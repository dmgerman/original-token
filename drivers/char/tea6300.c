multiline_comment|/*&n; * for the TEA6300 chip (only found on Gateway STB TV/FM cards tho the best&n; * of my knowledge)&n; * WARNING: THIS DRIVER WILL LOAD WITHOUT COMPLAINTS EVEN IF THE WRONG&n; * CHIP (i.e., an MSP3400) IS ON I2C ADDRESS 0x80 (it relies on i2c to&n; * make sure that there is a device acknowledging that address).  This&n; * is a potential problem because the MSP3400 is very popular and does&n; * use this address!  You have been warned!&n; *&n; * Copyright (c) 1998 Greg Alexander &lt;galexand@acm.org&gt;&n; * This code is placed under the terms of the GNU General Public License&n; * Code liberally copied from msp3400.c, which is by Gerd Knorr&n; *&n; * All of this should work, though it would be nice to eventually support&n; * balance (different left,right values) and, if someone ever finds a card&n; * with the support (or if you&squot;re careful with a soldering iron), fade&n; * (front/back).&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/videodev.h&gt;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &lt;linux/i2c-algo-bit.h&gt;
macro_line|#include &quot;bttv.h&quot;
macro_line|#include &quot;audiochip.h&quot;
multiline_comment|/* Addresses to scan */
DECL|macro|I2C_TEA6300
mdefine_line|#define I2C_TEA6300&t;0x80
DECL|variable|normal_i2c
r_static
r_int
r_int
id|normal_i2c
(braket
)braket
op_assign
(brace
id|I2C_TEA6300
op_rshift
l_int|1
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|normal_i2c_range
r_static
r_int
r_int
id|normal_i2c_range
(braket
)braket
op_assign
(brace
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|probe
r_static
r_int
r_int
id|probe
(braket
l_int|2
)braket
op_assign
(brace
id|I2C_CLIENT_END
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|probe_range
r_static
r_int
r_int
id|probe_range
(braket
l_int|2
)braket
op_assign
(brace
id|I2C_CLIENT_END
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|ignore
r_static
r_int
r_int
id|ignore
(braket
l_int|2
)braket
op_assign
(brace
id|I2C_CLIENT_END
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|ignore_range
r_static
r_int
r_int
id|ignore_range
(braket
l_int|2
)braket
op_assign
(brace
id|I2C_CLIENT_END
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|force
r_static
r_int
r_int
id|force
(braket
l_int|2
)braket
op_assign
(brace
id|I2C_CLIENT_END
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|addr_data
r_static
r_struct
id|i2c_client_address_data
id|addr_data
op_assign
(brace
id|normal_i2c
comma
id|normal_i2c_range
comma
id|probe
comma
id|probe_range
comma
id|ignore
comma
id|ignore_range
comma
id|force
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* insmod parameter */
DECL|macro|dprintk
mdefine_line|#define dprintk  if (debug) printk
DECL|struct|tea6300
r_struct
id|tea6300
(brace
DECL|member|mode
r_int
id|mode
suffix:semicolon
multiline_comment|/* set to AUDIO_{OFF,TUNER,RADIO,EXTERN} */
DECL|member|stereo
r_int
id|stereo
suffix:semicolon
DECL|member|left
DECL|member|right
id|__u16
id|left
comma
id|right
suffix:semicolon
DECL|member|bass
DECL|member|treble
id|__u16
id|bass
comma
id|treble
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|driver
r_static
r_struct
id|i2c_driver
id|driver
suffix:semicolon
DECL|variable|client_template
r_static
r_struct
id|i2c_client
id|client_template
suffix:semicolon
DECL|macro|TEA6300_VL
mdefine_line|#define TEA6300_VL         0x00  /* volume left */
DECL|macro|TEA6300_VR
mdefine_line|#define TEA6300_VR         0x01  /* volume right */
DECL|macro|TEA6300_BA
mdefine_line|#define TEA6300_BA         0x02  /* bass */
DECL|macro|TEA6300_TR
mdefine_line|#define TEA6300_TR         0x03  /* treble */
DECL|macro|TEA6300_FA
mdefine_line|#define TEA6300_FA         0x04  /* fader control */
DECL|macro|TEA6300_S
mdefine_line|#define TEA6300_S          0x05  /* switch register */
multiline_comment|/* values for those registers: */
DECL|macro|TEA6300_S_SA
mdefine_line|#define TEA6300_S_SA       0x01  /* stereo A input */
DECL|macro|TEA6300_S_SB
mdefine_line|#define TEA6300_S_SB       0x02  /* stereo B */
DECL|macro|TEA6300_S_SC
mdefine_line|#define TEA6300_S_SC       0x04  /* stereo C */
DECL|macro|TEA6300_S_GMU
mdefine_line|#define TEA6300_S_GMU      0x80  /* general mute */
multiline_comment|/* ******************************** *&n; * functions for talking to TEA6300 *&n; * ******************************** */
DECL|function|tea6300_write
r_static
r_int
id|tea6300_write
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
comma
r_int
id|addr
comma
r_int
id|val
)paren
(brace
r_int
r_char
id|buffer
(braket
l_int|2
)braket
suffix:semicolon
id|buffer
(braket
l_int|0
)braket
op_assign
id|addr
suffix:semicolon
id|buffer
(braket
l_int|1
)braket
op_assign
id|val
suffix:semicolon
r_if
c_cond
(paren
l_int|2
op_ne
id|i2c_master_send
c_func
(paren
id|client
comma
id|buffer
comma
l_int|2
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;tea6300: I/O error, trying (write %d 0x%x)&bslash;n&quot;
comma
id|addr
comma
id|val
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tea6300_set
r_static
r_void
id|tea6300_set
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
)paren
(brace
r_struct
id|tea6300
op_star
id|tea
op_assign
id|client-&gt;data
suffix:semicolon
multiline_comment|/* mode is ignored today */
id|dprintk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;tea6300_set(%04x,%04x,%04x,%04x)&bslash;n&quot;
comma
id|tea-&gt;left
op_rshift
l_int|10
comma
id|tea-&gt;right
op_rshift
l_int|10
comma
id|tea-&gt;bass
op_rshift
l_int|12
comma
id|tea-&gt;treble
op_rshift
l_int|12
)paren
suffix:semicolon
id|tea6300_write
c_func
(paren
id|client
comma
id|TEA6300_VL
comma
id|tea-&gt;left
op_rshift
l_int|10
)paren
suffix:semicolon
id|tea6300_write
c_func
(paren
id|client
comma
id|TEA6300_VR
comma
id|tea-&gt;right
op_rshift
l_int|10
)paren
suffix:semicolon
id|tea6300_write
c_func
(paren
id|client
comma
id|TEA6300_BA
comma
id|tea-&gt;bass
op_rshift
l_int|12
)paren
suffix:semicolon
id|tea6300_write
c_func
(paren
id|client
comma
id|TEA6300_TR
comma
id|tea-&gt;treble
op_rshift
l_int|12
)paren
suffix:semicolon
)brace
DECL|function|do_tea6300_init
r_static
r_void
id|do_tea6300_init
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
)paren
(brace
r_struct
id|tea6300
op_star
id|tea
op_assign
id|client-&gt;data
suffix:semicolon
id|tea-&gt;left
op_assign
id|tea-&gt;right
op_assign
l_int|49152
suffix:semicolon
multiline_comment|/* -10dB (loud enough, but not beyond&n;&t;                                 normal line levels - so as to avoid&n;&t;                                 clipping */
id|tea-&gt;bass
op_assign
id|tea-&gt;treble
op_assign
l_int|28672
suffix:semicolon
multiline_comment|/* 0dB */
id|tea-&gt;mode
op_assign
id|AUDIO_OFF
suffix:semicolon
id|tea-&gt;stereo
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* left=right=0x27&lt;&lt;10, bass=treble=0x07&lt;&lt;12 */
id|tea6300_write
c_func
(paren
id|client
comma
id|TEA6300_FA
comma
l_int|0x3f
)paren
suffix:semicolon
multiline_comment|/* fader off */
id|tea6300_write
c_func
(paren
id|client
comma
id|TEA6300_S
comma
id|TEA6300_S_GMU
)paren
suffix:semicolon
multiline_comment|/* mute */
id|tea6300_set
c_func
(paren
id|client
)paren
suffix:semicolon
)brace
DECL|function|tea6300_audio
r_static
r_void
id|tea6300_audio
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
comma
r_int
id|mode
)paren
(brace
r_struct
id|tea6300
op_star
id|tea
op_assign
id|client-&gt;data
suffix:semicolon
multiline_comment|/* valid for AUDIO_TUNER, RADIO, EXTERN, OFF */
id|dprintk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;tea6300_audio:%d (T,R,E,I,O)&bslash;n&quot;
comma
id|mode
)paren
suffix:semicolon
id|tea-&gt;mode
op_assign
id|mode
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
id|AUDIO_OFF
)paren
(brace
multiline_comment|/* just mute it */
id|tea6300_write
c_func
(paren
id|client
comma
id|TEA6300_S
comma
id|TEA6300_S_GMU
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
id|AUDIO_TUNER
suffix:colon
id|tea6300_write
c_func
(paren
id|client
comma
id|TEA6300_S
comma
id|TEA6300_S_SA
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AUDIO_RADIO
suffix:colon
id|tea6300_write
c_func
(paren
id|client
comma
id|TEA6300_S
comma
id|TEA6300_S_SB
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AUDIO_EXTERN
suffix:colon
id|tea6300_write
c_func
(paren
id|client
comma
id|TEA6300_S
comma
id|TEA6300_S_SC
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* *********************** *&n; * i2c interface functions *&n; * *********************** */
DECL|function|tea6300_attach
r_static
r_int
id|tea6300_attach
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adap
comma
r_int
id|addr
comma
r_int
r_int
id|flags
comma
r_int
id|kind
)paren
(brace
r_struct
id|tea6300
op_star
id|tea
suffix:semicolon
r_struct
id|i2c_client
op_star
id|client
suffix:semicolon
id|client
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|client
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|client
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memcpy
c_func
(paren
id|client
comma
op_amp
id|client_template
comma
r_sizeof
(paren
r_struct
id|i2c_client
)paren
)paren
suffix:semicolon
id|client-&gt;adapter
op_assign
id|adap
suffix:semicolon
id|client-&gt;addr
op_assign
id|addr
suffix:semicolon
id|client-&gt;data
op_assign
id|tea
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|tea
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tea
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|tea
comma
l_int|0
comma
r_sizeof
op_star
id|tea
)paren
suffix:semicolon
id|do_tea6300_init
c_func
(paren
id|client
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|strcpy
c_func
(paren
id|client-&gt;name
comma
l_string|&quot;TEA6300T&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;tea6300: initialized&bslash;n&quot;
)paren
suffix:semicolon
id|i2c_attach_client
c_func
(paren
id|client
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tea6300_probe
r_static
r_int
id|tea6300_probe
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adap
)paren
(brace
r_if
c_cond
(paren
id|adap-&gt;id
op_eq
(paren
id|I2C_ALGO_BIT
op_or
id|I2C_HW_B_BT848
)paren
)paren
r_return
id|i2c_probe
c_func
(paren
id|adap
comma
op_amp
id|addr_data
comma
id|tea6300_attach
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tea6300_detach
r_static
r_int
id|tea6300_detach
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
)paren
(brace
r_struct
id|tea6300
op_star
id|tea
op_assign
id|client-&gt;data
suffix:semicolon
id|do_tea6300_init
c_func
(paren
id|client
)paren
suffix:semicolon
id|i2c_detach_client
c_func
(paren
id|client
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tea
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|client
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|tea6300_command
id|tea6300_command
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|tea6300
op_star
id|tea
op_assign
id|client-&gt;data
suffix:semicolon
id|__u16
op_star
id|sarg
op_assign
id|arg
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|AUDC_SET_RADIO
suffix:colon
id|tea6300_audio
c_func
(paren
id|client
comma
id|AUDIO_RADIO
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AUDC_SET_INPUT
suffix:colon
id|tea6300_audio
c_func
(paren
id|client
comma
op_star
id|sarg
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* --- v4l ioctls --- */
multiline_comment|/* take care: bttv does userspace copying, we&squot;ll get a&n;&t;   kernel pointer here... */
r_case
id|VIDIOCGAUDIO
suffix:colon
(brace
r_struct
id|video_audio
op_star
id|va
op_assign
id|arg
suffix:semicolon
id|va-&gt;flags
op_or_assign
id|VIDEO_AUDIO_VOLUME
op_or
id|VIDEO_AUDIO_BASS
op_or
id|VIDEO_AUDIO_TREBLE
suffix:semicolon
id|va-&gt;volume
op_assign
id|MAX
c_func
(paren
id|tea-&gt;left
comma
id|tea-&gt;right
)paren
suffix:semicolon
id|va-&gt;balance
op_assign
(paren
l_int|32768
op_star
id|MIN
c_func
(paren
id|tea-&gt;left
comma
id|tea-&gt;right
)paren
)paren
op_div
(paren
id|va-&gt;volume
ques
c_cond
id|va-&gt;volume
suffix:colon
l_int|1
)paren
suffix:semicolon
id|va-&gt;balance
op_assign
(paren
id|tea-&gt;left
OL
id|tea-&gt;right
)paren
ques
c_cond
(paren
l_int|65535
op_minus
id|va-&gt;balance
)paren
suffix:colon
id|va-&gt;balance
suffix:semicolon
id|va-&gt;bass
op_assign
id|tea-&gt;bass
suffix:semicolon
id|va-&gt;treble
op_assign
id|tea-&gt;treble
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|VIDIOCSAUDIO
suffix:colon
(brace
r_struct
id|video_audio
op_star
id|va
op_assign
id|arg
suffix:semicolon
id|tea-&gt;left
op_assign
(paren
id|MIN
c_func
(paren
l_int|65536
op_minus
id|va-&gt;balance
comma
l_int|32768
)paren
op_star
id|va-&gt;volume
)paren
op_div
l_int|32768
suffix:semicolon
id|tea-&gt;right
op_assign
(paren
id|MIN
c_func
(paren
id|va-&gt;balance
comma
l_int|32768
)paren
op_star
id|va-&gt;volume
)paren
op_div
l_int|32768
suffix:semicolon
id|tea-&gt;bass
op_assign
id|va-&gt;bass
suffix:semicolon
id|tea-&gt;treble
op_assign
id|va-&gt;treble
suffix:semicolon
id|tea6300_set
c_func
(paren
id|client
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/* --- old, obsolete interface --- */
r_case
id|AUDC_GET_VOLUME_LEFT
suffix:colon
op_star
id|sarg
op_assign
id|tea-&gt;left
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AUDC_GET_VOLUME_RIGHT
suffix:colon
op_star
id|sarg
op_assign
id|tea-&gt;right
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AUDC_SET_VOLUME_LEFT
suffix:colon
id|tea-&gt;left
op_assign
op_star
id|sarg
suffix:semicolon
id|tea6300_set
c_func
(paren
id|client
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AUDC_SET_VOLUME_RIGHT
suffix:colon
id|tea-&gt;right
op_assign
op_star
id|sarg
suffix:semicolon
id|tea6300_set
c_func
(paren
id|client
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AUDC_GET_BASS
suffix:colon
op_star
id|sarg
op_assign
id|tea-&gt;bass
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AUDC_SET_BASS
suffix:colon
id|tea-&gt;bass
op_assign
op_star
id|sarg
suffix:semicolon
id|tea6300_set
c_func
(paren
id|client
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AUDC_GET_TREBLE
suffix:colon
op_star
id|sarg
op_assign
id|tea-&gt;treble
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AUDC_SET_TREBLE
suffix:colon
id|tea-&gt;treble
op_assign
op_star
id|sarg
suffix:semicolon
id|tea6300_set
c_func
(paren
id|client
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AUDC_GET_STEREO
suffix:colon
op_star
id|sarg
op_assign
id|tea-&gt;stereo
ques
c_cond
id|VIDEO_SOUND_STEREO
suffix:colon
id|VIDEO_SOUND_MONO
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AUDC_SET_STEREO
suffix:colon
id|tea-&gt;stereo
op_assign
(paren
op_star
id|sarg
op_eq
id|VIDEO_SOUND_MONO
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* TODO: make this write to the TDA9850? */
r_break
suffix:semicolon
multiline_comment|/*&t;case AUDC_SWITCH_MUTE:&t;someday, maybe -- not a lot of point to&n;&t;case AUDC_NEWCHANNEL:&t;it and it would require preserving state&n;&t;case AUDC_GET_DC:&t;huh?? (not used by bttv.c)&n;*/
macro_line|#endif
r_default
suffix:colon
(brace
)brace
multiline_comment|/* nothing */
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|driver
r_static
r_struct
id|i2c_driver
id|driver
op_assign
(brace
l_string|&quot;i2c tea6300 driver&quot;
comma
id|I2C_DRIVERID_TEA6300
comma
id|I2C_DF_NOTIFY
comma
id|tea6300_probe
comma
id|tea6300_detach
comma
id|tea6300_command
comma
)brace
suffix:semicolon
DECL|variable|client_template
r_static
r_struct
id|i2c_client
id|client_template
op_assign
(brace
l_string|&quot;(unset)&quot;
comma
multiline_comment|/* name */
op_minus
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
op_amp
id|driver
)brace
suffix:semicolon
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
macro_line|#else
r_int
id|tea6300_init
c_func
(paren
r_void
)paren
macro_line|#endif
(brace
id|i2c_add_driver
c_func
(paren
op_amp
id|driver
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|i2c_del_driver
c_func
(paren
op_amp
id|driver
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * Local variables:&n; * c-basic-offset: 8&n; * End:&n; */
eof
