multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;stallion.c  -- stallion multiport serial driver.&n; *&n; *&t;Copyright (C) 1996-1999  Stallion Technologies (support@stallion.oz.au).&n; *&t;Copyright (C) 1994-1996  Greg Ungerer.&n; *&n; *&t;This code is loosely based on the Linux serial driver, written by&n; *&t;Linus Torvalds, Theodore T&squot;so and others.&n; *&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2 of the License, or&n; *&t;(at your option) any later version.&n; *&n; *&t;This program is distributed in the hope that it will be useful,&n; *&t;but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *&t;MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *&t;GNU General Public License for more details.&n; *&n; *&t;You should have received a copy of the GNU General Public License&n; *&t;along with this program; if not, write to the Free Software&n; *&t;Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
multiline_comment|/*****************************************************************************/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt; /* for linux/stallion.h */
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/tty_flip.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;linux/cd1400.h&gt;
macro_line|#include &lt;linux/sc26198.h&gt;
macro_line|#include &lt;linux/comstats.h&gt;
macro_line|#include &lt;linux/stallion.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/devfs_fs_kernel.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#ifdef CONFIG_PCI
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#endif
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Define different board types. Use the standard Stallion &quot;assigned&quot;&n; *&t;board numbers. Boards supported in this driver are abbreviated as&n; *&t;EIO = EasyIO and ECH = EasyConnection 8/32.&n; */
DECL|macro|BRD_EASYIO
mdefine_line|#define&t;BRD_EASYIO&t;20
DECL|macro|BRD_ECH
mdefine_line|#define&t;BRD_ECH&t;&t;21
DECL|macro|BRD_ECHMC
mdefine_line|#define&t;BRD_ECHMC&t;22
DECL|macro|BRD_ECHPCI
mdefine_line|#define&t;BRD_ECHPCI&t;26
DECL|macro|BRD_ECH64PCI
mdefine_line|#define&t;BRD_ECH64PCI&t;27
DECL|macro|BRD_EASYIOPCI
mdefine_line|#define&t;BRD_EASYIOPCI&t;28
multiline_comment|/*&n; *&t;Define a configuration structure to hold the board configuration.&n; *&t;Need to set this up in the code (for now) with the boards that are&n; *&t;to be configured into the system. This is what needs to be modified&n; *&t;when adding/removing/modifying boards. Each line entry in the&n; *&t;stl_brdconf[] array is a board. Each line contains io/irq/memory&n; *&t;ranges for that board (as well as what type of board it is).&n; *&t;Some examples:&n; *&t;&t;{ BRD_EASYIO, 0x2a0, 0, 0, 10, 0 },&n; *&t;This line would configure an EasyIO board (4 or 8, no difference),&n; *&t;at io address 2a0 and irq 10.&n; *&t;Another example:&n; *&t;&t;{ BRD_ECH, 0x2a8, 0x280, 0, 12, 0 },&n; *&t;This line will configure an EasyConnection 8/32 board at primary io&n; *&t;address 2a8, secondary io address 280 and irq 12.&n; *&t;Enter as many lines into this array as you want (only the first 4&n; *&t;will actually be used!). Any combination of EasyIO and EasyConnection&n; *&t;boards can be specified. EasyConnection 8/32 boards can share their&n; *&t;secondary io addresses between each other.&n; *&n; *&t;NOTE: there is no need to put any entries in this table for PCI&n; *&t;boards. They will be found automatically by the driver - provided&n; *&t;PCI BIOS32 support is compiled into the kernel.&n; */
r_typedef
r_struct
(brace
DECL|member|brdtype
r_int
id|brdtype
suffix:semicolon
DECL|member|ioaddr1
r_int
id|ioaddr1
suffix:semicolon
DECL|member|ioaddr2
r_int
id|ioaddr2
suffix:semicolon
DECL|member|memaddr
r_int
r_int
id|memaddr
suffix:semicolon
DECL|member|irq
r_int
id|irq
suffix:semicolon
DECL|member|irqtype
r_int
id|irqtype
suffix:semicolon
DECL|typedef|stlconf_t
)brace
id|stlconf_t
suffix:semicolon
DECL|variable|stl_brdconf
r_static
id|stlconf_t
id|stl_brdconf
(braket
)braket
op_assign
(brace
multiline_comment|/*{ BRD_EASYIO, 0x2a0, 0, 0, 10, 0 },*/
)brace
suffix:semicolon
DECL|variable|stl_nrbrds
r_static
r_int
id|stl_nrbrds
op_assign
r_sizeof
(paren
id|stl_brdconf
)paren
op_div
r_sizeof
(paren
id|stlconf_t
)paren
suffix:semicolon
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Define some important driver characteristics. Device major numbers&n; *&t;allocated as per Linux Device Registry.&n; */
macro_line|#ifndef&t;STL_SIOMEMMAJOR
DECL|macro|STL_SIOMEMMAJOR
mdefine_line|#define&t;STL_SIOMEMMAJOR&t;&t;28
macro_line|#endif
macro_line|#ifndef&t;STL_SERIALMAJOR
DECL|macro|STL_SERIALMAJOR
mdefine_line|#define&t;STL_SERIALMAJOR&t;&t;24
macro_line|#endif
macro_line|#ifndef&t;STL_CALLOUTMAJOR
DECL|macro|STL_CALLOUTMAJOR
mdefine_line|#define&t;STL_CALLOUTMAJOR&t;25
macro_line|#endif
DECL|macro|STL_DRVTYPSERIAL
mdefine_line|#define&t;STL_DRVTYPSERIAL&t;1
DECL|macro|STL_DRVTYPCALLOUT
mdefine_line|#define&t;STL_DRVTYPCALLOUT&t;2
multiline_comment|/*&n; *&t;Set the TX buffer size. Bigger is better, but we don&squot;t want&n; *&t;to chew too much memory with buffers!&n; */
DECL|macro|STL_TXBUFLOW
mdefine_line|#define&t;STL_TXBUFLOW&t;&t;512
DECL|macro|STL_TXBUFSIZE
mdefine_line|#define&t;STL_TXBUFSIZE&t;&t;4096
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Define our local driver identity first. Set up stuff to deal with&n; *&t;all the local structures required by a serial tty driver.&n; */
DECL|variable|stl_drvtitle
r_static
r_char
op_star
id|stl_drvtitle
op_assign
l_string|&quot;Stallion Multiport Serial Driver&quot;
suffix:semicolon
DECL|variable|stl_drvname
r_static
r_char
op_star
id|stl_drvname
op_assign
l_string|&quot;stallion&quot;
suffix:semicolon
DECL|variable|stl_drvversion
r_static
r_char
op_star
id|stl_drvversion
op_assign
l_string|&quot;5.6.0&quot;
suffix:semicolon
DECL|variable|stl_serialname
r_static
r_char
op_star
id|stl_serialname
op_assign
l_string|&quot;ttyE&quot;
suffix:semicolon
DECL|variable|stl_calloutname
r_static
r_char
op_star
id|stl_calloutname
op_assign
l_string|&quot;cue&quot;
suffix:semicolon
DECL|variable|stl_serial
r_static
r_struct
id|tty_driver
id|stl_serial
suffix:semicolon
DECL|variable|stl_callout
r_static
r_struct
id|tty_driver
id|stl_callout
suffix:semicolon
DECL|variable|stl_ttys
r_static
r_struct
id|tty_struct
op_star
id|stl_ttys
(braket
id|STL_MAXDEVS
)braket
suffix:semicolon
DECL|variable|stl_termios
r_static
r_struct
id|termios
op_star
id|stl_termios
(braket
id|STL_MAXDEVS
)braket
suffix:semicolon
DECL|variable|stl_termioslocked
r_static
r_struct
id|termios
op_star
id|stl_termioslocked
(braket
id|STL_MAXDEVS
)braket
suffix:semicolon
DECL|variable|stl_refcount
r_static
r_int
id|stl_refcount
suffix:semicolon
multiline_comment|/*&n; *&t;We will need to allocate a temporary write buffer for chars that&n; *&t;come direct from user space. The problem is that a copy from user&n; *&t;space might cause a page fault (typically on a system that is&n; *&t;swapping!). All ports will share one buffer - since if the system&n; *&t;is already swapping a shared buffer won&squot;t make things any worse.&n; */
DECL|variable|stl_tmpwritebuf
r_static
r_char
op_star
id|stl_tmpwritebuf
suffix:semicolon
r_static
id|DECLARE_MUTEX
c_func
(paren
id|stl_tmpwritesem
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;Define a local default termios struct. All ports will be created&n; *&t;with this termios initially. Basically all it defines is a raw port&n; *&t;at 9600, 8 data bits, 1 stop bit.&n; */
DECL|variable|stl_deftermios
r_static
r_struct
id|termios
id|stl_deftermios
op_assign
(brace
l_int|0
comma
l_int|0
comma
(paren
id|B9600
op_or
id|CS8
op_or
id|CREAD
op_or
id|HUPCL
op_or
id|CLOCAL
)paren
comma
l_int|0
comma
l_int|0
comma
id|INIT_C_CC
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;Define global stats structures. Not used often, and can be&n; *&t;re-used for each stats call.&n; */
DECL|variable|stl_comstats
r_static
id|comstats_t
id|stl_comstats
suffix:semicolon
DECL|variable|stl_brdstats
r_static
id|combrd_t
id|stl_brdstats
suffix:semicolon
DECL|variable|stl_dummybrd
r_static
id|stlbrd_t
id|stl_dummybrd
suffix:semicolon
DECL|variable|stl_dummyport
r_static
id|stlport_t
id|stl_dummyport
suffix:semicolon
multiline_comment|/*&n; *&t;Define global place to put buffer overflow characters.&n; */
DECL|variable|stl_unwanted
r_static
r_char
id|stl_unwanted
(braket
id|SC26198_RXFIFOSIZE
)braket
suffix:semicolon
multiline_comment|/*&n; *&t;Keep track of what interrupts we have requested for us.&n; *&t;We don&squot;t need to request an interrupt twice if it is being&n; *&t;shared with another Stallion board.&n; */
DECL|variable|stl_gotintrs
r_static
r_int
id|stl_gotintrs
(braket
id|STL_MAXBRDS
)braket
suffix:semicolon
DECL|variable|stl_numintrs
r_static
r_int
id|stl_numintrs
suffix:semicolon
multiline_comment|/*****************************************************************************/
DECL|variable|stl_brds
r_static
id|stlbrd_t
op_star
id|stl_brds
(braket
id|STL_MAXBRDS
)braket
suffix:semicolon
multiline_comment|/*&n; *&t;Per board state flags. Used with the state field of the board struct.&n; *&t;Not really much here!&n; */
DECL|macro|BRD_FOUND
mdefine_line|#define&t;BRD_FOUND&t;0x1
multiline_comment|/*&n; *&t;Define the port structure istate flags. These set of flags are&n; *&t;modified at interrupt time - so setting and reseting them needs&n; *&t;to be atomic. Use the bit clear/setting routines for this.&n; */
DECL|macro|ASYI_TXBUSY
mdefine_line|#define&t;ASYI_TXBUSY&t;1
DECL|macro|ASYI_TXLOW
mdefine_line|#define&t;ASYI_TXLOW&t;2
DECL|macro|ASYI_DCDCHANGE
mdefine_line|#define&t;ASYI_DCDCHANGE&t;3
DECL|macro|ASYI_TXFLOWED
mdefine_line|#define&t;ASYI_TXFLOWED&t;4
multiline_comment|/*&n; *&t;Define an array of board names as printable strings. Handy for&n; *&t;referencing boards when printing trace and stuff.&n; */
DECL|variable|stl_brdnames
r_static
r_char
op_star
id|stl_brdnames
(braket
)braket
op_assign
(brace
(paren
r_char
op_star
)paren
l_int|NULL
comma
(paren
r_char
op_star
)paren
l_int|NULL
comma
(paren
r_char
op_star
)paren
l_int|NULL
comma
(paren
r_char
op_star
)paren
l_int|NULL
comma
(paren
r_char
op_star
)paren
l_int|NULL
comma
(paren
r_char
op_star
)paren
l_int|NULL
comma
(paren
r_char
op_star
)paren
l_int|NULL
comma
(paren
r_char
op_star
)paren
l_int|NULL
comma
(paren
r_char
op_star
)paren
l_int|NULL
comma
(paren
r_char
op_star
)paren
l_int|NULL
comma
(paren
r_char
op_star
)paren
l_int|NULL
comma
(paren
r_char
op_star
)paren
l_int|NULL
comma
(paren
r_char
op_star
)paren
l_int|NULL
comma
(paren
r_char
op_star
)paren
l_int|NULL
comma
(paren
r_char
op_star
)paren
l_int|NULL
comma
(paren
r_char
op_star
)paren
l_int|NULL
comma
(paren
r_char
op_star
)paren
l_int|NULL
comma
(paren
r_char
op_star
)paren
l_int|NULL
comma
(paren
r_char
op_star
)paren
l_int|NULL
comma
(paren
r_char
op_star
)paren
l_int|NULL
comma
l_string|&quot;EasyIO&quot;
comma
l_string|&quot;EC8/32-AT&quot;
comma
l_string|&quot;EC8/32-MC&quot;
comma
(paren
r_char
op_star
)paren
l_int|NULL
comma
(paren
r_char
op_star
)paren
l_int|NULL
comma
(paren
r_char
op_star
)paren
l_int|NULL
comma
l_string|&quot;EC8/32-PCI&quot;
comma
l_string|&quot;EC8/64-PCI&quot;
comma
l_string|&quot;EasyIO-PCI&quot;
comma
)brace
suffix:semicolon
multiline_comment|/*****************************************************************************/
macro_line|#ifdef MODULE
multiline_comment|/*&n; *&t;Define some string labels for arguments passed from the module&n; *&t;load line. These allow for easy board definitions, and easy&n; *&t;modification of the io, memory and irq resoucres.&n; */
DECL|variable|board0
r_static
r_char
op_star
id|board0
(braket
l_int|4
)braket
suffix:semicolon
DECL|variable|board1
r_static
r_char
op_star
id|board1
(braket
l_int|4
)braket
suffix:semicolon
DECL|variable|board2
r_static
r_char
op_star
id|board2
(braket
l_int|4
)braket
suffix:semicolon
DECL|variable|board3
r_static
r_char
op_star
id|board3
(braket
l_int|4
)braket
suffix:semicolon
DECL|variable|stl_brdsp
r_static
r_char
op_star
op_star
id|stl_brdsp
(braket
)braket
op_assign
(brace
(paren
r_char
op_star
op_star
)paren
op_amp
id|board0
comma
(paren
r_char
op_star
op_star
)paren
op_amp
id|board1
comma
(paren
r_char
op_star
op_star
)paren
op_amp
id|board2
comma
(paren
r_char
op_star
op_star
)paren
op_amp
id|board3
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;Define a set of common board names, and types. This is used to&n; *&t;parse any module arguments.&n; */
DECL|struct|stlbrdtype
r_typedef
r_struct
id|stlbrdtype
(brace
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|type
r_int
id|type
suffix:semicolon
DECL|typedef|stlbrdtype_t
)brace
id|stlbrdtype_t
suffix:semicolon
DECL|variable|stl_brdstr
r_static
id|stlbrdtype_t
id|stl_brdstr
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;easyio&quot;
comma
id|BRD_EASYIO
)brace
comma
(brace
l_string|&quot;eio&quot;
comma
id|BRD_EASYIO
)brace
comma
(brace
l_string|&quot;20&quot;
comma
id|BRD_EASYIO
)brace
comma
(brace
l_string|&quot;ec8/32&quot;
comma
id|BRD_ECH
)brace
comma
(brace
l_string|&quot;ec8/32-at&quot;
comma
id|BRD_ECH
)brace
comma
(brace
l_string|&quot;ec8/32-isa&quot;
comma
id|BRD_ECH
)brace
comma
(brace
l_string|&quot;ech&quot;
comma
id|BRD_ECH
)brace
comma
(brace
l_string|&quot;echat&quot;
comma
id|BRD_ECH
)brace
comma
(brace
l_string|&quot;21&quot;
comma
id|BRD_ECH
)brace
comma
(brace
l_string|&quot;ec8/32-mc&quot;
comma
id|BRD_ECHMC
)brace
comma
(brace
l_string|&quot;ec8/32-mca&quot;
comma
id|BRD_ECHMC
)brace
comma
(brace
l_string|&quot;echmc&quot;
comma
id|BRD_ECHMC
)brace
comma
(brace
l_string|&quot;echmca&quot;
comma
id|BRD_ECHMC
)brace
comma
(brace
l_string|&quot;22&quot;
comma
id|BRD_ECHMC
)brace
comma
(brace
l_string|&quot;ec8/32-pc&quot;
comma
id|BRD_ECHPCI
)brace
comma
(brace
l_string|&quot;ec8/32-pci&quot;
comma
id|BRD_ECHPCI
)brace
comma
(brace
l_string|&quot;26&quot;
comma
id|BRD_ECHPCI
)brace
comma
(brace
l_string|&quot;ec8/64-pc&quot;
comma
id|BRD_ECH64PCI
)brace
comma
(brace
l_string|&quot;ec8/64-pci&quot;
comma
id|BRD_ECH64PCI
)brace
comma
(brace
l_string|&quot;ech-pci&quot;
comma
id|BRD_ECH64PCI
)brace
comma
(brace
l_string|&quot;echpci&quot;
comma
id|BRD_ECH64PCI
)brace
comma
(brace
l_string|&quot;echpc&quot;
comma
id|BRD_ECH64PCI
)brace
comma
(brace
l_string|&quot;27&quot;
comma
id|BRD_ECH64PCI
)brace
comma
(brace
l_string|&quot;easyio-pc&quot;
comma
id|BRD_EASYIOPCI
)brace
comma
(brace
l_string|&quot;easyio-pci&quot;
comma
id|BRD_EASYIOPCI
)brace
comma
(brace
l_string|&quot;eio-pci&quot;
comma
id|BRD_EASYIOPCI
)brace
comma
(brace
l_string|&quot;eiopci&quot;
comma
id|BRD_EASYIOPCI
)brace
comma
(brace
l_string|&quot;28&quot;
comma
id|BRD_EASYIOPCI
)brace
comma
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;Define the module agruments.&n; */
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Greg Ungerer&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Stallion Multiport Serial Driver&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|board0
comma
l_string|&quot;1-4s&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|board0
comma
l_string|&quot;Board 0 config -&gt; name[,ioaddr[,ioaddr2][,irq]]&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|board1
comma
l_string|&quot;1-4s&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|board1
comma
l_string|&quot;Board 1 config -&gt; name[,ioaddr[,ioaddr2][,irq]]&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|board2
comma
l_string|&quot;1-4s&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|board2
comma
l_string|&quot;Board 2 config -&gt; name[,ioaddr[,ioaddr2][,irq]]&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|board3
comma
l_string|&quot;1-4s&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|board3
comma
l_string|&quot;Board 3 config -&gt; name[,ioaddr[,ioaddr2][,irq]]&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Hardware ID bits for the EasyIO and ECH boards. These defines apply&n; *&t;to the directly accessible io ports of these boards (not the uarts -&n; *&t;they are in cd1400.h and sc26198.h).&n; */
DECL|macro|EIO_8PORTRS
mdefine_line|#define&t;EIO_8PORTRS&t;0x04
DECL|macro|EIO_4PORTRS
mdefine_line|#define&t;EIO_4PORTRS&t;0x05
DECL|macro|EIO_8PORTDI
mdefine_line|#define&t;EIO_8PORTDI&t;0x00
DECL|macro|EIO_8PORTM
mdefine_line|#define&t;EIO_8PORTM&t;0x06
DECL|macro|EIO_MK3
mdefine_line|#define&t;EIO_MK3&t;&t;0x03
DECL|macro|EIO_IDBITMASK
mdefine_line|#define&t;EIO_IDBITMASK&t;0x07
DECL|macro|EIO_BRDMASK
mdefine_line|#define&t;EIO_BRDMASK&t;0xf0
DECL|macro|ID_BRD4
mdefine_line|#define&t;ID_BRD4&t;&t;0x10
DECL|macro|ID_BRD8
mdefine_line|#define&t;ID_BRD8&t;&t;0x20
DECL|macro|ID_BRD16
mdefine_line|#define&t;ID_BRD16&t;0x30
DECL|macro|EIO_INTRPEND
mdefine_line|#define&t;EIO_INTRPEND&t;0x08
DECL|macro|EIO_INTEDGE
mdefine_line|#define&t;EIO_INTEDGE&t;0x00
DECL|macro|EIO_INTLEVEL
mdefine_line|#define&t;EIO_INTLEVEL&t;0x08
DECL|macro|EIO_0WS
mdefine_line|#define&t;EIO_0WS&t;&t;0x10
DECL|macro|ECH_ID
mdefine_line|#define&t;ECH_ID&t;&t;0xa0
DECL|macro|ECH_IDBITMASK
mdefine_line|#define&t;ECH_IDBITMASK&t;0xe0
DECL|macro|ECH_BRDENABLE
mdefine_line|#define&t;ECH_BRDENABLE&t;0x08
DECL|macro|ECH_BRDDISABLE
mdefine_line|#define&t;ECH_BRDDISABLE&t;0x00
DECL|macro|ECH_INTENABLE
mdefine_line|#define&t;ECH_INTENABLE&t;0x01
DECL|macro|ECH_INTDISABLE
mdefine_line|#define&t;ECH_INTDISABLE&t;0x00
DECL|macro|ECH_INTLEVEL
mdefine_line|#define&t;ECH_INTLEVEL&t;0x02
DECL|macro|ECH_INTEDGE
mdefine_line|#define&t;ECH_INTEDGE&t;0x00
DECL|macro|ECH_INTRPEND
mdefine_line|#define&t;ECH_INTRPEND&t;0x01
DECL|macro|ECH_BRDRESET
mdefine_line|#define&t;ECH_BRDRESET&t;0x01
DECL|macro|ECHMC_INTENABLE
mdefine_line|#define&t;ECHMC_INTENABLE&t;0x01
DECL|macro|ECHMC_BRDRESET
mdefine_line|#define&t;ECHMC_BRDRESET&t;0x02
DECL|macro|ECH_PNLSTATUS
mdefine_line|#define&t;ECH_PNLSTATUS&t;2
DECL|macro|ECH_PNL16PORT
mdefine_line|#define&t;ECH_PNL16PORT&t;0x20
DECL|macro|ECH_PNLIDMASK
mdefine_line|#define&t;ECH_PNLIDMASK&t;0x07
DECL|macro|ECH_PNLXPID
mdefine_line|#define&t;ECH_PNLXPID&t;0x40
DECL|macro|ECH_PNLINTRPEND
mdefine_line|#define&t;ECH_PNLINTRPEND&t;0x80
DECL|macro|ECH_ADDR2MASK
mdefine_line|#define&t;ECH_ADDR2MASK&t;0x1e0
multiline_comment|/*&n; *&t;Define the vector mapping bits for the programmable interrupt board&n; *&t;hardware. These bits encode the interrupt for the board to use - it&n; *&t;is software selectable (except the EIO-8M).&n; */
DECL|variable|stl_vecmap
r_static
r_int
r_char
id|stl_vecmap
(braket
)braket
op_assign
(brace
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0x04
comma
l_int|0x06
comma
l_int|0x05
comma
l_int|0xff
comma
l_int|0x07
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0x00
comma
l_int|0x02
comma
l_int|0x01
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0x03
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;Set up enable and disable macros for the ECH boards. They require&n; *&t;the secondary io address space to be activated and deactivated.&n; *&t;This way all ECH boards can share their secondary io region.&n; *&t;If this is an ECH-PCI board then also need to set the page pointer&n; *&t;to point to the correct page.&n; */
DECL|macro|BRDENABLE
mdefine_line|#define&t;BRDENABLE(brdnr,pagenr)&t;&t;&t;&t;&t;&t;&bslash;&n;&t;if (stl_brds[(brdnr)]-&gt;brdtype == BRD_ECH)&t;&t;&t;&bslash;&n;&t;&t;outb((stl_brds[(brdnr)]-&gt;ioctrlval | ECH_BRDENABLE),&t;&bslash;&n;&t;&t;&t;stl_brds[(brdnr)]-&gt;ioctrl);&t;&t;&t;&bslash;&n;&t;else if (stl_brds[(brdnr)]-&gt;brdtype == BRD_ECHPCI)&t;&t;&bslash;&n;&t;&t;outb((pagenr), stl_brds[(brdnr)]-&gt;ioctrl);
DECL|macro|BRDDISABLE
mdefine_line|#define&t;BRDDISABLE(brdnr)&t;&t;&t;&t;&t;&t;&bslash;&n;&t;if (stl_brds[(brdnr)]-&gt;brdtype == BRD_ECH)&t;&t;&t;&bslash;&n;&t;&t;outb((stl_brds[(brdnr)]-&gt;ioctrlval | ECH_BRDDISABLE),&t;&bslash;&n;&t;&t;&t;stl_brds[(brdnr)]-&gt;ioctrl);
DECL|macro|STL_CD1400MAXBAUD
mdefine_line|#define&t;STL_CD1400MAXBAUD&t;230400
DECL|macro|STL_SC26198MAXBAUD
mdefine_line|#define&t;STL_SC26198MAXBAUD&t;460800
DECL|macro|STL_BAUDBASE
mdefine_line|#define&t;STL_BAUDBASE&t;&t;115200
DECL|macro|STL_CLOSEDELAY
mdefine_line|#define&t;STL_CLOSEDELAY&t;&t;(5 * HZ / 10)
multiline_comment|/*****************************************************************************/
macro_line|#ifdef CONFIG_PCI
multiline_comment|/*&n; *&t;Define the Stallion PCI vendor and device IDs.&n; */
macro_line|#ifndef&t;PCI_VENDOR_ID_STALLION
DECL|macro|PCI_VENDOR_ID_STALLION
mdefine_line|#define&t;PCI_VENDOR_ID_STALLION&t;&t;0x124d
macro_line|#endif
macro_line|#ifndef PCI_DEVICE_ID_ECHPCI832
DECL|macro|PCI_DEVICE_ID_ECHPCI832
mdefine_line|#define&t;PCI_DEVICE_ID_ECHPCI832&t;&t;0x0000
macro_line|#endif
macro_line|#ifndef PCI_DEVICE_ID_ECHPCI864
DECL|macro|PCI_DEVICE_ID_ECHPCI864
mdefine_line|#define&t;PCI_DEVICE_ID_ECHPCI864&t;&t;0x0002
macro_line|#endif
macro_line|#ifndef PCI_DEVICE_ID_EIOPCI
DECL|macro|PCI_DEVICE_ID_EIOPCI
mdefine_line|#define&t;PCI_DEVICE_ID_EIOPCI&t;&t;0x0003
macro_line|#endif
multiline_comment|/*&n; *&t;Define structure to hold all Stallion PCI boards.&n; */
DECL|struct|stlpcibrd
r_typedef
r_struct
id|stlpcibrd
(brace
DECL|member|vendid
r_int
r_int
id|vendid
suffix:semicolon
DECL|member|devid
r_int
r_int
id|devid
suffix:semicolon
DECL|member|brdtype
r_int
id|brdtype
suffix:semicolon
DECL|typedef|stlpcibrd_t
)brace
id|stlpcibrd_t
suffix:semicolon
DECL|variable|stl_pcibrds
r_static
id|stlpcibrd_t
id|stl_pcibrds
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_STALLION
comma
id|PCI_DEVICE_ID_ECHPCI864
comma
id|BRD_ECH64PCI
)brace
comma
(brace
id|PCI_VENDOR_ID_STALLION
comma
id|PCI_DEVICE_ID_EIOPCI
comma
id|BRD_EASYIOPCI
)brace
comma
(brace
id|PCI_VENDOR_ID_STALLION
comma
id|PCI_DEVICE_ID_ECHPCI832
comma
id|BRD_ECHPCI
)brace
comma
(brace
id|PCI_VENDOR_ID_NS
comma
id|PCI_DEVICE_ID_NS_87410
comma
id|BRD_ECHPCI
)brace
comma
)brace
suffix:semicolon
DECL|variable|stl_nrpcibrds
r_static
r_int
id|stl_nrpcibrds
op_assign
r_sizeof
(paren
id|stl_pcibrds
)paren
op_div
r_sizeof
(paren
id|stlpcibrd_t
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Define macros to extract a brd/port number from a minor number.&n; */
DECL|macro|MINOR2BRD
mdefine_line|#define&t;MINOR2BRD(min)&t;&t;(((min) &amp; 0xc0) &gt;&gt; 6)
DECL|macro|MINOR2PORT
mdefine_line|#define&t;MINOR2PORT(min)&t;&t;((min) &amp; 0x3f)
multiline_comment|/*&n; *&t;Define a baud rate table that converts termios baud rate selector&n; *&t;into the actual baud rate value. All baud rate calculations are&n; *&t;based on the actual baud rate required.&n; */
DECL|variable|stl_baudrates
r_static
r_int
r_int
id|stl_baudrates
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|50
comma
l_int|75
comma
l_int|110
comma
l_int|134
comma
l_int|150
comma
l_int|200
comma
l_int|300
comma
l_int|600
comma
l_int|1200
comma
l_int|1800
comma
l_int|2400
comma
l_int|4800
comma
l_int|9600
comma
l_int|19200
comma
l_int|38400
comma
l_int|57600
comma
l_int|115200
comma
l_int|230400
comma
l_int|460800
comma
l_int|921600
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;Define some handy local macros...&n; */
DECL|macro|MIN
macro_line|#undef&t;MIN
DECL|macro|MIN
mdefine_line|#define&t;MIN(a,b)&t;(((a) &lt;= (b)) ? (a) : (b))
DECL|macro|TOLOWER
macro_line|#undef&t;TOLOWER
DECL|macro|TOLOWER
mdefine_line|#define&t;TOLOWER(x)&t;((((x) &gt;= &squot;A&squot;) &amp;&amp; ((x) &lt;= &squot;Z&squot;)) ? ((x) + 0x20) : (x))
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Declare all those functions in this driver!&n; */
macro_line|#ifdef MODULE
r_int
id|init_module
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|stl_argbrds
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|stl_parsebrd
c_func
(paren
id|stlconf_t
op_star
id|confp
comma
r_char
op_star
op_star
id|argp
)paren
suffix:semicolon
r_static
r_int
r_int
id|stl_atol
c_func
(paren
r_char
op_star
id|str
)paren
suffix:semicolon
macro_line|#endif
r_int
id|stl_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|stl_open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_void
id|stl_close
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_int
id|stl_write
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|from_user
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_void
id|stl_putchar
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
r_char
id|ch
)paren
suffix:semicolon
r_static
r_void
id|stl_flushchars
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_int
id|stl_writeroom
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_int
id|stl_charsinbuffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_int
id|stl_ioctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_void
id|stl_settermios
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|termios
op_star
id|old
)paren
suffix:semicolon
r_static
r_void
id|stl_throttle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_void
id|stl_unthrottle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_void
id|stl_stop
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_void
id|stl_start
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_void
id|stl_flushbuffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_void
id|stl_breakctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|state
)paren
suffix:semicolon
r_static
r_void
id|stl_waituntilsent
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|timeout
)paren
suffix:semicolon
r_static
r_void
id|stl_sendxchar
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_char
id|ch
)paren
suffix:semicolon
r_static
r_void
id|stl_hangup
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_int
id|stl_memioctl
c_func
(paren
r_struct
id|inode
op_star
id|ip
comma
r_struct
id|file
op_star
id|fp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|stl_portinfo
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|portnr
comma
r_char
op_star
id|pos
)paren
suffix:semicolon
r_static
r_int
id|stl_readproc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|stl_brdinit
c_func
(paren
id|stlbrd_t
op_star
id|brdp
)paren
suffix:semicolon
r_static
r_int
id|stl_initports
c_func
(paren
id|stlbrd_t
op_star
id|brdp
comma
id|stlpanel_t
op_star
id|panelp
)paren
suffix:semicolon
r_static
r_int
id|stl_mapirq
c_func
(paren
r_int
id|irq
comma
r_char
op_star
id|name
)paren
suffix:semicolon
r_static
r_void
id|stl_getserial
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_struct
id|serial_struct
op_star
id|sp
)paren
suffix:semicolon
r_static
r_int
id|stl_setserial
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_struct
id|serial_struct
op_star
id|sp
)paren
suffix:semicolon
r_static
r_int
id|stl_getbrdstats
c_func
(paren
id|combrd_t
op_star
id|bp
)paren
suffix:semicolon
r_static
r_int
id|stl_getportstats
c_func
(paren
id|stlport_t
op_star
id|portp
comma
id|comstats_t
op_star
id|cp
)paren
suffix:semicolon
r_static
r_int
id|stl_clrportstats
c_func
(paren
id|stlport_t
op_star
id|portp
comma
id|comstats_t
op_star
id|cp
)paren
suffix:semicolon
r_static
r_int
id|stl_getportstruct
c_func
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|stl_getbrdstruct
c_func
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|stl_waitcarrier
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_void
id|stl_delay
c_func
(paren
r_int
id|len
)paren
suffix:semicolon
r_static
r_void
id|stl_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|stl_eiointr
c_func
(paren
id|stlbrd_t
op_star
id|brdp
)paren
suffix:semicolon
r_static
r_void
id|stl_echatintr
c_func
(paren
id|stlbrd_t
op_star
id|brdp
)paren
suffix:semicolon
r_static
r_void
id|stl_echmcaintr
c_func
(paren
id|stlbrd_t
op_star
id|brdp
)paren
suffix:semicolon
r_static
r_void
id|stl_echpciintr
c_func
(paren
id|stlbrd_t
op_star
id|brdp
)paren
suffix:semicolon
r_static
r_void
id|stl_echpci64intr
c_func
(paren
id|stlbrd_t
op_star
id|brdp
)paren
suffix:semicolon
r_static
r_void
id|stl_offintr
c_func
(paren
r_void
op_star
r_private
)paren
suffix:semicolon
r_static
r_void
op_star
id|stl_memalloc
c_func
(paren
r_int
id|len
)paren
suffix:semicolon
r_static
id|stlbrd_t
op_star
id|stl_allocbrd
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
id|stlport_t
op_star
id|stl_getport
c_func
(paren
r_int
id|brdnr
comma
r_int
id|panelnr
comma
r_int
id|portnr
)paren
suffix:semicolon
r_static
r_inline
r_int
id|stl_initbrds
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_inline
r_int
id|stl_initeio
c_func
(paren
id|stlbrd_t
op_star
id|brdp
)paren
suffix:semicolon
r_static
r_inline
r_int
id|stl_initech
c_func
(paren
id|stlbrd_t
op_star
id|brdp
)paren
suffix:semicolon
r_static
r_inline
r_int
id|stl_getbrdnr
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#ifdef&t;CONFIG_PCI
r_static
r_inline
r_int
id|stl_findpcibrds
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_inline
r_int
id|stl_initpcibrd
c_func
(paren
r_int
id|brdtype
comma
r_struct
id|pci_dev
op_star
id|devp
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; *&t;CD1400 uart specific handling functions.&n; */
r_static
r_void
id|stl_cd1400setreg
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|regnr
comma
r_int
id|value
)paren
suffix:semicolon
r_static
r_int
id|stl_cd1400getreg
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|regnr
)paren
suffix:semicolon
r_static
r_int
id|stl_cd1400updatereg
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|regnr
comma
r_int
id|value
)paren
suffix:semicolon
r_static
r_int
id|stl_cd1400panelinit
c_func
(paren
id|stlbrd_t
op_star
id|brdp
comma
id|stlpanel_t
op_star
id|panelp
)paren
suffix:semicolon
r_static
r_void
id|stl_cd1400portinit
c_func
(paren
id|stlbrd_t
op_star
id|brdp
comma
id|stlpanel_t
op_star
id|panelp
comma
id|stlport_t
op_star
id|portp
)paren
suffix:semicolon
r_static
r_void
id|stl_cd1400setport
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_struct
id|termios
op_star
id|tiosp
)paren
suffix:semicolon
r_static
r_int
id|stl_cd1400getsignals
c_func
(paren
id|stlport_t
op_star
id|portp
)paren
suffix:semicolon
r_static
r_void
id|stl_cd1400setsignals
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|dtr
comma
r_int
id|rts
)paren
suffix:semicolon
r_static
r_void
id|stl_cd1400ccrwait
c_func
(paren
id|stlport_t
op_star
id|portp
)paren
suffix:semicolon
r_static
r_void
id|stl_cd1400enablerxtx
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|rx
comma
r_int
id|tx
)paren
suffix:semicolon
r_static
r_void
id|stl_cd1400startrxtx
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|rx
comma
r_int
id|tx
)paren
suffix:semicolon
r_static
r_void
id|stl_cd1400disableintrs
c_func
(paren
id|stlport_t
op_star
id|portp
)paren
suffix:semicolon
r_static
r_void
id|stl_cd1400sendbreak
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_void
id|stl_cd1400flowctrl
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|state
)paren
suffix:semicolon
r_static
r_void
id|stl_cd1400sendflow
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|state
)paren
suffix:semicolon
r_static
r_void
id|stl_cd1400flush
c_func
(paren
id|stlport_t
op_star
id|portp
)paren
suffix:semicolon
r_static
r_int
id|stl_cd1400datastate
c_func
(paren
id|stlport_t
op_star
id|portp
)paren
suffix:semicolon
r_static
r_void
id|stl_cd1400eiointr
c_func
(paren
id|stlpanel_t
op_star
id|panelp
comma
r_int
r_int
id|iobase
)paren
suffix:semicolon
r_static
r_void
id|stl_cd1400echintr
c_func
(paren
id|stlpanel_t
op_star
id|panelp
comma
r_int
r_int
id|iobase
)paren
suffix:semicolon
r_static
r_void
id|stl_cd1400txisr
c_func
(paren
id|stlpanel_t
op_star
id|panelp
comma
r_int
id|ioaddr
)paren
suffix:semicolon
r_static
r_void
id|stl_cd1400rxisr
c_func
(paren
id|stlpanel_t
op_star
id|panelp
comma
r_int
id|ioaddr
)paren
suffix:semicolon
r_static
r_void
id|stl_cd1400mdmisr
c_func
(paren
id|stlpanel_t
op_star
id|panelp
comma
r_int
id|ioaddr
)paren
suffix:semicolon
r_static
r_inline
r_int
id|stl_cd1400breakisr
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|ioaddr
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;SC26198 uart specific handling functions.&n; */
r_static
r_void
id|stl_sc26198setreg
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|regnr
comma
r_int
id|value
)paren
suffix:semicolon
r_static
r_int
id|stl_sc26198getreg
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|regnr
)paren
suffix:semicolon
r_static
r_int
id|stl_sc26198updatereg
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|regnr
comma
r_int
id|value
)paren
suffix:semicolon
r_static
r_int
id|stl_sc26198getglobreg
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|regnr
)paren
suffix:semicolon
r_static
r_int
id|stl_sc26198panelinit
c_func
(paren
id|stlbrd_t
op_star
id|brdp
comma
id|stlpanel_t
op_star
id|panelp
)paren
suffix:semicolon
r_static
r_void
id|stl_sc26198portinit
c_func
(paren
id|stlbrd_t
op_star
id|brdp
comma
id|stlpanel_t
op_star
id|panelp
comma
id|stlport_t
op_star
id|portp
)paren
suffix:semicolon
r_static
r_void
id|stl_sc26198setport
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_struct
id|termios
op_star
id|tiosp
)paren
suffix:semicolon
r_static
r_int
id|stl_sc26198getsignals
c_func
(paren
id|stlport_t
op_star
id|portp
)paren
suffix:semicolon
r_static
r_void
id|stl_sc26198setsignals
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|dtr
comma
r_int
id|rts
)paren
suffix:semicolon
r_static
r_void
id|stl_sc26198enablerxtx
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|rx
comma
r_int
id|tx
)paren
suffix:semicolon
r_static
r_void
id|stl_sc26198startrxtx
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|rx
comma
r_int
id|tx
)paren
suffix:semicolon
r_static
r_void
id|stl_sc26198disableintrs
c_func
(paren
id|stlport_t
op_star
id|portp
)paren
suffix:semicolon
r_static
r_void
id|stl_sc26198sendbreak
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_void
id|stl_sc26198flowctrl
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|state
)paren
suffix:semicolon
r_static
r_void
id|stl_sc26198sendflow
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|state
)paren
suffix:semicolon
r_static
r_void
id|stl_sc26198flush
c_func
(paren
id|stlport_t
op_star
id|portp
)paren
suffix:semicolon
r_static
r_int
id|stl_sc26198datastate
c_func
(paren
id|stlport_t
op_star
id|portp
)paren
suffix:semicolon
r_static
r_void
id|stl_sc26198wait
c_func
(paren
id|stlport_t
op_star
id|portp
)paren
suffix:semicolon
r_static
r_void
id|stl_sc26198txunflow
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_void
id|stl_sc26198intr
c_func
(paren
id|stlpanel_t
op_star
id|panelp
comma
r_int
r_int
id|iobase
)paren
suffix:semicolon
r_static
r_void
id|stl_sc26198txisr
c_func
(paren
id|stlport_t
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|stl_sc26198rxisr
c_func
(paren
id|stlport_t
op_star
id|port
comma
r_int
r_int
id|iack
)paren
suffix:semicolon
r_static
r_void
id|stl_sc26198rxbadch
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
r_char
id|status
comma
r_char
id|ch
)paren
suffix:semicolon
r_static
r_void
id|stl_sc26198rxbadchars
c_func
(paren
id|stlport_t
op_star
id|portp
)paren
suffix:semicolon
r_static
r_void
id|stl_sc26198otherisr
c_func
(paren
id|stlport_t
op_star
id|port
comma
r_int
r_int
id|iack
)paren
suffix:semicolon
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Generic UART support structure.&n; */
DECL|struct|uart
r_typedef
r_struct
id|uart
(brace
DECL|member|panelinit
r_int
(paren
op_star
id|panelinit
)paren
(paren
id|stlbrd_t
op_star
id|brdp
comma
id|stlpanel_t
op_star
id|panelp
)paren
suffix:semicolon
DECL|member|portinit
r_void
(paren
op_star
id|portinit
)paren
(paren
id|stlbrd_t
op_star
id|brdp
comma
id|stlpanel_t
op_star
id|panelp
comma
id|stlport_t
op_star
id|portp
)paren
suffix:semicolon
DECL|member|setport
r_void
(paren
op_star
id|setport
)paren
(paren
id|stlport_t
op_star
id|portp
comma
r_struct
id|termios
op_star
id|tiosp
)paren
suffix:semicolon
DECL|member|getsignals
r_int
(paren
op_star
id|getsignals
)paren
(paren
id|stlport_t
op_star
id|portp
)paren
suffix:semicolon
DECL|member|setsignals
r_void
(paren
op_star
id|setsignals
)paren
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|dtr
comma
r_int
id|rts
)paren
suffix:semicolon
DECL|member|enablerxtx
r_void
(paren
op_star
id|enablerxtx
)paren
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|rx
comma
r_int
id|tx
)paren
suffix:semicolon
DECL|member|startrxtx
r_void
(paren
op_star
id|startrxtx
)paren
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|rx
comma
r_int
id|tx
)paren
suffix:semicolon
DECL|member|disableintrs
r_void
(paren
op_star
id|disableintrs
)paren
(paren
id|stlport_t
op_star
id|portp
)paren
suffix:semicolon
DECL|member|sendbreak
r_void
(paren
op_star
id|sendbreak
)paren
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|len
)paren
suffix:semicolon
DECL|member|flowctrl
r_void
(paren
op_star
id|flowctrl
)paren
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|state
)paren
suffix:semicolon
DECL|member|sendflow
r_void
(paren
op_star
id|sendflow
)paren
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|state
)paren
suffix:semicolon
DECL|member|flush
r_void
(paren
op_star
id|flush
)paren
(paren
id|stlport_t
op_star
id|portp
)paren
suffix:semicolon
DECL|member|datastate
r_int
(paren
op_star
id|datastate
)paren
(paren
id|stlport_t
op_star
id|portp
)paren
suffix:semicolon
DECL|member|intr
r_void
(paren
op_star
id|intr
)paren
(paren
id|stlpanel_t
op_star
id|panelp
comma
r_int
r_int
id|iobase
)paren
suffix:semicolon
DECL|typedef|uart_t
)brace
id|uart_t
suffix:semicolon
multiline_comment|/*&n; *&t;Define some macros to make calling these functions nice and clean.&n; */
DECL|macro|stl_panelinit
mdefine_line|#define&t;stl_panelinit&t;&t;(* ((uart_t *) panelp-&gt;uartp)-&gt;panelinit)
DECL|macro|stl_portinit
mdefine_line|#define&t;stl_portinit&t;&t;(* ((uart_t *) portp-&gt;uartp)-&gt;portinit)
DECL|macro|stl_setport
mdefine_line|#define&t;stl_setport&t;&t;(* ((uart_t *) portp-&gt;uartp)-&gt;setport)
DECL|macro|stl_getsignals
mdefine_line|#define&t;stl_getsignals&t;&t;(* ((uart_t *) portp-&gt;uartp)-&gt;getsignals)
DECL|macro|stl_setsignals
mdefine_line|#define&t;stl_setsignals&t;&t;(* ((uart_t *) portp-&gt;uartp)-&gt;setsignals)
DECL|macro|stl_enablerxtx
mdefine_line|#define&t;stl_enablerxtx&t;&t;(* ((uart_t *) portp-&gt;uartp)-&gt;enablerxtx)
DECL|macro|stl_startrxtx
mdefine_line|#define&t;stl_startrxtx&t;&t;(* ((uart_t *) portp-&gt;uartp)-&gt;startrxtx)
DECL|macro|stl_disableintrs
mdefine_line|#define&t;stl_disableintrs&t;(* ((uart_t *) portp-&gt;uartp)-&gt;disableintrs)
DECL|macro|stl_sendbreak
mdefine_line|#define&t;stl_sendbreak&t;&t;(* ((uart_t *) portp-&gt;uartp)-&gt;sendbreak)
DECL|macro|stl_flowctrl
mdefine_line|#define&t;stl_flowctrl&t;&t;(* ((uart_t *) portp-&gt;uartp)-&gt;flowctrl)
DECL|macro|stl_sendflow
mdefine_line|#define&t;stl_sendflow&t;&t;(* ((uart_t *) portp-&gt;uartp)-&gt;sendflow)
DECL|macro|stl_flush
mdefine_line|#define&t;stl_flush&t;&t;(* ((uart_t *) portp-&gt;uartp)-&gt;flush)
DECL|macro|stl_datastate
mdefine_line|#define&t;stl_datastate&t;&t;(* ((uart_t *) portp-&gt;uartp)-&gt;datastate)
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;CD1400 UART specific data initialization.&n; */
DECL|variable|stl_cd1400uart
r_static
id|uart_t
id|stl_cd1400uart
op_assign
(brace
id|stl_cd1400panelinit
comma
id|stl_cd1400portinit
comma
id|stl_cd1400setport
comma
id|stl_cd1400getsignals
comma
id|stl_cd1400setsignals
comma
id|stl_cd1400enablerxtx
comma
id|stl_cd1400startrxtx
comma
id|stl_cd1400disableintrs
comma
id|stl_cd1400sendbreak
comma
id|stl_cd1400flowctrl
comma
id|stl_cd1400sendflow
comma
id|stl_cd1400flush
comma
id|stl_cd1400datastate
comma
id|stl_cd1400eiointr
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;Define the offsets within the register bank of a cd1400 based panel.&n; *&t;These io address offsets are common to the EasyIO board as well.&n; */
DECL|macro|EREG_ADDR
mdefine_line|#define&t;EREG_ADDR&t;0
DECL|macro|EREG_DATA
mdefine_line|#define&t;EREG_DATA&t;4
DECL|macro|EREG_RXACK
mdefine_line|#define&t;EREG_RXACK&t;5
DECL|macro|EREG_TXACK
mdefine_line|#define&t;EREG_TXACK&t;6
DECL|macro|EREG_MDACK
mdefine_line|#define&t;EREG_MDACK&t;7
DECL|macro|EREG_BANKSIZE
mdefine_line|#define&t;EREG_BANKSIZE&t;8
DECL|macro|CD1400_CLK
mdefine_line|#define&t;CD1400_CLK&t;25000000
DECL|macro|CD1400_CLK8M
mdefine_line|#define&t;CD1400_CLK8M&t;20000000
multiline_comment|/*&n; *&t;Define the cd1400 baud rate clocks. These are used when calculating&n; *&t;what clock and divisor to use for the required baud rate. Also&n; *&t;define the maximum baud rate allowed, and the default base baud.&n; */
DECL|variable|stl_cd1400clkdivs
r_static
r_int
id|stl_cd1400clkdivs
(braket
)braket
op_assign
(brace
id|CD1400_CLK0
comma
id|CD1400_CLK1
comma
id|CD1400_CLK2
comma
id|CD1400_CLK3
comma
id|CD1400_CLK4
)brace
suffix:semicolon
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;SC26198 UART specific data initization.&n; */
DECL|variable|stl_sc26198uart
r_static
id|uart_t
id|stl_sc26198uart
op_assign
(brace
id|stl_sc26198panelinit
comma
id|stl_sc26198portinit
comma
id|stl_sc26198setport
comma
id|stl_sc26198getsignals
comma
id|stl_sc26198setsignals
comma
id|stl_sc26198enablerxtx
comma
id|stl_sc26198startrxtx
comma
id|stl_sc26198disableintrs
comma
id|stl_sc26198sendbreak
comma
id|stl_sc26198flowctrl
comma
id|stl_sc26198sendflow
comma
id|stl_sc26198flush
comma
id|stl_sc26198datastate
comma
id|stl_sc26198intr
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;Define the offsets within the register bank of a sc26198 based panel.&n; */
DECL|macro|XP_DATA
mdefine_line|#define&t;XP_DATA&t;&t;0
DECL|macro|XP_ADDR
mdefine_line|#define&t;XP_ADDR&t;&t;1
DECL|macro|XP_MODID
mdefine_line|#define&t;XP_MODID&t;2
DECL|macro|XP_STATUS
mdefine_line|#define&t;XP_STATUS&t;2
DECL|macro|XP_IACK
mdefine_line|#define&t;XP_IACK&t;&t;3
DECL|macro|XP_BANKSIZE
mdefine_line|#define&t;XP_BANKSIZE&t;4
multiline_comment|/*&n; *&t;Define the sc26198 baud rate table. Offsets within the table&n; *&t;represent the actual baud rate selector of sc26198 registers.&n; */
DECL|variable|sc26198_baudtable
r_static
r_int
r_int
id|sc26198_baudtable
(braket
)braket
op_assign
(brace
l_int|50
comma
l_int|75
comma
l_int|150
comma
l_int|200
comma
l_int|300
comma
l_int|450
comma
l_int|600
comma
l_int|900
comma
l_int|1200
comma
l_int|1800
comma
l_int|2400
comma
l_int|3600
comma
l_int|4800
comma
l_int|7200
comma
l_int|9600
comma
l_int|14400
comma
l_int|19200
comma
l_int|28800
comma
l_int|38400
comma
l_int|57600
comma
l_int|115200
comma
l_int|230400
comma
l_int|460800
comma
l_int|921600
)brace
suffix:semicolon
DECL|macro|SC26198_NRBAUDS
mdefine_line|#define&t;SC26198_NRBAUDS&t;&t;(sizeof(sc26198_baudtable) / sizeof(unsigned int))
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Define the driver info for a user level control device. Used mainly&n; *&t;to get at port stats - only not using the port device itself.&n; */
DECL|variable|stl_fsiomem
r_static
r_struct
id|file_operations
id|stl_fsiomem
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|ioctl
suffix:colon
id|stl_memioctl
comma
)brace
suffix:semicolon
multiline_comment|/*****************************************************************************/
DECL|variable|devfs_handle
r_static
id|devfs_handle_t
id|devfs_handle
suffix:semicolon
macro_line|#ifdef MODULE
multiline_comment|/*&n; *&t;Loadable module initialization stuff.&n; */
DECL|function|init_module
r_int
id|init_module
c_func
(paren
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;init_module()&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|stl_init
c_func
(paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
)paren
(brace
id|stlbrd_t
op_star
id|brdp
suffix:semicolon
id|stlpanel_t
op_star
id|panelp
suffix:semicolon
id|stlport_t
op_star
id|portp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|k
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;cleanup_module()&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Unloading %s: version %s&bslash;n&quot;
comma
id|stl_drvtitle
comma
id|stl_drvversion
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;Free up all allocated resources used by the ports. This includes&n; *&t;memory and interrupts. As part of this process we will also do&n; *&t;a hangup on every open port - to try to flush out any processes&n; *&t;hanging onto ports.&n; */
id|i
op_assign
id|tty_unregister_driver
c_func
(paren
op_amp
id|stl_serial
)paren
suffix:semicolon
id|j
op_assign
id|tty_unregister_driver
c_func
(paren
op_amp
id|stl_callout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_logical_or
id|j
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;STALLION: failed to un-register tty driver, &quot;
l_string|&quot;errno=%d,%d&bslash;n&quot;
comma
op_minus
id|i
comma
op_minus
id|j
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|devfs_unregister
(paren
id|devfs_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|devfs_unregister_chrdev
c_func
(paren
id|STL_SIOMEMMAJOR
comma
l_string|&quot;staliomem&quot;
)paren
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;STALLION: failed to un-register serial memory device, &quot;
l_string|&quot;errno=%d&bslash;n&quot;
comma
op_minus
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stl_tmpwritebuf
op_ne
(paren
r_char
op_star
)paren
l_int|NULL
)paren
id|kfree
c_func
(paren
id|stl_tmpwritebuf
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|stl_nrbrds
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|brdp
op_assign
id|stl_brds
(braket
id|i
)braket
)paren
op_eq
(paren
id|stlbrd_t
op_star
)paren
l_int|NULL
)paren
r_continue
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
(paren
id|j
OL
id|STL_MAXPANELS
)paren
suffix:semicolon
id|j
op_increment
)paren
(brace
id|panelp
op_assign
id|brdp-&gt;panels
(braket
id|j
)braket
suffix:semicolon
r_if
c_cond
(paren
id|panelp
op_eq
(paren
id|stlpanel_t
op_star
)paren
l_int|NULL
)paren
r_continue
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
(paren
id|k
OL
id|STL_PORTSPERPANEL
)paren
suffix:semicolon
id|k
op_increment
)paren
(brace
id|portp
op_assign
id|panelp-&gt;ports
(braket
id|k
)braket
suffix:semicolon
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|portp-&gt;tty
op_ne
(paren
r_struct
id|tty_struct
op_star
)paren
l_int|NULL
)paren
id|stl_hangup
c_func
(paren
id|portp-&gt;tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|portp-&gt;tx.buf
op_ne
(paren
r_char
op_star
)paren
l_int|NULL
)paren
id|kfree
c_func
(paren
id|portp-&gt;tx.buf
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|portp
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|panelp
)paren
suffix:semicolon
)brace
id|release_region
c_func
(paren
id|brdp-&gt;ioaddr1
comma
id|brdp-&gt;iosize1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|brdp-&gt;iosize2
OG
l_int|0
)paren
id|release_region
c_func
(paren
id|brdp-&gt;ioaddr2
comma
id|brdp-&gt;iosize2
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|brdp
)paren
suffix:semicolon
id|stl_brds
(braket
id|i
)braket
op_assign
(paren
id|stlbrd_t
op_star
)paren
l_int|NULL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|stl_numintrs
)paren
suffix:semicolon
id|i
op_increment
)paren
id|free_irq
c_func
(paren
id|stl_gotintrs
(braket
id|i
)braket
comma
l_int|NULL
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Check for any arguments passed in on the module load command line.&n; */
DECL|function|stl_argbrds
r_static
r_void
id|stl_argbrds
c_func
(paren
)paren
(brace
id|stlconf_t
id|conf
suffix:semicolon
id|stlbrd_t
op_star
id|brdp
suffix:semicolon
r_int
id|nrargs
comma
id|i
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_argbrds()&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|nrargs
op_assign
r_sizeof
(paren
id|stl_brdsp
)paren
op_div
r_sizeof
(paren
r_char
op_star
op_star
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|stl_nrbrds
suffix:semicolon
(paren
id|i
OL
id|nrargs
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|memset
c_func
(paren
op_amp
id|conf
comma
l_int|0
comma
r_sizeof
(paren
id|conf
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stl_parsebrd
c_func
(paren
op_amp
id|conf
comma
id|stl_brdsp
(braket
id|i
)braket
)paren
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|brdp
op_assign
id|stl_allocbrd
c_func
(paren
)paren
)paren
op_eq
(paren
id|stlbrd_t
op_star
)paren
l_int|NULL
)paren
r_continue
suffix:semicolon
id|stl_nrbrds
op_assign
id|i
op_plus
l_int|1
suffix:semicolon
id|brdp-&gt;brdnr
op_assign
id|i
suffix:semicolon
id|brdp-&gt;brdtype
op_assign
id|conf.brdtype
suffix:semicolon
id|brdp-&gt;ioaddr1
op_assign
id|conf.ioaddr1
suffix:semicolon
id|brdp-&gt;ioaddr2
op_assign
id|conf.ioaddr2
suffix:semicolon
id|brdp-&gt;irq
op_assign
id|conf.irq
suffix:semicolon
id|brdp-&gt;irqtype
op_assign
id|conf.irqtype
suffix:semicolon
id|stl_brdinit
c_func
(paren
id|brdp
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Convert an ascii string number into an unsigned long.&n; */
DECL|function|stl_atol
r_static
r_int
r_int
id|stl_atol
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_int
r_int
id|val
suffix:semicolon
r_int
id|base
comma
id|c
suffix:semicolon
r_char
op_star
id|sp
suffix:semicolon
id|val
op_assign
l_int|0
suffix:semicolon
id|sp
op_assign
id|str
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|sp
op_eq
l_char|&squot;0&squot;
)paren
op_logical_and
(paren
op_star
(paren
id|sp
op_plus
l_int|1
)paren
op_eq
l_char|&squot;x&squot;
)paren
)paren
(brace
id|base
op_assign
l_int|16
suffix:semicolon
id|sp
op_add_assign
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_star
id|sp
op_eq
l_char|&squot;0&squot;
)paren
(brace
id|base
op_assign
l_int|8
suffix:semicolon
id|sp
op_increment
suffix:semicolon
)brace
r_else
(brace
id|base
op_assign
l_int|10
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
(paren
op_star
id|sp
op_ne
l_int|0
)paren
suffix:semicolon
id|sp
op_increment
)paren
(brace
id|c
op_assign
(paren
op_star
id|sp
OG
l_char|&squot;9&squot;
)paren
ques
c_cond
(paren
id|TOLOWER
c_func
(paren
op_star
id|sp
)paren
op_minus
l_char|&squot;a&squot;
op_plus
l_int|10
)paren
suffix:colon
(paren
op_star
id|sp
op_minus
l_char|&squot;0&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|c
OL
l_int|0
)paren
op_logical_or
(paren
id|c
op_ge
id|base
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;STALLION: invalid argument %s&bslash;n&quot;
comma
id|str
)paren
suffix:semicolon
id|val
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|val
op_assign
(paren
id|val
op_star
id|base
)paren
op_plus
id|c
suffix:semicolon
)brace
r_return
id|val
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Parse the supplied argument string, into the board conf struct.&n; */
DECL|function|stl_parsebrd
r_static
r_int
id|stl_parsebrd
c_func
(paren
id|stlconf_t
op_star
id|confp
comma
r_char
op_star
op_star
id|argp
)paren
(brace
r_char
op_star
id|sp
suffix:semicolon
r_int
id|nrbrdnames
comma
id|i
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_parsebrd(confp=%x,argp=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|confp
comma
(paren
r_int
)paren
id|argp
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|argp
(braket
l_int|0
)braket
op_eq
(paren
r_char
op_star
)paren
l_int|NULL
)paren
op_logical_or
(paren
op_star
id|argp
(braket
l_int|0
)braket
op_eq
l_int|0
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|sp
op_assign
id|argp
(braket
l_int|0
)braket
comma
id|i
op_assign
l_int|0
suffix:semicolon
(paren
(paren
op_star
id|sp
op_ne
l_int|0
)paren
op_logical_and
(paren
id|i
OL
l_int|25
)paren
)paren
suffix:semicolon
id|sp
op_increment
comma
id|i
op_increment
)paren
op_star
id|sp
op_assign
id|TOLOWER
c_func
(paren
op_star
id|sp
)paren
suffix:semicolon
id|nrbrdnames
op_assign
r_sizeof
(paren
id|stl_brdstr
)paren
op_div
r_sizeof
(paren
id|stlbrdtype_t
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|nrbrdnames
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|stl_brdstr
(braket
id|i
)braket
dot
id|name
comma
id|argp
(braket
l_int|0
)braket
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ge
id|nrbrdnames
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;STALLION: unknown board name, %s?&bslash;n&quot;
comma
id|argp
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|confp-&gt;brdtype
op_assign
id|stl_brdstr
(braket
id|i
)braket
dot
id|type
suffix:semicolon
id|i
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|argp
(braket
id|i
)braket
op_ne
(paren
r_char
op_star
)paren
l_int|NULL
)paren
op_logical_and
(paren
op_star
id|argp
(braket
id|i
)braket
op_ne
l_int|0
)paren
)paren
id|confp-&gt;ioaddr1
op_assign
id|stl_atol
c_func
(paren
id|argp
(braket
id|i
)braket
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|confp-&gt;brdtype
op_eq
id|BRD_ECH
)paren
(brace
r_if
c_cond
(paren
(paren
id|argp
(braket
id|i
)braket
op_ne
(paren
r_char
op_star
)paren
l_int|NULL
)paren
op_logical_and
(paren
op_star
id|argp
(braket
id|i
)braket
op_ne
l_int|0
)paren
)paren
id|confp-&gt;ioaddr2
op_assign
id|stl_atol
c_func
(paren
id|argp
(braket
id|i
)braket
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|argp
(braket
id|i
)braket
op_ne
(paren
r_char
op_star
)paren
l_int|NULL
)paren
op_logical_and
(paren
op_star
id|argp
(braket
id|i
)braket
op_ne
l_int|0
)paren
)paren
id|confp-&gt;irq
op_assign
id|stl_atol
c_func
(paren
id|argp
(braket
id|i
)braket
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Local driver kernel memory allocation routine.&n; */
DECL|function|stl_memalloc
r_static
r_void
op_star
id|stl_memalloc
c_func
(paren
r_int
id|len
)paren
(brace
r_return
(paren
r_void
op_star
)paren
id|kmalloc
c_func
(paren
id|len
comma
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Allocate a new board structure. Fill out the basic info in it.&n; */
DECL|function|stl_allocbrd
r_static
id|stlbrd_t
op_star
id|stl_allocbrd
c_func
(paren
)paren
(brace
id|stlbrd_t
op_star
id|brdp
suffix:semicolon
id|brdp
op_assign
(paren
id|stlbrd_t
op_star
)paren
id|stl_memalloc
c_func
(paren
r_sizeof
(paren
id|stlbrd_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|brdp
op_eq
(paren
id|stlbrd_t
op_star
)paren
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;STALLION: failed to allocate memory (size=%d)&bslash;n&quot;
comma
r_sizeof
(paren
id|stlbrd_t
)paren
)paren
suffix:semicolon
r_return
(paren
id|stlbrd_t
op_star
)paren
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|brdp
comma
l_int|0
comma
r_sizeof
(paren
id|stlbrd_t
)paren
)paren
suffix:semicolon
id|brdp-&gt;magic
op_assign
id|STL_BOARDMAGIC
suffix:semicolon
r_return
id|brdp
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|stl_open
r_static
r_int
id|stl_open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|stlport_t
op_star
id|portp
suffix:semicolon
id|stlbrd_t
op_star
id|brdp
suffix:semicolon
r_int
r_int
id|minordev
suffix:semicolon
r_int
id|brdnr
comma
id|panelnr
comma
id|portnr
comma
id|rc
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_open(tty=%x,filp=%x): device=%x&bslash;n&quot;
comma
(paren
r_int
)paren
id|tty
comma
(paren
r_int
)paren
id|filp
comma
id|tty-&gt;device
)paren
suffix:semicolon
macro_line|#endif
id|minordev
op_assign
id|MINOR
c_func
(paren
id|tty-&gt;device
)paren
suffix:semicolon
id|brdnr
op_assign
id|MINOR2BRD
c_func
(paren
id|minordev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|brdnr
op_ge
id|stl_nrbrds
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|brdp
op_assign
id|stl_brds
(braket
id|brdnr
)braket
suffix:semicolon
r_if
c_cond
(paren
id|brdp
op_eq
(paren
id|stlbrd_t
op_star
)paren
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|minordev
op_assign
id|MINOR2PORT
c_func
(paren
id|minordev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|portnr
op_assign
op_minus
l_int|1
comma
id|panelnr
op_assign
l_int|0
suffix:semicolon
(paren
id|panelnr
OL
id|STL_MAXPANELS
)paren
suffix:semicolon
id|panelnr
op_increment
)paren
(brace
r_if
c_cond
(paren
id|brdp-&gt;panels
(braket
id|panelnr
)braket
op_eq
(paren
id|stlpanel_t
op_star
)paren
l_int|NULL
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|minordev
OL
id|brdp-&gt;panels
(braket
id|panelnr
)braket
op_member_access_from_pointer
id|nrports
)paren
(brace
id|portnr
op_assign
id|minordev
suffix:semicolon
r_break
suffix:semicolon
)brace
id|minordev
op_sub_assign
id|brdp-&gt;panels
(braket
id|panelnr
)braket
op_member_access_from_pointer
id|nrports
suffix:semicolon
)brace
r_if
c_cond
(paren
id|portnr
OL
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|portp
op_assign
id|brdp-&gt;panels
(braket
id|panelnr
)braket
op_member_access_from_pointer
id|ports
(braket
id|portnr
)braket
suffix:semicolon
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
multiline_comment|/*&n; *&t;On the first open of the device setup the port hardware, and&n; *&t;initialize the per port data structure.&n; */
id|portp-&gt;tty
op_assign
id|tty
suffix:semicolon
id|tty-&gt;driver_data
op_assign
id|portp
suffix:semicolon
id|portp-&gt;refcount
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_INITIALIZED
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|portp-&gt;tx.buf
op_eq
(paren
r_char
op_star
)paren
l_int|NULL
)paren
(brace
id|portp-&gt;tx.buf
op_assign
(paren
r_char
op_star
)paren
id|stl_memalloc
c_func
(paren
id|STL_TXBUFSIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|portp-&gt;tx.buf
op_eq
(paren
r_char
op_star
)paren
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|portp-&gt;tx.head
op_assign
id|portp-&gt;tx.buf
suffix:semicolon
id|portp-&gt;tx.tail
op_assign
id|portp-&gt;tx.buf
suffix:semicolon
)brace
id|stl_setport
c_func
(paren
id|portp
comma
id|tty-&gt;termios
)paren
suffix:semicolon
id|portp-&gt;sigs
op_assign
id|stl_getsignals
c_func
(paren
id|portp
)paren
suffix:semicolon
id|stl_setsignals
c_func
(paren
id|portp
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
id|stl_enablerxtx
c_func
(paren
id|portp
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
id|stl_startrxtx
c_func
(paren
id|portp
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|TTY_IO_ERROR
comma
op_amp
id|tty-&gt;flags
)paren
suffix:semicolon
id|portp-&gt;flags
op_or_assign
id|ASYNC_INITIALIZED
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Check if this port is in the middle of closing. If so then wait&n; *&t;until it is closed then return error status, based on flag settings.&n; *&t;The sleep here does not need interrupt protection since the wakeup&n; *&t;for it is done with the same context.&n; */
r_if
c_cond
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_CLOSING
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|portp-&gt;close_wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_HUP_NOTIFY
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Based on type of open being done check if it can overlap with any&n; *&t;previous opens still in effect. If we are a normal serial device&n; *&t;then also we might have to wait for carrier.&n; */
r_if
c_cond
(paren
id|tty-&gt;driver.subtype
op_eq
id|STL_DRVTYPCALLOUT
)paren
(brace
r_if
c_cond
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_NORMAL_ACTIVE
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
(brace
r_if
c_cond
(paren
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_SESSION_LOCKOUT
)paren
op_logical_and
(paren
id|portp-&gt;session
op_ne
id|current-&gt;session
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_PGRP_LOCKOUT
)paren
op_logical_and
(paren
id|portp-&gt;pgrp
op_ne
id|current-&gt;pgrp
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|portp-&gt;flags
op_or_assign
id|ASYNC_CALLOUT_ACTIVE
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|filp-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
r_if
c_cond
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|stl_waitcarrier
c_func
(paren
id|portp
comma
id|filp
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|rc
suffix:semicolon
)brace
id|portp-&gt;flags
op_or_assign
id|ASYNC_NORMAL_ACTIVE
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|portp-&gt;refcount
op_eq
l_int|1
)paren
op_logical_and
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_SPLIT_TERMIOS
)paren
)paren
(brace
r_if
c_cond
(paren
id|tty-&gt;driver.subtype
op_eq
id|STL_DRVTYPSERIAL
)paren
op_star
id|tty-&gt;termios
op_assign
id|portp-&gt;normaltermios
suffix:semicolon
r_else
op_star
id|tty-&gt;termios
op_assign
id|portp-&gt;callouttermios
suffix:semicolon
id|stl_setport
c_func
(paren
id|portp
comma
id|tty-&gt;termios
)paren
suffix:semicolon
)brace
id|portp-&gt;session
op_assign
id|current-&gt;session
suffix:semicolon
id|portp-&gt;pgrp
op_assign
id|current-&gt;pgrp
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Possibly need to wait for carrier (DCD signal) to come high. Say&n; *&t;maybe because if we are clocal then we don&squot;t need to wait...&n; */
DECL|function|stl_waitcarrier
r_static
r_int
id|stl_waitcarrier
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|rc
comma
id|doclocal
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_waitcarrier(portp=%x,filp=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|portp
comma
(paren
r_int
)paren
id|filp
)paren
suffix:semicolon
macro_line|#endif
id|rc
op_assign
l_int|0
suffix:semicolon
id|doclocal
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
(brace
r_if
c_cond
(paren
id|portp-&gt;normaltermios.c_cflag
op_amp
id|CLOCAL
)paren
id|doclocal
op_increment
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|portp-&gt;tty-&gt;termios-&gt;c_cflag
op_amp
id|CLOCAL
)paren
id|doclocal
op_increment
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|portp-&gt;openwaitcnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
)paren
id|portp-&gt;refcount
op_decrement
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
op_eq
l_int|0
)paren
id|stl_setsignals
c_func
(paren
id|portp
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
op_logical_or
(paren
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_INITIALIZED
)paren
op_eq
l_int|0
)paren
)paren
(brace
r_if
c_cond
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_HUP_NOTIFY
)paren
id|rc
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_else
id|rc
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_CLOSING
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|doclocal
op_logical_or
(paren
id|portp-&gt;sigs
op_amp
id|TIOCM_CD
)paren
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_break
suffix:semicolon
)brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|portp-&gt;open_wait
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
)paren
id|portp-&gt;refcount
op_increment
suffix:semicolon
id|portp-&gt;openwaitcnt
op_decrement
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|stl_close
r_static
r_void
id|stl_close
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|stlport_t
op_star
id|portp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_close(tty=%x,filp=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|tty
comma
(paren
r_int
)paren
id|filp
)paren
suffix:semicolon
macro_line|#endif
id|portp
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|tty-&gt;count
op_eq
l_int|1
)paren
op_logical_and
(paren
id|portp-&gt;refcount
op_ne
l_int|1
)paren
)paren
id|portp-&gt;refcount
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|portp-&gt;refcount
op_decrement
OG
l_int|1
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|portp-&gt;refcount
op_assign
l_int|0
suffix:semicolon
id|portp-&gt;flags
op_or_assign
id|ASYNC_CLOSING
suffix:semicolon
r_if
c_cond
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_NORMAL_ACTIVE
)paren
id|portp-&gt;normaltermios
op_assign
op_star
id|tty-&gt;termios
suffix:semicolon
r_if
c_cond
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
id|portp-&gt;callouttermios
op_assign
op_star
id|tty-&gt;termios
suffix:semicolon
multiline_comment|/*&n; *&t;May want to wait for any data to drain before closing. The BUSY&n; *&t;flag keeps track of whether we are still sending or not - it is&n; *&t;very accurate for the cd1400, not quite so for the sc26198.&n; *&t;(The sc26198 has no &quot;end-of-data&quot; interrupt only empty FIFO)&n; */
id|tty-&gt;closing
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|portp-&gt;closing_wait
op_ne
id|ASYNC_CLOSING_WAIT_NONE
)paren
id|tty_wait_until_sent
c_func
(paren
id|tty
comma
id|portp-&gt;closing_wait
)paren
suffix:semicolon
id|stl_waituntilsent
c_func
(paren
id|tty
comma
(paren
id|HZ
op_div
l_int|2
)paren
)paren
suffix:semicolon
id|portp-&gt;flags
op_and_assign
op_complement
id|ASYNC_INITIALIZED
suffix:semicolon
id|stl_disableintrs
c_func
(paren
id|portp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|HUPCL
)paren
id|stl_setsignals
c_func
(paren
id|portp
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|stl_enablerxtx
c_func
(paren
id|portp
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|stl_flushbuffer
c_func
(paren
id|tty
)paren
suffix:semicolon
id|portp-&gt;istate
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|portp-&gt;tx.buf
op_ne
(paren
r_char
op_star
)paren
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|portp-&gt;tx.buf
)paren
suffix:semicolon
id|portp-&gt;tx.buf
op_assign
(paren
r_char
op_star
)paren
l_int|NULL
suffix:semicolon
id|portp-&gt;tx.head
op_assign
(paren
r_char
op_star
)paren
l_int|NULL
suffix:semicolon
id|portp-&gt;tx.tail
op_assign
(paren
r_char
op_star
)paren
l_int|NULL
suffix:semicolon
)brace
id|set_bit
c_func
(paren
id|TTY_IO_ERROR
comma
op_amp
id|tty-&gt;flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;ldisc.flush_buffer
)paren
(paren
id|tty-&gt;ldisc.flush_buffer
)paren
(paren
id|tty
)paren
suffix:semicolon
id|tty-&gt;closing
op_assign
l_int|0
suffix:semicolon
id|portp-&gt;tty
op_assign
(paren
r_struct
id|tty_struct
op_star
)paren
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|portp-&gt;openwaitcnt
)paren
(brace
r_if
c_cond
(paren
id|portp-&gt;close_delay
)paren
id|stl_delay
c_func
(paren
id|portp-&gt;close_delay
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|portp-&gt;open_wait
)paren
suffix:semicolon
)brace
id|portp-&gt;flags
op_and_assign
op_complement
(paren
id|ASYNC_CALLOUT_ACTIVE
op_or
id|ASYNC_NORMAL_ACTIVE
op_or
id|ASYNC_CLOSING
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|portp-&gt;close_wait
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Wait for a specified delay period, this is not a busy-loop. It will&n; *&t;give up the processor while waiting. Unfortunately this has some&n; *&t;rather intimate knowledge of the process management stuff.&n; */
DECL|function|stl_delay
r_static
r_void
id|stl_delay
c_func
(paren
r_int
id|len
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_delay(len=%d)&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|len
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
)brace
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Write routine. Take data and stuff it in to the TX ring queue.&n; *&t;If transmit interrupts are not running then start them.&n; */
DECL|function|stl_write
r_static
r_int
id|stl_write
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|from_user
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
id|stlport_t
op_star
id|portp
suffix:semicolon
r_int
r_int
id|len
comma
id|stlen
suffix:semicolon
r_int
r_char
op_star
id|chbuf
suffix:semicolon
r_char
op_star
id|head
comma
op_star
id|tail
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_write(tty=%x,from_user=%d,buf=%x,count=%d)&bslash;n&quot;
comma
(paren
r_int
)paren
id|tty
comma
id|from_user
comma
(paren
r_int
)paren
id|buf
comma
id|count
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|tty
op_eq
(paren
r_struct
id|tty_struct
op_star
)paren
l_int|NULL
)paren
op_logical_or
(paren
id|stl_tmpwritebuf
op_eq
(paren
r_char
op_star
)paren
l_int|NULL
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|portp
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|portp-&gt;tx.buf
op_eq
(paren
r_char
op_star
)paren
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n; *&t;If copying direct from user space we must cater for page faults,&n; *&t;causing us to &quot;sleep&quot; here for a while. To handle this copy in all&n; *&t;the data we need now, into a local buffer. Then when we got it all&n; *&t;copy it into the TX buffer.&n; */
id|chbuf
op_assign
(paren
r_int
r_char
op_star
)paren
id|buf
suffix:semicolon
r_if
c_cond
(paren
id|from_user
)paren
(brace
id|head
op_assign
id|portp-&gt;tx.head
suffix:semicolon
id|tail
op_assign
id|portp-&gt;tx.tail
suffix:semicolon
id|len
op_assign
(paren
id|head
op_ge
id|tail
)paren
ques
c_cond
(paren
id|STL_TXBUFSIZE
op_minus
(paren
id|head
op_minus
id|tail
)paren
op_minus
l_int|1
)paren
suffix:colon
(paren
id|tail
op_minus
id|head
op_minus
l_int|1
)paren
suffix:semicolon
id|count
op_assign
id|MIN
c_func
(paren
id|len
comma
id|count
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|stl_tmpwritesem
)paren
suffix:semicolon
id|copy_from_user
c_func
(paren
id|stl_tmpwritebuf
comma
id|chbuf
comma
id|count
)paren
suffix:semicolon
id|chbuf
op_assign
op_amp
id|stl_tmpwritebuf
(braket
l_int|0
)braket
suffix:semicolon
)brace
id|head
op_assign
id|portp-&gt;tx.head
suffix:semicolon
id|tail
op_assign
id|portp-&gt;tx.tail
suffix:semicolon
r_if
c_cond
(paren
id|head
op_ge
id|tail
)paren
(brace
id|len
op_assign
id|STL_TXBUFSIZE
op_minus
(paren
id|head
op_minus
id|tail
)paren
op_minus
l_int|1
suffix:semicolon
id|stlen
op_assign
id|STL_TXBUFSIZE
op_minus
(paren
id|head
op_minus
id|portp-&gt;tx.buf
)paren
suffix:semicolon
)brace
r_else
(brace
id|len
op_assign
id|tail
op_minus
id|head
op_minus
l_int|1
suffix:semicolon
id|stlen
op_assign
id|len
suffix:semicolon
)brace
id|len
op_assign
id|MIN
c_func
(paren
id|len
comma
id|count
)paren
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|len
OG
l_int|0
)paren
(brace
id|stlen
op_assign
id|MIN
c_func
(paren
id|len
comma
id|stlen
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|head
comma
id|chbuf
comma
id|stlen
)paren
suffix:semicolon
id|len
op_sub_assign
id|stlen
suffix:semicolon
id|chbuf
op_add_assign
id|stlen
suffix:semicolon
id|count
op_add_assign
id|stlen
suffix:semicolon
id|head
op_add_assign
id|stlen
suffix:semicolon
r_if
c_cond
(paren
id|head
op_ge
(paren
id|portp-&gt;tx.buf
op_plus
id|STL_TXBUFSIZE
)paren
)paren
(brace
id|head
op_assign
id|portp-&gt;tx.buf
suffix:semicolon
id|stlen
op_assign
id|tail
op_minus
id|head
suffix:semicolon
)brace
)brace
id|portp-&gt;tx.head
op_assign
id|head
suffix:semicolon
id|clear_bit
c_func
(paren
id|ASYI_TXLOW
comma
op_amp
id|portp-&gt;istate
)paren
suffix:semicolon
id|stl_startrxtx
c_func
(paren
id|portp
comma
op_minus
l_int|1
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|from_user
)paren
id|up
c_func
(paren
op_amp
id|stl_tmpwritesem
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|stl_putchar
r_static
r_void
id|stl_putchar
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
r_char
id|ch
)paren
(brace
id|stlport_t
op_star
id|portp
suffix:semicolon
r_int
r_int
id|len
suffix:semicolon
r_char
op_star
id|head
comma
op_star
id|tail
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_putchar(tty=%x,ch=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|tty
comma
(paren
r_int
)paren
id|ch
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|tty
op_eq
(paren
r_struct
id|tty_struct
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|portp
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|portp-&gt;tx.buf
op_eq
(paren
r_char
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|head
op_assign
id|portp-&gt;tx.head
suffix:semicolon
id|tail
op_assign
id|portp-&gt;tx.tail
suffix:semicolon
id|len
op_assign
(paren
id|head
op_ge
id|tail
)paren
ques
c_cond
(paren
id|STL_TXBUFSIZE
op_minus
(paren
id|head
op_minus
id|tail
)paren
)paren
suffix:colon
(paren
id|tail
op_minus
id|head
)paren
suffix:semicolon
id|len
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
op_star
id|head
op_increment
op_assign
id|ch
suffix:semicolon
r_if
c_cond
(paren
id|head
op_ge
(paren
id|portp-&gt;tx.buf
op_plus
id|STL_TXBUFSIZE
)paren
)paren
id|head
op_assign
id|portp-&gt;tx.buf
suffix:semicolon
)brace
id|portp-&gt;tx.head
op_assign
id|head
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;If there are any characters in the buffer then make sure that TX&n; *&t;interrupts are on and get&squot;em out. Normally used after the putchar&n; *&t;routine has been called.&n; */
DECL|function|stl_flushchars
r_static
r_void
id|stl_flushchars
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|stlport_t
op_star
id|portp
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_flushchars(tty=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|tty
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|tty
op_eq
(paren
r_struct
id|tty_struct
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|portp
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|portp-&gt;tx.buf
op_eq
(paren
r_char
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|tty-&gt;stopped
op_logical_or
id|tty-&gt;hw_stopped
op_logical_or
(paren
id|portp-&gt;tx.head
op_eq
id|portp-&gt;tx.tail
)paren
)paren
r_return
suffix:semicolon
macro_line|#endif
id|stl_startrxtx
c_func
(paren
id|portp
comma
op_minus
l_int|1
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|stl_writeroom
r_static
r_int
id|stl_writeroom
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|stlport_t
op_star
id|portp
suffix:semicolon
r_char
op_star
id|head
comma
op_star
id|tail
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_writeroom(tty=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|tty
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|tty
op_eq
(paren
r_struct
id|tty_struct
op_star
)paren
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|portp
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|portp-&gt;tx.buf
op_eq
(paren
r_char
op_star
)paren
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|head
op_assign
id|portp-&gt;tx.head
suffix:semicolon
id|tail
op_assign
id|portp-&gt;tx.tail
suffix:semicolon
r_return
(paren
id|head
op_ge
id|tail
)paren
ques
c_cond
(paren
id|STL_TXBUFSIZE
op_minus
(paren
id|head
op_minus
id|tail
)paren
op_minus
l_int|1
)paren
suffix:colon
(paren
id|tail
op_minus
id|head
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Return number of chars in the TX buffer. Normally we would just&n; *&t;calculate the number of chars in the buffer and return that, but if&n; *&t;the buffer is empty and TX interrupts are still on then we return&n; *&t;that the buffer still has 1 char in it. This way whoever called us&n; *&t;will not think that ALL chars have drained - since the UART still&n; *&t;must have some chars in it (we are busy after all).&n; */
DECL|function|stl_charsinbuffer
r_static
r_int
id|stl_charsinbuffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|stlport_t
op_star
id|portp
suffix:semicolon
r_int
r_int
id|size
suffix:semicolon
r_char
op_star
id|head
comma
op_star
id|tail
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_charsinbuffer(tty=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|tty
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|tty
op_eq
(paren
r_struct
id|tty_struct
op_star
)paren
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|portp
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|portp-&gt;tx.buf
op_eq
(paren
r_char
op_star
)paren
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|head
op_assign
id|portp-&gt;tx.head
suffix:semicolon
id|tail
op_assign
id|portp-&gt;tx.tail
suffix:semicolon
id|size
op_assign
(paren
id|head
op_ge
id|tail
)paren
ques
c_cond
(paren
id|head
op_minus
id|tail
)paren
suffix:colon
(paren
id|STL_TXBUFSIZE
op_minus
(paren
id|tail
op_minus
id|head
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|size
op_eq
l_int|0
)paren
op_logical_and
id|test_bit
c_func
(paren
id|ASYI_TXBUSY
comma
op_amp
id|portp-&gt;istate
)paren
)paren
id|size
op_assign
l_int|1
suffix:semicolon
r_return
id|size
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Generate the serial struct info.&n; */
DECL|function|stl_getserial
r_static
r_void
id|stl_getserial
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_struct
id|serial_struct
op_star
id|sp
)paren
(brace
r_struct
id|serial_struct
id|sio
suffix:semicolon
id|stlbrd_t
op_star
id|brdp
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_getserial(portp=%x,sp=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|portp
comma
(paren
r_int
)paren
id|sp
)paren
suffix:semicolon
macro_line|#endif
id|memset
c_func
(paren
op_amp
id|sio
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|serial_struct
)paren
)paren
suffix:semicolon
id|sio.line
op_assign
id|portp-&gt;portnr
suffix:semicolon
id|sio.port
op_assign
id|portp-&gt;ioaddr
suffix:semicolon
id|sio.flags
op_assign
id|portp-&gt;flags
suffix:semicolon
id|sio.baud_base
op_assign
id|portp-&gt;baud_base
suffix:semicolon
id|sio.close_delay
op_assign
id|portp-&gt;close_delay
suffix:semicolon
id|sio.closing_wait
op_assign
id|portp-&gt;closing_wait
suffix:semicolon
id|sio.custom_divisor
op_assign
id|portp-&gt;custom_divisor
suffix:semicolon
id|sio.hub6
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|portp-&gt;uartp
op_eq
op_amp
id|stl_cd1400uart
)paren
(brace
id|sio.type
op_assign
id|PORT_CIRRUS
suffix:semicolon
id|sio.xmit_fifo_size
op_assign
id|CD1400_TXFIFOSIZE
suffix:semicolon
)brace
r_else
(brace
id|sio.type
op_assign
id|PORT_UNKNOWN
suffix:semicolon
id|sio.xmit_fifo_size
op_assign
id|SC26198_TXFIFOSIZE
suffix:semicolon
)brace
id|brdp
op_assign
id|stl_brds
(braket
id|portp-&gt;brdnr
)braket
suffix:semicolon
r_if
c_cond
(paren
id|brdp
op_ne
(paren
id|stlbrd_t
op_star
)paren
l_int|NULL
)paren
id|sio.irq
op_assign
id|brdp-&gt;irq
suffix:semicolon
id|copy_to_user
c_func
(paren
id|sp
comma
op_amp
id|sio
comma
r_sizeof
(paren
r_struct
id|serial_struct
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Set port according to the serial struct info.&n; *&t;At this point we do not do any auto-configure stuff, so we will&n; *&t;just quietly ignore any requests to change irq, etc.&n; */
DECL|function|stl_setserial
r_static
r_int
id|stl_setserial
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_struct
id|serial_struct
op_star
id|sp
)paren
(brace
r_struct
id|serial_struct
id|sio
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_setserial(portp=%x,sp=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|portp
comma
(paren
r_int
)paren
id|sp
)paren
suffix:semicolon
macro_line|#endif
id|copy_from_user
c_func
(paren
op_amp
id|sio
comma
id|sp
comma
r_sizeof
(paren
r_struct
id|serial_struct
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|sio.baud_base
op_ne
id|portp-&gt;baud_base
)paren
op_logical_or
(paren
id|sio.close_delay
op_ne
id|portp-&gt;close_delay
)paren
op_logical_or
(paren
(paren
id|sio.flags
op_amp
op_complement
id|ASYNC_USR_MASK
)paren
op_ne
(paren
id|portp-&gt;flags
op_amp
op_complement
id|ASYNC_USR_MASK
)paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
id|portp-&gt;flags
op_assign
(paren
id|portp-&gt;flags
op_amp
op_complement
id|ASYNC_USR_MASK
)paren
op_or
(paren
id|sio.flags
op_amp
id|ASYNC_USR_MASK
)paren
suffix:semicolon
id|portp-&gt;baud_base
op_assign
id|sio.baud_base
suffix:semicolon
id|portp-&gt;close_delay
op_assign
id|sio.close_delay
suffix:semicolon
id|portp-&gt;closing_wait
op_assign
id|sio.closing_wait
suffix:semicolon
id|portp-&gt;custom_divisor
op_assign
id|sio.custom_divisor
suffix:semicolon
id|stl_setport
c_func
(paren
id|portp
comma
id|portp-&gt;tty-&gt;termios
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|stl_ioctl
r_static
r_int
id|stl_ioctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|stlport_t
op_star
id|portp
suffix:semicolon
r_int
r_int
id|ival
suffix:semicolon
r_int
id|rc
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_ioctl(tty=%x,file=%x,cmd=%x,arg=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|tty
comma
(paren
r_int
)paren
id|file
comma
id|cmd
comma
(paren
r_int
)paren
id|arg
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|tty
op_eq
(paren
r_struct
id|tty_struct
op_star
)paren
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|portp
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cmd
op_ne
id|TIOCGSERIAL
)paren
op_logical_and
(paren
id|cmd
op_ne
id|TIOCSSERIAL
)paren
op_logical_and
(paren
id|cmd
op_ne
id|COM_GETPORTSTATS
)paren
op_logical_and
(paren
id|cmd
op_ne
id|COM_CLRPORTSTATS
)paren
)paren
(brace
r_if
c_cond
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_IO_ERROR
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|rc
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TIOCGSOFTCAR
suffix:colon
id|rc
op_assign
id|put_user
c_func
(paren
(paren
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CLOCAL
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCSSOFTCAR
suffix:colon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|get_user
c_func
(paren
id|ival
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
id|tty-&gt;termios-&gt;c_cflag
op_assign
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
op_complement
id|CLOCAL
)paren
op_or
(paren
id|ival
ques
c_cond
id|CLOCAL
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TIOCMGET
suffix:colon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|ival
op_assign
id|stl_getsignals
c_func
(paren
id|portp
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|ival
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TIOCMBIS
suffix:colon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|get_user
c_func
(paren
id|ival
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
id|stl_setsignals
c_func
(paren
id|portp
comma
(paren
(paren
id|ival
op_amp
id|TIOCM_DTR
)paren
ques
c_cond
l_int|1
suffix:colon
op_minus
l_int|1
)paren
comma
(paren
(paren
id|ival
op_amp
id|TIOCM_RTS
)paren
ques
c_cond
l_int|1
suffix:colon
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TIOCMBIC
suffix:colon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|get_user
c_func
(paren
id|ival
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
id|stl_setsignals
c_func
(paren
id|portp
comma
(paren
(paren
id|ival
op_amp
id|TIOCM_DTR
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
l_int|1
)paren
comma
(paren
(paren
id|ival
op_amp
id|TIOCM_RTS
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TIOCMSET
suffix:colon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|get_user
c_func
(paren
id|ival
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
id|stl_setsignals
c_func
(paren
id|portp
comma
(paren
(paren
id|ival
op_amp
id|TIOCM_DTR
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
comma
(paren
(paren
id|ival
op_amp
id|TIOCM_RTS
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TIOCGSERIAL
suffix:colon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|serial_struct
)paren
)paren
)paren
op_eq
l_int|0
)paren
id|stl_getserial
c_func
(paren
id|portp
comma
(paren
r_struct
id|serial_struct
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCSSERIAL
suffix:colon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|serial_struct
)paren
)paren
)paren
op_eq
l_int|0
)paren
id|rc
op_assign
id|stl_setserial
c_func
(paren
id|portp
comma
(paren
r_struct
id|serial_struct
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|COM_GETPORTSTATS
suffix:colon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|comstats_t
)paren
)paren
)paren
op_eq
l_int|0
)paren
id|rc
op_assign
id|stl_getportstats
c_func
(paren
id|portp
comma
(paren
id|comstats_t
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|COM_CLRPORTSTATS
suffix:colon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|comstats_t
)paren
)paren
)paren
op_eq
l_int|0
)paren
id|rc
op_assign
id|stl_clrportstats
c_func
(paren
id|portp
comma
(paren
id|comstats_t
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCSERCONFIG
suffix:colon
r_case
id|TIOCSERGWILD
suffix:colon
r_case
id|TIOCSERSWILD
suffix:colon
r_case
id|TIOCSERGETLSR
suffix:colon
r_case
id|TIOCSERGSTRUCT
suffix:colon
r_case
id|TIOCSERGETMULTI
suffix:colon
r_case
id|TIOCSERSETMULTI
suffix:colon
r_default
suffix:colon
id|rc
op_assign
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|stl_settermios
r_static
r_void
id|stl_settermios
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|termios
op_star
id|old
)paren
(brace
id|stlport_t
op_star
id|portp
suffix:semicolon
r_struct
id|termios
op_star
id|tiosp
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_settermios(tty=%x,old=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|tty
comma
(paren
r_int
)paren
id|old
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|tty
op_eq
(paren
r_struct
id|tty_struct
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|portp
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|tiosp
op_assign
id|tty-&gt;termios
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tiosp-&gt;c_cflag
op_eq
id|old-&gt;c_cflag
)paren
op_logical_and
(paren
id|tiosp-&gt;c_iflag
op_eq
id|old-&gt;c_iflag
)paren
)paren
r_return
suffix:semicolon
id|stl_setport
c_func
(paren
id|portp
comma
id|tiosp
)paren
suffix:semicolon
id|stl_setsignals
c_func
(paren
id|portp
comma
(paren
(paren
id|tiosp-&gt;c_cflag
op_amp
(paren
id|CBAUD
op_amp
op_complement
id|CBAUDEX
)paren
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|old-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
op_logical_and
(paren
(paren
id|tiosp-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
op_eq
l_int|0
)paren
)paren
(brace
id|tty-&gt;hw_stopped
op_assign
l_int|0
suffix:semicolon
id|stl_start
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|old-&gt;c_cflag
op_amp
id|CLOCAL
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|tiosp-&gt;c_cflag
op_amp
id|CLOCAL
)paren
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|portp-&gt;open_wait
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Attempt to flow control who ever is sending us data. Based on termios&n; *&t;settings use software or/and hardware flow control.&n; */
DECL|function|stl_throttle
r_static
r_void
id|stl_throttle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|stlport_t
op_star
id|portp
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_throttle(tty=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|tty
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|tty
op_eq
(paren
r_struct
id|tty_struct
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|portp
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|stl_flowctrl
c_func
(paren
id|portp
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Unflow control the device sending us data...&n; */
DECL|function|stl_unthrottle
r_static
r_void
id|stl_unthrottle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|stlport_t
op_star
id|portp
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_unthrottle(tty=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|tty
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|tty
op_eq
(paren
r_struct
id|tty_struct
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|portp
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|stl_flowctrl
c_func
(paren
id|portp
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Stop the transmitter. Basically to do this we will just turn TX&n; *&t;interrupts off.&n; */
DECL|function|stl_stop
r_static
r_void
id|stl_stop
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|stlport_t
op_star
id|portp
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_stop(tty=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|tty
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|tty
op_eq
(paren
r_struct
id|tty_struct
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|portp
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|stl_startrxtx
c_func
(paren
id|portp
comma
op_minus
l_int|1
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Start the transmitter again. Just turn TX interrupts back on.&n; */
DECL|function|stl_start
r_static
r_void
id|stl_start
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|stlport_t
op_star
id|portp
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_start(tty=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|tty
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|tty
op_eq
(paren
r_struct
id|tty_struct
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|portp
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|stl_startrxtx
c_func
(paren
id|portp
comma
op_minus
l_int|1
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Hangup this port. This is pretty much like closing the port, only&n; *&t;a little more brutal. No waiting for data to drain. Shutdown the&n; *&t;port and maybe drop signals.&n; */
DECL|function|stl_hangup
r_static
r_void
id|stl_hangup
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|stlport_t
op_star
id|portp
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_hangup(tty=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|tty
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|tty
op_eq
(paren
r_struct
id|tty_struct
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|portp
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|portp-&gt;flags
op_and_assign
op_complement
id|ASYNC_INITIALIZED
suffix:semicolon
id|stl_disableintrs
c_func
(paren
id|portp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|HUPCL
)paren
id|stl_setsignals
c_func
(paren
id|portp
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|stl_enablerxtx
c_func
(paren
id|portp
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|stl_flushbuffer
c_func
(paren
id|tty
)paren
suffix:semicolon
id|portp-&gt;istate
op_assign
l_int|0
suffix:semicolon
id|set_bit
c_func
(paren
id|TTY_IO_ERROR
comma
op_amp
id|tty-&gt;flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|portp-&gt;tx.buf
op_ne
(paren
r_char
op_star
)paren
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|portp-&gt;tx.buf
)paren
suffix:semicolon
id|portp-&gt;tx.buf
op_assign
(paren
r_char
op_star
)paren
l_int|NULL
suffix:semicolon
id|portp-&gt;tx.head
op_assign
(paren
r_char
op_star
)paren
l_int|NULL
suffix:semicolon
id|portp-&gt;tx.tail
op_assign
(paren
r_char
op_star
)paren
l_int|NULL
suffix:semicolon
)brace
id|portp-&gt;tty
op_assign
(paren
r_struct
id|tty_struct
op_star
)paren
l_int|NULL
suffix:semicolon
id|portp-&gt;flags
op_and_assign
op_complement
(paren
id|ASYNC_NORMAL_ACTIVE
op_or
id|ASYNC_CALLOUT_ACTIVE
)paren
suffix:semicolon
id|portp-&gt;refcount
op_assign
l_int|0
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|portp-&gt;open_wait
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|stl_flushbuffer
r_static
r_void
id|stl_flushbuffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|stlport_t
op_star
id|portp
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_flushbuffer(tty=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|tty
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|tty
op_eq
(paren
r_struct
id|tty_struct
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|portp
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|stl_flush
c_func
(paren
id|portp
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|stl_breakctl
r_static
r_void
id|stl_breakctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|state
)paren
(brace
id|stlport_t
op_star
id|portp
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_breakctl(tty=%x,state=%d)&bslash;n&quot;
comma
(paren
r_int
)paren
id|tty
comma
id|state
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|tty
op_eq
(paren
r_struct
id|tty_struct
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|portp
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|stl_sendbreak
c_func
(paren
id|portp
comma
(paren
(paren
id|state
op_eq
op_minus
l_int|1
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|2
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|stl_waituntilsent
r_static
r_void
id|stl_waituntilsent
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|timeout
)paren
(brace
id|stlport_t
op_star
id|portp
suffix:semicolon
r_int
r_int
id|tend
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_waituntilsent(tty=%x,timeout=%d)&bslash;n&quot;
comma
(paren
r_int
)paren
id|tty
comma
id|timeout
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|tty
op_eq
(paren
r_struct
id|tty_struct
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|portp
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|timeout
op_eq
l_int|0
)paren
id|timeout
op_assign
id|HZ
suffix:semicolon
id|tend
op_assign
id|jiffies
op_plus
id|timeout
suffix:semicolon
r_while
c_loop
(paren
id|stl_datastate
c_func
(paren
id|portp
)paren
)paren
(brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_break
suffix:semicolon
id|stl_delay
c_func
(paren
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_after_eq
c_func
(paren
id|jiffies
comma
id|tend
)paren
)paren
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*****************************************************************************/
DECL|function|stl_sendxchar
r_static
r_void
id|stl_sendxchar
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_char
id|ch
)paren
(brace
id|stlport_t
op_star
id|portp
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_sendxchar(tty=%x,ch=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|tty
comma
id|ch
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|tty
op_eq
(paren
r_struct
id|tty_struct
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|portp
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|ch
op_eq
id|STOP_CHAR
c_func
(paren
id|tty
)paren
)paren
id|stl_sendflow
c_func
(paren
id|portp
comma
l_int|0
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ch
op_eq
id|START_CHAR
c_func
(paren
id|tty
)paren
)paren
id|stl_sendflow
c_func
(paren
id|portp
comma
l_int|1
)paren
suffix:semicolon
r_else
id|stl_putchar
c_func
(paren
id|tty
comma
id|ch
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|macro|MAXLINE
mdefine_line|#define&t;MAXLINE&t;&t;80
multiline_comment|/*&n; *&t;Format info for a specified port. The line is deliberately limited&n; *&t;to 80 characters. (If it is too long it will be truncated, if too&n; *&t;short then padded with spaces).&n; */
DECL|function|stl_portinfo
r_static
r_int
id|stl_portinfo
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|portnr
comma
r_char
op_star
id|pos
)paren
(brace
r_char
op_star
id|sp
suffix:semicolon
r_int
id|sigs
comma
id|cnt
suffix:semicolon
id|sp
op_assign
id|pos
suffix:semicolon
id|sp
op_add_assign
id|sprintf
c_func
(paren
id|sp
comma
l_string|&quot;%d: uart:%s tx:%d rx:%d&quot;
comma
id|portnr
comma
(paren
id|portp-&gt;hwid
op_eq
l_int|1
)paren
ques
c_cond
l_string|&quot;SC26198&quot;
suffix:colon
l_string|&quot;CD1400&quot;
comma
(paren
r_int
)paren
id|portp-&gt;stats.txtotal
comma
(paren
r_int
)paren
id|portp-&gt;stats.rxtotal
)paren
suffix:semicolon
r_if
c_cond
(paren
id|portp-&gt;stats.rxframing
)paren
id|sp
op_add_assign
id|sprintf
c_func
(paren
id|sp
comma
l_string|&quot; fe:%d&quot;
comma
(paren
r_int
)paren
id|portp-&gt;stats.rxframing
)paren
suffix:semicolon
r_if
c_cond
(paren
id|portp-&gt;stats.rxparity
)paren
id|sp
op_add_assign
id|sprintf
c_func
(paren
id|sp
comma
l_string|&quot; pe:%d&quot;
comma
(paren
r_int
)paren
id|portp-&gt;stats.rxparity
)paren
suffix:semicolon
r_if
c_cond
(paren
id|portp-&gt;stats.rxbreaks
)paren
id|sp
op_add_assign
id|sprintf
c_func
(paren
id|sp
comma
l_string|&quot; brk:%d&quot;
comma
(paren
r_int
)paren
id|portp-&gt;stats.rxbreaks
)paren
suffix:semicolon
r_if
c_cond
(paren
id|portp-&gt;stats.rxoverrun
)paren
id|sp
op_add_assign
id|sprintf
c_func
(paren
id|sp
comma
l_string|&quot; oe:%d&quot;
comma
(paren
r_int
)paren
id|portp-&gt;stats.rxoverrun
)paren
suffix:semicolon
id|sigs
op_assign
id|stl_getsignals
c_func
(paren
id|portp
)paren
suffix:semicolon
id|cnt
op_assign
id|sprintf
c_func
(paren
id|sp
comma
l_string|&quot;%s%s%s%s%s &quot;
comma
(paren
id|sigs
op_amp
id|TIOCM_RTS
)paren
ques
c_cond
l_string|&quot;|RTS&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|sigs
op_amp
id|TIOCM_CTS
)paren
ques
c_cond
l_string|&quot;|CTS&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|sigs
op_amp
id|TIOCM_DTR
)paren
ques
c_cond
l_string|&quot;|DTR&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|sigs
op_amp
id|TIOCM_CD
)paren
ques
c_cond
l_string|&quot;|DCD&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|sigs
op_amp
id|TIOCM_DSR
)paren
ques
c_cond
l_string|&quot;|DSR&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
op_star
id|sp
op_assign
l_char|&squot; &squot;
suffix:semicolon
id|sp
op_add_assign
id|cnt
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
(paren
id|sp
op_minus
id|pos
)paren
suffix:semicolon
(paren
id|cnt
OL
(paren
id|MAXLINE
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|cnt
op_increment
)paren
op_star
id|sp
op_increment
op_assign
l_char|&squot; &squot;
suffix:semicolon
r_if
c_cond
(paren
id|cnt
op_ge
id|MAXLINE
)paren
id|pos
(braket
(paren
id|MAXLINE
op_minus
l_int|2
)paren
)braket
op_assign
l_char|&squot;+&squot;
suffix:semicolon
id|pos
(braket
(paren
id|MAXLINE
op_minus
l_int|1
)paren
)braket
op_assign
l_char|&squot;&bslash;n&squot;
suffix:semicolon
r_return
id|MAXLINE
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Port info, read from the /proc file system.&n; */
DECL|function|stl_readproc
r_static
r_int
id|stl_readproc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
id|stlbrd_t
op_star
id|brdp
suffix:semicolon
id|stlpanel_t
op_star
id|panelp
suffix:semicolon
id|stlport_t
op_star
id|portp
suffix:semicolon
r_int
id|brdnr
comma
id|panelnr
comma
id|portnr
comma
id|totalport
suffix:semicolon
r_int
id|curoff
comma
id|maxoff
suffix:semicolon
r_char
op_star
id|pos
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_readproc(page=%x,start=%x,off=%x,count=%d,eof=%x,&quot;
l_string|&quot;data=%x&bslash;n&quot;
comma
(paren
r_int
)paren
id|page
comma
(paren
r_int
)paren
id|start
comma
(paren
r_int
)paren
id|off
comma
id|count
comma
(paren
r_int
)paren
id|eof
comma
(paren
r_int
)paren
id|data
)paren
suffix:semicolon
macro_line|#endif
id|pos
op_assign
id|page
suffix:semicolon
id|totalport
op_assign
l_int|0
suffix:semicolon
id|curoff
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|off
op_eq
l_int|0
)paren
(brace
id|pos
op_add_assign
id|sprintf
c_func
(paren
id|pos
comma
l_string|&quot;%s: version %s&quot;
comma
id|stl_drvtitle
comma
id|stl_drvversion
)paren
suffix:semicolon
r_while
c_loop
(paren
id|pos
OL
(paren
id|page
op_plus
id|MAXLINE
op_minus
l_int|1
)paren
)paren
op_star
id|pos
op_increment
op_assign
l_char|&squot; &squot;
suffix:semicolon
op_star
id|pos
op_increment
op_assign
l_char|&squot;&bslash;n&squot;
suffix:semicolon
)brace
id|curoff
op_assign
id|MAXLINE
suffix:semicolon
multiline_comment|/*&n; *&t;We scan through for each board, panel and port. The offset is&n; *&t;calculated on the fly, and irrelevant ports are skipped.&n; */
r_for
c_loop
(paren
id|brdnr
op_assign
l_int|0
suffix:semicolon
(paren
id|brdnr
OL
id|stl_nrbrds
)paren
suffix:semicolon
id|brdnr
op_increment
)paren
(brace
id|brdp
op_assign
id|stl_brds
(braket
id|brdnr
)braket
suffix:semicolon
r_if
c_cond
(paren
id|brdp
op_eq
(paren
id|stlbrd_t
op_star
)paren
l_int|NULL
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|brdp-&gt;state
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
id|maxoff
op_assign
id|curoff
op_plus
(paren
id|brdp-&gt;nrports
op_star
id|MAXLINE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|off
op_ge
id|maxoff
)paren
(brace
id|curoff
op_assign
id|maxoff
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|totalport
op_assign
id|brdnr
op_star
id|STL_MAXPORTS
suffix:semicolon
r_for
c_loop
(paren
id|panelnr
op_assign
l_int|0
suffix:semicolon
(paren
id|panelnr
OL
id|brdp-&gt;nrpanels
)paren
suffix:semicolon
id|panelnr
op_increment
)paren
(brace
id|panelp
op_assign
id|brdp-&gt;panels
(braket
id|panelnr
)braket
suffix:semicolon
r_if
c_cond
(paren
id|panelp
op_eq
(paren
id|stlpanel_t
op_star
)paren
l_int|NULL
)paren
r_continue
suffix:semicolon
id|maxoff
op_assign
id|curoff
op_plus
(paren
id|panelp-&gt;nrports
op_star
id|MAXLINE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|off
op_ge
id|maxoff
)paren
(brace
id|curoff
op_assign
id|maxoff
suffix:semicolon
id|totalport
op_add_assign
id|panelp-&gt;nrports
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_for
c_loop
(paren
id|portnr
op_assign
l_int|0
suffix:semicolon
(paren
id|portnr
OL
id|panelp-&gt;nrports
)paren
suffix:semicolon
id|portnr
op_increment
comma
id|totalport
op_increment
)paren
(brace
id|portp
op_assign
id|panelp-&gt;ports
(braket
id|portnr
)braket
suffix:semicolon
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|off
op_ge
(paren
id|curoff
op_add_assign
id|MAXLINE
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pos
op_minus
id|page
op_plus
id|MAXLINE
)paren
OG
id|count
)paren
r_goto
id|stl_readdone
suffix:semicolon
id|pos
op_add_assign
id|stl_portinfo
c_func
(paren
id|portp
comma
id|totalport
comma
id|pos
)paren
suffix:semicolon
)brace
)brace
)brace
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
id|stl_readdone
suffix:colon
op_star
id|start
op_assign
id|page
suffix:semicolon
r_return
id|pos
op_minus
id|page
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;All board interrupts are vectored through here first. This code then&n; *&t;calls off to the approrpriate board interrupt handlers.&n; */
DECL|function|stl_intr
r_static
r_void
id|stl_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|stlbrd_t
op_star
id|brdp
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_intr(irq=%d,regs=%x)&bslash;n&quot;
comma
id|irq
comma
(paren
r_int
)paren
id|regs
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|stl_nrbrds
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|brdp
op_assign
id|stl_brds
(braket
id|i
)braket
)paren
op_eq
(paren
id|stlbrd_t
op_star
)paren
l_int|NULL
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|brdp-&gt;state
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
(paren
op_star
id|brdp-&gt;isr
)paren
(paren
id|brdp
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Interrupt service routine for EasyIO board types.&n; */
DECL|function|stl_eiointr
r_static
r_void
id|stl_eiointr
c_func
(paren
id|stlbrd_t
op_star
id|brdp
)paren
(brace
id|stlpanel_t
op_star
id|panelp
suffix:semicolon
r_int
r_int
id|iobase
suffix:semicolon
id|panelp
op_assign
id|brdp-&gt;panels
(braket
l_int|0
)braket
suffix:semicolon
id|iobase
op_assign
id|panelp-&gt;iobase
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|brdp-&gt;iostatus
)paren
op_amp
id|EIO_INTRPEND
)paren
(paren
op_star
id|panelp-&gt;isr
)paren
(paren
id|panelp
comma
id|iobase
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Interrupt service routine for ECH-AT board types.&n; */
DECL|function|stl_echatintr
r_static
r_void
id|stl_echatintr
c_func
(paren
id|stlbrd_t
op_star
id|brdp
)paren
(brace
id|stlpanel_t
op_star
id|panelp
suffix:semicolon
r_int
r_int
id|ioaddr
suffix:semicolon
r_int
id|bnknr
suffix:semicolon
id|outb
c_func
(paren
(paren
id|brdp-&gt;ioctrlval
op_or
id|ECH_BRDENABLE
)paren
comma
id|brdp-&gt;ioctrl
)paren
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|brdp-&gt;iostatus
)paren
op_amp
id|ECH_INTRPEND
)paren
(brace
r_for
c_loop
(paren
id|bnknr
op_assign
l_int|0
suffix:semicolon
(paren
id|bnknr
OL
id|brdp-&gt;nrbnks
)paren
suffix:semicolon
id|bnknr
op_increment
)paren
(brace
id|ioaddr
op_assign
id|brdp-&gt;bnkstataddr
(braket
id|bnknr
)braket
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|ioaddr
)paren
op_amp
id|ECH_PNLINTRPEND
)paren
(brace
id|panelp
op_assign
id|brdp-&gt;bnk2panel
(braket
id|bnknr
)braket
suffix:semicolon
(paren
op_star
id|panelp-&gt;isr
)paren
(paren
id|panelp
comma
(paren
id|ioaddr
op_amp
l_int|0xfffc
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
id|outb
c_func
(paren
(paren
id|brdp-&gt;ioctrlval
op_or
id|ECH_BRDDISABLE
)paren
comma
id|brdp-&gt;ioctrl
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Interrupt service routine for ECH-MCA board types.&n; */
DECL|function|stl_echmcaintr
r_static
r_void
id|stl_echmcaintr
c_func
(paren
id|stlbrd_t
op_star
id|brdp
)paren
(brace
id|stlpanel_t
op_star
id|panelp
suffix:semicolon
r_int
r_int
id|ioaddr
suffix:semicolon
r_int
id|bnknr
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|brdp-&gt;iostatus
)paren
op_amp
id|ECH_INTRPEND
)paren
(brace
r_for
c_loop
(paren
id|bnknr
op_assign
l_int|0
suffix:semicolon
(paren
id|bnknr
OL
id|brdp-&gt;nrbnks
)paren
suffix:semicolon
id|bnknr
op_increment
)paren
(brace
id|ioaddr
op_assign
id|brdp-&gt;bnkstataddr
(braket
id|bnknr
)braket
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|ioaddr
)paren
op_amp
id|ECH_PNLINTRPEND
)paren
(brace
id|panelp
op_assign
id|brdp-&gt;bnk2panel
(braket
id|bnknr
)braket
suffix:semicolon
(paren
op_star
id|panelp-&gt;isr
)paren
(paren
id|panelp
comma
(paren
id|ioaddr
op_amp
l_int|0xfffc
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Interrupt service routine for ECH-PCI board types.&n; */
DECL|function|stl_echpciintr
r_static
r_void
id|stl_echpciintr
c_func
(paren
id|stlbrd_t
op_star
id|brdp
)paren
(brace
id|stlpanel_t
op_star
id|panelp
suffix:semicolon
r_int
r_int
id|ioaddr
suffix:semicolon
r_int
id|bnknr
comma
id|recheck
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|recheck
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|bnknr
op_assign
l_int|0
suffix:semicolon
(paren
id|bnknr
OL
id|brdp-&gt;nrbnks
)paren
suffix:semicolon
id|bnknr
op_increment
)paren
(brace
id|outb
c_func
(paren
id|brdp-&gt;bnkpageaddr
(braket
id|bnknr
)braket
comma
id|brdp-&gt;ioctrl
)paren
suffix:semicolon
id|ioaddr
op_assign
id|brdp-&gt;bnkstataddr
(braket
id|bnknr
)braket
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|ioaddr
)paren
op_amp
id|ECH_PNLINTRPEND
)paren
(brace
id|panelp
op_assign
id|brdp-&gt;bnk2panel
(braket
id|bnknr
)braket
suffix:semicolon
(paren
op_star
id|panelp-&gt;isr
)paren
(paren
id|panelp
comma
(paren
id|ioaddr
op_amp
l_int|0xfffc
)paren
)paren
suffix:semicolon
id|recheck
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|recheck
)paren
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Interrupt service routine for ECH-8/64-PCI board types.&n; */
DECL|function|stl_echpci64intr
r_static
r_void
id|stl_echpci64intr
c_func
(paren
id|stlbrd_t
op_star
id|brdp
)paren
(brace
id|stlpanel_t
op_star
id|panelp
suffix:semicolon
r_int
r_int
id|ioaddr
suffix:semicolon
r_int
id|bnknr
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|brdp-&gt;ioctrl
)paren
op_amp
l_int|0x1
)paren
(brace
r_for
c_loop
(paren
id|bnknr
op_assign
l_int|0
suffix:semicolon
(paren
id|bnknr
OL
id|brdp-&gt;nrbnks
)paren
suffix:semicolon
id|bnknr
op_increment
)paren
(brace
id|ioaddr
op_assign
id|brdp-&gt;bnkstataddr
(braket
id|bnknr
)braket
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|ioaddr
)paren
op_amp
id|ECH_PNLINTRPEND
)paren
(brace
id|panelp
op_assign
id|brdp-&gt;bnk2panel
(braket
id|bnknr
)braket
suffix:semicolon
(paren
op_star
id|panelp-&gt;isr
)paren
(paren
id|panelp
comma
(paren
id|ioaddr
op_amp
l_int|0xfffc
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Service an off-level request for some channel.&n; */
DECL|function|stl_offintr
r_static
r_void
id|stl_offintr
c_func
(paren
r_void
op_star
r_private
)paren
(brace
id|stlport_t
op_star
id|portp
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
r_int
id|oldsigs
suffix:semicolon
id|portp
op_assign
r_private
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_offintr(portp=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|portp
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
id|tty
op_assign
id|portp-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
id|tty
op_eq
(paren
r_struct
id|tty_struct
op_star
)paren
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|ASYI_TXLOW
comma
op_amp
id|portp-&gt;istate
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|ASYI_DCDCHANGE
comma
op_amp
id|portp-&gt;istate
)paren
)paren
(brace
id|clear_bit
c_func
(paren
id|ASYI_DCDCHANGE
comma
op_amp
id|portp-&gt;istate
)paren
suffix:semicolon
id|oldsigs
op_assign
id|portp-&gt;sigs
suffix:semicolon
id|portp-&gt;sigs
op_assign
id|stl_getsignals
c_func
(paren
id|portp
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|portp-&gt;sigs
op_amp
id|TIOCM_CD
)paren
op_logical_and
(paren
(paren
id|oldsigs
op_amp
id|TIOCM_CD
)paren
op_eq
l_int|0
)paren
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|portp-&gt;open_wait
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|oldsigs
op_amp
id|TIOCM_CD
)paren
op_logical_and
(paren
(paren
id|portp-&gt;sigs
op_amp
id|TIOCM_CD
)paren
op_eq
l_int|0
)paren
)paren
(brace
r_if
c_cond
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_CHECK_CD
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
op_logical_and
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_CALLOUT_NOHUP
)paren
)paren
)paren
(brace
id|tty_hangup
c_func
(paren
id|tty
)paren
suffix:semicolon
multiline_comment|/* FIXME: module removal race here - AKPM */
)brace
)brace
)brace
)brace
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
id|out
suffix:colon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Map in interrupt vector to this driver. Check that we don&squot;t&n; *&t;already have this vector mapped, we might be sharing this&n; *&t;interrupt across multiple boards.&n; */
DECL|function|stl_mapirq
r_static
r_int
id|__init
id|stl_mapirq
c_func
(paren
r_int
id|irq
comma
r_char
op_star
id|name
)paren
(brace
r_int
id|rc
comma
id|i
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_mapirq(irq=%d,name=%s)&bslash;n&quot;
comma
id|irq
comma
id|name
)paren
suffix:semicolon
macro_line|#endif
id|rc
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|stl_numintrs
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|stl_gotintrs
(braket
id|i
)braket
op_eq
id|irq
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ge
id|stl_numintrs
)paren
(brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|stl_intr
comma
id|SA_SHIRQ
comma
id|name
comma
l_int|NULL
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;STALLION: failed to register interrupt &quot;
l_string|&quot;routine for %s irq=%d&bslash;n&quot;
comma
id|name
comma
id|irq
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
)brace
r_else
(brace
id|stl_gotintrs
(braket
id|stl_numintrs
op_increment
)braket
op_assign
id|irq
suffix:semicolon
)brace
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Initialize all the ports on a panel.&n; */
DECL|function|stl_initports
r_static
r_int
id|__init
id|stl_initports
c_func
(paren
id|stlbrd_t
op_star
id|brdp
comma
id|stlpanel_t
op_star
id|panelp
)paren
(brace
id|stlport_t
op_star
id|portp
suffix:semicolon
r_int
id|chipmask
comma
id|i
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_initports(brdp=%x,panelp=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|brdp
comma
(paren
r_int
)paren
id|panelp
)paren
suffix:semicolon
macro_line|#endif
id|chipmask
op_assign
id|stl_panelinit
c_func
(paren
id|brdp
comma
id|panelp
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;All UART&squot;s are initialized (if found!). Now go through and setup&n; *&t;each ports data structures.&n; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|panelp-&gt;nrports
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|portp
op_assign
(paren
id|stlport_t
op_star
)paren
id|stl_memalloc
c_func
(paren
r_sizeof
(paren
id|stlport_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;STALLION: failed to allocate memory &quot;
l_string|&quot;(size=%d)&bslash;n&quot;
comma
r_sizeof
(paren
id|stlport_t
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|memset
c_func
(paren
id|portp
comma
l_int|0
comma
r_sizeof
(paren
id|stlport_t
)paren
)paren
suffix:semicolon
id|portp-&gt;magic
op_assign
id|STL_PORTMAGIC
suffix:semicolon
id|portp-&gt;portnr
op_assign
id|i
suffix:semicolon
id|portp-&gt;brdnr
op_assign
id|panelp-&gt;brdnr
suffix:semicolon
id|portp-&gt;panelnr
op_assign
id|panelp-&gt;panelnr
suffix:semicolon
id|portp-&gt;uartp
op_assign
id|panelp-&gt;uartp
suffix:semicolon
id|portp-&gt;clk
op_assign
id|brdp-&gt;clk
suffix:semicolon
id|portp-&gt;baud_base
op_assign
id|STL_BAUDBASE
suffix:semicolon
id|portp-&gt;close_delay
op_assign
id|STL_CLOSEDELAY
suffix:semicolon
id|portp-&gt;closing_wait
op_assign
l_int|30
op_star
id|HZ
suffix:semicolon
id|portp-&gt;normaltermios
op_assign
id|stl_deftermios
suffix:semicolon
id|portp-&gt;callouttermios
op_assign
id|stl_deftermios
suffix:semicolon
id|portp-&gt;tqueue.routine
op_assign
id|stl_offintr
suffix:semicolon
id|portp-&gt;tqueue.data
op_assign
id|portp
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|portp-&gt;open_wait
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|portp-&gt;close_wait
)paren
suffix:semicolon
id|portp-&gt;stats.brd
op_assign
id|portp-&gt;brdnr
suffix:semicolon
id|portp-&gt;stats.panel
op_assign
id|portp-&gt;panelnr
suffix:semicolon
id|portp-&gt;stats.port
op_assign
id|portp-&gt;portnr
suffix:semicolon
id|panelp-&gt;ports
(braket
id|i
)braket
op_assign
id|portp
suffix:semicolon
id|stl_portinit
c_func
(paren
id|brdp
comma
id|panelp
comma
id|portp
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Try to find and initialize an EasyIO board.&n; */
DECL|function|stl_initeio
r_static
r_inline
r_int
id|stl_initeio
c_func
(paren
id|stlbrd_t
op_star
id|brdp
)paren
(brace
id|stlpanel_t
op_star
id|panelp
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
r_char
op_star
id|name
suffix:semicolon
r_int
id|rc
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_initeio(brdp=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|brdp
)paren
suffix:semicolon
macro_line|#endif
id|brdp-&gt;ioctrl
op_assign
id|brdp-&gt;ioaddr1
op_plus
l_int|1
suffix:semicolon
id|brdp-&gt;iostatus
op_assign
id|brdp-&gt;ioaddr1
op_plus
l_int|2
suffix:semicolon
id|status
op_assign
id|inb
c_func
(paren
id|brdp-&gt;iostatus
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|EIO_IDBITMASK
)paren
op_eq
id|EIO_MK3
)paren
id|brdp-&gt;ioctrl
op_increment
suffix:semicolon
multiline_comment|/*&n; *&t;Handle board specific stuff now. The real difference is PCI&n; *&t;or not PCI.&n; */
r_if
c_cond
(paren
id|brdp-&gt;brdtype
op_eq
id|BRD_EASYIOPCI
)paren
(brace
id|brdp-&gt;iosize1
op_assign
l_int|0x80
suffix:semicolon
id|brdp-&gt;iosize2
op_assign
l_int|0x80
suffix:semicolon
id|name
op_assign
l_string|&quot;serial(EIO-PCI)&quot;
suffix:semicolon
id|outb
c_func
(paren
l_int|0x41
comma
(paren
id|brdp-&gt;ioaddr2
op_plus
l_int|0x4c
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|brdp-&gt;iosize1
op_assign
l_int|8
suffix:semicolon
id|name
op_assign
l_string|&quot;serial(EIO)&quot;
suffix:semicolon
r_if
c_cond
(paren
(paren
id|brdp-&gt;irq
OL
l_int|0
)paren
op_logical_or
(paren
id|brdp-&gt;irq
OG
l_int|15
)paren
op_logical_or
(paren
id|stl_vecmap
(braket
id|brdp-&gt;irq
)braket
op_eq
(paren
r_int
r_char
)paren
l_int|0xff
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;STALLION: invalid irq=%d for brd=%d&bslash;n&quot;
comma
id|brdp-&gt;irq
comma
id|brdp-&gt;brdnr
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|outb
c_func
(paren
(paren
id|stl_vecmap
(braket
id|brdp-&gt;irq
)braket
op_or
id|EIO_0WS
op_or
(paren
(paren
id|brdp-&gt;irqtype
)paren
ques
c_cond
id|EIO_INTLEVEL
suffix:colon
id|EIO_INTEDGE
)paren
)paren
comma
id|brdp-&gt;ioctrl
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|brdp-&gt;ioaddr1
comma
id|brdp-&gt;iosize1
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;STALLION: Warning, board %d I/O address %x conflicts &quot;
l_string|&quot;with another device&bslash;n&quot;
comma
id|brdp-&gt;brdnr
comma
id|brdp-&gt;ioaddr1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|brdp-&gt;iosize2
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|brdp-&gt;ioaddr2
comma
id|brdp-&gt;iosize2
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;STALLION: Warning, board %d I/O address %x &quot;
l_string|&quot;conflicts with another device&bslash;n&quot;
comma
id|brdp-&gt;brdnr
comma
id|brdp-&gt;ioaddr2
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;Everything looks OK, so let&squot;s go ahead and probe for the hardware.&n; */
id|brdp-&gt;clk
op_assign
id|CD1400_CLK
suffix:semicolon
id|brdp-&gt;isr
op_assign
id|stl_eiointr
suffix:semicolon
r_switch
c_cond
(paren
id|status
op_amp
id|EIO_IDBITMASK
)paren
(brace
r_case
id|EIO_8PORTM
suffix:colon
id|brdp-&gt;clk
op_assign
id|CD1400_CLK8M
suffix:semicolon
multiline_comment|/* fall thru */
r_case
id|EIO_8PORTRS
suffix:colon
r_case
id|EIO_8PORTDI
suffix:colon
id|brdp-&gt;nrports
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EIO_4PORTRS
suffix:colon
id|brdp-&gt;nrports
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EIO_MK3
suffix:colon
r_switch
c_cond
(paren
id|status
op_amp
id|EIO_BRDMASK
)paren
(brace
r_case
id|ID_BRD4
suffix:colon
id|brdp-&gt;nrports
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ID_BRD8
suffix:colon
id|brdp-&gt;nrports
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ID_BRD16
suffix:colon
id|brdp-&gt;nrports
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;We have verfied that the board is actually present, so now we&n; *&t;can complete the setup.&n; */
id|request_region
c_func
(paren
id|brdp-&gt;ioaddr1
comma
id|brdp-&gt;iosize1
comma
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|brdp-&gt;iosize2
OG
l_int|0
)paren
id|request_region
c_func
(paren
id|brdp-&gt;ioaddr2
comma
id|brdp-&gt;iosize2
comma
id|name
)paren
suffix:semicolon
id|panelp
op_assign
(paren
id|stlpanel_t
op_star
)paren
id|stl_memalloc
c_func
(paren
r_sizeof
(paren
id|stlpanel_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|panelp
op_eq
(paren
id|stlpanel_t
op_star
)paren
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;STALLION: failed to allocate memory (size=%d)&bslash;n&quot;
comma
r_sizeof
(paren
id|stlpanel_t
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|panelp
comma
l_int|0
comma
r_sizeof
(paren
id|stlpanel_t
)paren
)paren
suffix:semicolon
id|panelp-&gt;magic
op_assign
id|STL_PANELMAGIC
suffix:semicolon
id|panelp-&gt;brdnr
op_assign
id|brdp-&gt;brdnr
suffix:semicolon
id|panelp-&gt;panelnr
op_assign
l_int|0
suffix:semicolon
id|panelp-&gt;nrports
op_assign
id|brdp-&gt;nrports
suffix:semicolon
id|panelp-&gt;iobase
op_assign
id|brdp-&gt;ioaddr1
suffix:semicolon
id|panelp-&gt;hwid
op_assign
id|status
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|EIO_IDBITMASK
)paren
op_eq
id|EIO_MK3
)paren
(brace
id|panelp-&gt;uartp
op_assign
(paren
r_void
op_star
)paren
op_amp
id|stl_sc26198uart
suffix:semicolon
id|panelp-&gt;isr
op_assign
id|stl_sc26198intr
suffix:semicolon
)brace
r_else
(brace
id|panelp-&gt;uartp
op_assign
(paren
r_void
op_star
)paren
op_amp
id|stl_cd1400uart
suffix:semicolon
id|panelp-&gt;isr
op_assign
id|stl_cd1400eiointr
suffix:semicolon
)brace
id|brdp-&gt;panels
(braket
l_int|0
)braket
op_assign
id|panelp
suffix:semicolon
id|brdp-&gt;nrpanels
op_assign
l_int|1
suffix:semicolon
id|brdp-&gt;state
op_or_assign
id|BRD_FOUND
suffix:semicolon
id|brdp-&gt;hwid
op_assign
id|status
suffix:semicolon
id|rc
op_assign
id|stl_mapirq
c_func
(paren
id|brdp-&gt;irq
comma
id|name
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Try to find an ECH board and initialize it. This code is capable of&n; *&t;dealing with all types of ECH board.&n; */
DECL|function|stl_initech
r_static
r_int
r_inline
id|stl_initech
c_func
(paren
id|stlbrd_t
op_star
id|brdp
)paren
(brace
id|stlpanel_t
op_star
id|panelp
suffix:semicolon
r_int
r_int
id|status
comma
id|nxtid
comma
id|ioaddr
comma
id|conflict
suffix:semicolon
r_int
id|panelnr
comma
id|banknr
comma
id|i
suffix:semicolon
r_char
op_star
id|name
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_initech(brdp=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|brdp
)paren
suffix:semicolon
macro_line|#endif
id|status
op_assign
l_int|0
suffix:semicolon
id|conflict
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; *&t;Set up the initial board register contents for boards. This varies a&n; *&t;bit between the different board types. So we need to handle each&n; *&t;separately. Also do a check that the supplied IRQ is good.&n; */
r_switch
c_cond
(paren
id|brdp-&gt;brdtype
)paren
(brace
r_case
id|BRD_ECH
suffix:colon
id|brdp-&gt;isr
op_assign
id|stl_echatintr
suffix:semicolon
id|brdp-&gt;ioctrl
op_assign
id|brdp-&gt;ioaddr1
op_plus
l_int|1
suffix:semicolon
id|brdp-&gt;iostatus
op_assign
id|brdp-&gt;ioaddr1
op_plus
l_int|1
suffix:semicolon
id|status
op_assign
id|inb
c_func
(paren
id|brdp-&gt;iostatus
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|ECH_IDBITMASK
)paren
op_ne
id|ECH_ID
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
(paren
id|brdp-&gt;irq
OL
l_int|0
)paren
op_logical_or
(paren
id|brdp-&gt;irq
OG
l_int|15
)paren
op_logical_or
(paren
id|stl_vecmap
(braket
id|brdp-&gt;irq
)braket
op_eq
(paren
r_int
r_char
)paren
l_int|0xff
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;STALLION: invalid irq=%d for brd=%d&bslash;n&quot;
comma
id|brdp-&gt;irq
comma
id|brdp-&gt;brdnr
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|status
op_assign
(paren
(paren
id|brdp-&gt;ioaddr2
op_amp
id|ECH_ADDR2MASK
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
id|status
op_or_assign
(paren
id|stl_vecmap
(braket
id|brdp-&gt;irq
)braket
op_lshift
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|status
op_or
id|ECH_BRDRESET
)paren
comma
id|brdp-&gt;ioaddr1
)paren
suffix:semicolon
id|brdp-&gt;ioctrlval
op_assign
id|ECH_INTENABLE
op_or
(paren
(paren
id|brdp-&gt;irqtype
)paren
ques
c_cond
id|ECH_INTLEVEL
suffix:colon
id|ECH_INTEDGE
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
l_int|10
)paren
suffix:semicolon
id|i
op_increment
)paren
id|outb
c_func
(paren
(paren
id|brdp-&gt;ioctrlval
op_or
id|ECH_BRDENABLE
)paren
comma
id|brdp-&gt;ioctrl
)paren
suffix:semicolon
id|brdp-&gt;iosize1
op_assign
l_int|2
suffix:semicolon
id|brdp-&gt;iosize2
op_assign
l_int|32
suffix:semicolon
id|name
op_assign
l_string|&quot;serial(EC8/32)&quot;
suffix:semicolon
id|outb
c_func
(paren
id|status
comma
id|brdp-&gt;ioaddr1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BRD_ECHMC
suffix:colon
id|brdp-&gt;isr
op_assign
id|stl_echmcaintr
suffix:semicolon
id|brdp-&gt;ioctrl
op_assign
id|brdp-&gt;ioaddr1
op_plus
l_int|0x20
suffix:semicolon
id|brdp-&gt;iostatus
op_assign
id|brdp-&gt;ioctrl
suffix:semicolon
id|status
op_assign
id|inb
c_func
(paren
id|brdp-&gt;iostatus
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|ECH_IDBITMASK
)paren
op_ne
id|ECH_ID
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
(paren
id|brdp-&gt;irq
OL
l_int|0
)paren
op_logical_or
(paren
id|brdp-&gt;irq
OG
l_int|15
)paren
op_logical_or
(paren
id|stl_vecmap
(braket
id|brdp-&gt;irq
)braket
op_eq
(paren
r_int
r_char
)paren
l_int|0xff
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;STALLION: invalid irq=%d for brd=%d&bslash;n&quot;
comma
id|brdp-&gt;irq
comma
id|brdp-&gt;brdnr
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|outb
c_func
(paren
id|ECHMC_BRDRESET
comma
id|brdp-&gt;ioctrl
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ECHMC_INTENABLE
comma
id|brdp-&gt;ioctrl
)paren
suffix:semicolon
id|brdp-&gt;iosize1
op_assign
l_int|64
suffix:semicolon
id|name
op_assign
l_string|&quot;serial(EC8/32-MC)&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BRD_ECHPCI
suffix:colon
id|brdp-&gt;isr
op_assign
id|stl_echpciintr
suffix:semicolon
id|brdp-&gt;ioctrl
op_assign
id|brdp-&gt;ioaddr1
op_plus
l_int|2
suffix:semicolon
id|brdp-&gt;iosize1
op_assign
l_int|4
suffix:semicolon
id|brdp-&gt;iosize2
op_assign
l_int|8
suffix:semicolon
id|name
op_assign
l_string|&quot;serial(EC8/32-PCI)&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BRD_ECH64PCI
suffix:colon
id|brdp-&gt;isr
op_assign
id|stl_echpci64intr
suffix:semicolon
id|brdp-&gt;ioctrl
op_assign
id|brdp-&gt;ioaddr2
op_plus
l_int|0x40
suffix:semicolon
id|outb
c_func
(paren
l_int|0x43
comma
(paren
id|brdp-&gt;ioaddr1
op_plus
l_int|0x4c
)paren
)paren
suffix:semicolon
id|brdp-&gt;iosize1
op_assign
l_int|0x80
suffix:semicolon
id|brdp-&gt;iosize2
op_assign
l_int|0x80
suffix:semicolon
id|name
op_assign
l_string|&quot;serial(EC8/64-PCI)&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;STALLION: unknown board type=%d&bslash;n&quot;
comma
id|brdp-&gt;brdtype
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Check boards for possible IO address conflicts. We won&squot;t actually&n; *&t;do anything about it here, just issue a warning...&n; */
id|conflict
op_assign
id|check_region
c_func
(paren
id|brdp-&gt;ioaddr1
comma
id|brdp-&gt;iosize1
)paren
ques
c_cond
id|brdp-&gt;ioaddr1
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|conflict
op_eq
l_int|0
)paren
op_logical_and
(paren
id|brdp-&gt;iosize2
OG
l_int|0
)paren
)paren
id|conflict
op_assign
id|check_region
c_func
(paren
id|brdp-&gt;ioaddr2
comma
id|brdp-&gt;iosize2
)paren
ques
c_cond
id|brdp-&gt;ioaddr2
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|conflict
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;STALLION: Warning, board %d I/O address %x conflicts &quot;
l_string|&quot;with another device&bslash;n&quot;
comma
id|brdp-&gt;brdnr
comma
id|conflict
)paren
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|brdp-&gt;ioaddr1
comma
id|brdp-&gt;iosize1
comma
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|brdp-&gt;iosize2
OG
l_int|0
)paren
id|request_region
c_func
(paren
id|brdp-&gt;ioaddr2
comma
id|brdp-&gt;iosize2
comma
id|name
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;Scan through the secondary io address space looking for panels.&n; *&t;As we find&squot;em allocate and initialize panel structures for each.&n; */
id|brdp-&gt;clk
op_assign
id|CD1400_CLK
suffix:semicolon
id|brdp-&gt;hwid
op_assign
id|status
suffix:semicolon
id|ioaddr
op_assign
id|brdp-&gt;ioaddr2
suffix:semicolon
id|banknr
op_assign
l_int|0
suffix:semicolon
id|panelnr
op_assign
l_int|0
suffix:semicolon
id|nxtid
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|STL_MAXPANELS
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|brdp-&gt;brdtype
op_eq
id|BRD_ECHPCI
)paren
(brace
id|outb
c_func
(paren
id|nxtid
comma
id|brdp-&gt;ioctrl
)paren
suffix:semicolon
id|ioaddr
op_assign
id|brdp-&gt;ioaddr2
suffix:semicolon
)brace
id|status
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|ECH_PNLSTATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|ECH_PNLIDMASK
)paren
op_ne
id|nxtid
)paren
r_break
suffix:semicolon
id|panelp
op_assign
(paren
id|stlpanel_t
op_star
)paren
id|stl_memalloc
c_func
(paren
r_sizeof
(paren
id|stlpanel_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|panelp
op_eq
(paren
id|stlpanel_t
op_star
)paren
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;STALLION: failed to allocate memory &quot;
l_string|&quot;(size=%d)&bslash;n&quot;
comma
r_sizeof
(paren
id|stlpanel_t
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|memset
c_func
(paren
id|panelp
comma
l_int|0
comma
r_sizeof
(paren
id|stlpanel_t
)paren
)paren
suffix:semicolon
id|panelp-&gt;magic
op_assign
id|STL_PANELMAGIC
suffix:semicolon
id|panelp-&gt;brdnr
op_assign
id|brdp-&gt;brdnr
suffix:semicolon
id|panelp-&gt;panelnr
op_assign
id|panelnr
suffix:semicolon
id|panelp-&gt;iobase
op_assign
id|ioaddr
suffix:semicolon
id|panelp-&gt;pagenr
op_assign
id|nxtid
suffix:semicolon
id|panelp-&gt;hwid
op_assign
id|status
suffix:semicolon
id|brdp-&gt;bnk2panel
(braket
id|banknr
)braket
op_assign
id|panelp
suffix:semicolon
id|brdp-&gt;bnkpageaddr
(braket
id|banknr
)braket
op_assign
id|nxtid
suffix:semicolon
id|brdp-&gt;bnkstataddr
(braket
id|banknr
op_increment
)braket
op_assign
id|ioaddr
op_plus
id|ECH_PNLSTATUS
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|ECH_PNLXPID
)paren
(brace
id|panelp-&gt;uartp
op_assign
(paren
r_void
op_star
)paren
op_amp
id|stl_sc26198uart
suffix:semicolon
id|panelp-&gt;isr
op_assign
id|stl_sc26198intr
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|ECH_PNL16PORT
)paren
(brace
id|panelp-&gt;nrports
op_assign
l_int|16
suffix:semicolon
id|brdp-&gt;bnk2panel
(braket
id|banknr
)braket
op_assign
id|panelp
suffix:semicolon
id|brdp-&gt;bnkpageaddr
(braket
id|banknr
)braket
op_assign
id|nxtid
suffix:semicolon
id|brdp-&gt;bnkstataddr
(braket
id|banknr
op_increment
)braket
op_assign
id|ioaddr
op_plus
l_int|4
op_plus
id|ECH_PNLSTATUS
suffix:semicolon
)brace
r_else
(brace
id|panelp-&gt;nrports
op_assign
l_int|8
suffix:semicolon
)brace
)brace
r_else
(brace
id|panelp-&gt;uartp
op_assign
(paren
r_void
op_star
)paren
op_amp
id|stl_cd1400uart
suffix:semicolon
id|panelp-&gt;isr
op_assign
id|stl_cd1400echintr
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|ECH_PNL16PORT
)paren
(brace
id|panelp-&gt;nrports
op_assign
l_int|16
suffix:semicolon
id|panelp-&gt;ackmask
op_assign
l_int|0x80
suffix:semicolon
r_if
c_cond
(paren
id|brdp-&gt;brdtype
op_ne
id|BRD_ECHPCI
)paren
id|ioaddr
op_add_assign
id|EREG_BANKSIZE
suffix:semicolon
id|brdp-&gt;bnk2panel
(braket
id|banknr
)braket
op_assign
id|panelp
suffix:semicolon
id|brdp-&gt;bnkpageaddr
(braket
id|banknr
)braket
op_assign
op_increment
id|nxtid
suffix:semicolon
id|brdp-&gt;bnkstataddr
(braket
id|banknr
op_increment
)braket
op_assign
id|ioaddr
op_plus
id|ECH_PNLSTATUS
suffix:semicolon
)brace
r_else
(brace
id|panelp-&gt;nrports
op_assign
l_int|8
suffix:semicolon
id|panelp-&gt;ackmask
op_assign
l_int|0xc0
suffix:semicolon
)brace
)brace
id|nxtid
op_increment
suffix:semicolon
id|ioaddr
op_add_assign
id|EREG_BANKSIZE
suffix:semicolon
id|brdp-&gt;nrports
op_add_assign
id|panelp-&gt;nrports
suffix:semicolon
id|brdp-&gt;panels
(braket
id|panelnr
op_increment
)braket
op_assign
id|panelp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|brdp-&gt;brdtype
op_ne
id|BRD_ECHPCI
)paren
op_logical_and
(paren
id|ioaddr
op_ge
(paren
id|brdp-&gt;ioaddr2
op_plus
id|brdp-&gt;iosize2
)paren
)paren
)paren
r_break
suffix:semicolon
)brace
id|brdp-&gt;nrpanels
op_assign
id|panelnr
suffix:semicolon
id|brdp-&gt;nrbnks
op_assign
id|banknr
suffix:semicolon
r_if
c_cond
(paren
id|brdp-&gt;brdtype
op_eq
id|BRD_ECH
)paren
id|outb
c_func
(paren
(paren
id|brdp-&gt;ioctrlval
op_or
id|ECH_BRDDISABLE
)paren
comma
id|brdp-&gt;ioctrl
)paren
suffix:semicolon
id|brdp-&gt;state
op_or_assign
id|BRD_FOUND
suffix:semicolon
id|i
op_assign
id|stl_mapirq
c_func
(paren
id|brdp-&gt;irq
comma
id|name
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Initialize and configure the specified board.&n; *&t;Scan through all the boards in the configuration and see what we&n; *&t;can find. Handle EIO and the ECH boards a little differently here&n; *&t;since the initial search and setup is very different.&n; */
DECL|function|stl_brdinit
r_static
r_int
id|__init
id|stl_brdinit
c_func
(paren
id|stlbrd_t
op_star
id|brdp
)paren
(brace
r_int
id|i
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_brdinit(brdp=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|brdp
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|brdp-&gt;brdtype
)paren
(brace
r_case
id|BRD_EASYIO
suffix:colon
r_case
id|BRD_EASYIOPCI
suffix:colon
id|stl_initeio
c_func
(paren
id|brdp
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BRD_ECH
suffix:colon
r_case
id|BRD_ECHMC
suffix:colon
r_case
id|BRD_ECHPCI
suffix:colon
r_case
id|BRD_ECH64PCI
suffix:colon
id|stl_initech
c_func
(paren
id|brdp
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;STALLION: board=%d is unknown board type=%d&bslash;n&quot;
comma
id|brdp-&gt;brdnr
comma
id|brdp-&gt;brdtype
)paren
suffix:semicolon
r_return
id|ENODEV
suffix:semicolon
)brace
id|stl_brds
(braket
id|brdp-&gt;brdnr
)braket
op_assign
id|brdp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|brdp-&gt;state
op_amp
id|BRD_FOUND
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;STALLION: %s board not found, board=%d io=%x irq=%d&bslash;n&quot;
comma
id|stl_brdnames
(braket
id|brdp-&gt;brdtype
)braket
comma
id|brdp-&gt;brdnr
comma
id|brdp-&gt;ioaddr1
comma
id|brdp-&gt;irq
)paren
suffix:semicolon
r_return
id|ENODEV
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|STL_MAXPANELS
)paren
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|brdp-&gt;panels
(braket
id|i
)braket
op_ne
(paren
id|stlpanel_t
op_star
)paren
l_int|NULL
)paren
id|stl_initports
c_func
(paren
id|brdp
comma
id|brdp-&gt;panels
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;STALLION: %s found, board=%d io=%x irq=%d &quot;
l_string|&quot;nrpanels=%d nrports=%d&bslash;n&quot;
comma
id|stl_brdnames
(braket
id|brdp-&gt;brdtype
)braket
comma
id|brdp-&gt;brdnr
comma
id|brdp-&gt;ioaddr1
comma
id|brdp-&gt;irq
comma
id|brdp-&gt;nrpanels
comma
id|brdp-&gt;nrports
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Find the next available board number that is free.&n; */
DECL|function|stl_getbrdnr
r_static
r_inline
r_int
id|stl_getbrdnr
c_func
(paren
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|STL_MAXBRDS
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|stl_brds
(braket
id|i
)braket
op_eq
(paren
id|stlbrd_t
op_star
)paren
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|i
op_ge
id|stl_nrbrds
)paren
id|stl_nrbrds
op_assign
id|i
op_plus
l_int|1
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
macro_line|#ifdef&t;CONFIG_PCI
multiline_comment|/*&n; *&t;We have a Stallion board. Allocate a board structure and&n; *&t;initialize it. Read its IO and IRQ resources from PCI&n; *&t;configuration space.&n; */
DECL|function|stl_initpcibrd
r_static
r_inline
r_int
id|stl_initpcibrd
c_func
(paren
r_int
id|brdtype
comma
r_struct
id|pci_dev
op_star
id|devp
)paren
(brace
id|stlbrd_t
op_star
id|brdp
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_initpcibrd(brdtype=%d,busnr=%x,devnr=%x)&bslash;n&quot;
comma
id|brdtype
comma
id|devp-&gt;bus-&gt;number
comma
id|devp-&gt;devfn
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|devp
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
(paren
id|brdp
op_assign
id|stl_allocbrd
c_func
(paren
)paren
)paren
op_eq
(paren
id|stlbrd_t
op_star
)paren
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
(paren
id|brdp-&gt;brdnr
op_assign
id|stl_getbrdnr
c_func
(paren
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;STALLION: too many boards found, &quot;
l_string|&quot;maximum supported %d&bslash;n&quot;
comma
id|STL_MAXBRDS
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|brdp-&gt;brdtype
op_assign
id|brdtype
suffix:semicolon
multiline_comment|/*&n; *&t;Different Stallion boards use the BAR registers in different ways,&n; *&t;so set up io addresses based on board type.&n; */
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;%s(%d): BAR[]=%x,%x,%x,%x IRQ=%x&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|pci_resource_start
c_func
(paren
id|devp
comma
l_int|0
)paren
comma
id|pci_resource_start
c_func
(paren
id|devp
comma
l_int|1
)paren
comma
id|pci_resource_start
c_func
(paren
id|devp
comma
l_int|2
)paren
comma
id|pci_resource_start
c_func
(paren
id|devp
comma
l_int|3
)paren
comma
id|devp-&gt;irq
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; *&t;We have all resources from the board, so let&squot;s setup the actual&n; *&t;board structure now.&n; */
r_switch
c_cond
(paren
id|brdtype
)paren
(brace
r_case
id|BRD_ECHPCI
suffix:colon
id|brdp-&gt;ioaddr2
op_assign
id|pci_resource_start
c_func
(paren
id|devp
comma
l_int|0
)paren
suffix:semicolon
id|brdp-&gt;ioaddr1
op_assign
id|pci_resource_start
c_func
(paren
id|devp
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BRD_ECH64PCI
suffix:colon
id|brdp-&gt;ioaddr2
op_assign
id|pci_resource_start
c_func
(paren
id|devp
comma
l_int|2
)paren
suffix:semicolon
id|brdp-&gt;ioaddr1
op_assign
id|pci_resource_start
c_func
(paren
id|devp
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BRD_EASYIOPCI
suffix:colon
id|brdp-&gt;ioaddr1
op_assign
id|pci_resource_start
c_func
(paren
id|devp
comma
l_int|2
)paren
suffix:semicolon
id|brdp-&gt;ioaddr2
op_assign
id|pci_resource_start
c_func
(paren
id|devp
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;STALLION: unknown PCI board type=%d&bslash;n&quot;
comma
id|brdtype
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|brdp-&gt;irq
op_assign
id|devp-&gt;irq
suffix:semicolon
id|stl_brdinit
c_func
(paren
id|brdp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Find all Stallion PCI boards that might be installed. Initialize each&n; *&t;one as it is found.&n; */
DECL|function|stl_findpcibrds
r_static
r_inline
r_int
id|stl_findpcibrds
c_func
(paren
)paren
(brace
r_struct
id|pci_dev
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
comma
id|rc
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_findpcibrds()&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|pci_present
c_func
(paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|stl_nrpcibrds
)paren
suffix:semicolon
id|i
op_increment
)paren
r_while
c_loop
(paren
(paren
id|dev
op_assign
id|pci_find_device
c_func
(paren
id|stl_pcibrds
(braket
id|i
)braket
dot
id|vendid
comma
id|stl_pcibrds
(braket
id|i
)braket
dot
id|devid
comma
id|dev
)paren
)paren
)paren
(brace
multiline_comment|/*&n; *&t;&t;&t;Found a device on the PCI bus that has our vendor and&n; *&t;&t;&t;device ID. Need to check now that it is really us.&n; */
r_if
c_cond
(paren
(paren
id|dev
op_member_access_from_pointer
r_class
op_rshift
l_int|8
)paren
op_eq
id|PCI_CLASS_STORAGE_IDE
)paren
r_continue
suffix:semicolon
id|rc
op_assign
id|stl_initpcibrd
c_func
(paren
id|stl_pcibrds
(braket
id|i
)braket
dot
id|brdtype
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Scan through all the boards in the configuration and see what we&n; *&t;can find. Handle EIO and the ECH boards a little differently here&n; *&t;since the initial search and setup is too different.&n; */
DECL|function|stl_initbrds
r_static
r_inline
r_int
id|stl_initbrds
c_func
(paren
)paren
(brace
id|stlbrd_t
op_star
id|brdp
suffix:semicolon
id|stlconf_t
op_star
id|confp
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_initbrds()&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|stl_nrbrds
OG
id|STL_MAXBRDS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;STALLION: too many boards in configuration table, &quot;
l_string|&quot;truncating to %d&bslash;n&quot;
comma
id|STL_MAXBRDS
)paren
suffix:semicolon
id|stl_nrbrds
op_assign
id|STL_MAXBRDS
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Firstly scan the list of static boards configured. Allocate&n; *&t;resources and initialize the boards as found.&n; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|stl_nrbrds
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|confp
op_assign
op_amp
id|stl_brdconf
(braket
id|i
)braket
suffix:semicolon
macro_line|#ifdef MODULE
id|stl_parsebrd
c_func
(paren
id|confp
comma
id|stl_brdsp
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|brdp
op_assign
id|stl_allocbrd
c_func
(paren
)paren
)paren
op_eq
(paren
id|stlbrd_t
op_star
)paren
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|brdp-&gt;brdnr
op_assign
id|i
suffix:semicolon
id|brdp-&gt;brdtype
op_assign
id|confp-&gt;brdtype
suffix:semicolon
id|brdp-&gt;ioaddr1
op_assign
id|confp-&gt;ioaddr1
suffix:semicolon
id|brdp-&gt;ioaddr2
op_assign
id|confp-&gt;ioaddr2
suffix:semicolon
id|brdp-&gt;irq
op_assign
id|confp-&gt;irq
suffix:semicolon
id|brdp-&gt;irqtype
op_assign
id|confp-&gt;irqtype
suffix:semicolon
id|stl_brdinit
c_func
(paren
id|brdp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Find any dynamically supported boards. That is via module load&n; *&t;line options or auto-detected on the PCI bus.&n; */
macro_line|#ifdef MODULE
id|stl_argbrds
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_PCI
id|stl_findpcibrds
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Return the board stats structure to user app.&n; */
DECL|function|stl_getbrdstats
r_static
r_int
id|stl_getbrdstats
c_func
(paren
id|combrd_t
op_star
id|bp
)paren
(brace
id|stlbrd_t
op_star
id|brdp
suffix:semicolon
id|stlpanel_t
op_star
id|panelp
suffix:semicolon
r_int
id|i
suffix:semicolon
id|copy_from_user
c_func
(paren
op_amp
id|stl_brdstats
comma
id|bp
comma
r_sizeof
(paren
id|combrd_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stl_brdstats.brd
op_ge
id|STL_MAXBRDS
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|brdp
op_assign
id|stl_brds
(braket
id|stl_brdstats.brd
)braket
suffix:semicolon
r_if
c_cond
(paren
id|brdp
op_eq
(paren
id|stlbrd_t
op_star
)paren
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|stl_brdstats
comma
l_int|0
comma
r_sizeof
(paren
id|combrd_t
)paren
)paren
suffix:semicolon
id|stl_brdstats.brd
op_assign
id|brdp-&gt;brdnr
suffix:semicolon
id|stl_brdstats.type
op_assign
id|brdp-&gt;brdtype
suffix:semicolon
id|stl_brdstats.hwid
op_assign
id|brdp-&gt;hwid
suffix:semicolon
id|stl_brdstats.state
op_assign
id|brdp-&gt;state
suffix:semicolon
id|stl_brdstats.ioaddr
op_assign
id|brdp-&gt;ioaddr1
suffix:semicolon
id|stl_brdstats.ioaddr2
op_assign
id|brdp-&gt;ioaddr2
suffix:semicolon
id|stl_brdstats.irq
op_assign
id|brdp-&gt;irq
suffix:semicolon
id|stl_brdstats.nrpanels
op_assign
id|brdp-&gt;nrpanels
suffix:semicolon
id|stl_brdstats.nrports
op_assign
id|brdp-&gt;nrports
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|brdp-&gt;nrpanels
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|panelp
op_assign
id|brdp-&gt;panels
(braket
id|i
)braket
suffix:semicolon
id|stl_brdstats.panels
(braket
id|i
)braket
dot
id|panel
op_assign
id|i
suffix:semicolon
id|stl_brdstats.panels
(braket
id|i
)braket
dot
id|hwid
op_assign
id|panelp-&gt;hwid
suffix:semicolon
id|stl_brdstats.panels
(braket
id|i
)braket
dot
id|nrports
op_assign
id|panelp-&gt;nrports
suffix:semicolon
)brace
id|copy_to_user
c_func
(paren
id|bp
comma
op_amp
id|stl_brdstats
comma
r_sizeof
(paren
id|combrd_t
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Resolve the referenced port number into a port struct pointer.&n; */
DECL|function|stl_getport
r_static
id|stlport_t
op_star
id|stl_getport
c_func
(paren
r_int
id|brdnr
comma
r_int
id|panelnr
comma
r_int
id|portnr
)paren
(brace
id|stlbrd_t
op_star
id|brdp
suffix:semicolon
id|stlpanel_t
op_star
id|panelp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|brdnr
OL
l_int|0
)paren
op_logical_or
(paren
id|brdnr
op_ge
id|STL_MAXBRDS
)paren
)paren
r_return
(paren
id|stlport_t
op_star
)paren
l_int|NULL
suffix:semicolon
id|brdp
op_assign
id|stl_brds
(braket
id|brdnr
)braket
suffix:semicolon
r_if
c_cond
(paren
id|brdp
op_eq
(paren
id|stlbrd_t
op_star
)paren
l_int|NULL
)paren
r_return
(paren
id|stlport_t
op_star
)paren
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|panelnr
OL
l_int|0
)paren
op_logical_or
(paren
id|panelnr
op_ge
id|brdp-&gt;nrpanels
)paren
)paren
r_return
(paren
id|stlport_t
op_star
)paren
l_int|NULL
suffix:semicolon
id|panelp
op_assign
id|brdp-&gt;panels
(braket
id|panelnr
)braket
suffix:semicolon
r_if
c_cond
(paren
id|panelp
op_eq
(paren
id|stlpanel_t
op_star
)paren
l_int|NULL
)paren
r_return
(paren
id|stlport_t
op_star
)paren
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|portnr
OL
l_int|0
)paren
op_logical_or
(paren
id|portnr
op_ge
id|panelp-&gt;nrports
)paren
)paren
r_return
(paren
id|stlport_t
op_star
)paren
l_int|NULL
suffix:semicolon
r_return
id|panelp-&gt;ports
(braket
id|portnr
)braket
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Return the port stats structure to user app. A NULL port struct&n; *&t;pointer passed in means that we need to find out from the app&n; *&t;what port to get stats for (used through board control device).&n; */
DECL|function|stl_getportstats
r_static
r_int
id|stl_getportstats
c_func
(paren
id|stlport_t
op_star
id|portp
comma
id|comstats_t
op_star
id|cp
)paren
(brace
r_int
r_char
op_star
id|head
comma
op_star
id|tail
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
(brace
id|copy_from_user
c_func
(paren
op_amp
id|stl_comstats
comma
id|cp
comma
r_sizeof
(paren
id|comstats_t
)paren
)paren
suffix:semicolon
id|portp
op_assign
id|stl_getport
c_func
(paren
id|stl_comstats.brd
comma
id|stl_comstats.panel
comma
id|stl_comstats.port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|portp-&gt;stats.state
op_assign
id|portp-&gt;istate
suffix:semicolon
id|portp-&gt;stats.flags
op_assign
id|portp-&gt;flags
suffix:semicolon
id|portp-&gt;stats.hwid
op_assign
id|portp-&gt;hwid
suffix:semicolon
id|portp-&gt;stats.ttystate
op_assign
l_int|0
suffix:semicolon
id|portp-&gt;stats.cflags
op_assign
l_int|0
suffix:semicolon
id|portp-&gt;stats.iflags
op_assign
l_int|0
suffix:semicolon
id|portp-&gt;stats.oflags
op_assign
l_int|0
suffix:semicolon
id|portp-&gt;stats.lflags
op_assign
l_int|0
suffix:semicolon
id|portp-&gt;stats.rxbuffered
op_assign
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|portp-&gt;tty
op_ne
(paren
r_struct
id|tty_struct
op_star
)paren
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|portp-&gt;tty-&gt;driver_data
op_eq
id|portp
)paren
(brace
id|portp-&gt;stats.ttystate
op_assign
id|portp-&gt;tty-&gt;flags
suffix:semicolon
id|portp-&gt;stats.rxbuffered
op_assign
id|portp-&gt;tty-&gt;flip.count
suffix:semicolon
r_if
c_cond
(paren
id|portp-&gt;tty-&gt;termios
op_ne
(paren
r_struct
id|termios
op_star
)paren
l_int|NULL
)paren
(brace
id|portp-&gt;stats.cflags
op_assign
id|portp-&gt;tty-&gt;termios-&gt;c_cflag
suffix:semicolon
id|portp-&gt;stats.iflags
op_assign
id|portp-&gt;tty-&gt;termios-&gt;c_iflag
suffix:semicolon
id|portp-&gt;stats.oflags
op_assign
id|portp-&gt;tty-&gt;termios-&gt;c_oflag
suffix:semicolon
id|portp-&gt;stats.lflags
op_assign
id|portp-&gt;tty-&gt;termios-&gt;c_lflag
suffix:semicolon
)brace
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|head
op_assign
id|portp-&gt;tx.head
suffix:semicolon
id|tail
op_assign
id|portp-&gt;tx.tail
suffix:semicolon
id|portp-&gt;stats.txbuffered
op_assign
(paren
(paren
id|head
op_ge
id|tail
)paren
ques
c_cond
(paren
id|head
op_minus
id|tail
)paren
suffix:colon
(paren
id|STL_TXBUFSIZE
op_minus
(paren
id|tail
op_minus
id|head
)paren
)paren
)paren
suffix:semicolon
id|portp-&gt;stats.signals
op_assign
(paren
r_int
r_int
)paren
id|stl_getsignals
c_func
(paren
id|portp
)paren
suffix:semicolon
id|copy_to_user
c_func
(paren
id|cp
comma
op_amp
id|portp-&gt;stats
comma
r_sizeof
(paren
id|comstats_t
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Clear the port stats structure. We also return it zeroed out...&n; */
DECL|function|stl_clrportstats
r_static
r_int
id|stl_clrportstats
c_func
(paren
id|stlport_t
op_star
id|portp
comma
id|comstats_t
op_star
id|cp
)paren
(brace
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
(brace
id|copy_from_user
c_func
(paren
op_amp
id|stl_comstats
comma
id|cp
comma
r_sizeof
(paren
id|comstats_t
)paren
)paren
suffix:semicolon
id|portp
op_assign
id|stl_getport
c_func
(paren
id|stl_comstats.brd
comma
id|stl_comstats.panel
comma
id|stl_comstats.port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|memset
c_func
(paren
op_amp
id|portp-&gt;stats
comma
l_int|0
comma
r_sizeof
(paren
id|comstats_t
)paren
)paren
suffix:semicolon
id|portp-&gt;stats.brd
op_assign
id|portp-&gt;brdnr
suffix:semicolon
id|portp-&gt;stats.panel
op_assign
id|portp-&gt;panelnr
suffix:semicolon
id|portp-&gt;stats.port
op_assign
id|portp-&gt;portnr
suffix:semicolon
id|copy_to_user
c_func
(paren
id|cp
comma
op_amp
id|portp-&gt;stats
comma
r_sizeof
(paren
id|comstats_t
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Return the entire driver ports structure to a user app.&n; */
DECL|function|stl_getportstruct
r_static
r_int
id|stl_getportstruct
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
id|stlport_t
op_star
id|portp
suffix:semicolon
id|copy_from_user
c_func
(paren
op_amp
id|stl_dummyport
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|stlport_t
)paren
)paren
suffix:semicolon
id|portp
op_assign
id|stl_getport
c_func
(paren
id|stl_dummyport.brdnr
comma
id|stl_dummyport.panelnr
comma
id|stl_dummyport.portnr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
id|portp
comma
r_sizeof
(paren
id|stlport_t
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Return the entire driver board structure to a user app.&n; */
DECL|function|stl_getbrdstruct
r_static
r_int
id|stl_getbrdstruct
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
id|stlbrd_t
op_star
id|brdp
suffix:semicolon
id|copy_from_user
c_func
(paren
op_amp
id|stl_dummybrd
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|stlbrd_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|stl_dummybrd.brdnr
OL
l_int|0
)paren
op_logical_or
(paren
id|stl_dummybrd.brdnr
op_ge
id|STL_MAXBRDS
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|brdp
op_assign
id|stl_brds
(braket
id|stl_dummybrd.brdnr
)braket
suffix:semicolon
r_if
c_cond
(paren
id|brdp
op_eq
(paren
id|stlbrd_t
op_star
)paren
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
id|brdp
comma
r_sizeof
(paren
id|stlbrd_t
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;The &quot;staliomem&quot; device is also required to do some special operations&n; *&t;on the board and/or ports. In this driver it is mostly used for stats&n; *&t;collection.&n; */
DECL|function|stl_memioctl
r_static
r_int
id|stl_memioctl
c_func
(paren
r_struct
id|inode
op_star
id|ip
comma
r_struct
id|file
op_star
id|fp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|brdnr
comma
id|rc
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_memioctl(ip=%x,fp=%x,cmd=%x,arg=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|ip
comma
(paren
r_int
)paren
id|fp
comma
id|cmd
comma
(paren
r_int
)paren
id|arg
)paren
suffix:semicolon
macro_line|#endif
id|brdnr
op_assign
id|MINOR
c_func
(paren
id|ip-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|brdnr
op_ge
id|STL_MAXBRDS
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|COM_GETPORTSTATS
suffix:colon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|comstats_t
)paren
)paren
)paren
op_eq
l_int|0
)paren
id|rc
op_assign
id|stl_getportstats
c_func
(paren
(paren
id|stlport_t
op_star
)paren
l_int|NULL
comma
(paren
id|comstats_t
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|COM_CLRPORTSTATS
suffix:colon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|comstats_t
)paren
)paren
)paren
op_eq
l_int|0
)paren
id|rc
op_assign
id|stl_clrportstats
c_func
(paren
(paren
id|stlport_t
op_star
)paren
l_int|NULL
comma
(paren
id|comstats_t
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|COM_GETBRDSTATS
suffix:colon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|combrd_t
)paren
)paren
)paren
op_eq
l_int|0
)paren
id|rc
op_assign
id|stl_getbrdstats
c_func
(paren
(paren
id|combrd_t
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|COM_READPORT
suffix:colon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|stlport_t
)paren
)paren
)paren
op_eq
l_int|0
)paren
id|rc
op_assign
id|stl_getportstruct
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|COM_READBOARD
suffix:colon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|stlbrd_t
)paren
)paren
)paren
op_eq
l_int|0
)paren
id|rc
op_assign
id|stl_getbrdstruct
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|rc
op_assign
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|stl_init
r_int
id|__init
id|stl_init
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: version %s&bslash;n&quot;
comma
id|stl_drvtitle
comma
id|stl_drvversion
)paren
suffix:semicolon
id|stl_initbrds
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;Allocate a temporary write buffer.&n; */
id|stl_tmpwritebuf
op_assign
(paren
r_char
op_star
)paren
id|stl_memalloc
c_func
(paren
id|STL_TXBUFSIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stl_tmpwritebuf
op_eq
(paren
r_char
op_star
)paren
l_int|NULL
)paren
id|printk
c_func
(paren
l_string|&quot;STALLION: failed to allocate memory (size=%d)&bslash;n&quot;
comma
id|STL_TXBUFSIZE
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;Set up a character driver for per board stuff. This is mainly used&n; *&t;to do stats ioctls on the ports.&n; */
r_if
c_cond
(paren
id|devfs_register_chrdev
c_func
(paren
id|STL_SIOMEMMAJOR
comma
l_string|&quot;staliomem&quot;
comma
op_amp
id|stl_fsiomem
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;STALLION: failed to register serial board device&bslash;n&quot;
)paren
suffix:semicolon
id|devfs_handle
op_assign
id|devfs_mk_dir
(paren
l_int|NULL
comma
l_string|&quot;staliomem&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|devfs_register_series
(paren
id|devfs_handle
comma
l_string|&quot;%u&quot;
comma
l_int|4
comma
id|DEVFS_FL_DEFAULT
comma
id|STL_SIOMEMMAJOR
comma
l_int|0
comma
id|S_IFCHR
op_or
id|S_IRUSR
op_or
id|S_IWUSR
comma
op_amp
id|stl_fsiomem
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;Set up the tty driver structure and register us as a driver.&n; *&t;Also setup the callout tty device.&n; */
id|memset
c_func
(paren
op_amp
id|stl_serial
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tty_driver
)paren
)paren
suffix:semicolon
id|stl_serial.magic
op_assign
id|TTY_DRIVER_MAGIC
suffix:semicolon
id|stl_serial.driver_name
op_assign
id|stl_drvname
suffix:semicolon
id|stl_serial.name
op_assign
id|stl_serialname
suffix:semicolon
id|stl_serial.major
op_assign
id|STL_SERIALMAJOR
suffix:semicolon
id|stl_serial.minor_start
op_assign
l_int|0
suffix:semicolon
id|stl_serial.num
op_assign
id|STL_MAXBRDS
op_star
id|STL_MAXPORTS
suffix:semicolon
id|stl_serial.type
op_assign
id|TTY_DRIVER_TYPE_SERIAL
suffix:semicolon
id|stl_serial.subtype
op_assign
id|STL_DRVTYPSERIAL
suffix:semicolon
id|stl_serial.init_termios
op_assign
id|stl_deftermios
suffix:semicolon
id|stl_serial.flags
op_assign
id|TTY_DRIVER_REAL_RAW
suffix:semicolon
id|stl_serial.refcount
op_assign
op_amp
id|stl_refcount
suffix:semicolon
id|stl_serial.table
op_assign
id|stl_ttys
suffix:semicolon
id|stl_serial.termios
op_assign
id|stl_termios
suffix:semicolon
id|stl_serial.termios_locked
op_assign
id|stl_termioslocked
suffix:semicolon
id|stl_serial.open
op_assign
id|stl_open
suffix:semicolon
id|stl_serial.close
op_assign
id|stl_close
suffix:semicolon
id|stl_serial.write
op_assign
id|stl_write
suffix:semicolon
id|stl_serial.put_char
op_assign
id|stl_putchar
suffix:semicolon
id|stl_serial.flush_chars
op_assign
id|stl_flushchars
suffix:semicolon
id|stl_serial.write_room
op_assign
id|stl_writeroom
suffix:semicolon
id|stl_serial.chars_in_buffer
op_assign
id|stl_charsinbuffer
suffix:semicolon
id|stl_serial.ioctl
op_assign
id|stl_ioctl
suffix:semicolon
id|stl_serial.set_termios
op_assign
id|stl_settermios
suffix:semicolon
id|stl_serial.throttle
op_assign
id|stl_throttle
suffix:semicolon
id|stl_serial.unthrottle
op_assign
id|stl_unthrottle
suffix:semicolon
id|stl_serial.stop
op_assign
id|stl_stop
suffix:semicolon
id|stl_serial.start
op_assign
id|stl_start
suffix:semicolon
id|stl_serial.hangup
op_assign
id|stl_hangup
suffix:semicolon
id|stl_serial.flush_buffer
op_assign
id|stl_flushbuffer
suffix:semicolon
id|stl_serial.break_ctl
op_assign
id|stl_breakctl
suffix:semicolon
id|stl_serial.wait_until_sent
op_assign
id|stl_waituntilsent
suffix:semicolon
id|stl_serial.send_xchar
op_assign
id|stl_sendxchar
suffix:semicolon
id|stl_serial.read_proc
op_assign
id|stl_readproc
suffix:semicolon
id|stl_callout
op_assign
id|stl_serial
suffix:semicolon
id|stl_callout.name
op_assign
id|stl_calloutname
suffix:semicolon
id|stl_callout.major
op_assign
id|STL_CALLOUTMAJOR
suffix:semicolon
id|stl_callout.subtype
op_assign
id|STL_DRVTYPCALLOUT
suffix:semicolon
id|stl_callout.read_proc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tty_register_driver
c_func
(paren
op_amp
id|stl_serial
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;STALLION: failed to register serial driver&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty_register_driver
c_func
(paren
op_amp
id|stl_callout
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;STALLION: failed to register callout driver&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*                       CD1400 HARDWARE FUNCTIONS                           */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;These functions get/set/update the registers of the cd1400 UARTs.&n; *&t;Access to the cd1400 registers is via an address/data io port pair.&n; *&t;(Maybe should make this inline...)&n; */
DECL|function|stl_cd1400getreg
r_static
r_int
id|stl_cd1400getreg
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|regnr
)paren
(brace
id|outb
c_func
(paren
(paren
id|regnr
op_plus
id|portp-&gt;uartaddr
)paren
comma
id|portp-&gt;ioaddr
)paren
suffix:semicolon
r_return
id|inb
c_func
(paren
id|portp-&gt;ioaddr
op_plus
id|EREG_DATA
)paren
suffix:semicolon
)brace
DECL|function|stl_cd1400setreg
r_static
r_void
id|stl_cd1400setreg
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|regnr
comma
r_int
id|value
)paren
(brace
id|outb
c_func
(paren
(paren
id|regnr
op_plus
id|portp-&gt;uartaddr
)paren
comma
id|portp-&gt;ioaddr
)paren
suffix:semicolon
id|outb
c_func
(paren
id|value
comma
id|portp-&gt;ioaddr
op_plus
id|EREG_DATA
)paren
suffix:semicolon
)brace
DECL|function|stl_cd1400updatereg
r_static
r_int
id|stl_cd1400updatereg
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|regnr
comma
r_int
id|value
)paren
(brace
id|outb
c_func
(paren
(paren
id|regnr
op_plus
id|portp-&gt;uartaddr
)paren
comma
id|portp-&gt;ioaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|portp-&gt;ioaddr
op_plus
id|EREG_DATA
)paren
op_ne
id|value
)paren
(brace
id|outb
c_func
(paren
id|value
comma
id|portp-&gt;ioaddr
op_plus
id|EREG_DATA
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Inbitialize the UARTs in a panel. We don&squot;t care what sort of board&n; *&t;these ports are on - since the port io registers are almost&n; *&t;identical when dealing with ports.&n; */
DECL|function|stl_cd1400panelinit
r_static
r_int
id|stl_cd1400panelinit
c_func
(paren
id|stlbrd_t
op_star
id|brdp
comma
id|stlpanel_t
op_star
id|panelp
)paren
(brace
r_int
r_int
id|gfrcr
suffix:semicolon
r_int
id|chipmask
comma
id|i
comma
id|j
suffix:semicolon
r_int
id|nrchips
comma
id|uartaddr
comma
id|ioaddr
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_panelinit(brdp=%x,panelp=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|brdp
comma
(paren
r_int
)paren
id|panelp
)paren
suffix:semicolon
macro_line|#endif
id|BRDENABLE
c_func
(paren
id|panelp-&gt;brdnr
comma
id|panelp-&gt;pagenr
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;Check that each chip is present and started up OK.&n; */
id|chipmask
op_assign
l_int|0
suffix:semicolon
id|nrchips
op_assign
id|panelp-&gt;nrports
op_div
id|CD1400_PORTS
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|nrchips
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|brdp-&gt;brdtype
op_eq
id|BRD_ECHPCI
)paren
(brace
id|outb
c_func
(paren
(paren
id|panelp-&gt;pagenr
op_plus
(paren
id|i
op_rshift
l_int|1
)paren
)paren
comma
id|brdp-&gt;ioctrl
)paren
suffix:semicolon
id|ioaddr
op_assign
id|panelp-&gt;iobase
suffix:semicolon
)brace
r_else
(brace
id|ioaddr
op_assign
id|panelp-&gt;iobase
op_plus
(paren
id|EREG_BANKSIZE
op_star
(paren
id|i
op_rshift
l_int|1
)paren
)paren
suffix:semicolon
)brace
id|uartaddr
op_assign
(paren
id|i
op_amp
l_int|0x01
)paren
ques
c_cond
l_int|0x080
suffix:colon
l_int|0
suffix:semicolon
id|outb
c_func
(paren
(paren
id|GFRCR
op_plus
id|uartaddr
)paren
comma
id|ioaddr
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
(paren
id|ioaddr
op_plus
id|EREG_DATA
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|CCR
op_plus
id|uartaddr
)paren
comma
id|ioaddr
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CCR_RESETFULL
comma
(paren
id|ioaddr
op_plus
id|EREG_DATA
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CCR_RESETFULL
comma
(paren
id|ioaddr
op_plus
id|EREG_DATA
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|GFRCR
op_plus
id|uartaddr
)paren
comma
id|ioaddr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
(paren
id|j
OL
id|CCR_MAXWAIT
)paren
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|gfrcr
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|EREG_DATA
)paren
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|j
op_ge
id|CCR_MAXWAIT
)paren
op_logical_or
(paren
id|gfrcr
OL
l_int|0x40
)paren
op_logical_or
(paren
id|gfrcr
OG
l_int|0x60
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;STALLION: cd1400 not responding, &quot;
l_string|&quot;brd=%d panel=%d chip=%d&bslash;n&quot;
comma
id|panelp-&gt;brdnr
comma
id|panelp-&gt;panelnr
comma
id|i
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|chipmask
op_or_assign
(paren
l_int|0x1
op_lshift
id|i
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|PPR
op_plus
id|uartaddr
)paren
comma
id|ioaddr
)paren
suffix:semicolon
id|outb
c_func
(paren
id|PPR_SCALAR
comma
(paren
id|ioaddr
op_plus
id|EREG_DATA
)paren
)paren
suffix:semicolon
)brace
id|BRDDISABLE
c_func
(paren
id|panelp-&gt;brdnr
)paren
suffix:semicolon
r_return
id|chipmask
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Initialize hardware specific port registers.&n; */
DECL|function|stl_cd1400portinit
r_static
r_void
id|stl_cd1400portinit
c_func
(paren
id|stlbrd_t
op_star
id|brdp
comma
id|stlpanel_t
op_star
id|panelp
comma
id|stlport_t
op_star
id|portp
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_cd1400portinit(brdp=%x,panelp=%x,portp=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|brdp
comma
(paren
r_int
)paren
id|panelp
comma
(paren
r_int
)paren
id|portp
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|brdp
op_eq
(paren
id|stlbrd_t
op_star
)paren
l_int|NULL
)paren
op_logical_or
(paren
id|panelp
op_eq
(paren
id|stlpanel_t
op_star
)paren
l_int|NULL
)paren
op_logical_or
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
)paren
r_return
suffix:semicolon
id|portp-&gt;ioaddr
op_assign
id|panelp-&gt;iobase
op_plus
(paren
(paren
(paren
id|brdp-&gt;brdtype
op_eq
id|BRD_ECHPCI
)paren
op_logical_or
(paren
id|portp-&gt;portnr
OL
l_int|8
)paren
)paren
ques
c_cond
l_int|0
suffix:colon
id|EREG_BANKSIZE
)paren
suffix:semicolon
id|portp-&gt;uartaddr
op_assign
(paren
id|portp-&gt;portnr
op_amp
l_int|0x04
)paren
op_lshift
l_int|5
suffix:semicolon
id|portp-&gt;pagenr
op_assign
id|panelp-&gt;pagenr
op_plus
(paren
id|portp-&gt;portnr
op_rshift
l_int|3
)paren
suffix:semicolon
id|BRDENABLE
c_func
(paren
id|portp-&gt;brdnr
comma
id|portp-&gt;pagenr
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|CAR
comma
(paren
id|portp-&gt;portnr
op_amp
l_int|0x03
)paren
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|LIVR
comma
(paren
id|portp-&gt;portnr
op_lshift
l_int|3
)paren
)paren
suffix:semicolon
id|portp-&gt;hwid
op_assign
id|stl_cd1400getreg
c_func
(paren
id|portp
comma
id|GFRCR
)paren
suffix:semicolon
id|BRDDISABLE
c_func
(paren
id|portp-&gt;brdnr
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Wait for the command register to be ready. We will poll this,&n; *&t;since it won&squot;t usually take too long to be ready.&n; */
DECL|function|stl_cd1400ccrwait
r_static
r_void
id|stl_cd1400ccrwait
c_func
(paren
id|stlport_t
op_star
id|portp
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|CCR_MAXWAIT
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|stl_cd1400getreg
c_func
(paren
id|portp
comma
id|CCR
)paren
op_eq
l_int|0
)paren
(brace
r_return
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;STALLION: cd1400 not responding, port=%d panel=%d brd=%d&bslash;n&quot;
comma
id|portp-&gt;portnr
comma
id|portp-&gt;panelnr
comma
id|portp-&gt;brdnr
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Set up the cd1400 registers for a port based on the termios port&n; *&t;settings.&n; */
DECL|function|stl_cd1400setport
r_static
r_void
id|stl_cd1400setport
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_struct
id|termios
op_star
id|tiosp
)paren
(brace
id|stlbrd_t
op_star
id|brdp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|clkdiv
comma
id|baudrate
suffix:semicolon
r_int
r_char
id|cor1
comma
id|cor2
comma
id|cor3
suffix:semicolon
r_int
r_char
id|cor4
comma
id|cor5
comma
id|ccr
suffix:semicolon
r_int
r_char
id|srer
comma
id|sreron
comma
id|sreroff
suffix:semicolon
r_int
r_char
id|mcor1
comma
id|mcor2
comma
id|rtpr
suffix:semicolon
r_int
r_char
id|clk
comma
id|div
suffix:semicolon
id|cor1
op_assign
l_int|0
suffix:semicolon
id|cor2
op_assign
l_int|0
suffix:semicolon
id|cor3
op_assign
l_int|0
suffix:semicolon
id|cor4
op_assign
l_int|0
suffix:semicolon
id|cor5
op_assign
l_int|0
suffix:semicolon
id|ccr
op_assign
l_int|0
suffix:semicolon
id|rtpr
op_assign
l_int|0
suffix:semicolon
id|clk
op_assign
l_int|0
suffix:semicolon
id|div
op_assign
l_int|0
suffix:semicolon
id|mcor1
op_assign
l_int|0
suffix:semicolon
id|mcor2
op_assign
l_int|0
suffix:semicolon
id|sreron
op_assign
l_int|0
suffix:semicolon
id|sreroff
op_assign
l_int|0
suffix:semicolon
id|brdp
op_assign
id|stl_brds
(braket
id|portp-&gt;brdnr
)braket
suffix:semicolon
r_if
c_cond
(paren
id|brdp
op_eq
(paren
id|stlbrd_t
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
multiline_comment|/*&n; *&t;Set up the RX char ignore mask with those RX error types we&n; *&t;can ignore. We can get the cd1400 to help us out a little here,&n; *&t;it will ignore parity errors and breaks for us.&n; */
id|portp-&gt;rxignoremsk
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tiosp-&gt;c_iflag
op_amp
id|IGNPAR
)paren
(brace
id|portp-&gt;rxignoremsk
op_or_assign
(paren
id|ST_PARITY
op_or
id|ST_FRAMING
op_or
id|ST_OVERRUN
)paren
suffix:semicolon
id|cor1
op_or_assign
id|COR1_PARIGNORE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tiosp-&gt;c_iflag
op_amp
id|IGNBRK
)paren
(brace
id|portp-&gt;rxignoremsk
op_or_assign
id|ST_BREAK
suffix:semicolon
id|cor4
op_or_assign
id|COR4_IGNBRK
suffix:semicolon
)brace
id|portp-&gt;rxmarkmsk
op_assign
id|ST_OVERRUN
suffix:semicolon
r_if
c_cond
(paren
id|tiosp-&gt;c_iflag
op_amp
(paren
id|INPCK
op_or
id|PARMRK
)paren
)paren
id|portp-&gt;rxmarkmsk
op_or_assign
(paren
id|ST_PARITY
op_or
id|ST_FRAMING
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tiosp-&gt;c_iflag
op_amp
id|BRKINT
)paren
id|portp-&gt;rxmarkmsk
op_or_assign
id|ST_BREAK
suffix:semicolon
multiline_comment|/*&n; *&t;Go through the char size, parity and stop bits and set all the&n; *&t;option register appropriately.&n; */
r_switch
c_cond
(paren
id|tiosp-&gt;c_cflag
op_amp
id|CSIZE
)paren
(brace
r_case
id|CS5
suffix:colon
id|cor1
op_or_assign
id|COR1_CHL5
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS6
suffix:colon
id|cor1
op_or_assign
id|COR1_CHL6
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS7
suffix:colon
id|cor1
op_or_assign
id|COR1_CHL7
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|cor1
op_or_assign
id|COR1_CHL8
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tiosp-&gt;c_cflag
op_amp
id|CSTOPB
)paren
id|cor1
op_or_assign
id|COR1_STOP2
suffix:semicolon
r_else
id|cor1
op_or_assign
id|COR1_STOP1
suffix:semicolon
r_if
c_cond
(paren
id|tiosp-&gt;c_cflag
op_amp
id|PARENB
)paren
(brace
r_if
c_cond
(paren
id|tiosp-&gt;c_cflag
op_amp
id|PARODD
)paren
id|cor1
op_or_assign
(paren
id|COR1_PARENB
op_or
id|COR1_PARODD
)paren
suffix:semicolon
r_else
id|cor1
op_or_assign
(paren
id|COR1_PARENB
op_or
id|COR1_PAREVEN
)paren
suffix:semicolon
)brace
r_else
(brace
id|cor1
op_or_assign
id|COR1_PARNONE
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Set the RX FIFO threshold at 6 chars. This gives a bit of breathing&n; *&t;space for hardware flow control and the like. This should be set to&n; *&t;VMIN. Also here we will set the RX data timeout to 10ms - this should&n; *&t;really be based on VTIME.&n; */
id|cor3
op_or_assign
id|FIFO_RXTHRESHOLD
suffix:semicolon
id|rtpr
op_assign
l_int|2
suffix:semicolon
multiline_comment|/*&n; *&t;Calculate the baud rate timers. For now we will just assume that&n; *&t;the input and output baud are the same. Could have used a baud&n; *&t;table here, but this way we can generate virtually any baud rate&n; *&t;we like!&n; */
id|baudrate
op_assign
id|tiosp-&gt;c_cflag
op_amp
id|CBAUD
suffix:semicolon
r_if
c_cond
(paren
id|baudrate
op_amp
id|CBAUDEX
)paren
(brace
id|baudrate
op_and_assign
op_complement
id|CBAUDEX
suffix:semicolon
r_if
c_cond
(paren
(paren
id|baudrate
OL
l_int|1
)paren
op_logical_or
(paren
id|baudrate
OG
l_int|4
)paren
)paren
id|tiosp-&gt;c_cflag
op_and_assign
op_complement
id|CBAUDEX
suffix:semicolon
r_else
id|baudrate
op_add_assign
l_int|15
suffix:semicolon
)brace
id|baudrate
op_assign
id|stl_baudrates
(braket
id|baudrate
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tiosp-&gt;c_cflag
op_amp
id|CBAUD
)paren
op_eq
id|B38400
)paren
(brace
r_if
c_cond
(paren
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_SPD_MASK
)paren
op_eq
id|ASYNC_SPD_HI
)paren
id|baudrate
op_assign
l_int|57600
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_SPD_MASK
)paren
op_eq
id|ASYNC_SPD_VHI
)paren
id|baudrate
op_assign
l_int|115200
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_SPD_MASK
)paren
op_eq
id|ASYNC_SPD_SHI
)paren
id|baudrate
op_assign
l_int|230400
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_SPD_MASK
)paren
op_eq
id|ASYNC_SPD_WARP
)paren
id|baudrate
op_assign
l_int|460800
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_SPD_MASK
)paren
op_eq
id|ASYNC_SPD_CUST
)paren
id|baudrate
op_assign
(paren
id|portp-&gt;baud_base
op_div
id|portp-&gt;custom_divisor
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|baudrate
OG
id|STL_CD1400MAXBAUD
)paren
id|baudrate
op_assign
id|STL_CD1400MAXBAUD
suffix:semicolon
r_if
c_cond
(paren
id|baudrate
OG
l_int|0
)paren
(brace
r_for
c_loop
(paren
id|clk
op_assign
l_int|0
suffix:semicolon
(paren
id|clk
OL
id|CD1400_NUMCLKS
)paren
suffix:semicolon
id|clk
op_increment
)paren
(brace
id|clkdiv
op_assign
(paren
(paren
id|portp-&gt;clk
op_div
id|stl_cd1400clkdivs
(braket
id|clk
)braket
)paren
op_div
id|baudrate
)paren
suffix:semicolon
r_if
c_cond
(paren
id|clkdiv
OL
l_int|0x100
)paren
r_break
suffix:semicolon
)brace
id|div
op_assign
(paren
r_int
r_char
)paren
id|clkdiv
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Check what form of modem signaling is required and set it up.&n; */
r_if
c_cond
(paren
(paren
id|tiosp-&gt;c_cflag
op_amp
id|CLOCAL
)paren
op_eq
l_int|0
)paren
(brace
id|mcor1
op_or_assign
id|MCOR1_DCD
suffix:semicolon
id|mcor2
op_or_assign
id|MCOR2_DCD
suffix:semicolon
id|sreron
op_or_assign
id|SRER_MODEM
suffix:semicolon
id|portp-&gt;flags
op_or_assign
id|ASYNC_CHECK_CD
suffix:semicolon
)brace
r_else
(brace
id|portp-&gt;flags
op_and_assign
op_complement
id|ASYNC_CHECK_CD
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Setup cd1400 enhanced modes if we can. In particular we want to&n; *&t;handle as much of the flow control as possible automatically. As&n; *&t;well as saving a few CPU cycles it will also greatly improve flow&n; *&t;control reliability.&n; */
r_if
c_cond
(paren
id|tiosp-&gt;c_iflag
op_amp
id|IXON
)paren
(brace
id|cor2
op_or_assign
id|COR2_TXIBE
suffix:semicolon
id|cor3
op_or_assign
id|COR3_SCD12
suffix:semicolon
r_if
c_cond
(paren
id|tiosp-&gt;c_iflag
op_amp
id|IXANY
)paren
id|cor2
op_or_assign
id|COR2_IXM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tiosp-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
(brace
id|cor2
op_or_assign
id|COR2_CTSAE
suffix:semicolon
id|mcor1
op_or_assign
id|FIFO_RTSTHRESHOLD
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;All cd1400 register values calculated so go through and set&n; *&t;them all up.&n; */
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;SETPORT: portnr=%d panelnr=%d brdnr=%d&bslash;n&quot;
comma
id|portp-&gt;portnr
comma
id|portp-&gt;panelnr
comma
id|portp-&gt;brdnr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;    cor1=%x cor2=%x cor3=%x cor4=%x cor5=%x&bslash;n&quot;
comma
id|cor1
comma
id|cor2
comma
id|cor3
comma
id|cor4
comma
id|cor5
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;    mcor1=%x mcor2=%x rtpr=%x sreron=%x sreroff=%x&bslash;n&quot;
comma
id|mcor1
comma
id|mcor2
comma
id|rtpr
comma
id|sreron
comma
id|sreroff
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;    tcor=%x tbpr=%x rcor=%x rbpr=%x&bslash;n&quot;
comma
id|clk
comma
id|div
comma
id|clk
comma
id|div
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;    schr1=%x schr2=%x schr3=%x schr4=%x&bslash;n&quot;
comma
id|tiosp-&gt;c_cc
(braket
id|VSTART
)braket
comma
id|tiosp-&gt;c_cc
(braket
id|VSTOP
)braket
comma
id|tiosp-&gt;c_cc
(braket
id|VSTART
)braket
comma
id|tiosp-&gt;c_cc
(braket
id|VSTOP
)braket
)paren
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|BRDENABLE
c_func
(paren
id|portp-&gt;brdnr
comma
id|portp-&gt;pagenr
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|CAR
comma
(paren
id|portp-&gt;portnr
op_amp
l_int|0x3
)paren
)paren
suffix:semicolon
id|srer
op_assign
id|stl_cd1400getreg
c_func
(paren
id|portp
comma
id|SRER
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|SRER
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stl_cd1400updatereg
c_func
(paren
id|portp
comma
id|COR1
comma
id|cor1
)paren
)paren
id|ccr
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|stl_cd1400updatereg
c_func
(paren
id|portp
comma
id|COR2
comma
id|cor2
)paren
)paren
id|ccr
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|stl_cd1400updatereg
c_func
(paren
id|portp
comma
id|COR3
comma
id|cor3
)paren
)paren
id|ccr
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ccr
)paren
(brace
id|stl_cd1400ccrwait
c_func
(paren
id|portp
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|CCR
comma
id|CCR_CORCHANGE
)paren
suffix:semicolon
)brace
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|COR4
comma
id|cor4
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|COR5
comma
id|cor5
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|MCOR1
comma
id|mcor1
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|MCOR2
comma
id|mcor2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|baudrate
OG
l_int|0
)paren
(brace
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|TCOR
comma
id|clk
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|TBPR
comma
id|div
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|RCOR
comma
id|clk
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|RBPR
comma
id|div
)paren
suffix:semicolon
)brace
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|SCHR1
comma
id|tiosp-&gt;c_cc
(braket
id|VSTART
)braket
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|SCHR2
comma
id|tiosp-&gt;c_cc
(braket
id|VSTOP
)braket
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|SCHR3
comma
id|tiosp-&gt;c_cc
(braket
id|VSTART
)braket
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|SCHR4
comma
id|tiosp-&gt;c_cc
(braket
id|VSTOP
)braket
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|RTPR
comma
id|rtpr
)paren
suffix:semicolon
id|mcor1
op_assign
id|stl_cd1400getreg
c_func
(paren
id|portp
comma
id|MSVR1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mcor1
op_amp
id|MSVR1_DCD
)paren
id|portp-&gt;sigs
op_or_assign
id|TIOCM_CD
suffix:semicolon
r_else
id|portp-&gt;sigs
op_and_assign
op_complement
id|TIOCM_CD
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|SRER
comma
(paren
(paren
id|srer
op_amp
op_complement
id|sreroff
)paren
op_or
id|sreron
)paren
)paren
suffix:semicolon
id|BRDDISABLE
c_func
(paren
id|portp-&gt;brdnr
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Set the state of the DTR and RTS signals.&n; */
DECL|function|stl_cd1400setsignals
r_static
r_void
id|stl_cd1400setsignals
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|dtr
comma
r_int
id|rts
)paren
(brace
r_int
r_char
id|msvr1
comma
id|msvr2
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_cd1400setsignals(portp=%x,dtr=%d,rts=%d)&bslash;n&quot;
comma
(paren
r_int
)paren
id|portp
comma
id|dtr
comma
id|rts
)paren
suffix:semicolon
macro_line|#endif
id|msvr1
op_assign
l_int|0
suffix:semicolon
id|msvr2
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dtr
OG
l_int|0
)paren
id|msvr1
op_assign
id|MSVR1_DTR
suffix:semicolon
r_if
c_cond
(paren
id|rts
OG
l_int|0
)paren
id|msvr2
op_assign
id|MSVR2_RTS
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|BRDENABLE
c_func
(paren
id|portp-&gt;brdnr
comma
id|portp-&gt;pagenr
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|CAR
comma
(paren
id|portp-&gt;portnr
op_amp
l_int|0x03
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rts
op_ge
l_int|0
)paren
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|MSVR2
comma
id|msvr2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dtr
op_ge
l_int|0
)paren
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|MSVR1
comma
id|msvr1
)paren
suffix:semicolon
id|BRDDISABLE
c_func
(paren
id|portp-&gt;brdnr
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Return the state of the signals.&n; */
DECL|function|stl_cd1400getsignals
r_static
r_int
id|stl_cd1400getsignals
c_func
(paren
id|stlport_t
op_star
id|portp
)paren
(brace
r_int
r_char
id|msvr1
comma
id|msvr2
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|sigs
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_cd1400getsignals(portp=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|portp
)paren
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|BRDENABLE
c_func
(paren
id|portp-&gt;brdnr
comma
id|portp-&gt;pagenr
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|CAR
comma
(paren
id|portp-&gt;portnr
op_amp
l_int|0x03
)paren
)paren
suffix:semicolon
id|msvr1
op_assign
id|stl_cd1400getreg
c_func
(paren
id|portp
comma
id|MSVR1
)paren
suffix:semicolon
id|msvr2
op_assign
id|stl_cd1400getreg
c_func
(paren
id|portp
comma
id|MSVR2
)paren
suffix:semicolon
id|BRDDISABLE
c_func
(paren
id|portp-&gt;brdnr
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|sigs
op_assign
l_int|0
suffix:semicolon
id|sigs
op_or_assign
(paren
id|msvr1
op_amp
id|MSVR1_DCD
)paren
ques
c_cond
id|TIOCM_CD
suffix:colon
l_int|0
suffix:semicolon
id|sigs
op_or_assign
(paren
id|msvr1
op_amp
id|MSVR1_CTS
)paren
ques
c_cond
id|TIOCM_CTS
suffix:colon
l_int|0
suffix:semicolon
id|sigs
op_or_assign
(paren
id|msvr1
op_amp
id|MSVR1_DTR
)paren
ques
c_cond
id|TIOCM_DTR
suffix:colon
l_int|0
suffix:semicolon
id|sigs
op_or_assign
(paren
id|msvr2
op_amp
id|MSVR2_RTS
)paren
ques
c_cond
id|TIOCM_RTS
suffix:colon
l_int|0
suffix:semicolon
macro_line|#if 0
id|sigs
op_or_assign
(paren
id|msvr1
op_amp
id|MSVR1_RI
)paren
ques
c_cond
id|TIOCM_RI
suffix:colon
l_int|0
suffix:semicolon
id|sigs
op_or_assign
(paren
id|msvr1
op_amp
id|MSVR1_DSR
)paren
ques
c_cond
id|TIOCM_DSR
suffix:colon
l_int|0
suffix:semicolon
macro_line|#else
id|sigs
op_or_assign
id|TIOCM_DSR
suffix:semicolon
macro_line|#endif
r_return
id|sigs
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Enable/Disable the Transmitter and/or Receiver.&n; */
DECL|function|stl_cd1400enablerxtx
r_static
r_void
id|stl_cd1400enablerxtx
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|rx
comma
r_int
id|tx
)paren
(brace
r_int
r_char
id|ccr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_cd1400enablerxtx(portp=%x,rx=%d,tx=%d)&bslash;n&quot;
comma
(paren
r_int
)paren
id|portp
comma
id|rx
comma
id|tx
)paren
suffix:semicolon
macro_line|#endif
id|ccr
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tx
op_eq
l_int|0
)paren
id|ccr
op_or_assign
id|CCR_TXDISABLE
suffix:semicolon
r_else
r_if
c_cond
(paren
id|tx
OG
l_int|0
)paren
id|ccr
op_or_assign
id|CCR_TXENABLE
suffix:semicolon
r_if
c_cond
(paren
id|rx
op_eq
l_int|0
)paren
id|ccr
op_or_assign
id|CCR_RXDISABLE
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rx
OG
l_int|0
)paren
id|ccr
op_or_assign
id|CCR_RXENABLE
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|BRDENABLE
c_func
(paren
id|portp-&gt;brdnr
comma
id|portp-&gt;pagenr
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|CAR
comma
(paren
id|portp-&gt;portnr
op_amp
l_int|0x03
)paren
)paren
suffix:semicolon
id|stl_cd1400ccrwait
c_func
(paren
id|portp
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|CCR
comma
id|ccr
)paren
suffix:semicolon
id|stl_cd1400ccrwait
c_func
(paren
id|portp
)paren
suffix:semicolon
id|BRDDISABLE
c_func
(paren
id|portp-&gt;brdnr
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Start/stop the Transmitter and/or Receiver.&n; */
DECL|function|stl_cd1400startrxtx
r_static
r_void
id|stl_cd1400startrxtx
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|rx
comma
r_int
id|tx
)paren
(brace
r_int
r_char
id|sreron
comma
id|sreroff
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_cd1400startrxtx(portp=%x,rx=%d,tx=%d)&bslash;n&quot;
comma
(paren
r_int
)paren
id|portp
comma
id|rx
comma
id|tx
)paren
suffix:semicolon
macro_line|#endif
id|sreron
op_assign
l_int|0
suffix:semicolon
id|sreroff
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tx
op_eq
l_int|0
)paren
id|sreroff
op_or_assign
(paren
id|SRER_TXDATA
op_or
id|SRER_TXEMPTY
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|tx
op_eq
l_int|1
)paren
id|sreron
op_or_assign
id|SRER_TXDATA
suffix:semicolon
r_else
r_if
c_cond
(paren
id|tx
op_ge
l_int|2
)paren
id|sreron
op_or_assign
id|SRER_TXEMPTY
suffix:semicolon
r_if
c_cond
(paren
id|rx
op_eq
l_int|0
)paren
id|sreroff
op_or_assign
id|SRER_RXDATA
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rx
OG
l_int|0
)paren
id|sreron
op_or_assign
id|SRER_RXDATA
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|BRDENABLE
c_func
(paren
id|portp-&gt;brdnr
comma
id|portp-&gt;pagenr
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|CAR
comma
(paren
id|portp-&gt;portnr
op_amp
l_int|0x03
)paren
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|SRER
comma
(paren
(paren
id|stl_cd1400getreg
c_func
(paren
id|portp
comma
id|SRER
)paren
op_amp
op_complement
id|sreroff
)paren
op_or
id|sreron
)paren
)paren
suffix:semicolon
id|BRDDISABLE
c_func
(paren
id|portp-&gt;brdnr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tx
OG
l_int|0
)paren
id|set_bit
c_func
(paren
id|ASYI_TXBUSY
comma
op_amp
id|portp-&gt;istate
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Disable all interrupts from this port.&n; */
DECL|function|stl_cd1400disableintrs
r_static
r_void
id|stl_cd1400disableintrs
c_func
(paren
id|stlport_t
op_star
id|portp
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_cd1400disableintrs(portp=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|portp
)paren
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|BRDENABLE
c_func
(paren
id|portp-&gt;brdnr
comma
id|portp-&gt;pagenr
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|CAR
comma
(paren
id|portp-&gt;portnr
op_amp
l_int|0x03
)paren
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|SRER
comma
l_int|0
)paren
suffix:semicolon
id|BRDDISABLE
c_func
(paren
id|portp-&gt;brdnr
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|stl_cd1400sendbreak
r_static
r_void
id|stl_cd1400sendbreak
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|len
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_cd1400sendbreak(portp=%x,len=%d)&bslash;n&quot;
comma
(paren
r_int
)paren
id|portp
comma
id|len
)paren
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|BRDENABLE
c_func
(paren
id|portp-&gt;brdnr
comma
id|portp-&gt;pagenr
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|CAR
comma
(paren
id|portp-&gt;portnr
op_amp
l_int|0x03
)paren
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|SRER
comma
(paren
(paren
id|stl_cd1400getreg
c_func
(paren
id|portp
comma
id|SRER
)paren
op_amp
op_complement
id|SRER_TXDATA
)paren
op_or
id|SRER_TXEMPTY
)paren
)paren
suffix:semicolon
id|BRDDISABLE
c_func
(paren
id|portp-&gt;brdnr
)paren
suffix:semicolon
id|portp-&gt;brklen
op_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|len
op_eq
l_int|1
)paren
id|portp-&gt;stats.txbreaks
op_increment
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Take flow control actions...&n; */
DECL|function|stl_cd1400flowctrl
r_static
r_void
id|stl_cd1400flowctrl
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|state
)paren
(brace
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_cd1400flowctrl(portp=%x,state=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|portp
comma
id|state
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|tty
op_assign
id|portp-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
id|tty
op_eq
(paren
r_struct
id|tty_struct
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|BRDENABLE
c_func
(paren
id|portp-&gt;brdnr
comma
id|portp-&gt;pagenr
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|CAR
comma
(paren
id|portp-&gt;portnr
op_amp
l_int|0x03
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
)paren
(brace
r_if
c_cond
(paren
id|tty-&gt;termios-&gt;c_iflag
op_amp
id|IXOFF
)paren
(brace
id|stl_cd1400ccrwait
c_func
(paren
id|portp
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|CCR
comma
id|CCR_SENDSCHR1
)paren
suffix:semicolon
id|portp-&gt;stats.rxxon
op_increment
suffix:semicolon
id|stl_cd1400ccrwait
c_func
(paren
id|portp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;&t;Question: should we return RTS to what it was before? It may&n; *&t;&t;have been set by an ioctl... Suppose not, since if you have&n; *&t;&t;hardware flow control set then it is pretty silly to go and&n; *&t;&t;set the RTS line by hand.&n; */
r_if
c_cond
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
(brace
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|MCOR1
comma
(paren
id|stl_cd1400getreg
c_func
(paren
id|portp
comma
id|MCOR1
)paren
op_or
id|FIFO_RTSTHRESHOLD
)paren
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|MSVR2
comma
id|MSVR2_RTS
)paren
suffix:semicolon
id|portp-&gt;stats.rxrtson
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|tty-&gt;termios-&gt;c_iflag
op_amp
id|IXOFF
)paren
(brace
id|stl_cd1400ccrwait
c_func
(paren
id|portp
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|CCR
comma
id|CCR_SENDSCHR2
)paren
suffix:semicolon
id|portp-&gt;stats.rxxoff
op_increment
suffix:semicolon
id|stl_cd1400ccrwait
c_func
(paren
id|portp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
(brace
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|MCOR1
comma
(paren
id|stl_cd1400getreg
c_func
(paren
id|portp
comma
id|MCOR1
)paren
op_amp
l_int|0xf0
)paren
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|MSVR2
comma
l_int|0
)paren
suffix:semicolon
id|portp-&gt;stats.rxrtsoff
op_increment
suffix:semicolon
)brace
)brace
id|BRDDISABLE
c_func
(paren
id|portp-&gt;brdnr
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Send a flow control character...&n; */
DECL|function|stl_cd1400sendflow
r_static
r_void
id|stl_cd1400sendflow
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|state
)paren
(brace
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_cd1400sendflow(portp=%x,state=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|portp
comma
id|state
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|tty
op_assign
id|portp-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
id|tty
op_eq
(paren
r_struct
id|tty_struct
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|BRDENABLE
c_func
(paren
id|portp-&gt;brdnr
comma
id|portp-&gt;pagenr
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|CAR
comma
(paren
id|portp-&gt;portnr
op_amp
l_int|0x03
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
)paren
(brace
id|stl_cd1400ccrwait
c_func
(paren
id|portp
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|CCR
comma
id|CCR_SENDSCHR1
)paren
suffix:semicolon
id|portp-&gt;stats.rxxon
op_increment
suffix:semicolon
id|stl_cd1400ccrwait
c_func
(paren
id|portp
)paren
suffix:semicolon
)brace
r_else
(brace
id|stl_cd1400ccrwait
c_func
(paren
id|portp
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|CCR
comma
id|CCR_SENDSCHR2
)paren
suffix:semicolon
id|portp-&gt;stats.rxxoff
op_increment
suffix:semicolon
id|stl_cd1400ccrwait
c_func
(paren
id|portp
)paren
suffix:semicolon
)brace
id|BRDDISABLE
c_func
(paren
id|portp-&gt;brdnr
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|stl_cd1400flush
r_static
r_void
id|stl_cd1400flush
c_func
(paren
id|stlport_t
op_star
id|portp
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_cd1400flush(portp=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|portp
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|BRDENABLE
c_func
(paren
id|portp-&gt;brdnr
comma
id|portp-&gt;pagenr
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|CAR
comma
(paren
id|portp-&gt;portnr
op_amp
l_int|0x03
)paren
)paren
suffix:semicolon
id|stl_cd1400ccrwait
c_func
(paren
id|portp
)paren
suffix:semicolon
id|stl_cd1400setreg
c_func
(paren
id|portp
comma
id|CCR
comma
id|CCR_TXFLUSHFIFO
)paren
suffix:semicolon
id|stl_cd1400ccrwait
c_func
(paren
id|portp
)paren
suffix:semicolon
id|portp-&gt;tx.tail
op_assign
id|portp-&gt;tx.head
suffix:semicolon
id|BRDDISABLE
c_func
(paren
id|portp-&gt;brdnr
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Return the current state of data flow on this port. This is only&n; *&t;really interresting when determining if data has fully completed&n; *&t;transmission or not... This is easy for the cd1400, it accurately&n; *&t;maintains the busy port flag.&n; */
DECL|function|stl_cd1400datastate
r_static
r_int
id|stl_cd1400datastate
c_func
(paren
id|stlport_t
op_star
id|portp
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_cd1400datastate(portp=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|portp
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
r_return
id|test_bit
c_func
(paren
id|ASYI_TXBUSY
comma
op_amp
id|portp-&gt;istate
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Interrupt service routine for cd1400 EasyIO boards.&n; */
DECL|function|stl_cd1400eiointr
r_static
r_void
id|stl_cd1400eiointr
c_func
(paren
id|stlpanel_t
op_star
id|panelp
comma
r_int
r_int
id|iobase
)paren
(brace
r_int
r_char
id|svrtype
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_cd1400eiointr(panelp=%x,iobase=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|panelp
comma
id|iobase
)paren
suffix:semicolon
macro_line|#endif
id|outb
c_func
(paren
id|SVRR
comma
id|iobase
)paren
suffix:semicolon
id|svrtype
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|EREG_DATA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|panelp-&gt;nrports
OG
l_int|4
)paren
(brace
id|outb
c_func
(paren
(paren
id|SVRR
op_plus
l_int|0x80
)paren
comma
id|iobase
)paren
suffix:semicolon
id|svrtype
op_or_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|EREG_DATA
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|svrtype
op_amp
id|SVRR_RX
)paren
id|stl_cd1400rxisr
c_func
(paren
id|panelp
comma
id|iobase
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|svrtype
op_amp
id|SVRR_TX
)paren
id|stl_cd1400txisr
c_func
(paren
id|panelp
comma
id|iobase
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|svrtype
op_amp
id|SVRR_MDM
)paren
id|stl_cd1400mdmisr
c_func
(paren
id|panelp
comma
id|iobase
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Interrupt service routine for cd1400 panels.&n; */
DECL|function|stl_cd1400echintr
r_static
r_void
id|stl_cd1400echintr
c_func
(paren
id|stlpanel_t
op_star
id|panelp
comma
r_int
r_int
id|iobase
)paren
(brace
r_int
r_char
id|svrtype
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_cd1400echintr(panelp=%x,iobase=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|panelp
comma
id|iobase
)paren
suffix:semicolon
macro_line|#endif
id|outb
c_func
(paren
id|SVRR
comma
id|iobase
)paren
suffix:semicolon
id|svrtype
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|EREG_DATA
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|SVRR
op_plus
l_int|0x80
)paren
comma
id|iobase
)paren
suffix:semicolon
id|svrtype
op_or_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|EREG_DATA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|svrtype
op_amp
id|SVRR_RX
)paren
id|stl_cd1400rxisr
c_func
(paren
id|panelp
comma
id|iobase
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|svrtype
op_amp
id|SVRR_TX
)paren
id|stl_cd1400txisr
c_func
(paren
id|panelp
comma
id|iobase
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|svrtype
op_amp
id|SVRR_MDM
)paren
id|stl_cd1400mdmisr
c_func
(paren
id|panelp
comma
id|iobase
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Unfortunately we need to handle breaks in the TX data stream, since&n; *&t;this is the only way to generate them on the cd1400.&n; */
DECL|function|stl_cd1400breakisr
r_static
r_inline
r_int
id|stl_cd1400breakisr
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|ioaddr
)paren
(brace
r_if
c_cond
(paren
id|portp-&gt;brklen
op_eq
l_int|1
)paren
(brace
id|outb
c_func
(paren
(paren
id|COR2
op_plus
id|portp-&gt;uartaddr
)paren
comma
id|ioaddr
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|EREG_DATA
)paren
op_or
id|COR2_ETC
)paren
comma
(paren
id|ioaddr
op_plus
id|EREG_DATA
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|TDR
op_plus
id|portp-&gt;uartaddr
)paren
comma
id|ioaddr
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ETC_CMD
comma
(paren
id|ioaddr
op_plus
id|EREG_DATA
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ETC_STARTBREAK
comma
(paren
id|ioaddr
op_plus
id|EREG_DATA
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|SRER
op_plus
id|portp-&gt;uartaddr
)paren
comma
id|ioaddr
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|EREG_DATA
)paren
op_amp
op_complement
(paren
id|SRER_TXDATA
op_or
id|SRER_TXEMPTY
)paren
)paren
comma
(paren
id|ioaddr
op_plus
id|EREG_DATA
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|portp-&gt;brklen
OG
l_int|1
)paren
(brace
id|outb
c_func
(paren
(paren
id|TDR
op_plus
id|portp-&gt;uartaddr
)paren
comma
id|ioaddr
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ETC_CMD
comma
(paren
id|ioaddr
op_plus
id|EREG_DATA
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ETC_STOPBREAK
comma
(paren
id|ioaddr
op_plus
id|EREG_DATA
)paren
)paren
suffix:semicolon
id|portp-&gt;brklen
op_assign
op_minus
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|outb
c_func
(paren
(paren
id|COR2
op_plus
id|portp-&gt;uartaddr
)paren
comma
id|ioaddr
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|EREG_DATA
)paren
op_amp
op_complement
id|COR2_ETC
)paren
comma
(paren
id|ioaddr
op_plus
id|EREG_DATA
)paren
)paren
suffix:semicolon
id|portp-&gt;brklen
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Transmit interrupt handler. This has gotta be fast!  Handling TX&n; *&t;chars is pretty simple, stuff as many as possible from the TX buffer&n; *&t;into the cd1400 FIFO. Must also handle TX breaks here, since they&n; *&t;are embedded as commands in the data stream. Oh no, had to use a goto!&n; *&t;This could be optimized more, will do when I get time...&n; *&t;In practice it is possible that interrupts are enabled but that the&n; *&t;port has been hung up. Need to handle not having any TX buffer here,&n; *&t;this is done by using the side effect that head and tail will also&n; *&t;be NULL if the buffer has been freed.&n; */
DECL|function|stl_cd1400txisr
r_static
r_void
id|stl_cd1400txisr
c_func
(paren
id|stlpanel_t
op_star
id|panelp
comma
r_int
id|ioaddr
)paren
(brace
id|stlport_t
op_star
id|portp
suffix:semicolon
r_int
id|len
comma
id|stlen
suffix:semicolon
r_char
op_star
id|head
comma
op_star
id|tail
suffix:semicolon
r_int
r_char
id|ioack
comma
id|srer
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_cd1400txisr(panelp=%x,ioaddr=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|panelp
comma
id|ioaddr
)paren
suffix:semicolon
macro_line|#endif
id|ioack
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|EREG_TXACK
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|ioack
op_amp
id|panelp-&gt;ackmask
)paren
op_ne
l_int|0
)paren
op_logical_or
(paren
(paren
id|ioack
op_amp
id|ACK_TYPMASK
)paren
op_ne
id|ACK_TYPTX
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;STALLION: bad TX interrupt ack value=%x&bslash;n&quot;
comma
id|ioack
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|portp
op_assign
id|panelp-&gt;ports
(braket
(paren
id|ioack
op_rshift
l_int|3
)paren
)braket
suffix:semicolon
multiline_comment|/*&n; *&t;Unfortunately we need to handle breaks in the data stream, since&n; *&t;this is the only way to generate them on the cd1400. Do it now if&n; *&t;a break is to be sent.&n; */
r_if
c_cond
(paren
id|portp-&gt;brklen
op_ne
l_int|0
)paren
r_if
c_cond
(paren
id|stl_cd1400breakisr
c_func
(paren
id|portp
comma
id|ioaddr
)paren
)paren
r_goto
id|stl_txalldone
suffix:semicolon
id|head
op_assign
id|portp-&gt;tx.head
suffix:semicolon
id|tail
op_assign
id|portp-&gt;tx.tail
suffix:semicolon
id|len
op_assign
(paren
id|head
op_ge
id|tail
)paren
ques
c_cond
(paren
id|head
op_minus
id|tail
)paren
suffix:colon
(paren
id|STL_TXBUFSIZE
op_minus
(paren
id|tail
op_minus
id|head
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
op_eq
l_int|0
)paren
op_logical_or
(paren
(paren
id|len
OL
id|STL_TXBUFLOW
)paren
op_logical_and
(paren
id|test_bit
c_func
(paren
id|ASYI_TXLOW
comma
op_amp
id|portp-&gt;istate
)paren
op_eq
l_int|0
)paren
)paren
)paren
(brace
id|set_bit
c_func
(paren
id|ASYI_TXLOW
comma
op_amp
id|portp-&gt;istate
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
id|schedule_task
c_func
(paren
op_amp
id|portp-&gt;tqueue
)paren
op_eq
l_int|0
)paren
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
op_eq
l_int|0
)paren
(brace
id|outb
c_func
(paren
(paren
id|SRER
op_plus
id|portp-&gt;uartaddr
)paren
comma
id|ioaddr
)paren
suffix:semicolon
id|srer
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|EREG_DATA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srer
op_amp
id|SRER_TXDATA
)paren
(brace
id|srer
op_assign
(paren
id|srer
op_amp
op_complement
id|SRER_TXDATA
)paren
op_or
id|SRER_TXEMPTY
suffix:semicolon
)brace
r_else
(brace
id|srer
op_and_assign
op_complement
(paren
id|SRER_TXDATA
op_or
id|SRER_TXEMPTY
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|ASYI_TXBUSY
comma
op_amp
id|portp-&gt;istate
)paren
suffix:semicolon
)brace
id|outb
c_func
(paren
id|srer
comma
(paren
id|ioaddr
op_plus
id|EREG_DATA
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|len
op_assign
id|MIN
c_func
(paren
id|len
comma
id|CD1400_TXFIFOSIZE
)paren
suffix:semicolon
id|portp-&gt;stats.txtotal
op_add_assign
id|len
suffix:semicolon
id|stlen
op_assign
id|MIN
c_func
(paren
id|len
comma
(paren
(paren
id|portp-&gt;tx.buf
op_plus
id|STL_TXBUFSIZE
)paren
op_minus
id|tail
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|TDR
op_plus
id|portp-&gt;uartaddr
)paren
comma
id|ioaddr
)paren
suffix:semicolon
id|outsb
c_func
(paren
(paren
id|ioaddr
op_plus
id|EREG_DATA
)paren
comma
id|tail
comma
id|stlen
)paren
suffix:semicolon
id|len
op_sub_assign
id|stlen
suffix:semicolon
id|tail
op_add_assign
id|stlen
suffix:semicolon
r_if
c_cond
(paren
id|tail
op_ge
(paren
id|portp-&gt;tx.buf
op_plus
id|STL_TXBUFSIZE
)paren
)paren
id|tail
op_assign
id|portp-&gt;tx.buf
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
id|outsb
c_func
(paren
(paren
id|ioaddr
op_plus
id|EREG_DATA
)paren
comma
id|tail
comma
id|len
)paren
suffix:semicolon
id|tail
op_add_assign
id|len
suffix:semicolon
)brace
id|portp-&gt;tx.tail
op_assign
id|tail
suffix:semicolon
)brace
id|stl_txalldone
suffix:colon
id|outb
c_func
(paren
(paren
id|EOSRR
op_plus
id|portp-&gt;uartaddr
)paren
comma
id|ioaddr
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
(paren
id|ioaddr
op_plus
id|EREG_DATA
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Receive character interrupt handler. Determine if we have good chars&n; *&t;or bad chars and then process appropriately. Good chars are easy&n; *&t;just shove the lot into the RX buffer and set all status byte to 0.&n; *&t;If a bad RX char then process as required. This routine needs to be&n; *&t;fast!  In practice it is possible that we get an interrupt on a port&n; *&t;that is closed. This can happen on hangups - since they completely&n; *&t;shutdown a port not in user context. Need to handle this case.&n; */
DECL|function|stl_cd1400rxisr
r_static
r_void
id|stl_cd1400rxisr
c_func
(paren
id|stlpanel_t
op_star
id|panelp
comma
r_int
id|ioaddr
)paren
(brace
id|stlport_t
op_star
id|portp
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
r_int
id|ioack
comma
id|len
comma
id|buflen
suffix:semicolon
r_int
r_char
id|status
suffix:semicolon
r_char
id|ch
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_cd1400rxisr(panelp=%x,ioaddr=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|panelp
comma
id|ioaddr
)paren
suffix:semicolon
macro_line|#endif
id|ioack
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|EREG_RXACK
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ioack
op_amp
id|panelp-&gt;ackmask
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;STALLION: bad RX interrupt ack value=%x&bslash;n&quot;
comma
id|ioack
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|portp
op_assign
id|panelp-&gt;ports
(braket
(paren
id|ioack
op_rshift
l_int|3
)paren
)braket
suffix:semicolon
id|tty
op_assign
id|portp-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ioack
op_amp
id|ACK_TYPMASK
)paren
op_eq
id|ACK_TYPRXGOOD
)paren
(brace
id|outb
c_func
(paren
(paren
id|RDCR
op_plus
id|portp-&gt;uartaddr
)paren
comma
id|ioaddr
)paren
suffix:semicolon
id|len
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|EREG_DATA
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tty
op_eq
(paren
r_struct
id|tty_struct
op_star
)paren
l_int|NULL
)paren
op_logical_or
(paren
id|tty-&gt;flip.char_buf_ptr
op_eq
(paren
r_char
op_star
)paren
l_int|NULL
)paren
op_logical_or
(paren
(paren
id|buflen
op_assign
id|TTY_FLIPBUF_SIZE
op_minus
id|tty-&gt;flip.count
)paren
op_eq
l_int|0
)paren
)paren
(brace
id|len
op_assign
id|MIN
c_func
(paren
id|len
comma
r_sizeof
(paren
id|stl_unwanted
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|RDSR
op_plus
id|portp-&gt;uartaddr
)paren
comma
id|ioaddr
)paren
suffix:semicolon
id|insb
c_func
(paren
(paren
id|ioaddr
op_plus
id|EREG_DATA
)paren
comma
op_amp
id|stl_unwanted
(braket
l_int|0
)braket
comma
id|len
)paren
suffix:semicolon
id|portp-&gt;stats.rxlost
op_add_assign
id|len
suffix:semicolon
id|portp-&gt;stats.rxtotal
op_add_assign
id|len
suffix:semicolon
)brace
r_else
(brace
id|len
op_assign
id|MIN
c_func
(paren
id|len
comma
id|buflen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
id|outb
c_func
(paren
(paren
id|RDSR
op_plus
id|portp-&gt;uartaddr
)paren
comma
id|ioaddr
)paren
suffix:semicolon
id|insb
c_func
(paren
(paren
id|ioaddr
op_plus
id|EREG_DATA
)paren
comma
id|tty-&gt;flip.char_buf_ptr
comma
id|len
)paren
suffix:semicolon
id|memset
c_func
(paren
id|tty-&gt;flip.flag_buf_ptr
comma
l_int|0
comma
id|len
)paren
suffix:semicolon
id|tty-&gt;flip.flag_buf_ptr
op_add_assign
id|len
suffix:semicolon
id|tty-&gt;flip.char_buf_ptr
op_add_assign
id|len
suffix:semicolon
id|tty-&gt;flip.count
op_add_assign
id|len
suffix:semicolon
id|tty_schedule_flip
c_func
(paren
id|tty
)paren
suffix:semicolon
id|portp-&gt;stats.rxtotal
op_add_assign
id|len
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|ioack
op_amp
id|ACK_TYPMASK
)paren
op_eq
id|ACK_TYPRXBAD
)paren
(brace
id|outb
c_func
(paren
(paren
id|RDSR
op_plus
id|portp-&gt;uartaddr
)paren
comma
id|ioaddr
)paren
suffix:semicolon
id|status
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|EREG_DATA
)paren
suffix:semicolon
id|ch
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|EREG_DATA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|ST_PARITY
)paren
id|portp-&gt;stats.rxparity
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|ST_FRAMING
)paren
id|portp-&gt;stats.rxframing
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|ST_OVERRUN
)paren
id|portp-&gt;stats.rxoverrun
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|ST_BREAK
)paren
id|portp-&gt;stats.rxbreaks
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|ST_SCHARMASK
)paren
(brace
r_if
c_cond
(paren
(paren
id|status
op_amp
id|ST_SCHARMASK
)paren
op_eq
id|ST_SCHAR1
)paren
id|portp-&gt;stats.txxon
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|ST_SCHARMASK
)paren
op_eq
id|ST_SCHAR2
)paren
id|portp-&gt;stats.txxoff
op_increment
suffix:semicolon
r_goto
id|stl_rxalldone
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|tty
op_ne
(paren
r_struct
id|tty_struct
op_star
)paren
l_int|NULL
)paren
op_logical_and
(paren
(paren
id|portp-&gt;rxignoremsk
op_amp
id|status
)paren
op_eq
l_int|0
)paren
)paren
(brace
r_if
c_cond
(paren
id|portp-&gt;rxmarkmsk
op_amp
id|status
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|ST_BREAK
)paren
(brace
id|status
op_assign
id|TTY_BREAK
suffix:semicolon
r_if
c_cond
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_SAK
)paren
(brace
id|do_SAK
c_func
(paren
id|tty
)paren
suffix:semicolon
id|BRDENABLE
c_func
(paren
id|portp-&gt;brdnr
comma
id|portp-&gt;pagenr
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
id|ST_PARITY
)paren
(brace
id|status
op_assign
id|TTY_PARITY
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
id|ST_FRAMING
)paren
(brace
id|status
op_assign
id|TTY_FRAME
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
id|ST_OVERRUN
)paren
(brace
id|status
op_assign
id|TTY_OVERRUN
suffix:semicolon
)brace
r_else
(brace
id|status
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
id|status
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tty-&gt;flip.char_buf_ptr
op_ne
(paren
r_char
op_star
)paren
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|tty-&gt;flip.count
OL
id|TTY_FLIPBUF_SIZE
)paren
(brace
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|status
suffix:semicolon
op_star
id|tty-&gt;flip.char_buf_ptr
op_increment
op_assign
id|ch
suffix:semicolon
id|tty-&gt;flip.count
op_increment
suffix:semicolon
)brace
id|tty_schedule_flip
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;STALLION: bad RX interrupt ack value=%x&bslash;n&quot;
comma
id|ioack
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|stl_rxalldone
suffix:colon
id|outb
c_func
(paren
(paren
id|EOSRR
op_plus
id|portp-&gt;uartaddr
)paren
comma
id|ioaddr
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
(paren
id|ioaddr
op_plus
id|EREG_DATA
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Modem interrupt handler. The is called when the modem signal line&n; *&t;(DCD) has changed state. Leave most of the work to the off-level&n; *&t;processing routine.&n; */
DECL|function|stl_cd1400mdmisr
r_static
r_void
id|stl_cd1400mdmisr
c_func
(paren
id|stlpanel_t
op_star
id|panelp
comma
r_int
id|ioaddr
)paren
(brace
id|stlport_t
op_star
id|portp
suffix:semicolon
r_int
r_int
id|ioack
suffix:semicolon
r_int
r_char
id|misr
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_cd1400mdmisr(panelp=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|panelp
)paren
suffix:semicolon
macro_line|#endif
id|ioack
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|EREG_MDACK
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|ioack
op_amp
id|panelp-&gt;ackmask
)paren
op_ne
l_int|0
)paren
op_logical_or
(paren
(paren
id|ioack
op_amp
id|ACK_TYPMASK
)paren
op_ne
id|ACK_TYPMDM
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;STALLION: bad MODEM interrupt ack value=%x&bslash;n&quot;
comma
id|ioack
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|portp
op_assign
id|panelp-&gt;ports
(braket
(paren
id|ioack
op_rshift
l_int|3
)paren
)braket
suffix:semicolon
id|outb
c_func
(paren
(paren
id|MISR
op_plus
id|portp-&gt;uartaddr
)paren
comma
id|ioaddr
)paren
suffix:semicolon
id|misr
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|EREG_DATA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|misr
op_amp
id|MISR_DCD
)paren
(brace
id|set_bit
c_func
(paren
id|ASYI_DCDCHANGE
comma
op_amp
id|portp-&gt;istate
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
id|schedule_task
c_func
(paren
op_amp
id|portp-&gt;tqueue
)paren
op_eq
l_int|0
)paren
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|portp-&gt;stats.modem
op_increment
suffix:semicolon
)brace
id|outb
c_func
(paren
(paren
id|EOSRR
op_plus
id|portp-&gt;uartaddr
)paren
comma
id|ioaddr
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
(paren
id|ioaddr
op_plus
id|EREG_DATA
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*                      SC26198 HARDWARE FUNCTIONS                           */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;These functions get/set/update the registers of the sc26198 UARTs.&n; *&t;Access to the sc26198 registers is via an address/data io port pair.&n; *&t;(Maybe should make this inline...)&n; */
DECL|function|stl_sc26198getreg
r_static
r_int
id|stl_sc26198getreg
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|regnr
)paren
(brace
id|outb
c_func
(paren
(paren
id|regnr
op_or
id|portp-&gt;uartaddr
)paren
comma
(paren
id|portp-&gt;ioaddr
op_plus
id|XP_ADDR
)paren
)paren
suffix:semicolon
r_return
id|inb
c_func
(paren
id|portp-&gt;ioaddr
op_plus
id|XP_DATA
)paren
suffix:semicolon
)brace
DECL|function|stl_sc26198setreg
r_static
r_void
id|stl_sc26198setreg
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|regnr
comma
r_int
id|value
)paren
(brace
id|outb
c_func
(paren
(paren
id|regnr
op_or
id|portp-&gt;uartaddr
)paren
comma
(paren
id|portp-&gt;ioaddr
op_plus
id|XP_ADDR
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|value
comma
(paren
id|portp-&gt;ioaddr
op_plus
id|XP_DATA
)paren
)paren
suffix:semicolon
)brace
DECL|function|stl_sc26198updatereg
r_static
r_int
id|stl_sc26198updatereg
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|regnr
comma
r_int
id|value
)paren
(brace
id|outb
c_func
(paren
(paren
id|regnr
op_or
id|portp-&gt;uartaddr
)paren
comma
(paren
id|portp-&gt;ioaddr
op_plus
id|XP_ADDR
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|portp-&gt;ioaddr
op_plus
id|XP_DATA
)paren
op_ne
id|value
)paren
(brace
id|outb
c_func
(paren
id|value
comma
(paren
id|portp-&gt;ioaddr
op_plus
id|XP_DATA
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Functions to get and set the sc26198 global registers.&n; */
DECL|function|stl_sc26198getglobreg
r_static
r_int
id|stl_sc26198getglobreg
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|regnr
)paren
(brace
id|outb
c_func
(paren
id|regnr
comma
(paren
id|portp-&gt;ioaddr
op_plus
id|XP_ADDR
)paren
)paren
suffix:semicolon
r_return
id|inb
c_func
(paren
id|portp-&gt;ioaddr
op_plus
id|XP_DATA
)paren
suffix:semicolon
)brace
macro_line|#if 0
r_static
r_void
id|stl_sc26198setglobreg
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|regnr
comma
r_int
id|value
)paren
(brace
id|outb
c_func
(paren
id|regnr
comma
(paren
id|portp-&gt;ioaddr
op_plus
id|XP_ADDR
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|value
comma
(paren
id|portp-&gt;ioaddr
op_plus
id|XP_DATA
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Inbitialize the UARTs in a panel. We don&squot;t care what sort of board&n; *&t;these ports are on - since the port io registers are almost&n; *&t;identical when dealing with ports.&n; */
DECL|function|stl_sc26198panelinit
r_static
r_int
id|stl_sc26198panelinit
c_func
(paren
id|stlbrd_t
op_star
id|brdp
comma
id|stlpanel_t
op_star
id|panelp
)paren
(brace
r_int
id|chipmask
comma
id|i
suffix:semicolon
r_int
id|nrchips
comma
id|ioaddr
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_sc26198panelinit(brdp=%x,panelp=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|brdp
comma
(paren
r_int
)paren
id|panelp
)paren
suffix:semicolon
macro_line|#endif
id|BRDENABLE
c_func
(paren
id|panelp-&gt;brdnr
comma
id|panelp-&gt;pagenr
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;Check that each chip is present and started up OK.&n; */
id|chipmask
op_assign
l_int|0
suffix:semicolon
id|nrchips
op_assign
(paren
id|panelp-&gt;nrports
op_plus
l_int|4
)paren
op_div
id|SC26198_PORTS
suffix:semicolon
r_if
c_cond
(paren
id|brdp-&gt;brdtype
op_eq
id|BRD_ECHPCI
)paren
id|outb
c_func
(paren
id|panelp-&gt;pagenr
comma
id|brdp-&gt;ioctrl
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|nrchips
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ioaddr
op_assign
id|panelp-&gt;iobase
op_plus
(paren
id|i
op_star
l_int|4
)paren
suffix:semicolon
id|outb
c_func
(paren
id|SCCR
comma
(paren
id|ioaddr
op_plus
id|XP_ADDR
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CR_RESETALL
comma
(paren
id|ioaddr
op_plus
id|XP_DATA
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|TSTR
comma
(paren
id|ioaddr
op_plus
id|XP_ADDR
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
id|XP_DATA
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;STALLION: sc26198 not responding, &quot;
l_string|&quot;brd=%d panel=%d chip=%d&bslash;n&quot;
comma
id|panelp-&gt;brdnr
comma
id|panelp-&gt;panelnr
comma
id|i
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|chipmask
op_or_assign
(paren
l_int|0x1
op_lshift
id|i
)paren
suffix:semicolon
id|outb
c_func
(paren
id|GCCR
comma
(paren
id|ioaddr
op_plus
id|XP_ADDR
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|GCCR_IVRTYPCHANACK
comma
(paren
id|ioaddr
op_plus
id|XP_DATA
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|WDTRCR
comma
(paren
id|ioaddr
op_plus
id|XP_ADDR
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xff
comma
(paren
id|ioaddr
op_plus
id|XP_DATA
)paren
)paren
suffix:semicolon
)brace
id|BRDDISABLE
c_func
(paren
id|panelp-&gt;brdnr
)paren
suffix:semicolon
r_return
id|chipmask
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Initialize hardware specific port registers.&n; */
DECL|function|stl_sc26198portinit
r_static
r_void
id|stl_sc26198portinit
c_func
(paren
id|stlbrd_t
op_star
id|brdp
comma
id|stlpanel_t
op_star
id|panelp
comma
id|stlport_t
op_star
id|portp
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_sc26198portinit(brdp=%x,panelp=%x,portp=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|brdp
comma
(paren
r_int
)paren
id|panelp
comma
(paren
r_int
)paren
id|portp
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|brdp
op_eq
(paren
id|stlbrd_t
op_star
)paren
l_int|NULL
)paren
op_logical_or
(paren
id|panelp
op_eq
(paren
id|stlpanel_t
op_star
)paren
l_int|NULL
)paren
op_logical_or
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
)paren
r_return
suffix:semicolon
id|portp-&gt;ioaddr
op_assign
id|panelp-&gt;iobase
op_plus
(paren
(paren
id|portp-&gt;portnr
OL
l_int|8
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|4
)paren
suffix:semicolon
id|portp-&gt;uartaddr
op_assign
(paren
id|portp-&gt;portnr
op_amp
l_int|0x07
)paren
op_lshift
l_int|4
suffix:semicolon
id|portp-&gt;pagenr
op_assign
id|panelp-&gt;pagenr
suffix:semicolon
id|portp-&gt;hwid
op_assign
l_int|0x1
suffix:semicolon
id|BRDENABLE
c_func
(paren
id|portp-&gt;brdnr
comma
id|portp-&gt;pagenr
)paren
suffix:semicolon
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|IOPCR
comma
id|IOPCR_SETSIGS
)paren
suffix:semicolon
id|BRDDISABLE
c_func
(paren
id|portp-&gt;brdnr
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Set up the sc26198 registers for a port based on the termios port&n; *&t;settings.&n; */
DECL|function|stl_sc26198setport
r_static
r_void
id|stl_sc26198setport
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_struct
id|termios
op_star
id|tiosp
)paren
(brace
id|stlbrd_t
op_star
id|brdp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|baudrate
suffix:semicolon
r_int
r_char
id|mr0
comma
id|mr1
comma
id|mr2
comma
id|clk
suffix:semicolon
r_int
r_char
id|imron
comma
id|imroff
comma
id|iopr
comma
id|ipr
suffix:semicolon
id|mr0
op_assign
l_int|0
suffix:semicolon
id|mr1
op_assign
l_int|0
suffix:semicolon
id|mr2
op_assign
l_int|0
suffix:semicolon
id|clk
op_assign
l_int|0
suffix:semicolon
id|iopr
op_assign
l_int|0
suffix:semicolon
id|imron
op_assign
l_int|0
suffix:semicolon
id|imroff
op_assign
l_int|0
suffix:semicolon
id|brdp
op_assign
id|stl_brds
(braket
id|portp-&gt;brdnr
)braket
suffix:semicolon
r_if
c_cond
(paren
id|brdp
op_eq
(paren
id|stlbrd_t
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
multiline_comment|/*&n; *&t;Set up the RX char ignore mask with those RX error types we&n; *&t;can ignore.&n; */
id|portp-&gt;rxignoremsk
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tiosp-&gt;c_iflag
op_amp
id|IGNPAR
)paren
id|portp-&gt;rxignoremsk
op_or_assign
(paren
id|SR_RXPARITY
op_or
id|SR_RXFRAMING
op_or
id|SR_RXOVERRUN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tiosp-&gt;c_iflag
op_amp
id|IGNBRK
)paren
id|portp-&gt;rxignoremsk
op_or_assign
id|SR_RXBREAK
suffix:semicolon
id|portp-&gt;rxmarkmsk
op_assign
id|SR_RXOVERRUN
suffix:semicolon
r_if
c_cond
(paren
id|tiosp-&gt;c_iflag
op_amp
(paren
id|INPCK
op_or
id|PARMRK
)paren
)paren
id|portp-&gt;rxmarkmsk
op_or_assign
(paren
id|SR_RXPARITY
op_or
id|SR_RXFRAMING
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tiosp-&gt;c_iflag
op_amp
id|BRKINT
)paren
id|portp-&gt;rxmarkmsk
op_or_assign
id|SR_RXBREAK
suffix:semicolon
multiline_comment|/*&n; *&t;Go through the char size, parity and stop bits and set all the&n; *&t;option register appropriately.&n; */
r_switch
c_cond
(paren
id|tiosp-&gt;c_cflag
op_amp
id|CSIZE
)paren
(brace
r_case
id|CS5
suffix:colon
id|mr1
op_or_assign
id|MR1_CS5
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS6
suffix:colon
id|mr1
op_or_assign
id|MR1_CS6
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS7
suffix:colon
id|mr1
op_or_assign
id|MR1_CS7
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|mr1
op_or_assign
id|MR1_CS8
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tiosp-&gt;c_cflag
op_amp
id|CSTOPB
)paren
id|mr2
op_or_assign
id|MR2_STOP2
suffix:semicolon
r_else
id|mr2
op_or_assign
id|MR2_STOP1
suffix:semicolon
r_if
c_cond
(paren
id|tiosp-&gt;c_cflag
op_amp
id|PARENB
)paren
(brace
r_if
c_cond
(paren
id|tiosp-&gt;c_cflag
op_amp
id|PARODD
)paren
id|mr1
op_or_assign
(paren
id|MR1_PARENB
op_or
id|MR1_PARODD
)paren
suffix:semicolon
r_else
id|mr1
op_or_assign
(paren
id|MR1_PARENB
op_or
id|MR1_PAREVEN
)paren
suffix:semicolon
)brace
r_else
(brace
id|mr1
op_or_assign
id|MR1_PARNONE
suffix:semicolon
)brace
id|mr1
op_or_assign
id|MR1_ERRBLOCK
suffix:semicolon
multiline_comment|/*&n; *&t;Set the RX FIFO threshold at 8 chars. This gives a bit of breathing&n; *&t;space for hardware flow control and the like. This should be set to&n; *&t;VMIN.&n; */
id|mr2
op_or_assign
id|MR2_RXFIFOHALF
suffix:semicolon
multiline_comment|/*&n; *&t;Calculate the baud rate timers. For now we will just assume that&n; *&t;the input and output baud are the same. The sc26198 has a fixed&n; *&t;baud rate table, so only discrete baud rates possible.&n; */
id|baudrate
op_assign
id|tiosp-&gt;c_cflag
op_amp
id|CBAUD
suffix:semicolon
r_if
c_cond
(paren
id|baudrate
op_amp
id|CBAUDEX
)paren
(brace
id|baudrate
op_and_assign
op_complement
id|CBAUDEX
suffix:semicolon
r_if
c_cond
(paren
(paren
id|baudrate
OL
l_int|1
)paren
op_logical_or
(paren
id|baudrate
OG
l_int|4
)paren
)paren
id|tiosp-&gt;c_cflag
op_and_assign
op_complement
id|CBAUDEX
suffix:semicolon
r_else
id|baudrate
op_add_assign
l_int|15
suffix:semicolon
)brace
id|baudrate
op_assign
id|stl_baudrates
(braket
id|baudrate
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tiosp-&gt;c_cflag
op_amp
id|CBAUD
)paren
op_eq
id|B38400
)paren
(brace
r_if
c_cond
(paren
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_SPD_MASK
)paren
op_eq
id|ASYNC_SPD_HI
)paren
id|baudrate
op_assign
l_int|57600
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_SPD_MASK
)paren
op_eq
id|ASYNC_SPD_VHI
)paren
id|baudrate
op_assign
l_int|115200
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_SPD_MASK
)paren
op_eq
id|ASYNC_SPD_SHI
)paren
id|baudrate
op_assign
l_int|230400
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_SPD_MASK
)paren
op_eq
id|ASYNC_SPD_WARP
)paren
id|baudrate
op_assign
l_int|460800
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_SPD_MASK
)paren
op_eq
id|ASYNC_SPD_CUST
)paren
id|baudrate
op_assign
(paren
id|portp-&gt;baud_base
op_div
id|portp-&gt;custom_divisor
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|baudrate
OG
id|STL_SC26198MAXBAUD
)paren
id|baudrate
op_assign
id|STL_SC26198MAXBAUD
suffix:semicolon
r_if
c_cond
(paren
id|baudrate
OG
l_int|0
)paren
(brace
r_for
c_loop
(paren
id|clk
op_assign
l_int|0
suffix:semicolon
(paren
id|clk
OL
id|SC26198_NRBAUDS
)paren
suffix:semicolon
id|clk
op_increment
)paren
(brace
r_if
c_cond
(paren
id|baudrate
op_le
id|sc26198_baudtable
(braket
id|clk
)braket
)paren
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;Check what form of modem signaling is required and set it up.&n; */
r_if
c_cond
(paren
id|tiosp-&gt;c_cflag
op_amp
id|CLOCAL
)paren
(brace
id|portp-&gt;flags
op_and_assign
op_complement
id|ASYNC_CHECK_CD
suffix:semicolon
)brace
r_else
(brace
id|iopr
op_or_assign
id|IOPR_DCDCOS
suffix:semicolon
id|imron
op_or_assign
id|IR_IOPORT
suffix:semicolon
id|portp-&gt;flags
op_or_assign
id|ASYNC_CHECK_CD
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Setup sc26198 enhanced modes if we can. In particular we want to&n; *&t;handle as much of the flow control as possible automatically. As&n; *&t;well as saving a few CPU cycles it will also greatly improve flow&n; *&t;control reliability.&n; */
r_if
c_cond
(paren
id|tiosp-&gt;c_iflag
op_amp
id|IXON
)paren
(brace
id|mr0
op_or_assign
id|MR0_SWFTX
op_or
id|MR0_SWFT
suffix:semicolon
id|imron
op_or_assign
id|IR_XONXOFF
suffix:semicolon
)brace
r_else
(brace
id|imroff
op_or_assign
id|IR_XONXOFF
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tiosp-&gt;c_iflag
op_amp
id|IXOFF
)paren
id|mr0
op_or_assign
id|MR0_SWFRX
suffix:semicolon
r_if
c_cond
(paren
id|tiosp-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
(brace
id|mr2
op_or_assign
id|MR2_AUTOCTS
suffix:semicolon
id|mr1
op_or_assign
id|MR1_AUTORTS
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;All sc26198 register values calculated so go through and set&n; *&t;them all up.&n; */
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;SETPORT: portnr=%d panelnr=%d brdnr=%d&bslash;n&quot;
comma
id|portp-&gt;portnr
comma
id|portp-&gt;panelnr
comma
id|portp-&gt;brdnr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;    mr0=%x mr1=%x mr2=%x clk=%x&bslash;n&quot;
comma
id|mr0
comma
id|mr1
comma
id|mr2
comma
id|clk
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;    iopr=%x imron=%x imroff=%x&bslash;n&quot;
comma
id|iopr
comma
id|imron
comma
id|imroff
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;    schr1=%x schr2=%x schr3=%x schr4=%x&bslash;n&quot;
comma
id|tiosp-&gt;c_cc
(braket
id|VSTART
)braket
comma
id|tiosp-&gt;c_cc
(braket
id|VSTOP
)braket
comma
id|tiosp-&gt;c_cc
(braket
id|VSTART
)braket
comma
id|tiosp-&gt;c_cc
(braket
id|VSTOP
)braket
)paren
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|BRDENABLE
c_func
(paren
id|portp-&gt;brdnr
comma
id|portp-&gt;pagenr
)paren
suffix:semicolon
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|IMR
comma
l_int|0
)paren
suffix:semicolon
id|stl_sc26198updatereg
c_func
(paren
id|portp
comma
id|MR0
comma
id|mr0
)paren
suffix:semicolon
id|stl_sc26198updatereg
c_func
(paren
id|portp
comma
id|MR1
comma
id|mr1
)paren
suffix:semicolon
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|SCCR
comma
id|CR_RXERRBLOCK
)paren
suffix:semicolon
id|stl_sc26198updatereg
c_func
(paren
id|portp
comma
id|MR2
comma
id|mr2
)paren
suffix:semicolon
id|stl_sc26198updatereg
c_func
(paren
id|portp
comma
id|IOPIOR
comma
(paren
(paren
id|stl_sc26198getreg
c_func
(paren
id|portp
comma
id|IOPIOR
)paren
op_amp
op_complement
id|IPR_CHANGEMASK
)paren
op_or
id|iopr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|baudrate
OG
l_int|0
)paren
(brace
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|TXCSR
comma
id|clk
)paren
suffix:semicolon
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|RXCSR
comma
id|clk
)paren
suffix:semicolon
)brace
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|XONCR
comma
id|tiosp-&gt;c_cc
(braket
id|VSTART
)braket
)paren
suffix:semicolon
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|XOFFCR
comma
id|tiosp-&gt;c_cc
(braket
id|VSTOP
)braket
)paren
suffix:semicolon
id|ipr
op_assign
id|stl_sc26198getreg
c_func
(paren
id|portp
comma
id|IPR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ipr
op_amp
id|IPR_DCD
)paren
id|portp-&gt;sigs
op_and_assign
op_complement
id|TIOCM_CD
suffix:semicolon
r_else
id|portp-&gt;sigs
op_or_assign
id|TIOCM_CD
suffix:semicolon
id|portp-&gt;imr
op_assign
(paren
id|portp-&gt;imr
op_amp
op_complement
id|imroff
)paren
op_or
id|imron
suffix:semicolon
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|IMR
comma
id|portp-&gt;imr
)paren
suffix:semicolon
id|BRDDISABLE
c_func
(paren
id|portp-&gt;brdnr
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Set the state of the DTR and RTS signals.&n; */
DECL|function|stl_sc26198setsignals
r_static
r_void
id|stl_sc26198setsignals
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|dtr
comma
r_int
id|rts
)paren
(brace
r_int
r_char
id|iopioron
comma
id|iopioroff
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_sc26198setsignals(portp=%x,dtr=%d,rts=%d)&bslash;n&quot;
comma
(paren
r_int
)paren
id|portp
comma
id|dtr
comma
id|rts
)paren
suffix:semicolon
macro_line|#endif
id|iopioron
op_assign
l_int|0
suffix:semicolon
id|iopioroff
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dtr
op_eq
l_int|0
)paren
id|iopioroff
op_or_assign
id|IPR_DTR
suffix:semicolon
r_else
r_if
c_cond
(paren
id|dtr
OG
l_int|0
)paren
id|iopioron
op_or_assign
id|IPR_DTR
suffix:semicolon
r_if
c_cond
(paren
id|rts
op_eq
l_int|0
)paren
id|iopioroff
op_or_assign
id|IPR_RTS
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rts
OG
l_int|0
)paren
id|iopioron
op_or_assign
id|IPR_RTS
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|BRDENABLE
c_func
(paren
id|portp-&gt;brdnr
comma
id|portp-&gt;pagenr
)paren
suffix:semicolon
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|IOPIOR
comma
(paren
(paren
id|stl_sc26198getreg
c_func
(paren
id|portp
comma
id|IOPIOR
)paren
op_amp
op_complement
id|iopioroff
)paren
op_or
id|iopioron
)paren
)paren
suffix:semicolon
id|BRDDISABLE
c_func
(paren
id|portp-&gt;brdnr
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Return the state of the signals.&n; */
DECL|function|stl_sc26198getsignals
r_static
r_int
id|stl_sc26198getsignals
c_func
(paren
id|stlport_t
op_star
id|portp
)paren
(brace
r_int
r_char
id|ipr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|sigs
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_sc26198getsignals(portp=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|portp
)paren
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|BRDENABLE
c_func
(paren
id|portp-&gt;brdnr
comma
id|portp-&gt;pagenr
)paren
suffix:semicolon
id|ipr
op_assign
id|stl_sc26198getreg
c_func
(paren
id|portp
comma
id|IPR
)paren
suffix:semicolon
id|BRDDISABLE
c_func
(paren
id|portp-&gt;brdnr
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|sigs
op_assign
l_int|0
suffix:semicolon
id|sigs
op_or_assign
(paren
id|ipr
op_amp
id|IPR_DCD
)paren
ques
c_cond
l_int|0
suffix:colon
id|TIOCM_CD
suffix:semicolon
id|sigs
op_or_assign
(paren
id|ipr
op_amp
id|IPR_CTS
)paren
ques
c_cond
l_int|0
suffix:colon
id|TIOCM_CTS
suffix:semicolon
id|sigs
op_or_assign
(paren
id|ipr
op_amp
id|IPR_DTR
)paren
ques
c_cond
l_int|0
suffix:colon
id|TIOCM_DTR
suffix:semicolon
id|sigs
op_or_assign
(paren
id|ipr
op_amp
id|IPR_RTS
)paren
ques
c_cond
l_int|0
suffix:colon
id|TIOCM_RTS
suffix:semicolon
id|sigs
op_or_assign
id|TIOCM_DSR
suffix:semicolon
r_return
id|sigs
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Enable/Disable the Transmitter and/or Receiver.&n; */
DECL|function|stl_sc26198enablerxtx
r_static
r_void
id|stl_sc26198enablerxtx
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|rx
comma
r_int
id|tx
)paren
(brace
r_int
r_char
id|ccr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_sc26198enablerxtx(portp=%x,rx=%d,tx=%d)&bslash;n&quot;
comma
(paren
r_int
)paren
id|portp
comma
id|rx
comma
id|tx
)paren
suffix:semicolon
macro_line|#endif
id|ccr
op_assign
id|portp-&gt;crenable
suffix:semicolon
r_if
c_cond
(paren
id|tx
op_eq
l_int|0
)paren
id|ccr
op_and_assign
op_complement
id|CR_TXENABLE
suffix:semicolon
r_else
r_if
c_cond
(paren
id|tx
OG
l_int|0
)paren
id|ccr
op_or_assign
id|CR_TXENABLE
suffix:semicolon
r_if
c_cond
(paren
id|rx
op_eq
l_int|0
)paren
id|ccr
op_and_assign
op_complement
id|CR_RXENABLE
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rx
OG
l_int|0
)paren
id|ccr
op_or_assign
id|CR_RXENABLE
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|BRDENABLE
c_func
(paren
id|portp-&gt;brdnr
comma
id|portp-&gt;pagenr
)paren
suffix:semicolon
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|SCCR
comma
id|ccr
)paren
suffix:semicolon
id|BRDDISABLE
c_func
(paren
id|portp-&gt;brdnr
)paren
suffix:semicolon
id|portp-&gt;crenable
op_assign
id|ccr
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Start/stop the Transmitter and/or Receiver.&n; */
DECL|function|stl_sc26198startrxtx
r_static
r_void
id|stl_sc26198startrxtx
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|rx
comma
r_int
id|tx
)paren
(brace
r_int
r_char
id|imr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_sc26198startrxtx(portp=%x,rx=%d,tx=%d)&bslash;n&quot;
comma
(paren
r_int
)paren
id|portp
comma
id|rx
comma
id|tx
)paren
suffix:semicolon
macro_line|#endif
id|imr
op_assign
id|portp-&gt;imr
suffix:semicolon
r_if
c_cond
(paren
id|tx
op_eq
l_int|0
)paren
id|imr
op_and_assign
op_complement
id|IR_TXRDY
suffix:semicolon
r_else
r_if
c_cond
(paren
id|tx
op_eq
l_int|1
)paren
id|imr
op_or_assign
id|IR_TXRDY
suffix:semicolon
r_if
c_cond
(paren
id|rx
op_eq
l_int|0
)paren
id|imr
op_and_assign
op_complement
(paren
id|IR_RXRDY
op_or
id|IR_RXBREAK
op_or
id|IR_RXWATCHDOG
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rx
OG
l_int|0
)paren
id|imr
op_or_assign
id|IR_RXRDY
op_or
id|IR_RXBREAK
op_or
id|IR_RXWATCHDOG
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|BRDENABLE
c_func
(paren
id|portp-&gt;brdnr
comma
id|portp-&gt;pagenr
)paren
suffix:semicolon
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|IMR
comma
id|imr
)paren
suffix:semicolon
id|BRDDISABLE
c_func
(paren
id|portp-&gt;brdnr
)paren
suffix:semicolon
id|portp-&gt;imr
op_assign
id|imr
suffix:semicolon
r_if
c_cond
(paren
id|tx
OG
l_int|0
)paren
id|set_bit
c_func
(paren
id|ASYI_TXBUSY
comma
op_amp
id|portp-&gt;istate
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Disable all interrupts from this port.&n; */
DECL|function|stl_sc26198disableintrs
r_static
r_void
id|stl_sc26198disableintrs
c_func
(paren
id|stlport_t
op_star
id|portp
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_sc26198disableintrs(portp=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|portp
)paren
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|BRDENABLE
c_func
(paren
id|portp-&gt;brdnr
comma
id|portp-&gt;pagenr
)paren
suffix:semicolon
id|portp-&gt;imr
op_assign
l_int|0
suffix:semicolon
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|IMR
comma
l_int|0
)paren
suffix:semicolon
id|BRDDISABLE
c_func
(paren
id|portp-&gt;brdnr
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|stl_sc26198sendbreak
r_static
r_void
id|stl_sc26198sendbreak
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|len
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_sc26198sendbreak(portp=%x,len=%d)&bslash;n&quot;
comma
(paren
r_int
)paren
id|portp
comma
id|len
)paren
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|BRDENABLE
c_func
(paren
id|portp-&gt;brdnr
comma
id|portp-&gt;pagenr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_eq
l_int|1
)paren
(brace
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|SCCR
comma
id|CR_TXSTARTBREAK
)paren
suffix:semicolon
id|portp-&gt;stats.txbreaks
op_increment
suffix:semicolon
)brace
r_else
(brace
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|SCCR
comma
id|CR_TXSTOPBREAK
)paren
suffix:semicolon
)brace
id|BRDDISABLE
c_func
(paren
id|portp-&gt;brdnr
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Take flow control actions...&n; */
DECL|function|stl_sc26198flowctrl
r_static
r_void
id|stl_sc26198flowctrl
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|state
)paren
(brace
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|mr0
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_sc26198flowctrl(portp=%x,state=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|portp
comma
id|state
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|tty
op_assign
id|portp-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
id|tty
op_eq
(paren
r_struct
id|tty_struct
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|BRDENABLE
c_func
(paren
id|portp-&gt;brdnr
comma
id|portp-&gt;pagenr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
)paren
(brace
r_if
c_cond
(paren
id|tty-&gt;termios-&gt;c_iflag
op_amp
id|IXOFF
)paren
(brace
id|mr0
op_assign
id|stl_sc26198getreg
c_func
(paren
id|portp
comma
id|MR0
)paren
suffix:semicolon
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|MR0
comma
(paren
id|mr0
op_amp
op_complement
id|MR0_SWFRXTX
)paren
)paren
suffix:semicolon
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|SCCR
comma
id|CR_TXSENDXON
)paren
suffix:semicolon
id|mr0
op_or_assign
id|MR0_SWFRX
suffix:semicolon
id|portp-&gt;stats.rxxon
op_increment
suffix:semicolon
id|stl_sc26198wait
c_func
(paren
id|portp
)paren
suffix:semicolon
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|MR0
comma
id|mr0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;&t;Question: should we return RTS to what it was before? It may&n; *&t;&t;have been set by an ioctl... Suppose not, since if you have&n; *&t;&t;hardware flow control set then it is pretty silly to go and&n; *&t;&t;set the RTS line by hand.&n; */
r_if
c_cond
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
(brace
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|MR1
comma
(paren
id|stl_sc26198getreg
c_func
(paren
id|portp
comma
id|MR1
)paren
op_or
id|MR1_AUTORTS
)paren
)paren
suffix:semicolon
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|IOPIOR
comma
(paren
id|stl_sc26198getreg
c_func
(paren
id|portp
comma
id|IOPIOR
)paren
op_or
id|IOPR_RTS
)paren
)paren
suffix:semicolon
id|portp-&gt;stats.rxrtson
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|tty-&gt;termios-&gt;c_iflag
op_amp
id|IXOFF
)paren
(brace
id|mr0
op_assign
id|stl_sc26198getreg
c_func
(paren
id|portp
comma
id|MR0
)paren
suffix:semicolon
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|MR0
comma
(paren
id|mr0
op_amp
op_complement
id|MR0_SWFRXTX
)paren
)paren
suffix:semicolon
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|SCCR
comma
id|CR_TXSENDXOFF
)paren
suffix:semicolon
id|mr0
op_and_assign
op_complement
id|MR0_SWFRX
suffix:semicolon
id|portp-&gt;stats.rxxoff
op_increment
suffix:semicolon
id|stl_sc26198wait
c_func
(paren
id|portp
)paren
suffix:semicolon
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|MR0
comma
id|mr0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
(brace
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|MR1
comma
(paren
id|stl_sc26198getreg
c_func
(paren
id|portp
comma
id|MR1
)paren
op_amp
op_complement
id|MR1_AUTORTS
)paren
)paren
suffix:semicolon
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|IOPIOR
comma
(paren
id|stl_sc26198getreg
c_func
(paren
id|portp
comma
id|IOPIOR
)paren
op_amp
op_complement
id|IOPR_RTS
)paren
)paren
suffix:semicolon
id|portp-&gt;stats.rxrtsoff
op_increment
suffix:semicolon
)brace
)brace
id|BRDDISABLE
c_func
(paren
id|portp-&gt;brdnr
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Send a flow control character.&n; */
DECL|function|stl_sc26198sendflow
r_static
r_void
id|stl_sc26198sendflow
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
id|state
)paren
(brace
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|mr0
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_sc26198sendflow(portp=%x,state=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|portp
comma
id|state
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|tty
op_assign
id|portp-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
id|tty
op_eq
(paren
r_struct
id|tty_struct
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|BRDENABLE
c_func
(paren
id|portp-&gt;brdnr
comma
id|portp-&gt;pagenr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
)paren
(brace
id|mr0
op_assign
id|stl_sc26198getreg
c_func
(paren
id|portp
comma
id|MR0
)paren
suffix:semicolon
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|MR0
comma
(paren
id|mr0
op_amp
op_complement
id|MR0_SWFRXTX
)paren
)paren
suffix:semicolon
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|SCCR
comma
id|CR_TXSENDXON
)paren
suffix:semicolon
id|mr0
op_or_assign
id|MR0_SWFRX
suffix:semicolon
id|portp-&gt;stats.rxxon
op_increment
suffix:semicolon
id|stl_sc26198wait
c_func
(paren
id|portp
)paren
suffix:semicolon
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|MR0
comma
id|mr0
)paren
suffix:semicolon
)brace
r_else
(brace
id|mr0
op_assign
id|stl_sc26198getreg
c_func
(paren
id|portp
comma
id|MR0
)paren
suffix:semicolon
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|MR0
comma
(paren
id|mr0
op_amp
op_complement
id|MR0_SWFRXTX
)paren
)paren
suffix:semicolon
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|SCCR
comma
id|CR_TXSENDXOFF
)paren
suffix:semicolon
id|mr0
op_and_assign
op_complement
id|MR0_SWFRX
suffix:semicolon
id|portp-&gt;stats.rxxoff
op_increment
suffix:semicolon
id|stl_sc26198wait
c_func
(paren
id|portp
)paren
suffix:semicolon
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|MR0
comma
id|mr0
)paren
suffix:semicolon
)brace
id|BRDDISABLE
c_func
(paren
id|portp-&gt;brdnr
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|stl_sc26198flush
r_static
r_void
id|stl_sc26198flush
c_func
(paren
id|stlport_t
op_star
id|portp
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_sc26198flush(portp=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|portp
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|BRDENABLE
c_func
(paren
id|portp-&gt;brdnr
comma
id|portp-&gt;pagenr
)paren
suffix:semicolon
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|SCCR
comma
id|CR_TXRESET
)paren
suffix:semicolon
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|SCCR
comma
id|portp-&gt;crenable
)paren
suffix:semicolon
id|BRDDISABLE
c_func
(paren
id|portp-&gt;brdnr
)paren
suffix:semicolon
id|portp-&gt;tx.tail
op_assign
id|portp-&gt;tx.head
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Return the current state of data flow on this port. This is only&n; *&t;really interresting when determining if data has fully completed&n; *&t;transmission or not... The sc26198 interrupt scheme cannot&n; *&t;determine when all data has actually drained, so we need to&n; *&t;check the port statusy register to be sure.&n; */
DECL|function|stl_sc26198datastate
r_static
r_int
id|stl_sc26198datastate
c_func
(paren
id|stlport_t
op_star
id|portp
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|sr
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_sc26198datastate(portp=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|portp
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|ASYI_TXBUSY
comma
op_amp
id|portp-&gt;istate
)paren
)paren
r_return
l_int|1
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|BRDENABLE
c_func
(paren
id|portp-&gt;brdnr
comma
id|portp-&gt;pagenr
)paren
suffix:semicolon
id|sr
op_assign
id|stl_sc26198getreg
c_func
(paren
id|portp
comma
id|SR
)paren
suffix:semicolon
id|BRDDISABLE
c_func
(paren
id|portp-&gt;brdnr
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
(paren
id|sr
op_amp
id|SR_TXEMPTY
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Delay for a small amount of time, to give the sc26198 a chance&n; *&t;to process a command...&n; */
DECL|function|stl_sc26198wait
r_static
r_void
id|stl_sc26198wait
c_func
(paren
id|stlport_t
op_star
id|portp
)paren
(brace
r_int
id|i
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_sc26198wait(portp=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|portp
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|portp
op_eq
(paren
id|stlport_t
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
l_int|20
)paren
suffix:semicolon
id|i
op_increment
)paren
id|stl_sc26198getglobreg
c_func
(paren
id|portp
comma
id|TSTR
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;If we are TX flow controlled and in IXANY mode then we may&n; *&t;need to unflow control here. We gotta do this because of the&n; *&t;automatic flow control modes of the sc26198.&n; */
DECL|function|stl_sc26198txunflow
r_static
r_inline
r_void
id|stl_sc26198txunflow
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_int
r_char
id|mr0
suffix:semicolon
id|mr0
op_assign
id|stl_sc26198getreg
c_func
(paren
id|portp
comma
id|MR0
)paren
suffix:semicolon
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|MR0
comma
(paren
id|mr0
op_amp
op_complement
id|MR0_SWFRXTX
)paren
)paren
suffix:semicolon
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|SCCR
comma
id|CR_HOSTXON
)paren
suffix:semicolon
id|stl_sc26198wait
c_func
(paren
id|portp
)paren
suffix:semicolon
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|MR0
comma
id|mr0
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|ASYI_TXFLOWED
comma
op_amp
id|portp-&gt;istate
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Interrupt service routine for sc26198 panels.&n; */
DECL|function|stl_sc26198intr
r_static
r_void
id|stl_sc26198intr
c_func
(paren
id|stlpanel_t
op_star
id|panelp
comma
r_int
r_int
id|iobase
)paren
(brace
id|stlport_t
op_star
id|portp
suffix:semicolon
r_int
r_int
id|iack
suffix:semicolon
multiline_comment|/* &n; *&t;Work around bug in sc26198 chip... Cannot have A6 address&n; *&t;line of UART high, else iack will be returned as 0.&n; */
id|outb
c_func
(paren
l_int|0
comma
(paren
id|iobase
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|iack
op_assign
id|inb
c_func
(paren
id|iobase
op_plus
id|XP_IACK
)paren
suffix:semicolon
id|portp
op_assign
id|panelp-&gt;ports
(braket
(paren
id|iack
op_amp
id|IVR_CHANMASK
)paren
op_plus
(paren
(paren
id|iobase
op_amp
l_int|0x4
)paren
op_lshift
l_int|1
)paren
)braket
suffix:semicolon
r_if
c_cond
(paren
id|iack
op_amp
id|IVR_RXDATA
)paren
id|stl_sc26198rxisr
c_func
(paren
id|portp
comma
id|iack
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|iack
op_amp
id|IVR_TXDATA
)paren
id|stl_sc26198txisr
c_func
(paren
id|portp
)paren
suffix:semicolon
r_else
id|stl_sc26198otherisr
c_func
(paren
id|portp
comma
id|iack
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Transmit interrupt handler. This has gotta be fast!  Handling TX&n; *&t;chars is pretty simple, stuff as many as possible from the TX buffer&n; *&t;into the sc26198 FIFO.&n; *&t;In practice it is possible that interrupts are enabled but that the&n; *&t;port has been hung up. Need to handle not having any TX buffer here,&n; *&t;this is done by using the side effect that head and tail will also&n; *&t;be NULL if the buffer has been freed.&n; */
DECL|function|stl_sc26198txisr
r_static
r_void
id|stl_sc26198txisr
c_func
(paren
id|stlport_t
op_star
id|portp
)paren
(brace
r_int
r_int
id|ioaddr
suffix:semicolon
r_int
r_char
id|mr0
suffix:semicolon
r_int
id|len
comma
id|stlen
suffix:semicolon
r_char
op_star
id|head
comma
op_star
id|tail
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_sc26198txisr(portp=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|portp
)paren
suffix:semicolon
macro_line|#endif
id|ioaddr
op_assign
id|portp-&gt;ioaddr
suffix:semicolon
id|head
op_assign
id|portp-&gt;tx.head
suffix:semicolon
id|tail
op_assign
id|portp-&gt;tx.tail
suffix:semicolon
id|len
op_assign
(paren
id|head
op_ge
id|tail
)paren
ques
c_cond
(paren
id|head
op_minus
id|tail
)paren
suffix:colon
(paren
id|STL_TXBUFSIZE
op_minus
(paren
id|tail
op_minus
id|head
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
op_eq
l_int|0
)paren
op_logical_or
(paren
(paren
id|len
OL
id|STL_TXBUFLOW
)paren
op_logical_and
(paren
id|test_bit
c_func
(paren
id|ASYI_TXLOW
comma
op_amp
id|portp-&gt;istate
)paren
op_eq
l_int|0
)paren
)paren
)paren
(brace
id|set_bit
c_func
(paren
id|ASYI_TXLOW
comma
op_amp
id|portp-&gt;istate
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
id|schedule_task
c_func
(paren
op_amp
id|portp-&gt;tqueue
)paren
op_eq
l_int|0
)paren
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
op_eq
l_int|0
)paren
(brace
id|outb
c_func
(paren
(paren
id|MR0
op_or
id|portp-&gt;uartaddr
)paren
comma
(paren
id|ioaddr
op_plus
id|XP_ADDR
)paren
)paren
suffix:semicolon
id|mr0
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|XP_DATA
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mr0
op_amp
id|MR0_TXMASK
)paren
op_eq
id|MR0_TXEMPTY
)paren
(brace
id|portp-&gt;imr
op_and_assign
op_complement
id|IR_TXRDY
suffix:semicolon
id|outb
c_func
(paren
(paren
id|IMR
op_or
id|portp-&gt;uartaddr
)paren
comma
(paren
id|ioaddr
op_plus
id|XP_ADDR
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|portp-&gt;imr
comma
(paren
id|ioaddr
op_plus
id|XP_DATA
)paren
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|ASYI_TXBUSY
comma
op_amp
id|portp-&gt;istate
)paren
suffix:semicolon
)brace
r_else
(brace
id|mr0
op_or_assign
(paren
(paren
id|mr0
op_amp
op_complement
id|MR0_TXMASK
)paren
op_or
id|MR0_TXEMPTY
)paren
suffix:semicolon
id|outb
c_func
(paren
id|mr0
comma
(paren
id|ioaddr
op_plus
id|XP_DATA
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|len
op_assign
id|MIN
c_func
(paren
id|len
comma
id|SC26198_TXFIFOSIZE
)paren
suffix:semicolon
id|portp-&gt;stats.txtotal
op_add_assign
id|len
suffix:semicolon
id|stlen
op_assign
id|MIN
c_func
(paren
id|len
comma
(paren
(paren
id|portp-&gt;tx.buf
op_plus
id|STL_TXBUFSIZE
)paren
op_minus
id|tail
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|GTXFIFO
comma
(paren
id|ioaddr
op_plus
id|XP_ADDR
)paren
)paren
suffix:semicolon
id|outsb
c_func
(paren
(paren
id|ioaddr
op_plus
id|XP_DATA
)paren
comma
id|tail
comma
id|stlen
)paren
suffix:semicolon
id|len
op_sub_assign
id|stlen
suffix:semicolon
id|tail
op_add_assign
id|stlen
suffix:semicolon
r_if
c_cond
(paren
id|tail
op_ge
(paren
id|portp-&gt;tx.buf
op_plus
id|STL_TXBUFSIZE
)paren
)paren
id|tail
op_assign
id|portp-&gt;tx.buf
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
id|outsb
c_func
(paren
(paren
id|ioaddr
op_plus
id|XP_DATA
)paren
comma
id|tail
comma
id|len
)paren
suffix:semicolon
id|tail
op_add_assign
id|len
suffix:semicolon
)brace
id|portp-&gt;tx.tail
op_assign
id|tail
suffix:semicolon
)brace
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Receive character interrupt handler. Determine if we have good chars&n; *&t;or bad chars and then process appropriately. Good chars are easy&n; *&t;just shove the lot into the RX buffer and set all status byte to 0.&n; *&t;If a bad RX char then process as required. This routine needs to be&n; *&t;fast!  In practice it is possible that we get an interrupt on a port&n; *&t;that is closed. This can happen on hangups - since they completely&n; *&t;shutdown a port not in user context. Need to handle this case.&n; */
DECL|function|stl_sc26198rxisr
r_static
r_void
id|stl_sc26198rxisr
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
r_int
id|iack
)paren
(brace
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
r_int
id|len
comma
id|buflen
comma
id|ioaddr
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_sc26198rxisr(portp=%x,iack=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|portp
comma
id|iack
)paren
suffix:semicolon
macro_line|#endif
id|tty
op_assign
id|portp-&gt;tty
suffix:semicolon
id|ioaddr
op_assign
id|portp-&gt;ioaddr
suffix:semicolon
id|outb
c_func
(paren
id|GIBCR
comma
(paren
id|ioaddr
op_plus
id|XP_ADDR
)paren
)paren
suffix:semicolon
id|len
op_assign
id|inb
c_func
(paren
id|ioaddr
op_plus
id|XP_DATA
)paren
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|iack
op_amp
id|IVR_TYPEMASK
)paren
op_eq
id|IVR_RXDATA
)paren
(brace
r_if
c_cond
(paren
(paren
id|tty
op_eq
(paren
r_struct
id|tty_struct
op_star
)paren
l_int|NULL
)paren
op_logical_or
(paren
id|tty-&gt;flip.char_buf_ptr
op_eq
(paren
r_char
op_star
)paren
l_int|NULL
)paren
op_logical_or
(paren
(paren
id|buflen
op_assign
id|TTY_FLIPBUF_SIZE
op_minus
id|tty-&gt;flip.count
)paren
op_eq
l_int|0
)paren
)paren
(brace
id|len
op_assign
id|MIN
c_func
(paren
id|len
comma
r_sizeof
(paren
id|stl_unwanted
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|GRXFIFO
comma
(paren
id|ioaddr
op_plus
id|XP_ADDR
)paren
)paren
suffix:semicolon
id|insb
c_func
(paren
(paren
id|ioaddr
op_plus
id|XP_DATA
)paren
comma
op_amp
id|stl_unwanted
(braket
l_int|0
)braket
comma
id|len
)paren
suffix:semicolon
id|portp-&gt;stats.rxlost
op_add_assign
id|len
suffix:semicolon
id|portp-&gt;stats.rxtotal
op_add_assign
id|len
suffix:semicolon
)brace
r_else
(brace
id|len
op_assign
id|MIN
c_func
(paren
id|len
comma
id|buflen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
id|outb
c_func
(paren
id|GRXFIFO
comma
(paren
id|ioaddr
op_plus
id|XP_ADDR
)paren
)paren
suffix:semicolon
id|insb
c_func
(paren
(paren
id|ioaddr
op_plus
id|XP_DATA
)paren
comma
id|tty-&gt;flip.char_buf_ptr
comma
id|len
)paren
suffix:semicolon
id|memset
c_func
(paren
id|tty-&gt;flip.flag_buf_ptr
comma
l_int|0
comma
id|len
)paren
suffix:semicolon
id|tty-&gt;flip.flag_buf_ptr
op_add_assign
id|len
suffix:semicolon
id|tty-&gt;flip.char_buf_ptr
op_add_assign
id|len
suffix:semicolon
id|tty-&gt;flip.count
op_add_assign
id|len
suffix:semicolon
id|tty_schedule_flip
c_func
(paren
id|tty
)paren
suffix:semicolon
id|portp-&gt;stats.rxtotal
op_add_assign
id|len
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|stl_sc26198rxbadchars
c_func
(paren
id|portp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;If we are TX flow controlled and in IXANY mode then we may need&n; *&t;to unflow control here. We gotta do this because of the automatic&n; *&t;flow control modes of the sc26198.&n; */
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|ASYI_TXFLOWED
comma
op_amp
id|portp-&gt;istate
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|tty
op_ne
(paren
r_struct
id|tty_struct
op_star
)paren
l_int|NULL
)paren
op_logical_and
(paren
id|tty-&gt;termios
op_ne
(paren
r_struct
id|termios
op_star
)paren
l_int|NULL
)paren
op_logical_and
(paren
id|tty-&gt;termios-&gt;c_iflag
op_amp
id|IXANY
)paren
)paren
(brace
id|stl_sc26198txunflow
c_func
(paren
id|portp
comma
id|tty
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Process an RX bad character.&n; */
DECL|function|stl_sc26198rxbadch
r_static
r_void
r_inline
id|stl_sc26198rxbadch
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
r_char
id|status
comma
r_char
id|ch
)paren
(brace
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
r_int
id|ioaddr
suffix:semicolon
id|tty
op_assign
id|portp-&gt;tty
suffix:semicolon
id|ioaddr
op_assign
id|portp-&gt;ioaddr
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SR_RXPARITY
)paren
id|portp-&gt;stats.rxparity
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SR_RXFRAMING
)paren
id|portp-&gt;stats.rxframing
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SR_RXOVERRUN
)paren
id|portp-&gt;stats.rxoverrun
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SR_RXBREAK
)paren
id|portp-&gt;stats.rxbreaks
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tty
op_ne
(paren
r_struct
id|tty_struct
op_star
)paren
l_int|NULL
)paren
op_logical_and
(paren
(paren
id|portp-&gt;rxignoremsk
op_amp
id|status
)paren
op_eq
l_int|0
)paren
)paren
(brace
r_if
c_cond
(paren
id|portp-&gt;rxmarkmsk
op_amp
id|status
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|SR_RXBREAK
)paren
(brace
id|status
op_assign
id|TTY_BREAK
suffix:semicolon
r_if
c_cond
(paren
id|portp-&gt;flags
op_amp
id|ASYNC_SAK
)paren
(brace
id|do_SAK
c_func
(paren
id|tty
)paren
suffix:semicolon
id|BRDENABLE
c_func
(paren
id|portp-&gt;brdnr
comma
id|portp-&gt;pagenr
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
id|SR_RXPARITY
)paren
(brace
id|status
op_assign
id|TTY_PARITY
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
id|SR_RXFRAMING
)paren
(brace
id|status
op_assign
id|TTY_FRAME
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
id|SR_RXOVERRUN
)paren
(brace
id|status
op_assign
id|TTY_OVERRUN
suffix:semicolon
)brace
r_else
(brace
id|status
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
id|status
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tty-&gt;flip.char_buf_ptr
op_ne
(paren
r_char
op_star
)paren
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|tty-&gt;flip.count
OL
id|TTY_FLIPBUF_SIZE
)paren
(brace
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|status
suffix:semicolon
op_star
id|tty-&gt;flip.char_buf_ptr
op_increment
op_assign
id|ch
suffix:semicolon
id|tty-&gt;flip.count
op_increment
suffix:semicolon
)brace
id|tty_schedule_flip
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
id|portp-&gt;stats.rxtotal
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Process all characters in the RX FIFO of the UART. Check all char&n; *&t;status bytes as well, and process as required. We need to check&n; *&t;all bytes in the FIFO, in case some more enter the FIFO while we&n; *&t;are here. To get the exact character error type we need to switch&n; *&t;into CHAR error mode (that is why we need to make sure we empty&n; *&t;the FIFO).&n; */
DECL|function|stl_sc26198rxbadchars
r_static
r_void
id|stl_sc26198rxbadchars
c_func
(paren
id|stlport_t
op_star
id|portp
)paren
(brace
r_int
r_char
id|status
comma
id|mr1
suffix:semicolon
r_char
id|ch
suffix:semicolon
multiline_comment|/*&n; *&t;To get the precise error type for each character we must switch&n; *&t;back into CHAR error mode.&n; */
id|mr1
op_assign
id|stl_sc26198getreg
c_func
(paren
id|portp
comma
id|MR1
)paren
suffix:semicolon
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|MR1
comma
(paren
id|mr1
op_amp
op_complement
id|MR1_ERRBLOCK
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|status
op_assign
id|stl_sc26198getreg
c_func
(paren
id|portp
comma
id|SR
)paren
)paren
op_amp
id|SR_RXRDY
)paren
(brace
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|SCCR
comma
id|CR_CLEARRXERR
)paren
suffix:semicolon
id|ch
op_assign
id|stl_sc26198getreg
c_func
(paren
id|portp
comma
id|RXFIFO
)paren
suffix:semicolon
id|stl_sc26198rxbadch
c_func
(paren
id|portp
comma
id|status
comma
id|ch
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;To get correct interrupt class we must switch back into BLOCK&n; *&t;error mode.&n; */
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|MR1
comma
id|mr1
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Other interrupt handler. This includes modem signals, flow&n; *&t;control actions, etc. Most stuff is left to off-level interrupt&n; *&t;processing time.&n; */
DECL|function|stl_sc26198otherisr
r_static
r_void
id|stl_sc26198otherisr
c_func
(paren
id|stlport_t
op_star
id|portp
comma
r_int
r_int
id|iack
)paren
(brace
r_int
r_char
id|cir
comma
id|ipr
comma
id|xisr
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;stl_sc26198otherisr(portp=%x,iack=%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|portp
comma
id|iack
)paren
suffix:semicolon
macro_line|#endif
id|cir
op_assign
id|stl_sc26198getglobreg
c_func
(paren
id|portp
comma
id|CIR
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cir
op_amp
id|CIR_SUBTYPEMASK
)paren
(brace
r_case
id|CIR_SUBCOS
suffix:colon
id|ipr
op_assign
id|stl_sc26198getreg
c_func
(paren
id|portp
comma
id|IPR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ipr
op_amp
id|IPR_DCDCHANGE
)paren
(brace
id|set_bit
c_func
(paren
id|ASYI_DCDCHANGE
comma
op_amp
id|portp-&gt;istate
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
id|schedule_task
c_func
(paren
op_amp
id|portp-&gt;tqueue
)paren
op_eq
l_int|0
)paren
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|portp-&gt;stats.modem
op_increment
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CIR_SUBXONXOFF
suffix:colon
id|xisr
op_assign
id|stl_sc26198getreg
c_func
(paren
id|portp
comma
id|XISR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xisr
op_amp
id|XISR_RXXONGOT
)paren
(brace
id|set_bit
c_func
(paren
id|ASYI_TXFLOWED
comma
op_amp
id|portp-&gt;istate
)paren
suffix:semicolon
id|portp-&gt;stats.txxoff
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|xisr
op_amp
id|XISR_RXXOFFGOT
)paren
(brace
id|clear_bit
c_func
(paren
id|ASYI_TXFLOWED
comma
op_amp
id|portp-&gt;istate
)paren
suffix:semicolon
id|portp-&gt;stats.txxon
op_increment
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CIR_SUBBREAK
suffix:colon
id|stl_sc26198setreg
c_func
(paren
id|portp
comma
id|SCCR
comma
id|CR_BREAKRESET
)paren
suffix:semicolon
id|stl_sc26198rxbadchars
c_func
(paren
id|portp
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*****************************************************************************/
eof
