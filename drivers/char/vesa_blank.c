multiline_comment|/*&n; * vesa_blank.c&n; *&n; * Exported functions:&n; *&t;void vesa_blank(void);&n; *&t;void vesa_unblank(void);&n; *&t;void set_vesa_blanking(const unsigned long arg);&n; *&n; * Not all hardware reacts well to this code - activate at your own risk.&n; * Activation is done using a sufficiently recent version of setterm&n; * or using a tiny C program like the following.&n; *&n;-----------------------------------------------------------------------&n;|#include &lt;stdio.h&gt;&n;|#include &lt;linux/termios.h&gt;&n;|main(int argc, char *argv[]) {&n;|    int fd;&n;|    struct { char ten, onoff; } arg;&n;|&n;|    if (argc != 2) {&n;|&t;fprintf(stderr, &quot;usage: setvesablank ON|on|off&bslash;n&quot;);&n;|&t;exit(1);&n;|    }&n;|    if ((fd = open(&quot;/dev/console&quot;, 0)) &lt; 0)&n;|      fd = 0;&n;|    arg.ten = 10;&n;|    arg.onoff = 0;&n;|    if (!strcmp(argv[1], &quot;on&quot;))&n;|      arg.onoff = 1;&n;|    else if (!strcmp(argv[1], &quot;ON&quot;))&n;|      arg.onoff = 2;&n;|    if (ioctl(fd, TIOCLINUX, &amp;arg)) {&n;|&t;perror(&quot;setvesablank: TIOCLINUX&quot;);&n;|&t;exit(1);&n;|    }&n;|    exit(0);&n;|}&n;-----------------------------------------------------------------------&n;*/
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
r_extern
r_int
r_int
id|video_port_reg
comma
id|video_port_val
suffix:semicolon
multiline_comment|/*&n; * This file handles the VESA Power Saving Protocol that lets a&n; * monitor be powered down whenever not needed for a longer time.&n; * The VESA protocol defines:&n; *&n; *  Mode/Status&t;&t;HSync&t;VSync&t;Video&n; *  -------------------------------------------&n; *  &quot;On&quot;&t;&t;on&t;on&t;active  (mode 0)&n; *  &quot;Suspend&quot; {either}&t;on&t;off&t;blank   (mode 1)&n; *            {  or  }&t;off&t;on&t;blank   &n; *  &quot;Off&quot;               off&t;off&t;blank&t;(mode 2)&n; *&n; * Original code taken from the Power Management Utility (PMU) of&n; * Huang shi chao, delivered together with many new monitor models&n; * capable of the VESA Power Saving Protocol.&n; *&n; * Adapted to Linux by Christoph Rimek (chrimek@toppoint.de)  15-may-94.&n; * A slightly adapted fragment of his README follows.&n; *&n;Patch (based on Linux Kernel revision 1.0) for handling the Power Saving&n;feature of the new monitor generation. The code works on all these monitors&n;(mine is a Smile 1506) and should run on *all* video adapter cards (change&n;some i/o-adresses), although tested only on two different VGA-cards: a  &n;cheap Cirrus Logic (5428) and a miro Crystal 8S (S3-805).&n;&n;You can choose from two options:&n;&n;(1) Setting vesa_blanking_mode to 1.&n;    The code will save the current setting of your video adapters&squot;&n;    register settings and then program the controller to turn off&n;    the vertical synchronisation pulse.&n;&n;(2) Setting vesa_blanking_mode to 2.&n;    If your monitor locally has an Off_Mode timer then you should not&n;    force your video card to send the OFF-signal - your monitor will&n;    power down by itself.&n;    If your monitor cannot handle this and needs the Off-signal directly,&n;    or if you like your monitor to power down immediately when the&n;    blank_timer times out, then you choose this option.&n;&n;On the other hand I&squot;d recommend to not choose this second option unless&n;it is absolutely necessary. Powering down a monitor to the Off_State with&n;an approx. power consumption of 3-5 Watts is a rather strong action for&n;the CRT and it should not be done every now and then. If the software only  &n;sends the signal to enter Standby mode, you have the chance to interfere&n;before the monitor powers down. Do not set a too short period, if you love&n;your hardware :-)) .&n;&n;If requested, in the future it may be possible to install another timer&n;to provide a configurable delay between the two stages Standby and Off&n;similar to the &quot;setterm -blank&quot;-feature.&n;*/
DECL|macro|seq_port_reg
mdefine_line|#define seq_port_reg&t;(0x3c4)&t;&t;/* Sequencer register select port */
DECL|macro|seq_port_val
mdefine_line|#define seq_port_val&t;(0x3c5)&t;&t;/* Sequencer register value port  */
DECL|macro|video_misc_rd
mdefine_line|#define video_misc_rd&t;(0x3cc)&t;&t;/* Video misc. read port&t;  */
DECL|macro|video_misc_wr
mdefine_line|#define video_misc_wr&t;(0x3c2)&t;&t;/* Video misc. write port&t;  */
multiline_comment|/* structure holding original VGA register settings */
r_static
r_struct
(brace
DECL|member|SeqCtrlIndex
r_int
r_char
id|SeqCtrlIndex
suffix:semicolon
multiline_comment|/* Sequencer Index reg.   */
DECL|member|CrtCtrlIndex
r_int
r_char
id|CrtCtrlIndex
suffix:semicolon
multiline_comment|/* CRT-Contr. Index reg.  */
DECL|member|CrtMiscIO
r_int
r_char
id|CrtMiscIO
suffix:semicolon
multiline_comment|/* Miscellaneous register */
DECL|member|HorizontalTotal
r_int
r_char
id|HorizontalTotal
suffix:semicolon
multiline_comment|/* CRT-Controller:00h */
DECL|member|HorizDisplayEnd
r_int
r_char
id|HorizDisplayEnd
suffix:semicolon
multiline_comment|/* CRT-Controller:01h */
DECL|member|StartHorizRetrace
r_int
r_char
id|StartHorizRetrace
suffix:semicolon
multiline_comment|/* CRT-Controller:04h */
DECL|member|EndHorizRetrace
r_int
r_char
id|EndHorizRetrace
suffix:semicolon
multiline_comment|/* CRT-Controller:05h */
DECL|member|Overflow
r_int
r_char
id|Overflow
suffix:semicolon
multiline_comment|/* CRT-Controller:07h */
DECL|member|StartVertRetrace
r_int
r_char
id|StartVertRetrace
suffix:semicolon
multiline_comment|/* CRT-Controller:10h */
DECL|member|EndVertRetrace
r_int
r_char
id|EndVertRetrace
suffix:semicolon
multiline_comment|/* CRT-Controller:11h */
DECL|member|ModeControl
r_int
r_char
id|ModeControl
suffix:semicolon
multiline_comment|/* CRT-Controller:17h */
DECL|member|ClockingMode
r_int
r_char
id|ClockingMode
suffix:semicolon
multiline_comment|/* Seq-Controller:01h */
DECL|variable|vga
)brace
id|vga
suffix:semicolon
DECL|variable|vesa_blanking_mode
r_static
r_int
id|vesa_blanking_mode
op_assign
l_int|0
suffix:semicolon
DECL|variable|vesa_blanked
r_static
r_int
id|vesa_blanked
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* routine to blank a vesa screen */
DECL|function|vesa_blank
r_void
id|vesa_blank
c_func
(paren
r_void
)paren
(brace
r_int
id|mode
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mode
op_assign
id|vesa_blanking_mode
)paren
op_eq
l_int|0
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/* save original values of VGA controller registers */
id|cli
c_func
(paren
)paren
suffix:semicolon
id|vga.SeqCtrlIndex
op_assign
id|inb_p
c_func
(paren
id|seq_port_reg
)paren
suffix:semicolon
id|vga.CrtCtrlIndex
op_assign
id|inb_p
c_func
(paren
id|video_port_reg
)paren
suffix:semicolon
id|vga.CrtMiscIO
op_assign
id|inb_p
c_func
(paren
id|video_misc_rd
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
l_int|2
)paren
(brace
id|outb_p
c_func
(paren
l_int|0x00
comma
id|video_port_reg
)paren
suffix:semicolon
multiline_comment|/* HorizontalTotal */
id|vga.HorizontalTotal
op_assign
id|inb_p
c_func
(paren
id|video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x01
comma
id|video_port_reg
)paren
suffix:semicolon
multiline_comment|/* HorizDisplayEnd */
id|vga.HorizDisplayEnd
op_assign
id|inb_p
c_func
(paren
id|video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x04
comma
id|video_port_reg
)paren
suffix:semicolon
multiline_comment|/* StartHorizRetrace */
id|vga.StartHorizRetrace
op_assign
id|inb_p
c_func
(paren
id|video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x05
comma
id|video_port_reg
)paren
suffix:semicolon
multiline_comment|/* EndHorizRetrace */
id|vga.EndHorizRetrace
op_assign
id|inb_p
c_func
(paren
id|video_port_val
)paren
suffix:semicolon
)brace
id|outb_p
c_func
(paren
l_int|0x07
comma
id|video_port_reg
)paren
suffix:semicolon
multiline_comment|/* Overflow */
id|vga.Overflow
op_assign
id|inb_p
c_func
(paren
id|video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x10
comma
id|video_port_reg
)paren
suffix:semicolon
multiline_comment|/* StartVertRetrace */
id|vga.StartVertRetrace
op_assign
id|inb_p
c_func
(paren
id|video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x11
comma
id|video_port_reg
)paren
suffix:semicolon
multiline_comment|/* EndVertRetrace */
id|vga.EndVertRetrace
op_assign
id|inb_p
c_func
(paren
id|video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x17
comma
id|video_port_reg
)paren
suffix:semicolon
multiline_comment|/* ModeControl */
id|vga.ModeControl
op_assign
id|inb_p
c_func
(paren
id|video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x01
comma
id|seq_port_reg
)paren
suffix:semicolon
multiline_comment|/* ClockingMode */
id|vga.ClockingMode
op_assign
id|inb_p
c_func
(paren
id|seq_port_val
)paren
suffix:semicolon
multiline_comment|/* assure that video is enabled */
multiline_comment|/* &quot;0x20&quot; is VIDEO_ENABLE_bit in register 01 of sequencer */
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x01
comma
id|seq_port_reg
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|vga.ClockingMode
op_or
l_int|0x20
comma
id|seq_port_val
)paren
suffix:semicolon
multiline_comment|/* test for vertical retrace in process.... */
r_if
c_cond
(paren
(paren
id|vga.CrtMiscIO
op_amp
l_int|0x80
)paren
op_eq
l_int|0x80
)paren
id|outb_p
c_func
(paren
id|vga.CrtMiscIO
op_amp
l_int|0xef
comma
id|video_misc_wr
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set &lt;End of vertical retrace&gt; to minimum (0) and&n;&t; * &lt;Start of vertical Retrace&gt; to maximum (incl. overflow)&n;&t; * Result: turn off vertical sync (VSync) pulse.&n;&t; */
id|outb_p
c_func
(paren
l_int|0x10
comma
id|video_port_reg
)paren
suffix:semicolon
multiline_comment|/* StartVertRetrace */
id|outb_p
c_func
(paren
l_int|0xff
comma
id|video_port_val
)paren
suffix:semicolon
multiline_comment|/* maximum value */
id|outb_p
c_func
(paren
l_int|0x11
comma
id|video_port_reg
)paren
suffix:semicolon
multiline_comment|/* EndVertRetrace */
id|outb_p
c_func
(paren
l_int|0x40
comma
id|video_port_val
)paren
suffix:semicolon
multiline_comment|/* minimum (bits 0..3)  */
id|outb_p
c_func
(paren
l_int|0x07
comma
id|video_port_reg
)paren
suffix:semicolon
multiline_comment|/* Overflow */
id|outb_p
c_func
(paren
id|vga.Overflow
op_or
l_int|0x84
comma
id|video_port_val
)paren
suffix:semicolon
multiline_comment|/* bits 9,10 of  */
multiline_comment|/* vert. retrace */
r_if
c_cond
(paren
id|mode
op_eq
l_int|2
)paren
(brace
multiline_comment|/*&n;&t;     * Set &lt;End of horizontal retrace&gt; to minimum (0) and&n;&t;     *  &lt;Start of horizontal Retrace&gt; to maximum&n;&t;     * Result: turn off horizontal sync (HSync) pulse.&n;&t;     */
id|outb_p
c_func
(paren
l_int|0x04
comma
id|video_port_reg
)paren
suffix:semicolon
multiline_comment|/* StartHorizRetrace */
id|outb_p
c_func
(paren
l_int|0xff
comma
id|video_port_val
)paren
suffix:semicolon
multiline_comment|/* maximum */
id|outb_p
c_func
(paren
l_int|0x05
comma
id|video_port_reg
)paren
suffix:semicolon
multiline_comment|/* EndHorizRetrace */
id|outb_p
c_func
(paren
l_int|0x00
comma
id|video_port_val
)paren
suffix:semicolon
multiline_comment|/* minimum (0) */
)brace
multiline_comment|/* restore both index registers */
id|outb_p
c_func
(paren
id|vga.SeqCtrlIndex
comma
id|seq_port_reg
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|vga.CrtCtrlIndex
comma
id|video_port_reg
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
id|vesa_blanked
op_assign
id|mode
suffix:semicolon
)brace
multiline_comment|/* routine to unblank a vesa screen */
DECL|function|vesa_unblank
r_void
id|vesa_unblank
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|vesa_blanked
)paren
r_return
suffix:semicolon
multiline_comment|/* restore original values of VGA controller registers */
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|vga.CrtMiscIO
comma
id|video_misc_wr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vesa_blanked
op_eq
l_int|2
)paren
(brace
id|outb_p
c_func
(paren
l_int|0x00
comma
id|video_port_reg
)paren
suffix:semicolon
multiline_comment|/* HorizontalTotal */
id|outb_p
c_func
(paren
id|vga.HorizontalTotal
comma
id|video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x01
comma
id|video_port_reg
)paren
suffix:semicolon
multiline_comment|/* HorizDisplayEnd */
id|outb_p
c_func
(paren
id|vga.HorizDisplayEnd
comma
id|video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x04
comma
id|video_port_reg
)paren
suffix:semicolon
multiline_comment|/* StartHorizRetrace */
id|outb_p
c_func
(paren
id|vga.StartHorizRetrace
comma
id|video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x05
comma
id|video_port_reg
)paren
suffix:semicolon
multiline_comment|/* EndHorizRetrace */
id|outb_p
c_func
(paren
id|vga.EndHorizRetrace
comma
id|video_port_val
)paren
suffix:semicolon
)brace
id|outb_p
c_func
(paren
l_int|0x07
comma
id|video_port_reg
)paren
suffix:semicolon
multiline_comment|/* Overflow */
id|outb_p
c_func
(paren
id|vga.Overflow
comma
id|video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x10
comma
id|video_port_reg
)paren
suffix:semicolon
multiline_comment|/* StartVertRetrace */
id|outb_p
c_func
(paren
id|vga.StartVertRetrace
comma
id|video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x11
comma
id|video_port_reg
)paren
suffix:semicolon
multiline_comment|/* EndVertRetrace */
id|outb_p
c_func
(paren
id|vga.EndVertRetrace
comma
id|video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x17
comma
id|video_port_reg
)paren
suffix:semicolon
multiline_comment|/* ModeControl */
id|outb_p
c_func
(paren
id|vga.ModeControl
comma
id|video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x01
comma
id|seq_port_reg
)paren
suffix:semicolon
multiline_comment|/* ClockingMode */
id|outb_p
c_func
(paren
id|vga.ClockingMode
comma
id|seq_port_val
)paren
suffix:semicolon
multiline_comment|/* restore index/control registers */
id|outb_p
c_func
(paren
id|vga.SeqCtrlIndex
comma
id|seq_port_reg
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|vga.CrtCtrlIndex
comma
id|video_port_reg
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
id|vesa_blanked
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|set_vesa_blanking
r_void
id|set_vesa_blanking
c_func
(paren
r_const
r_int
r_int
id|arg
)paren
(brace
r_char
op_star
id|argp
op_assign
(paren
r_char
op_star
)paren
(paren
id|arg
op_plus
l_int|1
)paren
suffix:semicolon
r_int
r_int
id|mode
op_assign
id|get_fs_byte
c_func
(paren
id|argp
)paren
suffix:semicolon
id|vesa_blanking_mode
op_assign
(paren
(paren
id|mode
OL
l_int|3
)paren
ques
c_cond
id|mode
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
eof
