multiline_comment|/*&n; * drivers/char/vme_scc.c: MVME147, MVME162, BVME6000 SCC serial ports&n; * implementation.&n; * Copyright 1999 Richard Hirst &lt;richard@sleepie.demon.co.uk&gt;&n; *&n; * Based on atari_SCC.c which was&n; *   Copyright 1994-95 Roman Hodek &lt;Roman.Hodek@informatik.uni-erlangen.de&gt;&n; *   Partially based on PC-Linux serial.c by Linus Torvalds and Theodore Ts&squot;o&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file COPYING in the main directory of this archive&n; * for more details.&n; *&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kdev_t.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/tty_flip.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/tqueue.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/setup.h&gt;
macro_line|#include &lt;asm/bootinfo.h&gt;
macro_line|#ifdef CONFIG_MVME147_SCC
macro_line|#include &lt;asm/mvme147hw.h&gt;
macro_line|#endif
macro_line|#ifdef CONFIG_MVME162_SCC
macro_line|#include &lt;asm/mvme16xhw.h&gt;
macro_line|#endif
macro_line|#ifdef CONFIG_BVME6000_SCC
macro_line|#include &lt;asm/bvme6000hw.h&gt;
macro_line|#endif
macro_line|#include &lt;linux/generic_serial.h&gt;
macro_line|#include &quot;scc.h&quot;
DECL|macro|CHANNEL_A
mdefine_line|#define CHANNEL_A&t;0
DECL|macro|CHANNEL_B
mdefine_line|#define CHANNEL_B&t;1
DECL|macro|SCC_MINOR_BASE
mdefine_line|#define SCC_MINOR_BASE&t;64
multiline_comment|/* Shadows for all SCC write registers */
DECL|variable|scc_shadow
r_static
r_int
r_char
id|scc_shadow
(braket
l_int|2
)braket
(braket
l_int|16
)braket
suffix:semicolon
multiline_comment|/* Location to access for SCC register access delay */
DECL|variable|scc_del
r_static
r_volatile
r_int
r_char
op_star
id|scc_del
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* To keep track of STATUS_REG state for detection of Ext/Status int source */
DECL|variable|scc_last_status_reg
r_static
r_int
r_char
id|scc_last_status_reg
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/***************************** Prototypes *****************************/
multiline_comment|/* Function prototypes */
r_static
r_void
id|scc_disable_tx_interrupts
c_func
(paren
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_void
id|scc_enable_tx_interrupts
c_func
(paren
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_void
id|scc_disable_rx_interrupts
c_func
(paren
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_void
id|scc_enable_rx_interrupts
c_func
(paren
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_int
id|scc_get_CD
c_func
(paren
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_void
id|scc_shutdown_port
c_func
(paren
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_int
id|scc_set_real_termios
c_func
(paren
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_void
id|scc_hungup
c_func
(paren
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_void
id|scc_close
c_func
(paren
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_int
id|scc_chars_in_buffer
c_func
(paren
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_int
id|scc_open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_int
id|scc_ioctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_void
id|scc_throttle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_void
id|scc_unthrottle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_void
id|scc_tx_int
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|data
comma
r_struct
id|pt_regs
op_star
id|fp
)paren
suffix:semicolon
r_static
r_void
id|scc_rx_int
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|data
comma
r_struct
id|pt_regs
op_star
id|fp
)paren
suffix:semicolon
r_static
r_void
id|scc_stat_int
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|data
comma
r_struct
id|pt_regs
op_star
id|fp
)paren
suffix:semicolon
r_static
r_void
id|scc_spcond_int
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|data
comma
r_struct
id|pt_regs
op_star
id|fp
)paren
suffix:semicolon
r_static
r_void
id|scc_setsignals
c_func
(paren
r_struct
id|scc_port
op_star
id|port
comma
r_int
id|dtr
comma
r_int
id|rts
)paren
suffix:semicolon
r_static
r_void
id|scc_break_ctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|break_state
)paren
suffix:semicolon
DECL|variable|scc_driver
DECL|variable|scc_callout_driver
r_static
r_struct
id|tty_driver
id|scc_driver
comma
id|scc_callout_driver
suffix:semicolon
DECL|variable|scc_table
r_static
r_struct
id|tty_struct
op_star
id|scc_table
(braket
l_int|2
)braket
op_assign
(brace
l_int|NULL
comma
)brace
suffix:semicolon
DECL|variable|scc_termios
r_static
r_struct
id|termios
op_star
id|scc_termios
(braket
l_int|2
)braket
suffix:semicolon
DECL|variable|scc_termios_locked
r_static
r_struct
id|termios
op_star
id|scc_termios_locked
(braket
l_int|2
)braket
suffix:semicolon
DECL|variable|scc_ports
r_struct
id|scc_port
id|scc_ports
(braket
l_int|2
)braket
suffix:semicolon
DECL|variable|scc_refcount
r_int
id|scc_refcount
suffix:semicolon
DECL|variable|scc_initialized
r_int
id|scc_initialized
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*---------------------------------------------------------------------------&n; * Interface from generic_serial.c back here&n; *--------------------------------------------------------------------------*/
DECL|variable|scc_real_driver
r_static
r_struct
id|real_driver
id|scc_real_driver
op_assign
(brace
id|scc_disable_tx_interrupts
comma
id|scc_enable_tx_interrupts
comma
id|scc_disable_rx_interrupts
comma
id|scc_enable_rx_interrupts
comma
id|scc_get_CD
comma
id|scc_shutdown_port
comma
id|scc_set_real_termios
comma
id|scc_chars_in_buffer
comma
id|scc_close
comma
id|scc_hungup
comma
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/*----------------------------------------------------------------------------&n; * vme_scc_init() and support functions&n; *---------------------------------------------------------------------------*/
DECL|function|scc_init_drivers
r_static
r_int
id|scc_init_drivers
c_func
(paren
r_void
)paren
(brace
r_int
id|error
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|scc_driver
comma
l_int|0
comma
r_sizeof
(paren
id|scc_driver
)paren
)paren
suffix:semicolon
id|scc_driver.magic
op_assign
id|TTY_DRIVER_MAGIC
suffix:semicolon
id|scc_driver.driver_name
op_assign
l_string|&quot;scc&quot;
suffix:semicolon
id|scc_driver.name
op_assign
l_string|&quot;ttyS&quot;
suffix:semicolon
id|scc_driver.major
op_assign
id|TTY_MAJOR
suffix:semicolon
id|scc_driver.minor_start
op_assign
id|SCC_MINOR_BASE
suffix:semicolon
id|scc_driver.num
op_assign
l_int|2
suffix:semicolon
id|scc_driver.type
op_assign
id|TTY_DRIVER_TYPE_SERIAL
suffix:semicolon
id|scc_driver.subtype
op_assign
id|SERIAL_TYPE_NORMAL
suffix:semicolon
id|scc_driver.init_termios
op_assign
id|tty_std_termios
suffix:semicolon
id|scc_driver.init_termios.c_cflag
op_assign
id|B9600
op_or
id|CS8
op_or
id|CREAD
op_or
id|HUPCL
op_or
id|CLOCAL
suffix:semicolon
id|scc_driver.flags
op_assign
id|TTY_DRIVER_REAL_RAW
suffix:semicolon
id|scc_driver.refcount
op_assign
op_amp
id|scc_refcount
suffix:semicolon
id|scc_driver.table
op_assign
id|scc_table
suffix:semicolon
id|scc_driver.termios
op_assign
id|scc_termios
suffix:semicolon
id|scc_driver.termios_locked
op_assign
id|scc_termios_locked
suffix:semicolon
id|scc_driver.open
op_assign
id|scc_open
suffix:semicolon
id|scc_driver.close
op_assign
id|gs_close
suffix:semicolon
id|scc_driver.write
op_assign
id|gs_write
suffix:semicolon
id|scc_driver.put_char
op_assign
id|gs_put_char
suffix:semicolon
id|scc_driver.flush_chars
op_assign
id|gs_flush_chars
suffix:semicolon
id|scc_driver.write_room
op_assign
id|gs_write_room
suffix:semicolon
id|scc_driver.chars_in_buffer
op_assign
id|gs_chars_in_buffer
suffix:semicolon
id|scc_driver.flush_buffer
op_assign
id|gs_flush_buffer
suffix:semicolon
id|scc_driver.ioctl
op_assign
id|scc_ioctl
suffix:semicolon
id|scc_driver.throttle
op_assign
id|scc_throttle
suffix:semicolon
id|scc_driver.unthrottle
op_assign
id|scc_unthrottle
suffix:semicolon
id|scc_driver.set_termios
op_assign
id|gs_set_termios
suffix:semicolon
id|scc_driver.stop
op_assign
id|gs_stop
suffix:semicolon
id|scc_driver.start
op_assign
id|gs_start
suffix:semicolon
id|scc_driver.hangup
op_assign
id|gs_hangup
suffix:semicolon
id|scc_driver.break_ctl
op_assign
id|scc_break_ctl
suffix:semicolon
id|scc_callout_driver
op_assign
id|scc_driver
suffix:semicolon
id|scc_callout_driver.name
op_assign
l_string|&quot;cua&quot;
suffix:semicolon
id|scc_callout_driver.major
op_assign
id|TTYAUX_MAJOR
suffix:semicolon
id|scc_callout_driver.subtype
op_assign
id|SERIAL_TYPE_CALLOUT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_assign
id|tty_register_driver
c_func
(paren
op_amp
id|scc_driver
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scc: Couldn&squot;t register scc driver, error = %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|error
op_assign
id|tty_register_driver
c_func
(paren
op_amp
id|scc_callout_driver
)paren
)paren
)paren
(brace
id|tty_unregister_driver
c_func
(paren
op_amp
id|scc_driver
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scc: Couldn&squot;t register scc callout driver, error = %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ports[] array is indexed by line no (i.e. [0] for ttyS0, [1] for ttyS1).&n; */
DECL|function|scc_init_portstructs
r_static
r_void
id|scc_init_portstructs
c_func
(paren
r_void
)paren
(brace
r_struct
id|scc_port
op_star
id|port
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|port
op_assign
id|scc_ports
op_plus
id|i
suffix:semicolon
id|port-&gt;gs.callout_termios
op_assign
id|tty_std_termios
suffix:semicolon
id|port-&gt;gs.normal_termios
op_assign
id|tty_std_termios
suffix:semicolon
id|port-&gt;gs.magic
op_assign
id|SCC_MAGIC
suffix:semicolon
id|port-&gt;gs.close_delay
op_assign
id|HZ
op_div
l_int|2
suffix:semicolon
id|port-&gt;gs.closing_wait
op_assign
l_int|30
op_star
id|HZ
suffix:semicolon
id|port-&gt;gs.rd
op_assign
op_amp
id|scc_real_driver
suffix:semicolon
macro_line|#ifdef NEW_WRITE_LOCKING
id|port-&gt;gs.port_write_sem
op_assign
id|MUTEX
suffix:semicolon
macro_line|#endif
id|init_waitqueue_head
c_func
(paren
op_amp
id|port-&gt;gs.open_wait
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|port-&gt;gs.close_wait
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef CONFIG_MVME147_SCC
DECL|function|mvme147_scc_init
r_static
r_int
id|mvme147_scc_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|scc_port
op_star
id|port
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCC: MVME147 Serial Driver&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Init channel A */
id|port
op_assign
op_amp
id|scc_ports
(braket
l_int|0
)braket
suffix:semicolon
id|port-&gt;channel
op_assign
id|CHANNEL_A
suffix:semicolon
id|port-&gt;ctrlp
op_assign
(paren
r_volatile
r_int
r_char
op_star
)paren
id|M147_SCC_A_ADDR
suffix:semicolon
id|port-&gt;datap
op_assign
id|port-&gt;ctrlp
op_plus
l_int|1
suffix:semicolon
id|port-&gt;port_a
op_assign
op_amp
id|scc_ports
(braket
l_int|0
)braket
suffix:semicolon
id|port-&gt;port_b
op_assign
op_amp
id|scc_ports
(braket
l_int|1
)braket
suffix:semicolon
id|request_irq
c_func
(paren
id|MVME147_IRQ_SCCA_TX
comma
id|scc_tx_int
comma
id|SA_INTERRUPT
comma
l_string|&quot;SCC-A TX&quot;
comma
id|port
)paren
suffix:semicolon
id|request_irq
c_func
(paren
id|MVME147_IRQ_SCCA_STAT
comma
id|scc_stat_int
comma
id|SA_INTERRUPT
comma
l_string|&quot;SCC-A status&quot;
comma
id|port
)paren
suffix:semicolon
id|request_irq
c_func
(paren
id|MVME147_IRQ_SCCA_RX
comma
id|scc_rx_int
comma
id|SA_INTERRUPT
comma
l_string|&quot;SCC-A RX&quot;
comma
id|port
)paren
suffix:semicolon
id|request_irq
c_func
(paren
id|MVME147_IRQ_SCCA_SPCOND
comma
id|scc_spcond_int
comma
id|SA_INTERRUPT
comma
l_string|&quot;SCC-A special cond&quot;
comma
id|port
)paren
suffix:semicolon
(brace
id|SCC_ACCESS_INIT
c_func
(paren
id|port
)paren
suffix:semicolon
multiline_comment|/* disable interrupts for this channel */
id|SCCwrite
c_func
(paren
id|INT_AND_DMA_REG
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Set the interrupt vector */
id|SCCwrite
c_func
(paren
id|INT_VECTOR_REG
comma
id|MVME147_IRQ_SCC_BASE
)paren
suffix:semicolon
multiline_comment|/* Interrupt parameters: vector includes status, status low */
id|SCCwrite
c_func
(paren
id|MASTER_INT_CTRL
comma
id|MIC_VEC_INCL_STAT
)paren
suffix:semicolon
id|SCCmod
c_func
(paren
id|MASTER_INT_CTRL
comma
l_int|0xff
comma
id|MIC_MASTER_INT_ENAB
)paren
suffix:semicolon
)brace
multiline_comment|/* Init channel B */
id|port
op_assign
op_amp
id|scc_ports
(braket
l_int|1
)braket
suffix:semicolon
id|port-&gt;channel
op_assign
id|CHANNEL_B
suffix:semicolon
id|port-&gt;ctrlp
op_assign
(paren
r_volatile
r_int
r_char
op_star
)paren
id|M147_SCC_B_ADDR
suffix:semicolon
id|port-&gt;datap
op_assign
id|port-&gt;ctrlp
op_plus
l_int|1
suffix:semicolon
id|port-&gt;port_a
op_assign
op_amp
id|scc_ports
(braket
l_int|0
)braket
suffix:semicolon
id|port-&gt;port_b
op_assign
op_amp
id|scc_ports
(braket
l_int|1
)braket
suffix:semicolon
id|request_irq
c_func
(paren
id|MVME147_IRQ_SCCB_TX
comma
id|scc_tx_int
comma
id|SA_INTERRUPT
comma
l_string|&quot;SCC-B TX&quot;
comma
id|port
)paren
suffix:semicolon
id|request_irq
c_func
(paren
id|MVME147_IRQ_SCCB_STAT
comma
id|scc_stat_int
comma
id|SA_INTERRUPT
comma
l_string|&quot;SCC-B status&quot;
comma
id|port
)paren
suffix:semicolon
id|request_irq
c_func
(paren
id|MVME147_IRQ_SCCB_RX
comma
id|scc_rx_int
comma
id|SA_INTERRUPT
comma
l_string|&quot;SCC-B RX&quot;
comma
id|port
)paren
suffix:semicolon
id|request_irq
c_func
(paren
id|MVME147_IRQ_SCCB_SPCOND
comma
id|scc_spcond_int
comma
id|SA_INTERRUPT
comma
l_string|&quot;SCC-B special cond&quot;
comma
id|port
)paren
suffix:semicolon
(brace
id|SCC_ACCESS_INIT
c_func
(paren
id|port
)paren
suffix:semicolon
multiline_comment|/* disable interrupts for this channel */
id|SCCwrite
c_func
(paren
id|INT_AND_DMA_REG
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Ensure interrupts are enabled in the PCC chip */
id|m147_pcc-&gt;serial_cntrl
op_assign
id|PCC_LEVEL_SERIAL
op_or
id|PCC_INT_ENAB
suffix:semicolon
multiline_comment|/* Initialise the tty driver structures and register */
id|scc_init_portstructs
c_func
(paren
)paren
suffix:semicolon
id|scc_init_drivers
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_MVME162_SCC
DECL|function|mvme162_scc_init
r_static
r_int
id|mvme162_scc_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|scc_port
op_star
id|port
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mvme16x_config
op_amp
id|MVME16x_CONFIG_GOT_SCCA
)paren
)paren
r_return
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCC: MVME162 Serial Driver&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Init channel A */
id|port
op_assign
op_amp
id|scc_ports
(braket
l_int|0
)braket
suffix:semicolon
id|port-&gt;channel
op_assign
id|CHANNEL_A
suffix:semicolon
id|port-&gt;ctrlp
op_assign
(paren
r_volatile
r_int
r_char
op_star
)paren
id|MVME_SCC_A_ADDR
suffix:semicolon
id|port-&gt;datap
op_assign
id|port-&gt;ctrlp
op_plus
l_int|2
suffix:semicolon
id|port-&gt;port_a
op_assign
op_amp
id|scc_ports
(braket
l_int|0
)braket
suffix:semicolon
id|port-&gt;port_b
op_assign
op_amp
id|scc_ports
(braket
l_int|1
)braket
suffix:semicolon
id|request_irq
c_func
(paren
id|MVME162_IRQ_SCCA_TX
comma
id|scc_tx_int
comma
id|SA_INTERRUPT
comma
l_string|&quot;SCC-A TX&quot;
comma
id|port
)paren
suffix:semicolon
id|request_irq
c_func
(paren
id|MVME162_IRQ_SCCA_STAT
comma
id|scc_stat_int
comma
id|SA_INTERRUPT
comma
l_string|&quot;SCC-A status&quot;
comma
id|port
)paren
suffix:semicolon
id|request_irq
c_func
(paren
id|MVME162_IRQ_SCCA_RX
comma
id|scc_rx_int
comma
id|SA_INTERRUPT
comma
l_string|&quot;SCC-A RX&quot;
comma
id|port
)paren
suffix:semicolon
id|request_irq
c_func
(paren
id|MVME162_IRQ_SCCA_SPCOND
comma
id|scc_spcond_int
comma
id|SA_INTERRUPT
comma
l_string|&quot;SCC-A special cond&quot;
comma
id|port
)paren
suffix:semicolon
(brace
id|SCC_ACCESS_INIT
c_func
(paren
id|port
)paren
suffix:semicolon
multiline_comment|/* disable interrupts for this channel */
id|SCCwrite
c_func
(paren
id|INT_AND_DMA_REG
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Set the interrupt vector */
id|SCCwrite
c_func
(paren
id|INT_VECTOR_REG
comma
id|MVME162_IRQ_SCC_BASE
)paren
suffix:semicolon
multiline_comment|/* Interrupt parameters: vector includes status, status low */
id|SCCwrite
c_func
(paren
id|MASTER_INT_CTRL
comma
id|MIC_VEC_INCL_STAT
)paren
suffix:semicolon
id|SCCmod
c_func
(paren
id|MASTER_INT_CTRL
comma
l_int|0xff
comma
id|MIC_MASTER_INT_ENAB
)paren
suffix:semicolon
)brace
multiline_comment|/* Init channel B */
id|port
op_assign
op_amp
id|scc_ports
(braket
l_int|1
)braket
suffix:semicolon
id|port-&gt;channel
op_assign
id|CHANNEL_B
suffix:semicolon
id|port-&gt;ctrlp
op_assign
(paren
r_volatile
r_int
r_char
op_star
)paren
id|MVME_SCC_B_ADDR
suffix:semicolon
id|port-&gt;datap
op_assign
id|port-&gt;ctrlp
op_plus
l_int|2
suffix:semicolon
id|port-&gt;port_a
op_assign
op_amp
id|scc_ports
(braket
l_int|0
)braket
suffix:semicolon
id|port-&gt;port_b
op_assign
op_amp
id|scc_ports
(braket
l_int|1
)braket
suffix:semicolon
id|request_irq
c_func
(paren
id|MVME162_IRQ_SCCB_TX
comma
id|scc_tx_int
comma
id|SA_INTERRUPT
comma
l_string|&quot;SCC-B TX&quot;
comma
id|port
)paren
suffix:semicolon
id|request_irq
c_func
(paren
id|MVME162_IRQ_SCCB_STAT
comma
id|scc_stat_int
comma
id|SA_INTERRUPT
comma
l_string|&quot;SCC-B status&quot;
comma
id|port
)paren
suffix:semicolon
id|request_irq
c_func
(paren
id|MVME162_IRQ_SCCB_RX
comma
id|scc_rx_int
comma
id|SA_INTERRUPT
comma
l_string|&quot;SCC-B RX&quot;
comma
id|port
)paren
suffix:semicolon
id|request_irq
c_func
(paren
id|MVME162_IRQ_SCCB_SPCOND
comma
id|scc_spcond_int
comma
id|SA_INTERRUPT
comma
l_string|&quot;SCC-B special cond&quot;
comma
id|port
)paren
suffix:semicolon
(brace
id|SCC_ACCESS_INIT
c_func
(paren
id|port
)paren
suffix:semicolon
multiline_comment|/* Either channel will do */
multiline_comment|/* disable interrupts for this channel */
id|SCCwrite
c_func
(paren
id|INT_AND_DMA_REG
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Ensure interrupts are enabled in the MC2 chip */
op_star
(paren
r_volatile
r_char
op_star
)paren
l_int|0xfff4201d
op_assign
l_int|0x14
suffix:semicolon
multiline_comment|/* Initialise the tty driver structures and register */
id|scc_init_portstructs
c_func
(paren
)paren
suffix:semicolon
id|scc_init_drivers
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_BVME6000_SCC
DECL|function|bvme6000_scc_init
r_static
r_int
id|bvme6000_scc_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|scc_port
op_star
id|port
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCC: BVME6000 Serial Driver&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Init channel A */
id|port
op_assign
op_amp
id|scc_ports
(braket
l_int|0
)braket
suffix:semicolon
id|port-&gt;channel
op_assign
id|CHANNEL_A
suffix:semicolon
id|port-&gt;ctrlp
op_assign
(paren
r_volatile
r_int
r_char
op_star
)paren
id|BVME_SCC_A_ADDR
suffix:semicolon
id|port-&gt;datap
op_assign
id|port-&gt;ctrlp
op_plus
l_int|4
suffix:semicolon
id|port-&gt;port_a
op_assign
op_amp
id|scc_ports
(braket
l_int|0
)braket
suffix:semicolon
id|port-&gt;port_b
op_assign
op_amp
id|scc_ports
(braket
l_int|1
)braket
suffix:semicolon
id|request_irq
c_func
(paren
id|BVME_IRQ_SCCA_TX
comma
id|scc_tx_int
comma
id|SA_INTERRUPT
comma
l_string|&quot;SCC-A TX&quot;
comma
id|port
)paren
suffix:semicolon
id|request_irq
c_func
(paren
id|BVME_IRQ_SCCA_STAT
comma
id|scc_stat_int
comma
id|SA_INTERRUPT
comma
l_string|&quot;SCC-A status&quot;
comma
id|port
)paren
suffix:semicolon
id|request_irq
c_func
(paren
id|BVME_IRQ_SCCA_RX
comma
id|scc_rx_int
comma
id|SA_INTERRUPT
comma
l_string|&quot;SCC-A RX&quot;
comma
id|port
)paren
suffix:semicolon
id|request_irq
c_func
(paren
id|BVME_IRQ_SCCA_SPCOND
comma
id|scc_spcond_int
comma
id|SA_INTERRUPT
comma
l_string|&quot;SCC-A special cond&quot;
comma
id|port
)paren
suffix:semicolon
(brace
id|SCC_ACCESS_INIT
c_func
(paren
id|port
)paren
suffix:semicolon
multiline_comment|/* disable interrupts for this channel */
id|SCCwrite
c_func
(paren
id|INT_AND_DMA_REG
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Set the interrupt vector */
id|SCCwrite
c_func
(paren
id|INT_VECTOR_REG
comma
id|BVME_IRQ_SCC_BASE
)paren
suffix:semicolon
multiline_comment|/* Interrupt parameters: vector includes status, status low */
id|SCCwrite
c_func
(paren
id|MASTER_INT_CTRL
comma
id|MIC_VEC_INCL_STAT
)paren
suffix:semicolon
id|SCCmod
c_func
(paren
id|MASTER_INT_CTRL
comma
l_int|0xff
comma
id|MIC_MASTER_INT_ENAB
)paren
suffix:semicolon
)brace
multiline_comment|/* Init channel B */
id|port
op_assign
op_amp
id|scc_ports
(braket
l_int|1
)braket
suffix:semicolon
id|port-&gt;channel
op_assign
id|CHANNEL_B
suffix:semicolon
id|port-&gt;ctrlp
op_assign
(paren
r_volatile
r_int
r_char
op_star
)paren
id|BVME_SCC_B_ADDR
suffix:semicolon
id|port-&gt;datap
op_assign
id|port-&gt;ctrlp
op_plus
l_int|4
suffix:semicolon
id|port-&gt;port_a
op_assign
op_amp
id|scc_ports
(braket
l_int|0
)braket
suffix:semicolon
id|port-&gt;port_b
op_assign
op_amp
id|scc_ports
(braket
l_int|1
)braket
suffix:semicolon
id|request_irq
c_func
(paren
id|BVME_IRQ_SCCB_TX
comma
id|scc_tx_int
comma
id|SA_INTERRUPT
comma
l_string|&quot;SCC-B TX&quot;
comma
id|port
)paren
suffix:semicolon
id|request_irq
c_func
(paren
id|BVME_IRQ_SCCB_STAT
comma
id|scc_stat_int
comma
id|SA_INTERRUPT
comma
l_string|&quot;SCC-B status&quot;
comma
id|port
)paren
suffix:semicolon
id|request_irq
c_func
(paren
id|BVME_IRQ_SCCB_RX
comma
id|scc_rx_int
comma
id|SA_INTERRUPT
comma
l_string|&quot;SCC-B RX&quot;
comma
id|port
)paren
suffix:semicolon
id|request_irq
c_func
(paren
id|BVME_IRQ_SCCB_SPCOND
comma
id|scc_spcond_int
comma
id|SA_INTERRUPT
comma
l_string|&quot;SCC-B special cond&quot;
comma
id|port
)paren
suffix:semicolon
(brace
id|SCC_ACCESS_INIT
c_func
(paren
id|port
)paren
suffix:semicolon
multiline_comment|/* Either channel will do */
multiline_comment|/* disable interrupts for this channel */
id|SCCwrite
c_func
(paren
id|INT_AND_DMA_REG
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialise the tty driver structures and register */
id|scc_init_portstructs
c_func
(paren
)paren
suffix:semicolon
id|scc_init_drivers
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|function|vme_scc_init
r_int
id|vme_scc_init
c_func
(paren
r_void
)paren
(brace
r_int
id|res
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_static
r_int
id|called
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|called
)paren
r_return
id|res
suffix:semicolon
id|called
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef CONFIG_MVME147_SCC
r_if
c_cond
(paren
id|MACH_IS_MVME147
)paren
id|res
op_assign
id|mvme147_scc_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_MVME162_SCC
r_if
c_cond
(paren
id|MACH_IS_MVME16x
)paren
id|res
op_assign
id|mvme162_scc_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_BVME6000_SCC
r_if
c_cond
(paren
id|MACH_IS_BVME6000
)paren
id|res
op_assign
id|bvme6000_scc_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------------&n; * Interrupt handlers&n; *--------------------------------------------------------------------------*/
DECL|function|scc_rx_int
r_static
r_void
id|scc_rx_int
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|data
comma
r_struct
id|pt_regs
op_star
id|fp
)paren
(brace
r_int
r_char
id|ch
suffix:semicolon
r_struct
id|scc_port
op_star
id|port
op_assign
id|data
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|port-&gt;gs.tty
suffix:semicolon
id|SCC_ACCESS_INIT
c_func
(paren
id|port
)paren
suffix:semicolon
id|ch
op_assign
id|SCCread_NB
c_func
(paren
id|RX_DATA_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
)paren
(brace
id|printk
(paren
l_string|&quot;scc_rx_int with NULL tty!&bslash;n&quot;
)paren
suffix:semicolon
id|SCCwrite_NB
c_func
(paren
id|COMMAND_REG
comma
id|CR_HIGHEST_IUS_RESET
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tty-&gt;flip.count
OL
id|TTY_FLIPBUF_SIZE
)paren
(brace
op_star
id|tty-&gt;flip.char_buf_ptr
op_assign
id|ch
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
l_int|0
suffix:semicolon
id|tty-&gt;flip.flag_buf_ptr
op_increment
suffix:semicolon
id|tty-&gt;flip.char_buf_ptr
op_increment
suffix:semicolon
id|tty-&gt;flip.count
op_increment
suffix:semicolon
)brace
multiline_comment|/* Check if another character is already ready; in that case, the&n;&t; * spcond_int() function must be used, because this character may have an&n;&t; * error condition that isn&squot;t signalled by the interrupt vector used!&n;&t; */
r_if
c_cond
(paren
id|SCCread
c_func
(paren
id|INT_PENDING_REG
)paren
op_amp
(paren
id|port-&gt;channel
op_eq
id|CHANNEL_A
ques
c_cond
id|IPR_A_RX
suffix:colon
id|IPR_B_RX
)paren
)paren
(brace
id|scc_spcond_int
(paren
id|irq
comma
id|data
comma
id|fp
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|SCCwrite_NB
c_func
(paren
id|COMMAND_REG
comma
id|CR_HIGHEST_IUS_RESET
)paren
suffix:semicolon
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
DECL|function|scc_spcond_int
r_static
r_void
id|scc_spcond_int
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|data
comma
r_struct
id|pt_regs
op_star
id|fp
)paren
(brace
r_struct
id|scc_port
op_star
id|port
op_assign
id|data
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|port-&gt;gs.tty
suffix:semicolon
r_int
r_char
id|stat
comma
id|ch
comma
id|err
suffix:semicolon
r_int
id|int_pending_mask
op_assign
id|port-&gt;channel
op_eq
id|CHANNEL_A
ques
c_cond
id|IPR_A_RX
suffix:colon
id|IPR_B_RX
suffix:semicolon
id|SCC_ACCESS_INIT
c_func
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
)paren
(brace
id|printk
(paren
l_string|&quot;scc_spcond_int with NULL tty!&bslash;n&quot;
)paren
suffix:semicolon
id|SCCwrite
c_func
(paren
id|COMMAND_REG
comma
id|CR_ERROR_RESET
)paren
suffix:semicolon
id|SCCwrite_NB
c_func
(paren
id|COMMAND_REG
comma
id|CR_HIGHEST_IUS_RESET
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_do
(brace
id|stat
op_assign
id|SCCread
c_func
(paren
id|SPCOND_STATUS_REG
)paren
suffix:semicolon
id|ch
op_assign
id|SCCread_NB
c_func
(paren
id|RX_DATA_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
id|SCSR_RX_OVERRUN
)paren
id|err
op_assign
id|TTY_OVERRUN
suffix:semicolon
r_else
r_if
c_cond
(paren
id|stat
op_amp
id|SCSR_PARITY_ERR
)paren
id|err
op_assign
id|TTY_PARITY
suffix:semicolon
r_else
r_if
c_cond
(paren
id|stat
op_amp
id|SCSR_CRC_FRAME_ERR
)paren
id|err
op_assign
id|TTY_FRAME
suffix:semicolon
r_else
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;flip.count
OL
id|TTY_FLIPBUF_SIZE
)paren
(brace
op_star
id|tty-&gt;flip.char_buf_ptr
op_assign
id|ch
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
id|err
suffix:semicolon
id|tty-&gt;flip.flag_buf_ptr
op_increment
suffix:semicolon
id|tty-&gt;flip.char_buf_ptr
op_increment
suffix:semicolon
id|tty-&gt;flip.count
op_increment
suffix:semicolon
)brace
multiline_comment|/* ++TeSche: *All* errors have to be cleared manually,&n;&t;&t; * else the condition persists for the next chars&n;&t;&t; */
r_if
c_cond
(paren
id|err
)paren
id|SCCwrite
c_func
(paren
id|COMMAND_REG
comma
id|CR_ERROR_RESET
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|SCCread
c_func
(paren
id|INT_PENDING_REG
)paren
op_amp
id|int_pending_mask
)paren
(brace
suffix:semicolon
)brace
id|SCCwrite_NB
c_func
(paren
id|COMMAND_REG
comma
id|CR_HIGHEST_IUS_RESET
)paren
suffix:semicolon
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
DECL|function|scc_tx_int
r_static
r_void
id|scc_tx_int
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|data
comma
r_struct
id|pt_regs
op_star
id|fp
)paren
(brace
r_struct
id|scc_port
op_star
id|port
op_assign
id|data
suffix:semicolon
id|SCC_ACCESS_INIT
c_func
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port-&gt;gs.tty
)paren
(brace
id|printk
(paren
l_string|&quot;scc_tx_int with NULL tty!&bslash;n&quot;
)paren
suffix:semicolon
id|SCCmod
(paren
id|INT_AND_DMA_REG
comma
op_complement
id|IDR_TX_INT_ENAB
comma
l_int|0
)paren
suffix:semicolon
id|SCCwrite
c_func
(paren
id|COMMAND_REG
comma
id|CR_TX_PENDING_RESET
)paren
suffix:semicolon
id|SCCwrite_NB
c_func
(paren
id|COMMAND_REG
comma
id|CR_HIGHEST_IUS_RESET
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|SCCread_NB
c_func
(paren
id|STATUS_REG
)paren
op_amp
id|SR_TX_BUF_EMPTY
)paren
)paren
(brace
r_if
c_cond
(paren
id|port-&gt;x_char
)paren
(brace
id|SCCwrite
c_func
(paren
id|TX_DATA_REG
comma
id|port-&gt;x_char
)paren
suffix:semicolon
id|port-&gt;x_char
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|port-&gt;gs.xmit_cnt
op_le
l_int|0
)paren
op_logical_or
id|port-&gt;gs.tty-&gt;stopped
op_logical_or
id|port-&gt;gs.tty-&gt;hw_stopped
)paren
r_break
suffix:semicolon
r_else
(brace
id|SCCwrite
c_func
(paren
id|TX_DATA_REG
comma
id|port-&gt;gs.xmit_buf
(braket
id|port-&gt;gs.xmit_tail
op_increment
)braket
)paren
suffix:semicolon
id|port-&gt;gs.xmit_tail
op_assign
id|port-&gt;gs.xmit_tail
op_amp
(paren
id|SERIAL_XMIT_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|port-&gt;gs.xmit_cnt
op_le
l_int|0
)paren
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|port-&gt;gs.xmit_cnt
op_le
l_int|0
)paren
op_logical_or
id|port-&gt;gs.tty-&gt;stopped
op_logical_or
id|port-&gt;gs.tty-&gt;hw_stopped
)paren
(brace
multiline_comment|/* disable tx interrupts */
id|SCCmod
(paren
id|INT_AND_DMA_REG
comma
op_complement
id|IDR_TX_INT_ENAB
comma
l_int|0
)paren
suffix:semicolon
id|SCCwrite
c_func
(paren
id|COMMAND_REG
comma
id|CR_TX_PENDING_RESET
)paren
suffix:semicolon
multiline_comment|/* disable tx_int on next tx underrun? */
id|port-&gt;gs.flags
op_and_assign
op_complement
id|GS_TX_INTEN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|port-&gt;gs.tty
op_logical_and
id|port-&gt;gs.xmit_cnt
op_le
id|port-&gt;gs.wakeup_chars
)paren
(brace
r_if
c_cond
(paren
(paren
id|port-&gt;gs.tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|port-&gt;gs.tty-&gt;ldisc.write_wakeup
)paren
(paren
id|port-&gt;gs.tty-&gt;ldisc.write_wakeup
)paren
(paren
id|port-&gt;gs.tty
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|port-&gt;gs.tty-&gt;write_wait
)paren
suffix:semicolon
)brace
id|SCCwrite_NB
c_func
(paren
id|COMMAND_REG
comma
id|CR_HIGHEST_IUS_RESET
)paren
suffix:semicolon
)brace
DECL|function|scc_stat_int
r_static
r_void
id|scc_stat_int
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|data
comma
r_struct
id|pt_regs
op_star
id|fp
)paren
(brace
r_struct
id|scc_port
op_star
id|port
op_assign
id|data
suffix:semicolon
r_int
id|channel
op_assign
id|port-&gt;channel
suffix:semicolon
r_int
r_char
id|last_sr
comma
id|sr
comma
id|changed
suffix:semicolon
id|SCC_ACCESS_INIT
c_func
(paren
id|port
)paren
suffix:semicolon
id|last_sr
op_assign
id|scc_last_status_reg
(braket
id|channel
)braket
suffix:semicolon
id|sr
op_assign
id|scc_last_status_reg
(braket
id|channel
)braket
op_assign
id|SCCread_NB
c_func
(paren
id|STATUS_REG
)paren
suffix:semicolon
id|changed
op_assign
id|last_sr
op_xor
id|sr
suffix:semicolon
r_if
c_cond
(paren
id|changed
op_amp
id|SR_DCD
)paren
(brace
id|port-&gt;c_dcd
op_assign
op_logical_neg
op_logical_neg
(paren
id|sr
op_amp
id|SR_DCD
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|port-&gt;gs.flags
op_amp
id|ASYNC_CHECK_CD
)paren
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t report DCD changes */
r_else
r_if
c_cond
(paren
id|port-&gt;c_dcd
)paren
(brace
r_if
c_cond
(paren
op_complement
(paren
id|port-&gt;gs.flags
op_amp
id|ASYNC_NORMAL_ACTIVE
)paren
op_logical_or
op_complement
(paren
id|port-&gt;gs.flags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
)paren
(brace
multiline_comment|/* Are we blocking in open?*/
id|wake_up_interruptible
c_func
(paren
op_amp
id|port-&gt;gs.open_wait
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|port-&gt;gs.flags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
op_logical_and
(paren
id|port-&gt;gs.flags
op_amp
id|ASYNC_CALLOUT_NOHUP
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|port-&gt;gs.tty
)paren
id|tty_hangup
(paren
id|port-&gt;gs.tty
)paren
suffix:semicolon
)brace
)brace
)brace
id|SCCwrite
c_func
(paren
id|COMMAND_REG
comma
id|CR_EXTSTAT_RESET
)paren
suffix:semicolon
id|SCCwrite_NB
c_func
(paren
id|COMMAND_REG
comma
id|CR_HIGHEST_IUS_RESET
)paren
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------------&n; * generic_serial.c callback funtions&n; *--------------------------------------------------------------------------*/
DECL|function|scc_disable_tx_interrupts
r_static
r_void
id|scc_disable_tx_interrupts
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|scc_port
op_star
id|port
op_assign
id|ptr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|SCC_ACCESS_INIT
c_func
(paren
id|port
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|SCCmod
c_func
(paren
id|INT_AND_DMA_REG
comma
op_complement
id|IDR_TX_INT_ENAB
comma
l_int|0
)paren
suffix:semicolon
id|port-&gt;gs.flags
op_and_assign
op_complement
id|GS_TX_INTEN
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|scc_enable_tx_interrupts
r_static
r_void
id|scc_enable_tx_interrupts
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|scc_port
op_star
id|port
op_assign
id|ptr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|SCC_ACCESS_INIT
c_func
(paren
id|port
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|SCCmod
c_func
(paren
id|INT_AND_DMA_REG
comma
l_int|0xff
comma
id|IDR_TX_INT_ENAB
)paren
suffix:semicolon
multiline_comment|/* restart the transmitter */
id|scc_tx_int
(paren
l_int|0
comma
id|port
comma
l_int|0
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|scc_disable_rx_interrupts
r_static
r_void
id|scc_disable_rx_interrupts
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|scc_port
op_star
id|port
op_assign
id|ptr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|SCC_ACCESS_INIT
c_func
(paren
id|port
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|SCCmod
c_func
(paren
id|INT_AND_DMA_REG
comma
op_complement
(paren
id|IDR_RX_INT_MASK
op_or
id|IDR_PARERR_AS_SPCOND
op_or
id|IDR_EXTSTAT_INT_ENAB
)paren
comma
l_int|0
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|scc_enable_rx_interrupts
r_static
r_void
id|scc_enable_rx_interrupts
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|scc_port
op_star
id|port
op_assign
id|ptr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|SCC_ACCESS_INIT
c_func
(paren
id|port
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|SCCmod
c_func
(paren
id|INT_AND_DMA_REG
comma
l_int|0xff
comma
id|IDR_EXTSTAT_INT_ENAB
op_or
id|IDR_PARERR_AS_SPCOND
op_or
id|IDR_RX_INT_ALL
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|scc_get_CD
r_static
r_int
id|scc_get_CD
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|scc_port
op_star
id|port
op_assign
id|ptr
suffix:semicolon
r_int
id|channel
op_assign
id|port-&gt;channel
suffix:semicolon
r_return
op_logical_neg
op_logical_neg
(paren
id|scc_last_status_reg
(braket
id|channel
)braket
op_amp
id|SR_DCD
)paren
suffix:semicolon
)brace
DECL|function|scc_shutdown_port
r_static
r_void
id|scc_shutdown_port
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|scc_port
op_star
id|port
op_assign
id|ptr
suffix:semicolon
id|port-&gt;gs.flags
op_and_assign
op_complement
id|GS_ACTIVE
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;gs.tty
op_logical_and
id|port-&gt;gs.tty-&gt;termios-&gt;c_cflag
op_amp
id|HUPCL
)paren
(brace
id|scc_setsignals
(paren
id|port
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
DECL|function|scc_set_real_termios
r_static
r_int
id|scc_set_real_termios
(paren
r_void
op_star
id|ptr
)paren
(brace
multiline_comment|/* the SCC has char sizes 5,7,6,8 in that order! */
r_static
r_int
id|chsize_map
(braket
l_int|4
)braket
op_assign
(brace
l_int|0
comma
l_int|2
comma
l_int|1
comma
l_int|3
)brace
suffix:semicolon
r_int
id|cflag
comma
id|baud
comma
id|chsize
comma
id|channel
comma
id|brgval
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|scc_port
op_star
id|port
op_assign
id|ptr
suffix:semicolon
id|SCC_ACCESS_INIT
c_func
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port-&gt;gs.tty
op_logical_or
op_logical_neg
id|port-&gt;gs.tty-&gt;termios
)paren
r_return
l_int|0
suffix:semicolon
id|channel
op_assign
id|port-&gt;channel
suffix:semicolon
r_if
c_cond
(paren
id|channel
op_eq
id|CHANNEL_A
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Settings controlled by boot PROM */
id|cflag
op_assign
id|port-&gt;gs.tty-&gt;termios-&gt;c_cflag
suffix:semicolon
id|baud
op_assign
id|port-&gt;gs.baud
suffix:semicolon
id|chsize
op_assign
(paren
id|cflag
op_amp
id|CSIZE
)paren
op_rshift
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|baud
op_eq
l_int|0
)paren
(brace
multiline_comment|/* speed == 0 -&gt; drop DTR */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|SCCmod
c_func
(paren
id|TX_CTRL_REG
comma
op_complement
id|TCR_DTR
comma
l_int|0
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|MACH_IS_MVME16x
op_logical_and
(paren
id|baud
template_param
l_int|38400
)paren
)paren
op_logical_or
(paren
id|MACH_IS_MVME147
op_logical_and
(paren
id|baud
template_param
l_int|19200
)paren
)paren
op_logical_or
(paren
id|MACH_IS_BVME6000
op_logical_and
(paren
id|baud
template_param
l_int|76800
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SCC: Bad speed requested, %d&bslash;n&quot;
comma
id|baud
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cflag
op_amp
id|CLOCAL
)paren
id|port-&gt;gs.flags
op_and_assign
op_complement
id|ASYNC_CHECK_CD
suffix:semicolon
r_else
id|port-&gt;gs.flags
op_or_assign
id|ASYNC_CHECK_CD
suffix:semicolon
macro_line|#ifdef CONFIG_MVME147_SCC
r_if
c_cond
(paren
id|MACH_IS_MVME147
)paren
id|brgval
op_assign
(paren
id|M147_SCC_PCLK
op_plus
id|baud
op_div
l_int|2
)paren
op_div
(paren
l_int|16
op_star
l_int|2
op_star
id|baud
)paren
op_minus
l_int|2
suffix:semicolon
r_else
macro_line|#endif
macro_line|#ifdef CONFIG_MVME162_SCC
r_if
c_cond
(paren
id|MACH_IS_MVME16x
)paren
id|brgval
op_assign
(paren
id|MVME_SCC_PCLK
op_plus
id|baud
op_div
l_int|2
)paren
op_div
(paren
l_int|16
op_star
l_int|2
op_star
id|baud
)paren
op_minus
l_int|2
suffix:semicolon
r_else
macro_line|#endif
macro_line|#ifdef CONFIG_BVME6000_SCC
r_if
c_cond
(paren
id|MACH_IS_BVME6000
)paren
id|brgval
op_assign
(paren
id|BVME_SCC_RTxC
op_plus
id|baud
op_div
l_int|2
)paren
op_div
(paren
l_int|16
op_star
l_int|2
op_star
id|baud
)paren
op_minus
l_int|2
suffix:semicolon
macro_line|#endif
multiline_comment|/* Now we have all parameters and can go to set them: */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* receiver&squot;s character size and auto-enables */
id|SCCmod
c_func
(paren
id|RX_CTRL_REG
comma
op_complement
(paren
id|RCR_CHSIZE_MASK
op_or
id|RCR_AUTO_ENAB_MODE
)paren
comma
(paren
id|chsize_map
(braket
id|chsize
)braket
op_lshift
l_int|6
)paren
op_or
(paren
(paren
id|cflag
op_amp
id|CRTSCTS
)paren
ques
c_cond
id|RCR_AUTO_ENAB_MODE
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
multiline_comment|/* parity and stop bits (both, Tx and Rx), clock mode never changes */
id|SCCmod
(paren
id|AUX1_CTRL_REG
comma
op_complement
(paren
id|A1CR_PARITY_MASK
op_or
id|A1CR_MODE_MASK
)paren
comma
(paren
(paren
id|cflag
op_amp
id|PARENB
ques
c_cond
(paren
id|cflag
op_amp
id|PARODD
ques
c_cond
id|A1CR_PARITY_ODD
suffix:colon
id|A1CR_PARITY_EVEN
)paren
suffix:colon
id|A1CR_PARITY_NONE
)paren
op_or
(paren
id|cflag
op_amp
id|CSTOPB
ques
c_cond
id|A1CR_MODE_ASYNC_2
suffix:colon
id|A1CR_MODE_ASYNC_1
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* sender&squot;s character size, set DTR for valid baud rate */
id|SCCmod
c_func
(paren
id|TX_CTRL_REG
comma
op_complement
id|TCR_CHSIZE_MASK
comma
id|chsize_map
(braket
id|chsize
)braket
op_lshift
l_int|5
op_or
id|TCR_DTR
)paren
suffix:semicolon
multiline_comment|/* clock sources never change */
multiline_comment|/* disable BRG before changing the value */
id|SCCmod
c_func
(paren
id|DPLL_CTRL_REG
comma
op_complement
id|DCR_BRG_ENAB
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* BRG value */
id|SCCwrite
c_func
(paren
id|TIMER_LOW_REG
comma
id|brgval
op_amp
l_int|0xff
)paren
suffix:semicolon
id|SCCwrite
c_func
(paren
id|TIMER_HIGH_REG
comma
(paren
id|brgval
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* BRG enable, and clock source never changes */
id|SCCmod
c_func
(paren
id|DPLL_CTRL_REG
comma
l_int|0xff
comma
id|DCR_BRG_ENAB
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|scc_chars_in_buffer
r_static
r_int
id|scc_chars_in_buffer
(paren
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|scc_port
op_star
id|port
op_assign
id|ptr
suffix:semicolon
id|SCC_ACCESS_INIT
c_func
(paren
id|port
)paren
suffix:semicolon
r_return
(paren
id|SCCread
(paren
id|SPCOND_STATUS_REG
)paren
op_amp
id|SCSR_ALL_SENT
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
)brace
DECL|function|scc_hungup
r_static
r_void
id|scc_hungup
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
id|scc_disable_tx_interrupts
c_func
(paren
id|ptr
)paren
suffix:semicolon
id|scc_disable_rx_interrupts
c_func
(paren
id|ptr
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
DECL|function|scc_close
r_static
r_void
id|scc_close
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
id|scc_disable_tx_interrupts
c_func
(paren
id|ptr
)paren
suffix:semicolon
id|scc_disable_rx_interrupts
c_func
(paren
id|ptr
)paren
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------------&n; * Internal support functions&n; *--------------------------------------------------------------------------*/
DECL|function|scc_setsignals
r_static
r_void
id|scc_setsignals
c_func
(paren
r_struct
id|scc_port
op_star
id|port
comma
r_int
id|dtr
comma
r_int
id|rts
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|t
suffix:semicolon
id|SCC_ACCESS_INIT
c_func
(paren
id|port
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|t
op_assign
id|SCCread
c_func
(paren
id|TX_CTRL_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dtr
op_ge
l_int|0
)paren
id|t
op_assign
id|dtr
ques
c_cond
(paren
id|t
op_or
id|TCR_DTR
)paren
suffix:colon
(paren
id|t
op_amp
op_complement
id|TCR_DTR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rts
op_ge
l_int|0
)paren
id|t
op_assign
id|rts
ques
c_cond
(paren
id|t
op_or
id|TCR_RTS
)paren
suffix:colon
(paren
id|t
op_amp
op_complement
id|TCR_RTS
)paren
suffix:semicolon
id|SCCwrite
c_func
(paren
id|TX_CTRL_REG
comma
id|t
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|scc_send_xchar
r_static
r_void
id|scc_send_xchar
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_char
id|ch
)paren
(brace
r_struct
id|scc_port
op_star
id|port
op_assign
(paren
r_struct
id|scc_port
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|port-&gt;x_char
op_assign
id|ch
suffix:semicolon
r_if
c_cond
(paren
id|ch
)paren
id|scc_enable_tx_interrupts
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------------&n; * Driver entrypoints referenced from above&n; *--------------------------------------------------------------------------*/
DECL|function|scc_open
r_static
r_int
id|scc_open
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_int
id|line
op_assign
id|MINOR
c_func
(paren
id|tty-&gt;device
)paren
op_minus
id|SCC_MINOR_BASE
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_struct
id|scc_port
op_star
id|port
op_assign
op_amp
id|scc_ports
(braket
id|line
)braket
suffix:semicolon
r_int
id|i
comma
id|channel
op_assign
id|port-&gt;channel
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|SCC_ACCESS_INIT
c_func
(paren
id|port
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_MVME162_SCC) || defined(CONFIG_MVME147_SCC)
r_static
r_const
r_struct
(brace
r_int
id|reg
comma
id|val
suffix:semicolon
)brace
id|mvme_init_tab
(braket
)braket
op_assign
(brace
multiline_comment|/* Values for MVME162 and MVME147 */
multiline_comment|/* no parity, 1 stop bit, async, 1:16 */
(brace
id|AUX1_CTRL_REG
comma
id|A1CR_PARITY_NONE
op_or
id|A1CR_MODE_ASYNC_1
op_or
id|A1CR_CLKMODE_x16
)brace
comma
multiline_comment|/* parity error is special cond, ints disabled, no DMA */
(brace
id|INT_AND_DMA_REG
comma
id|IDR_PARERR_AS_SPCOND
op_or
id|IDR_RX_INT_DISAB
)brace
comma
multiline_comment|/* Rx 8 bits/char, no auto enable, Rx off */
(brace
id|RX_CTRL_REG
comma
id|RCR_CHSIZE_8
)brace
comma
multiline_comment|/* DTR off, Tx 8 bits/char, RTS off, Tx off */
(brace
id|TX_CTRL_REG
comma
id|TCR_CHSIZE_8
)brace
comma
multiline_comment|/* special features off */
(brace
id|AUX2_CTRL_REG
comma
l_int|0
)brace
comma
(brace
id|CLK_CTRL_REG
comma
id|CCR_RXCLK_BRG
op_or
id|CCR_TXCLK_BRG
)brace
comma
(brace
id|DPLL_CTRL_REG
comma
id|DCR_BRG_ENAB
op_or
id|DCR_BRG_USE_PCLK
)brace
comma
multiline_comment|/* Start Rx */
(brace
id|RX_CTRL_REG
comma
id|RCR_RX_ENAB
op_or
id|RCR_CHSIZE_8
)brace
comma
multiline_comment|/* Start Tx */
(brace
id|TX_CTRL_REG
comma
id|TCR_TX_ENAB
op_or
id|TCR_RTS
op_or
id|TCR_DTR
op_or
id|TCR_CHSIZE_8
)brace
comma
multiline_comment|/* Ext/Stat ints: DCD only */
(brace
id|INT_CTRL_REG
comma
id|ICR_ENAB_DCD_INT
)brace
comma
multiline_comment|/* Reset Ext/Stat ints */
(brace
id|COMMAND_REG
comma
id|CR_EXTSTAT_RESET
)brace
comma
multiline_comment|/* ...again */
(brace
id|COMMAND_REG
comma
id|CR_EXTSTAT_RESET
)brace
comma
)brace
suffix:semicolon
macro_line|#endif
macro_line|#if defined(CONFIG_BVME6000_SCC)
r_static
r_const
r_struct
(brace
r_int
id|reg
comma
id|val
suffix:semicolon
)brace
id|bvme_init_tab
(braket
)braket
op_assign
(brace
multiline_comment|/* Values for BVME6000 */
multiline_comment|/* no parity, 1 stop bit, async, 1:16 */
(brace
id|AUX1_CTRL_REG
comma
id|A1CR_PARITY_NONE
op_or
id|A1CR_MODE_ASYNC_1
op_or
id|A1CR_CLKMODE_x16
)brace
comma
multiline_comment|/* parity error is special cond, ints disabled, no DMA */
(brace
id|INT_AND_DMA_REG
comma
id|IDR_PARERR_AS_SPCOND
op_or
id|IDR_RX_INT_DISAB
)brace
comma
multiline_comment|/* Rx 8 bits/char, no auto enable, Rx off */
(brace
id|RX_CTRL_REG
comma
id|RCR_CHSIZE_8
)brace
comma
multiline_comment|/* DTR off, Tx 8 bits/char, RTS off, Tx off */
(brace
id|TX_CTRL_REG
comma
id|TCR_CHSIZE_8
)brace
comma
multiline_comment|/* special features off */
(brace
id|AUX2_CTRL_REG
comma
l_int|0
)brace
comma
(brace
id|CLK_CTRL_REG
comma
id|CCR_RTxC_XTAL
op_or
id|CCR_RXCLK_BRG
op_or
id|CCR_TXCLK_BRG
)brace
comma
(brace
id|DPLL_CTRL_REG
comma
id|DCR_BRG_ENAB
)brace
comma
multiline_comment|/* Start Rx */
(brace
id|RX_CTRL_REG
comma
id|RCR_RX_ENAB
op_or
id|RCR_CHSIZE_8
)brace
comma
multiline_comment|/* Start Tx */
(brace
id|TX_CTRL_REG
comma
id|TCR_TX_ENAB
op_or
id|TCR_RTS
op_or
id|TCR_DTR
op_or
id|TCR_CHSIZE_8
)brace
comma
multiline_comment|/* Ext/Stat ints: DCD only */
(brace
id|INT_CTRL_REG
comma
id|ICR_ENAB_DCD_INT
)brace
comma
multiline_comment|/* Reset Ext/Stat ints */
(brace
id|COMMAND_REG
comma
id|CR_EXTSTAT_RESET
)brace
comma
multiline_comment|/* ...again */
(brace
id|COMMAND_REG
comma
id|CR_EXTSTAT_RESET
)brace
comma
)brace
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
(paren
id|port-&gt;gs.flags
op_amp
id|ASYNC_INITIALIZED
)paren
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_MVME147_SCC) || defined(CONFIG_MVME162_SCC)
r_if
c_cond
(paren
id|MACH_IS_MVME147
op_logical_or
id|MACH_IS_MVME16x
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|mvme_init_tab
)paren
op_div
r_sizeof
(paren
op_star
id|mvme_init_tab
)paren
suffix:semicolon
op_increment
id|i
)paren
id|SCCwrite
c_func
(paren
id|mvme_init_tab
(braket
id|i
)braket
dot
id|reg
comma
id|mvme_init_tab
(braket
id|i
)braket
dot
id|val
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if defined(CONFIG_BVME6000_SCC)
r_if
c_cond
(paren
id|MACH_IS_BVME6000
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|bvme_init_tab
)paren
op_div
r_sizeof
(paren
op_star
id|bvme_init_tab
)paren
suffix:semicolon
op_increment
id|i
)paren
id|SCCwrite
c_func
(paren
id|bvme_init_tab
(braket
id|i
)braket
dot
id|reg
comma
id|bvme_init_tab
(braket
id|i
)braket
dot
id|val
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* remember status register for detection of DCD and CTS changes */
id|scc_last_status_reg
(braket
id|channel
)braket
op_assign
id|SCCread
c_func
(paren
id|STATUS_REG
)paren
suffix:semicolon
id|port-&gt;c_dcd
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Prevent initial 1-&gt;0 interrupt */
id|scc_setsignals
(paren
id|port
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
id|tty-&gt;driver_data
op_assign
id|port
suffix:semicolon
id|port-&gt;gs.tty
op_assign
id|tty
suffix:semicolon
id|port-&gt;gs.count
op_increment
suffix:semicolon
id|retval
op_assign
id|gs_init_port
c_func
(paren
op_amp
id|port-&gt;gs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|port-&gt;gs.count
op_decrement
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
id|port-&gt;gs.flags
op_or_assign
id|GS_ACTIVE
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;gs.count
op_eq
l_int|1
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
)brace
id|retval
op_assign
id|block_til_ready
c_func
(paren
id|port
comma
id|filp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|port-&gt;gs.count
op_decrement
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|port-&gt;gs.count
op_eq
l_int|1
)paren
op_logical_and
(paren
id|port-&gt;gs.flags
op_amp
id|ASYNC_SPLIT_TERMIOS
)paren
)paren
(brace
r_if
c_cond
(paren
id|tty-&gt;driver.subtype
op_eq
id|SERIAL_TYPE_NORMAL
)paren
op_star
id|tty-&gt;termios
op_assign
id|port-&gt;gs.normal_termios
suffix:semicolon
r_else
op_star
id|tty-&gt;termios
op_assign
id|port-&gt;gs.callout_termios
suffix:semicolon
id|scc_set_real_termios
(paren
id|port
)paren
suffix:semicolon
)brace
id|port-&gt;gs.session
op_assign
id|current-&gt;session
suffix:semicolon
id|port-&gt;gs.pgrp
op_assign
id|current-&gt;pgrp
suffix:semicolon
id|port-&gt;c_dcd
op_assign
id|scc_get_CD
(paren
id|port
)paren
suffix:semicolon
id|scc_enable_rx_interrupts
c_func
(paren
id|port
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|scc_throttle
r_static
r_void
id|scc_throttle
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|scc_port
op_star
id|port
op_assign
(paren
r_struct
id|scc_port
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|SCC_ACCESS_INIT
c_func
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|SCCmod
c_func
(paren
id|TX_CTRL_REG
comma
op_complement
id|TCR_RTS
comma
l_int|0
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|I_IXOFF
c_func
(paren
id|tty
)paren
)paren
id|scc_send_xchar
c_func
(paren
id|tty
comma
id|STOP_CHAR
c_func
(paren
id|tty
)paren
)paren
suffix:semicolon
)brace
DECL|function|scc_unthrottle
r_static
r_void
id|scc_unthrottle
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|scc_port
op_star
id|port
op_assign
(paren
r_struct
id|scc_port
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|SCC_ACCESS_INIT
c_func
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|SCCmod
c_func
(paren
id|TX_CTRL_REG
comma
l_int|0xff
comma
id|TCR_RTS
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|I_IXOFF
c_func
(paren
id|tty
)paren
)paren
id|scc_send_xchar
c_func
(paren
id|tty
comma
id|START_CHAR
c_func
(paren
id|tty
)paren
)paren
suffix:semicolon
)brace
DECL|function|scc_ioctl
r_static
r_int
id|scc_ioctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
DECL|function|scc_break_ctl
r_static
r_void
id|scc_break_ctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|break_state
)paren
(brace
r_struct
id|scc_port
op_star
id|port
op_assign
(paren
r_struct
id|scc_port
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|SCC_ACCESS_INIT
c_func
(paren
id|port
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|SCCmod
c_func
(paren
id|TX_CTRL_REG
comma
op_complement
id|TCR_SEND_BREAK
comma
id|break_state
ques
c_cond
id|TCR_SEND_BREAK
suffix:colon
l_int|0
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------------&n; * Serial console stuff...&n; *--------------------------------------------------------------------------*/
DECL|macro|scc_delay
mdefine_line|#define scc_delay() do { __asm__ __volatile__ (&quot; nop; nop&quot;); } while (0)
DECL|function|scc_ch_write
r_static
r_void
id|scc_ch_write
(paren
r_char
id|ch
)paren
(brace
r_volatile
r_char
op_star
id|p
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef CONFIG_MVME147_SCC
r_if
c_cond
(paren
id|MACH_IS_MVME147
)paren
id|p
op_assign
(paren
r_volatile
r_char
op_star
)paren
id|M147_SCC_A_ADDR
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_MVME162_SCC
r_if
c_cond
(paren
id|MACH_IS_MVME16x
)paren
id|p
op_assign
(paren
r_volatile
r_char
op_star
)paren
id|MVME_SCC_A_ADDR
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_BVME6000_SCC
r_if
c_cond
(paren
id|MACH_IS_BVME6000
)paren
id|p
op_assign
(paren
r_volatile
r_char
op_star
)paren
id|BVME_SCC_A_ADDR
suffix:semicolon
macro_line|#endif
r_do
(brace
id|scc_delay
c_func
(paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
op_star
id|p
op_amp
l_int|4
)paren
)paren
suffix:semicolon
id|scc_delay
c_func
(paren
)paren
suffix:semicolon
op_star
id|p
op_assign
l_int|8
suffix:semicolon
id|scc_delay
c_func
(paren
)paren
suffix:semicolon
op_star
id|p
op_assign
id|ch
suffix:semicolon
)brace
multiline_comment|/* The console_lock must be held when we get here. */
DECL|function|scc_console_write
r_static
r_void
id|scc_console_write
(paren
r_struct
id|console
op_star
id|co
comma
r_const
r_char
op_star
id|str
comma
r_int
id|count
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
op_decrement
)paren
(brace
r_if
c_cond
(paren
op_star
id|str
op_eq
l_char|&squot;&bslash;n&squot;
)paren
id|scc_ch_write
(paren
l_char|&squot;&bslash;r&squot;
)paren
suffix:semicolon
id|scc_ch_write
(paren
op_star
id|str
op_increment
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|scc_console_wait_key
r_static
r_int
id|scc_console_wait_key
c_func
(paren
r_struct
id|console
op_star
id|co
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_volatile
r_char
op_star
id|p
op_assign
l_int|NULL
suffix:semicolon
r_int
id|c
suffix:semicolon
macro_line|#ifdef CONFIG_MVME147_SCC
r_if
c_cond
(paren
id|MACH_IS_MVME147
)paren
id|p
op_assign
(paren
r_volatile
r_char
op_star
)paren
id|M147_SCC_A_ADDR
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_MVME162_SCC
r_if
c_cond
(paren
id|MACH_IS_MVME16x
)paren
id|p
op_assign
(paren
r_volatile
r_char
op_star
)paren
id|MVME_SCC_A_ADDR
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_BVME6000_SCC
r_if
c_cond
(paren
id|MACH_IS_BVME6000
)paren
id|p
op_assign
(paren
r_volatile
r_char
op_star
)paren
id|BVME_SCC_A_ADDR
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* wait for rx buf filled */
r_while
c_loop
(paren
(paren
op_star
id|p
op_amp
l_int|0x01
)paren
op_eq
l_int|0
)paren
suffix:semicolon
op_star
id|p
op_assign
l_int|8
suffix:semicolon
id|scc_delay
c_func
(paren
)paren
suffix:semicolon
id|c
op_assign
op_star
id|p
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|c
suffix:semicolon
)brace
DECL|function|scc_console_device
r_static
id|kdev_t
id|scc_console_device
c_func
(paren
r_struct
id|console
op_star
id|c
)paren
(brace
r_return
id|MKDEV
c_func
(paren
id|TTY_MAJOR
comma
id|SCC_MINOR_BASE
op_plus
id|c-&gt;index
)paren
suffix:semicolon
)brace
DECL|function|scc_console_setup
r_static
r_int
id|__init
id|scc_console_setup
c_func
(paren
r_struct
id|console
op_star
id|co
comma
r_char
op_star
id|options
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|sercons
r_static
r_struct
id|console
id|sercons
op_assign
(brace
id|name
suffix:colon
l_string|&quot;ttyS&quot;
comma
id|write
suffix:colon
id|scc_console_write
comma
id|device
suffix:colon
id|scc_console_device
comma
id|wait_key
suffix:colon
id|scc_console_wait_key
comma
id|setup
suffix:colon
id|scc_console_setup
comma
id|flags
suffix:colon
id|CON_PRINTBUFFER
comma
id|index
suffix:colon
op_minus
l_int|1
comma
)brace
suffix:semicolon
DECL|function|vme_scc_console_init
r_void
id|__init
id|vme_scc_console_init
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|vme_brdtype
op_eq
id|VME_TYPE_MVME147
op_logical_or
id|vme_brdtype
op_eq
id|VME_TYPE_MVME162
op_logical_or
id|vme_brdtype
op_eq
id|VME_TYPE_MVME172
op_logical_or
id|vme_brdtype
op_eq
id|VME_TYPE_BVME4000
op_logical_or
id|vme_brdtype
op_eq
id|VME_TYPE_BVME6000
)paren
id|register_console
c_func
(paren
op_amp
id|sercons
)paren
suffix:semicolon
)brace
eof
