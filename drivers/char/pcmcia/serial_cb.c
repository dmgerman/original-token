multiline_comment|/*======================================================================&n;&n;    A driver for CardBus serial devices&n;&n;    serial_cb.c 1.20 2000/08/07 19:02:03&n;&n;    Copyright 1998, 1999 by Donald Becker and David Hinds&n;    &n;    This software may be used and distributed according to the terms&n;    of the GNU Public License, incorporated herein by reference.&n;    All other rights reserved.&n;    &n;    This driver is an activator for CardBus serial cards, as&n;    found on multifunction (e.g. Ethernet and Modem) CardBus cards.&n;    &n;    Donald Becker may be reached as becker@CESDIS.edu, or C/O&n;    USRA Center of Excellence in Space Data and Information Sciences&n;    Code 930.5, NASA Goddard Space Flight Center, Greenbelt MD 20771&n;    David Hinds may be reached at dahinds@users.sourceforge.net&n;    &n;======================================================================*/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;pcmcia/driver_ops.h&gt;
macro_line|#ifdef PCMCIA_DEBUG
DECL|variable|pc_debug
r_static
r_int
id|pc_debug
op_assign
id|PCMCIA_DEBUG
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|pc_debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|macro|DEBUG
mdefine_line|#define DEBUG(n, args...) if (pc_debug&gt;(n)) printk(KERN_DEBUG args)
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;serial_cb.c 1.20 2000/08/07 19:02:03 (David Hinds)&quot;
suffix:semicolon
macro_line|#else
DECL|macro|DEBUG
mdefine_line|#define DEBUG(n, args...)
macro_line|#endif
multiline_comment|/*======================================================================&n;&n;    Card-specific configuration hacks&n;&n;======================================================================*/
DECL|function|device_setup
r_static
r_void
id|device_setup
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|u_int
id|ioaddr
)paren
(brace
id|u_short
id|a
comma
id|b
suffix:semicolon
id|a
op_assign
id|pdev-&gt;subsystem_vendor
suffix:semicolon
id|b
op_assign
id|pdev-&gt;subsystem_device
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|a
op_eq
l_int|0x13a2
)paren
op_logical_and
(paren
id|b
op_eq
l_int|0x8007
)paren
)paren
op_logical_or
(paren
(paren
id|a
op_eq
l_int|0x1420
)paren
op_logical_and
(paren
id|b
op_eq
l_int|0x8003
)paren
)paren
)paren
(brace
multiline_comment|/* Ositech, Psion 83c175-based cards */
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;  83c175 NVCTL_m = 0x%4.4x.&bslash;n&quot;
comma
id|inl
c_func
(paren
id|ioaddr
op_plus
l_int|0x80
)paren
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x4C00
comma
id|ioaddr
op_plus
l_int|0x80
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x4C80
comma
id|ioaddr
op_plus
l_int|0x80
)paren
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;  modem registers are %2.2x %2.2x %2.2x &quot;
l_string|&quot;%2.2x %2.2x %2.2x %2.2x %2.2x  %2.2x.&bslash;n&quot;
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|0
)paren
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|1
)paren
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|2
)paren
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|3
)paren
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|4
)paren
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|5
)paren
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|6
)paren
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|7
)paren
comma
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|8
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*======================================================================&n;&n;    serial_attach() creates a serial device &quot;instance&quot; and registers&n;    it with the kernel serial driver, and serial_detach() unregisters&n;    an instance.&n;&n;======================================================================*/
DECL|function|serial_attach
r_static
id|dev_node_t
op_star
id|serial_attach
c_func
(paren
id|dev_locator_t
op_star
id|loc
)paren
(brace
id|u_int
id|io
suffix:semicolon
id|u_char
id|irq
suffix:semicolon
r_int
id|line
suffix:semicolon
r_struct
id|serial_struct
id|serial
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
id|dev_node_t
op_star
id|node
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
id|loc-&gt;bus
op_ne
id|LOC_PCI
)paren
r_goto
id|err_out
suffix:semicolon
id|pdev
op_assign
id|pci_find_slot
(paren
id|loc-&gt;b.pci.bus
comma
id|loc-&gt;b.pci.devfn
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pdev
)paren
r_goto
id|err_out
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
r_goto
id|err_out
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;serial_attach(bus %d, fn %d)&bslash;n&quot;
comma
id|pdev-&gt;bus-&gt;number
comma
id|pdev-&gt;devfn
)paren
suffix:semicolon
id|io
op_assign
id|pci_resource_start
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pci_resource_flags
c_func
(paren
id|pdev
comma
l_int|0
)paren
op_amp
id|IORESOURCE_IO
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;serial_cb: PCI base address 0 is not IO&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
id|device_setup
c_func
(paren
id|pdev
comma
id|io
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|serial
comma
l_int|0
comma
r_sizeof
(paren
id|serial
)paren
)paren
suffix:semicolon
id|serial.port
op_assign
id|io
suffix:semicolon
id|serial.irq
op_assign
id|irq
suffix:semicolon
id|serial.flags
op_assign
id|ASYNC_SKIP_TEST
op_or
id|ASYNC_SHARE_IRQ
suffix:semicolon
multiline_comment|/* Some devices seem to need extra time */
id|__set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|50
)paren
suffix:semicolon
id|line
op_assign
id|register_serial
c_func
(paren
op_amp
id|serial
)paren
suffix:semicolon
r_if
c_cond
(paren
id|line
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;serial_cb: register_serial() at 0x%04x, &quot;
l_string|&quot;irq %d failed&bslash;n&quot;
comma
id|serial.port
comma
id|serial.irq
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
id|node
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|dev_node_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
r_goto
id|err_out_unregister
suffix:semicolon
id|sprintf
c_func
(paren
id|node-&gt;dev_name
comma
l_string|&quot;ttyS%d&quot;
comma
id|line
)paren
suffix:semicolon
id|node-&gt;major
op_assign
id|TTY_MAJOR
suffix:semicolon
id|node-&gt;minor
op_assign
l_int|0x40
op_plus
id|line
suffix:semicolon
id|node-&gt;next
op_assign
l_int|NULL
suffix:semicolon
r_return
id|node
suffix:semicolon
id|err_out_unregister
suffix:colon
id|unregister_serial
c_func
(paren
id|line
)paren
suffix:semicolon
id|err_out
suffix:colon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|serial_detach
r_static
r_void
id|serial_detach
c_func
(paren
id|dev_node_t
op_star
id|node
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;serial_detach(ttyS%02d)&bslash;n&quot;
comma
id|node-&gt;minor
op_minus
l_int|0x40
)paren
suffix:semicolon
id|unregister_serial
c_func
(paren
id|node-&gt;minor
op_minus
l_int|0x40
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|node
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
DECL|variable|serial_ops
r_struct
id|driver_operations
id|serial_ops
op_assign
(brace
l_string|&quot;serial_cb&quot;
comma
id|serial_attach
comma
l_int|NULL
comma
l_int|NULL
comma
id|serial_detach
)brace
suffix:semicolon
DECL|function|init_serial_cb
r_static
r_int
id|__init
id|init_serial_cb
c_func
(paren
r_void
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|version
)paren
suffix:semicolon
id|register_driver
c_func
(paren
op_amp
id|serial_ops
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|exit_serial_cb
r_static
r_void
id|__exit
id|exit_serial_cb
c_func
(paren
r_void
)paren
(brace
id|DEBUG
c_func
(paren
l_int|0
comma
l_string|&quot;serial_cb: unloading&bslash;n&quot;
)paren
suffix:semicolon
id|unregister_driver
c_func
(paren
op_amp
id|serial_ops
)paren
suffix:semicolon
)brace
DECL|variable|init_serial_cb
id|module_init
c_func
(paren
id|init_serial_cb
)paren
suffix:semicolon
DECL|variable|exit_serial_cb
id|module_exit
c_func
(paren
id|exit_serial_cb
)paren
suffix:semicolon
eof
