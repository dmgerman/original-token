multiline_comment|/* soc.c: Sparc SUNW,soc (Serial Optical Channel) Fibre Channel Sbus adapter support.&n; *&n; * Copyright (C) 1996,1997,1999 Jakub Jelinek (jj@ultra.linux.cz)&n; * Copyright (C) 1997,1998 Jirka Hanika (geo@ff.cuni.cz)&n; *&n; * Sources:&n; *&t;Fibre Channel Physical &amp; Signaling Interface (FC-PH), dpANS, 1994&n; *&t;dpANS Fibre Channel Protocol for SCSI (X3.269-199X), Rev. 012, 1995&n; *&n; * Supported hardware:&n; *      Tested on SOC sbus card bought with SS1000 in Linux running on SS5 and Ultra1. &n; *      For SOC sbus cards, you have to make sure your FCode is 1.52 or later.&n; *      If you have older FCode, you should try to upgrade or get SOC microcode from Sun&n; *      (the microcode is present in Solaris soc driver as well). In that case you need&n; *      to #define HAVE_SOC_UCODE and format the microcode into soc_asm.c. For the exact&n; *      format mail me and I will tell you. I cannot offer you the actual microcode though,&n; *      unless Sun confirms they don&squot;t mind.&n; */
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;soc.c:v1.3 9/Feb/99 Jakub Jelinek (jj@ultra.linux.cz), Jirka Hanika (geo@ff.cuni.cz)&bslash;n&quot;
suffix:semicolon
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/openprom.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/auxio.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
multiline_comment|/* #define SOCDEBUG */
multiline_comment|/* #define HAVE_SOC_UCODE */
macro_line|#include &quot;fcp_impl.h&quot;
macro_line|#include &quot;soc.h&quot;
macro_line|#ifdef HAVE_SOC_UCODE
macro_line|#include &quot;soc_asm.h&quot;
macro_line|#endif
DECL|macro|soc_printk
mdefine_line|#define soc_printk printk (&quot;soc%d: &quot;, s-&gt;soc_no); printk 
macro_line|#ifdef SOCDEBUG
DECL|macro|SOD
mdefine_line|#define SOD(x)  soc_printk x;
macro_line|#else
DECL|macro|SOD
mdefine_line|#define SOD(x)
macro_line|#endif
DECL|macro|for_each_soc
mdefine_line|#define for_each_soc(s) for (s = socs; s; s = s-&gt;next)
DECL|variable|socs
r_struct
id|soc
op_star
id|socs
op_assign
l_int|NULL
suffix:semicolon
DECL|function|soc_disable
r_static
r_inline
r_void
id|soc_disable
c_func
(paren
r_struct
id|soc
op_star
id|s
)paren
(brace
id|sbus_writel
c_func
(paren
l_int|0
comma
id|s-&gt;regs
op_plus
id|IMASK
)paren
suffix:semicolon
id|sbus_writel
c_func
(paren
id|SOC_CMD_SOFT_RESET
comma
id|s-&gt;regs
op_plus
id|CMD
)paren
suffix:semicolon
)brace
DECL|function|soc_enable
r_static
r_inline
r_void
id|soc_enable
c_func
(paren
r_struct
id|soc
op_star
id|s
)paren
(brace
id|SOD
c_func
(paren
(paren
l_string|&quot;enable %08x&bslash;n&quot;
comma
id|s-&gt;cfg
)paren
)paren
id|sbus_writel
c_func
(paren
l_int|0
comma
id|s-&gt;regs
op_plus
id|SAE
)paren
suffix:semicolon
id|sbus_writel
c_func
(paren
id|s-&gt;cfg
comma
id|s-&gt;regs
op_plus
id|CFG
)paren
suffix:semicolon
id|sbus_writel
c_func
(paren
id|SOC_CMD_RSP_QALL
comma
id|s-&gt;regs
op_plus
id|CMD
)paren
suffix:semicolon
id|SOC_SETIMASK
c_func
(paren
id|s
comma
id|SOC_IMASK_RSP_QALL
op_or
id|SOC_IMASK_SAE
)paren
suffix:semicolon
id|SOD
c_func
(paren
(paren
l_string|&quot;imask %08lx %08lx&bslash;n&quot;
comma
id|s-&gt;imask
comma
id|sbus_readl
c_func
(paren
id|s-&gt;regs
op_plus
id|IMAK
)paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|soc_reset
r_static
r_void
id|soc_reset
c_func
(paren
id|fc_channel
op_star
id|fc
)paren
(brace
id|soc_port
op_star
id|port
op_assign
(paren
id|soc_port
op_star
)paren
id|fc
suffix:semicolon
r_struct
id|soc
op_star
id|s
op_assign
id|port-&gt;s
suffix:semicolon
multiline_comment|/* FIXME */
id|soc_disable
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;req
(braket
l_int|0
)braket
dot
id|seqno
op_assign
l_int|1
suffix:semicolon
id|s-&gt;req
(braket
l_int|1
)braket
dot
id|seqno
op_assign
l_int|1
suffix:semicolon
id|s-&gt;rsp
(braket
l_int|0
)braket
dot
id|seqno
op_assign
l_int|1
suffix:semicolon
id|s-&gt;rsp
(braket
l_int|1
)braket
dot
id|seqno
op_assign
l_int|1
suffix:semicolon
id|s-&gt;req
(braket
l_int|0
)braket
dot
id|in
op_assign
l_int|0
suffix:semicolon
id|s-&gt;req
(braket
l_int|1
)braket
dot
id|in
op_assign
l_int|0
suffix:semicolon
id|s-&gt;rsp
(braket
l_int|0
)braket
dot
id|in
op_assign
l_int|0
suffix:semicolon
id|s-&gt;rsp
(braket
l_int|1
)braket
dot
id|in
op_assign
l_int|0
suffix:semicolon
id|s-&gt;req
(braket
l_int|0
)braket
dot
id|out
op_assign
l_int|0
suffix:semicolon
id|s-&gt;req
(braket
l_int|1
)braket
dot
id|out
op_assign
l_int|0
suffix:semicolon
id|s-&gt;rsp
(braket
l_int|0
)braket
dot
id|out
op_assign
l_int|0
suffix:semicolon
id|s-&gt;rsp
(braket
l_int|1
)braket
dot
id|out
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* FIXME */
id|soc_enable
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
DECL|function|soc_solicited
r_static
r_void
r_inline
id|soc_solicited
(paren
r_struct
id|soc
op_star
id|s
)paren
(brace
id|fc_hdr
id|fchdr
suffix:semicolon
id|soc_rsp
op_star
id|hwrsp
suffix:semicolon
id|soc_cq
op_star
id|sw_cq
suffix:semicolon
r_int
id|token
suffix:semicolon
r_int
id|status
suffix:semicolon
id|fc_channel
op_star
id|fc
suffix:semicolon
id|sw_cq
op_assign
op_amp
id|s-&gt;rsp
(braket
id|SOC_SOLICITED_RSP_Q
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sw_cq-&gt;pool
op_eq
l_int|NULL
)paren
id|sw_cq-&gt;pool
op_assign
(paren
id|soc_req
op_star
)paren
(paren
id|s-&gt;xram
op_plus
id|xram_get_32low
(paren
(paren
id|xram_p
)paren
op_amp
id|sw_cq-&gt;hw_cq-&gt;address
)paren
)paren
suffix:semicolon
id|sw_cq-&gt;in
op_assign
id|xram_get_8
(paren
(paren
id|xram_p
)paren
op_amp
id|sw_cq-&gt;hw_cq-&gt;in
)paren
suffix:semicolon
id|SOD
(paren
(paren
l_string|&quot;soc_solicited, %d pkts arrived&bslash;n&quot;
comma
(paren
id|sw_cq-&gt;in
op_minus
id|sw_cq-&gt;out
)paren
op_amp
id|sw_cq-&gt;last
)paren
)paren
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|hwrsp
op_assign
(paren
id|soc_rsp
op_star
)paren
id|sw_cq-&gt;pool
op_plus
id|sw_cq-&gt;out
suffix:semicolon
id|token
op_assign
id|xram_get_32low
(paren
(paren
id|xram_p
)paren
op_amp
id|hwrsp-&gt;shdr.token
)paren
suffix:semicolon
id|status
op_assign
id|xram_get_32low
(paren
(paren
id|xram_p
)paren
op_amp
id|hwrsp-&gt;status
)paren
suffix:semicolon
id|fc
op_assign
(paren
id|fc_channel
op_star
)paren
(paren
op_amp
id|s-&gt;port
(braket
(paren
id|token
op_rshift
l_int|11
)paren
op_amp
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
id|SOC_OK
)paren
(brace
id|fcp_receive_solicited
c_func
(paren
id|fc
comma
id|token
op_rshift
l_int|12
comma
id|token
op_amp
(paren
(paren
l_int|1
op_lshift
l_int|11
)paren
op_minus
l_int|1
)paren
comma
id|FC_STATUS_OK
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_else
(brace
id|xram_copy_from
c_func
(paren
op_amp
id|fchdr
comma
(paren
id|xram_p
)paren
op_amp
id|hwrsp-&gt;fchdr
comma
r_sizeof
(paren
id|fchdr
)paren
)paren
suffix:semicolon
multiline_comment|/* We have intentionally defined FC_STATUS_* constants&n;&t;&t;&t; * to match SOC_* constants, otherwise we&squot;d have to&n;&t;&t;&t; * translate status.&n;&t;&t;&t; */
id|fcp_receive_solicited
c_func
(paren
id|fc
comma
id|token
op_rshift
l_int|12
comma
id|token
op_amp
(paren
(paren
l_int|1
op_lshift
l_int|11
)paren
op_minus
l_int|1
)paren
comma
id|status
comma
op_amp
id|fchdr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_increment
id|sw_cq-&gt;out
OG
id|sw_cq-&gt;last
)paren
(brace
id|sw_cq-&gt;seqno
op_increment
suffix:semicolon
id|sw_cq-&gt;out
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sw_cq-&gt;out
op_eq
id|sw_cq-&gt;in
)paren
(brace
id|sw_cq-&gt;in
op_assign
id|xram_get_8
(paren
(paren
id|xram_p
)paren
op_amp
id|sw_cq-&gt;hw_cq-&gt;in
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sw_cq-&gt;out
op_eq
id|sw_cq-&gt;in
)paren
(brace
multiline_comment|/* Tell the hardware about it */
id|sbus_writel
c_func
(paren
(paren
id|sw_cq-&gt;out
op_lshift
l_int|24
)paren
op_or
(paren
id|SOC_CMD_RSP_QALL
op_amp
op_complement
(paren
id|SOC_CMD_RSP_Q0
op_lshift
id|SOC_SOLICITED_RSP_Q
)paren
)paren
comma
id|s-&gt;regs
op_plus
id|CMD
)paren
suffix:semicolon
multiline_comment|/* Read it, so that we&squot;re sure it has been updated */
id|sbus_readl
c_func
(paren
id|s-&gt;regs
op_plus
id|CMD
)paren
suffix:semicolon
id|sw_cq-&gt;in
op_assign
id|xram_get_8
(paren
(paren
id|xram_p
)paren
op_amp
id|sw_cq-&gt;hw_cq-&gt;in
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sw_cq-&gt;out
op_eq
id|sw_cq-&gt;in
)paren
r_break
suffix:semicolon
)brace
)brace
)brace
)brace
DECL|function|soc_request
r_static
r_void
r_inline
id|soc_request
(paren
r_struct
id|soc
op_star
id|s
comma
id|u32
id|cmd
)paren
(brace
id|SOC_SETIMASK
c_func
(paren
id|s
comma
id|s-&gt;imask
op_amp
op_complement
(paren
id|cmd
op_amp
id|SOC_CMD_REQ_QALL
)paren
)paren
suffix:semicolon
id|SOD
c_func
(paren
(paren
l_string|&quot;imask %08lx %08lx&bslash;n&quot;
comma
id|s-&gt;imask
comma
id|sbus_readl
c_func
(paren
id|s-&gt;regs
op_plus
id|IMASK
)paren
)paren
)paren
suffix:semicolon
id|SOD
c_func
(paren
(paren
l_string|&quot;Queues available %08x OUT %X %X&bslash;n&quot;
comma
id|cmd
comma
id|xram_get_8
c_func
(paren
(paren
id|xram_p
)paren
op_amp
id|s-&gt;req
(braket
l_int|0
)braket
dot
id|hw_cq-&gt;out
)paren
comma
id|xram_get_8
c_func
(paren
(paren
id|xram_p
)paren
op_amp
id|s-&gt;req
(braket
l_int|0
)braket
dot
id|hw_cq-&gt;out
)paren
)paren
)paren
r_if
c_cond
(paren
id|s-&gt;port
(braket
id|s-&gt;curr_port
)braket
dot
id|fc.state
op_ne
id|FC_STATE_OFFLINE
)paren
(brace
id|fcp_queue_empty
(paren
(paren
id|fc_channel
op_star
)paren
op_amp
(paren
id|s-&gt;port
(braket
id|s-&gt;curr_port
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|s-&gt;req
(braket
l_int|1
)braket
dot
id|in
op_plus
l_int|1
)paren
op_amp
id|s-&gt;req
(braket
l_int|1
)braket
dot
id|last
)paren
op_ne
(paren
id|s-&gt;req
(braket
l_int|1
)braket
dot
id|out
)paren
)paren
id|fcp_queue_empty
(paren
(paren
id|fc_channel
op_star
)paren
op_amp
(paren
id|s-&gt;port
(braket
l_int|1
op_minus
id|s-&gt;curr_port
)braket
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|fcp_queue_empty
(paren
(paren
id|fc_channel
op_star
)paren
op_amp
(paren
id|s-&gt;port
(braket
l_int|1
op_minus
id|s-&gt;curr_port
)braket
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s-&gt;port
(braket
l_int|1
op_minus
id|s-&gt;curr_port
)braket
dot
id|fc.state
op_ne
id|FC_STATE_OFFLINE
)paren
id|s-&gt;curr_port
op_xor_assign
l_int|1
suffix:semicolon
)brace
DECL|function|soc_unsolicited
r_static
r_void
r_inline
id|soc_unsolicited
(paren
r_struct
id|soc
op_star
id|s
)paren
(brace
id|soc_rsp
op_star
id|hwrsp
comma
op_star
id|hwrspc
suffix:semicolon
id|soc_cq
op_star
id|sw_cq
suffix:semicolon
r_int
id|count
suffix:semicolon
r_int
id|status
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|fc_channel
op_star
id|fc
suffix:semicolon
id|sw_cq
op_assign
op_amp
id|s-&gt;rsp
(braket
id|SOC_UNSOLICITED_RSP_Q
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sw_cq-&gt;pool
op_eq
l_int|NULL
)paren
id|sw_cq-&gt;pool
op_assign
(paren
id|soc_req
op_star
)paren
(paren
id|s-&gt;xram
op_plus
(paren
id|xram_get_32low
(paren
(paren
id|xram_p
)paren
op_amp
id|sw_cq-&gt;hw_cq-&gt;address
)paren
)paren
)paren
suffix:semicolon
id|sw_cq-&gt;in
op_assign
id|xram_get_8
(paren
(paren
id|xram_p
)paren
op_amp
id|sw_cq-&gt;hw_cq-&gt;in
)paren
suffix:semicolon
id|SOD
(paren
(paren
l_string|&quot;soc_unsolicited, %d packets arrived&bslash;n&quot;
comma
(paren
id|sw_cq-&gt;in
op_minus
id|sw_cq-&gt;out
)paren
op_amp
id|sw_cq-&gt;last
)paren
)paren
r_while
c_loop
(paren
id|sw_cq-&gt;in
op_ne
id|sw_cq-&gt;out
)paren
(brace
multiline_comment|/* ...real work per entry here... */
id|hwrsp
op_assign
(paren
id|soc_rsp
op_star
)paren
id|sw_cq-&gt;pool
op_plus
id|sw_cq-&gt;out
suffix:semicolon
id|hwrspc
op_assign
l_int|NULL
suffix:semicolon
id|flags
op_assign
id|xram_get_16
(paren
(paren
id|xram_p
)paren
op_amp
id|hwrsp-&gt;shdr.flags
)paren
suffix:semicolon
id|count
op_assign
id|xram_get_8
(paren
(paren
id|xram_p
)paren
op_amp
id|hwrsp-&gt;count
)paren
suffix:semicolon
id|fc
op_assign
(paren
id|fc_channel
op_star
)paren
op_amp
id|s-&gt;port
(braket
id|flags
op_amp
id|SOC_PORT_B
)braket
suffix:semicolon
id|SOD
c_func
(paren
(paren
l_string|&quot;FC %08lx fcp_state_change %08lx&bslash;n&quot;
comma
(paren
r_int
)paren
id|fc
comma
(paren
r_int
)paren
id|fc-&gt;fcp_state_change
)paren
)paren
r_if
c_cond
(paren
id|count
op_ne
l_int|1
)paren
(brace
multiline_comment|/* Ugh, continuation entries */
id|u8
id|in
suffix:semicolon
r_if
c_cond
(paren
id|count
op_ne
l_int|2
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Too many continuations entries %d&bslash;n&quot;
comma
id|fc-&gt;name
comma
id|count
)paren
suffix:semicolon
r_goto
id|update_out
suffix:semicolon
)brace
id|in
op_assign
id|sw_cq-&gt;in
suffix:semicolon
r_if
c_cond
(paren
id|in
OL
id|sw_cq-&gt;out
)paren
id|in
op_add_assign
id|sw_cq-&gt;last
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|in
OL
id|sw_cq-&gt;out
op_plus
l_int|2
)paren
(brace
multiline_comment|/* Ask the hardware if they haven&squot;t arrived yet. */
id|sbus_writel
c_func
(paren
(paren
id|sw_cq-&gt;out
op_lshift
l_int|24
)paren
op_or
(paren
id|SOC_CMD_RSP_QALL
op_amp
op_complement
(paren
id|SOC_CMD_RSP_Q0
op_lshift
id|SOC_UNSOLICITED_RSP_Q
)paren
)paren
comma
id|s-&gt;regs
op_plus
id|CMD
)paren
suffix:semicolon
multiline_comment|/* Read it, so that we&squot;re sure it has been updated */
id|sbus_readl
c_func
(paren
id|s-&gt;regs
op_plus
id|CMD
)paren
suffix:semicolon
id|sw_cq-&gt;in
op_assign
id|xram_get_8
(paren
(paren
id|xram_p
)paren
op_amp
id|sw_cq-&gt;hw_cq-&gt;in
)paren
suffix:semicolon
id|in
op_assign
id|sw_cq-&gt;in
suffix:semicolon
r_if
c_cond
(paren
id|in
OL
id|sw_cq-&gt;out
)paren
id|in
op_add_assign
id|sw_cq-&gt;last
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|in
OL
id|sw_cq-&gt;out
op_plus
l_int|2
)paren
multiline_comment|/* Nothing came, let us wait */
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sw_cq-&gt;out
op_eq
id|sw_cq-&gt;last
)paren
id|hwrspc
op_assign
(paren
id|soc_rsp
op_star
)paren
id|sw_cq-&gt;pool
suffix:semicolon
r_else
id|hwrspc
op_assign
id|hwrsp
op_plus
l_int|1
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|flags
op_amp
op_complement
id|SOC_PORT_B
)paren
(brace
r_case
id|SOC_STATUS
suffix:colon
id|status
op_assign
id|xram_get_32low
(paren
(paren
id|xram_p
)paren
op_amp
id|hwrsp-&gt;status
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|status
)paren
(brace
r_case
id|SOC_ONLINE
suffix:colon
id|SOD
c_func
(paren
(paren
l_string|&quot;State change to ONLINE&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|fcp_state_change
c_func
(paren
id|fc
comma
id|FC_STATE_ONLINE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOC_OFFLINE
suffix:colon
id|SOD
c_func
(paren
(paren
l_string|&quot;State change to OFFLINE&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|fcp_state_change
c_func
(paren
id|fc
comma
id|FC_STATE_OFFLINE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
l_string|&quot;%s: Unknown STATUS no %d&bslash;n&quot;
comma
id|fc-&gt;name
comma
id|status
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
(paren
id|SOC_UNSOLICITED
op_or
id|SOC_FC_HDR
)paren
suffix:colon
(brace
r_int
id|r_ctl
op_assign
id|xram_get_8
(paren
(paren
id|xram_p
)paren
op_amp
id|hwrsp-&gt;fchdr
)paren
suffix:semicolon
r_int
id|len
suffix:semicolon
r_char
id|buf
(braket
l_int|64
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|r_ctl
op_amp
l_int|0xf0
)paren
op_eq
id|R_CTL_EXTENDED_SVC
)paren
(brace
id|len
op_assign
id|xram_get_32
(paren
(paren
id|xram_p
)paren
op_amp
id|hwrsp-&gt;shdr.bytecnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|4
op_logical_or
op_logical_neg
id|hwrspc
)paren
(brace
id|printk
(paren
l_string|&quot;%s: Invalid R_CTL %02x &quot;
l_string|&quot;continuation entries&bslash;n&quot;
comma
id|fc-&gt;name
comma
id|r_ctl
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|len
OG
l_int|60
)paren
id|len
op_assign
l_int|60
suffix:semicolon
id|xram_copy_from
(paren
id|buf
comma
(paren
id|xram_p
)paren
id|hwrspc
comma
(paren
id|len
op_plus
l_int|3
)paren
op_amp
op_complement
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
(paren
id|u32
op_star
)paren
id|buf
op_eq
id|LS_DISPLAY
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|4
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|buf
(braket
id|i
)braket
op_eq
l_char|&squot;&bslash;n&squot;
)paren
id|buf
(braket
id|i
)braket
op_assign
l_char|&squot; &squot;
suffix:semicolon
id|buf
(braket
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|printk
(paren
l_string|&quot;%s message: %s&bslash;n&quot;
comma
id|fc-&gt;name
comma
id|buf
op_plus
l_int|4
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
(paren
l_string|&quot;%s: Unknown LS_CMD &quot;
l_string|&quot;%02x&bslash;n&quot;
comma
id|fc-&gt;name
comma
id|buf
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|printk
(paren
l_string|&quot;%s: Unsolicited R_CTL %02x &quot;
l_string|&quot;not handled&bslash;n&quot;
comma
id|fc-&gt;name
comma
id|r_ctl
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
l_string|&quot;%s: Unexpected flags %08x&bslash;n&quot;
comma
id|fc-&gt;name
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
id|update_out
suffix:colon
r_if
c_cond
(paren
op_increment
id|sw_cq-&gt;out
OG
id|sw_cq-&gt;last
)paren
(brace
id|sw_cq-&gt;seqno
op_increment
suffix:semicolon
id|sw_cq-&gt;out
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hwrspc
)paren
(brace
r_if
c_cond
(paren
op_increment
id|sw_cq-&gt;out
OG
id|sw_cq-&gt;last
)paren
(brace
id|sw_cq-&gt;seqno
op_increment
suffix:semicolon
id|sw_cq-&gt;out
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|sw_cq-&gt;out
op_eq
id|sw_cq-&gt;in
)paren
(brace
id|sw_cq-&gt;in
op_assign
id|xram_get_8
(paren
(paren
id|xram_p
)paren
op_amp
id|sw_cq-&gt;hw_cq-&gt;in
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sw_cq-&gt;out
op_eq
id|sw_cq-&gt;in
)paren
(brace
multiline_comment|/* Tell the hardware about it */
id|sbus_writel
c_func
(paren
(paren
id|sw_cq-&gt;out
op_lshift
l_int|24
)paren
op_or
(paren
id|SOC_CMD_RSP_QALL
op_amp
op_complement
(paren
id|SOC_CMD_RSP_Q0
op_lshift
id|SOC_UNSOLICITED_RSP_Q
)paren
)paren
comma
id|s-&gt;regs
op_plus
id|CMD
)paren
suffix:semicolon
multiline_comment|/* Read it, so that we&squot;re sure it has been updated */
id|sbus_readl
c_func
(paren
id|s-&gt;regs
op_plus
id|CMD
)paren
suffix:semicolon
id|sw_cq-&gt;in
op_assign
id|xram_get_8
(paren
(paren
id|xram_p
)paren
op_amp
id|sw_cq-&gt;hw_cq-&gt;in
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
DECL|function|soc_intr
r_static
r_void
id|soc_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|u32
id|cmd
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_register
r_struct
id|soc
op_star
id|s
op_assign
(paren
r_struct
id|soc
op_star
)paren
id|dev_id
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
id|cmd
op_assign
id|sbus_readl
c_func
(paren
id|s-&gt;regs
op_plus
id|CMD
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
(paren
id|cmd
op_assign
id|SOC_INTR
(paren
id|s
comma
id|cmd
)paren
)paren
suffix:semicolon
id|cmd
op_assign
id|sbus_readl
c_func
(paren
id|s-&gt;regs
op_plus
id|CMD
)paren
)paren
(brace
r_if
c_cond
(paren
id|cmd
op_amp
id|SOC_CMD_RSP_Q1
)paren
id|soc_unsolicited
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_amp
id|SOC_CMD_RSP_Q0
)paren
id|soc_solicited
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_amp
id|SOC_CMD_REQ_QALL
)paren
id|soc_request
(paren
id|s
comma
id|cmd
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|macro|TOKEN
mdefine_line|#define TOKEN(proto, port, token) (((proto)&lt;&lt;12)|(token)|(port))
DECL|function|soc_hw_enque
r_static
r_int
id|soc_hw_enque
(paren
id|fc_channel
op_star
id|fc
comma
id|fcp_cmnd
op_star
id|fcmd
)paren
(brace
id|soc_port
op_star
id|port
op_assign
(paren
id|soc_port
op_star
)paren
id|fc
suffix:semicolon
r_struct
id|soc
op_star
id|s
op_assign
id|port-&gt;s
suffix:semicolon
r_int
id|qno
suffix:semicolon
id|soc_cq
op_star
id|sw_cq
suffix:semicolon
r_int
id|cq_next_in
suffix:semicolon
id|soc_req
op_star
id|request
suffix:semicolon
id|fc_hdr
op_star
id|fch
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|fcmd-&gt;proto
op_eq
id|TYPE_SCSI_FCP
)paren
id|qno
op_assign
l_int|1
suffix:semicolon
r_else
id|qno
op_assign
l_int|0
suffix:semicolon
id|SOD
c_func
(paren
(paren
l_string|&quot;Putting a FCP packet type %d into hw queue %d&bslash;n&quot;
comma
id|fcmd-&gt;proto
comma
id|qno
)paren
)paren
r_if
c_cond
(paren
id|s-&gt;imask
op_amp
(paren
id|SOC_IMASK_REQ_Q0
op_lshift
id|qno
)paren
)paren
(brace
id|SOD
c_func
(paren
(paren
l_string|&quot;EIO %08x&bslash;n&quot;
comma
id|s-&gt;imask
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|sw_cq
op_assign
id|s-&gt;req
op_plus
id|qno
suffix:semicolon
id|cq_next_in
op_assign
(paren
id|sw_cq-&gt;in
op_plus
l_int|1
)paren
op_amp
id|sw_cq-&gt;last
suffix:semicolon
r_if
c_cond
(paren
id|cq_next_in
op_eq
id|sw_cq-&gt;out
op_logical_and
id|cq_next_in
op_eq
(paren
id|sw_cq-&gt;out
op_assign
id|xram_get_8
c_func
(paren
(paren
id|xram_p
)paren
op_amp
id|sw_cq-&gt;hw_cq-&gt;out
)paren
)paren
)paren
(brace
id|SOD
c_func
(paren
(paren
l_string|&quot;%d IN %d OUT %d LAST %d&bslash;n&quot;
comma
id|qno
comma
id|sw_cq-&gt;in
comma
id|sw_cq-&gt;out
comma
id|sw_cq-&gt;last
)paren
)paren
id|SOC_SETIMASK
c_func
(paren
id|s
comma
id|s-&gt;imask
op_or
(paren
id|SOC_IMASK_REQ_Q0
op_lshift
id|qno
)paren
)paren
suffix:semicolon
id|SOD
c_func
(paren
(paren
l_string|&quot;imask %08lx %08lx&bslash;n&quot;
comma
id|s-&gt;imask
comma
id|sbus_readl
c_func
(paren
id|s-&gt;regs
op_plus
id|IMASK
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* If queue is full, just say NO */
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|request
op_assign
id|sw_cq-&gt;pool
op_plus
id|sw_cq-&gt;in
suffix:semicolon
id|fch
op_assign
op_amp
id|request-&gt;fchdr
suffix:semicolon
r_switch
c_cond
(paren
id|fcmd-&gt;proto
)paren
(brace
r_case
id|TYPE_SCSI_FCP
suffix:colon
id|request-&gt;shdr.token
op_assign
id|TOKEN
c_func
(paren
id|TYPE_SCSI_FCP
comma
id|port-&gt;mask
comma
id|fcmd-&gt;token
)paren
suffix:semicolon
id|request-&gt;data
(braket
l_int|0
)braket
dot
id|base
op_assign
id|fc-&gt;dma_scsi_cmd
op_plus
id|fcmd-&gt;token
op_star
r_sizeof
(paren
id|fcp_cmd
)paren
suffix:semicolon
id|request-&gt;data
(braket
l_int|0
)braket
dot
id|count
op_assign
r_sizeof
(paren
id|fcp_cmd
)paren
suffix:semicolon
id|request-&gt;data
(braket
l_int|1
)braket
dot
id|base
op_assign
id|fc-&gt;dma_scsi_rsp
op_plus
id|fcmd-&gt;token
op_star
id|fc-&gt;rsp_size
suffix:semicolon
id|request-&gt;data
(braket
l_int|1
)braket
dot
id|count
op_assign
id|fc-&gt;rsp_size
suffix:semicolon
r_if
c_cond
(paren
id|fcmd-&gt;data
)paren
(brace
id|request-&gt;shdr.segcnt
op_assign
l_int|3
suffix:semicolon
id|i
op_assign
id|fc-&gt;scsi_cmd_pool
(braket
id|fcmd-&gt;token
)braket
dot
id|fcp_data_len
suffix:semicolon
id|request-&gt;shdr.bytecnt
op_assign
id|i
suffix:semicolon
id|request-&gt;data
(braket
l_int|2
)braket
dot
id|base
op_assign
id|fcmd-&gt;data
suffix:semicolon
id|request-&gt;data
(braket
l_int|2
)braket
dot
id|count
op_assign
id|i
suffix:semicolon
id|request-&gt;type
op_assign
(paren
id|fc-&gt;scsi_cmd_pool
(braket
id|fcmd-&gt;token
)braket
dot
id|fcp_cntl
op_amp
id|FCP_CNTL_WRITE
)paren
ques
c_cond
id|SOC_CQTYPE_IO_WRITE
suffix:colon
id|SOC_CQTYPE_IO_READ
suffix:semicolon
)brace
r_else
(brace
id|request-&gt;shdr.segcnt
op_assign
l_int|2
suffix:semicolon
id|request-&gt;shdr.bytecnt
op_assign
l_int|0
suffix:semicolon
id|request-&gt;data
(braket
l_int|2
)braket
dot
id|base
op_assign
l_int|0
suffix:semicolon
id|request-&gt;data
(braket
l_int|2
)braket
dot
id|count
op_assign
l_int|0
suffix:semicolon
id|request-&gt;type
op_assign
id|SOC_CQTYPE_SIMPLE
suffix:semicolon
)brace
id|FILL_FCHDR_RCTL_DID
c_func
(paren
id|fch
comma
id|R_CTL_COMMAND
comma
id|fc-&gt;did
)paren
suffix:semicolon
id|FILL_FCHDR_SID
c_func
(paren
id|fch
comma
id|fc-&gt;sid
)paren
suffix:semicolon
id|FILL_FCHDR_TYPE_FCTL
c_func
(paren
id|fch
comma
id|TYPE_SCSI_FCP
comma
id|F_CTL_FIRST_SEQ
op_or
id|F_CTL_SEQ_INITIATIVE
)paren
suffix:semicolon
id|FILL_FCHDR_SEQ_DF_SEQ
c_func
(paren
id|fch
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|FILL_FCHDR_OXRX
c_func
(paren
id|fch
comma
l_int|0xffff
comma
l_int|0xffff
)paren
suffix:semicolon
id|fch-&gt;param
op_assign
l_int|0
suffix:semicolon
id|request-&gt;shdr.flags
op_assign
id|port-&gt;flags
suffix:semicolon
id|request-&gt;shdr
dot
r_class
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PROTO_OFFLINE
suffix:colon
id|memset
(paren
id|request
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|request
)paren
)paren
suffix:semicolon
id|request-&gt;shdr.token
op_assign
id|TOKEN
c_func
(paren
id|PROTO_OFFLINE
comma
id|port-&gt;mask
comma
id|fcmd-&gt;token
)paren
suffix:semicolon
id|request-&gt;type
op_assign
id|SOC_CQTYPE_OFFLINE
suffix:semicolon
id|FILL_FCHDR_RCTL_DID
c_func
(paren
id|fch
comma
id|R_CTL_COMMAND
comma
id|fc-&gt;did
)paren
suffix:semicolon
id|FILL_FCHDR_SID
c_func
(paren
id|fch
comma
id|fc-&gt;sid
)paren
suffix:semicolon
id|FILL_FCHDR_TYPE_FCTL
c_func
(paren
id|fch
comma
id|TYPE_SCSI_FCP
comma
id|F_CTL_FIRST_SEQ
op_or
id|F_CTL_SEQ_INITIATIVE
)paren
suffix:semicolon
id|FILL_FCHDR_SEQ_DF_SEQ
c_func
(paren
id|fch
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|FILL_FCHDR_OXRX
c_func
(paren
id|fch
comma
l_int|0xffff
comma
l_int|0xffff
)paren
suffix:semicolon
id|request-&gt;shdr.flags
op_assign
id|port-&gt;flags
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PROTO_REPORT_AL_MAP
suffix:colon
multiline_comment|/* SOC only supports Point-to-Point topology, no FC-AL, sorry... */
r_return
op_minus
id|ENOSYS
suffix:semicolon
r_default
suffix:colon
id|request-&gt;shdr.token
op_assign
id|TOKEN
c_func
(paren
id|fcmd-&gt;proto
comma
id|port-&gt;mask
comma
id|fcmd-&gt;token
)paren
suffix:semicolon
id|request-&gt;shdr
dot
r_class
op_assign
l_int|2
suffix:semicolon
id|request-&gt;shdr.flags
op_assign
id|port-&gt;flags
suffix:semicolon
id|memcpy
(paren
id|fch
comma
op_amp
id|fcmd-&gt;fch
comma
r_sizeof
(paren
id|fc_hdr
)paren
)paren
suffix:semicolon
id|request-&gt;data
(braket
l_int|0
)braket
dot
id|count
op_assign
id|fcmd-&gt;cmdlen
suffix:semicolon
id|request-&gt;data
(braket
l_int|1
)braket
dot
id|count
op_assign
id|fcmd-&gt;rsplen
suffix:semicolon
id|request-&gt;type
op_assign
id|fcmd
op_member_access_from_pointer
r_class
suffix:semicolon
r_switch
c_cond
(paren
id|fcmd
op_member_access_from_pointer
r_class
)paren
(brace
r_case
id|FC_CLASS_OUTBOUND
suffix:colon
id|request-&gt;data
(braket
l_int|0
)braket
dot
id|base
op_assign
id|fcmd-&gt;cmd
suffix:semicolon
id|request-&gt;data
(braket
l_int|0
)braket
dot
id|count
op_assign
id|fcmd-&gt;cmdlen
suffix:semicolon
id|request-&gt;type
op_assign
id|SOC_CQTYPE_OUTBOUND
suffix:semicolon
id|request-&gt;shdr.bytecnt
op_assign
id|fcmd-&gt;cmdlen
suffix:semicolon
id|request-&gt;shdr.segcnt
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FC_CLASS_INBOUND
suffix:colon
id|request-&gt;data
(braket
l_int|0
)braket
dot
id|base
op_assign
id|fcmd-&gt;rsp
suffix:semicolon
id|request-&gt;data
(braket
l_int|0
)braket
dot
id|count
op_assign
id|fcmd-&gt;rsplen
suffix:semicolon
id|request-&gt;type
op_assign
id|SOC_CQTYPE_INBOUND
suffix:semicolon
id|request-&gt;shdr.bytecnt
op_assign
l_int|0
suffix:semicolon
id|request-&gt;shdr.segcnt
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FC_CLASS_SIMPLE
suffix:colon
id|request-&gt;data
(braket
l_int|0
)braket
dot
id|base
op_assign
id|fcmd-&gt;cmd
suffix:semicolon
id|request-&gt;data
(braket
l_int|1
)braket
dot
id|base
op_assign
id|fcmd-&gt;rsp
suffix:semicolon
id|request-&gt;data
(braket
l_int|0
)braket
dot
id|count
op_assign
id|fcmd-&gt;cmdlen
suffix:semicolon
id|request-&gt;data
(braket
l_int|1
)braket
dot
id|count
op_assign
id|fcmd-&gt;rsplen
suffix:semicolon
id|request-&gt;type
op_assign
id|SOC_CQTYPE_SIMPLE
suffix:semicolon
id|request-&gt;shdr.bytecnt
op_assign
id|fcmd-&gt;cmdlen
suffix:semicolon
id|request-&gt;shdr.segcnt
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FC_CLASS_IO_READ
suffix:colon
r_case
id|FC_CLASS_IO_WRITE
suffix:colon
id|request-&gt;data
(braket
l_int|0
)braket
dot
id|base
op_assign
id|fcmd-&gt;cmd
suffix:semicolon
id|request-&gt;data
(braket
l_int|1
)braket
dot
id|base
op_assign
id|fcmd-&gt;rsp
suffix:semicolon
id|request-&gt;data
(braket
l_int|0
)braket
dot
id|count
op_assign
id|fcmd-&gt;cmdlen
suffix:semicolon
id|request-&gt;data
(braket
l_int|1
)braket
dot
id|count
op_assign
id|fcmd-&gt;rsplen
suffix:semicolon
id|request-&gt;type
op_assign
(paren
id|fcmd
op_member_access_from_pointer
r_class
op_eq
id|FC_CLASS_IO_READ
)paren
ques
c_cond
id|SOC_CQTYPE_IO_READ
suffix:colon
id|SOC_CQTYPE_IO_WRITE
suffix:semicolon
r_if
c_cond
(paren
id|fcmd-&gt;data
)paren
(brace
id|request-&gt;data
(braket
l_int|2
)braket
dot
id|base
op_assign
id|fcmd-&gt;data
suffix:semicolon
id|request-&gt;data
(braket
l_int|2
)braket
dot
id|count
op_assign
id|fcmd-&gt;datalen
suffix:semicolon
id|request-&gt;shdr.bytecnt
op_assign
id|fcmd-&gt;datalen
suffix:semicolon
id|request-&gt;shdr.segcnt
op_assign
l_int|3
suffix:semicolon
)brace
r_else
(brace
id|request-&gt;shdr.bytecnt
op_assign
l_int|0
suffix:semicolon
id|request-&gt;shdr.segcnt
op_assign
l_int|2
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
id|request-&gt;count
op_assign
l_int|1
suffix:semicolon
id|request-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|request-&gt;seqno
op_assign
id|sw_cq-&gt;seqno
suffix:semicolon
multiline_comment|/* And now tell the SOC about it */
r_if
c_cond
(paren
op_increment
id|sw_cq-&gt;in
OG
id|sw_cq-&gt;last
)paren
(brace
id|sw_cq-&gt;in
op_assign
l_int|0
suffix:semicolon
id|sw_cq-&gt;seqno
op_increment
suffix:semicolon
)brace
id|SOD
c_func
(paren
(paren
l_string|&quot;Putting %08x into cmd&bslash;n&quot;
comma
id|SOC_CMD_RSP_QALL
op_or
(paren
id|sw_cq-&gt;in
op_lshift
l_int|24
)paren
op_or
(paren
id|SOC_CMD_REQ_Q0
op_lshift
id|qno
)paren
)paren
)paren
id|sbus_writel
c_func
(paren
id|SOC_CMD_RSP_QALL
op_or
(paren
id|sw_cq-&gt;in
op_lshift
l_int|24
)paren
op_or
(paren
id|SOC_CMD_REQ_Q0
op_lshift
id|qno
)paren
comma
id|s-&gt;regs
op_plus
id|CMD
)paren
suffix:semicolon
multiline_comment|/* Read so that command is completed. */
id|sbus_readl
c_func
(paren
id|s-&gt;regs
op_plus
id|CMD
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|soc_download_fw
r_static
r_inline
r_void
id|soc_download_fw
c_func
(paren
r_struct
id|soc
op_star
id|s
)paren
(brace
macro_line|#ifdef HAVE_SOC_UCODE
id|xram_copy_to
(paren
id|s-&gt;xram
comma
id|soc_ucode
comma
r_sizeof
(paren
id|soc_ucode
)paren
)paren
suffix:semicolon
id|xram_bzero
(paren
id|s-&gt;xram
op_plus
r_sizeof
(paren
id|soc_ucode
)paren
comma
l_int|32768
op_minus
r_sizeof
(paren
id|soc_ucode
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Check for what the best SBUS burst we can use happens&n; * to be on this machine.&n; */
DECL|function|soc_init_bursts
r_static
r_inline
r_void
id|soc_init_bursts
c_func
(paren
r_struct
id|soc
op_star
id|s
comma
r_struct
id|sbus_dev
op_star
id|sdev
)paren
(brace
r_int
id|bsizes
comma
id|bsizes_more
suffix:semicolon
id|bsizes
op_assign
(paren
id|prom_getintdefault
c_func
(paren
id|sdev-&gt;prom_node
comma
l_string|&quot;burst-sizes&quot;
comma
l_int|0xff
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|bsizes_more
op_assign
(paren
id|prom_getintdefault
c_func
(paren
id|sdev-&gt;bus-&gt;prom_node
comma
l_string|&quot;burst-sizes&quot;
comma
l_int|0xff
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|bsizes
op_and_assign
id|bsizes_more
suffix:semicolon
r_if
c_cond
(paren
(paren
id|bsizes
op_amp
l_int|0x7f
)paren
op_eq
l_int|0x7f
)paren
id|s-&gt;cfg
op_assign
id|SOC_CFG_BURST_64
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|bsizes
op_amp
l_int|0x3f
)paren
op_eq
l_int|0x3f
)paren
id|s-&gt;cfg
op_assign
id|SOC_CFG_BURST_32
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|bsizes
op_amp
l_int|0x1f
)paren
op_eq
l_int|0x1f
)paren
id|s-&gt;cfg
op_assign
id|SOC_CFG_BURST_16
suffix:semicolon
r_else
id|s-&gt;cfg
op_assign
id|SOC_CFG_BURST_4
suffix:semicolon
)brace
DECL|function|soc_init
r_static
r_inline
r_void
id|soc_init
c_func
(paren
r_struct
id|sbus_dev
op_star
id|sdev
comma
r_int
id|no
)paren
(brace
r_int
r_char
id|tmp
(braket
l_int|60
)braket
suffix:semicolon
r_int
id|propl
suffix:semicolon
r_struct
id|soc
op_star
id|s
suffix:semicolon
r_static
r_int
id|version_printed
op_assign
l_int|0
suffix:semicolon
id|soc_hw_cq
id|cq
(braket
l_int|8
)braket
suffix:semicolon
r_int
id|size
comma
id|i
suffix:semicolon
r_int
id|irq
suffix:semicolon
id|s
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|soc
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|memset
(paren
id|s
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|soc
)paren
)paren
suffix:semicolon
id|s-&gt;soc_no
op_assign
id|no
suffix:semicolon
id|SOD
c_func
(paren
(paren
l_string|&quot;socs %08lx soc_intr %08lx soc_hw_enque %08x&bslash;n&quot;
comma
(paren
r_int
)paren
id|socs
comma
(paren
r_int
)paren
id|soc_intr
comma
(paren
r_int
)paren
id|soc_hw_enque
)paren
)paren
r_if
c_cond
(paren
id|version_printed
op_increment
op_eq
l_int|0
)paren
id|printk
(paren
id|version
)paren
suffix:semicolon
macro_line|#ifdef MODULE
id|s-&gt;port
(braket
l_int|0
)braket
dot
id|fc.module
op_assign
op_amp
id|__this_module
suffix:semicolon
id|s-&gt;port
(braket
l_int|1
)braket
dot
id|fc.module
op_assign
op_amp
id|__this_module
suffix:semicolon
macro_line|#else
id|s-&gt;port
(braket
l_int|0
)braket
dot
id|fc.module
op_assign
l_int|NULL
suffix:semicolon
id|s-&gt;port
(braket
l_int|1
)braket
dot
id|fc.module
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
id|s-&gt;next
op_assign
id|socs
suffix:semicolon
id|socs
op_assign
id|s
suffix:semicolon
id|s-&gt;port
(braket
l_int|0
)braket
dot
id|fc.dev
op_assign
id|sdev
suffix:semicolon
id|s-&gt;port
(braket
l_int|1
)braket
dot
id|fc.dev
op_assign
id|sdev
suffix:semicolon
id|s-&gt;port
(braket
l_int|0
)braket
dot
id|s
op_assign
id|s
suffix:semicolon
id|s-&gt;port
(braket
l_int|1
)braket
dot
id|s
op_assign
id|s
suffix:semicolon
id|s-&gt;port
(braket
l_int|0
)braket
dot
id|fc.next
op_assign
op_amp
id|s-&gt;port
(braket
l_int|1
)braket
dot
id|fc
suffix:semicolon
multiline_comment|/* World Wide Name of SOC */
id|propl
op_assign
id|prom_getproperty
(paren
id|sdev-&gt;prom_node
comma
l_string|&quot;soc-wwn&quot;
comma
id|tmp
comma
r_sizeof
(paren
id|tmp
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|propl
op_ne
r_sizeof
(paren
id|fc_wwn
)paren
)paren
(brace
id|s-&gt;wwn.naaid
op_assign
id|NAAID_IEEE
suffix:semicolon
id|s-&gt;wwn.lo
op_assign
l_int|0x12345678
suffix:semicolon
)brace
r_else
id|memcpy
(paren
op_amp
id|s-&gt;wwn
comma
id|tmp
comma
r_sizeof
(paren
id|fc_wwn
)paren
)paren
suffix:semicolon
id|propl
op_assign
id|prom_getproperty
(paren
id|sdev-&gt;prom_node
comma
l_string|&quot;port-wwns&quot;
comma
id|tmp
comma
r_sizeof
(paren
id|tmp
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|propl
op_ne
l_int|2
op_star
r_sizeof
(paren
id|fc_wwn
)paren
)paren
(brace
id|s-&gt;port
(braket
l_int|0
)braket
dot
id|fc.wwn_nport.naaid
op_assign
id|NAAID_IEEE_EXT
suffix:semicolon
id|s-&gt;port
(braket
l_int|0
)braket
dot
id|fc.wwn_nport.hi
op_assign
id|s-&gt;wwn.hi
suffix:semicolon
id|s-&gt;port
(braket
l_int|0
)braket
dot
id|fc.wwn_nport.lo
op_assign
id|s-&gt;wwn.lo
suffix:semicolon
id|s-&gt;port
(braket
l_int|1
)braket
dot
id|fc.wwn_nport.naaid
op_assign
id|NAAID_IEEE_EXT
suffix:semicolon
id|s-&gt;port
(braket
l_int|1
)braket
dot
id|fc.wwn_nport.nportid
op_assign
l_int|1
suffix:semicolon
id|s-&gt;port
(braket
l_int|1
)braket
dot
id|fc.wwn_nport.hi
op_assign
id|s-&gt;wwn.hi
suffix:semicolon
id|s-&gt;port
(braket
l_int|1
)braket
dot
id|fc.wwn_nport.lo
op_assign
id|s-&gt;wwn.lo
suffix:semicolon
)brace
r_else
(brace
id|memcpy
(paren
op_amp
id|s-&gt;port
(braket
l_int|0
)braket
dot
id|fc.wwn_nport
comma
id|tmp
comma
r_sizeof
(paren
id|fc_wwn
)paren
)paren
suffix:semicolon
id|memcpy
(paren
op_amp
id|s-&gt;port
(braket
l_int|1
)braket
dot
id|fc.wwn_nport
comma
id|tmp
op_plus
r_sizeof
(paren
id|fc_wwn
)paren
comma
r_sizeof
(paren
id|fc_wwn
)paren
)paren
suffix:semicolon
)brace
id|memcpy
(paren
op_amp
id|s-&gt;port
(braket
l_int|0
)braket
dot
id|fc.wwn_node
comma
op_amp
id|s-&gt;wwn
comma
r_sizeof
(paren
id|fc_wwn
)paren
)paren
suffix:semicolon
id|memcpy
(paren
op_amp
id|s-&gt;port
(braket
l_int|1
)braket
dot
id|fc.wwn_node
comma
op_amp
id|s-&gt;wwn
comma
r_sizeof
(paren
id|fc_wwn
)paren
)paren
suffix:semicolon
id|SOD
c_func
(paren
(paren
l_string|&quot;Got wwns %08x%08x ports %08x%08x and %08x%08x&bslash;n&quot;
comma
op_star
(paren
id|u32
op_star
)paren
op_amp
id|s-&gt;port
(braket
l_int|0
)braket
dot
id|fc.wwn_nport
comma
id|s-&gt;port
(braket
l_int|0
)braket
dot
id|fc.wwn_nport.lo
comma
op_star
(paren
id|u32
op_star
)paren
op_amp
id|s-&gt;port
(braket
l_int|0
)braket
dot
id|fc.wwn_nport
comma
id|s-&gt;port
(braket
l_int|0
)braket
dot
id|fc.wwn_nport.lo
comma
op_star
(paren
id|u32
op_star
)paren
op_amp
id|s-&gt;port
(braket
l_int|1
)braket
dot
id|fc.wwn_nport
comma
id|s-&gt;port
(braket
l_int|1
)braket
dot
id|fc.wwn_nport.lo
)paren
)paren
id|s-&gt;port
(braket
l_int|0
)braket
dot
id|fc.sid
op_assign
l_int|1
suffix:semicolon
id|s-&gt;port
(braket
l_int|1
)braket
dot
id|fc.sid
op_assign
l_int|17
suffix:semicolon
id|s-&gt;port
(braket
l_int|0
)braket
dot
id|fc.did
op_assign
l_int|2
suffix:semicolon
id|s-&gt;port
(braket
l_int|1
)braket
dot
id|fc.did
op_assign
l_int|18
suffix:semicolon
id|s-&gt;port
(braket
l_int|0
)braket
dot
id|fc.reset
op_assign
id|soc_reset
suffix:semicolon
id|s-&gt;port
(braket
l_int|1
)braket
dot
id|fc.reset
op_assign
id|soc_reset
suffix:semicolon
r_if
c_cond
(paren
id|sdev-&gt;num_registers
op_eq
l_int|1
)paren
(brace
multiline_comment|/* Probably SunFire onboard SOC */
id|s-&gt;xram
op_assign
id|sbus_ioremap
c_func
(paren
op_amp
id|sdev-&gt;resource
(braket
l_int|0
)braket
comma
l_int|0
comma
l_int|0x10000UL
comma
l_string|&quot;soc xram&quot;
)paren
suffix:semicolon
id|s-&gt;regs
op_assign
id|sbus_ioremap
c_func
(paren
op_amp
id|sdev-&gt;resource
(braket
l_int|0
)braket
comma
l_int|0x10000UL
comma
l_int|0x10UL
comma
l_string|&quot;soc regs&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Probably SOC sbus card */
id|s-&gt;xram
op_assign
id|sbus_ioremap
c_func
(paren
op_amp
id|sdev-&gt;resource
(braket
l_int|1
)braket
comma
l_int|0
comma
id|sdev-&gt;reg_addrs
(braket
l_int|1
)braket
dot
id|reg_size
comma
l_string|&quot;soc xram&quot;
)paren
suffix:semicolon
id|s-&gt;regs
op_assign
id|sbus_ioremap
c_func
(paren
op_amp
id|sdev-&gt;resource
(braket
l_int|2
)braket
comma
l_int|0
comma
id|sdev-&gt;reg_addrs
(braket
l_int|2
)braket
dot
id|reg_size
comma
l_string|&quot;soc regs&quot;
)paren
suffix:semicolon
)brace
id|soc_init_bursts
c_func
(paren
id|s
comma
id|sdev
)paren
suffix:semicolon
id|SOD
c_func
(paren
(paren
l_string|&quot;Disabling SOC&bslash;n&quot;
)paren
)paren
id|soc_disable
(paren
id|s
)paren
suffix:semicolon
id|irq
op_assign
id|sdev-&gt;irqs
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
(paren
id|irq
comma
id|soc_intr
comma
id|SA_SHIRQ
comma
l_string|&quot;SOC&quot;
comma
(paren
r_void
op_star
)paren
id|s
)paren
)paren
(brace
id|soc_printk
(paren
l_string|&quot;Cannot order irq %d to go&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
id|socs
op_assign
id|s-&gt;next
suffix:semicolon
r_return
suffix:semicolon
)brace
id|SOD
c_func
(paren
(paren
l_string|&quot;SOC uses IRQ%s&bslash;n&quot;
comma
id|__irq_itoa
c_func
(paren
id|irq
)paren
)paren
)paren
id|s-&gt;port
(braket
l_int|0
)braket
dot
id|fc.irq
op_assign
id|irq
suffix:semicolon
id|s-&gt;port
(braket
l_int|1
)braket
dot
id|fc.irq
op_assign
id|irq
suffix:semicolon
id|sprintf
(paren
id|s-&gt;port
(braket
l_int|0
)braket
dot
id|fc.name
comma
l_string|&quot;soc%d port A&quot;
comma
id|no
)paren
suffix:semicolon
id|sprintf
(paren
id|s-&gt;port
(braket
l_int|1
)braket
dot
id|fc.name
comma
l_string|&quot;soc%d port B&quot;
comma
id|no
)paren
suffix:semicolon
id|s-&gt;port
(braket
l_int|0
)braket
dot
id|flags
op_assign
id|SOC_FC_HDR
op_or
id|SOC_PORT_A
suffix:semicolon
id|s-&gt;port
(braket
l_int|1
)braket
dot
id|flags
op_assign
id|SOC_FC_HDR
op_or
id|SOC_PORT_B
suffix:semicolon
id|s-&gt;port
(braket
l_int|1
)braket
dot
id|mask
op_assign
(paren
l_int|1
op_lshift
l_int|11
)paren
suffix:semicolon
id|s-&gt;port
(braket
l_int|0
)braket
dot
id|fc.hw_enque
op_assign
id|soc_hw_enque
suffix:semicolon
id|s-&gt;port
(braket
l_int|1
)braket
dot
id|fc.hw_enque
op_assign
id|soc_hw_enque
suffix:semicolon
id|soc_download_fw
(paren
id|s
)paren
suffix:semicolon
id|SOD
c_func
(paren
(paren
l_string|&quot;Downloaded firmware&bslash;n&quot;
)paren
)paren
multiline_comment|/* Now setup xram circular queues */
id|memset
(paren
id|cq
comma
l_int|0
comma
r_sizeof
(paren
id|cq
)paren
)paren
suffix:semicolon
id|size
op_assign
(paren
id|SOC_CQ_REQ0_SIZE
op_plus
id|SOC_CQ_REQ1_SIZE
)paren
op_star
r_sizeof
(paren
id|soc_req
)paren
suffix:semicolon
id|s-&gt;req_cpu
op_assign
id|sbus_alloc_consistent
c_func
(paren
id|sdev
comma
id|size
comma
op_amp
id|s-&gt;req_dvma
)paren
suffix:semicolon
id|s-&gt;req
(braket
l_int|0
)braket
dot
id|pool
op_assign
id|s-&gt;req_cpu
suffix:semicolon
id|cq
(braket
l_int|0
)braket
dot
id|address
op_assign
id|s-&gt;req_dvma
suffix:semicolon
id|s-&gt;req
(braket
l_int|1
)braket
dot
id|pool
op_assign
id|s-&gt;req
(braket
l_int|0
)braket
dot
id|pool
op_plus
id|SOC_CQ_REQ0_SIZE
suffix:semicolon
id|s-&gt;req
(braket
l_int|0
)braket
dot
id|hw_cq
op_assign
(paren
id|soc_hw_cq
op_star
)paren
(paren
id|s-&gt;xram
op_plus
id|SOC_CQ_REQ_OFFSET
)paren
suffix:semicolon
id|s-&gt;req
(braket
l_int|1
)braket
dot
id|hw_cq
op_assign
(paren
id|soc_hw_cq
op_star
)paren
(paren
id|s-&gt;xram
op_plus
id|SOC_CQ_REQ_OFFSET
op_plus
r_sizeof
(paren
id|soc_hw_cq
)paren
)paren
suffix:semicolon
id|s-&gt;rsp
(braket
l_int|0
)braket
dot
id|hw_cq
op_assign
(paren
id|soc_hw_cq
op_star
)paren
(paren
id|s-&gt;xram
op_plus
id|SOC_CQ_RSP_OFFSET
)paren
suffix:semicolon
id|s-&gt;rsp
(braket
l_int|1
)braket
dot
id|hw_cq
op_assign
(paren
id|soc_hw_cq
op_star
)paren
(paren
id|s-&gt;xram
op_plus
id|SOC_CQ_RSP_OFFSET
op_plus
r_sizeof
(paren
id|soc_hw_cq
)paren
)paren
suffix:semicolon
id|cq
(braket
l_int|1
)braket
dot
id|address
op_assign
id|cq
(braket
l_int|0
)braket
dot
id|address
op_plus
(paren
id|SOC_CQ_REQ0_SIZE
op_star
r_sizeof
(paren
id|soc_req
)paren
)paren
suffix:semicolon
id|cq
(braket
l_int|4
)braket
dot
id|address
op_assign
l_int|1
suffix:semicolon
id|cq
(braket
l_int|5
)braket
dot
id|address
op_assign
l_int|1
suffix:semicolon
id|cq
(braket
l_int|0
)braket
dot
id|last
op_assign
id|SOC_CQ_REQ0_SIZE
op_minus
l_int|1
suffix:semicolon
id|cq
(braket
l_int|1
)braket
dot
id|last
op_assign
id|SOC_CQ_REQ1_SIZE
op_minus
l_int|1
suffix:semicolon
id|cq
(braket
l_int|4
)braket
dot
id|last
op_assign
id|SOC_CQ_RSP0_SIZE
op_minus
l_int|1
suffix:semicolon
id|cq
(braket
l_int|5
)braket
dot
id|last
op_assign
id|SOC_CQ_RSP1_SIZE
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|cq
(braket
id|i
)braket
dot
id|seqno
op_assign
l_int|1
suffix:semicolon
id|s-&gt;req
(braket
l_int|0
)braket
dot
id|last
op_assign
id|SOC_CQ_REQ0_SIZE
op_minus
l_int|1
suffix:semicolon
id|s-&gt;req
(braket
l_int|1
)braket
dot
id|last
op_assign
id|SOC_CQ_REQ1_SIZE
op_minus
l_int|1
suffix:semicolon
id|s-&gt;rsp
(braket
l_int|0
)braket
dot
id|last
op_assign
id|SOC_CQ_RSP0_SIZE
op_minus
l_int|1
suffix:semicolon
id|s-&gt;rsp
(braket
l_int|1
)braket
dot
id|last
op_assign
id|SOC_CQ_RSP1_SIZE
op_minus
l_int|1
suffix:semicolon
id|s-&gt;req
(braket
l_int|0
)braket
dot
id|seqno
op_assign
l_int|1
suffix:semicolon
id|s-&gt;req
(braket
l_int|1
)braket
dot
id|seqno
op_assign
l_int|1
suffix:semicolon
id|s-&gt;rsp
(braket
l_int|0
)braket
dot
id|seqno
op_assign
l_int|1
suffix:semicolon
id|s-&gt;rsp
(braket
l_int|1
)braket
dot
id|seqno
op_assign
l_int|1
suffix:semicolon
id|xram_copy_to
(paren
id|s-&gt;xram
op_plus
id|SOC_CQ_REQ_OFFSET
comma
id|cq
comma
r_sizeof
(paren
id|cq
)paren
)paren
suffix:semicolon
multiline_comment|/* Make our sw copy of SOC service parameters */
id|xram_copy_from
(paren
id|s-&gt;serv_params
comma
id|s-&gt;xram
op_plus
l_int|0x140
comma
r_sizeof
(paren
id|s-&gt;serv_params
)paren
)paren
suffix:semicolon
id|s-&gt;port
(braket
l_int|0
)braket
dot
id|fc.common_svc
op_assign
(paren
id|common_svc_parm
op_star
)paren
id|s-&gt;serv_params
suffix:semicolon
id|s-&gt;port
(braket
l_int|0
)braket
dot
id|fc.class_svcs
op_assign
(paren
id|svc_parm
op_star
)paren
(paren
id|s-&gt;serv_params
op_plus
l_int|0x20
)paren
suffix:semicolon
id|s-&gt;port
(braket
l_int|1
)braket
dot
id|fc.common_svc
op_assign
(paren
id|common_svc_parm
op_star
)paren
op_amp
id|s-&gt;serv_params
suffix:semicolon
id|s-&gt;port
(braket
l_int|1
)braket
dot
id|fc.class_svcs
op_assign
(paren
id|svc_parm
op_star
)paren
(paren
id|s-&gt;serv_params
op_plus
l_int|0x20
)paren
suffix:semicolon
id|soc_enable
(paren
id|s
)paren
suffix:semicolon
id|SOD
c_func
(paren
(paren
l_string|&quot;Enabled SOC&bslash;n&quot;
)paren
)paren
)brace
macro_line|#ifndef MODULE
DECL|function|soc_probe
r_int
id|__init
id|soc_probe
c_func
(paren
r_void
)paren
macro_line|#else
r_int
id|init_module
c_func
(paren
r_void
)paren
macro_line|#endif
(brace
r_struct
id|sbus_bus
op_star
id|sbus
suffix:semicolon
r_struct
id|sbus_dev
op_star
id|sdev
op_assign
l_int|0
suffix:semicolon
r_struct
id|soc
op_star
id|s
suffix:semicolon
r_int
id|cards
op_assign
l_int|0
suffix:semicolon
id|for_each_sbus
c_func
(paren
id|sbus
)paren
(brace
id|for_each_sbusdev
c_func
(paren
id|sdev
comma
id|sbus
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|sdev-&gt;prom_name
comma
l_string|&quot;SUNW,soc&quot;
)paren
)paren
(brace
id|soc_init
c_func
(paren
id|sdev
comma
id|cards
)paren
suffix:semicolon
id|cards
op_increment
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|cards
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|for_each_soc
c_func
(paren
id|s
)paren
r_if
c_cond
(paren
id|s-&gt;next
)paren
id|s-&gt;port
(braket
l_int|1
)braket
dot
id|fc.next
op_assign
op_amp
id|s-&gt;next-&gt;port
(braket
l_int|0
)braket
dot
id|fc
suffix:semicolon
id|fcp_init
(paren
op_amp
id|socs-&gt;port
(braket
l_int|0
)braket
dot
id|fc
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|EXPORT_NO_SYMBOLS
suffix:semicolon
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_struct
id|soc
op_star
id|s
suffix:semicolon
r_int
id|irq
suffix:semicolon
r_struct
id|sbus_dev
op_star
id|sdev
suffix:semicolon
id|for_each_soc
c_func
(paren
id|s
)paren
(brace
id|irq
op_assign
id|s-&gt;port
(braket
l_int|0
)braket
dot
id|fc.irq
suffix:semicolon
id|disable_irq
(paren
id|irq
)paren
suffix:semicolon
id|free_irq
(paren
id|irq
comma
id|s
)paren
suffix:semicolon
id|fcp_release
c_func
(paren
op_amp
(paren
id|s-&gt;port
(braket
l_int|0
)braket
dot
id|fc
)paren
comma
l_int|2
)paren
suffix:semicolon
id|sdev
op_assign
id|s-&gt;port
(braket
l_int|0
)braket
dot
id|fc.dev
suffix:semicolon
r_if
c_cond
(paren
id|sdev-&gt;num_registers
op_eq
l_int|1
)paren
(brace
id|sbus_iounmap
c_func
(paren
id|s-&gt;xram
comma
l_int|0x10000UL
)paren
suffix:semicolon
id|sbus_iounmap
c_func
(paren
id|s-&gt;regs
comma
l_int|0x10UL
)paren
suffix:semicolon
)brace
r_else
(brace
id|sbus_iounmap
c_func
(paren
id|s-&gt;xram
comma
id|sdev-&gt;reg_addrs
(braket
l_int|1
)braket
dot
id|reg_size
)paren
suffix:semicolon
id|sbus_iounmap
c_func
(paren
id|s-&gt;regs
comma
id|sdev-&gt;reg_addrs
(braket
l_int|2
)braket
dot
id|reg_size
)paren
suffix:semicolon
)brace
id|sbus_free_consistent
c_func
(paren
id|sdev
comma
(paren
id|SOC_CQ_REQ0_SIZE
op_plus
id|SOC_CQ_REQ1_SIZE
)paren
op_star
r_sizeof
(paren
id|soc_req
)paren
comma
id|s-&gt;req_cpu
comma
id|s-&gt;req_dvma
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
eof
