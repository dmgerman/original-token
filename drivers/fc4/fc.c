multiline_comment|/* fc.c: Generic Fibre Channel and FC4 SCSI driver.&n; *&n; * Copyright (C) 1997,1998,1999 Jakub Jelinek (jj@ultra.linux.cz)&n; * Copyright (C) 1997,1998 Jirka Hanika (geo@ff.cuni.cz)&n; *&n; * There are two kinds of Fibre Channel adapters used in Linux. Either&n; * the adapter is &quot;smart&quot; and does all FC bookkeeping by itself and&n; * just presents a standard SCSI interface to the operating system&n; * (that&squot;s e.g. the case with Qlogic FC cards), or leaves most of the FC&n; * bookkeeping to the OS (e.g. soc, socal). Drivers for the former adapters&n; * will look like normal SCSI drivers (with the exception of max_id will be&n; * usually 127), the latter on the other side allows SCSI, IP over FC and other&n; * protocols. This driver tree is for the latter adapters.&n; *&n; * This file should support both Point-to-Point and Arbitrated Loop topologies.&n; *&n; * Sources:&n; *&t;Fibre Channel Physical &amp; Signaling Interface (FC-PH), dpANS, 1994&n; *&t;dpANS Fibre Channel Protocol for SCSI (X3.269-199X), Rev. 012, 1995&n; *&t;Fibre Channel Arbitrated Loop (FC-AL), Rev. 4.5, 1995&n; *&t;Fibre Channel Private Loop SCSI Direct Attach (FC-PLDA), Rev. 2.1, 1997&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/semaphore.h&gt;
macro_line|#include &quot;fcp_impl.h&quot;
macro_line|#include &quot;../scsi/hosts.h&quot;
multiline_comment|/* #define FCDEBUG */
DECL|macro|fc_printk
mdefine_line|#define fc_printk printk (&quot;%s: &quot;, fc-&gt;name); printk 
macro_line|#ifdef FCDEBUG
DECL|macro|FCD
mdefine_line|#define FCD(x)  fc_printk x;
DECL|macro|FCND
mdefine_line|#define FCND(x)&t;printk (&quot;FC: &quot;); printk x;
macro_line|#else
DECL|macro|FCD
mdefine_line|#define FCD(x)
DECL|macro|FCND
mdefine_line|#define FCND(x)
macro_line|#endif
macro_line|#ifdef __sparc__
DECL|macro|dma_alloc_consistent
mdefine_line|#define dma_alloc_consistent(d,s,p) sbus_alloc_consistent(d,s,p)
DECL|macro|dma_free_consistent
mdefine_line|#define dma_free_consistent(d,s,v,h) sbus_free_consistent(d,s,v,h)
DECL|macro|dma_map_single
mdefine_line|#define dma_map_single(d,v,s,dir) sbus_map_single(d,v,s,dir)
DECL|macro|dma_unmap_single
mdefine_line|#define dma_unmap_single(d,h,s,dir) sbus_unmap_single(d,h,s,dir)
DECL|macro|dma_map_sg
mdefine_line|#define dma_map_sg(d,s,n,dir) sbus_map_sg(d,s,n,dir)
DECL|macro|dma_unmap_sg
mdefine_line|#define dma_unmap_sg(d,s,n,dir) sbus_unmap_sg(d,s,n,dir)
DECL|macro|scsi_to_fc_dma_dir
mdefine_line|#define scsi_to_fc_dma_dir(dir)&t;scsi_to_sbus_dma_dir(dir)
DECL|macro|FC_DMA_BIDIRECTIONAL
mdefine_line|#define FC_DMA_BIDIRECTIONAL&t;SBUS_DMA_BIDIRECTIONAL
macro_line|#else
DECL|macro|dma_alloc_consistent
mdefine_line|#define dma_alloc_consistent(d,s,p) pci_alloc_consistent(d,s,p)
DECL|macro|dma_free_consistent
mdefine_line|#define dma_free_consistent(d,s,v,h) pci_free_consistent(d,s,v,h)
DECL|macro|dma_map_single
mdefine_line|#define dma_map_single(d,v,s,dir) pci_map_single(d,v,s,dir)
DECL|macro|dma_unmap_single
mdefine_line|#define dma_unmap_single(d,h,s,dir) pci_unmap_single(d,h,s,dir)
DECL|macro|dma_map_sg
mdefine_line|#define dma_map_sg(d,s,n,dir) pci_map_sg(d,s,n,dir)
DECL|macro|dma_unmap_sg
mdefine_line|#define dma_unmap_sg(d,s,n,dir) pci_unmap_sg(d,s,n,dir)
DECL|macro|scsi_to_fc_dma_dir
mdefine_line|#define scsi_to_fc_dma_dir(dir)&t;scsi_to_pci_dma_dir(dir)
DECL|macro|FC_DMA_BIDIRECTIONAL
mdefine_line|#define FC_DMA_BIDIRECTIONAL&t;PCI_DMA_BIDIRECTIONAL
macro_line|#endif&t;&t;&t;&t;&t;&t;&t;       
DECL|macro|FCP_CMND
mdefine_line|#define FCP_CMND(SCpnt) ((fcp_cmnd *)&amp;(SCpnt-&gt;SCp))
DECL|macro|FC_SCMND
mdefine_line|#define FC_SCMND(SCpnt) ((fc_channel *)(SCpnt-&gt;host-&gt;hostdata[0]))
DECL|macro|SC_FCMND
mdefine_line|#define SC_FCMND(fcmnd) ((Scsi_Cmnd *)((long)fcmnd - (long)&amp;(((Scsi_Cmnd *)0)-&gt;SCp)))
r_static
r_int
id|fcp_scsi_queue_it
c_func
(paren
id|fc_channel
op_star
comma
id|Scsi_Cmnd
op_star
comma
id|fcp_cmnd
op_star
comma
r_int
)paren
suffix:semicolon
r_void
id|fcp_queue_empty
c_func
(paren
id|fc_channel
op_star
)paren
suffix:semicolon
DECL|function|fcp_scsi_insert_queue
r_static
r_void
id|fcp_scsi_insert_queue
(paren
id|fc_channel
op_star
id|fc
comma
id|fcp_cmnd
op_star
id|fcmd
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|fc-&gt;scsi_que
)paren
(brace
id|fc-&gt;scsi_que
op_assign
id|fcmd
suffix:semicolon
id|fcmd-&gt;next
op_assign
id|fcmd
suffix:semicolon
id|fcmd-&gt;prev
op_assign
id|fcmd
suffix:semicolon
)brace
r_else
(brace
id|fc-&gt;scsi_que-&gt;prev-&gt;next
op_assign
id|fcmd
suffix:semicolon
id|fcmd-&gt;prev
op_assign
id|fc-&gt;scsi_que-&gt;prev
suffix:semicolon
id|fc-&gt;scsi_que-&gt;prev
op_assign
id|fcmd
suffix:semicolon
id|fcmd-&gt;next
op_assign
id|fc-&gt;scsi_que
suffix:semicolon
)brace
)brace
DECL|function|fcp_scsi_remove_queue
r_static
r_void
id|fcp_scsi_remove_queue
(paren
id|fc_channel
op_star
id|fc
comma
id|fcp_cmnd
op_star
id|fcmd
)paren
(brace
r_if
c_cond
(paren
id|fcmd
op_eq
id|fcmd-&gt;next
)paren
(brace
id|fc-&gt;scsi_que
op_assign
l_int|NULL
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fcmd
op_eq
id|fc-&gt;scsi_que
)paren
id|fc-&gt;scsi_que
op_assign
id|fcmd-&gt;next
suffix:semicolon
id|fcmd-&gt;prev-&gt;next
op_assign
id|fcmd-&gt;next
suffix:semicolon
id|fcmd-&gt;next-&gt;prev
op_assign
id|fcmd-&gt;prev
suffix:semicolon
)brace
DECL|variable|fc_channels
id|fc_channel
op_star
id|fc_channels
op_assign
l_int|NULL
suffix:semicolon
DECL|macro|LSMAGIC
mdefine_line|#define LSMAGIC&t;620829043
r_typedef
r_struct
(brace
multiline_comment|/* Must be first */
DECL|member|sem
r_struct
id|semaphore
id|sem
suffix:semicolon
DECL|member|magic
r_int
id|magic
suffix:semicolon
DECL|member|count
r_int
id|count
suffix:semicolon
DECL|member|logi
id|logi
op_star
id|logi
suffix:semicolon
DECL|member|fcmds
id|fcp_cmnd
op_star
id|fcmds
suffix:semicolon
DECL|member|todo
id|atomic_t
id|todo
suffix:semicolon
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
DECL|member|grace
r_int
r_char
id|grace
(braket
l_int|0
)braket
suffix:semicolon
DECL|typedef|ls
)brace
id|ls
suffix:semicolon
DECL|macro|LSOMAGIC
mdefine_line|#define LSOMAGIC 654907799
r_typedef
r_struct
(brace
multiline_comment|/* Must be first */
DECL|member|sem
r_struct
id|semaphore
id|sem
suffix:semicolon
DECL|member|magic
r_int
id|magic
suffix:semicolon
DECL|member|count
r_int
id|count
suffix:semicolon
DECL|member|fcmds
id|fcp_cmnd
op_star
id|fcmds
suffix:semicolon
DECL|member|todo
id|atomic_t
id|todo
suffix:semicolon
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
DECL|typedef|lso
)brace
id|lso
suffix:semicolon
DECL|macro|LSEMAGIC
mdefine_line|#define LSEMAGIC 84482456
r_typedef
r_struct
(brace
multiline_comment|/* Must be first */
DECL|member|sem
r_struct
id|semaphore
id|sem
suffix:semicolon
DECL|member|magic
r_int
id|magic
suffix:semicolon
DECL|member|status
r_int
id|status
suffix:semicolon
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
DECL|typedef|lse
)brace
id|lse
suffix:semicolon
DECL|function|fcp_login_timeout
r_static
r_void
id|fcp_login_timeout
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|ls
op_star
id|l
op_assign
(paren
id|ls
op_star
)paren
id|data
suffix:semicolon
id|FCND
c_func
(paren
(paren
l_string|&quot;Login timeout&bslash;n&quot;
)paren
)paren
id|up
c_func
(paren
op_amp
id|l-&gt;sem
)paren
suffix:semicolon
)brace
DECL|function|fcp_login_done
r_static
r_void
id|fcp_login_done
c_func
(paren
id|fc_channel
op_star
id|fc
comma
r_int
id|i
comma
r_int
id|status
)paren
(brace
id|fcp_cmnd
op_star
id|fcmd
suffix:semicolon
id|logi
op_star
id|plogi
suffix:semicolon
id|fc_hdr
op_star
id|fch
suffix:semicolon
id|ls
op_star
id|l
op_assign
(paren
id|ls
op_star
)paren
id|fc-&gt;ls
suffix:semicolon
id|FCD
c_func
(paren
(paren
l_string|&quot;Login done %d %d&bslash;n&quot;
comma
id|i
comma
id|status
)paren
)paren
r_if
c_cond
(paren
id|i
OL
id|l-&gt;count
)paren
(brace
r_if
c_cond
(paren
id|fc-&gt;state
op_eq
id|FC_STATE_FPORT_OK
)paren
(brace
id|FCD
c_func
(paren
(paren
l_string|&quot;Additional FPORT_OK received with status %d&bslash;n&quot;
comma
id|status
)paren
)paren
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|status
)paren
(brace
r_case
id|FC_STATUS_OK
suffix:colon
multiline_comment|/* Oh, we found a fabric */
r_case
id|FC_STATUS_P_RJT
suffix:colon
multiline_comment|/* Oh, we haven&squot;t found any */
id|fc-&gt;state
op_assign
id|FC_STATE_FPORT_OK
suffix:semicolon
id|fcmd
op_assign
id|l-&gt;fcmds
op_plus
id|i
suffix:semicolon
id|plogi
op_assign
id|l-&gt;logi
op_plus
l_int|3
op_star
id|i
suffix:semicolon
id|dma_unmap_single
(paren
id|fc-&gt;dev
comma
id|fcmd-&gt;cmd
comma
l_int|3
op_star
r_sizeof
(paren
id|logi
)paren
comma
id|FC_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|plogi-&gt;code
op_assign
id|LS_PLOGI
suffix:semicolon
id|memcpy
(paren
op_amp
id|plogi-&gt;nport_wwn
comma
op_amp
id|fc-&gt;wwn_nport
comma
r_sizeof
(paren
id|fc_wwn
)paren
)paren
suffix:semicolon
id|memcpy
(paren
op_amp
id|plogi-&gt;node_wwn
comma
op_amp
id|fc-&gt;wwn_node
comma
r_sizeof
(paren
id|fc_wwn
)paren
)paren
suffix:semicolon
id|memcpy
(paren
op_amp
id|plogi-&gt;common
comma
id|fc-&gt;common_svc
comma
r_sizeof
(paren
id|common_svc_parm
)paren
)paren
suffix:semicolon
id|memcpy
(paren
op_amp
id|plogi-&gt;class1
comma
id|fc-&gt;class_svcs
comma
l_int|3
op_star
r_sizeof
(paren
id|svc_parm
)paren
)paren
suffix:semicolon
id|fch
op_assign
op_amp
id|fcmd-&gt;fch
suffix:semicolon
id|fcmd-&gt;token
op_add_assign
id|l-&gt;count
suffix:semicolon
id|FILL_FCHDR_RCTL_DID
c_func
(paren
id|fch
comma
id|R_CTL_ELS_REQ
comma
id|fc-&gt;did
)paren
suffix:semicolon
id|FILL_FCHDR_SID
c_func
(paren
id|fch
comma
id|fc-&gt;sid
)paren
suffix:semicolon
macro_line|#ifdef FCDEBUG
(brace
r_int
id|i
suffix:semicolon
r_int
op_star
id|x
op_assign
(paren
r_int
op_star
)paren
id|plogi
suffix:semicolon
id|printk
(paren
l_string|&quot;logi: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|21
suffix:semicolon
id|i
op_increment
)paren
id|printk
(paren
l_string|&quot;%08x &quot;
comma
id|x
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;
id|fcmd-&gt;cmd
op_assign
id|dma_map_single
(paren
id|fc-&gt;dev
comma
id|plogi
comma
l_int|3
op_star
r_sizeof
(paren
id|logi
)paren
comma
id|FC_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|fcmd-&gt;rsp
op_assign
id|fcmd-&gt;cmd
op_plus
l_int|2
op_star
r_sizeof
(paren
id|logi
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fc-&gt;hw_enque
(paren
id|fc
comma
id|fcmd
)paren
)paren
id|printk
(paren
l_string|&quot;FC: Cannot enque PLOGI packet on %s&bslash;n&quot;
comma
id|fc-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FC_STATUS_ERR_OFFLINE
suffix:colon
id|fc-&gt;state
op_assign
id|FC_STATE_MAYBEOFFLINE
suffix:semicolon
id|FCD
(paren
(paren
l_string|&quot;FC is offline %d&bslash;n&quot;
comma
id|l-&gt;grace
(braket
id|i
)braket
)paren
)paren
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
l_string|&quot;FLOGI failed for %s with status %d&bslash;n&quot;
comma
id|fc-&gt;name
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* Do some sort of error recovery here */
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
id|i
op_sub_assign
id|l-&gt;count
suffix:semicolon
r_if
c_cond
(paren
id|fc-&gt;state
op_ne
id|FC_STATE_FPORT_OK
)paren
(brace
id|FCD
c_func
(paren
(paren
l_string|&quot;Unexpected N-PORT rsp received&quot;
)paren
)paren
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|status
)paren
(brace
r_case
id|FC_STATUS_OK
suffix:colon
id|plogi
op_assign
id|l-&gt;logi
op_plus
l_int|3
op_star
id|i
suffix:semicolon
id|dma_unmap_single
(paren
id|fc-&gt;dev
comma
id|l-&gt;fcmds
(braket
id|i
)braket
dot
id|cmd
comma
l_int|3
op_star
r_sizeof
(paren
id|logi
)paren
comma
id|FC_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fc-&gt;wwn_dest.lo
op_logical_and
op_logical_neg
id|fc-&gt;wwn_dest.hi
)paren
(brace
id|memcpy
(paren
op_amp
id|fc-&gt;wwn_dest
comma
op_amp
id|plogi
(braket
l_int|1
)braket
dot
id|node_wwn
comma
r_sizeof
(paren
id|fc_wwn
)paren
)paren
suffix:semicolon
id|FCD
c_func
(paren
(paren
l_string|&quot;Dest WWN %08x%08x&bslash;n&quot;
comma
op_star
(paren
id|u32
op_star
)paren
op_amp
id|fc-&gt;wwn_dest
comma
id|fc-&gt;wwn_dest.lo
)paren
)paren
)brace
r_else
r_if
c_cond
(paren
id|fc-&gt;wwn_dest.lo
op_ne
id|plogi
(braket
l_int|1
)braket
dot
id|node_wwn.lo
op_logical_or
id|fc-&gt;wwn_dest.hi
op_ne
id|plogi
(braket
l_int|1
)braket
dot
id|node_wwn.hi
)paren
(brace
id|printk
(paren
l_string|&quot;%s: mismatch in wwns. Got %08x%08x, expected %08x%08x&bslash;n&quot;
comma
id|fc-&gt;name
comma
op_star
(paren
id|u32
op_star
)paren
op_amp
id|plogi
(braket
l_int|1
)braket
dot
id|node_wwn
comma
id|plogi
(braket
l_int|1
)braket
dot
id|node_wwn.lo
comma
op_star
(paren
id|u32
op_star
)paren
op_amp
id|fc-&gt;wwn_dest
comma
id|fc-&gt;wwn_dest.lo
)paren
suffix:semicolon
)brace
id|fc-&gt;state
op_assign
id|FC_STATE_ONLINE
suffix:semicolon
id|printk
(paren
l_string|&quot;%s: ONLINE&bslash;n&quot;
comma
id|fc-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_dec_and_test
(paren
op_amp
id|l-&gt;todo
)paren
)paren
id|up
c_func
(paren
op_amp
id|l-&gt;sem
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FC_STATUS_ERR_OFFLINE
suffix:colon
id|fc-&gt;state
op_assign
id|FC_STATE_OFFLINE
suffix:semicolon
id|dma_unmap_single
(paren
id|fc-&gt;dev
comma
id|l-&gt;fcmds
(braket
id|i
)braket
dot
id|cmd
comma
l_int|3
op_star
r_sizeof
(paren
id|logi
)paren
comma
id|FC_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;%s: FC is offline&bslash;n&quot;
comma
id|fc-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_dec_and_test
(paren
op_amp
id|l-&gt;todo
)paren
)paren
id|up
c_func
(paren
op_amp
id|l-&gt;sem
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
l_string|&quot;PLOGI failed for %s with status %d&bslash;n&quot;
comma
id|fc-&gt;name
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* Do some sort of error recovery here */
r_break
suffix:semicolon
)brace
)brace
)brace
DECL|function|fcp_report_map_done
r_static
r_void
id|fcp_report_map_done
c_func
(paren
id|fc_channel
op_star
id|fc
comma
r_int
id|i
comma
r_int
id|status
)paren
(brace
id|fcp_cmnd
op_star
id|fcmd
suffix:semicolon
id|fc_hdr
op_star
id|fch
suffix:semicolon
r_int
r_char
id|j
suffix:semicolon
id|ls
op_star
id|l
op_assign
(paren
id|ls
op_star
)paren
id|fc-&gt;ls
suffix:semicolon
id|fc_al_posmap
op_star
id|p
suffix:semicolon
id|FCD
c_func
(paren
(paren
l_string|&quot;Report map done %d %d&bslash;n&quot;
comma
id|i
comma
id|status
)paren
)paren
r_switch
c_cond
(paren
id|status
)paren
(brace
r_case
id|FC_STATUS_OK
suffix:colon
multiline_comment|/* Ok, let&squot;s have a fun on a loop */
id|dma_unmap_single
(paren
id|fc-&gt;dev
comma
id|l-&gt;fcmds
(braket
id|i
)braket
dot
id|cmd
comma
l_int|3
op_star
r_sizeof
(paren
id|logi
)paren
comma
id|FC_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|p
op_assign
(paren
id|fc_al_posmap
op_star
)paren
(paren
id|l-&gt;logi
op_plus
l_int|3
op_star
id|i
)paren
suffix:semicolon
macro_line|#ifdef FCDEBUG
(brace
id|u32
op_star
id|u
op_assign
(paren
id|u32
op_star
)paren
id|p
suffix:semicolon
id|FCD
c_func
(paren
(paren
l_string|&quot;%08x&bslash;n&quot;
comma
id|u
(braket
l_int|0
)braket
)paren
)paren
id|u
op_increment
suffix:semicolon
id|FCD
c_func
(paren
(paren
l_string|&quot;%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x&bslash;n&quot;
comma
id|u
(braket
l_int|0
)braket
comma
id|u
(braket
l_int|1
)braket
comma
id|u
(braket
l_int|2
)braket
comma
id|u
(braket
l_int|3
)braket
comma
id|u
(braket
l_int|4
)braket
comma
id|u
(braket
l_int|5
)braket
comma
id|u
(braket
l_int|6
)braket
comma
id|u
(braket
l_int|7
)braket
)paren
)paren
)brace
macro_line|#endif&t;&t;
r_if
c_cond
(paren
(paren
id|p-&gt;magic
op_amp
l_int|0xffff0000
)paren
op_ne
id|FC_AL_LILP
op_logical_or
op_logical_neg
id|p-&gt;len
)paren
(brace
id|printk
(paren
l_string|&quot;FC: Bad magic from REPORT_AL_MAP on %s - %08x&bslash;n&quot;
comma
id|fc-&gt;name
comma
id|p-&gt;magic
)paren
suffix:semicolon
id|fc-&gt;state
op_assign
id|FC_STATE_OFFLINE
suffix:semicolon
)brace
r_else
(brace
id|fc-&gt;posmap
op_assign
(paren
id|fcp_posmap
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|fcp_posmap
)paren
op_plus
id|p-&gt;len
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fc-&gt;posmap
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;FC: Not enough memory, offlining channel&bslash;n&quot;
)paren
suffix:semicolon
id|fc-&gt;state
op_assign
id|FC_STATE_OFFLINE
suffix:semicolon
)brace
r_else
(brace
r_int
id|k
suffix:semicolon
id|memset
c_func
(paren
id|fc-&gt;posmap
comma
l_int|0
comma
r_sizeof
(paren
id|fcp_posmap
)paren
op_plus
id|p-&gt;len
)paren
suffix:semicolon
multiline_comment|/* FIXME: This is where SOCAL transfers our AL-PA.&n;&t;&t;&t;&t;   Keep it here till we found out what other cards do... */
id|fc-&gt;sid
op_assign
(paren
id|p-&gt;magic
op_amp
l_int|0xff
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|p-&gt;len
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|p-&gt;alpa
(braket
id|i
)braket
op_eq
id|fc-&gt;sid
)paren
r_break
suffix:semicolon
id|k
op_assign
id|p-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|p-&gt;len
)paren
id|i
op_assign
l_int|0
suffix:semicolon
r_else
(brace
id|p-&gt;len
op_decrement
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
id|fc-&gt;posmap-&gt;len
op_assign
id|p-&gt;len
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|p-&gt;len
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
id|k
)paren
id|i
op_assign
l_int|0
suffix:semicolon
id|fc-&gt;posmap-&gt;list
(braket
id|j
)braket
op_assign
id|p-&gt;alpa
(braket
id|i
op_increment
)braket
suffix:semicolon
)brace
id|fc-&gt;state
op_assign
id|FC_STATE_ONLINE
suffix:semicolon
)brace
)brace
id|printk
(paren
l_string|&quot;%s: ONLINE&bslash;n&quot;
comma
id|fc-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_dec_and_test
(paren
op_amp
id|l-&gt;todo
)paren
)paren
id|up
c_func
(paren
op_amp
id|l-&gt;sem
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FC_STATUS_POINTTOPOINT
suffix:colon
multiline_comment|/* We&squot;re Point-to-Point, no AL... */
id|FCD
c_func
(paren
(paren
l_string|&quot;SID %d DID %d&bslash;n&quot;
comma
id|fc-&gt;sid
comma
id|fc-&gt;did
)paren
)paren
id|fcmd
op_assign
id|l-&gt;fcmds
op_plus
id|i
suffix:semicolon
id|dma_unmap_single
c_func
(paren
id|fc-&gt;dev
comma
id|fcmd-&gt;cmd
comma
l_int|3
op_star
r_sizeof
(paren
id|logi
)paren
comma
id|FC_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|fch
op_assign
op_amp
id|fcmd-&gt;fch
suffix:semicolon
id|memset
c_func
(paren
id|l-&gt;logi
op_plus
l_int|3
op_star
id|i
comma
l_int|0
comma
l_int|3
op_star
r_sizeof
(paren
id|logi
)paren
)paren
suffix:semicolon
id|FILL_FCHDR_RCTL_DID
c_func
(paren
id|fch
comma
id|R_CTL_ELS_REQ
comma
id|FS_FABRIC_F_PORT
)paren
suffix:semicolon
id|FILL_FCHDR_SID
c_func
(paren
id|fch
comma
l_int|0
)paren
suffix:semicolon
id|FILL_FCHDR_TYPE_FCTL
c_func
(paren
id|fch
comma
id|TYPE_EXTENDED_LS
comma
id|F_CTL_FIRST_SEQ
op_or
id|F_CTL_SEQ_INITIATIVE
)paren
suffix:semicolon
id|FILL_FCHDR_SEQ_DF_SEQ
c_func
(paren
id|fch
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|FILL_FCHDR_OXRX
c_func
(paren
id|fch
comma
l_int|0xffff
comma
l_int|0xffff
)paren
suffix:semicolon
id|fch-&gt;param
op_assign
l_int|0
suffix:semicolon
id|l-&gt;logi
(braket
l_int|3
op_star
id|i
)braket
dot
id|code
op_assign
id|LS_FLOGI
suffix:semicolon
id|fcmd-&gt;cmd
op_assign
id|dma_map_single
(paren
id|fc-&gt;dev
comma
id|l-&gt;logi
op_plus
l_int|3
op_star
id|i
comma
l_int|3
op_star
r_sizeof
(paren
id|logi
)paren
comma
id|FC_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|fcmd-&gt;rsp
op_assign
id|fcmd-&gt;cmd
op_plus
r_sizeof
(paren
id|logi
)paren
suffix:semicolon
id|fcmd-&gt;cmdlen
op_assign
r_sizeof
(paren
id|logi
)paren
suffix:semicolon
id|fcmd-&gt;rsplen
op_assign
r_sizeof
(paren
id|logi
)paren
suffix:semicolon
id|fcmd-&gt;data
op_assign
(paren
id|dma_addr_t
)paren
l_int|NULL
suffix:semicolon
id|fcmd
op_member_access_from_pointer
r_class
op_assign
id|FC_CLASS_SIMPLE
suffix:semicolon
id|fcmd-&gt;proto
op_assign
id|TYPE_EXTENDED_LS
suffix:semicolon
r_if
c_cond
(paren
id|fc-&gt;hw_enque
(paren
id|fc
comma
id|fcmd
)paren
)paren
id|printk
(paren
l_string|&quot;FC: Cannot enque FLOGI packet on %s&bslash;n&quot;
comma
id|fc-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FC_STATUS_ERR_OFFLINE
suffix:colon
id|fc-&gt;state
op_assign
id|FC_STATE_MAYBEOFFLINE
suffix:semicolon
id|FCD
(paren
(paren
l_string|&quot;FC is offline %d&bslash;n&quot;
comma
id|l-&gt;grace
(braket
id|i
)braket
)paren
)paren
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
l_string|&quot;FLOGI failed for %s with status %d&bslash;n&quot;
comma
id|fc-&gt;name
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* Do some sort of error recovery here */
r_break
suffix:semicolon
)brace
)brace
DECL|function|fcp_register
r_void
id|fcp_register
c_func
(paren
id|fc_channel
op_star
id|fc
comma
id|u8
id|type
comma
r_int
id|unregister
)paren
(brace
r_int
id|size
comma
id|i
suffix:semicolon
r_int
id|slots
op_assign
(paren
id|fc-&gt;can_queue
op_star
l_int|3
)paren
op_rshift
l_int|1
suffix:semicolon
id|FCND
c_func
(paren
(paren
l_string|&quot;Going to %sregister&bslash;n&quot;
comma
id|unregister
ques
c_cond
l_string|&quot;un&quot;
suffix:colon
l_string|&quot;&quot;
)paren
)paren
r_if
c_cond
(paren
id|type
op_eq
id|TYPE_SCSI_FCP
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|unregister
)paren
(brace
id|fc-&gt;scsi_cmd_pool
op_assign
(paren
id|fcp_cmd
op_star
)paren
id|dma_alloc_consistent
(paren
id|fc-&gt;dev
comma
id|slots
op_star
(paren
r_sizeof
(paren
id|fcp_cmd
)paren
op_plus
id|fc-&gt;rsp_size
)paren
comma
op_amp
id|fc-&gt;dma_scsi_cmd
)paren
suffix:semicolon
id|fc-&gt;scsi_rsp_pool
op_assign
(paren
r_char
op_star
)paren
(paren
id|fc-&gt;scsi_cmd_pool
op_plus
id|slots
)paren
suffix:semicolon
id|fc-&gt;dma_scsi_rsp
op_assign
id|fc-&gt;dma_scsi_cmd
op_plus
id|slots
op_star
r_sizeof
(paren
id|fcp_cmd
)paren
suffix:semicolon
id|fc-&gt;scsi_bitmap_end
op_assign
(paren
id|slots
op_plus
l_int|63
)paren
op_amp
op_complement
l_int|63
suffix:semicolon
id|size
op_assign
id|fc-&gt;scsi_bitmap_end
op_div
l_int|8
suffix:semicolon
id|fc-&gt;scsi_bitmap
op_assign
id|kmalloc
(paren
id|size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|memset
(paren
id|fc-&gt;scsi_bitmap
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
id|set_bit
(paren
l_int|0
comma
id|fc-&gt;scsi_bitmap
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|fc-&gt;can_queue
suffix:semicolon
id|i
OL
id|fc-&gt;scsi_bitmap_end
suffix:semicolon
id|i
op_increment
)paren
id|set_bit
(paren
id|i
comma
id|fc-&gt;scsi_bitmap
)paren
suffix:semicolon
id|fc-&gt;scsi_free
op_assign
id|fc-&gt;can_queue
suffix:semicolon
id|fc-&gt;cmd_slots
op_assign
(paren
id|fcp_cmnd
op_star
op_star
)paren
id|kmalloc
c_func
(paren
id|slots
op_star
r_sizeof
(paren
id|fcp_cmnd
op_star
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|memset
c_func
(paren
id|fc-&gt;cmd_slots
comma
l_int|0
comma
id|slots
op_star
r_sizeof
(paren
id|fcp_cmnd
op_star
)paren
)paren
suffix:semicolon
id|fc-&gt;abort_count
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|fc-&gt;scsi_name
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|kfree
(paren
id|fc-&gt;scsi_bitmap
)paren
suffix:semicolon
id|kfree
(paren
id|fc-&gt;cmd_slots
)paren
suffix:semicolon
id|FCND
c_func
(paren
(paren
l_string|&quot;Unregistering&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fc-&gt;rst_pkt
)paren
(brace
r_if
c_cond
(paren
id|fc-&gt;rst_pkt-&gt;eh_state
op_eq
id|SCSI_STATE_UNUSED
)paren
id|kfree
c_func
(paren
id|fc-&gt;rst_pkt
)paren
suffix:semicolon
r_else
(brace
multiline_comment|/* Can&squot;t happen. Some memory would be lost. */
id|printk
c_func
(paren
l_string|&quot;FC: Reset in progress. Now?!&quot;
)paren
suffix:semicolon
)brace
)brace
id|FCND
c_func
(paren
(paren
l_string|&quot;Unregistered&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
id|printk
(paren
l_string|&quot;FC: %segistering unknown type %02x&bslash;n&quot;
comma
id|unregister
ques
c_cond
l_string|&quot;Unr&quot;
suffix:colon
l_string|&quot;R&quot;
comma
id|type
)paren
suffix:semicolon
)brace
r_static
r_void
id|fcp_scsi_done
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
suffix:semicolon
DECL|function|fcp_scsi_receive
r_static
r_inline
r_void
id|fcp_scsi_receive
c_func
(paren
id|fc_channel
op_star
id|fc
comma
r_int
id|token
comma
r_int
id|status
comma
id|fc_hdr
op_star
id|fch
)paren
(brace
id|fcp_cmnd
op_star
id|fcmd
suffix:semicolon
id|fcp_rsp
op_star
id|rsp
suffix:semicolon
r_int
id|host_status
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
r_int
id|sense_len
suffix:semicolon
r_int
id|rsp_status
suffix:semicolon
id|fcmd
op_assign
id|fc-&gt;cmd_slots
(braket
id|token
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fcmd
)paren
r_return
suffix:semicolon
id|rsp
op_assign
(paren
id|fcp_rsp
op_star
)paren
(paren
id|fc-&gt;scsi_rsp_pool
op_plus
id|fc-&gt;rsp_size
op_star
id|token
)paren
suffix:semicolon
id|SCpnt
op_assign
id|SC_FCMND
c_func
(paren
id|fcmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;done
op_ne
id|fcp_scsi_done
)paren
r_return
suffix:semicolon
id|rsp_status
op_assign
id|rsp-&gt;fcp_status
suffix:semicolon
id|FCD
c_func
(paren
(paren
l_string|&quot;rsp_status %08x status %08x&bslash;n&quot;
comma
id|rsp_status
comma
id|status
)paren
)paren
r_switch
c_cond
(paren
id|status
)paren
(brace
r_case
id|FC_STATUS_OK
suffix:colon
id|host_status
op_assign
id|DID_OK
suffix:semicolon
r_if
c_cond
(paren
id|rsp_status
op_amp
id|FCP_STATUS_RESID
)paren
(brace
macro_line|#ifdef FCDEBUG
id|FCD
c_func
(paren
(paren
l_string|&quot;Resid %d&bslash;n&quot;
comma
id|rsp-&gt;fcp_resid
)paren
)paren
(brace
id|fcp_cmd
op_star
id|cmd
op_assign
id|fc-&gt;scsi_cmd_pool
op_plus
id|token
suffix:semicolon
r_int
id|i
suffix:semicolon
id|printk
(paren
l_string|&quot;Command &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|fcp_cmd
)paren
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
id|printk
(paren
l_string|&quot;%08x &quot;
comma
op_star
(paren
id|u32
op_star
)paren
(paren
(paren
(paren
r_char
op_star
)paren
id|cmd
)paren
op_plus
id|i
)paren
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;&bslash;nResponse &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|fc-&gt;rsp_size
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
id|printk
(paren
l_string|&quot;%08x &quot;
comma
op_star
(paren
id|u32
op_star
)paren
(paren
(paren
(paren
r_char
op_star
)paren
id|rsp
)paren
op_plus
id|i
)paren
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;
)brace
r_if
c_cond
(paren
id|rsp_status
op_amp
id|FCP_STATUS_SENSE_LEN
)paren
(brace
id|sense_len
op_assign
id|rsp-&gt;fcp_sense_len
suffix:semicolon
r_if
c_cond
(paren
id|sense_len
OG
r_sizeof
(paren
id|SCpnt-&gt;sense_buffer
)paren
)paren
id|sense_len
op_assign
r_sizeof
(paren
id|SCpnt-&gt;sense_buffer
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|SCpnt-&gt;sense_buffer
comma
(paren
(paren
r_char
op_star
)paren
(paren
id|rsp
op_plus
l_int|1
)paren
)paren
comma
id|sense_len
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fcmd-&gt;data
)paren
(brace
r_if
c_cond
(paren
id|SCpnt-&gt;use_sg
)paren
id|dma_unmap_sg
c_func
(paren
id|fc-&gt;dev
comma
(paren
r_struct
id|scatterlist
op_star
)paren
id|SCpnt-&gt;buffer
comma
id|SCpnt-&gt;use_sg
comma
id|scsi_to_fc_dma_dir
c_func
(paren
id|SCpnt-&gt;sc_data_direction
)paren
)paren
suffix:semicolon
r_else
id|dma_unmap_single
c_func
(paren
id|fc-&gt;dev
comma
id|fcmd-&gt;data
comma
id|SCpnt-&gt;request_bufflen
comma
id|scsi_to_fc_dma_dir
c_func
(paren
id|SCpnt-&gt;sc_data_direction
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
multiline_comment|/* FIXME */
id|FCD
c_func
(paren
(paren
l_string|&quot;Wrong FC status %d for token %d&bslash;n&quot;
comma
id|status
comma
id|token
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status_byte
c_func
(paren
id|rsp_status
)paren
op_eq
id|QUEUE_FULL
)paren
(brace
id|printk
(paren
l_string|&quot;%s: (%d,%d) Received rsp_status 0x%x&bslash;n&quot;
comma
id|fc-&gt;name
comma
id|SCpnt-&gt;channel
comma
id|SCpnt-&gt;target
comma
id|rsp_status
)paren
suffix:semicolon
)brace
id|SCpnt-&gt;result
op_assign
(paren
id|host_status
op_lshift
l_int|16
)paren
op_or
(paren
id|rsp_status
op_amp
l_int|0xff
)paren
suffix:semicolon
macro_line|#ifdef FCDEBUG&t;
r_if
c_cond
(paren
id|host_status
op_logical_or
id|SCpnt-&gt;result
op_logical_or
id|rsp_status
)paren
id|printk
c_func
(paren
l_string|&quot;FC: host_status %d, packet status %d&bslash;n&quot;
comma
id|host_status
comma
id|SCpnt-&gt;result
)paren
suffix:semicolon
macro_line|#endif
id|SCpnt-&gt;done
op_assign
id|fcmd-&gt;done
suffix:semicolon
id|fcmd-&gt;done
op_assign
l_int|NULL
suffix:semicolon
id|clear_bit
c_func
(paren
id|token
comma
id|fc-&gt;scsi_bitmap
)paren
suffix:semicolon
id|fc-&gt;scsi_free
op_increment
suffix:semicolon
id|FCD
c_func
(paren
(paren
l_string|&quot;Calling scsi_done with %08x&bslash;n&quot;
comma
id|SCpnt-&gt;result
)paren
)paren
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
)brace
DECL|function|fcp_receive_solicited
r_void
id|fcp_receive_solicited
c_func
(paren
id|fc_channel
op_star
id|fc
comma
r_int
id|proto
comma
r_int
id|token
comma
r_int
id|status
comma
id|fc_hdr
op_star
id|fch
)paren
(brace
r_int
id|magic
suffix:semicolon
id|FCD
c_func
(paren
(paren
l_string|&quot;receive_solicited %d %d %d&bslash;n&quot;
comma
id|proto
comma
id|token
comma
id|status
)paren
)paren
r_switch
c_cond
(paren
id|proto
)paren
(brace
r_case
id|TYPE_SCSI_FCP
suffix:colon
id|fcp_scsi_receive
c_func
(paren
id|fc
comma
id|token
comma
id|status
comma
id|fch
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TYPE_EXTENDED_LS
suffix:colon
r_case
id|PROTO_REPORT_AL_MAP
suffix:colon
id|magic
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|fc-&gt;ls
)paren
id|magic
op_assign
(paren
(paren
id|ls
op_star
)paren
(paren
id|fc-&gt;ls
)paren
)paren
op_member_access_from_pointer
id|magic
suffix:semicolon
r_if
c_cond
(paren
id|magic
op_eq
id|LSMAGIC
)paren
(brace
id|ls
op_star
id|l
op_assign
(paren
id|ls
op_star
)paren
id|fc-&gt;ls
suffix:semicolon
r_int
id|i
op_assign
(paren
id|token
op_ge
id|l-&gt;count
)paren
ques
c_cond
id|token
op_minus
id|l-&gt;count
suffix:colon
id|token
suffix:semicolon
multiline_comment|/* Let&squot;s be sure */
r_if
c_cond
(paren
(paren
r_int
)paren
id|i
OL
id|l-&gt;count
op_logical_and
id|l-&gt;fcmds
(braket
id|i
)braket
dot
id|fc
op_eq
id|fc
)paren
(brace
r_if
c_cond
(paren
id|proto
op_eq
id|TYPE_EXTENDED_LS
)paren
id|fcp_login_done
c_func
(paren
id|fc
comma
id|token
comma
id|status
)paren
suffix:semicolon
r_else
id|fcp_report_map_done
c_func
(paren
id|fc
comma
id|token
comma
id|status
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|FCD
c_func
(paren
(paren
l_string|&quot;fc %p fc-&gt;ls %p fc-&gt;cmd_slots %p&bslash;n&quot;
comma
id|fc
comma
id|fc-&gt;ls
comma
id|fc-&gt;cmd_slots
)paren
)paren
r_if
c_cond
(paren
id|proto
op_eq
id|TYPE_EXTENDED_LS
op_logical_and
op_logical_neg
id|fc-&gt;ls
op_logical_and
id|fc-&gt;cmd_slots
)paren
(brace
id|fcp_cmnd
op_star
id|fcmd
suffix:semicolon
id|fcmd
op_assign
id|fc-&gt;cmd_slots
(braket
id|token
)braket
suffix:semicolon
r_if
c_cond
(paren
id|fcmd
op_logical_and
id|fcmd-&gt;ls
op_logical_and
(paren
(paren
id|ls
op_star
)paren
(paren
id|fcmd-&gt;ls
)paren
)paren
op_member_access_from_pointer
id|magic
op_eq
id|LSEMAGIC
)paren
(brace
id|lse
op_star
id|l
op_assign
(paren
id|lse
op_star
)paren
id|fcmd-&gt;ls
suffix:semicolon
id|l-&gt;status
op_assign
id|status
suffix:semicolon
id|up
(paren
op_amp
id|l-&gt;sem
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|PROTO_OFFLINE
suffix:colon
r_if
c_cond
(paren
id|fc-&gt;ls
op_logical_and
(paren
(paren
id|lso
op_star
)paren
(paren
id|fc-&gt;ls
)paren
)paren
op_member_access_from_pointer
id|magic
op_eq
id|LSOMAGIC
)paren
(brace
id|lso
op_star
id|l
op_assign
(paren
id|lso
op_star
)paren
id|fc-&gt;ls
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|token
OL
id|l-&gt;count
op_logical_and
id|l-&gt;fcmds
(braket
id|token
)braket
dot
id|fc
op_eq
id|fc
)paren
(brace
multiline_comment|/* Wow, OFFLINE response arrived :) */
id|FCD
c_func
(paren
(paren
l_string|&quot;OFFLINE Response arrived&bslash;n&quot;
)paren
)paren
id|fc-&gt;state
op_assign
id|FC_STATE_OFFLINE
suffix:semicolon
r_if
c_cond
(paren
id|atomic_dec_and_test
(paren
op_amp
id|l-&gt;todo
)paren
)paren
id|up
c_func
(paren
op_amp
id|l-&gt;sem
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
DECL|function|fcp_state_change
r_void
id|fcp_state_change
c_func
(paren
id|fc_channel
op_star
id|fc
comma
r_int
id|state
)paren
(brace
id|FCD
c_func
(paren
(paren
l_string|&quot;state_change %d %d&bslash;n&quot;
comma
id|state
comma
id|fc-&gt;state
)paren
)paren
r_if
c_cond
(paren
id|state
op_eq
id|FC_STATE_ONLINE
op_logical_and
id|fc-&gt;state
op_eq
id|FC_STATE_MAYBEOFFLINE
)paren
id|fc-&gt;state
op_assign
id|FC_STATE_UNINITED
suffix:semicolon
r_else
r_if
c_cond
(paren
id|state
op_eq
id|FC_STATE_ONLINE
)paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: state change to ONLINE&bslash;n&quot;
comma
id|fc-&gt;name
)paren
suffix:semicolon
r_else
id|printk
(paren
id|KERN_ERR
l_string|&quot;%s: state change to OFFLINE&bslash;n&quot;
comma
id|fc-&gt;name
)paren
suffix:semicolon
)brace
DECL|function|fcp_initialize
r_int
id|fcp_initialize
c_func
(paren
id|fc_channel
op_star
id|fcchain
comma
r_int
id|count
)paren
(brace
id|fc_channel
op_star
id|fc
suffix:semicolon
id|fcp_cmnd
op_star
id|fcmd
suffix:semicolon
r_int
id|i
comma
id|retry
comma
id|ret
suffix:semicolon
id|ls
op_star
id|l
suffix:semicolon
id|FCND
c_func
(paren
(paren
l_string|&quot;fcp_inititialize %08lx&bslash;n&quot;
comma
(paren
r_int
)paren
id|fcp_init
)paren
)paren
id|FCND
c_func
(paren
(paren
l_string|&quot;fc_channels %08lx&bslash;n&quot;
comma
(paren
r_int
)paren
id|fc_channels
)paren
)paren
id|FCND
c_func
(paren
(paren
l_string|&quot; SID %d DID %d&bslash;n&quot;
comma
id|fcchain-&gt;sid
comma
id|fcchain-&gt;did
)paren
)paren
id|l
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|ls
)paren
op_plus
id|count
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|l
)paren
(brace
id|printk
(paren
l_string|&quot;FC: Cannot allocate memory for initialization&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|l
comma
l_int|0
comma
r_sizeof
(paren
id|ls
)paren
op_plus
id|count
)paren
suffix:semicolon
id|l-&gt;magic
op_assign
id|LSMAGIC
suffix:semicolon
id|l-&gt;count
op_assign
id|count
suffix:semicolon
id|FCND
c_func
(paren
(paren
l_string|&quot;FCP Init for %d channels&bslash;n&quot;
comma
id|count
)paren
)paren
id|init_MUTEX_LOCKED
c_func
(paren
op_amp
id|l-&gt;sem
)paren
suffix:semicolon
id|l-&gt;timer.function
op_assign
id|fcp_login_timeout
suffix:semicolon
id|l-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|l
suffix:semicolon
id|atomic_set
(paren
op_amp
id|l-&gt;todo
comma
id|count
)paren
suffix:semicolon
id|l-&gt;logi
op_assign
id|kmalloc
(paren
id|count
op_star
l_int|3
op_star
r_sizeof
(paren
id|logi
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|l-&gt;fcmds
op_assign
id|kmalloc
(paren
id|count
op_star
r_sizeof
(paren
id|fcp_cmnd
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|l-&gt;logi
op_logical_or
op_logical_neg
id|l-&gt;fcmds
)paren
(brace
r_if
c_cond
(paren
id|l-&gt;logi
)paren
id|kfree
(paren
id|l-&gt;logi
)paren
suffix:semicolon
r_if
c_cond
(paren
id|l-&gt;fcmds
)paren
id|kfree
(paren
id|l-&gt;fcmds
)paren
suffix:semicolon
id|kfree
(paren
id|l
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;FC: Cannot allocate DMA memory for initialization&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|l-&gt;logi
comma
l_int|0
comma
id|count
op_star
l_int|3
op_star
r_sizeof
(paren
id|logi
)paren
)paren
suffix:semicolon
id|memset
(paren
id|l-&gt;fcmds
comma
l_int|0
comma
id|count
op_star
r_sizeof
(paren
id|fcp_cmnd
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|fc
op_assign
id|fcchain
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|fc
op_logical_and
id|i
OL
id|count
suffix:semicolon
id|fc
op_assign
id|fc-&gt;next
comma
id|i
op_increment
)paren
(brace
id|fc-&gt;state
op_assign
id|FC_STATE_UNINITED
suffix:semicolon
id|fc-&gt;rst_pkt
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* kmalloc when first used */
)brace
multiline_comment|/* First try if we are in a AL topology */
id|FCND
c_func
(paren
(paren
l_string|&quot;Initializing REPORT_MAP packets&bslash;n&quot;
)paren
)paren
r_for
c_loop
(paren
id|fc
op_assign
id|fcchain
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|fc
op_logical_and
id|i
OL
id|count
suffix:semicolon
id|fc
op_assign
id|fc-&gt;next
comma
id|i
op_increment
)paren
(brace
id|fcmd
op_assign
id|l-&gt;fcmds
op_plus
id|i
suffix:semicolon
id|fc-&gt;login
op_assign
id|fcmd
suffix:semicolon
id|fc-&gt;ls
op_assign
(paren
r_void
op_star
)paren
id|l
suffix:semicolon
multiline_comment|/* Assumes sizeof(fc_al_posmap) &lt; 3 * sizeof(logi), which is true */
id|fcmd-&gt;cmd
op_assign
id|dma_map_single
(paren
id|fc-&gt;dev
comma
id|l-&gt;logi
op_plus
l_int|3
op_star
id|i
comma
l_int|3
op_star
r_sizeof
(paren
id|logi
)paren
comma
id|FC_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|fcmd-&gt;proto
op_assign
id|PROTO_REPORT_AL_MAP
suffix:semicolon
id|fcmd-&gt;token
op_assign
id|i
suffix:semicolon
id|fcmd-&gt;fc
op_assign
id|fc
suffix:semicolon
)brace
r_for
c_loop
(paren
id|retry
op_assign
l_int|0
suffix:semicolon
id|retry
OL
l_int|8
suffix:semicolon
id|retry
op_increment
)paren
(brace
r_int
id|nqueued
op_assign
l_int|0
suffix:semicolon
id|FCND
c_func
(paren
(paren
l_string|&quot;Sending REPORT_MAP/FLOGI/PLOGI packets&bslash;n&quot;
)paren
)paren
r_for
c_loop
(paren
id|fc
op_assign
id|fcchain
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|fc
op_logical_and
id|i
OL
id|count
suffix:semicolon
id|fc
op_assign
id|fc-&gt;next
comma
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|fc-&gt;state
op_eq
id|FC_STATE_ONLINE
op_logical_or
id|fc-&gt;state
op_eq
id|FC_STATE_OFFLINE
)paren
r_continue
suffix:semicolon
id|disable_irq
c_func
(paren
id|fc-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fc-&gt;state
op_eq
id|FC_STATE_MAYBEOFFLINE
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|l-&gt;grace
(braket
id|i
)braket
)paren
(brace
id|l-&gt;grace
(braket
id|i
)braket
op_increment
suffix:semicolon
id|FCD
c_func
(paren
(paren
l_string|&quot;Grace&bslash;n&quot;
)paren
)paren
)brace
r_else
(brace
id|fc-&gt;state
op_assign
id|FC_STATE_OFFLINE
suffix:semicolon
id|enable_irq
c_func
(paren
id|fc-&gt;irq
)paren
suffix:semicolon
id|dma_unmap_single
(paren
id|fc-&gt;dev
comma
id|l-&gt;fcmds
(braket
id|i
)braket
dot
id|cmd
comma
l_int|3
op_star
r_sizeof
(paren
id|logi
)paren
comma
id|FC_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_dec_and_test
(paren
op_amp
id|l-&gt;todo
)paren
)paren
r_goto
id|all_done
suffix:semicolon
)brace
)brace
id|ret
op_assign
id|fc-&gt;hw_enque
(paren
id|fc
comma
id|fc-&gt;login
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|fc-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
id|nqueued
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|ENOSYS
op_logical_and
id|fc-&gt;login-&gt;proto
op_eq
id|PROTO_REPORT_AL_MAP
)paren
(brace
multiline_comment|/* Oh yes, this card handles Point-to-Point only, so let&squot;s try that. */
id|fc_hdr
op_star
id|fch
suffix:semicolon
id|FCD
c_func
(paren
(paren
l_string|&quot;SID %d DID %d&bslash;n&quot;
comma
id|fc-&gt;sid
comma
id|fc-&gt;did
)paren
)paren
id|fcmd
op_assign
id|l-&gt;fcmds
op_plus
id|i
suffix:semicolon
id|dma_unmap_single
c_func
(paren
id|fc-&gt;dev
comma
id|fcmd-&gt;cmd
comma
l_int|3
op_star
r_sizeof
(paren
id|logi
)paren
comma
id|FC_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|fch
op_assign
op_amp
id|fcmd-&gt;fch
suffix:semicolon
id|FILL_FCHDR_RCTL_DID
c_func
(paren
id|fch
comma
id|R_CTL_ELS_REQ
comma
id|FS_FABRIC_F_PORT
)paren
suffix:semicolon
id|FILL_FCHDR_SID
c_func
(paren
id|fch
comma
l_int|0
)paren
suffix:semicolon
id|FILL_FCHDR_TYPE_FCTL
c_func
(paren
id|fch
comma
id|TYPE_EXTENDED_LS
comma
id|F_CTL_FIRST_SEQ
op_or
id|F_CTL_SEQ_INITIATIVE
)paren
suffix:semicolon
id|FILL_FCHDR_SEQ_DF_SEQ
c_func
(paren
id|fch
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|FILL_FCHDR_OXRX
c_func
(paren
id|fch
comma
l_int|0xffff
comma
l_int|0xffff
)paren
suffix:semicolon
id|fch-&gt;param
op_assign
l_int|0
suffix:semicolon
id|l-&gt;logi
(braket
l_int|3
op_star
id|i
)braket
dot
id|code
op_assign
id|LS_FLOGI
suffix:semicolon
id|fcmd-&gt;cmd
op_assign
id|dma_map_single
(paren
id|fc-&gt;dev
comma
id|l-&gt;logi
op_plus
l_int|3
op_star
id|i
comma
l_int|3
op_star
r_sizeof
(paren
id|logi
)paren
comma
id|FC_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|fcmd-&gt;rsp
op_assign
id|fcmd-&gt;cmd
op_plus
r_sizeof
(paren
id|logi
)paren
suffix:semicolon
id|fcmd-&gt;cmdlen
op_assign
r_sizeof
(paren
id|logi
)paren
suffix:semicolon
id|fcmd-&gt;rsplen
op_assign
r_sizeof
(paren
id|logi
)paren
suffix:semicolon
id|fcmd-&gt;data
op_assign
(paren
id|dma_addr_t
)paren
l_int|NULL
suffix:semicolon
id|fcmd
op_member_access_from_pointer
r_class
op_assign
id|FC_CLASS_SIMPLE
suffix:semicolon
id|fcmd-&gt;proto
op_assign
id|TYPE_EXTENDED_LS
suffix:semicolon
)brace
r_else
id|printk
(paren
l_string|&quot;FC: Cannot enque FLOGI/REPORT_MAP packet on %s&bslash;n&quot;
comma
id|fc-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|nqueued
)paren
(brace
id|l-&gt;timer.expires
op_assign
id|jiffies
op_plus
l_int|5
op_star
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|l-&gt;timer
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|l-&gt;sem
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atomic_read
c_func
(paren
op_amp
id|l-&gt;todo
)paren
)paren
(brace
id|FCND
c_func
(paren
(paren
l_string|&quot;All channels answered in time&bslash;n&quot;
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* All fc channels have answered us */
)brace
)brace
)brace
id|all_done
suffix:colon
r_for
c_loop
(paren
id|fc
op_assign
id|fcchain
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|fc
op_logical_and
id|i
OL
id|count
suffix:semicolon
id|fc
op_assign
id|fc-&gt;next
comma
id|i
op_increment
)paren
(brace
id|fc-&gt;ls
op_assign
l_int|NULL
suffix:semicolon
r_switch
c_cond
(paren
id|fc-&gt;state
)paren
(brace
r_case
id|FC_STATE_ONLINE
suffix:colon
r_break
suffix:semicolon
r_case
id|FC_STATE_OFFLINE
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|dma_unmap_single
(paren
id|fc-&gt;dev
comma
id|l-&gt;fcmds
(braket
id|i
)braket
dot
id|cmd
comma
l_int|3
op_star
r_sizeof
(paren
id|logi
)paren
comma
id|FC_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|del_timer
c_func
(paren
op_amp
id|l-&gt;timer
)paren
suffix:semicolon
id|kfree
(paren
id|l-&gt;logi
)paren
suffix:semicolon
id|kfree
(paren
id|l-&gt;fcmds
)paren
suffix:semicolon
id|kfree
(paren
id|l
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|fcp_forceoffline
r_int
id|fcp_forceoffline
c_func
(paren
id|fc_channel
op_star
id|fcchain
comma
r_int
id|count
)paren
(brace
id|fc_channel
op_star
id|fc
suffix:semicolon
id|fcp_cmnd
op_star
id|fcmd
suffix:semicolon
r_int
id|i
comma
id|ret
suffix:semicolon
id|lso
id|l
suffix:semicolon
id|memset
(paren
op_amp
id|l
comma
l_int|0
comma
r_sizeof
(paren
id|lso
)paren
)paren
suffix:semicolon
id|l.count
op_assign
id|count
suffix:semicolon
id|l.magic
op_assign
id|LSOMAGIC
suffix:semicolon
id|FCND
c_func
(paren
(paren
l_string|&quot;FCP Force Offline for %d channels&bslash;n&quot;
comma
id|count
)paren
)paren
id|init_MUTEX_LOCKED
c_func
(paren
op_amp
id|l.sem
)paren
suffix:semicolon
id|l.timer.function
op_assign
id|fcp_login_timeout
suffix:semicolon
id|l.timer.data
op_assign
(paren
r_int
r_int
)paren
op_amp
id|l
suffix:semicolon
id|atomic_set
(paren
op_amp
id|l.todo
comma
id|count
)paren
suffix:semicolon
id|l.fcmds
op_assign
id|kmalloc
(paren
id|count
op_star
r_sizeof
(paren
id|fcp_cmnd
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|l.fcmds
)paren
(brace
id|kfree
(paren
id|l.fcmds
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;FC: Cannot allocate memory for forcing offline&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|l.fcmds
comma
l_int|0
comma
id|count
op_star
r_sizeof
(paren
id|fcp_cmnd
)paren
)paren
suffix:semicolon
id|FCND
c_func
(paren
(paren
l_string|&quot;Initializing OFFLINE packets&bslash;n&quot;
)paren
)paren
r_for
c_loop
(paren
id|fc
op_assign
id|fcchain
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|fc
op_logical_and
id|i
OL
id|count
suffix:semicolon
id|fc
op_assign
id|fc-&gt;next
comma
id|i
op_increment
)paren
(brace
id|fc-&gt;state
op_assign
id|FC_STATE_UNINITED
suffix:semicolon
id|fcmd
op_assign
id|l.fcmds
op_plus
id|i
suffix:semicolon
id|fc-&gt;login
op_assign
id|fcmd
suffix:semicolon
id|fc-&gt;ls
op_assign
(paren
r_void
op_star
)paren
op_amp
id|l
suffix:semicolon
id|fcmd-&gt;did
op_assign
id|fc-&gt;did
suffix:semicolon
id|fcmd
op_member_access_from_pointer
r_class
op_assign
id|FC_CLASS_OFFLINE
suffix:semicolon
id|fcmd-&gt;proto
op_assign
id|PROTO_OFFLINE
suffix:semicolon
id|fcmd-&gt;token
op_assign
id|i
suffix:semicolon
id|fcmd-&gt;fc
op_assign
id|fc
suffix:semicolon
id|disable_irq
c_func
(paren
id|fc-&gt;irq
)paren
suffix:semicolon
id|ret
op_assign
id|fc-&gt;hw_enque
(paren
id|fc
comma
id|fc-&gt;login
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|fc-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|printk
(paren
l_string|&quot;FC: Cannot enque OFFLINE packet on %s&bslash;n&quot;
comma
id|fc-&gt;name
)paren
suffix:semicolon
)brace
id|l.timer.expires
op_assign
id|jiffies
op_plus
l_int|5
op_star
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|l.timer
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|l.sem
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|l.timer
)paren
suffix:semicolon
r_for
c_loop
(paren
id|fc
op_assign
id|fcchain
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|fc
op_logical_and
id|i
OL
id|count
suffix:semicolon
id|fc
op_assign
id|fc-&gt;next
comma
id|i
op_increment
)paren
id|fc-&gt;ls
op_assign
l_int|NULL
suffix:semicolon
id|kfree
(paren
id|l.fcmds
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|fcp_init
r_int
id|fcp_init
c_func
(paren
id|fc_channel
op_star
id|fcchain
)paren
(brace
id|fc_channel
op_star
id|fc
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_for
c_loop
(paren
id|fc
op_assign
id|fcchain
suffix:semicolon
id|fc
suffix:semicolon
id|fc
op_assign
id|fc-&gt;next
)paren
(brace
id|fc-&gt;fcp_register
op_assign
id|fcp_register
suffix:semicolon
id|count
op_increment
suffix:semicolon
)brace
id|ret
op_assign
id|fcp_initialize
(paren
id|fcchain
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fc_channels
)paren
id|fc_channels
op_assign
id|fcchain
suffix:semicolon
r_else
(brace
r_for
c_loop
(paren
id|fc
op_assign
id|fc_channels
suffix:semicolon
id|fc-&gt;next
suffix:semicolon
id|fc
op_assign
id|fc-&gt;next
)paren
suffix:semicolon
id|fc-&gt;next
op_assign
id|fcchain
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|fcp_release
r_void
id|fcp_release
c_func
(paren
id|fc_channel
op_star
id|fcchain
comma
r_int
id|count
)paren
multiline_comment|/* count must &gt; 0 */
(brace
id|fc_channel
op_star
id|fc
suffix:semicolon
id|fc_channel
op_star
id|fcx
suffix:semicolon
r_for
c_loop
(paren
id|fc
op_assign
id|fcchain
suffix:semicolon
op_decrement
id|count
op_logical_and
id|fc-&gt;next
suffix:semicolon
id|fc
op_assign
id|fc-&gt;next
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;FC: nothing to release&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fc_channels
op_eq
id|fcchain
)paren
id|fc_channels
op_assign
id|fc-&gt;next
suffix:semicolon
r_else
(brace
r_for
c_loop
(paren
id|fcx
op_assign
id|fc_channels
suffix:semicolon
id|fcx-&gt;next
op_ne
id|fcchain
suffix:semicolon
id|fcx
op_assign
id|fcx-&gt;next
)paren
suffix:semicolon
id|fcx-&gt;next
op_assign
id|fc-&gt;next
suffix:semicolon
)brace
id|fc-&gt;next
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;&t; *  We&squot;ve just grabbed fcchain out of the fc_channel list&n;&t; *  and zero-terminated it, while destroying the count.&n;&t; *&n;&t; *  Freeing the fc&squot;s is the low level driver&squot;s responsibility.&n;&t; */
)brace
DECL|function|fcp_scsi_done
r_static
r_void
id|fcp_scsi_done
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_if
c_cond
(paren
id|FCP_CMND
c_func
(paren
id|SCpnt
)paren
op_member_access_from_pointer
id|done
)paren
id|FCP_CMND
c_func
(paren
id|SCpnt
)paren
op_member_access_from_pointer
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
)brace
DECL|function|fcp_scsi_queue_it
r_static
r_int
id|fcp_scsi_queue_it
c_func
(paren
id|fc_channel
op_star
id|fc
comma
id|Scsi_Cmnd
op_star
id|SCpnt
comma
id|fcp_cmnd
op_star
id|fcmd
comma
r_int
id|prepare
)paren
(brace
r_int
id|i
suffix:semicolon
id|fcp_cmd
op_star
id|cmd
suffix:semicolon
id|u32
id|fcp_cntl
suffix:semicolon
r_if
c_cond
(paren
id|prepare
)paren
(brace
id|i
op_assign
id|find_first_zero_bit
(paren
id|fc-&gt;scsi_bitmap
comma
id|fc-&gt;scsi_bitmap_end
)paren
suffix:semicolon
id|set_bit
(paren
id|i
comma
id|fc-&gt;scsi_bitmap
)paren
suffix:semicolon
id|fcmd-&gt;token
op_assign
id|i
suffix:semicolon
id|cmd
op_assign
id|fc-&gt;scsi_cmd_pool
op_plus
id|i
suffix:semicolon
r_if
c_cond
(paren
id|fc-&gt;encode_addr
(paren
id|SCpnt
comma
id|cmd-&gt;fcp_addr
comma
id|fc
comma
id|fcmd
)paren
)paren
(brace
multiline_comment|/* Invalid channel/id/lun and couldn&squot;t map it into fcp_addr */
id|clear_bit
(paren
id|i
comma
id|fc-&gt;scsi_bitmap
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|fc-&gt;scsi_free
op_decrement
suffix:semicolon
id|fc-&gt;cmd_slots
(braket
id|fcmd-&gt;token
)braket
op_assign
id|fcmd
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;device-&gt;tagged_supported
)paren
(brace
r_if
c_cond
(paren
id|jiffies
op_minus
id|fc-&gt;ages
(braket
id|SCpnt-&gt;channel
op_star
id|fc-&gt;targets
op_plus
id|SCpnt-&gt;target
)braket
OG
(paren
l_int|5
op_star
l_int|60
op_star
id|HZ
)paren
)paren
(brace
id|fc-&gt;ages
(braket
id|SCpnt-&gt;channel
op_star
id|fc-&gt;targets
op_plus
id|SCpnt-&gt;target
)braket
op_assign
id|jiffies
suffix:semicolon
id|fcp_cntl
op_assign
id|FCP_CNTL_QTYPE_ORDERED
suffix:semicolon
)brace
r_else
id|fcp_cntl
op_assign
id|FCP_CNTL_QTYPE_SIMPLE
suffix:semicolon
)brace
r_else
id|fcp_cntl
op_assign
id|FCP_CNTL_QTYPE_UNTAGGED
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SCpnt-&gt;request_bufflen
op_logical_and
op_logical_neg
id|SCpnt-&gt;use_sg
)paren
(brace
id|cmd-&gt;fcp_cntl
op_assign
id|fcp_cntl
suffix:semicolon
id|fcmd-&gt;data
op_assign
(paren
id|dma_addr_t
)paren
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
r_switch
c_cond
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|WRITE_6
suffix:colon
r_case
id|WRITE_10
suffix:colon
r_case
id|WRITE_12
suffix:colon
id|cmd-&gt;fcp_cntl
op_assign
(paren
id|FCP_CNTL_WRITE
op_or
id|fcp_cntl
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|cmd-&gt;fcp_cntl
op_assign
(paren
id|FCP_CNTL_READ
op_or
id|fcp_cntl
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|SCpnt-&gt;use_sg
)paren
(brace
id|cmd-&gt;fcp_data_len
op_assign
id|SCpnt-&gt;request_bufflen
suffix:semicolon
id|fcmd-&gt;data
op_assign
id|dma_map_single
(paren
id|fc-&gt;dev
comma
(paren
r_char
op_star
)paren
id|SCpnt-&gt;request_buffer
comma
id|SCpnt-&gt;request_bufflen
comma
id|scsi_to_fc_dma_dir
c_func
(paren
id|SCpnt-&gt;sc_data_direction
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|scatterlist
op_star
id|sg
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|SCpnt-&gt;buffer
suffix:semicolon
r_int
id|nents
suffix:semicolon
id|FCD
c_func
(paren
(paren
l_string|&quot;XXX: Use_sg %d %d&bslash;n&quot;
comma
id|SCpnt-&gt;use_sg
comma
id|sg-&gt;length
)paren
)paren
id|nents
op_assign
id|dma_map_sg
(paren
id|fc-&gt;dev
comma
id|sg
comma
id|SCpnt-&gt;use_sg
comma
id|scsi_to_fc_dma_dir
c_func
(paren
id|SCpnt-&gt;sc_data_direction
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nents
OG
l_int|1
)paren
id|printk
(paren
l_string|&quot;%s: SG for nents %d (use_sg %d) not handled yet&bslash;n&quot;
comma
id|fc-&gt;name
comma
id|nents
comma
id|SCpnt-&gt;use_sg
)paren
suffix:semicolon
id|fcmd-&gt;data
op_assign
id|sg_dma_address
c_func
(paren
id|sg
)paren
suffix:semicolon
id|cmd-&gt;fcp_data_len
op_assign
id|sg_dma_len
c_func
(paren
id|sg
)paren
suffix:semicolon
)brace
)brace
id|memcpy
(paren
id|cmd-&gt;fcp_cdb
comma
id|SCpnt-&gt;cmnd
comma
id|SCpnt-&gt;cmd_len
)paren
suffix:semicolon
id|memset
(paren
id|cmd-&gt;fcp_cdb
op_plus
id|SCpnt-&gt;cmd_len
comma
l_int|0
comma
r_sizeof
(paren
id|cmd-&gt;fcp_cdb
)paren
op_minus
id|SCpnt-&gt;cmd_len
)paren
suffix:semicolon
id|FCD
c_func
(paren
(paren
l_string|&quot;XXX: %04x.%04x.%04x.%04x - %08x%08x%08x&bslash;n&quot;
comma
id|cmd-&gt;fcp_addr
(braket
l_int|0
)braket
comma
id|cmd-&gt;fcp_addr
(braket
l_int|1
)braket
comma
id|cmd-&gt;fcp_addr
(braket
l_int|2
)braket
comma
id|cmd-&gt;fcp_addr
(braket
l_int|3
)braket
comma
op_star
(paren
id|u32
op_star
)paren
id|SCpnt-&gt;cmnd
comma
op_star
(paren
id|u32
op_star
)paren
(paren
id|SCpnt-&gt;cmnd
op_plus
l_int|4
)paren
comma
op_star
(paren
id|u32
op_star
)paren
(paren
id|SCpnt-&gt;cmnd
op_plus
l_int|8
)paren
)paren
)paren
)brace
id|FCD
c_func
(paren
(paren
l_string|&quot;Trying to enque %p&bslash;n&quot;
comma
id|fcmd
)paren
)paren
r_if
c_cond
(paren
op_logical_neg
id|fc-&gt;scsi_que
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|fc-&gt;hw_enque
(paren
id|fc
comma
id|fcmd
)paren
)paren
(brace
id|FCD
c_func
(paren
(paren
l_string|&quot;hw_enque succeeded for %p&bslash;n&quot;
comma
id|fcmd
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|FCD
c_func
(paren
(paren
l_string|&quot;Putting into que1 %p&bslash;n&quot;
comma
id|fcmd
)paren
)paren
id|fcp_scsi_insert_queue
(paren
id|fc
comma
id|fcmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|fcp_scsi_queuecommand
r_int
id|fcp_scsi_queuecommand
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
id|fcp_cmnd
op_star
id|fcmd
op_assign
id|FCP_CMND
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|fc_channel
op_star
id|fc
op_assign
id|FC_SCMND
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|FCD
c_func
(paren
(paren
l_string|&quot;Entering SCSI queuecommand %p&bslash;n&quot;
comma
id|fcmd
)paren
)paren
r_if
c_cond
(paren
id|SCpnt-&gt;done
op_ne
id|fcp_scsi_done
)paren
(brace
id|fcmd-&gt;done
op_assign
id|SCpnt-&gt;done
suffix:semicolon
id|SCpnt-&gt;done
op_assign
id|fcp_scsi_done
suffix:semicolon
id|SCpnt-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|fcmd-&gt;proto
op_assign
id|TYPE_SCSI_FCP
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fc-&gt;scsi_free
)paren
(brace
id|FCD
c_func
(paren
(paren
l_string|&quot;FC: !scsi_free, putting cmd on ML queue&bslash;n&quot;
)paren
)paren
macro_line|#if (FCP_SCSI_USE_NEW_EH_CODE == 0)
id|printk
c_func
(paren
l_string|&quot;fcp_scsi_queue_command: queue full, losing cmd, bad&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|1
suffix:semicolon
)brace
r_return
id|fcp_scsi_queue_it
c_func
(paren
id|fc
comma
id|SCpnt
comma
id|fcmd
comma
l_int|1
)paren
suffix:semicolon
)brace
r_return
id|fcp_scsi_queue_it
c_func
(paren
id|fc
comma
id|SCpnt
comma
id|fcmd
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|fcp_queue_empty
r_void
id|fcp_queue_empty
c_func
(paren
id|fc_channel
op_star
id|fc
)paren
(brace
id|fcp_cmnd
op_star
id|fcmd
suffix:semicolon
id|FCD
c_func
(paren
(paren
l_string|&quot;Queue empty&bslash;n&quot;
)paren
)paren
r_while
c_loop
(paren
(paren
id|fcmd
op_assign
id|fc-&gt;scsi_que
)paren
)paren
(brace
multiline_comment|/* The hw told us we can try again queue some packet */
r_if
c_cond
(paren
id|fc-&gt;hw_enque
(paren
id|fc
comma
id|fcmd
)paren
)paren
r_break
suffix:semicolon
id|fcp_scsi_remove_queue
(paren
id|fc
comma
id|fcmd
)paren
suffix:semicolon
)brace
)brace
DECL|function|fcp_old_abort
r_int
id|fcp_old_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;FC: Abort not implemented&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|fcp_scsi_abort
r_int
id|fcp_scsi_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
multiline_comment|/* Internal bookkeeping only. Lose 1 cmd_slots slot. */
id|fcp_cmnd
op_star
id|fcmd
op_assign
id|FCP_CMND
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|fc_channel
op_star
id|fc
op_assign
id|FC_SCMND
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We react to abort requests by simply forgetting&n;&t; * about the command and pretending everything&squot;s sweet.&n;&t; * This may or may not be silly. We can&squot;t, however,&n;&t; * immediately reuse the command&squot;s cmd_slots slot,&n;&t; * as its result may arrive later and we cannot&n;&t; * check whether it is the aborted one, can&squot;t we?&n;&t; *&n;&t; * Therefore, after the first few aborts are done,&n;&t; * we tell the scsi error handler to do something clever.&n;&t; * It will eventually call host reset, refreshing&n;&t; * cmd_slots for us.&n;&t; *&n;&t; * There is a theoretical chance that we sometimes allow&n;&t; * more than can_queue packets to the jungle this way,&n;&t; * but the worst outcome possible is a series of&n;&t; * more aborts and eventually the dev_reset catharsis.&n;&t; */
r_if
c_cond
(paren
op_increment
id|fc-&gt;abort_count
OL
(paren
id|fc-&gt;can_queue
op_rshift
l_int|1
)paren
)paren
(brace
id|SCpnt-&gt;result
op_assign
id|DID_ABORT
suffix:semicolon
id|fcmd
op_member_access_from_pointer
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;FC: soft abort&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;FC: hard abort refused&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
)brace
DECL|function|fcp_scsi_reset_done
r_void
id|fcp_scsi_reset_done
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|fc_channel
op_star
id|fc
op_assign
id|FC_SCMND
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|fc-&gt;rst_pkt-&gt;eh_state
op_assign
id|SCSI_STATE_FINISHED
suffix:semicolon
id|up
c_func
(paren
id|fc-&gt;rst_pkt-&gt;host-&gt;eh_action
)paren
suffix:semicolon
)brace
DECL|macro|FCP_RESET_TIMEOUT
mdefine_line|#define FCP_RESET_TIMEOUT (2*HZ)
DECL|function|fcp_scsi_dev_reset
r_int
id|fcp_scsi_dev_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|fcp_cmd
op_star
id|cmd
suffix:semicolon
id|fcp_cmnd
op_star
id|fcmd
suffix:semicolon
id|fc_channel
op_star
id|fc
op_assign
id|FC_SCMND
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|DECLARE_MUTEX_LOCKED
c_func
(paren
id|sem
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fc-&gt;rst_pkt
)paren
(brace
id|fc-&gt;rst_pkt
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|SCpnt
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fc-&gt;rst_pkt
)paren
r_return
id|FAILED
suffix:semicolon
id|fcmd
op_assign
id|FCP_CMND
c_func
(paren
id|fc-&gt;rst_pkt
)paren
suffix:semicolon
id|fcmd-&gt;token
op_assign
l_int|0
suffix:semicolon
id|cmd
op_assign
id|fc-&gt;scsi_cmd_pool
op_plus
l_int|0
suffix:semicolon
id|FCD
c_func
(paren
(paren
l_string|&quot;Preparing rst packet&bslash;n&quot;
)paren
)paren
id|fc-&gt;encode_addr
(paren
id|SCpnt
comma
id|cmd-&gt;fcp_addr
comma
id|fc
comma
id|fcmd
)paren
suffix:semicolon
id|fc-&gt;rst_pkt-&gt;channel
op_assign
id|SCpnt-&gt;channel
suffix:semicolon
id|fc-&gt;rst_pkt-&gt;target
op_assign
id|SCpnt-&gt;target
suffix:semicolon
id|fc-&gt;rst_pkt-&gt;lun
op_assign
l_int|0
suffix:semicolon
id|fc-&gt;rst_pkt-&gt;cmd_len
op_assign
l_int|0
suffix:semicolon
id|fc-&gt;cmd_slots
(braket
l_int|0
)braket
op_assign
id|fcmd
suffix:semicolon
id|cmd-&gt;fcp_cntl
op_assign
id|FCP_CNTL_QTYPE_ORDERED
op_or
id|FCP_CNTL_RESET
suffix:semicolon
id|fcmd-&gt;data
op_assign
(paren
id|dma_addr_t
)paren
l_int|NULL
suffix:semicolon
id|fcmd-&gt;proto
op_assign
id|TYPE_SCSI_FCP
suffix:semicolon
id|memcpy
(paren
id|cmd-&gt;fcp_cdb
comma
id|SCpnt-&gt;cmnd
comma
id|SCpnt-&gt;cmd_len
)paren
suffix:semicolon
id|memset
(paren
id|cmd-&gt;fcp_cdb
op_plus
id|SCpnt-&gt;cmd_len
comma
l_int|0
comma
r_sizeof
(paren
id|cmd-&gt;fcp_cdb
)paren
op_minus
id|SCpnt-&gt;cmd_len
)paren
suffix:semicolon
id|FCD
c_func
(paren
(paren
l_string|&quot;XXX: %04x.%04x.%04x.%04x - %08x%08x%08x&bslash;n&quot;
comma
id|cmd-&gt;fcp_addr
(braket
l_int|0
)braket
comma
id|cmd-&gt;fcp_addr
(braket
l_int|1
)braket
comma
id|cmd-&gt;fcp_addr
(braket
l_int|2
)braket
comma
id|cmd-&gt;fcp_addr
(braket
l_int|3
)braket
comma
op_star
(paren
id|u32
op_star
)paren
id|SCpnt-&gt;cmnd
comma
op_star
(paren
id|u32
op_star
)paren
(paren
id|SCpnt-&gt;cmnd
op_plus
l_int|4
)paren
comma
op_star
(paren
id|u32
op_star
)paren
(paren
id|SCpnt-&gt;cmnd
op_plus
l_int|8
)paren
)paren
)paren
)brace
r_else
(brace
id|fcmd
op_assign
id|FCP_CMND
c_func
(paren
id|fc-&gt;rst_pkt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fc-&gt;rst_pkt-&gt;eh_state
op_eq
id|SCSI_STATE_QUEUED
)paren
r_return
id|FAILED
suffix:semicolon
multiline_comment|/* or SUCCESS. Only these */
)brace
id|fc-&gt;rst_pkt-&gt;done
op_assign
l_int|NULL
suffix:semicolon
id|fc-&gt;rst_pkt-&gt;eh_state
op_assign
id|SCSI_STATE_QUEUED
suffix:semicolon
id|fc-&gt;rst_pkt-&gt;eh_timeout.data
op_assign
(paren
r_int
r_int
)paren
id|fc-&gt;rst_pkt
suffix:semicolon
id|fc-&gt;rst_pkt-&gt;eh_timeout.expires
op_assign
id|jiffies
op_plus
id|FCP_RESET_TIMEOUT
suffix:semicolon
id|fc-&gt;rst_pkt-&gt;eh_timeout.function
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_int
r_int
)paren
)paren
id|fcp_scsi_reset_done
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|fc-&gt;rst_pkt-&gt;eh_timeout
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set up the semaphore so we wait for the command to complete.&n;&t; */
id|fc-&gt;rst_pkt-&gt;host-&gt;eh_action
op_assign
op_amp
id|sem
suffix:semicolon
id|fc-&gt;rst_pkt-&gt;request.rq_status
op_assign
id|RQ_SCSI_BUSY
suffix:semicolon
id|fc-&gt;rst_pkt-&gt;done
op_assign
id|fcp_scsi_reset_done
suffix:semicolon
id|fcp_scsi_queue_it
c_func
(paren
id|fc
comma
id|fc-&gt;rst_pkt
comma
id|fcmd
comma
l_int|0
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|sem
)paren
suffix:semicolon
id|fc-&gt;rst_pkt-&gt;host-&gt;eh_action
op_assign
l_int|NULL
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|fc-&gt;rst_pkt-&gt;eh_timeout
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * See if timeout.  If so, tell the host to forget about it.&n;&t; * In other words, we don&squot;t want a callback any more.&n;&t; */
r_if
c_cond
(paren
id|fc-&gt;rst_pkt-&gt;eh_state
op_eq
id|SCSI_STATE_TIMEOUT
)paren
(brace
id|fc-&gt;rst_pkt-&gt;eh_state
op_assign
id|SCSI_STATE_UNUSED
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|fc-&gt;rst_pkt-&gt;eh_state
op_assign
id|SCSI_STATE_UNUSED
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
DECL|function|fcp_scsi_bus_reset
r_int
id|fcp_scsi_bus_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|printk
(paren
l_string|&quot;FC: bus reset!&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
DECL|function|fcp_scsi_host_reset
r_int
id|fcp_scsi_host_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|fc_channel
op_star
id|fc
op_assign
id|FC_SCMND
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|fcp_cmnd
op_star
id|fcmd
op_assign
id|FCP_CMND
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
id|printk
(paren
l_string|&quot;FC: host reset&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|fc-&gt;can_queue
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|fc-&gt;cmd_slots
(braket
id|i
)braket
op_logical_and
id|SCpnt-&gt;result
op_ne
id|DID_ABORT
)paren
(brace
id|SCpnt-&gt;result
op_assign
id|DID_RESET
suffix:semicolon
id|fcmd
op_member_access_from_pointer
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|fc-&gt;cmd_slots
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|fc
op_member_access_from_pointer
id|reset
c_func
(paren
id|fc
)paren
suffix:semicolon
id|fc-&gt;abort_count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|fcp_initialize
c_func
(paren
id|fc
comma
l_int|1
)paren
)paren
r_return
id|SUCCESS
suffix:semicolon
r_else
r_return
id|FAILED
suffix:semicolon
)brace
DECL|function|fcp_els_queue_it
r_static
r_int
id|fcp_els_queue_it
c_func
(paren
id|fc_channel
op_star
id|fc
comma
id|fcp_cmnd
op_star
id|fcmd
)paren
(brace
r_int
id|i
suffix:semicolon
id|i
op_assign
id|find_first_zero_bit
(paren
id|fc-&gt;scsi_bitmap
comma
id|fc-&gt;scsi_bitmap_end
)paren
suffix:semicolon
id|set_bit
(paren
id|i
comma
id|fc-&gt;scsi_bitmap
)paren
suffix:semicolon
id|fcmd-&gt;token
op_assign
id|i
suffix:semicolon
id|fc-&gt;scsi_free
op_decrement
suffix:semicolon
id|fc-&gt;cmd_slots
(braket
id|fcmd-&gt;token
)braket
op_assign
id|fcmd
suffix:semicolon
r_return
id|fcp_scsi_queue_it
c_func
(paren
id|fc
comma
l_int|NULL
comma
id|fcmd
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|fc_do_els
r_static
r_int
id|fc_do_els
c_func
(paren
id|fc_channel
op_star
id|fc
comma
r_int
r_int
id|alpa
comma
r_void
op_star
id|data
comma
r_int
id|len
)paren
(brace
id|fcp_cmnd
id|_fcmd
comma
op_star
id|fcmd
suffix:semicolon
id|fc_hdr
op_star
id|fch
suffix:semicolon
id|lse
id|l
suffix:semicolon
r_int
id|i
suffix:semicolon
id|fcmd
op_assign
op_amp
id|_fcmd
suffix:semicolon
id|memset
c_func
(paren
id|fcmd
comma
l_int|0
comma
r_sizeof
(paren
id|fcmd
)paren
)paren
suffix:semicolon
id|FCD
c_func
(paren
(paren
l_string|&quot;PLOGI SID %d DID %d&bslash;n&quot;
comma
id|fc-&gt;sid
comma
id|alpa
)paren
)paren
id|fch
op_assign
op_amp
id|fcmd-&gt;fch
suffix:semicolon
id|FILL_FCHDR_RCTL_DID
c_func
(paren
id|fch
comma
id|R_CTL_ELS_REQ
comma
id|alpa
)paren
suffix:semicolon
id|FILL_FCHDR_SID
c_func
(paren
id|fch
comma
id|fc-&gt;sid
)paren
suffix:semicolon
id|FILL_FCHDR_TYPE_FCTL
c_func
(paren
id|fch
comma
id|TYPE_EXTENDED_LS
comma
id|F_CTL_FIRST_SEQ
op_or
id|F_CTL_SEQ_INITIATIVE
)paren
suffix:semicolon
id|FILL_FCHDR_SEQ_DF_SEQ
c_func
(paren
id|fch
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|FILL_FCHDR_OXRX
c_func
(paren
id|fch
comma
l_int|0xffff
comma
l_int|0xffff
)paren
suffix:semicolon
id|fch-&gt;param
op_assign
l_int|0
suffix:semicolon
id|fcmd-&gt;cmd
op_assign
id|dma_map_single
(paren
id|fc-&gt;dev
comma
id|data
comma
l_int|2
op_star
id|len
comma
id|FC_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|fcmd-&gt;rsp
op_assign
id|fcmd-&gt;cmd
op_plus
id|len
suffix:semicolon
id|fcmd-&gt;cmdlen
op_assign
id|len
suffix:semicolon
id|fcmd-&gt;rsplen
op_assign
id|len
suffix:semicolon
id|fcmd-&gt;data
op_assign
(paren
id|dma_addr_t
)paren
l_int|NULL
suffix:semicolon
id|fcmd-&gt;fc
op_assign
id|fc
suffix:semicolon
id|fcmd
op_member_access_from_pointer
r_class
op_assign
id|FC_CLASS_SIMPLE
suffix:semicolon
id|fcmd-&gt;proto
op_assign
id|TYPE_EXTENDED_LS
suffix:semicolon
id|memset
(paren
op_amp
id|l
comma
l_int|0
comma
r_sizeof
(paren
id|lse
)paren
)paren
suffix:semicolon
id|l.magic
op_assign
id|LSEMAGIC
suffix:semicolon
id|init_MUTEX_LOCKED
c_func
(paren
op_amp
id|l.sem
)paren
suffix:semicolon
id|l.timer.function
op_assign
id|fcp_login_timeout
suffix:semicolon
id|l.timer.data
op_assign
(paren
r_int
r_int
)paren
op_amp
id|l
suffix:semicolon
id|l.status
op_assign
id|FC_STATUS_TIMED_OUT
suffix:semicolon
id|fcmd-&gt;ls
op_assign
(paren
r_void
op_star
)paren
op_amp
id|l
suffix:semicolon
id|disable_irq
c_func
(paren
id|fc-&gt;irq
)paren
suffix:semicolon
id|fcp_els_queue_it
c_func
(paren
id|fc
comma
id|fcmd
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|fc-&gt;irq
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
suffix:semicolon
)paren
(brace
id|l.timer.expires
op_assign
id|jiffies
op_plus
l_int|5
op_star
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|l.timer
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|l.sem
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|l.timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|l.status
op_ne
id|FC_STATUS_TIMED_OUT
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|i
op_eq
l_int|3
)paren
r_break
suffix:semicolon
id|disable_irq
c_func
(paren
id|fc-&gt;irq
)paren
suffix:semicolon
id|fcp_scsi_queue_it
c_func
(paren
id|fc
comma
l_int|NULL
comma
id|fcmd
comma
l_int|0
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|fc-&gt;irq
)paren
suffix:semicolon
)brace
id|clear_bit
c_func
(paren
id|fcmd-&gt;token
comma
id|fc-&gt;scsi_bitmap
)paren
suffix:semicolon
id|fc-&gt;scsi_free
op_increment
suffix:semicolon
id|dma_unmap_single
(paren
id|fc-&gt;dev
comma
id|fcmd-&gt;cmd
comma
l_int|2
op_star
id|len
comma
id|FC_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
r_return
id|l.status
suffix:semicolon
)brace
DECL|function|fc_do_plogi
r_int
id|fc_do_plogi
c_func
(paren
id|fc_channel
op_star
id|fc
comma
r_int
r_char
id|alpa
comma
id|fc_wwn
op_star
id|node
comma
id|fc_wwn
op_star
id|nport
)paren
(brace
id|logi
op_star
id|l
suffix:semicolon
r_int
id|status
suffix:semicolon
id|l
op_assign
(paren
id|logi
op_star
)paren
id|kmalloc
c_func
(paren
l_int|2
op_star
r_sizeof
(paren
id|logi
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|l
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|l
comma
l_int|0
comma
l_int|2
op_star
r_sizeof
(paren
id|logi
)paren
)paren
suffix:semicolon
id|l-&gt;code
op_assign
id|LS_PLOGI
suffix:semicolon
id|memcpy
(paren
op_amp
id|l-&gt;nport_wwn
comma
op_amp
id|fc-&gt;wwn_nport
comma
r_sizeof
(paren
id|fc_wwn
)paren
)paren
suffix:semicolon
id|memcpy
(paren
op_amp
id|l-&gt;node_wwn
comma
op_amp
id|fc-&gt;wwn_node
comma
r_sizeof
(paren
id|fc_wwn
)paren
)paren
suffix:semicolon
id|memcpy
(paren
op_amp
id|l-&gt;common
comma
id|fc-&gt;common_svc
comma
r_sizeof
(paren
id|common_svc_parm
)paren
)paren
suffix:semicolon
id|memcpy
(paren
op_amp
id|l-&gt;class1
comma
id|fc-&gt;class_svcs
comma
l_int|3
op_star
r_sizeof
(paren
id|svc_parm
)paren
)paren
suffix:semicolon
id|status
op_assign
id|fc_do_els
c_func
(paren
id|fc
comma
id|alpa
comma
id|l
comma
r_sizeof
(paren
id|logi
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
id|FC_STATUS_OK
)paren
(brace
r_if
c_cond
(paren
id|l
(braket
l_int|1
)braket
dot
id|code
op_eq
id|LS_ACC
)paren
(brace
macro_line|#ifdef FCDEBUG
id|u32
op_star
id|u
op_assign
(paren
id|u32
op_star
)paren
op_amp
id|l
(braket
l_int|1
)braket
dot
id|nport_wwn
suffix:semicolon
id|FCD
c_func
(paren
(paren
l_string|&quot;AL-PA %02x: Port WWN %08x%08x Node WWN %08x%08x&bslash;n&quot;
comma
id|alpa
comma
id|u
(braket
l_int|0
)braket
comma
id|u
(braket
l_int|1
)braket
comma
id|u
(braket
l_int|2
)braket
comma
id|u
(braket
l_int|3
)braket
)paren
)paren
macro_line|#endif
id|memcpy
c_func
(paren
id|nport
comma
op_amp
id|l
(braket
l_int|1
)braket
dot
id|nport_wwn
comma
r_sizeof
(paren
id|fc_wwn
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|node
comma
op_amp
id|l
(braket
l_int|1
)braket
dot
id|node_wwn
comma
r_sizeof
(paren
id|fc_wwn
)paren
)paren
suffix:semicolon
)brace
r_else
id|status
op_assign
id|FC_STATUS_BAD_RSP
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|l
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
r_typedef
r_struct
(brace
DECL|member|code
r_int
r_int
id|code
suffix:semicolon
DECL|member|params
r_int
id|params
(braket
l_int|4
)braket
suffix:semicolon
DECL|typedef|prli
)brace
id|prli
suffix:semicolon
DECL|function|fc_do_prli
r_int
id|fc_do_prli
c_func
(paren
id|fc_channel
op_star
id|fc
comma
r_int
r_char
id|alpa
)paren
(brace
id|prli
op_star
id|p
suffix:semicolon
r_int
id|status
suffix:semicolon
id|p
op_assign
(paren
id|prli
op_star
)paren
id|kmalloc
c_func
(paren
l_int|2
op_star
r_sizeof
(paren
id|prli
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|p
comma
l_int|0
comma
l_int|2
op_star
r_sizeof
(paren
id|prli
)paren
)paren
suffix:semicolon
id|p-&gt;code
op_assign
id|LS_PRLI
suffix:semicolon
id|p-&gt;params
(braket
l_int|0
)braket
op_assign
l_int|0x08002000
suffix:semicolon
id|p-&gt;params
(braket
l_int|3
)braket
op_assign
l_int|0x00000022
suffix:semicolon
id|status
op_assign
id|fc_do_els
c_func
(paren
id|fc
comma
id|alpa
comma
id|p
comma
r_sizeof
(paren
id|prli
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
id|FC_STATUS_OK
op_logical_and
id|p
(braket
l_int|1
)braket
dot
id|code
op_ne
id|LS_PRLI_ACC
op_logical_and
id|p
(braket
l_int|1
)braket
dot
id|code
op_ne
id|LS_ACC
)paren
id|status
op_assign
id|FC_STATUS_BAD_RSP
suffix:semicolon
id|kfree
c_func
(paren
id|p
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
)brace
macro_line|#endif
eof
