multiline_comment|/* $Id: isdn_net.c,v 1.140.6.1 2000/12/10 22:01:04 kai Exp $&n;&n; * Linux ISDN subsystem, network interfaces and related functions (linklevel).&n; *&n; * Copyright 1994-1998  by Fritz Elfert (fritz@isdn4linux.de)&n; * Copyright 1995,96    by Thinking Objects Software GmbH Wuerzburg&n; * Copyright 1995,96    by Michael Hipp (Michael.Hipp@student.uni-tuebingen.de)&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/isdn.h&gt;
macro_line|#include &lt;net/arp.h&gt;
macro_line|#include &lt;net/dst.h&gt;
macro_line|#include &lt;net/pkt_sched.h&gt;
macro_line|#include &lt;linux/inetdevice.h&gt;
macro_line|#include &quot;isdn_common.h&quot;
macro_line|#include &quot;isdn_net.h&quot;
macro_line|#ifdef CONFIG_ISDN_PPP
macro_line|#include &quot;isdn_ppp.h&quot;
macro_line|#endif
macro_line|#ifdef CONFIG_ISDN_X25
macro_line|#include &lt;linux/concap.h&gt;
macro_line|#include &quot;isdn_concap.h&quot;
macro_line|#endif
multiline_comment|/*&n; * Outline of new tbusy handling: &n; *&n; * Old method, roughly spoken, consisted of setting tbusy when entering&n; * isdn_net_start_xmit() and at several other locations and clearing&n; * it from isdn_net_start_xmit() thread when sending was successful.&n; *&n; * With 2.3.x multithreaded network core, to prevent problems, tbusy should&n; * only be set by the isdn_net_start_xmit() thread and only when a tx-busy&n; * condition is detected. Other threads (in particular isdn_net_stat_callb())&n; * are only allowed to clear tbusy.&n; *&n; * -HE&n; */
multiline_comment|/*&n; * About SOFTNET:&n; * Most of the changes were pretty obvious and basically done by HE already.&n; *&n; * One problem of the isdn net device code is that is uses struct net_device&n; * for masters and slaves. However, only master interface are registered to &n; * the network layer, and therefore, it only makes sense to call netif_* &n; * functions on them.&n; *&n; * --KG&n; */
multiline_comment|/* &n; * Find out if the netdevice has been ifup-ed yet.&n; * For slaves, look at the corresponding master.&n; */
DECL|function|isdn_net_device_started
r_static
id|__inline__
r_int
id|isdn_net_device_started
c_func
(paren
id|isdn_net_dev
op_star
id|n
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
id|n-&gt;local
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;master
)paren
id|dev
op_assign
id|lp-&gt;master
suffix:semicolon
r_else
id|dev
op_assign
op_amp
id|n-&gt;dev
suffix:semicolon
r_return
id|netif_running
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * wake up the network -&gt; net_device queue.&n; * For slaves, wake the corresponding master interface.&n; */
DECL|function|isdn_net_device_wake_queue
r_static
id|__inline__
r_void
id|isdn_net_device_wake_queue
c_func
(paren
id|isdn_net_local
op_star
id|lp
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;master
)paren
id|netif_wake_queue
c_func
(paren
id|lp-&gt;master
)paren
suffix:semicolon
r_else
id|netif_wake_queue
c_func
(paren
op_amp
id|lp-&gt;netdev-&gt;dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * stop the network -&gt; net_device queue.&n; * For slaves, stop the corresponding master interface.&n; */
DECL|function|isdn_net_device_stop_queue
r_static
id|__inline__
r_void
id|isdn_net_device_stop_queue
c_func
(paren
id|isdn_net_local
op_star
id|lp
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;master
)paren
id|netif_stop_queue
c_func
(paren
id|lp-&gt;master
)paren
suffix:semicolon
r_else
id|netif_stop_queue
c_func
(paren
op_amp
id|lp-&gt;netdev-&gt;dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * find out if the net_device which this lp belongs to (lp can be&n; * master or slave) is busy. It&squot;s busy iff all (master and slave) &n; * queues are busy&n; */
DECL|function|isdn_net_device_busy
r_static
id|__inline__
r_int
id|isdn_net_device_busy
c_func
(paren
id|isdn_net_local
op_star
id|lp
)paren
(brace
id|isdn_net_local
op_star
id|nlp
suffix:semicolon
id|isdn_net_dev
op_star
id|nd
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|isdn_net_lp_busy
c_func
(paren
id|lp
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;master
)paren
id|nd
op_assign
(paren
(paren
id|isdn_net_local
op_star
)paren
id|lp-&gt;master-&gt;priv
)paren
op_member_access_from_pointer
id|netdev
suffix:semicolon
r_else
id|nd
op_assign
id|lp-&gt;netdev
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|nd-&gt;queue_lock
comma
id|flags
)paren
suffix:semicolon
id|nlp
op_assign
id|lp-&gt;next
suffix:semicolon
r_while
c_loop
(paren
id|nlp
op_ne
id|lp
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|isdn_net_lp_busy
c_func
(paren
id|nlp
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|nd-&gt;queue_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|nlp
op_assign
id|nlp-&gt;next
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|nd-&gt;queue_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|isdn_net_inc_frame_cnt
r_static
id|__inline__
r_void
id|isdn_net_inc_frame_cnt
c_func
(paren
id|isdn_net_local
op_star
id|lp
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|lp-&gt;frame_cnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isdn_net_device_busy
c_func
(paren
id|lp
)paren
)paren
id|isdn_net_device_stop_queue
c_func
(paren
id|lp
)paren
suffix:semicolon
)brace
DECL|function|isdn_net_dec_frame_cnt
r_static
id|__inline__
r_void
id|isdn_net_dec_frame_cnt
c_func
(paren
id|isdn_net_local
op_star
id|lp
)paren
(brace
id|atomic_dec
c_func
(paren
op_amp
id|lp-&gt;frame_cnt
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|isdn_net_device_busy
c_func
(paren
id|lp
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|skb_queue_empty
c_func
(paren
op_amp
id|lp-&gt;super_tx_queue
)paren
)paren
(brace
id|queue_task
c_func
(paren
op_amp
id|lp-&gt;tqueue
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
)brace
r_else
(brace
id|isdn_net_device_wake_queue
c_func
(paren
id|lp
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|isdn_net_zero_frame_cnt
r_static
id|__inline__
r_void
id|isdn_net_zero_frame_cnt
c_func
(paren
id|isdn_net_local
op_star
id|lp
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|lp-&gt;frame_cnt
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* For 2.2.x we leave the transmitter busy timeout at 2 secs, just &n; * to be safe.&n; * For 2.3.x we push it up to 20 secs, because call establishment&n; * (in particular callback) may take such a long time, and we &n; * don&squot;t want confusing messages in the log. However, there is a slight&n; * possibility that this large timeout will break other things like MPPP,&n; * which might rely on the tx timeout. If so, we&squot;ll find out this way...&n; */
DECL|macro|ISDN_NET_TX_TIMEOUT
mdefine_line|#define ISDN_NET_TX_TIMEOUT (20*HZ) 
multiline_comment|/* Prototypes */
r_int
id|isdn_net_force_dial_lp
c_func
(paren
id|isdn_net_local
op_star
)paren
suffix:semicolon
r_static
r_int
id|isdn_net_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
comma
r_struct
id|net_device
op_star
)paren
suffix:semicolon
DECL|variable|isdn_net_revision
r_char
op_star
id|isdn_net_revision
op_assign
l_string|&quot;$Revision: 1.140.6.1 $&quot;
suffix:semicolon
multiline_comment|/*&n;  * Code for raw-networking over ISDN&n;  */
r_static
r_void
DECL|function|isdn_net_unreachable
id|isdn_net_unreachable
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_char
op_star
id|reason
)paren
(brace
r_if
c_cond
(paren
id|skb
)paren
(brace
id|u_short
id|proto
op_assign
id|ntohs
c_func
(paren
id|skb-&gt;protocol
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_net: %s: %s, signalling dst_link_failure %s&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
id|reason
op_ne
l_int|NULL
)paren
ques
c_cond
id|reason
suffix:colon
l_string|&quot;unknown&quot;
comma
(paren
id|proto
op_ne
id|ETH_P_IP
)paren
ques
c_cond
l_string|&quot;Protocol != ETH_P_IP&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|dst_link_failure
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* dial not triggered by rawIP packet */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_net: %s: %s&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
id|reason
op_ne
l_int|NULL
)paren
ques
c_cond
id|reason
suffix:colon
l_string|&quot;reason unknown&quot;
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|isdn_net_reset
id|isdn_net_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
macro_line|#ifdef CONFIG_ISDN_X25
r_struct
id|concap_device_ops
op_star
id|dops
op_assign
(paren
(paren
id|isdn_net_local
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|dops
suffix:semicolon
r_struct
id|concap_proto
op_star
id|cprot
op_assign
(paren
(paren
id|isdn_net_local
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|netdev
op_member_access_from_pointer
id|cprot
suffix:semicolon
macro_line|#endif
id|ulong
id|flags
suffix:semicolon
multiline_comment|/* not sure if the cli() is needed at all --KG */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Avoid glitch on writes to CMD regs */
macro_line|#ifdef CONFIG_ISDN_X25
r_if
c_cond
(paren
id|cprot
op_logical_and
id|cprot
op_member_access_from_pointer
id|pops
op_logical_and
id|dops
)paren
(brace
id|cprot
op_member_access_from_pointer
id|pops
op_member_access_from_pointer
id|restart
(paren
id|cprot
comma
id|dev
comma
id|dops
)paren
suffix:semicolon
)brace
macro_line|#endif
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Open/initialize the board. */
r_static
r_int
DECL|function|isdn_net_open
id|isdn_net_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|net_device
op_star
id|p
suffix:semicolon
r_struct
id|in_device
op_star
id|in_dev
suffix:semicolon
multiline_comment|/* moved here from isdn_net_reset, because only the master has an&n;&t;   interface associated which is supposed to be started. BTW:&n;&t;   we need to call netif_start_queue, not netif_wake_queue here */
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|isdn_net_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Fill in the MAC-level header (not needed, but for compatibility... */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ETH_ALEN
op_minus
r_sizeof
(paren
id|u32
)paren
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
l_int|0xfc
suffix:semicolon
r_if
c_cond
(paren
(paren
id|in_dev
op_assign
id|dev-&gt;ip_ptr
)paren
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/*&n;&t;&t; *      Any address will do - we take the first&n;&t;&t; */
r_struct
id|in_ifaddr
op_star
id|ifa
op_assign
id|in_dev-&gt;ifa_list
suffix:semicolon
r_if
c_cond
(paren
id|ifa
op_ne
l_int|NULL
)paren
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
op_plus
l_int|2
comma
op_amp
id|ifa-&gt;ifa_local
comma
l_int|4
)paren
suffix:semicolon
)brace
multiline_comment|/* If this interface has slaves, start them also */
r_if
c_cond
(paren
(paren
id|p
op_assign
(paren
(paren
(paren
id|isdn_net_local
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|slave
)paren
)paren
)paren
(brace
r_while
c_loop
(paren
id|p
)paren
(brace
id|isdn_net_reset
c_func
(paren
id|p
)paren
suffix:semicolon
id|p
op_assign
(paren
(paren
(paren
id|isdn_net_local
op_star
)paren
id|p-&gt;priv
)paren
op_member_access_from_pointer
id|slave
)paren
suffix:semicolon
)brace
)brace
id|isdn_MOD_INC_USE_COUNT
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Assign an ISDN-channel to a net-interface&n; */
r_static
r_void
DECL|function|isdn_net_bind_channel
id|isdn_net_bind_channel
c_func
(paren
id|isdn_net_local
op_star
id|lp
comma
r_int
id|idx
)paren
(brace
id|ulong
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|lp-&gt;flags
op_or_assign
id|ISDN_NET_CONNECTED
suffix:semicolon
id|lp-&gt;isdn_device
op_assign
id|dev-&gt;drvmap
(braket
id|idx
)braket
suffix:semicolon
id|lp-&gt;isdn_channel
op_assign
id|dev-&gt;chanmap
(braket
id|idx
)braket
suffix:semicolon
id|dev-&gt;rx_netdev
(braket
id|idx
)braket
op_assign
id|lp-&gt;netdev
suffix:semicolon
id|dev-&gt;st_netdev
(braket
id|idx
)braket
op_assign
id|lp-&gt;netdev
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * unbind a net-interface (resets interface after an error)&n; */
r_static
r_void
DECL|function|isdn_net_unbind_channel
id|isdn_net_unbind_channel
c_func
(paren
id|isdn_net_local
op_star
id|lp
)paren
(brace
id|ulong
id|flags
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|lp-&gt;super_tx_queue
)paren
)paren
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;master
)paren
(brace
multiline_comment|/* reset only master device */
multiline_comment|/* Moral equivalent of dev_purge_queues():&n;&t;&t;   BEWARE! This chunk of code cannot be called from hardware&n;&t;&t;   interrupt handler. I hope it is true. --ANK&n;&t;&t; */
id|qdisc_reset
c_func
(paren
id|lp-&gt;netdev-&gt;dev.qdisc
)paren
suffix:semicolon
)brace
id|lp-&gt;dialstate
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;rx_netdev
(braket
id|isdn_dc2minor
c_func
(paren
id|lp-&gt;isdn_device
comma
id|lp-&gt;isdn_channel
)paren
)braket
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;st_netdev
(braket
id|isdn_dc2minor
c_func
(paren
id|lp-&gt;isdn_device
comma
id|lp-&gt;isdn_channel
)paren
)braket
op_assign
l_int|NULL
suffix:semicolon
id|isdn_free_channel
c_func
(paren
id|lp-&gt;isdn_device
comma
id|lp-&gt;isdn_channel
comma
id|ISDN_USAGE_NET
)paren
suffix:semicolon
id|lp-&gt;flags
op_and_assign
op_complement
id|ISDN_NET_CONNECTED
suffix:semicolon
id|lp-&gt;isdn_device
op_assign
op_minus
l_int|1
suffix:semicolon
id|lp-&gt;isdn_channel
op_assign
op_minus
l_int|1
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Perform auto-hangup and cps-calculation for net-interfaces.&n; *&n; * auto-hangup:&n; * Increment idle-counter (this counter is reset on any incoming or&n; * outgoing packet), if counter exceeds configured limit either do a&n; * hangup immediately or - if configured - wait until just before the next&n; * charge-info.&n; *&n; * cps-calculation (needed for dynamic channel-bundling):&n; * Since this function is called every second, simply reset the&n; * byte-counter of the interface after copying it to the cps-variable.&n; */
DECL|variable|last_jiffies
r_int
r_int
id|last_jiffies
op_assign
op_minus
id|HZ
suffix:semicolon
r_void
DECL|function|isdn_net_autohup
id|isdn_net_autohup
c_func
(paren
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|dev-&gt;netdev
suffix:semicolon
r_int
id|anymore
suffix:semicolon
id|anymore
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
id|isdn_net_local
op_star
id|l
op_assign
id|p-&gt;local
suffix:semicolon
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|last_jiffies
)paren
op_eq
l_int|0
)paren
id|l-&gt;cps
op_assign
id|l-&gt;transcount
suffix:semicolon
r_else
id|l-&gt;cps
op_assign
(paren
id|l-&gt;transcount
op_star
id|HZ
)paren
op_div
(paren
id|jiffies
op_minus
id|last_jiffies
)paren
suffix:semicolon
id|l-&gt;transcount
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;net_verbose
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: %d bogocps&bslash;n&quot;
comma
id|l-&gt;name
comma
id|l-&gt;cps
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|l-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
op_logical_and
(paren
op_logical_neg
id|l-&gt;dialstate
)paren
)paren
(brace
id|anymore
op_assign
l_int|1
suffix:semicolon
id|l-&gt;huptimer
op_increment
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * if there is some dialmode where timeout-hangup&n;&t;&t;&t; * should _not_ be done, check for that here&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|l-&gt;onhtime
)paren
op_logical_and
(paren
id|l-&gt;huptimer
OG
id|l-&gt;onhtime
)paren
)paren
(brace
r_if
c_cond
(paren
id|l-&gt;hupflags
op_amp
id|ISDN_MANCHARGE
op_logical_and
id|l-&gt;hupflags
op_amp
id|ISDN_CHARGEHUP
)paren
(brace
r_while
c_loop
(paren
id|jiffies
op_minus
id|l-&gt;chargetime
OG
id|l-&gt;chargeint
)paren
id|l-&gt;chargetime
op_add_assign
id|l-&gt;chargeint
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_minus
id|l-&gt;chargetime
op_ge
id|l-&gt;chargeint
op_minus
l_int|2
op_star
id|HZ
)paren
r_if
c_cond
(paren
id|l-&gt;outgoing
op_logical_or
id|l-&gt;hupflags
op_amp
id|ISDN_INHUP
)paren
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|l-&gt;outgoing
)paren
(brace
r_if
c_cond
(paren
id|l-&gt;hupflags
op_amp
id|ISDN_CHARGEHUP
)paren
(brace
r_if
c_cond
(paren
id|l-&gt;hupflags
op_amp
id|ISDN_WAITCHARGE
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_net: Hupflags of %s are %X&bslash;n&quot;
comma
id|l-&gt;name
comma
id|l-&gt;hupflags
)paren
suffix:semicolon
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|jiffies
op_minus
id|l-&gt;chargetime
OG
id|l-&gt;chargeint
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_net: %s: chtime = %lu, chint = %d&bslash;n&quot;
comma
id|l-&gt;name
comma
id|l-&gt;chargetime
comma
id|l-&gt;chargeint
)paren
suffix:semicolon
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
)brace
)brace
r_else
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|l-&gt;hupflags
op_amp
id|ISDN_INHUP
)paren
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;global_flags
op_amp
id|ISDN_GLOBAL_STOPPED
op_logical_or
(paren
id|ISDN_NET_DIALMODE
c_func
(paren
op_star
id|l
)paren
op_eq
id|ISDN_NET_DM_OFF
)paren
)paren
(brace
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|p
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|p-&gt;next
suffix:semicolon
)brace
id|last_jiffies
op_assign
id|jiffies
suffix:semicolon
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_NETHANGUP
comma
id|anymore
)paren
suffix:semicolon
)brace
DECL|function|isdn_net_lp_disconnected
r_static
r_void
id|isdn_net_lp_disconnected
c_func
(paren
id|isdn_net_local
op_star
id|lp
)paren
(brace
id|isdn_net_rm_from_bundle
c_func
(paren
id|lp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Handle status-messages from ISDN-interfacecard.&n; * This function is called from within the main-status-dispatcher&n; * isdn_status_callback, which itself is called from the low-level driver.&n; * Return: 1 = Event handled, 0 = not for us or unknown Event.&n; */
r_int
DECL|function|isdn_net_stat_callback
id|isdn_net_stat_callback
c_func
(paren
r_int
id|idx
comma
id|isdn_ctrl
op_star
id|c
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|dev-&gt;st_netdev
(braket
id|idx
)braket
suffix:semicolon
r_int
id|cmd
op_assign
id|c-&gt;command
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
id|p-&gt;local
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_X25
r_struct
id|concap_proto
op_star
id|cprot
op_assign
id|lp
op_member_access_from_pointer
id|netdev
op_member_access_from_pointer
id|cprot
suffix:semicolon
r_struct
id|concap_proto_ops
op_star
id|pops
op_assign
id|cprot
ques
c_cond
id|cprot
op_member_access_from_pointer
id|pops
suffix:colon
l_int|0
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|ISDN_STAT_BSENT
suffix:colon
multiline_comment|/* A packet has successfully been sent out */
r_if
c_cond
(paren
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
op_logical_and
(paren
op_logical_neg
id|lp-&gt;dialstate
)paren
)paren
(brace
id|isdn_net_dec_frame_cnt
c_func
(paren
id|lp
)paren
suffix:semicolon
id|lp-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_bytes
op_add_assign
id|c-&gt;parm.length
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
r_case
id|ISDN_STAT_DCONN
suffix:colon
multiline_comment|/* D-Channel is up */
r_switch
c_cond
(paren
id|lp-&gt;dialstate
)paren
(brace
r_case
l_int|4
suffix:colon
r_case
l_int|7
suffix:colon
r_case
l_int|8
suffix:colon
id|lp-&gt;dialstate
op_increment
suffix:semicolon
r_return
l_int|1
suffix:semicolon
r_case
l_int|12
suffix:colon
id|lp-&gt;dialstate
op_assign
l_int|5
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_STAT_DHUP
suffix:colon
multiline_comment|/* Either D-Channel-hangup or error during dialout */
macro_line|#ifdef CONFIG_ISDN_X25
multiline_comment|/* If we are not connencted then dialing had&n;&t;&t;&t;&t;   failed. If there are generic encap protocol&n;&t;&t;&t;&t;   receiver routines signal the closure of&n;&t;&t;&t;&t;   the link*/
r_if
c_cond
(paren
op_logical_neg
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
op_logical_and
id|pops
op_logical_and
id|pops
op_member_access_from_pointer
id|disconn_ind
)paren
(brace
id|pops
op_member_access_from_pointer
id|disconn_ind
c_func
(paren
id|cprot
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ISDN_X25 */
r_if
c_cond
(paren
(paren
op_logical_neg
id|lp-&gt;dialstate
)paren
op_logical_and
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
)paren
(brace
macro_line|#ifdef CONFIG_ISDN_PPP
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_SYNCPPP
)paren
id|isdn_ppp_free
c_func
(paren
id|lp
)paren
suffix:semicolon
macro_line|#endif
id|isdn_net_lp_disconnected
c_func
(paren
id|lp
)paren
suffix:semicolon
id|isdn_all_eaz
c_func
(paren
id|lp-&gt;isdn_device
comma
id|lp-&gt;isdn_channel
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: remote hangup&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Chargesum is %d&bslash;n&quot;
comma
id|lp-&gt;name
comma
id|lp-&gt;charge
)paren
suffix:semicolon
id|isdn_net_unbind_channel
c_func
(paren
id|lp
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_X25
r_case
id|ISDN_STAT_BHUP
suffix:colon
multiline_comment|/* B-Channel-hangup */
multiline_comment|/* try if there are generic encap protocol&n;&t;&t;&t;&t;   receiver routines and signal the closure of&n;&t;&t;&t;&t;   the link */
r_if
c_cond
(paren
id|pops
op_logical_and
id|pops
op_member_access_from_pointer
id|disconn_ind
)paren
(brace
id|pops
op_member_access_from_pointer
id|disconn_ind
c_func
(paren
id|cprot
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_X25 */
r_case
id|ISDN_STAT_BCONN
suffix:colon
multiline_comment|/* B-Channel is up */
id|isdn_net_zero_frame_cnt
c_func
(paren
id|lp
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|lp-&gt;dialstate
)paren
(brace
r_case
l_int|5
suffix:colon
r_case
l_int|6
suffix:colon
r_case
l_int|7
suffix:colon
r_case
l_int|8
suffix:colon
r_case
l_int|9
suffix:colon
r_case
l_int|10
suffix:colon
r_case
l_int|12
suffix:colon
r_if
c_cond
(paren
id|lp-&gt;dialstate
op_le
l_int|6
)paren
(brace
id|dev-&gt;usage
(braket
id|idx
)braket
op_or_assign
id|ISDN_USAGE_OUTGOING
suffix:semicolon
id|isdn_info_update
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
id|dev-&gt;rx_netdev
(braket
id|idx
)braket
op_assign
id|p
suffix:semicolon
id|lp-&gt;dialstate
op_assign
l_int|0
suffix:semicolon
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_NETHANGUP
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_CISCOHDLCK
)paren
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_KEEPALIVE
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_ne
id|ISDN_NET_ENCAP_SYNCPPP
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;master
)paren
(brace
multiline_comment|/* is lp a slave? */
id|isdn_net_dev
op_star
id|nd
op_assign
(paren
(paren
id|isdn_net_local
op_star
)paren
id|lp-&gt;master-&gt;priv
)paren
op_member_access_from_pointer
id|netdev
suffix:semicolon
id|isdn_net_add_to_bundle
c_func
(paren
id|nd
comma
id|lp
)paren
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdn_net: %s connected&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
multiline_comment|/* If first Chargeinfo comes before B-Channel connect,&n;&t;&t;&t;&t;&t;&t; * we correct the timestamp here.&n;&t;&t;&t;&t;&t;&t; */
id|lp-&gt;chargetime
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* reset dial-timeout */
id|lp-&gt;dialstarted
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;dialwait_timer
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_SYNCPPP
)paren
id|isdn_ppp_wakeup_daemon
c_func
(paren
id|lp
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ISDN_X25
multiline_comment|/* try if there are generic concap receiver routines */
r_if
c_cond
(paren
id|pops
)paren
r_if
c_cond
(paren
id|pops-&gt;connect_ind
)paren
(brace
id|pops
op_member_access_from_pointer
id|connect_ind
c_func
(paren
id|cprot
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ISDN_X25 */
multiline_comment|/* ppp needs to do negotiations first */
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_ne
id|ISDN_NET_ENCAP_SYNCPPP
)paren
id|isdn_net_device_wake_queue
c_func
(paren
id|lp
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_STAT_NODCH
suffix:colon
multiline_comment|/* No D-Channel avail. */
r_if
c_cond
(paren
id|lp-&gt;dialstate
op_eq
l_int|4
)paren
(brace
id|lp-&gt;dialstate
op_decrement
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_STAT_CINF
suffix:colon
multiline_comment|/* Charge-info from TelCo. Calculate interval between&n;&t;&t;&t;&t; * charge-infos and set timestamp for last info for&n;&t;&t;&t;&t; * usage by isdn_net_autohup()&n;&t;&t;&t;&t; */
id|lp-&gt;charge
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;hupflags
op_amp
id|ISDN_HAVECHARGE
)paren
(brace
id|lp-&gt;hupflags
op_and_assign
op_complement
id|ISDN_WAITCHARGE
suffix:semicolon
id|lp-&gt;chargeint
op_assign
id|jiffies
op_minus
id|lp-&gt;chargetime
op_minus
(paren
l_int|2
op_star
id|HZ
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;hupflags
op_amp
id|ISDN_WAITCHARGE
)paren
id|lp-&gt;hupflags
op_or_assign
id|ISDN_HAVECHARGE
suffix:semicolon
id|lp-&gt;chargetime
op_assign
id|jiffies
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_net: Got CINF chargetime of %s now %lu&bslash;n&quot;
comma
id|lp-&gt;name
comma
id|lp-&gt;chargetime
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Perform dialout for net-interfaces and timeout-handling for&n; * D-Channel-up and B-Channel-up Messages.&n; * This function is initially called from within isdn_net_start_xmit() or&n; * or isdn_net_find_icall() after initializing the dialstate for an&n; * interface. If further calls are needed, the function schedules itself&n; * for a timer-callback via isdn_timer_function().&n; * The dialstate is also affected by incoming status-messages from&n; * the ISDN-Channel which are handled in isdn_net_stat_callback() above.&n; */
r_void
DECL|function|isdn_net_dial
id|isdn_net_dial
c_func
(paren
r_void
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|dev-&gt;netdev
suffix:semicolon
r_int
id|anymore
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
id|p-&gt;local
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_NET_DIAL
r_if
c_cond
(paren
id|lp-&gt;dialstate
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: dialstate=%d&bslash;n&quot;
comma
id|lp-&gt;name
comma
id|lp-&gt;dialstate
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|lp-&gt;dialstate
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* Nothing to do for this interface */
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* Initiate dialout. Set phone-number-pointer to first number&n;&t;&t;&t;&t; * of interface.&n;&t;&t;&t;&t; */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|lp-&gt;dial
op_assign
id|lp-&gt;phone
(braket
l_int|1
)braket
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;dial
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: phone number deleted?&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|anymore
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;dialtimeout
OG
l_int|0
)paren
r_if
c_cond
(paren
id|lp-&gt;dialstarted
op_eq
l_int|0
op_logical_or
id|jiffies
OG
(paren
id|lp-&gt;dialstarted
op_plus
id|lp-&gt;dialtimeout
op_plus
id|lp-&gt;dialwait
)paren
)paren
(brace
id|lp-&gt;dialstarted
op_assign
id|jiffies
suffix:semicolon
id|lp-&gt;dialwait_timer
op_assign
l_int|0
suffix:semicolon
)brace
id|lp-&gt;dialstate
op_increment
suffix:semicolon
multiline_comment|/* Fall through */
r_case
l_int|2
suffix:colon
multiline_comment|/* Prepare dialing. Clear EAZ, then set EAZ. */
id|cmd.driver
op_assign
id|lp-&gt;isdn_device
suffix:semicolon
id|cmd.arg
op_assign
id|lp-&gt;isdn_channel
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_CLREAZ
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|cmd.parm.num
comma
l_string|&quot;%s&quot;
comma
id|isdn_map_eaz2msn
c_func
(paren
id|lp-&gt;msn
comma
id|cmd.driver
)paren
)paren
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_SETEAZ
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|lp-&gt;dialretry
op_assign
l_int|0
suffix:semicolon
id|anymore
op_assign
l_int|1
suffix:semicolon
id|lp-&gt;dialstate
op_increment
suffix:semicolon
multiline_comment|/* Fall through */
r_case
l_int|3
suffix:colon
multiline_comment|/* Setup interface, dial current phone-number, switch to next number.&n;&t;&t;&t;&t; * If list of phone-numbers is exhausted, increment&n;&t;&t;&t;&t; * retry-counter.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|dev-&gt;global_flags
op_amp
id|ISDN_GLOBAL_STOPPED
op_logical_or
(paren
id|ISDN_NET_DIALMODE
c_func
(paren
op_star
id|lp
)paren
op_eq
id|ISDN_NET_DM_OFF
)paren
)paren
(brace
r_char
op_star
id|s
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;global_flags
op_amp
id|ISDN_GLOBAL_STOPPED
)paren
id|s
op_assign
l_string|&quot;dial suppressed: isdn system stopped&quot;
suffix:semicolon
r_else
id|s
op_assign
l_string|&quot;dial suppressed: dialmode `off&squot;&quot;
suffix:semicolon
id|isdn_net_unreachable
c_func
(paren
op_amp
id|p-&gt;dev
comma
l_int|0
comma
id|s
)paren
suffix:semicolon
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|cmd.driver
op_assign
id|lp-&gt;isdn_device
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_SETL2
suffix:semicolon
id|cmd.arg
op_assign
id|lp-&gt;isdn_channel
op_plus
(paren
id|lp-&gt;l2_proto
op_lshift
l_int|8
)paren
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|lp-&gt;isdn_device
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_SETL3
suffix:semicolon
id|cmd.arg
op_assign
id|lp-&gt;isdn_channel
op_plus
(paren
id|lp-&gt;l3_proto
op_lshift
l_int|8
)paren
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|lp-&gt;isdn_device
suffix:semicolon
id|cmd.arg
op_assign
id|lp-&gt;isdn_channel
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;dial
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: phone number deleted?&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|lp-&gt;dial-&gt;num
comma
l_string|&quot;LEASED&quot;
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|lp-&gt;dialstate
op_assign
l_int|4
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Open leased line ...&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|lp-&gt;dialtimeout
OG
l_int|0
)paren
r_if
c_cond
(paren
id|jiffies
OG
(paren
id|lp-&gt;dialstarted
op_plus
id|lp-&gt;dialtimeout
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|lp-&gt;dialwait_timer
op_assign
id|jiffies
op_plus
id|lp-&gt;dialwait
suffix:semicolon
id|lp-&gt;dialstarted
op_assign
l_int|0
suffix:semicolon
id|isdn_net_unreachable
c_func
(paren
op_amp
id|p-&gt;dev
comma
l_int|0
comma
l_string|&quot;dial: timed out&quot;
)paren
suffix:semicolon
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|sprintf
c_func
(paren
id|cmd.parm.setup.phone
comma
l_string|&quot;%s&quot;
comma
id|lp-&gt;dial-&gt;num
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t; * Switch to next number or back to start if at end of list.&n;&t;&t;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|lp-&gt;dial
op_assign
(paren
id|isdn_net_phone
op_star
)paren
id|lp-&gt;dial-&gt;next
)paren
)paren
(brace
id|lp-&gt;dial
op_assign
id|lp-&gt;phone
(braket
l_int|1
)braket
suffix:semicolon
id|lp-&gt;dialretry
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;dialretry
OG
id|lp-&gt;dialmax
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;dialtimeout
op_eq
l_int|0
)paren
(brace
id|lp-&gt;dialwait_timer
op_assign
id|jiffies
op_plus
id|lp-&gt;dialwait
suffix:semicolon
id|lp-&gt;dialstarted
op_assign
l_int|0
suffix:semicolon
id|isdn_net_unreachable
c_func
(paren
op_amp
id|p-&gt;dev
comma
l_int|0
comma
l_string|&quot;dial: tried all numbers dialmax times&quot;
)paren
suffix:semicolon
)brace
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|lp-&gt;isdn_device
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_DIAL
suffix:semicolon
id|cmd.parm.setup.si1
op_assign
l_int|7
suffix:semicolon
id|cmd.parm.setup.si2
op_assign
l_int|0
suffix:semicolon
id|sprintf
c_func
(paren
id|cmd.parm.setup.eazmsn
comma
l_string|&quot;%s&quot;
comma
id|isdn_map_eaz2msn
c_func
(paren
id|lp-&gt;msn
comma
id|cmd.driver
)paren
)paren
suffix:semicolon
id|i
op_assign
id|isdn_dc2minor
c_func
(paren
id|lp-&gt;isdn_device
comma
id|lp-&gt;isdn_channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
l_int|0
)paren
(brace
id|strcpy
c_func
(paren
id|dev-&gt;num
(braket
id|i
)braket
comma
id|cmd.parm.setup.phone
)paren
suffix:semicolon
id|dev-&gt;usage
(braket
id|i
)braket
op_or_assign
id|ISDN_USAGE_OUTGOING
suffix:semicolon
id|isdn_info_update
c_func
(paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: dialing %d %s...&bslash;n&quot;
comma
id|lp-&gt;name
comma
id|lp-&gt;dialretry
comma
id|cmd.parm.setup.phone
)paren
suffix:semicolon
id|lp-&gt;dtimer
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_NET_DIAL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;dial: d=%d c=%d&bslash;n&quot;
comma
id|lp-&gt;isdn_device
comma
id|lp-&gt;isdn_channel
)paren
suffix:semicolon
macro_line|#endif
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
)brace
id|lp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;outgoing
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;chargeint
)paren
(brace
id|lp-&gt;hupflags
op_or_assign
id|ISDN_HAVECHARGE
suffix:semicolon
id|lp-&gt;hupflags
op_and_assign
op_complement
id|ISDN_WAITCHARGE
suffix:semicolon
)brace
r_else
(brace
id|lp-&gt;hupflags
op_or_assign
id|ISDN_WAITCHARGE
suffix:semicolon
id|lp-&gt;hupflags
op_and_assign
op_complement
id|ISDN_HAVECHARGE
suffix:semicolon
)brace
id|anymore
op_assign
l_int|1
suffix:semicolon
id|lp-&gt;dialstate
op_assign
(paren
id|lp-&gt;cbdelay
op_logical_and
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CBOUT
)paren
)paren
ques
c_cond
l_int|12
suffix:colon
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
multiline_comment|/* Wait for D-Channel-connect.&n;&t;&t;&t;&t; * If timeout, switch back to state 3.&n;&t;&t;&t;&t; * Dialmax-handling moved to state 3.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|lp-&gt;dtimer
op_increment
OG
id|ISDN_TIMER_DTIMEOUT10
)paren
id|lp-&gt;dialstate
op_assign
l_int|3
suffix:semicolon
id|anymore
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
multiline_comment|/* Got D-Channel-Connect, send B-Channel-request */
id|cmd.driver
op_assign
id|lp-&gt;isdn_device
suffix:semicolon
id|cmd.arg
op_assign
id|lp-&gt;isdn_channel
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_ACCEPTB
suffix:semicolon
id|anymore
op_assign
l_int|1
suffix:semicolon
id|lp-&gt;dtimer
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;dialstate
op_increment
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
multiline_comment|/* Wait for B- or D-Channel-connect. If timeout,&n;&t;&t;&t;&t; * switch back to state 3.&n;&t;&t;&t;&t; */
macro_line|#ifdef ISDN_DEBUG_NET_DIAL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;dialtimer2: %d&bslash;n&quot;
comma
id|lp-&gt;dtimer
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|lp-&gt;dtimer
op_increment
OG
id|ISDN_TIMER_DTIMEOUT10
)paren
id|lp-&gt;dialstate
op_assign
l_int|3
suffix:semicolon
id|anymore
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
multiline_comment|/* Got incoming Call, setup L2 and L3 protocols,&n;&t;&t;&t;&t; * then wait for D-Channel-connect&n;&t;&t;&t;&t; */
macro_line|#ifdef ISDN_DEBUG_NET_DIAL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;dialtimer4: %d&bslash;n&quot;
comma
id|lp-&gt;dtimer
)paren
suffix:semicolon
macro_line|#endif
id|cmd.driver
op_assign
id|lp-&gt;isdn_device
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_SETL2
suffix:semicolon
id|cmd.arg
op_assign
id|lp-&gt;isdn_channel
op_plus
(paren
id|lp-&gt;l2_proto
op_lshift
l_int|8
)paren
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|lp-&gt;isdn_device
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_SETL3
suffix:semicolon
id|cmd.arg
op_assign
id|lp-&gt;isdn_channel
op_plus
(paren
id|lp-&gt;l3_proto
op_lshift
l_int|8
)paren
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;dtimer
op_increment
OG
id|ISDN_TIMER_DTIMEOUT15
)paren
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
r_else
(brace
id|anymore
op_assign
l_int|1
suffix:semicolon
id|lp-&gt;dialstate
op_increment
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|9
suffix:colon
multiline_comment|/* Got incoming D-Channel-Connect, send B-Channel-request */
id|cmd.driver
op_assign
id|lp-&gt;isdn_device
suffix:semicolon
id|cmd.arg
op_assign
id|lp-&gt;isdn_channel
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_ACCEPTB
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|anymore
op_assign
l_int|1
suffix:semicolon
id|lp-&gt;dtimer
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;dialstate
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
r_case
l_int|10
suffix:colon
multiline_comment|/*  Wait for B- or D-channel-connect */
macro_line|#ifdef ISDN_DEBUG_NET_DIAL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;dialtimer4: %d&bslash;n&quot;
comma
id|lp-&gt;dtimer
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|lp-&gt;dtimer
op_increment
OG
id|ISDN_TIMER_DTIMEOUT10
)paren
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
r_else
id|anymore
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|11
suffix:colon
multiline_comment|/* Callback Delay */
r_if
c_cond
(paren
id|lp-&gt;dtimer
op_increment
OG
id|lp-&gt;cbdelay
)paren
id|lp-&gt;dialstate
op_assign
l_int|1
suffix:semicolon
id|anymore
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|12
suffix:colon
multiline_comment|/* Remote does callback. Hangup after cbdelay, then wait for incoming&n;&t;&t;&t;&t; * call (in state 4).&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|lp-&gt;dtimer
op_increment
OG
id|lp-&gt;cbdelay
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: hangup waiting for callback ...&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
id|lp-&gt;dtimer
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;dialstate
op_assign
l_int|4
suffix:semicolon
id|cmd.driver
op_assign
id|lp-&gt;isdn_device
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_HANGUP
suffix:semicolon
id|cmd.arg
op_assign
id|lp-&gt;isdn_channel
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|isdn_all_eaz
c_func
(paren
id|lp-&gt;isdn_device
comma
id|lp-&gt;isdn_channel
)paren
suffix:semicolon
)brace
id|anymore
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net: Illegal dialstate %d for device %s&bslash;n&quot;
comma
id|lp-&gt;dialstate
comma
id|lp-&gt;name
)paren
suffix:semicolon
)brace
id|p
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|p-&gt;next
suffix:semicolon
)brace
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_NETDIAL
comma
id|anymore
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Perform hangup for a net-interface.&n; */
r_void
DECL|function|isdn_net_hangup
id|isdn_net_hangup
c_func
(paren
r_struct
id|net_device
op_star
id|d
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|d-&gt;priv
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_X25
r_struct
id|concap_proto
op_star
id|cprot
op_assign
id|lp
op_member_access_from_pointer
id|netdev
op_member_access_from_pointer
id|cprot
suffix:semicolon
r_struct
id|concap_proto_ops
op_star
id|pops
op_assign
id|cprot
ques
c_cond
id|cprot
op_member_access_from_pointer
id|pops
suffix:colon
l_int|0
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;slave
op_ne
l_int|NULL
)paren
(brace
id|isdn_net_local
op_star
id|slp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|lp-&gt;slave-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|slp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdn_net: hang up slave %s before %s&bslash;n&quot;
comma
id|slp-&gt;name
comma
id|lp-&gt;name
)paren
suffix:semicolon
id|isdn_net_hangup
c_func
(paren
id|lp-&gt;slave
)paren
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdn_net: local hangup %s&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_SYNCPPP
)paren
id|isdn_ppp_free
c_func
(paren
id|lp
)paren
suffix:semicolon
macro_line|#endif
id|isdn_net_lp_disconnected
c_func
(paren
id|lp
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_X25
multiline_comment|/* try if there are generic encap protocol&n;&t;&t;   receiver routines and signal the closure of&n;&t;&t;   the link */
r_if
c_cond
(paren
id|pops
op_logical_and
id|pops
op_member_access_from_pointer
id|disconn_ind
)paren
(brace
id|pops
op_member_access_from_pointer
id|disconn_ind
c_func
(paren
id|cprot
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ISDN_X25 */
id|cmd.driver
op_assign
id|lp-&gt;isdn_device
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_HANGUP
suffix:semicolon
id|cmd.arg
op_assign
id|lp-&gt;isdn_channel
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Chargesum is %d&bslash;n&quot;
comma
id|lp-&gt;name
comma
id|lp-&gt;charge
)paren
suffix:semicolon
id|isdn_all_eaz
c_func
(paren
id|lp-&gt;isdn_device
comma
id|lp-&gt;isdn_channel
)paren
suffix:semicolon
)brace
id|isdn_net_unbind_channel
c_func
(paren
id|lp
)paren
suffix:semicolon
)brace
r_typedef
r_struct
(brace
DECL|member|source
r_int
r_int
id|source
suffix:semicolon
DECL|member|dest
r_int
r_int
id|dest
suffix:semicolon
DECL|typedef|ip_ports
)brace
id|ip_ports
suffix:semicolon
r_static
r_void
DECL|function|isdn_net_log_skb
id|isdn_net_log_skb
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
id|isdn_net_local
op_star
id|lp
)paren
(brace
id|u_char
op_star
id|p
op_assign
id|skb-&gt;nh.raw
suffix:semicolon
multiline_comment|/* hopefully, this was set correctly */
r_int
r_int
id|proto
op_assign
id|ntohs
c_func
(paren
id|skb-&gt;protocol
)paren
suffix:semicolon
r_int
id|data_ofs
suffix:semicolon
id|ip_ports
op_star
id|ipp
suffix:semicolon
r_char
id|addinfo
(braket
l_int|100
)braket
suffix:semicolon
id|addinfo
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
multiline_comment|/* This check stolen from 2.1.72 dev_queue_xmit_nit() */
r_if
c_cond
(paren
id|skb-&gt;nh.raw
OL
id|skb-&gt;data
op_logical_or
id|skb-&gt;nh.raw
op_ge
id|skb-&gt;tail
)paren
(brace
multiline_comment|/* fall back to old isdn_net_log_packet method() */
r_char
op_star
id|buf
op_assign
id|skb-&gt;data
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_net: protocol %04x is buggy, dev %s&bslash;n&quot;
comma
id|skb-&gt;protocol
comma
id|lp-&gt;name
)paren
suffix:semicolon
id|p
op_assign
id|buf
suffix:semicolon
id|proto
op_assign
id|ETH_P_IP
suffix:semicolon
r_switch
c_cond
(paren
id|lp-&gt;p_encap
)paren
(brace
r_case
id|ISDN_NET_ENCAP_IPTYP
suffix:colon
id|proto
op_assign
id|ntohs
c_func
(paren
op_star
(paren
r_int
r_int
op_star
)paren
op_amp
id|buf
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|p
op_assign
op_amp
id|buf
(braket
l_int|2
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_NET_ENCAP_ETHER
suffix:colon
id|proto
op_assign
id|ntohs
c_func
(paren
op_star
(paren
r_int
r_int
op_star
)paren
op_amp
id|buf
(braket
l_int|12
)braket
)paren
suffix:semicolon
id|p
op_assign
op_amp
id|buf
(braket
l_int|14
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_NET_ENCAP_CISCOHDLC
suffix:colon
id|proto
op_assign
id|ntohs
c_func
(paren
op_star
(paren
r_int
r_int
op_star
)paren
op_amp
id|buf
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|p
op_assign
op_amp
id|buf
(braket
l_int|4
)braket
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
r_case
id|ISDN_NET_ENCAP_SYNCPPP
suffix:colon
id|proto
op_assign
id|ntohs
c_func
(paren
id|skb-&gt;protocol
)paren
suffix:semicolon
id|p
op_assign
op_amp
id|buf
(braket
id|IPPP_MAX_HEADER
)braket
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
)brace
)brace
id|data_ofs
op_assign
(paren
(paren
id|p
(braket
l_int|0
)braket
op_amp
l_int|15
)paren
op_star
l_int|4
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|proto
)paren
(brace
r_case
id|ETH_P_IP
suffix:colon
r_switch
c_cond
(paren
id|p
(braket
l_int|9
)braket
)paren
(brace
r_case
l_int|1
suffix:colon
id|strcpy
c_func
(paren
id|addinfo
comma
l_string|&quot; ICMP&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|strcpy
c_func
(paren
id|addinfo
comma
l_string|&quot; IGMP&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|strcpy
c_func
(paren
id|addinfo
comma
l_string|&quot; IPIP&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|ipp
op_assign
(paren
id|ip_ports
op_star
)paren
(paren
op_amp
id|p
(braket
id|data_ofs
)braket
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|addinfo
comma
l_string|&quot; TCP, port: %d -&gt; %d&quot;
comma
id|ntohs
c_func
(paren
id|ipp-&gt;source
)paren
comma
id|ntohs
c_func
(paren
id|ipp-&gt;dest
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|strcpy
c_func
(paren
id|addinfo
comma
l_string|&quot; EGP&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|12
suffix:colon
id|strcpy
c_func
(paren
id|addinfo
comma
l_string|&quot; PUP&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|17
suffix:colon
id|ipp
op_assign
(paren
id|ip_ports
op_star
)paren
(paren
op_amp
id|p
(braket
id|data_ofs
)braket
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|addinfo
comma
l_string|&quot; UDP, port: %d -&gt; %d&quot;
comma
id|ntohs
c_func
(paren
id|ipp-&gt;source
)paren
comma
id|ntohs
c_func
(paren
id|ipp-&gt;dest
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|22
suffix:colon
id|strcpy
c_func
(paren
id|addinfo
comma
l_string|&quot; IDP&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;OPEN: %d.%d.%d.%d -&gt; %d.%d.%d.%d%s&bslash;n&quot;
comma
id|p
(braket
l_int|12
)braket
comma
id|p
(braket
l_int|13
)braket
comma
id|p
(braket
l_int|14
)braket
comma
id|p
(braket
l_int|15
)braket
comma
id|p
(braket
l_int|16
)braket
comma
id|p
(braket
l_int|17
)braket
comma
id|p
(braket
l_int|18
)braket
comma
id|p
(braket
l_int|19
)braket
comma
id|addinfo
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_ARP
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;OPEN: ARP %d.%d.%d.%d -&gt; *.*.*.* ?%d.%d.%d.%d&bslash;n&quot;
comma
id|p
(braket
l_int|14
)braket
comma
id|p
(braket
l_int|15
)braket
comma
id|p
(braket
l_int|16
)braket
comma
id|p
(braket
l_int|17
)braket
comma
id|p
(braket
l_int|24
)braket
comma
id|p
(braket
l_int|25
)braket
comma
id|p
(braket
l_int|26
)braket
comma
id|p
(braket
l_int|27
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * this function is used to send supervisory data, i.e. data which was&n; * not received from the network layer, but e.g. frames from ipppd, CCP&n; * reset frames etc.&n; */
DECL|function|isdn_net_write_super
r_void
id|isdn_net_write_super
c_func
(paren
id|isdn_net_local
op_star
id|lp
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_if
c_cond
(paren
id|in_interrupt
c_func
(paren
)paren
)paren
(brace
singleline_comment|// we can&squot;t grab the lock from irq context, 
singleline_comment|// so we just queue the packet
id|skb_queue_tail
c_func
(paren
op_amp
id|lp-&gt;super_tx_queue
comma
id|skb
)paren
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|lp-&gt;tqueue
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_lock_bh
c_func
(paren
op_amp
id|lp-&gt;xmit_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|isdn_net_lp_busy
c_func
(paren
id|lp
)paren
)paren
(brace
id|isdn_net_writebuf_skb
c_func
(paren
id|lp
comma
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
id|skb_queue_tail
c_func
(paren
op_amp
id|lp-&gt;super_tx_queue
comma
id|skb
)paren
suffix:semicolon
)brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|lp-&gt;xmit_lock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * called from tq_immediate&n; */
DECL|function|isdn_net_softint
r_static
r_void
id|isdn_net_softint
c_func
(paren
r_void
op_star
r_private
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
r_private
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|lp-&gt;xmit_lock
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|isdn_net_lp_busy
c_func
(paren
id|lp
)paren
)paren
(brace
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|lp-&gt;super_tx_queue
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_break
suffix:semicolon
id|isdn_net_writebuf_skb
c_func
(paren
id|lp
comma
id|skb
)paren
suffix:semicolon
)brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|lp-&gt;xmit_lock
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * all frames sent from the (net) LL to a HL driver should go via this function&n; * it&squot;s serialized by the caller holding the lp-&gt;xmit_lock spinlock&n; */
DECL|function|isdn_net_writebuf_skb
r_void
id|isdn_net_writebuf_skb
c_func
(paren
id|isdn_net_local
op_star
id|lp
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|ret
suffix:semicolon
r_int
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
multiline_comment|/* save len */
multiline_comment|/* before obtaining the lock the caller should have checked that&n;&t;   the lp isn&squot;t busy */
r_if
c_cond
(paren
id|isdn_net_lp_busy
c_func
(paren
id|lp
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;isdn BUG at %s:%d!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;isdn BUG at %s:%d!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|ret
op_assign
id|isdn_writebuf_skb_stub
c_func
(paren
id|lp-&gt;isdn_device
comma
id|lp-&gt;isdn_channel
comma
l_int|1
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
id|len
)paren
(brace
multiline_comment|/* we should never get here */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: HL driver queue full&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|lp-&gt;transcount
op_add_assign
id|len
suffix:semicolon
id|isdn_net_inc_frame_cnt
c_func
(paren
id|lp
)paren
suffix:semicolon
r_return
suffix:semicolon
id|error
suffix:colon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
)brace
multiline_comment|/*&n; *  Helper function for isdn_net_start_xmit.&n; *  When called, the connection is already established.&n; *  Based on cps-calculation, check if device is overloaded.&n; *  If so, and if a slave exists, trigger dialing for it.&n; *  If any slave is online, deliver packets using a simple round robin&n; *  scheme.&n; *&n; *  Return: 0 on success, !0 on failure.&n; */
r_static
r_int
DECL|function|isdn_net_xmit
id|isdn_net_xmit
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|isdn_net_dev
op_star
id|nd
suffix:semicolon
id|isdn_net_local
op_star
id|slp
suffix:semicolon
id|isdn_net_local
op_star
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|ndev-&gt;priv
suffix:semicolon
r_int
id|retv
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|isdn_net_local
op_star
)paren
(paren
id|ndev-&gt;priv
)paren
)paren
op_member_access_from_pointer
id|master
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;isdn BUG at %s:%d!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* For the other encaps the header has already been built */
macro_line|#ifdef CONFIG_ISDN_PPP
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_SYNCPPP
)paren
(brace
r_return
id|isdn_ppp_xmit
c_func
(paren
id|skb
comma
id|ndev
)paren
suffix:semicolon
)brace
macro_line|#endif
id|nd
op_assign
(paren
(paren
id|isdn_net_local
op_star
)paren
id|ndev-&gt;priv
)paren
op_member_access_from_pointer
id|netdev
suffix:semicolon
id|lp
op_assign
id|isdn_net_get_locked_lp
c_func
(paren
id|nd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: all channels busy - requeuing!&bslash;n&quot;
comma
id|ndev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* we have our lp locked from now on */
multiline_comment|/* Reset hangup-timeout */
id|lp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
singleline_comment|// FIXME?
id|isdn_net_writebuf_skb
c_func
(paren
id|lp
comma
id|skb
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|lp-&gt;xmit_lock
)paren
suffix:semicolon
multiline_comment|/* the following stuff is here for backwards compatibility.&n;&t; * in future, start-up and hangup of slaves (based on current load)&n;&t; * should move to userspace and get based on an overall cps&n;&t; * calculation&n;&t; */
r_if
c_cond
(paren
id|lp-&gt;cps
OG
id|lp-&gt;triggercps
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;slave
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;sqfull
)paren
(brace
multiline_comment|/* First time overload: set timestamp only */
id|lp-&gt;sqfull
op_assign
l_int|1
suffix:semicolon
id|lp-&gt;sqfull_stamp
op_assign
id|jiffies
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* subsequent overload: if slavedelay exceeded, start dialing */
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|lp-&gt;sqfull_stamp
)paren
OG
id|lp-&gt;slavedelay
)paren
(brace
id|slp
op_assign
id|lp-&gt;slave-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|slp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
)paren
(brace
id|isdn_net_force_dial_lp
c_func
(paren
(paren
id|isdn_net_local
op_star
)paren
id|lp-&gt;slave-&gt;priv
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|lp-&gt;sqfull
op_logical_and
(paren
(paren
id|jiffies
op_minus
id|lp-&gt;sqfull_stamp
)paren
OG
(paren
id|lp-&gt;slavedelay
op_plus
(paren
l_int|10
op_star
id|HZ
)paren
)paren
)paren
)paren
(brace
id|lp-&gt;sqfull
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* this is a hack to allow auto-hangup for slaves on moderate loads */
id|nd-&gt;queue
op_assign
id|nd-&gt;local
suffix:semicolon
)brace
r_return
id|retv
suffix:semicolon
)brace
r_static
r_void
DECL|function|isdn_net_adjust_hdr
id|isdn_net_adjust_hdr
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_ETHER
)paren
(brace
r_int
id|pullsize
op_assign
(paren
id|ulong
)paren
id|skb-&gt;nh.raw
op_minus
(paren
id|ulong
)paren
id|skb-&gt;data
op_minus
id|ETH_HLEN
suffix:semicolon
r_if
c_cond
(paren
id|pullsize
OG
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_net: Pull junk %d&bslash;n&quot;
comma
id|pullsize
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
id|pullsize
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|isdn_net_tx_timeout
r_void
id|isdn_net_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|ndev-&gt;priv
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_tx_timeout dev %s dialstate %d&bslash;n&quot;
comma
id|ndev-&gt;name
comma
id|lp-&gt;dialstate
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;dialstate
)paren
(brace
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
multiline_comment|/*&n;&t;&t; * There is a certain probability that this currently&n;&t;&t; * works at all because if we always wake up the interface,&n;&t;&t; * then upper layer will try to send the next packet&n;&t;&t; * immediately. And then, the old clean_up logic in the&n;&t;&t; * driver will hopefully continue to work as it used to do.&n;&t;&t; *&n;&t;&t; * This is rather primitive right know, we better should&n;&t;&t; * clean internal queues here, in particular for multilink and&n;&t;&t; * ppp, and reset HL driver&squot;s channel, too.   --HE&n;&t;&t; *&n;&t;&t; * actually, this may not matter at all, because ISDN hardware&n;&t;&t; * should not see transmitter hangs at all IMO&n;&t;&t; * changed KERN_DEBUG to KERN_WARNING to find out if this is &n;&t;&t; * ever called   --KG&n;&t;&t; */
)brace
id|ndev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|ndev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Try sending a packet.&n; * If this interface isn&squot;t connected to a ISDN-Channel, find a free channel,&n; * and start dialing.&n; */
r_static
r_int
DECL|function|isdn_net_start_xmit
id|isdn_net_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|ndev-&gt;priv
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_X25
r_struct
id|concap_proto
op_star
id|cprot
op_assign
id|lp
op_member_access_from_pointer
id|netdev
op_member_access_from_pointer
id|cprot
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ISDN_X25
multiline_comment|/* At this point hard_start_xmit() passes control to the encapsulation&n;   protocol (if present).&n;   For X.25 auto-dialing is completly bypassed because:&n;   - It does not conform with the semantics of a reliable datalink&n;     service as needed by X.25 PLP.&n;   - I don&squot;t want that the interface starts dialing when the network layer&n;     sends a message which requests to disconnect the lapb link (or if it&n;     sends any other message not resulting in data transmission).&n;   Instead, dialing will be initiated by the encapsulation protocol entity&n;   when a dl_establish request is received from the upper layer.&n;*/
r_if
c_cond
(paren
id|cprot
)paren
(brace
r_int
id|ret
op_assign
id|cprot
op_member_access_from_pointer
id|pops
op_member_access_from_pointer
id|encap_and_xmit
(paren
id|cprot
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|ndev
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
r_else
macro_line|#endif
multiline_comment|/* auto-dialing xmit function */
(brace
macro_line|#ifdef ISDN_DEBUG_NET_DUMP
id|u_char
op_star
id|buf
suffix:semicolon
macro_line|#endif
id|isdn_net_adjust_hdr
c_func
(paren
id|skb
comma
id|ndev
)paren
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_NET_DUMP
id|buf
op_assign
id|skb-&gt;data
suffix:semicolon
id|isdn_dumppkt
c_func
(paren
l_string|&quot;S:&quot;
comma
id|buf
comma
id|skb-&gt;len
comma
l_int|40
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
)paren
(brace
r_int
id|chi
suffix:semicolon
multiline_comment|/* only do autodial if allowed by config */
r_if
c_cond
(paren
op_logical_neg
(paren
id|ISDN_NET_DIALMODE
c_func
(paren
op_star
id|lp
)paren
op_eq
id|ISDN_NET_DM_AUTO
)paren
)paren
(brace
id|isdn_net_unreachable
c_func
(paren
id|ndev
comma
id|skb
comma
l_string|&quot;dial rejected: interface not in dialmode `auto&squot;&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;phone
(braket
l_int|1
)braket
)paren
(brace
id|ulong
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;dialwait_timer
op_le
l_int|0
)paren
r_if
c_cond
(paren
id|lp-&gt;dialstarted
OG
l_int|0
op_logical_and
id|lp-&gt;dialtimeout
OG
l_int|0
op_logical_and
id|jiffies
OL
id|lp-&gt;dialstarted
op_plus
id|lp-&gt;dialtimeout
op_plus
id|lp-&gt;dialwait
)paren
(brace
id|lp-&gt;dialwait_timer
op_assign
id|lp-&gt;dialstarted
op_plus
id|lp-&gt;dialtimeout
op_plus
id|lp-&gt;dialwait
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;dialwait_timer
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|jiffies
OL
id|lp-&gt;dialwait_timer
)paren
(brace
id|isdn_net_unreachable
c_func
(paren
id|ndev
comma
id|skb
comma
l_string|&quot;dial rejected: retry-time not reached&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
id|lp-&gt;dialwait_timer
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Grab a free ISDN-Channel */
r_if
c_cond
(paren
(paren
(paren
id|chi
op_assign
id|isdn_get_free_channel
c_func
(paren
id|ISDN_USAGE_NET
comma
id|lp-&gt;l2_proto
comma
id|lp-&gt;l3_proto
comma
id|lp-&gt;pre_device
comma
id|lp-&gt;pre_channel
comma
id|lp-&gt;msn
)paren
)paren
OL
l_int|0
)paren
op_logical_and
(paren
(paren
id|chi
op_assign
id|isdn_get_free_channel
c_func
(paren
id|ISDN_USAGE_NET
comma
id|lp-&gt;l2_proto
comma
id|lp-&gt;l3_proto
comma
id|lp-&gt;pre_device
comma
id|lp-&gt;pre_channel
op_xor
l_int|1
comma
id|lp-&gt;msn
)paren
)paren
OL
l_int|0
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|isdn_net_unreachable
c_func
(paren
id|ndev
comma
id|skb
comma
l_string|&quot;No channel&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Log packet, which triggered dialing */
r_if
c_cond
(paren
id|dev-&gt;net_verbose
)paren
id|isdn_net_log_skb
c_func
(paren
id|skb
comma
id|lp
)paren
suffix:semicolon
id|lp-&gt;dialstate
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Connect interface with channel */
id|isdn_net_bind_channel
c_func
(paren
id|lp
comma
id|chi
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_SYNCPPP
)paren
(brace
multiline_comment|/* no &squot;first_skb&squot; handling for syncPPP */
r_if
c_cond
(paren
id|isdn_ppp_bind
c_func
(paren
id|lp
)paren
OL
l_int|0
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|isdn_net_unbind_channel
c_func
(paren
id|lp
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* STN (skb to nirvana) ;) */
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|isdn_net_dial
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Initiate dialing */
id|netif_stop_queue
c_func
(paren
id|ndev
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* let upper layer requeue skb packet */
)brace
macro_line|#endif
multiline_comment|/* Initiate dialing */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|isdn_net_dial
c_func
(paren
)paren
suffix:semicolon
id|isdn_net_device_stop_queue
c_func
(paren
id|lp
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|isdn_net_unreachable
c_func
(paren
id|ndev
comma
id|skb
comma
l_string|&quot;No phone number&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Device is connected to an ISDN channel */
id|ndev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;dialstate
)paren
(brace
multiline_comment|/* ISDN connection is established, try sending */
r_int
id|ret
suffix:semicolon
id|ret
op_assign
(paren
id|isdn_net_xmit
c_func
(paren
id|ndev
comma
id|skb
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|ndev
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
r_else
id|netif_stop_queue
c_func
(paren
id|ndev
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Shutdown a net-interface.&n; */
r_static
r_int
DECL|function|isdn_net_close
id|isdn_net_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|net_device
op_star
id|p
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_X25
r_struct
id|concap_proto
op_star
id|cprot
op_assign
(paren
(paren
id|isdn_net_local
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|netdev
op_member_access_from_pointer
id|cprot
suffix:semicolon
multiline_comment|/* printk(KERN_DEBUG &quot;isdn_net_close %s&bslash;n&quot; , dev-&gt; name ); */
macro_line|#endif
macro_line|#ifdef CONFIG_ISDN_X25
r_if
c_cond
(paren
id|cprot
op_logical_and
id|cprot
op_member_access_from_pointer
id|pops
)paren
(brace
id|cprot
op_member_access_from_pointer
id|pops
op_member_access_from_pointer
id|close
c_func
(paren
id|cprot
)paren
suffix:semicolon
)brace
macro_line|#endif
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
op_assign
(paren
(paren
(paren
id|isdn_net_local
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|slave
)paren
)paren
)paren
(brace
multiline_comment|/* If this interface has slaves, stop them also */
r_while
c_loop
(paren
id|p
)paren
(brace
macro_line|#ifdef CONFIG_ISDN_X25
id|cprot
op_assign
(paren
(paren
id|isdn_net_local
op_star
)paren
id|p-&gt;priv
)paren
op_member_access_from_pointer
id|netdev
op_member_access_from_pointer
id|cprot
suffix:semicolon
r_if
c_cond
(paren
id|cprot
op_logical_and
id|cprot
op_member_access_from_pointer
id|pops
)paren
(brace
id|cprot
op_member_access_from_pointer
id|pops
op_member_access_from_pointer
id|close
c_func
(paren
id|cprot
)paren
suffix:semicolon
)brace
macro_line|#endif
id|isdn_net_hangup
c_func
(paren
id|p
)paren
suffix:semicolon
id|p
op_assign
(paren
(paren
(paren
id|isdn_net_local
op_star
)paren
id|p-&gt;priv
)paren
op_member_access_from_pointer
id|slave
)paren
suffix:semicolon
)brace
)brace
id|isdn_net_hangup
c_func
(paren
id|dev
)paren
suffix:semicolon
id|isdn_MOD_DEC_USE_COUNT
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Get statistics&n; */
r_static
r_struct
id|net_device_stats
op_star
DECL|function|isdn_net_get_stats
id|isdn_net_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|lp-&gt;stats
suffix:semicolon
)brace
multiline_comment|/*      This is simply a copy from std. eth.c EXCEPT we pull ETH_HLEN&n; *      instead of dev-&gt;hard_header_len off. This is done because the&n; *      lowlevel-driver has already pulled off its stuff when we get&n; *      here and this routine only gets called with p_encap == ETHER.&n; *      Determine the packet&squot;s protocol ID. The rule here is that we&n; *      assume 802.3 if the type field is short enough to be a length.&n; *      This is normal practice and works for any &squot;now in use&squot; protocol.&n; */
r_static
r_int
r_int
DECL|function|isdn_net_type_trans
id|isdn_net_type_trans
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ethhdr
op_star
id|eth
suffix:semicolon
r_int
r_char
op_star
id|rawp
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
id|ETH_HLEN
)paren
suffix:semicolon
id|eth
op_assign
id|skb-&gt;mac.ethernet
suffix:semicolon
r_if
c_cond
(paren
op_star
id|eth-&gt;h_dest
op_amp
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|eth-&gt;h_dest
comma
id|dev-&gt;broadcast
comma
id|ETH_ALEN
)paren
op_eq
l_int|0
)paren
id|skb-&gt;pkt_type
op_assign
id|PACKET_BROADCAST
suffix:semicolon
r_else
id|skb-&gt;pkt_type
op_assign
id|PACKET_MULTICAST
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *      This ALLMULTI check should be redundant by 1.4&n;&t; *      so don&squot;t forget to remove it.&n;&t; */
r_else
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
(paren
id|IFF_PROMISC
multiline_comment|/*| IFF_ALLMULTI*/
)paren
)paren
(brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|eth-&gt;h_dest
comma
id|dev-&gt;dev_addr
comma
id|ETH_ALEN
)paren
)paren
id|skb-&gt;pkt_type
op_assign
id|PACKET_OTHERHOST
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ntohs
c_func
(paren
id|eth-&gt;h_proto
)paren
op_ge
l_int|1536
)paren
r_return
id|eth-&gt;h_proto
suffix:semicolon
id|rawp
op_assign
id|skb-&gt;data
suffix:semicolon
multiline_comment|/*&n;&t; *      This is a magic hack to spot IPX packets. Older Novell breaks&n;&t; *      the protocol design and runs IPX over 802.3 without an 802.2 LLC&n;&t; *      layer. We look for FFFF which isn&squot;t a used 802.2 SSAP/DSAP. This&n;&t; *      won&squot;t work for fault tolerant netware but does for the rest.&n;&t; */
r_if
c_cond
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|rawp
op_eq
l_int|0xFFFF
)paren
r_return
id|htons
c_func
(paren
id|ETH_P_802_3
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *      Real 802.2 LLC&n;&t; */
r_return
id|htons
c_func
(paren
id|ETH_P_802_2
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|isdn_net_slarp_send
id|isdn_net_slarp_send
c_func
(paren
id|isdn_net_local
op_star
id|lp
comma
r_int
id|is_reply
)paren
(brace
r_int
r_int
id|hl
op_assign
id|dev-&gt;drv
(braket
id|lp-&gt;isdn_device
)braket
op_member_access_from_pointer
id|interface-&gt;hl_hdrlen
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|hl
op_plus
r_sizeof
(paren
id|cisco_hdr
)paren
op_plus
r_sizeof
(paren
id|cisco_slarp
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_int
r_int
id|t
op_assign
(paren
id|jiffies
op_div
id|HZ
op_star
l_int|1000000
)paren
suffix:semicolon
id|cisco_hdr
op_star
id|ch
suffix:semicolon
id|cisco_slarp
op_star
id|s
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Could not allocate SLARP reply&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb
comma
id|hl
)paren
suffix:semicolon
id|ch
op_assign
(paren
id|cisco_hdr
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
id|cisco_hdr
)paren
)paren
suffix:semicolon
id|ch-&gt;addr
op_assign
id|CISCO_ADDR_UNICAST
suffix:semicolon
id|ch-&gt;ctrl
op_assign
l_int|0
suffix:semicolon
id|ch-&gt;type
op_assign
id|htons
c_func
(paren
id|CISCO_TYPE_SLARP
)paren
suffix:semicolon
id|s
op_assign
(paren
id|cisco_slarp
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
id|cisco_slarp
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_reply
)paren
(brace
id|s-&gt;code
op_assign
id|htonl
c_func
(paren
id|CISCO_SLARP_REPLY
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|s-&gt;slarp.reply.ifaddr
comma
l_int|0
comma
r_sizeof
(paren
id|__u32
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|s-&gt;slarp.reply.netmask
comma
l_int|0
comma
r_sizeof
(paren
id|__u32
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|lp-&gt;cisco_myseq
op_increment
suffix:semicolon
id|s-&gt;code
op_assign
id|htonl
c_func
(paren
id|CISCO_SLARP_KEEPALIVE
)paren
suffix:semicolon
id|s-&gt;slarp.keepalive.my_seq
op_assign
id|htonl
c_func
(paren
id|lp-&gt;cisco_myseq
)paren
suffix:semicolon
id|s-&gt;slarp.keepalive.your_seq
op_assign
id|htonl
c_func
(paren
id|lp-&gt;cisco_yourseq
)paren
suffix:semicolon
)brace
id|s-&gt;rel
op_assign
l_int|0xffff
suffix:semicolon
id|s-&gt;t1
op_assign
id|t
op_rshift
l_int|16
suffix:semicolon
id|s-&gt;t0
op_assign
id|t
op_amp
l_int|0xffff
suffix:semicolon
id|isdn_net_write_super
c_func
(paren
id|lp
comma
id|skb
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|isdn_net_slarp_in
id|isdn_net_slarp_in
c_func
(paren
id|isdn_net_local
op_star
id|lp
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|cisco_slarp
op_star
id|s
op_assign
(paren
id|cisco_slarp
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_switch
c_cond
(paren
id|ntohl
c_func
(paren
id|s-&gt;code
)paren
)paren
(brace
r_case
id|CISCO_SLARP_REQUEST
suffix:colon
id|isdn_net_slarp_send
c_func
(paren
id|lp
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISCO_SLARP_REPLY
suffix:colon
multiline_comment|/* Ignore replies */
r_break
suffix:semicolon
r_case
id|CISCO_SLARP_KEEPALIVE
suffix:colon
id|lp-&gt;cisco_yourseq
op_assign
id|s-&gt;slarp.keepalive.my_seq
suffix:semicolon
r_if
c_cond
(paren
id|ntohl
c_func
(paren
id|s-&gt;slarp.keepalive.my_seq
op_eq
id|lp-&gt;cisco_myseq
)paren
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;cisco_loop
op_increment
op_eq
l_int|2
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Keepalive Loop&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
id|lp-&gt;cisco_myseq
op_xor_assign
id|jiffies
suffix:semicolon
)brace
)brace
r_else
id|lp-&gt;cisco_loop
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Called every 10 sec. via timer-interrupt if&n; * any network-interface has Cisco-Keepalive-Encapsulation&n; * and is online.&n; * Send Keepalive-Packet and re-schedule.&n; */
r_void
DECL|function|isdn_net_slarp_out
id|isdn_net_slarp_out
c_func
(paren
r_void
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|dev-&gt;netdev
suffix:semicolon
r_int
id|anymore
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
id|isdn_net_local
op_star
id|l
op_assign
id|p-&gt;local
suffix:semicolon
r_if
c_cond
(paren
(paren
id|l-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_CISCOHDLCK
)paren
op_logical_and
(paren
id|l-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
op_logical_and
(paren
op_logical_neg
id|l-&gt;dialstate
)paren
)paren
(brace
id|anymore
op_assign
l_int|1
suffix:semicolon
id|isdn_net_slarp_send
c_func
(paren
id|l
comma
l_int|0
)paren
suffix:semicolon
)brace
id|p
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|p-&gt;next
suffix:semicolon
)brace
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_KEEPALIVE
comma
id|anymore
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Got a packet from ISDN-Channel.&n; */
r_static
r_void
DECL|function|isdn_net_receive
id|isdn_net_receive
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|ndev-&gt;priv
suffix:semicolon
id|isdn_net_local
op_star
id|olp
op_assign
id|lp
suffix:semicolon
multiline_comment|/* original &squot;lp&squot; */
macro_line|#ifdef CONFIG_ISDN_PPP
r_int
id|proto
op_assign
id|PPP_PROTOCOL
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ISDN_X25
r_struct
id|concap_proto
op_star
id|cprot
op_assign
id|lp
op_member_access_from_pointer
id|netdev
op_member_access_from_pointer
id|cprot
suffix:semicolon
macro_line|#endif
id|cisco_hdr
op_star
id|ch
suffix:semicolon
id|lp-&gt;transcount
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;master
)paren
(brace
multiline_comment|/* Bundling: If device is a slave-device, deliver to master, also&n;&t;&t; * handle master&squot;s statistics and hangup-timeout&n;&t;&t; */
id|ndev
op_assign
id|lp-&gt;master
suffix:semicolon
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|ndev-&gt;priv
suffix:semicolon
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|ndev
suffix:semicolon
id|skb-&gt;pkt_type
op_assign
id|PACKET_HOST
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_NET_DUMP
id|isdn_dumppkt
c_func
(paren
l_string|&quot;R:&quot;
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
l_int|40
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|lp-&gt;p_encap
)paren
(brace
r_case
id|ISDN_NET_ENCAP_ETHER
suffix:colon
multiline_comment|/* Ethernet over ISDN */
id|olp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|isdn_net_type_trans
c_func
(paren
id|skb
comma
id|ndev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_NET_ENCAP_UIHDLC
suffix:colon
multiline_comment|/* HDLC with UI-frame (for ispa with -h1 option) */
id|olp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Fall through */
r_case
id|ISDN_NET_ENCAP_RAWIP
suffix:colon
multiline_comment|/* RAW-IP without MAC-Header */
id|olp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_NET_ENCAP_CISCOHDLCK
suffix:colon
id|ch
op_assign
(paren
id|cisco_hdr
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ch-&gt;addr
op_ne
id|CISCO_ADDR_UNICAST
)paren
op_logical_and
(paren
id|ch-&gt;addr
op_ne
id|CISCO_ADDR_BROADCAST
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Unknown Cisco addr 0x%02x&bslash;n&quot;
comma
id|lp-&gt;name
comma
id|ch-&gt;addr
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ch-&gt;ctrl
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Unknown Cisco ctrl 0x%02x&bslash;n&quot;
comma
id|lp-&gt;name
comma
id|ch-&gt;ctrl
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|ntohs
c_func
(paren
id|ch-&gt;type
)paren
)paren
(brace
r_case
id|CISCO_TYPE_INET
suffix:colon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|4
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISCO_TYPE_SLARP
suffix:colon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|4
)paren
suffix:semicolon
id|isdn_net_slarp_in
c_func
(paren
id|olp
comma
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Unknown Cisco type 0x%04x&bslash;n&quot;
comma
id|lp-&gt;name
comma
id|ch-&gt;type
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_NET_ENCAP_CISCOHDLC
suffix:colon
multiline_comment|/* CISCO-HDLC IP with type field and  fake I-frame-header */
id|skb_pull
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Fall through */
r_case
id|ISDN_NET_ENCAP_IPTYP
suffix:colon
multiline_comment|/* IP with type field */
id|olp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
id|skb-&gt;protocol
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
op_amp
(paren
id|skb-&gt;data
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|skb-&gt;data
op_eq
l_int|0xFFFF
)paren
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_802_3
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
r_case
id|ISDN_NET_ENCAP_SYNCPPP
suffix:colon
multiline_comment|/*&n;&t;&t;&t; * If encapsulation is syncppp, don&squot;t reset&n;&t;&t;&t; * huptimer on LCP packets.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|proto
op_ne
id|PPP_LCP
)paren
(brace
id|olp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
)brace
id|isdn_ppp_receive
c_func
(paren
id|lp-&gt;netdev
comma
id|olp
comma
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
(brace
)brace
macro_line|#ifdef CONFIG_ISDN_X25
multiline_comment|/* try if there are generic sync_device receiver routines */
r_if
c_cond
(paren
id|cprot
)paren
r_if
c_cond
(paren
id|cprot
op_member_access_from_pointer
id|pops
)paren
r_if
c_cond
(paren
id|cprot
op_member_access_from_pointer
id|pops
op_member_access_from_pointer
id|data_ind
)paren
(brace
id|cprot
op_member_access_from_pointer
id|pops
op_member_access_from_pointer
id|data_ind
c_func
(paren
id|cprot
comma
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_X25 */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: unknown encapsulation, dropping&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * A packet arrived via ISDN. Search interface-chain for a corresponding&n; * interface. If found, deliver packet to receiver-function and return 1,&n; * else return 0.&n; */
r_int
DECL|function|isdn_net_rcv_skb
id|isdn_net_rcv_skb
c_func
(paren
r_int
id|idx
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|dev-&gt;rx_netdev
(braket
id|idx
)braket
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
id|p-&gt;local
suffix:semicolon
r_if
c_cond
(paren
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
op_logical_and
(paren
op_logical_neg
id|lp-&gt;dialstate
)paren
)paren
(brace
id|isdn_net_receive
c_func
(paren
op_amp
id|p-&gt;dev
comma
id|skb
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|my_eth_header
id|my_eth_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
(brace
r_struct
id|ethhdr
op_star
id|eth
op_assign
(paren
r_struct
id|ethhdr
op_star
)paren
id|skb_push
c_func
(paren
id|skb
comma
id|ETH_HLEN
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set the protocol type. For a packet of type ETH_P_802_3 we&n;&t; * put the length here instead. It is up to the 802.2 layer to&n;&t; * carry protocol information.&n;&t; */
r_if
c_cond
(paren
id|type
op_ne
id|ETH_P_802_3
)paren
id|eth-&gt;h_proto
op_assign
id|htons
c_func
(paren
id|type
)paren
suffix:semicolon
r_else
id|eth-&gt;h_proto
op_assign
id|htons
c_func
(paren
id|len
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set the source hardware address.&n;&t; */
r_if
c_cond
(paren
id|saddr
)paren
id|memcpy
c_func
(paren
id|eth-&gt;h_source
comma
id|saddr
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
r_else
id|memcpy
c_func
(paren
id|eth-&gt;h_source
comma
id|dev-&gt;dev_addr
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Anyway, the loopback-device should never use this function...&n;&t; */
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
(paren
id|IFF_LOOPBACK
op_or
id|IFF_NOARP
)paren
)paren
(brace
id|memset
c_func
(paren
id|eth-&gt;h_dest
comma
l_int|0
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
r_return
id|ETH_HLEN
multiline_comment|/*(dev-&gt;hard_header_len)*/
suffix:semicolon
)brace
r_if
c_cond
(paren
id|daddr
)paren
(brace
id|memcpy
c_func
(paren
id|eth-&gt;h_dest
comma
id|daddr
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
r_return
id|ETH_HLEN
multiline_comment|/*dev-&gt;hard_header_len*/
suffix:semicolon
)brace
r_return
op_minus
id|ETH_HLEN
multiline_comment|/*dev-&gt;hard_header_len*/
suffix:semicolon
)brace
multiline_comment|/*&n; *  build an header&n; *  depends on encaps that is being used.&n; */
r_static
r_int
DECL|function|isdn_net_header
id|isdn_net_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|plen
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|ushort
id|len
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|lp-&gt;p_encap
)paren
(brace
r_case
id|ISDN_NET_ENCAP_ETHER
suffix:colon
id|len
op_assign
id|my_eth_header
c_func
(paren
id|skb
comma
id|dev
comma
id|type
comma
id|daddr
comma
id|saddr
comma
id|plen
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
r_case
id|ISDN_NET_ENCAP_SYNCPPP
suffix:colon
multiline_comment|/* stick on a fake header to keep fragmentation code happy. */
id|len
op_assign
id|IPPP_MAX_HEADER
suffix:semicolon
id|skb_push
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
id|ISDN_NET_ENCAP_RAWIP
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net_header called with RAW_IP!&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_NET_ENCAP_IPTYP
suffix:colon
multiline_comment|/* ethernet type field */
op_star
(paren
(paren
id|ushort
op_star
)paren
id|skb_push
c_func
(paren
id|skb
comma
l_int|2
)paren
)paren
op_assign
id|htons
c_func
(paren
id|type
)paren
suffix:semicolon
id|len
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_NET_ENCAP_UIHDLC
suffix:colon
multiline_comment|/* HDLC with UI-Frames (for ispa with -h1 option) */
op_star
(paren
(paren
id|ushort
op_star
)paren
id|skb_push
c_func
(paren
id|skb
comma
l_int|2
)paren
)paren
op_assign
id|htons
c_func
(paren
l_int|0x0103
)paren
suffix:semicolon
id|len
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_NET_ENCAP_CISCOHDLC
suffix:colon
id|skb_push
c_func
(paren
id|skb
comma
l_int|4
)paren
suffix:semicolon
id|skb-&gt;data
(braket
l_int|0
)braket
op_assign
l_int|0x0f
suffix:semicolon
id|skb-&gt;data
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
op_star
(paren
(paren
id|ushort
op_star
)paren
op_amp
id|skb-&gt;data
(braket
l_int|2
)braket
)paren
op_assign
id|htons
c_func
(paren
id|type
)paren
suffix:semicolon
id|len
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_X25
r_default
suffix:colon
(brace
)brace
multiline_comment|/* try if there are generic concap protocol routines */
r_if
c_cond
(paren
id|lp
op_member_access_from_pointer
id|netdev
op_member_access_from_pointer
id|cprot
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net_header called with concap_proto!&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_X25 */
)brace
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/* We don&squot;t need to send arp, because we have point-to-point connections. */
r_static
r_int
DECL|function|isdn_net_rebuild_header
id|isdn_net_rebuild_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|skb-&gt;dev
suffix:semicolon
id|isdn_net_local
op_star
id|lp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_ETHER
)paren
(brace
r_struct
id|ethhdr
op_star
id|eth
op_assign
(paren
r_struct
id|ethhdr
op_star
)paren
id|skb-&gt;data
suffix:semicolon
multiline_comment|/*&n;&t;&t; *      Only ARP/IP is currently supported&n;&t;&t; */
r_if
c_cond
(paren
id|eth-&gt;h_proto
op_ne
id|htons
c_func
(paren
id|ETH_P_IP
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net: %s don&squot;t know how to resolve type %d addresses?&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|eth-&gt;h_proto
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|eth-&gt;h_source
comma
id|dev-&gt;dev_addr
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *      Try to get ARP to resolve the header.&n;&t;&t; */
macro_line|#ifdef CONFIG_INET
id|ret
op_assign
id|arp_find
c_func
(paren
id|eth-&gt;h_dest
comma
id|skb
)paren
suffix:semicolon
macro_line|#endif
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Interface-setup. (just after registering a new interface)&n; */
r_static
r_int
DECL|function|isdn_net_init
id|isdn_net_init
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
id|ushort
id|max_hlhdr_len
op_assign
l_int|0
suffix:semicolon
id|isdn_net_local
op_star
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|ndev-&gt;priv
suffix:semicolon
r_int
id|drvidx
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
id|ndev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net_init: dev = NULL!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ndev-&gt;priv
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net_init: dev-&gt;priv = NULL!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|ether_setup
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|lp-&gt;org_hhc
op_assign
id|ndev-&gt;hard_header_cache
suffix:semicolon
id|lp-&gt;org_hcu
op_assign
id|ndev-&gt;header_cache_update
suffix:semicolon
multiline_comment|/* Setup the generic properties */
id|ndev-&gt;hard_header
op_assign
l_int|NULL
suffix:semicolon
id|ndev-&gt;hard_header_cache
op_assign
l_int|NULL
suffix:semicolon
id|ndev-&gt;header_cache_update
op_assign
l_int|NULL
suffix:semicolon
id|ndev-&gt;mtu
op_assign
l_int|1500
suffix:semicolon
id|ndev-&gt;flags
op_assign
id|IFF_NOARP
op_or
id|IFF_POINTOPOINT
suffix:semicolon
id|ndev-&gt;type
op_assign
id|ARPHRD_ETHER
suffix:semicolon
id|ndev-&gt;addr_len
op_assign
id|ETH_ALEN
suffix:semicolon
multiline_comment|/* for clients with MPPP maybe higher values better */
id|ndev-&gt;tx_queue_len
op_assign
l_int|30
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ETH_ALEN
suffix:semicolon
id|i
op_increment
)paren
id|ndev-&gt;broadcast
(braket
id|i
)braket
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* The ISDN-specific entries in the device structure. */
id|ndev-&gt;open
op_assign
op_amp
id|isdn_net_open
suffix:semicolon
id|ndev-&gt;hard_start_xmit
op_assign
op_amp
id|isdn_net_start_xmit
suffix:semicolon
multiline_comment|/*&n;&t; *  up till binding we ask the protocol layer to reserve as much&n;&t; *  as we might need for HL layer&n;&t; */
r_for
c_loop
(paren
id|drvidx
op_assign
l_int|0
suffix:semicolon
id|drvidx
OL
id|ISDN_MAX_DRIVERS
suffix:semicolon
id|drvidx
op_increment
)paren
r_if
c_cond
(paren
id|dev-&gt;drv
(braket
id|drvidx
)braket
)paren
r_if
c_cond
(paren
id|max_hlhdr_len
OL
id|dev-&gt;drv
(braket
id|drvidx
)braket
op_member_access_from_pointer
id|interface-&gt;hl_hdrlen
)paren
id|max_hlhdr_len
op_assign
id|dev-&gt;drv
(braket
id|drvidx
)braket
op_member_access_from_pointer
id|interface-&gt;hl_hdrlen
suffix:semicolon
id|ndev-&gt;hard_header_len
op_assign
id|ETH_HLEN
op_plus
id|max_hlhdr_len
suffix:semicolon
id|ndev-&gt;stop
op_assign
op_amp
id|isdn_net_close
suffix:semicolon
id|ndev-&gt;get_stats
op_assign
op_amp
id|isdn_net_get_stats
suffix:semicolon
id|ndev-&gt;rebuild_header
op_assign
op_amp
id|isdn_net_rebuild_header
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
id|ndev-&gt;do_ioctl
op_assign
id|isdn_ppp_dev_ioctl
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|isdn_net_swapbind
id|isdn_net_swapbind
c_func
(paren
r_int
id|drvidx
)paren
(brace
id|isdn_net_dev
op_star
id|p
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: swapping ch of %d&bslash;n&quot;
comma
id|drvidx
)paren
suffix:semicolon
macro_line|#endif
id|p
op_assign
id|dev-&gt;netdev
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;local-&gt;pre_device
op_eq
id|drvidx
)paren
r_switch
c_cond
(paren
id|p-&gt;local-&gt;pre_channel
)paren
(brace
r_case
l_int|0
suffix:colon
id|p-&gt;local-&gt;pre_channel
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|p-&gt;local-&gt;pre_channel
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|p
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|p-&gt;next
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|isdn_net_swap_usage
id|isdn_net_swap_usage
c_func
(paren
r_int
id|i1
comma
r_int
id|i2
)paren
(brace
r_int
id|u1
op_assign
id|dev-&gt;usage
(braket
id|i1
)braket
op_amp
id|ISDN_USAGE_EXCLUSIVE
suffix:semicolon
r_int
id|u2
op_assign
id|dev-&gt;usage
(braket
id|i2
)braket
op_amp
id|ISDN_USAGE_EXCLUSIVE
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: usage of %d and %d&bslash;n&quot;
comma
id|i1
comma
id|i2
)paren
suffix:semicolon
macro_line|#endif
id|dev-&gt;usage
(braket
id|i1
)braket
op_and_assign
op_complement
id|ISDN_USAGE_EXCLUSIVE
suffix:semicolon
id|dev-&gt;usage
(braket
id|i1
)braket
op_or_assign
id|u2
suffix:semicolon
id|dev-&gt;usage
(braket
id|i2
)braket
op_and_assign
op_complement
id|ISDN_USAGE_EXCLUSIVE
suffix:semicolon
id|dev-&gt;usage
(braket
id|i2
)braket
op_or_assign
id|u1
suffix:semicolon
id|isdn_info_update
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * An incoming call-request has arrived.&n; * Search the interface-chain for an appropriate interface.&n; * If found, connect the interface to the ISDN-channel and initiate&n; * D- and B-Channel-setup. If secure-flag is set, accept only&n; * configured phone-numbers. If callback-flag is set, initiate&n; * callback-dialing.&n; *&n; * Return-Value: 0 = No appropriate interface for this call.&n; *               1 = Call accepted&n; *               2 = Reject call, wait cbdelay, then call back&n; *               3 = Reject call&n; *               4 = Wait cbdelay, then call back&n; *               5 = No appropriate interface for this call,&n; *                   would eventually match if CID was longer.&n; */
r_int
DECL|function|isdn_net_find_icall
id|isdn_net_find_icall
c_func
(paren
r_int
id|di
comma
r_int
id|ch
comma
r_int
id|idx
comma
id|setup_parm
op_star
id|setup
)paren
(brace
r_char
op_star
id|eaz
suffix:semicolon
r_int
id|si1
suffix:semicolon
r_int
id|si2
suffix:semicolon
r_int
id|ematch
suffix:semicolon
r_int
id|wret
suffix:semicolon
r_int
id|swapped
suffix:semicolon
r_int
id|sidx
op_assign
l_int|0
suffix:semicolon
id|isdn_net_dev
op_star
id|p
suffix:semicolon
id|isdn_net_phone
op_star
id|n
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
r_char
id|nr
(braket
l_int|32
)braket
suffix:semicolon
multiline_comment|/* Search name in netdev-chain */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|setup-&gt;phone
(braket
l_int|0
)braket
)paren
(brace
id|nr
(braket
l_int|0
)braket
op_assign
l_char|&squot;0&squot;
suffix:semicolon
id|nr
(braket
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdn_net: Incoming call without OAD, assuming &squot;0&squot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
id|strcpy
c_func
(paren
id|nr
comma
id|setup-&gt;phone
)paren
suffix:semicolon
id|si1
op_assign
(paren
r_int
)paren
id|setup-&gt;si1
suffix:semicolon
id|si2
op_assign
(paren
r_int
)paren
id|setup-&gt;si2
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|setup-&gt;eazmsn
(braket
l_int|0
)braket
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net: Incoming call without CPN, assuming &squot;0&squot;&bslash;n&quot;
)paren
suffix:semicolon
id|eaz
op_assign
l_string|&quot;0&quot;
suffix:semicolon
)brace
r_else
id|eaz
op_assign
id|setup-&gt;eazmsn
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;net_verbose
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdn_net: call from %s,%d,%d -&gt; %s&bslash;n&quot;
comma
id|nr
comma
id|si1
comma
id|si2
comma
id|eaz
)paren
suffix:semicolon
multiline_comment|/* Accept only calls with Si1 = 7 (Data-Transmission) */
r_if
c_cond
(paren
id|si1
op_ne
l_int|7
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;net_verbose
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdn_net: Service-Indicator not 7, ignored&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|n
op_assign
(paren
id|isdn_net_phone
op_star
)paren
l_int|0
suffix:semicolon
id|p
op_assign
id|dev-&gt;netdev
suffix:semicolon
id|ematch
op_assign
id|wret
op_assign
id|swapped
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: di=%d ch=%d idx=%d usg=%d&bslash;n&quot;
comma
id|di
comma
id|ch
comma
id|idx
comma
id|dev-&gt;usage
(braket
id|idx
)braket
)paren
suffix:semicolon
macro_line|#endif
r_while
c_loop
(paren
id|p
)paren
(brace
r_int
id|matchret
suffix:semicolon
id|isdn_net_local
op_star
id|lp
op_assign
id|p-&gt;local
suffix:semicolon
multiline_comment|/* If last check has triggered as binding-swap, revert it */
r_switch
c_cond
(paren
id|swapped
)paren
(brace
r_case
l_int|2
suffix:colon
id|isdn_net_swap_usage
c_func
(paren
id|idx
comma
id|sidx
)paren
suffix:semicolon
multiline_comment|/* fall through */
r_case
l_int|1
suffix:colon
id|isdn_net_swapbind
c_func
(paren
id|di
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|swapped
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|matchret
op_assign
id|isdn_msncmp
c_func
(paren
id|eaz
comma
id|isdn_map_eaz2msn
c_func
(paren
id|lp-&gt;msn
comma
id|di
)paren
)paren
)paren
)paren
id|ematch
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Remember if more numbers eventually can match */
r_if
c_cond
(paren
id|matchret
OG
id|wret
)paren
id|wret
op_assign
id|matchret
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: if=&squot;%s&squot;, l.msn=%s, l.flags=%d, l.dstate=%d&bslash;n&quot;
comma
id|lp-&gt;name
comma
id|lp-&gt;msn
comma
id|lp-&gt;flags
comma
id|lp-&gt;dialstate
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
op_logical_neg
id|matchret
)paren
op_logical_and
multiline_comment|/* EAZ is matching   */
(paren
(paren
(paren
op_logical_neg
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
)paren
op_logical_and
multiline_comment|/* but not connected */
(paren
id|USG_NONE
c_func
(paren
id|dev-&gt;usage
(braket
id|idx
)braket
)paren
)paren
)paren
op_logical_or
multiline_comment|/* and ch. unused or */
(paren
(paren
(paren
(paren
id|lp-&gt;dialstate
op_eq
l_int|4
)paren
op_logical_or
(paren
id|lp-&gt;dialstate
op_eq
l_int|12
)paren
)paren
op_logical_and
multiline_comment|/* if dialing        */
(paren
op_logical_neg
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CALLBACK
)paren
)paren
)paren
multiline_comment|/* but no callback   */
)paren
)paren
)paren
(brace
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: match1, pdev=%d pch=%d&bslash;n&quot;
comma
id|lp-&gt;pre_device
comma
id|lp-&gt;pre_channel
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|dev-&gt;usage
(braket
id|idx
)braket
op_amp
id|ISDN_USAGE_EXCLUSIVE
)paren
(brace
r_if
c_cond
(paren
(paren
id|lp-&gt;pre_channel
op_ne
id|ch
)paren
op_logical_or
(paren
id|lp-&gt;pre_device
op_ne
id|di
)paren
)paren
(brace
multiline_comment|/* Here we got a problem:&n;&t;&t;&t;&t;&t; * If using an ICN-Card, an incoming call is always signaled on&n;&t;&t;&t;&t;&t; * on the first channel of the card, if both channels are&n;&t;&t;&t;&t;&t; * down. However this channel may be bound exclusive. If the&n;&t;&t;&t;&t;&t; * second channel is free, this call should be accepted.&n;&t;&t;&t;&t;&t; * The solution is horribly but it runs, so what:&n;&t;&t;&t;&t;&t; * We exchange the exclusive bindings of the two channels, the&n;&t;&t;&t;&t;&t; * corresponding variables in the interface-structs.&n;&t;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|ch
op_eq
l_int|0
)paren
(brace
id|sidx
op_assign
id|isdn_dc2minor
c_func
(paren
id|di
comma
l_int|1
)paren
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: ch is 0&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|USG_NONE
c_func
(paren
id|dev-&gt;usage
(braket
id|sidx
)braket
)paren
)paren
(brace
multiline_comment|/* Second Channel is free, now see if it is bound&n;&t;&t;&t;&t;&t;&t;&t; * exclusive too. */
r_if
c_cond
(paren
id|dev-&gt;usage
(braket
id|sidx
)braket
op_amp
id|ISDN_USAGE_EXCLUSIVE
)paren
(brace
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: 2nd channel is down and bound&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Yes, swap bindings only, if the original&n;&t;&t;&t;&t;&t;&t;&t;&t; * binding is bound to channel 1 of this driver */
r_if
c_cond
(paren
(paren
id|lp-&gt;pre_device
op_eq
id|di
)paren
op_logical_and
(paren
id|lp-&gt;pre_channel
op_eq
l_int|1
)paren
)paren
(brace
id|isdn_net_swapbind
c_func
(paren
id|di
)paren
suffix:semicolon
id|swapped
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* ... else iterate next device */
id|p
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|p-&gt;next
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
r_else
(brace
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: 2nd channel is down and unbound&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* No, swap always and swap excl-usage also */
id|isdn_net_swap_usage
c_func
(paren
id|idx
comma
id|sidx
)paren
suffix:semicolon
id|isdn_net_swapbind
c_func
(paren
id|di
)paren
suffix:semicolon
id|swapped
op_assign
l_int|2
suffix:semicolon
)brace
multiline_comment|/* Now check for exclusive binding again */
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: final check&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|dev-&gt;usage
(braket
id|idx
)braket
op_amp
id|ISDN_USAGE_EXCLUSIVE
)paren
op_logical_and
(paren
(paren
id|lp-&gt;pre_channel
op_ne
id|ch
)paren
op_logical_or
(paren
id|lp-&gt;pre_device
op_ne
id|di
)paren
)paren
)paren
(brace
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: final check failed&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|p
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|p-&gt;next
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* We are already on the second channel, so nothing to do */
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: already on 2nd channel&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
)brace
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: match2&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|n
op_assign
id|lp-&gt;phone
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_SECURE
)paren
(brace
r_while
c_loop
(paren
id|n
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|isdn_msncmp
c_func
(paren
id|nr
comma
id|n-&gt;num
)paren
)paren
r_break
suffix:semicolon
id|n
op_assign
(paren
id|isdn_net_phone
op_star
)paren
id|n-&gt;next
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|n
op_logical_or
(paren
op_logical_neg
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_SECURE
)paren
)paren
)paren
(brace
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: match3&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* matching interface found */
multiline_comment|/*&n;&t;&t;&t;&t; * Is the state STOPPED?&n;&t;&t;&t;&t; * If so, no dialin is allowed,&n;&t;&t;&t;&t; * so reject actively.&n;&t;&t;&t;&t; * */
r_if
c_cond
(paren
id|ISDN_NET_DIALMODE
c_func
(paren
op_star
id|lp
)paren
op_eq
id|ISDN_NET_DM_OFF
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;incoming call, interface %s `stopped&squot; -&gt; rejected&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
r_return
l_int|3
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t;&t; * Is the interface up?&n;&t;&t;&t;&t; * If not, reject the call actively.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|isdn_net_device_started
c_func
(paren
id|p
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: incoming call, interface down -&gt; rejected&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
r_return
l_int|3
suffix:semicolon
)brace
multiline_comment|/* Interface is up, now see if it&squot;s a slave. If so, see if&n;&t;&t;&t;&t; * it&squot;s master and parent slave is online. If not, reject the call.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|lp-&gt;master
)paren
(brace
id|isdn_net_local
op_star
id|mlp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|lp-&gt;master-&gt;priv
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ICALLslv: %s&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;master=%s&bslash;n&quot;
comma
id|mlp-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mlp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;master online&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Master is online, find parent-slave (master if first slave) */
r_while
c_loop
(paren
id|mlp-&gt;slave
)paren
(brace
r_if
c_cond
(paren
(paren
id|isdn_net_local
op_star
)paren
id|mlp-&gt;slave-&gt;priv
op_eq
id|lp
)paren
r_break
suffix:semicolon
id|mlp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|mlp-&gt;slave-&gt;priv
suffix:semicolon
)brace
)brace
r_else
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;master offline&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Found parent, if it&squot;s offline iterate next device */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;mlpf: %d&bslash;n&quot;
comma
id|mlp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mlp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
)paren
(brace
id|p
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|p-&gt;next
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CALLBACK
)paren
(brace
r_int
id|chi
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t; * Is the state MANUAL?&n;&t;&t;&t;&t;&t; * If so, no callback can be made,&n;&t;&t;&t;&t;&t; * so reject actively.&n;&t;&t;&t;&t;&t; * */
r_if
c_cond
(paren
id|ISDN_NET_DIALMODE
c_func
(paren
op_star
id|lp
)paren
op_eq
id|ISDN_NET_DM_OFF
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;incoming call for callback, interface %s `off&squot; -&gt; rejected&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
r_return
l_int|3
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: call from %s -&gt; %s, start callback&bslash;n&quot;
comma
id|lp-&gt;name
comma
id|nr
comma
id|eaz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;phone
(braket
l_int|1
)braket
)paren
(brace
multiline_comment|/* Grab a free ISDN-Channel */
r_if
c_cond
(paren
(paren
id|chi
op_assign
id|isdn_get_free_channel
c_func
(paren
id|ISDN_USAGE_NET
comma
id|lp-&gt;l2_proto
comma
id|lp-&gt;l3_proto
comma
id|lp-&gt;pre_device
comma
id|lp-&gt;pre_channel
comma
id|lp-&gt;msn
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net_find_icall: No channel for %s&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Setup dialstate. */
id|lp-&gt;dtimer
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;dialstate
op_assign
l_int|11
suffix:semicolon
multiline_comment|/* Connect interface with channel */
id|isdn_net_bind_channel
c_func
(paren
id|lp
comma
id|chi
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_SYNCPPP
)paren
r_if
c_cond
(paren
id|isdn_ppp_bind
c_func
(paren
id|lp
)paren
OL
l_int|0
)paren
(brace
id|isdn_net_unbind_channel
c_func
(paren
id|lp
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Initiate dialing by returning 2 or 4 */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CBHUP
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|4
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net: %s: No phone number&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: call from %s -&gt; %s accepted&bslash;n&quot;
comma
id|lp-&gt;name
comma
id|nr
comma
id|eaz
)paren
suffix:semicolon
multiline_comment|/* if this interface is dialing, it does it probably on a different&n;&t;&t;&t;&t;&t;   device, so free this device */
r_if
c_cond
(paren
(paren
id|lp-&gt;dialstate
op_eq
l_int|4
)paren
op_logical_or
(paren
id|lp-&gt;dialstate
op_eq
l_int|12
)paren
)paren
(brace
macro_line|#ifdef CONFIG_ISDN_PPP
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_SYNCPPP
)paren
id|isdn_ppp_free
c_func
(paren
id|lp
)paren
suffix:semicolon
macro_line|#endif
id|isdn_net_lp_disconnected
c_func
(paren
id|lp
)paren
suffix:semicolon
id|isdn_free_channel
c_func
(paren
id|lp-&gt;isdn_device
comma
id|lp-&gt;isdn_channel
comma
id|ISDN_USAGE_NET
)paren
suffix:semicolon
)brace
id|dev-&gt;usage
(braket
id|idx
)braket
op_and_assign
id|ISDN_USAGE_EXCLUSIVE
suffix:semicolon
id|dev-&gt;usage
(braket
id|idx
)braket
op_or_assign
id|ISDN_USAGE_NET
suffix:semicolon
id|strcpy
c_func
(paren
id|dev-&gt;num
(braket
id|idx
)braket
comma
id|nr
)paren
suffix:semicolon
id|isdn_info_update
c_func
(paren
)paren
suffix:semicolon
id|dev-&gt;st_netdev
(braket
id|idx
)braket
op_assign
id|lp-&gt;netdev
suffix:semicolon
id|lp-&gt;isdn_device
op_assign
id|di
suffix:semicolon
id|lp-&gt;isdn_channel
op_assign
id|ch
suffix:semicolon
id|lp-&gt;ppp_slot
op_assign
op_minus
l_int|1
suffix:semicolon
id|lp-&gt;flags
op_or_assign
id|ISDN_NET_CONNECTED
suffix:semicolon
id|lp-&gt;dialstate
op_assign
l_int|7
suffix:semicolon
id|lp-&gt;dtimer
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;outgoing
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;hupflags
op_or_assign
id|ISDN_WAITCHARGE
suffix:semicolon
id|lp-&gt;hupflags
op_and_assign
op_complement
id|ISDN_HAVECHARGE
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_SYNCPPP
)paren
r_if
c_cond
(paren
id|isdn_ppp_bind
c_func
(paren
id|lp
)paren
OL
l_int|0
)paren
(brace
id|isdn_net_unbind_channel
c_func
(paren
id|lp
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
)brace
id|p
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|p-&gt;next
suffix:semicolon
)brace
multiline_comment|/* If none of configured EAZ/MSN matched and not verbose, be silent */
r_if
c_cond
(paren
op_logical_neg
id|ematch
op_logical_or
id|dev-&gt;net_verbose
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdn_net: call from %s -&gt; %d %s ignored&bslash;n&quot;
comma
id|nr
comma
id|di
comma
id|eaz
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
(paren
id|wret
op_eq
l_int|2
)paren
ques
c_cond
l_int|5
suffix:colon
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Search list of net-interfaces for an interface with given name.&n; */
id|isdn_net_dev
op_star
DECL|function|isdn_net_findif
id|isdn_net_findif
c_func
(paren
r_char
op_star
id|name
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|dev-&gt;netdev
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|p-&gt;local-&gt;name
comma
id|name
)paren
)paren
r_return
id|p
suffix:semicolon
id|p
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|p-&gt;next
suffix:semicolon
)brace
r_return
(paren
id|isdn_net_dev
op_star
)paren
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Force a net-interface to dial out.&n; * This is called from the userlevel-routine below or&n; * from isdn_net_start_xmit().&n; */
r_int
DECL|function|isdn_net_force_dial_lp
id|isdn_net_force_dial_lp
c_func
(paren
id|isdn_net_local
op_star
id|lp
)paren
(brace
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
)paren
op_logical_and
op_logical_neg
id|lp-&gt;dialstate
)paren
(brace
r_int
id|chi
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;phone
(braket
l_int|1
)braket
)paren
(brace
id|ulong
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Grab a free ISDN-Channel */
r_if
c_cond
(paren
(paren
id|chi
op_assign
id|isdn_get_free_channel
c_func
(paren
id|ISDN_USAGE_NET
comma
id|lp-&gt;l2_proto
comma
id|lp-&gt;l3_proto
comma
id|lp-&gt;pre_device
comma
id|lp-&gt;pre_channel
comma
id|lp-&gt;msn
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net_force_dial: No channel for %s&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|lp-&gt;dialstate
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Connect interface with channel */
id|isdn_net_bind_channel
c_func
(paren
id|lp
comma
id|chi
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_SYNCPPP
)paren
r_if
c_cond
(paren
id|isdn_ppp_bind
c_func
(paren
id|lp
)paren
OL
l_int|0
)paren
(brace
id|isdn_net_unbind_channel
c_func
(paren
id|lp
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Initiate dialing */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|isdn_net_dial
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/*&n; * This is called from certain upper protocol layers (multilink ppp&n; * and x25iface encapsulation module) that want to initiate dialing&n; * themselves.&n; */
r_int
DECL|function|isdn_net_dial_req
id|isdn_net_dial_req
c_func
(paren
id|isdn_net_local
op_star
id|lp
)paren
(brace
multiline_comment|/* is there a better error code? */
r_if
c_cond
(paren
op_logical_neg
(paren
id|ISDN_NET_DIALMODE
c_func
(paren
op_star
id|lp
)paren
op_eq
id|ISDN_NET_DM_AUTO
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_return
id|isdn_net_force_dial_lp
c_func
(paren
id|lp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Force a net-interface to dial out.&n; * This is always called from within userspace (ISDN_IOCTL_NET_DIAL).&n; */
r_int
DECL|function|isdn_net_force_dial
id|isdn_net_force_dial
c_func
(paren
r_char
op_star
id|name
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|isdn_net_findif
c_func
(paren
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
(paren
id|isdn_net_force_dial_lp
c_func
(paren
id|p-&gt;local
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Allocate a new network-interface and initialize its data structures.&n; */
r_char
op_star
DECL|function|isdn_net_new
id|isdn_net_new
c_func
(paren
r_char
op_star
id|name
comma
r_struct
id|net_device
op_star
id|master
)paren
(brace
id|isdn_net_dev
op_star
id|netdev
suffix:semicolon
multiline_comment|/* Avoid creating an existing interface */
r_if
c_cond
(paren
id|isdn_net_findif
c_func
(paren
id|name
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net: interface %s already exists&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|netdev
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|isdn_net_dev
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net: Could not allocate net-device&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|netdev
comma
l_int|0
comma
r_sizeof
(paren
id|isdn_net_dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|netdev-&gt;local
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|isdn_net_local
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net: Could not allocate device locals&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|netdev-&gt;local
comma
l_int|0
comma
r_sizeof
(paren
id|isdn_net_local
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|name
op_eq
l_int|NULL
)paren
id|strcpy
c_func
(paren
id|netdev-&gt;local-&gt;name
comma
l_string|&quot;         &quot;
)paren
suffix:semicolon
r_else
id|strcpy
c_func
(paren
id|netdev-&gt;local-&gt;name
comma
id|name
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|netdev-&gt;dev.name
comma
id|netdev-&gt;local-&gt;name
)paren
suffix:semicolon
id|netdev-&gt;dev.priv
op_assign
id|netdev-&gt;local
suffix:semicolon
id|netdev-&gt;dev.init
op_assign
id|isdn_net_init
suffix:semicolon
id|netdev-&gt;local-&gt;p_encap
op_assign
id|ISDN_NET_ENCAP_RAWIP
suffix:semicolon
r_if
c_cond
(paren
id|master
)paren
(brace
multiline_comment|/* Device shall be a slave */
r_struct
id|net_device
op_star
id|p
op_assign
(paren
(paren
(paren
id|isdn_net_local
op_star
)paren
id|master-&gt;priv
)paren
op_member_access_from_pointer
id|slave
)paren
suffix:semicolon
r_struct
id|net_device
op_star
id|q
op_assign
id|master
suffix:semicolon
id|netdev-&gt;local-&gt;master
op_assign
id|master
suffix:semicolon
multiline_comment|/* Put device at end of slave-chain */
r_while
c_loop
(paren
id|p
)paren
(brace
id|q
op_assign
id|p
suffix:semicolon
id|p
op_assign
(paren
(paren
(paren
id|isdn_net_local
op_star
)paren
id|p-&gt;priv
)paren
op_member_access_from_pointer
id|slave
)paren
suffix:semicolon
)brace
(paren
(paren
id|isdn_net_local
op_star
)paren
id|q-&gt;priv
)paren
op_member_access_from_pointer
id|slave
op_assign
op_amp
(paren
id|netdev-&gt;dev
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Device shall be a master */
multiline_comment|/*&n;&t;&t; * Watchdog timer (currently) for master only.&n;&t;&t; */
id|netdev-&gt;dev.tx_timeout
op_assign
id|isdn_net_tx_timeout
suffix:semicolon
id|netdev-&gt;dev.watchdog_timeo
op_assign
id|ISDN_NET_TX_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
op_amp
id|netdev-&gt;dev
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net: Could not register net-device&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|netdev-&gt;local
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|netdev
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
id|netdev-&gt;local-&gt;magic
op_assign
id|ISDN_NET_MAGIC
suffix:semicolon
id|netdev-&gt;queue
op_assign
id|netdev-&gt;local
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|netdev-&gt;queue_lock
)paren
suffix:semicolon
id|netdev-&gt;local-&gt;last
op_assign
id|netdev-&gt;local
suffix:semicolon
id|netdev-&gt;local-&gt;netdev
op_assign
id|netdev
suffix:semicolon
id|netdev-&gt;local-&gt;next
op_assign
id|netdev-&gt;local
suffix:semicolon
id|netdev-&gt;local-&gt;tqueue.sync
op_assign
l_int|0
suffix:semicolon
id|netdev-&gt;local-&gt;tqueue.routine
op_assign
id|isdn_net_softint
suffix:semicolon
id|netdev-&gt;local-&gt;tqueue.data
op_assign
id|netdev-&gt;local
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|netdev-&gt;local-&gt;xmit_lock
)paren
suffix:semicolon
id|netdev-&gt;local-&gt;isdn_device
op_assign
op_minus
l_int|1
suffix:semicolon
id|netdev-&gt;local-&gt;isdn_channel
op_assign
op_minus
l_int|1
suffix:semicolon
id|netdev-&gt;local-&gt;pre_device
op_assign
op_minus
l_int|1
suffix:semicolon
id|netdev-&gt;local-&gt;pre_channel
op_assign
op_minus
l_int|1
suffix:semicolon
id|netdev-&gt;local-&gt;exclusive
op_assign
op_minus
l_int|1
suffix:semicolon
id|netdev-&gt;local-&gt;ppp_slot
op_assign
op_minus
l_int|1
suffix:semicolon
id|netdev-&gt;local-&gt;pppbind
op_assign
op_minus
l_int|1
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|netdev-&gt;local-&gt;super_tx_queue
)paren
suffix:semicolon
id|netdev-&gt;local-&gt;l2_proto
op_assign
id|ISDN_PROTO_L2_X75I
suffix:semicolon
id|netdev-&gt;local-&gt;l3_proto
op_assign
id|ISDN_PROTO_L3_TRANS
suffix:semicolon
id|netdev-&gt;local-&gt;triggercps
op_assign
l_int|6000
suffix:semicolon
id|netdev-&gt;local-&gt;slavedelay
op_assign
l_int|10
op_star
id|HZ
suffix:semicolon
id|netdev-&gt;local-&gt;hupflags
op_assign
id|ISDN_INHUP
suffix:semicolon
multiline_comment|/* Do hangup even on incoming calls */
id|netdev-&gt;local-&gt;onhtime
op_assign
l_int|10
suffix:semicolon
multiline_comment|/* Default hangup-time for saving costs&n;&t;   of those who forget configuring this */
id|netdev-&gt;local-&gt;dialmax
op_assign
l_int|1
suffix:semicolon
id|netdev-&gt;local-&gt;flags
op_assign
id|ISDN_NET_CBHUP
op_or
id|ISDN_NET_DM_MANUAL
suffix:semicolon
multiline_comment|/* Hangup before Callback, manual dial */
id|netdev-&gt;local-&gt;cbdelay
op_assign
l_int|25
suffix:semicolon
multiline_comment|/* Wait 5 secs before Callback */
id|netdev-&gt;local-&gt;dialtimeout
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Infinite Dial-Timeout */
id|netdev-&gt;local-&gt;dialwait
op_assign
l_int|5
op_star
id|HZ
suffix:semicolon
multiline_comment|/* Wait 5 sec. after failed dial */
id|netdev-&gt;local-&gt;dialstarted
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Jiffies of last dial-start */
id|netdev-&gt;local-&gt;dialwait_timer
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Jiffies of earliest next dial-start */
multiline_comment|/* Put into to netdev-chain */
id|netdev-&gt;next
op_assign
(paren
r_void
op_star
)paren
id|dev-&gt;netdev
suffix:semicolon
id|dev-&gt;netdev
op_assign
id|netdev
suffix:semicolon
r_return
id|netdev-&gt;dev.name
suffix:semicolon
)brace
r_char
op_star
DECL|function|isdn_net_newslave
id|isdn_net_newslave
c_func
(paren
r_char
op_star
id|parm
)paren
(brace
r_char
op_star
id|p
op_assign
id|strchr
c_func
(paren
id|parm
comma
l_char|&squot;,&squot;
)paren
suffix:semicolon
id|isdn_net_dev
op_star
id|n
suffix:semicolon
r_char
id|newname
(braket
l_int|10
)braket
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
multiline_comment|/* Slave-Name MUST not be empty */
r_if
c_cond
(paren
op_logical_neg
id|strlen
c_func
(paren
id|p
op_plus
l_int|1
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
id|strcpy
c_func
(paren
id|newname
comma
id|p
op_plus
l_int|1
)paren
suffix:semicolon
op_star
id|p
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Master must already exist */
r_if
c_cond
(paren
op_logical_neg
(paren
id|n
op_assign
id|isdn_net_findif
c_func
(paren
id|parm
)paren
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* Master must be a real interface, not a slave */
r_if
c_cond
(paren
id|n-&gt;local-&gt;master
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* Master must not be started yet */
r_if
c_cond
(paren
id|isdn_net_device_started
c_func
(paren
id|n
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
r_return
(paren
id|isdn_net_new
c_func
(paren
id|newname
comma
op_amp
(paren
id|n-&gt;dev
)paren
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Set interface-parameters.&n; * Always set all parameters, so the user-level application is responsible&n; * for not overwriting existing setups. It has to get the current&n; * setup first, if only selected parameters are to be changed.&n; */
r_int
DECL|function|isdn_net_setcfg
id|isdn_net_setcfg
c_func
(paren
id|isdn_net_ioctl_cfg
op_star
id|cfg
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|isdn_net_findif
c_func
(paren
id|cfg-&gt;name
)paren
suffix:semicolon
id|ulong
id|features
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|drvidx
suffix:semicolon
r_int
id|chidx
suffix:semicolon
r_char
id|drvid
(braket
l_int|25
)braket
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_X25
id|ulong
id|flags
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|p
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
id|p-&gt;local
suffix:semicolon
multiline_comment|/* See if any registered driver supports the features we want */
id|features
op_assign
(paren
(paren
l_int|1
op_lshift
id|cfg-&gt;l2_proto
)paren
op_lshift
id|ISDN_FEATURE_L2_SHIFT
)paren
op_or
(paren
(paren
l_int|1
op_lshift
id|cfg-&gt;l3_proto
)paren
op_lshift
id|ISDN_FEATURE_L3_SHIFT
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_MAX_DRIVERS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|dev-&gt;drv
(braket
id|i
)braket
)paren
r_if
c_cond
(paren
(paren
id|dev-&gt;drv
(braket
id|i
)braket
op_member_access_from_pointer
id|interface-&gt;features
op_amp
id|features
)paren
op_eq
id|features
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|ISDN_MAX_DRIVERS
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net: No driver with selected features&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_ne
id|cfg-&gt;p_encap
)paren
(brace
macro_line|#ifdef CONFIG_ISDN_X25
r_struct
id|concap_proto
op_star
id|cprot
op_assign
id|p
op_member_access_from_pointer
id|cprot
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|isdn_net_device_started
c_func
(paren
id|p
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: cannot change encap when if is up&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ISDN_X25
multiline_comment|/* delete old encapsulation protocol if present ... */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* avoid races with incoming events trying to&n;&t;&t;&t;&t;  call cprot-&gt;pops methods */
r_if
c_cond
(paren
id|cprot
op_logical_and
id|cprot
op_member_access_from_pointer
id|pops
)paren
(brace
id|cprot
op_member_access_from_pointer
id|pops
op_member_access_from_pointer
id|proto_del
(paren
id|cprot
)paren
suffix:semicolon
)brace
id|p
op_member_access_from_pointer
id|cprot
op_assign
l_int|NULL
suffix:semicolon
id|lp
op_member_access_from_pointer
id|dops
op_assign
l_int|NULL
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* ... ,  prepare for configuration of new one ... */
r_switch
c_cond
(paren
id|cfg
op_member_access_from_pointer
id|p_encap
)paren
(brace
r_case
id|ISDN_NET_ENCAP_X25IFACE
suffix:colon
id|lp
op_member_access_from_pointer
id|dops
op_assign
op_amp
id|isdn_concap_reliable_dl_dops
suffix:semicolon
)brace
multiline_comment|/* ... and allocate new one ... */
id|p
op_member_access_from_pointer
id|cprot
op_assign
id|isdn_concap_new
c_func
(paren
id|cfg
op_member_access_from_pointer
id|p_encap
)paren
suffix:semicolon
multiline_comment|/* p -&gt; cprot == NULL now if p_encap is not supported&n;&t;&t;&t;   by means of the concap_proto mechanism */
multiline_comment|/* the protocol is not configured yet; this will&n;&t;&t;&t;   happen later when isdn_net_reset() is called */
macro_line|#endif
)brace
r_switch
c_cond
(paren
id|cfg-&gt;p_encap
)paren
(brace
r_case
id|ISDN_NET_ENCAP_SYNCPPP
suffix:colon
macro_line|#ifndef CONFIG_ISDN_PPP
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: SyncPPP support not configured&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
macro_line|#else
id|p-&gt;dev.type
op_assign
id|ARPHRD_PPP
suffix:semicolon
multiline_comment|/* change ARP type */
id|p-&gt;dev.addr_len
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|ISDN_NET_ENCAP_X25IFACE
suffix:colon
macro_line|#ifndef CONFIG_ISDN_X25
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: isdn-x25 support not configured&bslash;n&quot;
comma
id|p-&gt;local-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
macro_line|#else
id|p-&gt;dev.type
op_assign
id|ARPHRD_X25
suffix:semicolon
multiline_comment|/* change ARP type */
id|p-&gt;dev.addr_len
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|cfg-&gt;p_encap
op_ge
l_int|0
op_logical_and
id|cfg-&gt;p_encap
op_le
id|ISDN_NET_ENCAP_MAX_ENCAP
)paren
(brace
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: encapsulation protocol %d not supported&bslash;n&quot;
comma
id|p-&gt;local-&gt;name
comma
id|cfg-&gt;p_encap
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|cfg-&gt;drvid
)paren
)paren
(brace
multiline_comment|/* A bind has been requested ... */
r_char
op_star
id|c
comma
op_star
id|e
suffix:semicolon
id|drvidx
op_assign
op_minus
l_int|1
suffix:semicolon
id|chidx
op_assign
op_minus
l_int|1
suffix:semicolon
id|strcpy
c_func
(paren
id|drvid
comma
id|cfg-&gt;drvid
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|c
op_assign
id|strchr
c_func
(paren
id|drvid
comma
l_char|&squot;,&squot;
)paren
)paren
)paren
(brace
multiline_comment|/* The channel-number is appended to the driver-Id with a comma */
id|chidx
op_assign
(paren
r_int
)paren
id|simple_strtoul
c_func
(paren
id|c
op_plus
l_int|1
comma
op_amp
id|e
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|e
op_eq
id|c
)paren
id|chidx
op_assign
op_minus
l_int|1
suffix:semicolon
op_star
id|c
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_MAX_DRIVERS
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* Lookup driver-Id in array */
r_if
c_cond
(paren
op_logical_neg
(paren
id|strcmp
c_func
(paren
id|dev-&gt;drvid
(braket
id|i
)braket
comma
id|drvid
)paren
)paren
)paren
(brace
id|drvidx
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|drvidx
op_eq
op_minus
l_int|1
)paren
op_logical_or
(paren
id|chidx
op_eq
op_minus
l_int|1
)paren
)paren
multiline_comment|/* Either driver-Id or channel-number invalid */
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Parameters are valid, so get them */
id|drvidx
op_assign
id|lp-&gt;pre_device
suffix:semicolon
id|chidx
op_assign
id|lp-&gt;pre_channel
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cfg-&gt;exclusive
OG
l_int|0
)paren
(brace
r_int
id|flags
suffix:semicolon
multiline_comment|/* If binding is exclusive, try to grab the channel */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|isdn_get_free_channel
c_func
(paren
id|ISDN_USAGE_NET
comma
id|lp-&gt;l2_proto
comma
id|lp-&gt;l3_proto
comma
id|drvidx
comma
id|chidx
comma
id|lp-&gt;msn
)paren
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* Grab failed, because desired channel is in use */
id|lp-&gt;exclusive
op_assign
op_minus
l_int|1
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* All went ok, so update isdninfo */
id|dev-&gt;usage
(braket
id|i
)braket
op_assign
id|ISDN_USAGE_EXCLUSIVE
suffix:semicolon
id|isdn_info_update
c_func
(paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|lp-&gt;exclusive
op_assign
id|i
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Non-exclusive binding or unbind. */
id|lp-&gt;exclusive
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|lp-&gt;pre_device
op_ne
op_minus
l_int|1
)paren
op_logical_and
(paren
id|cfg-&gt;exclusive
op_eq
op_minus
l_int|1
)paren
)paren
(brace
id|isdn_unexclusive_channel
c_func
(paren
id|lp-&gt;pre_device
comma
id|lp-&gt;pre_channel
)paren
suffix:semicolon
id|isdn_free_channel
c_func
(paren
id|lp-&gt;pre_device
comma
id|lp-&gt;pre_channel
comma
id|ISDN_USAGE_NET
)paren
suffix:semicolon
id|drvidx
op_assign
op_minus
l_int|1
suffix:semicolon
id|chidx
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
)brace
id|strcpy
c_func
(paren
id|lp-&gt;msn
comma
id|cfg-&gt;eaz
)paren
suffix:semicolon
id|lp-&gt;pre_device
op_assign
id|drvidx
suffix:semicolon
id|lp-&gt;pre_channel
op_assign
id|chidx
suffix:semicolon
id|lp-&gt;onhtime
op_assign
id|cfg-&gt;onhtime
suffix:semicolon
id|lp-&gt;charge
op_assign
id|cfg-&gt;charge
suffix:semicolon
id|lp-&gt;l2_proto
op_assign
id|cfg-&gt;l2_proto
suffix:semicolon
id|lp-&gt;l3_proto
op_assign
id|cfg-&gt;l3_proto
suffix:semicolon
id|lp-&gt;cbdelay
op_assign
id|cfg-&gt;cbdelay
suffix:semicolon
id|lp-&gt;dialmax
op_assign
id|cfg-&gt;dialmax
suffix:semicolon
id|lp-&gt;triggercps
op_assign
id|cfg-&gt;triggercps
suffix:semicolon
id|lp-&gt;slavedelay
op_assign
id|cfg-&gt;slavedelay
op_star
id|HZ
suffix:semicolon
id|lp-&gt;pppbind
op_assign
id|cfg-&gt;pppbind
suffix:semicolon
id|lp-&gt;dialtimeout
op_assign
id|cfg-&gt;dialtimeout
op_ge
l_int|0
ques
c_cond
id|cfg-&gt;dialtimeout
op_star
id|HZ
suffix:colon
op_minus
l_int|1
suffix:semicolon
id|lp-&gt;dialwait
op_assign
id|cfg-&gt;dialwait
op_star
id|HZ
suffix:semicolon
r_if
c_cond
(paren
id|cfg-&gt;secure
)paren
id|lp-&gt;flags
op_or_assign
id|ISDN_NET_SECURE
suffix:semicolon
r_else
id|lp-&gt;flags
op_and_assign
op_complement
id|ISDN_NET_SECURE
suffix:semicolon
r_if
c_cond
(paren
id|cfg-&gt;cbhup
)paren
id|lp-&gt;flags
op_or_assign
id|ISDN_NET_CBHUP
suffix:semicolon
r_else
id|lp-&gt;flags
op_and_assign
op_complement
id|ISDN_NET_CBHUP
suffix:semicolon
r_switch
c_cond
(paren
id|cfg-&gt;callback
)paren
(brace
r_case
l_int|0
suffix:colon
id|lp-&gt;flags
op_and_assign
op_complement
(paren
id|ISDN_NET_CALLBACK
op_or
id|ISDN_NET_CBOUT
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|lp-&gt;flags
op_or_assign
id|ISDN_NET_CALLBACK
suffix:semicolon
id|lp-&gt;flags
op_and_assign
op_complement
id|ISDN_NET_CBOUT
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|lp-&gt;flags
op_or_assign
id|ISDN_NET_CBOUT
suffix:semicolon
id|lp-&gt;flags
op_and_assign
op_complement
id|ISDN_NET_CALLBACK
suffix:semicolon
r_break
suffix:semicolon
)brace
id|lp-&gt;flags
op_and_assign
op_complement
id|ISDN_NET_DIALMODE_MASK
suffix:semicolon
multiline_comment|/* first all bits off */
r_if
c_cond
(paren
id|cfg-&gt;dialmode
op_logical_and
op_logical_neg
(paren
id|cfg-&gt;dialmode
op_amp
id|ISDN_NET_DIALMODE_MASK
)paren
)paren
(brace
multiline_comment|/* old isdnctrl version, where only 0 or 1 is given */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Old isdnctrl version detected! Please update.&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;flags
op_or_assign
id|ISDN_NET_DM_OFF
suffix:semicolon
multiline_comment|/* turn on `off&squot; bit */
)brace
r_else
(brace
id|lp-&gt;flags
op_or_assign
id|cfg-&gt;dialmode
suffix:semicolon
multiline_comment|/* turn on selected bits */
)brace
r_if
c_cond
(paren
id|cfg-&gt;chargehup
)paren
id|lp-&gt;hupflags
op_or_assign
id|ISDN_CHARGEHUP
suffix:semicolon
r_else
id|lp-&gt;hupflags
op_and_assign
op_complement
id|ISDN_CHARGEHUP
suffix:semicolon
r_if
c_cond
(paren
id|cfg-&gt;ihup
)paren
id|lp-&gt;hupflags
op_or_assign
id|ISDN_INHUP
suffix:semicolon
r_else
id|lp-&gt;hupflags
op_and_assign
op_complement
id|ISDN_INHUP
suffix:semicolon
r_if
c_cond
(paren
id|cfg-&gt;chargeint
OG
l_int|10
)paren
(brace
id|lp-&gt;hupflags
op_or_assign
id|ISDN_CHARGEHUP
op_or
id|ISDN_HAVECHARGE
op_or
id|ISDN_MANCHARGE
suffix:semicolon
id|lp-&gt;chargeint
op_assign
id|cfg-&gt;chargeint
op_star
id|HZ
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cfg-&gt;p_encap
op_ne
id|lp-&gt;p_encap
)paren
(brace
r_if
c_cond
(paren
id|cfg-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_RAWIP
)paren
(brace
id|p-&gt;dev.hard_header
op_assign
l_int|NULL
suffix:semicolon
id|p-&gt;dev.hard_header_cache
op_assign
l_int|NULL
suffix:semicolon
id|p-&gt;dev.header_cache_update
op_assign
l_int|NULL
suffix:semicolon
id|p-&gt;dev.flags
op_assign
id|IFF_NOARP
op_or
id|IFF_POINTOPOINT
suffix:semicolon
)brace
r_else
(brace
id|p-&gt;dev.hard_header
op_assign
id|isdn_net_header
suffix:semicolon
r_if
c_cond
(paren
id|cfg-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_ETHER
)paren
(brace
id|p-&gt;dev.hard_header_cache
op_assign
id|lp-&gt;org_hhc
suffix:semicolon
id|p-&gt;dev.header_cache_update
op_assign
id|lp-&gt;org_hcu
suffix:semicolon
id|p-&gt;dev.flags
op_assign
id|IFF_BROADCAST
op_or
id|IFF_MULTICAST
suffix:semicolon
)brace
r_else
(brace
id|p-&gt;dev.hard_header_cache
op_assign
l_int|NULL
suffix:semicolon
id|p-&gt;dev.header_cache_update
op_assign
l_int|NULL
suffix:semicolon
id|p-&gt;dev.flags
op_assign
id|IFF_NOARP
op_or
id|IFF_POINTOPOINT
suffix:semicolon
)brace
)brace
)brace
id|lp-&gt;p_encap
op_assign
id|cfg-&gt;p_encap
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n; * Perform get-interface-parameters.ioctl&n; */
r_int
DECL|function|isdn_net_getcfg
id|isdn_net_getcfg
c_func
(paren
id|isdn_net_ioctl_cfg
op_star
id|cfg
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|isdn_net_findif
c_func
(paren
id|cfg-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
id|p-&gt;local
suffix:semicolon
id|strcpy
c_func
(paren
id|cfg-&gt;eaz
comma
id|lp-&gt;msn
)paren
suffix:semicolon
id|cfg-&gt;exclusive
op_assign
id|lp-&gt;exclusive
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;pre_device
op_ge
l_int|0
)paren
(brace
id|sprintf
c_func
(paren
id|cfg-&gt;drvid
comma
l_string|&quot;%s,%d&quot;
comma
id|dev-&gt;drvid
(braket
id|lp-&gt;pre_device
)braket
comma
id|lp-&gt;pre_channel
)paren
suffix:semicolon
)brace
r_else
id|cfg-&gt;drvid
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|cfg-&gt;onhtime
op_assign
id|lp-&gt;onhtime
suffix:semicolon
id|cfg-&gt;charge
op_assign
id|lp-&gt;charge
suffix:semicolon
id|cfg-&gt;l2_proto
op_assign
id|lp-&gt;l2_proto
suffix:semicolon
id|cfg-&gt;l3_proto
op_assign
id|lp-&gt;l3_proto
suffix:semicolon
id|cfg-&gt;p_encap
op_assign
id|lp-&gt;p_encap
suffix:semicolon
id|cfg-&gt;secure
op_assign
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_SECURE
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|cfg-&gt;callback
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CALLBACK
)paren
id|cfg-&gt;callback
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CBOUT
)paren
id|cfg-&gt;callback
op_assign
l_int|2
suffix:semicolon
id|cfg-&gt;cbhup
op_assign
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CBHUP
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|cfg-&gt;dialmode
op_assign
id|lp-&gt;flags
op_amp
id|ISDN_NET_DIALMODE_MASK
suffix:semicolon
id|cfg-&gt;chargehup
op_assign
(paren
id|lp-&gt;hupflags
op_amp
l_int|4
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|cfg-&gt;ihup
op_assign
(paren
id|lp-&gt;hupflags
op_amp
l_int|8
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|cfg-&gt;cbdelay
op_assign
id|lp-&gt;cbdelay
suffix:semicolon
id|cfg-&gt;dialmax
op_assign
id|lp-&gt;dialmax
suffix:semicolon
id|cfg-&gt;triggercps
op_assign
id|lp-&gt;triggercps
suffix:semicolon
id|cfg-&gt;slavedelay
op_assign
id|lp-&gt;slavedelay
op_div
id|HZ
suffix:semicolon
id|cfg-&gt;chargeint
op_assign
(paren
id|lp-&gt;hupflags
op_amp
id|ISDN_CHARGEHUP
)paren
ques
c_cond
(paren
id|lp-&gt;chargeint
op_div
id|HZ
)paren
suffix:colon
l_int|0
suffix:semicolon
id|cfg-&gt;pppbind
op_assign
id|lp-&gt;pppbind
suffix:semicolon
id|cfg-&gt;dialtimeout
op_assign
id|lp-&gt;dialtimeout
op_ge
l_int|0
ques
c_cond
id|lp-&gt;dialtimeout
op_div
id|HZ
suffix:colon
op_minus
l_int|1
suffix:semicolon
id|cfg-&gt;dialwait
op_assign
id|lp-&gt;dialwait
op_div
id|HZ
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;slave
)paren
id|strcpy
c_func
(paren
id|cfg-&gt;slave
comma
(paren
(paren
id|isdn_net_local
op_star
)paren
id|lp-&gt;slave-&gt;priv
)paren
op_member_access_from_pointer
id|name
)paren
suffix:semicolon
r_else
id|cfg-&gt;slave
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;master
)paren
id|strcpy
c_func
(paren
id|cfg-&gt;master
comma
(paren
(paren
id|isdn_net_local
op_star
)paren
id|lp-&gt;master-&gt;priv
)paren
op_member_access_from_pointer
id|name
)paren
suffix:semicolon
r_else
id|cfg-&gt;master
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n; * Add a phone-number to an interface.&n; */
r_int
DECL|function|isdn_net_addphone
id|isdn_net_addphone
c_func
(paren
id|isdn_net_ioctl_phone
op_star
id|phone
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|isdn_net_findif
c_func
(paren
id|phone-&gt;name
)paren
suffix:semicolon
id|isdn_net_phone
op_star
id|n
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|n
op_assign
(paren
id|isdn_net_phone
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|isdn_net_phone
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|strcpy
c_func
(paren
id|n-&gt;num
comma
id|phone-&gt;phone
)paren
suffix:semicolon
id|n-&gt;next
op_assign
id|p-&gt;local-&gt;phone
(braket
id|phone-&gt;outgoing
op_amp
l_int|1
)braket
suffix:semicolon
id|p-&gt;local-&gt;phone
(braket
id|phone-&gt;outgoing
op_amp
l_int|1
)braket
op_assign
id|n
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n; * Copy a string of all phone-numbers of an interface to user space.&n; * This might sleep and must be called with the isdn semaphore down.&n; */
r_int
DECL|function|isdn_net_getphones
id|isdn_net_getphones
c_func
(paren
id|isdn_net_ioctl_phone
op_star
id|phone
comma
r_char
op_star
id|phones
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|isdn_net_findif
c_func
(paren
id|phone-&gt;name
)paren
suffix:semicolon
r_int
id|inout
op_assign
id|phone-&gt;outgoing
op_amp
l_int|1
suffix:semicolon
r_int
id|more
op_assign
l_int|0
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
id|isdn_net_phone
op_star
id|n
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|inout
op_and_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
id|p-&gt;local-&gt;phone
(braket
id|inout
)braket
suffix:semicolon
id|n
suffix:semicolon
id|n
op_assign
id|n-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|more
)paren
(brace
id|put_user
c_func
(paren
l_char|&squot; &squot;
comma
id|phones
op_increment
)paren
suffix:semicolon
id|count
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|phones
comma
id|n-&gt;num
comma
id|strlen
c_func
(paren
id|n-&gt;num
)paren
op_plus
l_int|1
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|phones
op_add_assign
id|strlen
c_func
(paren
id|n-&gt;num
)paren
suffix:semicolon
id|count
op_add_assign
id|strlen
c_func
(paren
id|n-&gt;num
)paren
suffix:semicolon
id|more
op_assign
l_int|1
suffix:semicolon
)brace
id|put_user
c_func
(paren
l_int|0
comma
id|phones
)paren
suffix:semicolon
id|count
op_increment
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/*&n; * Copy a string containing the peer&squot;s phone number of a connected interface&n; * to user space.&n; */
r_int
DECL|function|isdn_net_getpeer
id|isdn_net_getpeer
c_func
(paren
id|isdn_net_ioctl_phone
op_star
id|phone
comma
id|isdn_net_ioctl_phone
op_star
id|peer
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|isdn_net_findif
c_func
(paren
id|phone-&gt;name
)paren
suffix:semicolon
r_int
id|ch
comma
id|dv
comma
id|idx
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/*&n;&t; * Theoretical race: while this executes, the remote number might&n;&t; * become invalid (hang up) or change (new connection), resulting&n;         * in (partially) wrong number copied to user. This race&n;&t; * currently ignored.&n;&t; */
id|ch
op_assign
id|p-&gt;local-&gt;isdn_channel
suffix:semicolon
id|dv
op_assign
id|p-&gt;local-&gt;isdn_device
suffix:semicolon
r_if
c_cond
(paren
id|ch
OL
l_int|0
op_logical_and
id|dv
OL
l_int|0
)paren
(brace
r_return
op_minus
id|ENOTCONN
suffix:semicolon
)brace
id|idx
op_assign
id|isdn_dc2minor
c_func
(paren
id|dv
comma
id|ch
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idx
OL
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* for pre-bound channels, we need this extra check */
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|dev-&gt;num
(braket
id|idx
)braket
comma
l_string|&quot;???&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|ENOTCONN
suffix:semicolon
id|strncpy
c_func
(paren
id|phone-&gt;phone
comma
id|dev-&gt;num
(braket
id|idx
)braket
comma
id|ISDN_MSNLEN
)paren
suffix:semicolon
id|phone-&gt;outgoing
op_assign
id|USG_OUTGOING
c_func
(paren
id|dev-&gt;usage
(braket
id|idx
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|peer
comma
id|phone
comma
r_sizeof
(paren
op_star
id|peer
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Delete a phone-number from an interface.&n; */
r_int
DECL|function|isdn_net_delphone
id|isdn_net_delphone
c_func
(paren
id|isdn_net_ioctl_phone
op_star
id|phone
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|isdn_net_findif
c_func
(paren
id|phone-&gt;name
)paren
suffix:semicolon
r_int
id|inout
op_assign
id|phone-&gt;outgoing
op_amp
l_int|1
suffix:semicolon
id|isdn_net_phone
op_star
id|n
suffix:semicolon
id|isdn_net_phone
op_star
id|m
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|n
op_assign
id|p-&gt;local-&gt;phone
(braket
id|inout
)braket
suffix:semicolon
id|m
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
id|n
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|n-&gt;num
comma
id|phone-&gt;phone
)paren
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;local-&gt;dial
op_eq
id|n
)paren
id|p-&gt;local-&gt;dial
op_assign
id|n-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|m
)paren
id|m-&gt;next
op_assign
id|n-&gt;next
suffix:semicolon
r_else
id|p-&gt;local-&gt;phone
(braket
id|inout
)braket
op_assign
id|n-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|n
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|m
op_assign
id|n
suffix:semicolon
id|n
op_assign
(paren
id|isdn_net_phone
op_star
)paren
id|n-&gt;next
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n; * Delete all phone-numbers of an interface.&n; */
r_static
r_int
DECL|function|isdn_net_rmallphone
id|isdn_net_rmallphone
c_func
(paren
id|isdn_net_dev
op_star
id|p
)paren
(brace
id|isdn_net_phone
op_star
id|n
suffix:semicolon
id|isdn_net_phone
op_star
id|m
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|n
op_assign
id|p-&gt;local-&gt;phone
(braket
id|i
)braket
suffix:semicolon
r_while
c_loop
(paren
id|n
)paren
(brace
id|m
op_assign
id|n-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|n
)paren
suffix:semicolon
id|n
op_assign
id|m
suffix:semicolon
)brace
id|p-&gt;local-&gt;phone
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|p-&gt;local-&gt;dial
op_assign
l_int|NULL
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Force a hangup of a network-interface.&n; */
r_int
DECL|function|isdn_net_force_hangup
id|isdn_net_force_hangup
c_func
(paren
r_char
op_star
id|name
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|isdn_net_findif
c_func
(paren
id|name
)paren
suffix:semicolon
r_struct
id|net_device
op_star
id|q
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;local-&gt;isdn_device
OL
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
id|q
op_assign
id|p-&gt;local-&gt;slave
suffix:semicolon
multiline_comment|/* If this interface has slaves, do a hangup for them also. */
r_while
c_loop
(paren
id|q
)paren
(brace
id|isdn_net_hangup
c_func
(paren
id|q
)paren
suffix:semicolon
id|q
op_assign
(paren
(paren
(paren
id|isdn_net_local
op_star
)paren
id|q-&gt;priv
)paren
op_member_access_from_pointer
id|slave
)paren
suffix:semicolon
)brace
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n; * Helper-function for isdn_net_rm: Do the real work.&n; */
r_static
r_int
DECL|function|isdn_net_realrm
id|isdn_net_realrm
c_func
(paren
id|isdn_net_dev
op_star
id|p
comma
id|isdn_net_dev
op_star
id|q
)paren
(brace
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isdn_net_device_started
c_func
(paren
id|p
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ISDN_X25
r_if
c_cond
(paren
id|p
op_member_access_from_pointer
id|cprot
op_logical_and
id|p
op_member_access_from_pointer
id|cprot
op_member_access_from_pointer
id|pops
)paren
(brace
id|p
op_member_access_from_pointer
id|cprot
op_member_access_from_pointer
id|pops
op_member_access_from_pointer
id|proto_del
(paren
id|p
op_member_access_from_pointer
id|cprot
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Free all phone-entries */
id|isdn_net_rmallphone
c_func
(paren
id|p
)paren
suffix:semicolon
multiline_comment|/* If interface is bound exclusive, free channel-usage */
r_if
c_cond
(paren
id|p-&gt;local-&gt;exclusive
op_ne
op_minus
l_int|1
)paren
id|isdn_unexclusive_channel
c_func
(paren
id|p-&gt;local-&gt;pre_device
comma
id|p-&gt;local-&gt;pre_channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;local-&gt;master
)paren
(brace
multiline_comment|/* It&squot;s a slave-device, so update master&squot;s slave-pointer if necessary */
r_if
c_cond
(paren
(paren
(paren
id|isdn_net_local
op_star
)paren
(paren
id|p-&gt;local-&gt;master-&gt;priv
)paren
)paren
op_member_access_from_pointer
id|slave
op_eq
op_amp
id|p-&gt;dev
)paren
(paren
(paren
id|isdn_net_local
op_star
)paren
(paren
id|p-&gt;local-&gt;master-&gt;priv
)paren
)paren
op_member_access_from_pointer
id|slave
op_assign
id|p-&gt;local-&gt;slave
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Unregister only if it&squot;s a master-device */
id|p-&gt;dev.hard_header_cache
op_assign
id|p-&gt;local-&gt;org_hhc
suffix:semicolon
id|p-&gt;dev.header_cache_update
op_assign
id|p-&gt;local-&gt;org_hcu
suffix:semicolon
id|unregister_netdev
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Unlink device from chain */
r_if
c_cond
(paren
id|q
)paren
id|q-&gt;next
op_assign
id|p-&gt;next
suffix:semicolon
r_else
id|dev-&gt;netdev
op_assign
id|p-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;local-&gt;slave
)paren
(brace
multiline_comment|/* If this interface has a slave, remove it also */
r_char
op_star
id|slavename
op_assign
(paren
(paren
id|isdn_net_local
op_star
)paren
(paren
id|p-&gt;local-&gt;slave-&gt;priv
)paren
)paren
op_member_access_from_pointer
id|name
suffix:semicolon
id|isdn_net_dev
op_star
id|n
op_assign
id|dev-&gt;netdev
suffix:semicolon
id|q
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
id|n
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|n-&gt;local-&gt;name
comma
id|slavename
)paren
)paren
(brace
id|isdn_net_realrm
c_func
(paren
id|n
comma
id|q
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|q
op_assign
id|n
suffix:semicolon
id|n
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|n-&gt;next
suffix:semicolon
)brace
)brace
multiline_comment|/* If no more net-devices remain, disable auto-hangup timer */
r_if
c_cond
(paren
id|dev-&gt;netdev
op_eq
l_int|NULL
)paren
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_NETHANGUP
comma
l_int|0
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|p-&gt;local
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|p
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Remove a single network-interface.&n; */
r_int
DECL|function|isdn_net_rm
id|isdn_net_rm
c_func
(paren
r_char
op_star
id|name
)paren
(brace
id|isdn_net_dev
op_star
id|p
suffix:semicolon
id|isdn_net_dev
op_star
id|q
suffix:semicolon
multiline_comment|/* Search name in netdev-chain */
id|p
op_assign
id|dev-&gt;netdev
suffix:semicolon
id|q
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|p-&gt;local-&gt;name
comma
id|name
)paren
)paren
r_return
(paren
id|isdn_net_realrm
c_func
(paren
id|p
comma
id|q
)paren
)paren
suffix:semicolon
id|q
op_assign
id|p
suffix:semicolon
id|p
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|p-&gt;next
suffix:semicolon
)brace
multiline_comment|/* If no more net-devices remain, disable auto-hangup timer */
r_if
c_cond
(paren
id|dev-&gt;netdev
op_eq
l_int|NULL
)paren
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_NETHANGUP
comma
l_int|0
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n; * Remove all network-interfaces&n; */
r_int
DECL|function|isdn_net_rmall
id|isdn_net_rmall
c_func
(paren
r_void
)paren
(brace
r_int
id|flags
suffix:semicolon
r_int
id|ret
suffix:semicolon
multiline_comment|/* Walk through netdev-chain */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|dev-&gt;netdev
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;netdev-&gt;local-&gt;master
)paren
(brace
multiline_comment|/* Remove master-devices only, slaves get removed with their master */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|isdn_net_realrm
c_func
(paren
id|dev-&gt;netdev
comma
l_int|NULL
)paren
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
)brace
)brace
id|dev-&gt;netdev
op_assign
l_int|NULL
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
