multiline_comment|/* $Id: isdn_net.c,v 1.84 1999/04/18 14:06:55 fritz Exp $&n;&n; * Linux ISDN subsystem, network interfaces and related functions (linklevel).&n; *&n; * Copyright 1994-1998  by Fritz Elfert (fritz@isdn4linux.de)&n; * Copyright 1995,96    by Thinking Objects Software GmbH Wuerzburg&n; * Copyright 1995,96    by Michael Hipp (Michael.Hipp@student.uni-tuebingen.de)&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; * $Log: isdn_net.c,v $&n; * Revision 1.84  1999/04/18 14:06:55  fritz&n; * Removed TIMRU stuff.&n; *&n; * Revision 1.83  1999/04/12 12:33:23  fritz&n; * Changes from 2.0 tree.&n; *&n; * Revision 1.82  1999/01/17 00:55:58  he&n; * added mark_bh in BCONN statcallb and cleaned up some dead code&n; *&n; * Revision 1.81  1999/01/15 16:36:52  he&n; * replaced icmp_send() by dst_link_failure()&n; *&n; * Revision 1.80  1998/12/01 13:06:22  paul&n; * Also huptimeout with dialmode == manual&n; *&n; * Revision 1.79  1998/10/30 17:55:27  he&n; * dialmode for x25iface and multulink ppp&n; *&n; * Revision 1.78  1998/10/26 18:20:46  he&n; * re-inserted p=p-&gt;next in isdn_net_find_icall() (fixes kernel lock up&n; * on incoming call not matching the first interface)&n; *&n; * Revision 1.77  1998/10/23 10:18:44  paul&n; * Implementation of &quot;dialmode&quot; (successor of &quot;status&quot;)&n; * You also need current isdnctrl for this!&n; *&n; * Revision 1.76  1998/09/07 22:00:05  he&n; * flush method for 2.1.118 and above&n; * updated IIOCTLNETGPN&n; *&n; * Revision 1.75  1998/08/31 21:09:50  he&n; * new ioctl IIOCNETGPN for /dev/isdninfo (get network interface&squot;&n; *     peer phone number)&n; *&n; * Revision 1.74  1998/07/30 11:28:32  paul&n; * printk message only appeared when status is off and interface is rawIP,&n; * which is confusing for people who don&squot;t know about &quot;isdnctrl status &lt;if&gt; on&quot;.&n; *&n; * Revision 1.73  1998/06/26 22:01:37  keil&n; * tx_queue_len = 5 was too small&n; *&n; * Revision 1.72  1998/06/26 15:12:31  fritz&n; * Added handling of STAT_ICALL with incomplete CPN.&n; * Added AT&amp;L for ttyI emulator.&n; * Added more locking stuff in tty_write.&n; *&n; * Revision 1.71  1998/06/18 22:43:08  fritz&n; * Bugfix: Setting ndev-&gt;do_ioctl had beed accidetly removed at abc-cleanup.&n; *&n; * Revision 1.70  1998/06/17 19:50:49  he&n; * merged with 2.1.10[34] (cosmetics and udelay() -&gt; mdelay())&n; * brute force fix to avoid Ugh&squot;s in isdn_tty_write()&n; * cleaned up some dead code&n; *&n; * Revision 1.69  1998/06/09 12:27:37  cal&n; * Changed default of local netdev flags: ISDN_NET_STOPPED is default now,&n; * so autodial is suppressed for that device until it is switched on using&n; * &squot;isdnctrl status dev-name on&squot;.&n; *&n; * Revision 1.68  1998/06/07 00:20:05  fritz&n; * abc cleanup.&n; *&n; * Revision 1.67  1998/06/02 12:10:08  detabc&n; * wegen einer einstweiliger verfuegung gegen DW ist zur zeit&n; * die abc-extension bis zur klaerung der rechtslage nicht verfuegbar&n; *&n; * Revision 1.66  1998/05/26 22:39:24  he&n; * sync&squot;ed with 2.1.102 where appropriate (CAPABILITY changes)&n; * concap typo&n; * cleared dev.tbusy in isdn_net BCONN status callback&n; *&n; * Revision 1.65  1998/05/22 10:01:11  detabc&n; * in case of a icmp-unreach condition the tcp-keepalive-entrys&n; * will be dropped from the internal double-link-list (only abc-extension).&n; * send icmp unreach only if the skb-&gt;protocol == ETH_P_IP&n; * speedup abc-no-dchan  redial&n; *&n; * Revision 1.64  1998/05/07 19:58:39  detabc&n; * bugfix in abc_delayed_hangup&n; * optimize keepalive-tests for abc_rawip&n; *&n; * Revision 1.63  1998/05/05 23:23:36  detabc&n; * change ICMP_HOST_UNREACH to ICMP_NET_UNREACH (only abc-ext.)&n; * set dev-&gt;tbusy to zero in isdn_net_unreachable() (only abc-ext.)&n; * drop all new packets and send ICMP_NET_UNREACH for&n; * min. dialwait to max. dialwait * 6 time. (only abc-ext.)&n; * change random-deliver of packets (small first) from all emcapsulation&n; * to only rawip with ABC-Router-Flag enabled.&n; *&n; * Revision 1.62  1998/05/03 17:40:42  detabc&n; * Include abc-extension-support for &gt;= 2.1.x Kernels in&n; * isdn_net.c and isdn_common.c. alpha-test OK and running !&n; *&n; * Revision 1.61  1998/04/16 19:19:42  keil&n; * Fix from vger (tx max qlength)&n; *&n; * Revision 1.60  1998/04/14 16:28:49  he&n; * Fixed user space access with interrupts off and remaining&n; * copy_{to,from}_user() -&gt; -EFAULT return codes&n; *&n; * Revision 1.59  1998/03/07 22:37:33  fritz&n; * Bugfix: restore_flags missing.&n; *&n; * Revision 1.58  1998/03/07 18:21:05  cal&n; * Dynamic Timeout-Rule-Handling vs. 971110 included&n; *&n; * Revision 1.57  1998/02/25 18:31:13  fritz&n; * Added debugging output in adjust_header.&n; *&n; * Revision 1.56  1998/02/25 17:49:42  he&n; * Changed return codes caused be failing copy_{to,from}_user to -EFAULT&n; *&n; * Revision 1.55  1998/02/23 19:38:22  fritz&n; * Corrected check for modified feature-flags.&n; *&n; * Revision 1.54  1998/02/20 17:15:07  fritz&n; * Changes for recent kernels.&n; * Ugly workaround for adjusting Ethernet frames with recent kernels.&n; * replaced direct calls to lowlevel-driver command by common hook.&n; *&n; * Revision 1.53  1998/01/31 22:05:54  keil&n; * Lots of changes for X.25 support:&n; * Added generic support for connection-controlling encapsulation protocols&n; * Added support of BHUP status message&n; * Added support for additional p_encap X25IFACE&n; * Added support for kernels &gt;= 2.1.72&n; *&n; * Revision 1.52  1998/01/31 19:29:51  calle&n; * Merged changes from and for 2.1.82, not tested only compiled ...&n; *&n; * Revision 1.51  1997/10/09 21:28:50  fritz&n; * New HL&lt;-&gt;LL interface:&n; *   New BSENT callback with nr. of bytes included.&n; *   Sending without ACK.&n; *   New L1 error status (not yet in use).&n; *   Cleaned up obsolete structures.&n; * Implemented Cisco-SLARP.&n; * Changed local net-interface data to be dynamically allocated.&n; * Removed old 2.0 compatibility stuff.&n; *&n; * Revision 1.50  1997/10/01 09:20:32  fritz&n; * Removed old compatibility stuff for 2.0.X kernels.&n; * From now on, this code is for 2.1.X ONLY!&n; * Old stuff is still in the separate branch.&n; *&n; * Revision 1.49  1997/08/21 14:38:13  fritz&n; * Bugfix: Did not compile without SyncPPP.&n; *&n; * Revision 1.48  1997/06/22 11:57:15  fritz&n; * Added ability to adjust slave triggerlevel.&n; *&n; * Revision 1.47  1997/06/21 10:52:05  fritz&n; * Removed wrong SET_SKB_FREE in isdn_net_send_skb()&n; *&n; * Revision 1.46  1997/06/17 13:05:24  hipp&n; * Applied Eric&squot;s underflow-patches (slightly modified)&n; *&n; * Revision 1.45  1997/06/10 16:24:22  hipp&n; * hard_header changes for syncPPP (now behaves like RAWIP)&n; *&n; * Revision 1.44  1997/05/27 15:17:26  fritz&n; * Added changes for recent 2.1.x kernels:&n; *   changed return type of isdn_close&n; *   queue_task_* -&gt; queue_task&n; *   clear/set_bit -&gt; test_and_... where apropriate.&n; *   changed type of hard_header_cache parameter.&n; *&n; * Revision 1.43  1997/03/30 16:51:13  calle&n; * changed calls to copy_from_user/copy_to_user and removed verify_area&n; * were possible.&n; *&n; * Revision 1.42  1997/03/11 08:43:51  fritz&n; * Perform a hangup if number is deleted while dialing.&n; *&n; * Revision 1.41  1997/03/08 08:16:31  fritz&n; * Bugfix: Deleting a phone number during dial gave unpredictable results.&n; *&n; * Revision 1.40  1997/03/05 21:16:08  fritz&n; * Fix: did not compile with 2.1.27&n; *&n; * Revision 1.39  1997/03/04 21:36:52  fritz&n; * Added sending ICMP messages when no connetion is possible.&n; *&n; * Revision 1.38  1997/02/23 23:41:14  fritz&n; * Bugfix: Slave interfaces have to be hung up before master.&n; *&n; * Revision 1.37  1997/02/11 18:32:51  fritz&n; * Bugfix in isdn_ppp_free_mpqueue().&n; *&n; * Revision 1.36  1997/02/10 21:31:11  fritz&n; * Changed setup-interface (incoming and outgoing).&n; *&n; * Revision 1.35  1997/02/10 20:12:45  fritz&n; * Changed interface for reporting incoming calls.&n; *&n; * Revision 1.34  1997/02/03 23:15:07  fritz&n; * Reformatted according CodingStyle.&n; * replaced arp_find prototype by proper include.&n; * made dev_purge_queues static.&n; * Bugfix in bogocps calculation.&n; * removed isdn_net_receive_callback - was never used ;-)&n; * Misc. fixes for Kernel 2.1.X comaptibility.&n; *&n; * Revision 1.33  1997/01/17 01:19:25  fritz&n; * Applied chargeint patch.&n; *&n; * Revision 1.32  1997/01/14 01:29:31  fritz&n; * Bugfix: isdn_net_hangup() did not reset ISDN_NET_CONNECTED.&n; *&n; * Revision 1.31  1997/01/11 23:30:42  fritz&n; * Speed up dial statemachine.&n; *&n; * Revision 1.30  1996/11/25 17:20:50  hipp&n; * fixed pppbind bug in isdn_net_find_icall()&n; *&n; * Revision 1.29  1996/11/13 02:31:38  fritz&n; * Minor cleanup.&n; *&n; * Revision 1.28  1996/10/27 20:49:06  keil&n; * bugfix to compile without MPP&n; *&n; * Revision 1.27  1996/10/25 18:46:01  fritz&n; * Another bugfix in isdn_net_autohup()&n; *&n; * Revision 1.26  1996/10/23 23:05:36  fritz&n; * Bugfix: Divide by zero in isdn_net_autohup()&n; *&n; * Revision 1.25  1996/10/22 23:13:58  fritz&n; * Changes for compatibility to 2.0.X and 2.1.X kernels.&n; *&n; * Revision 1.24  1996/10/11 13:57:40  fritz&n; * Bugfix: Error in BogoCPS calculation.&n; *&n; * Revision 1.23  1996/09/23 01:58:08  fritz&n; * Fix: With syncPPP encapsulation, discard LCP packets&n; *      when calculating hangup timeout.&n; *&n; * Revision 1.22  1996/09/23 00:03:37  fritz&n; * Fix: did not compile without CONFIG_ISDN_PPP&n; *&n; * Revision 1.21  1996/09/07 12:44:50  hipp&n; * (hopefully) fixed callback problem with syncPPP&n; * syncPPP network devices now show PPP link encap&n; *&n; * Revision 1.20  1996/08/29 20:06:03  fritz&n; * Bugfix: Transmission timeout had been much to low.&n; *&n; * Revision 1.19  1996/08/12 16:24:32  hipp&n; * removed some (now) obsolete functions for syncPPP in rebuild_header etc.&n; *&n; * Revision 1.18  1996/07/03 13:48:51  hipp&n; * bugfix: Call dev_purge_queues() only for master device&n; *&n; * Revision 1.17  1996/06/25 18:37:37  fritz&n; * Fixed return count for empty return string in isdn_net_getphones().&n; *&n; * Revision 1.16  1996/06/24 17:48:08  fritz&n; * Bugfixes:&n; *   - Did not free channel on unbinding.&n; *   - ioctl returned wrong callback settings.&n; *&n; * Revision 1.15  1996/06/16 17:42:54  tsbogend&n; * fixed problem with IP addresses on Linux/Alpha (long is 8 byte there)&n; *&n; * Revision 1.14  1996/06/11 14:54:08  hipp&n; * minor bugfix in isdn_net_send_skb&n; * changes in BSENT callback handler for syncPPP&n; * added lp-&gt;sav_skb stuff&n; *&n; * Revision 1.13  1996/06/06 14:25:44  fritz&n; * Changed loglevel of &quot;incoming ... without OAD&quot; message, since&n; * with audio support this is quite normal.&n; *&n; * Revision 1.12  1996/06/05 02:36:45  fritz&n; * Minor bugfixes by M. Hipp.&n; *&n; * Revision 1.11  1996/05/18 01:36:59  fritz&n; * Added spelling corrections and some minor changes&n; * to stay in sync with kernel.&n; *&n; * Revision 1.10  1996/05/17 03:49:01  fritz&n; * Some cleanup.&n; *&n; * Revision 1.9  1996/05/06 11:34:57  hipp&n; * fixed a few bugs&n; *&n; * Revision 1.8  1996/04/30 21:04:40  fritz&n; * Test commit&n; *&n; * Revision 1.7  1996/04/30 11:10:42  fritz&n; * Added Michael&squot;s ippp-bind patch.&n; *&n; * Revision 1.6  1996/04/30 09:34:35  fritz&n; * Removed compatibility-macros.&n; *&n; * Revision 1.5  1996/04/20 16:28:38  fritz&n; * Made more parameters of the dial statemachine user-configurable and&n; * added hangup after dial for more reliability using callback.&n; * Changed all io going through generic routines in isdn_common.c&n; * Added missing call to dev_free_skb on failed dialing.&n; * Added uihdlc encapsulation.&n; * Fixed isdn_net_setcfg not to destroy interface-flags anymore.&n; * Misc. typos.&n; *&n; * Revision 1.4  1996/02/19 15:23:38  fritz&n; * Bugfix: Sync-PPP packets got compressed twice, when resent due to&n; *         send-queue-full reject.&n; *&n; * Revision 1.3  1996/02/11 02:22:28  fritz&n; * Changed status- receive-callbacks to use pointer-arrays for finding&n; * a corresponding interface instead of looping over all interfaces.&n; * Activate Auto-hangup-timer only when interface is online.&n; * Some bugfixes in the dialing-statemachine.&n; * Lot of bugfixes in sk_buff&squot;ized encapsulation handling.&n; * For speedup connection-setup after dialing, remember sk_buf that triggered&n; * dialing.&n; * Fixed isdn_net_log_packet according to different encapsulations.&n; * Correct ARP-handling for ETHERNET-encapsulation.&n; *&n; * Revision 1.2  1996/01/22 05:05:12  fritz&n; * Changed returncode-logic for isdn_net_start_xmit() and its&n; * helper-functions.&n; * Changed handling of buildheader for RAWIP and ETHERNET-encapsulation.&n; *&n; * Revision 1.1  1996/01/09 04:12:34  fritz&n; * Initial revision&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/isdn.h&gt;
macro_line|#include &lt;net/arp.h&gt;
macro_line|#include &lt;net/dst.h&gt;
macro_line|#include &lt;net/pkt_sched.h&gt;
macro_line|#include &lt;linux/inetdevice.h&gt;
macro_line|#include &quot;isdn_common.h&quot;
macro_line|#include &quot;isdn_net.h&quot;
macro_line|#ifdef CONFIG_ISDN_PPP
macro_line|#include &quot;isdn_ppp.h&quot;
macro_line|#endif
macro_line|#ifdef CONFIG_ISDN_X25
macro_line|#include &lt;linux/concap.h&gt;
macro_line|#include &quot;isdn_concap.h&quot;
macro_line|#endif
multiline_comment|/* Prototypes */
r_int
id|isdn_net_force_dial_lp
c_func
(paren
id|isdn_net_local
op_star
)paren
suffix:semicolon
r_static
r_int
id|isdn_net_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
comma
r_struct
id|device
op_star
)paren
suffix:semicolon
r_static
r_int
id|isdn_net_xmit
c_func
(paren
r_struct
id|device
op_star
comma
id|isdn_net_local
op_star
comma
r_struct
id|sk_buff
op_star
)paren
suffix:semicolon
DECL|variable|isdn_net_revision
r_char
op_star
id|isdn_net_revision
op_assign
l_string|&quot;$Revision: 1.84 $&quot;
suffix:semicolon
multiline_comment|/*&n;  * Code for raw-networking over ISDN&n;  */
r_static
r_void
DECL|function|isdn_net_unreachable
id|isdn_net_unreachable
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_char
op_star
id|reason
)paren
(brace
r_if
c_cond
(paren
id|skb
)paren
(brace
id|u_short
id|proto
op_assign
id|ntohs
c_func
(paren
id|skb-&gt;protocol
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_net: %s: %s, signalling dst_link_failure %s&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
id|reason
op_ne
l_int|NULL
)paren
ques
c_cond
id|reason
suffix:colon
l_string|&quot;unknown&quot;
comma
(paren
id|proto
op_ne
id|ETH_P_IP
)paren
ques
c_cond
l_string|&quot;Protocol != ETH_P_IP&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|dst_link_failure
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* dial not triggered by rawIP packet */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_net: %s: %s&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
id|reason
op_ne
l_int|NULL
)paren
ques
c_cond
id|reason
suffix:colon
l_string|&quot;reason unknown&quot;
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|isdn_net_reset
id|isdn_net_reset
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
macro_line|#ifdef CONFIG_ISDN_X25
r_struct
id|concap_device_ops
op_star
id|dops
op_assign
(paren
(paren
id|isdn_net_local
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|dops
suffix:semicolon
r_struct
id|concap_proto
op_star
id|cprot
op_assign
(paren
(paren
id|isdn_net_local
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|netdev
op_member_access_from_pointer
id|cprot
suffix:semicolon
macro_line|#endif
id|ulong
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Avoid glitch on writes to CMD regs */
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_X25
r_if
c_cond
(paren
id|cprot
op_logical_and
id|cprot
op_member_access_from_pointer
id|pops
op_logical_and
id|dops
)paren
(brace
id|cprot
op_member_access_from_pointer
id|pops
op_member_access_from_pointer
id|restart
(paren
id|cprot
comma
id|dev
comma
id|dops
)paren
suffix:semicolon
)brace
macro_line|#endif
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Open/initialize the board. */
r_static
r_int
DECL|function|isdn_net_open
id|isdn_net_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|device
op_star
id|p
suffix:semicolon
r_struct
id|in_device
op_star
id|in_dev
suffix:semicolon
id|isdn_net_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Fill in the MAC-level header (not needed, but for compatibility... */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ETH_ALEN
op_minus
r_sizeof
(paren
id|u32
)paren
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
l_int|0xfc
suffix:semicolon
r_if
c_cond
(paren
(paren
id|in_dev
op_assign
id|dev-&gt;ip_ptr
)paren
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/*&n;&t;&t; *      Any address will do - we take the first&n;&t;&t; */
r_struct
id|in_ifaddr
op_star
id|ifa
op_assign
id|in_dev-&gt;ifa_list
suffix:semicolon
r_if
c_cond
(paren
id|ifa
op_ne
l_int|NULL
)paren
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
op_plus
l_int|2
comma
op_amp
id|ifa-&gt;ifa_local
comma
l_int|4
)paren
suffix:semicolon
)brace
multiline_comment|/* If this interface has slaves, start them also */
r_if
c_cond
(paren
(paren
id|p
op_assign
(paren
(paren
(paren
id|isdn_net_local
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|slave
)paren
)paren
)paren
(brace
r_while
c_loop
(paren
id|p
)paren
(brace
id|isdn_net_reset
c_func
(paren
id|p
)paren
suffix:semicolon
id|p-&gt;start
op_assign
l_int|1
suffix:semicolon
id|p
op_assign
(paren
(paren
(paren
id|isdn_net_local
op_star
)paren
id|p-&gt;priv
)paren
op_member_access_from_pointer
id|slave
)paren
suffix:semicolon
)brace
)brace
id|isdn_MOD_INC_USE_COUNT
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Assign an ISDN-channel to a net-interface&n; */
r_static
r_void
DECL|function|isdn_net_bind_channel
id|isdn_net_bind_channel
c_func
(paren
id|isdn_net_local
op_star
id|lp
comma
r_int
id|idx
)paren
(brace
id|ulong
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|lp-&gt;flags
op_or_assign
id|ISDN_NET_CONNECTED
suffix:semicolon
id|lp-&gt;isdn_device
op_assign
id|dev-&gt;drvmap
(braket
id|idx
)braket
suffix:semicolon
id|lp-&gt;isdn_channel
op_assign
id|dev-&gt;chanmap
(braket
id|idx
)braket
suffix:semicolon
id|dev-&gt;rx_netdev
(braket
id|idx
)braket
op_assign
id|lp-&gt;netdev
suffix:semicolon
id|dev-&gt;st_netdev
(braket
id|idx
)braket
op_assign
id|lp-&gt;netdev
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * unbind a net-interface (resets interface after an error)&n; */
r_static
r_void
DECL|function|isdn_net_unbind_channel
id|isdn_net_unbind_channel
c_func
(paren
id|isdn_net_local
op_star
id|lp
)paren
(brace
id|ulong
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;first_skb
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|lp-&gt;first_skb
)paren
suffix:semicolon
id|lp-&gt;first_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;sav_skb
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|lp-&gt;sav_skb
)paren
suffix:semicolon
id|lp-&gt;sav_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;master
)paren
(brace
multiline_comment|/* reset only master device */
multiline_comment|/* Moral equivalent of dev_purge_queues():&n;&t;&t;   BEWARE! This chunk of code cannot be called from hardware&n;&t;&t;   interrupt handler. I hope it is true. --ANK&n;&t;&t; */
id|qdisc_reset
c_func
(paren
id|lp-&gt;netdev-&gt;dev.qdisc
)paren
suffix:semicolon
)brace
id|lp-&gt;dialstate
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;rx_netdev
(braket
id|isdn_dc2minor
c_func
(paren
id|lp-&gt;isdn_device
comma
id|lp-&gt;isdn_channel
)paren
)braket
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;st_netdev
(braket
id|isdn_dc2minor
c_func
(paren
id|lp-&gt;isdn_device
comma
id|lp-&gt;isdn_channel
)paren
)braket
op_assign
l_int|NULL
suffix:semicolon
id|isdn_free_channel
c_func
(paren
id|lp-&gt;isdn_device
comma
id|lp-&gt;isdn_channel
comma
id|ISDN_USAGE_NET
)paren
suffix:semicolon
id|lp-&gt;flags
op_and_assign
op_complement
id|ISDN_NET_CONNECTED
suffix:semicolon
id|lp-&gt;isdn_device
op_assign
op_minus
l_int|1
suffix:semicolon
id|lp-&gt;isdn_channel
op_assign
op_minus
l_int|1
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Perform auto-hangup and cps-calculation for net-interfaces.&n; *&n; * auto-hangup:&n; * Increment idle-counter (this counter is reset on any incoming or&n; * outgoing packet), if counter exceeds configured limit either do a&n; * hangup immediately or - if configured - wait until just before the next&n; * charge-info.&n; *&n; * cps-calculation (needed for dynamic channel-bundling):&n; * Since this function is called every second, simply reset the&n; * byte-counter of the interface after copying it to the cps-variable.&n; */
DECL|variable|last_jiffies
r_int
r_int
id|last_jiffies
op_assign
op_minus
id|HZ
suffix:semicolon
r_void
DECL|function|isdn_net_autohup
id|isdn_net_autohup
c_func
(paren
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|dev-&gt;netdev
suffix:semicolon
r_int
id|anymore
suffix:semicolon
id|anymore
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
id|isdn_net_local
op_star
id|l
op_assign
id|p-&gt;local
suffix:semicolon
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|last_jiffies
)paren
op_eq
l_int|0
)paren
id|l-&gt;cps
op_assign
id|l-&gt;transcount
suffix:semicolon
r_else
id|l-&gt;cps
op_assign
(paren
id|l-&gt;transcount
op_star
id|HZ
)paren
op_div
(paren
id|jiffies
op_minus
id|last_jiffies
)paren
suffix:semicolon
id|l-&gt;transcount
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;net_verbose
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: %d bogocps&bslash;n&quot;
comma
id|l-&gt;name
comma
id|l-&gt;cps
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|l-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
op_logical_and
(paren
op_logical_neg
id|l-&gt;dialstate
)paren
)paren
(brace
id|anymore
op_assign
l_int|1
suffix:semicolon
id|l-&gt;huptimer
op_increment
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * if there is some dialmode where timeout-hangup&n;&t;&t;&t; * should _not_ be done, check for that here&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|l-&gt;onhtime
)paren
op_logical_and
(paren
id|l-&gt;huptimer
OG
id|l-&gt;onhtime
)paren
)paren
(brace
r_if
c_cond
(paren
id|l-&gt;hupflags
op_amp
id|ISDN_MANCHARGE
op_logical_and
id|l-&gt;hupflags
op_amp
id|ISDN_CHARGEHUP
)paren
(brace
r_while
c_loop
(paren
id|jiffies
op_minus
id|l-&gt;chargetime
OG
id|l-&gt;chargeint
)paren
id|l-&gt;chargetime
op_add_assign
id|l-&gt;chargeint
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_minus
id|l-&gt;chargetime
op_ge
id|l-&gt;chargeint
op_minus
l_int|2
op_star
id|HZ
)paren
r_if
c_cond
(paren
id|l-&gt;outgoing
op_logical_or
id|l-&gt;hupflags
op_amp
id|ISDN_INHUP
)paren
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|l-&gt;outgoing
)paren
(brace
r_if
c_cond
(paren
id|l-&gt;hupflags
op_amp
id|ISDN_CHARGEHUP
)paren
(brace
r_if
c_cond
(paren
id|l-&gt;hupflags
op_amp
id|ISDN_WAITCHARGE
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_net: Hupflags of %s are %X&bslash;n&quot;
comma
id|l-&gt;name
comma
id|l-&gt;hupflags
)paren
suffix:semicolon
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|jiffies
op_minus
id|l-&gt;chargetime
OG
id|l-&gt;chargeint
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_net: %s: chtime = %d, chint = %d&bslash;n&quot;
comma
id|l-&gt;name
comma
id|l-&gt;chargetime
comma
id|l-&gt;chargeint
)paren
suffix:semicolon
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
)brace
)brace
r_else
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|l-&gt;hupflags
op_amp
id|ISDN_INHUP
)paren
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;global_flags
op_amp
id|ISDN_GLOBAL_STOPPED
op_logical_or
(paren
id|ISDN_NET_DIALMODE
c_func
(paren
op_star
id|l
)paren
op_eq
id|ISDN_NET_DM_OFF
)paren
)paren
(brace
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|p
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|p-&gt;next
suffix:semicolon
)brace
id|last_jiffies
op_assign
id|jiffies
suffix:semicolon
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_NETHANGUP
comma
id|anymore
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Handle status-messages from ISDN-interfacecard.&n; * This function is called from within the main-status-dispatcher&n; * isdn_status_callback, which itself is called from the low-level driver.&n; * Return: 1 = Event handled, 0 = not for us or unknown Event.&n; */
r_int
DECL|function|isdn_net_stat_callback
id|isdn_net_stat_callback
c_func
(paren
r_int
id|idx
comma
id|isdn_ctrl
op_star
id|c
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|dev-&gt;st_netdev
(braket
id|idx
)braket
suffix:semicolon
r_int
id|cmd
op_assign
id|c-&gt;command
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
id|p-&gt;local
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_X25
r_struct
id|concap_proto
op_star
id|cprot
op_assign
id|lp
op_member_access_from_pointer
id|netdev
op_member_access_from_pointer
id|cprot
suffix:semicolon
r_struct
id|concap_proto_ops
op_star
id|pops
op_assign
id|cprot
ques
c_cond
id|cprot
op_member_access_from_pointer
id|pops
suffix:colon
l_int|0
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|ISDN_STAT_BSENT
suffix:colon
multiline_comment|/* A packet has successfully been sent out */
r_if
c_cond
(paren
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
op_logical_and
(paren
op_logical_neg
id|lp-&gt;dialstate
)paren
)paren
(brace
id|lp-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|lp-&gt;stats.tx_bytes
op_add_assign
id|c-&gt;parm.length
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_SYNCPPP
op_logical_and
id|lp-&gt;sav_skb
)paren
(brace
r_struct
id|device
op_star
id|mdev
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;master
)paren
id|mdev
op_assign
id|lp-&gt;master
suffix:semicolon
r_else
id|mdev
op_assign
op_amp
id|lp-&gt;netdev-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|isdn_net_send_skb
c_func
(paren
id|mdev
comma
id|lp
comma
id|lp-&gt;sav_skb
)paren
)paren
(brace
id|lp-&gt;sav_skb
op_assign
l_int|NULL
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
r_else
(brace
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
(paren
id|p-&gt;dev.tbusy
)paren
)paren
)paren
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
r_case
id|ISDN_STAT_DCONN
suffix:colon
multiline_comment|/* D-Channel is up */
r_switch
c_cond
(paren
id|lp-&gt;dialstate
)paren
(brace
r_case
l_int|4
suffix:colon
r_case
l_int|7
suffix:colon
r_case
l_int|8
suffix:colon
id|lp-&gt;dialstate
op_increment
suffix:semicolon
r_return
l_int|1
suffix:semicolon
r_case
l_int|12
suffix:colon
id|lp-&gt;dialstate
op_assign
l_int|5
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_STAT_DHUP
suffix:colon
multiline_comment|/* Either D-Channel-hangup or error during dialout */
macro_line|#ifdef CONFIG_ISDN_X25
multiline_comment|/* If we are not connencted then dialing had&n;&t;&t;&t;&t;   failed. If there are generic encap protocol&n;&t;&t;&t;&t;   receiver routines signal the closure of&n;&t;&t;&t;&t;   the link*/
r_if
c_cond
(paren
op_logical_neg
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
op_logical_and
id|pops
op_logical_and
id|pops
op_member_access_from_pointer
id|disconn_ind
)paren
(brace
id|pops
op_member_access_from_pointer
id|disconn_ind
c_func
(paren
id|cprot
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ISDN_X25 */
r_if
c_cond
(paren
(paren
op_logical_neg
id|lp-&gt;dialstate
)paren
op_logical_and
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
)paren
(brace
macro_line|#ifdef CONFIG_ISDN_PPP
id|isdn_ppp_free
c_func
(paren
id|lp
)paren
suffix:semicolon
macro_line|#endif
id|isdn_all_eaz
c_func
(paren
id|lp-&gt;isdn_device
comma
id|lp-&gt;isdn_channel
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: remote hangup&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Chargesum is %d&bslash;n&quot;
comma
id|lp-&gt;name
comma
id|lp-&gt;charge
)paren
suffix:semicolon
id|isdn_net_unbind_channel
c_func
(paren
id|lp
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_X25
r_case
id|ISDN_STAT_BHUP
suffix:colon
multiline_comment|/* B-Channel-hangup */
multiline_comment|/* try if there are generic encap protocol&n;&t;&t;&t;&t;   receiver routines and signal the closure of&n;&t;&t;&t;&t;   the link */
r_if
c_cond
(paren
id|pops
op_logical_and
id|pops
op_member_access_from_pointer
id|disconn_ind
)paren
(brace
id|pops
op_member_access_from_pointer
id|disconn_ind
c_func
(paren
id|cprot
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_X25 */
r_case
id|ISDN_STAT_BCONN
suffix:colon
multiline_comment|/* B-Channel is up */
r_switch
c_cond
(paren
id|lp-&gt;dialstate
)paren
(brace
r_case
l_int|5
suffix:colon
r_case
l_int|6
suffix:colon
r_case
l_int|7
suffix:colon
r_case
l_int|8
suffix:colon
r_case
l_int|9
suffix:colon
r_case
l_int|10
suffix:colon
r_case
l_int|12
suffix:colon
r_if
c_cond
(paren
id|lp-&gt;dialstate
op_le
l_int|6
)paren
(brace
id|dev-&gt;usage
(braket
id|idx
)braket
op_or_assign
id|ISDN_USAGE_OUTGOING
suffix:semicolon
id|isdn_info_update
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
id|dev-&gt;rx_netdev
(braket
id|idx
)braket
op_assign
id|p
suffix:semicolon
id|lp-&gt;dialstate
op_assign
l_int|0
suffix:semicolon
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_NETHANGUP
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_CISCOHDLCK
)paren
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_KEEPALIVE
comma
l_int|1
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdn_net: %s connected&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
multiline_comment|/* If first Chargeinfo comes before B-Channel connect,&n;&t;&t;&t;&t;&t;&t; * we correct the timestamp here.&n;&t;&t;&t;&t;&t;&t; */
id|lp-&gt;chargetime
op_assign
id|jiffies
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_net: chargetime of %s now %d&bslash;n&quot;
comma
id|lp-&gt;name
comma
id|lp-&gt;chargetime
)paren
suffix:semicolon
multiline_comment|/* reset dial-timeout */
id|lp-&gt;dialstarted
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;dialwait_timer
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Immediately send first skb to speed up arp */
macro_line|#ifdef CONFIG_ISDN_PPP
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_SYNCPPP
)paren
id|isdn_ppp_wakeup_daemon
c_func
(paren
id|lp
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ISDN_X25
multiline_comment|/* try if there are generic concap receiver routines */
r_if
c_cond
(paren
id|pops
)paren
r_if
c_cond
(paren
id|pops-&gt;connect_ind
)paren
(brace
id|pops
op_member_access_from_pointer
id|connect_ind
c_func
(paren
id|cprot
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ISDN_X25 */
r_if
c_cond
(paren
id|lp-&gt;first_skb
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|isdn_net_xmit
c_func
(paren
op_amp
id|p-&gt;dev
comma
id|lp
comma
id|lp-&gt;first_skb
)paren
)paren
)paren
id|lp-&gt;first_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t;&t; * dev.tbusy is usually cleared implicitly by isdn_net_xmit(,,lp-&gt;first_skb).&n;&t;&t;&t;&t;&t;&t;&t; * With an empty lp-&gt;first_skb, we need to do this ourselves&n;&t;&t;&t;&t;&t;&t;&t; */
id|lp-&gt;netdev-&gt;dev.tbusy
op_assign
l_int|0
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_STAT_NODCH
suffix:colon
multiline_comment|/* No D-Channel avail. */
r_if
c_cond
(paren
id|lp-&gt;dialstate
op_eq
l_int|4
)paren
(brace
id|lp-&gt;dialstate
op_decrement
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_STAT_CINF
suffix:colon
multiline_comment|/* Charge-info from TelCo. Calculate interval between&n;&t;&t;&t;&t; * charge-infos and set timestamp for last info for&n;&t;&t;&t;&t; * usage by isdn_net_autohup()&n;&t;&t;&t;&t; */
id|lp-&gt;charge
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;hupflags
op_amp
id|ISDN_HAVECHARGE
)paren
(brace
id|lp-&gt;hupflags
op_and_assign
op_complement
id|ISDN_WAITCHARGE
suffix:semicolon
id|lp-&gt;chargeint
op_assign
id|jiffies
op_minus
id|lp-&gt;chargetime
op_minus
(paren
l_int|2
op_star
id|HZ
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;hupflags
op_amp
id|ISDN_WAITCHARGE
)paren
id|lp-&gt;hupflags
op_or_assign
id|ISDN_HAVECHARGE
suffix:semicolon
id|lp-&gt;chargetime
op_assign
id|jiffies
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_net: Got CINF chargetime of %s now %d&bslash;n&quot;
comma
id|lp-&gt;name
comma
id|lp-&gt;chargetime
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Check, if a number contains wildcard-characters, in which case it&n; * is for incoming purposes only.&n; */
r_static
r_int
DECL|function|isdn_net_checkwild
id|isdn_net_checkwild
c_func
(paren
r_char
op_star
id|num
)paren
(brace
r_return
(paren
(paren
id|strchr
c_func
(paren
id|num
comma
l_char|&squot;?&squot;
)paren
)paren
op_logical_or
(paren
id|strchr
c_func
(paren
id|num
comma
l_char|&squot;*&squot;
)paren
)paren
op_logical_or
(paren
id|strchr
c_func
(paren
id|num
comma
l_char|&squot;[&squot;
)paren
)paren
op_logical_or
(paren
id|strchr
c_func
(paren
id|num
comma
l_char|&squot;]&squot;
)paren
)paren
op_logical_or
(paren
id|strchr
c_func
(paren
id|num
comma
l_char|&squot;^&squot;
)paren
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Perform dialout for net-interfaces and timeout-handling for&n; * D-Channel-up and B-Channel-up Messages.&n; * This function is initially called from within isdn_net_start_xmit() or&n; * or isdn_net_find_icall() after initializing the dialstate for an&n; * interface. If further calls are needed, the function schedules itself&n; * for a timer-callback via isdn_timer_function().&n; * The dialstate is also affected by incoming status-messages from&n; * the ISDN-Channel which are handled in isdn_net_stat_callback() above.&n; */
r_void
DECL|function|isdn_net_dial
id|isdn_net_dial
c_func
(paren
r_void
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|dev-&gt;netdev
suffix:semicolon
r_int
id|anymore
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
id|p-&gt;local
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_NET_DIAL
r_if
c_cond
(paren
id|lp-&gt;dialstate
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: dialstate=%d&bslash;n&quot;
comma
id|lp-&gt;name
comma
id|lp-&gt;dialstate
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|lp-&gt;dialstate
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* Nothing to do for this interface */
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* Initiate dialout. Set phone-number-pointer to first number&n;&t;&t;&t;&t; * of interface.&n;&t;&t;&t;&t; */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|lp-&gt;dial
op_assign
id|lp-&gt;phone
(braket
l_int|1
)braket
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;dial
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: phone number deleted?&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|anymore
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;dialtimeout
OG
l_int|0
)paren
r_if
c_cond
(paren
id|lp-&gt;dialstarted
op_eq
l_int|0
op_logical_or
id|jiffies
OG
(paren
id|lp-&gt;dialstarted
op_plus
id|lp-&gt;dialtimeout
op_plus
id|lp-&gt;dialwait
)paren
)paren
(brace
id|lp-&gt;dialstarted
op_assign
id|jiffies
suffix:semicolon
id|lp-&gt;dialwait_timer
op_assign
l_int|0
suffix:semicolon
)brace
id|lp-&gt;dialstate
op_increment
suffix:semicolon
multiline_comment|/* Fall through */
r_case
l_int|2
suffix:colon
multiline_comment|/* Prepare dialing. Clear EAZ, then set EAZ. */
id|cmd.driver
op_assign
id|lp-&gt;isdn_device
suffix:semicolon
id|cmd.arg
op_assign
id|lp-&gt;isdn_channel
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_CLREAZ
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|cmd.parm.num
comma
l_string|&quot;%s&quot;
comma
id|isdn_map_eaz2msn
c_func
(paren
id|lp-&gt;msn
comma
id|cmd.driver
)paren
)paren
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_SETEAZ
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|lp-&gt;dialretry
op_assign
l_int|0
suffix:semicolon
id|anymore
op_assign
l_int|1
suffix:semicolon
id|lp-&gt;dialstate
op_increment
suffix:semicolon
multiline_comment|/* Fall through */
r_case
l_int|3
suffix:colon
multiline_comment|/* Setup interface, dial current phone-number, switch to next number.&n;&t;&t;&t;&t; * If list of phone-numbers is exhausted, increment&n;&t;&t;&t;&t; * retry-counter.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|dev-&gt;global_flags
op_amp
id|ISDN_GLOBAL_STOPPED
op_logical_or
(paren
id|ISDN_NET_DIALMODE
c_func
(paren
op_star
id|lp
)paren
op_eq
id|ISDN_NET_DM_OFF
)paren
)paren
(brace
r_char
op_star
id|s
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;global_flags
op_amp
id|ISDN_GLOBAL_STOPPED
)paren
id|s
op_assign
l_string|&quot;dial suppressed: isdn system stopped&quot;
suffix:semicolon
r_else
id|s
op_assign
l_string|&quot;dial suppressed: dialmode `off&squot;&quot;
suffix:semicolon
id|isdn_net_unreachable
c_func
(paren
op_amp
id|p-&gt;dev
comma
id|lp-&gt;first_skb
comma
id|s
)paren
suffix:semicolon
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|cmd.driver
op_assign
id|lp-&gt;isdn_device
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_SETL2
suffix:semicolon
id|cmd.arg
op_assign
id|lp-&gt;isdn_channel
op_plus
(paren
id|lp-&gt;l2_proto
op_lshift
l_int|8
)paren
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|lp-&gt;isdn_device
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_SETL3
suffix:semicolon
id|cmd.arg
op_assign
id|lp-&gt;isdn_channel
op_plus
(paren
id|lp-&gt;l3_proto
op_lshift
l_int|8
)paren
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|lp-&gt;isdn_device
suffix:semicolon
id|cmd.arg
op_assign
id|lp-&gt;isdn_channel
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;dial
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: phone number deleted?&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|lp-&gt;dial-&gt;num
comma
l_string|&quot;LEASED&quot;
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|lp-&gt;dialstate
op_assign
l_int|4
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Open leased line ...&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|lp-&gt;dialtimeout
OG
l_int|0
)paren
r_if
c_cond
(paren
id|jiffies
OG
(paren
id|lp-&gt;dialstarted
op_plus
id|lp-&gt;dialtimeout
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|lp-&gt;dialwait_timer
op_assign
id|jiffies
op_plus
id|lp-&gt;dialwait
suffix:semicolon
id|lp-&gt;dialstarted
op_assign
l_int|0
suffix:semicolon
id|isdn_net_unreachable
c_func
(paren
op_amp
id|p-&gt;dev
comma
id|lp-&gt;first_skb
comma
l_string|&quot;dial: timed out&quot;
)paren
suffix:semicolon
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|sprintf
c_func
(paren
id|cmd.parm.setup.phone
comma
l_string|&quot;%s&quot;
comma
id|lp-&gt;dial-&gt;num
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t; * Switch to next number or back to start if at end of list.&n;&t;&t;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|lp-&gt;dial
op_assign
(paren
id|isdn_net_phone
op_star
)paren
id|lp-&gt;dial-&gt;next
)paren
)paren
(brace
id|lp-&gt;dial
op_assign
id|lp-&gt;phone
(braket
l_int|1
)braket
suffix:semicolon
id|lp-&gt;dialretry
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;dialretry
OG
id|lp-&gt;dialmax
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;dialtimeout
op_eq
l_int|0
)paren
(brace
id|lp-&gt;dialwait_timer
op_assign
id|jiffies
op_plus
id|lp-&gt;dialwait
suffix:semicolon
id|lp-&gt;dialstarted
op_assign
l_int|0
suffix:semicolon
id|isdn_net_unreachable
c_func
(paren
op_amp
id|p-&gt;dev
comma
id|lp-&gt;first_skb
comma
l_string|&quot;dial: tried all numbers dialmax times&quot;
)paren
suffix:semicolon
)brace
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|lp-&gt;isdn_device
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_DIAL
suffix:semicolon
id|cmd.parm.setup.si1
op_assign
l_int|7
suffix:semicolon
id|cmd.parm.setup.si2
op_assign
l_int|0
suffix:semicolon
id|sprintf
c_func
(paren
id|cmd.parm.setup.eazmsn
comma
l_string|&quot;%s&quot;
comma
id|isdn_map_eaz2msn
c_func
(paren
id|lp-&gt;msn
comma
id|cmd.driver
)paren
)paren
suffix:semicolon
id|i
op_assign
id|isdn_dc2minor
c_func
(paren
id|lp-&gt;isdn_device
comma
id|lp-&gt;isdn_channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
l_int|0
)paren
(brace
id|strcpy
c_func
(paren
id|dev-&gt;num
(braket
id|i
)braket
comma
id|cmd.parm.setup.phone
)paren
suffix:semicolon
id|isdn_info_update
c_func
(paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: dialing %d %s...&bslash;n&quot;
comma
id|lp-&gt;name
comma
id|lp-&gt;dialretry
comma
id|cmd.parm.setup.phone
)paren
suffix:semicolon
id|lp-&gt;dtimer
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_NET_DIAL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;dial: d=%d c=%d&bslash;n&quot;
comma
id|lp-&gt;isdn_device
comma
id|lp-&gt;isdn_channel
)paren
suffix:semicolon
macro_line|#endif
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
)brace
id|lp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;outgoing
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;chargeint
)paren
(brace
id|lp-&gt;hupflags
op_or_assign
id|ISDN_HAVECHARGE
suffix:semicolon
id|lp-&gt;hupflags
op_and_assign
op_complement
id|ISDN_WAITCHARGE
suffix:semicolon
)brace
r_else
(brace
id|lp-&gt;hupflags
op_or_assign
id|ISDN_WAITCHARGE
suffix:semicolon
id|lp-&gt;hupflags
op_and_assign
op_complement
id|ISDN_HAVECHARGE
suffix:semicolon
)brace
id|anymore
op_assign
l_int|1
suffix:semicolon
id|lp-&gt;dialstate
op_assign
(paren
id|lp-&gt;cbdelay
op_logical_and
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CBOUT
)paren
)paren
ques
c_cond
l_int|12
suffix:colon
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
multiline_comment|/* Wait for D-Channel-connect.&n;&t;&t;&t;&t; * If timeout, switch back to state 3.&n;&t;&t;&t;&t; * Dialmax-handling moved to state 3.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|lp-&gt;dtimer
op_increment
OG
id|ISDN_TIMER_DTIMEOUT10
)paren
id|lp-&gt;dialstate
op_assign
l_int|3
suffix:semicolon
id|anymore
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
multiline_comment|/* Got D-Channel-Connect, send B-Channel-request */
id|cmd.driver
op_assign
id|lp-&gt;isdn_device
suffix:semicolon
id|cmd.arg
op_assign
id|lp-&gt;isdn_channel
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_ACCEPTB
suffix:semicolon
id|anymore
op_assign
l_int|1
suffix:semicolon
id|lp-&gt;dtimer
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;dialstate
op_increment
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
multiline_comment|/* Wait for B- or D-Channel-connect. If timeout,&n;&t;&t;&t;&t; * switch back to state 3.&n;&t;&t;&t;&t; */
macro_line|#ifdef ISDN_DEBUG_NET_DIAL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;dialtimer2: %d&bslash;n&quot;
comma
id|lp-&gt;dtimer
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|lp-&gt;dtimer
op_increment
OG
id|ISDN_TIMER_DTIMEOUT10
)paren
id|lp-&gt;dialstate
op_assign
l_int|3
suffix:semicolon
id|anymore
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
multiline_comment|/* Got incoming Call, setup L2 and L3 protocols,&n;&t;&t;&t;&t; * then wait for D-Channel-connect&n;&t;&t;&t;&t; */
macro_line|#ifdef ISDN_DEBUG_NET_DIAL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;dialtimer4: %d&bslash;n&quot;
comma
id|lp-&gt;dtimer
)paren
suffix:semicolon
macro_line|#endif
id|cmd.driver
op_assign
id|lp-&gt;isdn_device
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_SETL2
suffix:semicolon
id|cmd.arg
op_assign
id|lp-&gt;isdn_channel
op_plus
(paren
id|lp-&gt;l2_proto
op_lshift
l_int|8
)paren
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|lp-&gt;isdn_device
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_SETL3
suffix:semicolon
id|cmd.arg
op_assign
id|lp-&gt;isdn_channel
op_plus
(paren
id|lp-&gt;l3_proto
op_lshift
l_int|8
)paren
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;dtimer
op_increment
OG
id|ISDN_TIMER_DTIMEOUT15
)paren
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
r_else
(brace
id|anymore
op_assign
l_int|1
suffix:semicolon
id|lp-&gt;dialstate
op_increment
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|9
suffix:colon
multiline_comment|/* Got incoming D-Channel-Connect, send B-Channel-request */
id|cmd.driver
op_assign
id|lp-&gt;isdn_device
suffix:semicolon
id|cmd.arg
op_assign
id|lp-&gt;isdn_channel
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_ACCEPTB
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|anymore
op_assign
l_int|1
suffix:semicolon
id|lp-&gt;dtimer
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;dialstate
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
r_case
l_int|10
suffix:colon
multiline_comment|/*  Wait for B- or D-channel-connect */
macro_line|#ifdef ISDN_DEBUG_NET_DIAL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;dialtimer4: %d&bslash;n&quot;
comma
id|lp-&gt;dtimer
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|lp-&gt;dtimer
op_increment
OG
id|ISDN_TIMER_DTIMEOUT10
)paren
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
r_else
id|anymore
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|11
suffix:colon
multiline_comment|/* Callback Delay */
r_if
c_cond
(paren
id|lp-&gt;dtimer
op_increment
OG
id|lp-&gt;cbdelay
)paren
id|lp-&gt;dialstate
op_assign
l_int|1
suffix:semicolon
id|anymore
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|12
suffix:colon
multiline_comment|/* Remote does callback. Hangup after cbdelay, then wait for incoming&n;&t;&t;&t;&t; * call (in state 4).&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|lp-&gt;dtimer
op_increment
OG
id|lp-&gt;cbdelay
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: hangup waiting for callback ...&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
id|lp-&gt;dtimer
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;dialstate
op_assign
l_int|4
suffix:semicolon
id|cmd.driver
op_assign
id|lp-&gt;isdn_device
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_HANGUP
suffix:semicolon
id|cmd.arg
op_assign
id|lp-&gt;isdn_channel
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|isdn_all_eaz
c_func
(paren
id|lp-&gt;isdn_device
comma
id|lp-&gt;isdn_channel
)paren
suffix:semicolon
)brace
id|anymore
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net: Illegal dialstate %d for device %s&bslash;n&quot;
comma
id|lp-&gt;dialstate
comma
id|lp-&gt;name
)paren
suffix:semicolon
)brace
id|p
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|p-&gt;next
suffix:semicolon
)brace
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_NETDIAL
comma
id|anymore
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Perform hangup for a net-interface.&n; */
r_void
DECL|function|isdn_net_hangup
id|isdn_net_hangup
c_func
(paren
r_struct
id|device
op_star
id|d
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|d-&gt;priv
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_X25
r_struct
id|concap_proto
op_star
id|cprot
op_assign
id|lp
op_member_access_from_pointer
id|netdev
op_member_access_from_pointer
id|cprot
suffix:semicolon
r_struct
id|concap_proto_ops
op_star
id|pops
op_assign
id|cprot
ques
c_cond
id|cprot
op_member_access_from_pointer
id|pops
suffix:colon
l_int|0
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdn_net: local hangup %s&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
id|isdn_ppp_free
c_func
(paren
id|lp
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ISDN_X25
multiline_comment|/* try if there are generic encap protocol&n;&t;&t;   receiver routines and signal the closure of&n;&t;&t;   the link */
r_if
c_cond
(paren
id|pops
op_logical_and
id|pops
op_member_access_from_pointer
id|disconn_ind
)paren
(brace
id|pops
op_member_access_from_pointer
id|disconn_ind
c_func
(paren
id|cprot
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ISDN_X25 */
id|cmd.driver
op_assign
id|lp-&gt;isdn_device
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_HANGUP
suffix:semicolon
id|cmd.arg
op_assign
id|lp-&gt;isdn_channel
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Chargesum is %d&bslash;n&quot;
comma
id|lp-&gt;name
comma
id|lp-&gt;charge
)paren
suffix:semicolon
id|isdn_all_eaz
c_func
(paren
id|lp-&gt;isdn_device
comma
id|lp-&gt;isdn_channel
)paren
suffix:semicolon
)brace
id|isdn_net_unbind_channel
c_func
(paren
id|lp
)paren
suffix:semicolon
)brace
r_typedef
r_struct
(brace
DECL|member|source
r_int
r_int
id|source
suffix:semicolon
DECL|member|dest
r_int
r_int
id|dest
suffix:semicolon
DECL|typedef|ip_ports
)brace
id|ip_ports
suffix:semicolon
r_static
r_void
DECL|function|isdn_net_log_skb
id|isdn_net_log_skb
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
id|isdn_net_local
op_star
id|lp
)paren
(brace
id|u_char
op_star
id|p
op_assign
id|skb-&gt;nh.raw
suffix:semicolon
multiline_comment|/* hopefully, this was set correctly */
r_int
r_int
id|proto
op_assign
id|ntohs
c_func
(paren
id|skb-&gt;protocol
)paren
suffix:semicolon
r_int
id|data_ofs
suffix:semicolon
id|ip_ports
op_star
id|ipp
suffix:semicolon
r_char
id|addinfo
(braket
l_int|100
)braket
suffix:semicolon
id|addinfo
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
multiline_comment|/* This check stolen from 2.1.72 dev_queue_xmit_nit() */
r_if
c_cond
(paren
id|skb-&gt;nh.raw
OL
id|skb-&gt;data
op_logical_or
id|skb-&gt;nh.raw
op_ge
id|skb-&gt;tail
)paren
(brace
multiline_comment|/* fall back to old isdn_net_log_packet method() */
r_char
op_star
id|buf
op_assign
id|skb-&gt;data
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_net: protocol %04x is buggy, dev %s&bslash;n&quot;
comma
id|skb-&gt;protocol
comma
id|lp-&gt;name
)paren
suffix:semicolon
id|p
op_assign
id|buf
suffix:semicolon
id|proto
op_assign
id|ETH_P_IP
suffix:semicolon
r_switch
c_cond
(paren
id|lp-&gt;p_encap
)paren
(brace
r_case
id|ISDN_NET_ENCAP_IPTYP
suffix:colon
id|proto
op_assign
id|ntohs
c_func
(paren
op_star
(paren
r_int
r_int
op_star
)paren
op_amp
id|buf
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|p
op_assign
op_amp
id|buf
(braket
l_int|2
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_NET_ENCAP_ETHER
suffix:colon
id|proto
op_assign
id|ntohs
c_func
(paren
op_star
(paren
r_int
r_int
op_star
)paren
op_amp
id|buf
(braket
l_int|12
)braket
)paren
suffix:semicolon
id|p
op_assign
op_amp
id|buf
(braket
l_int|14
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_NET_ENCAP_CISCOHDLC
suffix:colon
id|proto
op_assign
id|ntohs
c_func
(paren
op_star
(paren
r_int
r_int
op_star
)paren
op_amp
id|buf
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|p
op_assign
op_amp
id|buf
(braket
l_int|4
)braket
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
r_case
id|ISDN_NET_ENCAP_SYNCPPP
suffix:colon
id|proto
op_assign
id|ntohs
c_func
(paren
id|skb-&gt;protocol
)paren
suffix:semicolon
id|p
op_assign
op_amp
id|buf
(braket
id|IPPP_MAX_HEADER
)braket
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
)brace
)brace
id|data_ofs
op_assign
(paren
(paren
id|p
(braket
l_int|0
)braket
op_amp
l_int|15
)paren
op_star
l_int|4
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|proto
)paren
(brace
r_case
id|ETH_P_IP
suffix:colon
r_switch
c_cond
(paren
id|p
(braket
l_int|9
)braket
)paren
(brace
r_case
l_int|1
suffix:colon
id|strcpy
c_func
(paren
id|addinfo
comma
l_string|&quot; ICMP&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|strcpy
c_func
(paren
id|addinfo
comma
l_string|&quot; IGMP&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|strcpy
c_func
(paren
id|addinfo
comma
l_string|&quot; IPIP&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|ipp
op_assign
(paren
id|ip_ports
op_star
)paren
(paren
op_amp
id|p
(braket
id|data_ofs
)braket
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|addinfo
comma
l_string|&quot; TCP, port: %d -&gt; %d&quot;
comma
id|ntohs
c_func
(paren
id|ipp-&gt;source
)paren
comma
id|ntohs
c_func
(paren
id|ipp-&gt;dest
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|strcpy
c_func
(paren
id|addinfo
comma
l_string|&quot; EGP&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|12
suffix:colon
id|strcpy
c_func
(paren
id|addinfo
comma
l_string|&quot; PUP&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|17
suffix:colon
id|ipp
op_assign
(paren
id|ip_ports
op_star
)paren
(paren
op_amp
id|p
(braket
id|data_ofs
)braket
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|addinfo
comma
l_string|&quot; UDP, port: %d -&gt; %d&quot;
comma
id|ntohs
c_func
(paren
id|ipp-&gt;source
)paren
comma
id|ntohs
c_func
(paren
id|ipp-&gt;dest
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|22
suffix:colon
id|strcpy
c_func
(paren
id|addinfo
comma
l_string|&quot; IDP&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;OPEN: %d.%d.%d.%d -&gt; %d.%d.%d.%d%s&bslash;n&quot;
comma
id|p
(braket
l_int|12
)braket
comma
id|p
(braket
l_int|13
)braket
comma
id|p
(braket
l_int|14
)braket
comma
id|p
(braket
l_int|15
)braket
comma
id|p
(braket
l_int|16
)braket
comma
id|p
(braket
l_int|17
)braket
comma
id|p
(braket
l_int|18
)braket
comma
id|p
(braket
l_int|19
)braket
comma
id|addinfo
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_ARP
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;OPEN: ARP %d.%d.%d.%d -&gt; *.*.*.* ?%d.%d.%d.%d&bslash;n&quot;
comma
id|p
(braket
l_int|14
)braket
comma
id|p
(braket
l_int|15
)braket
comma
id|p
(braket
l_int|16
)braket
comma
id|p
(braket
l_int|17
)braket
comma
id|p
(braket
l_int|24
)braket
comma
id|p
(braket
l_int|25
)braket
comma
id|p
(braket
l_int|26
)braket
comma
id|p
(braket
l_int|27
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Generic routine to send out an skbuf.&n; * If lowlevel-device does not support support skbufs, use&n; * standard send-routine, else send directly.&n; *&n; * Return: 0 on success, !0 on failure.&n; * Side-effects: ndev-&gt;tbusy is cleared on success.&n; */
r_int
DECL|function|isdn_net_send_skb
id|isdn_net_send_skb
c_func
(paren
r_struct
id|device
op_star
id|ndev
comma
id|isdn_net_local
op_star
id|lp
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|ret
suffix:semicolon
r_int
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
multiline_comment|/* save len */
id|ret
op_assign
id|isdn_writebuf_skb_stub
c_func
(paren
id|lp-&gt;isdn_device
comma
id|lp-&gt;isdn_channel
comma
l_int|1
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
id|len
)paren
(brace
id|lp-&gt;transcount
op_add_assign
id|len
suffix:semicolon
id|clear_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
(paren
id|ndev-&gt;tbusy
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|clear_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
(paren
id|ndev-&gt;tbusy
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; *  Helper function for isdn_net_start_xmit.&n; *  When called, the connection is already established.&n; *  Based on cps-calculation, check if device is overloaded.&n; *  If so, and if a slave exists, trigger dialing for it.&n; *  If any slave is online, deliver packets using a simple round robin&n; *  scheme.&n; *&n; *  Return: 0 on success, !0 on failure.&n; */
r_static
r_int
DECL|function|isdn_net_xmit
id|isdn_net_xmit
c_func
(paren
r_struct
id|device
op_star
id|ndev
comma
id|isdn_net_local
op_star
id|lp
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|ret
suffix:semicolon
multiline_comment|/* For the other encaps the header has already been built */
macro_line|#ifdef CONFIG_ISDN_PPP
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_SYNCPPP
)paren
(brace
r_return
id|isdn_ppp_xmit
c_func
(paren
id|skb
comma
id|ndev
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Reset hangup-timeout */
id|lp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;cps
OG
id|lp-&gt;triggercps
)paren
(brace
multiline_comment|/* Device overloaded */
multiline_comment|/*&n;&t;&t; * Packet-delivery via round-robin over master&n;&t;&t; * and all connected slaves.&n;&t;&t; */
r_if
c_cond
(paren
id|lp-&gt;master
)paren
multiline_comment|/* Slaves always deliver themselves */
id|ret
op_assign
id|isdn_net_send_skb
c_func
(paren
id|ndev
comma
id|lp
comma
id|skb
)paren
suffix:semicolon
r_else
(brace
id|isdn_net_local
op_star
id|slp
op_assign
(paren
id|isdn_net_local
op_star
)paren
(paren
id|lp-&gt;srobin-&gt;priv
)paren
suffix:semicolon
multiline_comment|/* Master delivers via srobin and maintains srobin */
r_if
c_cond
(paren
id|lp-&gt;srobin
op_eq
id|ndev
)paren
id|ret
op_assign
id|isdn_net_send_skb
c_func
(paren
id|ndev
comma
id|lp
comma
id|skb
)paren
suffix:semicolon
r_else
id|ret
op_assign
id|ndev-&gt;tbusy
op_assign
id|isdn_net_start_xmit
c_func
(paren
id|skb
comma
id|lp-&gt;srobin
)paren
suffix:semicolon
id|lp-&gt;srobin
op_assign
(paren
id|slp-&gt;slave
)paren
ques
c_cond
id|slp-&gt;slave
suffix:colon
id|ndev
suffix:semicolon
id|slp
op_assign
(paren
id|isdn_net_local
op_star
)paren
(paren
id|lp-&gt;srobin-&gt;priv
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|slp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
op_logical_and
(paren
id|slp-&gt;dialstate
op_eq
l_int|0
)paren
)paren
)paren
id|lp-&gt;srobin
op_assign
id|ndev
suffix:semicolon
)brace
multiline_comment|/* Slave-startup using delay-variable */
r_if
c_cond
(paren
id|lp-&gt;slave
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;sqfull
)paren
(brace
multiline_comment|/* First time overload: set timestamp only */
id|lp-&gt;sqfull
op_assign
l_int|1
suffix:semicolon
id|lp-&gt;sqfull_stamp
op_assign
id|jiffies
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* subsequent overload: if slavedelay exceeded, start dialing */
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|lp-&gt;sqfull_stamp
)paren
OG
id|lp-&gt;slavedelay
)paren
id|isdn_net_force_dial_lp
c_func
(paren
(paren
id|isdn_net_local
op_star
)paren
id|lp-&gt;slave-&gt;priv
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* Not overloaded, deliver locally */
id|ret
op_assign
id|isdn_net_send_skb
c_func
(paren
id|ndev
comma
id|lp
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;sqfull
op_logical_and
(paren
(paren
id|jiffies
op_minus
id|lp-&gt;sqfull_stamp
)paren
OG
(paren
id|lp-&gt;slavedelay
op_plus
(paren
l_int|10
op_star
id|HZ
)paren
)paren
)paren
)paren
id|lp-&gt;sqfull
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
r_static
r_void
DECL|function|isdn_net_adjust_hdr
id|isdn_net_adjust_hdr
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_ETHER
)paren
(brace
r_int
id|pullsize
op_assign
(paren
id|ulong
)paren
id|skb-&gt;nh.raw
op_minus
(paren
id|ulong
)paren
id|skb-&gt;data
op_minus
id|ETH_HLEN
suffix:semicolon
r_if
c_cond
(paren
id|pullsize
OG
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_net: Pull junk %d&bslash;n&quot;
comma
id|pullsize
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
id|pullsize
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * Try sending a packet.&n; * If this interface isn&squot;t connected to a ISDN-Channel, find a free channel,&n; * and start dialing.&n; */
r_static
r_int
DECL|function|isdn_net_start_xmit
id|isdn_net_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|ndev
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|ndev-&gt;priv
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_X25
r_struct
id|concap_proto
op_star
id|cprot
op_assign
id|lp
op_member_access_from_pointer
id|netdev
op_member_access_from_pointer
id|cprot
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ndev-&gt;tbusy
)paren
(brace
r_if
c_cond
(paren
id|jiffies
op_minus
id|ndev-&gt;trans_start
OL
(paren
l_int|2
op_star
id|HZ
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;dialstate
)paren
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|ndev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
)brace
id|ndev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* left instead of obsolete test_and_set_bit() */
macro_line|#ifdef CONFIG_ISDN_X25
multiline_comment|/* At this point hard_start_xmit() passes control to the encapsulation&n;   protocol (if present).&n;   For X.25 auto-dialing is completly bypassed because:&n;   - It does not conform with the semantics of a reliable datalink&n;     service as needed by X.25 PLP.&n;   - I don&squot;t want that the interface starts dialing when the network layer&n;     sends a message which requests to disconnect the lapb link (or if it&n;     sends any other message not resulting in data transmission).&n;   Instead, dialing will be initiated by the encapsulation protocol entity&n;   when a dl_establish request is received from the upper layer.&n;*/
r_if
c_cond
(paren
id|cprot
)paren
(brace
r_return
id|cprot
op_member_access_from_pointer
id|pops
op_member_access_from_pointer
id|encap_and_xmit
(paren
id|cprot
comma
id|skb
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif
multiline_comment|/* auto-dialing xmit function */
(brace
macro_line|#ifdef ISDN_DEBUG_NET_DUMP
id|u_char
op_star
id|buf
suffix:semicolon
macro_line|#endif
id|isdn_net_adjust_hdr
c_func
(paren
id|skb
comma
id|ndev
)paren
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_NET_DUMP
id|buf
op_assign
id|skb-&gt;data
suffix:semicolon
id|isdn_dumppkt
c_func
(paren
l_string|&quot;S:&quot;
comma
id|buf
comma
id|skb-&gt;len
comma
l_int|40
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
)paren
(brace
r_int
id|chi
suffix:semicolon
multiline_comment|/* only do autodial if allowed by config */
r_if
c_cond
(paren
op_logical_neg
(paren
id|ISDN_NET_DIALMODE
c_func
(paren
op_star
id|lp
)paren
op_eq
id|ISDN_NET_DM_AUTO
)paren
)paren
(brace
id|isdn_net_unreachable
c_func
(paren
id|ndev
comma
id|skb
comma
l_string|&quot;dial rejected: interface not in dialmode `auto&squot;&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|ndev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;phone
(braket
l_int|1
)braket
)paren
(brace
id|ulong
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;dialwait_timer
op_le
l_int|0
)paren
r_if
c_cond
(paren
id|lp-&gt;dialstarted
OG
l_int|0
op_logical_and
id|lp-&gt;dialtimeout
OG
l_int|0
op_logical_and
id|jiffies
OL
id|lp-&gt;dialstarted
op_plus
id|lp-&gt;dialtimeout
op_plus
id|lp-&gt;dialwait
)paren
(brace
id|lp-&gt;dialwait_timer
op_assign
id|lp-&gt;dialstarted
op_plus
id|lp-&gt;dialtimeout
op_plus
id|lp-&gt;dialwait
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;dialwait_timer
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|jiffies
OL
id|lp-&gt;dialwait_timer
)paren
(brace
id|isdn_net_unreachable
c_func
(paren
id|ndev
comma
id|skb
comma
l_string|&quot;dial rejected: retry-time not reached&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|ndev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
id|lp-&gt;dialwait_timer
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Grab a free ISDN-Channel */
r_if
c_cond
(paren
(paren
(paren
id|chi
op_assign
id|isdn_get_free_channel
c_func
(paren
id|ISDN_USAGE_NET
comma
id|lp-&gt;l2_proto
comma
id|lp-&gt;l3_proto
comma
id|lp-&gt;pre_device
comma
id|lp-&gt;pre_channel
)paren
)paren
OL
l_int|0
)paren
op_logical_and
(paren
(paren
id|chi
op_assign
id|isdn_get_free_channel
c_func
(paren
id|ISDN_USAGE_NET
comma
id|lp-&gt;l2_proto
comma
id|lp-&gt;l3_proto
comma
id|lp-&gt;pre_device
comma
id|lp-&gt;pre_channel
op_xor
l_int|1
)paren
)paren
OL
l_int|0
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|isdn_net_unreachable
c_func
(paren
id|ndev
comma
id|skb
comma
l_string|&quot;No channel&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|ndev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Log packet, which triggered dialing */
r_if
c_cond
(paren
id|dev-&gt;net_verbose
)paren
id|isdn_net_log_skb
c_func
(paren
id|skb
comma
id|lp
)paren
suffix:semicolon
id|lp-&gt;dialstate
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Connect interface with channel */
id|isdn_net_bind_channel
c_func
(paren
id|lp
comma
id|chi
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_SYNCPPP
)paren
(brace
multiline_comment|/* no &squot;first_skb&squot; handling for syncPPP */
r_if
c_cond
(paren
id|isdn_ppp_bind
c_func
(paren
id|lp
)paren
OL
l_int|0
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|isdn_net_unbind_channel
c_func
(paren
id|lp
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* STN (skb to nirvana) ;) */
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|isdn_net_dial
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Initiate dialing */
r_return
l_int|1
suffix:semicolon
multiline_comment|/* let upper layer requeue skb packet */
)brace
macro_line|#endif
multiline_comment|/* remember first skb to speed up arp&n;&t;&t;&t;&t; * when using encap ETHER&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|lp-&gt;first_skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net_start_xmit: First skb already set!&bslash;n&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|lp-&gt;first_skb
)paren
suffix:semicolon
id|lp-&gt;first_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|lp-&gt;first_skb
op_assign
id|skb
suffix:semicolon
multiline_comment|/* Initiate dialing */
id|ndev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|isdn_net_dial
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|isdn_net_unreachable
c_func
(paren
id|ndev
comma
id|skb
comma
l_string|&quot;No phone number&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|ndev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Connection is established, try sending */
id|ndev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;dialstate
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;first_skb
)paren
(brace
r_if
c_cond
(paren
id|isdn_net_xmit
c_func
(paren
id|ndev
comma
id|lp
comma
id|lp-&gt;first_skb
)paren
)paren
r_return
l_int|1
suffix:semicolon
id|lp-&gt;first_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
(paren
id|isdn_net_xmit
c_func
(paren
id|ndev
comma
id|lp
comma
id|skb
)paren
)paren
suffix:semicolon
)brace
r_else
id|ndev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Shutdown a net-interface.&n; */
r_static
r_int
DECL|function|isdn_net_close
id|isdn_net_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|device
op_star
id|p
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_X25
r_struct
id|concap_proto
op_star
id|cprot
op_assign
(paren
(paren
id|isdn_net_local
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|netdev
op_member_access_from_pointer
id|cprot
suffix:semicolon
multiline_comment|/* printk(KERN_DEBUG &quot;isdn_net_close %s&bslash;n&quot; , dev-&gt; name ); */
macro_line|#endif
macro_line|#ifdef CONFIG_ISDN_X25
r_if
c_cond
(paren
id|cprot
op_logical_and
id|cprot
op_member_access_from_pointer
id|pops
)paren
(brace
id|cprot
op_member_access_from_pointer
id|pops
op_member_access_from_pointer
id|close
c_func
(paren
id|cprot
)paren
suffix:semicolon
)brace
macro_line|#endif
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
op_assign
(paren
(paren
(paren
id|isdn_net_local
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|slave
)paren
)paren
)paren
(brace
multiline_comment|/* If this interface has slaves, stop them also */
r_while
c_loop
(paren
id|p
)paren
(brace
macro_line|#ifdef CONFIG_ISDN_X25
id|cprot
op_assign
(paren
(paren
id|isdn_net_local
op_star
)paren
id|p-&gt;priv
)paren
op_member_access_from_pointer
id|netdev
op_member_access_from_pointer
id|cprot
suffix:semicolon
r_if
c_cond
(paren
id|cprot
op_logical_and
id|cprot
op_member_access_from_pointer
id|pops
)paren
(brace
id|cprot
op_member_access_from_pointer
id|pops
op_member_access_from_pointer
id|close
c_func
(paren
id|cprot
)paren
suffix:semicolon
)brace
macro_line|#endif
id|isdn_net_hangup
c_func
(paren
id|p
)paren
suffix:semicolon
id|p-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|p-&gt;start
op_assign
l_int|0
suffix:semicolon
id|p
op_assign
(paren
(paren
(paren
id|isdn_net_local
op_star
)paren
id|p-&gt;priv
)paren
op_member_access_from_pointer
id|slave
)paren
suffix:semicolon
)brace
)brace
id|isdn_net_hangup
c_func
(paren
id|dev
)paren
suffix:semicolon
id|isdn_MOD_DEC_USE_COUNT
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Get statistics&n; */
r_static
r_struct
id|enet_statistics
op_star
DECL|function|isdn_net_get_stats
id|isdn_net_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|lp-&gt;stats
suffix:semicolon
)brace
multiline_comment|/*      This is simply a copy from std. eth.c EXCEPT we pull ETH_HLEN&n; *      instead of dev-&gt;hard_header_len off. This is done because the&n; *      lowlevel-driver has already pulled off its stuff when we get&n; *      here and this routine only gets called with p_encap == ETHER.&n; *      Determine the packet&squot;s protocol ID. The rule here is that we&n; *      assume 802.3 if the type field is short enough to be a length.&n; *      This is normal practice and works for any &squot;now in use&squot; protocol.&n; */
r_static
r_int
r_int
DECL|function|isdn_net_type_trans
id|isdn_net_type_trans
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|ethhdr
op_star
id|eth
suffix:semicolon
r_int
r_char
op_star
id|rawp
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
id|ETH_HLEN
)paren
suffix:semicolon
id|eth
op_assign
id|skb-&gt;mac.ethernet
suffix:semicolon
r_if
c_cond
(paren
op_star
id|eth-&gt;h_dest
op_amp
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|eth-&gt;h_dest
comma
id|dev-&gt;broadcast
comma
id|ETH_ALEN
)paren
op_eq
l_int|0
)paren
id|skb-&gt;pkt_type
op_assign
id|PACKET_BROADCAST
suffix:semicolon
r_else
id|skb-&gt;pkt_type
op_assign
id|PACKET_MULTICAST
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *      This ALLMULTI check should be redundant by 1.4&n;&t; *      so don&squot;t forget to remove it.&n;&t; */
r_else
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
(paren
id|IFF_PROMISC
multiline_comment|/*| IFF_ALLMULTI*/
)paren
)paren
(brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|eth-&gt;h_dest
comma
id|dev-&gt;dev_addr
comma
id|ETH_ALEN
)paren
)paren
id|skb-&gt;pkt_type
op_assign
id|PACKET_OTHERHOST
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ntohs
c_func
(paren
id|eth-&gt;h_proto
)paren
op_ge
l_int|1536
)paren
r_return
id|eth-&gt;h_proto
suffix:semicolon
id|rawp
op_assign
id|skb-&gt;data
suffix:semicolon
multiline_comment|/*&n;&t; *      This is a magic hack to spot IPX packets. Older Novell breaks&n;&t; *      the protocol design and runs IPX over 802.3 without an 802.2 LLC&n;&t; *      layer. We look for FFFF which isn&squot;t a used 802.2 SSAP/DSAP. This&n;&t; *      won&squot;t work for fault tolerant netware but does for the rest.&n;&t; */
r_if
c_cond
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|rawp
op_eq
l_int|0xFFFF
)paren
r_return
id|htons
c_func
(paren
id|ETH_P_802_3
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *      Real 802.2 LLC&n;&t; */
r_return
id|htons
c_func
(paren
id|ETH_P_802_2
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|isdn_net_slarp_send
id|isdn_net_slarp_send
c_func
(paren
id|isdn_net_local
op_star
id|lp
comma
r_int
id|is_reply
)paren
(brace
r_int
r_int
id|hl
op_assign
id|dev-&gt;drv
(braket
id|lp-&gt;isdn_device
)braket
op_member_access_from_pointer
id|interface-&gt;hl_hdrlen
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|hl
op_plus
r_sizeof
(paren
id|cisco_hdr
)paren
op_plus
r_sizeof
(paren
id|cisco_slarp
)paren
)paren
suffix:semicolon
r_int
r_int
id|t
op_assign
(paren
id|jiffies
op_div
id|HZ
op_star
l_int|1000000
)paren
suffix:semicolon
r_int
id|len
suffix:semicolon
id|cisco_hdr
op_star
id|ch
suffix:semicolon
id|cisco_slarp
op_star
id|s
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Could not allocate SLARP reply&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb
comma
id|hl
)paren
suffix:semicolon
id|ch
op_assign
(paren
id|cisco_hdr
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
id|cisco_hdr
)paren
)paren
suffix:semicolon
id|ch-&gt;addr
op_assign
id|CISCO_ADDR_UNICAST
suffix:semicolon
id|ch-&gt;ctrl
op_assign
l_int|0
suffix:semicolon
id|ch-&gt;type
op_assign
id|htons
c_func
(paren
id|CISCO_TYPE_SLARP
)paren
suffix:semicolon
id|s
op_assign
(paren
id|cisco_slarp
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
id|cisco_slarp
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_reply
)paren
(brace
id|s-&gt;code
op_assign
id|htonl
c_func
(paren
id|CISCO_SLARP_REPLY
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|s-&gt;slarp.reply.ifaddr
comma
l_int|0
comma
r_sizeof
(paren
id|__u32
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|s-&gt;slarp.reply.netmask
comma
l_int|0
comma
r_sizeof
(paren
id|__u32
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|lp-&gt;cisco_myseq
op_increment
suffix:semicolon
id|s-&gt;code
op_assign
id|htonl
c_func
(paren
id|CISCO_SLARP_KEEPALIVE
)paren
suffix:semicolon
id|s-&gt;slarp.keepalive.my_seq
op_assign
id|htonl
c_func
(paren
id|lp-&gt;cisco_myseq
)paren
suffix:semicolon
id|s-&gt;slarp.keepalive.your_seq
op_assign
id|htonl
c_func
(paren
id|lp-&gt;cisco_yourseq
)paren
suffix:semicolon
)brace
id|s-&gt;rel
op_assign
l_int|0xffff
suffix:semicolon
id|s-&gt;t1
op_assign
id|t
op_rshift
l_int|16
suffix:semicolon
id|s-&gt;t0
op_assign
id|t
op_amp
l_int|0xffff
suffix:semicolon
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|isdn_writebuf_skb_stub
c_func
(paren
id|lp-&gt;isdn_device
comma
id|lp-&gt;isdn_channel
comma
l_int|0
comma
id|skb
)paren
op_ne
id|len
)paren
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|isdn_net_slarp_in
id|isdn_net_slarp_in
c_func
(paren
id|isdn_net_local
op_star
id|lp
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|cisco_slarp
op_star
id|s
op_assign
(paren
id|cisco_slarp
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_switch
c_cond
(paren
id|ntohl
c_func
(paren
id|s-&gt;code
)paren
)paren
(brace
r_case
id|CISCO_SLARP_REQUEST
suffix:colon
id|isdn_net_slarp_send
c_func
(paren
id|lp
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISCO_SLARP_REPLY
suffix:colon
multiline_comment|/* Ignore replies */
r_break
suffix:semicolon
r_case
id|CISCO_SLARP_KEEPALIVE
suffix:colon
id|lp-&gt;cisco_yourseq
op_assign
id|s-&gt;slarp.keepalive.my_seq
suffix:semicolon
r_if
c_cond
(paren
id|ntohl
c_func
(paren
id|s-&gt;slarp.keepalive.my_seq
op_eq
id|lp-&gt;cisco_myseq
)paren
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;cisco_loop
op_increment
op_eq
l_int|2
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Keepalive Loop&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
id|lp-&gt;cisco_myseq
op_xor_assign
id|jiffies
suffix:semicolon
)brace
)brace
r_else
id|lp-&gt;cisco_loop
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Called every 10 sec. via timer-interrupt if&n; * any network-interface has Cisco-Keepalive-Encapsulation&n; * and is online.&n; * Send Keepalive-Packet and re-schedule.&n; */
r_void
DECL|function|isdn_net_slarp_out
id|isdn_net_slarp_out
c_func
(paren
r_void
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|dev-&gt;netdev
suffix:semicolon
r_int
id|anymore
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
id|isdn_net_local
op_star
id|l
op_assign
id|p-&gt;local
suffix:semicolon
r_if
c_cond
(paren
(paren
id|l-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_CISCOHDLCK
)paren
op_logical_and
(paren
id|l-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
op_logical_and
(paren
op_logical_neg
id|l-&gt;dialstate
)paren
)paren
(brace
id|anymore
op_assign
l_int|1
suffix:semicolon
id|isdn_net_slarp_send
c_func
(paren
id|l
comma
l_int|0
)paren
suffix:semicolon
)brace
id|p
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|p-&gt;next
suffix:semicolon
)brace
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_KEEPALIVE
comma
id|anymore
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Got a packet from ISDN-Channel.&n; */
r_static
r_void
DECL|function|isdn_net_receive
id|isdn_net_receive
c_func
(paren
r_struct
id|device
op_star
id|ndev
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|ndev-&gt;priv
suffix:semicolon
id|isdn_net_local
op_star
id|olp
op_assign
id|lp
suffix:semicolon
multiline_comment|/* original &squot;lp&squot; */
macro_line|#ifdef CONFIG_ISDN_PPP
r_int
id|proto
op_assign
id|PPP_PROTOCOL
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ISDN_X25
r_struct
id|concap_proto
op_star
id|cprot
op_assign
id|lp
op_member_access_from_pointer
id|netdev
op_member_access_from_pointer
id|cprot
suffix:semicolon
macro_line|#endif
id|cisco_hdr
op_star
id|ch
suffix:semicolon
id|lp-&gt;transcount
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;master
)paren
(brace
multiline_comment|/* Bundling: If device is a slave-device, deliver to master, also&n;&t;&t; * handle master&squot;s statistics and hangup-timeout&n;&t;&t; */
id|ndev
op_assign
id|lp-&gt;master
suffix:semicolon
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|ndev-&gt;priv
suffix:semicolon
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|lp-&gt;stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|ndev
suffix:semicolon
id|skb-&gt;pkt_type
op_assign
id|PACKET_HOST
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_NET_DUMP
id|isdn_dumppkt
c_func
(paren
l_string|&quot;R:&quot;
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
l_int|40
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|lp-&gt;p_encap
)paren
(brace
r_case
id|ISDN_NET_ENCAP_ETHER
suffix:colon
multiline_comment|/* Ethernet over ISDN */
id|olp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|isdn_net_type_trans
c_func
(paren
id|skb
comma
id|ndev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_NET_ENCAP_UIHDLC
suffix:colon
multiline_comment|/* HDLC with UI-frame (for ispa with -h1 option) */
id|olp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Fall through */
r_case
id|ISDN_NET_ENCAP_RAWIP
suffix:colon
multiline_comment|/* RAW-IP without MAC-Header */
id|olp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_NET_ENCAP_CISCOHDLCK
suffix:colon
id|ch
op_assign
(paren
id|cisco_hdr
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ch-&gt;addr
op_ne
id|CISCO_ADDR_UNICAST
)paren
op_logical_and
(paren
id|ch-&gt;addr
op_ne
id|CISCO_ADDR_BROADCAST
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Unknown Cisco addr 0x%02x&bslash;n&quot;
comma
id|lp-&gt;name
comma
id|ch-&gt;addr
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ch-&gt;ctrl
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Unknown Cisco ctrl 0x%02x&bslash;n&quot;
comma
id|lp-&gt;name
comma
id|ch-&gt;ctrl
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|ntohs
c_func
(paren
id|ch-&gt;type
)paren
)paren
(brace
r_case
id|CISCO_TYPE_INET
suffix:colon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|4
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISCO_TYPE_SLARP
suffix:colon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|4
)paren
suffix:semicolon
id|isdn_net_slarp_in
c_func
(paren
id|olp
comma
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Unknown Cisco type 0x%04x&bslash;n&quot;
comma
id|lp-&gt;name
comma
id|ch-&gt;type
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_NET_ENCAP_CISCOHDLC
suffix:colon
multiline_comment|/* CISCO-HDLC IP with type field and  fake I-frame-header */
id|skb_pull
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Fall through */
r_case
id|ISDN_NET_ENCAP_IPTYP
suffix:colon
multiline_comment|/* IP with type field */
id|olp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
id|skb-&gt;protocol
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
op_amp
(paren
id|skb-&gt;data
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|skb-&gt;data
op_eq
l_int|0xFFFF
)paren
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_802_3
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
r_case
id|ISDN_NET_ENCAP_SYNCPPP
suffix:colon
multiline_comment|/*&n;&t;&t;&t; * If encapsulation is syncppp, don&squot;t reset&n;&t;&t;&t; * huptimer on LCP packets.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|proto
op_ne
id|PPP_LCP
)paren
(brace
id|olp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
)brace
id|isdn_ppp_receive
c_func
(paren
id|lp-&gt;netdev
comma
id|olp
comma
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
(brace
)brace
macro_line|#ifdef CONFIG_ISDN_X25
multiline_comment|/* try if there are generic sync_device receiver routines */
r_if
c_cond
(paren
id|cprot
)paren
r_if
c_cond
(paren
id|cprot
op_member_access_from_pointer
id|pops
)paren
r_if
c_cond
(paren
id|cprot
op_member_access_from_pointer
id|pops
op_member_access_from_pointer
id|data_ind
)paren
(brace
id|cprot
op_member_access_from_pointer
id|pops
op_member_access_from_pointer
id|data_ind
c_func
(paren
id|cprot
comma
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_X25 */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: unknown encapsulation, dropping&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * A packet arrived via ISDN. Search interface-chain for a corresponding&n; * interface. If found, deliver packet to receiver-function and return 1,&n; * else return 0.&n; */
r_int
DECL|function|isdn_net_rcv_skb
id|isdn_net_rcv_skb
c_func
(paren
r_int
id|idx
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|dev-&gt;rx_netdev
(braket
id|idx
)braket
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
id|p-&gt;local
suffix:semicolon
r_if
c_cond
(paren
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
op_logical_and
(paren
op_logical_neg
id|lp-&gt;dialstate
)paren
)paren
(brace
id|isdn_net_receive
c_func
(paren
op_amp
id|p-&gt;dev
comma
id|skb
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|my_eth_header
id|my_eth_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
(brace
r_struct
id|ethhdr
op_star
id|eth
op_assign
(paren
r_struct
id|ethhdr
op_star
)paren
id|skb_push
c_func
(paren
id|skb
comma
id|ETH_HLEN
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set the protocol type. For a packet of type ETH_P_802_3 we&n;&t; * put the length here instead. It is up to the 802.2 layer to&n;&t; * carry protocol information.&n;&t; */
r_if
c_cond
(paren
id|type
op_ne
id|ETH_P_802_3
)paren
id|eth-&gt;h_proto
op_assign
id|htons
c_func
(paren
id|type
)paren
suffix:semicolon
r_else
id|eth-&gt;h_proto
op_assign
id|htons
c_func
(paren
id|len
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set the source hardware address.&n;&t; */
r_if
c_cond
(paren
id|saddr
)paren
id|memcpy
c_func
(paren
id|eth-&gt;h_source
comma
id|saddr
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
r_else
id|memcpy
c_func
(paren
id|eth-&gt;h_source
comma
id|dev-&gt;dev_addr
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Anyway, the loopback-device should never use this function...&n;&t; */
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
(paren
id|IFF_LOOPBACK
op_or
id|IFF_NOARP
)paren
)paren
(brace
id|memset
c_func
(paren
id|eth-&gt;h_dest
comma
l_int|0
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
r_return
id|ETH_HLEN
multiline_comment|/*(dev-&gt;hard_header_len)*/
suffix:semicolon
)brace
r_if
c_cond
(paren
id|daddr
)paren
(brace
id|memcpy
c_func
(paren
id|eth-&gt;h_dest
comma
id|daddr
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
r_return
id|ETH_HLEN
multiline_comment|/*dev-&gt;hard_header_len*/
suffix:semicolon
)brace
r_return
op_minus
id|ETH_HLEN
multiline_comment|/*dev-&gt;hard_header_len*/
suffix:semicolon
)brace
multiline_comment|/*&n; *  build an header&n; *  depends on encaps that is being used.&n; */
r_static
r_int
DECL|function|isdn_net_header
id|isdn_net_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|plen
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|ushort
id|len
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|lp-&gt;p_encap
)paren
(brace
r_case
id|ISDN_NET_ENCAP_ETHER
suffix:colon
id|len
op_assign
id|my_eth_header
c_func
(paren
id|skb
comma
id|dev
comma
id|type
comma
id|daddr
comma
id|saddr
comma
id|plen
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
r_case
id|ISDN_NET_ENCAP_SYNCPPP
suffix:colon
multiline_comment|/* stick on a fake header to keep fragmentation code happy. */
id|len
op_assign
id|IPPP_MAX_HEADER
suffix:semicolon
id|skb_push
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
id|ISDN_NET_ENCAP_RAWIP
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net_header called with RAW_IP!&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_NET_ENCAP_IPTYP
suffix:colon
multiline_comment|/* ethernet type field */
op_star
(paren
(paren
id|ushort
op_star
)paren
id|skb_push
c_func
(paren
id|skb
comma
l_int|2
)paren
)paren
op_assign
id|htons
c_func
(paren
id|type
)paren
suffix:semicolon
id|len
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_NET_ENCAP_UIHDLC
suffix:colon
multiline_comment|/* HDLC with UI-Frames (for ispa with -h1 option) */
op_star
(paren
(paren
id|ushort
op_star
)paren
id|skb_push
c_func
(paren
id|skb
comma
l_int|2
)paren
)paren
op_assign
id|htons
c_func
(paren
l_int|0x0103
)paren
suffix:semicolon
id|len
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_NET_ENCAP_CISCOHDLC
suffix:colon
id|skb_push
c_func
(paren
id|skb
comma
l_int|4
)paren
suffix:semicolon
id|skb-&gt;data
(braket
l_int|0
)braket
op_assign
l_int|0x0f
suffix:semicolon
id|skb-&gt;data
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
op_star
(paren
(paren
id|ushort
op_star
)paren
op_amp
id|skb-&gt;data
(braket
l_int|2
)braket
)paren
op_assign
id|htons
c_func
(paren
id|type
)paren
suffix:semicolon
id|len
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_X25
r_default
suffix:colon
(brace
)brace
multiline_comment|/* try if there are generic concap protocol routines */
r_if
c_cond
(paren
id|lp
op_member_access_from_pointer
id|netdev
op_member_access_from_pointer
id|cprot
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net_header called with concap_proto!&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_X25 */
)brace
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/* We don&squot;t need to send arp, because we have point-to-point connections. */
r_static
r_int
DECL|function|isdn_net_rebuild_header
id|isdn_net_rebuild_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
id|skb-&gt;dev
suffix:semicolon
id|isdn_net_local
op_star
id|lp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_ETHER
)paren
(brace
r_struct
id|ethhdr
op_star
id|eth
op_assign
(paren
r_struct
id|ethhdr
op_star
)paren
id|skb-&gt;data
suffix:semicolon
multiline_comment|/*&n;&t;&t; *      Only ARP/IP is currently supported&n;&t;&t; */
r_if
c_cond
(paren
id|eth-&gt;h_proto
op_ne
id|htons
c_func
(paren
id|ETH_P_IP
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net: %s don&squot;t know how to resolve type %d addresses?&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|eth-&gt;h_proto
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|eth-&gt;h_source
comma
id|dev-&gt;dev_addr
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *      Try to get ARP to resolve the header.&n;&t;&t; */
macro_line|#ifdef CONFIG_INET
id|ret
op_assign
id|arp_find
c_func
(paren
id|eth-&gt;h_dest
comma
id|skb
)paren
suffix:semicolon
macro_line|#endif
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Interface-setup. (called just after registering a new interface)&n; */
r_static
r_int
DECL|function|isdn_net_init
id|isdn_net_init
c_func
(paren
r_struct
id|device
op_star
id|ndev
)paren
(brace
id|ushort
id|max_hlhdr_len
op_assign
l_int|0
suffix:semicolon
id|isdn_net_local
op_star
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|ndev-&gt;priv
suffix:semicolon
r_int
id|drvidx
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
id|ndev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net_init: dev = NULL!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ndev-&gt;priv
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net_init: dev-&gt;priv = NULL!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|ether_setup
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|lp-&gt;org_hhc
op_assign
id|ndev-&gt;hard_header_cache
suffix:semicolon
id|lp-&gt;org_hcu
op_assign
id|ndev-&gt;header_cache_update
suffix:semicolon
multiline_comment|/* Setup the generic properties */
id|ndev-&gt;hard_header
op_assign
l_int|NULL
suffix:semicolon
id|ndev-&gt;hard_header_cache
op_assign
l_int|NULL
suffix:semicolon
id|ndev-&gt;header_cache_update
op_assign
l_int|NULL
suffix:semicolon
id|ndev-&gt;mtu
op_assign
l_int|1500
suffix:semicolon
id|ndev-&gt;flags
op_assign
id|IFF_NOARP
op_or
id|IFF_POINTOPOINT
suffix:semicolon
id|ndev-&gt;type
op_assign
id|ARPHRD_ETHER
suffix:semicolon
id|ndev-&gt;addr_len
op_assign
id|ETH_ALEN
suffix:semicolon
multiline_comment|/* for clients with MPPP maybe higher values better */
id|ndev-&gt;tx_queue_len
op_assign
l_int|30
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ETH_ALEN
suffix:semicolon
id|i
op_increment
)paren
id|ndev-&gt;broadcast
(braket
id|i
)braket
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* The ISDN-specific entries in the device structure. */
id|ndev-&gt;open
op_assign
op_amp
id|isdn_net_open
suffix:semicolon
id|ndev-&gt;hard_start_xmit
op_assign
op_amp
id|isdn_net_start_xmit
suffix:semicolon
multiline_comment|/*&n;&t; *  up till binding we ask the protocol layer to reserve as much&n;&t; *  as we might need for HL layer&n;&t; */
r_for
c_loop
(paren
id|drvidx
op_assign
l_int|0
suffix:semicolon
id|drvidx
OL
id|ISDN_MAX_DRIVERS
suffix:semicolon
id|drvidx
op_increment
)paren
r_if
c_cond
(paren
id|dev-&gt;drv
(braket
id|drvidx
)braket
)paren
r_if
c_cond
(paren
id|max_hlhdr_len
OL
id|dev-&gt;drv
(braket
id|drvidx
)braket
op_member_access_from_pointer
id|interface-&gt;hl_hdrlen
)paren
id|max_hlhdr_len
op_assign
id|dev-&gt;drv
(braket
id|drvidx
)braket
op_member_access_from_pointer
id|interface-&gt;hl_hdrlen
suffix:semicolon
id|ndev-&gt;hard_header_len
op_assign
id|ETH_HLEN
op_plus
id|max_hlhdr_len
suffix:semicolon
id|ndev-&gt;stop
op_assign
op_amp
id|isdn_net_close
suffix:semicolon
id|ndev-&gt;get_stats
op_assign
op_amp
id|isdn_net_get_stats
suffix:semicolon
id|ndev-&gt;rebuild_header
op_assign
op_amp
id|isdn_net_rebuild_header
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
id|ndev-&gt;do_ioctl
op_assign
id|isdn_ppp_dev_ioctl
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|isdn_net_swapbind
id|isdn_net_swapbind
c_func
(paren
r_int
id|drvidx
)paren
(brace
id|isdn_net_dev
op_star
id|p
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: swapping ch of %d&bslash;n&quot;
comma
id|drvidx
)paren
suffix:semicolon
macro_line|#endif
id|p
op_assign
id|dev-&gt;netdev
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;local-&gt;pre_device
op_eq
id|drvidx
)paren
r_switch
c_cond
(paren
id|p-&gt;local-&gt;pre_channel
)paren
(brace
r_case
l_int|0
suffix:colon
id|p-&gt;local-&gt;pre_channel
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|p-&gt;local-&gt;pre_channel
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|p
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|p-&gt;next
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|isdn_net_swap_usage
id|isdn_net_swap_usage
c_func
(paren
r_int
id|i1
comma
r_int
id|i2
)paren
(brace
r_int
id|u1
op_assign
id|dev-&gt;usage
(braket
id|i1
)braket
op_amp
id|ISDN_USAGE_EXCLUSIVE
suffix:semicolon
r_int
id|u2
op_assign
id|dev-&gt;usage
(braket
id|i2
)braket
op_amp
id|ISDN_USAGE_EXCLUSIVE
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: usage of %d and %d&bslash;n&quot;
comma
id|i1
comma
id|i2
)paren
suffix:semicolon
macro_line|#endif
id|dev-&gt;usage
(braket
id|i1
)braket
op_and_assign
op_complement
id|ISDN_USAGE_EXCLUSIVE
suffix:semicolon
id|dev-&gt;usage
(braket
id|i1
)braket
op_or_assign
id|u2
suffix:semicolon
id|dev-&gt;usage
(braket
id|i2
)braket
op_and_assign
op_complement
id|ISDN_USAGE_EXCLUSIVE
suffix:semicolon
id|dev-&gt;usage
(braket
id|i2
)braket
op_or_assign
id|u1
suffix:semicolon
id|isdn_info_update
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * An incoming call-request has arrived.&n; * Search the interface-chain for an appropriate interface.&n; * If found, connect the interface to the ISDN-channel and initiate&n; * D- and B-Channel-setup. If secure-flag is set, accept only&n; * configured phone-numbers. If callback-flag is set, initiate&n; * callback-dialing.&n; *&n; * Return-Value: 0 = No appropriate interface for this call.&n; *               1 = Call accepted&n; *               2 = Reject call, wait cbdelay, then call back&n; *               3 = Reject call&n; *               4 = Wait cbdelay, then call back&n; *               5 = No appropriate interface for this call,&n; *                   would eventually match if CID was longer.&n; */
r_int
DECL|function|isdn_net_find_icall
id|isdn_net_find_icall
c_func
(paren
r_int
id|di
comma
r_int
id|ch
comma
r_int
id|idx
comma
id|setup_parm
id|setup
)paren
(brace
r_char
op_star
id|eaz
suffix:semicolon
r_int
id|si1
suffix:semicolon
r_int
id|si2
suffix:semicolon
r_int
id|ematch
suffix:semicolon
r_int
id|wret
suffix:semicolon
r_int
id|swapped
suffix:semicolon
r_int
id|sidx
op_assign
l_int|0
suffix:semicolon
id|isdn_net_dev
op_star
id|p
suffix:semicolon
id|isdn_net_phone
op_star
id|n
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
r_char
id|nr
(braket
l_int|32
)braket
suffix:semicolon
multiline_comment|/* Search name in netdev-chain */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|setup.phone
(braket
l_int|0
)braket
)paren
(brace
id|nr
(braket
l_int|0
)braket
op_assign
l_char|&squot;0&squot;
suffix:semicolon
id|nr
(braket
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdn_net: Incoming call without OAD, assuming &squot;0&squot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
id|strcpy
c_func
(paren
id|nr
comma
id|setup.phone
)paren
suffix:semicolon
id|si1
op_assign
(paren
r_int
)paren
id|setup.si1
suffix:semicolon
id|si2
op_assign
(paren
r_int
)paren
id|setup.si2
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|setup.eazmsn
(braket
l_int|0
)braket
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net: Incoming call without CPN, assuming &squot;0&squot;&bslash;n&quot;
)paren
suffix:semicolon
id|eaz
op_assign
l_string|&quot;0&quot;
suffix:semicolon
)brace
r_else
id|eaz
op_assign
id|setup.eazmsn
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;net_verbose
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdn_net: call from %s,%d,%d -&gt; %s&bslash;n&quot;
comma
id|nr
comma
id|si1
comma
id|si2
comma
id|eaz
)paren
suffix:semicolon
multiline_comment|/* Accept only calls with Si1 = 7 (Data-Transmission) */
r_if
c_cond
(paren
id|si1
op_ne
l_int|7
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;net_verbose
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdn_net: Service-Indicator not 7, ignored&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|n
op_assign
(paren
id|isdn_net_phone
op_star
)paren
l_int|0
suffix:semicolon
id|p
op_assign
id|dev-&gt;netdev
suffix:semicolon
id|ematch
op_assign
id|wret
op_assign
id|swapped
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: di=%d ch=%d idx=%d usg=%d&bslash;n&quot;
comma
id|di
comma
id|ch
comma
id|idx
comma
id|dev-&gt;usage
(braket
id|idx
)braket
)paren
suffix:semicolon
macro_line|#endif
r_while
c_loop
(paren
id|p
)paren
(brace
r_int
id|matchret
suffix:semicolon
id|isdn_net_local
op_star
id|lp
op_assign
id|p-&gt;local
suffix:semicolon
multiline_comment|/* If last check has triggered as binding-swap, revert it */
r_switch
c_cond
(paren
id|swapped
)paren
(brace
r_case
l_int|2
suffix:colon
id|isdn_net_swap_usage
c_func
(paren
id|idx
comma
id|sidx
)paren
suffix:semicolon
multiline_comment|/* fall through */
r_case
l_int|1
suffix:colon
id|isdn_net_swapbind
c_func
(paren
id|di
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|swapped
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|matchret
op_assign
id|isdn_wildmat
c_func
(paren
id|eaz
comma
id|isdn_map_eaz2msn
c_func
(paren
id|lp-&gt;msn
comma
id|di
)paren
)paren
)paren
)paren
id|ematch
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Remember if more numbers eventually can match */
r_if
c_cond
(paren
id|matchret
OG
id|wret
)paren
id|wret
op_assign
id|matchret
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: if=&squot;%s&squot;, l.msn=%s, l.flags=%d, l.dstate=%d&bslash;n&quot;
comma
id|lp-&gt;name
comma
id|lp-&gt;msn
comma
id|lp-&gt;flags
comma
id|lp-&gt;dialstate
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
op_logical_neg
id|matchret
)paren
op_logical_and
multiline_comment|/* EAZ is matching   */
(paren
(paren
(paren
op_logical_neg
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
)paren
op_logical_and
multiline_comment|/* but not connected */
(paren
id|USG_NONE
c_func
(paren
id|dev-&gt;usage
(braket
id|idx
)braket
)paren
)paren
)paren
op_logical_or
multiline_comment|/* and ch. unused or */
(paren
(paren
(paren
(paren
id|lp-&gt;dialstate
op_eq
l_int|4
)paren
op_logical_or
(paren
id|lp-&gt;dialstate
op_eq
l_int|12
)paren
)paren
op_logical_and
multiline_comment|/* if dialing        */
(paren
op_logical_neg
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CALLBACK
)paren
)paren
)paren
multiline_comment|/* but no callback   */
)paren
)paren
)paren
(brace
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: match1, pdev=%d pch=%d&bslash;n&quot;
comma
id|lp-&gt;pre_device
comma
id|lp-&gt;pre_channel
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|dev-&gt;usage
(braket
id|idx
)braket
op_amp
id|ISDN_USAGE_EXCLUSIVE
)paren
(brace
r_if
c_cond
(paren
(paren
id|lp-&gt;pre_channel
op_ne
id|ch
)paren
op_logical_or
(paren
id|lp-&gt;pre_device
op_ne
id|di
)paren
)paren
(brace
multiline_comment|/* Here we got a problem:&n;&t;&t;&t;&t;&t; * If using an ICN-Card, an incoming call is always signaled on&n;&t;&t;&t;&t;&t; * on the first channel of the card, if both channels are&n;&t;&t;&t;&t;&t; * down. However this channel may be bound exclusive. If the&n;&t;&t;&t;&t;&t; * second channel is free, this call should be accepted.&n;&t;&t;&t;&t;&t; * The solution is horribly but it runs, so what:&n;&t;&t;&t;&t;&t; * We exchange the exclusive bindings of the two channels, the&n;&t;&t;&t;&t;&t; * corresponding variables in the interface-structs.&n;&t;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|ch
op_eq
l_int|0
)paren
(brace
id|sidx
op_assign
id|isdn_dc2minor
c_func
(paren
id|di
comma
l_int|1
)paren
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: ch is 0&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|USG_NONE
c_func
(paren
id|dev-&gt;usage
(braket
id|sidx
)braket
)paren
)paren
(brace
multiline_comment|/* Second Channel is free, now see if it is bound&n;&t;&t;&t;&t;&t;&t;&t; * exclusive too. */
r_if
c_cond
(paren
id|dev-&gt;usage
(braket
id|sidx
)braket
op_amp
id|ISDN_USAGE_EXCLUSIVE
)paren
(brace
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: 2nd channel is down and bound&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Yes, swap bindings only, if the original&n;&t;&t;&t;&t;&t;&t;&t;&t; * binding is bound to channel 1 of this driver */
r_if
c_cond
(paren
(paren
id|lp-&gt;pre_device
op_eq
id|di
)paren
op_logical_and
(paren
id|lp-&gt;pre_channel
op_eq
l_int|1
)paren
)paren
(brace
id|isdn_net_swapbind
c_func
(paren
id|di
)paren
suffix:semicolon
id|swapped
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* ... else iterate next device */
id|p
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|p-&gt;next
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
r_else
(brace
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: 2nd channel is down and unbound&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* No, swap always and swap excl-usage also */
id|isdn_net_swap_usage
c_func
(paren
id|idx
comma
id|sidx
)paren
suffix:semicolon
id|isdn_net_swapbind
c_func
(paren
id|di
)paren
suffix:semicolon
id|swapped
op_assign
l_int|2
suffix:semicolon
)brace
multiline_comment|/* Now check for exclusive binding again */
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: final check&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|dev-&gt;usage
(braket
id|idx
)braket
op_amp
id|ISDN_USAGE_EXCLUSIVE
)paren
op_logical_and
(paren
(paren
id|lp-&gt;pre_channel
op_ne
id|ch
)paren
op_logical_or
(paren
id|lp-&gt;pre_device
op_ne
id|di
)paren
)paren
)paren
(brace
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: final check failed&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|p
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|p-&gt;next
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* We are already on the second channel, so nothing to do */
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: already on 2nd channel&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
)brace
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: match2&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|n
op_assign
id|lp-&gt;phone
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_SECURE
)paren
(brace
r_while
c_loop
(paren
id|n
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|isdn_wildmat
c_func
(paren
id|nr
comma
id|n-&gt;num
)paren
)paren
r_break
suffix:semicolon
id|n
op_assign
(paren
id|isdn_net_phone
op_star
)paren
id|n-&gt;next
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|n
op_logical_or
(paren
op_logical_neg
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_SECURE
)paren
)paren
)paren
(brace
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: match3&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* matching interface found */
multiline_comment|/*&n;&t;&t;&t;&t; * Is the state STOPPED?&n;&t;&t;&t;&t; * If so, no dialin is allowed,&n;&t;&t;&t;&t; * so reject actively.&n;&t;&t;&t;&t; * */
r_if
c_cond
(paren
id|ISDN_NET_DIALMODE
c_func
(paren
op_star
id|lp
)paren
op_eq
id|ISDN_NET_DM_OFF
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;incoming call, interface %s `stopped&squot; -&gt; rejected&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
r_return
l_int|3
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t;&t; * Is the interface up?&n;&t;&t;&t;&t; * If not, reject the call actively.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;dev.start
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: incoming call, interface down -&gt; rejected&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
r_return
l_int|3
suffix:semicolon
)brace
multiline_comment|/* Interface is up, now see if it&squot;s a slave. If so, see if&n;&t;&t;&t;&t; * it&squot;s master and parent slave is online. If not, reject the call.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|lp-&gt;master
)paren
(brace
id|isdn_net_local
op_star
id|mlp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|lp-&gt;master-&gt;priv
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ICALLslv: %s&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;master=%s&bslash;n&quot;
comma
id|mlp-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mlp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;master online&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Master is online, find parent-slave (master if first slave) */
r_while
c_loop
(paren
id|mlp-&gt;slave
)paren
(brace
r_if
c_cond
(paren
(paren
id|isdn_net_local
op_star
)paren
id|mlp-&gt;slave-&gt;priv
op_eq
id|lp
)paren
r_break
suffix:semicolon
id|mlp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|mlp-&gt;slave-&gt;priv
suffix:semicolon
)brace
)brace
r_else
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;master offline&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Found parent, if it&squot;s offline iterate next device */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;mlpf: %d&bslash;n&quot;
comma
id|mlp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mlp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
)paren
(brace
id|p
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|p-&gt;next
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CALLBACK
)paren
(brace
r_int
id|chi
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t; * Is the state MANUAL?&n;&t;&t;&t;&t;&t; * If so, no callback can be made,&n;&t;&t;&t;&t;&t; * so reject actively.&n;&t;&t;&t;&t;&t; * */
r_if
c_cond
(paren
id|ISDN_NET_DIALMODE
c_func
(paren
op_star
id|lp
)paren
op_eq
id|ISDN_NET_DM_OFF
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;incoming call for callback, interface %s `off&squot; -&gt; rejected&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
r_return
l_int|3
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: call from %s -&gt; %s, start callback&bslash;n&quot;
comma
id|lp-&gt;name
comma
id|nr
comma
id|eaz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;phone
(braket
l_int|1
)braket
)paren
(brace
multiline_comment|/* Grab a free ISDN-Channel */
r_if
c_cond
(paren
(paren
id|chi
op_assign
id|isdn_get_free_channel
c_func
(paren
id|ISDN_USAGE_NET
comma
id|lp-&gt;l2_proto
comma
id|lp-&gt;l3_proto
comma
id|lp-&gt;pre_device
comma
id|lp-&gt;pre_channel
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net_find_icall: No channel for %s&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Setup dialstate. */
id|lp-&gt;dtimer
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;dialstate
op_assign
l_int|11
suffix:semicolon
multiline_comment|/* Connect interface with channel */
id|isdn_net_bind_channel
c_func
(paren
id|lp
comma
id|chi
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_SYNCPPP
)paren
r_if
c_cond
(paren
id|isdn_ppp_bind
c_func
(paren
id|lp
)paren
OL
l_int|0
)paren
(brace
id|isdn_net_unbind_channel
c_func
(paren
id|lp
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Initiate dialing by returning 2 or 4 */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CBHUP
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|4
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net: %s: No phone number&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: call from %s -&gt; %s accepted&bslash;n&quot;
comma
id|lp-&gt;name
comma
id|nr
comma
id|eaz
)paren
suffix:semicolon
multiline_comment|/* if this interface is dialing, it does it probably on a different&n;&t;&t;&t;&t;&t;   device, so free this device */
r_if
c_cond
(paren
(paren
id|lp-&gt;dialstate
op_eq
l_int|4
)paren
op_logical_or
(paren
id|lp-&gt;dialstate
op_eq
l_int|12
)paren
)paren
(brace
macro_line|#ifdef CONFIG_ISDN_PPP
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_SYNCPPP
)paren
id|isdn_ppp_free
c_func
(paren
id|lp
)paren
suffix:semicolon
macro_line|#endif
id|isdn_free_channel
c_func
(paren
id|lp-&gt;isdn_device
comma
id|lp-&gt;isdn_channel
comma
id|ISDN_USAGE_NET
)paren
suffix:semicolon
)brace
id|dev-&gt;usage
(braket
id|idx
)braket
op_and_assign
id|ISDN_USAGE_EXCLUSIVE
suffix:semicolon
id|dev-&gt;usage
(braket
id|idx
)braket
op_or_assign
id|ISDN_USAGE_NET
suffix:semicolon
id|strcpy
c_func
(paren
id|dev-&gt;num
(braket
id|idx
)braket
comma
id|nr
)paren
suffix:semicolon
id|isdn_info_update
c_func
(paren
)paren
suffix:semicolon
id|dev-&gt;st_netdev
(braket
id|idx
)braket
op_assign
id|lp-&gt;netdev
suffix:semicolon
id|lp-&gt;isdn_device
op_assign
id|di
suffix:semicolon
id|lp-&gt;isdn_channel
op_assign
id|ch
suffix:semicolon
id|lp-&gt;ppp_slot
op_assign
op_minus
l_int|1
suffix:semicolon
id|lp-&gt;flags
op_or_assign
id|ISDN_NET_CONNECTED
suffix:semicolon
id|lp-&gt;dialstate
op_assign
l_int|7
suffix:semicolon
id|lp-&gt;dtimer
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;outgoing
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;hupflags
op_or_assign
id|ISDN_WAITCHARGE
suffix:semicolon
id|lp-&gt;hupflags
op_and_assign
op_complement
id|ISDN_HAVECHARGE
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_SYNCPPP
)paren
r_if
c_cond
(paren
id|isdn_ppp_bind
c_func
(paren
id|lp
)paren
OL
l_int|0
)paren
(brace
id|isdn_net_unbind_channel
c_func
(paren
id|lp
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
)brace
id|p
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|p-&gt;next
suffix:semicolon
)brace
multiline_comment|/* If none of configured EAZ/MSN matched and not verbose, be silent */
r_if
c_cond
(paren
op_logical_neg
id|ematch
op_logical_or
id|dev-&gt;net_verbose
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdn_net: call from %s -&gt; %d %s ignored&bslash;n&quot;
comma
id|nr
comma
id|di
comma
id|eaz
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
(paren
id|wret
op_eq
l_int|2
)paren
ques
c_cond
l_int|5
suffix:colon
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Search list of net-interfaces for an interface with given name.&n; */
id|isdn_net_dev
op_star
DECL|function|isdn_net_findif
id|isdn_net_findif
c_func
(paren
r_char
op_star
id|name
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|dev-&gt;netdev
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|p-&gt;local-&gt;name
comma
id|name
)paren
)paren
r_return
id|p
suffix:semicolon
id|p
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|p-&gt;next
suffix:semicolon
)brace
r_return
(paren
id|isdn_net_dev
op_star
)paren
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Force a net-interface to dial out.&n; * This is called from the userlevel-routine below or&n; * from isdn_net_start_xmit().&n; */
r_int
DECL|function|isdn_net_force_dial_lp
id|isdn_net_force_dial_lp
c_func
(paren
id|isdn_net_local
op_star
id|lp
)paren
(brace
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
)paren
op_logical_and
op_logical_neg
id|lp-&gt;dialstate
)paren
(brace
r_int
id|chi
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;phone
(braket
l_int|1
)braket
)paren
(brace
id|ulong
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Grab a free ISDN-Channel */
r_if
c_cond
(paren
(paren
id|chi
op_assign
id|isdn_get_free_channel
c_func
(paren
id|ISDN_USAGE_NET
comma
id|lp-&gt;l2_proto
comma
id|lp-&gt;l3_proto
comma
id|lp-&gt;pre_device
comma
id|lp-&gt;pre_channel
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net_force_dial: No channel for %s&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|lp-&gt;dialstate
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Connect interface with channel */
id|isdn_net_bind_channel
c_func
(paren
id|lp
comma
id|chi
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_SYNCPPP
)paren
r_if
c_cond
(paren
id|isdn_ppp_bind
c_func
(paren
id|lp
)paren
OL
l_int|0
)paren
(brace
id|isdn_net_unbind_channel
c_func
(paren
id|lp
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Initiate dialing */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|isdn_net_dial
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/*&n; * This is called from certain upper protocol layers (multilink ppp&n; * and x25iface encapsulation module) that want to initiate dialing&n; * themselves.&n; */
r_int
DECL|function|isdn_net_dial_req
id|isdn_net_dial_req
c_func
(paren
id|isdn_net_local
op_star
id|lp
)paren
(brace
multiline_comment|/* is there a better error code? */
r_if
c_cond
(paren
op_logical_neg
(paren
id|ISDN_NET_DIALMODE
c_func
(paren
op_star
id|lp
)paren
op_eq
id|ISDN_NET_DM_AUTO
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_return
id|isdn_net_force_dial_lp
c_func
(paren
id|lp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Force a net-interface to dial out.&n; * This is always called from within userspace (ISDN_IOCTL_NET_DIAL).&n; */
r_int
DECL|function|isdn_net_force_dial
id|isdn_net_force_dial
c_func
(paren
r_char
op_star
id|name
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|isdn_net_findif
c_func
(paren
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
(paren
id|isdn_net_force_dial_lp
c_func
(paren
id|p-&gt;local
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Allocate a new network-interface and initialize its data structures.&n; */
r_char
op_star
DECL|function|isdn_net_new
id|isdn_net_new
c_func
(paren
r_char
op_star
id|name
comma
r_struct
id|device
op_star
id|master
)paren
(brace
id|isdn_net_dev
op_star
id|netdev
suffix:semicolon
multiline_comment|/* Avoid creating an existing interface */
r_if
c_cond
(paren
id|isdn_net_findif
c_func
(paren
id|name
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net: interface %s already exists&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|netdev
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|isdn_net_dev
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net: Could not allocate net-device&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|netdev
comma
l_int|0
comma
r_sizeof
(paren
id|isdn_net_dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|netdev-&gt;local
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|isdn_net_local
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net: Could not allocate device locals&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|netdev-&gt;local
comma
l_int|0
comma
r_sizeof
(paren
id|isdn_net_local
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|name
op_eq
l_int|NULL
)paren
id|strcpy
c_func
(paren
id|netdev-&gt;local-&gt;name
comma
l_string|&quot;         &quot;
)paren
suffix:semicolon
r_else
id|strcpy
c_func
(paren
id|netdev-&gt;local-&gt;name
comma
id|name
)paren
suffix:semicolon
id|netdev-&gt;dev.name
op_assign
id|netdev-&gt;local-&gt;name
suffix:semicolon
id|netdev-&gt;dev.priv
op_assign
id|netdev-&gt;local
suffix:semicolon
id|netdev-&gt;dev.init
op_assign
id|isdn_net_init
suffix:semicolon
id|netdev-&gt;local-&gt;p_encap
op_assign
id|ISDN_NET_ENCAP_RAWIP
suffix:semicolon
r_if
c_cond
(paren
id|master
)paren
(brace
multiline_comment|/* Device shall be a slave */
r_struct
id|device
op_star
id|p
op_assign
(paren
(paren
(paren
id|isdn_net_local
op_star
)paren
id|master-&gt;priv
)paren
op_member_access_from_pointer
id|slave
)paren
suffix:semicolon
r_struct
id|device
op_star
id|q
op_assign
id|master
suffix:semicolon
id|netdev-&gt;local-&gt;master
op_assign
id|master
suffix:semicolon
multiline_comment|/* Put device at end of slave-chain */
r_while
c_loop
(paren
id|p
)paren
(brace
id|q
op_assign
id|p
suffix:semicolon
id|p
op_assign
(paren
(paren
(paren
id|isdn_net_local
op_star
)paren
id|p-&gt;priv
)paren
op_member_access_from_pointer
id|slave
)paren
suffix:semicolon
)brace
(paren
(paren
id|isdn_net_local
op_star
)paren
id|q-&gt;priv
)paren
op_member_access_from_pointer
id|slave
op_assign
op_amp
(paren
id|netdev-&gt;dev
)paren
suffix:semicolon
id|q-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|q-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|q-&gt;start
op_assign
id|master-&gt;start
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Device shall be a master */
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
op_amp
id|netdev-&gt;dev
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net: Could not register net-device&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|netdev-&gt;local
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|netdev
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
id|netdev-&gt;local-&gt;magic
op_assign
id|ISDN_NET_MAGIC
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
id|netdev-&gt;mp_last
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* mpqueue is empty */
id|netdev-&gt;ib.next_num
op_assign
l_int|0
suffix:semicolon
id|netdev-&gt;ib.last
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
id|netdev-&gt;queue
op_assign
id|netdev-&gt;local
suffix:semicolon
id|netdev-&gt;local-&gt;last
op_assign
id|netdev-&gt;local
suffix:semicolon
id|netdev-&gt;local-&gt;netdev
op_assign
id|netdev
suffix:semicolon
id|netdev-&gt;local-&gt;next
op_assign
id|netdev-&gt;local
suffix:semicolon
id|netdev-&gt;local-&gt;isdn_device
op_assign
op_minus
l_int|1
suffix:semicolon
id|netdev-&gt;local-&gt;isdn_channel
op_assign
op_minus
l_int|1
suffix:semicolon
id|netdev-&gt;local-&gt;pre_device
op_assign
op_minus
l_int|1
suffix:semicolon
id|netdev-&gt;local-&gt;pre_channel
op_assign
op_minus
l_int|1
suffix:semicolon
id|netdev-&gt;local-&gt;exclusive
op_assign
op_minus
l_int|1
suffix:semicolon
id|netdev-&gt;local-&gt;ppp_slot
op_assign
op_minus
l_int|1
suffix:semicolon
id|netdev-&gt;local-&gt;pppbind
op_assign
op_minus
l_int|1
suffix:semicolon
id|netdev-&gt;local-&gt;sav_skb
op_assign
l_int|NULL
suffix:semicolon
id|netdev-&gt;local-&gt;first_skb
op_assign
l_int|NULL
suffix:semicolon
id|netdev-&gt;local-&gt;l2_proto
op_assign
id|ISDN_PROTO_L2_X75I
suffix:semicolon
id|netdev-&gt;local-&gt;l3_proto
op_assign
id|ISDN_PROTO_L3_TRANS
suffix:semicolon
id|netdev-&gt;local-&gt;triggercps
op_assign
l_int|6000
suffix:semicolon
id|netdev-&gt;local-&gt;slavedelay
op_assign
l_int|10
op_star
id|HZ
suffix:semicolon
id|netdev-&gt;local-&gt;srobin
op_assign
op_amp
id|netdev-&gt;dev
suffix:semicolon
id|netdev-&gt;local-&gt;hupflags
op_assign
id|ISDN_INHUP
suffix:semicolon
multiline_comment|/* Do hangup even on incoming calls */
id|netdev-&gt;local-&gt;onhtime
op_assign
l_int|10
suffix:semicolon
multiline_comment|/* Default hangup-time for saving costs&n;&t;   of those who forget configuring this */
id|netdev-&gt;local-&gt;dialmax
op_assign
l_int|1
suffix:semicolon
id|netdev-&gt;local-&gt;flags
op_assign
id|ISDN_NET_CBHUP
op_or
id|ISDN_NET_DM_MANUAL
suffix:semicolon
multiline_comment|/* Hangup before Callback, manual dial */
id|netdev-&gt;local-&gt;cbdelay
op_assign
l_int|25
suffix:semicolon
multiline_comment|/* Wait 5 secs before Callback */
id|netdev-&gt;local-&gt;dialtimeout
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Infinite Dial-Timeout */
id|netdev-&gt;local-&gt;dialwait
op_assign
l_int|5
op_star
id|HZ
suffix:semicolon
multiline_comment|/* Wait 5 sec. after failed dial */
id|netdev-&gt;local-&gt;dialstarted
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Jiffies of last dial-start */
id|netdev-&gt;local-&gt;dialwait_timer
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Jiffies of earliest next dial-start */
multiline_comment|/* Put into to netdev-chain */
id|netdev-&gt;next
op_assign
(paren
r_void
op_star
)paren
id|dev-&gt;netdev
suffix:semicolon
id|dev-&gt;netdev
op_assign
id|netdev
suffix:semicolon
r_return
id|netdev-&gt;dev.name
suffix:semicolon
)brace
r_char
op_star
DECL|function|isdn_net_newslave
id|isdn_net_newslave
c_func
(paren
r_char
op_star
id|parm
)paren
(brace
r_char
op_star
id|p
op_assign
id|strchr
c_func
(paren
id|parm
comma
l_char|&squot;,&squot;
)paren
suffix:semicolon
id|isdn_net_dev
op_star
id|n
suffix:semicolon
r_char
id|newname
(braket
l_int|10
)braket
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
multiline_comment|/* Slave-Name MUST not be empty */
r_if
c_cond
(paren
op_logical_neg
id|strlen
c_func
(paren
id|p
op_plus
l_int|1
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
id|strcpy
c_func
(paren
id|newname
comma
id|p
op_plus
l_int|1
)paren
suffix:semicolon
op_star
id|p
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Master must already exist */
r_if
c_cond
(paren
op_logical_neg
(paren
id|n
op_assign
id|isdn_net_findif
c_func
(paren
id|parm
)paren
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* Master must be a real interface, not a slave */
r_if
c_cond
(paren
id|n-&gt;local-&gt;master
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* Master must not be started yet */
r_if
c_cond
(paren
id|n-&gt;dev.start
)paren
r_return
l_int|NULL
suffix:semicolon
r_return
(paren
id|isdn_net_new
c_func
(paren
id|newname
comma
op_amp
(paren
id|n-&gt;dev
)paren
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Set interface-parameters.&n; * Always set all parameters, so the user-level application is responsible&n; * for not overwriting existing setups. It has to get the current&n; * setup first, if only selected parameters are to be changed.&n; */
r_int
DECL|function|isdn_net_setcfg
id|isdn_net_setcfg
c_func
(paren
id|isdn_net_ioctl_cfg
op_star
id|cfg
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|isdn_net_findif
c_func
(paren
id|cfg-&gt;name
)paren
suffix:semicolon
id|ulong
id|features
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|drvidx
suffix:semicolon
r_int
id|chidx
suffix:semicolon
r_char
id|drvid
(braket
l_int|25
)braket
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_X25
id|ulong
id|flags
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|p
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
id|p-&gt;local
suffix:semicolon
multiline_comment|/* See if any registered driver supports the features we want */
id|features
op_assign
(paren
(paren
l_int|1
op_lshift
id|cfg-&gt;l2_proto
)paren
op_lshift
id|ISDN_FEATURE_L2_SHIFT
)paren
op_or
(paren
(paren
l_int|1
op_lshift
id|cfg-&gt;l3_proto
)paren
op_lshift
id|ISDN_FEATURE_L3_SHIFT
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_MAX_DRIVERS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|dev-&gt;drv
(braket
id|i
)braket
)paren
r_if
c_cond
(paren
(paren
id|dev-&gt;drv
(braket
id|i
)braket
op_member_access_from_pointer
id|interface-&gt;features
op_amp
id|features
)paren
op_eq
id|features
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|ISDN_MAX_DRIVERS
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net: No driver with selected features&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_ne
id|cfg-&gt;p_encap
)paren
(brace
macro_line|#ifdef CONFIG_ISDN_X25
r_struct
id|concap_proto
op_star
id|cprot
op_assign
id|p
op_member_access_from_pointer
id|cprot
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|p-&gt;dev.start
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: cannot change encap when if is up&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ISDN_X25
multiline_comment|/* delete old encapsulation protocol if present ... */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* avoid races with incoming events trying to&n;&t;&t;&t;&t;  call cprot-&gt;pops methods */
r_if
c_cond
(paren
id|cprot
op_logical_and
id|cprot
op_member_access_from_pointer
id|pops
)paren
(brace
id|cprot
op_member_access_from_pointer
id|pops
op_member_access_from_pointer
id|proto_del
(paren
id|cprot
)paren
suffix:semicolon
)brace
id|p
op_member_access_from_pointer
id|cprot
op_assign
l_int|NULL
suffix:semicolon
id|lp
op_member_access_from_pointer
id|dops
op_assign
l_int|NULL
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* ... ,  prepare for configuration of new one ... */
r_switch
c_cond
(paren
id|cfg
op_member_access_from_pointer
id|p_encap
)paren
(brace
r_case
id|ISDN_NET_ENCAP_X25IFACE
suffix:colon
id|lp
op_member_access_from_pointer
id|dops
op_assign
op_amp
id|isdn_concap_reliable_dl_dops
suffix:semicolon
)brace
multiline_comment|/* ... and allocate new one ... */
id|p
op_member_access_from_pointer
id|cprot
op_assign
id|isdn_concap_new
c_func
(paren
id|cfg
op_member_access_from_pointer
id|p_encap
)paren
suffix:semicolon
multiline_comment|/* p -&gt; cprot == NULL now if p_encap is not supported&n;&t;&t;&t;   by means of the concap_proto mechanism */
multiline_comment|/* the protocol is not configured yet; this will&n;&t;&t;&t;   happen later when isdn_net_reset() is called */
macro_line|#endif
)brace
r_switch
c_cond
(paren
id|cfg-&gt;p_encap
)paren
(brace
r_case
id|ISDN_NET_ENCAP_SYNCPPP
suffix:colon
macro_line|#ifndef CONFIG_ISDN_PPP
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: SyncPPP support not configured&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
macro_line|#else
id|p-&gt;dev.type
op_assign
id|ARPHRD_PPP
suffix:semicolon
multiline_comment|/* change ARP type */
id|p-&gt;dev.addr_len
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|ISDN_NET_ENCAP_X25IFACE
suffix:colon
macro_line|#ifndef CONFIG_ISDN_X25
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: isdn-x25 support not configured&bslash;n&quot;
comma
id|p-&gt;local-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
macro_line|#else
id|p-&gt;dev.type
op_assign
id|ARPHRD_X25
suffix:semicolon
multiline_comment|/* change ARP type */
id|p-&gt;dev.addr_len
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|cfg-&gt;p_encap
op_ge
l_int|0
op_logical_and
id|cfg-&gt;p_encap
op_le
id|ISDN_NET_ENCAP_MAX_ENCAP
)paren
(brace
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: encapsulation protocol %d not supported&bslash;n&quot;
comma
id|p-&gt;local-&gt;name
comma
id|cfg-&gt;p_encap
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|cfg-&gt;drvid
)paren
)paren
(brace
multiline_comment|/* A bind has been requested ... */
r_char
op_star
id|c
comma
op_star
id|e
suffix:semicolon
id|drvidx
op_assign
op_minus
l_int|1
suffix:semicolon
id|chidx
op_assign
op_minus
l_int|1
suffix:semicolon
id|strcpy
c_func
(paren
id|drvid
comma
id|cfg-&gt;drvid
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|c
op_assign
id|strchr
c_func
(paren
id|drvid
comma
l_char|&squot;,&squot;
)paren
)paren
)paren
(brace
multiline_comment|/* The channel-number is appended to the driver-Id with a comma */
id|chidx
op_assign
(paren
r_int
)paren
id|simple_strtoul
c_func
(paren
id|c
op_plus
l_int|1
comma
op_amp
id|e
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|e
op_eq
id|c
)paren
id|chidx
op_assign
op_minus
l_int|1
suffix:semicolon
op_star
id|c
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_MAX_DRIVERS
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* Lookup driver-Id in array */
r_if
c_cond
(paren
op_logical_neg
(paren
id|strcmp
c_func
(paren
id|dev-&gt;drvid
(braket
id|i
)braket
comma
id|drvid
)paren
)paren
)paren
(brace
id|drvidx
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|drvidx
op_eq
op_minus
l_int|1
)paren
op_logical_or
(paren
id|chidx
op_eq
op_minus
l_int|1
)paren
)paren
multiline_comment|/* Either driver-Id or channel-number invalid */
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Parameters are valid, so get them */
id|drvidx
op_assign
id|lp-&gt;pre_device
suffix:semicolon
id|chidx
op_assign
id|lp-&gt;pre_channel
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cfg-&gt;exclusive
OG
l_int|0
)paren
(brace
r_int
id|flags
suffix:semicolon
multiline_comment|/* If binding is exclusive, try to grab the channel */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|isdn_get_free_channel
c_func
(paren
id|ISDN_USAGE_NET
comma
id|lp-&gt;l2_proto
comma
id|lp-&gt;l3_proto
comma
id|drvidx
comma
id|chidx
)paren
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* Grab failed, because desired channel is in use */
id|lp-&gt;exclusive
op_assign
op_minus
l_int|1
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* All went ok, so update isdninfo */
id|dev-&gt;usage
(braket
id|i
)braket
op_assign
id|ISDN_USAGE_EXCLUSIVE
suffix:semicolon
id|isdn_info_update
c_func
(paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|lp-&gt;exclusive
op_assign
id|i
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Non-exclusive binding or unbind. */
id|lp-&gt;exclusive
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|lp-&gt;pre_device
op_ne
op_minus
l_int|1
)paren
op_logical_and
(paren
id|cfg-&gt;exclusive
op_eq
op_minus
l_int|1
)paren
)paren
(brace
id|isdn_unexclusive_channel
c_func
(paren
id|lp-&gt;pre_device
comma
id|lp-&gt;pre_channel
)paren
suffix:semicolon
id|isdn_free_channel
c_func
(paren
id|lp-&gt;pre_device
comma
id|lp-&gt;pre_channel
comma
id|ISDN_USAGE_NET
)paren
suffix:semicolon
id|drvidx
op_assign
op_minus
l_int|1
suffix:semicolon
id|chidx
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
)brace
id|strcpy
c_func
(paren
id|lp-&gt;msn
comma
id|cfg-&gt;eaz
)paren
suffix:semicolon
id|lp-&gt;pre_device
op_assign
id|drvidx
suffix:semicolon
id|lp-&gt;pre_channel
op_assign
id|chidx
suffix:semicolon
id|lp-&gt;onhtime
op_assign
id|cfg-&gt;onhtime
suffix:semicolon
id|lp-&gt;charge
op_assign
id|cfg-&gt;charge
suffix:semicolon
id|lp-&gt;l2_proto
op_assign
id|cfg-&gt;l2_proto
suffix:semicolon
id|lp-&gt;l3_proto
op_assign
id|cfg-&gt;l3_proto
suffix:semicolon
id|lp-&gt;cbdelay
op_assign
id|cfg-&gt;cbdelay
suffix:semicolon
id|lp-&gt;dialmax
op_assign
id|cfg-&gt;dialmax
suffix:semicolon
id|lp-&gt;triggercps
op_assign
id|cfg-&gt;triggercps
suffix:semicolon
id|lp-&gt;slavedelay
op_assign
id|cfg-&gt;slavedelay
op_star
id|HZ
suffix:semicolon
id|lp-&gt;pppbind
op_assign
id|cfg-&gt;pppbind
suffix:semicolon
id|lp-&gt;dialtimeout
op_assign
id|cfg-&gt;dialtimeout
op_ge
l_int|0
ques
c_cond
id|cfg-&gt;dialtimeout
op_star
id|HZ
suffix:colon
op_minus
l_int|1
suffix:semicolon
id|lp-&gt;dialwait
op_assign
id|cfg-&gt;dialwait
op_star
id|HZ
suffix:semicolon
r_if
c_cond
(paren
id|cfg-&gt;secure
)paren
id|lp-&gt;flags
op_or_assign
id|ISDN_NET_SECURE
suffix:semicolon
r_else
id|lp-&gt;flags
op_and_assign
op_complement
id|ISDN_NET_SECURE
suffix:semicolon
r_if
c_cond
(paren
id|cfg-&gt;cbhup
)paren
id|lp-&gt;flags
op_or_assign
id|ISDN_NET_CBHUP
suffix:semicolon
r_else
id|lp-&gt;flags
op_and_assign
op_complement
id|ISDN_NET_CBHUP
suffix:semicolon
r_switch
c_cond
(paren
id|cfg-&gt;callback
)paren
(brace
r_case
l_int|0
suffix:colon
id|lp-&gt;flags
op_and_assign
op_complement
(paren
id|ISDN_NET_CALLBACK
op_or
id|ISDN_NET_CBOUT
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|lp-&gt;flags
op_or_assign
id|ISDN_NET_CALLBACK
suffix:semicolon
id|lp-&gt;flags
op_and_assign
op_complement
id|ISDN_NET_CBOUT
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|lp-&gt;flags
op_or_assign
id|ISDN_NET_CBOUT
suffix:semicolon
id|lp-&gt;flags
op_and_assign
op_complement
id|ISDN_NET_CALLBACK
suffix:semicolon
r_break
suffix:semicolon
)brace
id|lp-&gt;flags
op_and_assign
op_complement
id|ISDN_NET_DIALMODE_MASK
suffix:semicolon
multiline_comment|/* first all bits off */
r_if
c_cond
(paren
id|cfg-&gt;dialmode
op_logical_and
op_logical_neg
(paren
id|cfg-&gt;dialmode
op_amp
id|ISDN_NET_DIALMODE_MASK
)paren
)paren
(brace
multiline_comment|/* old isdnctrl version, where only 0 or 1 is given */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Old isdnctrl version detected! Please update.&bslash;n&quot;
)paren
suffix:semicolon
id|lp-&gt;flags
op_or_assign
id|ISDN_NET_DM_OFF
suffix:semicolon
multiline_comment|/* turn on `off&squot; bit */
)brace
r_else
(brace
id|lp-&gt;flags
op_or_assign
id|cfg-&gt;dialmode
suffix:semicolon
multiline_comment|/* turn on selected bits */
)brace
r_if
c_cond
(paren
id|cfg-&gt;chargehup
)paren
id|lp-&gt;hupflags
op_or_assign
id|ISDN_CHARGEHUP
suffix:semicolon
r_else
id|lp-&gt;hupflags
op_and_assign
op_complement
id|ISDN_CHARGEHUP
suffix:semicolon
r_if
c_cond
(paren
id|cfg-&gt;ihup
)paren
id|lp-&gt;hupflags
op_or_assign
id|ISDN_INHUP
suffix:semicolon
r_else
id|lp-&gt;hupflags
op_and_assign
op_complement
id|ISDN_INHUP
suffix:semicolon
r_if
c_cond
(paren
id|cfg-&gt;chargeint
OG
l_int|10
)paren
(brace
id|lp-&gt;hupflags
op_or_assign
id|ISDN_CHARGEHUP
op_or
id|ISDN_HAVECHARGE
op_or
id|ISDN_MANCHARGE
suffix:semicolon
id|lp-&gt;chargeint
op_assign
id|cfg-&gt;chargeint
op_star
id|HZ
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cfg-&gt;p_encap
op_ne
id|lp-&gt;p_encap
)paren
(brace
r_if
c_cond
(paren
id|cfg-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_RAWIP
)paren
(brace
id|p-&gt;dev.hard_header
op_assign
l_int|NULL
suffix:semicolon
id|p-&gt;dev.hard_header_cache
op_assign
l_int|NULL
suffix:semicolon
id|p-&gt;dev.header_cache_update
op_assign
l_int|NULL
suffix:semicolon
id|p-&gt;dev.flags
op_assign
id|IFF_NOARP
op_or
id|IFF_POINTOPOINT
suffix:semicolon
)brace
r_else
(brace
id|p-&gt;dev.hard_header
op_assign
id|isdn_net_header
suffix:semicolon
r_if
c_cond
(paren
id|cfg-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_ETHER
)paren
(brace
id|p-&gt;dev.hard_header_cache
op_assign
id|lp-&gt;org_hhc
suffix:semicolon
id|p-&gt;dev.header_cache_update
op_assign
id|lp-&gt;org_hcu
suffix:semicolon
id|p-&gt;dev.flags
op_assign
id|IFF_BROADCAST
op_or
id|IFF_MULTICAST
suffix:semicolon
)brace
r_else
(brace
id|p-&gt;dev.hard_header_cache
op_assign
l_int|NULL
suffix:semicolon
id|p-&gt;dev.header_cache_update
op_assign
l_int|NULL
suffix:semicolon
id|p-&gt;dev.flags
op_assign
id|IFF_NOARP
op_or
id|IFF_POINTOPOINT
suffix:semicolon
)brace
)brace
)brace
id|lp-&gt;p_encap
op_assign
id|cfg-&gt;p_encap
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n; * Perform get-interface-parameters.ioctl&n; */
r_int
DECL|function|isdn_net_getcfg
id|isdn_net_getcfg
c_func
(paren
id|isdn_net_ioctl_cfg
op_star
id|cfg
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|isdn_net_findif
c_func
(paren
id|cfg-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
id|p-&gt;local
suffix:semicolon
id|strcpy
c_func
(paren
id|cfg-&gt;eaz
comma
id|lp-&gt;msn
)paren
suffix:semicolon
id|cfg-&gt;exclusive
op_assign
id|lp-&gt;exclusive
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;pre_device
op_ge
l_int|0
)paren
(brace
id|sprintf
c_func
(paren
id|cfg-&gt;drvid
comma
l_string|&quot;%s,%d&quot;
comma
id|dev-&gt;drvid
(braket
id|lp-&gt;pre_device
)braket
comma
id|lp-&gt;pre_channel
)paren
suffix:semicolon
)brace
r_else
id|cfg-&gt;drvid
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|cfg-&gt;onhtime
op_assign
id|lp-&gt;onhtime
suffix:semicolon
id|cfg-&gt;charge
op_assign
id|lp-&gt;charge
suffix:semicolon
id|cfg-&gt;l2_proto
op_assign
id|lp-&gt;l2_proto
suffix:semicolon
id|cfg-&gt;l3_proto
op_assign
id|lp-&gt;l3_proto
suffix:semicolon
id|cfg-&gt;p_encap
op_assign
id|lp-&gt;p_encap
suffix:semicolon
id|cfg-&gt;secure
op_assign
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_SECURE
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|cfg-&gt;callback
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CALLBACK
)paren
id|cfg-&gt;callback
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CBOUT
)paren
id|cfg-&gt;callback
op_assign
l_int|2
suffix:semicolon
id|cfg-&gt;cbhup
op_assign
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CBHUP
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|cfg-&gt;dialmode
op_assign
id|lp-&gt;flags
op_amp
id|ISDN_NET_DIALMODE_MASK
suffix:semicolon
id|cfg-&gt;chargehup
op_assign
(paren
id|lp-&gt;hupflags
op_amp
l_int|4
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|cfg-&gt;ihup
op_assign
(paren
id|lp-&gt;hupflags
op_amp
l_int|8
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|cfg-&gt;cbdelay
op_assign
id|lp-&gt;cbdelay
suffix:semicolon
id|cfg-&gt;dialmax
op_assign
id|lp-&gt;dialmax
suffix:semicolon
id|cfg-&gt;triggercps
op_assign
id|lp-&gt;triggercps
suffix:semicolon
id|cfg-&gt;slavedelay
op_assign
id|lp-&gt;slavedelay
op_div
id|HZ
suffix:semicolon
id|cfg-&gt;chargeint
op_assign
(paren
id|lp-&gt;hupflags
op_amp
id|ISDN_CHARGEHUP
)paren
ques
c_cond
(paren
id|lp-&gt;chargeint
op_div
id|HZ
)paren
suffix:colon
l_int|0
suffix:semicolon
id|cfg-&gt;pppbind
op_assign
id|lp-&gt;pppbind
suffix:semicolon
id|cfg-&gt;dialtimeout
op_assign
id|lp-&gt;dialtimeout
op_ge
l_int|0
ques
c_cond
id|lp-&gt;dialtimeout
op_div
id|HZ
suffix:colon
op_minus
l_int|1
suffix:semicolon
id|cfg-&gt;dialwait
op_assign
id|lp-&gt;dialwait
op_div
id|HZ
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;slave
)paren
id|strcpy
c_func
(paren
id|cfg-&gt;slave
comma
(paren
(paren
id|isdn_net_local
op_star
)paren
id|lp-&gt;slave-&gt;priv
)paren
op_member_access_from_pointer
id|name
)paren
suffix:semicolon
r_else
id|cfg-&gt;slave
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;master
)paren
id|strcpy
c_func
(paren
id|cfg-&gt;master
comma
(paren
(paren
id|isdn_net_local
op_star
)paren
id|lp-&gt;master-&gt;priv
)paren
op_member_access_from_pointer
id|name
)paren
suffix:semicolon
r_else
id|cfg-&gt;master
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n; * Add a phone-number to an interface.&n; */
r_int
DECL|function|isdn_net_addphone
id|isdn_net_addphone
c_func
(paren
id|isdn_net_ioctl_phone
op_star
id|phone
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|isdn_net_findif
c_func
(paren
id|phone-&gt;name
)paren
suffix:semicolon
id|isdn_net_phone
op_star
id|n
suffix:semicolon
r_if
c_cond
(paren
id|isdn_net_checkwild
c_func
(paren
id|phone-&gt;phone
)paren
op_logical_and
(paren
id|phone-&gt;outgoing
op_amp
l_int|1
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|n
op_assign
(paren
id|isdn_net_phone
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|isdn_net_phone
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|strcpy
c_func
(paren
id|n-&gt;num
comma
id|phone-&gt;phone
)paren
suffix:semicolon
id|n-&gt;next
op_assign
id|p-&gt;local-&gt;phone
(braket
id|phone-&gt;outgoing
op_amp
l_int|1
)braket
suffix:semicolon
id|p-&gt;local-&gt;phone
(braket
id|phone-&gt;outgoing
op_amp
l_int|1
)braket
op_assign
id|n
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n; * Copy a string of all phone-numbers of an interface to user space.&n; * This might sleep and must be called with the isdn semaphore down.&n; */
r_int
DECL|function|isdn_net_getphones
id|isdn_net_getphones
c_func
(paren
id|isdn_net_ioctl_phone
op_star
id|phone
comma
r_char
op_star
id|phones
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|isdn_net_findif
c_func
(paren
id|phone-&gt;name
)paren
suffix:semicolon
r_int
id|inout
op_assign
id|phone-&gt;outgoing
op_amp
l_int|1
suffix:semicolon
r_int
id|more
op_assign
l_int|0
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
id|isdn_net_phone
op_star
id|n
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|inout
op_and_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
id|p-&gt;local-&gt;phone
(braket
id|inout
)braket
suffix:semicolon
id|n
suffix:semicolon
id|n
op_assign
id|n-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|more
)paren
(brace
id|put_user
c_func
(paren
l_char|&squot; &squot;
comma
id|phones
op_increment
)paren
suffix:semicolon
id|count
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|phones
comma
id|n-&gt;num
comma
id|strlen
c_func
(paren
id|n-&gt;num
)paren
op_plus
l_int|1
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|phones
op_add_assign
id|strlen
c_func
(paren
id|n-&gt;num
)paren
suffix:semicolon
id|count
op_add_assign
id|strlen
c_func
(paren
id|n-&gt;num
)paren
suffix:semicolon
id|more
op_assign
l_int|1
suffix:semicolon
)brace
id|put_user
c_func
(paren
l_int|0
comma
id|phones
)paren
suffix:semicolon
id|count
op_increment
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/*&n; * Copy a string containing the peer&squot;s phone number of a connected interface&n; * to user space.&n; */
r_int
DECL|function|isdn_net_getpeer
id|isdn_net_getpeer
c_func
(paren
id|isdn_net_ioctl_phone
op_star
id|phone
comma
id|isdn_net_ioctl_phone
op_star
id|peer
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|isdn_net_findif
c_func
(paren
id|phone-&gt;name
)paren
suffix:semicolon
r_int
id|ch
comma
id|dv
comma
id|idx
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/*&n;&t; * Theoretical race: while this executes, the remote number might&n;&t; * become invalid (hang up) or change (new connection), resulting&n;         * in (partially) wrong number copied to user. This race&n;&t; * currently ignored.&n;&t; */
id|ch
op_assign
id|p-&gt;local-&gt;isdn_channel
suffix:semicolon
id|dv
op_assign
id|p-&gt;local-&gt;isdn_device
suffix:semicolon
r_if
c_cond
(paren
id|ch
OL
l_int|0
op_logical_and
id|dv
OL
l_int|0
)paren
(brace
r_return
op_minus
id|ENOTCONN
suffix:semicolon
)brace
id|idx
op_assign
id|isdn_dc2minor
c_func
(paren
id|dv
comma
id|ch
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idx
OL
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* for pre-bound channels, we need this extra check */
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|dev-&gt;num
(braket
id|idx
)braket
comma
l_string|&quot;???&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|ENOTCONN
suffix:semicolon
id|strncpy
c_func
(paren
id|phone-&gt;phone
comma
id|dev-&gt;num
(braket
id|idx
)braket
comma
id|ISDN_MSNLEN
)paren
suffix:semicolon
id|phone-&gt;outgoing
op_assign
id|USG_OUTGOING
c_func
(paren
id|idx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|peer
comma
id|phone
comma
r_sizeof
(paren
op_star
id|peer
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Delete a phone-number from an interface.&n; */
r_int
DECL|function|isdn_net_delphone
id|isdn_net_delphone
c_func
(paren
id|isdn_net_ioctl_phone
op_star
id|phone
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|isdn_net_findif
c_func
(paren
id|phone-&gt;name
)paren
suffix:semicolon
r_int
id|inout
op_assign
id|phone-&gt;outgoing
op_amp
l_int|1
suffix:semicolon
id|isdn_net_phone
op_star
id|n
suffix:semicolon
id|isdn_net_phone
op_star
id|m
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|n
op_assign
id|p-&gt;local-&gt;phone
(braket
id|inout
)braket
suffix:semicolon
id|m
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
id|n
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|n-&gt;num
comma
id|phone-&gt;phone
)paren
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;local-&gt;dial
op_eq
id|n
)paren
id|p-&gt;local-&gt;dial
op_assign
id|n-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|m
)paren
id|m-&gt;next
op_assign
id|n-&gt;next
suffix:semicolon
r_else
id|p-&gt;local-&gt;phone
(braket
id|inout
)braket
op_assign
id|n-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|n
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|m
op_assign
id|n
suffix:semicolon
id|n
op_assign
(paren
id|isdn_net_phone
op_star
)paren
id|n-&gt;next
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n; * Delete all phone-numbers of an interface.&n; */
r_static
r_int
DECL|function|isdn_net_rmallphone
id|isdn_net_rmallphone
c_func
(paren
id|isdn_net_dev
op_star
id|p
)paren
(brace
id|isdn_net_phone
op_star
id|n
suffix:semicolon
id|isdn_net_phone
op_star
id|m
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|n
op_assign
id|p-&gt;local-&gt;phone
(braket
id|i
)braket
suffix:semicolon
r_while
c_loop
(paren
id|n
)paren
(brace
id|m
op_assign
id|n-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|n
)paren
suffix:semicolon
id|n
op_assign
id|m
suffix:semicolon
)brace
id|p-&gt;local-&gt;phone
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|p-&gt;local-&gt;dial
op_assign
l_int|NULL
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Force a hangup of a network-interface.&n; */
r_int
DECL|function|isdn_net_force_hangup
id|isdn_net_force_hangup
c_func
(paren
r_char
op_star
id|name
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|isdn_net_findif
c_func
(paren
id|name
)paren
suffix:semicolon
r_struct
id|device
op_star
id|q
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;local-&gt;isdn_device
OL
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
id|q
op_assign
id|p-&gt;local-&gt;slave
suffix:semicolon
multiline_comment|/* If this interface has slaves, do a hangup for them also. */
r_while
c_loop
(paren
id|q
)paren
(brace
id|isdn_net_hangup
c_func
(paren
id|q
)paren
suffix:semicolon
id|q
op_assign
(paren
(paren
(paren
id|isdn_net_local
op_star
)paren
id|q-&gt;priv
)paren
op_member_access_from_pointer
id|slave
)paren
suffix:semicolon
)brace
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n; * Helper-function for isdn_net_rm: Do the real work.&n; */
r_static
r_int
DECL|function|isdn_net_realrm
id|isdn_net_realrm
c_func
(paren
id|isdn_net_dev
op_star
id|p
comma
id|isdn_net_dev
op_star
id|q
)paren
(brace
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;local-&gt;master
)paren
(brace
multiline_comment|/* If it&squot;s a slave, it may be removed even if it is busy. However&n;&t;&t; * it has to be hung up first.&n;&t;&t; */
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
id|p-&gt;dev.start
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p-&gt;dev.start
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ISDN_X25
r_if
c_cond
(paren
id|p
op_member_access_from_pointer
id|cprot
op_logical_and
id|p
op_member_access_from_pointer
id|cprot
op_member_access_from_pointer
id|pops
)paren
(brace
id|p
op_member_access_from_pointer
id|cprot
op_member_access_from_pointer
id|pops
op_member_access_from_pointer
id|proto_del
(paren
id|p
op_member_access_from_pointer
id|cprot
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Free all phone-entries */
id|isdn_net_rmallphone
c_func
(paren
id|p
)paren
suffix:semicolon
multiline_comment|/* If interface is bound exclusive, free channel-usage */
r_if
c_cond
(paren
id|p-&gt;local-&gt;exclusive
op_ne
op_minus
l_int|1
)paren
id|isdn_unexclusive_channel
c_func
(paren
id|p-&gt;local-&gt;pre_device
comma
id|p-&gt;local-&gt;pre_channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;local-&gt;master
)paren
(brace
multiline_comment|/* It&squot;s a slave-device, so update master&squot;s slave-pointer if necessary */
r_if
c_cond
(paren
(paren
(paren
id|isdn_net_local
op_star
)paren
(paren
id|p-&gt;local-&gt;master-&gt;priv
)paren
)paren
op_member_access_from_pointer
id|slave
op_eq
op_amp
id|p-&gt;dev
)paren
(paren
(paren
id|isdn_net_local
op_star
)paren
(paren
id|p-&gt;local-&gt;master-&gt;priv
)paren
)paren
op_member_access_from_pointer
id|slave
op_assign
id|p-&gt;local-&gt;slave
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Unregister only if it&squot;s a master-device */
id|p-&gt;dev.hard_header_cache
op_assign
id|p-&gt;local-&gt;org_hhc
suffix:semicolon
id|p-&gt;dev.header_cache_update
op_assign
id|p-&gt;local-&gt;org_hcu
suffix:semicolon
id|unregister_netdev
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Unlink device from chain */
r_if
c_cond
(paren
id|q
)paren
id|q-&gt;next
op_assign
id|p-&gt;next
suffix:semicolon
r_else
id|dev-&gt;netdev
op_assign
id|p-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;local-&gt;slave
)paren
(brace
multiline_comment|/* If this interface has a slave, remove it also */
r_char
op_star
id|slavename
op_assign
(paren
(paren
id|isdn_net_local
op_star
)paren
(paren
id|p-&gt;local-&gt;slave-&gt;priv
)paren
)paren
op_member_access_from_pointer
id|name
suffix:semicolon
id|isdn_net_dev
op_star
id|n
op_assign
id|dev-&gt;netdev
suffix:semicolon
id|q
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
id|n
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|n-&gt;local-&gt;name
comma
id|slavename
)paren
)paren
(brace
id|isdn_net_realrm
c_func
(paren
id|n
comma
id|q
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|q
op_assign
id|n
suffix:semicolon
id|n
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|n-&gt;next
suffix:semicolon
)brace
)brace
multiline_comment|/* If no more net-devices remain, disable auto-hangup timer */
r_if
c_cond
(paren
id|dev-&gt;netdev
op_eq
l_int|NULL
)paren
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_NETHANGUP
comma
l_int|0
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|p-&gt;local
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|p
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Remove a single network-interface.&n; */
r_int
DECL|function|isdn_net_rm
id|isdn_net_rm
c_func
(paren
r_char
op_star
id|name
)paren
(brace
id|isdn_net_dev
op_star
id|p
suffix:semicolon
id|isdn_net_dev
op_star
id|q
suffix:semicolon
multiline_comment|/* Search name in netdev-chain */
id|p
op_assign
id|dev-&gt;netdev
suffix:semicolon
id|q
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|p-&gt;local-&gt;name
comma
id|name
)paren
)paren
r_return
(paren
id|isdn_net_realrm
c_func
(paren
id|p
comma
id|q
)paren
)paren
suffix:semicolon
id|q
op_assign
id|p
suffix:semicolon
id|p
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|p-&gt;next
suffix:semicolon
)brace
multiline_comment|/* If no more net-devices remain, disable auto-hangup timer */
r_if
c_cond
(paren
id|dev-&gt;netdev
op_eq
l_int|NULL
)paren
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_NETHANGUP
comma
l_int|0
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n; * Remove all network-interfaces&n; */
r_int
DECL|function|isdn_net_rmall
id|isdn_net_rmall
c_func
(paren
r_void
)paren
(brace
r_int
id|flags
suffix:semicolon
r_int
id|ret
suffix:semicolon
multiline_comment|/* Walk through netdev-chain */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|dev-&gt;netdev
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;netdev-&gt;local-&gt;master
)paren
(brace
multiline_comment|/* Remove master-devices only, slaves get removed with their master */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|isdn_net_realrm
c_func
(paren
id|dev-&gt;netdev
comma
l_int|NULL
)paren
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
)brace
)brace
id|dev-&gt;netdev
op_assign
l_int|NULL
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
