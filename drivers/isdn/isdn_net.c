multiline_comment|/* $Id: isdn_net.c,v 1.44 1997/05/27 15:17:26 fritz Exp $&n;&n; * Linux ISDN subsystem, network interfaces and related functions (linklevel).&n; *&n; * Copyright 1994,95,96 by Fritz Elfert (fritz@wuemaus.franken.de)&n; * Copyright 1995,96    by Thinking Objects Software GmbH Wuerzburg&n; * Copyright 1995,96    by Michael Hipp (Michael.Hipp@student.uni-tuebingen.de)&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; * $Log: isdn_net.c,v $&n; * Revision 1.44  1997/05/27 15:17:26  fritz&n; * Added changes for recent 2.1.x kernels:&n; *   changed return type of isdn_close&n; *   queue_task_* -&gt; queue_task&n; *   clear/set_bit -&gt; test_and_... where apropriate.&n; *   changed type of hard_header_cache parameter.&n; *&n; * Revision 1.43  1997/03/30 16:51:13  calle&n; * changed calls to copy_from_user/copy_to_user and removed verify_area&n; * were possible.&n; *&n; * Revision 1.42  1997/03/11 08:43:51  fritz&n; * Perform a hangup if number is deleted while dialing.&n; *&n; * Revision 1.41  1997/03/08 08:16:31  fritz&n; * Bugfix: Deleting a phone number during dial gave unpredictable results.&n; *&n; * Revision 1.40  1997/03/05 21:16:08  fritz&n; * Fix: did not compile with 2.1.27&n; *&n; * Revision 1.39  1997/03/04 21:36:52  fritz&n; * Added sending ICMP messages when no connetion is possible.&n; *&n; * Revision 1.38  1997/02/23 23:41:14  fritz&n; * Bugfix: Slave interfaces have to be hung up before master.&n; *&n; * Revision 1.37  1997/02/11 18:32:51  fritz&n; * Bugfix in isdn_ppp_free_mpqueue().&n; *&n; * Revision 1.36  1997/02/10 21:31:11  fritz&n; * Changed setup-interface (incoming and outgoing).&n; *&n; * Revision 1.35  1997/02/10 20:12:45  fritz&n; * Changed interface for reporting incoming calls.&n; *&n; * Revision 1.34  1997/02/03 23:15:07  fritz&n; * Reformatted according CodingStyle.&n; * replaced arp_find prototype by proper include.&n; * made dev_purge_queues static.&n; * Bugfix in bogocps calculation.&n; * removed isdn_net_receive_callback - was never used ;-)&n; * Misc. fixes for Kernel 2.1.X comaptibility.&n; *&n; * Revision 1.33  1997/01/17 01:19:25  fritz&n; * Applied chargeint patch.&n; *&n; * Revision 1.32  1997/01/14 01:29:31  fritz&n; * Bugfix: isdn_net_hangup() did not reset ISDN_NET_CONNECTED.&n; *&n; * Revision 1.31  1997/01/11 23:30:42  fritz&n; * Speed up dial statemachine.&n; *&n; * Revision 1.30  1996/11/25 17:20:50  hipp&n; * fixed pppbind bug in isdn_net_find_icall()&n; *&n; * Revision 1.29  1996/11/13 02:31:38  fritz&n; * Minor cleanup.&n; *&n; * Revision 1.28  1996/10/27 20:49:06  keil&n; * bugfix to compile without MPP&n; *&n; * Revision 1.27  1996/10/25 18:46:01  fritz&n; * Another bugfix in isdn_net_autohup()&n; *&n; * Revision 1.26  1996/10/23 23:05:36  fritz&n; * Bugfix: Divide by zero in isdn_net_autohup()&n; *&n; * Revision 1.25  1996/10/22 23:13:58  fritz&n; * Changes for compatibility to 2.0.X and 2.1.X kernels.&n; *&n; * Revision 1.24  1996/10/11 13:57:40  fritz&n; * Bugfix: Error in BogoCPS calculation.&n; *&n; * Revision 1.23  1996/09/23 01:58:08  fritz&n; * Fix: With syncPPP encapsulation, discard LCP packets&n; *      when calculating hangup timeout.&n; *&n; * Revision 1.22  1996/09/23 00:03:37  fritz&n; * Fix: did not compile without CONFIG_ISDN_PPP&n; *&n; * Revision 1.21  1996/09/07 12:44:50  hipp&n; * (hopefully) fixed callback problem with syncPPP&n; * syncPPP network devices now show PPP link encap&n; *&n; * Revision 1.20  1996/08/29 20:06:03  fritz&n; * Bugfix: Transmission timeout had been much to low.&n; *&n; * Revision 1.19  1996/08/12 16:24:32  hipp&n; * removed some (now) obsolete functions for syncPPP in rebuild_header etc.&n; *&n; * Revision 1.18  1996/07/03 13:48:51  hipp&n; * bugfix: Call dev_purge_queues() only for master device&n; *&n; * Revision 1.17  1996/06/25 18:37:37  fritz&n; * Fixed return count for empty return string in isdn_net_getphones().&n; *&n; * Revision 1.16  1996/06/24 17:48:08  fritz&n; * Bugfixes:&n; *   - Did not free channel on unbinding.&n; *   - ioctl returned wrong callback settings.&n; *&n; * Revision 1.15  1996/06/16 17:42:54  tsbogend&n; * fixed problem with IP addresses on Linux/Alpha (long is 8 byte there)&n; *&n; * Revision 1.14  1996/06/11 14:54:08  hipp&n; * minor bugfix in isdn_net_send_skb&n; * changes in BSENT callback handler for syncPPP&n; * added lp-&gt;sav_skb stuff&n; *&n; * Revision 1.13  1996/06/06 14:25:44  fritz&n; * Changed loglevel of &quot;incoming ... without OAD&quot; message, since&n; * with audio support this is quite normal.&n; *&n; * Revision 1.12  1996/06/05 02:36:45  fritz&n; * Minor bugfixes by M. Hipp.&n; *&n; * Revision 1.11  1996/05/18 01:36:59  fritz&n; * Added spelling corrections and some minor changes&n; * to stay in sync with kernel.&n; *&n; * Revision 1.10  1996/05/17 03:49:01  fritz&n; * Some cleanup.&n; *&n; * Revision 1.9  1996/05/06 11:34:57  hipp&n; * fixed a few bugs&n; *&n; * Revision 1.8  1996/04/30 21:04:40  fritz&n; * Test commit&n; *&n; * Revision 1.7  1996/04/30 11:10:42  fritz&n; * Added Michael&squot;s ippp-bind patch.&n; *&n; * Revision 1.6  1996/04/30 09:34:35  fritz&n; * Removed compatibility-macros.&n; *&n; * Revision 1.5  1996/04/20 16:28:38  fritz&n; * Made more parameters of the dial statemachine user-configurable and&n; * added hangup after dial for more reliability using callback.&n; * Changed all io going through generic routines in isdn_common.c&n; * Added missing call to dev_free_skb on failed dialing.&n; * Added uihdlc encapsulation.&n; * Fixed isdn_net_setcfg not to destroy interface-flags anymore.&n; * Misc. typos.&n; *&n; * Revision 1.4  1996/02/19 15:23:38  fritz&n; * Bugfix: Sync-PPP packets got compressed twice, when resent due to&n; *         send-queue-full reject.&n; *&n; * Revision 1.3  1996/02/11 02:22:28  fritz&n; * Changed status- receive-callbacks to use pointer-arrays for finding&n; * a corresponding interface instead of looping over all interfaces.&n; * Activate Auto-hangup-timer only when interface is online.&n; * Some bugfixes in the dialing-statemachine.&n; * Lot of bugfixes in sk_buff&squot;ized encapsulation handling.&n; * For speedup connection-setup after dialing, remember sk_buf that triggered&n; * dialing.&n; * Fixed isdn_net_log_packet according to different encapsulations.&n; * Correct ARP-handling for ETHERNET-encapsulation.&n; *&n; * Revision 1.2  1996/01/22 05:05:12  fritz&n; * Changed returncode-logic for isdn_net_start_xmit() and its&n; * helper-functions.&n; * Changed handling of buildheader for RAWIP and ETHERNET-encapsulation.&n; *&n; * Revision 1.1  1996/01/09 04:12:34  fritz&n; * Initial revision&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/isdn.h&gt;
macro_line|#include &lt;net/arp.h&gt;
macro_line|#include &lt;net/icmp.h&gt;
macro_line|#if (LINUX_VERSION_CODE &gt;= 0x020117)
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#endif
macro_line|#include &quot;isdn_common.h&quot;
macro_line|#include &quot;isdn_net.h&quot;
macro_line|#ifdef CONFIG_ISDN_PPP
macro_line|#include &quot;isdn_ppp.h&quot;
macro_line|#endif
macro_line|#ifndef DEV_NUMBUFFS
macro_line|#include &lt;net/pkt_sched.h&gt;
macro_line|#endif
multiline_comment|/* Prototypes */
r_int
id|isdn_net_force_dial_lp
c_func
(paren
id|isdn_net_local
op_star
)paren
suffix:semicolon
r_static
r_int
id|isdn_net_wildmat
c_func
(paren
r_char
op_star
id|s
comma
r_char
op_star
id|p
)paren
suffix:semicolon
r_static
r_int
id|isdn_net_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
comma
r_struct
id|device
op_star
)paren
suffix:semicolon
r_static
r_int
id|isdn_net_xmit
c_func
(paren
r_struct
id|device
op_star
comma
id|isdn_net_local
op_star
comma
r_struct
id|sk_buff
op_star
)paren
suffix:semicolon
macro_line|#ifdef DEV_NUMBUFFS
r_static
r_void
id|dev_purge_queues
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* move this to net/core/dev.c */
macro_line|#endif
DECL|variable|isdn_net_revision
r_char
op_star
id|isdn_net_revision
op_assign
l_string|&quot;$Revision: 1.44 $&quot;
suffix:semicolon
multiline_comment|/*&n;  * Code for raw-networking over ISDN&n;  */
r_static
r_void
DECL|function|isdn_net_unreachable
id|isdn_net_unreachable
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_char
op_star
id|reason
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_net: %s: %s, send ICMP&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|reason
)paren
suffix:semicolon
id|icmp_send
c_func
(paren
id|skb
comma
id|ICMP_DEST_UNREACH
comma
id|ICMP_HOST_UNREACH
comma
l_int|0
macro_line|#if (LINUX_VERSION_CODE &lt; 0x02010f)&t;/* 2.1.15 */
comma
id|dev
macro_line|#endif
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|isdn_net_reset
id|isdn_net_reset
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|ulong
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Avoid glitch on writes to CMD regs */
id|dev-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Open/initialize the board. */
r_static
r_int
DECL|function|isdn_net_open
id|isdn_net_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|device
op_star
id|p
suffix:semicolon
id|isdn_net_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Fill in the MAC-level header. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ETH_ALEN
op_minus
r_sizeof
(paren
id|u32
)paren
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
l_int|0xfc
suffix:semicolon
id|memset
c_func
(paren
op_amp
(paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
multiline_comment|/* If this interface has slaves, start them also */
r_if
c_cond
(paren
(paren
id|p
op_assign
(paren
(paren
(paren
id|isdn_net_local
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|slave
)paren
)paren
)paren
(brace
r_while
c_loop
(paren
id|p
)paren
(brace
id|isdn_net_reset
c_func
(paren
id|p
)paren
suffix:semicolon
id|p-&gt;start
op_assign
l_int|1
suffix:semicolon
id|p
op_assign
(paren
(paren
(paren
id|isdn_net_local
op_star
)paren
id|p-&gt;priv
)paren
op_member_access_from_pointer
id|slave
)paren
suffix:semicolon
)brace
)brace
id|isdn_MOD_INC_USE_COUNT
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Assign an ISDN-channel to a net-interface&n; */
r_static
r_void
DECL|function|isdn_net_bind_channel
id|isdn_net_bind_channel
c_func
(paren
id|isdn_net_local
op_star
id|lp
comma
r_int
id|idx
)paren
(brace
id|ulong
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|lp-&gt;isdn_device
op_assign
id|dev-&gt;drvmap
(braket
id|idx
)braket
suffix:semicolon
id|lp-&gt;isdn_channel
op_assign
id|dev-&gt;chanmap
(braket
id|idx
)braket
suffix:semicolon
id|dev-&gt;rx_netdev
(braket
id|idx
)braket
op_assign
id|lp-&gt;netdev
suffix:semicolon
id|dev-&gt;st_netdev
(braket
id|idx
)braket
op_assign
id|lp-&gt;netdev
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * unbind a net-interface (resets interface after an error)&n; */
r_static
r_void
DECL|function|isdn_net_unbind_channel
id|isdn_net_unbind_channel
c_func
(paren
id|isdn_net_local
op_star
id|lp
)paren
(brace
id|ulong
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;first_skb
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|lp-&gt;first_skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|lp-&gt;first_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;sav_skb
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|lp-&gt;sav_skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|lp-&gt;sav_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#ifdef DEV_NUMBUFFS
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;master
)paren
multiline_comment|/* purge only for master device */
id|dev_purge_queues
c_func
(paren
op_amp
id|lp-&gt;netdev-&gt;dev
)paren
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;master
)paren
(brace
multiline_comment|/* reset only master device */
multiline_comment|/* Moral equivalent of dev_purge_queues():&n;&t;&t;   BEWARE! This chunk of code cannot be called from hardware&n;&t;&t;   interrupt handler. I hope it is true. --ANK&n;&t;&t; */
id|qdisc_reset
c_func
(paren
id|lp-&gt;netdev-&gt;dev.qdisc
)paren
suffix:semicolon
)brace
macro_line|#endif
id|lp-&gt;dialstate
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;rx_netdev
(braket
id|isdn_dc2minor
c_func
(paren
id|lp-&gt;isdn_device
comma
id|lp-&gt;isdn_channel
)paren
)braket
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;st_netdev
(braket
id|isdn_dc2minor
c_func
(paren
id|lp-&gt;isdn_device
comma
id|lp-&gt;isdn_channel
)paren
)braket
op_assign
l_int|NULL
suffix:semicolon
id|isdn_free_channel
c_func
(paren
id|lp-&gt;isdn_device
comma
id|lp-&gt;isdn_channel
comma
id|ISDN_USAGE_NET
)paren
suffix:semicolon
id|lp-&gt;flags
op_and_assign
op_complement
id|ISDN_NET_CONNECTED
suffix:semicolon
id|lp-&gt;isdn_device
op_assign
op_minus
l_int|1
suffix:semicolon
id|lp-&gt;isdn_channel
op_assign
op_minus
l_int|1
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Perform auto-hangup and cps-calculation for net-interfaces.&n; *&n; * auto-hangup:&n; * Increment idle-counter (this counter is reset on any incoming or&n; * outgoing packet), if counter exceeds configured limit either do a&n; * hangup immediately or - if configured - wait until just before the next&n; * charge-info.&n; *&n; * cps-calculation (needed for dynamic channel-bundling):&n; * Since this function is called every second, simply reset the&n; * byte-counter of the interface after copying it to the cps-variable.&n; */
DECL|variable|last_jiffies
r_int
r_int
id|last_jiffies
op_assign
op_minus
id|HZ
suffix:semicolon
r_void
DECL|function|isdn_net_autohup
id|isdn_net_autohup
c_func
(paren
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|dev-&gt;netdev
suffix:semicolon
r_int
id|anymore
suffix:semicolon
id|anymore
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
id|isdn_net_local
op_star
id|l
op_assign
(paren
id|isdn_net_local
op_star
)paren
op_amp
(paren
id|p-&gt;local
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|last_jiffies
)paren
op_eq
l_int|0
)paren
id|l-&gt;cps
op_assign
id|l-&gt;transcount
suffix:semicolon
r_else
id|l-&gt;cps
op_assign
(paren
id|l-&gt;transcount
op_star
id|HZ
)paren
op_div
(paren
id|jiffies
op_minus
id|last_jiffies
)paren
suffix:semicolon
id|l-&gt;transcount
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;net_verbose
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: %d bogocps&bslash;n&quot;
comma
id|l-&gt;name
comma
id|l-&gt;cps
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|l-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
op_logical_and
(paren
op_logical_neg
id|l-&gt;dialstate
)paren
)paren
(brace
id|anymore
op_assign
l_int|1
suffix:semicolon
id|l-&gt;huptimer
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|l-&gt;onhtime
)paren
op_logical_and
(paren
id|l-&gt;huptimer
OG
id|l-&gt;onhtime
)paren
)paren
r_if
c_cond
(paren
id|l-&gt;hupflags
op_amp
id|ISDN_MANCHARGE
op_logical_and
id|l-&gt;hupflags
op_amp
id|ISDN_CHARGEHUP
)paren
(brace
r_while
c_loop
(paren
id|jiffies
op_minus
id|l-&gt;chargetime
OG
id|l-&gt;chargeint
)paren
id|l-&gt;chargetime
op_add_assign
id|l-&gt;chargeint
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_minus
id|l-&gt;chargetime
op_ge
id|l-&gt;chargeint
op_minus
l_int|2
op_star
id|HZ
)paren
r_if
c_cond
(paren
id|l-&gt;outgoing
op_logical_or
id|l-&gt;hupflags
op_amp
id|ISDN_INHUP
)paren
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|l-&gt;outgoing
)paren
(brace
r_if
c_cond
(paren
id|l-&gt;hupflags
op_amp
id|ISDN_CHARGEHUP
)paren
(brace
r_if
c_cond
(paren
id|l-&gt;hupflags
op_amp
id|ISDN_WAITCHARGE
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_net: Hupflags of %s are %X&bslash;n&quot;
comma
id|l-&gt;name
comma
id|l-&gt;hupflags
)paren
suffix:semicolon
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|jiffies
op_minus
id|l-&gt;chargetime
OG
id|l-&gt;chargeint
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_net: %s: chtime = %d, chint = %d&bslash;n&quot;
comma
id|l-&gt;name
comma
id|l-&gt;chargetime
comma
id|l-&gt;chargeint
)paren
suffix:semicolon
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
)brace
)brace
r_else
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|l-&gt;hupflags
op_amp
id|ISDN_INHUP
)paren
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
)brace
id|p
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|p-&gt;next
suffix:semicolon
)brace
id|last_jiffies
op_assign
id|jiffies
suffix:semicolon
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_NETHANGUP
comma
id|anymore
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Handle status-messages from ISDN-interfacecard.&n; * This function is called from within the main-status-dispatcher&n; * isdn_status_callback, which itself is called from the low-level driver.&n; * Return: 1 = Event handled, 0 = not for us or unknown Event.&n; */
r_int
DECL|function|isdn_net_stat_callback
id|isdn_net_stat_callback
c_func
(paren
r_int
id|idx
comma
r_int
id|cmd
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|dev-&gt;st_netdev
(braket
id|idx
)braket
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
op_amp
(paren
id|p-&gt;local
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|ISDN_STAT_BSENT
suffix:colon
multiline_comment|/* A packet has successfully been sent out */
r_if
c_cond
(paren
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
op_logical_and
(paren
op_logical_neg
id|lp-&gt;dialstate
)paren
)paren
(brace
id|lp-&gt;stats.tx_packets
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_SYNCPPP
op_logical_and
id|lp-&gt;sav_skb
)paren
(brace
r_struct
id|device
op_star
id|mdev
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;master
)paren
id|mdev
op_assign
id|lp-&gt;master
suffix:semicolon
r_else
id|mdev
op_assign
op_amp
id|lp-&gt;netdev-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|isdn_net_send_skb
c_func
(paren
id|mdev
comma
id|lp
comma
id|lp-&gt;sav_skb
)paren
)paren
(brace
id|lp-&gt;sav_skb
op_assign
l_int|NULL
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
r_else
(brace
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
(paren
id|p-&gt;dev.tbusy
)paren
)paren
)paren
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
r_case
id|ISDN_STAT_DCONN
suffix:colon
multiline_comment|/* D-Channel is up */
r_switch
c_cond
(paren
id|lp-&gt;dialstate
)paren
(brace
r_case
l_int|4
suffix:colon
r_case
l_int|7
suffix:colon
r_case
l_int|8
suffix:colon
id|lp-&gt;dialstate
op_increment
suffix:semicolon
r_return
l_int|1
suffix:semicolon
r_case
l_int|12
suffix:colon
id|lp-&gt;dialstate
op_assign
l_int|5
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_STAT_DHUP
suffix:colon
multiline_comment|/* Either D-Channel-hangup or error during dialout */
r_if
c_cond
(paren
(paren
op_logical_neg
id|lp-&gt;dialstate
)paren
op_logical_and
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
)paren
(brace
id|lp-&gt;flags
op_and_assign
op_complement
id|ISDN_NET_CONNECTED
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;first_skb
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|lp-&gt;first_skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|lp-&gt;first_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;sav_skb
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|lp-&gt;sav_skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|lp-&gt;sav_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|isdn_free_channel
c_func
(paren
id|lp-&gt;isdn_device
comma
id|lp-&gt;isdn_channel
comma
id|ISDN_USAGE_NET
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
id|isdn_ppp_free
c_func
(paren
id|lp
)paren
suffix:semicolon
macro_line|#endif
id|isdn_all_eaz
c_func
(paren
id|lp-&gt;isdn_device
comma
id|lp-&gt;isdn_channel
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: remote hangup&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Chargesum is %d&bslash;n&quot;
comma
id|lp-&gt;name
comma
id|lp-&gt;charge
)paren
suffix:semicolon
id|lp-&gt;isdn_device
op_assign
op_minus
l_int|1
suffix:semicolon
id|lp-&gt;isdn_channel
op_assign
op_minus
l_int|1
suffix:semicolon
id|dev-&gt;st_netdev
(braket
id|idx
)braket
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;rx_netdev
(braket
id|idx
)braket
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_STAT_BCONN
suffix:colon
multiline_comment|/* B-Channel is up */
r_switch
c_cond
(paren
id|lp-&gt;dialstate
)paren
(brace
r_case
l_int|5
suffix:colon
r_case
l_int|6
suffix:colon
r_case
l_int|7
suffix:colon
r_case
l_int|8
suffix:colon
r_case
l_int|9
suffix:colon
r_case
l_int|10
suffix:colon
r_case
l_int|12
suffix:colon
r_if
c_cond
(paren
id|lp-&gt;dialstate
op_le
l_int|6
)paren
(brace
id|dev-&gt;usage
(braket
id|idx
)braket
op_or_assign
id|ISDN_USAGE_OUTGOING
suffix:semicolon
id|isdn_info_update
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
id|dev-&gt;rx_netdev
(braket
id|idx
)braket
op_assign
id|p
suffix:semicolon
id|lp-&gt;dialstate
op_assign
l_int|0
suffix:semicolon
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_NETHANGUP
comma
l_int|1
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdn_net: %s connected&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
multiline_comment|/* If first Chargeinfo comes before B-Channel connect,&n;&t;&t;&t;&t;&t;&t; * we correct the timestamp here.&n;&t;&t;&t;&t;&t;&t; */
id|lp-&gt;chargetime
op_assign
id|jiffies
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_net: chargetime of %s now %d&bslash;n&quot;
comma
id|lp-&gt;name
comma
id|lp-&gt;chargetime
)paren
suffix:semicolon
multiline_comment|/* Immediately send first skb to speed up arp */
macro_line|#ifdef CONFIG_ISDN_PPP
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_SYNCPPP
)paren
id|isdn_ppp_wakeup_daemon
c_func
(paren
id|lp
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|lp-&gt;first_skb
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|isdn_net_xmit
c_func
(paren
op_amp
id|p-&gt;dev
comma
id|lp
comma
id|lp-&gt;first_skb
)paren
)paren
)paren
id|lp-&gt;first_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_STAT_NODCH
suffix:colon
multiline_comment|/* No D-Channel avail. */
r_if
c_cond
(paren
id|lp-&gt;dialstate
op_eq
l_int|4
)paren
(brace
id|lp-&gt;dialstate
op_decrement
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_STAT_CINF
suffix:colon
multiline_comment|/* Charge-info from TelCo. Calculate interval between&n;&t;&t;&t;&t; * charge-infos and set timestamp for last info for&n;&t;&t;&t;&t; * usage by isdn_net_autohup()&n;&t;&t;&t;&t; */
id|lp-&gt;charge
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;hupflags
op_amp
id|ISDN_HAVECHARGE
)paren
(brace
id|lp-&gt;hupflags
op_and_assign
op_complement
id|ISDN_WAITCHARGE
suffix:semicolon
id|lp-&gt;chargeint
op_assign
id|jiffies
op_minus
id|lp-&gt;chargetime
op_minus
(paren
l_int|2
op_star
id|HZ
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;hupflags
op_amp
id|ISDN_WAITCHARGE
)paren
id|lp-&gt;hupflags
op_or_assign
id|ISDN_HAVECHARGE
suffix:semicolon
id|lp-&gt;chargetime
op_assign
id|jiffies
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_net: Got CINF chargetime of %s now %d&bslash;n&quot;
comma
id|lp-&gt;name
comma
id|lp-&gt;chargetime
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Check, if a number contains wildcard-characters, in which case it&n; * is for incoming purposes only.&n; */
r_static
r_int
DECL|function|isdn_net_checkwild
id|isdn_net_checkwild
c_func
(paren
r_char
op_star
id|num
)paren
(brace
r_return
(paren
(paren
id|strchr
c_func
(paren
id|num
comma
l_char|&squot;?&squot;
)paren
)paren
op_logical_or
(paren
id|strchr
c_func
(paren
id|num
comma
l_char|&squot;*&squot;
)paren
)paren
op_logical_or
(paren
id|strchr
c_func
(paren
id|num
comma
l_char|&squot;[&squot;
)paren
)paren
op_logical_or
(paren
id|strchr
c_func
(paren
id|num
comma
l_char|&squot;]&squot;
)paren
)paren
op_logical_or
(paren
id|strchr
c_func
(paren
id|num
comma
l_char|&squot;^&squot;
)paren
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Perform dialout for net-interfaces and timeout-handling for&n; * D-Channel-up and B-Channel-up Messages.&n; * This function is initially called from within isdn_net_start_xmit() or&n; * or isdn_net_find_icall() after initializing the dialstate for an&n; * interface. If further calls are needed, the function schedules itself&n; * for a timer-callback via isdn_timer_function().&n; * The dialstate is also affected by incoming status-messages from&n; * the ISDN-Channel which are handled in isdn_net_stat_callback() above.&n; */
r_void
DECL|function|isdn_net_dial
id|isdn_net_dial
c_func
(paren
r_void
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|dev-&gt;netdev
suffix:semicolon
r_int
id|anymore
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
macro_line|#ifdef ISDN_DEBUG_NET_DIAL
r_if
c_cond
(paren
id|p-&gt;local.dialstate
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: dialstate=%d&bslash;n&quot;
comma
id|p-&gt;local.name
comma
id|p-&gt;local.dialstate
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|p-&gt;local.dialstate
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* Nothing to do for this interface */
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* Initiate dialout. Set phone-number-pointer to first number&n;&t;&t;&t;&t; * of interface.&n;&t;&t;&t;&t; */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|p-&gt;local.dial
op_assign
id|p-&gt;local.phone
(braket
l_int|1
)braket
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;local.dial
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: phone number deleted?&bslash;n&quot;
comma
id|p-&gt;local.name
)paren
suffix:semicolon
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|anymore
op_assign
l_int|1
suffix:semicolon
id|p-&gt;local.dialstate
op_increment
suffix:semicolon
multiline_comment|/* Fall through */
r_case
l_int|2
suffix:colon
multiline_comment|/* Prepare dialing. Clear EAZ, then set EAZ. */
id|cmd.driver
op_assign
id|p-&gt;local.isdn_device
suffix:semicolon
id|cmd.arg
op_assign
id|p-&gt;local.isdn_channel
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_CLREAZ
suffix:semicolon
id|dev-&gt;drv
(braket
id|p-&gt;local.isdn_device
)braket
op_member_access_from_pointer
id|interface
op_member_access_from_pointer
id|command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|cmd.parm.num
comma
l_string|&quot;%s&quot;
comma
id|isdn_map_eaz2msn
c_func
(paren
id|p-&gt;local.msn
comma
id|cmd.driver
)paren
)paren
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_SETEAZ
suffix:semicolon
id|dev-&gt;drv
(braket
id|p-&gt;local.isdn_device
)braket
op_member_access_from_pointer
id|interface
op_member_access_from_pointer
id|command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|p-&gt;local.dialretry
op_assign
l_int|0
suffix:semicolon
id|anymore
op_assign
l_int|1
suffix:semicolon
id|p-&gt;local.dialstate
op_increment
suffix:semicolon
multiline_comment|/* Falls through */
r_case
l_int|3
suffix:colon
multiline_comment|/* Setup interface, dial current phone-number, switch to next number.&n;&t;&t;&t;&t; * If list of phone-numbers is exhausted, increment&n;&t;&t;&t;&t; * retry-counter.&n;&t;&t;&t;&t; */
id|cmd.driver
op_assign
id|p-&gt;local.isdn_device
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_SETL2
suffix:semicolon
id|cmd.arg
op_assign
id|p-&gt;local.isdn_channel
op_plus
(paren
id|p-&gt;local.l2_proto
op_lshift
l_int|8
)paren
suffix:semicolon
id|dev-&gt;drv
(braket
id|p-&gt;local.isdn_device
)braket
op_member_access_from_pointer
id|interface
op_member_access_from_pointer
id|command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|p-&gt;local.isdn_device
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_SETL3
suffix:semicolon
id|cmd.arg
op_assign
id|p-&gt;local.isdn_channel
op_plus
(paren
id|p-&gt;local.l3_proto
op_lshift
l_int|8
)paren
suffix:semicolon
id|dev-&gt;drv
(braket
id|p-&gt;local.isdn_device
)braket
op_member_access_from_pointer
id|interface
op_member_access_from_pointer
id|command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|p-&gt;local.isdn_device
suffix:semicolon
id|cmd.arg
op_assign
id|p-&gt;local.isdn_channel
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;local.dial
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: phone number deleted?&bslash;n&quot;
comma
id|p-&gt;local.name
)paren
suffix:semicolon
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|p-&gt;local.dial-&gt;num
comma
l_string|&quot;LEASED&quot;
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|p-&gt;local.dialstate
op_assign
l_int|4
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Open leased line ...&bslash;n&quot;
comma
id|p-&gt;local.name
)paren
suffix:semicolon
)brace
r_else
(brace
id|sprintf
c_func
(paren
id|cmd.parm.setup.phone
comma
l_string|&quot;%s&quot;
comma
id|p-&gt;local.dial-&gt;num
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t; * Switch to next number or back to start if at end of list.&n;&t;&t;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|p-&gt;local.dial
op_assign
(paren
id|isdn_net_phone
op_star
)paren
id|p-&gt;local.dial-&gt;next
)paren
)paren
(brace
id|p-&gt;local.dial
op_assign
id|p-&gt;local.phone
(braket
l_int|1
)braket
suffix:semicolon
id|p-&gt;local.dialretry
op_increment
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_DIAL
suffix:semicolon
id|cmd.parm.setup.si1
op_assign
l_int|7
suffix:semicolon
id|cmd.parm.setup.si2
op_assign
l_int|0
suffix:semicolon
id|sprintf
c_func
(paren
id|cmd.parm.setup.eazmsn
comma
l_string|&quot;%s&quot;
comma
id|isdn_map_eaz2msn
c_func
(paren
id|p-&gt;local.msn
comma
id|cmd.driver
)paren
)paren
suffix:semicolon
id|i
op_assign
id|isdn_dc2minor
c_func
(paren
id|p-&gt;local.isdn_device
comma
id|p-&gt;local.isdn_channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
l_int|0
)paren
(brace
id|strcpy
c_func
(paren
id|dev-&gt;num
(braket
id|i
)braket
comma
id|cmd.parm.setup.phone
)paren
suffix:semicolon
id|isdn_info_update
c_func
(paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: dialing %d %s...&bslash;n&quot;
comma
id|p-&gt;local.name
comma
id|p-&gt;local.dialretry
op_minus
l_int|1
comma
id|cmd.parm.setup.phone
)paren
suffix:semicolon
id|p-&gt;local.dtimer
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_NET_DIAL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;dial: d=%d c=%d&bslash;n&quot;
comma
id|p-&gt;local.isdn_device
comma
id|p-&gt;local.isdn_channel
)paren
suffix:semicolon
macro_line|#endif
id|dev-&gt;drv
(braket
id|p-&gt;local.isdn_device
)braket
op_member_access_from_pointer
id|interface
op_member_access_from_pointer
id|command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
)brace
id|p-&gt;local.huptimer
op_assign
l_int|0
suffix:semicolon
id|p-&gt;local.outgoing
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;local.chargeint
)paren
(brace
id|p-&gt;local.hupflags
op_or_assign
id|ISDN_HAVECHARGE
suffix:semicolon
id|p-&gt;local.hupflags
op_and_assign
op_complement
id|ISDN_WAITCHARGE
suffix:semicolon
)brace
r_else
(brace
id|p-&gt;local.hupflags
op_or_assign
id|ISDN_WAITCHARGE
suffix:semicolon
id|p-&gt;local.hupflags
op_and_assign
op_complement
id|ISDN_HAVECHARGE
suffix:semicolon
)brace
id|anymore
op_assign
l_int|1
suffix:semicolon
id|p-&gt;local.dialstate
op_assign
(paren
id|p-&gt;local.cbdelay
op_logical_and
(paren
id|p-&gt;local.flags
op_amp
id|ISDN_NET_CBOUT
)paren
)paren
ques
c_cond
l_int|12
suffix:colon
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
multiline_comment|/* Wait for D-Channel-connect.&n;&t;&t;&t;&t; * If timeout and max retries not&n;&t;&t;&t;&t; * reached, switch back to state 3.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|p-&gt;local.dtimer
op_increment
OG
id|ISDN_TIMER_DTIMEOUT10
)paren
r_if
c_cond
(paren
id|p-&gt;local.dialretry
OL
id|p-&gt;local.dialmax
)paren
(brace
id|p-&gt;local.dialstate
op_assign
l_int|3
suffix:semicolon
)brace
r_else
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
id|anymore
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
multiline_comment|/* Got D-Channel-Connect, send B-Channel-request */
id|cmd.driver
op_assign
id|p-&gt;local.isdn_device
suffix:semicolon
id|cmd.arg
op_assign
id|p-&gt;local.isdn_channel
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_ACCEPTB
suffix:semicolon
id|anymore
op_assign
l_int|1
suffix:semicolon
id|p-&gt;local.dtimer
op_assign
l_int|0
suffix:semicolon
id|p-&gt;local.dialstate
op_increment
suffix:semicolon
id|dev-&gt;drv
(braket
id|p-&gt;local.isdn_device
)braket
op_member_access_from_pointer
id|interface
op_member_access_from_pointer
id|command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
multiline_comment|/* Wait for B- or D-Channel-connect. If timeout,&n;&t;&t;&t;&t; * switch back to state 3.&n;&t;&t;&t;&t; */
macro_line|#ifdef ISDN_DEBUG_NET_DIAL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;dialtimer2: %d&bslash;n&quot;
comma
id|p-&gt;local.dtimer
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|p-&gt;local.dtimer
op_increment
OG
id|ISDN_TIMER_DTIMEOUT10
)paren
id|p-&gt;local.dialstate
op_assign
l_int|3
suffix:semicolon
id|anymore
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
multiline_comment|/* Got incoming Call, setup L2 and L3 protocols,&n;&t;&t;&t;&t; * then wait for D-Channel-connect&n;&t;&t;&t;&t; */
macro_line|#ifdef ISDN_DEBUG_NET_DIAL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;dialtimer4: %d&bslash;n&quot;
comma
id|p-&gt;local.dtimer
)paren
suffix:semicolon
macro_line|#endif
id|cmd.driver
op_assign
id|p-&gt;local.isdn_device
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_SETL2
suffix:semicolon
id|cmd.arg
op_assign
id|p-&gt;local.isdn_channel
op_plus
(paren
id|p-&gt;local.l2_proto
op_lshift
l_int|8
)paren
suffix:semicolon
id|dev-&gt;drv
(braket
id|p-&gt;local.isdn_device
)braket
op_member_access_from_pointer
id|interface
op_member_access_from_pointer
id|command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|p-&gt;local.isdn_device
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_SETL3
suffix:semicolon
id|cmd.arg
op_assign
id|p-&gt;local.isdn_channel
op_plus
(paren
id|p-&gt;local.l3_proto
op_lshift
l_int|8
)paren
suffix:semicolon
id|dev-&gt;drv
(braket
id|p-&gt;local.isdn_device
)braket
op_member_access_from_pointer
id|interface
op_member_access_from_pointer
id|command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;local.dtimer
op_increment
OG
id|ISDN_TIMER_DTIMEOUT15
)paren
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
r_else
(brace
id|anymore
op_assign
l_int|1
suffix:semicolon
id|p-&gt;local.dialstate
op_increment
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|9
suffix:colon
multiline_comment|/* Got incoming D-Channel-Connect, send B-Channel-request */
id|cmd.driver
op_assign
id|p-&gt;local.isdn_device
suffix:semicolon
id|cmd.arg
op_assign
id|p-&gt;local.isdn_channel
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_ACCEPTB
suffix:semicolon
id|dev-&gt;drv
(braket
id|p-&gt;local.isdn_device
)braket
op_member_access_from_pointer
id|interface
op_member_access_from_pointer
id|command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|anymore
op_assign
l_int|1
suffix:semicolon
id|p-&gt;local.dtimer
op_assign
l_int|0
suffix:semicolon
id|p-&gt;local.dialstate
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
r_case
l_int|10
suffix:colon
multiline_comment|/*  Wait for B- or D-channel-connect */
macro_line|#ifdef ISDN_DEBUG_NET_DIAL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;dialtimer4: %d&bslash;n&quot;
comma
id|p-&gt;local.dtimer
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|p-&gt;local.dtimer
op_increment
OG
id|ISDN_TIMER_DTIMEOUT10
)paren
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
r_else
id|anymore
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|11
suffix:colon
multiline_comment|/* Callback Delay */
r_if
c_cond
(paren
id|p-&gt;local.dtimer
op_increment
OG
id|p-&gt;local.cbdelay
)paren
id|p-&gt;local.dialstate
op_assign
l_int|1
suffix:semicolon
id|anymore
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|12
suffix:colon
multiline_comment|/* Remote does callback. Hangup after cbdelay, then wait for incoming&n;&t;&t;&t;&t; * call (in state 4).&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|p-&gt;local.dtimer
op_increment
OG
id|p-&gt;local.cbdelay
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: hangup waiting for callback ...&bslash;n&quot;
comma
id|p-&gt;local.name
)paren
suffix:semicolon
id|p-&gt;local.dtimer
op_assign
l_int|0
suffix:semicolon
id|p-&gt;local.dialstate
op_assign
l_int|4
suffix:semicolon
id|cmd.driver
op_assign
id|p-&gt;local.isdn_device
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_HANGUP
suffix:semicolon
id|cmd.arg
op_assign
id|p-&gt;local.isdn_channel
suffix:semicolon
(paren
r_void
)paren
id|dev-&gt;drv
(braket
id|cmd.driver
)braket
op_member_access_from_pointer
id|interface
op_member_access_from_pointer
id|command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|isdn_all_eaz
c_func
(paren
id|p-&gt;local.isdn_device
comma
id|p-&gt;local.isdn_channel
)paren
suffix:semicolon
)brace
id|anymore
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net: Illegal dialstate %d for device %s&bslash;n&quot;
comma
id|p-&gt;local.dialstate
comma
id|p-&gt;local.name
)paren
suffix:semicolon
)brace
id|p
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|p-&gt;next
suffix:semicolon
)brace
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_NETDIAL
comma
id|anymore
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Perform hangup for a net-interface.&n; */
r_void
DECL|function|isdn_net_hangup
id|isdn_net_hangup
c_func
(paren
r_struct
id|device
op_star
id|d
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|d-&gt;priv
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
(brace
id|lp-&gt;flags
op_and_assign
op_complement
id|ISDN_NET_CONNECTED
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdn_net: local hangup %s&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
id|isdn_ppp_free
c_func
(paren
id|lp
)paren
suffix:semicolon
macro_line|#endif
id|cmd.driver
op_assign
id|lp-&gt;isdn_device
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_HANGUP
suffix:semicolon
id|cmd.arg
op_assign
id|lp-&gt;isdn_channel
suffix:semicolon
(paren
r_void
)paren
id|dev-&gt;drv
(braket
id|cmd.driver
)braket
op_member_access_from_pointer
id|interface
op_member_access_from_pointer
id|command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Chargesum is %d&bslash;n&quot;
comma
id|lp-&gt;name
comma
id|lp-&gt;charge
)paren
suffix:semicolon
id|isdn_all_eaz
c_func
(paren
id|lp-&gt;isdn_device
comma
id|lp-&gt;isdn_channel
)paren
suffix:semicolon
)brace
id|isdn_net_unbind_channel
c_func
(paren
id|lp
)paren
suffix:semicolon
)brace
r_typedef
r_struct
(brace
DECL|member|source
r_int
r_int
id|source
suffix:semicolon
DECL|member|dest
r_int
r_int
id|dest
suffix:semicolon
DECL|typedef|ip_ports
)brace
id|ip_ports
suffix:semicolon
r_static
r_void
DECL|function|isdn_net_log_packet
id|isdn_net_log_packet
c_func
(paren
id|u_char
op_star
id|buf
comma
id|isdn_net_local
op_star
id|lp
)paren
(brace
id|u_char
op_star
id|p
op_assign
id|buf
suffix:semicolon
r_int
r_int
id|proto
op_assign
id|ETH_P_IP
suffix:semicolon
r_int
id|data_ofs
suffix:semicolon
id|ip_ports
op_star
id|ipp
suffix:semicolon
r_char
id|addinfo
(braket
l_int|100
)braket
suffix:semicolon
id|addinfo
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_switch
c_cond
(paren
id|lp-&gt;p_encap
)paren
(brace
r_case
id|ISDN_NET_ENCAP_IPTYP
suffix:colon
id|proto
op_assign
id|ntohs
c_func
(paren
op_star
(paren
r_int
r_int
op_star
)paren
op_amp
id|buf
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|p
op_assign
op_amp
id|buf
(braket
l_int|2
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_NET_ENCAP_ETHER
suffix:colon
id|proto
op_assign
id|ntohs
c_func
(paren
op_star
(paren
r_int
r_int
op_star
)paren
op_amp
id|buf
(braket
l_int|12
)braket
)paren
suffix:semicolon
id|p
op_assign
op_amp
id|buf
(braket
l_int|14
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_NET_ENCAP_CISCOHDLC
suffix:colon
id|proto
op_assign
id|ntohs
c_func
(paren
op_star
(paren
r_int
r_int
op_star
)paren
op_amp
id|buf
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|p
op_assign
op_amp
id|buf
(braket
l_int|4
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
id|data_ofs
op_assign
(paren
(paren
id|p
(braket
l_int|0
)braket
op_amp
l_int|15
)paren
op_star
l_int|4
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|proto
)paren
(brace
r_case
id|ETH_P_IP
suffix:colon
r_switch
c_cond
(paren
id|p
(braket
l_int|9
)braket
)paren
(brace
r_case
l_int|1
suffix:colon
id|strcpy
c_func
(paren
id|addinfo
comma
l_string|&quot; ICMP&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|strcpy
c_func
(paren
id|addinfo
comma
l_string|&quot; IGMP&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|strcpy
c_func
(paren
id|addinfo
comma
l_string|&quot; IPIP&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|ipp
op_assign
(paren
id|ip_ports
op_star
)paren
(paren
op_amp
id|p
(braket
id|data_ofs
)braket
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|addinfo
comma
l_string|&quot; TCP, port: %d -&gt; %d&quot;
comma
id|ntohs
c_func
(paren
id|ipp-&gt;source
)paren
comma
id|ntohs
c_func
(paren
id|ipp-&gt;dest
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|strcpy
c_func
(paren
id|addinfo
comma
l_string|&quot; EGP&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|12
suffix:colon
id|strcpy
c_func
(paren
id|addinfo
comma
l_string|&quot; PUP&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|17
suffix:colon
id|ipp
op_assign
(paren
id|ip_ports
op_star
)paren
(paren
op_amp
id|p
(braket
id|data_ofs
)braket
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|addinfo
comma
l_string|&quot; UDP, port: %d -&gt; %d&quot;
comma
id|ntohs
c_func
(paren
id|ipp-&gt;source
)paren
comma
id|ntohs
c_func
(paren
id|ipp-&gt;dest
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|22
suffix:colon
id|strcpy
c_func
(paren
id|addinfo
comma
l_string|&quot; IDP&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;OPEN: %d.%d.%d.%d -&gt; %d.%d.%d.%d%s&bslash;n&quot;
comma
id|p
(braket
l_int|12
)braket
comma
id|p
(braket
l_int|13
)braket
comma
id|p
(braket
l_int|14
)braket
comma
id|p
(braket
l_int|15
)braket
comma
id|p
(braket
l_int|16
)braket
comma
id|p
(braket
l_int|17
)braket
comma
id|p
(braket
l_int|18
)braket
comma
id|p
(braket
l_int|19
)braket
comma
id|addinfo
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_ARP
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;OPEN: ARP %d.%d.%d.%d -&gt; *.*.*.* ?%d.%d.%d.%d&bslash;n&quot;
comma
id|p
(braket
l_int|14
)braket
comma
id|p
(braket
l_int|15
)braket
comma
id|p
(braket
l_int|16
)braket
comma
id|p
(braket
l_int|17
)braket
comma
id|p
(braket
l_int|24
)braket
comma
id|p
(braket
l_int|25
)braket
comma
id|p
(braket
l_int|26
)braket
comma
id|p
(braket
l_int|27
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Generic routine to send out an skbuf.&n; * If lowlevel-device does not support supports skbufs, use&n; * standard send-routine, else send directly.&n; *&n; * Return: 0 on success, !0 on failure.&n; * Side-effects: ndev-&gt;tbusy is cleared on success.&n; */
r_int
DECL|function|isdn_net_send_skb
id|isdn_net_send_skb
c_func
(paren
r_struct
id|device
op_star
id|ndev
comma
id|isdn_net_local
op_star
id|lp
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|ret
suffix:semicolon
r_int
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
multiline_comment|/* save len */
id|ret
op_assign
id|isdn_writebuf_skb_stub
c_func
(paren
id|lp-&gt;isdn_device
comma
id|lp-&gt;isdn_channel
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
id|len
)paren
(brace
id|lp-&gt;transcount
op_add_assign
id|len
suffix:semicolon
id|clear_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
(paren
id|ndev-&gt;tbusy
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|SET_SKB_FREE
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|clear_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
(paren
id|ndev-&gt;tbusy
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; *  Helper function for isdn_net_start_xmit.&n; *  When called, the connection is already established.&n; *  Based on cps-calculation, check if device is overloaded.&n; *  If so, and if a slave exists, trigger dialing for it.&n; *  If any slave is online, deliver packets using a simple round robin&n; *  scheme.&n; *&n; *  Return: 0 on success, !0 on failure.&n; */
r_static
r_int
DECL|function|isdn_net_xmit
id|isdn_net_xmit
c_func
(paren
r_struct
id|device
op_star
id|ndev
comma
id|isdn_net_local
op_star
id|lp
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|ret
suffix:semicolon
multiline_comment|/* For the other encaps the header has already been built */
macro_line|#ifdef CONFIG_ISDN_PPP
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_SYNCPPP
)paren
(brace
r_return
id|isdn_ppp_xmit
c_func
(paren
id|skb
comma
id|ndev
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Reset hangup-timeout */
id|lp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;cps
OG
l_int|7000
)paren
(brace
multiline_comment|/* Device overloaded */
multiline_comment|/*&n;&t;&t; * Packet-delivery via round-robin over master&n;&t;&t; * and all connected slaves.&n;&t;&t; */
r_if
c_cond
(paren
id|lp-&gt;master
)paren
multiline_comment|/* Slaves always deliver themselves */
id|ret
op_assign
id|isdn_net_send_skb
c_func
(paren
id|ndev
comma
id|lp
comma
id|skb
)paren
suffix:semicolon
r_else
(brace
id|isdn_net_local
op_star
id|slp
op_assign
(paren
id|isdn_net_local
op_star
)paren
(paren
id|lp-&gt;srobin-&gt;priv
)paren
suffix:semicolon
multiline_comment|/* Master delivers via srobin and maintains srobin */
r_if
c_cond
(paren
id|lp-&gt;srobin
op_eq
id|ndev
)paren
id|ret
op_assign
id|isdn_net_send_skb
c_func
(paren
id|ndev
comma
id|lp
comma
id|skb
)paren
suffix:semicolon
r_else
id|ret
op_assign
id|ndev-&gt;tbusy
op_assign
id|isdn_net_start_xmit
c_func
(paren
id|skb
comma
id|lp-&gt;srobin
)paren
suffix:semicolon
id|lp-&gt;srobin
op_assign
(paren
id|slp-&gt;slave
)paren
ques
c_cond
id|slp-&gt;slave
suffix:colon
id|ndev
suffix:semicolon
id|slp
op_assign
(paren
id|isdn_net_local
op_star
)paren
(paren
id|lp-&gt;srobin-&gt;priv
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|slp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
op_logical_and
(paren
id|slp-&gt;dialstate
op_eq
l_int|0
)paren
)paren
)paren
id|lp-&gt;srobin
op_assign
id|ndev
suffix:semicolon
)brace
multiline_comment|/* Slave-startup using delay-variable */
r_if
c_cond
(paren
id|lp-&gt;slave
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;sqfull
)paren
(brace
multiline_comment|/* First time overload: set timestamp only */
id|lp-&gt;sqfull
op_assign
l_int|1
suffix:semicolon
id|lp-&gt;sqfull_stamp
op_assign
id|jiffies
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* subsequent overload: if slavedelay exceeded, start dialing */
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|lp-&gt;sqfull_stamp
)paren
OG
id|lp-&gt;slavedelay
)paren
id|isdn_net_force_dial_lp
c_func
(paren
(paren
id|isdn_net_local
op_star
)paren
id|lp-&gt;slave-&gt;priv
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* Not overloaded, deliver locally */
id|ret
op_assign
id|isdn_net_send_skb
c_func
(paren
id|ndev
comma
id|lp
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;sqfull
op_logical_and
(paren
(paren
id|jiffies
op_minus
id|lp-&gt;sqfull_stamp
)paren
OG
(paren
id|lp-&gt;slavedelay
op_plus
(paren
l_int|10
op_star
id|HZ
)paren
)paren
)paren
)paren
id|lp-&gt;sqfull
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Try sending a packet.&n; * If this interface isn&squot;t connected to a ISDN-Channel, find a free channel,&n; * and start dialing.&n; */
r_int
DECL|function|isdn_net_start_xmit
id|isdn_net_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|ndev
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|ndev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|ndev-&gt;tbusy
)paren
(brace
r_if
c_cond
(paren
id|jiffies
op_minus
id|ndev-&gt;trans_start
OL
(paren
l_int|2
op_star
id|HZ
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;dialstate
)paren
id|lp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|ndev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|ndev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Avoid timer-based retransmission conflicts. */
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|ndev-&gt;tbusy
)paren
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Transmitter access conflict.&bslash;n&quot;
comma
id|ndev-&gt;name
)paren
suffix:semicolon
r_else
(brace
id|u_char
op_star
id|buf
op_assign
id|skb-&gt;data
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_NET_DUMP
id|isdn_dumppkt
c_func
(paren
l_string|&quot;S:&quot;
comma
id|buf
comma
id|skb-&gt;len
comma
l_int|40
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
)paren
(brace
r_int
id|chi
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;phone
(braket
l_int|1
)braket
)paren
(brace
id|ulong
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Grab a free ISDN-Channel */
r_if
c_cond
(paren
(paren
id|chi
op_assign
id|isdn_get_free_channel
c_func
(paren
id|ISDN_USAGE_NET
comma
id|lp-&gt;l2_proto
comma
id|lp-&gt;l3_proto
comma
id|lp-&gt;pre_device
comma
id|lp-&gt;pre_channel
)paren
)paren
OL
l_int|0
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net_start_xmit: No channel for %s&bslash;n&quot;
comma
id|ndev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* we probably should drop the skb here and return 0 to omit&n;&t;&t;&t;&t;&t;   &squot;socket destroy delayed&squot; messages */
r_return
l_int|1
suffix:semicolon
macro_line|#else
id|isdn_net_unreachable
c_func
(paren
id|ndev
comma
id|skb
comma
l_string|&quot;No channel&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|ndev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Log packet, which triggered dialing */
r_if
c_cond
(paren
id|dev-&gt;net_verbose
)paren
id|isdn_net_log_packet
c_func
(paren
id|buf
comma
id|lp
)paren
suffix:semicolon
id|lp-&gt;dialstate
op_assign
l_int|1
suffix:semicolon
id|lp-&gt;flags
op_or_assign
id|ISDN_NET_CONNECTED
suffix:semicolon
multiline_comment|/* Connect interface with channel */
id|isdn_net_bind_channel
c_func
(paren
id|lp
comma
id|chi
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_SYNCPPP
)paren
(brace
multiline_comment|/* no &squot;first_skb&squot; handling for syncPPP */
r_if
c_cond
(paren
id|isdn_ppp_bind
c_func
(paren
id|lp
)paren
OL
l_int|0
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|isdn_net_unbind_channel
c_func
(paren
id|lp
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* STN (skb to nirvana) ;) */
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|isdn_net_dial
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Initiate dialing */
r_return
l_int|1
suffix:semicolon
multiline_comment|/* let upper layer requeue skb packet */
)brace
macro_line|#endif
multiline_comment|/* remember first skb to speed up arp&n;&t;&t;&t;&t; * when using encap ETHER&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|lp-&gt;first_skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net_start_xmit: First skb already set!&bslash;n&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|lp-&gt;first_skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|lp-&gt;first_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|lp-&gt;first_skb
op_assign
id|skb
suffix:semicolon
multiline_comment|/* Initiate dialing */
id|ndev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|isdn_net_dial
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|isdn_net_unreachable
c_func
(paren
id|ndev
comma
id|skb
comma
l_string|&quot;No phone number&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|ndev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Connection is established, try sending */
id|ndev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;dialstate
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;first_skb
)paren
(brace
r_if
c_cond
(paren
id|isdn_net_xmit
c_func
(paren
id|ndev
comma
id|lp
comma
id|lp-&gt;first_skb
)paren
)paren
r_return
l_int|1
suffix:semicolon
id|lp-&gt;first_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
(paren
id|isdn_net_xmit
c_func
(paren
id|ndev
comma
id|lp
comma
id|skb
)paren
)paren
suffix:semicolon
)brace
r_else
id|ndev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Shutdown a net-interface.&n; */
r_static
r_int
DECL|function|isdn_net_close
id|isdn_net_close
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|device
op_star
id|p
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
op_assign
(paren
(paren
(paren
id|isdn_net_local
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|slave
)paren
)paren
)paren
(brace
multiline_comment|/* If this interface has slaves, stop them also */
r_while
c_loop
(paren
id|p
)paren
(brace
id|isdn_net_hangup
c_func
(paren
id|p
)paren
suffix:semicolon
id|p-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|p-&gt;start
op_assign
l_int|0
suffix:semicolon
id|p
op_assign
(paren
(paren
(paren
id|isdn_net_local
op_star
)paren
id|p-&gt;priv
)paren
op_member_access_from_pointer
id|slave
)paren
suffix:semicolon
)brace
)brace
id|isdn_net_hangup
c_func
(paren
id|dev
)paren
suffix:semicolon
id|isdn_MOD_DEC_USE_COUNT
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Get statistics&n; */
r_static
r_struct
id|enet_statistics
op_star
DECL|function|isdn_net_get_stats
id|isdn_net_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|lp-&gt;stats
suffix:semicolon
)brace
multiline_comment|/*      This is simply a copy from std. eth.c EXCEPT we pull ETH_HLEN&n; *      instead of dev-&gt;hard_header_len off. This is done because the&n; *      lowlevel-driver has already pulled off its stuff when we get&n; *      here and this routine only gets called with p_encap == ETHER.&n; *      Determine the packet&squot;s protocol ID. The rule here is that we&n; *      assume 802.3 if the type field is short enough to be a length.&n; *      This is normal practice and works for any &squot;now in use&squot; protocol.&n; */
r_static
r_int
r_int
DECL|function|isdn_net_type_trans
id|isdn_net_type_trans
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|ethhdr
op_star
id|eth
suffix:semicolon
r_int
r_char
op_star
id|rawp
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
id|ETH_HLEN
)paren
suffix:semicolon
id|eth
op_assign
id|skb-&gt;mac.ethernet
suffix:semicolon
r_if
c_cond
(paren
op_star
id|eth-&gt;h_dest
op_amp
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|eth-&gt;h_dest
comma
id|dev-&gt;broadcast
comma
id|ETH_ALEN
)paren
op_eq
l_int|0
)paren
id|skb-&gt;pkt_type
op_assign
id|PACKET_BROADCAST
suffix:semicolon
r_else
id|skb-&gt;pkt_type
op_assign
id|PACKET_MULTICAST
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *      This ALLMULTI check should be redundant by 1.4&n;&t; *      so don&squot;t forget to remove it.&n;&t; */
r_else
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
(paren
id|IFF_PROMISC
op_or
id|IFF_ALLMULTI
)paren
)paren
(brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|eth-&gt;h_dest
comma
id|dev-&gt;dev_addr
comma
id|ETH_ALEN
)paren
)paren
id|skb-&gt;pkt_type
op_assign
id|PACKET_OTHERHOST
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ntohs
c_func
(paren
id|eth-&gt;h_proto
)paren
op_ge
l_int|1536
)paren
r_return
id|eth-&gt;h_proto
suffix:semicolon
id|rawp
op_assign
id|skb-&gt;data
suffix:semicolon
multiline_comment|/*&n;&t; *      This is a magic hack to spot IPX packets. Older Novell breaks&n;&t; *      the protocol design and runs IPX over 802.3 without an 802.2 LLC&n;&t; *      layer. We look for FFFF which isn&squot;t a used 802.2 SSAP/DSAP. This&n;&t; *      won&squot;t work for fault tolerant netware but does for the rest.&n;&t; */
r_if
c_cond
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|rawp
op_eq
l_int|0xFFFF
)paren
r_return
id|htons
c_func
(paren
id|ETH_P_802_3
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *      Real 802.2 LLC&n;&t; */
r_return
id|htons
c_func
(paren
id|ETH_P_802_2
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Got a packet from ISDN-Channel.&n; */
r_static
r_void
DECL|function|isdn_net_receive
id|isdn_net_receive
c_func
(paren
r_struct
id|device
op_star
id|ndev
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|ndev-&gt;priv
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
id|isdn_net_local
op_star
id|olp
op_assign
id|lp
suffix:semicolon
multiline_comment|/* original &squot;lp&squot; */
r_int
id|proto
op_assign
id|PPP_PROTOCOL
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
macro_line|#endif
id|lp-&gt;transcount
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
multiline_comment|/*&n;&t; * If encapsulation is syncppp, don&squot;t reset&n;&t; * huptimer on LCP packets.&n;&t; */
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_ne
id|ISDN_NET_ENCAP_SYNCPPP
op_logical_or
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_SYNCPPP
op_logical_and
id|proto
op_ne
id|PPP_LCP
)paren
)paren
macro_line|#endif
id|lp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;master
)paren
(brace
multiline_comment|/* Bundling: If device is a slave-device, deliver to master, also&n;&t;&t; * handle master&squot;s statistics and hangup-timeout&n;&t;&t; */
id|ndev
op_assign
id|lp-&gt;master
suffix:semicolon
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|ndev-&gt;priv
suffix:semicolon
id|lp-&gt;stats.rx_packets
op_increment
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
multiline_comment|/*&n;&t;&t; * If encapsulation is syncppp, don&squot;t reset&n;&t;&t; * huptimer on LCP packets.&n;&t;&t; */
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_ne
id|ISDN_NET_ENCAP_SYNCPPP
op_logical_or
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_SYNCPPP
op_logical_and
id|proto
op_ne
id|PPP_LCP
)paren
)paren
macro_line|#endif
id|lp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|ndev
suffix:semicolon
id|skb-&gt;pkt_type
op_assign
id|PACKET_HOST
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_NET_DUMP
id|isdn_dumppkt
c_func
(paren
l_string|&quot;R:&quot;
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
l_int|40
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|lp-&gt;p_encap
)paren
(brace
r_case
id|ISDN_NET_ENCAP_ETHER
suffix:colon
multiline_comment|/* Ethernet over ISDN */
id|skb-&gt;protocol
op_assign
id|isdn_net_type_trans
c_func
(paren
id|skb
comma
id|ndev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_NET_ENCAP_UIHDLC
suffix:colon
multiline_comment|/* HDLC with UI-frame (for ispa with -h1 option) */
id|skb_pull
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Fall through */
r_case
id|ISDN_NET_ENCAP_RAWIP
suffix:colon
multiline_comment|/* RAW-IP without MAC-Header */
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_NET_ENCAP_CISCOHDLC
suffix:colon
multiline_comment|/* CISCO-HDLC IP with type field and  fake I-frame-header */
id|skb_pull
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Fall through */
r_case
id|ISDN_NET_ENCAP_IPTYP
suffix:colon
multiline_comment|/* IP with type field */
id|skb-&gt;protocol
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
op_amp
(paren
id|skb-&gt;data
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|skb-&gt;data
op_eq
l_int|0xFFFF
)paren
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_802_3
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
r_case
id|ISDN_NET_ENCAP_SYNCPPP
suffix:colon
id|isdn_ppp_receive
c_func
(paren
id|lp-&gt;netdev
comma
id|olp
comma
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: unknown encapsulation, dropping&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * A packet arrived via ISDN. Search interface-chain for a corresponding&n; * interface. If found, deliver packet to receiver-function and return 1,&n; * else return 0.&n; */
r_int
DECL|function|isdn_net_rcv_skb
id|isdn_net_rcv_skb
c_func
(paren
r_int
id|idx
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|dev-&gt;rx_netdev
(braket
id|idx
)braket
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
op_amp
id|p-&gt;local
suffix:semicolon
r_if
c_cond
(paren
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
op_logical_and
(paren
op_logical_neg
id|lp-&gt;dialstate
)paren
)paren
(brace
id|isdn_net_receive
c_func
(paren
op_amp
id|p-&gt;dev
comma
id|skb
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|my_eth_header
id|my_eth_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
(brace
r_struct
id|ethhdr
op_star
id|eth
op_assign
(paren
r_struct
id|ethhdr
op_star
)paren
id|skb_push
c_func
(paren
id|skb
comma
id|ETH_HLEN
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set the protocol type. For a packet of type ETH_P_802_3 we&n;&t; * put the length here instead. It is up to the 802.2 layer to&n;&t; * carry protocol information.&n;&t; */
r_if
c_cond
(paren
id|type
op_ne
id|ETH_P_802_3
)paren
id|eth-&gt;h_proto
op_assign
id|htons
c_func
(paren
id|type
)paren
suffix:semicolon
r_else
id|eth-&gt;h_proto
op_assign
id|htons
c_func
(paren
id|len
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set the source hardware address.&n;&t; */
r_if
c_cond
(paren
id|saddr
)paren
id|memcpy
c_func
(paren
id|eth-&gt;h_source
comma
id|saddr
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
r_else
id|memcpy
c_func
(paren
id|eth-&gt;h_source
comma
id|dev-&gt;dev_addr
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Anyway, the loopback-device should never use this function...&n;&t; */
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_LOOPBACK
)paren
(brace
id|memset
c_func
(paren
id|eth-&gt;h_dest
comma
l_int|0
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
r_return
(paren
id|dev-&gt;hard_header_len
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|daddr
)paren
(brace
id|memcpy
c_func
(paren
id|eth-&gt;h_dest
comma
id|daddr
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
r_return
id|dev-&gt;hard_header_len
suffix:semicolon
)brace
r_return
op_minus
id|dev-&gt;hard_header_len
suffix:semicolon
)brace
multiline_comment|/*&n; *  build an header&n; *  depends on encaps that is being used.&n; */
r_static
r_int
DECL|function|isdn_net_header
id|isdn_net_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|plen
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|ushort
id|len
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|lp-&gt;p_encap
)paren
(brace
r_case
id|ISDN_NET_ENCAP_ETHER
suffix:colon
id|len
op_assign
id|my_eth_header
c_func
(paren
id|skb
comma
id|dev
comma
id|type
comma
id|daddr
comma
id|saddr
comma
id|plen
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_NET_ENCAP_RAWIP
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net_header called with RAW_IP!&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_NET_ENCAP_IPTYP
suffix:colon
multiline_comment|/* ethernet type field */
op_star
(paren
(paren
id|ushort
op_star
)paren
id|skb_push
c_func
(paren
id|skb
comma
l_int|2
)paren
)paren
op_assign
id|htons
c_func
(paren
id|type
)paren
suffix:semicolon
id|len
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_NET_ENCAP_UIHDLC
suffix:colon
multiline_comment|/* HDLC with UI-Frames (for ispa with -h1 option) */
op_star
(paren
(paren
id|ushort
op_star
)paren
id|skb_push
c_func
(paren
id|skb
comma
l_int|2
)paren
)paren
op_assign
id|htons
c_func
(paren
l_int|0x0103
)paren
suffix:semicolon
id|len
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_NET_ENCAP_CISCOHDLC
suffix:colon
id|skb_push
c_func
(paren
id|skb
comma
l_int|4
)paren
suffix:semicolon
id|skb-&gt;data
(braket
l_int|0
)braket
op_assign
l_int|0x0f
suffix:semicolon
id|skb-&gt;data
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
op_star
(paren
(paren
id|ushort
op_star
)paren
op_amp
id|skb-&gt;data
(braket
l_int|2
)braket
)paren
op_assign
id|htons
c_func
(paren
id|type
)paren
suffix:semicolon
id|len
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/* We don&squot;t need to send arp, because we have point-to-point connections. */
macro_line|#if (LINUX_VERSION_CODE &lt; 0x02010F)
r_static
r_int
DECL|function|isdn_net_rebuild_header
id|isdn_net_rebuild_header
c_func
(paren
r_void
op_star
id|buff
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|dst
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_ETHER
)paren
(brace
r_struct
id|ethhdr
op_star
id|eth
op_assign
(paren
r_struct
id|ethhdr
op_star
)paren
id|buff
suffix:semicolon
multiline_comment|/*&n;&t;&t; *      Only ARP/IP is currently supported&n;&t;&t; */
r_if
c_cond
(paren
id|eth-&gt;h_proto
op_ne
id|htons
c_func
(paren
id|ETH_P_IP
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net: %s don&squot;t know how to resolve type %d addresses?&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|eth-&gt;h_proto
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|eth-&gt;h_source
comma
id|dev-&gt;dev_addr
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *      Try to get ARP to resolve the header.&n;&t;&t; */
macro_line|#ifdef CONFIG_INET
id|ret
op_assign
id|arp_find
c_func
(paren
id|eth-&gt;h_dest
comma
id|dst
comma
id|dev
comma
id|dev-&gt;pa_addr
comma
id|skb
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
macro_line|#endif
)brace
r_return
id|ret
suffix:semicolon
)brace
macro_line|#else
r_static
r_int
DECL|function|isdn_net_rebuild_header
id|isdn_net_rebuild_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
id|skb-&gt;dev
suffix:semicolon
id|isdn_net_local
op_star
id|lp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_ETHER
)paren
(brace
r_struct
id|ethhdr
op_star
id|eth
op_assign
(paren
r_struct
id|ethhdr
op_star
)paren
id|skb-&gt;data
suffix:semicolon
multiline_comment|/*&n;&t;&t; *      Only ARP/IP is currently supported&n;&t;&t; */
r_if
c_cond
(paren
id|eth-&gt;h_proto
op_ne
id|htons
c_func
(paren
id|ETH_P_IP
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net: %s don&squot;t know how to resolve type %d addresses?&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
r_int
)paren
id|eth-&gt;h_proto
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|eth-&gt;h_source
comma
id|dev-&gt;dev_addr
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *      Try to get ARP to resolve the header.&n;&t;&t; */
macro_line|#ifdef CONFIG_INET
id|ret
op_assign
id|arp_find
c_func
(paren
id|eth-&gt;h_dest
comma
id|skb
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
macro_line|#endif
)brace
r_return
id|ret
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * Interface-setup. (called just after registering a new interface)&n; */
r_static
r_int
DECL|function|isdn_net_init
id|isdn_net_init
c_func
(paren
r_struct
id|device
op_star
id|ndev
)paren
(brace
id|ushort
id|max_hlhdr_len
op_assign
l_int|0
suffix:semicolon
id|isdn_net_local
op_star
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|ndev-&gt;priv
suffix:semicolon
r_int
id|drvidx
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
id|ndev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net_init: dev = NULL!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ndev-&gt;priv
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net_init: dev-&gt;priv = NULL!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|ether_setup
c_func
(paren
id|ndev
)paren
suffix:semicolon
macro_line|#if (LINUX_VERSION_CODE &lt; 0x02010F)
id|lp-&gt;org_hcb
op_assign
id|ndev-&gt;header_cache_bind
suffix:semicolon
macro_line|#else
id|lp-&gt;org_hhc
op_assign
id|ndev-&gt;hard_header_cache
suffix:semicolon
macro_line|#endif
id|lp-&gt;org_hcu
op_assign
id|ndev-&gt;header_cache_update
suffix:semicolon
multiline_comment|/* Setup the generic properties */
id|ndev-&gt;hard_header
op_assign
l_int|NULL
suffix:semicolon
macro_line|#if (LINUX_VERSION_CODE &lt; 0x02010F)
id|ndev-&gt;header_cache_bind
op_assign
l_int|NULL
suffix:semicolon
macro_line|#else
id|ndev-&gt;hard_header_cache
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
id|ndev-&gt;header_cache_update
op_assign
l_int|NULL
suffix:semicolon
id|ndev-&gt;mtu
op_assign
l_int|1500
suffix:semicolon
id|ndev-&gt;flags
op_assign
id|IFF_NOARP
op_or
id|IFF_POINTOPOINT
suffix:semicolon
id|ndev-&gt;type
op_assign
id|ARPHRD_ETHER
suffix:semicolon
id|ndev-&gt;addr_len
op_assign
id|ETH_ALEN
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ETH_ALEN
suffix:semicolon
id|i
op_increment
)paren
id|ndev-&gt;broadcast
(braket
id|i
)braket
op_assign
l_int|0xff
suffix:semicolon
macro_line|#ifdef DEV_NUMBUFFS
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DEV_NUMBUFFS
suffix:semicolon
id|i
op_increment
)paren
id|skb_queue_head_init
c_func
(paren
op_amp
id|ndev-&gt;buffs
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* The ISDN-specific entries in the device structure. */
id|ndev-&gt;open
op_assign
op_amp
id|isdn_net_open
suffix:semicolon
id|ndev-&gt;hard_start_xmit
op_assign
op_amp
id|isdn_net_start_xmit
suffix:semicolon
multiline_comment|/*&n;&t; *  up till binding we ask the protocol layer to reserve as much&n;&t; *  as we might need for HL layer&n;&t; */
r_for
c_loop
(paren
id|drvidx
op_assign
l_int|0
suffix:semicolon
id|drvidx
OL
id|ISDN_MAX_DRIVERS
suffix:semicolon
id|drvidx
op_increment
)paren
r_if
c_cond
(paren
id|dev-&gt;drv
(braket
id|drvidx
)braket
)paren
r_if
c_cond
(paren
id|max_hlhdr_len
OL
id|dev-&gt;drv
(braket
id|drvidx
)braket
op_member_access_from_pointer
id|interface-&gt;hl_hdrlen
)paren
id|max_hlhdr_len
op_assign
id|dev-&gt;drv
(braket
id|drvidx
)braket
op_member_access_from_pointer
id|interface-&gt;hl_hdrlen
suffix:semicolon
id|ndev-&gt;hard_header_len
op_assign
id|ETH_HLEN
op_plus
id|max_hlhdr_len
suffix:semicolon
id|ndev-&gt;stop
op_assign
op_amp
id|isdn_net_close
suffix:semicolon
id|ndev-&gt;get_stats
op_assign
op_amp
id|isdn_net_get_stats
suffix:semicolon
id|ndev-&gt;rebuild_header
op_assign
op_amp
id|isdn_net_rebuild_header
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
id|ndev-&gt;do_ioctl
op_assign
id|isdn_ppp_dev_ioctl
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * I picked the pattern-matching-functions from an old GNU-tar version (1.10)&n; * It was originally written and put to PD by rs@mirror.TMC.COM (Rich Salz)&n; */
r_static
r_int
DECL|function|isdn_net_Star
id|isdn_net_Star
c_func
(paren
r_char
op_star
id|s
comma
r_char
op_star
id|p
)paren
(brace
r_while
c_loop
(paren
id|isdn_net_wildmat
c_func
(paren
id|s
comma
id|p
)paren
op_eq
l_int|0
)paren
r_if
c_cond
(paren
op_star
op_increment
id|s
op_eq
l_char|&squot;&bslash;0&squot;
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Shell-type Pattern-matching for incoming caller-Ids&n; * This function gets a string in s and checks, if it matches the pattern&n; * given in p. It returns 1 on success, 0 otherwise.&n; *&n; * Possible Patterns:&n; *&n; * &squot;?&squot;     matches one character&n; * &squot;*&squot;     matches zero or more characters&n; * [xyz]   matches the set of characters in brackets.&n; * [^xyz]  matches any single character not in the set of characters&n; */
r_static
r_int
DECL|function|isdn_net_wildmat
id|isdn_net_wildmat
c_func
(paren
r_char
op_star
id|s
comma
r_char
op_star
id|p
)paren
(brace
r_register
r_int
id|last
suffix:semicolon
r_register
r_int
id|matched
suffix:semicolon
r_register
r_int
id|reverse
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
op_star
id|p
suffix:semicolon
id|s
op_increment
comma
id|p
op_increment
)paren
r_switch
c_cond
(paren
op_star
id|p
)paren
(brace
r_case
l_char|&squot;&bslash;&bslash;&squot;
suffix:colon
multiline_comment|/*&n;&t;&t;&t;&t; * Literal match with following character,&n;&t;&t;&t;&t; * fall through.&n;&t;&t;&t;&t; */
id|p
op_increment
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
op_star
id|s
op_ne
op_star
id|p
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_continue
suffix:semicolon
r_case
l_char|&squot;?&squot;
suffix:colon
multiline_comment|/* Match anything. */
r_if
c_cond
(paren
op_star
id|s
op_eq
l_char|&squot;&bslash;0&squot;
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_continue
suffix:semicolon
r_case
l_char|&squot;*&squot;
suffix:colon
multiline_comment|/* Trailing star matches everything. */
r_return
(paren
op_star
op_increment
id|p
ques
c_cond
id|isdn_net_Star
c_func
(paren
id|s
comma
id|p
)paren
suffix:colon
l_int|1
)paren
suffix:semicolon
r_case
l_char|&squot;[&squot;
suffix:colon
multiline_comment|/* [^....] means inverse character class. */
r_if
c_cond
(paren
(paren
id|reverse
op_assign
(paren
id|p
(braket
l_int|1
)braket
op_eq
l_char|&squot;^&squot;
)paren
)paren
)paren
id|p
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|last
op_assign
l_int|0
comma
id|matched
op_assign
l_int|0
suffix:semicolon
op_star
op_increment
id|p
op_logical_and
(paren
op_star
id|p
op_ne
l_char|&squot;]&squot;
)paren
suffix:semicolon
id|last
op_assign
op_star
id|p
)paren
multiline_comment|/* This next line requires a good C compiler. */
r_if
c_cond
(paren
op_star
id|p
op_eq
l_char|&squot;-&squot;
ques
c_cond
op_star
id|s
op_le
op_star
op_increment
id|p
op_logical_and
op_star
id|s
op_ge
id|last
suffix:colon
op_star
id|s
op_eq
op_star
id|p
)paren
id|matched
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|matched
op_eq
id|reverse
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_return
(paren
op_star
id|s
op_eq
l_char|&squot;&bslash;0&squot;
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|isdn_net_swapbind
id|isdn_net_swapbind
c_func
(paren
r_int
id|drvidx
)paren
(brace
id|isdn_net_dev
op_star
id|p
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: swapping ch of %d&bslash;n&quot;
comma
id|drvidx
)paren
suffix:semicolon
macro_line|#endif
id|p
op_assign
id|dev-&gt;netdev
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;local.pre_device
op_eq
id|drvidx
)paren
r_switch
c_cond
(paren
id|p-&gt;local.pre_channel
)paren
(brace
r_case
l_int|0
suffix:colon
id|p-&gt;local.pre_channel
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|p-&gt;local.pre_channel
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|p
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|p-&gt;next
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|isdn_net_swap_usage
id|isdn_net_swap_usage
c_func
(paren
r_int
id|i1
comma
r_int
id|i2
)paren
(brace
r_int
id|u1
op_assign
id|dev-&gt;usage
(braket
id|i1
)braket
op_amp
id|ISDN_USAGE_EXCLUSIVE
suffix:semicolon
r_int
id|u2
op_assign
id|dev-&gt;usage
(braket
id|i2
)braket
op_amp
id|ISDN_USAGE_EXCLUSIVE
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: usage of %d and %d&bslash;n&quot;
comma
id|i1
comma
id|i2
)paren
suffix:semicolon
macro_line|#endif
id|dev-&gt;usage
(braket
id|i1
)braket
op_and_assign
op_complement
id|ISDN_USAGE_EXCLUSIVE
suffix:semicolon
id|dev-&gt;usage
(braket
id|i1
)braket
op_or_assign
id|u2
suffix:semicolon
id|dev-&gt;usage
(braket
id|i2
)braket
op_and_assign
op_complement
id|ISDN_USAGE_EXCLUSIVE
suffix:semicolon
id|dev-&gt;usage
(braket
id|i2
)braket
op_or_assign
id|u1
suffix:semicolon
id|isdn_info_update
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * An incoming call-request has arrived.&n; * Search the interface-chain for an appropriate interface.&n; * If found, connect the interface to the ISDN-channel and initiate&n; * D- and B-Channel-setup. If secure-flag is set, accept only&n; * configured phone-numbers. If callback-flag is set, initiate&n; * callback-dialing.&n; *&n; * Return-Value: 0 = No appropriate interface for this call.&n; *               1 = Call accepted&n; *               2 = Reject call, wait cbdelay, then call back&n; *               3 = Reject call&n; *               4 = Wait cbdelay, then call back&n; */
r_int
DECL|function|isdn_net_find_icall
id|isdn_net_find_icall
c_func
(paren
r_int
id|di
comma
r_int
id|ch
comma
r_int
id|idx
comma
id|setup_parm
id|setup
)paren
(brace
r_char
op_star
id|eaz
suffix:semicolon
r_int
id|si1
suffix:semicolon
r_int
id|si2
suffix:semicolon
r_int
id|ematch
suffix:semicolon
r_int
id|swapped
suffix:semicolon
r_int
id|sidx
op_assign
l_int|0
suffix:semicolon
id|isdn_net_dev
op_star
id|p
suffix:semicolon
id|isdn_net_phone
op_star
id|n
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
r_char
id|nr
(braket
l_int|32
)braket
suffix:semicolon
multiline_comment|/* Search name in netdev-chain */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|setup.phone
(braket
l_int|0
)braket
)paren
(brace
id|nr
(braket
l_int|0
)braket
op_assign
l_char|&squot;0&squot;
suffix:semicolon
id|nr
(braket
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdn_net: Incoming call without OAD, assuming &squot;0&squot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
id|strcpy
c_func
(paren
id|nr
comma
id|setup.phone
)paren
suffix:semicolon
id|si1
op_assign
(paren
r_int
)paren
id|setup.si1
suffix:semicolon
id|si2
op_assign
(paren
r_int
)paren
id|setup.si2
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|setup.eazmsn
(braket
l_int|0
)braket
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net: Incoming call without CPN, assuming &squot;0&squot;&bslash;n&quot;
)paren
suffix:semicolon
id|eaz
op_assign
l_string|&quot;0&quot;
suffix:semicolon
)brace
r_else
id|eaz
op_assign
id|setup.eazmsn
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;net_verbose
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdn_net: call from %s,%d,%d -&gt; %s&bslash;n&quot;
comma
id|nr
comma
id|si1
comma
id|si2
comma
id|eaz
)paren
suffix:semicolon
multiline_comment|/* Accept only calls with Si1 = 7 (Data-Transmission) */
r_if
c_cond
(paren
id|si1
op_ne
l_int|7
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;net_verbose
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdn_net: Service-Indicator not 7, ignored&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|n
op_assign
(paren
id|isdn_net_phone
op_star
)paren
l_int|0
suffix:semicolon
id|p
op_assign
id|dev-&gt;netdev
suffix:semicolon
id|ematch
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: di=%d ch=%d idx=%d usg=%d&bslash;n&quot;
comma
id|di
comma
id|ch
comma
id|idx
comma
id|dev-&gt;usage
(braket
id|idx
)braket
)paren
suffix:semicolon
macro_line|#endif
id|swapped
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
multiline_comment|/* If last check has triggered as binding-swap, revert it */
r_switch
c_cond
(paren
id|swapped
)paren
(brace
r_case
l_int|2
suffix:colon
id|isdn_net_swap_usage
c_func
(paren
id|idx
comma
id|sidx
)paren
suffix:semicolon
multiline_comment|/* fall through */
r_case
l_int|1
suffix:colon
id|isdn_net_swapbind
c_func
(paren
id|di
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|swapped
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|isdn_map_eaz2msn
c_func
(paren
id|p-&gt;local.msn
comma
id|di
)paren
comma
id|eaz
)paren
)paren
id|ematch
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: if=&squot;%s&squot;, l.msn=%s, l.flags=%d, l.dstate=%d&bslash;n&quot;
comma
id|p-&gt;local.name
comma
id|p-&gt;local.msn
comma
id|p-&gt;local.flags
comma
id|p-&gt;local.dialstate
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|isdn_map_eaz2msn
c_func
(paren
id|p-&gt;local.msn
comma
id|di
)paren
comma
id|eaz
)paren
)paren
op_logical_and
multiline_comment|/* EAZ is matching   */
(paren
(paren
(paren
op_logical_neg
(paren
id|p-&gt;local.flags
op_amp
id|ISDN_NET_CONNECTED
)paren
)paren
op_logical_and
multiline_comment|/* but not connected */
(paren
id|USG_NONE
c_func
(paren
id|dev-&gt;usage
(braket
id|idx
)braket
)paren
)paren
)paren
op_logical_or
multiline_comment|/* and ch. unused or */
(paren
(paren
(paren
(paren
id|p-&gt;local.dialstate
op_eq
l_int|4
)paren
op_logical_or
(paren
id|p-&gt;local.dialstate
op_eq
l_int|12
)paren
)paren
op_logical_and
multiline_comment|/* if dialing        */
(paren
op_logical_neg
(paren
id|p-&gt;local.flags
op_amp
id|ISDN_NET_CALLBACK
)paren
)paren
)paren
multiline_comment|/* but no callback   */
)paren
)paren
)paren
(brace
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: match1, pdev=%d pch=%d&bslash;n&quot;
comma
id|p-&gt;local.pre_device
comma
id|p-&gt;local.pre_channel
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|dev-&gt;usage
(braket
id|idx
)braket
op_amp
id|ISDN_USAGE_EXCLUSIVE
)paren
(brace
r_if
c_cond
(paren
(paren
id|p-&gt;local.pre_channel
op_ne
id|ch
)paren
op_logical_or
(paren
id|p-&gt;local.pre_device
op_ne
id|di
)paren
)paren
(brace
multiline_comment|/* Here we got a problem:&n;&t;&t;&t;&t;&t; * If using an ICN-Card, an incoming call is always signaled on&n;&t;&t;&t;&t;&t; * on the first channel of the card, if both channels are&n;&t;&t;&t;&t;&t; * down. However this channel may be bound exclusive. If the&n;&t;&t;&t;&t;&t; * second channel is free, this call should be accepted.&n;&t;&t;&t;&t;&t; * The solution is horribly but it runs, so what:&n;&t;&t;&t;&t;&t; * We exchange the exclusive bindings of the two channels, the&n;&t;&t;&t;&t;&t; * corresponding variables in the interface-structs.&n;&t;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|ch
op_eq
l_int|0
)paren
(brace
id|sidx
op_assign
id|isdn_dc2minor
c_func
(paren
id|di
comma
l_int|1
)paren
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: ch is 0&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|USG_NONE
c_func
(paren
id|dev-&gt;usage
(braket
id|sidx
)braket
)paren
)paren
(brace
multiline_comment|/* Second Channel is free, now see if it is bound&n;&t;&t;&t;&t;&t;&t;&t; * exclusive too. */
r_if
c_cond
(paren
id|dev-&gt;usage
(braket
id|sidx
)braket
op_amp
id|ISDN_USAGE_EXCLUSIVE
)paren
(brace
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: 2nd channel is down and bound&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Yes, swap bindings only, if the original&n;&t;&t;&t;&t;&t;&t;&t;&t; * binding is bound to channel 1 of this driver */
r_if
c_cond
(paren
(paren
id|p-&gt;local.pre_device
op_eq
id|di
)paren
op_logical_and
(paren
id|p-&gt;local.pre_channel
op_eq
l_int|1
)paren
)paren
(brace
id|isdn_net_swapbind
c_func
(paren
id|di
)paren
suffix:semicolon
id|swapped
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* ... else iterate next device */
id|p
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|p-&gt;next
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
r_else
(brace
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: 2nd channel is down and unbound&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* No, swap always and swap excl-usage also */
id|isdn_net_swap_usage
c_func
(paren
id|idx
comma
id|sidx
)paren
suffix:semicolon
id|isdn_net_swapbind
c_func
(paren
id|di
)paren
suffix:semicolon
id|swapped
op_assign
l_int|2
suffix:semicolon
)brace
multiline_comment|/* Now check for exclusive binding again */
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: final check&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|dev-&gt;usage
(braket
id|idx
)braket
op_amp
id|ISDN_USAGE_EXCLUSIVE
)paren
op_logical_and
(paren
(paren
id|p-&gt;local.pre_channel
op_ne
id|ch
)paren
op_logical_or
(paren
id|p-&gt;local.pre_device
op_ne
id|di
)paren
)paren
)paren
(brace
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: final check failed&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|p
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|p-&gt;next
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* We are already on the second channel, so nothing to do */
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: already on 2nd channel&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|p
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|p-&gt;next
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
)brace
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: match2&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|n
op_assign
id|p-&gt;local.phone
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;local.flags
op_amp
id|ISDN_NET_SECURE
)paren
(brace
r_while
c_loop
(paren
id|n
)paren
(brace
r_if
c_cond
(paren
id|isdn_net_wildmat
c_func
(paren
id|nr
comma
id|n-&gt;num
)paren
)paren
r_break
suffix:semicolon
id|n
op_assign
(paren
id|isdn_net_phone
op_star
)paren
id|n-&gt;next
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|n
op_logical_or
(paren
op_logical_neg
(paren
id|p-&gt;local.flags
op_amp
id|ISDN_NET_SECURE
)paren
)paren
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
op_amp
(paren
id|p-&gt;local
)paren
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_NET_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;n_fi: match3&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Here we got an interface matched, now see if it is up.&n;&t;&t;&t;&t; * If not, reject the call actively.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;dev.start
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: incoming call, if down -&gt; rejected&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
r_return
l_int|3
suffix:semicolon
)brace
multiline_comment|/* Interface is up, now see if it&squot;s a slave. If so, see if&n;&t;&t;&t;&t; * it&squot;s master and parent slave is online. If not, reject the call.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|lp-&gt;master
)paren
(brace
id|isdn_net_local
op_star
id|mlp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|lp-&gt;master-&gt;priv
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ICALLslv: %s&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;master=%s&bslash;n&quot;
comma
id|mlp-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mlp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;master online&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Master is online, find parent-slave (master if first slave) */
r_while
c_loop
(paren
id|mlp-&gt;slave
)paren
(brace
r_if
c_cond
(paren
(paren
id|isdn_net_local
op_star
)paren
id|mlp-&gt;slave-&gt;priv
op_eq
id|lp
)paren
r_break
suffix:semicolon
id|mlp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|mlp-&gt;slave-&gt;priv
suffix:semicolon
)brace
)brace
r_else
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;master offline&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Found parent, if it&squot;s offline iterate next device */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;mlpf: %d&bslash;n&quot;
comma
id|mlp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mlp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
)paren
(brace
id|p
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|p-&gt;next
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CALLBACK
)paren
(brace
r_int
id|chi
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: call from %s -&gt; %s, start callback&bslash;n&quot;
comma
id|lp-&gt;name
comma
id|nr
comma
id|eaz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;phone
(braket
l_int|1
)braket
)paren
(brace
multiline_comment|/* Grab a free ISDN-Channel */
r_if
c_cond
(paren
(paren
id|chi
op_assign
id|isdn_get_free_channel
c_func
(paren
id|ISDN_USAGE_NET
comma
id|lp-&gt;l2_proto
comma
id|lp-&gt;l3_proto
comma
id|lp-&gt;pre_device
comma
id|lp-&gt;pre_channel
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net_find_icall: No channel for %s&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Setup dialstate. */
id|lp-&gt;dtimer
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;dialstate
op_assign
l_int|11
suffix:semicolon
id|lp-&gt;flags
op_or_assign
id|ISDN_NET_CONNECTED
suffix:semicolon
multiline_comment|/* Connect interface with channel */
id|isdn_net_bind_channel
c_func
(paren
id|lp
comma
id|chi
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_SYNCPPP
)paren
r_if
c_cond
(paren
id|isdn_ppp_bind
c_func
(paren
id|lp
)paren
OL
l_int|0
)paren
(brace
id|isdn_net_unbind_channel
c_func
(paren
id|lp
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Initiate dialing by returning 2 or 4 */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CBHUP
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|4
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net: %s: No phone number&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: call from %s -&gt; %s accepted&bslash;n&quot;
comma
id|lp-&gt;name
comma
id|nr
comma
id|eaz
)paren
suffix:semicolon
multiline_comment|/* if this interface is dialing, it does it probably on a different&n;&t;&t;&t;&t;&t;   device, so free this device */
r_if
c_cond
(paren
(paren
id|p-&gt;local.dialstate
op_eq
l_int|4
)paren
op_logical_or
(paren
id|p-&gt;local.dialstate
op_eq
l_int|12
)paren
)paren
(brace
macro_line|#ifdef CONFIG_ISDN_PPP
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_SYNCPPP
)paren
id|isdn_ppp_free
c_func
(paren
id|lp
)paren
suffix:semicolon
macro_line|#endif
id|isdn_free_channel
c_func
(paren
id|p-&gt;local.isdn_device
comma
id|p-&gt;local.isdn_channel
comma
id|ISDN_USAGE_NET
)paren
suffix:semicolon
)brace
id|dev-&gt;usage
(braket
id|idx
)braket
op_and_assign
id|ISDN_USAGE_EXCLUSIVE
suffix:semicolon
id|dev-&gt;usage
(braket
id|idx
)braket
op_or_assign
id|ISDN_USAGE_NET
suffix:semicolon
id|strcpy
c_func
(paren
id|dev-&gt;num
(braket
id|idx
)braket
comma
id|nr
)paren
suffix:semicolon
id|isdn_info_update
c_func
(paren
)paren
suffix:semicolon
id|dev-&gt;st_netdev
(braket
id|idx
)braket
op_assign
id|lp-&gt;netdev
suffix:semicolon
id|p-&gt;local.isdn_device
op_assign
id|di
suffix:semicolon
id|p-&gt;local.isdn_channel
op_assign
id|ch
suffix:semicolon
id|p-&gt;local.ppp_slot
op_assign
op_minus
l_int|1
suffix:semicolon
id|p-&gt;local.flags
op_or_assign
id|ISDN_NET_CONNECTED
suffix:semicolon
id|p-&gt;local.dialstate
op_assign
l_int|7
suffix:semicolon
id|p-&gt;local.dtimer
op_assign
l_int|0
suffix:semicolon
id|p-&gt;local.outgoing
op_assign
l_int|0
suffix:semicolon
id|p-&gt;local.huptimer
op_assign
l_int|0
suffix:semicolon
id|p-&gt;local.hupflags
op_or_assign
id|ISDN_WAITCHARGE
suffix:semicolon
id|p-&gt;local.hupflags
op_and_assign
op_complement
id|ISDN_HAVECHARGE
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_SYNCPPP
)paren
r_if
c_cond
(paren
id|isdn_ppp_bind
c_func
(paren
id|lp
)paren
OL
l_int|0
)paren
(brace
id|isdn_net_unbind_channel
c_func
(paren
id|lp
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
)brace
id|p
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|p-&gt;next
suffix:semicolon
)brace
multiline_comment|/* If none of configured EAZ/MSN matched and not verbose, be silent */
r_if
c_cond
(paren
id|ematch
op_logical_or
id|dev-&gt;net_verbose
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdn_net: call from %s -&gt; %d %s ignored&bslash;n&quot;
comma
id|nr
comma
id|di
comma
id|eaz
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Search list of net-interfaces for an interface with given name.&n; */
id|isdn_net_dev
op_star
DECL|function|isdn_net_findif
id|isdn_net_findif
c_func
(paren
r_char
op_star
id|name
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|dev-&gt;netdev
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|p-&gt;local.name
comma
id|name
)paren
)paren
r_return
id|p
suffix:semicolon
id|p
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|p-&gt;next
suffix:semicolon
)brace
r_return
(paren
id|isdn_net_dev
op_star
)paren
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Force a net-interface to dial out.&n; * This is called from the userlevel-routine below or&n; * from isdn_net_start_xmit().&n; */
r_int
DECL|function|isdn_net_force_dial_lp
id|isdn_net_force_dial_lp
c_func
(paren
id|isdn_net_local
op_star
id|lp
)paren
(brace
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
)paren
op_logical_and
op_logical_neg
id|lp-&gt;dialstate
)paren
(brace
r_int
id|chi
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;phone
(braket
l_int|1
)braket
)paren
(brace
id|ulong
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Grab a free ISDN-Channel */
r_if
c_cond
(paren
(paren
id|chi
op_assign
id|isdn_get_free_channel
c_func
(paren
id|ISDN_USAGE_NET
comma
id|lp-&gt;l2_proto
comma
id|lp-&gt;l3_proto
comma
id|lp-&gt;pre_device
comma
id|lp-&gt;pre_channel
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net_force_dial: No channel for %s&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|lp-&gt;dialstate
op_assign
l_int|1
suffix:semicolon
id|lp-&gt;flags
op_or_assign
id|ISDN_NET_CONNECTED
suffix:semicolon
multiline_comment|/* Connect interface with channel */
id|isdn_net_bind_channel
c_func
(paren
id|lp
comma
id|chi
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_SYNCPPP
)paren
r_if
c_cond
(paren
id|isdn_ppp_bind
c_func
(paren
id|lp
)paren
OL
l_int|0
)paren
(brace
id|isdn_net_unbind_channel
c_func
(paren
id|lp
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Initiate dialing */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|isdn_net_dial
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/*&n; * Force a net-interface to dial out.&n; * This is always called from within userspace (ISDN_IOCTL_NET_DIAL).&n; */
r_int
DECL|function|isdn_net_force_dial
id|isdn_net_force_dial
c_func
(paren
r_char
op_star
id|name
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|isdn_net_findif
c_func
(paren
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
(paren
id|isdn_net_force_dial_lp
c_func
(paren
op_amp
id|p-&gt;local
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Allocate a new network-interface and initialize its data structures.&n; */
r_char
op_star
DECL|function|isdn_net_new
id|isdn_net_new
c_func
(paren
r_char
op_star
id|name
comma
r_struct
id|device
op_star
id|master
)paren
(brace
id|isdn_net_dev
op_star
id|netdev
suffix:semicolon
multiline_comment|/* Avoid creating an existing interface */
r_if
c_cond
(paren
id|isdn_net_findif
c_func
(paren
id|name
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net: interface %s already exists&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|netdev
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|isdn_net_dev
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net: Could not allocate net-device&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|netdev
comma
l_int|0
comma
r_sizeof
(paren
id|isdn_net_dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|name
op_eq
l_int|NULL
)paren
id|strcpy
c_func
(paren
id|netdev-&gt;local.name
comma
l_string|&quot;         &quot;
)paren
suffix:semicolon
r_else
id|strcpy
c_func
(paren
id|netdev-&gt;local.name
comma
id|name
)paren
suffix:semicolon
id|netdev-&gt;dev.name
op_assign
id|netdev-&gt;local.name
suffix:semicolon
id|netdev-&gt;dev.priv
op_assign
op_amp
id|netdev-&gt;local
suffix:semicolon
id|netdev-&gt;dev.init
op_assign
id|isdn_net_init
suffix:semicolon
id|netdev-&gt;local.p_encap
op_assign
id|ISDN_NET_ENCAP_RAWIP
suffix:semicolon
r_if
c_cond
(paren
id|master
)paren
(brace
multiline_comment|/* Device shall be a slave */
r_struct
id|device
op_star
id|p
op_assign
(paren
(paren
(paren
id|isdn_net_local
op_star
)paren
id|master-&gt;priv
)paren
op_member_access_from_pointer
id|slave
)paren
suffix:semicolon
r_struct
id|device
op_star
id|q
op_assign
id|master
suffix:semicolon
id|netdev-&gt;local.master
op_assign
id|master
suffix:semicolon
multiline_comment|/* Put device at end of slave-chain */
r_while
c_loop
(paren
id|p
)paren
(brace
id|q
op_assign
id|p
suffix:semicolon
id|p
op_assign
(paren
(paren
(paren
id|isdn_net_local
op_star
)paren
id|p-&gt;priv
)paren
op_member_access_from_pointer
id|slave
)paren
suffix:semicolon
)brace
(paren
(paren
id|isdn_net_local
op_star
)paren
id|q-&gt;priv
)paren
op_member_access_from_pointer
id|slave
op_assign
op_amp
(paren
id|netdev-&gt;dev
)paren
suffix:semicolon
id|q-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
id|q-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|q-&gt;start
op_assign
id|master-&gt;start
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Device shall be a master */
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
op_amp
id|netdev-&gt;dev
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net: Could not register net-device&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|netdev
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
id|netdev-&gt;local.magic
op_assign
id|ISDN_NET_MAGIC
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
id|netdev-&gt;mp_last
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* mpqueue is empty */
id|netdev-&gt;ib.next_num
op_assign
l_int|0
suffix:semicolon
id|netdev-&gt;ib.last
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
id|netdev-&gt;queue
op_assign
op_amp
id|netdev-&gt;local
suffix:semicolon
id|netdev-&gt;local.last
op_assign
op_amp
id|netdev-&gt;local
suffix:semicolon
id|netdev-&gt;local.netdev
op_assign
id|netdev
suffix:semicolon
id|netdev-&gt;local.next
op_assign
op_amp
id|netdev-&gt;local
suffix:semicolon
id|netdev-&gt;local.isdn_device
op_assign
op_minus
l_int|1
suffix:semicolon
id|netdev-&gt;local.isdn_channel
op_assign
op_minus
l_int|1
suffix:semicolon
id|netdev-&gt;local.pre_device
op_assign
op_minus
l_int|1
suffix:semicolon
id|netdev-&gt;local.pre_channel
op_assign
op_minus
l_int|1
suffix:semicolon
id|netdev-&gt;local.exclusive
op_assign
op_minus
l_int|1
suffix:semicolon
id|netdev-&gt;local.ppp_slot
op_assign
op_minus
l_int|1
suffix:semicolon
id|netdev-&gt;local.pppbind
op_assign
op_minus
l_int|1
suffix:semicolon
id|netdev-&gt;local.sav_skb
op_assign
l_int|NULL
suffix:semicolon
id|netdev-&gt;local.first_skb
op_assign
l_int|NULL
suffix:semicolon
id|netdev-&gt;local.l2_proto
op_assign
id|ISDN_PROTO_L2_X75I
suffix:semicolon
id|netdev-&gt;local.l3_proto
op_assign
id|ISDN_PROTO_L3_TRANS
suffix:semicolon
id|netdev-&gt;local.slavedelay
op_assign
l_int|10
op_star
id|HZ
suffix:semicolon
id|netdev-&gt;local.srobin
op_assign
op_amp
id|netdev-&gt;dev
suffix:semicolon
id|netdev-&gt;local.hupflags
op_assign
id|ISDN_INHUP
suffix:semicolon
multiline_comment|/* Do hangup even on incoming calls */
id|netdev-&gt;local.onhtime
op_assign
l_int|10
suffix:semicolon
multiline_comment|/* Default hangup-time for saving costs&n;&t;   of those who forget configuring this */
id|netdev-&gt;local.dialmax
op_assign
l_int|1
suffix:semicolon
id|netdev-&gt;local.flags
op_assign
id|ISDN_NET_CBHUP
suffix:semicolon
multiline_comment|/* Hangup before Callback */
id|netdev-&gt;local.cbdelay
op_assign
l_int|25
suffix:semicolon
multiline_comment|/* Wait 5 secs before Callback */
multiline_comment|/* Put into to netdev-chain */
id|netdev-&gt;next
op_assign
(paren
r_void
op_star
)paren
id|dev-&gt;netdev
suffix:semicolon
id|dev-&gt;netdev
op_assign
id|netdev
suffix:semicolon
r_return
id|netdev-&gt;dev.name
suffix:semicolon
)brace
r_char
op_star
DECL|function|isdn_net_newslave
id|isdn_net_newslave
c_func
(paren
r_char
op_star
id|parm
)paren
(brace
r_char
op_star
id|p
op_assign
id|strchr
c_func
(paren
id|parm
comma
l_char|&squot;,&squot;
)paren
suffix:semicolon
id|isdn_net_dev
op_star
id|n
suffix:semicolon
r_char
id|newname
(braket
l_int|10
)braket
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
multiline_comment|/* Slave-Name MUST not be empty */
r_if
c_cond
(paren
op_logical_neg
id|strlen
c_func
(paren
id|p
op_plus
l_int|1
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
id|strcpy
c_func
(paren
id|newname
comma
id|p
op_plus
l_int|1
)paren
suffix:semicolon
op_star
id|p
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Master must already exist */
r_if
c_cond
(paren
op_logical_neg
(paren
id|n
op_assign
id|isdn_net_findif
c_func
(paren
id|parm
)paren
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* Master must be a real interface, not a slave */
r_if
c_cond
(paren
id|n-&gt;local.master
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* Master must not be started yet */
r_if
c_cond
(paren
id|n-&gt;dev.start
)paren
r_return
l_int|NULL
suffix:semicolon
r_return
(paren
id|isdn_net_new
c_func
(paren
id|newname
comma
op_amp
(paren
id|n-&gt;dev
)paren
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Set interface-parameters.&n; * Always set all parameters, so the user-level application is responsible&n; * for not overwriting existing setups. It has to get the current&n; * setup first, if only selected parameters are to be changed.&n; */
r_int
DECL|function|isdn_net_setcfg
id|isdn_net_setcfg
c_func
(paren
id|isdn_net_ioctl_cfg
op_star
id|cfg
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|isdn_net_findif
c_func
(paren
id|cfg-&gt;name
)paren
suffix:semicolon
id|ulong
id|features
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|drvidx
suffix:semicolon
r_int
id|chidx
suffix:semicolon
r_char
id|drvid
(braket
l_int|25
)braket
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
multiline_comment|/* See if any registered driver supports the features we want */
id|features
op_assign
(paren
l_int|1
op_lshift
id|cfg-&gt;l2_proto
)paren
op_or
(paren
l_int|256
op_lshift
id|cfg-&gt;l3_proto
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_MAX_DRIVERS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|dev-&gt;drv
(braket
id|i
)braket
)paren
r_if
c_cond
(paren
(paren
id|dev-&gt;drv
(braket
id|i
)braket
op_member_access_from_pointer
id|interface-&gt;features
op_amp
id|features
)paren
op_eq
id|features
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|ISDN_MAX_DRIVERS
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_net: No driver with selected features&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p-&gt;local.p_encap
op_ne
id|cfg-&gt;p_encap
)paren
r_if
c_cond
(paren
id|p-&gt;dev.start
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: cannot change encap when if is up&bslash;n&quot;
comma
id|p-&gt;local.name
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cfg-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_SYNCPPP
)paren
(brace
macro_line|#ifndef CONFIG_ISDN_PPP
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: SyncPPP support not configured&bslash;n&quot;
comma
id|p-&gt;local.name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
macro_line|#else
id|p-&gt;dev.type
op_assign
id|ARPHRD_PPP
suffix:semicolon
multiline_comment|/* change ARP type */
id|p-&gt;dev.addr_len
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|cfg-&gt;drvid
)paren
)paren
(brace
multiline_comment|/* A bind has been requested ... */
r_char
op_star
id|c
comma
op_star
id|e
suffix:semicolon
id|drvidx
op_assign
op_minus
l_int|1
suffix:semicolon
id|chidx
op_assign
op_minus
l_int|1
suffix:semicolon
id|strcpy
c_func
(paren
id|drvid
comma
id|cfg-&gt;drvid
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|c
op_assign
id|strchr
c_func
(paren
id|drvid
comma
l_char|&squot;,&squot;
)paren
)paren
)paren
(brace
multiline_comment|/* The channel-number is appended to the driver-Id with a comma */
id|chidx
op_assign
(paren
r_int
)paren
id|simple_strtoul
c_func
(paren
id|c
op_plus
l_int|1
comma
op_amp
id|e
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|e
op_eq
id|c
)paren
id|chidx
op_assign
op_minus
l_int|1
suffix:semicolon
op_star
id|c
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_MAX_DRIVERS
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* Lookup driver-Id in array */
r_if
c_cond
(paren
op_logical_neg
(paren
id|strcmp
c_func
(paren
id|dev-&gt;drvid
(braket
id|i
)braket
comma
id|drvid
)paren
)paren
)paren
(brace
id|drvidx
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|drvidx
op_eq
op_minus
l_int|1
)paren
op_logical_or
(paren
id|chidx
op_eq
op_minus
l_int|1
)paren
)paren
multiline_comment|/* Either driver-Id or channel-number invalid */
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Parameters are valid, so get them */
id|drvidx
op_assign
id|p-&gt;local.pre_device
suffix:semicolon
id|chidx
op_assign
id|p-&gt;local.pre_channel
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cfg-&gt;exclusive
OG
l_int|0
)paren
(brace
r_int
id|flags
suffix:semicolon
multiline_comment|/* If binding is exclusive, try to grab the channel */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|isdn_get_free_channel
c_func
(paren
id|ISDN_USAGE_NET
comma
id|p-&gt;local.l2_proto
comma
id|p-&gt;local.l3_proto
comma
id|drvidx
comma
id|chidx
)paren
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* Grab failed, because desired channel is in use */
id|p-&gt;local.exclusive
op_assign
op_minus
l_int|1
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* All went ok, so update isdninfo */
id|dev-&gt;usage
(braket
id|i
)braket
op_assign
id|ISDN_USAGE_EXCLUSIVE
suffix:semicolon
id|isdn_info_update
c_func
(paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|p-&gt;local.exclusive
op_assign
id|i
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Non-exclusive binding or unbind. */
id|p-&gt;local.exclusive
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p-&gt;local.pre_device
op_ne
op_minus
l_int|1
)paren
op_logical_and
(paren
id|cfg-&gt;exclusive
op_eq
op_minus
l_int|1
)paren
)paren
(brace
id|isdn_unexclusive_channel
c_func
(paren
id|p-&gt;local.pre_device
comma
id|p-&gt;local.pre_channel
)paren
suffix:semicolon
id|isdn_free_channel
c_func
(paren
id|p-&gt;local.pre_device
comma
id|p-&gt;local.pre_channel
comma
id|ISDN_USAGE_NET
)paren
suffix:semicolon
id|drvidx
op_assign
op_minus
l_int|1
suffix:semicolon
id|chidx
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
)brace
id|strcpy
c_func
(paren
id|p-&gt;local.msn
comma
id|cfg-&gt;eaz
)paren
suffix:semicolon
id|p-&gt;local.pre_device
op_assign
id|drvidx
suffix:semicolon
id|p-&gt;local.pre_channel
op_assign
id|chidx
suffix:semicolon
id|p-&gt;local.onhtime
op_assign
id|cfg-&gt;onhtime
suffix:semicolon
id|p-&gt;local.charge
op_assign
id|cfg-&gt;charge
suffix:semicolon
id|p-&gt;local.l2_proto
op_assign
id|cfg-&gt;l2_proto
suffix:semicolon
id|p-&gt;local.l3_proto
op_assign
id|cfg-&gt;l3_proto
suffix:semicolon
id|p-&gt;local.cbdelay
op_assign
id|cfg-&gt;cbdelay
suffix:semicolon
id|p-&gt;local.dialmax
op_assign
id|cfg-&gt;dialmax
suffix:semicolon
id|p-&gt;local.slavedelay
op_assign
id|cfg-&gt;slavedelay
op_star
id|HZ
suffix:semicolon
id|p-&gt;local.pppbind
op_assign
id|cfg-&gt;pppbind
suffix:semicolon
r_if
c_cond
(paren
id|cfg-&gt;secure
)paren
id|p-&gt;local.flags
op_or_assign
id|ISDN_NET_SECURE
suffix:semicolon
r_else
id|p-&gt;local.flags
op_and_assign
op_complement
id|ISDN_NET_SECURE
suffix:semicolon
r_if
c_cond
(paren
id|cfg-&gt;cbhup
)paren
id|p-&gt;local.flags
op_or_assign
id|ISDN_NET_CBHUP
suffix:semicolon
r_else
id|p-&gt;local.flags
op_and_assign
op_complement
id|ISDN_NET_CBHUP
suffix:semicolon
r_switch
c_cond
(paren
id|cfg-&gt;callback
)paren
(brace
r_case
l_int|0
suffix:colon
id|p-&gt;local.flags
op_and_assign
op_complement
(paren
id|ISDN_NET_CALLBACK
op_or
id|ISDN_NET_CBOUT
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|p-&gt;local.flags
op_or_assign
id|ISDN_NET_CALLBACK
suffix:semicolon
id|p-&gt;local.flags
op_and_assign
op_complement
id|ISDN_NET_CBOUT
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|p-&gt;local.flags
op_or_assign
id|ISDN_NET_CBOUT
suffix:semicolon
id|p-&gt;local.flags
op_and_assign
op_complement
id|ISDN_NET_CALLBACK
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cfg-&gt;chargehup
)paren
id|p-&gt;local.hupflags
op_or_assign
id|ISDN_CHARGEHUP
suffix:semicolon
r_else
id|p-&gt;local.hupflags
op_and_assign
op_complement
id|ISDN_CHARGEHUP
suffix:semicolon
r_if
c_cond
(paren
id|cfg-&gt;ihup
)paren
id|p-&gt;local.hupflags
op_or_assign
id|ISDN_INHUP
suffix:semicolon
r_else
id|p-&gt;local.hupflags
op_and_assign
op_complement
id|ISDN_INHUP
suffix:semicolon
r_if
c_cond
(paren
id|cfg-&gt;chargeint
OG
l_int|10
)paren
(brace
id|p-&gt;local.hupflags
op_or_assign
id|ISDN_CHARGEHUP
op_or
id|ISDN_HAVECHARGE
op_or
id|ISDN_MANCHARGE
suffix:semicolon
id|p-&gt;local.chargeint
op_assign
id|cfg-&gt;chargeint
op_star
id|HZ
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cfg-&gt;p_encap
op_ne
id|p-&gt;local.p_encap
)paren
(brace
r_if
c_cond
(paren
id|cfg-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_RAWIP
)paren
(brace
id|p-&gt;dev.hard_header
op_assign
l_int|NULL
suffix:semicolon
macro_line|#if (LINUX_VERSION_CODE &lt; 0x02010F)
id|p-&gt;dev.header_cache_bind
op_assign
l_int|NULL
suffix:semicolon
macro_line|#else
id|p-&gt;dev.hard_header_cache
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
id|p-&gt;dev.header_cache_update
op_assign
l_int|NULL
suffix:semicolon
id|p-&gt;dev.flags
op_assign
id|IFF_NOARP
op_or
id|IFF_POINTOPOINT
suffix:semicolon
)brace
r_else
(brace
id|p-&gt;dev.hard_header
op_assign
id|isdn_net_header
suffix:semicolon
r_if
c_cond
(paren
id|cfg-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_ETHER
)paren
(brace
macro_line|#if (LINUX_VERSION_CODE &lt; 0x02010F)
id|p-&gt;dev.header_cache_bind
op_assign
id|p-&gt;local.org_hcb
suffix:semicolon
macro_line|#else
id|p-&gt;dev.hard_header_cache
op_assign
id|p-&gt;local.org_hhc
suffix:semicolon
macro_line|#endif
id|p-&gt;dev.header_cache_update
op_assign
id|p-&gt;local.org_hcu
suffix:semicolon
id|p-&gt;dev.flags
op_assign
id|IFF_BROADCAST
op_or
id|IFF_MULTICAST
suffix:semicolon
)brace
r_else
(brace
macro_line|#if (LINUX_VERSION_CODE &lt; 0x02010F)
id|p-&gt;dev.header_cache_bind
op_assign
l_int|NULL
suffix:semicolon
macro_line|#else
id|p-&gt;dev.hard_header_cache
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
id|p-&gt;dev.header_cache_update
op_assign
l_int|NULL
suffix:semicolon
id|p-&gt;dev.flags
op_assign
id|IFF_NOARP
op_or
id|IFF_POINTOPOINT
suffix:semicolon
)brace
)brace
)brace
id|p-&gt;local.p_encap
op_assign
id|cfg-&gt;p_encap
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n; * Perform get-interface-parameters.ioctl&n; */
r_int
DECL|function|isdn_net_getcfg
id|isdn_net_getcfg
c_func
(paren
id|isdn_net_ioctl_cfg
op_star
id|cfg
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|isdn_net_findif
c_func
(paren
id|cfg-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
id|strcpy
c_func
(paren
id|cfg-&gt;eaz
comma
id|p-&gt;local.msn
)paren
suffix:semicolon
id|cfg-&gt;exclusive
op_assign
id|p-&gt;local.exclusive
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;local.pre_device
op_ge
l_int|0
)paren
(brace
id|sprintf
c_func
(paren
id|cfg-&gt;drvid
comma
l_string|&quot;%s,%d&quot;
comma
id|dev-&gt;drvid
(braket
id|p-&gt;local.pre_device
)braket
comma
id|p-&gt;local.pre_channel
)paren
suffix:semicolon
)brace
r_else
id|cfg-&gt;drvid
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|cfg-&gt;onhtime
op_assign
id|p-&gt;local.onhtime
suffix:semicolon
id|cfg-&gt;charge
op_assign
id|p-&gt;local.charge
suffix:semicolon
id|cfg-&gt;l2_proto
op_assign
id|p-&gt;local.l2_proto
suffix:semicolon
id|cfg-&gt;l3_proto
op_assign
id|p-&gt;local.l3_proto
suffix:semicolon
id|cfg-&gt;p_encap
op_assign
id|p-&gt;local.p_encap
suffix:semicolon
id|cfg-&gt;secure
op_assign
(paren
id|p-&gt;local.flags
op_amp
id|ISDN_NET_SECURE
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|cfg-&gt;callback
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;local.flags
op_amp
id|ISDN_NET_CALLBACK
)paren
id|cfg-&gt;callback
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;local.flags
op_amp
id|ISDN_NET_CBOUT
)paren
id|cfg-&gt;callback
op_assign
l_int|2
suffix:semicolon
id|cfg-&gt;cbhup
op_assign
(paren
id|p-&gt;local.flags
op_amp
id|ISDN_NET_CBHUP
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|cfg-&gt;chargehup
op_assign
(paren
id|p-&gt;local.hupflags
op_amp
l_int|4
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|cfg-&gt;ihup
op_assign
(paren
id|p-&gt;local.hupflags
op_amp
l_int|8
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|cfg-&gt;cbdelay
op_assign
id|p-&gt;local.cbdelay
suffix:semicolon
id|cfg-&gt;dialmax
op_assign
id|p-&gt;local.dialmax
suffix:semicolon
id|cfg-&gt;slavedelay
op_assign
id|p-&gt;local.slavedelay
op_div
id|HZ
suffix:semicolon
id|cfg-&gt;chargeint
op_assign
(paren
id|p-&gt;local.hupflags
op_amp
id|ISDN_CHARGEHUP
)paren
ques
c_cond
(paren
id|p-&gt;local.chargeint
op_div
id|HZ
)paren
suffix:colon
l_int|0
suffix:semicolon
id|cfg-&gt;pppbind
op_assign
id|p-&gt;local.pppbind
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;local.slave
)paren
id|strcpy
c_func
(paren
id|cfg-&gt;slave
comma
(paren
(paren
id|isdn_net_local
op_star
)paren
id|p-&gt;local.slave-&gt;priv
)paren
op_member_access_from_pointer
id|name
)paren
suffix:semicolon
r_else
id|cfg-&gt;slave
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;local.master
)paren
id|strcpy
c_func
(paren
id|cfg-&gt;master
comma
(paren
(paren
id|isdn_net_local
op_star
)paren
id|p-&gt;local.master-&gt;priv
)paren
op_member_access_from_pointer
id|name
)paren
suffix:semicolon
r_else
id|cfg-&gt;master
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n; * Add a phone-number to an interface.&n; */
r_int
DECL|function|isdn_net_addphone
id|isdn_net_addphone
c_func
(paren
id|isdn_net_ioctl_phone
op_star
id|phone
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|isdn_net_findif
c_func
(paren
id|phone-&gt;name
)paren
suffix:semicolon
id|isdn_net_phone
op_star
id|n
suffix:semicolon
r_if
c_cond
(paren
id|isdn_net_checkwild
c_func
(paren
id|phone-&gt;phone
)paren
op_logical_and
(paren
id|phone-&gt;outgoing
op_amp
l_int|1
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|n
op_assign
(paren
id|isdn_net_phone
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|isdn_net_phone
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|strcpy
c_func
(paren
id|n-&gt;num
comma
id|phone-&gt;phone
)paren
suffix:semicolon
id|n-&gt;next
op_assign
id|p-&gt;local.phone
(braket
id|phone-&gt;outgoing
op_amp
l_int|1
)braket
suffix:semicolon
id|p-&gt;local.phone
(braket
id|phone-&gt;outgoing
op_amp
l_int|1
)braket
op_assign
id|n
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n; * Return a string of all phone-numbers of an interface.&n; */
r_int
DECL|function|isdn_net_getphones
id|isdn_net_getphones
c_func
(paren
id|isdn_net_ioctl_phone
op_star
id|phone
comma
r_char
op_star
id|phones
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|isdn_net_findif
c_func
(paren
id|phone-&gt;name
)paren
suffix:semicolon
r_int
id|inout
op_assign
id|phone-&gt;outgoing
op_amp
l_int|1
suffix:semicolon
r_int
id|more
op_assign
l_int|0
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
id|isdn_net_phone
op_star
id|n
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|inout
op_and_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
id|p-&gt;local.phone
(braket
id|inout
)braket
suffix:semicolon
id|n
suffix:semicolon
id|n
op_assign
id|n-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|more
)paren
(brace
id|put_user
c_func
(paren
l_char|&squot; &squot;
comma
id|phones
op_increment
)paren
suffix:semicolon
id|count
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|copy_to_user
c_func
(paren
id|phones
comma
id|n-&gt;num
comma
id|strlen
c_func
(paren
id|n-&gt;num
)paren
op_plus
l_int|1
)paren
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|phones
op_add_assign
id|strlen
c_func
(paren
id|n-&gt;num
)paren
suffix:semicolon
id|count
op_add_assign
id|strlen
c_func
(paren
id|n-&gt;num
)paren
suffix:semicolon
id|more
op_assign
l_int|1
suffix:semicolon
)brace
id|put_user
c_func
(paren
l_int|0
comma
id|phones
)paren
suffix:semicolon
id|count
op_increment
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/*&n; * Delete a phone-number from an interface.&n; */
r_int
DECL|function|isdn_net_delphone
id|isdn_net_delphone
c_func
(paren
id|isdn_net_ioctl_phone
op_star
id|phone
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|isdn_net_findif
c_func
(paren
id|phone-&gt;name
)paren
suffix:semicolon
r_int
id|inout
op_assign
id|phone-&gt;outgoing
op_amp
l_int|1
suffix:semicolon
id|isdn_net_phone
op_star
id|n
suffix:semicolon
id|isdn_net_phone
op_star
id|m
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|n
op_assign
id|p-&gt;local.phone
(braket
id|inout
)braket
suffix:semicolon
id|m
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
id|n
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|n-&gt;num
comma
id|phone-&gt;phone
)paren
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;local.dial
op_eq
id|n
)paren
id|p-&gt;local.dial
op_assign
id|n-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|m
)paren
id|m-&gt;next
op_assign
id|n-&gt;next
suffix:semicolon
r_else
id|p-&gt;local.phone
(braket
id|inout
)braket
op_assign
id|n-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|n
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|m
op_assign
id|n
suffix:semicolon
id|n
op_assign
(paren
id|isdn_net_phone
op_star
)paren
id|n-&gt;next
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n; * Delete all phone-numbers of an interface.&n; */
r_static
r_int
DECL|function|isdn_net_rmallphone
id|isdn_net_rmallphone
c_func
(paren
id|isdn_net_dev
op_star
id|p
)paren
(brace
id|isdn_net_phone
op_star
id|n
suffix:semicolon
id|isdn_net_phone
op_star
id|m
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|n
op_assign
id|p-&gt;local.phone
(braket
id|i
)braket
suffix:semicolon
r_while
c_loop
(paren
id|n
)paren
(brace
id|m
op_assign
id|n-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|n
)paren
suffix:semicolon
id|n
op_assign
id|m
suffix:semicolon
)brace
id|p-&gt;local.phone
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|p-&gt;local.dial
op_assign
l_int|NULL
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Force a hangup of a network-interface.&n; */
r_int
DECL|function|isdn_net_force_hangup
id|isdn_net_force_hangup
c_func
(paren
r_char
op_star
id|name
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|isdn_net_findif
c_func
(paren
id|name
)paren
suffix:semicolon
r_struct
id|device
op_star
id|q
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;local.isdn_device
OL
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
id|q
op_assign
id|p-&gt;local.slave
suffix:semicolon
multiline_comment|/* If this interface has slaves, do a hangup for them also. */
r_while
c_loop
(paren
id|q
)paren
(brace
id|isdn_net_hangup
c_func
(paren
id|q
)paren
suffix:semicolon
id|q
op_assign
(paren
(paren
(paren
id|isdn_net_local
op_star
)paren
id|q-&gt;priv
)paren
op_member_access_from_pointer
id|slave
)paren
suffix:semicolon
)brace
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n; * Helper-function for isdn_net_rm: Do the real work.&n; */
r_static
r_int
DECL|function|isdn_net_realrm
id|isdn_net_realrm
c_func
(paren
id|isdn_net_dev
op_star
id|p
comma
id|isdn_net_dev
op_star
id|q
)paren
(brace
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;local.master
)paren
(brace
multiline_comment|/* If it&squot;s a slave, it may be removed even if it is busy. However&n;&t;&t; * it has to be hung up first.&n;&t;&t; */
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
id|p-&gt;dev.start
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p-&gt;dev.start
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* Free all phone-entries */
id|isdn_net_rmallphone
c_func
(paren
id|p
)paren
suffix:semicolon
multiline_comment|/* If interface is bound exclusive, free channel-usage */
r_if
c_cond
(paren
id|p-&gt;local.exclusive
op_ne
op_minus
l_int|1
)paren
id|isdn_unexclusive_channel
c_func
(paren
id|p-&gt;local.pre_device
comma
id|p-&gt;local.pre_channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;local.master
)paren
(brace
multiline_comment|/* It&squot;s a slave-device, so update master&squot;s slave-pointer if necessary */
r_if
c_cond
(paren
(paren
(paren
id|isdn_net_local
op_star
)paren
(paren
id|p-&gt;local.master-&gt;priv
)paren
)paren
op_member_access_from_pointer
id|slave
op_eq
op_amp
id|p-&gt;dev
)paren
(paren
(paren
id|isdn_net_local
op_star
)paren
(paren
id|p-&gt;local.master-&gt;priv
)paren
)paren
op_member_access_from_pointer
id|slave
op_assign
id|p-&gt;local.slave
suffix:semicolon
)brace
r_else
multiline_comment|/* Unregister only if it&squot;s a master-device */
id|unregister_netdev
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
multiline_comment|/* Unlink device from chain */
r_if
c_cond
(paren
id|q
)paren
id|q-&gt;next
op_assign
id|p-&gt;next
suffix:semicolon
r_else
id|dev-&gt;netdev
op_assign
id|p-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;local.slave
)paren
(brace
multiline_comment|/* If this interface has a slave, remove it also */
r_char
op_star
id|slavename
op_assign
(paren
(paren
id|isdn_net_local
op_star
)paren
(paren
id|p-&gt;local.slave-&gt;priv
)paren
)paren
op_member_access_from_pointer
id|name
suffix:semicolon
id|isdn_net_dev
op_star
id|n
op_assign
id|dev-&gt;netdev
suffix:semicolon
id|q
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
id|n
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|n-&gt;local.name
comma
id|slavename
)paren
)paren
(brace
id|isdn_net_realrm
c_func
(paren
id|n
comma
id|q
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|q
op_assign
id|n
suffix:semicolon
id|n
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|n-&gt;next
suffix:semicolon
)brace
)brace
multiline_comment|/* If no more net-devices remain, disable auto-hangup timer */
r_if
c_cond
(paren
id|dev-&gt;netdev
op_eq
l_int|NULL
)paren
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_NETHANGUP
comma
l_int|0
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|p
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Remove a single network-interface.&n; */
r_int
DECL|function|isdn_net_rm
id|isdn_net_rm
c_func
(paren
r_char
op_star
id|name
)paren
(brace
id|isdn_net_dev
op_star
id|p
suffix:semicolon
id|isdn_net_dev
op_star
id|q
suffix:semicolon
multiline_comment|/* Search name in netdev-chain */
id|p
op_assign
id|dev-&gt;netdev
suffix:semicolon
id|q
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|p-&gt;local.name
comma
id|name
)paren
)paren
r_return
(paren
id|isdn_net_realrm
c_func
(paren
id|p
comma
id|q
)paren
)paren
suffix:semicolon
id|q
op_assign
id|p
suffix:semicolon
id|p
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|p-&gt;next
suffix:semicolon
)brace
multiline_comment|/* If no more net-devices remain, disable auto-hangup timer */
r_if
c_cond
(paren
id|dev-&gt;netdev
op_eq
l_int|NULL
)paren
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_NETHANGUP
comma
l_int|0
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n; * Remove all network-interfaces&n; */
r_int
DECL|function|isdn_net_rmall
id|isdn_net_rmall
c_func
(paren
r_void
)paren
(brace
r_int
id|flags
suffix:semicolon
r_int
id|ret
suffix:semicolon
multiline_comment|/* Walk through netdev-chain */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|dev-&gt;netdev
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;netdev-&gt;local.master
)paren
(brace
multiline_comment|/* Remove master-devices only, slaves get removed with their master */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|isdn_net_realrm
c_func
(paren
id|dev-&gt;netdev
comma
l_int|NULL
)paren
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
)brace
)brace
id|dev-&gt;netdev
op_assign
l_int|NULL
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef DEV_NUMBUFFS
multiline_comment|/*&n; * helper function to flush device queues&n; * the better place would be net/core/dev.c&n; */
r_static
r_void
DECL|function|dev_purge_queues
id|dev_purge_queues
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DEV_NUMBUFFS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|dev-&gt;buffs
(braket
id|i
)braket
)paren
)paren
)paren
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
eof
