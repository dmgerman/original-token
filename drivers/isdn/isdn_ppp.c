multiline_comment|/* $Id: isdn_ppp.c,v 1.85 2000/11/25 17:00:59 kai Exp $&n; *&n; * Linux ISDN subsystem, functions for synchronous PPP (linklevel).&n; *&n; * Copyright 1995,96 by Michael Hipp (Michael.Hipp@student.uni-tuebingen.de)&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/isdn.h&gt;
macro_line|#include &lt;linux/ppp-comp.h&gt;
macro_line|#include &quot;isdn_common.h&quot;
macro_line|#include &quot;isdn_ppp.h&quot;
macro_line|#include &quot;isdn_net.h&quot;
macro_line|#ifndef PPP_IPX
DECL|macro|PPP_IPX
mdefine_line|#define PPP_IPX 0x002b
macro_line|#endif
multiline_comment|/* Prototypes */
r_static
r_int
id|isdn_ppp_fill_rq
c_func
(paren
r_int
r_char
op_star
id|buf
comma
r_int
id|len
comma
r_int
id|proto
comma
r_int
id|slot
)paren
suffix:semicolon
r_static
r_int
id|isdn_ppp_closewait
c_func
(paren
r_int
id|slot
)paren
suffix:semicolon
r_static
r_void
id|isdn_ppp_push_higher
c_func
(paren
id|isdn_net_dev
op_star
id|net_dev
comma
id|isdn_net_local
op_star
id|lp
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|proto
)paren
suffix:semicolon
r_static
r_int
id|isdn_ppp_if_get_unit
c_func
(paren
r_char
op_star
id|namebuf
)paren
suffix:semicolon
r_static
r_int
id|isdn_ppp_set_compressor
c_func
(paren
r_struct
id|ippp_struct
op_star
id|is
comma
r_struct
id|isdn_ppp_comp_data
op_star
)paren
suffix:semicolon
r_static
r_struct
id|sk_buff
op_star
id|isdn_ppp_decompress
c_func
(paren
r_struct
id|sk_buff
op_star
comma
r_struct
id|ippp_struct
op_star
comma
r_struct
id|ippp_struct
op_star
comma
r_int
op_star
id|proto
)paren
suffix:semicolon
r_static
r_void
id|isdn_ppp_receive_ccp
c_func
(paren
id|isdn_net_dev
op_star
id|net_dev
comma
id|isdn_net_local
op_star
id|lp
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|proto
)paren
suffix:semicolon
r_static
r_struct
id|sk_buff
op_star
id|isdn_ppp_compress
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb_in
comma
r_int
op_star
id|proto
comma
r_struct
id|ippp_struct
op_star
id|is
comma
r_struct
id|ippp_struct
op_star
id|master
comma
r_int
id|type
)paren
suffix:semicolon
r_static
r_void
id|isdn_ppp_send_ccp
c_func
(paren
id|isdn_net_dev
op_star
id|net_dev
comma
id|isdn_net_local
op_star
id|lp
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
multiline_comment|/* New CCP stuff */
r_static
r_void
id|isdn_ppp_ccp_kickup
c_func
(paren
r_struct
id|ippp_struct
op_star
id|is
)paren
suffix:semicolon
r_static
r_void
id|isdn_ppp_ccp_xmit_reset
c_func
(paren
r_struct
id|ippp_struct
op_star
id|is
comma
r_int
id|proto
comma
r_int
r_char
id|code
comma
r_int
r_char
id|id
comma
r_int
r_char
op_star
id|data
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_struct
id|ippp_ccp_reset
op_star
id|isdn_ppp_ccp_reset_alloc
c_func
(paren
r_struct
id|ippp_struct
op_star
id|is
)paren
suffix:semicolon
r_static
r_void
id|isdn_ppp_ccp_reset_free
c_func
(paren
r_struct
id|ippp_struct
op_star
id|is
)paren
suffix:semicolon
r_static
r_void
id|isdn_ppp_ccp_reset_free_state
c_func
(paren
r_struct
id|ippp_struct
op_star
id|is
comma
r_int
r_char
id|id
)paren
suffix:semicolon
r_static
r_void
id|isdn_ppp_ccp_timer_callback
c_func
(paren
r_int
r_int
id|closure
)paren
suffix:semicolon
r_static
r_struct
id|ippp_ccp_reset_state
op_star
id|isdn_ppp_ccp_reset_alloc_state
c_func
(paren
r_struct
id|ippp_struct
op_star
id|is
comma
r_int
r_char
id|id
)paren
suffix:semicolon
r_static
r_void
id|isdn_ppp_ccp_reset_trans
c_func
(paren
r_struct
id|ippp_struct
op_star
id|is
comma
r_struct
id|isdn_ppp_resetparams
op_star
id|rp
)paren
suffix:semicolon
r_static
r_void
id|isdn_ppp_ccp_reset_ack_rcvd
c_func
(paren
r_struct
id|ippp_struct
op_star
id|is
comma
r_int
r_char
id|id
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_MPP
DECL|variable|isdn_ppp_bundle_arr
r_static
id|ippp_bundle
op_star
id|isdn_ppp_bundle_arr
op_assign
l_int|NULL
suffix:semicolon
r_static
r_int
id|isdn_ppp_mp_bundle_array_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|isdn_ppp_mp_init
c_func
(paren
id|isdn_net_local
op_star
id|lp
comma
id|ippp_bundle
op_star
id|add_to
)paren
suffix:semicolon
r_static
r_void
id|isdn_ppp_mp_receive
c_func
(paren
id|isdn_net_dev
op_star
id|net_dev
comma
id|isdn_net_local
op_star
id|lp
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_void
id|isdn_ppp_mp_cleanup
c_func
(paren
id|isdn_net_local
op_star
id|lp
)paren
suffix:semicolon
r_static
r_int
id|isdn_ppp_bundle
c_func
(paren
r_struct
id|ippp_struct
op_star
comma
r_int
id|unit
)paren
suffix:semicolon
macro_line|#endif&t;/* CONFIG_ISDN_MPP */
DECL|variable|isdn_ppp_revision
r_char
op_star
id|isdn_ppp_revision
op_assign
l_string|&quot;$Revision: 1.85 $&quot;
suffix:semicolon
DECL|variable|ippp_table
r_static
r_struct
id|ippp_struct
op_star
id|ippp_table
(braket
id|ISDN_MAX_CHANNELS
)braket
suffix:semicolon
DECL|variable|ipc_head
r_static
r_struct
id|isdn_ppp_compressor
op_star
id|ipc_head
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n; * frame log (debug)&n; */
r_static
r_void
DECL|function|isdn_ppp_frame_log
id|isdn_ppp_frame_log
c_func
(paren
r_char
op_star
id|info
comma
r_char
op_star
id|data
comma
r_int
id|len
comma
r_int
id|maxlen
comma
r_int
id|unit
comma
r_int
id|slot
)paren
(brace
r_int
id|cnt
comma
id|j
comma
id|i
suffix:semicolon
r_char
id|buf
(braket
l_int|80
)braket
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|maxlen
)paren
id|maxlen
op_assign
id|len
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|maxlen
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|16
op_logical_and
id|cnt
OL
id|maxlen
suffix:semicolon
id|j
op_increment
comma
id|cnt
op_increment
)paren
id|sprintf
c_func
(paren
id|buf
op_plus
id|j
op_star
l_int|3
comma
l_string|&quot;%02x &quot;
comma
(paren
r_int
r_char
)paren
id|data
(braket
id|cnt
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;[%d/%d].%s[%d]: %s&bslash;n&quot;
comma
id|unit
comma
id|slot
comma
id|info
comma
id|i
comma
id|buf
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * unbind isdn_net_local &lt;=&gt; ippp-device&n; * note: it can happen, that we hangup/free the master before the slaves&n; *       in this case we bind another lp to the master device&n; */
r_int
DECL|function|isdn_ppp_free
id|isdn_ppp_free
c_func
(paren
id|isdn_net_local
op_star
id|lp
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|ippp_struct
op_star
id|is
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;ppp_slot
template_param
id|ISDN_MAX_CHANNELS
)paren
r_return
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_MPP
id|spin_lock
c_func
(paren
op_amp
id|lp-&gt;netdev-&gt;pb-&gt;lock
)paren
suffix:semicolon
macro_line|#endif
id|isdn_net_rm_from_bundle
c_func
(paren
id|lp
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_MPP
r_if
c_cond
(paren
id|lp-&gt;netdev-&gt;pb-&gt;ref_ct
op_eq
l_int|1
)paren
multiline_comment|/* last link in queue? */
id|isdn_ppp_mp_cleanup
c_func
(paren
id|lp
)paren
suffix:semicolon
id|lp-&gt;netdev-&gt;pb-&gt;ref_ct
op_decrement
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|lp-&gt;netdev-&gt;pb-&gt;lock
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_MPP */
id|is
op_assign
id|ippp_table
(braket
id|lp-&gt;ppp_slot
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|is-&gt;state
op_amp
id|IPPP_CONNECT
)paren
)paren
id|isdn_ppp_closewait
c_func
(paren
id|lp-&gt;ppp_slot
)paren
suffix:semicolon
multiline_comment|/* force wakeup on ippp device */
r_else
r_if
c_cond
(paren
id|is-&gt;state
op_amp
id|IPPP_ASSIGNED
)paren
id|is-&gt;state
op_assign
id|IPPP_OPEN
suffix:semicolon
multiline_comment|/* fallback to &squot;OPEN but not ASSIGNED&squot; state */
r_if
c_cond
(paren
id|is-&gt;debug
op_amp
l_int|0x1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_ppp_free %d %lx %lx&bslash;n&quot;
comma
id|lp-&gt;ppp_slot
comma
(paren
r_int
)paren
id|lp
comma
(paren
r_int
)paren
id|is-&gt;lp
)paren
suffix:semicolon
id|is-&gt;lp
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* link is down .. set lp to NULL */
id|lp-&gt;ppp_slot
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* is this OK ?? */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * bind isdn_net_local &lt;=&gt; ippp-device&n; */
r_int
DECL|function|isdn_ppp_bind
id|isdn_ppp_bind
c_func
(paren
id|isdn_net_local
op_star
id|lp
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|unit
op_assign
l_int|0
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_struct
id|ippp_struct
op_star
id|is
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;pppbind
OL
l_int|0
)paren
(brace
multiline_comment|/* device bounded to ippp device ? */
id|isdn_net_dev
op_star
id|net_dev
op_assign
id|dev-&gt;netdev
suffix:semicolon
r_char
id|exclusive
(braket
id|ISDN_MAX_CHANNELS
)braket
suffix:semicolon
multiline_comment|/* exclusive flags */
id|memset
c_func
(paren
id|exclusive
comma
l_int|0
comma
id|ISDN_MAX_CHANNELS
)paren
suffix:semicolon
r_while
c_loop
(paren
id|net_dev
)paren
(brace
multiline_comment|/* step through net devices to find exclusive minors */
id|isdn_net_local
op_star
id|lp
op_assign
id|net_dev-&gt;local
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;pppbind
op_ge
l_int|0
)paren
id|exclusive
(braket
id|lp-&gt;pppbind
)braket
op_assign
l_int|1
suffix:semicolon
id|net_dev
op_assign
id|net_dev-&gt;next
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * search a free device / slot&n;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_MAX_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ippp_table
(braket
id|i
)braket
op_member_access_from_pointer
id|state
op_eq
id|IPPP_OPEN
op_logical_and
op_logical_neg
id|exclusive
(braket
id|ippp_table
(braket
id|i
)braket
op_member_access_from_pointer
id|minor
)braket
)paren
(brace
multiline_comment|/* OPEN, but not connected! */
r_break
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_MAX_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ippp_table
(braket
id|i
)braket
op_member_access_from_pointer
id|minor
op_eq
id|lp-&gt;pppbind
op_logical_and
(paren
id|ippp_table
(braket
id|i
)braket
op_member_access_from_pointer
id|state
op_amp
id|IPPP_OPEN
)paren
op_eq
id|IPPP_OPEN
)paren
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i
op_ge
id|ISDN_MAX_CHANNELS
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_ppp_bind: Can&squot;t find a (free) connection to the ipppd daemon.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|unit
op_assign
id|isdn_ppp_if_get_unit
c_func
(paren
id|lp-&gt;name
)paren
suffix:semicolon
multiline_comment|/* get unit number from interface name .. ugly! */
r_if
c_cond
(paren
id|unit
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;isdn_ppp_bind: illegal interface name %s.&bslash;n&quot;
comma
id|lp-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|lp-&gt;ppp_slot
op_assign
id|i
suffix:semicolon
id|is
op_assign
id|ippp_table
(braket
id|i
)braket
suffix:semicolon
id|is-&gt;lp
op_assign
id|lp
suffix:semicolon
id|is-&gt;unit
op_assign
id|unit
suffix:semicolon
id|is-&gt;state
op_assign
id|IPPP_OPEN
op_or
id|IPPP_ASSIGNED
suffix:semicolon
multiline_comment|/* assigned to a netdevice but not connected */
macro_line|#ifdef CONFIG_ISDN_MPP
r_if
c_cond
(paren
id|isdn_ppp_mp_init
c_func
(paren
id|lp
comma
l_int|NULL
)paren
OL
l_int|0
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_MPP */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|lp-&gt;ppp_slot
suffix:semicolon
)brace
multiline_comment|/*&n; * kick the ipppd on the device&n; * (wakes up daemon after B-channel connect)&n; */
r_void
DECL|function|isdn_ppp_wakeup_daemon
id|isdn_ppp_wakeup_daemon
c_func
(paren
id|isdn_net_local
op_star
id|lp
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;ppp_slot
OL
l_int|0
op_logical_or
id|lp-&gt;ppp_slot
op_ge
id|ISDN_MAX_CHANNELS
)paren
r_return
suffix:semicolon
id|ippp_table
(braket
id|lp-&gt;ppp_slot
)braket
op_member_access_from_pointer
id|state
op_assign
id|IPPP_OPEN
op_or
id|IPPP_CONNECT
op_or
id|IPPP_NOBLOCK
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|ippp_table
(braket
id|lp-&gt;ppp_slot
)braket
op_member_access_from_pointer
id|wq
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * there was a hangup on the netdevice&n; * force wakeup of the ippp device&n; * go into &squot;device waits for release&squot; state&n; */
r_static
r_int
DECL|function|isdn_ppp_closewait
id|isdn_ppp_closewait
c_func
(paren
r_int
id|slot
)paren
(brace
r_struct
id|ippp_struct
op_star
id|is
suffix:semicolon
r_if
c_cond
(paren
id|slot
OL
l_int|0
op_logical_or
id|slot
op_ge
id|ISDN_MAX_CHANNELS
)paren
r_return
l_int|0
suffix:semicolon
id|is
op_assign
id|ippp_table
(braket
id|slot
)braket
suffix:semicolon
r_if
c_cond
(paren
id|is-&gt;state
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|is-&gt;wq
)paren
suffix:semicolon
id|is-&gt;state
op_assign
id|IPPP_CLOSEWAIT
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * isdn_ppp_find_slot / isdn_ppp_free_slot&n; */
r_static
r_int
DECL|function|isdn_ppp_get_slot
id|isdn_ppp_get_slot
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_MAX_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ippp_table
(braket
id|i
)braket
op_member_access_from_pointer
id|state
)paren
r_return
id|i
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * isdn_ppp_open&n; */
r_int
DECL|function|isdn_ppp_open
id|isdn_ppp_open
c_func
(paren
r_int
id|min
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|slot
suffix:semicolon
r_struct
id|ippp_struct
op_star
id|is
suffix:semicolon
r_if
c_cond
(paren
id|min
template_param
id|ISDN_MAX_CHANNELS
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|slot
op_assign
id|isdn_ppp_get_slot
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot
OL
l_int|0
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|is
op_assign
id|file-&gt;private_data
op_assign
id|ippp_table
(braket
id|slot
)braket
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ippp, open, slot: %d, minor: %d, state: %04x&bslash;n&quot;
comma
id|slot
comma
id|min
comma
id|is-&gt;state
)paren
suffix:semicolon
multiline_comment|/* compression stuff */
id|is-&gt;link_compressor
op_assign
id|is-&gt;compressor
op_assign
l_int|NULL
suffix:semicolon
id|is-&gt;link_decompressor
op_assign
id|is-&gt;decompressor
op_assign
l_int|NULL
suffix:semicolon
id|is-&gt;link_comp_stat
op_assign
id|is-&gt;comp_stat
op_assign
l_int|NULL
suffix:semicolon
id|is-&gt;link_decomp_stat
op_assign
id|is-&gt;decomp_stat
op_assign
l_int|NULL
suffix:semicolon
id|is-&gt;compflags
op_assign
l_int|0
suffix:semicolon
id|is-&gt;reset
op_assign
id|isdn_ppp_ccp_reset_alloc
c_func
(paren
id|is
)paren
suffix:semicolon
id|is-&gt;lp
op_assign
l_int|NULL
suffix:semicolon
id|is-&gt;mp_seqno
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* MP sequence number */
id|is-&gt;pppcfg
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* ppp configuration */
id|is-&gt;mpppcfg
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* mppp configuration */
id|is-&gt;last_link_seqno
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* MP: maybe set to Bundle-MIN, when joining a bundle ?? */
id|is-&gt;unit
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* set, when we have our interface */
id|is-&gt;mru
op_assign
l_int|1524
suffix:semicolon
multiline_comment|/* MRU, default 1524 */
id|is-&gt;maxcid
op_assign
l_int|16
suffix:semicolon
multiline_comment|/* VJ: maxcid */
id|is-&gt;tk
op_assign
id|current
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|is-&gt;wq
)paren
suffix:semicolon
id|is-&gt;first
op_assign
id|is-&gt;rq
op_plus
id|NUM_RCV_BUFFS
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* receive queue */
id|is-&gt;last
op_assign
id|is-&gt;rq
suffix:semicolon
id|is-&gt;minor
op_assign
id|min
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP_VJ
multiline_comment|/*&n;&t; * VJ header compression init&n;&t; */
id|is-&gt;slcomp
op_assign
id|slhc_init
c_func
(paren
l_int|16
comma
l_int|16
)paren
suffix:semicolon
multiline_comment|/* not necessary for 2. link in bundle */
macro_line|#endif
id|is-&gt;state
op_assign
id|IPPP_OPEN
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * release ippp device&n; */
r_void
DECL|function|isdn_ppp_release
id|isdn_ppp_release
c_func
(paren
r_int
id|min
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|ippp_struct
op_star
id|is
suffix:semicolon
r_if
c_cond
(paren
id|min
OL
l_int|0
op_logical_or
id|min
op_ge
id|ISDN_MAX_CHANNELS
)paren
r_return
suffix:semicolon
id|is
op_assign
id|file-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|is-&gt;debug
op_amp
l_int|0x1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ippp: release, minor: %d %lx&bslash;n&quot;
comma
id|min
comma
(paren
r_int
)paren
id|is-&gt;lp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is-&gt;lp
)paren
(brace
multiline_comment|/* a lp address says: this link is still up */
id|isdn_net_dev
op_star
id|p
op_assign
id|is-&gt;lp-&gt;netdev
suffix:semicolon
id|is-&gt;state
op_and_assign
op_complement
id|IPPP_CONNECT
suffix:semicolon
multiline_comment|/* -&gt; effect: no call of wakeup */
multiline_comment|/*&n;&t;&t; * isdn_net_hangup() calls isdn_ppp_free()&n;&t;&t; * isdn_ppp_free() sets is-&gt;lp to NULL and lp-&gt;ppp_slot to -1&n;&t;&t; * removing the IPPP_CONNECT flag omits calling of isdn_ppp_wakeup_daemon()&n;&t;&t; */
id|isdn_net_hangup
c_func
(paren
op_amp
id|p-&gt;dev
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_RCV_BUFFS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|is-&gt;rq
(braket
id|i
)braket
dot
id|buf
)paren
(brace
id|kfree
c_func
(paren
id|is-&gt;rq
(braket
id|i
)braket
dot
id|buf
)paren
suffix:semicolon
id|is-&gt;rq
(braket
id|i
)braket
dot
id|buf
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|is-&gt;first
op_assign
id|is-&gt;rq
op_plus
id|NUM_RCV_BUFFS
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* receive queue */
id|is-&gt;last
op_assign
id|is-&gt;rq
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP_VJ
multiline_comment|/* TODO: if this was the previous master: link the slcomp to the new master */
id|slhc_free
c_func
(paren
id|is-&gt;slcomp
)paren
suffix:semicolon
id|is-&gt;slcomp
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
multiline_comment|/* TODO: if this was the previous master: link the the stuff to the new master */
r_if
c_cond
(paren
id|is-&gt;comp_stat
)paren
(brace
id|is-&gt;compressor
op_member_access_from_pointer
id|free
c_func
(paren
id|is-&gt;comp_stat
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|is-&gt;link_comp_stat
)paren
(brace
id|is-&gt;link_compressor
op_member_access_from_pointer
id|free
c_func
(paren
id|is-&gt;link_comp_stat
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|is-&gt;link_decomp_stat
)paren
(brace
id|is-&gt;link_decompressor
op_member_access_from_pointer
id|free
c_func
(paren
id|is-&gt;link_decomp_stat
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|is-&gt;decomp_stat
)paren
(brace
id|is-&gt;decompressor
op_member_access_from_pointer
id|free
c_func
(paren
id|is-&gt;decomp_stat
)paren
suffix:semicolon
)brace
id|is-&gt;compressor
op_assign
id|is-&gt;link_compressor
op_assign
l_int|NULL
suffix:semicolon
id|is-&gt;decompressor
op_assign
id|is-&gt;link_decompressor
op_assign
l_int|NULL
suffix:semicolon
id|is-&gt;comp_stat
op_assign
id|is-&gt;link_comp_stat
op_assign
l_int|NULL
suffix:semicolon
id|is-&gt;decomp_stat
op_assign
id|is-&gt;link_decomp_stat
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Clean up if necessary */
r_if
c_cond
(paren
id|is-&gt;reset
)paren
(brace
id|isdn_ppp_ccp_reset_free
c_func
(paren
id|is
)paren
suffix:semicolon
)brace
multiline_comment|/* this slot is ready for new connections */
id|is-&gt;state
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * get_arg .. ioctl helper&n; */
r_static
r_int
DECL|function|get_arg
id|get_arg
c_func
(paren
r_void
op_star
id|b
comma
r_void
op_star
id|val
comma
r_int
id|len
)paren
(brace
r_if
c_cond
(paren
id|len
op_le
l_int|0
)paren
id|len
op_assign
r_sizeof
(paren
r_void
op_star
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
id|val
comma
id|b
comma
id|len
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * set arg .. ioctl helper&n; */
r_static
r_int
DECL|function|set_arg
id|set_arg
c_func
(paren
r_void
op_star
id|b
comma
r_void
op_star
id|val
comma
r_int
id|len
)paren
(brace
r_if
c_cond
(paren
id|len
op_le
l_int|0
)paren
(brace
id|len
op_assign
r_sizeof
(paren
r_void
op_star
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|b
comma
(paren
r_void
op_star
)paren
id|val
comma
id|len
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * ippp device ioctl&n; */
r_int
DECL|function|isdn_ppp_ioctl
id|isdn_ppp_ioctl
c_func
(paren
r_int
id|min
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
r_int
id|val
suffix:semicolon
r_int
id|r
comma
id|i
comma
id|j
suffix:semicolon
r_struct
id|ippp_struct
op_star
id|is
suffix:semicolon
id|isdn_net_local
op_star
id|lp
suffix:semicolon
r_struct
id|isdn_ppp_comp_data
id|data
suffix:semicolon
id|is
op_assign
(paren
r_struct
id|ippp_struct
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
id|lp
op_assign
id|is-&gt;lp
suffix:semicolon
r_if
c_cond
(paren
id|is-&gt;debug
op_amp
l_int|0x1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_ppp_ioctl: minor: %d cmd: %x state: %x&bslash;n&quot;
comma
id|min
comma
id|cmd
comma
id|is-&gt;state
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|is-&gt;state
op_amp
id|IPPP_OPEN
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|PPPIOCBUNDLE
suffix:colon
macro_line|#ifdef CONFIG_ISDN_MPP
r_if
c_cond
(paren
op_logical_neg
(paren
id|is-&gt;state
op_amp
id|IPPP_CONNECT
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|r
op_assign
id|get_arg
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|val
comma
r_sizeof
(paren
id|val
)paren
)paren
)paren
)paren
r_return
id|r
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;iPPP-bundle: minor: %d, slave unit: %d, master unit: %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|min
comma
(paren
r_int
)paren
id|is-&gt;unit
comma
(paren
r_int
)paren
id|val
)paren
suffix:semicolon
r_return
id|isdn_ppp_bundle
c_func
(paren
id|is
comma
id|val
)paren
suffix:semicolon
macro_line|#else
r_return
op_minus
l_int|1
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|PPPIOCGUNIT
suffix:colon
multiline_comment|/* get ppp/isdn unit number */
r_if
c_cond
(paren
(paren
id|r
op_assign
id|set_arg
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|is-&gt;unit
comma
r_sizeof
(paren
id|is-&gt;unit
)paren
)paren
)paren
)paren
r_return
id|r
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PPPIOCGIFNAME
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|lp
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|r
op_assign
id|set_arg
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
id|lp-&gt;name
comma
id|strlen
c_func
(paren
id|lp-&gt;name
)paren
)paren
)paren
)paren
r_return
id|r
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PPPIOCGMPFLAGS
suffix:colon
multiline_comment|/* get configuration flags */
r_if
c_cond
(paren
(paren
id|r
op_assign
id|set_arg
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|is-&gt;mpppcfg
comma
r_sizeof
(paren
id|is-&gt;mpppcfg
)paren
)paren
)paren
)paren
r_return
id|r
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PPPIOCSMPFLAGS
suffix:colon
multiline_comment|/* set configuration flags */
r_if
c_cond
(paren
(paren
id|r
op_assign
id|get_arg
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|val
comma
r_sizeof
(paren
id|val
)paren
)paren
)paren
)paren
r_return
id|r
suffix:semicolon
id|is-&gt;mpppcfg
op_assign
id|val
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PPPIOCGFLAGS
suffix:colon
multiline_comment|/* get configuration flags */
r_if
c_cond
(paren
(paren
id|r
op_assign
id|set_arg
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|is-&gt;pppcfg
comma
r_sizeof
(paren
id|is-&gt;pppcfg
)paren
)paren
)paren
)paren
r_return
id|r
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PPPIOCSFLAGS
suffix:colon
multiline_comment|/* set configuration flags */
r_if
c_cond
(paren
(paren
id|r
op_assign
id|get_arg
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|val
comma
r_sizeof
(paren
id|val
)paren
)paren
)paren
)paren
(brace
r_return
id|r
suffix:semicolon
)brace
r_if
c_cond
(paren
id|val
op_amp
id|SC_ENABLE_IP
op_logical_and
op_logical_neg
(paren
id|is-&gt;pppcfg
op_amp
id|SC_ENABLE_IP
)paren
op_logical_and
(paren
id|is-&gt;state
op_amp
id|IPPP_CONNECT
)paren
)paren
(brace
r_if
c_cond
(paren
id|lp
)paren
(brace
multiline_comment|/* OK .. we are ready to send buffers */
id|netif_wake_queue
c_func
(paren
op_amp
id|lp-&gt;netdev-&gt;dev
)paren
suffix:semicolon
)brace
)brace
id|is-&gt;pppcfg
op_assign
id|val
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PPPIOCGIDLE
suffix:colon
multiline_comment|/* get idle time information */
r_if
c_cond
(paren
id|lp
)paren
(brace
r_struct
id|ppp_idle
id|pidle
suffix:semicolon
id|pidle.xmit_idle
op_assign
id|pidle.recv_idle
op_assign
id|lp-&gt;huptimer
suffix:semicolon
r_if
c_cond
(paren
(paren
id|r
op_assign
id|set_arg
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|pidle
comma
r_sizeof
(paren
r_struct
id|ppp_idle
)paren
)paren
)paren
)paren
r_return
id|r
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PPPIOCSMRU
suffix:colon
multiline_comment|/* set receive unit size for PPP */
r_if
c_cond
(paren
(paren
id|r
op_assign
id|get_arg
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|val
comma
r_sizeof
(paren
id|val
)paren
)paren
)paren
)paren
r_return
id|r
suffix:semicolon
id|is-&gt;mru
op_assign
id|val
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PPPIOCSMPMRU
suffix:colon
r_break
suffix:semicolon
r_case
id|PPPIOCSMPMTU
suffix:colon
r_break
suffix:semicolon
r_case
id|PPPIOCSMAXCID
suffix:colon
multiline_comment|/* set the maximum compression slot id */
r_if
c_cond
(paren
(paren
id|r
op_assign
id|get_arg
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|val
comma
r_sizeof
(paren
id|val
)paren
)paren
)paren
)paren
r_return
id|r
suffix:semicolon
id|val
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|is-&gt;maxcid
op_ne
id|val
)paren
(brace
macro_line|#ifdef CONFIG_ISDN_PPP_VJ
r_struct
id|slcompress
op_star
id|sltmp
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|is-&gt;debug
op_amp
l_int|0x1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ippp, ioctl: changed MAXCID to %ld&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
id|is-&gt;maxcid
op_assign
id|val
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP_VJ
id|sltmp
op_assign
id|slhc_init
c_func
(paren
l_int|16
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sltmp
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ippp, can&squot;t realloc slhc struct&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|is-&gt;slcomp
)paren
id|slhc_free
c_func
(paren
id|is-&gt;slcomp
)paren
suffix:semicolon
id|is-&gt;slcomp
op_assign
id|sltmp
suffix:semicolon
macro_line|#endif
)brace
r_break
suffix:semicolon
r_case
id|PPPIOCGDEBUG
suffix:colon
r_if
c_cond
(paren
(paren
id|r
op_assign
id|set_arg
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|is-&gt;debug
comma
r_sizeof
(paren
id|is-&gt;debug
)paren
)paren
)paren
)paren
r_return
id|r
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PPPIOCSDEBUG
suffix:colon
r_if
c_cond
(paren
(paren
id|r
op_assign
id|get_arg
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|val
comma
r_sizeof
(paren
id|val
)paren
)paren
)paren
)paren
r_return
id|r
suffix:semicolon
id|is-&gt;debug
op_assign
id|val
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PPPIOCGCOMPRESSORS
suffix:colon
(brace
r_int
r_int
id|protos
(braket
l_int|8
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
r_struct
id|isdn_ppp_compressor
op_star
id|ipc
op_assign
id|ipc_head
suffix:semicolon
r_while
c_loop
(paren
id|ipc
)paren
(brace
id|j
op_assign
id|ipc-&gt;num
op_div
(paren
r_sizeof
(paren
r_int
)paren
op_star
l_int|8
)paren
suffix:semicolon
id|i
op_assign
id|ipc-&gt;num
op_mod
(paren
r_sizeof
(paren
r_int
)paren
op_star
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|j
OL
l_int|8
)paren
(brace
id|protos
(braket
id|j
)braket
op_or_assign
(paren
l_int|0x1
op_lshift
id|i
)paren
suffix:semicolon
)brace
id|ipc
op_assign
id|ipc-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|r
op_assign
id|set_arg
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
id|protos
comma
l_int|8
op_star
r_sizeof
(paren
r_int
)paren
)paren
)paren
)paren
r_return
id|r
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PPPIOCSCOMPRESSOR
suffix:colon
r_if
c_cond
(paren
(paren
id|r
op_assign
id|get_arg
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|data
comma
r_sizeof
(paren
r_struct
id|isdn_ppp_comp_data
)paren
)paren
)paren
)paren
r_return
id|r
suffix:semicolon
r_return
id|isdn_ppp_set_compressor
c_func
(paren
id|is
comma
op_amp
id|data
)paren
suffix:semicolon
r_case
id|PPPIOCGCALLINFO
suffix:colon
(brace
r_struct
id|pppcallinfo
id|pci
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|pci
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pppcallinfo
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp
)paren
(brace
id|strncpy
c_func
(paren
id|pci.local_num
comma
id|lp-&gt;msn
comma
l_int|63
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;dial
)paren
(brace
id|strncpy
c_func
(paren
id|pci.remote_num
comma
id|lp-&gt;dial-&gt;num
comma
l_int|63
)paren
suffix:semicolon
)brace
id|pci.charge_units
op_assign
id|lp-&gt;charge
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;outgoing
)paren
(brace
id|pci.calltype
op_assign
id|CALLTYPE_OUTGOING
suffix:semicolon
)brace
r_else
id|pci.calltype
op_assign
id|CALLTYPE_INCOMING
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CALLBACK
)paren
(brace
id|pci.calltype
op_or_assign
id|CALLTYPE_CALLBACK
suffix:semicolon
)brace
)brace
r_return
id|set_arg
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|pci
comma
r_sizeof
(paren
r_struct
id|pppcallinfo
)paren
)paren
suffix:semicolon
)brace
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_int
r_int
DECL|function|isdn_ppp_poll
id|isdn_ppp_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|poll_table
op_star
id|wait
)paren
(brace
r_int
r_int
id|mask
suffix:semicolon
r_struct
id|ippp_buf_queue
op_star
id|bf
suffix:semicolon
r_struct
id|ippp_buf_queue
op_star
id|bl
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|ippp_struct
op_star
id|is
suffix:semicolon
id|is
op_assign
id|file-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|is-&gt;debug
op_amp
l_int|0x2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_ppp_poll: minor: %d&bslash;n&quot;
comma
id|MINOR
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_rdev
)paren
)paren
suffix:semicolon
multiline_comment|/* just registers wait_queue hook. This doesn&squot;t really wait. */
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|is-&gt;wq
comma
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|is-&gt;state
op_amp
id|IPPP_OPEN
)paren
)paren
(brace
r_if
c_cond
(paren
id|is-&gt;state
op_eq
id|IPPP_CLOSEWAIT
)paren
(brace
r_return
id|POLLHUP
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_ppp: device not open&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|POLLERR
suffix:semicolon
)brace
multiline_comment|/* we&squot;re always ready to send .. */
id|mask
op_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|bl
op_assign
id|is-&gt;last
suffix:semicolon
id|bf
op_assign
id|is-&gt;first
suffix:semicolon
multiline_comment|/*&n;&t; * if IPPP_NOBLOCK is set we return even if we have nothing to read&n;&t; */
r_if
c_cond
(paren
id|bf-&gt;next
op_ne
id|bl
op_logical_or
(paren
id|is-&gt;state
op_amp
id|IPPP_NOBLOCK
)paren
)paren
(brace
id|is-&gt;state
op_and_assign
op_complement
id|IPPP_NOBLOCK
suffix:semicolon
id|mask
op_or_assign
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|mask
suffix:semicolon
)brace
multiline_comment|/*&n; *  fill up isdn_ppp_read() queue ..&n; */
r_static
r_int
DECL|function|isdn_ppp_fill_rq
id|isdn_ppp_fill_rq
c_func
(paren
r_int
r_char
op_star
id|buf
comma
r_int
id|len
comma
r_int
id|proto
comma
r_int
id|slot
)paren
(brace
r_struct
id|ippp_buf_queue
op_star
id|bf
comma
op_star
id|bl
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
op_star
id|nbuf
suffix:semicolon
r_struct
id|ippp_struct
op_star
id|is
suffix:semicolon
r_if
c_cond
(paren
id|slot
OL
l_int|0
op_logical_or
id|slot
op_ge
id|ISDN_MAX_CHANNELS
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ippp: illegal slot.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|is
op_assign
id|ippp_table
(braket
id|slot
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|is-&gt;state
op_amp
id|IPPP_CONNECT
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ippp: device not activated.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|nbuf
op_assign
(paren
r_int
r_char
op_star
)paren
id|kmalloc
c_func
(paren
id|len
op_plus
l_int|4
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nbuf
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ippp: Can&squot;t alloc buf&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|nbuf
(braket
l_int|0
)braket
op_assign
id|PPP_ALLSTATIONS
suffix:semicolon
id|nbuf
(braket
l_int|1
)braket
op_assign
id|PPP_UI
suffix:semicolon
id|nbuf
(braket
l_int|2
)braket
op_assign
id|proto
op_rshift
l_int|8
suffix:semicolon
id|nbuf
(braket
l_int|3
)braket
op_assign
id|proto
op_amp
l_int|0xff
suffix:semicolon
id|memcpy
c_func
(paren
id|nbuf
op_plus
l_int|4
comma
id|buf
comma
id|len
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|bf
op_assign
id|is-&gt;first
suffix:semicolon
id|bl
op_assign
id|is-&gt;last
suffix:semicolon
r_if
c_cond
(paren
id|bf
op_eq
id|bl
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ippp: Queue is full; discarding first buffer&bslash;n&quot;
)paren
suffix:semicolon
id|bf
op_assign
id|bf-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|bf-&gt;buf
)paren
suffix:semicolon
id|is-&gt;first
op_assign
id|bf
suffix:semicolon
)brace
id|bl-&gt;buf
op_assign
(paren
r_char
op_star
)paren
id|nbuf
suffix:semicolon
id|bl-&gt;len
op_assign
id|len
op_plus
l_int|4
suffix:semicolon
id|is-&gt;last
op_assign
id|bl-&gt;next
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|is-&gt;wq
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; * read() .. non-blocking: ipppd calls it only after select()&n; *           reports, that there is data&n; */
r_int
DECL|function|isdn_ppp_read
id|isdn_ppp_read
c_func
(paren
r_int
id|min
comma
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|ippp_struct
op_star
id|is
suffix:semicolon
r_struct
id|ippp_buf_queue
op_star
id|b
suffix:semicolon
r_int
id|r
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
op_star
id|save_buf
suffix:semicolon
id|is
op_assign
id|file-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|is-&gt;state
op_amp
id|IPPP_OPEN
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|r
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|buf
comma
id|count
)paren
)paren
)paren
r_return
id|r
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|b
op_assign
id|is-&gt;first-&gt;next
suffix:semicolon
id|save_buf
op_assign
id|b-&gt;buf
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|save_buf
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|b-&gt;len
OL
id|count
)paren
id|count
op_assign
id|b-&gt;len
suffix:semicolon
id|b-&gt;buf
op_assign
l_int|NULL
suffix:semicolon
id|is-&gt;first
op_assign
id|b
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|copy_to_user
c_func
(paren
id|buf
comma
id|save_buf
comma
id|count
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|save_buf
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/*&n; * ipppd wanna write a packet to the card .. non-blocking&n; */
r_int
DECL|function|isdn_ppp_write
id|isdn_ppp_write
c_func
(paren
r_int
id|min
comma
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
id|isdn_net_local
op_star
id|lp
suffix:semicolon
r_struct
id|ippp_struct
op_star
id|is
suffix:semicolon
r_int
id|proto
suffix:semicolon
r_int
r_char
id|protobuf
(braket
l_int|4
)braket
suffix:semicolon
id|is
op_assign
id|file-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|is-&gt;state
op_amp
id|IPPP_CONNECT
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|lp
op_assign
id|is-&gt;lp
suffix:semicolon
multiline_comment|/* -&gt; push it directly to the lowlevel interface */
r_if
c_cond
(paren
op_logical_neg
id|lp
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_ppp_write: lp == NULL&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
multiline_comment|/*&n;&t;&t; * Don&squot;t reset huptimer for&n;&t;&t; * LCP packets. (Echo requests).&n;&t;&t; */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|protobuf
comma
id|buf
comma
l_int|4
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|proto
op_assign
id|PPP_PROTOCOL
c_func
(paren
id|protobuf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|proto
op_ne
id|PPP_LCP
)paren
id|lp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;isdn_device
OL
l_int|0
op_logical_or
id|lp-&gt;isdn_channel
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;drv
(braket
id|lp-&gt;isdn_device
)braket
op_member_access_from_pointer
id|flags
op_amp
id|DRV_FLAG_RUNNING
)paren
op_logical_and
id|lp-&gt;dialstate
op_eq
l_int|0
op_logical_and
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
)paren
(brace
r_int
r_int
id|hl
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * we need to reserve enought space in front of&n;&t;&t;&t; * sk_buff. old call to dev_alloc_skb only reserved&n;&t;&t;&t; * 16 bytes, now we are looking what the driver want&n;&t;&t;&t; */
id|hl
op_assign
id|dev-&gt;drv
(braket
id|lp-&gt;isdn_device
)braket
op_member_access_from_pointer
id|interface-&gt;hl_hdrlen
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|hl
op_plus
id|count
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_ppp_write: out of memory!&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb
comma
id|hl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|count
)paren
comma
id|buf
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|is-&gt;debug
op_amp
l_int|0x40
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ppp xmit: len %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|skb-&gt;len
)paren
suffix:semicolon
id|isdn_ppp_frame_log
c_func
(paren
l_string|&quot;xmit&quot;
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
l_int|32
comma
id|is-&gt;unit
comma
id|lp-&gt;ppp_slot
)paren
suffix:semicolon
)brace
id|isdn_ppp_send_ccp
c_func
(paren
id|lp-&gt;netdev
comma
id|lp
comma
id|skb
)paren
suffix:semicolon
multiline_comment|/* keeps CCP/compression states in sync */
id|isdn_net_write_super
c_func
(paren
id|lp
comma
id|skb
)paren
suffix:semicolon
)brace
)brace
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/*&n; * init memory, structures etc.&n; */
r_int
DECL|function|isdn_ppp_init
id|isdn_ppp_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_MPP
r_if
c_cond
(paren
id|isdn_ppp_mp_bundle_array_init
c_func
(paren
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ISDN_MPP */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_MAX_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|ippp_table
(braket
id|i
)braket
op_assign
(paren
r_struct
id|ippp_struct
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ippp_struct
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_ppp_init: Could not alloc ippp_table&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|i
suffix:semicolon
id|j
op_increment
)paren
id|kfree
c_func
(paren
id|ippp_table
(braket
id|i
)braket
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|ippp_table
(braket
id|i
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ippp_struct
)paren
)paren
suffix:semicolon
id|ippp_table
(braket
id|i
)braket
op_member_access_from_pointer
id|state
op_assign
l_int|0
suffix:semicolon
id|ippp_table
(braket
id|i
)braket
op_member_access_from_pointer
id|first
op_assign
id|ippp_table
(braket
id|i
)braket
op_member_access_from_pointer
id|rq
op_plus
id|NUM_RCV_BUFFS
op_minus
l_int|1
suffix:semicolon
id|ippp_table
(braket
id|i
)braket
op_member_access_from_pointer
id|last
op_assign
id|ippp_table
(braket
id|i
)braket
op_member_access_from_pointer
id|rq
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|NUM_RCV_BUFFS
suffix:semicolon
id|j
op_increment
)paren
(brace
id|ippp_table
(braket
id|i
)braket
op_member_access_from_pointer
id|rq
(braket
id|j
)braket
dot
id|buf
op_assign
l_int|NULL
suffix:semicolon
id|ippp_table
(braket
id|i
)braket
op_member_access_from_pointer
id|rq
(braket
id|j
)braket
dot
id|last
op_assign
id|ippp_table
(braket
id|i
)braket
op_member_access_from_pointer
id|rq
op_plus
(paren
id|NUM_RCV_BUFFS
op_plus
id|j
op_minus
l_int|1
)paren
op_mod
id|NUM_RCV_BUFFS
suffix:semicolon
id|ippp_table
(braket
id|i
)braket
op_member_access_from_pointer
id|rq
(braket
id|j
)braket
dot
id|next
op_assign
id|ippp_table
(braket
id|i
)braket
op_member_access_from_pointer
id|rq
op_plus
(paren
id|j
op_plus
l_int|1
)paren
op_mod
id|NUM_RCV_BUFFS
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|isdn_ppp_cleanup
id|isdn_ppp_cleanup
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_MAX_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
id|kfree
c_func
(paren
id|ippp_table
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_MPP
r_if
c_cond
(paren
id|isdn_ppp_bundle_arr
)paren
id|kfree
c_func
(paren
id|isdn_ppp_bundle_arr
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_MPP */
)brace
multiline_comment|/*&n; * check for address/control field and skip if allowed&n; * retval != 0 -&gt; discard packet silently&n; */
DECL|function|isdn_ppp_skip_ac
r_static
r_int
id|isdn_ppp_skip_ac
c_func
(paren
r_struct
id|ippp_struct
op_star
id|is
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_if
c_cond
(paren
id|skb-&gt;len
OL
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;data
(braket
l_int|0
)braket
op_eq
l_int|0xff
)paren
(brace
r_if
c_cond
(paren
id|skb-&gt;len
OL
l_int|2
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;data
(braket
l_int|1
)braket
op_ne
l_int|0x03
)paren
r_return
op_minus
l_int|1
suffix:semicolon
singleline_comment|// skip address/control (AC) field
id|skb_pull
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|is-&gt;pppcfg
op_amp
id|SC_REJ_COMP_AC
)paren
singleline_comment|// if AC compression was not negotiated, but used, discard packet
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * get the PPP protocol header and pull skb&n; * retval &lt; 0 -&gt; discard packet silently&n; */
DECL|function|isdn_ppp_strip_proto
r_static
r_int
id|isdn_ppp_strip_proto
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|proto
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
OL
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;data
(braket
l_int|0
)braket
op_amp
l_int|0x1
)paren
(brace
singleline_comment|// protocol field is compressed
id|proto
op_assign
id|skb-&gt;data
(braket
l_int|0
)braket
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|skb-&gt;len
OL
l_int|2
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|proto
op_assign
(paren
(paren
r_int
)paren
id|skb-&gt;data
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_plus
id|skb-&gt;data
(braket
l_int|1
)braket
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
)brace
r_return
id|proto
suffix:semicolon
)brace
multiline_comment|/*&n; * handler for incoming packets on a syncPPP interface&n; */
DECL|function|isdn_ppp_receive
r_void
id|isdn_ppp_receive
c_func
(paren
id|isdn_net_dev
op_star
id|net_dev
comma
id|isdn_net_local
op_star
id|lp
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|ippp_struct
op_star
id|is
suffix:semicolon
r_int
id|slot
suffix:semicolon
r_int
id|proto
suffix:semicolon
r_if
c_cond
(paren
id|net_dev-&gt;local-&gt;master
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
singleline_comment|// we&squot;re called with the master device always
id|slot
op_assign
id|lp-&gt;ppp_slot
suffix:semicolon
r_if
c_cond
(paren
id|slot
template_param
id|ISDN_MAX_CHANNELS
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;isdn_ppp_receive: lp-&gt;ppp_slot %d&bslash;n&quot;
comma
id|lp-&gt;ppp_slot
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|is
op_assign
id|ippp_table
(braket
id|slot
)braket
suffix:semicolon
r_if
c_cond
(paren
id|is-&gt;debug
op_amp
l_int|0x4
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ippp_receive: is:%08lx lp:%08lx slot:%d unit:%d len:%d&bslash;n&quot;
comma
(paren
r_int
)paren
id|is
comma
(paren
r_int
)paren
id|lp
comma
id|lp-&gt;ppp_slot
comma
id|is-&gt;unit
comma
(paren
r_int
)paren
id|skb-&gt;len
)paren
suffix:semicolon
id|isdn_ppp_frame_log
c_func
(paren
l_string|&quot;receive&quot;
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
l_int|32
comma
id|is-&gt;unit
comma
id|lp-&gt;ppp_slot
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|isdn_ppp_skip_ac
c_func
(paren
id|is
comma
id|skb
)paren
OL
l_int|0
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|proto
op_assign
id|isdn_ppp_strip_proto
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|proto
OL
l_int|0
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ISDN_MPP
r_if
c_cond
(paren
id|is-&gt;compflags
op_amp
id|SC_LINK_DECOMP_ON
)paren
(brace
id|skb
op_assign
id|isdn_ppp_decompress
c_func
(paren
id|skb
comma
id|is
comma
l_int|NULL
comma
op_amp
id|proto
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
singleline_comment|// decompression error
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|is-&gt;mpppcfg
op_amp
id|SC_REJ_MP_PROT
)paren
)paren
(brace
singleline_comment|// we agreed to receive MPPP
r_if
c_cond
(paren
id|proto
op_eq
id|PPP_MP
)paren
(brace
id|isdn_ppp_mp_receive
c_func
(paren
id|net_dev
comma
id|lp
comma
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
macro_line|#endif
id|isdn_ppp_push_higher
c_func
(paren
id|net_dev
comma
id|lp
comma
id|skb
comma
id|proto
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * we receive a reassembled frame, MPPP has been taken care of before.&n; * address/control and protocol have been stripped from the skb&n; * note: net_dev has to be master net_dev&n; */
r_static
r_void
DECL|function|isdn_ppp_push_higher
id|isdn_ppp_push_higher
c_func
(paren
id|isdn_net_dev
op_star
id|net_dev
comma
id|isdn_net_local
op_star
id|lp
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|proto
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
op_amp
id|net_dev-&gt;dev
suffix:semicolon
r_struct
id|ippp_struct
op_star
id|is
comma
op_star
id|mis
suffix:semicolon
r_int
id|slot
suffix:semicolon
id|slot
op_assign
id|lp-&gt;ppp_slot
suffix:semicolon
r_if
c_cond
(paren
id|slot
template_param
id|ISDN_MAX_CHANNELS
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;isdn_ppp_push_higher: lp-&gt;ppp_slot %d&bslash;n&quot;
comma
id|lp-&gt;ppp_slot
)paren
suffix:semicolon
r_goto
id|drop_packet
suffix:semicolon
)brace
id|is
op_assign
id|ippp_table
(braket
id|slot
)braket
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;master
)paren
(brace
singleline_comment|// FIXME?
id|slot
op_assign
(paren
(paren
id|isdn_net_local
op_star
)paren
(paren
id|lp-&gt;master-&gt;priv
)paren
)paren
op_member_access_from_pointer
id|ppp_slot
suffix:semicolon
r_if
c_cond
(paren
id|slot
template_param
id|ISDN_MAX_CHANNELS
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;isdn_ppp_push_higher: master-&gt;ppp_slot %d&bslash;n&quot;
comma
id|lp-&gt;ppp_slot
)paren
suffix:semicolon
r_goto
id|drop_packet
suffix:semicolon
)brace
)brace
id|mis
op_assign
id|ippp_table
(braket
id|slot
)braket
suffix:semicolon
r_if
c_cond
(paren
id|is-&gt;debug
op_amp
l_int|0x10
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;push, skb %d %04x&bslash;n&quot;
comma
(paren
r_int
)paren
id|skb-&gt;len
comma
id|proto
)paren
suffix:semicolon
id|isdn_ppp_frame_log
c_func
(paren
l_string|&quot;rpush&quot;
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
l_int|32
comma
id|is-&gt;unit
comma
id|lp-&gt;ppp_slot
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|is-&gt;compflags
op_amp
id|SC_DECOMP_ON
)paren
(brace
id|skb
op_assign
id|isdn_ppp_decompress
c_func
(paren
id|skb
comma
id|is
comma
id|mis
comma
op_amp
id|proto
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
singleline_comment|// decompression error
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|proto
)paren
(brace
r_case
id|PPP_IPX
suffix:colon
multiline_comment|/* untested */
r_if
c_cond
(paren
id|is-&gt;debug
op_amp
l_int|0x20
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_ppp: IPX&bslash;n&quot;
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IPX
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PPP_IP
suffix:colon
r_if
c_cond
(paren
id|is-&gt;debug
op_amp
l_int|0x20
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_ppp: IP&bslash;n&quot;
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP_VJ
r_case
id|PPP_VJC_UNCOMP
suffix:colon
r_if
c_cond
(paren
id|is-&gt;debug
op_amp
l_int|0x20
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_ppp: VJC_UNCOMP&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slhc_remember
c_func
(paren
id|ippp_table
(braket
id|net_dev-&gt;local-&gt;ppp_slot
)braket
op_member_access_from_pointer
id|slcomp
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_ppp: received illegal VJC_UNCOMP frame!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|drop_packet
suffix:semicolon
)brace
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PPP_VJC_COMP
suffix:colon
r_if
c_cond
(paren
id|is-&gt;debug
op_amp
l_int|0x20
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_ppp: VJC_COMP&bslash;n&quot;
)paren
suffix:semicolon
(brace
r_struct
id|sk_buff
op_star
id|skb_old
op_assign
id|skb
suffix:semicolon
r_int
id|pkt_len
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|skb_old-&gt;len
op_plus
l_int|128
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Memory squeeze, dropping packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|skb
op_assign
id|skb_old
suffix:semicolon
r_goto
id|drop_packet
suffix:semicolon
)brace
id|skb_put
c_func
(paren
id|skb
comma
id|skb_old-&gt;len
op_plus
l_int|128
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb-&gt;data
comma
id|skb_old-&gt;data
comma
id|skb_old-&gt;len
)paren
suffix:semicolon
id|pkt_len
op_assign
id|slhc_uncompress
c_func
(paren
id|ippp_table
(braket
id|net_dev-&gt;local-&gt;ppp_slot
)braket
op_member_access_from_pointer
id|slcomp
comma
id|skb-&gt;data
comma
id|skb_old-&gt;len
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb_old
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pkt_len
OL
l_int|0
)paren
r_goto
id|drop_packet
suffix:semicolon
id|skb_trim
c_func
(paren
id|skb
comma
id|pkt_len
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
macro_line|#endif
r_case
id|PPP_CCP
suffix:colon
r_case
id|PPP_CCPFRAG
suffix:colon
id|isdn_ppp_receive_ccp
c_func
(paren
id|net_dev
comma
id|lp
comma
id|skb
comma
id|proto
)paren
suffix:semicolon
multiline_comment|/* Dont pop up ResetReq/Ack stuff to the daemon any&n;&t;&t;&t;   longer - the job is done already */
r_if
c_cond
(paren
id|skb-&gt;data
(braket
l_int|0
)braket
op_eq
id|CCP_RESETREQ
op_logical_or
id|skb-&gt;data
(braket
l_int|0
)braket
op_eq
id|CCP_RESETACK
)paren
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/* fall through */
r_default
suffix:colon
id|isdn_ppp_fill_rq
c_func
(paren
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|proto
comma
id|lp-&gt;ppp_slot
)paren
suffix:semicolon
multiline_comment|/* push data to pppd device */
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Reset hangup-timer */
id|lp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* net_dev-&gt;local-&gt;stats.rx_packets++; done in isdn_net.c */
r_return
suffix:semicolon
id|drop_packet
suffix:colon
id|net_dev-&gt;local-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * isdn_ppp_skb_push ..&n; * checks whether we have enough space at the beginning of the skb&n; * and allocs a new SKB if necessary&n; */
DECL|function|isdn_ppp_skb_push
r_static
r_int
r_char
op_star
id|isdn_ppp_skb_push
c_func
(paren
r_struct
id|sk_buff
op_star
op_star
id|skb_p
comma
r_int
id|len
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
op_star
id|skb_p
suffix:semicolon
r_if
c_cond
(paren
id|skb_headroom
c_func
(paren
id|skb
)paren
OL
id|len
)paren
(brace
r_struct
id|sk_buff
op_star
id|nskb
op_assign
id|skb_realloc_headroom
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nskb
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;isdn_ppp_skb_push: can&squot;t realloc headroom!&bslash;n&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_ppp_skb_push:under %d %d&bslash;n&quot;
comma
id|skb_headroom
c_func
(paren
id|skb
)paren
comma
id|len
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
op_star
id|skb_p
op_assign
id|nskb
suffix:semicolon
r_return
id|skb_push
c_func
(paren
id|nskb
comma
id|len
)paren
suffix:semicolon
)brace
r_return
id|skb_push
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * send ppp frame .. we expect a PIDCOMPressable proto --&n; *  (here: currently always PPP_IP,PPP_VJC_COMP,PPP_VJC_UNCOMP)&n; *&n; * VJ compression may change skb pointer!!! .. requeue with old&n; * skb isn&squot;t allowed!!&n; */
r_int
DECL|function|isdn_ppp_xmit
id|isdn_ppp_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|netdev
)paren
(brace
id|isdn_net_local
op_star
id|lp
comma
op_star
id|mlp
suffix:semicolon
id|isdn_net_dev
op_star
id|nd
suffix:semicolon
r_int
r_int
id|proto
op_assign
id|PPP_IP
suffix:semicolon
multiline_comment|/* 0x21 */
r_struct
id|ippp_struct
op_star
id|ipt
comma
op_star
id|ipts
suffix:semicolon
r_int
id|slot
suffix:semicolon
id|mlp
op_assign
(paren
id|isdn_net_local
op_star
)paren
(paren
id|netdev-&gt;priv
)paren
suffix:semicolon
id|nd
op_assign
id|mlp-&gt;netdev
suffix:semicolon
multiline_comment|/* get master lp */
id|slot
op_assign
id|mlp-&gt;ppp_slot
suffix:semicolon
r_if
c_cond
(paren
id|slot
template_param
id|ISDN_MAX_CHANNELS
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;isdn_ppp_xmit: lp-&gt;ppp_slot %d&bslash;n&quot;
comma
id|mlp-&gt;ppp_slot
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|ipts
op_assign
id|ippp_table
(braket
id|slot
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ipts-&gt;pppcfg
op_amp
id|SC_ENABLE_IP
)paren
)paren
(brace
multiline_comment|/* PPP connected ? */
r_if
c_cond
(paren
id|ipts-&gt;debug
op_amp
l_int|0x1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: IP frame delayed.&bslash;n&quot;
comma
id|netdev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|ntohs
c_func
(paren
id|skb-&gt;protocol
)paren
)paren
(brace
r_case
id|ETH_P_IP
suffix:colon
id|proto
op_assign
id|PPP_IP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_IPX
suffix:colon
id|proto
op_assign
id|PPP_IPX
suffix:semicolon
multiline_comment|/* untested */
r_break
suffix:semicolon
r_default
suffix:colon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;isdn_ppp: skipped unsupported protocol: %#x.&bslash;n&quot;
comma
id|skb-&gt;protocol
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|lp
op_assign
id|isdn_net_get_locked_lp
c_func
(paren
id|nd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: all channels busy - requeuing!&bslash;n&quot;
comma
id|netdev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* we have our lp locked from now on */
id|slot
op_assign
id|lp-&gt;ppp_slot
suffix:semicolon
r_if
c_cond
(paren
id|slot
template_param
id|ISDN_MAX_CHANNELS
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;isdn_ppp_xmit: lp-&gt;ppp_slot %d&bslash;n&quot;
comma
id|lp-&gt;ppp_slot
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|ipt
op_assign
id|ippp_table
(braket
id|slot
)braket
suffix:semicolon
id|lp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * after this line .. requeueing in the device queue is no longer allowed!!!&n;&t; */
multiline_comment|/* Pull off the fake header we stuck on earlier to keep&n;&t; * the fragmentation code happy.&n;&t; */
id|skb_pull
c_func
(paren
id|skb
comma
id|IPPP_MAX_HEADER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ipt-&gt;debug
op_amp
l_int|0x4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;xmit skb, len %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|skb-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ipts-&gt;debug
op_amp
l_int|0x40
)paren
id|isdn_ppp_frame_log
c_func
(paren
l_string|&quot;xmit0&quot;
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
l_int|32
comma
id|ipts-&gt;unit
comma
id|lp-&gt;ppp_slot
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP_VJ
r_if
c_cond
(paren
id|proto
op_eq
id|PPP_IP
op_logical_and
id|ipts-&gt;pppcfg
op_amp
id|SC_COMP_TCP
)paren
(brace
multiline_comment|/* ipts here? probably yes, but check this again */
r_struct
id|sk_buff
op_star
id|new_skb
suffix:semicolon
r_int
r_int
id|hl
suffix:semicolon
multiline_comment|/*&n;&t;&t; * we need to reserve enought space in front of&n;&t;&t; * sk_buff. old call to dev_alloc_skb only reserved&n;&t;&t; * 16 bytes, now we are looking what the driver want.&n;&t;&t; */
id|hl
op_assign
id|dev-&gt;drv
(braket
id|lp-&gt;isdn_device
)braket
op_member_access_from_pointer
id|interface-&gt;hl_hdrlen
op_plus
id|IPPP_MAX_HEADER
suffix:semicolon
multiline_comment|/* &n;&t;&t; * Note: hl might still be insufficient because the method&n;&t;&t; * above does not account for a possibible MPPP slave channel&n;&t;&t; * which had larger HL header space requirements than the&n;&t;&t; * master.&n;&t;&t; */
id|new_skb
op_assign
id|alloc_skb
c_func
(paren
id|hl
op_plus
id|skb-&gt;len
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_skb
)paren
(brace
id|u_char
op_star
id|buf
suffix:semicolon
r_int
id|pktlen
suffix:semicolon
id|skb_reserve
c_func
(paren
id|new_skb
comma
id|hl
)paren
suffix:semicolon
id|new_skb-&gt;dev
op_assign
id|skb-&gt;dev
suffix:semicolon
id|skb_put
c_func
(paren
id|new_skb
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|buf
op_assign
id|skb-&gt;data
suffix:semicolon
id|pktlen
op_assign
id|slhc_compress
c_func
(paren
id|ipts-&gt;slcomp
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|new_skb-&gt;data
comma
op_amp
id|buf
comma
op_logical_neg
(paren
id|ipts-&gt;pppcfg
op_amp
id|SC_NO_TCP_CCID
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf
op_ne
id|skb-&gt;data
)paren
(brace
r_if
c_cond
(paren
id|new_skb-&gt;data
op_ne
id|buf
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;isdn_ppp: FATAL error after slhc_compress!!&bslash;n&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|skb
op_assign
id|new_skb
suffix:semicolon
)brace
r_else
(brace
id|dev_kfree_skb
c_func
(paren
id|new_skb
)paren
suffix:semicolon
)brace
id|skb_trim
c_func
(paren
id|skb
comma
id|pktlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;data
(braket
l_int|0
)braket
op_amp
id|SL_TYPE_COMPRESSED_TCP
)paren
(brace
multiline_comment|/* cslip? style -&gt; PPP */
id|proto
op_assign
id|PPP_VJC_COMP
suffix:semicolon
id|skb-&gt;data
(braket
l_int|0
)braket
op_xor_assign
id|SL_TYPE_COMPRESSED_TCP
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|skb-&gt;data
(braket
l_int|0
)braket
op_ge
id|SL_TYPE_UNCOMPRESSED_TCP
)paren
id|proto
op_assign
id|PPP_VJC_UNCOMP
suffix:semicolon
id|skb-&gt;data
(braket
l_int|0
)braket
op_assign
(paren
id|skb-&gt;data
(braket
l_int|0
)braket
op_amp
l_int|0x0f
)paren
op_or
l_int|0x40
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
multiline_comment|/*&n;&t; * normal (single link) or bundle compression&n;&t; */
r_if
c_cond
(paren
id|ipts-&gt;compflags
op_amp
id|SC_COMP_ON
)paren
(brace
id|skb
op_assign
id|isdn_ppp_compress
c_func
(paren
id|skb
comma
op_amp
id|proto
comma
id|ipt
comma
id|ipts
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ipt-&gt;debug
op_amp
l_int|0x24
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;xmit2 skb, len %d, proto %04x&bslash;n&quot;
comma
(paren
r_int
)paren
id|skb-&gt;len
comma
id|proto
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_MPP
r_if
c_cond
(paren
id|ipt-&gt;mpppcfg
op_amp
id|SC_MP_PROT
)paren
(brace
multiline_comment|/* we get mp_seqno from static isdn_net_local */
r_int
id|mp_seqno
op_assign
id|ipts-&gt;mp_seqno
suffix:semicolon
id|ipts-&gt;mp_seqno
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ipt-&gt;mpppcfg
op_amp
id|SC_OUT_SHORT_SEQ
)paren
(brace
r_int
r_char
op_star
id|data
op_assign
id|isdn_ppp_skb_push
c_func
(paren
op_amp
id|skb
comma
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|data
)paren
(brace
r_goto
id|unlock
suffix:semicolon
)brace
id|mp_seqno
op_and_assign
l_int|0xfff
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
id|MP_BEGIN_FRAG
op_or
id|MP_END_FRAG
op_or
(paren
(paren
id|mp_seqno
op_rshift
l_int|8
)paren
op_amp
l_int|0xf
)paren
suffix:semicolon
multiline_comment|/* (B)egin &amp; (E)ndbit .. */
id|data
(braket
l_int|1
)braket
op_assign
id|mp_seqno
op_amp
l_int|0xff
suffix:semicolon
id|data
(braket
l_int|2
)braket
op_assign
id|proto
suffix:semicolon
multiline_comment|/* PID compression */
)brace
r_else
(brace
r_int
r_char
op_star
id|data
op_assign
id|isdn_ppp_skb_push
c_func
(paren
op_amp
id|skb
comma
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|data
)paren
(brace
r_goto
id|unlock
suffix:semicolon
)brace
id|data
(braket
l_int|0
)braket
op_assign
id|MP_BEGIN_FRAG
op_or
id|MP_END_FRAG
suffix:semicolon
multiline_comment|/* (B)egin &amp; (E)ndbit .. */
id|data
(braket
l_int|1
)braket
op_assign
(paren
id|mp_seqno
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
multiline_comment|/* sequence number: 24bit */
id|data
(braket
l_int|2
)braket
op_assign
(paren
id|mp_seqno
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_assign
(paren
id|mp_seqno
op_rshift
l_int|0
)paren
op_amp
l_int|0xff
suffix:semicolon
id|data
(braket
l_int|4
)braket
op_assign
id|proto
suffix:semicolon
multiline_comment|/* PID compression */
)brace
id|proto
op_assign
id|PPP_MP
suffix:semicolon
multiline_comment|/* MP Protocol, 0x003d */
)brace
macro_line|#endif
multiline_comment|/*&n;&t; * &squot;link in bundle&squot; compression  ...&n;&t; */
r_if
c_cond
(paren
id|ipt-&gt;compflags
op_amp
id|SC_LINK_COMP_ON
)paren
(brace
id|skb
op_assign
id|isdn_ppp_compress
c_func
(paren
id|skb
comma
op_amp
id|proto
comma
id|ipt
comma
id|ipts
comma
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ipt-&gt;pppcfg
op_amp
id|SC_COMP_PROT
)paren
op_logical_and
(paren
id|proto
op_le
l_int|0xff
)paren
)paren
(brace
r_int
r_char
op_star
id|data
op_assign
id|isdn_ppp_skb_push
c_func
(paren
op_amp
id|skb
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|data
)paren
(brace
r_goto
id|unlock
suffix:semicolon
)brace
id|data
(braket
l_int|0
)braket
op_assign
id|proto
op_amp
l_int|0xff
suffix:semicolon
)brace
r_else
(brace
r_int
r_char
op_star
id|data
op_assign
id|isdn_ppp_skb_push
c_func
(paren
op_amp
id|skb
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|data
)paren
(brace
r_goto
id|unlock
suffix:semicolon
)brace
id|data
(braket
l_int|0
)braket
op_assign
(paren
id|proto
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
id|proto
op_amp
l_int|0xff
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|ipt-&gt;pppcfg
op_amp
id|SC_COMP_AC
)paren
)paren
(brace
r_int
r_char
op_star
id|data
op_assign
id|isdn_ppp_skb_push
c_func
(paren
op_amp
id|skb
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|data
)paren
(brace
r_goto
id|unlock
suffix:semicolon
)brace
id|data
(braket
l_int|0
)braket
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* All Stations */
id|data
(braket
l_int|1
)braket
op_assign
l_int|0x03
suffix:semicolon
multiline_comment|/* Unnumbered information */
)brace
multiline_comment|/* tx-stats are now updated via BSENT-callback */
r_if
c_cond
(paren
id|ipts-&gt;debug
op_amp
l_int|0x40
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;skb xmit: len: %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|skb-&gt;len
)paren
suffix:semicolon
id|isdn_ppp_frame_log
c_func
(paren
l_string|&quot;xmit&quot;
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
l_int|32
comma
id|ipt-&gt;unit
comma
id|lp-&gt;ppp_slot
)paren
suffix:semicolon
)brace
id|isdn_net_writebuf_skb
c_func
(paren
id|lp
comma
id|skb
)paren
suffix:semicolon
id|unlock
suffix:colon
id|spin_unlock_bh
c_func
(paren
op_amp
id|lp-&gt;xmit_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ISDN_MPP
multiline_comment|/* this is _not_ rfc1990 header, but something we convert both short and long&n; * headers to for convinience&squot;s sake:&n; * &t;byte 0 is flags as in rfc1990&n; *&t;bytes 1...4 is 24-bit seqence number converted to host byte order &n; */
DECL|macro|MP_HEADER_LEN
mdefine_line|#define MP_HEADER_LEN&t;5
DECL|macro|MP_LONGSEQ_MASK
mdefine_line|#define MP_LONGSEQ_MASK&t;&t;0x00ffffff
DECL|macro|MP_SHORTSEQ_MASK
mdefine_line|#define MP_SHORTSEQ_MASK&t;0x00000fff
DECL|macro|MP_LONGSEQ_MAX
mdefine_line|#define MP_LONGSEQ_MAX&t;&t;MP_LONGSEQ_MASK
DECL|macro|MP_SHORTSEQ_MAX
mdefine_line|#define MP_SHORTSEQ_MAX&t;&t;MP_SHORTSEQ_MASK
DECL|macro|MP_LONGSEQ_MAXBIT
mdefine_line|#define MP_LONGSEQ_MAXBIT&t;((MP_LONGSEQ_MASK+1)&gt;&gt;1)
DECL|macro|MP_SHORTSEQ_MAXBIT
mdefine_line|#define MP_SHORTSEQ_MAXBIT&t;((MP_SHORTSEQ_MASK+1)&gt;&gt;1)
multiline_comment|/* sequence-wrap safe comparisions (for long sequence)*/
DECL|macro|MP_LT
mdefine_line|#define MP_LT(a,b)&t;((a-b)&amp;MP_LONGSEQ_MAXBIT)
DECL|macro|MP_LE
mdefine_line|#define MP_LE(a,b) &t;!((b-a)&amp;MP_LONGSEQ_MAXBIT)
DECL|macro|MP_GT
mdefine_line|#define MP_GT(a,b) &t;((b-a)&amp;MP_LONGSEQ_MAXBIT)
DECL|macro|MP_GE
mdefine_line|#define MP_GE(a,b)&t;!((a-b)&amp;MP_LONGSEQ_MAXBIT)
DECL|macro|MP_SEQ
mdefine_line|#define MP_SEQ(f)&t;((*(u32*)(f-&gt;data+1)))
DECL|macro|MP_FLAGS
mdefine_line|#define MP_FLAGS(f)&t;(f-&gt;data[0])
DECL|function|isdn_ppp_mp_bundle_array_init
r_static
r_int
id|isdn_ppp_mp_bundle_array_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|sz
op_assign
id|ISDN_MAX_CHANNELS
op_star
r_sizeof
(paren
id|ippp_bundle
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|isdn_ppp_bundle_arr
op_assign
(paren
id|ippp_bundle
op_star
)paren
id|kmalloc
c_func
(paren
id|sz
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|isdn_ppp_bundle_arr
comma
l_int|0
comma
id|sz
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_MAX_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|spin_lock_init
c_func
(paren
op_amp
id|isdn_ppp_bundle_arr
(braket
id|i
)braket
dot
id|lock
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|isdn_ppp_mp_bundle_alloc
r_static
id|ippp_bundle
op_star
id|isdn_ppp_mp_bundle_alloc
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_MAX_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|isdn_ppp_bundle_arr
(braket
id|i
)braket
dot
id|ref_ct
op_le
l_int|0
)paren
r_return
(paren
id|isdn_ppp_bundle_arr
op_plus
id|i
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|isdn_ppp_mp_init
r_static
r_int
id|isdn_ppp_mp_init
c_func
(paren
id|isdn_net_local
op_star
id|lp
comma
id|ippp_bundle
op_star
id|add_to
)paren
(brace
r_struct
id|ippp_struct
op_star
id|is
op_assign
id|ippp_table
(braket
id|lp-&gt;ppp_slot
)braket
suffix:semicolon
r_if
c_cond
(paren
id|add_to
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;netdev-&gt;pb
)paren
(brace
id|lp-&gt;netdev-&gt;pb-&gt;ref_ct
op_decrement
suffix:semicolon
)brace
id|lp-&gt;netdev-&gt;pb
op_assign
id|add_to
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* first link in a bundle */
id|is-&gt;mp_seqno
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|lp-&gt;netdev-&gt;pb
op_assign
id|isdn_ppp_mp_bundle_alloc
c_func
(paren
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|lp-&gt;next
op_assign
id|lp-&gt;last
op_assign
id|lp
suffix:semicolon
multiline_comment|/* nobody else in a queue */
id|lp-&gt;netdev-&gt;pb-&gt;frags
op_assign
l_int|NULL
suffix:semicolon
id|lp-&gt;netdev-&gt;pb-&gt;frames
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;netdev-&gt;pb-&gt;seq
op_assign
id|LONG_MAX
suffix:semicolon
)brace
id|lp-&gt;netdev-&gt;pb-&gt;ref_ct
op_increment
suffix:semicolon
id|is-&gt;last_link_seqno
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
id|u32
id|isdn_ppp_mp_get_seq
c_func
(paren
r_int
id|short_seq
comma
r_struct
id|sk_buff
op_star
id|skb
comma
id|u32
id|last_seq
)paren
suffix:semicolon
r_static
r_struct
id|sk_buff
op_star
id|isdn_ppp_mp_discard
c_func
(paren
id|ippp_bundle
op_star
id|mp
comma
r_struct
id|sk_buff
op_star
id|from
comma
r_struct
id|sk_buff
op_star
id|to
)paren
suffix:semicolon
r_static
r_void
id|isdn_ppp_mp_reassembly
c_func
(paren
id|isdn_net_dev
op_star
id|net_dev
comma
id|isdn_net_local
op_star
id|lp
comma
r_struct
id|sk_buff
op_star
id|from
comma
r_struct
id|sk_buff
op_star
id|to
)paren
suffix:semicolon
r_static
r_void
id|isdn_ppp_mp_free_skb
c_func
(paren
id|ippp_bundle
op_star
id|mp
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_void
id|isdn_ppp_mp_print_recv_pkt
c_func
(paren
r_int
id|slot
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
DECL|function|isdn_ppp_mp_receive
r_static
r_void
id|isdn_ppp_mp_receive
c_func
(paren
id|isdn_net_dev
op_star
id|net_dev
comma
id|isdn_net_local
op_star
id|lp
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|ippp_struct
op_star
id|is
suffix:semicolon
id|isdn_net_local
op_star
id|lpq
suffix:semicolon
id|ippp_bundle
op_star
id|mp
suffix:semicolon
id|isdn_mppp_stats
op_star
id|stats
suffix:semicolon
r_struct
id|sk_buff
op_star
id|newfrag
comma
op_star
id|frag
comma
op_star
id|start
comma
op_star
id|nextf
suffix:semicolon
id|u32
id|newseq
comma
id|minseq
comma
id|thisseq
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|slot
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|net_dev-&gt;pb-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|mp
op_assign
id|net_dev-&gt;pb
suffix:semicolon
id|stats
op_assign
op_amp
id|mp-&gt;stats
suffix:semicolon
id|slot
op_assign
id|lp-&gt;ppp_slot
suffix:semicolon
r_if
c_cond
(paren
id|slot
template_param
id|ISDN_MAX_CHANNELS
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;isdn_ppp_mp_receive: lp-&gt;ppp_slot %d&bslash;n&quot;
comma
id|lp-&gt;ppp_slot
)paren
suffix:semicolon
id|stats-&gt;frame_drops
op_increment
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|is
op_assign
id|ippp_table
(braket
id|slot
)braket
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|mp-&gt;frames
OG
id|stats-&gt;max_queue_len
)paren
(brace
id|stats-&gt;max_queue_len
op_assign
id|mp-&gt;frames
suffix:semicolon
)brace
r_if
c_cond
(paren
id|is-&gt;debug
op_amp
l_int|0x8
)paren
id|isdn_ppp_mp_print_recv_pkt
c_func
(paren
id|lp-&gt;ppp_slot
comma
id|skb
)paren
suffix:semicolon
id|newseq
op_assign
id|isdn_ppp_mp_get_seq
c_func
(paren
id|is-&gt;mpppcfg
op_amp
id|SC_IN_SHORT_SEQ
comma
id|skb
comma
id|is-&gt;last_link_seqno
)paren
suffix:semicolon
multiline_comment|/* if this packet seq # is less than last already processed one,&n;&t; * toss it right away, but check for sequence start case first &n;&t; */
r_if
c_cond
(paren
id|mp-&gt;seq
OG
id|MP_LONGSEQ_MAX
op_logical_and
(paren
id|newseq
op_amp
id|MP_LONGSEQ_MAXBIT
)paren
)paren
(brace
id|mp-&gt;seq
op_assign
id|newseq
suffix:semicolon
multiline_comment|/* the first packet: required for&n;&t;&t;&t;&t;&t; * rfc1990 non-compliant clients --&n;&t;&t;&t;&t;&t; * prevents constant packet toss */
)brace
r_else
r_if
c_cond
(paren
id|MP_LT
c_func
(paren
id|newseq
comma
id|mp-&gt;seq
)paren
)paren
(brace
id|stats-&gt;frame_drops
op_increment
suffix:semicolon
id|isdn_ppp_mp_free_skb
c_func
(paren
id|mp
comma
id|skb
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* find the minimum received sequence number over all links */
id|is-&gt;last_link_seqno
op_assign
id|minseq
op_assign
id|newseq
suffix:semicolon
r_for
c_loop
(paren
id|lpq
op_assign
id|net_dev-&gt;queue
suffix:semicolon
suffix:semicolon
)paren
(brace
id|slot
op_assign
id|lpq-&gt;ppp_slot
suffix:semicolon
r_if
c_cond
(paren
id|slot
template_param
id|ISDN_MAX_CHANNELS
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;isdn_ppp_mp_receive: lpq-&gt;ppp_slot %d&bslash;n&quot;
comma
id|lpq-&gt;ppp_slot
)paren
suffix:semicolon
)brace
r_else
(brace
id|u32
id|lls
op_assign
id|ippp_table
(braket
id|slot
)braket
op_member_access_from_pointer
id|last_link_seqno
suffix:semicolon
r_if
c_cond
(paren
id|MP_LT
c_func
(paren
id|lls
comma
id|minseq
)paren
)paren
id|minseq
op_assign
id|lls
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|lpq
op_assign
id|lpq-&gt;next
)paren
op_eq
id|net_dev-&gt;queue
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|MP_LT
c_func
(paren
id|minseq
comma
id|mp-&gt;seq
)paren
)paren
id|minseq
op_assign
id|mp-&gt;seq
suffix:semicolon
multiline_comment|/* can&squot;t go beyond already processed&n;&t;&t;&t;&t;&t; * packets */
id|newfrag
op_assign
id|skb
suffix:semicolon
multiline_comment|/* if this new fragment is before the first one, then enqueue it now. */
r_if
c_cond
(paren
(paren
id|frag
op_assign
id|mp-&gt;frags
)paren
op_eq
l_int|NULL
op_logical_or
id|MP_LT
c_func
(paren
id|newseq
comma
id|MP_SEQ
c_func
(paren
id|frag
)paren
)paren
)paren
(brace
id|newfrag-&gt;next
op_assign
id|frag
suffix:semicolon
id|mp-&gt;frags
op_assign
id|frag
op_assign
id|newfrag
suffix:semicolon
id|newfrag
op_assign
l_int|NULL
suffix:semicolon
)brace
id|start
op_assign
id|MP_FLAGS
c_func
(paren
id|frag
)paren
op_amp
id|MP_BEGIN_FRAG
op_logical_and
id|MP_SEQ
c_func
(paren
id|frag
)paren
op_eq
id|mp-&gt;seq
ques
c_cond
id|frag
suffix:colon
l_int|NULL
suffix:semicolon
multiline_comment|/* &n;&t; * main fragment traversing loop&n;&t; *&n;&t; * try to accomplish several tasks:&n;&t; * - insert new fragment into the proper sequence slot (once that&squot;s done&n;&t; *   newfrag will be set to NULL)&n;&t; * - reassemble any complete fragment sequence (non-null &squot;start&squot;&n;&t; *   indicates there is a continguous sequence present)&n;&t; * - discard any incomplete sequences that are below minseq -- due&n;&t; *   to the fact that sender always increment sequence number, if there&n;&t; *   is an incomplete sequence below minseq, no new fragments would&n;&t; *   come to complete such sequence and it should be discarded&n;&t; *&n;&t; * loop completes when we accomplished the following tasks:&n;&t; * - new fragment is inserted in the proper sequence (&squot;newfrag&squot; is &n;&t; *   set to NULL)&n;&t; * - we hit a gap in the sequence, so no reassembly/processing is &n;&t; *   possible (&squot;start&squot; would be set to NULL)&n;&t; *&n;&t; * algorightm for this code is derived from code in the book&n;&t; * &squot;PPP Design And Debugging&squot; by James Carlson (Addison-Wesley)&n;&t; */
r_while
c_loop
(paren
id|start
op_ne
l_int|NULL
op_logical_or
id|newfrag
op_ne
l_int|NULL
)paren
(brace
id|thisseq
op_assign
id|MP_SEQ
c_func
(paren
id|frag
)paren
suffix:semicolon
id|nextf
op_assign
id|frag-&gt;next
suffix:semicolon
multiline_comment|/* drop any duplicate fragments */
r_if
c_cond
(paren
id|newfrag
op_ne
l_int|NULL
op_logical_and
id|thisseq
op_eq
id|newseq
)paren
(brace
id|isdn_ppp_mp_free_skb
c_func
(paren
id|mp
comma
id|newfrag
)paren
suffix:semicolon
id|newfrag
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* insert new fragment before next element if possible. */
r_if
c_cond
(paren
id|newfrag
op_ne
l_int|NULL
op_logical_and
(paren
id|nextf
op_eq
l_int|NULL
op_logical_or
id|MP_LT
c_func
(paren
id|newseq
comma
id|MP_SEQ
c_func
(paren
id|nextf
)paren
)paren
)paren
)paren
(brace
id|newfrag-&gt;next
op_assign
id|nextf
suffix:semicolon
id|frag-&gt;next
op_assign
id|nextf
op_assign
id|newfrag
suffix:semicolon
id|newfrag
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|start
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* check for misplaced start */
r_if
c_cond
(paren
id|start
op_ne
id|frag
op_logical_and
(paren
id|MP_FLAGS
c_func
(paren
id|frag
)paren
op_amp
id|MP_BEGIN_FRAG
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_mppp(seq %d): new &quot;
l_string|&quot;BEGIN flag with no prior END&quot;
comma
id|thisseq
)paren
suffix:semicolon
id|stats-&gt;seqerrs
op_increment
suffix:semicolon
id|stats-&gt;frame_drops
op_increment
suffix:semicolon
id|start
op_assign
id|isdn_ppp_mp_discard
c_func
(paren
id|mp
comma
id|start
comma
id|frag
)paren
suffix:semicolon
id|nextf
op_assign
id|frag-&gt;next
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|MP_LE
c_func
(paren
id|thisseq
comma
id|minseq
)paren
)paren
(brace
r_if
c_cond
(paren
id|MP_FLAGS
c_func
(paren
id|frag
)paren
op_amp
id|MP_BEGIN_FRAG
)paren
id|start
op_assign
id|frag
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|MP_FLAGS
c_func
(paren
id|frag
)paren
op_amp
id|MP_END_FRAG
)paren
id|stats-&gt;frame_drops
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;frags
op_eq
id|frag
)paren
(brace
id|mp-&gt;frags
op_assign
id|nextf
suffix:semicolon
)brace
id|isdn_ppp_mp_free_skb
c_func
(paren
id|mp
comma
id|frag
)paren
suffix:semicolon
id|frag
op_assign
id|nextf
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
multiline_comment|/* if start is non-null and we have end fragment, then&n;&t;&t; * we have full reassembly sequence -- reassemble &n;&t;&t; * and process packet now&n;&t;&t; */
r_if
c_cond
(paren
id|start
op_ne
l_int|NULL
op_logical_and
(paren
id|MP_FLAGS
c_func
(paren
id|frag
)paren
op_amp
id|MP_END_FRAG
)paren
)paren
(brace
id|minseq
op_assign
id|mp-&gt;seq
op_assign
(paren
id|thisseq
op_plus
l_int|1
)paren
op_amp
id|MP_LONGSEQ_MASK
suffix:semicolon
multiline_comment|/* Reassemble the packet then dispatch it */
id|isdn_ppp_mp_reassembly
c_func
(paren
id|net_dev
comma
id|lp
comma
id|start
comma
id|nextf
)paren
suffix:semicolon
id|start
op_assign
l_int|NULL
suffix:semicolon
id|frag
op_assign
l_int|NULL
suffix:semicolon
id|mp-&gt;frags
op_assign
id|nextf
suffix:semicolon
)brace
multiline_comment|/* check if need to update start pointer: if we just&n;&t;&t; * reassembled the packet and sequence is contiguous&n;&t;&t; * then next fragment should be the start of new reassembly&n;&t;&t; * if sequence is contiguous, but we haven&squot;t reassembled yet,&n;&t;&t; * keep going.&n;&t;&t; * if sequence is not contiguous, either clear everyting&n;&t;&t; * below low watermark and set start to the next frag or&n;&t;&t; * clear start ptr.&n;&t;&t; */
r_if
c_cond
(paren
id|nextf
op_ne
l_int|NULL
op_logical_and
(paren
(paren
id|thisseq
op_plus
l_int|1
)paren
op_amp
id|MP_LONGSEQ_MASK
)paren
op_eq
id|MP_SEQ
c_func
(paren
id|nextf
)paren
)paren
(brace
multiline_comment|/* if we just reassembled and the next one is here, &n;&t;&t;&t; * then start another reassembly. */
r_if
c_cond
(paren
id|frag
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|MP_FLAGS
c_func
(paren
id|nextf
)paren
op_amp
id|MP_BEGIN_FRAG
)paren
id|start
op_assign
id|nextf
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_mppp(seq %d):&quot;
l_string|&quot; END flag with no following &quot;
l_string|&quot;BEGIN&quot;
comma
id|thisseq
)paren
suffix:semicolon
id|stats-&gt;seqerrs
op_increment
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|nextf
op_ne
l_int|NULL
op_logical_and
id|frag
op_ne
l_int|NULL
op_logical_and
id|MP_LT
c_func
(paren
id|thisseq
comma
id|minseq
)paren
)paren
(brace
multiline_comment|/* we&squot;ve got a break in the sequence&n;&t;&t;&t;&t; * and we not at the end yet&n;&t;&t;&t;&t; * and we did not just reassembled&n;&t;&t;&t;&t; *(if we did, there wouldn&squot;t be anything before)&n;&t;&t;&t;&t; * and we below the low watermark &n;&t;&t;&t; &t; * discard all the frames below low watermark &n;&t;&t;&t;&t; * and start over */
id|stats-&gt;frame_drops
op_increment
suffix:semicolon
id|mp-&gt;frags
op_assign
id|isdn_ppp_mp_discard
c_func
(paren
id|mp
comma
id|start
comma
id|nextf
)paren
suffix:semicolon
)brace
multiline_comment|/* break in the sequence, no reassembly */
id|start
op_assign
l_int|NULL
suffix:semicolon
)brace
id|frag
op_assign
id|nextf
suffix:semicolon
)brace
multiline_comment|/* while -- main loop */
r_if
c_cond
(paren
id|mp-&gt;frags
op_eq
l_int|NULL
)paren
id|mp-&gt;frags
op_assign
id|frag
suffix:semicolon
multiline_comment|/* rather straighforward way to deal with (not very) possible &n;&t; * queue overflow */
r_if
c_cond
(paren
id|mp-&gt;frames
OG
id|MP_MAX_QUEUE_LEN
)paren
(brace
id|stats-&gt;overflows
op_increment
suffix:semicolon
r_while
c_loop
(paren
id|mp-&gt;frames
OG
id|MP_MAX_QUEUE_LEN
)paren
(brace
id|frag
op_assign
id|mp-&gt;frags-&gt;next
suffix:semicolon
id|isdn_ppp_mp_free_skb
c_func
(paren
id|mp
comma
id|mp-&gt;frags
)paren
suffix:semicolon
id|mp-&gt;frags
op_assign
id|frag
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|isdn_ppp_mp_cleanup
r_static
r_void
id|isdn_ppp_mp_cleanup
c_func
(paren
id|isdn_net_local
op_star
id|lp
)paren
(brace
r_struct
id|sk_buff
op_star
id|frag
op_assign
id|lp-&gt;netdev-&gt;pb-&gt;frags
suffix:semicolon
r_struct
id|sk_buff
op_star
id|nextfrag
suffix:semicolon
r_while
c_loop
(paren
id|frag
)paren
(brace
id|nextfrag
op_assign
id|frag-&gt;next
suffix:semicolon
id|isdn_ppp_mp_free_skb
c_func
(paren
id|lp-&gt;netdev-&gt;pb
comma
id|frag
)paren
suffix:semicolon
id|frag
op_assign
id|nextfrag
suffix:semicolon
)brace
id|lp-&gt;netdev-&gt;pb-&gt;frags
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|isdn_ppp_mp_get_seq
r_static
id|u32
id|isdn_ppp_mp_get_seq
c_func
(paren
r_int
id|short_seq
comma
r_struct
id|sk_buff
op_star
id|skb
comma
id|u32
id|last_seq
)paren
(brace
id|u32
id|seq
suffix:semicolon
r_int
id|flags
op_assign
id|skb-&gt;data
(braket
l_int|0
)braket
op_amp
(paren
id|MP_BEGIN_FRAG
op_or
id|MP_END_FRAG
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|short_seq
)paren
(brace
id|seq
op_assign
id|ntohl
c_func
(paren
op_star
(paren
id|u32
op_star
)paren
id|skb-&gt;data
)paren
op_amp
id|MP_LONGSEQ_MASK
suffix:semicolon
id|skb_push
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* convert 12-bit short seq number to 24-bit long one &n;&t; &t;*/
id|seq
op_assign
id|ntohs
c_func
(paren
op_star
(paren
id|u16
op_star
)paren
id|skb-&gt;data
)paren
op_amp
id|MP_SHORTSEQ_MASK
suffix:semicolon
multiline_comment|/* check for seqence wrap */
r_if
c_cond
(paren
op_logical_neg
(paren
id|seq
op_amp
id|MP_SHORTSEQ_MAXBIT
)paren
op_logical_and
(paren
id|last_seq
op_amp
id|MP_SHORTSEQ_MAXBIT
)paren
op_logical_and
(paren
r_int
r_int
)paren
id|last_seq
op_le
id|MP_LONGSEQ_MAX
)paren
(brace
id|seq
op_or_assign
(paren
id|last_seq
op_plus
id|MP_SHORTSEQ_MAX
op_plus
l_int|1
)paren
op_amp
(paren
op_complement
id|MP_SHORTSEQ_MASK
op_amp
id|MP_LONGSEQ_MASK
)paren
suffix:semicolon
)brace
r_else
id|seq
op_or_assign
id|last_seq
op_amp
(paren
op_complement
id|MP_SHORTSEQ_MASK
op_amp
id|MP_LONGSEQ_MASK
)paren
suffix:semicolon
id|skb_push
c_func
(paren
id|skb
comma
l_int|3
)paren
suffix:semicolon
multiline_comment|/* put converted seqence back in skb */
)brace
op_star
(paren
id|u32
op_star
)paren
(paren
id|skb-&gt;data
op_plus
l_int|1
)paren
op_assign
id|seq
suffix:semicolon
multiline_comment|/* put seqence back in _host_ byte&n;&t;&t;&t;&t;&t; * order */
id|skb-&gt;data
(braket
l_int|0
)braket
op_assign
id|flags
suffix:semicolon
multiline_comment|/* restore flags */
r_return
id|seq
suffix:semicolon
)brace
DECL|function|isdn_ppp_mp_discard
r_struct
id|sk_buff
op_star
id|isdn_ppp_mp_discard
c_func
(paren
id|ippp_bundle
op_star
id|mp
comma
r_struct
id|sk_buff
op_star
id|from
comma
r_struct
id|sk_buff
op_star
id|to
)paren
(brace
r_if
c_cond
(paren
id|from
)paren
r_while
c_loop
(paren
id|from
op_ne
id|to
)paren
(brace
r_struct
id|sk_buff
op_star
id|next
op_assign
id|from-&gt;next
suffix:semicolon
id|isdn_ppp_mp_free_skb
c_func
(paren
id|mp
comma
id|from
)paren
suffix:semicolon
id|from
op_assign
id|next
suffix:semicolon
)brace
r_return
id|from
suffix:semicolon
)brace
DECL|function|isdn_ppp_mp_reassembly
r_void
id|isdn_ppp_mp_reassembly
c_func
(paren
id|isdn_net_dev
op_star
id|net_dev
comma
id|isdn_net_local
op_star
id|lp
comma
r_struct
id|sk_buff
op_star
id|from
comma
r_struct
id|sk_buff
op_star
id|to
)paren
(brace
id|ippp_bundle
op_star
id|mp
op_assign
id|net_dev-&gt;pb
suffix:semicolon
r_int
id|proto
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_int
id|tot_len
suffix:semicolon
r_if
c_cond
(paren
id|MP_FLAGS
c_func
(paren
id|from
)paren
op_eq
(paren
id|MP_BEGIN_FRAG
op_or
id|MP_END_FRAG
)paren
)paren
(brace
r_if
c_cond
(paren
id|ippp_table
(braket
id|lp-&gt;ppp_slot
)braket
op_member_access_from_pointer
id|debug
op_amp
l_int|0x40
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_mppp: reassembly: frame %d, &quot;
l_string|&quot;len %d&bslash;n&quot;
comma
id|MP_SEQ
c_func
(paren
id|from
)paren
comma
id|from-&gt;len
)paren
suffix:semicolon
)brace
id|skb
op_assign
id|from
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
id|MP_HEADER_LEN
)paren
suffix:semicolon
id|mp-&gt;frames
op_decrement
suffix:semicolon
)brace
r_else
(brace
r_struct
id|sk_buff
op_star
id|frag
suffix:semicolon
r_int
id|n
suffix:semicolon
r_for
c_loop
(paren
id|tot_len
op_assign
id|n
op_assign
l_int|0
comma
id|frag
op_assign
id|from
suffix:semicolon
id|frag
op_ne
id|to
suffix:semicolon
id|frag
op_assign
id|frag-&gt;next
comma
id|n
op_increment
)paren
(brace
id|tot_len
op_add_assign
id|frag-&gt;len
op_minus
id|MP_HEADER_LEN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ippp_table
(braket
id|lp-&gt;ppp_slot
)braket
op_member_access_from_pointer
id|debug
op_amp
l_int|0x40
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_mppp: reassembling frames %d &quot;
l_string|&quot;to %d, len %d&bslash;n&quot;
comma
id|MP_SEQ
c_func
(paren
id|from
)paren
comma
(paren
id|MP_SEQ
c_func
(paren
id|from
)paren
op_plus
id|n
op_minus
l_int|1
)paren
op_amp
id|MP_LONGSEQ_MASK
comma
id|tot_len
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|tot_len
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;isdn_mppp: cannot allocate sk buff &quot;
l_string|&quot;of size %d&bslash;n&quot;
comma
id|tot_len
)paren
suffix:semicolon
id|isdn_ppp_mp_discard
c_func
(paren
id|mp
comma
id|from
comma
id|to
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
id|from
op_ne
id|to
)paren
(brace
r_int
r_int
id|len
op_assign
id|from-&gt;len
op_minus
id|MP_HEADER_LEN
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
comma
id|from-&gt;data
op_plus
id|MP_HEADER_LEN
comma
id|len
)paren
suffix:semicolon
id|frag
op_assign
id|from-&gt;next
suffix:semicolon
id|isdn_ppp_mp_free_skb
c_func
(paren
id|mp
comma
id|from
)paren
suffix:semicolon
id|from
op_assign
id|frag
suffix:semicolon
)brace
)brace
id|proto
op_assign
id|isdn_ppp_strip_proto
c_func
(paren
id|skb
)paren
suffix:semicolon
id|isdn_ppp_push_higher
c_func
(paren
id|net_dev
comma
id|lp
comma
id|skb
comma
id|proto
)paren
suffix:semicolon
)brace
DECL|function|isdn_ppp_mp_free_skb
r_static
r_void
id|isdn_ppp_mp_free_skb
c_func
(paren
id|ippp_bundle
op_star
id|mp
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|mp-&gt;frames
op_decrement
suffix:semicolon
)brace
DECL|function|isdn_ppp_mp_print_recv_pkt
r_static
r_void
id|isdn_ppp_mp_print_recv_pkt
c_func
(paren
r_int
id|slot
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;mp_recv: %d/%d -&gt; %02x %02x %02x %02x %02x %02x&bslash;n&quot;
comma
id|slot
comma
(paren
r_int
)paren
id|skb-&gt;len
comma
(paren
r_int
)paren
id|skb-&gt;data
(braket
l_int|0
)braket
comma
(paren
r_int
)paren
id|skb-&gt;data
(braket
l_int|1
)braket
comma
(paren
r_int
)paren
id|skb-&gt;data
(braket
l_int|2
)braket
comma
(paren
r_int
)paren
id|skb-&gt;data
(braket
l_int|3
)braket
comma
(paren
r_int
)paren
id|skb-&gt;data
(braket
l_int|4
)braket
comma
(paren
r_int
)paren
id|skb-&gt;data
(braket
l_int|5
)braket
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|isdn_ppp_bundle
id|isdn_ppp_bundle
c_func
(paren
r_struct
id|ippp_struct
op_star
id|is
comma
r_int
id|unit
)paren
(brace
r_char
id|ifn
(braket
id|IFNAMSIZ
op_plus
l_int|1
)braket
suffix:semicolon
id|isdn_net_dev
op_star
id|p
suffix:semicolon
id|isdn_net_local
op_star
id|lp
comma
op_star
id|nlp
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|sprintf
c_func
(paren
id|ifn
comma
l_string|&quot;ippp%d&quot;
comma
id|unit
)paren
suffix:semicolon
id|p
op_assign
id|isdn_net_findif
c_func
(paren
id|ifn
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ippp_bundle: cannot find %s&bslash;n&quot;
comma
id|ifn
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|p-&gt;pb-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|nlp
op_assign
id|is-&gt;lp
suffix:semicolon
id|lp
op_assign
id|p-&gt;queue
suffix:semicolon
r_if
c_cond
(paren
id|nlp-&gt;ppp_slot
OL
l_int|0
op_logical_or
id|nlp-&gt;ppp_slot
op_ge
id|ISDN_MAX_CHANNELS
op_logical_or
id|lp-&gt;ppp_slot
OL
l_int|0
op_logical_or
id|lp-&gt;ppp_slot
op_ge
id|ISDN_MAX_CHANNELS
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ippp_bundle: binding to invalid slot %d&bslash;n&quot;
comma
id|nlp-&gt;ppp_slot
OL
l_int|0
op_logical_or
id|nlp-&gt;ppp_slot
op_ge
id|ISDN_MAX_CHANNELS
ques
c_cond
id|nlp-&gt;ppp_slot
suffix:colon
id|lp-&gt;ppp_slot
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|isdn_net_add_to_bundle
c_func
(paren
id|p
comma
id|nlp
)paren
suffix:semicolon
id|ippp_table
(braket
id|nlp-&gt;ppp_slot
)braket
op_member_access_from_pointer
id|unit
op_assign
id|ippp_table
(braket
id|lp-&gt;ppp_slot
)braket
op_member_access_from_pointer
id|unit
suffix:semicolon
multiline_comment|/* maybe also SC_CCP stuff */
id|ippp_table
(braket
id|nlp-&gt;ppp_slot
)braket
op_member_access_from_pointer
id|pppcfg
op_or_assign
id|ippp_table
(braket
id|lp-&gt;ppp_slot
)braket
op_member_access_from_pointer
id|pppcfg
op_amp
(paren
id|SC_ENABLE_IP
op_or
id|SC_NO_TCP_CCID
op_or
id|SC_REJ_COMP_TCP
)paren
suffix:semicolon
id|ippp_table
(braket
id|nlp-&gt;ppp_slot
)braket
op_member_access_from_pointer
id|mpppcfg
op_or_assign
id|ippp_table
(braket
id|lp-&gt;ppp_slot
)braket
op_member_access_from_pointer
id|mpppcfg
op_amp
(paren
id|SC_MP_PROT
op_or
id|SC_REJ_MP_PROT
op_or
id|SC_OUT_SHORT_SEQ
op_or
id|SC_IN_SHORT_SEQ
)paren
suffix:semicolon
id|rc
op_assign
id|isdn_ppp_mp_init
c_func
(paren
id|nlp
comma
id|p-&gt;pb
)paren
suffix:semicolon
id|out
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|p-&gt;pb-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ISDN_MPP */
multiline_comment|/*&n; * network device ioctl handlers&n; */
r_static
r_int
DECL|function|isdn_ppp_dev_ioctl_stats
id|isdn_ppp_dev_ioctl_stats
c_func
(paren
r_int
id|slot
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ppp_stats
op_star
id|res
comma
id|t
suffix:semicolon
id|isdn_net_local
op_star
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|err
suffix:semicolon
id|res
op_assign
(paren
r_struct
id|ppp_stats
op_star
)paren
id|ifr-&gt;ifr_ifru.ifru_data
suffix:semicolon
id|err
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|res
comma
r_sizeof
(paren
r_struct
id|ppp_stats
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/* build a temporary stat struct and copy it to user space */
id|memset
c_func
(paren
op_amp
id|t
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ppp_stats
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
(brace
id|t.p.ppp_ipackets
op_assign
id|lp-&gt;stats.rx_packets
suffix:semicolon
id|t.p.ppp_ierrors
op_assign
id|lp-&gt;stats.rx_errors
suffix:semicolon
id|t.p.ppp_opackets
op_assign
id|lp-&gt;stats.tx_packets
suffix:semicolon
id|t.p.ppp_oerrors
op_assign
id|lp-&gt;stats.tx_errors
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP_VJ
r_if
c_cond
(paren
id|slot
op_ge
l_int|0
op_logical_and
id|ippp_table
(braket
id|slot
)braket
op_member_access_from_pointer
id|slcomp
)paren
(brace
r_struct
id|slcompress
op_star
id|slcomp
op_assign
id|ippp_table
(braket
id|slot
)braket
op_member_access_from_pointer
id|slcomp
suffix:semicolon
id|t.vj.vjs_packets
op_assign
id|slcomp-&gt;sls_o_compressed
op_plus
id|slcomp-&gt;sls_o_uncompressed
suffix:semicolon
id|t.vj.vjs_compressed
op_assign
id|slcomp-&gt;sls_o_compressed
suffix:semicolon
id|t.vj.vjs_searches
op_assign
id|slcomp-&gt;sls_o_searches
suffix:semicolon
id|t.vj.vjs_misses
op_assign
id|slcomp-&gt;sls_o_misses
suffix:semicolon
id|t.vj.vjs_errorin
op_assign
id|slcomp-&gt;sls_i_error
suffix:semicolon
id|t.vj.vjs_tossed
op_assign
id|slcomp-&gt;sls_i_tossed
suffix:semicolon
id|t.vj.vjs_uncompressedin
op_assign
id|slcomp-&gt;sls_i_uncompressed
suffix:semicolon
id|t.vj.vjs_compressedin
op_assign
id|slcomp-&gt;sls_i_compressed
suffix:semicolon
)brace
macro_line|#endif
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|res
comma
op_amp
id|t
comma
r_sizeof
(paren
r_struct
id|ppp_stats
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|isdn_ppp_dev_ioctl
id|isdn_ppp_dev_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|r
suffix:semicolon
r_int
id|len
suffix:semicolon
id|isdn_net_local
op_star
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_ne
id|ISDN_NET_ENCAP_SYNCPPP
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCGPPPVER
suffix:colon
id|r
op_assign
(paren
r_char
op_star
)paren
id|ifr-&gt;ifr_ifru.ifru_data
suffix:semicolon
id|len
op_assign
id|strlen
c_func
(paren
id|PPP_VERSION
)paren
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|r
comma
id|PPP_VERSION
comma
id|len
)paren
)paren
(brace
id|error
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SIOCGPPPSTATS
suffix:colon
id|error
op_assign
id|isdn_ppp_dev_ioctl_stats
c_func
(paren
id|lp-&gt;ppp_slot
comma
id|ifr
comma
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|error
suffix:semicolon
)brace
r_static
r_int
DECL|function|isdn_ppp_if_get_unit
id|isdn_ppp_if_get_unit
c_func
(paren
r_char
op_star
id|name
)paren
(brace
r_int
id|len
comma
id|i
comma
id|unit
op_assign
l_int|0
comma
id|deci
suffix:semicolon
id|len
op_assign
id|strlen
c_func
(paren
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
l_string|&quot;ippp&quot;
comma
id|name
comma
l_int|4
)paren
op_logical_or
id|len
OG
l_int|8
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|deci
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
comma
id|deci
op_mul_assign
l_int|10
)paren
(brace
r_char
id|a
op_assign
id|name
(braket
id|len
op_minus
id|i
op_minus
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|a
op_ge
l_char|&squot;0&squot;
op_logical_and
id|a
op_le
l_char|&squot;9&squot;
)paren
id|unit
op_add_assign
(paren
id|a
op_minus
l_char|&squot;0&squot;
)paren
op_star
id|deci
suffix:semicolon
r_else
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|i
op_logical_or
id|len
op_minus
id|i
op_ne
l_int|4
)paren
id|unit
op_assign
op_minus
l_int|1
suffix:semicolon
r_return
id|unit
suffix:semicolon
)brace
r_int
DECL|function|isdn_ppp_dial_slave
id|isdn_ppp_dial_slave
c_func
(paren
r_char
op_star
id|name
)paren
(brace
macro_line|#ifdef CONFIG_ISDN_MPP
id|isdn_net_dev
op_star
id|ndev
suffix:semicolon
id|isdn_net_local
op_star
id|lp
suffix:semicolon
r_struct
id|net_device
op_star
id|sdev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ndev
op_assign
id|isdn_net_findif
c_func
(paren
id|name
)paren
)paren
)paren
r_return
l_int|1
suffix:semicolon
id|lp
op_assign
id|ndev-&gt;local
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
)paren
r_return
l_int|5
suffix:semicolon
id|sdev
op_assign
id|lp-&gt;slave
suffix:semicolon
r_while
c_loop
(paren
id|sdev
)paren
(brace
id|isdn_net_local
op_star
id|mlp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|sdev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mlp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
)paren
r_break
suffix:semicolon
id|sdev
op_assign
id|mlp-&gt;slave
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|sdev
)paren
r_return
l_int|2
suffix:semicolon
id|isdn_net_dial_req
c_func
(paren
(paren
id|isdn_net_local
op_star
)paren
id|sdev-&gt;priv
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#else
r_return
op_minus
l_int|1
suffix:semicolon
macro_line|#endif
)brace
r_int
DECL|function|isdn_ppp_hangup_slave
id|isdn_ppp_hangup_slave
c_func
(paren
r_char
op_star
id|name
)paren
(brace
macro_line|#ifdef CONFIG_ISDN_MPP
id|isdn_net_dev
op_star
id|ndev
suffix:semicolon
id|isdn_net_local
op_star
id|lp
suffix:semicolon
r_struct
id|net_device
op_star
id|sdev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ndev
op_assign
id|isdn_net_findif
c_func
(paren
id|name
)paren
)paren
)paren
r_return
l_int|1
suffix:semicolon
id|lp
op_assign
id|ndev-&gt;local
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|lp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
)paren
r_return
l_int|5
suffix:semicolon
id|sdev
op_assign
id|lp-&gt;slave
suffix:semicolon
r_while
c_loop
(paren
id|sdev
)paren
(brace
id|isdn_net_local
op_star
id|mlp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|sdev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mlp-&gt;flags
op_amp
id|ISDN_NET_CONNECTED
)paren
)paren
r_break
suffix:semicolon
id|sdev
op_assign
id|mlp-&gt;slave
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|sdev
)paren
r_return
l_int|2
suffix:semicolon
id|isdn_net_hangup
c_func
(paren
id|sdev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#else
r_return
op_minus
l_int|1
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * PPP compression stuff&n; */
multiline_comment|/* Push an empty CCP Data Frame up to the daemon to wake it up and let it&n;   generate a CCP Reset-Request or tear down CCP altogether */
DECL|function|isdn_ppp_ccp_kickup
r_static
r_void
id|isdn_ppp_ccp_kickup
c_func
(paren
r_struct
id|ippp_struct
op_star
id|is
)paren
(brace
id|isdn_ppp_fill_rq
c_func
(paren
l_int|NULL
comma
l_int|0
comma
id|PPP_COMP
comma
id|is-&gt;lp-&gt;ppp_slot
)paren
suffix:semicolon
)brace
multiline_comment|/* In-kernel handling of CCP Reset-Request and Reset-Ack is necessary,&n;   but absolutely nontrivial. The most abstruse problem we are facing is&n;   that the generation, reception and all the handling of timeouts and&n;   resends including proper request id management should be entirely left&n;   to the (de)compressor, but indeed is not covered by the current API to&n;   the (de)compressor. The API is a prototype version from PPP where only&n;   some (de)compressors have yet been implemented and all of them are&n;   rather simple in their reset handling. Especially, their is only one&n;   outstanding ResetAck at a time with all of them and ResetReq/-Acks do&n;   not have parameters. For this very special case it was sufficient to&n;   just return an error code from the decompressor and have a single&n;   reset() entry to communicate all the necessary information between&n;   the framework and the (de)compressor. Bad enough, LZS is different&n;   (and any other compressor may be different, too). It has multiple&n;   histories (eventually) and needs to Reset each of them independently&n;   and thus uses multiple outstanding Acks and history numbers as an&n;   additional parameter to Reqs/Acks.&n;   All that makes it harder to port the reset state engine into the&n;   kernel because it is not just the same simple one as in (i)pppd but&n;   it must be able to pass additional parameters and have multiple out-&n;   standing Acks. We are trying to achieve the impossible by handling&n;   reset transactions independent by their id. The id MUST change when&n;   the data portion changes, thus any (de)compressor who uses more than&n;   one resettable state must provide and recognize individual ids for&n;   each individual reset transaction. The framework itself does _only_&n;   differentiate them by id, because it has no other semantics like the&n;   (de)compressor might.&n;   This looks like a major redesign of the interface would be nice,&n;   but I don&squot;t have an idea how to do it better. */
multiline_comment|/* Send a CCP Reset-Request or Reset-Ack directly from the kernel. This is&n;   getting that lengthy because there is no simple &quot;send-this-frame-out&quot;&n;   function above but every wrapper does a bit different. Hope I guess&n;   correct in this hack... */
DECL|function|isdn_ppp_ccp_xmit_reset
r_static
r_void
id|isdn_ppp_ccp_xmit_reset
c_func
(paren
r_struct
id|ippp_struct
op_star
id|is
comma
r_int
id|proto
comma
r_int
r_char
id|code
comma
r_int
r_char
id|id
comma
r_int
r_char
op_star
id|data
comma
r_int
id|len
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_char
op_star
id|p
suffix:semicolon
r_int
id|hl
suffix:semicolon
r_int
id|cnt
op_assign
l_int|0
suffix:semicolon
id|isdn_net_local
op_star
id|lp
op_assign
id|is-&gt;lp
suffix:semicolon
multiline_comment|/* Alloc large enough skb */
id|hl
op_assign
id|dev-&gt;drv
(braket
id|lp-&gt;isdn_device
)braket
op_member_access_from_pointer
id|interface-&gt;hl_hdrlen
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|len
op_plus
id|hl
op_plus
l_int|16
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ippp: CCP cannot send reset - out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb
comma
id|hl
)paren
suffix:semicolon
multiline_comment|/* We may need to stuff an address and control field first */
r_if
c_cond
(paren
op_logical_neg
(paren
id|is-&gt;pppcfg
op_amp
id|SC_COMP_AC
)paren
)paren
(brace
id|p
op_assign
id|skb_put
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|0xff
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|0x03
suffix:semicolon
)brace
multiline_comment|/* Stuff proto, code, id and length */
id|p
op_assign
id|skb_put
c_func
(paren
id|skb
comma
l_int|6
)paren
suffix:semicolon
op_star
id|p
op_increment
op_assign
(paren
id|proto
op_rshift
l_int|8
)paren
suffix:semicolon
op_star
id|p
op_increment
op_assign
(paren
id|proto
op_amp
l_int|0xff
)paren
suffix:semicolon
op_star
id|p
op_increment
op_assign
id|code
suffix:semicolon
op_star
id|p
op_increment
op_assign
id|id
suffix:semicolon
id|cnt
op_assign
l_int|4
op_plus
id|len
suffix:semicolon
op_star
id|p
op_increment
op_assign
(paren
id|cnt
op_rshift
l_int|8
)paren
suffix:semicolon
op_star
id|p
op_increment
op_assign
(paren
id|cnt
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Now stuff remaining bytes */
r_if
c_cond
(paren
id|len
)paren
(brace
id|p
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|p
comma
id|data
comma
id|len
)paren
suffix:semicolon
)brace
multiline_comment|/* skb is now ready for xmit */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Sending CCP Frame:&bslash;n&quot;
)paren
suffix:semicolon
id|isdn_ppp_frame_log
c_func
(paren
l_string|&quot;ccp-xmit&quot;
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
l_int|32
comma
id|is-&gt;unit
comma
id|lp-&gt;ppp_slot
)paren
suffix:semicolon
id|isdn_net_write_super
c_func
(paren
id|lp
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/* Allocate the reset state vector */
DECL|function|isdn_ppp_ccp_reset_alloc
r_static
r_struct
id|ippp_ccp_reset
op_star
id|isdn_ppp_ccp_reset_alloc
c_func
(paren
r_struct
id|ippp_struct
op_star
id|is
)paren
(brace
r_struct
id|ippp_ccp_reset
op_star
id|r
suffix:semicolon
id|r
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ippp_ccp_reset
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|r
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ippp_ccp: failed to allocate reset data&quot;
l_string|&quot; structure - no mem&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|r
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ippp_ccp_reset
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ippp_ccp: allocated reset data structure %p&bslash;n&quot;
comma
id|r
)paren
suffix:semicolon
id|is-&gt;reset
op_assign
id|r
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
multiline_comment|/* Destroy the reset state vector. Kill all pending timers first. */
DECL|function|isdn_ppp_ccp_reset_free
r_static
r_void
id|isdn_ppp_ccp_reset_free
c_func
(paren
r_struct
id|ippp_struct
op_star
id|is
)paren
(brace
r_int
r_int
id|id
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ippp_ccp: freeing reset data structure %p&bslash;n&quot;
comma
id|is-&gt;reset
)paren
suffix:semicolon
r_for
c_loop
(paren
id|id
op_assign
l_int|0
suffix:semicolon
id|id
OL
l_int|256
suffix:semicolon
id|id
op_increment
)paren
(brace
r_if
c_cond
(paren
id|is-&gt;reset-&gt;rs
(braket
id|id
)braket
)paren
(brace
id|isdn_ppp_ccp_reset_free_state
c_func
(paren
id|is
comma
(paren
r_int
r_char
)paren
id|id
)paren
suffix:semicolon
)brace
)brace
id|kfree
c_func
(paren
id|is-&gt;reset
)paren
suffix:semicolon
id|is-&gt;reset
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Free a given state and clear everything up for later reallocation */
DECL|function|isdn_ppp_ccp_reset_free_state
r_static
r_void
id|isdn_ppp_ccp_reset_free_state
c_func
(paren
r_struct
id|ippp_struct
op_star
id|is
comma
r_int
r_char
id|id
)paren
(brace
r_struct
id|ippp_ccp_reset_state
op_star
id|rs
suffix:semicolon
r_if
c_cond
(paren
id|is-&gt;reset-&gt;rs
(braket
id|id
)braket
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ippp_ccp: freeing state for id %d&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
id|rs
op_assign
id|is-&gt;reset-&gt;rs
(braket
id|id
)braket
suffix:semicolon
multiline_comment|/* Make sure the kernel will not call back later */
r_if
c_cond
(paren
id|rs-&gt;ta
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|rs-&gt;timer
)paren
suffix:semicolon
)brace
id|is-&gt;reset-&gt;rs
(braket
id|id
)braket
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|rs
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ippp_ccp: id %d is not allocated&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* The timer callback function which is called when a ResetReq has timed out,&n;   aka has never been answered by a ResetAck */
DECL|function|isdn_ppp_ccp_timer_callback
r_static
r_void
id|isdn_ppp_ccp_timer_callback
c_func
(paren
r_int
r_int
id|closure
)paren
(brace
r_struct
id|ippp_ccp_reset_state
op_star
id|rs
op_assign
(paren
r_struct
id|ippp_ccp_reset_state
op_star
)paren
id|closure
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rs
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ippp_ccp: timer cb with zero closure.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rs-&gt;ta
op_logical_and
id|rs-&gt;state
op_eq
id|CCPResetSentReq
)paren
(brace
multiline_comment|/* We are correct here */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ippp_ccp: CCP Reset timed out for id %d&bslash;n&quot;
comma
id|rs-&gt;id
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rs-&gt;expra
)paren
(brace
multiline_comment|/* Hmm, there is no Ack really expected. We can clean&n;&t;&t;&t;   up the state now, it will be reallocated if the&n;&t;&t;&t;   decompressor insists on another reset */
id|rs-&gt;ta
op_assign
l_int|0
suffix:semicolon
id|isdn_ppp_ccp_reset_free_state
c_func
(paren
id|rs-&gt;is
comma
id|rs-&gt;id
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Push it again */
id|isdn_ppp_ccp_xmit_reset
c_func
(paren
id|rs-&gt;is
comma
id|PPP_CCP
comma
id|CCP_RESETREQ
comma
id|rs-&gt;id
comma
id|rs-&gt;data
comma
id|rs-&gt;dlen
)paren
suffix:semicolon
multiline_comment|/* Restart timer */
id|rs-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|HZ
op_star
l_int|5
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|rs-&gt;timer
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ippp_ccp: timer cb in wrong state %d&bslash;n&quot;
comma
id|rs-&gt;state
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Allocate a new reset transaction state */
DECL|function|isdn_ppp_ccp_reset_alloc_state
r_static
r_struct
id|ippp_ccp_reset_state
op_star
id|isdn_ppp_ccp_reset_alloc_state
c_func
(paren
r_struct
id|ippp_struct
op_star
id|is
comma
r_int
r_char
id|id
)paren
(brace
r_struct
id|ippp_ccp_reset_state
op_star
id|rs
suffix:semicolon
r_if
c_cond
(paren
id|is-&gt;reset-&gt;rs
(braket
id|id
)braket
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ippp_ccp: old state exists for id %d&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|rs
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ippp_ccp_reset_state
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rs
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|rs
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ippp_ccp_reset_state
)paren
)paren
suffix:semicolon
id|rs-&gt;state
op_assign
id|CCPResetIdle
suffix:semicolon
id|rs-&gt;is
op_assign
id|is
suffix:semicolon
id|rs-&gt;id
op_assign
id|id
suffix:semicolon
id|rs-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|rs
suffix:semicolon
id|rs-&gt;timer.function
op_assign
id|isdn_ppp_ccp_timer_callback
suffix:semicolon
id|is-&gt;reset-&gt;rs
(braket
id|id
)braket
op_assign
id|rs
suffix:semicolon
)brace
r_return
id|rs
suffix:semicolon
)brace
multiline_comment|/* A decompressor wants a reset with a set of parameters - do what is&n;   necessary to fulfill it */
DECL|function|isdn_ppp_ccp_reset_trans
r_static
r_void
id|isdn_ppp_ccp_reset_trans
c_func
(paren
r_struct
id|ippp_struct
op_star
id|is
comma
r_struct
id|isdn_ppp_resetparams
op_star
id|rp
)paren
(brace
r_struct
id|ippp_ccp_reset_state
op_star
id|rs
suffix:semicolon
r_if
c_cond
(paren
id|rp-&gt;valid
)paren
(brace
multiline_comment|/* The decompressor defines parameters by itself */
r_if
c_cond
(paren
id|rp-&gt;rsend
)paren
(brace
multiline_comment|/* And he wants us to send a request */
r_if
c_cond
(paren
op_logical_neg
(paren
id|rp-&gt;idval
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ippp_ccp: decompressor must&quot;
l_string|&quot; specify reset id&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|is-&gt;reset-&gt;rs
(braket
id|rp-&gt;id
)braket
)paren
(brace
multiline_comment|/* There is already a transaction in existence&n;&t;&t;&t;&t;   for this id. May be still waiting for a&n;&t;&t;&t;&t;   Ack or may be wrong. */
id|rs
op_assign
id|is-&gt;reset-&gt;rs
(braket
id|rp-&gt;id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|rs-&gt;state
op_eq
id|CCPResetSentReq
op_logical_and
id|rs-&gt;ta
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ippp_ccp: reset&quot;
l_string|&quot; trans still in progress&quot;
l_string|&quot; for id %d&bslash;n&quot;
comma
id|rp-&gt;id
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ippp_ccp: reset&quot;
l_string|&quot; trans in wrong state %d for&quot;
l_string|&quot; id %d&bslash;n&quot;
comma
id|rs-&gt;state
comma
id|rp-&gt;id
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Ok, this is a new transaction */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ippp_ccp: new trans for id&quot;
l_string|&quot; %d to be started&bslash;n&quot;
comma
id|rp-&gt;id
)paren
suffix:semicolon
id|rs
op_assign
id|isdn_ppp_ccp_reset_alloc_state
c_func
(paren
id|is
comma
id|rp-&gt;id
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rs
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ippp_ccp: out of mem&quot;
l_string|&quot; allocing ccp trans&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|rs-&gt;state
op_assign
id|CCPResetSentReq
suffix:semicolon
id|rs-&gt;expra
op_assign
id|rp-&gt;expra
suffix:semicolon
r_if
c_cond
(paren
id|rp-&gt;dtval
)paren
(brace
id|rs-&gt;dlen
op_assign
id|rp-&gt;dlen
suffix:semicolon
id|memcpy
c_func
(paren
id|rs-&gt;data
comma
id|rp-&gt;data
comma
id|rp-&gt;dlen
)paren
suffix:semicolon
)brace
multiline_comment|/* HACK TODO - add link comp here */
id|isdn_ppp_ccp_xmit_reset
c_func
(paren
id|is
comma
id|PPP_CCP
comma
id|CCP_RESETREQ
comma
id|rs-&gt;id
comma
id|rs-&gt;data
comma
id|rs-&gt;dlen
)paren
suffix:semicolon
multiline_comment|/* Start the timer */
id|rs-&gt;timer.expires
op_assign
id|jiffies
op_plus
l_int|5
op_star
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|rs-&gt;timer
)paren
suffix:semicolon
id|rs-&gt;ta
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ippp_ccp: no reset sent&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* The reset params are invalid. The decompressor does not&n;&t;&t;   care about them, so we just send the minimal requests&n;&t;&t;   and increase ids only when an Ack is received for a&n;&t;&t;   given id */
r_if
c_cond
(paren
id|is-&gt;reset-&gt;rs
(braket
id|is-&gt;reset-&gt;lastid
)braket
)paren
(brace
multiline_comment|/* There is already a transaction in existence&n;&t;&t;&t;   for this id. May be still waiting for a&n;&t;&t;&t;   Ack or may be wrong. */
id|rs
op_assign
id|is-&gt;reset-&gt;rs
(braket
id|is-&gt;reset-&gt;lastid
)braket
suffix:semicolon
r_if
c_cond
(paren
id|rs-&gt;state
op_eq
id|CCPResetSentReq
op_logical_and
id|rs-&gt;ta
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ippp_ccp: reset&quot;
l_string|&quot; trans still in progress&quot;
l_string|&quot; for id %d&bslash;n&quot;
comma
id|rp-&gt;id
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ippp_ccp: reset&quot;
l_string|&quot; trans in wrong state %d for&quot;
l_string|&quot; id %d&bslash;n&quot;
comma
id|rs-&gt;state
comma
id|rp-&gt;id
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ippp_ccp: new trans for id&quot;
l_string|&quot; %d to be started&bslash;n&quot;
comma
id|is-&gt;reset-&gt;lastid
)paren
suffix:semicolon
id|rs
op_assign
id|isdn_ppp_ccp_reset_alloc_state
c_func
(paren
id|is
comma
id|is-&gt;reset-&gt;lastid
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rs
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ippp_ccp: out of mem&quot;
l_string|&quot; allocing ccp trans&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|rs-&gt;state
op_assign
id|CCPResetSentReq
suffix:semicolon
multiline_comment|/* We always expect an Ack if the decompressor doesnt&n;&t;&t;&t;   know&t;better */
id|rs-&gt;expra
op_assign
l_int|1
suffix:semicolon
id|rs-&gt;dlen
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* HACK TODO - add link comp here */
id|isdn_ppp_ccp_xmit_reset
c_func
(paren
id|is
comma
id|PPP_CCP
comma
id|CCP_RESETREQ
comma
id|rs-&gt;id
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Start the timer */
id|rs-&gt;timer.expires
op_assign
id|jiffies
op_plus
l_int|5
op_star
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|rs-&gt;timer
)paren
suffix:semicolon
id|rs-&gt;ta
op_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* An Ack was received for this id. This means we stop the timer and clean&n;   up the state prior to calling the decompressors reset routine. */
DECL|function|isdn_ppp_ccp_reset_ack_rcvd
r_static
r_void
id|isdn_ppp_ccp_reset_ack_rcvd
c_func
(paren
r_struct
id|ippp_struct
op_star
id|is
comma
r_int
r_char
id|id
)paren
(brace
r_struct
id|ippp_ccp_reset_state
op_star
id|rs
op_assign
id|is-&gt;reset-&gt;rs
(braket
id|id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|rs
)paren
(brace
r_if
c_cond
(paren
id|rs-&gt;ta
op_logical_and
id|rs-&gt;state
op_eq
id|CCPResetSentReq
)paren
(brace
multiline_comment|/* Great, we are correct */
r_if
c_cond
(paren
op_logical_neg
id|rs-&gt;expra
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ippp_ccp: ResetAck received&quot;
l_string|&quot; for id %d but not expected&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ippp_ccp: ResetAck received out of&quot;
l_string|&quot;sync for id %d&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rs-&gt;ta
)paren
(brace
id|rs-&gt;ta
op_assign
l_int|0
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|rs-&gt;timer
)paren
suffix:semicolon
)brace
id|isdn_ppp_ccp_reset_free_state
c_func
(paren
id|is
comma
id|id
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ippp_ccp: ResetAck received for unknown id&quot;
l_string|&quot; %d&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
)brace
multiline_comment|/* Make sure the simple reset stuff uses a new id next time */
id|is-&gt;reset-&gt;lastid
op_increment
suffix:semicolon
)brace
multiline_comment|/* &n; * decompress packet&n; *&n; * if master = 0, we&squot;re trying to uncompress an per-link compressed packet,&n; * as opposed to an compressed reconstructed-from-MPPP packet.&n; * proto is updated to protocol field of uncompressed packet.&n; *&n; * retval: decompressed packet,&n; *         same packet if uncompressed,&n; *&t;   NULL if decompression error&n; */
DECL|function|isdn_ppp_decompress
r_static
r_struct
id|sk_buff
op_star
id|isdn_ppp_decompress
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|ippp_struct
op_star
id|is
comma
r_struct
id|ippp_struct
op_star
id|master
comma
r_int
op_star
id|proto
)paren
(brace
r_void
op_star
id|stat
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|isdn_ppp_compressor
op_star
id|ipc
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb_out
suffix:semicolon
r_int
id|len
suffix:semicolon
r_struct
id|ippp_struct
op_star
id|ri
suffix:semicolon
r_struct
id|isdn_ppp_resetparams
id|rsparm
suffix:semicolon
r_int
r_char
id|rsdata
(braket
id|IPPP_RESET_MAXDATABYTES
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|master
)paren
(brace
singleline_comment|// per-link decompression 
id|stat
op_assign
id|is-&gt;link_decomp_stat
suffix:semicolon
id|ipc
op_assign
id|is-&gt;link_decompressor
suffix:semicolon
id|ri
op_assign
id|is
suffix:semicolon
)brace
r_else
(brace
id|stat
op_assign
id|master-&gt;decomp_stat
suffix:semicolon
id|ipc
op_assign
id|master-&gt;decompressor
suffix:semicolon
id|ri
op_assign
id|master
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ipc
)paren
(brace
singleline_comment|// no decompressor -&gt; we can&squot;t decompress.
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ippp: no decompressor defined!&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|skb
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|stat
)paren
singleline_comment|// if we have a compressor, stat has been set as well
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|master
op_logical_and
op_star
id|proto
op_eq
id|PPP_COMP
)paren
op_logical_or
(paren
op_logical_neg
id|master
op_logical_and
op_star
id|proto
op_eq
id|PPP_COMPFRAG
)paren
)paren
(brace
singleline_comment|// compressed packets are compressed by their protocol type
singleline_comment|// Set up reset params for the decompressor
id|memset
c_func
(paren
op_amp
id|rsparm
comma
l_int|0
comma
r_sizeof
(paren
id|rsparm
)paren
)paren
suffix:semicolon
id|rsparm.data
op_assign
id|rsdata
suffix:semicolon
id|rsparm.maxdlen
op_assign
id|IPPP_RESET_MAXDATABYTES
suffix:semicolon
multiline_comment|/* !!!HACK,HACK,HACK!!! 2048 is only assumed */
id|skb_out
op_assign
id|dev_alloc_skb
c_func
(paren
l_int|2048
)paren
suffix:semicolon
id|len
op_assign
id|ipc
op_member_access_from_pointer
id|decompress
c_func
(paren
id|stat
comma
id|skb
comma
id|skb_out
comma
op_amp
id|rsparm
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
l_int|0
)paren
(brace
r_switch
c_cond
(paren
id|len
)paren
(brace
r_case
id|DECOMP_ERROR
suffix:colon
id|ri-&gt;pppcfg
op_or_assign
id|SC_DC_ERROR
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ippp: decomp wants reset %s params&bslash;n&quot;
comma
id|rsparm.valid
ques
c_cond
l_string|&quot;with&quot;
suffix:colon
l_string|&quot;without&quot;
)paren
suffix:semicolon
id|isdn_ppp_ccp_reset_trans
c_func
(paren
id|ri
comma
op_amp
id|rsparm
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DECOMP_FATALERROR
suffix:colon
id|ri-&gt;pppcfg
op_or_assign
id|SC_DC_FERROR
suffix:semicolon
multiline_comment|/* Kick ipppd to recognize the error */
id|isdn_ppp_ccp_kickup
c_func
(paren
id|ri
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|kfree_skb
c_func
(paren
id|skb_out
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|isdn_ppp_skip_ac
c_func
(paren
id|ri
comma
id|skb
)paren
OL
l_int|0
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
op_star
id|proto
op_assign
id|isdn_ppp_strip_proto
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|proto
OL
l_int|0
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
id|skb_out
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// uncompressed packets are fed through the decompressor to
singleline_comment|// update the decompressor state
id|ipc
op_member_access_from_pointer
id|incomp
c_func
(paren
id|stat
comma
id|skb
comma
op_star
id|proto
)paren
suffix:semicolon
r_return
id|skb
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * compress a frame &n; *   type=0: normal/bundle compression&n; *       =1: link compression&n; * returns original skb if we haven&squot;t compressed the frame&n; * and a new skb pointer if we&squot;ve done it&n; */
DECL|function|isdn_ppp_compress
r_static
r_struct
id|sk_buff
op_star
id|isdn_ppp_compress
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb_in
comma
r_int
op_star
id|proto
comma
r_struct
id|ippp_struct
op_star
id|is
comma
r_struct
id|ippp_struct
op_star
id|master
comma
r_int
id|type
)paren
(brace
r_int
id|ret
suffix:semicolon
r_int
id|new_proto
suffix:semicolon
r_struct
id|isdn_ppp_compressor
op_star
id|compressor
suffix:semicolon
r_void
op_star
id|stat
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb_out
suffix:semicolon
multiline_comment|/* we do not compress control protocols */
r_if
c_cond
(paren
op_star
id|proto
template_param
l_int|0x3fff
)paren
(brace
r_return
id|skb_in
suffix:semicolon
)brace
r_if
c_cond
(paren
id|type
)paren
(brace
multiline_comment|/* type=1 =&gt; Link compression */
r_return
id|skb_in
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|master
)paren
(brace
id|compressor
op_assign
id|is-&gt;compressor
suffix:semicolon
id|stat
op_assign
id|is-&gt;comp_stat
suffix:semicolon
)brace
r_else
(brace
id|compressor
op_assign
id|master-&gt;compressor
suffix:semicolon
id|stat
op_assign
id|master-&gt;comp_stat
suffix:semicolon
)brace
id|new_proto
op_assign
id|PPP_COMP
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|compressor
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;isdn_ppp: No compressor set!&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|skb_in
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|stat
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;isdn_ppp: Compressor not initialized?&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|skb_in
suffix:semicolon
)brace
multiline_comment|/* Allow for at least 150 % expansion (for now) */
id|skb_out
op_assign
id|alloc_skb
c_func
(paren
id|skb_in-&gt;len
op_plus
id|skb_in-&gt;len
op_div
l_int|2
op_plus
l_int|32
op_plus
id|skb_headroom
c_func
(paren
id|skb_in
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb_out
)paren
(brace
r_return
id|skb_in
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb_out
comma
id|skb_headroom
c_func
(paren
id|skb_in
)paren
)paren
suffix:semicolon
id|ret
op_assign
(paren
id|compressor-&gt;compress
)paren
(paren
id|stat
comma
id|skb_in
comma
id|skb_out
comma
op_star
id|proto
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb_out
)paren
suffix:semicolon
r_return
id|skb_in
suffix:semicolon
)brace
id|dev_kfree_skb
c_func
(paren
id|skb_in
)paren
suffix:semicolon
op_star
id|proto
op_assign
id|new_proto
suffix:semicolon
r_return
id|skb_out
suffix:semicolon
)brace
multiline_comment|/*&n; * we received a CCP frame .. &n; * not a clean solution, but we MUST handle a few cases in the kernel&n; */
DECL|function|isdn_ppp_receive_ccp
r_static
r_void
id|isdn_ppp_receive_ccp
c_func
(paren
id|isdn_net_dev
op_star
id|net_dev
comma
id|isdn_net_local
op_star
id|lp
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|proto
)paren
(brace
r_struct
id|ippp_struct
op_star
id|is
op_assign
id|ippp_table
(braket
id|lp-&gt;ppp_slot
)braket
suffix:semicolon
r_struct
id|ippp_struct
op_star
id|mis
suffix:semicolon
r_int
id|len
suffix:semicolon
r_struct
id|isdn_ppp_resetparams
id|rsparm
suffix:semicolon
r_int
r_char
id|rsdata
(braket
id|IPPP_RESET_MAXDATABYTES
)braket
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Received CCP frame from peer&bslash;n&quot;
)paren
suffix:semicolon
id|isdn_ppp_frame_log
c_func
(paren
l_string|&quot;ccp-rcv&quot;
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
l_int|32
comma
id|is-&gt;unit
comma
id|lp-&gt;ppp_slot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;master
)paren
(brace
id|mis
op_assign
id|ippp_table
(braket
(paren
(paren
id|isdn_net_local
op_star
)paren
(paren
id|lp-&gt;master-&gt;priv
)paren
)paren
op_member_access_from_pointer
id|ppp_slot
)braket
suffix:semicolon
)brace
r_else
id|mis
op_assign
id|is
suffix:semicolon
r_switch
c_cond
(paren
id|skb-&gt;data
(braket
l_int|0
)braket
)paren
(brace
r_case
id|CCP_CONFREQ
suffix:colon
r_case
id|CCP_TERMREQ
suffix:colon
r_case
id|CCP_TERMACK
suffix:colon
r_if
c_cond
(paren
id|is-&gt;debug
op_amp
l_int|0x10
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Disable (de)compression here!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|proto
op_eq
id|PPP_CCP
)paren
(brace
id|mis-&gt;compflags
op_and_assign
op_complement
(paren
id|SC_DECOMP_ON
op_or
id|SC_COMP_ON
)paren
suffix:semicolon
)brace
r_else
id|is-&gt;compflags
op_and_assign
op_complement
(paren
id|SC_LINK_DECOMP_ON
op_or
id|SC_LINK_COMP_ON
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CCP_CONFACK
suffix:colon
multiline_comment|/* if we RECEIVE an ackowledge we enable the decompressor */
r_if
c_cond
(paren
id|is-&gt;debug
op_amp
l_int|0x10
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Enable decompression here!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|proto
op_eq
id|PPP_CCP
)paren
(brace
id|mis-&gt;compflags
op_or_assign
id|SC_DECOMP_ON
suffix:semicolon
)brace
r_else
id|is-&gt;compflags
op_or_assign
id|SC_LINK_DECOMP_ON
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CCP_RESETACK
suffix:colon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Received ResetAck from peer&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_assign
(paren
id|skb-&gt;data
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
id|skb-&gt;data
(braket
l_int|3
)braket
suffix:semicolon
id|len
op_sub_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|proto
op_eq
id|PPP_CCP
)paren
(brace
multiline_comment|/* If a reset Ack was outstanding for this id, then&n;&t;&t;&t;   clean up the state engine */
id|isdn_ppp_ccp_reset_ack_rcvd
c_func
(paren
id|mis
comma
id|skb-&gt;data
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mis-&gt;decompressor
op_logical_and
id|mis-&gt;decomp_stat
)paren
(brace
id|mis-&gt;decompressor
op_member_access_from_pointer
id|reset
c_func
(paren
id|mis-&gt;decomp_stat
comma
id|skb-&gt;data
(braket
l_int|0
)braket
comma
id|skb-&gt;data
(braket
l_int|1
)braket
comma
id|len
ques
c_cond
op_amp
id|skb-&gt;data
(braket
l_int|4
)braket
suffix:colon
l_int|NULL
comma
id|len
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/* TODO: This is not easy to decide here */
id|mis-&gt;compflags
op_and_assign
op_complement
id|SC_DECOMP_DISCARD
suffix:semicolon
id|mis-&gt;pppcfg
op_and_assign
op_complement
id|SC_DC_ERROR
suffix:semicolon
)brace
r_else
(brace
id|isdn_ppp_ccp_reset_ack_rcvd
c_func
(paren
id|is
comma
id|skb-&gt;data
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is-&gt;link_decompressor
op_logical_and
id|is-&gt;link_decomp_stat
)paren
(brace
id|is-&gt;link_decompressor
op_member_access_from_pointer
id|reset
c_func
(paren
id|is-&gt;link_decomp_stat
comma
id|skb-&gt;data
(braket
l_int|0
)braket
comma
id|skb-&gt;data
(braket
l_int|1
)braket
comma
id|len
ques
c_cond
op_amp
id|skb-&gt;data
(braket
l_int|4
)braket
suffix:colon
l_int|NULL
comma
id|len
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/* TODO: neither here */
id|is-&gt;compflags
op_and_assign
op_complement
id|SC_LINK_DECOMP_DISCARD
suffix:semicolon
id|is-&gt;pppcfg
op_and_assign
op_complement
id|SC_DC_ERROR
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CCP_RESETREQ
suffix:colon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Received ResetReq from peer&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Receiving a ResetReq means we must reset our compressor */
multiline_comment|/* Set up reset params for the reset entry */
id|memset
c_func
(paren
op_amp
id|rsparm
comma
l_int|0
comma
r_sizeof
(paren
id|rsparm
)paren
)paren
suffix:semicolon
id|rsparm.data
op_assign
id|rsdata
suffix:semicolon
id|rsparm.maxdlen
op_assign
id|IPPP_RESET_MAXDATABYTES
suffix:semicolon
multiline_comment|/* Isolate data length */
id|len
op_assign
(paren
id|skb-&gt;data
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
id|skb-&gt;data
(braket
l_int|3
)braket
suffix:semicolon
id|len
op_sub_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|proto
op_eq
id|PPP_CCP
)paren
(brace
r_if
c_cond
(paren
id|mis-&gt;compressor
op_logical_and
id|mis-&gt;comp_stat
)paren
(brace
id|mis-&gt;compressor
op_member_access_from_pointer
id|reset
c_func
(paren
id|mis-&gt;comp_stat
comma
id|skb-&gt;data
(braket
l_int|0
)braket
comma
id|skb-&gt;data
(braket
l_int|1
)braket
comma
id|len
ques
c_cond
op_amp
id|skb-&gt;data
(braket
l_int|4
)braket
suffix:colon
l_int|NULL
comma
id|len
comma
op_amp
id|rsparm
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|is-&gt;link_compressor
op_logical_and
id|is-&gt;link_comp_stat
)paren
(brace
id|is-&gt;link_compressor
op_member_access_from_pointer
id|reset
c_func
(paren
id|is-&gt;link_comp_stat
comma
id|skb-&gt;data
(braket
l_int|0
)braket
comma
id|skb-&gt;data
(braket
l_int|1
)braket
comma
id|len
ques
c_cond
op_amp
id|skb-&gt;data
(braket
l_int|4
)braket
suffix:colon
l_int|NULL
comma
id|len
comma
op_amp
id|rsparm
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Ack the Req as specified by rsparm */
r_if
c_cond
(paren
id|rsparm.valid
)paren
(brace
multiline_comment|/* Compressor reset handler decided how to answer */
r_if
c_cond
(paren
id|rsparm.rsend
)paren
(brace
multiline_comment|/* We should send a Frame */
id|isdn_ppp_ccp_xmit_reset
c_func
(paren
id|is
comma
id|proto
comma
id|CCP_RESETACK
comma
id|rsparm.idval
ques
c_cond
id|rsparm.id
suffix:colon
id|skb-&gt;data
(braket
l_int|1
)braket
comma
id|rsparm.dtval
ques
c_cond
id|rsparm.data
suffix:colon
l_int|NULL
comma
id|rsparm.dtval
ques
c_cond
id|rsparm.dlen
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ResetAck suppressed&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* We answer with a straight reflected Ack */
id|isdn_ppp_ccp_xmit_reset
c_func
(paren
id|is
comma
id|proto
comma
id|CCP_RESETACK
comma
id|skb-&gt;data
(braket
l_int|1
)braket
comma
id|len
ques
c_cond
op_amp
id|skb-&gt;data
(braket
l_int|4
)braket
suffix:colon
l_int|NULL
comma
id|len
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Daemon sends a CCP frame ...&n; */
multiline_comment|/* TODO: Clean this up with new Reset semantics */
DECL|function|isdn_ppp_send_ccp
r_static
r_void
id|isdn_ppp_send_ccp
c_func
(paren
id|isdn_net_dev
op_star
id|net_dev
comma
id|isdn_net_local
op_star
id|lp
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|ippp_struct
op_star
id|mis
comma
op_star
id|is
op_assign
id|ippp_table
(braket
id|lp-&gt;ppp_slot
)braket
suffix:semicolon
r_int
id|proto
suffix:semicolon
r_int
r_char
op_star
id|data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
op_logical_or
id|skb-&gt;len
OL
l_int|3
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/* Daemon may send with or without address and control field comp */
id|data
op_assign
id|skb-&gt;data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|is-&gt;pppcfg
op_amp
id|SC_COMP_AC
)paren
op_logical_and
id|data
(braket
l_int|0
)braket
op_eq
l_int|0xff
op_logical_and
id|data
(braket
l_int|1
)braket
op_eq
l_int|0x03
)paren
(brace
id|data
op_add_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
OL
l_int|5
)paren
(brace
r_return
suffix:semicolon
)brace
)brace
id|proto
op_assign
(paren
(paren
r_int
)paren
id|data
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_plus
id|data
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|proto
op_ne
id|PPP_CCP
op_logical_and
id|proto
op_ne
id|PPP_CCPFRAG
)paren
(brace
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Received CCP frame from daemon:&bslash;n&quot;
)paren
suffix:semicolon
id|isdn_ppp_frame_log
c_func
(paren
l_string|&quot;ccp-xmit&quot;
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
l_int|32
comma
id|is-&gt;unit
comma
id|lp-&gt;ppp_slot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;master
)paren
(brace
id|mis
op_assign
id|ippp_table
(braket
(paren
(paren
id|isdn_net_local
op_star
)paren
(paren
id|lp-&gt;master-&gt;priv
)paren
)paren
op_member_access_from_pointer
id|ppp_slot
)braket
suffix:semicolon
)brace
r_else
id|mis
op_assign
id|is
suffix:semicolon
r_if
c_cond
(paren
id|mis
op_ne
id|is
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_ppp: Ouch! Master CCP sends on slave slot!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|data
(braket
l_int|2
)braket
)paren
(brace
r_case
id|CCP_CONFREQ
suffix:colon
r_case
id|CCP_TERMREQ
suffix:colon
r_case
id|CCP_TERMACK
suffix:colon
r_if
c_cond
(paren
id|is-&gt;debug
op_amp
l_int|0x10
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Disable (de)compression here!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|proto
op_eq
id|PPP_CCP
)paren
(brace
id|is-&gt;compflags
op_and_assign
op_complement
(paren
id|SC_DECOMP_ON
op_or
id|SC_COMP_ON
)paren
suffix:semicolon
)brace
r_else
id|is-&gt;compflags
op_and_assign
op_complement
(paren
id|SC_LINK_DECOMP_ON
op_or
id|SC_LINK_COMP_ON
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CCP_CONFACK
suffix:colon
multiline_comment|/* if we SEND an ackowledge we can/must enable the compressor */
r_if
c_cond
(paren
id|is-&gt;debug
op_amp
l_int|0x10
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Enable compression here!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|proto
op_eq
id|PPP_CCP
)paren
(brace
id|is-&gt;compflags
op_or_assign
id|SC_COMP_ON
suffix:semicolon
)brace
r_else
id|is-&gt;compflags
op_or_assign
id|SC_LINK_COMP_ON
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CCP_RESETACK
suffix:colon
multiline_comment|/* If we send a ACK we should reset our compressor */
r_if
c_cond
(paren
id|is-&gt;debug
op_amp
l_int|0x10
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Reset decompression state here!&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ResetAck from daemon passed by&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|proto
op_eq
id|PPP_CCP
)paren
(brace
multiline_comment|/* link to master? */
r_if
c_cond
(paren
id|is-&gt;compressor
op_logical_and
id|is-&gt;comp_stat
)paren
(brace
id|is-&gt;compressor
op_member_access_from_pointer
id|reset
c_func
(paren
id|is-&gt;comp_stat
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
)brace
id|is-&gt;compflags
op_and_assign
op_complement
id|SC_COMP_DISCARD
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|is-&gt;link_compressor
op_logical_and
id|is-&gt;link_comp_stat
)paren
(brace
id|is-&gt;link_compressor
op_member_access_from_pointer
id|reset
c_func
(paren
id|is-&gt;link_comp_stat
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
)brace
id|is-&gt;compflags
op_and_assign
op_complement
id|SC_LINK_COMP_DISCARD
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CCP_RESETREQ
suffix:colon
multiline_comment|/* Just let it pass by */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ResetReq from daemon passed by&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|isdn_ppp_register_compressor
r_int
id|isdn_ppp_register_compressor
c_func
(paren
r_struct
id|isdn_ppp_compressor
op_star
id|ipc
)paren
(brace
id|ipc-&gt;next
op_assign
id|ipc_head
suffix:semicolon
id|ipc-&gt;prev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|ipc_head
)paren
(brace
id|ipc_head-&gt;prev
op_assign
id|ipc
suffix:semicolon
)brace
id|ipc_head
op_assign
id|ipc
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|isdn_ppp_unregister_compressor
r_int
id|isdn_ppp_unregister_compressor
c_func
(paren
r_struct
id|isdn_ppp_compressor
op_star
id|ipc
)paren
(brace
r_if
c_cond
(paren
id|ipc-&gt;prev
)paren
(brace
id|ipc-&gt;prev-&gt;next
op_assign
id|ipc-&gt;next
suffix:semicolon
)brace
r_else
id|ipc_head
op_assign
id|ipc-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|ipc-&gt;next
)paren
(brace
id|ipc-&gt;next-&gt;prev
op_assign
id|ipc-&gt;prev
suffix:semicolon
)brace
id|ipc-&gt;prev
op_assign
id|ipc-&gt;next
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|isdn_ppp_set_compressor
r_static
r_int
id|isdn_ppp_set_compressor
c_func
(paren
r_struct
id|ippp_struct
op_star
id|is
comma
r_struct
id|isdn_ppp_comp_data
op_star
id|data
)paren
(brace
r_struct
id|isdn_ppp_compressor
op_star
id|ipc
op_assign
id|ipc_head
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_void
op_star
id|stat
suffix:semicolon
r_int
id|num
op_assign
id|data-&gt;num
suffix:semicolon
r_if
c_cond
(paren
id|is-&gt;debug
op_amp
l_int|0x10
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;[%d] Set %s type %d&bslash;n&quot;
comma
id|is-&gt;unit
comma
(paren
id|data-&gt;flags
op_amp
id|IPPP_COMP_FLAG_XMIT
)paren
ques
c_cond
l_string|&quot;compressor&quot;
suffix:colon
l_string|&quot;decompressor&quot;
comma
id|num
)paren
suffix:semicolon
)brace
multiline_comment|/* If is has no valid reset state vector, we cannot allocate a&n;&t;   decompressor. The decompressor would cause reset transactions&n;&t;   sooner or later, and they need that vector. */
r_if
c_cond
(paren
op_logical_neg
(paren
id|data-&gt;flags
op_amp
id|IPPP_COMP_FLAG_XMIT
)paren
op_logical_and
op_logical_neg
id|is-&gt;reset
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ippp_ccp: no reset data structure - can&squot;t&quot;
l_string|&quot; allow decompression.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_while
c_loop
(paren
id|ipc
)paren
(brace
r_if
c_cond
(paren
id|ipc-&gt;num
op_eq
id|num
)paren
(brace
id|stat
op_assign
id|ipc
op_member_access_from_pointer
id|alloc
c_func
(paren
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat
)paren
(brace
id|ret
op_assign
id|ipc
op_member_access_from_pointer
id|init
c_func
(paren
id|stat
comma
id|data
comma
id|is-&gt;unit
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Can&squot;t init (de)compression!&bslash;n&quot;
)paren
suffix:semicolon
id|ipc
op_member_access_from_pointer
id|free
c_func
(paren
id|stat
)paren
suffix:semicolon
id|stat
op_assign
l_int|NULL
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Can&squot;t alloc (de)compression!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data-&gt;flags
op_amp
id|IPPP_COMP_FLAG_XMIT
)paren
(brace
r_if
c_cond
(paren
id|data-&gt;flags
op_amp
id|IPPP_COMP_FLAG_LINK
)paren
(brace
r_if
c_cond
(paren
id|is-&gt;link_comp_stat
)paren
(brace
id|is-&gt;link_compressor
op_member_access_from_pointer
id|free
c_func
(paren
id|is-&gt;link_comp_stat
)paren
suffix:semicolon
)brace
id|is-&gt;link_comp_stat
op_assign
id|stat
suffix:semicolon
id|is-&gt;link_compressor
op_assign
id|ipc
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|is-&gt;comp_stat
)paren
(brace
id|is-&gt;compressor
op_member_access_from_pointer
id|free
c_func
(paren
id|is-&gt;comp_stat
)paren
suffix:semicolon
)brace
id|is-&gt;comp_stat
op_assign
id|stat
suffix:semicolon
id|is-&gt;compressor
op_assign
id|ipc
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|data-&gt;flags
op_amp
id|IPPP_COMP_FLAG_LINK
)paren
(brace
r_if
c_cond
(paren
id|is-&gt;link_decomp_stat
)paren
(brace
id|is-&gt;link_decompressor
op_member_access_from_pointer
id|free
c_func
(paren
id|is-&gt;link_decomp_stat
)paren
suffix:semicolon
)brace
id|is-&gt;link_decomp_stat
op_assign
id|stat
suffix:semicolon
id|is-&gt;link_decompressor
op_assign
id|ipc
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|is-&gt;decomp_stat
)paren
(brace
id|is-&gt;decompressor
op_member_access_from_pointer
id|free
c_func
(paren
id|is-&gt;decomp_stat
)paren
suffix:semicolon
)brace
id|is-&gt;decomp_stat
op_assign
id|stat
suffix:semicolon
id|is-&gt;decompressor
op_assign
id|ipc
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
id|ipc
op_assign
id|ipc-&gt;next
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
eof
