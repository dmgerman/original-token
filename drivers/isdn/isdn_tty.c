multiline_comment|/* $Id: isdn_tty.c,v 1.94 2000/11/25 17:00:59 kai Exp $&n;&n; * Linux ISDN subsystem, tty functions and AT-command emulator (linklevel).&n; *&n; * Copyright 1994-1999  by Fritz Elfert (fritz@isdn4linux.de)&n; * Copyright 1995,96    by Thinking Objects Software GmbH Wuerzburg&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; */
DECL|macro|ISDN_TTY_STAT_DEBUG
macro_line|#undef ISDN_TTY_STAT_DEBUG
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/isdn.h&gt;
macro_line|#include &quot;isdn_common.h&quot;
macro_line|#include &quot;isdn_tty.h&quot;
macro_line|#ifdef CONFIG_ISDN_AUDIO
macro_line|#include &quot;isdn_audio.h&quot;
DECL|macro|VBUF
mdefine_line|#define VBUF 0x3e0
DECL|macro|VBUFX
mdefine_line|#define VBUFX (VBUF/16)
macro_line|#endif
DECL|macro|FIX_FILE_TRANSFER
mdefine_line|#define FIX_FILE_TRANSFER
DECL|macro|DUMMY_HAYES_AT
mdefine_line|#define&t;DUMMY_HAYES_AT
multiline_comment|/* Prototypes */
r_static
r_int
id|isdn_tty_edit_at
c_func
(paren
r_const
r_char
op_star
comma
r_int
comma
id|modem_info
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|isdn_tty_check_esc
c_func
(paren
r_const
id|u_char
op_star
comma
id|u_char
comma
r_int
comma
r_int
op_star
comma
r_int
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|isdn_tty_modem_reset_regs
c_func
(paren
id|modem_info
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|isdn_tty_cmd_ATA
c_func
(paren
id|modem_info
op_star
)paren
suffix:semicolon
r_static
r_void
id|isdn_tty_flush_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
)paren
suffix:semicolon
r_static
r_void
id|isdn_tty_modem_result
c_func
(paren
r_int
comma
id|modem_info
op_star
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_AUDIO
r_static
r_int
id|isdn_tty_countDLE
c_func
(paren
r_int
r_char
op_star
comma
r_int
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Leave this unchanged unless you know what you do! */
DECL|macro|MODEM_PARANOIA_CHECK
mdefine_line|#define MODEM_PARANOIA_CHECK
DECL|macro|MODEM_DO_RESTART
mdefine_line|#define MODEM_DO_RESTART
macro_line|#ifdef CONFIG_DEVFS_FS
DECL|variable|isdn_ttyname_ttyI
r_static
r_char
op_star
id|isdn_ttyname_ttyI
op_assign
l_string|&quot;isdn/ttyI%d&quot;
suffix:semicolon
DECL|variable|isdn_ttyname_cui
r_static
r_char
op_star
id|isdn_ttyname_cui
op_assign
l_string|&quot;isdn/cui%d&quot;
suffix:semicolon
macro_line|#else
DECL|variable|isdn_ttyname_ttyI
r_static
r_char
op_star
id|isdn_ttyname_ttyI
op_assign
l_string|&quot;ttyI&quot;
suffix:semicolon
DECL|variable|isdn_ttyname_cui
r_static
r_char
op_star
id|isdn_ttyname_cui
op_assign
l_string|&quot;cui&quot;
suffix:semicolon
macro_line|#endif
DECL|variable|bit2si
r_static
r_int
id|bit2si
(braket
l_int|8
)braket
op_assign
(brace
l_int|1
comma
l_int|5
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
)brace
suffix:semicolon
DECL|variable|si2bit
r_static
r_int
id|si2bit
(braket
l_int|8
)braket
op_assign
(brace
l_int|4
comma
l_int|1
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
)brace
suffix:semicolon
DECL|variable|isdn_tty_revision
r_char
op_star
id|isdn_tty_revision
op_assign
l_string|&quot;$Revision: 1.94 $&quot;
suffix:semicolon
multiline_comment|/* isdn_tty_try_read() is called from within isdn_tty_rcv_skb()&n; * to stuff incoming data directly into a tty&squot;s flip-buffer. This&n; * is done to speed up tty-receiving if the receive-queue is empty.&n; * This routine MUST be called with interrupts off.&n; * Return:&n; *  1 = Success&n; *  0 = Failure, data has to be buffered and later processed by&n; *      isdn_tty_readmodem().&n; */
r_static
r_int
DECL|function|isdn_tty_try_read
id|isdn_tty_try_read
c_func
(paren
id|modem_info
op_star
id|info
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|c
suffix:semicolon
r_int
id|len
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;online
)paren
(brace
r_if
c_cond
(paren
(paren
id|tty
op_assign
id|info-&gt;tty
)paren
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;mcr
op_amp
id|UART_MCR_RTS
)paren
(brace
id|c
op_assign
id|TTY_FLIPBUF_SIZE
op_minus
id|tty-&gt;flip.count
suffix:semicolon
id|len
op_assign
id|skb-&gt;len
macro_line|#ifdef CONFIG_ISDN_AUDIO
op_plus
id|ISDN_AUDIO_SKB_DLECOUNT
c_func
(paren
id|skb
)paren
macro_line|#endif
suffix:semicolon
r_if
c_cond
(paren
id|c
op_ge
id|len
)paren
(brace
macro_line|#ifdef CONFIG_ISDN_AUDIO
r_if
c_cond
(paren
id|ISDN_AUDIO_SKB_DLECOUNT
c_func
(paren
id|skb
)paren
)paren
r_while
c_loop
(paren
id|skb-&gt;len
op_decrement
)paren
(brace
r_if
c_cond
(paren
op_star
id|skb-&gt;data
op_eq
id|DLE
)paren
id|tty_insert_flip_char
c_func
(paren
id|tty
comma
id|DLE
comma
l_int|0
)paren
suffix:semicolon
id|tty_insert_flip_char
c_func
(paren
id|tty
comma
op_star
id|skb-&gt;data
op_increment
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
macro_line|#endif
id|memcpy
c_func
(paren
id|tty-&gt;flip.char_buf_ptr
comma
id|skb-&gt;data
comma
id|len
)paren
suffix:semicolon
id|tty-&gt;flip.count
op_add_assign
id|len
suffix:semicolon
id|tty-&gt;flip.char_buf_ptr
op_add_assign
id|len
suffix:semicolon
id|memset
c_func
(paren
id|tty-&gt;flip.flag_buf_ptr
comma
l_int|0
comma
id|len
)paren
suffix:semicolon
id|tty-&gt;flip.flag_buf_ptr
op_add_assign
id|len
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_AUDIO
)brace
macro_line|#endif
r_if
c_cond
(paren
id|info-&gt;emu.mdmreg
(braket
id|REG_CPPP
)braket
op_amp
id|BIT_CPPP
)paren
id|tty-&gt;flip.flag_buf_ptr
(braket
id|len
op_minus
l_int|1
)braket
op_assign
l_int|0xff
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|tty-&gt;flip.tqueue
comma
op_amp
id|tq_timer
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* isdn_tty_readmodem() is called periodically from within timer-interrupt.&n; * It tries getting received data from the receive queue an stuff it into&n; * the tty&squot;s flip-buffer.&n; */
r_void
DECL|function|isdn_tty_readmodem
id|isdn_tty_readmodem
c_func
(paren
r_void
)paren
(brace
r_int
id|resched
op_assign
l_int|0
suffix:semicolon
r_int
id|midx
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|c
suffix:semicolon
r_int
id|r
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
id|modem_info
op_star
id|info
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_MAX_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|midx
op_assign
id|dev-&gt;m_idx
(braket
id|i
)braket
)paren
op_ge
l_int|0
)paren
(brace
id|info
op_assign
op_amp
id|dev-&gt;mdm.info
(braket
id|midx
)braket
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;online
)paren
(brace
id|r
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_AUDIO
id|isdn_audio_eval_dtmf
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;vonline
op_amp
l_int|1
)paren
op_logical_and
(paren
id|info-&gt;emu.vpar
(braket
l_int|1
)braket
)paren
)paren
id|isdn_audio_eval_silence
c_func
(paren
id|info
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|tty
op_assign
id|info-&gt;tty
)paren
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;mcr
op_amp
id|UART_MCR_RTS
)paren
(brace
id|c
op_assign
id|TTY_FLIPBUF_SIZE
op_minus
id|tty-&gt;flip.count
suffix:semicolon
r_if
c_cond
(paren
id|c
OG
l_int|0
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|r
op_assign
id|isdn_readbchan
c_func
(paren
id|info-&gt;isdn_driver
comma
id|info-&gt;isdn_channel
comma
id|tty-&gt;flip.char_buf_ptr
comma
id|tty-&gt;flip.flag_buf_ptr
comma
id|c
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* CISCO AsyncPPP Hack */
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;emu.mdmreg
(braket
id|REG_CPPP
)braket
op_amp
id|BIT_CPPP
)paren
)paren
id|memset
c_func
(paren
id|tty-&gt;flip.flag_buf_ptr
comma
l_int|0
comma
id|r
)paren
suffix:semicolon
id|tty-&gt;flip.count
op_add_assign
id|r
suffix:semicolon
id|tty-&gt;flip.flag_buf_ptr
op_add_assign
id|r
suffix:semicolon
id|tty-&gt;flip.char_buf_ptr
op_add_assign
id|r
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
id|queue_task
c_func
(paren
op_amp
id|tty-&gt;flip.tqueue
comma
op_amp
id|tq_timer
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
r_else
id|r
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|r
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
(brace
id|info-&gt;rcvsched
op_assign
l_int|0
suffix:semicolon
id|resched
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|info-&gt;rcvsched
op_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|resched
)paren
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_MODEMREAD
comma
l_int|0
)paren
suffix:semicolon
)brace
r_int
DECL|function|isdn_tty_rcv_skb
id|isdn_tty_rcv_skb
c_func
(paren
r_int
id|i
comma
r_int
id|di
comma
r_int
id|channel
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|ulong
id|flags
suffix:semicolon
r_int
id|midx
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_AUDIO
r_int
id|ifmt
suffix:semicolon
macro_line|#endif
id|modem_info
op_star
id|info
suffix:semicolon
r_if
c_cond
(paren
(paren
id|midx
op_assign
id|dev-&gt;m_idx
(braket
id|i
)braket
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* if midx is invalid, packet is not for tty */
r_return
l_int|0
suffix:semicolon
)brace
id|info
op_assign
op_amp
id|dev-&gt;mdm.info
(braket
id|midx
)braket
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_AUDIO
id|ifmt
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;vonline
)paren
op_logical_and
(paren
op_logical_neg
id|info-&gt;emu.vpar
(braket
l_int|4
)braket
)paren
)paren
id|isdn_audio_calc_dtmf
c_func
(paren
id|info
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|ifmt
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;vonline
op_amp
l_int|1
)paren
op_logical_and
(paren
id|info-&gt;emu.vpar
(braket
l_int|1
)braket
)paren
)paren
id|isdn_audio_calc_silence
c_func
(paren
id|info
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|ifmt
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|info-&gt;online
OL
l_int|2
)paren
macro_line|#ifdef CONFIG_ISDN_AUDIO
op_logical_and
(paren
op_logical_neg
(paren
id|info-&gt;vonline
op_amp
l_int|1
)paren
)paren
macro_line|#endif
)paren
(brace
multiline_comment|/* If Modem not listening, drop data */
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;emu.mdmreg
(braket
id|REG_T70
)braket
op_amp
id|BIT_T70
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;emu.mdmreg
(braket
id|REG_T70
)braket
op_amp
id|BIT_T70_EXT
)paren
(brace
multiline_comment|/* T.70 decoding: throw away the T.70 header (2 or 4 bytes)   */
r_if
c_cond
(paren
id|skb-&gt;data
(braket
l_int|0
)braket
op_eq
l_int|3
)paren
multiline_comment|/* pure data packet -&gt; 4 byte headers  */
id|skb_pull
c_func
(paren
id|skb
comma
l_int|4
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|skb-&gt;data
(braket
l_int|0
)braket
op_eq
l_int|1
)paren
multiline_comment|/* keepalive packet -&gt; 2 byte hdr  */
id|skb_pull
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* T.70 decoding: Simply throw away the T.70 header (4 bytes) */
r_if
c_cond
(paren
(paren
id|skb-&gt;data
(braket
l_int|0
)braket
op_eq
l_int|1
)paren
op_logical_and
(paren
(paren
id|skb-&gt;data
(braket
l_int|1
)braket
op_eq
l_int|0
)paren
op_logical_or
(paren
id|skb-&gt;data
(braket
l_int|1
)braket
op_eq
l_int|1
)paren
)paren
)paren
id|skb_pull
c_func
(paren
id|skb
comma
l_int|4
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ISDN_AUDIO
r_if
c_cond
(paren
id|skb_headroom
c_func
(paren
id|skb
)paren
OL
r_sizeof
(paren
id|isdn_audio_skb
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_audio: insufficient skb_headroom, dropping&bslash;n&quot;
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|ISDN_AUDIO_SKB_DLECOUNT
c_func
(paren
id|skb
)paren
op_assign
l_int|0
suffix:semicolon
id|ISDN_AUDIO_SKB_LOCK
c_func
(paren
id|skb
)paren
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;vonline
op_amp
l_int|1
)paren
(brace
multiline_comment|/* voice conversion/compression */
r_switch
c_cond
(paren
id|info-&gt;emu.vpar
(braket
l_int|3
)braket
)paren
(brace
r_case
l_int|2
suffix:colon
r_case
l_int|3
suffix:colon
r_case
l_int|4
suffix:colon
multiline_comment|/* adpcm&n;&t;&t;&t;&t; * Since compressed data takes less&n;&t;&t;&t;&t; * space, we can overwrite the buffer.&n;&t;&t;&t;&t; */
id|skb_trim
c_func
(paren
id|skb
comma
id|isdn_audio_xlaw2adpcm
c_func
(paren
id|info-&gt;adpcmr
comma
id|ifmt
comma
id|skb-&gt;data
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
multiline_comment|/* a-law */
r_if
c_cond
(paren
op_logical_neg
id|ifmt
)paren
id|isdn_audio_ulaw2alaw
c_func
(paren
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
multiline_comment|/* u-law */
r_if
c_cond
(paren
id|ifmt
)paren
id|isdn_audio_alaw2ulaw
c_func
(paren
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ISDN_AUDIO_SKB_DLECOUNT
c_func
(paren
id|skb
)paren
op_assign
id|isdn_tty_countDLE
c_func
(paren
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ISDN_TTY_FAX
r_else
(brace
r_if
c_cond
(paren
id|info-&gt;faxonline
op_amp
l_int|2
)paren
(brace
id|isdn_tty_fax_bitorder
c_func
(paren
id|info
comma
id|skb
)paren
suffix:semicolon
id|ISDN_AUDIO_SKB_DLECOUNT
c_func
(paren
id|skb
)paren
op_assign
id|isdn_tty_countDLE
c_func
(paren
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
macro_line|#endif
multiline_comment|/* Try to deliver directly via tty-flip-buf if queue is empty */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb_queue_empty
c_func
(paren
op_amp
id|dev-&gt;drv
(braket
id|di
)braket
op_member_access_from_pointer
id|rpqueue
(braket
id|channel
)braket
)paren
)paren
r_if
c_cond
(paren
id|isdn_tty_try_read
c_func
(paren
id|info
comma
id|skb
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Direct deliver failed or queue wasn&squot;t empty.&n;&t; * Queue up for later dequeueing via timer-irq.&n;&t; */
id|__skb_queue_tail
c_func
(paren
op_amp
id|dev-&gt;drv
(braket
id|di
)braket
op_member_access_from_pointer
id|rpqueue
(braket
id|channel
)braket
comma
id|skb
)paren
suffix:semicolon
id|dev-&gt;drv
(braket
id|di
)braket
op_member_access_from_pointer
id|rcvcount
(braket
id|channel
)braket
op_add_assign
(paren
id|skb-&gt;len
macro_line|#ifdef CONFIG_ISDN_AUDIO
op_plus
id|ISDN_AUDIO_SKB_DLECOUNT
c_func
(paren
id|skb
)paren
macro_line|#endif
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Schedule dequeuing */
r_if
c_cond
(paren
(paren
id|dev-&gt;modempoll
)paren
op_logical_and
(paren
id|info-&gt;rcvsched
)paren
)paren
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_MODEMREAD
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_void
DECL|function|isdn_tty_cleanup_xmit
id|isdn_tty_cleanup_xmit
c_func
(paren
id|modem_info
op_star
id|info
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb_queue_len
c_func
(paren
op_amp
id|info-&gt;xmit_queue
)paren
)paren
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|info-&gt;xmit_queue
)paren
)paren
)paren
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_AUDIO
r_if
c_cond
(paren
id|skb_queue_len
c_func
(paren
op_amp
id|info-&gt;dtmf_queue
)paren
)paren
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|info-&gt;dtmf_queue
)paren
)paren
)paren
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
macro_line|#endif
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|isdn_tty_tint
id|isdn_tty_tint
c_func
(paren
id|modem_info
op_star
id|info
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|info-&gt;xmit_queue
)paren
suffix:semicolon
r_int
id|len
comma
id|slen
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_return
suffix:semicolon
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
(paren
id|slen
op_assign
id|isdn_writebuf_skb_stub
c_func
(paren
id|info-&gt;isdn_driver
comma
id|info-&gt;isdn_channel
comma
l_int|1
comma
id|skb
)paren
)paren
op_eq
id|len
)paren
(brace
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|info-&gt;tty
suffix:semicolon
id|info-&gt;send_outstanding
op_increment
suffix:semicolon
id|info-&gt;msr
op_and_assign
op_complement
id|UART_MSR_CTS
suffix:semicolon
id|info-&gt;lsr
op_and_assign
op_complement
id|UART_LSR_TEMT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slen
OL
l_int|0
)paren
(brace
multiline_comment|/* Error: no channel, already shutdown, or wrong parameter */
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb_queue_head
c_func
(paren
op_amp
id|info-&gt;xmit_queue
comma
id|skb
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ISDN_AUDIO
r_static
r_int
DECL|function|isdn_tty_countDLE
id|isdn_tty_countDLE
c_func
(paren
r_int
r_char
op_star
id|buf
comma
r_int
id|len
)paren
(brace
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|len
op_decrement
)paren
r_if
c_cond
(paren
op_star
id|buf
op_increment
op_eq
id|DLE
)paren
id|count
op_increment
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/* This routine is called from within isdn_tty_write() to perform&n; * DLE-decoding when sending audio-data.&n; */
r_static
r_int
DECL|function|isdn_tty_handleDLEdown
id|isdn_tty_handleDLEdown
c_func
(paren
id|modem_info
op_star
id|info
comma
id|atemu
op_star
id|m
comma
r_int
id|len
)paren
(brace
r_int
r_char
op_star
id|p
op_assign
op_amp
id|info-&gt;xmit_buf
(braket
id|info-&gt;xmit_count
)braket
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|len
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|m-&gt;lastDLE
)paren
(brace
id|m-&gt;lastDLE
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|p
)paren
(brace
r_case
id|DLE
suffix:colon
multiline_comment|/* Escape code */
r_if
c_cond
(paren
id|len
OG
l_int|1
)paren
id|memmove
c_func
(paren
id|p
comma
id|p
op_plus
l_int|1
comma
id|len
op_minus
l_int|1
)paren
suffix:semicolon
id|p
op_decrement
suffix:semicolon
id|count
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETX
suffix:colon
multiline_comment|/* End of data */
id|info-&gt;vonline
op_or_assign
l_int|4
suffix:semicolon
r_return
id|count
suffix:semicolon
r_case
id|DC4
suffix:colon
multiline_comment|/* Abort RX */
id|info-&gt;vonline
op_and_assign
op_complement
l_int|1
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_VOICE
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;DLEdown: got DLE-DC4, send DLE-ETX on ttyI%d&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;&bslash;020&bslash;003&quot;
comma
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;vonline
)paren
(brace
macro_line|#ifdef ISDN_DEBUG_MODEM_VOICE
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;DLEdown: send VCON on ttyI%d&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;&bslash;r&bslash;nVCON&bslash;r&bslash;n&quot;
comma
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/* Fall through */
r_case
l_char|&squot;q&squot;
suffix:colon
r_case
l_char|&squot;s&squot;
suffix:colon
multiline_comment|/* Silence */
r_if
c_cond
(paren
id|len
OG
l_int|1
)paren
id|memmove
c_func
(paren
id|p
comma
id|p
op_plus
l_int|1
comma
id|len
op_minus
l_int|1
)paren
suffix:semicolon
id|p
op_decrement
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
op_star
id|p
op_eq
id|DLE
)paren
id|m-&gt;lastDLE
op_assign
l_int|1
suffix:semicolon
r_else
id|count
op_increment
suffix:semicolon
)brace
id|p
op_increment
suffix:semicolon
id|len
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_tty: len&lt;0 in DLEdown&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/* This routine is called from within isdn_tty_write() when receiving&n; * audio-data. It interrupts receiving, if an character other than&n; * ^S or ^Q is sent.&n; */
r_static
r_int
DECL|function|isdn_tty_end_vrx
id|isdn_tty_end_vrx
c_func
(paren
r_const
r_char
op_star
id|buf
comma
r_int
id|c
comma
r_int
id|from_user
)paren
(brace
r_char
id|ch
suffix:semicolon
r_while
c_loop
(paren
id|c
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|from_user
)paren
id|get_user
c_func
(paren
id|ch
comma
id|buf
)paren
suffix:semicolon
r_else
id|ch
op_assign
op_star
id|buf
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ch
op_ne
l_int|0x11
)paren
op_logical_and
(paren
id|ch
op_ne
l_int|0x13
)paren
)paren
r_return
l_int|1
suffix:semicolon
id|buf
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|voice_cf
r_static
r_int
id|voice_cf
(braket
l_int|7
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|4
comma
l_int|3
comma
l_int|2
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
macro_line|#endif                          /* CONFIG_ISDN_AUDIO */
multiline_comment|/* isdn_tty_senddown() is called either directly from within isdn_tty_write()&n; * or via timer-interrupt from within isdn_tty_modem_xmit(). It pulls&n; * outgoing data from the tty&squot;s xmit-buffer, handles voice-decompression or&n; * T.70 if necessary, and finally queues it up for sending via isdn_tty_tint.&n; */
r_static
r_void
DECL|function|isdn_tty_senddown
id|isdn_tty_senddown
c_func
(paren
id|modem_info
op_star
id|info
)paren
(brace
r_int
id|buflen
suffix:semicolon
r_int
id|skb_res
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_AUDIO
r_int
id|audio_len
suffix:semicolon
macro_line|#endif
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_AUDIO
r_if
c_cond
(paren
id|info-&gt;vonline
op_amp
l_int|4
)paren
(brace
id|info-&gt;vonline
op_and_assign
op_complement
l_int|6
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;vonline
)paren
(brace
macro_line|#ifdef ISDN_DEBUG_MODEM_VOICE
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;senddown: send VCON on ttyI%d&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;&bslash;r&bslash;nVCON&bslash;r&bslash;n&quot;
comma
id|info
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
(paren
id|buflen
op_assign
id|info-&gt;xmit_count
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;emu.mdmreg
(braket
id|REG_CTS
)braket
op_amp
id|BIT_CTS
)paren
op_ne
l_int|0
)paren
id|info-&gt;msr
op_and_assign
op_complement
id|UART_MSR_CTS
suffix:semicolon
id|info-&gt;lsr
op_and_assign
op_complement
id|UART_LSR_TEMT
suffix:semicolon
multiline_comment|/* info-&gt;xmit_count is modified here and in isdn_tty_write().&n;&t; * So we return here if isdn_tty_write() is in the&n;&t; * critical section.&n;&t; */
id|atomic_inc
c_func
(paren
op_amp
id|info-&gt;xmit_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|info-&gt;xmit_lock
)paren
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;isdn_driver
OL
l_int|0
)paren
(brace
id|info-&gt;xmit_count
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb_res
op_assign
id|dev-&gt;drv
(braket
id|info-&gt;isdn_driver
)braket
op_member_access_from_pointer
id|interface-&gt;hl_hdrlen
op_plus
l_int|4
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_AUDIO
r_if
c_cond
(paren
id|info-&gt;vonline
op_amp
l_int|2
)paren
id|audio_len
op_assign
id|buflen
op_star
id|voice_cf
(braket
id|info-&gt;emu.vpar
(braket
l_int|3
)braket
)braket
suffix:semicolon
r_else
id|audio_len
op_assign
l_int|0
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|skb_res
op_plus
id|buflen
op_plus
id|audio_len
)paren
suffix:semicolon
macro_line|#else
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|skb_res
op_plus
id|buflen
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_tty: Out of memory in ttyI%d senddown&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb
comma
id|skb_res
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|buflen
)paren
comma
id|info-&gt;xmit_buf
comma
id|buflen
)paren
suffix:semicolon
id|info-&gt;xmit_count
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_AUDIO
r_if
c_cond
(paren
id|info-&gt;vonline
op_amp
l_int|2
)paren
(brace
multiline_comment|/* For now, ifmt is fixed to 1 (alaw), since this&n;&t;&t; * is used with ISDN everywhere in the world, except&n;&t;&t; * US, Canada and Japan.&n;&t;&t; * Later, when US-ISDN protocols are implemented,&n;&t;&t; * this setting will depend on the D-channel protocol.&n;&t;&t; */
r_int
id|ifmt
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* voice conversion/decompression */
r_switch
c_cond
(paren
id|info-&gt;emu.vpar
(braket
l_int|3
)braket
)paren
(brace
r_case
l_int|2
suffix:colon
r_case
l_int|3
suffix:colon
r_case
l_int|4
suffix:colon
multiline_comment|/* adpcm, compatible to ZyXel 1496 modem&n;&t;&t;&t;&t; * with ROM revision 6.01&n;&t;&t;&t;&t; */
id|audio_len
op_assign
id|isdn_audio_adpcm2xlaw
c_func
(paren
id|info-&gt;adpcms
comma
id|ifmt
comma
id|skb-&gt;data
comma
id|skb_put
c_func
(paren
id|skb
comma
id|audio_len
)paren
comma
id|buflen
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
id|buflen
)paren
suffix:semicolon
id|skb_trim
c_func
(paren
id|skb
comma
id|audio_len
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
multiline_comment|/* a-law */
r_if
c_cond
(paren
op_logical_neg
id|ifmt
)paren
id|isdn_audio_alaw2ulaw
c_func
(paren
id|skb-&gt;data
comma
id|buflen
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
multiline_comment|/* u-law */
r_if
c_cond
(paren
id|ifmt
)paren
id|isdn_audio_ulaw2alaw
c_func
(paren
id|skb-&gt;data
comma
id|buflen
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
macro_line|#endif                          /* CONFIG_ISDN_AUDIO */
r_if
c_cond
(paren
id|info-&gt;emu.mdmreg
(braket
id|REG_T70
)braket
op_amp
id|BIT_T70
)paren
(brace
multiline_comment|/* Add T.70 simplified header */
r_if
c_cond
(paren
id|info-&gt;emu.mdmreg
(braket
id|REG_T70
)braket
op_amp
id|BIT_T70_EXT
)paren
id|memcpy
c_func
(paren
id|skb_push
c_func
(paren
id|skb
comma
l_int|2
)paren
comma
l_string|&quot;&bslash;1&bslash;0&quot;
comma
l_int|2
)paren
suffix:semicolon
r_else
id|memcpy
c_func
(paren
id|skb_push
c_func
(paren
id|skb
comma
l_int|4
)paren
comma
l_string|&quot;&bslash;1&bslash;0&bslash;1&bslash;0&quot;
comma
l_int|4
)paren
suffix:semicolon
)brace
id|skb_queue_tail
c_func
(paren
op_amp
id|info-&gt;xmit_queue
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/************************************************************&n; *&n; * Modem-functions&n; *&n; * mostly &quot;stolen&quot; from original Linux-serial.c and friends.&n; *&n; ************************************************************/
multiline_comment|/* The next routine is called once from within timer-interrupt&n; * triggered within isdn_tty_modem_ncarrier(). It calls&n; * isdn_tty_modem_result() to stuff a &quot;NO CARRIER&quot; Message&n; * into the tty&squot;s flip-buffer.&n; */
r_static
r_void
DECL|function|isdn_tty_modem_do_ncarrier
id|isdn_tty_modem_do_ncarrier
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|modem_info
op_star
id|info
op_assign
(paren
id|modem_info
op_star
)paren
id|data
suffix:semicolon
id|isdn_tty_modem_result
c_func
(paren
id|RESULT_NO_CARRIER
comma
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/* Next routine is called, whenever the DTR-signal is raised.&n; * It checks the ncarrier-flag, and triggers the above routine&n; * when necessary. The ncarrier-flag is set, whenever DTR goes&n; * low.&n; */
r_static
r_void
DECL|function|isdn_tty_modem_ncarrier
id|isdn_tty_modem_ncarrier
c_func
(paren
id|modem_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;ncarrier
)paren
(brace
id|info-&gt;nc_timer.expires
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
id|info-&gt;nc_timer.function
op_assign
id|isdn_tty_modem_do_ncarrier
suffix:semicolon
id|info-&gt;nc_timer.data
op_assign
(paren
r_int
r_int
)paren
id|info
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|info-&gt;nc_timer
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * return the usage calculated by si and layer 2 protocol&n; */
r_int
DECL|function|isdn_calc_usage
id|isdn_calc_usage
c_func
(paren
r_int
id|si
comma
r_int
id|l2
)paren
(brace
r_int
id|usg
op_assign
id|ISDN_USAGE_MODEM
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_AUDIO
r_if
c_cond
(paren
id|si
op_eq
l_int|1
)paren
(brace
r_switch
c_cond
(paren
id|l2
)paren
(brace
r_case
id|ISDN_PROTO_L2_MODEM
suffix:colon
id|usg
op_assign
id|ISDN_USAGE_MODEM
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_TTY_FAX
r_case
id|ISDN_PROTO_L2_FAX
suffix:colon
id|usg
op_assign
id|ISDN_USAGE_FAX
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
id|ISDN_PROTO_L2_TRANS
suffix:colon
r_default
suffix:colon
id|usg
op_assign
id|ISDN_USAGE_VOICE
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
macro_line|#endif
r_return
id|usg
suffix:semicolon
)brace
multiline_comment|/* isdn_tty_dial() performs dialing of a tty an the necessary&n; * setup of the lower levels before that.&n; */
r_static
r_void
DECL|function|isdn_tty_dial
id|isdn_tty_dial
c_func
(paren
r_char
op_star
id|n
comma
id|modem_info
op_star
id|info
comma
id|atemu
op_star
id|m
)paren
(brace
r_int
id|usg
op_assign
id|ISDN_USAGE_MODEM
suffix:semicolon
r_int
id|si
op_assign
l_int|7
suffix:semicolon
r_int
id|l2
op_assign
id|m-&gt;mdmreg
(braket
id|REG_L2PROT
)braket
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|j
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|7
suffix:semicolon
id|j
op_ge
l_int|0
suffix:semicolon
id|j
op_decrement
)paren
r_if
c_cond
(paren
id|m-&gt;mdmreg
(braket
id|REG_SI1
)braket
op_amp
(paren
l_int|1
op_lshift
id|j
)paren
)paren
(brace
id|si
op_assign
id|bit2si
(braket
id|j
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
id|usg
op_assign
id|isdn_calc_usage
c_func
(paren
id|si
comma
id|l2
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_AUDIO
r_if
c_cond
(paren
(paren
id|si
op_eq
l_int|1
)paren
op_logical_and
(paren
id|l2
op_ne
id|ISDN_PROTO_L2_MODEM
)paren
macro_line|#ifdef CONFIG_ISDN_TTY_FAX
op_logical_and
(paren
id|l2
op_ne
id|ISDN_PROTO_L2_FAX
)paren
macro_line|#endif
)paren
(brace
id|l2
op_assign
id|ISDN_PROTO_L2_TRANS
suffix:semicolon
id|usg
op_assign
id|ISDN_USAGE_VOICE
suffix:semicolon
)brace
macro_line|#endif
id|m-&gt;mdmreg
(braket
id|REG_SI1I
)braket
op_assign
id|si2bit
(braket
id|si
)braket
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|i
op_assign
id|isdn_get_free_channel
c_func
(paren
id|usg
comma
id|l2
comma
id|m-&gt;mdmreg
(braket
id|REG_L3PROT
)braket
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|m-&gt;msn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|isdn_tty_modem_result
c_func
(paren
id|RESULT_NO_DIALTONE
comma
id|info
)paren
suffix:semicolon
)brace
r_else
(brace
id|info-&gt;isdn_driver
op_assign
id|dev-&gt;drvmap
(braket
id|i
)braket
suffix:semicolon
id|info-&gt;isdn_channel
op_assign
id|dev-&gt;chanmap
(braket
id|i
)braket
suffix:semicolon
id|info-&gt;drv_index
op_assign
id|i
suffix:semicolon
id|dev-&gt;m_idx
(braket
id|i
)braket
op_assign
id|info-&gt;line
suffix:semicolon
id|dev-&gt;usage
(braket
id|i
)braket
op_or_assign
id|ISDN_USAGE_OUTGOING
suffix:semicolon
id|info-&gt;last_dir
op_assign
l_int|1
suffix:semicolon
id|strcpy
c_func
(paren
id|info-&gt;last_num
comma
id|n
)paren
suffix:semicolon
id|isdn_info_update
c_func
(paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|cmd.arg
op_assign
id|info-&gt;isdn_channel
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_CLREAZ
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|cmd.parm.num
comma
id|isdn_map_eaz2msn
c_func
(paren
id|m-&gt;msn
comma
id|info-&gt;isdn_driver
)paren
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_SETEAZ
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_SETL2
suffix:semicolon
id|info-&gt;last_l2
op_assign
id|l2
suffix:semicolon
id|cmd.arg
op_assign
id|info-&gt;isdn_channel
op_plus
(paren
id|l2
op_lshift
l_int|8
)paren
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_SETL3
suffix:semicolon
id|cmd.arg
op_assign
id|info-&gt;isdn_channel
op_plus
(paren
id|m-&gt;mdmreg
(braket
id|REG_L3PROT
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_TTY_FAX
r_if
c_cond
(paren
id|l2
op_eq
id|ISDN_PROTO_L2_FAX
)paren
(brace
id|cmd.parm.fax
op_assign
id|info-&gt;fax
suffix:semicolon
id|info-&gt;fax-&gt;direction
op_assign
id|ISDN_TTY_FAX_CONN_OUT
suffix:semicolon
)brace
macro_line|#endif
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|cmd.arg
op_assign
id|info-&gt;isdn_channel
suffix:semicolon
id|sprintf
c_func
(paren
id|cmd.parm.setup.phone
comma
l_string|&quot;%s&quot;
comma
id|n
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|cmd.parm.setup.eazmsn
comma
l_string|&quot;%s&quot;
comma
id|isdn_map_eaz2msn
c_func
(paren
id|m-&gt;msn
comma
id|info-&gt;isdn_driver
)paren
)paren
suffix:semicolon
id|cmd.parm.setup.si1
op_assign
id|si
suffix:semicolon
id|cmd.parm.setup.si2
op_assign
id|m-&gt;mdmreg
(braket
id|REG_SI2
)braket
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_DIAL
suffix:semicolon
id|info-&gt;dialing
op_assign
l_int|1
suffix:semicolon
id|info-&gt;emu.carrierwait
op_assign
l_int|0
suffix:semicolon
id|strcpy
c_func
(paren
id|dev-&gt;num
(braket
id|i
)braket
comma
id|n
)paren
suffix:semicolon
id|isdn_info_update
c_func
(paren
)paren
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_CARRIER
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* isdn_tty_hangup() disassociates a tty from the real&n; * ISDN-line (hangup). The usage-status is cleared&n; * and some cleanup is done also.&n; */
r_void
DECL|function|isdn_tty_modem_hup
id|isdn_tty_modem_hup
c_func
(paren
id|modem_info
op_star
id|info
comma
r_int
id|local
)paren
(brace
id|isdn_ctrl
id|cmd
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
r_return
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_HUP
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Mhup ttyI%d&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
id|info-&gt;rcvsched
op_assign
l_int|0
suffix:semicolon
id|isdn_tty_flush_buffer
c_func
(paren
id|info-&gt;tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;online
)paren
(brace
id|info-&gt;last_lhup
op_assign
id|local
suffix:semicolon
id|info-&gt;online
op_assign
l_int|0
suffix:semicolon
id|isdn_tty_modem_result
c_func
(paren
id|RESULT_NO_CARRIER
comma
id|info
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ISDN_AUDIO
id|info-&gt;vonline
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_TTY_FAX
id|info-&gt;faxonline
op_assign
l_int|0
suffix:semicolon
id|info-&gt;fax-&gt;phase
op_assign
id|ISDN_FAX_PHASE_IDLE
suffix:semicolon
macro_line|#endif
id|info-&gt;emu.vpar
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|info-&gt;emu.vpar
(braket
l_int|5
)braket
op_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;dtmf_state
)paren
(brace
id|kfree
c_func
(paren
id|info-&gt;dtmf_state
)paren
suffix:semicolon
id|info-&gt;dtmf_state
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;silence_state
)paren
(brace
id|kfree
c_func
(paren
id|info-&gt;silence_state
)paren
suffix:semicolon
id|info-&gt;silence_state
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;adpcms
)paren
(brace
id|kfree
c_func
(paren
id|info-&gt;adpcms
)paren
suffix:semicolon
id|info-&gt;adpcms
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;adpcmr
)paren
(brace
id|kfree
c_func
(paren
id|info-&gt;adpcmr
)paren
suffix:semicolon
id|info-&gt;adpcmr
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
(paren
id|info-&gt;msr
op_amp
id|UART_MSR_RI
)paren
op_logical_and
(paren
id|info-&gt;emu.mdmreg
(braket
id|REG_RUNG
)braket
op_amp
id|BIT_RUNG
)paren
)paren
id|isdn_tty_modem_result
c_func
(paren
id|RESULT_RUNG
comma
id|info
)paren
suffix:semicolon
id|info-&gt;msr
op_and_assign
op_complement
(paren
id|UART_MSR_DCD
op_or
id|UART_MSR_RI
)paren
suffix:semicolon
id|info-&gt;lsr
op_or_assign
id|UART_LSR_TEMT
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;isdn_driver
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|local
)paren
(brace
id|cmd.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_HANGUP
suffix:semicolon
id|cmd.arg
op_assign
id|info-&gt;isdn_channel
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
)brace
id|isdn_all_eaz
c_func
(paren
id|info-&gt;isdn_driver
comma
id|info-&gt;isdn_channel
)paren
suffix:semicolon
id|info-&gt;emu.mdmreg
(braket
id|REG_RINGCNT
)braket
op_assign
l_int|0
suffix:semicolon
id|isdn_free_channel
c_func
(paren
id|info-&gt;isdn_driver
comma
id|info-&gt;isdn_channel
comma
l_int|0
)paren
suffix:semicolon
)brace
id|info-&gt;isdn_driver
op_assign
op_minus
l_int|1
suffix:semicolon
id|info-&gt;isdn_channel
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;drv_index
op_ge
l_int|0
)paren
(brace
id|dev-&gt;m_idx
(braket
id|info-&gt;drv_index
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
id|info-&gt;drv_index
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Begin of a CAPI like interface, currently used only for &n; * supplementary service (CAPI 2.0 part III)&n; */
macro_line|#include &quot;avmb1/capicmd.h&quot;  /* this should be moved in a common place */
r_int
DECL|function|isdn_tty_capi_facility
id|isdn_tty_capi_facility
c_func
(paren
id|capi_msg
op_star
id|cm
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* dummy */
)brace
multiline_comment|/* isdn_tty_suspend() tries to suspend the current tty connection&n; */
r_static
r_void
DECL|function|isdn_tty_suspend
id|isdn_tty_suspend
c_func
(paren
r_char
op_star
id|id
comma
id|modem_info
op_star
id|info
comma
id|atemu
op_star
id|m
)paren
(brace
id|isdn_ctrl
id|cmd
suffix:semicolon
r_int
id|l
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
r_return
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_SERVICES
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Msusp ttyI%d&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
id|l
op_assign
id|strlen
c_func
(paren
id|id
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;isdn_driver
op_ge
l_int|0
)paren
)paren
(brace
id|cmd.parm.cmsg.Length
op_assign
id|l
op_plus
l_int|18
suffix:semicolon
id|cmd.parm.cmsg.Command
op_assign
id|CAPI_FACILITY
suffix:semicolon
id|cmd.parm.cmsg.Subcommand
op_assign
id|CAPI_REQ
suffix:semicolon
id|cmd.parm.cmsg.adr.Controller
op_assign
id|info-&gt;isdn_driver
op_plus
l_int|1
suffix:semicolon
id|cmd.parm.cmsg.para
(braket
l_int|0
)braket
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* 16 bit 0x0003 suplementary service */
id|cmd.parm.cmsg.para
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|cmd.parm.cmsg.para
(braket
l_int|2
)braket
op_assign
id|l
op_plus
l_int|3
suffix:semicolon
id|cmd.parm.cmsg.para
(braket
l_int|3
)braket
op_assign
l_int|4
suffix:semicolon
multiline_comment|/* 16 bit 0x0004 Suspend */
id|cmd.parm.cmsg.para
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|cmd.parm.cmsg.para
(braket
l_int|5
)braket
op_assign
id|l
suffix:semicolon
id|strncpy
c_func
(paren
op_amp
id|cmd.parm.cmsg.para
(braket
l_int|6
)braket
comma
id|id
comma
id|l
)paren
suffix:semicolon
id|cmd.command
op_assign
id|CAPI_PUT_MESSAGE
suffix:semicolon
id|cmd.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|cmd.arg
op_assign
id|info-&gt;isdn_channel
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* isdn_tty_resume() tries to resume a suspended call&n; * setup of the lower levels before that. unfortunatly here is no&n; * checking for compatibility of used protocols implemented by Q931&n; * It does the same things like isdn_tty_dial, the last command&n; * is different, may be we can merge it.&n; */
r_static
r_void
DECL|function|isdn_tty_resume
id|isdn_tty_resume
c_func
(paren
r_char
op_star
id|id
comma
id|modem_info
op_star
id|info
comma
id|atemu
op_star
id|m
)paren
(brace
r_int
id|usg
op_assign
id|ISDN_USAGE_MODEM
suffix:semicolon
r_int
id|si
op_assign
l_int|7
suffix:semicolon
r_int
id|l2
op_assign
id|m-&gt;mdmreg
(braket
id|REG_L2PROT
)braket
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|j
suffix:semicolon
r_int
id|l
suffix:semicolon
id|l
op_assign
id|strlen
c_func
(paren
id|id
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|7
suffix:semicolon
id|j
op_ge
l_int|0
suffix:semicolon
id|j
op_decrement
)paren
r_if
c_cond
(paren
id|m-&gt;mdmreg
(braket
id|REG_SI1
)braket
op_amp
(paren
l_int|1
op_lshift
id|j
)paren
)paren
(brace
id|si
op_assign
id|bit2si
(braket
id|j
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
id|usg
op_assign
id|isdn_calc_usage
c_func
(paren
id|si
comma
id|l2
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_AUDIO
r_if
c_cond
(paren
(paren
id|si
op_eq
l_int|1
)paren
op_logical_and
(paren
id|l2
op_ne
id|ISDN_PROTO_L2_MODEM
)paren
macro_line|#ifdef CONFIG_ISDN_TTY_FAX
op_logical_and
(paren
id|l2
op_ne
id|ISDN_PROTO_L2_FAX
)paren
macro_line|#endif
)paren
(brace
id|l2
op_assign
id|ISDN_PROTO_L2_TRANS
suffix:semicolon
id|usg
op_assign
id|ISDN_USAGE_VOICE
suffix:semicolon
)brace
macro_line|#endif
id|m-&gt;mdmreg
(braket
id|REG_SI1I
)braket
op_assign
id|si2bit
(braket
id|si
)braket
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|i
op_assign
id|isdn_get_free_channel
c_func
(paren
id|usg
comma
id|l2
comma
id|m-&gt;mdmreg
(braket
id|REG_L3PROT
)braket
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|m-&gt;msn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|isdn_tty_modem_result
c_func
(paren
id|RESULT_NO_DIALTONE
comma
id|info
)paren
suffix:semicolon
)brace
r_else
(brace
id|info-&gt;isdn_driver
op_assign
id|dev-&gt;drvmap
(braket
id|i
)braket
suffix:semicolon
id|info-&gt;isdn_channel
op_assign
id|dev-&gt;chanmap
(braket
id|i
)braket
suffix:semicolon
id|info-&gt;drv_index
op_assign
id|i
suffix:semicolon
id|dev-&gt;m_idx
(braket
id|i
)braket
op_assign
id|info-&gt;line
suffix:semicolon
id|dev-&gt;usage
(braket
id|i
)braket
op_or_assign
id|ISDN_USAGE_OUTGOING
suffix:semicolon
id|info-&gt;last_dir
op_assign
l_int|1
suffix:semicolon
singleline_comment|//&t;&t;strcpy(info-&gt;last_num, n);
id|isdn_info_update
c_func
(paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|cmd.arg
op_assign
id|info-&gt;isdn_channel
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_CLREAZ
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|cmd.parm.num
comma
id|isdn_map_eaz2msn
c_func
(paren
id|m-&gt;msn
comma
id|info-&gt;isdn_driver
)paren
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_SETEAZ
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_SETL2
suffix:semicolon
id|info-&gt;last_l2
op_assign
id|l2
suffix:semicolon
id|cmd.arg
op_assign
id|info-&gt;isdn_channel
op_plus
(paren
id|l2
op_lshift
l_int|8
)paren
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_SETL3
suffix:semicolon
id|cmd.arg
op_assign
id|info-&gt;isdn_channel
op_plus
(paren
id|m-&gt;mdmreg
(braket
id|REG_L3PROT
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|cmd.arg
op_assign
id|info-&gt;isdn_channel
suffix:semicolon
id|cmd.parm.cmsg.Length
op_assign
id|l
op_plus
l_int|18
suffix:semicolon
id|cmd.parm.cmsg.Command
op_assign
id|CAPI_FACILITY
suffix:semicolon
id|cmd.parm.cmsg.Subcommand
op_assign
id|CAPI_REQ
suffix:semicolon
id|cmd.parm.cmsg.adr.Controller
op_assign
id|info-&gt;isdn_driver
op_plus
l_int|1
suffix:semicolon
id|cmd.parm.cmsg.para
(braket
l_int|0
)braket
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* 16 bit 0x0003 suplementary service */
id|cmd.parm.cmsg.para
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|cmd.parm.cmsg.para
(braket
l_int|2
)braket
op_assign
id|l
op_plus
l_int|3
suffix:semicolon
id|cmd.parm.cmsg.para
(braket
l_int|3
)braket
op_assign
l_int|5
suffix:semicolon
multiline_comment|/* 16 bit 0x0005 Resume */
id|cmd.parm.cmsg.para
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|cmd.parm.cmsg.para
(braket
l_int|5
)braket
op_assign
id|l
suffix:semicolon
id|strncpy
c_func
(paren
op_amp
id|cmd.parm.cmsg.para
(braket
l_int|6
)braket
comma
id|id
comma
id|l
)paren
suffix:semicolon
id|cmd.command
op_assign
id|CAPI_PUT_MESSAGE
suffix:semicolon
id|info-&gt;dialing
op_assign
l_int|1
suffix:semicolon
singleline_comment|//&t;&t;strcpy(dev-&gt;num[i], n);
id|isdn_info_update
c_func
(paren
)paren
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_CARRIER
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* isdn_tty_send_msg() sends a message to a HL driver&n; * This is used for hybrid modem cards to send AT commands to it&n; */
r_static
r_void
DECL|function|isdn_tty_send_msg
id|isdn_tty_send_msg
c_func
(paren
id|modem_info
op_star
id|info
comma
id|atemu
op_star
id|m
comma
r_char
op_star
id|msg
)paren
(brace
r_int
id|usg
op_assign
id|ISDN_USAGE_MODEM
suffix:semicolon
r_int
id|si
op_assign
l_int|7
suffix:semicolon
r_int
id|l2
op_assign
id|m-&gt;mdmreg
(braket
id|REG_L2PROT
)braket
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|j
suffix:semicolon
r_int
id|l
suffix:semicolon
id|l
op_assign
id|strlen
c_func
(paren
id|msg
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|l
)paren
(brace
id|isdn_tty_modem_result
c_func
(paren
id|RESULT_ERROR
comma
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|j
op_assign
l_int|7
suffix:semicolon
id|j
op_ge
l_int|0
suffix:semicolon
id|j
op_decrement
)paren
r_if
c_cond
(paren
id|m-&gt;mdmreg
(braket
id|REG_SI1
)braket
op_amp
(paren
l_int|1
op_lshift
id|j
)paren
)paren
(brace
id|si
op_assign
id|bit2si
(braket
id|j
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
id|usg
op_assign
id|isdn_calc_usage
c_func
(paren
id|si
comma
id|l2
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_AUDIO
r_if
c_cond
(paren
(paren
id|si
op_eq
l_int|1
)paren
op_logical_and
(paren
id|l2
op_ne
id|ISDN_PROTO_L2_MODEM
)paren
macro_line|#ifdef CONFIG_ISDN_TTY_FAX
op_logical_and
(paren
id|l2
op_ne
id|ISDN_PROTO_L2_FAX
)paren
macro_line|#endif
)paren
(brace
id|l2
op_assign
id|ISDN_PROTO_L2_TRANS
suffix:semicolon
id|usg
op_assign
id|ISDN_USAGE_VOICE
suffix:semicolon
)brace
macro_line|#endif
id|m-&gt;mdmreg
(braket
id|REG_SI1I
)braket
op_assign
id|si2bit
(braket
id|si
)braket
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|i
op_assign
id|isdn_get_free_channel
c_func
(paren
id|usg
comma
id|l2
comma
id|m-&gt;mdmreg
(braket
id|REG_L3PROT
)braket
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|m-&gt;msn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|isdn_tty_modem_result
c_func
(paren
id|RESULT_NO_DIALTONE
comma
id|info
)paren
suffix:semicolon
)brace
r_else
(brace
id|info-&gt;isdn_driver
op_assign
id|dev-&gt;drvmap
(braket
id|i
)braket
suffix:semicolon
id|info-&gt;isdn_channel
op_assign
id|dev-&gt;chanmap
(braket
id|i
)braket
suffix:semicolon
id|info-&gt;drv_index
op_assign
id|i
suffix:semicolon
id|dev-&gt;m_idx
(braket
id|i
)braket
op_assign
id|info-&gt;line
suffix:semicolon
id|dev-&gt;usage
(braket
id|i
)braket
op_or_assign
id|ISDN_USAGE_OUTGOING
suffix:semicolon
id|info-&gt;last_dir
op_assign
l_int|1
suffix:semicolon
id|isdn_info_update
c_func
(paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|cmd.arg
op_assign
id|info-&gt;isdn_channel
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_CLREAZ
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|cmd.parm.num
comma
id|isdn_map_eaz2msn
c_func
(paren
id|m-&gt;msn
comma
id|info-&gt;isdn_driver
)paren
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_SETEAZ
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_SETL2
suffix:semicolon
id|info-&gt;last_l2
op_assign
id|l2
suffix:semicolon
id|cmd.arg
op_assign
id|info-&gt;isdn_channel
op_plus
(paren
id|l2
op_lshift
l_int|8
)paren
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_SETL3
suffix:semicolon
id|cmd.arg
op_assign
id|info-&gt;isdn_channel
op_plus
(paren
id|m-&gt;mdmreg
(braket
id|REG_L3PROT
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|cmd.arg
op_assign
id|info-&gt;isdn_channel
suffix:semicolon
id|cmd.parm.cmsg.Length
op_assign
id|l
op_plus
l_int|14
suffix:semicolon
id|cmd.parm.cmsg.Command
op_assign
id|CAPI_MANUFACTURER
suffix:semicolon
id|cmd.parm.cmsg.Subcommand
op_assign
id|CAPI_REQ
suffix:semicolon
id|cmd.parm.cmsg.adr.Controller
op_assign
id|info-&gt;isdn_driver
op_plus
l_int|1
suffix:semicolon
id|cmd.parm.cmsg.para
(braket
l_int|0
)braket
op_assign
id|l
op_plus
l_int|1
suffix:semicolon
id|strncpy
c_func
(paren
op_amp
id|cmd.parm.cmsg.para
(braket
l_int|1
)braket
comma
id|msg
comma
id|l
)paren
suffix:semicolon
id|cmd.parm.cmsg.para
(braket
id|l
op_plus
l_int|1
)braket
op_assign
l_int|0xd
suffix:semicolon
id|cmd.command
op_assign
id|CAPI_PUT_MESSAGE
suffix:semicolon
multiline_comment|/*&t;&t;info-&gt;dialing = 1;&n;&t;&t;strcpy(dev-&gt;num[i], n);&n;&t;&t;isdn_info_update();&n;*/
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
)brace
)brace
r_static
r_inline
r_int
DECL|function|isdn_tty_paranoia_check
id|isdn_tty_paranoia_check
c_func
(paren
id|modem_info
op_star
id|info
comma
id|kdev_t
id|device
comma
r_const
r_char
op_star
id|routine
)paren
(brace
macro_line|#ifdef MODEM_PARANOIA_CHECK
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_tty: null info_struct for (%d, %d) in %s&bslash;n&quot;
comma
id|MAJOR
c_func
(paren
id|device
)paren
comma
id|MINOR
c_func
(paren
id|device
)paren
comma
id|routine
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;magic
op_ne
id|ISDN_ASYNC_MAGIC
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_tty: bad magic for modem struct (%d, %d) in %s&bslash;n&quot;
comma
id|MAJOR
c_func
(paren
id|device
)paren
comma
id|MINOR
c_func
(paren
id|device
)paren
comma
id|routine
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This routine is called to set the UART divisor registers to match&n; * the specified baud rate for a serial port.&n; */
r_static
r_void
DECL|function|isdn_tty_change_speed
id|isdn_tty_change_speed
c_func
(paren
id|modem_info
op_star
id|info
)paren
(brace
id|uint
id|cflag
comma
id|cval
comma
id|fcr
comma
id|quot
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tty
op_logical_or
op_logical_neg
id|info-&gt;tty-&gt;termios
)paren
r_return
suffix:semicolon
id|cflag
op_assign
id|info-&gt;tty-&gt;termios-&gt;c_cflag
suffix:semicolon
id|quot
op_assign
id|i
op_assign
id|cflag
op_amp
id|CBAUD
suffix:semicolon
r_if
c_cond
(paren
id|i
op_amp
id|CBAUDEX
)paren
(brace
id|i
op_and_assign
op_complement
id|CBAUDEX
suffix:semicolon
r_if
c_cond
(paren
id|i
template_param
l_int|2
)paren
id|info-&gt;tty-&gt;termios-&gt;c_cflag
op_and_assign
op_complement
id|CBAUDEX
suffix:semicolon
r_else
id|i
op_add_assign
l_int|15
suffix:semicolon
)brace
r_if
c_cond
(paren
id|quot
)paren
(brace
id|info-&gt;mcr
op_or_assign
id|UART_MCR_DTR
suffix:semicolon
id|isdn_tty_modem_ncarrier
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
r_else
(brace
id|info-&gt;mcr
op_and_assign
op_complement
id|UART_MCR_DTR
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;emu.mdmreg
(braket
id|REG_DTRHUP
)braket
op_amp
id|BIT_DTRHUP
)paren
(brace
macro_line|#ifdef ISDN_DEBUG_MODEM_HUP
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Mhup in changespeed&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|info-&gt;online
)paren
id|info-&gt;ncarrier
op_assign
l_int|1
suffix:semicolon
id|isdn_tty_modem_reset_regs
c_func
(paren
id|info
comma
l_int|0
)paren
suffix:semicolon
id|isdn_tty_modem_hup
c_func
(paren
id|info
comma
l_int|1
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* byte size and parity */
id|cval
op_assign
id|cflag
op_amp
(paren
id|CSIZE
op_or
id|CSTOPB
)paren
suffix:semicolon
id|cval
op_rshift_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|cflag
op_amp
id|PARENB
)paren
id|cval
op_or_assign
id|UART_LCR_PARITY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|cflag
op_amp
id|PARODD
)paren
)paren
id|cval
op_or_assign
id|UART_LCR_EPAR
suffix:semicolon
id|fcr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* CTS flow control flag and modem status interrupts */
r_if
c_cond
(paren
id|cflag
op_amp
id|CRTSCTS
)paren
(brace
id|info-&gt;flags
op_or_assign
id|ISDN_ASYNC_CTS_FLOW
suffix:semicolon
)brace
r_else
id|info-&gt;flags
op_and_assign
op_complement
id|ISDN_ASYNC_CTS_FLOW
suffix:semicolon
r_if
c_cond
(paren
id|cflag
op_amp
id|CLOCAL
)paren
id|info-&gt;flags
op_and_assign
op_complement
id|ISDN_ASYNC_CHECK_CD
suffix:semicolon
r_else
(brace
id|info-&gt;flags
op_or_assign
id|ISDN_ASYNC_CHECK_CD
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|isdn_tty_startup
id|isdn_tty_startup
c_func
(paren
id|modem_info
op_star
id|info
)paren
(brace
id|ulong
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_INITIALIZED
)paren
r_return
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|isdn_MOD_INC_USE_COUNT
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_OPEN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;starting up ttyi%d ...&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * Now, initialize the UART&n;&t; */
id|info-&gt;mcr
op_assign
id|UART_MCR_DTR
op_or
id|UART_MCR_RTS
op_or
id|UART_MCR_OUT2
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tty
)paren
id|clear_bit
c_func
(paren
id|TTY_IO_ERROR
comma
op_amp
id|info-&gt;tty-&gt;flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * and set the speed of the serial port&n;&t; */
id|isdn_tty_change_speed
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;flags
op_or_assign
id|ISDN_ASYNC_INITIALIZED
suffix:semicolon
id|info-&gt;msr
op_or_assign
(paren
id|UART_MSR_DSR
op_or
id|UART_MSR_CTS
)paren
suffix:semicolon
id|info-&gt;send_outstanding
op_assign
l_int|0
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This routine will shutdown a serial port; interrupts are disabled, and&n; * DTR is dropped if the hangup on close termio flag is on.&n; */
r_static
r_void
DECL|function|isdn_tty_shutdown
id|isdn_tty_shutdown
c_func
(paren
id|modem_info
op_star
id|info
)paren
(brace
id|ulong
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_INITIALIZED
)paren
)paren
r_return
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_OPEN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Shutting down isdnmodem port %d ....&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts */
id|isdn_MOD_DEC_USE_COUNT
c_func
(paren
)paren
suffix:semicolon
id|info-&gt;msr
op_and_assign
op_complement
id|UART_MSR_RI
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tty
op_logical_or
(paren
id|info-&gt;tty-&gt;termios-&gt;c_cflag
op_amp
id|HUPCL
)paren
)paren
(brace
id|info-&gt;mcr
op_and_assign
op_complement
(paren
id|UART_MCR_DTR
op_or
id|UART_MCR_RTS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;emu.mdmreg
(braket
id|REG_DTRHUP
)braket
op_amp
id|BIT_DTRHUP
)paren
(brace
id|isdn_tty_modem_reset_regs
c_func
(paren
id|info
comma
l_int|0
)paren
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_HUP
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Mhup in isdn_tty_shutdown&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|isdn_tty_modem_hup
c_func
(paren
id|info
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|info-&gt;tty
)paren
id|set_bit
c_func
(paren
id|TTY_IO_ERROR
comma
op_amp
id|info-&gt;tty-&gt;flags
)paren
suffix:semicolon
id|info-&gt;flags
op_and_assign
op_complement
id|ISDN_ASYNC_INITIALIZED
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* isdn_tty_write() is the main send-routine. It is called from the upper&n; * levels within the kernel to perform sending data. Depending on the&n; * online-flag it either directs output to the at-command-interpreter or&n; * to the lower level. Additional tasks done here:&n; *  - If online, check for escape-sequence (+++)&n; *  - If sending audio-data, call isdn_tty_DLEdown() to parse DLE-codes.&n; *  - If receiving audio-data, call isdn_tty_end_vrx() to abort if needed.&n; *  - If dialing, abort dial.&n; */
r_static
r_int
DECL|function|isdn_tty_write
id|isdn_tty_write
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|from_user
comma
r_const
id|u_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
id|c
suffix:semicolon
r_int
id|total
op_assign
l_int|0
suffix:semicolon
id|modem_info
op_star
id|info
op_assign
(paren
id|modem_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|atemu
op_star
id|m
op_assign
op_amp
id|info-&gt;emu
suffix:semicolon
r_if
c_cond
(paren
id|isdn_tty_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;isdn_tty_write&quot;
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|from_user
)paren
id|down
c_func
(paren
op_amp
id|info-&gt;write_sem
)paren
suffix:semicolon
multiline_comment|/* See isdn_tty_senddown() */
id|atomic_inc
c_func
(paren
op_amp
id|info-&gt;xmit_lock
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|c
op_assign
id|MIN
c_func
(paren
id|count
comma
id|info-&gt;xmit_size
op_minus
id|info-&gt;xmit_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;isdn_driver
op_ge
l_int|0
)paren
id|c
op_assign
id|MIN
c_func
(paren
id|c
comma
id|dev-&gt;drv
(braket
id|info-&gt;isdn_driver
)braket
op_member_access_from_pointer
id|maxbufsize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
op_le
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;online
OG
l_int|1
)paren
macro_line|#ifdef CONFIG_ISDN_AUDIO
op_logical_or
(paren
id|info-&gt;vonline
op_amp
l_int|3
)paren
macro_line|#endif
)paren
(brace
macro_line|#ifdef CONFIG_ISDN_AUDIO
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;vonline
)paren
macro_line|#endif
id|isdn_tty_check_esc
c_func
(paren
id|buf
comma
id|m-&gt;mdmreg
(braket
id|REG_ESC
)braket
comma
id|c
comma
op_amp
(paren
id|m-&gt;pluscount
)paren
comma
op_amp
(paren
id|m-&gt;lastplus
)paren
comma
id|from_user
)paren
suffix:semicolon
r_if
c_cond
(paren
id|from_user
)paren
id|copy_from_user
c_func
(paren
op_amp
(paren
id|info-&gt;xmit_buf
(braket
id|info-&gt;xmit_count
)braket
)paren
comma
id|buf
comma
id|c
)paren
suffix:semicolon
r_else
id|memcpy
c_func
(paren
op_amp
(paren
id|info-&gt;xmit_buf
(braket
id|info-&gt;xmit_count
)braket
)paren
comma
id|buf
comma
id|c
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_AUDIO
r_if
c_cond
(paren
id|info-&gt;vonline
)paren
(brace
r_int
id|cc
op_assign
id|isdn_tty_handleDLEdown
c_func
(paren
id|info
comma
id|m
comma
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;vonline
op_amp
l_int|2
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|cc
)paren
(brace
multiline_comment|/* If DLE decoding results in zero-transmit, but&n;&t;&t;&t;&t;&t;&t; * c originally was non-zero, do a wakeup.&n;&t;&t;&t;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
id|info-&gt;msr
op_or_assign
id|UART_MSR_CTS
suffix:semicolon
id|info-&gt;lsr
op_or_assign
id|UART_LSR_TEMT
suffix:semicolon
)brace
id|info-&gt;xmit_count
op_add_assign
id|cc
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|info-&gt;vonline
op_amp
l_int|3
)paren
op_eq
l_int|1
)paren
(brace
multiline_comment|/* Do NOT handle Ctrl-Q or Ctrl-S&n;&t;&t;&t;&t;&t; * when in full-duplex audio mode.&n;&t;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|isdn_tty_end_vrx
c_func
(paren
id|buf
comma
id|c
comma
id|from_user
)paren
)paren
(brace
id|info-&gt;vonline
op_and_assign
op_complement
l_int|1
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_VOICE
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;got !^Q/^S, send DLE-ETX,VCON on ttyI%d&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;&bslash;020&bslash;003&bslash;r&bslash;nVCON&bslash;r&bslash;n&quot;
comma
id|info
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|TTY_IS_FCLASS1
c_func
(paren
id|info
)paren
)paren
(brace
r_int
id|cc
op_assign
id|isdn_tty_handleDLEdown
c_func
(paren
id|info
comma
id|m
comma
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;vonline
op_amp
l_int|4
)paren
(brace
multiline_comment|/* ETX seen */
id|isdn_ctrl
id|c
suffix:semicolon
id|c.command
op_assign
id|ISDN_CMD_FAXCMD
suffix:semicolon
id|c.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|c.arg
op_assign
id|info-&gt;isdn_channel
suffix:semicolon
id|c.parm.aux.cmd
op_assign
id|ISDN_FAX_CLASS1_CTRL
suffix:semicolon
id|c.parm.aux.subcmd
op_assign
id|ETX
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|c
)paren
suffix:semicolon
)brace
id|info-&gt;vonline
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_VOICE
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;fax dle cc/c %d/%d&bslash;n&quot;
comma
id|cc
comma
id|c
)paren
suffix:semicolon
macro_line|#endif
id|info-&gt;xmit_count
op_add_assign
id|cc
suffix:semicolon
)brace
r_else
macro_line|#endif
id|info-&gt;xmit_count
op_add_assign
id|c
suffix:semicolon
)brace
r_else
(brace
id|info-&gt;msr
op_or_assign
id|UART_MSR_CTS
suffix:semicolon
id|info-&gt;lsr
op_or_assign
id|UART_LSR_TEMT
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;dialing
)paren
(brace
id|info-&gt;dialing
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_HUP
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Mhup in isdn_tty_write&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|isdn_tty_modem_result
c_func
(paren
id|RESULT_NO_CARRIER
comma
id|info
)paren
suffix:semicolon
id|isdn_tty_modem_hup
c_func
(paren
id|info
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
id|c
op_assign
id|isdn_tty_edit_at
c_func
(paren
id|buf
comma
id|c
comma
id|info
comma
id|from_user
)paren
suffix:semicolon
)brace
id|buf
op_add_assign
id|c
suffix:semicolon
id|count
op_sub_assign
id|c
suffix:semicolon
id|total
op_add_assign
id|c
suffix:semicolon
)brace
id|atomic_dec
c_func
(paren
op_amp
id|info-&gt;xmit_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;xmit_count
)paren
op_logical_or
(paren
id|skb_queue_len
c_func
(paren
op_amp
id|info-&gt;xmit_queue
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|m-&gt;mdmreg
(braket
id|REG_DXMT
)braket
op_amp
id|BIT_DXMT
)paren
(brace
id|isdn_tty_senddown
c_func
(paren
id|info
)paren
suffix:semicolon
id|isdn_tty_tint
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_MODEMXMIT
comma
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|from_user
)paren
id|up
c_func
(paren
op_amp
id|info-&gt;write_sem
)paren
suffix:semicolon
r_return
id|total
suffix:semicolon
)brace
r_static
r_int
DECL|function|isdn_tty_write_room
id|isdn_tty_write_room
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|modem_info
op_star
id|info
op_assign
(paren
id|modem_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|isdn_tty_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;isdn_tty_write_room&quot;
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;online
)paren
r_return
id|info-&gt;xmit_size
suffix:semicolon
id|ret
op_assign
id|info-&gt;xmit_size
op_minus
id|info-&gt;xmit_count
suffix:semicolon
r_return
(paren
id|ret
OL
l_int|0
)paren
ques
c_cond
l_int|0
suffix:colon
id|ret
suffix:semicolon
)brace
r_static
r_int
DECL|function|isdn_tty_chars_in_buffer
id|isdn_tty_chars_in_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|modem_info
op_star
id|info
op_assign
(paren
id|modem_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|isdn_tty_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;isdn_tty_chars_in_buffer&quot;
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;online
)paren
r_return
l_int|0
suffix:semicolon
r_return
(paren
id|info-&gt;xmit_count
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|isdn_tty_flush_buffer
id|isdn_tty_flush_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|modem_info
op_star
id|info
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|info
op_assign
(paren
id|modem_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|isdn_tty_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;isdn_tty_flush_buffer&quot;
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|isdn_tty_cleanup_xmit
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;xmit_count
op_assign
l_int|0
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|isdn_tty_flush_chars
id|isdn_tty_flush_chars
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|modem_info
op_star
id|info
op_assign
(paren
id|modem_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|isdn_tty_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;isdn_tty_flush_chars&quot;
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;xmit_count
)paren
op_logical_or
(paren
id|skb_queue_len
c_func
(paren
op_amp
id|info-&gt;xmit_queue
)paren
)paren
)paren
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_MODEMXMIT
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * ------------------------------------------------------------&n; * isdn_tty_throttle()&n; *&n; * This routine is called by the upper-layer tty layer to signal that&n; * incoming characters should be throttled.&n; * ------------------------------------------------------------&n; */
r_static
r_void
DECL|function|isdn_tty_throttle
id|isdn_tty_throttle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|modem_info
op_star
id|info
op_assign
(paren
id|modem_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|isdn_tty_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;isdn_tty_throttle&quot;
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|I_IXOFF
c_func
(paren
id|tty
)paren
)paren
id|info-&gt;x_char
op_assign
id|STOP_CHAR
c_func
(paren
id|tty
)paren
suffix:semicolon
id|info-&gt;mcr
op_and_assign
op_complement
id|UART_MCR_RTS
suffix:semicolon
)brace
r_static
r_void
DECL|function|isdn_tty_unthrottle
id|isdn_tty_unthrottle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|modem_info
op_star
id|info
op_assign
(paren
id|modem_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|isdn_tty_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;isdn_tty_unthrottle&quot;
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|I_IXOFF
c_func
(paren
id|tty
)paren
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;x_char
)paren
id|info-&gt;x_char
op_assign
l_int|0
suffix:semicolon
r_else
id|info-&gt;x_char
op_assign
id|START_CHAR
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
id|info-&gt;mcr
op_or_assign
id|UART_MCR_RTS
suffix:semicolon
)brace
multiline_comment|/*&n; * ------------------------------------------------------------&n; * isdn_tty_ioctl() and friends&n; * ------------------------------------------------------------&n; */
multiline_comment|/*&n; * isdn_tty_get_lsr_info - get line status register info&n; *&n; * Purpose: Let user call ioctl() to get info when the UART physically&n; *          is emptied.  On bus types like RS485, the transmitter must&n; *          release the bus after transmitting. This must be done when&n; *          the transmit shift register is empty, not be done when the&n; *          transmit holding register is empty.  This functionality&n; *          allows RS485 driver to be written in user space.&n; */
r_static
r_int
DECL|function|isdn_tty_get_lsr_info
id|isdn_tty_get_lsr_info
c_func
(paren
id|modem_info
op_star
id|info
comma
id|uint
op_star
id|value
)paren
(brace
id|u_char
id|status
suffix:semicolon
id|uint
id|result
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|status
op_assign
id|info-&gt;lsr
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|result
op_assign
(paren
(paren
id|status
op_amp
id|UART_LSR_TEMT
)paren
ques
c_cond
id|TIOCSER_TEMT
suffix:colon
l_int|0
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|result
comma
(paren
id|uint
op_star
)paren
id|value
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|isdn_tty_get_modem_info
id|isdn_tty_get_modem_info
c_func
(paren
id|modem_info
op_star
id|info
comma
id|uint
op_star
id|value
)paren
(brace
id|u_char
id|control
comma
id|status
suffix:semicolon
id|uint
id|result
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
id|control
op_assign
id|info-&gt;mcr
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|status
op_assign
id|info-&gt;msr
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|result
op_assign
(paren
(paren
id|control
op_amp
id|UART_MCR_RTS
)paren
ques
c_cond
id|TIOCM_RTS
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|control
op_amp
id|UART_MCR_DTR
)paren
ques
c_cond
id|TIOCM_DTR
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|status
op_amp
id|UART_MSR_DCD
)paren
ques
c_cond
id|TIOCM_CAR
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|status
op_amp
id|UART_MSR_RI
)paren
ques
c_cond
id|TIOCM_RNG
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|status
op_amp
id|UART_MSR_DSR
)paren
ques
c_cond
id|TIOCM_DSR
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|status
op_amp
id|UART_MSR_CTS
)paren
ques
c_cond
id|TIOCM_CTS
suffix:colon
l_int|0
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|result
comma
(paren
id|uint
op_star
)paren
id|value
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|isdn_tty_set_modem_info
id|isdn_tty_set_modem_info
c_func
(paren
id|modem_info
op_star
id|info
comma
id|uint
id|cmd
comma
id|uint
op_star
id|value
)paren
(brace
id|uint
id|arg
suffix:semicolon
r_int
id|pre_dtr
suffix:semicolon
id|get_user
c_func
(paren
id|arg
comma
(paren
id|uint
op_star
)paren
id|value
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TIOCMBIS
suffix:colon
macro_line|#ifdef ISDN_DEBUG_MODEM_IOCTL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ttyI%d ioctl TIOCMBIS&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_RTS
)paren
(brace
id|info-&gt;mcr
op_or_assign
id|UART_MCR_RTS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_DTR
)paren
(brace
id|info-&gt;mcr
op_or_assign
id|UART_MCR_DTR
suffix:semicolon
id|isdn_tty_modem_ncarrier
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TIOCMBIC
suffix:colon
macro_line|#ifdef ISDN_DEBUG_MODEM_IOCTL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ttyI%d ioctl TIOCMBIC&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_RTS
)paren
(brace
id|info-&gt;mcr
op_and_assign
op_complement
id|UART_MCR_RTS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_DTR
)paren
(brace
id|info-&gt;mcr
op_and_assign
op_complement
id|UART_MCR_DTR
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;emu.mdmreg
(braket
id|REG_DTRHUP
)braket
op_amp
id|BIT_DTRHUP
)paren
(brace
id|isdn_tty_modem_reset_regs
c_func
(paren
id|info
comma
l_int|0
)paren
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_HUP
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Mhup in TIOCMBIC&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|info-&gt;online
)paren
id|info-&gt;ncarrier
op_assign
l_int|1
suffix:semicolon
id|isdn_tty_modem_hup
c_func
(paren
id|info
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|TIOCMSET
suffix:colon
macro_line|#ifdef ISDN_DEBUG_MODEM_IOCTL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ttyI%d ioctl TIOCMSET&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
id|pre_dtr
op_assign
(paren
id|info-&gt;mcr
op_amp
id|UART_MCR_DTR
)paren
suffix:semicolon
id|info-&gt;mcr
op_assign
(paren
(paren
id|info-&gt;mcr
op_amp
op_complement
(paren
id|UART_MCR_RTS
op_or
id|UART_MCR_DTR
)paren
)paren
op_or
(paren
(paren
id|arg
op_amp
id|TIOCM_RTS
)paren
ques
c_cond
id|UART_MCR_RTS
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|arg
op_amp
id|TIOCM_DTR
)paren
ques
c_cond
id|UART_MCR_DTR
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pre_dtr
op_or_assign
(paren
id|info-&gt;mcr
op_amp
id|UART_MCR_DTR
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;mcr
op_amp
id|UART_MCR_DTR
)paren
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;emu.mdmreg
(braket
id|REG_DTRHUP
)braket
op_amp
id|BIT_DTRHUP
)paren
(brace
id|isdn_tty_modem_reset_regs
c_func
(paren
id|info
comma
l_int|0
)paren
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_HUP
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Mhup in TIOCMSET&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|info-&gt;online
)paren
id|info-&gt;ncarrier
op_assign
l_int|1
suffix:semicolon
id|isdn_tty_modem_hup
c_func
(paren
id|info
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
r_else
id|isdn_tty_modem_ncarrier
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|isdn_tty_ioctl
id|isdn_tty_ioctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
id|uint
id|cmd
comma
id|ulong
id|arg
)paren
(brace
id|modem_info
op_star
id|info
op_assign
(paren
id|modem_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
id|error
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_if
c_cond
(paren
id|isdn_tty_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;isdn_tty_ioctl&quot;
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_IO_ERROR
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TCSBRK
suffix:colon
multiline_comment|/* SVID version: non-zero arg --&gt; no break */
macro_line|#ifdef ISDN_DEBUG_MODEM_IOCTL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ttyI%d ioctl TCSBRK&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
id|retval
op_assign
id|tty_check_change
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
id|retval
suffix:semicolon
id|tty_wait_until_sent
c_func
(paren
id|tty
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TCSBRKP
suffix:colon
multiline_comment|/* support for POSIX tcsendbreak() */
macro_line|#ifdef ISDN_DEBUG_MODEM_IOCTL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ttyI%d ioctl TCSBRKP&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
id|retval
op_assign
id|tty_check_change
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
id|retval
suffix:semicolon
id|tty_wait_until_sent
c_func
(paren
id|tty
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TIOCGSOFTCAR
suffix:colon
macro_line|#ifdef ISDN_DEBUG_MODEM_IOCTL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ttyI%d ioctl TIOCGSOFTCAR&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|put_user
c_func
(paren
id|C_CLOCAL
c_func
(paren
id|tty
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
(paren
id|ulong
op_star
)paren
id|arg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TIOCSSOFTCAR
suffix:colon
macro_line|#ifdef ISDN_DEBUG_MODEM_IOCTL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ttyI%d ioctl TIOCSSOFTCAR&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|get_user
c_func
(paren
id|arg
comma
(paren
id|ulong
op_star
)paren
id|arg
)paren
suffix:semicolon
id|tty-&gt;termios-&gt;c_cflag
op_assign
(paren
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
op_complement
id|CLOCAL
)paren
op_or
(paren
id|arg
ques
c_cond
id|CLOCAL
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TIOCMGET
suffix:colon
macro_line|#ifdef ISDN_DEBUG_MODEM_IOCTL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ttyI%d ioctl TIOCMGET&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|uint
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
r_return
id|isdn_tty_get_modem_info
c_func
(paren
id|info
comma
(paren
id|uint
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|TIOCMBIS
suffix:colon
r_case
id|TIOCMBIC
suffix:colon
r_case
id|TIOCMSET
suffix:colon
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|uint
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
r_return
id|isdn_tty_set_modem_info
c_func
(paren
id|info
comma
id|cmd
comma
(paren
id|uint
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|TIOCSERGETLSR
suffix:colon
multiline_comment|/* Get line status register */
macro_line|#ifdef ISDN_DEBUG_MODEM_IOCTL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ttyI%d ioctl TIOCSERGETLSR&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|uint
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
r_else
r_return
id|isdn_tty_get_lsr_info
c_func
(paren
id|info
comma
(paren
id|uint
op_star
)paren
id|arg
)paren
suffix:semicolon
r_default
suffix:colon
macro_line|#ifdef ISDN_DEBUG_MODEM_IOCTL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;UNKNOWN ioctl 0x%08x on ttyi%d&bslash;n&quot;
comma
id|cmd
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|isdn_tty_set_termios
id|isdn_tty_set_termios
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|termios
op_star
id|old_termios
)paren
(brace
id|modem_info
op_star
id|info
op_assign
(paren
id|modem_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|old_termios
)paren
id|isdn_tty_change_speed
c_func
(paren
id|info
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|tty-&gt;termios-&gt;c_cflag
op_eq
id|old_termios-&gt;c_cflag
)paren
r_return
suffix:semicolon
id|isdn_tty_change_speed
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|old_termios-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
op_logical_and
op_logical_neg
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
)paren
(brace
id|tty-&gt;hw_stopped
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * ------------------------------------------------------------&n; * isdn_tty_open() and friends&n; * ------------------------------------------------------------&n; */
r_static
r_int
DECL|function|isdn_tty_block_til_ready
id|isdn_tty_block_til_ready
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
comma
id|modem_info
op_star
id|info
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
l_int|NULL
)paren
suffix:semicolon
r_int
id|do_clocal
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|retval
suffix:semicolon
multiline_comment|/*&n;&t; * If the device is in the middle of being closed, then block&n;&t; * until it&squot;s done, and then try again.&n;&t; */
r_if
c_cond
(paren
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
op_logical_or
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_CLOSING
)paren
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_CLOSING
)paren
id|interruptible_sleep_on
c_func
(paren
op_amp
id|info-&gt;close_wait
)paren
suffix:semicolon
macro_line|#ifdef MODEM_DO_RESTART
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_HUP_NOTIFY
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_else
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
macro_line|#else
r_return
op_minus
id|EAGAIN
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n;&t; * If this is a callout device, then just make sure the normal&n;&t; * device isn&squot;t being used.&n;&t; */
r_if
c_cond
(paren
id|tty-&gt;driver.subtype
op_eq
id|ISDN_SERIAL_TYPE_CALLOUT
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_NORMAL_ACTIVE
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_CALLOUT_ACTIVE
)paren
op_logical_and
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_SESSION_LOCKOUT
)paren
op_logical_and
(paren
id|info-&gt;session
op_ne
id|current-&gt;session
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_CALLOUT_ACTIVE
)paren
op_logical_and
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_PGRP_LOCKOUT
)paren
op_logical_and
(paren
id|info-&gt;pgrp
op_ne
id|current-&gt;pgrp
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|info-&gt;flags
op_or_assign
id|ISDN_ASYNC_CALLOUT_ACTIVE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * If non-blocking mode is set, then make the check up front&n;&t; * and then exit.&n;&t; */
r_if
c_cond
(paren
(paren
id|filp-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
op_logical_or
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_IO_ERROR
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_CALLOUT_ACTIVE
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|info-&gt;flags
op_or_assign
id|ISDN_ASYNC_NORMAL_ACTIVE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_CALLOUT_ACTIVE
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;normal_termios.c_cflag
op_amp
id|CLOCAL
)paren
id|do_clocal
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CLOCAL
)paren
id|do_clocal
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Block waiting for the carrier detect and the line to become&n;&t; * free (i.e., not in use by the callout).  While we are in&n;&t; * this loop, info-&gt;count is dropped by one, so that&n;&t; * isdn_tty_close() knows when to free things.  We restore it upon&n;&t; * exit, either normal or abnormal.&n;&t; */
id|retval
op_assign
l_int|0
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|info-&gt;open_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_OPEN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_tty_block_til_ready before block: ttyi%d, count = %d&bslash;n&quot;
comma
id|info-&gt;line
comma
id|info-&gt;count
)paren
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
)paren
)paren
id|info-&gt;count
op_decrement
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|info-&gt;blocked_open
op_increment
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
op_logical_or
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_INITIALIZED
)paren
)paren
(brace
macro_line|#ifdef MODEM_DO_RESTART
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_HUP_NOTIFY
)paren
id|retval
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
macro_line|#else
id|retval
op_assign
op_minus
id|EAGAIN
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_CALLOUT_ACTIVE
)paren
op_logical_and
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_CLOSING
)paren
op_logical_and
(paren
id|do_clocal
op_logical_or
(paren
id|info-&gt;msr
op_amp
id|UART_MSR_DCD
)paren
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#ifdef ISDN_DEBUG_MODEM_OPEN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_tty_block_til_ready blocking: ttyi%d, count = %d&bslash;n&quot;
comma
id|info-&gt;line
comma
id|info-&gt;count
)paren
suffix:semicolon
macro_line|#endif
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|info-&gt;open_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
)paren
id|info-&gt;count
op_increment
suffix:semicolon
id|info-&gt;blocked_open
op_decrement
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_OPEN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_tty_block_til_ready after blocking: ttyi%d, count = %d&bslash;n&quot;
comma
id|info-&gt;line
comma
id|info-&gt;count
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|retval
)paren
r_return
id|retval
suffix:semicolon
id|info-&gt;flags
op_or_assign
id|ISDN_ASYNC_NORMAL_ACTIVE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This routine is called whenever a serial port is opened.  It&n; * enables interrupts for a serial port, linking in its async structure into&n; * the IRQ chain.   It also performs the serial-specific&n; * initialization for the tty structure.&n; */
r_static
r_int
DECL|function|isdn_tty_open
id|isdn_tty_open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|modem_info
op_star
id|info
suffix:semicolon
r_int
id|retval
comma
id|line
suffix:semicolon
id|line
op_assign
id|MINOR
c_func
(paren
id|tty-&gt;device
)paren
op_minus
id|tty-&gt;driver.minor_start
suffix:semicolon
r_if
c_cond
(paren
id|line
template_param
id|ISDN_MAX_CHANNELS
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|info
op_assign
op_amp
id|dev-&gt;mdm.info
(braket
id|line
)braket
suffix:semicolon
r_if
c_cond
(paren
id|isdn_tty_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;isdn_tty_open&quot;
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_OPEN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_tty_open %s%d, count = %d&bslash;n&quot;
comma
id|tty-&gt;driver.name
comma
id|info-&gt;line
comma
id|info-&gt;count
)paren
suffix:semicolon
macro_line|#endif
id|info-&gt;count
op_increment
suffix:semicolon
id|tty-&gt;driver_data
op_assign
id|info
suffix:semicolon
id|info-&gt;tty
op_assign
id|tty
suffix:semicolon
multiline_comment|/*&n;&t; * Start up serial port&n;&t; */
id|retval
op_assign
id|isdn_tty_startup
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
macro_line|#ifdef ISDN_DEBUG_MODEM_OPEN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_tty_open return after startup&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|retval
suffix:semicolon
)brace
id|retval
op_assign
id|isdn_tty_block_til_ready
c_func
(paren
id|tty
comma
id|filp
comma
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
macro_line|#ifdef ISDN_DEBUG_MODEM_OPEN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_tty_open return after isdn_tty_block_til_ready &bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|retval
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|info-&gt;count
op_eq
l_int|1
)paren
op_logical_and
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_SPLIT_TERMIOS
)paren
)paren
(brace
r_if
c_cond
(paren
id|tty-&gt;driver.subtype
op_eq
id|ISDN_SERIAL_TYPE_NORMAL
)paren
op_star
id|tty-&gt;termios
op_assign
id|info-&gt;normal_termios
suffix:semicolon
r_else
op_star
id|tty-&gt;termios
op_assign
id|info-&gt;callout_termios
suffix:semicolon
id|isdn_tty_change_speed
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
id|info-&gt;session
op_assign
id|current-&gt;session
suffix:semicolon
id|info-&gt;pgrp
op_assign
id|current-&gt;pgrp
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_OPEN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_tty_open ttyi%d successful...&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
id|dev-&gt;modempoll
op_increment
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_OPEN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_tty_open normal exit&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|isdn_tty_close
id|isdn_tty_close
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|modem_info
op_star
id|info
op_assign
(paren
id|modem_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
id|ulong
id|timeout
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
op_logical_or
id|isdn_tty_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;isdn_tty_close&quot;
)paren
)paren
r_return
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_OPEN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_tty_close return after tty_hung_up_p&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|tty-&gt;count
op_eq
l_int|1
)paren
op_logical_and
(paren
id|info-&gt;count
op_ne
l_int|1
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * Uh, oh.  tty-&gt;count is 1, which means that the tty&n;&t;&t; * structure will be freed.  Info-&gt;count should always&n;&t;&t; * be one in these conditions.  If it&squot;s greater than&n;&t;&t; * one, we&squot;ve got real problems, since it means the&n;&t;&t; * serial port won&squot;t be shutdown.&n;&t;&t; */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;isdn_tty_close: bad port count; tty-&gt;count is 1, &quot;
l_string|&quot;info-&gt;count is %d&bslash;n&quot;
comma
id|info-&gt;count
)paren
suffix:semicolon
id|info-&gt;count
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_decrement
id|info-&gt;count
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;isdn_tty_close: bad port count for ttyi%d: %d&bslash;n&quot;
comma
id|info-&gt;line
comma
id|info-&gt;count
)paren
suffix:semicolon
id|info-&gt;count
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;count
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_OPEN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_tty_close after info-&gt;count != 0&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
id|info-&gt;flags
op_or_assign
id|ISDN_ASYNC_CLOSING
suffix:semicolon
multiline_comment|/*&n;&t; * Save the termios structure, since this port may have&n;&t; * separate termios for callout and dialin.&n;&t; */
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_NORMAL_ACTIVE
)paren
id|info-&gt;normal_termios
op_assign
op_star
id|tty-&gt;termios
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_CALLOUT_ACTIVE
)paren
id|info-&gt;callout_termios
op_assign
op_star
id|tty-&gt;termios
suffix:semicolon
id|tty-&gt;closing
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * At this point we stop accepting input.  To do this, we&n;&t; * disable the receive line status interrupts, and tell the&n;&t; * interrupt driver to stop checking the data ready bit in the&n;&t; * line status register.&n;&t; */
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_INITIALIZED
)paren
(brace
id|tty_wait_until_sent
c_func
(paren
id|tty
comma
l_int|3000
)paren
suffix:semicolon
multiline_comment|/* 30 seconds timeout */
multiline_comment|/*&n;&t;&t; * Before we drop DTR, make sure the UART transmitter&n;&t;&t; * has completely drained; this is especially&n;&t;&t; * important if there is a transmit FIFO!&n;&t;&t; */
id|timeout
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|info-&gt;lsr
op_amp
id|UART_LSR_TEMT
)paren
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|20
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
r_break
suffix:semicolon
)brace
)brace
id|dev-&gt;modempoll
op_decrement
suffix:semicolon
id|isdn_tty_shutdown
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;driver.flush_buffer
)paren
id|tty-&gt;driver
dot
id|flush_buffer
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;ldisc.flush_buffer
)paren
id|tty-&gt;ldisc
dot
id|flush_buffer
c_func
(paren
id|tty
)paren
suffix:semicolon
id|info-&gt;tty
op_assign
l_int|0
suffix:semicolon
id|info-&gt;ncarrier
op_assign
l_int|0
suffix:semicolon
id|tty-&gt;closing
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;blocked_open
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|50
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;open_wait
)paren
suffix:semicolon
)brace
id|info-&gt;flags
op_and_assign
op_complement
(paren
id|ISDN_ASYNC_NORMAL_ACTIVE
op_or
id|ISDN_ASYNC_CALLOUT_ACTIVE
op_or
id|ISDN_ASYNC_CLOSING
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;close_wait
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_OPEN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_tty_close normal exit&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * isdn_tty_hangup() --- called by tty_hangup() when a hangup is signaled.&n; */
r_static
r_void
DECL|function|isdn_tty_hangup
id|isdn_tty_hangup
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|modem_info
op_star
id|info
op_assign
(paren
id|modem_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|isdn_tty_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;isdn_tty_hangup&quot;
)paren
)paren
r_return
suffix:semicolon
id|isdn_tty_shutdown
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;count
op_assign
l_int|0
suffix:semicolon
id|info-&gt;flags
op_and_assign
op_complement
(paren
id|ISDN_ASYNC_NORMAL_ACTIVE
op_or
id|ISDN_ASYNC_CALLOUT_ACTIVE
)paren
suffix:semicolon
id|info-&gt;tty
op_assign
l_int|0
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;open_wait
)paren
suffix:semicolon
)brace
multiline_comment|/* This routine initializes all emulator-data.&n; */
r_static
r_void
DECL|function|isdn_tty_reset_profile
id|isdn_tty_reset_profile
c_func
(paren
id|atemu
op_star
id|m
)paren
(brace
id|m-&gt;profile
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|m-&gt;profile
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|m-&gt;profile
(braket
l_int|2
)braket
op_assign
l_int|43
suffix:semicolon
id|m-&gt;profile
(braket
l_int|3
)braket
op_assign
l_int|13
suffix:semicolon
id|m-&gt;profile
(braket
l_int|4
)braket
op_assign
l_int|10
suffix:semicolon
id|m-&gt;profile
(braket
l_int|5
)braket
op_assign
l_int|8
suffix:semicolon
id|m-&gt;profile
(braket
l_int|6
)braket
op_assign
l_int|3
suffix:semicolon
id|m-&gt;profile
(braket
l_int|7
)braket
op_assign
l_int|60
suffix:semicolon
id|m-&gt;profile
(braket
l_int|8
)braket
op_assign
l_int|2
suffix:semicolon
id|m-&gt;profile
(braket
l_int|9
)braket
op_assign
l_int|6
suffix:semicolon
id|m-&gt;profile
(braket
l_int|10
)braket
op_assign
l_int|7
suffix:semicolon
id|m-&gt;profile
(braket
l_int|11
)braket
op_assign
l_int|70
suffix:semicolon
id|m-&gt;profile
(braket
l_int|12
)braket
op_assign
l_int|0x45
suffix:semicolon
id|m-&gt;profile
(braket
l_int|13
)braket
op_assign
l_int|4
suffix:semicolon
id|m-&gt;profile
(braket
l_int|14
)braket
op_assign
id|ISDN_PROTO_L2_X75I
suffix:semicolon
id|m-&gt;profile
(braket
l_int|15
)braket
op_assign
id|ISDN_PROTO_L3_TRANS
suffix:semicolon
id|m-&gt;profile
(braket
l_int|16
)braket
op_assign
id|ISDN_SERIAL_XMIT_SIZE
op_div
l_int|16
suffix:semicolon
id|m-&gt;profile
(braket
l_int|17
)braket
op_assign
id|ISDN_MODEM_WINSIZE
suffix:semicolon
id|m-&gt;profile
(braket
l_int|18
)braket
op_assign
l_int|4
suffix:semicolon
id|m-&gt;profile
(braket
l_int|19
)braket
op_assign
l_int|0
suffix:semicolon
id|m-&gt;profile
(braket
l_int|20
)braket
op_assign
l_int|0
suffix:semicolon
id|m-&gt;profile
(braket
l_int|23
)braket
op_assign
l_int|0
suffix:semicolon
id|m-&gt;pmsn
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|m-&gt;plmsn
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ISDN_AUDIO
r_static
r_void
DECL|function|isdn_tty_modem_reset_vpar
id|isdn_tty_modem_reset_vpar
c_func
(paren
id|atemu
op_star
id|m
)paren
(brace
id|m-&gt;vpar
(braket
l_int|0
)braket
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* Voice-device            (2 = phone line) */
id|m-&gt;vpar
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Silence detection level (0 = none      ) */
id|m-&gt;vpar
(braket
l_int|2
)braket
op_assign
l_int|70
suffix:semicolon
multiline_comment|/* Silence interval        (7 sec.        ) */
id|m-&gt;vpar
(braket
l_int|3
)braket
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* Compression type        (1 = ADPCM-2   ) */
id|m-&gt;vpar
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* DTMF detection level    (0 = softcode  ) */
id|m-&gt;vpar
(braket
l_int|5
)braket
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* DTMF interval           (8 * 5 ms.     ) */
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_ISDN_TTY_FAX
r_static
r_void
DECL|function|isdn_tty_modem_reset_faxpar
id|isdn_tty_modem_reset_faxpar
c_func
(paren
id|modem_info
op_star
id|info
)paren
(brace
id|T30_s
op_star
id|f
op_assign
id|info-&gt;fax
suffix:semicolon
id|f-&gt;code
op_assign
l_int|0
suffix:semicolon
id|f-&gt;phase
op_assign
id|ISDN_FAX_PHASE_IDLE
suffix:semicolon
id|f-&gt;direction
op_assign
l_int|0
suffix:semicolon
id|f-&gt;resolution
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* fine */
id|f-&gt;rate
op_assign
l_int|5
suffix:semicolon
multiline_comment|/* 14400 bit/s */
id|f-&gt;width
op_assign
l_int|0
suffix:semicolon
id|f-&gt;length
op_assign
l_int|0
suffix:semicolon
id|f-&gt;compression
op_assign
l_int|0
suffix:semicolon
id|f-&gt;ecm
op_assign
l_int|0
suffix:semicolon
id|f-&gt;binary
op_assign
l_int|0
suffix:semicolon
id|f-&gt;scantime
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|f-&gt;id
(braket
l_int|0
)braket
comma
l_int|32
comma
id|FAXIDLEN
op_minus
l_int|1
)paren
suffix:semicolon
id|f-&gt;id
(braket
id|FAXIDLEN
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|f-&gt;badlin
op_assign
l_int|0
suffix:semicolon
id|f-&gt;badmul
op_assign
l_int|0
suffix:semicolon
id|f-&gt;bor
op_assign
l_int|0
suffix:semicolon
id|f-&gt;nbc
op_assign
l_int|0
suffix:semicolon
id|f-&gt;cq
op_assign
l_int|0
suffix:semicolon
id|f-&gt;cr
op_assign
l_int|0
suffix:semicolon
id|f-&gt;ctcrty
op_assign
l_int|0
suffix:semicolon
id|f-&gt;minsp
op_assign
l_int|0
suffix:semicolon
id|f-&gt;phcto
op_assign
l_int|30
suffix:semicolon
id|f-&gt;rel
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|f-&gt;pollid
(braket
l_int|0
)braket
comma
l_int|32
comma
id|FAXIDLEN
op_minus
l_int|1
)paren
suffix:semicolon
id|f-&gt;pollid
(braket
id|FAXIDLEN
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_static
r_void
DECL|function|isdn_tty_modem_reset_regs
id|isdn_tty_modem_reset_regs
c_func
(paren
id|modem_info
op_star
id|info
comma
r_int
id|force
)paren
(brace
id|atemu
op_star
id|m
op_assign
op_amp
id|info-&gt;emu
suffix:semicolon
r_if
c_cond
(paren
(paren
id|m-&gt;mdmreg
(braket
id|REG_DTRR
)braket
op_amp
id|BIT_DTRR
)paren
op_logical_or
id|force
)paren
(brace
id|memcpy
c_func
(paren
id|m-&gt;mdmreg
comma
id|m-&gt;profile
comma
id|ISDN_MODEM_NUMREG
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|m-&gt;msn
comma
id|m-&gt;pmsn
comma
id|ISDN_MSNLEN
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|m-&gt;lmsn
comma
id|m-&gt;plmsn
comma
id|ISDN_LMSNLEN
)paren
suffix:semicolon
id|info-&gt;xmit_size
op_assign
id|m-&gt;mdmreg
(braket
id|REG_PSIZE
)braket
op_star
l_int|16
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ISDN_AUDIO
id|isdn_tty_modem_reset_vpar
c_func
(paren
id|m
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ISDN_TTY_FAX
id|isdn_tty_modem_reset_faxpar
c_func
(paren
id|info
)paren
suffix:semicolon
macro_line|#endif
id|m-&gt;mdmcmdl
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|modem_write_profile
id|modem_write_profile
c_func
(paren
id|atemu
op_star
id|m
)paren
(brace
id|memcpy
c_func
(paren
id|m-&gt;profile
comma
id|m-&gt;mdmreg
comma
id|ISDN_MODEM_NUMREG
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|m-&gt;pmsn
comma
id|m-&gt;msn
comma
id|ISDN_MSNLEN
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|m-&gt;plmsn
comma
id|m-&gt;lmsn
comma
id|ISDN_LMSNLEN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;profd
)paren
id|send_sig
c_func
(paren
id|SIGIO
comma
id|dev-&gt;profd
comma
l_int|1
)paren
suffix:semicolon
)brace
r_int
DECL|function|isdn_tty_modem_init
id|isdn_tty_modem_init
c_func
(paren
r_void
)paren
(brace
id|modem
op_star
id|m
suffix:semicolon
r_int
id|i
suffix:semicolon
id|modem_info
op_star
id|info
suffix:semicolon
id|m
op_assign
op_amp
id|dev-&gt;mdm
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|m-&gt;tty_modem
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tty_driver
)paren
)paren
suffix:semicolon
id|m-&gt;tty_modem.magic
op_assign
id|TTY_DRIVER_MAGIC
suffix:semicolon
id|m-&gt;tty_modem.name
op_assign
id|isdn_ttyname_ttyI
suffix:semicolon
id|m-&gt;tty_modem.major
op_assign
id|ISDN_TTY_MAJOR
suffix:semicolon
id|m-&gt;tty_modem.minor_start
op_assign
l_int|0
suffix:semicolon
id|m-&gt;tty_modem.num
op_assign
id|ISDN_MAX_CHANNELS
suffix:semicolon
id|m-&gt;tty_modem.type
op_assign
id|TTY_DRIVER_TYPE_SERIAL
suffix:semicolon
id|m-&gt;tty_modem.subtype
op_assign
id|ISDN_SERIAL_TYPE_NORMAL
suffix:semicolon
id|m-&gt;tty_modem.init_termios
op_assign
id|tty_std_termios
suffix:semicolon
id|m-&gt;tty_modem.init_termios.c_cflag
op_assign
id|B9600
op_or
id|CS8
op_or
id|CREAD
op_or
id|HUPCL
op_or
id|CLOCAL
suffix:semicolon
id|m-&gt;tty_modem.flags
op_assign
id|TTY_DRIVER_REAL_RAW
suffix:semicolon
id|m-&gt;tty_modem.refcount
op_assign
op_amp
id|m-&gt;refcount
suffix:semicolon
id|m-&gt;tty_modem.table
op_assign
id|m-&gt;modem_table
suffix:semicolon
id|m-&gt;tty_modem.termios
op_assign
id|m-&gt;modem_termios
suffix:semicolon
id|m-&gt;tty_modem.termios_locked
op_assign
id|m-&gt;modem_termios_locked
suffix:semicolon
id|m-&gt;tty_modem.open
op_assign
id|isdn_tty_open
suffix:semicolon
id|m-&gt;tty_modem.close
op_assign
id|isdn_tty_close
suffix:semicolon
id|m-&gt;tty_modem.write
op_assign
id|isdn_tty_write
suffix:semicolon
id|m-&gt;tty_modem.put_char
op_assign
l_int|NULL
suffix:semicolon
id|m-&gt;tty_modem.flush_chars
op_assign
id|isdn_tty_flush_chars
suffix:semicolon
id|m-&gt;tty_modem.write_room
op_assign
id|isdn_tty_write_room
suffix:semicolon
id|m-&gt;tty_modem.chars_in_buffer
op_assign
id|isdn_tty_chars_in_buffer
suffix:semicolon
id|m-&gt;tty_modem.flush_buffer
op_assign
id|isdn_tty_flush_buffer
suffix:semicolon
id|m-&gt;tty_modem.ioctl
op_assign
id|isdn_tty_ioctl
suffix:semicolon
id|m-&gt;tty_modem.throttle
op_assign
id|isdn_tty_throttle
suffix:semicolon
id|m-&gt;tty_modem.unthrottle
op_assign
id|isdn_tty_unthrottle
suffix:semicolon
id|m-&gt;tty_modem.set_termios
op_assign
id|isdn_tty_set_termios
suffix:semicolon
id|m-&gt;tty_modem.stop
op_assign
l_int|NULL
suffix:semicolon
id|m-&gt;tty_modem.start
op_assign
l_int|NULL
suffix:semicolon
id|m-&gt;tty_modem.hangup
op_assign
id|isdn_tty_hangup
suffix:semicolon
id|m-&gt;tty_modem.driver_name
op_assign
l_string|&quot;isdn_tty&quot;
suffix:semicolon
multiline_comment|/*&n;&t; * The callout device is just like normal device except for&n;&t; * major number and the subtype code.&n;&t; */
id|m-&gt;cua_modem
op_assign
id|m-&gt;tty_modem
suffix:semicolon
id|m-&gt;cua_modem.name
op_assign
id|isdn_ttyname_cui
suffix:semicolon
id|m-&gt;cua_modem.major
op_assign
id|ISDN_TTYAUX_MAJOR
suffix:semicolon
id|m-&gt;tty_modem.minor_start
op_assign
l_int|0
suffix:semicolon
id|m-&gt;cua_modem.subtype
op_assign
id|ISDN_SERIAL_TYPE_CALLOUT
suffix:semicolon
r_if
c_cond
(paren
id|tty_register_driver
c_func
(paren
op_amp
id|m-&gt;tty_modem
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_tty: Couldn&squot;t register modem-device&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tty_register_driver
c_func
(paren
op_amp
id|m-&gt;cua_modem
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_tty: Couldn&squot;t register modem-callout-device&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|2
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_MAX_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|info
op_assign
op_amp
id|m-&gt;info
(braket
id|i
)braket
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_TTY_FAX
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;fax
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|T30_s
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Could not allocate fax t30-buffer&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|3
suffix:semicolon
)brace
macro_line|#endif
id|init_MUTEX
c_func
(paren
op_amp
id|info-&gt;write_sem
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|info-&gt;last_cause
comma
l_string|&quot;0000&quot;
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|info-&gt;last_num
comma
l_string|&quot;none&quot;
)paren
suffix:semicolon
id|info-&gt;last_dir
op_assign
l_int|0
suffix:semicolon
id|info-&gt;last_lhup
op_assign
l_int|1
suffix:semicolon
id|info-&gt;last_l2
op_assign
op_minus
l_int|1
suffix:semicolon
id|info-&gt;last_si
op_assign
l_int|0
suffix:semicolon
id|isdn_tty_reset_profile
c_func
(paren
op_amp
id|info-&gt;emu
)paren
suffix:semicolon
id|isdn_tty_modem_reset_regs
c_func
(paren
id|info
comma
l_int|1
)paren
suffix:semicolon
id|info-&gt;magic
op_assign
id|ISDN_ASYNC_MAGIC
suffix:semicolon
id|info-&gt;line
op_assign
id|i
suffix:semicolon
id|info-&gt;tty
op_assign
l_int|0
suffix:semicolon
id|info-&gt;x_char
op_assign
l_int|0
suffix:semicolon
id|info-&gt;count
op_assign
l_int|0
suffix:semicolon
id|info-&gt;blocked_open
op_assign
l_int|0
suffix:semicolon
id|info-&gt;callout_termios
op_assign
id|m-&gt;cua_modem.init_termios
suffix:semicolon
id|info-&gt;normal_termios
op_assign
id|m-&gt;tty_modem.init_termios
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|info-&gt;open_wait
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|info-&gt;close_wait
)paren
suffix:semicolon
id|info-&gt;isdn_driver
op_assign
op_minus
l_int|1
suffix:semicolon
id|info-&gt;isdn_channel
op_assign
op_minus
l_int|1
suffix:semicolon
id|info-&gt;drv_index
op_assign
op_minus
l_int|1
suffix:semicolon
id|info-&gt;xmit_size
op_assign
id|ISDN_SERIAL_XMIT_SIZE
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|info-&gt;xmit_queue
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_AUDIO
id|skb_queue_head_init
c_func
(paren
op_amp
id|info-&gt;dtmf_queue
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;xmit_buf
op_assign
id|kmalloc
c_func
(paren
id|ISDN_SERIAL_XMIT_MAX
op_plus
l_int|5
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Could not allocate modem xmit-buffer&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|3
suffix:semicolon
)brace
multiline_comment|/* Make room for T.70 header */
id|info-&gt;xmit_buf
op_add_assign
l_int|4
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * isdn_tty_match_icall(char *MSN, atemu *tty_emulator, int dev_idx)&n; *      match the MSN against the MSNs (glob patterns) defined for tty_emulator,&n; *      and return 0 for match, 1 for no match, 2 if MSN could match if longer.&n; */
r_static
r_int
DECL|function|isdn_tty_match_icall
id|isdn_tty_match_icall
c_func
(paren
r_char
op_star
id|cid
comma
id|atemu
op_star
id|emu
comma
r_int
id|di
)paren
(brace
macro_line|#ifdef ISDN_DEBUG_MODEM_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;m_fi: msn=%s lmsn=%s mmsn=%s mreg[SI1]=%d mreg[SI2]=%d&bslash;n&quot;
comma
id|emu-&gt;msn
comma
id|emu-&gt;lmsn
comma
id|isdn_map_eaz2msn
c_func
(paren
id|emu-&gt;msn
comma
id|di
)paren
comma
id|emu-&gt;mdmreg
(braket
id|REG_SI1
)braket
comma
id|emu-&gt;mdmreg
(braket
id|REG_SI2
)braket
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|emu-&gt;lmsn
)paren
)paren
(brace
r_char
op_star
id|p
op_assign
id|emu-&gt;lmsn
suffix:semicolon
r_char
op_star
id|q
suffix:semicolon
r_int
id|tmp
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
(paren
id|q
op_assign
id|strchr
c_func
(paren
id|p
comma
l_char|&squot;;&squot;
)paren
)paren
)paren
op_star
id|q
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_assign
id|isdn_msncmp
c_func
(paren
id|cid
comma
id|isdn_map_eaz2msn
c_func
(paren
id|p
comma
id|di
)paren
)paren
)paren
OG
id|ret
)paren
id|ret
op_assign
id|tmp
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;m_fi: lmsnX=%s mmsn=%s -&gt; tmp=%d&bslash;n&quot;
comma
id|p
comma
id|isdn_map_eaz2msn
c_func
(paren
id|emu-&gt;msn
comma
id|di
)paren
comma
id|tmp
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|q
)paren
(brace
op_star
id|q
op_assign
l_char|&squot;;&squot;
suffix:semicolon
id|p
op_assign
id|q
suffix:semicolon
id|p
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|tmp
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|q
)paren
r_break
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
r_else
(brace
r_int
id|tmp
suffix:semicolon
id|tmp
op_assign
id|isdn_msncmp
c_func
(paren
id|cid
comma
id|isdn_map_eaz2msn
c_func
(paren
id|emu-&gt;msn
comma
id|di
)paren
)paren
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;m_fi: mmsn=%s -&gt; tmp=%d&bslash;n&quot;
comma
id|isdn_map_eaz2msn
c_func
(paren
id|emu-&gt;msn
comma
id|di
)paren
comma
id|tmp
)paren
suffix:semicolon
macro_line|#endif
r_return
id|tmp
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * An incoming call-request has arrived.&n; * Search the tty-devices for an appropriate device and bind&n; * it to the ISDN-Channel.&n; * Return:&n; *&n; *  0 = No matching device found.&n; *  1 = A matching device found.&n; *  3 = No match found, but eventually would match, if&n; *      CID is longer.&n; */
r_int
DECL|function|isdn_tty_find_icall
id|isdn_tty_find_icall
c_func
(paren
r_int
id|di
comma
r_int
id|ch
comma
id|setup_parm
op_star
id|setup
)paren
(brace
r_char
op_star
id|eaz
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|wret
suffix:semicolon
r_int
id|idx
suffix:semicolon
r_int
id|si1
suffix:semicolon
r_int
id|si2
suffix:semicolon
r_char
op_star
id|nr
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|setup-&gt;phone
(braket
l_int|0
)braket
)paren
(brace
id|nr
op_assign
l_string|&quot;0&quot;
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdn_tty: Incoming call without OAD, assuming &squot;0&squot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
id|nr
op_assign
id|setup-&gt;phone
suffix:semicolon
id|si1
op_assign
(paren
r_int
)paren
id|setup-&gt;si1
suffix:semicolon
id|si2
op_assign
(paren
r_int
)paren
id|setup-&gt;si2
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|setup-&gt;eazmsn
(braket
l_int|0
)braket
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_tty: Incoming call without CPN, assuming &squot;0&squot;&bslash;n&quot;
)paren
suffix:semicolon
id|eaz
op_assign
l_string|&quot;0&quot;
suffix:semicolon
)brace
r_else
id|eaz
op_assign
id|setup-&gt;eazmsn
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;m_fi: eaz=%s si1=%d si2=%d&bslash;n&quot;
comma
id|eaz
comma
id|si1
comma
id|si2
)paren
suffix:semicolon
macro_line|#endif
id|wret
op_assign
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_MAX_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|modem_info
op_star
id|info
op_assign
op_amp
id|dev-&gt;mdm.info
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;count
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;emu.mdmreg
(braket
id|REG_SI1
)braket
op_amp
id|si2bit
(braket
id|si1
)braket
)paren
op_logical_and
multiline_comment|/* SI1 is matching */
(paren
id|info-&gt;emu.mdmreg
(braket
id|REG_SI2
)braket
op_eq
id|si2
)paren
)paren
(brace
multiline_comment|/* SI2 is matching */
id|idx
op_assign
id|isdn_dc2minor
c_func
(paren
id|di
comma
id|ch
)paren
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;m_fi: match1 wret=%d&bslash;n&quot;
comma
id|wret
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;m_fi: idx=%d flags=%08lx drv=%d ch=%d usg=%d&bslash;n&quot;
comma
id|idx
comma
id|info-&gt;flags
comma
id|info-&gt;isdn_driver
comma
id|info-&gt;isdn_channel
comma
id|dev-&gt;usage
(braket
id|idx
)braket
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
macro_line|#ifndef FIX_FILE_TRANSFER
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_NORMAL_ACTIVE
)paren
op_logical_and
macro_line|#endif
(paren
id|info-&gt;isdn_driver
op_eq
op_minus
l_int|1
)paren
op_logical_and
(paren
id|info-&gt;isdn_channel
op_eq
op_minus
l_int|1
)paren
op_logical_and
(paren
id|USG_NONE
c_func
(paren
id|dev-&gt;usage
(braket
id|idx
)braket
)paren
)paren
)paren
(brace
r_int
id|matchret
suffix:semicolon
r_if
c_cond
(paren
(paren
id|matchret
op_assign
id|isdn_tty_match_icall
c_func
(paren
id|eaz
comma
op_amp
id|info-&gt;emu
comma
id|di
)paren
)paren
OG
id|wret
)paren
id|wret
op_assign
id|matchret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|matchret
)paren
(brace
multiline_comment|/* EAZ is matching */
id|info-&gt;isdn_driver
op_assign
id|di
suffix:semicolon
id|info-&gt;isdn_channel
op_assign
id|ch
suffix:semicolon
id|info-&gt;drv_index
op_assign
id|idx
suffix:semicolon
id|dev-&gt;m_idx
(braket
id|idx
)braket
op_assign
id|info-&gt;line
suffix:semicolon
id|dev-&gt;usage
(braket
id|idx
)braket
op_and_assign
id|ISDN_USAGE_EXCLUSIVE
suffix:semicolon
id|dev-&gt;usage
(braket
id|idx
)braket
op_or_assign
id|isdn_calc_usage
c_func
(paren
id|si1
comma
id|info-&gt;emu.mdmreg
(braket
id|REG_L2PROT
)braket
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|dev-&gt;num
(braket
id|idx
)braket
comma
id|nr
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|info-&gt;emu.cpn
comma
id|eaz
)paren
suffix:semicolon
id|info-&gt;emu.mdmreg
(braket
id|REG_SI1I
)braket
op_assign
id|si2bit
(braket
id|si1
)braket
suffix:semicolon
id|info-&gt;emu.mdmreg
(braket
id|REG_PLAN
)braket
op_assign
id|setup-&gt;plan
suffix:semicolon
id|info-&gt;emu.mdmreg
(braket
id|REG_SCREEN
)braket
op_assign
id|setup-&gt;screen
suffix:semicolon
id|isdn_info_update
c_func
(paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdn_tty: call from %s, -&gt; RING on ttyI%d&bslash;n&quot;
comma
id|nr
comma
id|info-&gt;line
)paren
suffix:semicolon
id|info-&gt;msr
op_or_assign
id|UART_MSR_RI
suffix:semicolon
id|isdn_tty_modem_result
c_func
(paren
id|RESULT_RING
comma
id|info
)paren
suffix:semicolon
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_MODEMRING
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdn_tty: call from %s -&gt; %s %s&bslash;n&quot;
comma
id|nr
comma
id|eaz
comma
(paren
(paren
id|dev-&gt;drv
(braket
id|di
)braket
op_member_access_from_pointer
id|flags
op_amp
id|DRV_FLAG_REJBUS
)paren
op_logical_and
(paren
id|wret
op_ne
l_int|2
)paren
)paren
ques
c_cond
l_string|&quot;rejected&quot;
suffix:colon
l_string|&quot;ignored&quot;
)paren
suffix:semicolon
r_return
(paren
id|wret
op_eq
l_int|2
)paren
ques
c_cond
l_int|3
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|macro|TTY_IS_ACTIVE
mdefine_line|#define TTY_IS_ACTIVE(info) &bslash;&n;&t;(info-&gt;flags &amp; (ISDN_ASYNC_NORMAL_ACTIVE | ISDN_ASYNC_CALLOUT_ACTIVE))
r_int
DECL|function|isdn_tty_stat_callback
id|isdn_tty_stat_callback
c_func
(paren
r_int
id|i
comma
id|isdn_ctrl
op_star
id|c
)paren
(brace
r_int
id|mi
suffix:semicolon
id|modem_info
op_star
id|info
suffix:semicolon
r_char
op_star
id|e
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mi
op_assign
id|dev-&gt;m_idx
(braket
id|i
)braket
)paren
op_ge
l_int|0
)paren
(brace
id|info
op_assign
op_amp
id|dev-&gt;mdm.info
(braket
id|mi
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|c-&gt;command
)paren
(brace
r_case
id|ISDN_STAT_CINF
suffix:colon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;CHARGEINFO on ttyI%d: %ld %s&bslash;n&quot;
comma
id|info-&gt;line
comma
id|c-&gt;arg
comma
id|c-&gt;parm.num
)paren
suffix:semicolon
id|info-&gt;emu.charge
op_assign
(paren
r_int
)paren
id|simple_strtoul
c_func
(paren
id|c-&gt;parm.num
comma
op_amp
id|e
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|e
op_eq
(paren
r_char
op_star
)paren
id|c-&gt;parm.num
)paren
id|info-&gt;emu.charge
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_STAT_BSENT
suffix:colon
macro_line|#ifdef ISDN_TTY_STAT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;tty_STAT_BSENT ttyI%d&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|info-&gt;isdn_driver
op_eq
id|c-&gt;driver
)paren
op_logical_and
(paren
id|info-&gt;isdn_channel
op_eq
id|c-&gt;arg
)paren
)paren
(brace
id|info-&gt;msr
op_or_assign
id|UART_MSR_CTS
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;send_outstanding
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
op_decrement
id|info-&gt;send_outstanding
)paren
)paren
id|info-&gt;lsr
op_or_assign
id|UART_LSR_TEMT
suffix:semicolon
id|isdn_tty_tint
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_STAT_CAUSE
suffix:colon
macro_line|#ifdef ISDN_TTY_STAT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;tty_STAT_CAUSE ttyI%d&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Signal cause to tty-device */
id|strncpy
c_func
(paren
id|info-&gt;last_cause
comma
id|c-&gt;parm.num
comma
l_int|5
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
r_case
id|ISDN_STAT_DISPLAY
suffix:colon
macro_line|#ifdef ISDN_TTY_STAT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;tty_STAT_DISPLAY ttyI%d&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Signal display to tty-device */
r_if
c_cond
(paren
(paren
id|info-&gt;emu.mdmreg
(braket
id|REG_DISPLAY
)braket
op_amp
id|BIT_DISPLAY
)paren
op_logical_and
op_logical_neg
(paren
id|info-&gt;emu.mdmreg
(braket
id|REG_RESPNUM
)braket
op_amp
id|BIT_RESPNUM
)paren
)paren
(brace
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;&bslash;r&bslash;n&quot;
comma
id|info
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;DISPLAY: &quot;
comma
id|info
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|c-&gt;parm.display
comma
id|info
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;&bslash;r&bslash;n&quot;
comma
id|info
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
r_case
id|ISDN_STAT_DCONN
suffix:colon
macro_line|#ifdef ISDN_TTY_STAT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;tty_STAT_DCONN ttyI%d&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|TTY_IS_ACTIVE
c_func
(paren
id|info
)paren
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;dialing
op_eq
l_int|1
)paren
(brace
id|info-&gt;dialing
op_assign
l_int|2
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|ISDN_STAT_DHUP
suffix:colon
macro_line|#ifdef ISDN_TTY_STAT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;tty_STAT_DHUP ttyI%d&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|TTY_IS_ACTIVE
c_func
(paren
id|info
)paren
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;dialing
op_eq
l_int|1
)paren
id|isdn_tty_modem_result
c_func
(paren
id|RESULT_BUSY
comma
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;dialing
OG
l_int|1
)paren
id|isdn_tty_modem_result
c_func
(paren
id|RESULT_NO_CARRIER
comma
id|info
)paren
suffix:semicolon
id|info-&gt;dialing
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_HUP
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Mhup in ISDN_STAT_DHUP&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|isdn_tty_modem_hup
c_func
(paren
id|info
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_STAT_BCONN
suffix:colon
macro_line|#ifdef ISDN_TTY_STAT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;tty_STAT_BCONN ttyI%d&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Wake up any processes waiting&n;&t;&t;&t;&t; * for incoming call of this device when&n;&t;&t;&t;&t; * DCD follow the state of incoming carrier&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|info-&gt;blocked_open
op_logical_and
(paren
id|info-&gt;emu.mdmreg
(braket
id|REG_DCD
)braket
op_amp
id|BIT_DCD
)paren
)paren
(brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;open_wait
)paren
suffix:semicolon
)brace
multiline_comment|/* Schedule CONNECT-Message to any tty&n;&t;&t;&t;&t; * waiting for it and&n;&t;&t;&t;&t; * set DCD-bit of its modem-status.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|TTY_IS_ACTIVE
c_func
(paren
id|info
)paren
op_logical_or
(paren
id|info-&gt;blocked_open
op_logical_and
(paren
id|info-&gt;emu.mdmreg
(braket
id|REG_DCD
)braket
op_amp
id|BIT_DCD
)paren
)paren
)paren
(brace
id|info-&gt;msr
op_or_assign
id|UART_MSR_DCD
suffix:semicolon
id|info-&gt;emu.charge
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;dialing
op_amp
l_int|0xf
)paren
id|info-&gt;last_dir
op_assign
l_int|1
suffix:semicolon
r_else
id|info-&gt;last_dir
op_assign
l_int|0
suffix:semicolon
id|info-&gt;dialing
op_assign
l_int|0
suffix:semicolon
id|info-&gt;rcvsched
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|USG_MODEM
c_func
(paren
id|dev-&gt;usage
(braket
id|i
)braket
)paren
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;emu.mdmreg
(braket
id|REG_L2PROT
)braket
op_eq
id|ISDN_PROTO_L2_MODEM
)paren
(brace
id|strcpy
c_func
(paren
id|info-&gt;emu.connmsg
comma
id|c-&gt;parm.num
)paren
suffix:semicolon
id|isdn_tty_modem_result
c_func
(paren
id|RESULT_CONNECT
comma
id|info
)paren
suffix:semicolon
)brace
r_else
id|isdn_tty_modem_result
c_func
(paren
id|RESULT_CONNECT64000
comma
id|info
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|USG_VOICE
c_func
(paren
id|dev-&gt;usage
(braket
id|i
)braket
)paren
)paren
id|isdn_tty_modem_result
c_func
(paren
id|RESULT_VCON
comma
id|info
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_STAT_BHUP
suffix:colon
macro_line|#ifdef ISDN_TTY_STAT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;tty_STAT_BHUP ttyI%d&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|TTY_IS_ACTIVE
c_func
(paren
id|info
)paren
)paren
(brace
macro_line|#ifdef ISDN_DEBUG_MODEM_HUP
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Mhup in ISDN_STAT_BHUP&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|isdn_tty_modem_hup
c_func
(paren
id|info
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_STAT_NODCH
suffix:colon
macro_line|#ifdef ISDN_TTY_STAT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;tty_STAT_NODCH ttyI%d&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|TTY_IS_ACTIVE
c_func
(paren
id|info
)paren
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;dialing
)paren
(brace
id|info-&gt;dialing
op_assign
l_int|0
suffix:semicolon
id|info-&gt;last_l2
op_assign
op_minus
l_int|1
suffix:semicolon
id|info-&gt;last_si
op_assign
l_int|0
suffix:semicolon
id|sprintf
c_func
(paren
id|info-&gt;last_cause
comma
l_string|&quot;0000&quot;
)paren
suffix:semicolon
id|isdn_tty_modem_result
c_func
(paren
id|RESULT_NO_DIALTONE
comma
id|info
)paren
suffix:semicolon
)brace
id|isdn_tty_modem_hup
c_func
(paren
id|info
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_STAT_UNLOAD
suffix:colon
macro_line|#ifdef ISDN_TTY_STAT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;tty_STAT_UNLOAD ttyI%d&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_MAX_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|info
op_assign
op_amp
id|dev-&gt;mdm.info
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;isdn_driver
op_eq
id|c-&gt;driver
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;online
)paren
id|isdn_tty_modem_hup
c_func
(paren
id|info
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_TTY_FAX
r_case
id|ISDN_STAT_FAXIND
suffix:colon
r_if
c_cond
(paren
id|TTY_IS_ACTIVE
c_func
(paren
id|info
)paren
)paren
(brace
id|isdn_tty_fax_command
c_func
(paren
id|info
comma
id|c
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ISDN_AUDIO
r_case
id|ISDN_STAT_AUDIO
suffix:colon
r_if
c_cond
(paren
id|TTY_IS_ACTIVE
c_func
(paren
id|info
)paren
)paren
(brace
r_switch
c_cond
(paren
id|c-&gt;parm.num
(braket
l_int|0
)braket
)paren
(brace
r_case
id|ISDN_AUDIO_DTMF
suffix:colon
r_if
c_cond
(paren
id|info-&gt;vonline
)paren
(brace
id|isdn_audio_put_dle_code
c_func
(paren
id|info
comma
id|c-&gt;parm.num
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
macro_line|#endif
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*********************************************************************&n; Modem-Emulator-Routines&n; *********************************************************************/
DECL|macro|cmdchar
mdefine_line|#define cmdchar(c) ((c&gt;=&squot; &squot;)&amp;&amp;(c&lt;=0x7f))
multiline_comment|/*&n; * Put a message from the AT-emulator into receive-buffer of tty,&n; * convert CR, LF, and BS to values in modem-registers 3, 4 and 5.&n; */
r_void
DECL|function|isdn_tty_at_cout
id|isdn_tty_at_cout
c_func
(paren
r_char
op_star
id|msg
comma
id|modem_info
op_star
id|info
)paren
(brace
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
id|atemu
op_star
id|m
op_assign
op_amp
id|info-&gt;emu
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_char
id|c
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|sp
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|msg
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_tty: Null-Message in isdn_tty_at_cout&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|tty
op_assign
id|info-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_CLOSING
)paren
op_logical_or
(paren
op_logical_neg
id|tty
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* use queue instead of direct flip, if online and */
multiline_comment|/* data is in queue or flip buffer is full */
r_if
c_cond
(paren
(paren
id|info-&gt;online
)paren
op_logical_and
(paren
(paren
(paren
id|tty-&gt;flip.count
op_plus
id|strlen
c_func
(paren
id|msg
)paren
)paren
op_ge
id|TTY_FLIPBUF_SIZE
)paren
op_logical_or
(paren
op_logical_neg
id|skb_queue_empty
c_func
(paren
op_amp
id|dev-&gt;drv
(braket
id|info-&gt;isdn_driver
)braket
op_member_access_from_pointer
id|rpqueue
(braket
id|info-&gt;isdn_channel
)braket
)paren
)paren
)paren
)paren
(brace
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|strlen
c_func
(paren
id|msg
)paren
macro_line|#ifdef CONFIG_ISDN_AUDIO
op_plus
r_sizeof
(paren
id|isdn_audio_skb
)paren
macro_line|#endif
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ISDN_AUDIO
id|skb_reserve
c_func
(paren
id|skb
comma
r_sizeof
(paren
id|isdn_audio_skb
)paren
)paren
suffix:semicolon
macro_line|#endif
id|sp
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|strlen
c_func
(paren
id|msg
)paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_AUDIO
id|ISDN_AUDIO_SKB_DLECOUNT
c_func
(paren
id|skb
)paren
op_assign
l_int|0
suffix:semicolon
id|ISDN_AUDIO_SKB_LOCK
c_func
(paren
id|skb
)paren
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
)brace
r_for
c_loop
(paren
id|p
op_assign
id|msg
suffix:semicolon
op_star
id|p
suffix:semicolon
id|p
op_increment
)paren
(brace
r_switch
c_cond
(paren
op_star
id|p
)paren
(brace
r_case
l_char|&squot;&bslash;r&squot;
suffix:colon
id|c
op_assign
id|m-&gt;mdmreg
(braket
id|REG_CR
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;&bslash;n&squot;
suffix:colon
id|c
op_assign
id|m-&gt;mdmreg
(braket
id|REG_LF
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;&bslash;b&squot;
suffix:colon
id|c
op_assign
id|m-&gt;mdmreg
(braket
id|REG_BS
)braket
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|c
op_assign
op_star
id|p
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb
)paren
(brace
op_star
id|sp
op_increment
op_assign
id|c
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|tty-&gt;flip.count
op_ge
id|TTY_FLIPBUF_SIZE
)paren
r_break
suffix:semicolon
id|tty_insert_flip_char
c_func
(paren
id|tty
comma
id|c
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|skb
)paren
(brace
id|__skb_queue_tail
c_func
(paren
op_amp
id|dev-&gt;drv
(braket
id|info-&gt;isdn_driver
)braket
op_member_access_from_pointer
id|rpqueue
(braket
id|info-&gt;isdn_channel
)braket
comma
id|skb
)paren
suffix:semicolon
id|dev-&gt;drv
(braket
id|info-&gt;isdn_driver
)braket
op_member_access_from_pointer
id|rcvcount
(braket
id|info-&gt;isdn_channel
)braket
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Schedule dequeuing */
r_if
c_cond
(paren
(paren
id|dev-&gt;modempoll
)paren
op_logical_and
(paren
id|info-&gt;rcvsched
)paren
)paren
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_MODEMREAD
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|tty-&gt;flip.tqueue
comma
op_amp
id|tq_timer
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Perform ATH Hangup&n; */
r_static
r_void
DECL|function|isdn_tty_on_hook
id|isdn_tty_on_hook
c_func
(paren
id|modem_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;isdn_channel
op_ge
l_int|0
)paren
(brace
macro_line|#ifdef ISDN_DEBUG_MODEM_HUP
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Mhup in isdn_tty_on_hook&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|isdn_tty_modem_hup
c_func
(paren
id|info
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|isdn_tty_off_hook
id|isdn_tty_off_hook
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_tty_off_hook&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|macro|PLUSWAIT1
mdefine_line|#define PLUSWAIT1 (HZ/2)        /* 0.5 sec. */
DECL|macro|PLUSWAIT2
mdefine_line|#define PLUSWAIT2 (HZ*3/2)      /* 1.5 sec */
multiline_comment|/*&n; * Check Buffer for Modem-escape-sequence, activate timer-callback to&n; * isdn_tty_modem_escape() if sequence found.&n; *&n; * Parameters:&n; *   p          pointer to databuffer&n; *   plus       escape-character&n; *   count      length of buffer&n; *   pluscount  count of valid escape-characters so far&n; *   lastplus   timestamp of last character&n; */
r_static
r_void
DECL|function|isdn_tty_check_esc
id|isdn_tty_check_esc
c_func
(paren
r_const
id|u_char
op_star
id|p
comma
id|u_char
id|plus
comma
r_int
id|count
comma
r_int
op_star
id|pluscount
comma
r_int
op_star
id|lastplus
comma
r_int
id|from_user
)paren
(brace
r_char
id|cbuf
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|plus
OG
l_int|127
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
l_int|3
)paren
(brace
id|p
op_add_assign
id|count
op_minus
l_int|3
suffix:semicolon
id|count
op_assign
l_int|3
suffix:semicolon
op_star
id|pluscount
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|from_user
)paren
(brace
id|copy_from_user
c_func
(paren
id|cbuf
comma
id|p
comma
id|count
)paren
suffix:semicolon
id|p
op_assign
id|cbuf
suffix:semicolon
)brace
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_star
(paren
id|p
op_increment
)paren
op_eq
id|plus
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|pluscount
)paren
op_increment
)paren
(brace
multiline_comment|/* Time since last &squot;+&squot; &gt; 0.5 sec. ? */
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
op_star
id|lastplus
)paren
OG
id|PLUSWAIT1
)paren
op_star
id|pluscount
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Time since last non-&squot;+&squot; &lt; 1.5 sec. ? */
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
op_star
id|lastplus
)paren
OL
id|PLUSWAIT2
)paren
op_star
id|pluscount
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
op_star
id|pluscount
op_eq
l_int|3
)paren
op_logical_and
(paren
id|count
op_eq
l_int|1
)paren
)paren
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_MODEMPLUS
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|pluscount
OG
l_int|3
)paren
op_star
id|pluscount
op_assign
l_int|1
suffix:semicolon
)brace
r_else
op_star
id|pluscount
op_assign
l_int|0
suffix:semicolon
op_star
id|lastplus
op_assign
id|jiffies
suffix:semicolon
id|count
op_decrement
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Return result of AT-emulator to tty-receive-buffer, depending on&n; * modem-register 12, bit 0 and 1.&n; * For CONNECT-messages also switch to online-mode.&n; * For RING-message handle auto-ATA if register 0 != 0&n; */
r_static
r_void
DECL|function|isdn_tty_modem_result
id|isdn_tty_modem_result
c_func
(paren
r_int
id|code
comma
id|modem_info
op_star
id|info
)paren
(brace
id|atemu
op_star
id|m
op_assign
op_amp
id|info-&gt;emu
suffix:semicolon
r_static
r_char
op_star
id|msg
(braket
)braket
op_assign
(brace
l_string|&quot;OK&quot;
comma
l_string|&quot;CONNECT&quot;
comma
l_string|&quot;RING&quot;
comma
l_string|&quot;NO CARRIER&quot;
comma
l_string|&quot;ERROR&quot;
comma
l_string|&quot;CONNECT 64000&quot;
comma
l_string|&quot;NO DIALTONE&quot;
comma
l_string|&quot;BUSY&quot;
comma
l_string|&quot;NO ANSWER&quot;
comma
l_string|&quot;RINGING&quot;
comma
l_string|&quot;NO MSN/EAZ&quot;
comma
l_string|&quot;VCON&quot;
comma
l_string|&quot;RUNG&quot;
)brace
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
r_char
id|s
(braket
id|ISDN_MSNLEN
op_plus
l_int|10
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|code
)paren
(brace
r_case
id|RESULT_RING
suffix:colon
id|m-&gt;mdmreg
(braket
id|REG_RINGCNT
)braket
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|m-&gt;mdmreg
(braket
id|REG_RINGCNT
)braket
op_eq
id|m-&gt;mdmreg
(braket
id|REG_RINGATA
)braket
)paren
multiline_comment|/* Automatically accept incoming call */
id|isdn_tty_cmd_ATA
c_func
(paren
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RESULT_NO_CARRIER
suffix:colon
macro_line|#ifdef ISDN_DEBUG_MODEM_HUP
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;modem_result: NO CARRIER %d %d&bslash;n&quot;
comma
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_CLOSING
)paren
comma
(paren
op_logical_neg
id|info-&gt;tty
)paren
)paren
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|m-&gt;mdmreg
(braket
id|REG_RINGCNT
)braket
op_assign
l_int|0
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|info-&gt;nc_timer
)paren
suffix:semicolon
id|info-&gt;ncarrier
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_CLOSING
)paren
op_logical_or
(paren
op_logical_neg
id|info-&gt;tty
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_AUDIO
r_if
c_cond
(paren
id|info-&gt;vonline
op_amp
l_int|1
)paren
(brace
macro_line|#ifdef ISDN_DEBUG_MODEM_VOICE
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;res3: send DLE-ETX on ttyI%d&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* voice-recording, add DLE-ETX */
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;&bslash;020&bslash;003&quot;
comma
id|info
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;vonline
op_amp
l_int|2
)paren
(brace
macro_line|#ifdef ISDN_DEBUG_MODEM_VOICE
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;res3: send DLE-DC4 on ttyI%d&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* voice-playing, add DLE-DC4 */
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;&bslash;020&bslash;024&quot;
comma
id|info
)paren
suffix:semicolon
)brace
macro_line|#endif
r_break
suffix:semicolon
r_case
id|RESULT_CONNECT
suffix:colon
r_case
id|RESULT_CONNECT64000
suffix:colon
id|sprintf
c_func
(paren
id|info-&gt;last_cause
comma
l_string|&quot;0000&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;online
)paren
id|info-&gt;online
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RESULT_VCON
suffix:colon
macro_line|#ifdef ISDN_DEBUG_MODEM_VOICE
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;res3: send VCON on ttyI%d&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
id|sprintf
c_func
(paren
id|info-&gt;last_cause
comma
l_string|&quot;0000&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;online
)paren
id|info-&gt;online
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* switch(code) */
r_if
c_cond
(paren
id|m-&gt;mdmreg
(braket
id|REG_RESP
)braket
op_amp
id|BIT_RESP
)paren
(brace
multiline_comment|/* Show results */
r_if
c_cond
(paren
id|m-&gt;mdmreg
(braket
id|REG_RESPNUM
)braket
op_amp
id|BIT_RESPNUM
)paren
(brace
multiline_comment|/* Show numeric results only */
id|sprintf
c_func
(paren
id|s
comma
l_string|&quot;&bslash;r&bslash;n%d&bslash;r&bslash;n&quot;
comma
id|code
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|s
comma
id|info
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|code
op_eq
id|RESULT_RING
)paren
(brace
multiline_comment|/* return if &quot;show RUNG&quot; and ringcounter&gt;1 */
r_if
c_cond
(paren
(paren
id|m-&gt;mdmreg
(braket
id|REG_RUNG
)braket
op_amp
id|BIT_RUNG
)paren
op_logical_and
(paren
id|m-&gt;mdmreg
(braket
id|REG_RINGCNT
)braket
OG
l_int|1
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* print CID, _before_ _every_ ring */
r_if
c_cond
(paren
op_logical_neg
(paren
id|m-&gt;mdmreg
(braket
id|REG_CIDONCE
)braket
op_amp
id|BIT_CIDONCE
)paren
)paren
(brace
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;&bslash;r&bslash;nCALLER NUMBER: &quot;
comma
id|info
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|dev-&gt;num
(braket
id|info-&gt;drv_index
)braket
comma
id|info
)paren
suffix:semicolon
)brace
)brace
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;&bslash;r&bslash;n&quot;
comma
id|info
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|msg
(braket
id|code
)braket
comma
id|info
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|code
)paren
(brace
r_case
id|RESULT_CONNECT
suffix:colon
r_switch
c_cond
(paren
id|m-&gt;mdmreg
(braket
id|REG_L2PROT
)braket
)paren
(brace
r_case
id|ISDN_PROTO_L2_MODEM
suffix:colon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot; &quot;
comma
id|info
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|m-&gt;connmsg
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RESULT_RING
suffix:colon
multiline_comment|/* Append CPN, if enabled */
r_if
c_cond
(paren
(paren
id|m-&gt;mdmreg
(braket
id|REG_CPN
)braket
op_amp
id|BIT_CPN
)paren
)paren
(brace
id|sprintf
c_func
(paren
id|s
comma
l_string|&quot;/%s&quot;
comma
id|m-&gt;cpn
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|s
comma
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/* Print CID only once, _after_ 1st RING */
r_if
c_cond
(paren
(paren
id|m-&gt;mdmreg
(braket
id|REG_CIDONCE
)braket
op_amp
id|BIT_CIDONCE
)paren
op_logical_and
(paren
id|m-&gt;mdmreg
(braket
id|REG_RINGCNT
)braket
op_eq
l_int|1
)paren
)paren
(brace
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;&bslash;r&bslash;n&quot;
comma
id|info
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;CALLER NUMBER: &quot;
comma
id|info
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|dev-&gt;num
(braket
id|info-&gt;drv_index
)braket
comma
id|info
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RESULT_NO_CARRIER
suffix:colon
r_case
id|RESULT_NO_DIALTONE
suffix:colon
r_case
id|RESULT_BUSY
suffix:colon
r_case
id|RESULT_NO_ANSWER
suffix:colon
id|m-&gt;mdmreg
(braket
id|REG_RINGCNT
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Append Cause-Message if enabled */
r_if
c_cond
(paren
id|m-&gt;mdmreg
(braket
id|REG_RESPXT
)braket
op_amp
id|BIT_RESPXT
)paren
(brace
id|sprintf
c_func
(paren
id|s
comma
l_string|&quot;/%s&quot;
comma
id|info-&gt;last_cause
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|s
comma
id|info
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RESULT_CONNECT64000
suffix:colon
multiline_comment|/* Append Protocol to CONNECT message */
r_switch
c_cond
(paren
id|m-&gt;mdmreg
(braket
id|REG_L2PROT
)braket
)paren
(brace
r_case
id|ISDN_PROTO_L2_X75I
suffix:colon
r_case
id|ISDN_PROTO_L2_X75UI
suffix:colon
r_case
id|ISDN_PROTO_L2_X75BUI
suffix:colon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;/X.75&quot;
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_PROTO_L2_HDLC
suffix:colon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;/HDLC&quot;
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_PROTO_L2_V11096
suffix:colon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;/V110/9600&quot;
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_PROTO_L2_V11019
suffix:colon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;/V110/19200&quot;
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_PROTO_L2_V11038
suffix:colon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;/V110/38400&quot;
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|m-&gt;mdmreg
(braket
id|REG_T70
)braket
op_amp
id|BIT_T70
)paren
(brace
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;/T.70&quot;
comma
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m-&gt;mdmreg
(braket
id|REG_T70
)braket
op_amp
id|BIT_T70_EXT
)paren
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;+&quot;
comma
id|info
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;&bslash;r&bslash;n&quot;
comma
id|info
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|code
op_eq
id|RESULT_NO_CARRIER
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_CLOSING
)paren
op_logical_or
(paren
op_logical_neg
id|info-&gt;tty
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;tty-&gt;ldisc.flush_buffer
)paren
id|info-&gt;tty-&gt;ldisc
dot
id|flush_buffer
c_func
(paren
id|info-&gt;tty
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_CHECK_CD
)paren
op_logical_and
(paren
op_logical_neg
(paren
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_CALLOUT_ACTIVE
)paren
op_logical_and
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_CALLOUT_NOHUP
)paren
)paren
)paren
)paren
(brace
id|tty_hangup
c_func
(paren
id|info-&gt;tty
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Display a modem-register-value.&n; */
r_static
r_void
DECL|function|isdn_tty_show_profile
id|isdn_tty_show_profile
c_func
(paren
r_int
id|ridx
comma
id|modem_info
op_star
id|info
)paren
(brace
r_char
id|v
(braket
l_int|6
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|v
comma
l_string|&quot;&bslash;r&bslash;n%d&quot;
comma
id|info-&gt;emu.mdmreg
(braket
id|ridx
)braket
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|v
comma
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Get MSN-string from char-pointer, set pointer to end of number&n; */
r_static
r_void
DECL|function|isdn_tty_get_msnstr
id|isdn_tty_get_msnstr
c_func
(paren
r_char
op_star
id|n
comma
r_char
op_star
op_star
id|p
)paren
(brace
r_int
id|limit
op_assign
id|ISDN_MSNLEN
op_minus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
op_star
id|p
(braket
l_int|0
)braket
op_ge
l_char|&squot;0&squot;
op_logical_and
op_star
id|p
(braket
l_int|0
)braket
op_le
l_char|&squot;9&squot;
)paren
op_logical_or
multiline_comment|/* Why a comma ??? */
(paren
op_star
id|p
(braket
l_int|0
)braket
op_eq
l_char|&squot;,&squot;
)paren
op_logical_or
(paren
op_star
id|p
(braket
l_int|0
)braket
op_eq
l_char|&squot;:&squot;
)paren
)paren
op_logical_and
(paren
id|limit
op_decrement
)paren
)paren
op_star
id|n
op_increment
op_assign
op_star
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
op_star
id|n
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
multiline_comment|/*&n; * Get phone-number from modem-commandbuffer&n; */
r_static
r_void
DECL|function|isdn_tty_getdial
id|isdn_tty_getdial
c_func
(paren
r_char
op_star
id|p
comma
r_char
op_star
id|q
comma
r_int
id|cnt
)paren
(brace
r_int
id|first
op_assign
l_int|1
suffix:semicolon
r_int
id|limit
op_assign
id|ISDN_MSNLEN
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* MUST match the size of interface var to avoid&n;&t;&t;&t;&t;&t;buffer overflow */
r_while
c_loop
(paren
id|strchr
c_func
(paren
l_string|&quot; 0123456789,#.*WPTS-&quot;
comma
op_star
id|p
)paren
op_logical_and
op_star
id|p
op_logical_and
op_decrement
id|cnt
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|p
op_ge
l_char|&squot;0&squot;
op_logical_and
op_star
id|p
op_le
l_char|&squot;9&squot;
)paren
op_logical_or
(paren
(paren
op_star
id|p
op_eq
l_char|&squot;S&squot;
)paren
op_logical_and
id|first
)paren
op_logical_or
(paren
op_star
id|p
op_eq
l_char|&squot;*&squot;
)paren
op_logical_or
(paren
op_star
id|p
op_eq
l_char|&squot;#&squot;
)paren
)paren
(brace
op_star
id|q
op_increment
op_assign
op_star
id|p
suffix:semicolon
id|limit
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|limit
)paren
(brace
r_break
suffix:semicolon
)brace
id|p
op_increment
suffix:semicolon
id|first
op_assign
l_int|0
suffix:semicolon
)brace
op_star
id|q
op_assign
l_int|0
suffix:semicolon
)brace
DECL|macro|PARSE_ERROR
mdefine_line|#define PARSE_ERROR { isdn_tty_modem_result(RESULT_ERROR, info); return; }
DECL|macro|PARSE_ERROR1
mdefine_line|#define PARSE_ERROR1 { isdn_tty_modem_result(RESULT_ERROR, info); return 1; }
r_static
r_void
DECL|function|isdn_tty_report
id|isdn_tty_report
c_func
(paren
id|modem_info
op_star
id|info
)paren
(brace
id|atemu
op_star
id|m
op_assign
op_amp
id|info-&gt;emu
suffix:semicolon
r_char
id|s
(braket
l_int|80
)braket
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;&bslash;r&bslash;nStatistics of last connection:&bslash;r&bslash;n&bslash;r&bslash;n&quot;
comma
id|info
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|s
comma
l_string|&quot;    Remote Number:    %s&bslash;r&bslash;n&quot;
comma
id|info-&gt;last_num
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|s
comma
id|info
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|s
comma
l_string|&quot;    Direction:        %s&bslash;r&bslash;n&quot;
comma
id|info-&gt;last_dir
ques
c_cond
l_string|&quot;outgoing&quot;
suffix:colon
l_string|&quot;incoming&quot;
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|s
comma
id|info
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;    Layer-2 Protocol: &quot;
comma
id|info
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|info-&gt;last_l2
)paren
(brace
r_case
id|ISDN_PROTO_L2_X75I
suffix:colon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;X.75i&quot;
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_PROTO_L2_X75UI
suffix:colon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;X.75ui&quot;
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_PROTO_L2_X75BUI
suffix:colon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;X.75bui&quot;
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_PROTO_L2_HDLC
suffix:colon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;HDLC&quot;
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_PROTO_L2_V11096
suffix:colon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;V.110 9600 Baud&quot;
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_PROTO_L2_V11019
suffix:colon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;V.110 19200 Baud&quot;
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_PROTO_L2_V11038
suffix:colon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;V.110 38400 Baud&quot;
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_PROTO_L2_TRANS
suffix:colon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;transparent&quot;
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_PROTO_L2_MODEM
suffix:colon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;modem&quot;
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_PROTO_L2_FAX
suffix:colon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;fax&quot;
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;unknown&quot;
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|m-&gt;mdmreg
(braket
id|REG_T70
)braket
op_amp
id|BIT_T70
)paren
(brace
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;/T.70&quot;
comma
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m-&gt;mdmreg
(braket
id|REG_T70
)braket
op_amp
id|BIT_T70_EXT
)paren
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;+&quot;
comma
id|info
)paren
suffix:semicolon
)brace
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;&bslash;r&bslash;n&quot;
comma
id|info
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;    Service:          &quot;
comma
id|info
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|info-&gt;last_si
)paren
(brace
r_case
l_int|1
suffix:colon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;audio&bslash;r&bslash;n&quot;
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;btx&bslash;r&bslash;n&quot;
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;data&bslash;r&bslash;n&quot;
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|sprintf
c_func
(paren
id|s
comma
l_string|&quot;%d&bslash;r&bslash;n&quot;
comma
id|info-&gt;last_si
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|s
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|sprintf
c_func
(paren
id|s
comma
l_string|&quot;    Hangup location:  %s&bslash;r&bslash;n&quot;
comma
id|info-&gt;last_lhup
ques
c_cond
l_string|&quot;local&quot;
suffix:colon
l_string|&quot;remote&quot;
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|s
comma
id|info
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|s
comma
l_string|&quot;    Last cause:       %s&bslash;r&bslash;n&quot;
comma
id|info-&gt;last_cause
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|s
comma
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Parse AT&amp;.. commands.&n; */
r_static
r_int
DECL|function|isdn_tty_cmd_ATand
id|isdn_tty_cmd_ATand
c_func
(paren
r_char
op_star
op_star
id|p
comma
id|modem_info
op_star
id|info
)paren
(brace
id|atemu
op_star
id|m
op_assign
op_amp
id|info-&gt;emu
suffix:semicolon
r_int
id|i
suffix:semicolon
r_char
id|rb
(braket
l_int|100
)braket
suffix:semicolon
DECL|macro|MAXRB
mdefine_line|#define MAXRB (sizeof(rb) - 1)
r_switch
c_cond
(paren
op_star
id|p
(braket
l_int|0
)braket
)paren
(brace
r_case
l_char|&squot;B&squot;
suffix:colon
multiline_comment|/* &amp;B - Set Buffersize */
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|i
op_assign
id|isdn_getnum
c_func
(paren
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
OL
l_int|0
)paren
op_logical_or
(paren
id|i
OG
id|ISDN_SERIAL_XMIT_MAX
)paren
)paren
id|PARSE_ERROR1
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_AUDIO
r_if
c_cond
(paren
(paren
id|m-&gt;mdmreg
(braket
id|REG_SI1
)braket
op_amp
l_int|1
)paren
op_logical_and
(paren
id|i
OG
id|VBUF
)paren
)paren
id|PARSE_ERROR1
suffix:semicolon
macro_line|#endif
id|m-&gt;mdmreg
(braket
id|REG_PSIZE
)braket
op_assign
id|i
op_div
l_int|16
suffix:semicolon
id|info-&gt;xmit_size
op_assign
id|m-&gt;mdmreg
(braket
id|REG_PSIZE
)braket
op_star
l_int|16
suffix:semicolon
r_switch
c_cond
(paren
id|m-&gt;mdmreg
(braket
id|REG_L2PROT
)braket
)paren
(brace
r_case
id|ISDN_PROTO_L2_V11096
suffix:colon
r_case
id|ISDN_PROTO_L2_V11019
suffix:colon
r_case
id|ISDN_PROTO_L2_V11038
suffix:colon
id|info-&gt;xmit_size
op_div_assign
l_int|10
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_char|&squot;C&squot;
suffix:colon
multiline_comment|/* &amp;C - DCD Status */
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
r_switch
c_cond
(paren
id|isdn_getnum
c_func
(paren
id|p
)paren
)paren
(brace
r_case
l_int|0
suffix:colon
id|m-&gt;mdmreg
(braket
id|REG_DCD
)braket
op_and_assign
op_complement
id|BIT_DCD
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|m-&gt;mdmreg
(braket
id|REG_DCD
)braket
op_or_assign
id|BIT_DCD
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
id|PARSE_ERROR1
)brace
r_break
suffix:semicolon
r_case
l_char|&squot;D&squot;
suffix:colon
multiline_comment|/* &amp;D - Set DTR-Low-behavior */
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
r_switch
c_cond
(paren
id|isdn_getnum
c_func
(paren
id|p
)paren
)paren
(brace
r_case
l_int|0
suffix:colon
id|m-&gt;mdmreg
(braket
id|REG_DTRHUP
)braket
op_and_assign
op_complement
id|BIT_DTRHUP
suffix:semicolon
id|m-&gt;mdmreg
(braket
id|REG_DTRR
)braket
op_and_assign
op_complement
id|BIT_DTRR
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|m-&gt;mdmreg
(braket
id|REG_DTRHUP
)braket
op_or_assign
id|BIT_DTRHUP
suffix:semicolon
id|m-&gt;mdmreg
(braket
id|REG_DTRR
)braket
op_and_assign
op_complement
id|BIT_DTRR
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|m-&gt;mdmreg
(braket
id|REG_DTRHUP
)braket
op_or_assign
id|BIT_DTRHUP
suffix:semicolon
id|m-&gt;mdmreg
(braket
id|REG_DTRR
)braket
op_or_assign
id|BIT_DTRR
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
id|PARSE_ERROR1
)brace
r_break
suffix:semicolon
r_case
l_char|&squot;E&squot;
suffix:colon
multiline_comment|/* &amp;E -Set EAZ/MSN */
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|isdn_tty_get_msnstr
c_func
(paren
id|m-&gt;msn
comma
id|p
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;F&squot;
suffix:colon
multiline_comment|/* &amp;F -Set Factory-Defaults */
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;msr
op_amp
id|UART_MSR_DCD
)paren
id|PARSE_ERROR1
suffix:semicolon
id|isdn_tty_reset_profile
c_func
(paren
id|m
)paren
suffix:semicolon
id|isdn_tty_modem_reset_regs
c_func
(paren
id|info
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef DUMMY_HAYES_AT
r_case
l_char|&squot;K&squot;
suffix:colon
multiline_comment|/* only for be compilant with common scripts */
multiline_comment|/* &amp;K Flowcontrol - no function */
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|isdn_getnum
c_func
(paren
id|p
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
l_char|&squot;L&squot;
suffix:colon
multiline_comment|/* &amp;L -Set Numbers to listen on */
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_star
id|p
(braket
l_int|0
)braket
op_logical_and
(paren
id|strchr
c_func
(paren
l_string|&quot;0123456789,-*[]?;&quot;
comma
op_star
id|p
(braket
l_int|0
)braket
)paren
)paren
op_logical_and
(paren
id|i
OL
id|ISDN_LMSNLEN
)paren
)paren
id|m-&gt;lmsn
(braket
id|i
op_increment
)braket
op_assign
op_star
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|m-&gt;lmsn
(braket
id|i
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;R&squot;
suffix:colon
multiline_comment|/* &amp;R - Set V.110 bitrate adaption */
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|i
op_assign
id|isdn_getnum
c_func
(paren
id|p
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|i
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* Switch off V.110, back to X.75 */
id|m-&gt;mdmreg
(braket
id|REG_L2PROT
)braket
op_assign
id|ISDN_PROTO_L2_X75I
suffix:semicolon
id|m-&gt;mdmreg
(braket
id|REG_SI2
)braket
op_assign
l_int|0
suffix:semicolon
id|info-&gt;xmit_size
op_assign
id|m-&gt;mdmreg
(braket
id|REG_PSIZE
)braket
op_star
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|9600
suffix:colon
id|m-&gt;mdmreg
(braket
id|REG_L2PROT
)braket
op_assign
id|ISDN_PROTO_L2_V11096
suffix:semicolon
id|m-&gt;mdmreg
(braket
id|REG_SI2
)braket
op_assign
l_int|197
suffix:semicolon
id|info-&gt;xmit_size
op_assign
id|m-&gt;mdmreg
(braket
id|REG_PSIZE
)braket
op_star
l_int|16
op_div
l_int|10
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|19200
suffix:colon
id|m-&gt;mdmreg
(braket
id|REG_L2PROT
)braket
op_assign
id|ISDN_PROTO_L2_V11019
suffix:semicolon
id|m-&gt;mdmreg
(braket
id|REG_SI2
)braket
op_assign
l_int|199
suffix:semicolon
id|info-&gt;xmit_size
op_assign
id|m-&gt;mdmreg
(braket
id|REG_PSIZE
)braket
op_star
l_int|16
op_div
l_int|10
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|38400
suffix:colon
id|m-&gt;mdmreg
(braket
id|REG_L2PROT
)braket
op_assign
id|ISDN_PROTO_L2_V11038
suffix:semicolon
id|m-&gt;mdmreg
(braket
id|REG_SI2
)braket
op_assign
l_int|198
suffix:semicolon
multiline_comment|/* no existing standard for this */
id|info-&gt;xmit_size
op_assign
id|m-&gt;mdmreg
(braket
id|REG_PSIZE
)braket
op_star
l_int|16
op_div
l_int|10
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PARSE_ERROR1
suffix:semicolon
)brace
multiline_comment|/* Switch off T.70 */
id|m-&gt;mdmreg
(braket
id|REG_T70
)braket
op_and_assign
op_complement
(paren
id|BIT_T70
op_or
id|BIT_T70_EXT
)paren
suffix:semicolon
multiline_comment|/* Set Service 7 */
id|m-&gt;mdmreg
(braket
id|REG_SI1
)braket
op_or_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;S&squot;
suffix:colon
multiline_comment|/* &amp;S - Set Windowsize */
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|i
op_assign
id|isdn_getnum
c_func
(paren
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
OG
l_int|0
)paren
op_logical_and
(paren
id|i
OL
l_int|9
)paren
)paren
id|m-&gt;mdmreg
(braket
id|REG_WSIZE
)braket
op_assign
id|i
suffix:semicolon
r_else
id|PARSE_ERROR1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;V&squot;
suffix:colon
multiline_comment|/* &amp;V - Show registers */
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;&bslash;r&bslash;n&quot;
comma
id|info
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_MODEM_NUMREG
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sprintf
c_func
(paren
id|rb
comma
l_string|&quot;S%02d=%03d%s&quot;
comma
id|i
comma
id|m-&gt;mdmreg
(braket
id|i
)braket
comma
(paren
(paren
id|i
op_plus
l_int|1
)paren
op_mod
l_int|10
)paren
ques
c_cond
l_string|&quot; &quot;
suffix:colon
l_string|&quot;&bslash;r&bslash;n&quot;
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|rb
comma
id|info
)paren
suffix:semicolon
)brace
id|sprintf
c_func
(paren
id|rb
comma
l_string|&quot;&bslash;r&bslash;nEAZ/MSN: %.50s&bslash;r&bslash;n&quot;
comma
id|strlen
c_func
(paren
id|m-&gt;msn
)paren
ques
c_cond
id|m-&gt;msn
suffix:colon
l_string|&quot;None&quot;
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|rb
comma
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|m-&gt;lmsn
)paren
)paren
(brace
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;&bslash;r&bslash;nListen: &quot;
comma
id|info
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|m-&gt;lmsn
comma
id|info
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;&bslash;r&bslash;n&quot;
comma
id|info
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_char|&squot;W&squot;
suffix:colon
multiline_comment|/* &amp;W - Write Profile */
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|p
(braket
l_int|0
)braket
)paren
(brace
r_case
l_char|&squot;0&squot;
suffix:colon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|modem_write_profile
c_func
(paren
id|m
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PARSE_ERROR1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_char|&squot;X&squot;
suffix:colon
multiline_comment|/* &amp;X - Switch to BTX-Mode and T.70 */
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
r_switch
c_cond
(paren
id|isdn_getnum
c_func
(paren
id|p
)paren
)paren
(brace
r_case
l_int|0
suffix:colon
id|m-&gt;mdmreg
(braket
id|REG_T70
)braket
op_and_assign
op_complement
(paren
id|BIT_T70
op_or
id|BIT_T70_EXT
)paren
suffix:semicolon
id|info-&gt;xmit_size
op_assign
id|m-&gt;mdmreg
(braket
id|REG_PSIZE
)braket
op_star
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|m-&gt;mdmreg
(braket
id|REG_T70
)braket
op_or_assign
id|BIT_T70
suffix:semicolon
id|m-&gt;mdmreg
(braket
id|REG_T70
)braket
op_and_assign
op_complement
id|BIT_T70_EXT
suffix:semicolon
id|m-&gt;mdmreg
(braket
id|REG_L2PROT
)braket
op_assign
id|ISDN_PROTO_L2_X75I
suffix:semicolon
id|info-&gt;xmit_size
op_assign
l_int|112
suffix:semicolon
id|m-&gt;mdmreg
(braket
id|REG_SI1
)braket
op_assign
l_int|4
suffix:semicolon
id|m-&gt;mdmreg
(braket
id|REG_SI2
)braket
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|m-&gt;mdmreg
(braket
id|REG_T70
)braket
op_or_assign
(paren
id|BIT_T70
op_or
id|BIT_T70_EXT
)paren
suffix:semicolon
id|m-&gt;mdmreg
(braket
id|REG_L2PROT
)braket
op_assign
id|ISDN_PROTO_L2_X75I
suffix:semicolon
id|info-&gt;xmit_size
op_assign
l_int|112
suffix:semicolon
id|m-&gt;mdmreg
(braket
id|REG_SI1
)braket
op_assign
l_int|4
suffix:semicolon
id|m-&gt;mdmreg
(braket
id|REG_SI2
)braket
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PARSE_ERROR1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|PARSE_ERROR1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|isdn_tty_check_ats
id|isdn_tty_check_ats
c_func
(paren
r_int
id|mreg
comma
r_int
id|mval
comma
id|modem_info
op_star
id|info
comma
id|atemu
op_star
id|m
)paren
(brace
multiline_comment|/* Some plausibility checks */
r_switch
c_cond
(paren
id|mreg
)paren
(brace
r_case
id|REG_L2PROT
suffix:colon
r_if
c_cond
(paren
id|mval
OG
id|ISDN_PROTO_L2_MAX
)paren
r_return
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|REG_PSIZE
suffix:colon
r_if
c_cond
(paren
(paren
id|mval
op_star
l_int|16
)paren
OG
id|ISDN_SERIAL_XMIT_MAX
)paren
r_return
l_int|1
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_AUDIO
r_if
c_cond
(paren
(paren
id|m-&gt;mdmreg
(braket
id|REG_SI1
)braket
op_amp
l_int|1
)paren
op_logical_and
(paren
id|mval
OG
id|VBUFX
)paren
)paren
r_return
l_int|1
suffix:semicolon
macro_line|#endif
id|info-&gt;xmit_size
op_assign
id|mval
op_star
l_int|16
suffix:semicolon
r_switch
c_cond
(paren
id|m-&gt;mdmreg
(braket
id|REG_L2PROT
)braket
)paren
(brace
r_case
id|ISDN_PROTO_L2_V11096
suffix:colon
r_case
id|ISDN_PROTO_L2_V11019
suffix:colon
r_case
id|ISDN_PROTO_L2_V11038
suffix:colon
id|info-&gt;xmit_size
op_div_assign
l_int|10
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|REG_SI1I
suffix:colon
r_case
id|REG_PLAN
suffix:colon
r_case
id|REG_SCREEN
suffix:colon
multiline_comment|/* readonly registers */
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Perform ATS command&n; */
r_static
r_int
DECL|function|isdn_tty_cmd_ATS
id|isdn_tty_cmd_ATS
c_func
(paren
r_char
op_star
op_star
id|p
comma
id|modem_info
op_star
id|info
)paren
(brace
id|atemu
op_star
id|m
op_assign
op_amp
id|info-&gt;emu
suffix:semicolon
r_int
id|bitpos
suffix:semicolon
r_int
id|mreg
suffix:semicolon
r_int
id|mval
suffix:semicolon
r_int
id|bval
suffix:semicolon
id|mreg
op_assign
id|isdn_getnum
c_func
(paren
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mreg
OL
l_int|0
op_logical_or
id|mreg
op_ge
id|ISDN_MODEM_NUMREG
)paren
id|PARSE_ERROR1
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|p
(braket
l_int|0
)braket
)paren
(brace
r_case
l_char|&squot;=&squot;
suffix:colon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|mval
op_assign
id|isdn_getnum
c_func
(paren
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mval
template_param
l_int|255
)paren
id|PARSE_ERROR1
suffix:semicolon
r_if
c_cond
(paren
id|isdn_tty_check_ats
c_func
(paren
id|mreg
comma
id|mval
comma
id|info
comma
id|m
)paren
)paren
id|PARSE_ERROR1
suffix:semicolon
id|m-&gt;mdmreg
(braket
id|mreg
)braket
op_assign
id|mval
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;.&squot;
suffix:colon
multiline_comment|/* Set/Clear a single bit */
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|bitpos
op_assign
id|isdn_getnum
c_func
(paren
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|bitpos
OL
l_int|0
)paren
op_logical_or
(paren
id|bitpos
OG
l_int|7
)paren
)paren
id|PARSE_ERROR1
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|p
(braket
l_int|0
)braket
)paren
(brace
r_case
l_char|&squot;=&squot;
suffix:colon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|bval
op_assign
id|isdn_getnum
c_func
(paren
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bval
template_param
l_int|1
)paren
id|PARSE_ERROR1
suffix:semicolon
r_if
c_cond
(paren
id|bval
)paren
id|mval
op_assign
id|m-&gt;mdmreg
(braket
id|mreg
)braket
op_or
(paren
l_int|1
op_lshift
id|bitpos
)paren
suffix:semicolon
r_else
id|mval
op_assign
id|m-&gt;mdmreg
(braket
id|mreg
)braket
op_amp
op_complement
(paren
l_int|1
op_lshift
id|bitpos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isdn_tty_check_ats
c_func
(paren
id|mreg
comma
id|mval
comma
id|info
comma
id|m
)paren
)paren
id|PARSE_ERROR1
suffix:semicolon
id|m-&gt;mdmreg
(braket
id|mreg
)braket
op_assign
id|mval
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;?&squot;
suffix:colon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;&bslash;r&bslash;n&quot;
comma
id|info
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
(paren
id|m-&gt;mdmreg
(braket
id|mreg
)braket
op_amp
(paren
l_int|1
op_lshift
id|bitpos
)paren
)paren
ques
c_cond
l_string|&quot;1&quot;
suffix:colon
l_string|&quot;0&quot;
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PARSE_ERROR1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_char|&squot;?&squot;
suffix:colon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|isdn_tty_show_profile
c_func
(paren
id|mreg
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PARSE_ERROR1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Perform ATA command&n; */
r_static
r_void
DECL|function|isdn_tty_cmd_ATA
id|isdn_tty_cmd_ATA
c_func
(paren
id|modem_info
op_star
id|info
)paren
(brace
id|atemu
op_star
id|m
op_assign
op_amp
id|info-&gt;emu
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
r_int
id|l2
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;msr
op_amp
id|UART_MSR_RI
)paren
(brace
multiline_comment|/* Accept incoming call */
id|info-&gt;last_dir
op_assign
l_int|0
suffix:semicolon
id|strcpy
c_func
(paren
id|info-&gt;last_num
comma
id|dev-&gt;num
(braket
id|info-&gt;drv_index
)braket
)paren
suffix:semicolon
id|m-&gt;mdmreg
(braket
id|REG_RINGCNT
)braket
op_assign
l_int|0
suffix:semicolon
id|info-&gt;msr
op_and_assign
op_complement
id|UART_MSR_RI
suffix:semicolon
id|l2
op_assign
id|m-&gt;mdmreg
(braket
id|REG_L2PROT
)braket
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_AUDIO
multiline_comment|/* If more than one bit set in reg18, autoselect Layer2 */
r_if
c_cond
(paren
(paren
id|m-&gt;mdmreg
(braket
id|REG_SI1
)braket
op_amp
id|m-&gt;mdmreg
(braket
id|REG_SI1I
)braket
)paren
op_ne
id|m-&gt;mdmreg
(braket
id|REG_SI1
)braket
)paren
(brace
r_if
c_cond
(paren
id|m-&gt;mdmreg
(braket
id|REG_SI1I
)braket
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
(paren
id|l2
op_ne
id|ISDN_PROTO_L2_MODEM
)paren
op_logical_and
(paren
id|l2
op_ne
id|ISDN_PROTO_L2_FAX
)paren
)paren
id|l2
op_assign
id|ISDN_PROTO_L2_TRANS
suffix:semicolon
)brace
r_else
id|l2
op_assign
id|ISDN_PROTO_L2_X75I
suffix:semicolon
)brace
macro_line|#endif
id|cmd.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_SETL2
suffix:semicolon
id|cmd.arg
op_assign
id|info-&gt;isdn_channel
op_plus
(paren
id|l2
op_lshift
l_int|8
)paren
suffix:semicolon
id|info-&gt;last_l2
op_assign
id|l2
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_SETL3
suffix:semicolon
id|cmd.arg
op_assign
id|info-&gt;isdn_channel
op_plus
(paren
id|m-&gt;mdmreg
(braket
id|REG_L3PROT
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_TTY_FAX
r_if
c_cond
(paren
id|l2
op_eq
id|ISDN_PROTO_L2_FAX
)paren
(brace
id|cmd.parm.fax
op_assign
id|info-&gt;fax
suffix:semicolon
id|info-&gt;fax-&gt;direction
op_assign
id|ISDN_TTY_FAX_CONN_IN
suffix:semicolon
)brace
macro_line|#endif
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|cmd.arg
op_assign
id|info-&gt;isdn_channel
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_ACCEPTD
suffix:semicolon
id|info-&gt;dialing
op_assign
l_int|16
suffix:semicolon
id|info-&gt;emu.carrierwait
op_assign
l_int|0
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_CARRIER
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
id|isdn_tty_modem_result
c_func
(paren
id|RESULT_NO_ANSWER
comma
id|info
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ISDN_AUDIO
multiline_comment|/*&n; * Parse AT+F.. commands&n; */
r_static
r_int
DECL|function|isdn_tty_cmd_PLUSF
id|isdn_tty_cmd_PLUSF
c_func
(paren
r_char
op_star
op_star
id|p
comma
id|modem_info
op_star
id|info
)paren
(brace
id|atemu
op_star
id|m
op_assign
op_amp
id|info-&gt;emu
suffix:semicolon
r_char
id|rs
(braket
l_int|20
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|p
(braket
l_int|0
)braket
comma
l_string|&quot;CLASS&quot;
comma
l_int|5
)paren
)paren
(brace
id|p
(braket
l_int|0
)braket
op_add_assign
l_int|5
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|p
(braket
l_int|0
)braket
)paren
(brace
r_case
l_char|&squot;?&squot;
suffix:colon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|sprintf
c_func
(paren
id|rs
comma
l_string|&quot;&bslash;r&bslash;n%d&quot;
comma
(paren
id|m-&gt;mdmreg
(braket
id|REG_SI1
)braket
op_amp
l_int|1
)paren
ques
c_cond
l_int|8
suffix:colon
l_int|0
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_TTY_FAX
r_if
c_cond
(paren
id|TTY_IS_FCLASS2
c_func
(paren
id|info
)paren
)paren
id|sprintf
c_func
(paren
id|rs
comma
l_string|&quot;&bslash;r&bslash;n2&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|TTY_IS_FCLASS1
c_func
(paren
id|info
)paren
)paren
id|sprintf
c_func
(paren
id|rs
comma
l_string|&quot;&bslash;r&bslash;n1&quot;
)paren
suffix:semicolon
macro_line|#endif
id|isdn_tty_at_cout
c_func
(paren
id|rs
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;=&squot;
suffix:colon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|p
(braket
l_int|0
)braket
)paren
(brace
r_case
l_char|&squot;0&squot;
suffix:colon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|m-&gt;mdmreg
(braket
id|REG_L2PROT
)braket
op_assign
id|ISDN_PROTO_L2_X75I
suffix:semicolon
id|m-&gt;mdmreg
(braket
id|REG_L3PROT
)braket
op_assign
id|ISDN_PROTO_L3_TRANS
suffix:semicolon
id|m-&gt;mdmreg
(braket
id|REG_SI1
)braket
op_assign
l_int|4
suffix:semicolon
id|info-&gt;xmit_size
op_assign
id|m-&gt;mdmreg
(braket
id|REG_PSIZE
)braket
op_star
l_int|16
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_TTY_FAX
r_case
l_char|&squot;1&squot;
suffix:colon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;global_features
op_amp
id|ISDN_FEATURE_L3_FCLASS1
)paren
)paren
id|PARSE_ERROR1
suffix:semicolon
id|m-&gt;mdmreg
(braket
id|REG_SI1
)braket
op_assign
l_int|1
suffix:semicolon
id|m-&gt;mdmreg
(braket
id|REG_L2PROT
)braket
op_assign
id|ISDN_PROTO_L2_FAX
suffix:semicolon
id|m-&gt;mdmreg
(braket
id|REG_L3PROT
)braket
op_assign
id|ISDN_PROTO_L3_FCLASS1
suffix:semicolon
id|info-&gt;xmit_size
op_assign
id|m-&gt;mdmreg
(braket
id|REG_PSIZE
)braket
op_star
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;2&squot;
suffix:colon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;global_features
op_amp
id|ISDN_FEATURE_L3_FCLASS2
)paren
)paren
id|PARSE_ERROR1
suffix:semicolon
id|m-&gt;mdmreg
(braket
id|REG_SI1
)braket
op_assign
l_int|1
suffix:semicolon
id|m-&gt;mdmreg
(braket
id|REG_L2PROT
)braket
op_assign
id|ISDN_PROTO_L2_FAX
suffix:semicolon
id|m-&gt;mdmreg
(braket
id|REG_L3PROT
)braket
op_assign
id|ISDN_PROTO_L3_FCLASS2
suffix:semicolon
id|info-&gt;xmit_size
op_assign
id|m-&gt;mdmreg
(braket
id|REG_PSIZE
)braket
op_star
l_int|16
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
l_char|&squot;8&squot;
suffix:colon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
multiline_comment|/* L2 will change on dialout with si=1 */
id|m-&gt;mdmreg
(braket
id|REG_L2PROT
)braket
op_assign
id|ISDN_PROTO_L2_X75I
suffix:semicolon
id|m-&gt;mdmreg
(braket
id|REG_L3PROT
)braket
op_assign
id|ISDN_PROTO_L3_TRANS
suffix:semicolon
id|m-&gt;mdmreg
(braket
id|REG_SI1
)braket
op_assign
l_int|5
suffix:semicolon
id|info-&gt;xmit_size
op_assign
id|VBUF
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;?&squot;
suffix:colon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|strcpy
c_func
(paren
id|rs
comma
l_string|&quot;&bslash;r&bslash;n0,&quot;
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_TTY_FAX
r_if
c_cond
(paren
id|dev-&gt;global_features
op_amp
id|ISDN_FEATURE_L3_FCLASS1
)paren
id|strcat
c_func
(paren
id|rs
comma
l_string|&quot;1,&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;global_features
op_amp
id|ISDN_FEATURE_L3_FCLASS2
)paren
id|strcat
c_func
(paren
id|rs
comma
l_string|&quot;2,&quot;
)paren
suffix:semicolon
macro_line|#endif
id|strcat
c_func
(paren
id|rs
comma
l_string|&quot;8&quot;
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|rs
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PARSE_ERROR1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|PARSE_ERROR1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ISDN_TTY_FAX
r_return
(paren
id|isdn_tty_cmd_PLUSF_FAX
c_func
(paren
id|p
comma
id|info
)paren
)paren
suffix:semicolon
macro_line|#else
id|PARSE_ERROR1
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * Parse AT+V.. commands&n; */
r_static
r_int
DECL|function|isdn_tty_cmd_PLUSV
id|isdn_tty_cmd_PLUSV
c_func
(paren
r_char
op_star
op_star
id|p
comma
id|modem_info
op_star
id|info
)paren
(brace
id|atemu
op_star
id|m
op_assign
op_amp
id|info-&gt;emu
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
r_static
r_char
op_star
id|vcmd
(braket
)braket
op_assign
(brace
l_string|&quot;NH&quot;
comma
l_string|&quot;IP&quot;
comma
l_string|&quot;LS&quot;
comma
l_string|&quot;RX&quot;
comma
l_string|&quot;SD&quot;
comma
l_string|&quot;SM&quot;
comma
l_string|&quot;TX&quot;
comma
l_string|&quot;DD&quot;
comma
l_int|NULL
)brace
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|par1
suffix:semicolon
r_int
id|par2
suffix:semicolon
r_char
id|rs
(braket
l_int|20
)braket
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|vcmd
(braket
id|i
)braket
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|vcmd
(braket
id|i
)braket
comma
id|p
(braket
l_int|0
)braket
comma
l_int|2
)paren
)paren
(brace
id|p
(braket
l_int|0
)braket
op_add_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
)brace
id|i
op_increment
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|i
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* AT+VNH - Auto hangup feature */
r_switch
c_cond
(paren
op_star
id|p
(braket
l_int|0
)braket
)paren
(brace
r_case
l_char|&squot;?&squot;
suffix:colon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;&bslash;r&bslash;n1&quot;
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;=&squot;
suffix:colon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|p
(braket
l_int|0
)braket
)paren
(brace
r_case
l_char|&squot;1&squot;
suffix:colon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;?&squot;
suffix:colon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;&bslash;r&bslash;n1&quot;
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PARSE_ERROR1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|PARSE_ERROR1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* AT+VIP - Reset all voice parameters */
id|isdn_tty_modem_reset_vpar
c_func
(paren
id|m
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* AT+VLS - Select device, accept incoming call */
r_switch
c_cond
(paren
op_star
id|p
(braket
l_int|0
)braket
)paren
(brace
r_case
l_char|&squot;?&squot;
suffix:colon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|sprintf
c_func
(paren
id|rs
comma
l_string|&quot;&bslash;r&bslash;n%d&quot;
comma
id|m-&gt;vpar
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|rs
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;=&squot;
suffix:colon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|p
(braket
l_int|0
)braket
)paren
(brace
r_case
l_char|&squot;0&squot;
suffix:colon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|m-&gt;vpar
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;2&squot;
suffix:colon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|m-&gt;vpar
(braket
l_int|0
)braket
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;?&squot;
suffix:colon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;&bslash;r&bslash;n0,2&quot;
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PARSE_ERROR1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|PARSE_ERROR1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* AT+VRX - Start recording */
r_if
c_cond
(paren
op_logical_neg
id|m-&gt;vpar
(braket
l_int|0
)braket
)paren
id|PARSE_ERROR1
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;online
op_ne
l_int|1
)paren
(brace
id|isdn_tty_modem_result
c_func
(paren
id|RESULT_NO_ANSWER
comma
id|info
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|info-&gt;dtmf_state
op_assign
id|isdn_audio_dtmf_init
c_func
(paren
id|info-&gt;dtmf_state
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;dtmf_state
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_tty: Couldn&squot;t malloc dtmf state&bslash;n&quot;
)paren
suffix:semicolon
id|PARSE_ERROR1
suffix:semicolon
)brace
id|info-&gt;silence_state
op_assign
id|isdn_audio_silence_init
c_func
(paren
id|info-&gt;silence_state
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;silence_state
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_tty: Couldn&squot;t malloc silence state&bslash;n&quot;
)paren
suffix:semicolon
id|PARSE_ERROR1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|m-&gt;vpar
(braket
l_int|3
)braket
OL
l_int|5
)paren
(brace
id|info-&gt;adpcmr
op_assign
id|isdn_audio_adpcm_init
c_func
(paren
id|info-&gt;adpcmr
comma
id|m-&gt;vpar
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;adpcmr
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_tty: Couldn&squot;t malloc adpcm state&bslash;n&quot;
)paren
suffix:semicolon
id|PARSE_ERROR1
suffix:semicolon
)brace
)brace
macro_line|#ifdef ISDN_DEBUG_AT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;AT: +VRX&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|info-&gt;vonline
op_or_assign
l_int|1
suffix:semicolon
id|isdn_tty_modem_result
c_func
(paren
id|RESULT_CONNECT
comma
id|info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
multiline_comment|/* AT+VSD - Silence detection */
r_switch
c_cond
(paren
op_star
id|p
(braket
l_int|0
)braket
)paren
(brace
r_case
l_char|&squot;?&squot;
suffix:colon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|sprintf
c_func
(paren
id|rs
comma
l_string|&quot;&bslash;r&bslash;n&lt;%d&gt;,&lt;%d&gt;&quot;
comma
id|m-&gt;vpar
(braket
l_int|1
)braket
comma
id|m-&gt;vpar
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|rs
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;=&squot;
suffix:colon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|p
(braket
l_int|0
)braket
op_ge
l_char|&squot;0&squot;
)paren
op_logical_and
(paren
op_star
id|p
(braket
l_int|0
)braket
op_le
l_char|&squot;9&squot;
)paren
)paren
(brace
id|par1
op_assign
id|isdn_getnum
c_func
(paren
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|par1
OL
l_int|0
)paren
op_logical_or
(paren
id|par1
OG
l_int|31
)paren
)paren
id|PARSE_ERROR1
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
(braket
l_int|0
)braket
op_ne
l_char|&squot;,&squot;
)paren
id|PARSE_ERROR1
suffix:semicolon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|par2
op_assign
id|isdn_getnum
c_func
(paren
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|par2
OL
l_int|0
)paren
op_logical_or
(paren
id|par2
OG
l_int|255
)paren
)paren
id|PARSE_ERROR1
suffix:semicolon
id|m-&gt;vpar
(braket
l_int|1
)braket
op_assign
id|par1
suffix:semicolon
id|m-&gt;vpar
(braket
l_int|2
)braket
op_assign
id|par2
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_star
id|p
(braket
l_int|0
)braket
op_eq
l_char|&squot;?&squot;
)paren
(brace
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;&bslash;r&bslash;n&lt;0-31&gt;,&lt;0-255&gt;&quot;
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
id|PARSE_ERROR1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PARSE_ERROR1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
multiline_comment|/* AT+VSM - Select compression */
r_switch
c_cond
(paren
op_star
id|p
(braket
l_int|0
)braket
)paren
(brace
r_case
l_char|&squot;?&squot;
suffix:colon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|sprintf
c_func
(paren
id|rs
comma
l_string|&quot;&bslash;r&bslash;n&lt;%d&gt;,&lt;%d&gt;&lt;8000&gt;&quot;
comma
id|m-&gt;vpar
(braket
l_int|3
)braket
comma
id|m-&gt;vpar
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|rs
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;=&squot;
suffix:colon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|p
(braket
l_int|0
)braket
)paren
(brace
r_case
l_char|&squot;2&squot;
suffix:colon
r_case
l_char|&squot;3&squot;
suffix:colon
r_case
l_char|&squot;4&squot;
suffix:colon
r_case
l_char|&squot;5&squot;
suffix:colon
r_case
l_char|&squot;6&squot;
suffix:colon
id|par1
op_assign
id|isdn_getnum
c_func
(paren
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|par1
OL
l_int|2
)paren
op_logical_or
(paren
id|par1
OG
l_int|6
)paren
)paren
id|PARSE_ERROR1
suffix:semicolon
id|m-&gt;vpar
(braket
l_int|3
)braket
op_assign
id|par1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;?&squot;
suffix:colon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;&bslash;r&bslash;n2;ADPCM;2;0;(8000)&bslash;r&bslash;n&quot;
comma
id|info
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;3;ADPCM;3;0;(8000)&bslash;r&bslash;n&quot;
comma
id|info
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;4;ADPCM;4;0;(8000)&bslash;r&bslash;n&quot;
comma
id|info
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;5;ALAW;8;0;(8000)&bslash;r&bslash;n&quot;
comma
id|info
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;6;ULAW;8;0;(8000)&bslash;r&bslash;n&quot;
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PARSE_ERROR1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|PARSE_ERROR1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
multiline_comment|/* AT+VTX - Start sending */
r_if
c_cond
(paren
op_logical_neg
id|m-&gt;vpar
(braket
l_int|0
)braket
)paren
id|PARSE_ERROR1
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;online
op_ne
l_int|1
)paren
(brace
id|isdn_tty_modem_result
c_func
(paren
id|RESULT_NO_ANSWER
comma
id|info
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|info-&gt;dtmf_state
op_assign
id|isdn_audio_dtmf_init
c_func
(paren
id|info-&gt;dtmf_state
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;dtmf_state
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_tty: Couldn&squot;t malloc dtmf state&bslash;n&quot;
)paren
suffix:semicolon
id|PARSE_ERROR1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|m-&gt;vpar
(braket
l_int|3
)braket
OL
l_int|5
)paren
(brace
id|info-&gt;adpcms
op_assign
id|isdn_audio_adpcm_init
c_func
(paren
id|info-&gt;adpcms
comma
id|m-&gt;vpar
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;adpcms
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_tty: Couldn&squot;t malloc adpcm state&bslash;n&quot;
)paren
suffix:semicolon
id|PARSE_ERROR1
suffix:semicolon
)brace
)brace
macro_line|#ifdef ISDN_DEBUG_AT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;AT: +VTX&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|m-&gt;lastDLE
op_assign
l_int|0
suffix:semicolon
id|info-&gt;vonline
op_or_assign
l_int|2
suffix:semicolon
id|isdn_tty_modem_result
c_func
(paren
id|RESULT_CONNECT
comma
id|info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
multiline_comment|/* AT+VDD - DTMF detection */
r_switch
c_cond
(paren
op_star
id|p
(braket
l_int|0
)braket
)paren
(brace
r_case
l_char|&squot;?&squot;
suffix:colon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|sprintf
c_func
(paren
id|rs
comma
l_string|&quot;&bslash;r&bslash;n&lt;%d&gt;,&lt;%d&gt;&quot;
comma
id|m-&gt;vpar
(braket
l_int|4
)braket
comma
id|m-&gt;vpar
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|rs
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;=&squot;
suffix:colon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|p
(braket
l_int|0
)braket
op_ge
l_char|&squot;0&squot;
)paren
op_logical_and
(paren
op_star
id|p
(braket
l_int|0
)braket
op_le
l_char|&squot;9&squot;
)paren
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;online
op_ne
l_int|1
)paren
id|PARSE_ERROR1
suffix:semicolon
id|par1
op_assign
id|isdn_getnum
c_func
(paren
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|par1
OL
l_int|0
)paren
op_logical_or
(paren
id|par1
OG
l_int|15
)paren
)paren
id|PARSE_ERROR1
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
(braket
l_int|0
)braket
op_ne
l_char|&squot;,&squot;
)paren
id|PARSE_ERROR1
suffix:semicolon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|par2
op_assign
id|isdn_getnum
c_func
(paren
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|par2
OL
l_int|0
)paren
op_logical_or
(paren
id|par2
OG
l_int|255
)paren
)paren
id|PARSE_ERROR1
suffix:semicolon
id|m-&gt;vpar
(braket
l_int|4
)braket
op_assign
id|par1
suffix:semicolon
id|m-&gt;vpar
(braket
l_int|5
)braket
op_assign
id|par2
suffix:semicolon
id|cmd.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_AUDIO
suffix:semicolon
id|cmd.arg
op_assign
id|info-&gt;isdn_channel
op_plus
(paren
id|ISDN_AUDIO_SETDD
op_lshift
l_int|8
)paren
suffix:semicolon
id|cmd.parm.num
(braket
l_int|0
)braket
op_assign
id|par1
suffix:semicolon
id|cmd.parm.num
(braket
l_int|1
)braket
op_assign
id|par2
suffix:semicolon
id|isdn_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_star
id|p
(braket
l_int|0
)braket
op_eq
l_char|&squot;?&squot;
)paren
(brace
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;&bslash;r&bslash;n&lt;0-15&gt;,&lt;0-255&gt;&quot;
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
id|PARSE_ERROR1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PARSE_ERROR1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|PARSE_ERROR1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif                          /* CONFIG_ISDN_AUDIO */
multiline_comment|/*&n; * Parse and perform an AT-command-line.&n; */
r_static
r_void
DECL|function|isdn_tty_parse_at
id|isdn_tty_parse_at
c_func
(paren
id|modem_info
op_star
id|info
)paren
(brace
id|atemu
op_star
id|m
op_assign
op_amp
id|info-&gt;emu
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_char
id|ds
(braket
l_int|40
)braket
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_AT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;AT: &squot;%s&squot;&bslash;n&quot;
comma
id|m-&gt;mdmcmd
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|p
op_assign
op_amp
id|m-&gt;mdmcmd
(braket
l_int|2
)braket
suffix:semicolon
op_star
id|p
suffix:semicolon
)paren
(brace
r_switch
c_cond
(paren
op_star
id|p
)paren
(brace
r_case
l_char|&squot; &squot;
suffix:colon
id|p
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;A&squot;
suffix:colon
multiline_comment|/* A - Accept incoming call */
id|p
op_increment
suffix:semicolon
id|isdn_tty_cmd_ATA
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;D&squot;
suffix:colon
multiline_comment|/* D - Dial */
r_if
c_cond
(paren
id|info-&gt;msr
op_amp
id|UART_MSR_DCD
)paren
id|PARSE_ERROR
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;msr
op_amp
id|UART_MSR_RI
)paren
(brace
id|isdn_tty_modem_result
c_func
(paren
id|RESULT_NO_CARRIER
comma
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|isdn_tty_getdial
c_func
(paren
op_increment
id|p
comma
id|ds
comma
r_sizeof
id|ds
)paren
suffix:semicolon
id|p
op_add_assign
id|strlen
c_func
(paren
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strlen
c_func
(paren
id|m-&gt;msn
)paren
)paren
id|isdn_tty_modem_result
c_func
(paren
id|RESULT_NO_MSN_EAZ
comma
id|info
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|ds
)paren
)paren
id|isdn_tty_dial
c_func
(paren
id|ds
comma
id|info
comma
id|m
)paren
suffix:semicolon
r_else
id|PARSE_ERROR
suffix:semicolon
r_return
suffix:semicolon
r_case
l_char|&squot;E&squot;
suffix:colon
multiline_comment|/* E - Turn Echo on/off */
id|p
op_increment
suffix:semicolon
r_switch
c_cond
(paren
id|isdn_getnum
c_func
(paren
op_amp
id|p
)paren
)paren
(brace
r_case
l_int|0
suffix:colon
id|m-&gt;mdmreg
(braket
id|REG_ECHO
)braket
op_and_assign
op_complement
id|BIT_ECHO
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|m-&gt;mdmreg
(braket
id|REG_ECHO
)braket
op_or_assign
id|BIT_ECHO
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PARSE_ERROR
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_char|&squot;H&squot;
suffix:colon
multiline_comment|/* H - On/Off-hook */
id|p
op_increment
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|p
)paren
(brace
r_case
l_char|&squot;0&squot;
suffix:colon
id|p
op_increment
suffix:semicolon
id|isdn_tty_on_hook
c_func
(paren
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;1&squot;
suffix:colon
id|p
op_increment
suffix:semicolon
id|isdn_tty_off_hook
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|isdn_tty_on_hook
c_func
(paren
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_char|&squot;I&squot;
suffix:colon
multiline_comment|/* I - Information */
id|p
op_increment
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;&bslash;r&bslash;nLinux ISDN&quot;
comma
id|info
)paren
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|p
)paren
(brace
r_case
l_char|&squot;0&squot;
suffix:colon
r_case
l_char|&squot;1&squot;
suffix:colon
id|p
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;2&squot;
suffix:colon
id|p
op_increment
suffix:semicolon
id|isdn_tty_report
c_func
(paren
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;3&squot;
suffix:colon
id|p
op_increment
suffix:semicolon
id|sprintf
c_func
(paren
id|ds
comma
l_string|&quot;&bslash;r&bslash;n%d&quot;
comma
id|info-&gt;emu.charge
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|ds
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
)brace
r_break
suffix:semicolon
macro_line|#ifdef DUMMY_HAYES_AT
r_case
l_char|&squot;L&squot;
suffix:colon
r_case
l_char|&squot;M&squot;
suffix:colon
multiline_comment|/* only for be compilant with common scripts */
multiline_comment|/* no function */
id|p
op_increment
suffix:semicolon
id|isdn_getnum
c_func
(paren
op_amp
id|p
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
l_char|&squot;O&squot;
suffix:colon
multiline_comment|/* O - Go online */
id|p
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;msr
op_amp
id|UART_MSR_DCD
)paren
multiline_comment|/* if B-Channel is up */
id|isdn_tty_modem_result
c_func
(paren
(paren
id|m-&gt;mdmreg
(braket
id|REG_L2PROT
)braket
op_eq
id|ISDN_PROTO_L2_MODEM
)paren
ques
c_cond
id|RESULT_CONNECT
suffix:colon
id|RESULT_CONNECT64000
comma
id|info
)paren
suffix:semicolon
r_else
id|isdn_tty_modem_result
c_func
(paren
id|RESULT_NO_CARRIER
comma
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_char|&squot;Q&squot;
suffix:colon
multiline_comment|/* Q - Turn Emulator messages on/off */
id|p
op_increment
suffix:semicolon
r_switch
c_cond
(paren
id|isdn_getnum
c_func
(paren
op_amp
id|p
)paren
)paren
(brace
r_case
l_int|0
suffix:colon
id|m-&gt;mdmreg
(braket
id|REG_RESP
)braket
op_or_assign
id|BIT_RESP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|m-&gt;mdmreg
(braket
id|REG_RESP
)braket
op_and_assign
op_complement
id|BIT_RESP
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PARSE_ERROR
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_char|&squot;S&squot;
suffix:colon
multiline_comment|/* S - Set/Get Register */
id|p
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|isdn_tty_cmd_ATS
c_func
(paren
op_amp
id|p
comma
id|info
)paren
)paren
r_return
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;V&squot;
suffix:colon
multiline_comment|/* V - Numeric or ASCII Emulator-messages */
id|p
op_increment
suffix:semicolon
r_switch
c_cond
(paren
id|isdn_getnum
c_func
(paren
op_amp
id|p
)paren
)paren
(brace
r_case
l_int|0
suffix:colon
id|m-&gt;mdmreg
(braket
id|REG_RESP
)braket
op_or_assign
id|BIT_RESPNUM
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|m-&gt;mdmreg
(braket
id|REG_RESP
)braket
op_and_assign
op_complement
id|BIT_RESPNUM
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PARSE_ERROR
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_char|&squot;Z&squot;
suffix:colon
multiline_comment|/* Z - Load Registers from Profile */
id|p
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;msr
op_amp
id|UART_MSR_DCD
)paren
(brace
id|info-&gt;online
op_assign
l_int|0
suffix:semicolon
id|isdn_tty_on_hook
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
id|isdn_tty_modem_reset_regs
c_func
(paren
id|info
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;+&squot;
suffix:colon
id|p
op_increment
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|p
)paren
(brace
macro_line|#ifdef CONFIG_ISDN_AUDIO
r_case
l_char|&squot;F&squot;
suffix:colon
id|p
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|isdn_tty_cmd_PLUSF
c_func
(paren
op_amp
id|p
comma
id|info
)paren
)paren
r_return
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;V&squot;
suffix:colon
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
id|m-&gt;mdmreg
(braket
id|REG_SI1
)braket
op_amp
l_int|1
)paren
)paren
op_logical_or
(paren
id|m-&gt;mdmreg
(braket
id|REG_L2PROT
)braket
op_eq
id|ISDN_PROTO_L2_MODEM
)paren
)paren
id|PARSE_ERROR
suffix:semicolon
id|p
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|isdn_tty_cmd_PLUSV
c_func
(paren
op_amp
id|p
comma
id|info
)paren
)paren
r_return
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif                          /* CONFIG_ISDN_AUDIO */
r_case
l_char|&squot;S&squot;
suffix:colon
multiline_comment|/* SUSPEND */
id|p
op_increment
suffix:semicolon
id|isdn_tty_get_msnstr
c_func
(paren
id|ds
comma
op_amp
id|p
)paren
suffix:semicolon
id|isdn_tty_suspend
c_func
(paren
id|ds
comma
id|info
comma
id|m
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;R&squot;
suffix:colon
multiline_comment|/* RESUME */
id|p
op_increment
suffix:semicolon
id|isdn_tty_get_msnstr
c_func
(paren
id|ds
comma
op_amp
id|p
)paren
suffix:semicolon
id|isdn_tty_resume
c_func
(paren
id|ds
comma
id|info
comma
id|m
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;M&squot;
suffix:colon
multiline_comment|/* MESSAGE */
id|p
op_increment
suffix:semicolon
id|isdn_tty_send_msg
c_func
(paren
id|info
comma
id|m
comma
id|p
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PARSE_ERROR
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_char|&squot;&amp;&squot;
suffix:colon
id|p
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|isdn_tty_cmd_ATand
c_func
(paren
op_amp
id|p
comma
id|info
)paren
)paren
r_return
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PARSE_ERROR
suffix:semicolon
)brace
)brace
macro_line|#ifdef CONFIG_ISDN_AUDIO
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;vonline
)paren
macro_line|#endif
id|isdn_tty_modem_result
c_func
(paren
id|RESULT_OK
comma
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/* Need own toupper() because standard-toupper is not available&n; * within modules.&n; */
DECL|macro|my_toupper
mdefine_line|#define my_toupper(c) (((c&gt;=&squot;a&squot;)&amp;&amp;(c&lt;=&squot;z&squot;))?(c&amp;0xdf):c)
multiline_comment|/*&n; * Perform line-editing of AT-commands&n; *&n; * Parameters:&n; *   p        inputbuffer&n; *   count    length of buffer&n; *   channel  index to line (minor-device)&n; *   user     flag: buffer is in userspace&n; */
r_static
r_int
DECL|function|isdn_tty_edit_at
id|isdn_tty_edit_at
c_func
(paren
r_const
r_char
op_star
id|p
comma
r_int
id|count
comma
id|modem_info
op_star
id|info
comma
r_int
id|user
)paren
(brace
id|atemu
op_star
id|m
op_assign
op_amp
id|info-&gt;emu
suffix:semicolon
r_int
id|total
op_assign
l_int|0
suffix:semicolon
id|u_char
id|c
suffix:semicolon
r_char
id|eb
(braket
l_int|2
)braket
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
id|count
suffix:semicolon
id|cnt
OG
l_int|0
suffix:semicolon
id|p
op_increment
comma
id|cnt
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|user
)paren
id|get_user
c_func
(paren
id|c
comma
id|p
)paren
suffix:semicolon
r_else
id|c
op_assign
op_star
id|p
suffix:semicolon
id|total
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|c
op_eq
id|m-&gt;mdmreg
(braket
id|REG_CR
)braket
op_logical_or
id|c
op_eq
id|m-&gt;mdmreg
(braket
id|REG_LF
)braket
)paren
(brace
multiline_comment|/* Separator (CR or LF) */
id|m-&gt;mdmcmd
(braket
id|m-&gt;mdmcmdl
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|m-&gt;mdmreg
(braket
id|REG_ECHO
)braket
op_amp
id|BIT_ECHO
)paren
(brace
id|eb
(braket
l_int|0
)braket
op_assign
id|c
suffix:semicolon
id|eb
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|eb
comma
id|info
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|m-&gt;mdmcmdl
op_ge
l_int|2
)paren
op_logical_and
(paren
op_logical_neg
(paren
id|strncmp
c_func
(paren
id|m-&gt;mdmcmd
comma
l_string|&quot;AT&quot;
comma
l_int|2
)paren
)paren
)paren
)paren
id|isdn_tty_parse_at
c_func
(paren
id|info
)paren
suffix:semicolon
id|m-&gt;mdmcmdl
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|c
op_eq
id|m-&gt;mdmreg
(braket
id|REG_BS
)braket
op_logical_and
id|m-&gt;mdmreg
(braket
id|REG_BS
)braket
OL
l_int|128
)paren
(brace
multiline_comment|/* Backspace-Function */
r_if
c_cond
(paren
(paren
id|m-&gt;mdmcmdl
OG
l_int|2
)paren
op_logical_or
(paren
op_logical_neg
id|m-&gt;mdmcmdl
)paren
)paren
(brace
r_if
c_cond
(paren
id|m-&gt;mdmcmdl
)paren
id|m-&gt;mdmcmdl
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|m-&gt;mdmreg
(braket
id|REG_ECHO
)braket
op_amp
id|BIT_ECHO
)paren
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;&bslash;b&quot;
comma
id|info
)paren
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmdchar
c_func
(paren
id|c
)paren
)paren
(brace
r_if
c_cond
(paren
id|m-&gt;mdmreg
(braket
id|REG_ECHO
)braket
op_amp
id|BIT_ECHO
)paren
(brace
id|eb
(braket
l_int|0
)braket
op_assign
id|c
suffix:semicolon
id|eb
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|eb
comma
id|info
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|m-&gt;mdmcmdl
OL
l_int|255
)paren
(brace
id|c
op_assign
id|my_toupper
c_func
(paren
id|c
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|m-&gt;mdmcmdl
)paren
(brace
r_case
l_int|1
suffix:colon
r_if
c_cond
(paren
id|c
op_eq
l_char|&squot;T&squot;
)paren
(brace
id|m-&gt;mdmcmd
(braket
id|m-&gt;mdmcmdl
)braket
op_assign
id|c
suffix:semicolon
id|m-&gt;mdmcmd
(braket
op_increment
id|m-&gt;mdmcmdl
)braket
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
id|m-&gt;mdmcmdl
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Fall through, check for &squot;A&squot; */
r_case
l_int|0
suffix:colon
r_if
c_cond
(paren
id|c
op_eq
l_char|&squot;A&squot;
)paren
(brace
id|m-&gt;mdmcmd
(braket
id|m-&gt;mdmcmdl
)braket
op_assign
id|c
suffix:semicolon
id|m-&gt;mdmcmd
(braket
op_increment
id|m-&gt;mdmcmdl
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|m-&gt;mdmcmd
(braket
id|m-&gt;mdmcmdl
)braket
op_assign
id|c
suffix:semicolon
id|m-&gt;mdmcmd
(braket
op_increment
id|m-&gt;mdmcmdl
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
)brace
r_return
id|total
suffix:semicolon
)brace
multiline_comment|/*&n; * Switch all modem-channels who are online and got a valid&n; * escape-sequence 1.5 seconds ago, to command-mode.&n; * This function is called every second via timer-interrupt from within&n; * timer-dispatcher isdn_timer_function()&n; */
r_void
DECL|function|isdn_tty_modem_escape
id|isdn_tty_modem_escape
c_func
(paren
r_void
)paren
(brace
r_int
id|ton
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|midx
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_MAX_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|USG_MODEM
c_func
(paren
id|dev-&gt;usage
(braket
id|i
)braket
)paren
)paren
r_if
c_cond
(paren
(paren
id|midx
op_assign
id|dev-&gt;m_idx
(braket
id|i
)braket
)paren
op_ge
l_int|0
)paren
(brace
id|modem_info
op_star
id|info
op_assign
op_amp
id|dev-&gt;mdm.info
(braket
id|midx
)braket
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;online
)paren
(brace
id|ton
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;emu.pluscount
op_eq
l_int|3
)paren
op_logical_and
(paren
(paren
id|jiffies
op_minus
id|info-&gt;emu.lastplus
)paren
OG
id|PLUSWAIT2
)paren
)paren
(brace
id|info-&gt;emu.pluscount
op_assign
l_int|0
suffix:semicolon
id|info-&gt;online
op_assign
l_int|0
suffix:semicolon
id|isdn_tty_modem_result
c_func
(paren
id|RESULT_OK
comma
id|info
)paren
suffix:semicolon
)brace
)brace
)brace
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_MODEMPLUS
comma
id|ton
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Put a RING-message to all modem-channels who have the RI-bit set.&n; * This function is called every second via timer-interrupt from within&n; * timer-dispatcher isdn_timer_function()&n; */
r_void
DECL|function|isdn_tty_modem_ring
id|isdn_tty_modem_ring
c_func
(paren
r_void
)paren
(brace
r_int
id|ton
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_MAX_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|modem_info
op_star
id|info
op_assign
op_amp
id|dev-&gt;mdm.info
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;msr
op_amp
id|UART_MSR_RI
)paren
(brace
id|ton
op_assign
l_int|1
suffix:semicolon
id|isdn_tty_modem_result
c_func
(paren
id|RESULT_RING
comma
id|info
)paren
suffix:semicolon
)brace
)brace
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_MODEMRING
comma
id|ton
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * For all online tty&squot;s, try sending data to&n; * the lower levels.&n; */
r_void
DECL|function|isdn_tty_modem_xmit
id|isdn_tty_modem_xmit
c_func
(paren
r_void
)paren
(brace
r_int
id|ton
op_assign
l_int|1
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_MAX_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|modem_info
op_star
id|info
op_assign
op_amp
id|dev-&gt;mdm.info
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;online
)paren
(brace
id|ton
op_assign
l_int|1
suffix:semicolon
id|isdn_tty_senddown
c_func
(paren
id|info
)paren
suffix:semicolon
id|isdn_tty_tint
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
)brace
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_MODEMXMIT
comma
id|ton
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Check all channels if we have a &squot;no carrier&squot; timeout.&n; * Timeout value is set by Register S7.&n; */
r_void
DECL|function|isdn_tty_carrier_timeout
id|isdn_tty_carrier_timeout
c_func
(paren
r_void
)paren
(brace
r_int
id|ton
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_MAX_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|modem_info
op_star
id|info
op_assign
op_amp
id|dev-&gt;mdm.info
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;dialing
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;emu.carrierwait
op_increment
OG
id|info-&gt;emu.mdmreg
(braket
id|REG_WAITC
)braket
)paren
(brace
id|info-&gt;dialing
op_assign
l_int|0
suffix:semicolon
id|isdn_tty_modem_result
c_func
(paren
id|RESULT_NO_CARRIER
comma
id|info
)paren
suffix:semicolon
id|isdn_tty_modem_hup
c_func
(paren
id|info
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
id|ton
op_assign
l_int|1
suffix:semicolon
)brace
)brace
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_CARRIER
comma
id|ton
)paren
suffix:semicolon
)brace
eof
