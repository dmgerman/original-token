multiline_comment|/* $Id: isdn_tty.c,v 1.4 1996/04/20 16:39:54 fritz Exp $&n; *&n; * Linux ISDN subsystem, tty functions and AT-command emulator (linklevel).&n; *&n; * Copyright 1994,95,96 by Fritz Elfert (fritz@wuemaus.franken.de)&n; * Copyright 1995,96    by Thinking Objects Software GmbH Wuerzburg&n; * &n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA. &n; *&n; * $Log: isdn_tty.c,v $&n; * Revision 1.4  1996/04/20 16:39:54  fritz&n; * Changed all io to go through generic routines in isdn_common.c&n; * Fixed a real ugly bug in modem-emulator: &squot;ATA&squot; had been accepted&n; * even when a call has been cancelled from the remote machine.&n; *&n; * Revision 1.3  1996/02/11 02:12:32  fritz&n; * Bugfixes according to similar fixes in standard serial.c of kernel.&n; *&n; * Revision 1.2  1996/01/22 05:12:25  fritz&n; * replaced my_atoi by simple_strtoul&n; *&n; * Revision 1.1  1996/01/09 04:13:18  fritz&n; * Initial revision&n; *&n; */
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/isdn.h&gt;
macro_line|#include &quot;isdn_common.h&quot;
macro_line|#include &quot;isdn_tty.h&quot;
multiline_comment|/* Prototypes */
r_static
r_int
id|isdn_tty_edit_at
c_func
(paren
r_const
r_char
op_star
comma
r_int
comma
id|modem_info
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|isdn_tty_check_esc
c_func
(paren
r_const
id|u_char
op_star
comma
id|u_char
comma
r_int
comma
r_int
op_star
comma
r_int
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|isdn_tty_modem_reset_regs
c_func
(paren
id|atemu
op_star
comma
r_int
)paren
suffix:semicolon
multiline_comment|/* Leave this unchanged unless you know what you do! */
DECL|macro|MODEM_PARANOIA_CHECK
mdefine_line|#define MODEM_PARANOIA_CHECK
DECL|macro|MODEM_DO_RESTART
mdefine_line|#define MODEM_DO_RESTART
DECL|variable|isdn_ttyname_ttyI
r_static
r_char
op_star
id|isdn_ttyname_ttyI
op_assign
l_string|&quot;ttyI&quot;
suffix:semicolon
DECL|variable|isdn_ttyname_cui
r_static
r_char
op_star
id|isdn_ttyname_cui
op_assign
l_string|&quot;cui&quot;
suffix:semicolon
DECL|variable|isdn_tty_revision
r_char
op_star
id|isdn_tty_revision
op_assign
l_string|&quot;$Revision: 1.4 $&quot;
suffix:semicolon
DECL|function|isdn_tty_try_read
r_int
id|isdn_tty_try_read
c_func
(paren
r_int
id|i
comma
id|u_char
op_star
id|buf
comma
r_int
id|len
)paren
(brace
r_int
id|c
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;mdm.online
(braket
id|i
)braket
)paren
(brace
r_if
c_cond
(paren
(paren
id|tty
op_assign
id|dev-&gt;mdm.info
(braket
id|i
)braket
dot
id|tty
)paren
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;mdm.info
(braket
id|i
)braket
dot
id|MCR
op_amp
id|UART_MCR_RTS
)paren
(brace
id|c
op_assign
id|TTY_FLIPBUF_SIZE
op_minus
id|tty-&gt;flip.count
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|c
op_ge
id|len
)paren
(brace
r_if
c_cond
(paren
id|len
OG
l_int|1
)paren
(brace
id|memcpy
c_func
(paren
id|tty-&gt;flip.char_buf_ptr
comma
id|buf
comma
id|len
)paren
suffix:semicolon
id|tty-&gt;flip.count
op_add_assign
id|len
suffix:semicolon
id|memset
c_func
(paren
id|tty-&gt;flip.flag_buf_ptr
comma
l_int|0
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;mdm.atmodem
(braket
id|i
)braket
dot
id|mdmreg
(braket
l_int|12
)braket
op_amp
l_int|128
)paren
id|tty-&gt;flip.flag_buf_ptr
(braket
id|len
op_minus
l_int|1
)braket
op_assign
l_int|0xff
suffix:semicolon
id|tty-&gt;flip.flag_buf_ptr
op_add_assign
id|len
suffix:semicolon
id|tty-&gt;flip.char_buf_ptr
op_add_assign
id|len
suffix:semicolon
)brace
r_else
id|tty_insert_flip_char
c_func
(paren
id|tty
comma
id|buf
(braket
l_int|0
)braket
comma
l_int|0
)paren
suffix:semicolon
id|queue_task_irq_off
c_func
(paren
op_amp
id|tty-&gt;flip.tqueue
comma
op_amp
id|tq_timer
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|isdn_tty_readmodem
r_void
id|isdn_tty_readmodem
c_func
(paren
r_void
)paren
(brace
r_int
id|resched
op_assign
l_int|0
suffix:semicolon
r_int
id|midx
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|c
suffix:semicolon
r_int
id|r
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
id|modem_info
op_star
id|info
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_MAX_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|midx
op_assign
id|dev-&gt;m_idx
(braket
id|i
)braket
)paren
op_ge
l_int|0
)paren
r_if
c_cond
(paren
id|dev-&gt;mdm.online
(braket
id|midx
)braket
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|r
op_assign
l_int|0
suffix:semicolon
id|info
op_assign
op_amp
id|dev-&gt;mdm.info
(braket
id|midx
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tty
op_assign
id|info-&gt;tty
)paren
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;MCR
op_amp
id|UART_MCR_RTS
)paren
(brace
id|c
op_assign
id|TTY_FLIPBUF_SIZE
op_minus
id|tty-&gt;flip.count
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|c
OG
l_int|0
)paren
(brace
id|r
op_assign
id|isdn_readbchan
c_func
(paren
id|info-&gt;isdn_driver
comma
id|info-&gt;isdn_channel
comma
id|tty-&gt;flip.char_buf_ptr
comma
id|tty-&gt;flip.flag_buf_ptr
comma
id|c
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;mdm.atmodem
(braket
id|midx
)braket
dot
id|mdmreg
(braket
l_int|12
)braket
op_amp
l_int|128
)paren
)paren
id|memset
c_func
(paren
id|tty-&gt;flip.flag_buf_ptr
comma
l_int|0
comma
id|r
)paren
suffix:semicolon
id|tty-&gt;flip.count
op_add_assign
id|r
suffix:semicolon
id|tty-&gt;flip.flag_buf_ptr
op_add_assign
id|r
suffix:semicolon
id|tty-&gt;flip.char_buf_ptr
op_add_assign
id|r
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
id|queue_task_irq_off
c_func
(paren
op_amp
id|tty-&gt;flip.tqueue
comma
op_amp
id|tq_timer
)paren
suffix:semicolon
)brace
)brace
r_else
id|r
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|r
op_assign
l_int|1
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
(brace
id|dev-&gt;mdm.rcvsched
(braket
id|midx
)braket
op_assign
l_int|0
suffix:semicolon
id|resched
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|dev-&gt;mdm.rcvsched
(braket
id|midx
)braket
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|resched
)paren
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_MODEMREAD
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/************************************************************&n; *&n; * Modem-functions&n; *&n; * mostly &quot;stolen&quot; from original Linux-serial.c and friends.&n; *&n; ************************************************************/
DECL|function|isdn_tty_dial
r_static
r_void
id|isdn_tty_dial
c_func
(paren
r_char
op_star
id|n
comma
id|modem_info
op_star
id|info
comma
id|atemu
op_star
id|m
)paren
(brace
id|isdn_ctrl
id|cmd
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|i
op_assign
id|isdn_get_free_channel
c_func
(paren
id|ISDN_USAGE_MODEM
comma
id|m-&gt;mdmreg
(braket
l_int|14
)braket
comma
id|m-&gt;mdmreg
(braket
l_int|15
)braket
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|isdn_tty_modem_result
c_func
(paren
l_int|6
comma
id|info
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|m-&gt;msn
)paren
)paren
(brace
id|info-&gt;isdn_driver
op_assign
id|dev-&gt;drvmap
(braket
id|i
)braket
suffix:semicolon
id|info-&gt;isdn_channel
op_assign
id|dev-&gt;chanmap
(braket
id|i
)braket
suffix:semicolon
id|info-&gt;drv_index
op_assign
id|i
suffix:semicolon
id|dev-&gt;m_idx
(braket
id|i
)braket
op_assign
id|info-&gt;line
suffix:semicolon
id|dev-&gt;usage
(braket
id|i
)braket
op_or_assign
id|ISDN_USAGE_OUTGOING
suffix:semicolon
id|isdn_info_update
c_func
(paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|cmd.arg
op_assign
id|info-&gt;isdn_channel
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_CLREAZ
suffix:semicolon
id|dev-&gt;drv
(braket
id|info-&gt;isdn_driver
)braket
op_member_access_from_pointer
id|interface
op_member_access_from_pointer
id|command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|cmd.num
comma
id|isdn_map_eaz2msn
c_func
(paren
id|m-&gt;msn
comma
id|info-&gt;isdn_driver
)paren
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_SETEAZ
suffix:semicolon
id|dev-&gt;drv
(braket
id|info-&gt;isdn_driver
)braket
op_member_access_from_pointer
id|interface
op_member_access_from_pointer
id|command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_SETL2
suffix:semicolon
id|cmd.arg
op_assign
id|info-&gt;isdn_channel
op_plus
(paren
id|m-&gt;mdmreg
(braket
l_int|14
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
id|dev-&gt;drv
(braket
id|info-&gt;isdn_driver
)braket
op_member_access_from_pointer
id|interface
op_member_access_from_pointer
id|command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_SETL3
suffix:semicolon
id|cmd.arg
op_assign
id|info-&gt;isdn_channel
op_plus
(paren
id|m-&gt;mdmreg
(braket
l_int|15
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
id|dev-&gt;drv
(braket
id|info-&gt;isdn_driver
)braket
op_member_access_from_pointer
id|interface
op_member_access_from_pointer
id|command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|cmd.arg
op_assign
id|info-&gt;isdn_channel
suffix:semicolon
id|sprintf
c_func
(paren
id|cmd.num
comma
l_string|&quot;%s,%s,%d,%d&quot;
comma
id|n
comma
id|isdn_map_eaz2msn
c_func
(paren
id|m-&gt;msn
comma
id|info-&gt;isdn_driver
)paren
comma
id|m-&gt;mdmreg
(braket
l_int|18
)braket
comma
id|m-&gt;mdmreg
(braket
l_int|19
)braket
)paren
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_DIAL
suffix:semicolon
id|dev-&gt;mdm.dialing
(braket
id|info-&gt;line
)braket
op_assign
l_int|1
suffix:semicolon
id|strcpy
c_func
(paren
id|dev-&gt;num
(braket
id|i
)braket
comma
id|n
)paren
suffix:semicolon
id|isdn_info_update
c_func
(paren
)paren
suffix:semicolon
id|dev-&gt;drv
(braket
id|info-&gt;isdn_driver
)braket
op_member_access_from_pointer
id|interface
op_member_access_from_pointer
id|command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
)brace
r_else
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
DECL|function|isdn_tty_modem_hup
r_void
id|isdn_tty_modem_hup
c_func
(paren
id|modem_info
op_star
id|info
)paren
(brace
id|isdn_ctrl
id|cmd
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
r_return
suffix:semicolon
id|dev-&gt;mdm.rcvsched
(braket
id|info-&gt;line
)braket
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;mdm.online
(braket
id|info-&gt;line
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;isdn_driver
op_ge
l_int|0
)paren
(brace
id|cmd.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_HANGUP
suffix:semicolon
id|cmd.arg
op_assign
id|info-&gt;isdn_channel
suffix:semicolon
id|dev-&gt;drv
(braket
id|info-&gt;isdn_driver
)braket
op_member_access_from_pointer
id|interface
op_member_access_from_pointer
id|command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|isdn_all_eaz
c_func
(paren
id|info-&gt;isdn_driver
comma
id|info-&gt;isdn_channel
)paren
suffix:semicolon
id|isdn_free_channel
c_func
(paren
id|info-&gt;isdn_driver
comma
id|info-&gt;isdn_channel
comma
id|ISDN_USAGE_MODEM
)paren
suffix:semicolon
)brace
id|info-&gt;isdn_driver
op_assign
op_minus
l_int|1
suffix:semicolon
id|info-&gt;isdn_channel
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;drv_index
op_ge
l_int|0
)paren
(brace
id|info-&gt;drv_index
op_assign
op_minus
l_int|1
suffix:semicolon
id|dev-&gt;m_idx
(braket
id|info-&gt;drv_index
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
)brace
DECL|function|isdn_tty_paranoia_check
r_static
r_inline
r_int
id|isdn_tty_paranoia_check
c_func
(paren
id|modem_info
op_star
id|info
comma
id|kdev_t
id|device
comma
r_const
r_char
op_star
id|routine
)paren
(brace
macro_line|#ifdef MODEM_PARANOIA_CHECK
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_tty: null info_struct for (%d, %d) in %s&bslash;n&quot;
comma
id|MAJOR
c_func
(paren
id|device
)paren
comma
id|MINOR
c_func
(paren
id|device
)paren
comma
id|routine
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;magic
op_ne
id|ISDN_ASYNC_MAGIC
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_tty: bad magic for modem struct (%d, %d) in %s&bslash;n&quot;
comma
id|MAJOR
c_func
(paren
id|device
)paren
comma
id|MINOR
c_func
(paren
id|device
)paren
comma
id|routine
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This routine is called to set the UART divisor registers to match&n; * the specified baud rate for a serial port.&n; */
DECL|function|isdn_tty_change_speed
r_static
r_void
id|isdn_tty_change_speed
c_func
(paren
id|modem_info
op_star
id|info
)paren
(brace
id|uint
id|cflag
comma
id|cval
comma
id|fcr
comma
id|quot
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tty
op_logical_or
op_logical_neg
id|info-&gt;tty-&gt;termios
)paren
r_return
suffix:semicolon
id|cflag
op_assign
id|info-&gt;tty-&gt;termios-&gt;c_cflag
suffix:semicolon
id|quot
op_assign
id|i
op_assign
id|cflag
op_amp
id|CBAUD
suffix:semicolon
r_if
c_cond
(paren
id|i
op_amp
id|CBAUDEX
)paren
(brace
id|i
op_and_assign
op_complement
id|CBAUDEX
suffix:semicolon
r_if
c_cond
(paren
id|i
template_param
l_int|2
)paren
id|info-&gt;tty-&gt;termios-&gt;c_cflag
op_and_assign
op_complement
id|CBAUDEX
suffix:semicolon
r_else
id|i
op_add_assign
l_int|15
suffix:semicolon
)brace
r_if
c_cond
(paren
id|quot
)paren
(brace
id|info-&gt;MCR
op_or_assign
id|UART_MCR_DTR
suffix:semicolon
)brace
r_else
(brace
id|info-&gt;MCR
op_and_assign
op_complement
id|UART_MCR_DTR
suffix:semicolon
id|isdn_tty_modem_reset_regs
c_func
(paren
op_amp
id|dev-&gt;mdm.atmodem
(braket
id|info-&gt;line
)braket
comma
l_int|0
)paren
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_HUP
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Mhup in changespeed&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|isdn_tty_modem_hup
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;mdm.online
(braket
id|info-&gt;line
)braket
)paren
id|isdn_tty_modem_result
c_func
(paren
l_int|3
comma
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* byte size and parity */
id|cval
op_assign
id|cflag
op_amp
(paren
id|CSIZE
op_or
id|CSTOPB
)paren
suffix:semicolon
id|cval
op_rshift_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|cflag
op_amp
id|PARENB
)paren
id|cval
op_or_assign
id|UART_LCR_PARITY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|cflag
op_amp
id|PARODD
)paren
)paren
id|cval
op_or_assign
id|UART_LCR_EPAR
suffix:semicolon
id|fcr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* CTS flow control flag and modem status interrupts */
r_if
c_cond
(paren
id|cflag
op_amp
id|CRTSCTS
)paren
(brace
id|info-&gt;flags
op_or_assign
id|ISDN_ASYNC_CTS_FLOW
suffix:semicolon
)brace
r_else
id|info-&gt;flags
op_and_assign
op_complement
id|ISDN_ASYNC_CTS_FLOW
suffix:semicolon
r_if
c_cond
(paren
id|cflag
op_amp
id|CLOCAL
)paren
id|info-&gt;flags
op_and_assign
op_complement
id|ISDN_ASYNC_CHECK_CD
suffix:semicolon
r_else
(brace
id|info-&gt;flags
op_or_assign
id|ISDN_ASYNC_CHECK_CD
suffix:semicolon
)brace
)brace
DECL|function|isdn_tty_startup
r_static
r_int
id|isdn_tty_startup
c_func
(paren
id|modem_info
op_star
id|info
)paren
(brace
id|ulong
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_INITIALIZED
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;type
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;tty
)paren
id|set_bit
c_func
(paren
id|TTY_IO_ERROR
comma
op_amp
id|info-&gt;tty-&gt;flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_OPEN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;starting up ttyi%d ...&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * Now, initialize the UART &n;&t; */
id|info-&gt;MCR
op_assign
id|UART_MCR_DTR
op_or
id|UART_MCR_RTS
op_or
id|UART_MCR_OUT2
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tty
)paren
id|clear_bit
c_func
(paren
id|TTY_IO_ERROR
comma
op_amp
id|info-&gt;tty-&gt;flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * and set the speed of the serial port&n;&t; */
id|isdn_tty_change_speed
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;flags
op_or_assign
id|ISDN_ASYNC_INITIALIZED
suffix:semicolon
id|dev-&gt;mdm.msr
(braket
id|info-&gt;line
)braket
op_or_assign
id|UART_MSR_DSR
suffix:semicolon
macro_line|#if FUTURE
id|info-&gt;send_outstanding
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This routine will shutdown a serial port; interrupts are disabled, and&n; * DTR is dropped if the hangup on close termio flag is on.&n; */
DECL|function|isdn_tty_shutdown
r_static
r_void
id|isdn_tty_shutdown
c_func
(paren
id|modem_info
op_star
id|info
)paren
(brace
id|ulong
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_INITIALIZED
)paren
)paren
r_return
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_OPEN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Shutting down isdnmodem port %d ....&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts */
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tty
op_logical_or
(paren
id|info-&gt;tty-&gt;termios-&gt;c_cflag
op_amp
id|HUPCL
)paren
)paren
(brace
id|info-&gt;MCR
op_and_assign
op_complement
(paren
id|UART_MCR_DTR
op_or
id|UART_MCR_RTS
)paren
suffix:semicolon
id|isdn_tty_modem_reset_regs
c_func
(paren
op_amp
id|dev-&gt;mdm.atmodem
(braket
id|info-&gt;line
)braket
comma
l_int|0
)paren
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_HUP
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Mhup in isdn_tty_shutdown&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|isdn_tty_modem_hup
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;tty
)paren
id|set_bit
c_func
(paren
id|TTY_IO_ERROR
comma
op_amp
id|info-&gt;tty-&gt;flags
)paren
suffix:semicolon
id|info-&gt;flags
op_and_assign
op_complement
id|ISDN_ASYNC_INITIALIZED
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|isdn_tty_write
r_static
r_int
id|isdn_tty_write
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|from_user
comma
r_const
id|u_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
id|c
comma
id|total
op_assign
l_int|0
suffix:semicolon
id|modem_info
op_star
id|info
op_assign
(paren
id|modem_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|isdn_tty_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;isdn_tty_write&quot;
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
)paren
r_return
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|c
op_assign
id|MIN
c_func
(paren
id|count
comma
id|info-&gt;xmit_size
op_minus
id|info-&gt;xmit_count
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;isdn_driver
op_ge
l_int|0
)paren
(brace
macro_line|#if 0
r_if
c_cond
(paren
id|info-&gt;isdn_driver
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;FIDO: Zwei HW-Treiber geladen? Ansonsten ist was faul.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_int
id|drvidx
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|driver
op_star
id|driv
op_assign
id|dev-&gt;drv
(braket
id|drvidx
)braket
suffix:semicolon
id|i
op_assign
id|driv-&gt;maxbufsize
suffix:semicolon
macro_line|#else
id|i
op_assign
id|dev-&gt;drv
(braket
id|info-&gt;isdn_driver
)braket
op_member_access_from_pointer
id|maxbufsize
suffix:semicolon
macro_line|#endif
id|c
op_assign
id|MIN
c_func
(paren
id|c
comma
id|i
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|c
op_le
l_int|0
)paren
r_break
suffix:semicolon
id|i
op_assign
id|info-&gt;line
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;mdm.online
(braket
id|i
)braket
)paren
(brace
id|isdn_tty_check_esc
c_func
(paren
id|buf
comma
id|dev-&gt;mdm.atmodem
(braket
id|i
)braket
dot
id|mdmreg
(braket
l_int|2
)braket
comma
id|c
comma
op_amp
(paren
id|dev-&gt;mdm.atmodem
(braket
id|i
)braket
dot
id|pluscount
)paren
comma
op_amp
(paren
id|dev-&gt;mdm.atmodem
(braket
id|i
)braket
dot
id|lastplus
)paren
comma
id|from_user
)paren
suffix:semicolon
r_if
c_cond
(paren
id|from_user
)paren
id|memcpy_fromfs
c_func
(paren
op_amp
(paren
id|info-&gt;xmit_buf
(braket
id|info-&gt;xmit_count
)braket
)paren
comma
id|buf
comma
id|c
)paren
suffix:semicolon
r_else
id|memcpy
c_func
(paren
op_amp
(paren
id|info-&gt;xmit_buf
(braket
id|info-&gt;xmit_count
)braket
)paren
comma
id|buf
comma
id|c
)paren
suffix:semicolon
id|info-&gt;xmit_count
op_add_assign
id|c
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;mdm.atmodem
(braket
id|i
)braket
dot
id|mdmreg
(braket
l_int|13
)braket
op_amp
l_int|1
)paren
(brace
r_char
op_star
id|bufptr
suffix:semicolon
r_int
id|buflen
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;WB1: %d&bslash;n&quot;
comma
id|info-&gt;xmit_count
)paren
suffix:semicolon
macro_line|#endif
id|bufptr
op_assign
id|info-&gt;xmit_buf
suffix:semicolon
id|buflen
op_assign
id|info-&gt;xmit_count
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;mdm.atmodem
(braket
id|i
)braket
dot
id|mdmreg
(braket
l_int|13
)braket
op_amp
l_int|2
)paren
(brace
multiline_comment|/* Add T.70 simplified header */
macro_line|#ifdef ISDN_DEBUG_MODEM_DUMP
id|isdn_dumppkt
c_func
(paren
l_string|&quot;T70pack1:&quot;
comma
id|bufptr
comma
id|buflen
comma
l_int|40
)paren
suffix:semicolon
macro_line|#endif
id|bufptr
op_sub_assign
l_int|4
suffix:semicolon
id|buflen
op_add_assign
l_int|4
suffix:semicolon
id|memcpy
c_func
(paren
id|bufptr
comma
l_string|&quot;&bslash;1&bslash;0&bslash;1&bslash;0&quot;
comma
l_int|4
)paren
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_DUMP
id|isdn_dumppkt
c_func
(paren
l_string|&quot;T70pack2:&quot;
comma
id|bufptr
comma
id|buflen
comma
l_int|40
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|isdn_writebuf_stub
c_func
(paren
id|info-&gt;isdn_driver
comma
id|info-&gt;isdn_channel
comma
id|bufptr
comma
id|buflen
comma
l_int|0
)paren
OG
l_int|0
)paren
(brace
id|info-&gt;xmit_count
op_assign
l_int|0
suffix:semicolon
id|info-&gt;xmit_size
op_assign
id|dev-&gt;mdm.atmodem
(braket
id|i
)braket
dot
id|mdmreg
(braket
l_int|16
)braket
op_star
l_int|16
suffix:semicolon
macro_line|#if FUTURE
id|info-&gt;send_outstanding
op_increment
suffix:semicolon
id|dev-&gt;mdm.msr
(braket
id|i
)braket
op_and_assign
op_complement
id|UART_MSR_CTS
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|dev-&gt;mdm.dialing
(braket
id|i
)braket
)paren
(brace
id|dev-&gt;mdm.dialing
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_HUP
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Mhup in isdn_tty_write&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|isdn_tty_modem_hup
c_func
(paren
id|info
)paren
suffix:semicolon
id|isdn_tty_modem_result
c_func
(paren
l_int|3
comma
id|info
)paren
suffix:semicolon
)brace
r_else
id|c
op_assign
id|isdn_tty_edit_at
c_func
(paren
id|buf
comma
id|c
comma
id|info
comma
id|from_user
)paren
suffix:semicolon
)brace
id|buf
op_add_assign
id|c
suffix:semicolon
id|count
op_sub_assign
id|c
suffix:semicolon
id|total
op_add_assign
id|c
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;xmit_count
)paren
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_MODEMXMIT
comma
l_int|1
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|total
suffix:semicolon
)brace
DECL|function|isdn_tty_write_room
r_static
r_int
id|isdn_tty_write_room
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|modem_info
op_star
id|info
op_assign
(paren
id|modem_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|isdn_tty_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;isdn_tty_write_room&quot;
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;mdm.online
(braket
id|info-&gt;line
)braket
)paren
r_return
id|info-&gt;xmit_size
op_minus
l_int|1
suffix:semicolon
id|ret
op_assign
id|info-&gt;xmit_size
op_minus
id|info-&gt;xmit_count
op_minus
l_int|1
suffix:semicolon
r_return
(paren
id|ret
OL
l_int|0
)paren
ques
c_cond
l_int|0
suffix:colon
id|ret
suffix:semicolon
)brace
DECL|function|isdn_tty_chars_in_buffer
r_static
r_int
id|isdn_tty_chars_in_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|modem_info
op_star
id|info
op_assign
(paren
id|modem_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|isdn_tty_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;isdn_tty_chars_in_buffer&quot;
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;mdm.online
(braket
id|info-&gt;line
)braket
)paren
r_return
l_int|0
suffix:semicolon
r_return
(paren
id|info-&gt;xmit_count
)paren
suffix:semicolon
)brace
DECL|function|isdn_tty_flush_buffer
r_static
r_void
id|isdn_tty_flush_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|modem_info
op_star
id|info
op_assign
(paren
id|modem_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|uint
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|isdn_tty_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;isdn_tty_flush_buffer&quot;
)paren
)paren
r_return
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|info-&gt;xmit_count
op_assign
l_int|0
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty
)paren
suffix:semicolon
)brace
DECL|function|isdn_tty_flush_chars
r_static
r_void
id|isdn_tty_flush_chars
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|modem_info
op_star
id|info
op_assign
(paren
id|modem_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|isdn_tty_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;isdn_tty_flush_chars&quot;
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;xmit_count
OG
l_int|0
)paren
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_MODEMXMIT
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * ------------------------------------------------------------&n; * isdn_tty_throttle()&n; * &n; * This routine is called by the upper-layer tty layer to signal that&n; * incoming characters should be throttled.&n; * ------------------------------------------------------------&n; */
DECL|function|isdn_tty_throttle
r_static
r_void
id|isdn_tty_throttle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|modem_info
op_star
id|info
op_assign
(paren
id|modem_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|isdn_tty_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;isdn_tty_throttle&quot;
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|I_IXOFF
c_func
(paren
id|tty
)paren
)paren
id|info-&gt;x_char
op_assign
id|STOP_CHAR
c_func
(paren
id|tty
)paren
suffix:semicolon
id|info-&gt;MCR
op_and_assign
op_complement
id|UART_MCR_RTS
suffix:semicolon
)brace
DECL|function|isdn_tty_unthrottle
r_static
r_void
id|isdn_tty_unthrottle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|modem_info
op_star
id|info
op_assign
(paren
id|modem_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|isdn_tty_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;isdn_tty_unthrottle&quot;
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|I_IXOFF
c_func
(paren
id|tty
)paren
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;x_char
)paren
id|info-&gt;x_char
op_assign
l_int|0
suffix:semicolon
r_else
id|info-&gt;x_char
op_assign
id|START_CHAR
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
id|info-&gt;MCR
op_or_assign
id|UART_MCR_RTS
suffix:semicolon
)brace
multiline_comment|/*&n; * ------------------------------------------------------------&n; * isdn_tty_ioctl() and friends&n; * ------------------------------------------------------------&n; */
multiline_comment|/*&n; * isdn_tty_get_lsr_info - get line status register info&n; *&n; * Purpose: Let user call ioctl() to get info when the UART physically&n; *          is emptied.  On bus types like RS485, the transmitter must&n; *          release the bus after transmitting. This must be done when&n; *          the transmit shift register is empty, not be done when the&n; *          transmit holding register is empty.  This functionality&n; *          allows RS485 driver to be written in user space. &n; */
DECL|function|isdn_tty_get_lsr_info
r_static
r_int
id|isdn_tty_get_lsr_info
c_func
(paren
id|modem_info
op_star
id|info
comma
id|uint
op_star
id|value
)paren
(brace
id|u_char
id|status
suffix:semicolon
id|uint
id|result
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|status
op_assign
id|dev-&gt;mdm.msr
(braket
id|info-&gt;line
)braket
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|result
op_assign
(paren
(paren
id|status
op_amp
id|UART_LSR_TEMT
)paren
ques
c_cond
id|TIOCSER_TEMT
suffix:colon
l_int|0
)paren
suffix:semicolon
id|put_fs_long
c_func
(paren
id|result
comma
(paren
id|ulong
op_star
)paren
id|value
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|isdn_tty_get_modem_info
r_static
r_int
id|isdn_tty_get_modem_info
c_func
(paren
id|modem_info
op_star
id|info
comma
id|uint
op_star
id|value
)paren
(brace
id|u_char
id|control
comma
id|status
suffix:semicolon
id|uint
id|result
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
id|control
op_assign
id|info-&gt;MCR
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|status
op_assign
id|dev-&gt;mdm.msr
(braket
id|info-&gt;line
)braket
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|result
op_assign
(paren
(paren
id|control
op_amp
id|UART_MCR_RTS
)paren
ques
c_cond
id|TIOCM_RTS
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|control
op_amp
id|UART_MCR_DTR
)paren
ques
c_cond
id|TIOCM_DTR
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|status
op_amp
id|UART_MSR_DCD
)paren
ques
c_cond
id|TIOCM_CAR
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|status
op_amp
id|UART_MSR_RI
)paren
ques
c_cond
id|TIOCM_RNG
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|status
op_amp
id|UART_MSR_DSR
)paren
ques
c_cond
id|TIOCM_DSR
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|status
op_amp
id|UART_MSR_CTS
)paren
ques
c_cond
id|TIOCM_CTS
suffix:colon
l_int|0
)paren
suffix:semicolon
id|put_fs_long
c_func
(paren
id|result
comma
(paren
id|ulong
op_star
)paren
id|value
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|isdn_tty_set_modem_info
r_static
r_int
id|isdn_tty_set_modem_info
c_func
(paren
id|modem_info
op_star
id|info
comma
id|uint
id|cmd
comma
id|uint
op_star
id|value
)paren
(brace
id|uint
id|arg
op_assign
id|get_fs_long
c_func
(paren
(paren
id|ulong
op_star
)paren
id|value
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TIOCMBIS
suffix:colon
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_RTS
)paren
(brace
id|info-&gt;MCR
op_or_assign
id|UART_MCR_RTS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_DTR
)paren
(brace
id|info-&gt;MCR
op_or_assign
id|UART_MCR_DTR
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TIOCMBIC
suffix:colon
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_RTS
)paren
(brace
id|info-&gt;MCR
op_and_assign
op_complement
id|UART_MCR_RTS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_DTR
)paren
(brace
id|info-&gt;MCR
op_and_assign
op_complement
id|UART_MCR_DTR
suffix:semicolon
id|isdn_tty_modem_reset_regs
c_func
(paren
op_amp
id|dev-&gt;mdm.atmodem
(braket
id|info-&gt;line
)braket
comma
l_int|0
)paren
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_HUP
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Mhup in TIOCMBIC&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|isdn_tty_modem_hup
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;mdm.online
(braket
id|info-&gt;line
)braket
)paren
id|isdn_tty_modem_result
c_func
(paren
l_int|3
comma
id|info
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TIOCMSET
suffix:colon
id|info-&gt;MCR
op_assign
(paren
(paren
id|info-&gt;MCR
op_amp
op_complement
(paren
id|UART_MCR_RTS
op_or
id|UART_MCR_DTR
)paren
)paren
op_or
(paren
(paren
id|arg
op_amp
id|TIOCM_RTS
)paren
ques
c_cond
id|UART_MCR_RTS
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|arg
op_amp
id|TIOCM_DTR
)paren
ques
c_cond
id|UART_MCR_DTR
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;MCR
op_amp
id|UART_MCR_DTR
)paren
)paren
(brace
id|isdn_tty_modem_reset_regs
c_func
(paren
op_amp
id|dev-&gt;mdm.atmodem
(braket
id|info-&gt;line
)braket
comma
l_int|0
)paren
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_HUP
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Mhup in TIOCMSET&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|isdn_tty_modem_hup
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;mdm.online
(braket
id|info-&gt;line
)braket
)paren
id|isdn_tty_modem_result
c_func
(paren
l_int|3
comma
id|info
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|isdn_tty_ioctl
r_static
r_int
id|isdn_tty_ioctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
id|uint
id|cmd
comma
id|ulong
id|arg
)paren
(brace
id|modem_info
op_star
id|info
op_assign
(paren
id|modem_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
id|error
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_if
c_cond
(paren
id|isdn_tty_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;isdn_tty_ioctl&quot;
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TCSBRK
suffix:colon
multiline_comment|/* SVID version: non-zero arg --&gt; no break */
id|retval
op_assign
id|tty_check_change
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
id|retval
suffix:semicolon
id|tty_wait_until_sent
c_func
(paren
id|tty
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TCSBRKP
suffix:colon
multiline_comment|/* support for POSIX tcsendbreak() */
id|retval
op_assign
id|tty_check_change
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
id|retval
suffix:semicolon
id|tty_wait_until_sent
c_func
(paren
id|tty
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TIOCGSOFTCAR
suffix:colon
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|put_fs_long
c_func
(paren
id|C_CLOCAL
c_func
(paren
id|tty
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
(paren
id|ulong
op_star
)paren
id|arg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TIOCSSOFTCAR
suffix:colon
id|arg
op_assign
id|get_fs_long
c_func
(paren
(paren
id|ulong
op_star
)paren
id|arg
)paren
suffix:semicolon
id|tty-&gt;termios-&gt;c_cflag
op_assign
(paren
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
op_complement
id|CLOCAL
)paren
op_or
(paren
id|arg
ques
c_cond
id|CLOCAL
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TIOCMGET
suffix:colon
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|uint
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
r_return
id|isdn_tty_get_modem_info
c_func
(paren
id|info
comma
(paren
id|uint
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|TIOCMBIS
suffix:colon
r_case
id|TIOCMBIC
suffix:colon
r_case
id|TIOCMSET
suffix:colon
r_return
id|isdn_tty_set_modem_info
c_func
(paren
id|info
comma
id|cmd
comma
(paren
id|uint
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|TIOCSERGETLSR
suffix:colon
multiline_comment|/* Get line status register */
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|uint
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
r_else
r_return
id|isdn_tty_get_lsr_info
c_func
(paren
id|info
comma
(paren
id|uint
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|TIOCGSERIAL
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
macro_line|#if 0
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|serial_struct
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
r_return
id|get_serial_info
c_func
(paren
id|info
comma
(paren
r_struct
id|serial_struct
op_star
)paren
id|arg
)paren
suffix:semicolon
macro_line|#endif
r_case
id|TIOCSSERIAL
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
macro_line|#if 0
r_return
id|set_serial_info
c_func
(paren
id|info
comma
(paren
r_struct
id|serial_struct
op_star
)paren
id|arg
)paren
suffix:semicolon
macro_line|#endif
r_case
id|TIOCSERCONFIG
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
macro_line|#if 0
r_return
id|do_autoconfig
c_func
(paren
id|info
)paren
suffix:semicolon
macro_line|#endif
r_case
id|TIOCSERGWILD
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
macro_line|#if 0
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|put_fs_long
c_func
(paren
id|modem_wild_int_mask
comma
(paren
id|ulong
op_star
)paren
id|arg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#endif
r_case
id|TIOCSERSWILD
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|modem_wild_int_mask
op_assign
id|get_fs_long
c_func
(paren
(paren
id|ulong
op_star
)paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|modem_wild_int_mask
OL
l_int|0
)paren
id|modem_wild_int_mask
op_assign
id|check_wild_interrupts
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#endif
r_case
id|TIOCSERGSTRUCT
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
macro_line|#if 0
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|modem_info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|memcpy_tofs
c_func
(paren
(paren
id|modem_info
op_star
)paren
id|arg
comma
id|info
comma
r_sizeof
(paren
id|modem_info
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
macro_line|#ifdef ISDN_DEBUG_MODEM_IOCTL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;unsupp. ioctl 0x%08x on ttyi%d&bslash;n&quot;
comma
id|cmd
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|isdn_tty_set_termios
r_static
r_void
id|isdn_tty_set_termios
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|termios
op_star
id|old_termios
)paren
(brace
id|modem_info
op_star
id|info
op_assign
(paren
id|modem_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;termios-&gt;c_cflag
op_eq
id|old_termios-&gt;c_cflag
)paren
r_return
suffix:semicolon
id|isdn_tty_change_speed
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|old_termios-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
op_logical_and
op_logical_neg
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
)paren
(brace
id|tty-&gt;hw_stopped
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * ------------------------------------------------------------&n; * isdn_tty_open() and friends&n; * ------------------------------------------------------------&n; */
DECL|function|isdn_tty_block_til_ready
r_static
r_int
id|isdn_tty_block_til_ready
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
comma
id|modem_info
op_star
id|info
)paren
(brace
r_struct
id|wait_queue
id|wait
op_assign
(brace
id|current
comma
l_int|NULL
)brace
suffix:semicolon
r_int
id|do_clocal
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|retval
suffix:semicolon
multiline_comment|/*&n;&t; * If the device is in the middle of being closed, then block&n;&t; * until it&squot;s done, and then try again.&n;&t; */
r_if
c_cond
(paren
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
op_logical_or
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_CLOSING
)paren
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_CLOSING
)paren
id|interruptible_sleep_on
c_func
(paren
op_amp
id|info-&gt;close_wait
)paren
suffix:semicolon
macro_line|#ifdef MODEM_DO_RESTART
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_HUP_NOTIFY
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_else
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
macro_line|#else
r_return
op_minus
id|EAGAIN
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n;&t; * If this is a callout device, then just make sure the normal&n;&t; * device isn&squot;t being used.&n;&t; */
r_if
c_cond
(paren
id|tty-&gt;driver.subtype
op_eq
id|ISDN_SERIAL_TYPE_CALLOUT
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_NORMAL_ACTIVE
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_CALLOUT_ACTIVE
)paren
op_logical_and
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_SESSION_LOCKOUT
)paren
op_logical_and
(paren
id|info-&gt;session
op_ne
id|current-&gt;session
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_CALLOUT_ACTIVE
)paren
op_logical_and
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_PGRP_LOCKOUT
)paren
op_logical_and
(paren
id|info-&gt;pgrp
op_ne
id|current-&gt;pgrp
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|info-&gt;flags
op_or_assign
id|ISDN_ASYNC_CALLOUT_ACTIVE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * If non-blocking mode is set, then make the check up front&n;&t; * and then exit.&n;&t; */
r_if
c_cond
(paren
id|filp-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_CALLOUT_ACTIVE
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|info-&gt;flags
op_or_assign
id|ISDN_ASYNC_NORMAL_ACTIVE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_CALLOUT_ACTIVE
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;normal_termios.c_cflag
op_amp
id|CLOCAL
)paren
id|do_clocal
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CLOCAL
)paren
id|do_clocal
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Block waiting for the carrier detect and the line to become&n;&t; * free (i.e., not in use by the callout).  While we are in&n;&t; * this loop, info-&gt;count is dropped by one, so that&n;&t; * isdn_tty_close() knows when to free things.  We restore it upon&n;&t; * exit, either normal or abnormal.&n;&t; */
id|retval
op_assign
l_int|0
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|info-&gt;open_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_OPEN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_tty_block_til_ready before block: ttyi%d, count = %d&bslash;n&quot;
comma
id|info-&gt;line
comma
id|info-&gt;count
)paren
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
)paren
)paren
id|info-&gt;count
op_decrement
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|info-&gt;blocked_open
op_increment
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
r_if
c_cond
(paren
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
op_logical_or
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_INITIALIZED
)paren
)paren
(brace
macro_line|#ifdef MODEM_DO_RESTART
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_HUP_NOTIFY
)paren
id|retval
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
macro_line|#else
id|retval
op_assign
op_minus
id|EAGAIN
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_CALLOUT_ACTIVE
)paren
op_logical_and
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_CLOSING
)paren
op_logical_and
(paren
id|do_clocal
op_logical_or
(paren
id|dev-&gt;mdm.msr
(braket
id|info-&gt;line
)braket
op_amp
id|UART_MSR_DCD
)paren
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|current-&gt;signal
op_amp
op_complement
id|current-&gt;blocked
)paren
(brace
id|retval
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#ifdef ISDN_DEBUG_MODEM_OPEN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_tty_block_til_ready blocking: ttyi%d, count = %d&bslash;n&quot;
comma
id|info-&gt;line
comma
id|info-&gt;count
)paren
suffix:semicolon
macro_line|#endif
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|info-&gt;open_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
)paren
id|info-&gt;count
op_increment
suffix:semicolon
id|info-&gt;blocked_open
op_decrement
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_OPEN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_tty_block_til_ready after blocking: ttyi%d, count = %d&bslash;n&quot;
comma
id|info-&gt;line
comma
id|info-&gt;count
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|retval
)paren
r_return
id|retval
suffix:semicolon
id|info-&gt;flags
op_or_assign
id|ISDN_ASYNC_NORMAL_ACTIVE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This routine is called whenever a serial port is opened.  It&n; * enables interrupts for a serial port, linking in its async structure into&n; * the IRQ chain.   It also performs the serial-specific&n; * initialization for the tty structure.&n; */
DECL|function|isdn_tty_open
r_static
r_int
id|isdn_tty_open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|modem_info
op_star
id|info
suffix:semicolon
r_int
id|retval
comma
id|line
suffix:semicolon
id|line
op_assign
id|MINOR
c_func
(paren
id|tty-&gt;device
)paren
op_minus
id|tty-&gt;driver.minor_start
suffix:semicolon
r_if
c_cond
(paren
id|line
template_param
id|ISDN_MAX_CHANNELS
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|info
op_assign
op_amp
id|dev-&gt;mdm.info
(braket
id|line
)braket
suffix:semicolon
r_if
c_cond
(paren
id|isdn_tty_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;isdn_tty_open&quot;
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_OPEN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_tty_open %s%d, count = %d&bslash;n&quot;
comma
id|tty-&gt;driver.name
comma
id|info-&gt;line
comma
id|info-&gt;count
)paren
suffix:semicolon
macro_line|#endif
id|info-&gt;count
op_increment
suffix:semicolon
id|tty-&gt;driver_data
op_assign
id|info
suffix:semicolon
id|info-&gt;tty
op_assign
id|tty
suffix:semicolon
multiline_comment|/*&n;&t; * Start up serial port&n;&t; */
id|retval
op_assign
id|isdn_tty_startup
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
macro_line|#ifdef ISDN_DEBUG_MODEM_OPEN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_tty_open return after startup&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|retval
suffix:semicolon
)brace
id|retval
op_assign
id|isdn_tty_block_til_ready
c_func
(paren
id|tty
comma
id|filp
comma
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
macro_line|#ifdef ISDN_DEBUG_MODEM_OPEN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_tty_open return after isdn_tty_block_til_ready &bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|retval
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|info-&gt;count
op_eq
l_int|1
)paren
op_logical_and
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_SPLIT_TERMIOS
)paren
)paren
(brace
r_if
c_cond
(paren
id|tty-&gt;driver.subtype
op_eq
id|ISDN_SERIAL_TYPE_NORMAL
)paren
op_star
id|tty-&gt;termios
op_assign
id|info-&gt;normal_termios
suffix:semicolon
r_else
op_star
id|tty-&gt;termios
op_assign
id|info-&gt;callout_termios
suffix:semicolon
id|isdn_tty_change_speed
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
id|info-&gt;session
op_assign
id|current-&gt;session
suffix:semicolon
id|info-&gt;pgrp
op_assign
id|current-&gt;pgrp
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_OPEN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_tty_open ttyi%d successful...&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
id|dev-&gt;modempoll
op_increment
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_OPEN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_tty_open normal exit&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|isdn_tty_close
r_static
r_void
id|isdn_tty_close
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|modem_info
op_star
id|info
op_assign
(paren
id|modem_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
id|ulong
id|timeout
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
op_logical_or
id|isdn_tty_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;isdn_tty_close&quot;
)paren
)paren
r_return
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_OPEN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_tty_close return after tty_hung_up_p&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
id|dev-&gt;modempoll
op_decrement
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tty-&gt;count
op_eq
l_int|1
)paren
op_logical_and
(paren
id|info-&gt;count
op_ne
l_int|1
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * Uh, oh.  tty-&gt;count is 1, which means that the tty&n;&t;&t; * structure will be freed.  Info-&gt;count should always&n;&t;&t; * be one in these conditions.  If it&squot;s greater than&n;&t;&t; * one, we&squot;ve got real problems, since it means the&n;&t;&t; * serial port won&squot;t be shutdown.&n;&t;&t; */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;isdn_tty_close: bad port count; tty-&gt;count is 1, &quot;
l_string|&quot;info-&gt;count is %d&bslash;n&quot;
comma
id|info-&gt;count
)paren
suffix:semicolon
id|info-&gt;count
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_decrement
id|info-&gt;count
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;isdn_tty_close: bad port count for ttyi%d: %d&bslash;n&quot;
comma
id|info-&gt;line
comma
id|info-&gt;count
)paren
suffix:semicolon
id|info-&gt;count
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;count
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_OPEN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_tty_close after info-&gt;count != 0&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
id|info-&gt;flags
op_or_assign
id|ISDN_ASYNC_CLOSING
suffix:semicolon
multiline_comment|/*&n;&t; * Save the termios structure, since this port may have&n;&t; * separate termios for callout and dialin.&n;&t; */
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_NORMAL_ACTIVE
)paren
id|info-&gt;normal_termios
op_assign
op_star
id|tty-&gt;termios
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_CALLOUT_ACTIVE
)paren
id|info-&gt;callout_termios
op_assign
op_star
id|tty-&gt;termios
suffix:semicolon
id|tty-&gt;closing
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * At this point we stop accepting input.  To do this, we&n;&t; * disable the receive line status interrupts, and tell the&n;&t; * interrupt driver to stop checking the data ready bit in the&n;&t; * line status register.&n;&t; */
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_INITIALIZED
)paren
(brace
id|tty_wait_until_sent
c_func
(paren
id|tty
comma
l_int|3000
)paren
suffix:semicolon
multiline_comment|/* 30 seconds timeout */
multiline_comment|/*&n;&t;&t; * Before we drop DTR, make sure the UART transmitter&n;&t;&t; * has completely drained; this is especially&n;&t;&t; * important if there is a transmit FIFO!&n;&t;&t; */
id|timeout
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|dev-&gt;mdm.mlr
(braket
id|info-&gt;line
)braket
op_amp
id|UART_LSR_TEMT
)paren
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|current-&gt;timeout
op_assign
id|jiffies
op_plus
l_int|20
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
OG
id|timeout
)paren
r_break
suffix:semicolon
)brace
)brace
id|isdn_tty_shutdown
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;driver.flush_buffer
)paren
id|tty-&gt;driver
dot
id|flush_buffer
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;ldisc.flush_buffer
)paren
id|tty-&gt;ldisc
dot
id|flush_buffer
c_func
(paren
id|tty
)paren
suffix:semicolon
id|info-&gt;tty
op_assign
l_int|0
suffix:semicolon
id|tty-&gt;closing
op_assign
l_int|0
suffix:semicolon
macro_line|#if 00
r_if
c_cond
(paren
id|tty-&gt;ldisc.num
op_ne
id|ldiscs
(braket
id|N_TTY
)braket
dot
id|num
)paren
(brace
r_if
c_cond
(paren
id|tty-&gt;ldisc.close
)paren
(paren
id|tty-&gt;ldisc.close
)paren
(paren
id|tty
)paren
suffix:semicolon
id|tty-&gt;ldisc
op_assign
id|ldiscs
(braket
id|N_TTY
)braket
suffix:semicolon
id|tty-&gt;termios-&gt;c_line
op_assign
id|N_TTY
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;ldisc.open
)paren
(paren
id|tty-&gt;ldisc.open
)paren
(paren
id|tty
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|info-&gt;blocked_open
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;close_delay
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|current-&gt;timeout
op_assign
id|jiffies
op_plus
id|info-&gt;close_delay
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;open_wait
)paren
suffix:semicolon
)brace
id|info-&gt;flags
op_and_assign
op_complement
(paren
id|ISDN_ASYNC_NORMAL_ACTIVE
op_or
id|ISDN_ASYNC_CALLOUT_ACTIVE
op_or
id|ISDN_ASYNC_CLOSING
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;close_wait
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_OPEN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_tty_close normal exit&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * isdn_tty_hangup() --- called by tty_hangup() when a hangup is signaled.&n; */
DECL|function|isdn_tty_hangup
r_static
r_void
id|isdn_tty_hangup
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|modem_info
op_star
id|info
op_assign
(paren
id|modem_info
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|isdn_tty_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;isdn_tty_hangup&quot;
)paren
)paren
r_return
suffix:semicolon
id|isdn_tty_shutdown
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;count
op_assign
l_int|0
suffix:semicolon
id|info-&gt;flags
op_and_assign
op_complement
(paren
id|ISDN_ASYNC_NORMAL_ACTIVE
op_or
id|ISDN_ASYNC_CALLOUT_ACTIVE
)paren
suffix:semicolon
id|info-&gt;tty
op_assign
l_int|0
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;open_wait
)paren
suffix:semicolon
)brace
DECL|function|isdn_tty_reset_profile
r_static
r_void
id|isdn_tty_reset_profile
c_func
(paren
id|atemu
op_star
id|m
)paren
(brace
id|m-&gt;profile
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|m-&gt;profile
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|m-&gt;profile
(braket
l_int|2
)braket
op_assign
l_int|43
suffix:semicolon
id|m-&gt;profile
(braket
l_int|3
)braket
op_assign
l_int|13
suffix:semicolon
id|m-&gt;profile
(braket
l_int|4
)braket
op_assign
l_int|10
suffix:semicolon
id|m-&gt;profile
(braket
l_int|5
)braket
op_assign
l_int|8
suffix:semicolon
id|m-&gt;profile
(braket
l_int|6
)braket
op_assign
l_int|3
suffix:semicolon
id|m-&gt;profile
(braket
l_int|7
)braket
op_assign
l_int|60
suffix:semicolon
id|m-&gt;profile
(braket
l_int|8
)braket
op_assign
l_int|2
suffix:semicolon
id|m-&gt;profile
(braket
l_int|9
)braket
op_assign
l_int|6
suffix:semicolon
id|m-&gt;profile
(braket
l_int|10
)braket
op_assign
l_int|7
suffix:semicolon
id|m-&gt;profile
(braket
l_int|11
)braket
op_assign
l_int|70
suffix:semicolon
id|m-&gt;profile
(braket
l_int|12
)braket
op_assign
l_int|0x45
suffix:semicolon
id|m-&gt;profile
(braket
l_int|13
)braket
op_assign
l_int|0
suffix:semicolon
id|m-&gt;profile
(braket
l_int|14
)braket
op_assign
id|ISDN_PROTO_L2_X75I
suffix:semicolon
id|m-&gt;profile
(braket
l_int|15
)braket
op_assign
id|ISDN_PROTO_L3_TRANS
suffix:semicolon
id|m-&gt;profile
(braket
l_int|16
)braket
op_assign
id|ISDN_SERIAL_XMIT_SIZE
op_div
l_int|16
suffix:semicolon
id|m-&gt;profile
(braket
l_int|17
)braket
op_assign
id|ISDN_MODEM_WINSIZE
suffix:semicolon
id|m-&gt;profile
(braket
l_int|18
)braket
op_assign
l_int|7
suffix:semicolon
id|m-&gt;profile
(braket
l_int|19
)braket
op_assign
l_int|0
suffix:semicolon
id|m-&gt;pmsn
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
DECL|function|isdn_tty_modem_reset_regs
r_static
r_void
id|isdn_tty_modem_reset_regs
c_func
(paren
id|atemu
op_star
id|m
comma
r_int
id|force
)paren
(brace
r_if
c_cond
(paren
(paren
id|m-&gt;mdmreg
(braket
l_int|12
)braket
op_amp
l_int|32
)paren
op_logical_or
id|force
)paren
(brace
id|memcpy
c_func
(paren
id|m-&gt;mdmreg
comma
id|m-&gt;profile
comma
id|ISDN_MODEM_ANZREG
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|m-&gt;msn
comma
id|m-&gt;pmsn
comma
id|ISDN_MSNLEN
)paren
suffix:semicolon
)brace
id|m-&gt;mdmcmdl
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|modem_write_profile
r_static
r_void
id|modem_write_profile
c_func
(paren
id|atemu
op_star
id|m
)paren
(brace
id|memcpy
c_func
(paren
id|m-&gt;profile
comma
id|m-&gt;mdmreg
comma
id|ISDN_MODEM_ANZREG
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|m-&gt;pmsn
comma
id|m-&gt;msn
comma
id|ISDN_MSNLEN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;profd
)paren
id|send_sig
c_func
(paren
id|SIGIO
comma
id|dev-&gt;profd
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|isdn_tty_modem_init
r_int
id|isdn_tty_modem_init
c_func
(paren
r_void
)paren
(brace
id|modem
op_star
id|m
suffix:semicolon
r_int
id|i
suffix:semicolon
id|modem_info
op_star
id|info
suffix:semicolon
id|m
op_assign
op_amp
id|dev-&gt;mdm
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_MAX_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|isdn_tty_reset_profile
c_func
(paren
op_amp
(paren
id|m-&gt;atmodem
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|isdn_tty_modem_reset_regs
c_func
(paren
op_amp
(paren
id|m-&gt;atmodem
(braket
id|i
)braket
)paren
comma
l_int|1
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
op_amp
id|m-&gt;tty_modem
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tty_driver
)paren
)paren
suffix:semicolon
id|m-&gt;tty_modem.magic
op_assign
id|TTY_DRIVER_MAGIC
suffix:semicolon
id|m-&gt;tty_modem.name
op_assign
id|isdn_ttyname_ttyI
suffix:semicolon
id|m-&gt;tty_modem.major
op_assign
id|ISDN_TTY_MAJOR
suffix:semicolon
id|m-&gt;tty_modem.minor_start
op_assign
l_int|0
suffix:semicolon
id|m-&gt;tty_modem.num
op_assign
id|ISDN_MAX_CHANNELS
suffix:semicolon
id|m-&gt;tty_modem.type
op_assign
id|TTY_DRIVER_TYPE_SERIAL
suffix:semicolon
id|m-&gt;tty_modem.subtype
op_assign
id|ISDN_SERIAL_TYPE_NORMAL
suffix:semicolon
id|m-&gt;tty_modem.init_termios
op_assign
id|tty_std_termios
suffix:semicolon
id|m-&gt;tty_modem.init_termios.c_cflag
op_assign
id|B9600
op_or
id|CS8
op_or
id|CREAD
op_or
id|HUPCL
op_or
id|CLOCAL
suffix:semicolon
id|m-&gt;tty_modem.flags
op_assign
id|TTY_DRIVER_REAL_RAW
suffix:semicolon
id|m-&gt;tty_modem.refcount
op_assign
op_amp
id|m-&gt;refcount
suffix:semicolon
id|m-&gt;tty_modem.table
op_assign
id|m-&gt;modem_table
suffix:semicolon
id|m-&gt;tty_modem.termios
op_assign
id|m-&gt;modem_termios
suffix:semicolon
id|m-&gt;tty_modem.termios_locked
op_assign
id|m-&gt;modem_termios_locked
suffix:semicolon
id|m-&gt;tty_modem.open
op_assign
id|isdn_tty_open
suffix:semicolon
id|m-&gt;tty_modem.close
op_assign
id|isdn_tty_close
suffix:semicolon
id|m-&gt;tty_modem.write
op_assign
id|isdn_tty_write
suffix:semicolon
id|m-&gt;tty_modem.put_char
op_assign
l_int|NULL
suffix:semicolon
id|m-&gt;tty_modem.flush_chars
op_assign
id|isdn_tty_flush_chars
suffix:semicolon
id|m-&gt;tty_modem.write_room
op_assign
id|isdn_tty_write_room
suffix:semicolon
id|m-&gt;tty_modem.chars_in_buffer
op_assign
id|isdn_tty_chars_in_buffer
suffix:semicolon
id|m-&gt;tty_modem.flush_buffer
op_assign
id|isdn_tty_flush_buffer
suffix:semicolon
id|m-&gt;tty_modem.ioctl
op_assign
id|isdn_tty_ioctl
suffix:semicolon
id|m-&gt;tty_modem.throttle
op_assign
id|isdn_tty_throttle
suffix:semicolon
id|m-&gt;tty_modem.unthrottle
op_assign
id|isdn_tty_unthrottle
suffix:semicolon
id|m-&gt;tty_modem.set_termios
op_assign
id|isdn_tty_set_termios
suffix:semicolon
id|m-&gt;tty_modem.stop
op_assign
l_int|NULL
suffix:semicolon
id|m-&gt;tty_modem.start
op_assign
l_int|NULL
suffix:semicolon
id|m-&gt;tty_modem.hangup
op_assign
id|isdn_tty_hangup
suffix:semicolon
multiline_comment|/*&n;&t; * The callout device is just like normal device except for&n;&t; * major number and the subtype code.&n;&t; */
id|m-&gt;cua_modem
op_assign
id|m-&gt;tty_modem
suffix:semicolon
id|m-&gt;cua_modem.name
op_assign
id|isdn_ttyname_cui
suffix:semicolon
id|m-&gt;cua_modem.major
op_assign
id|ISDN_TTYAUX_MAJOR
suffix:semicolon
id|m-&gt;tty_modem.minor_start
op_assign
l_int|0
suffix:semicolon
id|m-&gt;cua_modem.subtype
op_assign
id|ISDN_SERIAL_TYPE_CALLOUT
suffix:semicolon
r_if
c_cond
(paren
id|tty_register_driver
c_func
(paren
op_amp
id|m-&gt;tty_modem
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_tty: Couldn&squot;t register modem-device&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tty_register_driver
c_func
(paren
op_amp
id|m-&gt;cua_modem
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_tty: Couldn&squot;t register modem-callout-device&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|2
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_MAX_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|info
op_assign
op_amp
(paren
id|m-&gt;info
(braket
id|i
)braket
)paren
suffix:semicolon
id|info-&gt;magic
op_assign
id|ISDN_ASYNC_MAGIC
suffix:semicolon
id|info-&gt;line
op_assign
id|i
suffix:semicolon
id|info-&gt;tty
op_assign
l_int|0
suffix:semicolon
id|info-&gt;close_delay
op_assign
l_int|50
suffix:semicolon
id|info-&gt;x_char
op_assign
l_int|0
suffix:semicolon
id|info-&gt;count
op_assign
l_int|0
suffix:semicolon
id|info-&gt;blocked_open
op_assign
l_int|0
suffix:semicolon
id|info-&gt;callout_termios
op_assign
id|m-&gt;cua_modem.init_termios
suffix:semicolon
id|info-&gt;normal_termios
op_assign
id|m-&gt;tty_modem.init_termios
suffix:semicolon
id|info-&gt;open_wait
op_assign
l_int|0
suffix:semicolon
id|info-&gt;close_wait
op_assign
l_int|0
suffix:semicolon
id|info-&gt;type
op_assign
id|ISDN_PORT_16550A
suffix:semicolon
id|info-&gt;isdn_driver
op_assign
op_minus
l_int|1
suffix:semicolon
id|info-&gt;isdn_channel
op_assign
op_minus
l_int|1
suffix:semicolon
id|info-&gt;drv_index
op_assign
op_minus
l_int|1
suffix:semicolon
id|info-&gt;xmit_size
op_assign
id|ISDN_SERIAL_XMIT_SIZE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;xmit_buf
op_assign
id|kmalloc
c_func
(paren
id|ISDN_SERIAL_XMIT_SIZE
op_plus
l_int|5
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Could not allocate modem xmit-buffer&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|3
suffix:semicolon
)brace
id|info-&gt;xmit_buf
op_add_assign
l_int|4
suffix:semicolon
multiline_comment|/* Make room for T.70 header */
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * An incoming call-request has arrived.&n; * Search the tty-devices for an appropriate device and bind&n; * it to the ISDN-Channel.&n; * Return Index to dev-&gt;mdm or -1 if none found.&n; */
DECL|function|isdn_tty_find_icall
r_int
id|isdn_tty_find_icall
c_func
(paren
r_int
id|di
comma
r_int
id|ch
comma
r_char
op_star
id|num
)paren
(brace
r_char
op_star
id|eaz
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|idx
suffix:semicolon
r_int
id|si1
suffix:semicolon
r_int
id|si2
suffix:semicolon
r_char
op_star
id|s
suffix:semicolon
r_char
id|nr
(braket
l_int|31
)braket
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num
(braket
l_int|0
)braket
op_eq
l_char|&squot;,&squot;
)paren
(brace
id|nr
(braket
l_int|0
)braket
op_assign
l_char|&squot;0&squot;
suffix:semicolon
id|strncpy
c_func
(paren
op_amp
id|nr
(braket
l_int|1
)braket
comma
id|num
comma
l_int|29
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_tty: Incoming call without OAD, assuming &squot;0&squot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
id|strncpy
c_func
(paren
id|nr
comma
id|num
comma
l_int|30
)paren
suffix:semicolon
id|s
op_assign
id|strtok
c_func
(paren
id|nr
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
id|s
op_assign
id|strtok
c_func
(paren
l_int|NULL
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_tty: Incoming callinfo garbled, ignored: %s&bslash;n&quot;
comma
id|num
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|si1
op_assign
(paren
r_int
)paren
id|simple_strtoul
c_func
(paren
id|s
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
id|s
op_assign
id|strtok
c_func
(paren
l_int|NULL
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_tty: Incoming callinfo garbled, ignored: %s&bslash;n&quot;
comma
id|num
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|si2
op_assign
(paren
r_int
)paren
id|simple_strtoul
c_func
(paren
id|s
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
id|eaz
op_assign
id|strtok
c_func
(paren
l_int|NULL
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|eaz
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_tty: Incoming call without CPN, assuming &squot;0&squot;&bslash;n&quot;
)paren
suffix:semicolon
id|eaz
op_assign
l_string|&quot;0&quot;
suffix:semicolon
)brace
macro_line|#ifdef ISDN_DEBUG_MODEM_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;m_fi: eaz=%s si1=%d si2=%d&bslash;n&quot;
comma
id|eaz
comma
id|si1
comma
id|si2
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_MAX_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
macro_line|#ifdef ISDN_DEBUG_MODEM_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;m_fi: i=%d msn=%s mmsn=%s mreg18=%d mreg19=%d&bslash;n&quot;
comma
id|i
comma
id|dev-&gt;mdm.atmodem
(braket
id|i
)braket
dot
id|msn
comma
id|isdn_map_eaz2msn
c_func
(paren
id|dev-&gt;mdm.atmodem
(braket
id|i
)braket
dot
id|msn
comma
id|di
)paren
comma
id|dev-&gt;mdm.atmodem
(braket
id|i
)braket
dot
id|mdmreg
(braket
l_int|18
)braket
comma
id|dev-&gt;mdm.atmodem
(braket
id|i
)braket
dot
id|mdmreg
(braket
l_int|19
)braket
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|isdn_map_eaz2msn
c_func
(paren
id|dev-&gt;mdm.atmodem
(braket
id|i
)braket
dot
id|msn
comma
id|di
)paren
comma
id|eaz
)paren
)paren
op_logical_and
multiline_comment|/* EAZ is matching   */
(paren
id|dev-&gt;mdm.atmodem
(braket
id|i
)braket
dot
id|mdmreg
(braket
l_int|18
)braket
op_eq
id|si1
)paren
op_logical_and
multiline_comment|/* SI1 is matching   */
(paren
id|dev-&gt;mdm.atmodem
(braket
id|i
)braket
dot
id|mdmreg
(braket
l_int|19
)braket
op_eq
id|si2
)paren
)paren
(brace
multiline_comment|/* SI2 is matching   */
id|modem_info
op_star
id|info
op_assign
op_amp
id|dev-&gt;mdm.info
(braket
id|i
)braket
suffix:semicolon
id|idx
op_assign
id|isdn_dc2minor
c_func
(paren
id|di
comma
id|ch
)paren
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_ICALL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;m_fi: match1&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;m_fi: idx=%d flags=%08lx drv=%d ch=%d usg=%d&bslash;n&quot;
comma
id|idx
comma
id|info-&gt;flags
comma
id|info-&gt;isdn_driver
comma
id|info-&gt;isdn_channel
comma
id|dev-&gt;usage
(braket
id|idx
)braket
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_NORMAL_ACTIVE
)paren
op_logical_and
(paren
id|info-&gt;isdn_driver
op_eq
op_minus
l_int|1
)paren
op_logical_and
(paren
id|info-&gt;isdn_channel
op_eq
op_minus
l_int|1
)paren
op_logical_and
(paren
id|USG_NONE
c_func
(paren
id|dev-&gt;usage
(braket
id|idx
)braket
)paren
)paren
)paren
(brace
id|info-&gt;isdn_driver
op_assign
id|di
suffix:semicolon
id|info-&gt;isdn_channel
op_assign
id|ch
suffix:semicolon
id|info-&gt;drv_index
op_assign
id|idx
suffix:semicolon
id|dev-&gt;m_idx
(braket
id|idx
)braket
op_assign
id|info-&gt;line
suffix:semicolon
id|dev-&gt;usage
(braket
id|idx
)braket
op_and_assign
id|ISDN_USAGE_EXCLUSIVE
suffix:semicolon
id|dev-&gt;usage
(braket
id|idx
)braket
op_or_assign
id|ISDN_USAGE_MODEM
suffix:semicolon
id|strcpy
c_func
(paren
id|dev-&gt;num
(braket
id|idx
)braket
comma
id|nr
)paren
suffix:semicolon
id|isdn_info_update
c_func
(paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdn_tty: call from %s, -&gt; RING on ttyI%d&bslash;n&quot;
comma
id|nr
comma
id|info-&gt;line
)paren
suffix:semicolon
r_return
id|info-&gt;line
suffix:semicolon
)brace
)brace
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdn_tty: call from %s -&gt; %s %s&bslash;n&quot;
comma
id|nr
comma
id|eaz
comma
id|dev-&gt;drv
(braket
id|di
)braket
op_member_access_from_pointer
id|reject_bus
ques
c_cond
l_string|&quot;rejected&quot;
suffix:colon
l_string|&quot;ignored&quot;
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*********************************************************************&n; Modem-Emulator-Routines&n; *********************************************************************/
DECL|macro|cmdchar
mdefine_line|#define cmdchar(c) ((c&gt;&squot; &squot;)&amp;&amp;(c&lt;=0x7f))
multiline_comment|/*&n; * Put a message from the AT-emulator into receive-buffer of tty,&n; * convert CR, LF, and BS to values in modem-registers 3, 4 and 5.&n; */
DECL|function|isdn_tty_at_cout
r_static
r_void
id|isdn_tty_at_cout
c_func
(paren
r_char
op_star
id|msg
comma
id|modem_info
op_star
id|info
)paren
(brace
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
id|atemu
op_star
id|m
op_assign
op_amp
(paren
id|dev-&gt;mdm.atmodem
(braket
id|info-&gt;line
)braket
)paren
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_char
id|c
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|msg
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_tty: Null-Message in isdn_tty_at_cout&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|tty
op_assign
id|info-&gt;tty
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|msg
suffix:semicolon
op_star
id|p
suffix:semicolon
id|p
op_increment
)paren
(brace
r_switch
c_cond
(paren
op_star
id|p
)paren
(brace
r_case
l_char|&squot;&bslash;r&squot;
suffix:colon
id|c
op_assign
id|m-&gt;mdmreg
(braket
l_int|3
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;&bslash;n&squot;
suffix:colon
id|c
op_assign
id|m-&gt;mdmreg
(braket
l_int|4
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;&bslash;b&squot;
suffix:colon
id|c
op_assign
id|m-&gt;mdmreg
(braket
l_int|5
)braket
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|c
op_assign
op_star
id|p
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_CLOSING
)paren
op_logical_or
(paren
op_logical_neg
id|tty
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tty-&gt;flip.count
op_ge
id|TTY_FLIPBUF_SIZE
)paren
r_break
suffix:semicolon
id|tty_insert_flip_char
c_func
(paren
id|tty
comma
id|c
comma
l_int|0
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|tty-&gt;flip.tqueue
comma
op_amp
id|tq_timer
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Perform ATH Hangup&n; */
DECL|function|isdn_tty_on_hook
r_static
r_void
id|isdn_tty_on_hook
c_func
(paren
id|modem_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;isdn_channel
op_ge
l_int|0
)paren
(brace
macro_line|#ifdef ISDN_DEBUG_MODEM_HUP
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Mhup in isdn_tty_on_hook&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|isdn_tty_modem_hup
c_func
(paren
id|info
)paren
suffix:semicolon
id|isdn_tty_modem_result
c_func
(paren
l_int|3
comma
id|info
)paren
suffix:semicolon
)brace
)brace
DECL|function|isdn_tty_off_hook
r_static
r_void
id|isdn_tty_off_hook
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_tty_off_hook&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|macro|PLUSWAIT1
mdefine_line|#define PLUSWAIT1 (HZ/2)&t;/* 0.5 sec. */
DECL|macro|PLUSWAIT2
mdefine_line|#define PLUSWAIT2 (HZ*3/2)&t;/* 1.5 sec */
multiline_comment|/*&n; * Check Buffer for Modem-escape-sequence, activate timer-callback to&n; * isdn_tty_modem_escape() if sequence found.&n; *&n; * Parameters:&n; *   p          pointer to databuffer&n; *   plus       escape-character&n; *   count      length of buffer&n; *   pluscount  count of valid escape-characters so far&n; *   lastplus   timestamp of last character&n; */
DECL|function|isdn_tty_check_esc
r_static
r_void
id|isdn_tty_check_esc
c_func
(paren
r_const
id|u_char
op_star
id|p
comma
id|u_char
id|plus
comma
r_int
id|count
comma
r_int
op_star
id|pluscount
comma
r_int
op_star
id|lastplus
comma
r_int
id|from_user
)paren
(brace
r_char
id|cbuf
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|plus
OG
l_int|127
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
l_int|3
)paren
(brace
id|p
op_add_assign
id|count
op_minus
l_int|3
suffix:semicolon
id|count
op_assign
l_int|3
suffix:semicolon
op_star
id|pluscount
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|from_user
)paren
(brace
id|memcpy_fromfs
c_func
(paren
id|cbuf
comma
id|p
comma
id|count
)paren
suffix:semicolon
id|p
op_assign
id|cbuf
suffix:semicolon
)brace
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_star
(paren
id|p
op_increment
)paren
op_eq
id|plus
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|pluscount
)paren
op_increment
)paren
(brace
multiline_comment|/* Time since last &squot;+&squot; &gt; 0.5 sec. ? */
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
op_star
id|lastplus
)paren
OG
id|PLUSWAIT1
)paren
op_star
id|pluscount
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Time since last non-&squot;+&squot; &lt; 1.5 sec. ? */
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
op_star
id|lastplus
)paren
OL
id|PLUSWAIT2
)paren
op_star
id|pluscount
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
op_star
id|pluscount
op_eq
l_int|3
)paren
op_logical_and
(paren
id|count
op_assign
l_int|1
)paren
)paren
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_MODEMPLUS
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|pluscount
OG
l_int|3
)paren
op_star
id|pluscount
op_assign
l_int|1
suffix:semicolon
)brace
r_else
op_star
id|pluscount
op_assign
l_int|0
suffix:semicolon
op_star
id|lastplus
op_assign
id|jiffies
suffix:semicolon
id|count
op_decrement
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Return result of AT-emulator to tty-receive-buffer, depending on&n; * modem-register 12, bit 0 and 1.&n; * For CONNECT-messages also switch to online-mode.&n; * For RING-message handle auto-ATA if register 0 != 0&n; */
DECL|function|isdn_tty_modem_result
r_void
id|isdn_tty_modem_result
c_func
(paren
r_int
id|code
comma
id|modem_info
op_star
id|info
)paren
(brace
id|atemu
op_star
id|m
op_assign
op_amp
id|dev-&gt;mdm.atmodem
(braket
id|info-&gt;line
)braket
suffix:semicolon
r_static
r_char
op_star
id|msg
(braket
)braket
op_assign
(brace
l_string|&quot;OK&quot;
comma
l_string|&quot;CONNECT&quot;
comma
l_string|&quot;RING&quot;
comma
l_string|&quot;NO CARRIER&quot;
comma
l_string|&quot;ERROR&quot;
comma
l_string|&quot;CONNECT 64000&quot;
comma
l_string|&quot;NO DIALTONE&quot;
comma
l_string|&quot;BUSY&quot;
comma
l_string|&quot;NO ANSWER&quot;
comma
l_string|&quot;RINGING&quot;
comma
l_string|&quot;NO MSN/EAZ&quot;
)brace
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
r_char
id|s
(braket
l_int|4
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|code
)paren
(brace
r_case
l_int|2
suffix:colon
id|m-&gt;mdmreg
(braket
l_int|1
)braket
op_increment
suffix:semicolon
multiline_comment|/* RING */
r_if
c_cond
(paren
id|m-&gt;mdmreg
(braket
l_int|1
)braket
op_eq
id|m-&gt;mdmreg
(braket
l_int|0
)braket
)paren
(brace
multiline_comment|/* Accept incoming call */
id|isdn_ctrl
id|cmd
suffix:semicolon
id|m-&gt;mdmreg
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;mdm.msr
(braket
id|info-&gt;line
)braket
op_and_assign
op_complement
id|UART_MSR_RI
suffix:semicolon
id|cmd.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|cmd.arg
op_assign
id|info-&gt;isdn_channel
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_ACCEPTD
suffix:semicolon
id|dev-&gt;drv
(braket
id|info-&gt;isdn_driver
)braket
op_member_access_from_pointer
id|interface
op_member_access_from_pointer
id|command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* NO CARRIER */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|dev-&gt;mdm.msr
(braket
id|info-&gt;line
)braket
op_and_assign
op_complement
(paren
id|UART_MSR_DCD
op_or
id|UART_MSR_RI
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_CLOSING
)paren
op_logical_or
(paren
op_logical_neg
id|info-&gt;tty
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
r_case
l_int|5
suffix:colon
id|dev-&gt;mdm.online
(braket
id|info-&gt;line
)braket
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|m-&gt;mdmreg
(braket
l_int|12
)braket
op_amp
l_int|1
)paren
(brace
multiline_comment|/* Show results */
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;&bslash;r&bslash;n&quot;
comma
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m-&gt;mdmreg
(braket
l_int|12
)braket
op_amp
l_int|2
)paren
(brace
multiline_comment|/* Show numeric results */
id|sprintf
c_func
(paren
id|s
comma
l_string|&quot;%d&quot;
comma
id|code
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|s
comma
id|info
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|code
op_eq
l_int|2
)paren
(brace
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;CALLER NUMBER: &quot;
comma
id|info
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|dev-&gt;num
(braket
id|info-&gt;drv_index
)braket
comma
id|info
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;&bslash;r&bslash;n&quot;
comma
id|info
)paren
suffix:semicolon
)brace
id|isdn_tty_at_cout
c_func
(paren
id|msg
(braket
id|code
)braket
comma
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|code
op_eq
l_int|5
)paren
(brace
multiline_comment|/* Append Protocol to CONNECT message */
id|isdn_tty_at_cout
c_func
(paren
(paren
id|m-&gt;mdmreg
(braket
l_int|14
)braket
op_ne
l_int|3
)paren
ques
c_cond
l_string|&quot;/X.75&quot;
suffix:colon
l_string|&quot;/HDLC&quot;
comma
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m-&gt;mdmreg
(braket
l_int|13
)braket
op_amp
l_int|2
)paren
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;/T.70&quot;
comma
id|info
)paren
suffix:semicolon
)brace
)brace
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;&bslash;r&bslash;n&quot;
comma
id|info
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|code
op_eq
l_int|3
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_CLOSING
)paren
op_logical_or
(paren
op_logical_neg
id|info-&gt;tty
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_CHECK_CD
)paren
op_logical_and
(paren
op_logical_neg
(paren
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_CALLOUT_ACTIVE
)paren
op_logical_and
(paren
id|info-&gt;flags
op_amp
id|ISDN_ASYNC_CALLOUT_NOHUP
)paren
)paren
)paren
)paren
id|tty_hangup
c_func
(paren
id|info-&gt;tty
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Display a modem-register-value.&n; */
DECL|function|isdn_tty_show_profile
r_static
r_void
id|isdn_tty_show_profile
c_func
(paren
r_int
id|ridx
comma
id|modem_info
op_star
id|info
)paren
(brace
r_char
id|v
(braket
l_int|6
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|v
comma
l_string|&quot;%d&bslash;r&bslash;n&quot;
comma
id|dev-&gt;mdm.atmodem
(braket
id|info-&gt;line
)braket
dot
id|mdmreg
(braket
id|ridx
)braket
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|v
comma
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Get MSN-string from char-pointer, set pointer to end of number&n; */
DECL|function|isdn_tty_get_msnstr
r_static
r_void
id|isdn_tty_get_msnstr
c_func
(paren
r_char
op_star
id|n
comma
r_char
op_star
op_star
id|p
)paren
(brace
r_while
c_loop
(paren
(paren
op_star
id|p
(braket
l_int|0
)braket
op_ge
l_char|&squot;0&squot;
op_logical_and
op_star
id|p
(braket
l_int|0
)braket
op_le
l_char|&squot;9&squot;
)paren
op_logical_or
(paren
op_star
id|p
(braket
l_int|0
)braket
op_eq
l_char|&squot;,&squot;
)paren
)paren
op_star
id|n
op_increment
op_assign
op_star
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
op_star
id|n
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
multiline_comment|/*&n; * Get phone-number from modem-commandbuffer&n; */
DECL|function|isdn_tty_getdial
r_static
r_void
id|isdn_tty_getdial
c_func
(paren
r_char
op_star
id|p
comma
r_char
op_star
id|q
)paren
(brace
r_int
id|first
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|strchr
c_func
(paren
l_string|&quot;0123456789,#.*WPTS-&quot;
comma
op_star
id|p
)paren
op_logical_and
op_star
id|p
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|p
op_ge
l_char|&squot;0&squot;
op_logical_and
op_star
id|p
op_le
l_char|&squot;9&squot;
)paren
op_logical_or
(paren
(paren
op_star
id|p
op_eq
l_char|&squot;S&squot;
)paren
op_logical_and
id|first
)paren
)paren
op_star
id|q
op_increment
op_assign
op_star
id|p
suffix:semicolon
id|p
op_increment
suffix:semicolon
id|first
op_assign
l_int|0
suffix:semicolon
)brace
op_star
id|q
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Parse and perform an AT-command-line.&n; *&n; * Parameter:&n; *   channel   index to line (minor-device)&n; */
DECL|function|isdn_tty_parse_at
r_static
r_void
id|isdn_tty_parse_at
c_func
(paren
id|modem_info
op_star
id|info
)paren
(brace
id|atemu
op_star
id|m
op_assign
op_amp
id|dev-&gt;mdm.atmodem
(braket
id|info-&gt;line
)braket
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_int
id|mreg
suffix:semicolon
r_int
id|mval
suffix:semicolon
r_int
id|i
suffix:semicolon
r_char
id|rb
(braket
l_int|100
)braket
suffix:semicolon
r_char
id|ds
(braket
l_int|40
)braket
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_AT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;AT: &squot;%s&squot;&bslash;n&quot;
comma
id|m-&gt;mdmcmd
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|p
op_assign
op_amp
id|m-&gt;mdmcmd
(braket
l_int|2
)braket
suffix:semicolon
op_star
id|p
suffix:semicolon
)paren
(brace
r_switch
c_cond
(paren
op_star
id|p
)paren
(brace
r_case
l_char|&squot;A&squot;
suffix:colon
multiline_comment|/* A - Accept incoming call */
id|p
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;mdm.msr
(braket
id|info-&gt;line
)braket
op_amp
id|UART_MSR_RI
)paren
(brace
DECL|macro|FIDOBUG
mdefine_line|#define FIDOBUG
macro_line|#ifdef FIDOBUG
multiline_comment|/* Variables fido... defined temporarily for finding a strange bug */
id|driver
op_star
id|fido_drv
suffix:semicolon
id|isdn_if
op_star
id|fido_if
suffix:semicolon
r_int
id|fido_isdn_driver
suffix:semicolon
id|modem_info
op_star
id|fido_modem_info
suffix:semicolon
r_int
(paren
op_star
id|fido_command
)paren
(paren
id|isdn_ctrl
op_star
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Accept incoming call */
id|m-&gt;mdmreg
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;mdm.msr
(braket
id|info-&gt;line
)braket
op_and_assign
op_complement
id|UART_MSR_RI
suffix:semicolon
id|cmd.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_SETL2
suffix:semicolon
id|cmd.arg
op_assign
id|info-&gt;isdn_channel
op_plus
(paren
id|m-&gt;mdmreg
(braket
l_int|14
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
id|dev-&gt;drv
(braket
id|info-&gt;isdn_driver
)braket
op_member_access_from_pointer
id|interface
op_member_access_from_pointer
id|command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_SETL3
suffix:semicolon
id|cmd.arg
op_assign
id|info-&gt;isdn_channel
op_plus
(paren
id|m-&gt;mdmreg
(braket
l_int|15
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
id|dev-&gt;drv
(braket
id|info-&gt;isdn_driver
)braket
op_member_access_from_pointer
id|interface
op_member_access_from_pointer
id|command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.driver
op_assign
id|info-&gt;isdn_driver
suffix:semicolon
id|cmd.arg
op_assign
id|info-&gt;isdn_channel
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_CMD_ACCEPTD
suffix:semicolon
macro_line|#ifdef FIDOBUG
id|fido_modem_info
op_assign
id|info
suffix:semicolon
id|fido_isdn_driver
op_assign
id|fido_modem_info-&gt;isdn_driver
suffix:semicolon
id|fido_drv
op_assign
id|dev-&gt;drv
(braket
id|fido_isdn_driver
)braket
suffix:semicolon
id|fido_if
op_assign
id|fido_drv-&gt;interface
suffix:semicolon
id|fido_command
op_assign
id|fido_if-&gt;command
suffix:semicolon
id|fido_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
macro_line|#else
id|dev-&gt;drv
(braket
id|info-&gt;isdn_driver
)braket
op_member_access_from_pointer
id|interface
op_member_access_from_pointer
id|command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|isdn_tty_modem_result
c_func
(paren
l_int|8
comma
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_char|&squot;D&squot;
suffix:colon
multiline_comment|/* D - Dial */
id|isdn_tty_getdial
c_func
(paren
op_increment
id|p
comma
id|ds
)paren
suffix:semicolon
id|p
op_add_assign
id|strlen
c_func
(paren
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strlen
c_func
(paren
id|m-&gt;msn
)paren
)paren
id|isdn_tty_modem_result
c_func
(paren
l_int|10
comma
id|info
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|ds
)paren
)paren
id|isdn_tty_dial
c_func
(paren
id|ds
comma
id|info
comma
id|m
)paren
suffix:semicolon
r_else
id|isdn_tty_modem_result
c_func
(paren
l_int|4
comma
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_char|&squot;E&squot;
suffix:colon
multiline_comment|/* E - Turn Echo on/off */
id|p
op_increment
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|p
)paren
(brace
r_case
l_char|&squot;0&squot;
suffix:colon
id|p
op_increment
suffix:semicolon
id|m-&gt;mdmreg
(braket
l_int|12
)braket
op_and_assign
op_complement
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;1&squot;
suffix:colon
id|p
op_increment
suffix:semicolon
id|m-&gt;mdmreg
(braket
l_int|12
)braket
op_or_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|isdn_tty_modem_result
c_func
(paren
l_int|4
comma
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_char|&squot;H&squot;
suffix:colon
multiline_comment|/* H - On/Off-hook */
id|p
op_increment
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|p
)paren
(brace
r_case
l_char|&squot;0&squot;
suffix:colon
id|p
op_increment
suffix:semicolon
id|isdn_tty_on_hook
c_func
(paren
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;1&squot;
suffix:colon
id|p
op_increment
suffix:semicolon
id|isdn_tty_off_hook
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|isdn_tty_on_hook
c_func
(paren
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_char|&squot;I&squot;
suffix:colon
multiline_comment|/* I - Information */
id|p
op_increment
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;ISDN for Linux  (c) by Fritz Elfert&bslash;r&bslash;n&quot;
comma
id|info
)paren
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|p
)paren
(brace
r_case
l_char|&squot;0&squot;
suffix:colon
r_case
l_char|&squot;1&squot;
suffix:colon
id|p
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
)brace
r_break
suffix:semicolon
r_case
l_char|&squot;O&squot;
suffix:colon
multiline_comment|/* O - Go online */
id|p
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;mdm.msr
(braket
id|info-&gt;line
)braket
op_amp
id|UART_MSR_DCD
)paren
multiline_comment|/* if B-Channel is up */
id|isdn_tty_modem_result
c_func
(paren
l_int|5
comma
id|info
)paren
suffix:semicolon
r_else
id|isdn_tty_modem_result
c_func
(paren
l_int|3
comma
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_char|&squot;Q&squot;
suffix:colon
multiline_comment|/* Q - Turn Emulator messages on/off */
id|p
op_increment
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|p
)paren
(brace
r_case
l_char|&squot;0&squot;
suffix:colon
id|p
op_increment
suffix:semicolon
id|m-&gt;mdmreg
(braket
l_int|12
)braket
op_or_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;1&squot;
suffix:colon
id|p
op_increment
suffix:semicolon
id|m-&gt;mdmreg
(braket
l_int|12
)braket
op_and_assign
op_complement
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|isdn_tty_modem_result
c_func
(paren
l_int|4
comma
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_char|&squot;S&squot;
suffix:colon
multiline_comment|/* S - Set/Get Register */
id|p
op_increment
suffix:semicolon
id|mreg
op_assign
id|isdn_getnum
c_func
(paren
op_amp
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mreg
template_param
id|ISDN_MODEM_ANZREG
)paren
(brace
id|isdn_tty_modem_result
c_func
(paren
l_int|4
comma
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
op_star
id|p
)paren
(brace
r_case
l_char|&squot;=&squot;
suffix:colon
id|p
op_increment
suffix:semicolon
id|mval
op_assign
id|isdn_getnum
c_func
(paren
op_amp
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mval
op_ge
l_int|0
op_logical_and
id|mval
op_le
l_int|255
)paren
(brace
r_if
c_cond
(paren
(paren
id|mreg
op_eq
l_int|16
)paren
op_logical_and
(paren
(paren
id|mval
op_star
l_int|16
)paren
OG
id|ISDN_SERIAL_XMIT_SIZE
)paren
)paren
(brace
id|isdn_tty_modem_result
c_func
(paren
l_int|4
comma
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|m-&gt;mdmreg
(braket
id|mreg
)braket
op_assign
id|mval
suffix:semicolon
)brace
r_else
(brace
id|isdn_tty_modem_result
c_func
(paren
l_int|4
comma
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_char|&squot;?&squot;
suffix:colon
id|p
op_increment
suffix:semicolon
id|isdn_tty_show_profile
c_func
(paren
id|mreg
comma
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|isdn_tty_modem_result
c_func
(paren
l_int|4
comma
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_char|&squot;V&squot;
suffix:colon
multiline_comment|/* V - Numeric or ASCII Emulator-messages */
id|p
op_increment
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|p
)paren
(brace
r_case
l_char|&squot;0&squot;
suffix:colon
id|p
op_increment
suffix:semicolon
id|m-&gt;mdmreg
(braket
l_int|12
)braket
op_or_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;1&squot;
suffix:colon
id|p
op_increment
suffix:semicolon
id|m-&gt;mdmreg
(braket
l_int|12
)braket
op_and_assign
op_complement
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|isdn_tty_modem_result
c_func
(paren
l_int|4
comma
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_char|&squot;Z&squot;
suffix:colon
multiline_comment|/* Z - Load Registers from Profile */
id|p
op_increment
suffix:semicolon
id|isdn_tty_modem_reset_regs
c_func
(paren
id|m
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;+&squot;
suffix:colon
id|p
op_increment
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|p
)paren
(brace
r_case
l_char|&squot;F&squot;
suffix:colon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_char|&squot;&amp;&squot;
suffix:colon
id|p
op_increment
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|p
)paren
(brace
r_case
l_char|&squot;B&squot;
suffix:colon
multiline_comment|/* &amp;B - Set Buffersize */
id|p
op_increment
suffix:semicolon
id|i
op_assign
id|isdn_getnum
c_func
(paren
op_amp
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
OL
l_int|0
)paren
op_logical_or
(paren
id|i
OG
id|ISDN_SERIAL_XMIT_SIZE
)paren
)paren
(brace
id|isdn_tty_modem_result
c_func
(paren
l_int|4
comma
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|m-&gt;mdmreg
(braket
l_int|16
)braket
op_assign
id|i
op_div
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;D&squot;
suffix:colon
multiline_comment|/* &amp;D - Set DCD-Low-behavior */
id|p
op_increment
suffix:semicolon
r_switch
c_cond
(paren
id|isdn_getnum
c_func
(paren
op_amp
id|p
)paren
)paren
(brace
r_case
l_int|2
suffix:colon
id|m-&gt;mdmreg
(braket
l_int|12
)braket
op_and_assign
op_complement
l_int|32
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|m-&gt;mdmreg
(braket
l_int|12
)braket
op_or_assign
l_int|32
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|isdn_tty_modem_result
c_func
(paren
l_int|4
comma
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_char|&squot;E&squot;
suffix:colon
multiline_comment|/* &amp;E -Set EAZ/MSN */
id|p
op_increment
suffix:semicolon
id|isdn_tty_get_msnstr
c_func
(paren
id|m-&gt;msn
comma
op_amp
id|p
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;F&squot;
suffix:colon
multiline_comment|/* &amp;F -Set Factory-Defaults */
id|p
op_increment
suffix:semicolon
id|isdn_tty_reset_profile
c_func
(paren
id|m
)paren
suffix:semicolon
id|isdn_tty_modem_reset_regs
c_func
(paren
id|m
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;S&squot;
suffix:colon
multiline_comment|/* &amp;S - Set Windowsize */
id|p
op_increment
suffix:semicolon
id|i
op_assign
id|isdn_getnum
c_func
(paren
op_amp
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
OG
l_int|0
)paren
op_logical_and
(paren
id|i
OL
l_int|9
)paren
)paren
id|m-&gt;mdmreg
(braket
l_int|17
)braket
op_assign
id|i
suffix:semicolon
r_else
(brace
id|isdn_tty_modem_result
c_func
(paren
l_int|4
comma
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_char|&squot;V&squot;
suffix:colon
multiline_comment|/* &amp;V - Show registers */
id|p
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_MODEM_ANZREG
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sprintf
c_func
(paren
id|rb
comma
l_string|&quot;S%d=%d%s&quot;
comma
id|i
comma
id|m-&gt;mdmreg
(braket
id|i
)braket
comma
(paren
id|i
op_eq
l_int|6
)paren
ques
c_cond
l_string|&quot;&bslash;r&bslash;n&quot;
suffix:colon
l_string|&quot; &quot;
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|rb
comma
id|info
)paren
suffix:semicolon
)brace
id|sprintf
c_func
(paren
id|rb
comma
l_string|&quot;&bslash;r&bslash;nEAZ/MSN: %s&bslash;r&bslash;n&quot;
comma
id|strlen
c_func
(paren
id|m-&gt;msn
)paren
ques
c_cond
id|m-&gt;msn
suffix:colon
l_string|&quot;None&quot;
)paren
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|rb
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;W&squot;
suffix:colon
multiline_comment|/* &amp;W - Write Profile */
id|p
op_increment
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|p
)paren
(brace
r_case
l_char|&squot;0&squot;
suffix:colon
id|p
op_increment
suffix:semicolon
id|modem_write_profile
c_func
(paren
id|m
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|isdn_tty_modem_result
c_func
(paren
l_int|4
comma
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_char|&squot;X&squot;
suffix:colon
multiline_comment|/* &amp;X - Switch to BTX-Mode */
id|p
op_increment
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|p
)paren
(brace
r_case
l_char|&squot;0&squot;
suffix:colon
id|p
op_increment
suffix:semicolon
id|m-&gt;mdmreg
(braket
l_int|13
)braket
op_and_assign
op_complement
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;1&squot;
suffix:colon
id|p
op_increment
suffix:semicolon
id|m-&gt;mdmreg
(braket
l_int|13
)braket
op_or_assign
l_int|2
suffix:semicolon
id|m-&gt;mdmreg
(braket
l_int|14
)braket
op_assign
l_int|0
suffix:semicolon
id|m-&gt;mdmreg
(braket
l_int|16
)braket
op_assign
l_int|7
suffix:semicolon
id|m-&gt;mdmreg
(braket
l_int|18
)braket
op_assign
l_int|7
suffix:semicolon
id|m-&gt;mdmreg
(braket
l_int|19
)braket
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|isdn_tty_modem_result
c_func
(paren
l_int|4
comma
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|isdn_tty_modem_result
c_func
(paren
l_int|4
comma
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|isdn_tty_modem_result
c_func
(paren
l_int|4
comma
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|isdn_tty_modem_result
c_func
(paren
l_int|0
comma
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/* Need own toupper() because standard-toupper is not available&n; * within modules.&n; */
DECL|macro|my_toupper
mdefine_line|#define my_toupper(c) (((c&gt;=&squot;a&squot;)&amp;&amp;(c&lt;=&squot;z&squot;))?(c&amp;0xdf):c)
multiline_comment|/*&n; * Perform line-editing of AT-commands&n; *&n; * Parameters:&n; *   p        inputbuffer&n; *   count    length of buffer&n; *   channel  index to line (minor-device)&n; *   user     flag: buffer is in userspace&n; */
DECL|function|isdn_tty_edit_at
r_static
r_int
id|isdn_tty_edit_at
c_func
(paren
r_const
r_char
op_star
id|p
comma
r_int
id|count
comma
id|modem_info
op_star
id|info
comma
r_int
id|user
)paren
(brace
id|atemu
op_star
id|m
op_assign
op_amp
id|dev-&gt;mdm.atmodem
(braket
id|info-&gt;line
)braket
suffix:semicolon
r_int
id|total
op_assign
l_int|0
suffix:semicolon
id|u_char
id|c
suffix:semicolon
r_char
id|eb
(braket
l_int|2
)braket
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
id|count
suffix:semicolon
id|cnt
OG
l_int|0
suffix:semicolon
id|p
op_increment
comma
id|cnt
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|user
)paren
id|c
op_assign
id|get_fs_byte
c_func
(paren
id|p
)paren
suffix:semicolon
r_else
id|c
op_assign
op_star
id|p
suffix:semicolon
id|total
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|c
op_eq
id|m-&gt;mdmreg
(braket
l_int|3
)braket
op_logical_or
id|c
op_eq
id|m-&gt;mdmreg
(braket
l_int|4
)braket
)paren
(brace
multiline_comment|/* Separator (CR oder LF) */
id|m-&gt;mdmcmd
(braket
id|m-&gt;mdmcmdl
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|m-&gt;mdmreg
(braket
l_int|12
)braket
op_amp
l_int|4
)paren
(brace
id|eb
(braket
l_int|0
)braket
op_assign
id|c
suffix:semicolon
id|eb
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|eb
comma
id|info
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|m-&gt;mdmcmdl
op_ge
l_int|2
)paren
id|isdn_tty_parse_at
c_func
(paren
id|info
)paren
suffix:semicolon
id|m-&gt;mdmcmdl
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|c
op_eq
id|m-&gt;mdmreg
(braket
l_int|5
)braket
op_logical_and
id|m-&gt;mdmreg
(braket
l_int|5
)braket
OL
l_int|128
)paren
(brace
multiline_comment|/* Backspace-Funktion */
r_if
c_cond
(paren
(paren
id|m-&gt;mdmcmdl
OG
l_int|2
)paren
op_logical_or
(paren
op_logical_neg
id|m-&gt;mdmcmdl
)paren
)paren
(brace
r_if
c_cond
(paren
id|m-&gt;mdmcmdl
)paren
id|m-&gt;mdmcmdl
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|m-&gt;mdmreg
(braket
l_int|12
)braket
op_amp
l_int|4
)paren
id|isdn_tty_at_cout
c_func
(paren
l_string|&quot;&bslash;b&quot;
comma
id|info
)paren
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmdchar
c_func
(paren
id|c
)paren
)paren
(brace
r_if
c_cond
(paren
id|m-&gt;mdmreg
(braket
l_int|12
)braket
op_amp
l_int|4
)paren
(brace
id|eb
(braket
l_int|0
)braket
op_assign
id|c
suffix:semicolon
id|eb
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|isdn_tty_at_cout
c_func
(paren
id|eb
comma
id|info
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|m-&gt;mdmcmdl
OL
l_int|255
)paren
(brace
id|c
op_assign
id|my_toupper
c_func
(paren
id|c
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|m-&gt;mdmcmdl
)paren
(brace
r_case
l_int|0
suffix:colon
r_if
c_cond
(paren
id|c
op_eq
l_char|&squot;A&squot;
)paren
id|m-&gt;mdmcmd
(braket
id|m-&gt;mdmcmdl
op_increment
)braket
op_assign
id|c
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
r_if
c_cond
(paren
id|c
op_eq
l_char|&squot;T&squot;
)paren
id|m-&gt;mdmcmd
(braket
id|m-&gt;mdmcmdl
op_increment
)braket
op_assign
id|c
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|m-&gt;mdmcmd
(braket
id|m-&gt;mdmcmdl
op_increment
)braket
op_assign
id|c
suffix:semicolon
)brace
)brace
)brace
)brace
r_return
id|total
suffix:semicolon
)brace
multiline_comment|/*&n; * Switch all modem-channels who are online and got a valid&n; * escape-sequence 1.5 seconds ago, to command-mode.&n; * This function is called every second via timer-interrupt from within &n; * timer-dispatcher isdn_timer_function()&n; */
DECL|function|isdn_tty_modem_escape
r_void
id|isdn_tty_modem_escape
c_func
(paren
r_void
)paren
(brace
r_int
id|ton
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|midx
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_MAX_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|USG_MODEM
c_func
(paren
id|dev-&gt;usage
(braket
id|i
)braket
)paren
)paren
r_if
c_cond
(paren
(paren
id|midx
op_assign
id|dev-&gt;m_idx
(braket
id|i
)braket
)paren
op_ge
l_int|0
)paren
r_if
c_cond
(paren
id|dev-&gt;mdm.online
(braket
id|midx
)braket
)paren
(brace
id|ton
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;mdm.atmodem
(braket
id|midx
)braket
dot
id|pluscount
op_eq
l_int|3
)paren
op_logical_and
(paren
(paren
id|jiffies
op_minus
id|dev-&gt;mdm.atmodem
(braket
id|midx
)braket
dot
id|lastplus
)paren
OG
id|PLUSWAIT2
)paren
)paren
(brace
id|dev-&gt;mdm.atmodem
(braket
id|midx
)braket
dot
id|pluscount
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;mdm.online
(braket
id|midx
)braket
op_assign
l_int|0
suffix:semicolon
id|isdn_tty_modem_result
c_func
(paren
l_int|0
comma
op_amp
id|dev-&gt;mdm.info
(braket
id|midx
)braket
)paren
suffix:semicolon
)brace
)brace
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_MODEMPLUS
comma
id|ton
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Put a RING-message to all modem-channels who have the RI-bit set.&n; * This function is called every second via timer-interrupt from within &n; * timer-dispatcher isdn_timer_function()&n; */
DECL|function|isdn_tty_modem_ring
r_void
id|isdn_tty_modem_ring
c_func
(paren
r_void
)paren
(brace
r_int
id|ton
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|midx
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_MAX_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|USG_MODEM
c_func
(paren
id|dev-&gt;usage
(braket
id|i
)braket
)paren
)paren
r_if
c_cond
(paren
(paren
id|midx
op_assign
id|dev-&gt;m_idx
(braket
id|i
)braket
)paren
op_ge
l_int|0
)paren
r_if
c_cond
(paren
id|dev-&gt;mdm.msr
(braket
id|midx
)braket
op_amp
id|UART_MSR_RI
)paren
(brace
id|ton
op_assign
l_int|1
suffix:semicolon
id|isdn_tty_modem_result
c_func
(paren
l_int|2
comma
op_amp
id|dev-&gt;mdm.info
(braket
id|midx
)braket
)paren
suffix:semicolon
)brace
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_MODEMRING
comma
id|ton
)paren
suffix:semicolon
)brace
DECL|function|isdn_tty_modem_xmit
r_void
id|isdn_tty_modem_xmit
c_func
(paren
r_void
)paren
(brace
r_int
id|ton
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|midx
suffix:semicolon
r_char
op_star
id|bufptr
suffix:semicolon
r_int
id|buflen
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_MAX_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|USG_MODEM
c_func
(paren
id|dev-&gt;usage
(braket
id|i
)braket
)paren
)paren
r_if
c_cond
(paren
(paren
id|midx
op_assign
id|dev-&gt;m_idx
(braket
id|i
)braket
)paren
op_ge
l_int|0
)paren
r_if
c_cond
(paren
id|dev-&gt;mdm.online
(braket
id|midx
)braket
)paren
(brace
id|modem_info
op_star
id|info
op_assign
op_amp
(paren
id|dev-&gt;mdm.info
(braket
id|midx
)braket
)paren
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;xmit_count
OG
l_int|0
)paren
(brace
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|info-&gt;tty
suffix:semicolon
id|ton
op_assign
l_int|1
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;WB2: %d&bslash;n&quot;
comma
id|info-&gt;xmit_count
)paren
suffix:semicolon
macro_line|#endif
id|bufptr
op_assign
id|info-&gt;xmit_buf
suffix:semicolon
id|buflen
op_assign
id|info-&gt;xmit_count
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;mdm.atmodem
(braket
id|midx
)braket
dot
id|mdmreg
(braket
l_int|13
)braket
op_amp
l_int|2
)paren
(brace
multiline_comment|/* Add T.70 simplified header */
macro_line|#ifdef ISDN_DEBUG_MODEM_DUMP
id|isdn_dumppkt
c_func
(paren
l_string|&quot;T70pack3:&quot;
comma
id|bufptr
comma
id|buflen
comma
l_int|40
)paren
suffix:semicolon
macro_line|#endif
id|bufptr
op_sub_assign
l_int|4
suffix:semicolon
id|buflen
op_add_assign
l_int|4
suffix:semicolon
id|memcpy
c_func
(paren
id|bufptr
comma
l_string|&quot;&bslash;1&bslash;0&bslash;1&bslash;0&quot;
comma
l_int|4
)paren
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_MODEM_DUMP
id|isdn_dumppkt
c_func
(paren
l_string|&quot;T70pack4:&quot;
comma
id|bufptr
comma
id|buflen
comma
l_int|40
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|isdn_writebuf_stub
c_func
(paren
id|info-&gt;isdn_driver
comma
id|info-&gt;isdn_channel
comma
id|bufptr
comma
id|buflen
comma
l_int|0
)paren
OG
l_int|0
)paren
(brace
id|info-&gt;xmit_count
op_assign
l_int|0
suffix:semicolon
id|info-&gt;xmit_size
op_assign
id|dev-&gt;mdm.atmodem
(braket
id|midx
)braket
dot
id|mdmreg
(braket
l_int|16
)braket
op_star
l_int|16
suffix:semicolon
macro_line|#if FUTURE
id|info-&gt;send_outstanding
op_increment
suffix:semicolon
id|dev-&gt;mdm.msr
(braket
id|midx
)braket
op_and_assign
op_complement
id|UART_MSR_CTS
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
id|isdn_timer_ctrl
c_func
(paren
id|ISDN_TIMER_MODEMXMIT
comma
id|ton
)paren
suffix:semicolon
)brace
macro_line|#if FUTURE
multiline_comment|/*&n; * A packet has been output successfully.&n; * Search the tty-devices for an appropriate device, decrement its&n; * counter for outstanding packets, and set CTS if this counter reaches 0.&n; */
DECL|function|isdn_tty_bsent
r_void
id|isdn_tty_bsent
c_func
(paren
r_int
id|drv
comma
r_int
id|chan
)paren
(brace
r_int
id|i
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_MAX_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|modem_info
op_star
id|info
op_assign
op_amp
id|dev-&gt;mdm.info
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;isdn_driver
op_eq
id|drv
)paren
op_logical_and
(paren
id|info-&gt;isdn_channel
op_eq
id|chan
)paren
op_logical_and
(paren
id|info-&gt;send_outstanding
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
op_decrement
id|info-&gt;send_outstanding
)paren
)paren
id|dev-&gt;mdm.msr
(braket
id|i
)braket
op_or_assign
id|UART_MSR_CTS
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* FUTURE */
eof
