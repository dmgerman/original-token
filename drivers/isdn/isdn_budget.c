multiline_comment|/* $Id: isdn_budget.c,v 1.3 1998/10/23 10:18:39 paul Exp $&n; *&n; * Linux ISDN subsystem, budget-accounting for network interfaces.&n; *&n; * Copyright 1997       by Christian Lademann &lt;cal@zls.de&gt;&n; * &n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA. &n; *&n; * $Log: isdn_budget.c,v $&n; * Revision 1.3  1998/10/23 10:18:39  paul&n; * Implementation of &quot;dialmode&quot; (successor of &quot;status&quot;)&n; * You also need current isdnctrl for this!&n; *&n; * Revision 1.2  1998/03/07 23:17:30  fritz&n; * Added RCS keywords&n; * Bugfix: Did not compile without isdn_dumppkt beeing enabled.&n; *&n; */
multiline_comment|/*&n;30.06.97:cal:angelegt&n;04.11.97:cal:budget.period: int --&gt; time_t&n;*/
macro_line|#include &lt;linux/config.h&gt;
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/isdn.h&gt;
macro_line|#include &quot;isdn_common.h&quot;
macro_line|#include &quot;isdn_net.h&quot;
macro_line|#ifdef CONFIG_ISDN_BUDGET
DECL|macro|VERBOSE_PRINTK
mdefine_line|#define&t;VERBOSE_PRINTK(v, l, p...)&t;{ &bslash;&n;&t;if(dev-&gt;net_verbose &gt;= (v)) { &bslash;&n;&t;&t;printk(l ## p); &bslash;&n;&t;} else { ; } &bslash;&n;}
r_int
DECL|function|isdn_net_budget
id|isdn_net_budget
c_func
(paren
r_int
id|type
comma
r_struct
id|device
op_star
id|ndev
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|ndev-&gt;priv
suffix:semicolon
r_int
id|i
comma
id|ret
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|ISDN_BUDGET_INIT
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_BUDGET_NUM_BUDGET
suffix:semicolon
id|i
op_increment
)paren
(brace
id|lp-&gt;budget
(braket
id|i
)braket
dot
id|amount
op_assign
op_minus
l_int|1
suffix:semicolon
id|lp-&gt;budget
(braket
id|i
)braket
dot
id|used
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;budget
(braket
id|i
)braket
dot
id|period
op_assign
(paren
id|time_t
)paren
l_int|0
suffix:semicolon
id|lp-&gt;budget
(braket
id|i
)braket
dot
id|period_started
op_assign
(paren
id|time_t
)paren
l_int|0
suffix:semicolon
id|lp-&gt;budget
(braket
id|i
)braket
dot
id|last_check
op_assign
id|CURRENT_TIME
suffix:semicolon
id|lp-&gt;budget
(braket
id|i
)braket
dot
id|notified
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_BUDGET_CHECK_DIAL
suffix:colon
r_case
id|ISDN_BUDGET_CHECK_CHARGE
suffix:colon
r_case
id|ISDN_BUDGET_CHECK_ONLINE
suffix:colon
id|ret
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_BUDGET_NUM_BUDGET
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|lp-&gt;budget
(braket
id|i
)braket
dot
id|amount
OL
l_int|0
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;budget
(braket
id|i
)braket
dot
id|period_started
op_plus
id|lp-&gt;budget
(braket
id|i
)braket
dot
id|period
OL
id|CURRENT_TIME
)paren
(brace
id|lp-&gt;budget
(braket
id|i
)braket
dot
id|used
op_assign
l_int|0
suffix:semicolon
id|lp-&gt;budget
(braket
id|i
)braket
dot
id|period_started
op_assign
id|CURRENT_TIME
suffix:semicolon
id|lp-&gt;budget
(braket
id|i
)braket
dot
id|notified
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;budget
(braket
id|i
)braket
dot
id|used
op_ge
id|lp-&gt;budget
(braket
id|i
)braket
dot
id|amount
)paren
(brace
id|ret
op_or_assign
(paren
l_int|1
op_lshift
id|i
)paren
suffix:semicolon
)brace
)brace
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|ISDN_BUDGET_CHECK_DIAL
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
id|lp-&gt;budget
(braket
id|ISDN_BUDGET_DIAL
)braket
dot
id|used
op_increment
suffix:semicolon
id|lp-&gt;budget
(braket
id|ISDN_BUDGET_DIAL
)braket
dot
id|last_check
op_assign
id|CURRENT_TIME
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_BUDGET_CHECK_CHARGE
suffix:colon
id|lp-&gt;budget
(braket
id|ISDN_BUDGET_CHARGE
)braket
dot
id|used
op_increment
suffix:semicolon
id|lp-&gt;budget
(braket
id|ISDN_BUDGET_CHARGE
)braket
dot
id|last_check
op_assign
id|CURRENT_TIME
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_BUDGET_CHECK_ONLINE
suffix:colon
r_if
c_cond
(paren
id|lp-&gt;budget
(braket
id|ISDN_BUDGET_ONLINE
)braket
dot
id|last_check
)paren
(brace
id|lp-&gt;budget
(braket
id|ISDN_BUDGET_ONLINE
)braket
dot
id|used
op_add_assign
(paren
id|CURRENT_TIME
op_minus
id|lp-&gt;budget
(braket
id|ISDN_BUDGET_ONLINE
)braket
dot
id|last_check
)paren
suffix:semicolon
)brace
id|lp-&gt;budget
(braket
id|ISDN_BUDGET_ONLINE
)braket
dot
id|last_check
op_assign
id|CURRENT_TIME
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;if(ret)&n;&t;&t;&t;lp-&gt;flags |= ISDN_NET_DM_OFF;&n;*/
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_BUDGET_NUM_BUDGET
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ret
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
op_logical_and
op_logical_neg
id|lp-&gt;budget
(braket
id|i
)braket
dot
id|notified
)paren
(brace
r_switch
c_cond
(paren
id|i
)paren
(brace
r_case
id|ISDN_BUDGET_DIAL
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_budget: dial budget used up.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_BUDGET_CHARGE
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_budget: charge budget used up.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_BUDGET_ONLINE
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_budget: online budget used up.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_budget: budget #%d used up.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|lp-&gt;budget
(braket
id|i
)braket
dot
id|notified
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_return
id|ret
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_BUDGET_START_ONLINE
suffix:colon
id|lp-&gt;budget
(braket
id|ISDN_BUDGET_ONLINE
)braket
dot
id|last_check
op_assign
id|CURRENT_TIME
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_int
DECL|function|isdn_budget_ioctl
id|isdn_budget_ioctl
c_func
(paren
id|isdn_ioctl_budget
op_star
id|iocmd
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|isdn_net_findif
c_func
(paren
id|iocmd-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
r_switch
c_cond
(paren
id|iocmd-&gt;command
)paren
(brace
r_case
id|ISDN_BUDGET_SET_BUDGET
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
(brace
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|iocmd-&gt;budget
template_param
id|ISDN_BUDGET_NUM_BUDGET
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|iocmd-&gt;amount
OL
l_int|0
)paren
(brace
id|iocmd-&gt;amount
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
id|p-&gt;local-&gt;budget
(braket
id|iocmd-&gt;budget
)braket
dot
id|amount
op_assign
id|iocmd-&gt;amount
suffix:semicolon
id|p-&gt;local-&gt;budget
(braket
id|iocmd-&gt;budget
)braket
dot
id|period
op_assign
id|iocmd-&gt;period
suffix:semicolon
r_if
c_cond
(paren
id|iocmd-&gt;used
op_le
l_int|0
)paren
(brace
id|p-&gt;local-&gt;budget
(braket
id|iocmd-&gt;budget
)braket
dot
id|used
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|p-&gt;local-&gt;budget
(braket
id|iocmd-&gt;budget
)braket
dot
id|used
op_assign
id|iocmd-&gt;used
suffix:semicolon
r_if
c_cond
(paren
id|iocmd-&gt;period_started
op_eq
(paren
id|time_t
)paren
l_int|0
)paren
(brace
id|p-&gt;local-&gt;budget
(braket
id|iocmd-&gt;budget
)braket
dot
id|period_started
op_assign
id|CURRENT_TIME
suffix:semicolon
)brace
r_else
id|p-&gt;local-&gt;budget
(braket
id|iocmd-&gt;budget
)braket
dot
id|period_started
op_assign
id|iocmd-&gt;period_started
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_BUDGET_GET_BUDGET
suffix:colon
r_if
c_cond
(paren
id|iocmd-&gt;budget
template_param
id|ISDN_BUDGET_NUM_BUDGET
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|iocmd-&gt;amount
op_assign
id|p-&gt;local-&gt;budget
(braket
id|iocmd-&gt;budget
)braket
dot
id|amount
suffix:semicolon
id|iocmd-&gt;used
op_assign
id|p-&gt;local-&gt;budget
(braket
id|iocmd-&gt;budget
)braket
dot
id|used
suffix:semicolon
id|iocmd-&gt;period
op_assign
id|p-&gt;local-&gt;budget
(braket
id|iocmd-&gt;budget
)braket
dot
id|period
suffix:semicolon
id|iocmd-&gt;period_started
op_assign
id|p-&gt;local-&gt;budget
(braket
id|iocmd-&gt;budget
)braket
dot
id|period_started
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
macro_line|#endif
eof
