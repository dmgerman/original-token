multiline_comment|/*&n; * Copyright (C) 1996 Universidade de Lisboa&n; * &n; * Written by Pedro Roque Marques (roque@di.fc.ul.pt)&n; *&n; * This software may be used and distributed according to the terms of &n; * the GNU Public License, incorporated herein by reference.&n; */
multiline_comment|/*        &n; *        callbacks for the FSM&n; */
multiline_comment|/*&n; * Fix: 19981230 - Carlos Morgado &lt;chbm@techie.com&gt;&n; * Port of Nelson Escravana&squot;s &lt;nelson.escravana@usa.net&gt; fix to CalledPN &n; * NULL pointer dereference in cb_in_1 (originally fixed in 2.0)&n; */
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/tqueue.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/isdnif.h&gt;
macro_line|#include &quot;pcbit.h&quot;
macro_line|#include &quot;layer2.h&quot;
macro_line|#include &quot;edss1.h&quot;
macro_line|#include &quot;callbacks.h&quot;
macro_line|#include &quot;capi.h&quot;
DECL|variable|last_ref_num
id|ushort
id|last_ref_num
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n; *  send_conn_req&n; *&n; */
DECL|function|cb_out_1
r_void
id|cb_out_1
c_func
(paren
r_struct
id|pcbit_dev
op_star
id|dev
comma
r_struct
id|pcbit_chan
op_star
id|chan
comma
r_struct
id|callb_data
op_star
id|cbdata
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|len
suffix:semicolon
id|ushort
id|refnum
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Called Party Number: %s&bslash;n&quot;
comma
id|cbdata-&gt;data.setup.CalledPN
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;         * hdr - kmalloc in capi_conn_req&n;         *     - kfree   when msg has been sent&n;         */
r_if
c_cond
(paren
(paren
id|len
op_assign
id|capi_conn_req
c_func
(paren
id|cbdata-&gt;data.setup.CalledPN
comma
op_amp
id|skb
comma
id|chan-&gt;proto
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;capi_conn_req failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|refnum
op_assign
id|last_ref_num
op_increment
op_amp
l_int|0x7fffU
suffix:semicolon
id|chan-&gt;callref
op_assign
l_int|0
suffix:semicolon
id|chan-&gt;layer2link
op_assign
l_int|0
suffix:semicolon
id|chan-&gt;snum
op_assign
l_int|0
suffix:semicolon
id|chan-&gt;s_refnum
op_assign
id|refnum
suffix:semicolon
id|pcbit_l2_write
c_func
(paren
id|dev
comma
id|MSG_CONN_REQ
comma
id|refnum
comma
id|skb
comma
id|len
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  rcv CONNECT&n; *  will go into ACTIVE state&n; *  send CONN_ACTIVE_RESP&n; *  send Select protocol request &n; */
DECL|function|cb_out_2
r_void
id|cb_out_2
c_func
(paren
r_struct
id|pcbit_dev
op_star
id|dev
comma
r_struct
id|pcbit_chan
op_star
id|chan
comma
r_struct
id|callb_data
op_star
id|data
)paren
(brace
id|isdn_ctrl
id|ictl
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|len
suffix:semicolon
id|ushort
id|refnum
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
op_assign
id|capi_conn_active_resp
c_func
(paren
id|chan
comma
op_amp
id|skb
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;capi_conn_active_req failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|refnum
op_assign
id|last_ref_num
op_increment
op_amp
l_int|0x7fffU
suffix:semicolon
id|chan-&gt;s_refnum
op_assign
id|refnum
suffix:semicolon
id|pcbit_l2_write
c_func
(paren
id|dev
comma
id|MSG_CONN_ACTV_RESP
comma
id|refnum
comma
id|skb
comma
id|len
)paren
suffix:semicolon
id|ictl.command
op_assign
id|ISDN_STAT_DCONN
suffix:semicolon
id|ictl.driver
op_assign
id|dev-&gt;id
suffix:semicolon
id|ictl.arg
op_assign
id|chan-&gt;id
suffix:semicolon
id|dev-&gt;dev_if
op_member_access_from_pointer
id|statcallb
c_func
(paren
op_amp
id|ictl
)paren
suffix:semicolon
multiline_comment|/* ACTIVE D-channel */
multiline_comment|/* Select protocol  */
r_if
c_cond
(paren
(paren
id|len
op_assign
id|capi_select_proto_req
c_func
(paren
id|chan
comma
op_amp
id|skb
comma
l_int|1
multiline_comment|/*outgoing*/
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;capi_select_proto_req failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|refnum
op_assign
id|last_ref_num
op_increment
op_amp
l_int|0x7fffU
suffix:semicolon
id|chan-&gt;s_refnum
op_assign
id|refnum
suffix:semicolon
id|pcbit_l2_write
c_func
(paren
id|dev
comma
id|MSG_SELP_REQ
comma
id|refnum
comma
id|skb
comma
id|len
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Disconnect received (actually RELEASE COMPLETE) &n; * This means we were not able to establish connection with remote&n; * Inform the big boss above&n; */
DECL|function|cb_out_3
r_void
id|cb_out_3
c_func
(paren
r_struct
id|pcbit_dev
op_star
id|dev
comma
r_struct
id|pcbit_chan
op_star
id|chan
comma
r_struct
id|callb_data
op_star
id|data
)paren
(brace
id|isdn_ctrl
id|ictl
suffix:semicolon
id|ictl.command
op_assign
id|ISDN_STAT_DHUP
suffix:semicolon
id|ictl.driver
op_assign
id|dev-&gt;id
suffix:semicolon
id|ictl.arg
op_assign
id|chan-&gt;id
suffix:semicolon
id|dev-&gt;dev_if
op_member_access_from_pointer
id|statcallb
c_func
(paren
op_amp
id|ictl
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Incoming call received&n; * inform user&n; */
DECL|function|cb_in_1
r_void
id|cb_in_1
c_func
(paren
r_struct
id|pcbit_dev
op_star
id|dev
comma
r_struct
id|pcbit_chan
op_star
id|chan
comma
r_struct
id|callb_data
op_star
id|cbdata
)paren
(brace
id|isdn_ctrl
id|ictl
suffix:semicolon
r_int
r_int
id|refnum
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|len
suffix:semicolon
id|ictl.command
op_assign
id|ISDN_STAT_ICALL
suffix:semicolon
id|ictl.driver
op_assign
id|dev-&gt;id
suffix:semicolon
id|ictl.arg
op_assign
id|chan-&gt;id
suffix:semicolon
multiline_comment|/*&n;         *  ictl.num &gt;= strlen() + strlen() + 5&n;         */
r_if
c_cond
(paren
id|cbdata-&gt;data.setup.CallingPN
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;NULL CallingPN to phone; using 0&bslash;n&quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|ictl.parm.setup.phone
comma
l_string|&quot;0&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|strcpy
c_func
(paren
id|ictl.parm.setup.phone
comma
id|cbdata-&gt;data.setup.CallingPN
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cbdata-&gt;data.setup.CalledPN
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;NULL CalledPN to eazmsn; using 0&bslash;n&quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|ictl.parm.setup.eazmsn
comma
l_string|&quot;0&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|strcpy
c_func
(paren
id|ictl.parm.setup.eazmsn
comma
id|cbdata-&gt;data.setup.CalledPN
)paren
suffix:semicolon
)brace
id|ictl.parm.setup.si1
op_assign
l_int|7
suffix:semicolon
id|ictl.parm.setup.si2
op_assign
l_int|0
suffix:semicolon
id|ictl.parm.setup.plan
op_assign
l_int|0
suffix:semicolon
id|ictl.parm.setup.screen
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;statstr: %s&bslash;n&quot;
comma
id|ictl.num
)paren
suffix:semicolon
macro_line|#endif
id|dev-&gt;dev_if
op_member_access_from_pointer
id|statcallb
c_func
(paren
op_amp
id|ictl
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
op_assign
id|capi_conn_resp
c_func
(paren
id|chan
comma
op_amp
id|skb
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capi_conn_resp failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|refnum
op_assign
id|last_ref_num
op_increment
op_amp
l_int|0x7fffU
suffix:semicolon
id|chan-&gt;s_refnum
op_assign
id|refnum
suffix:semicolon
id|pcbit_l2_write
c_func
(paren
id|dev
comma
id|MSG_CONN_RESP
comma
id|refnum
comma
id|skb
comma
id|len
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * user has replied&n; * open the channel&n; * send CONNECT message CONNECT_ACTIVE_REQ in CAPI&n; */
DECL|function|cb_in_2
r_void
id|cb_in_2
c_func
(paren
r_struct
id|pcbit_dev
op_star
id|dev
comma
r_struct
id|pcbit_chan
op_star
id|chan
comma
r_struct
id|callb_data
op_star
id|data
)paren
(brace
r_int
r_int
id|refnum
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|len
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
op_assign
id|capi_conn_active_req
c_func
(paren
id|chan
comma
op_amp
id|skb
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capi_conn_active_req failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|refnum
op_assign
id|last_ref_num
op_increment
op_amp
l_int|0x7fffU
suffix:semicolon
id|chan-&gt;s_refnum
op_assign
id|refnum
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;sending MSG_CONN_ACTV_REQ&bslash;n&quot;
)paren
suffix:semicolon
id|pcbit_l2_write
c_func
(paren
id|dev
comma
id|MSG_CONN_ACTV_REQ
comma
id|refnum
comma
id|skb
comma
id|len
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * CONN_ACK arrived&n; * start b-proto selection&n; *&n; */
DECL|function|cb_in_3
r_void
id|cb_in_3
c_func
(paren
r_struct
id|pcbit_dev
op_star
id|dev
comma
r_struct
id|pcbit_chan
op_star
id|chan
comma
r_struct
id|callb_data
op_star
id|data
)paren
(brace
r_int
r_int
id|refnum
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|len
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
op_assign
id|capi_select_proto_req
c_func
(paren
id|chan
comma
op_amp
id|skb
comma
l_int|0
multiline_comment|/*incoming*/
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;capi_select_proto_req failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|refnum
op_assign
id|last_ref_num
op_increment
op_amp
l_int|0x7fffU
suffix:semicolon
id|chan-&gt;s_refnum
op_assign
id|refnum
suffix:semicolon
id|pcbit_l2_write
c_func
(paren
id|dev
comma
id|MSG_SELP_REQ
comma
id|refnum
comma
id|skb
comma
id|len
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Received disconnect ind on active state&n; * send disconnect resp&n; * send msg to user&n; */
DECL|function|cb_disc_1
r_void
id|cb_disc_1
c_func
(paren
r_struct
id|pcbit_dev
op_star
id|dev
comma
r_struct
id|pcbit_chan
op_star
id|chan
comma
r_struct
id|callb_data
op_star
id|data
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|len
suffix:semicolon
id|ushort
id|refnum
suffix:semicolon
id|isdn_ctrl
id|ictl
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
op_assign
id|capi_disc_resp
c_func
(paren
id|chan
comma
op_amp
id|skb
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;capi_disc_resp failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|refnum
op_assign
id|last_ref_num
op_increment
op_amp
l_int|0x7fffU
suffix:semicolon
id|chan-&gt;s_refnum
op_assign
id|refnum
suffix:semicolon
id|pcbit_l2_write
c_func
(paren
id|dev
comma
id|MSG_DISC_RESP
comma
id|refnum
comma
id|skb
comma
id|len
)paren
suffix:semicolon
id|ictl.command
op_assign
id|ISDN_STAT_BHUP
suffix:semicolon
id|ictl.driver
op_assign
id|dev-&gt;id
suffix:semicolon
id|ictl.arg
op_assign
id|chan-&gt;id
suffix:semicolon
id|dev-&gt;dev_if
op_member_access_from_pointer
id|statcallb
c_func
(paren
op_amp
id|ictl
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  User HANGUP on active/call proceeding state&n; *  send disc.req&n; */
DECL|function|cb_disc_2
r_void
id|cb_disc_2
c_func
(paren
r_struct
id|pcbit_dev
op_star
id|dev
comma
r_struct
id|pcbit_chan
op_star
id|chan
comma
r_struct
id|callb_data
op_star
id|data
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|len
suffix:semicolon
id|ushort
id|refnum
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
op_assign
id|capi_disc_req
c_func
(paren
id|chan-&gt;callref
comma
op_amp
id|skb
comma
id|CAUSE_NORMAL
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;capi_disc_req failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|refnum
op_assign
id|last_ref_num
op_increment
op_amp
l_int|0x7fffU
suffix:semicolon
id|chan-&gt;s_refnum
op_assign
id|refnum
suffix:semicolon
id|pcbit_l2_write
c_func
(paren
id|dev
comma
id|MSG_DISC_REQ
comma
id|refnum
comma
id|skb
comma
id|len
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  Disc confirm received send BHUP&n; *  Problem: when the HL driver sends the disc req itself&n; *           LL receives BHUP&n; */
DECL|function|cb_disc_3
r_void
id|cb_disc_3
c_func
(paren
r_struct
id|pcbit_dev
op_star
id|dev
comma
r_struct
id|pcbit_chan
op_star
id|chan
comma
r_struct
id|callb_data
op_star
id|data
)paren
(brace
id|isdn_ctrl
id|ictl
suffix:semicolon
id|ictl.command
op_assign
id|ISDN_STAT_BHUP
suffix:semicolon
id|ictl.driver
op_assign
id|dev-&gt;id
suffix:semicolon
id|ictl.arg
op_assign
id|chan-&gt;id
suffix:semicolon
id|dev-&gt;dev_if
op_member_access_from_pointer
id|statcallb
c_func
(paren
op_amp
id|ictl
)paren
suffix:semicolon
)brace
DECL|function|cb_notdone
r_void
id|cb_notdone
c_func
(paren
r_struct
id|pcbit_dev
op_star
id|dev
comma
r_struct
id|pcbit_chan
op_star
id|chan
comma
r_struct
id|callb_data
op_star
id|data
)paren
(brace
)brace
multiline_comment|/*&n; * send activate b-chan protocol&n; */
DECL|function|cb_selp_1
r_void
id|cb_selp_1
c_func
(paren
r_struct
id|pcbit_dev
op_star
id|dev
comma
r_struct
id|pcbit_chan
op_star
id|chan
comma
r_struct
id|callb_data
op_star
id|data
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|len
suffix:semicolon
id|ushort
id|refnum
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
op_assign
id|capi_activate_transp_req
c_func
(paren
id|chan
comma
op_amp
id|skb
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;capi_conn_activate_transp_req failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|refnum
op_assign
id|last_ref_num
op_increment
op_amp
l_int|0x7fffU
suffix:semicolon
id|chan-&gt;s_refnum
op_assign
id|refnum
suffix:semicolon
id|pcbit_l2_write
c_func
(paren
id|dev
comma
id|MSG_ACT_TRANSP_REQ
comma
id|refnum
comma
id|skb
comma
id|len
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  Inform User that the B-channel is available&n; */
DECL|function|cb_open
r_void
id|cb_open
c_func
(paren
r_struct
id|pcbit_dev
op_star
id|dev
comma
r_struct
id|pcbit_chan
op_star
id|chan
comma
r_struct
id|callb_data
op_star
id|data
)paren
(brace
id|isdn_ctrl
id|ictl
suffix:semicolon
id|ictl.command
op_assign
id|ISDN_STAT_BCONN
suffix:semicolon
id|ictl.driver
op_assign
id|dev-&gt;id
suffix:semicolon
id|ictl.arg
op_assign
id|chan-&gt;id
suffix:semicolon
id|dev-&gt;dev_if
op_member_access_from_pointer
id|statcallb
c_func
(paren
op_amp
id|ictl
)paren
suffix:semicolon
)brace
eof
