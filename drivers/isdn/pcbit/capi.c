multiline_comment|/*&n; * Copyright (C) 1996 Universidade de Lisboa&n; * &n; * Written by Pedro Roque Marques (roque@di.fc.ul.pt)&n; *&n; * This software may be used and distributed according to the terms of &n; * the GNU Public License, incorporated herein by reference.&n; */
multiline_comment|/*        &n; *        CAPI encoder/decoder for&n; *        Portugal Telecom CAPI 2.0&n; *&n; *        Not compatible with the AVM Gmbh. CAPI 2.0&n; */
multiline_comment|/*&n; *        Documentation:&n; *        - &quot;Common ISDN API - Perfil Portugu&#xfffd;s - Vers&#xfffd;o 2.1&quot;,&n; *           Telecom Portugal, Fev 1992.&n; *        - &quot;Common ISDN API - Especifica&#xfffd;&#xfffd;o de protocolos para &n; *           acesso aos canais B&quot;, Inesc, Jan 1994.&n; */
multiline_comment|/*&n; *        TODO: better decoding of Information Elements&n; *              for debug purposes mainly&n; *              encode our number in CallerPN and ConnectedPN&n; */
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/tqueue.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/string.h&gt;
macro_line|#include &lt;linux/isdnif.h&gt;
macro_line|#include &quot;pcbit.h&quot;
macro_line|#include &quot;edss1.h&quot;
macro_line|#include &quot;capi.h&quot;
multiline_comment|/*&n; *  Encoding of CAPI messages&n; *&n; */
DECL|function|capi_conn_req
r_int
id|capi_conn_req
c_func
(paren
r_const
r_char
op_star
id|calledPN
comma
r_struct
id|sk_buff
op_star
op_star
id|skb
comma
r_int
id|proto
)paren
(brace
id|ushort
id|len
suffix:semicolon
multiline_comment|/*&n;         * length&n;         *   AppInfoMask - 2&n;         *   BC0         - 3&n;         *   BC1         - 1&n;         *   Chan        - 2&n;         *   Keypad      - 1&n;         *   CPN         - 1&n;         *   CPSA        - 1&n;         *   CalledPN    - 2 + strlen&n;         *   CalledPSA   - 1&n;         *   rest...     - 4&n;         *   ----------------&n;         *   Total        18 + strlen&n;         */
id|len
op_assign
l_int|18
op_plus
id|strlen
c_func
(paren
id|calledPN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|proto
op_eq
id|ISDN_PROTO_L2_TRANS
)paren
id|len
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;capi_conn_req: alloc_skb failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* InfoElmMask */
op_star
(paren
(paren
id|ushort
op_star
)paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|2
)paren
)paren
op_assign
id|AppInfoMask
suffix:semicolon
r_if
c_cond
(paren
id|proto
op_eq
id|ISDN_PROTO_L2_TRANS
)paren
(brace
multiline_comment|/* Bearer Capability - Mandatory*/
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* BC0.Length&t;&t;*/
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* Speech&t;&t;*/
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* Circuit Mode&t;&t;*/
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0x23
suffix:semicolon
multiline_comment|/* A-law&t;&t;*/
)brace
r_else
(brace
multiline_comment|/* Bearer Capability - Mandatory*/
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* BC0.Length&t;&t;*/
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0x88
suffix:semicolon
multiline_comment|/* Digital Information&t;*/
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0x90
suffix:semicolon
multiline_comment|/* BC0.Octect4&t;&t;*/
)brace
multiline_comment|/* Bearer Capability - Optional*/
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* BC1.Length = 0                    */
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* ChannelID.Length = 1              */
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0x83
suffix:semicolon
multiline_comment|/* Basic Interface - Any Channel     */
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Keypad.Length = 0                 */
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* CallingPN.Length = 0              */
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* CallingPSA.Length = 0             */
multiline_comment|/* Called Party Number */
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
id|strlen
c_func
(paren
id|calledPN
)paren
op_plus
l_int|1
suffix:semicolon
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0x81
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
id|strlen
c_func
(paren
id|calledPN
)paren
)paren
comma
id|calledPN
comma
id|strlen
c_func
(paren
id|calledPN
)paren
)paren
suffix:semicolon
multiline_comment|/* &squot;#&squot; */
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* CalledPSA.Length = 0     */
multiline_comment|/* LLC.Length  = 0; */
multiline_comment|/* HLC0.Length = 0; */
multiline_comment|/* HLC1.Length = 0; */
multiline_comment|/* UTUS.Length = 0; */
id|memset
c_func
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|4
)paren
comma
l_int|0
comma
l_int|4
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|function|capi_conn_resp
r_int
id|capi_conn_resp
c_func
(paren
r_struct
id|pcbit_chan
op_star
id|chan
comma
r_struct
id|sk_buff
op_star
op_star
id|skb
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
l_int|5
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;capi_conn_resp: alloc_skb failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
op_star
(paren
(paren
id|ushort
op_star
)paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|2
)paren
)paren
op_assign
id|chan-&gt;callref
suffix:semicolon
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* ACCEPT_CALL */
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0
suffix:semicolon
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0
suffix:semicolon
r_return
l_int|5
suffix:semicolon
)brace
DECL|function|capi_conn_active_req
r_int
id|capi_conn_active_req
c_func
(paren
r_struct
id|pcbit_chan
op_star
id|chan
comma
r_struct
id|sk_buff
op_star
op_star
id|skb
)paren
(brace
multiline_comment|/*&n;         * 8 bytes&n;         */
r_if
c_cond
(paren
(paren
op_star
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
l_int|8
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;capi_conn_active_req: alloc_skb failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
op_star
(paren
(paren
id|ushort
op_star
)paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|2
)paren
)paren
op_assign
id|chan-&gt;callref
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Call Reference: %04x&bslash;n&quot;
comma
id|chan-&gt;callref
)paren
suffix:semicolon
macro_line|#endif
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*  BC.Length = 0;          */
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*  ConnectedPN.Length = 0  */
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*  PSA.Length              */
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*  LLC.Length = 0;         */
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*  HLC.Length = 0;         */
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*  UTUS.Length = 0;        */
r_return
l_int|8
suffix:semicolon
)brace
DECL|function|capi_conn_active_resp
r_int
id|capi_conn_active_resp
c_func
(paren
r_struct
id|pcbit_chan
op_star
id|chan
comma
r_struct
id|sk_buff
op_star
op_star
id|skb
)paren
(brace
multiline_comment|/*&n;         * 2 bytes&n;         */
r_if
c_cond
(paren
(paren
op_star
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
l_int|2
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;capi_conn_active_resp: alloc_skb failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
op_star
(paren
(paren
id|ushort
op_star
)paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|2
)paren
)paren
op_assign
id|chan-&gt;callref
suffix:semicolon
r_return
l_int|2
suffix:semicolon
)brace
DECL|function|capi_select_proto_req
r_int
id|capi_select_proto_req
c_func
(paren
r_struct
id|pcbit_chan
op_star
id|chan
comma
r_struct
id|sk_buff
op_star
op_star
id|skb
comma
r_int
id|outgoing
)paren
(brace
multiline_comment|/*&n;         * 18 bytes&n;         */
r_if
c_cond
(paren
(paren
op_star
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
l_int|18
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;capi_select_proto_req: alloc_skb failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
op_star
(paren
(paren
id|ushort
op_star
)paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|2
)paren
)paren
op_assign
id|chan-&gt;callref
suffix:semicolon
multiline_comment|/* Layer2 protocol */
r_switch
c_cond
(paren
id|chan-&gt;proto
)paren
(brace
r_case
id|ISDN_PROTO_L2_X75I
suffix:colon
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0x05
suffix:semicolon
multiline_comment|/* LAPB */
r_break
suffix:semicolon
r_case
id|ISDN_PROTO_L2_HDLC
suffix:colon
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0x02
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_PROTO_L2_TRANS
suffix:colon
multiline_comment|/* &n;&t;&t; *&t;Voice (a-law)&n;&t;&t; */
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0x06
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
macro_line|#ifdef DEBUG 
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Transparent&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0x03
suffix:semicolon
r_break
suffix:semicolon
)brace
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
(paren
id|outgoing
ques
c_cond
l_int|0x02
suffix:colon
l_int|0x42
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t ask */
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0x00
suffix:semicolon
op_star
(paren
(paren
id|ushort
op_star
)paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|2
)paren
)paren
op_assign
id|MRU
suffix:semicolon
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0x08
suffix:semicolon
multiline_comment|/* Modulo */
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0x07
suffix:semicolon
multiline_comment|/* Max Window */
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* No Layer3 Protocol */
multiline_comment|/*&n;         * 2 - layer3 MTU       [10]&n;         *   - Modulo           [12]&n;         *   - Window           &n;         *   - layer1 proto     [14]&n;         *   - bitrate&n;         *   - sub-channel      [16]&n;         *   - layer1dataformat [17]&n;         */
id|memset
c_func
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|8
)paren
comma
l_int|0
comma
l_int|8
)paren
suffix:semicolon
r_return
l_int|18
suffix:semicolon
)brace
DECL|function|capi_activate_transp_req
r_int
id|capi_activate_transp_req
c_func
(paren
r_struct
id|pcbit_chan
op_star
id|chan
comma
r_struct
id|sk_buff
op_star
op_star
id|skb
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
l_int|7
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;capi_activate_transp_req: alloc_skb failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
op_star
(paren
(paren
id|ushort
op_star
)paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|2
)paren
)paren
op_assign
id|chan-&gt;callref
suffix:semicolon
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
id|chan-&gt;layer2link
suffix:semicolon
multiline_comment|/* Layer2 id */
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Transmit by default */
op_star
(paren
(paren
id|ushort
op_star
)paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|2
)paren
)paren
op_assign
id|MRU
suffix:semicolon
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* Enables reception*/
r_return
l_int|7
suffix:semicolon
)brace
DECL|function|capi_tdata_req
r_int
id|capi_tdata_req
c_func
(paren
r_struct
id|pcbit_chan
op_star
id|chan
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|ushort
id|data_len
suffix:semicolon
multiline_comment|/*  &n;&t; * callref      - 2  &n;&t; * layer2link   - 1&n;&t; * wBlockLength - 2 &n;&t; * data         - 4&n;&t; * sernum       - 1&n;&t; */
id|data_len
op_assign
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|skb_headroom
c_func
(paren
id|skb
)paren
OL
l_int|10
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;No headspace (%u) on headroom %p for capi header&bslash;n&quot;
comma
id|skb_headroom
c_func
(paren
id|skb
)paren
comma
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
id|skb_push
c_func
(paren
id|skb
comma
l_int|10
)paren
suffix:semicolon
)brace
op_star
(paren
(paren
id|u16
op_star
)paren
(paren
id|skb-&gt;data
)paren
)paren
op_assign
id|chan-&gt;callref
suffix:semicolon
id|skb-&gt;data
(braket
l_int|2
)braket
op_assign
id|chan-&gt;layer2link
suffix:semicolon
op_star
(paren
(paren
id|u16
op_star
)paren
(paren
id|skb-&gt;data
op_plus
l_int|3
)paren
)paren
op_assign
id|data_len
suffix:semicolon
id|chan-&gt;s_refnum
op_assign
(paren
id|chan-&gt;s_refnum
op_plus
l_int|1
)paren
op_mod
l_int|8
suffix:semicolon
op_star
(paren
(paren
id|u32
op_star
)paren
(paren
id|skb-&gt;data
op_plus
l_int|5
)paren
)paren
op_assign
id|chan-&gt;s_refnum
suffix:semicolon
id|skb-&gt;data
(braket
l_int|9
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* HDLC frame number */
r_return
l_int|10
suffix:semicolon
)brace
DECL|function|capi_tdata_resp
r_int
id|capi_tdata_resp
c_func
(paren
r_struct
id|pcbit_chan
op_star
id|chan
comma
r_struct
id|sk_buff
op_star
op_star
id|skb
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
l_int|4
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;capi_tdata_resp: alloc_skb failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
op_star
(paren
(paren
id|ushort
op_star
)paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|2
)paren
)paren
op_assign
id|chan-&gt;callref
suffix:semicolon
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
id|chan-&gt;layer2link
suffix:semicolon
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
id|chan-&gt;r_refnum
suffix:semicolon
r_return
(paren
op_star
id|skb
)paren
op_member_access_from_pointer
id|len
suffix:semicolon
)brace
DECL|function|capi_disc_req
r_int
id|capi_disc_req
c_func
(paren
id|ushort
id|callref
comma
r_struct
id|sk_buff
op_star
op_star
id|skb
comma
id|u_char
id|cause
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
l_int|6
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;capi_disc_req: alloc_skb failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
op_star
(paren
(paren
id|ushort
op_star
)paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|2
)paren
)paren
op_assign
id|callref
suffix:semicolon
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* Cause.Length = 2; */
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0x80
suffix:semicolon
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0x80
op_or
id|cause
suffix:semicolon
multiline_comment|/* &n;         * Change it: we should send &squot;Sic transit gloria Mundi&squot; here ;-) &n;         */
op_star
(paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|1
)paren
)paren
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* UTUS.Length = 0;  */
r_return
l_int|6
suffix:semicolon
)brace
DECL|function|capi_disc_resp
r_int
id|capi_disc_resp
c_func
(paren
r_struct
id|pcbit_chan
op_star
id|chan
comma
r_struct
id|sk_buff
op_star
op_star
id|skb
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
l_int|2
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;capi_disc_resp: alloc_skb failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
op_star
(paren
(paren
id|ushort
op_star
)paren
id|skb_put
c_func
(paren
op_star
id|skb
comma
l_int|2
)paren
)paren
op_assign
id|chan-&gt;callref
suffix:semicolon
r_return
l_int|2
suffix:semicolon
)brace
multiline_comment|/*&n; *  Decoding of CAPI messages&n; *&n; */
DECL|function|capi_decode_conn_ind
r_int
id|capi_decode_conn_ind
c_func
(paren
r_struct
id|pcbit_chan
op_star
id|chan
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|callb_data
op_star
id|info
)paren
(brace
r_int
id|CIlen
comma
id|len
suffix:semicolon
multiline_comment|/* Call Reference [CAPI] */
id|chan-&gt;callref
op_assign
op_star
(paren
(paren
id|ushort
op_star
)paren
id|skb-&gt;data
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Call Reference: %04x&bslash;n&quot;
comma
id|chan-&gt;callref
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Channel Identification */
multiline_comment|/* Expect  &n;           Len = 1 &n;           Octect 3 = 0100 10CC - [ 7 Basic, 4 , 2-1 chan ]&n;           */
id|CIlen
op_assign
id|skb-&gt;data
(braket
l_int|0
)braket
suffix:semicolon
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
id|CIlen
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|skb-&gt;data
(braket
l_int|1
)braket
)paren
op_amp
l_int|0xFC
)paren
op_eq
l_int|0x48
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;decode_conn_ind: chan ok&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;phyChan = %d&bslash;n&quot;
comma
id|skb-&gt;data
(braket
l_int|1
)braket
op_amp
l_int|0x03
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;conn_ind: CIlen = %d&bslash;n&quot;
comma
id|CIlen
)paren
suffix:semicolon
macro_line|#endif
id|skb_pull
c_func
(paren
id|skb
comma
id|CIlen
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Calling Party Number */
multiline_comment|/* An &quot;additional service&quot; as far as Portugal Telecom is concerned */
id|len
op_assign
id|skb-&gt;data
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
r_int
id|count
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;CPN: Octect 3 %02x&bslash;n&quot;
comma
id|skb-&gt;data
(braket
l_int|1
)braket
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|skb-&gt;data
(braket
l_int|1
)braket
op_amp
l_int|0x80
)paren
op_eq
l_int|0
)paren
id|count
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;data.setup.CallingPN
op_assign
id|kmalloc
c_func
(paren
id|len
op_minus
id|count
op_plus
l_int|1
comma
id|GFP_ATOMIC
)paren
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|memcpy
c_func
(paren
id|info-&gt;data.setup.CallingPN
comma
id|skb-&gt;data
op_plus
id|count
op_plus
l_int|1
comma
id|len
op_minus
id|count
)paren
suffix:semicolon
id|info-&gt;data.setup.CallingPN
(braket
id|len
op_minus
id|count
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|info-&gt;data.setup.CallingPN
op_assign
l_int|NULL
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;NULL CallingPN&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|skb_pull
c_func
(paren
id|skb
comma
id|len
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Calling Party Subaddress */
id|skb_pull
c_func
(paren
id|skb
comma
id|skb-&gt;data
(braket
l_int|0
)braket
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Called Party Number */
id|len
op_assign
id|skb-&gt;data
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
r_int
id|count
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb-&gt;data
(braket
l_int|1
)braket
op_amp
l_int|0x80
)paren
op_eq
l_int|0
)paren
id|count
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;data.setup.CalledPN
op_assign
id|kmalloc
c_func
(paren
id|len
op_minus
id|count
op_plus
l_int|1
comma
id|GFP_ATOMIC
)paren
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|memcpy
c_func
(paren
id|info-&gt;data.setup.CalledPN
comma
id|skb-&gt;data
op_plus
id|count
op_plus
l_int|1
comma
id|len
op_minus
id|count
)paren
suffix:semicolon
id|info-&gt;data.setup.CalledPN
(braket
id|len
op_minus
id|count
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|info-&gt;data.setup.CalledPN
op_assign
l_int|NULL
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;NULL CalledPN&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|skb_pull
c_func
(paren
id|skb
comma
id|len
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Called Party Subaddress */
id|skb_pull
c_func
(paren
id|skb
comma
id|skb-&gt;data
(braket
l_int|0
)braket
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* LLC */
id|skb_pull
c_func
(paren
id|skb
comma
id|skb-&gt;data
(braket
l_int|0
)braket
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* HLC */
id|skb_pull
c_func
(paren
id|skb
comma
id|skb-&gt;data
(braket
l_int|0
)braket
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* U2U */
id|skb_pull
c_func
(paren
id|skb
comma
id|skb-&gt;data
(braket
l_int|0
)braket
op_plus
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *  returns errcode&n; */
DECL|function|capi_decode_conn_conf
r_int
id|capi_decode_conn_conf
c_func
(paren
r_struct
id|pcbit_chan
op_star
id|chan
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
op_star
id|complete
)paren
(brace
r_int
id|errcode
suffix:semicolon
id|chan-&gt;callref
op_assign
op_star
(paren
(paren
id|ushort
op_star
)paren
id|skb-&gt;data
)paren
suffix:semicolon
multiline_comment|/* Update CallReference */
id|skb_pull
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
id|errcode
op_assign
op_star
(paren
(paren
id|ushort
op_star
)paren
id|skb-&gt;data
)paren
suffix:semicolon
multiline_comment|/* read errcode */
id|skb_pull
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
op_star
id|complete
op_assign
op_star
(paren
id|skb-&gt;data
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* FIX ME */
multiline_comment|/* This is actually a firmware bug */
r_if
c_cond
(paren
op_logical_neg
op_star
id|complete
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;complete=%02x&bslash;n&quot;
comma
op_star
id|complete
)paren
suffix:semicolon
op_star
id|complete
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Optional Bearer Capability */
id|skb_pull
c_func
(paren
id|skb
comma
op_star
(paren
id|skb-&gt;data
)paren
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Channel Identification */
id|skb_pull
c_func
(paren
id|skb
comma
op_star
(paren
id|skb-&gt;data
)paren
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* High Layer Compatibility follows */
id|skb_pull
c_func
(paren
id|skb
comma
op_star
(paren
id|skb-&gt;data
)paren
op_plus
l_int|1
)paren
suffix:semicolon
r_return
id|errcode
suffix:semicolon
)brace
DECL|function|capi_decode_conn_actv_ind
r_int
id|capi_decode_conn_actv_ind
c_func
(paren
r_struct
id|pcbit_chan
op_star
id|chan
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|ushort
id|len
suffix:semicolon
macro_line|#ifdef DEBUG
r_char
id|str
(braket
l_int|32
)braket
suffix:semicolon
macro_line|#endif
multiline_comment|/* Yet Another Bearer Capability */
id|skb_pull
c_func
(paren
id|skb
comma
op_star
(paren
id|skb-&gt;data
)paren
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Connected Party Number */
id|len
op_assign
op_star
(paren
id|skb-&gt;data
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
id|len
OG
l_int|1
op_logical_and
id|len
OL
l_int|31
)paren
(brace
id|memcpy
c_func
(paren
id|str
comma
id|skb-&gt;data
op_plus
l_int|2
comma
id|len
op_minus
l_int|1
)paren
suffix:semicolon
id|str
(braket
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Connected Party Number: %s&bslash;n&quot;
comma
id|str
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;actv_ind CPN len = %d&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
macro_line|#endif
id|skb_pull
c_func
(paren
id|skb
comma
id|len
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Connected Subaddress */
id|skb_pull
c_func
(paren
id|skb
comma
op_star
(paren
id|skb-&gt;data
)paren
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Low Layer Capability */
id|skb_pull
c_func
(paren
id|skb
comma
op_star
(paren
id|skb-&gt;data
)paren
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* High Layer Capability */
id|skb_pull
c_func
(paren
id|skb
comma
op_star
(paren
id|skb-&gt;data
)paren
op_plus
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|capi_decode_conn_actv_conf
r_int
id|capi_decode_conn_actv_conf
c_func
(paren
r_struct
id|pcbit_chan
op_star
id|chan
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|ushort
id|errcode
suffix:semicolon
id|errcode
op_assign
op_star
(paren
(paren
id|ushort
op_star
)paren
id|skb-&gt;data
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Channel Identification &n;        skb_pull(skb, skb-&gt;data[0] + 1);&n;        */
r_return
id|errcode
suffix:semicolon
)brace
DECL|function|capi_decode_sel_proto_conf
r_int
id|capi_decode_sel_proto_conf
c_func
(paren
r_struct
id|pcbit_chan
op_star
id|chan
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|ushort
id|errcode
suffix:semicolon
id|chan-&gt;layer2link
op_assign
op_star
(paren
id|skb-&gt;data
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
id|errcode
op_assign
op_star
(paren
(paren
id|ushort
op_star
)paren
id|skb-&gt;data
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
r_return
id|errcode
suffix:semicolon
)brace
DECL|function|capi_decode_actv_trans_conf
r_int
id|capi_decode_actv_trans_conf
c_func
(paren
r_struct
id|pcbit_chan
op_star
id|chan
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|ushort
id|errcode
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;layer2link
op_ne
op_star
(paren
id|skb-&gt;data
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;capi_decode_actv_trans_conf: layer2link doesn&squot;t match&bslash;n&quot;
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
id|errcode
op_assign
op_star
(paren
(paren
id|ushort
op_star
)paren
id|skb-&gt;data
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
r_return
id|errcode
suffix:semicolon
)brace
DECL|function|capi_decode_disc_ind
r_int
id|capi_decode_disc_ind
c_func
(paren
r_struct
id|pcbit_chan
op_star
id|chan
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|ushort
id|len
suffix:semicolon
macro_line|#ifdef DEBUG
r_int
id|i
suffix:semicolon
macro_line|#endif
multiline_comment|/* Cause */
id|len
op_assign
op_star
(paren
id|skb-&gt;data
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Cause Octect %d: %02x&bslash;n&quot;
comma
id|i
op_plus
l_int|3
comma
op_star
(paren
id|skb-&gt;data
op_plus
id|i
)paren
)paren
suffix:semicolon
macro_line|#endif
id|skb_pull
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|capi_decode_disc_conf
r_int
id|capi_decode_disc_conf
c_func
(paren
r_struct
id|pcbit_chan
op_star
id|chan
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|ushort
id|errcode
suffix:semicolon
id|errcode
op_assign
op_star
(paren
(paren
id|ushort
op_star
)paren
id|skb-&gt;data
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
r_return
id|errcode
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
DECL|function|capi_decode_debug_188
r_int
id|capi_decode_debug_188
c_func
(paren
id|u_char
op_star
id|hdr
comma
id|ushort
id|hdrlen
)paren
(brace
r_char
id|str
(braket
l_int|64
)braket
suffix:semicolon
r_int
id|len
suffix:semicolon
id|len
op_assign
id|hdr
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|64
op_logical_and
id|len
op_eq
id|hdrlen
op_minus
l_int|1
)paren
(brace
id|memcpy
c_func
(paren
id|str
comma
id|hdr
op_plus
l_int|1
comma
id|hdrlen
op_minus
l_int|1
)paren
suffix:semicolon
id|str
(braket
id|hdrlen
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|str
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;debug message incorrect&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
eof
