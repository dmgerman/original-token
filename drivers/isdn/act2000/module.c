multiline_comment|/* $Id: module.c,v 1.14 2000/11/12 16:32:06 kai Exp $&n; *&n; * ISDN lowlevel-module for the IBM ISDN-S0 Active 2000.&n; *&n; * Copyright 1998 by Fritz Elfert (fritz@isdn4linux.de)&n; * Thanks to Friedemann Baitinger and IBM Germany&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA. &n; *&n; */
macro_line|#include &quot;act2000.h&quot;
macro_line|#include &quot;act2000_isa.h&quot;
macro_line|#include &quot;capi.h&quot;
DECL|variable|act2000_isa_ports
r_static
r_int
r_int
id|act2000_isa_ports
(braket
)braket
op_assign
(brace
l_int|0x0200
comma
l_int|0x0240
comma
l_int|0x0280
comma
l_int|0x02c0
comma
l_int|0x0300
comma
l_int|0x0340
comma
l_int|0x0380
comma
l_int|0xcfe0
comma
l_int|0xcfa0
comma
l_int|0xcf60
comma
l_int|0xcf20
comma
l_int|0xcee0
comma
l_int|0xcea0
comma
l_int|0xce60
comma
)brace
suffix:semicolon
DECL|macro|ISA_NRPORTS
mdefine_line|#define ISA_NRPORTS (sizeof(act2000_isa_ports)/sizeof(unsigned short))
DECL|variable|cards
r_static
id|act2000_card
op_star
id|cards
op_assign
(paren
id|act2000_card
op_star
)paren
l_int|NULL
suffix:semicolon
multiline_comment|/* Parameters to be set by insmod */
DECL|variable|act_bus
r_static
r_int
id|act_bus
op_assign
l_int|0
suffix:semicolon
DECL|variable|act_port
r_static
r_int
id|act_port
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* -1 = Autoprobe  */
DECL|variable|act_irq
r_static
r_int
id|act_irq
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* -1 = Autoselect */
DECL|variable|act_id
r_static
r_char
op_star
id|act_id
op_assign
l_string|&quot;&bslash;0&bslash;0&bslash;0&bslash;0&bslash;0&bslash;0&bslash;0&bslash;0&bslash;0&bslash;0&bslash;0&bslash;0&bslash;0&bslash;0&bslash;0&bslash;0&quot;
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Driver for IBM Active 2000 ISDN card&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Fritz Elfert&quot;
)paren
suffix:semicolon
id|MODULE_SUPPORTED_DEVICE
c_func
(paren
l_string|&quot;ISDN subsystem&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|act_bus
comma
l_string|&quot;BusType of first card, 1=ISA, 2=MCA, 3=PCMCIA, currently only ISA&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|membase
comma
l_string|&quot;Base port address of first card&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|act_irq
comma
l_string|&quot;IRQ of first card (-1 = grab next free IRQ)&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|act_id
comma
l_string|&quot;ID-String of first card&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|act_bus
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|act_port
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|act_irq
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|act_id
comma
l_string|&quot;s&quot;
)paren
suffix:semicolon
r_static
r_int
id|act2000_addcard
c_func
(paren
r_int
comma
r_int
comma
r_int
comma
r_char
op_star
)paren
suffix:semicolon
r_static
id|act2000_chan
op_star
DECL|function|find_channel
id|find_channel
c_func
(paren
id|act2000_card
op_star
id|card
comma
r_int
id|channel
)paren
(brace
r_if
c_cond
(paren
(paren
id|channel
op_ge
l_int|0
)paren
op_logical_and
(paren
id|channel
OL
id|ACT2000_BCH
)paren
)paren
r_return
op_amp
(paren
id|card-&gt;bch
(braket
id|channel
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;act2000: Invalid channel %d&bslash;n&quot;
comma
id|channel
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Free MSN list&n; */
r_static
r_void
DECL|function|act2000_clear_msn
id|act2000_clear_msn
c_func
(paren
id|act2000_card
op_star
id|card
)paren
(brace
r_struct
id|msn_entry
op_star
id|p
op_assign
id|card-&gt;msn_list
suffix:semicolon
r_struct
id|msn_entry
op_star
id|q
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|card-&gt;msn_list
op_assign
l_int|NULL
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
id|q
op_assign
id|p-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|p
)paren
suffix:semicolon
id|p
op_assign
id|q
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Find an MSN entry in the list.&n; * If ia5 != 0, return IA5-encoded EAZ, else&n; * return a bitmask with corresponding bit set.&n; */
r_static
id|__u16
DECL|function|act2000_find_msn
id|act2000_find_msn
c_func
(paren
id|act2000_card
op_star
id|card
comma
r_char
op_star
id|msn
comma
r_int
id|ia5
)paren
(brace
r_struct
id|msn_entry
op_star
id|p
op_assign
id|card-&gt;msn_list
suffix:semicolon
id|__u8
id|eaz
op_assign
l_char|&squot;0&squot;
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|p-&gt;msn
comma
id|msn
)paren
)paren
(brace
id|eaz
op_assign
id|p-&gt;eaz
suffix:semicolon
r_break
suffix:semicolon
)brace
id|p
op_assign
id|p-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ia5
)paren
r_return
(paren
l_int|1
op_lshift
(paren
id|eaz
op_minus
l_char|&squot;0&squot;
)paren
)paren
suffix:semicolon
r_else
r_return
id|eaz
suffix:semicolon
)brace
multiline_comment|/*&n; * Find an EAZ entry in the list.&n; * return a string with corresponding msn.&n; */
r_char
op_star
DECL|function|act2000_find_eaz
id|act2000_find_eaz
c_func
(paren
id|act2000_card
op_star
id|card
comma
r_char
id|eaz
)paren
(brace
r_struct
id|msn_entry
op_star
id|p
op_assign
id|card-&gt;msn_list
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;eaz
op_eq
id|eaz
)paren
r_return
id|p-&gt;msn
suffix:semicolon
id|p
op_assign
id|p-&gt;next
suffix:semicolon
)brace
r_return
l_string|&quot;&bslash;0&quot;
suffix:semicolon
)brace
multiline_comment|/*&n; * Add or delete an MSN to the MSN list&n; *&n; * First character of msneaz is EAZ, rest is MSN.&n; * If length of eazmsn is 1, delete that entry.&n; */
r_static
r_int
DECL|function|act2000_set_msn
id|act2000_set_msn
c_func
(paren
id|act2000_card
op_star
id|card
comma
r_char
op_star
id|eazmsn
)paren
(brace
r_struct
id|msn_entry
op_star
id|p
op_assign
id|card-&gt;msn_list
suffix:semicolon
r_struct
id|msn_entry
op_star
id|q
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strlen
c_func
(paren
id|eazmsn
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|eazmsn
)paren
OG
l_int|16
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|strlen
c_func
(paren
id|eazmsn
)paren
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|isdigit
c_func
(paren
id|eazmsn
(braket
id|i
)braket
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|eazmsn
)paren
op_eq
l_int|1
)paren
(brace
multiline_comment|/* Delete a single MSN */
r_while
c_loop
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;eaz
op_eq
id|eazmsn
(braket
l_int|0
)braket
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q
)paren
id|q-&gt;next
op_assign
id|p-&gt;next
suffix:semicolon
r_else
id|card-&gt;msn_list
op_assign
id|p-&gt;next
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|p
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Mapping for EAZ %c deleted&bslash;n&quot;
comma
id|eazmsn
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|q
op_assign
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Add a single MSN */
r_while
c_loop
(paren
id|p
)paren
(brace
multiline_comment|/* Found in list, replace MSN */
r_if
c_cond
(paren
id|p-&gt;eaz
op_eq
id|eazmsn
(braket
l_int|0
)braket
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|p-&gt;msn
comma
op_amp
id|eazmsn
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Mapping for EAZ %c changed to %s&bslash;n&quot;
comma
id|eazmsn
(braket
l_int|0
)braket
comma
op_amp
id|eazmsn
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|p
op_assign
id|p-&gt;next
suffix:semicolon
)brace
multiline_comment|/* Not found in list, add new entry */
id|p
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|msn_entry
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|p-&gt;eaz
op_assign
id|eazmsn
(braket
l_int|0
)braket
suffix:semicolon
id|strcpy
c_func
(paren
id|p-&gt;msn
comma
op_amp
id|eazmsn
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|p-&gt;next
op_assign
id|card-&gt;msn_list
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|card-&gt;msn_list
op_assign
id|p
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Mapping %c -&gt; %s added&bslash;n&quot;
comma
id|eazmsn
(braket
l_int|0
)braket
comma
op_amp
id|eazmsn
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|act2000_transmit
id|act2000_transmit
c_func
(paren
r_struct
id|act2000_card
op_star
id|card
)paren
(brace
r_switch
c_cond
(paren
id|card-&gt;bus
)paren
(brace
r_case
id|ACT2000_BUS_ISA
suffix:colon
id|act2000_isa_send
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACT2000_BUS_PCMCIA
suffix:colon
r_case
id|ACT2000_BUS_MCA
suffix:colon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;act2000_transmit: Illegal bustype %d&bslash;n&quot;
comma
id|card-&gt;bus
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|act2000_receive
id|act2000_receive
c_func
(paren
r_struct
id|act2000_card
op_star
id|card
)paren
(brace
r_switch
c_cond
(paren
id|card-&gt;bus
)paren
(brace
r_case
id|ACT2000_BUS_ISA
suffix:colon
id|act2000_isa_receive
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACT2000_BUS_PCMCIA
suffix:colon
r_case
id|ACT2000_BUS_MCA
suffix:colon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;act2000_receive: Illegal bustype %d&bslash;n&quot;
comma
id|card-&gt;bus
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|act2000_poll
id|act2000_poll
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|act2000_card
op_star
id|card
op_assign
(paren
id|act2000_card
op_star
)paren
id|data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|act2000_receive
c_func
(paren
id|card
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|card-&gt;ptimer
comma
id|jiffies
op_plus
l_int|3
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|act2000_command
id|act2000_command
c_func
(paren
id|act2000_card
op_star
id|card
comma
id|isdn_ctrl
op_star
id|c
)paren
(brace
id|ulong
id|a
suffix:semicolon
id|act2000_chan
op_star
id|chan
suffix:semicolon
id|act2000_cdef
id|cdef
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
r_char
id|tmp
(braket
l_int|17
)braket
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_switch
c_cond
(paren
id|c-&gt;command
)paren
(brace
r_case
id|ISDN_CMD_IOCTL
suffix:colon
id|memcpy
c_func
(paren
op_amp
id|a
comma
id|c-&gt;parm.num
comma
r_sizeof
(paren
id|ulong
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|c-&gt;arg
)paren
(brace
r_case
id|ACT2000_IOCTL_LOADBOOT
suffix:colon
r_switch
c_cond
(paren
id|card-&gt;bus
)paren
(brace
r_case
id|ACT2000_BUS_ISA
suffix:colon
id|ret
op_assign
id|act2000_isa_download
c_func
(paren
id|card
comma
(paren
id|act2000_ddef
op_star
)paren
id|a
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
id|card-&gt;flags
op_or_assign
id|ACT2000_FLAGS_LOADED
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|card-&gt;flags
op_amp
id|ACT2000_FLAGS_IVALID
)paren
)paren
(brace
id|card-&gt;ptimer.expires
op_assign
id|jiffies
op_plus
l_int|3
suffix:semicolon
id|card-&gt;ptimer.function
op_assign
id|act2000_poll
suffix:semicolon
id|card-&gt;ptimer.data
op_assign
(paren
r_int
r_int
)paren
id|card
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|card-&gt;ptimer
)paren
suffix:semicolon
)brace
id|actcapi_manufacturer_req_errh
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;act2000: Illegal BUS type %d&bslash;n&quot;
comma
id|card-&gt;bus
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
r_case
id|ACT2000_IOCTL_SETPROTO
suffix:colon
id|card-&gt;ptype
op_assign
id|a
ques
c_cond
id|ISDN_PTYPE_EURO
suffix:colon
id|ISDN_PTYPE_1TR6
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|card-&gt;flags
op_amp
id|ACT2000_FLAGS_RUNNING
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|actcapi_manufacturer_req_net
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ACT2000_IOCTL_SETMSN
suffix:colon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|copy_from_user
c_func
(paren
id|tmp
comma
(paren
r_char
op_star
)paren
id|a
comma
r_sizeof
(paren
id|tmp
)paren
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|act2000_set_msn
c_func
(paren
id|card
comma
id|tmp
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;flags
op_amp
id|ACT2000_FLAGS_RUNNING
)paren
r_return
id|actcapi_manufacturer_req_msn
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ACT2000_IOCTL_ADDCARD
suffix:colon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|cdef
comma
(paren
r_char
op_star
)paren
id|a
comma
r_sizeof
(paren
id|cdef
)paren
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|act2000_addcard
c_func
(paren
id|cdef.bus
comma
id|cdef.port
comma
id|cdef.irq
comma
id|cdef.id
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ACT2000_IOCTL_TEST
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|card-&gt;flags
op_amp
id|ACT2000_FLAGS_RUNNING
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_CMD_DIAL
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ACT2000_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|chan
op_assign
id|find_channel
c_func
(paren
id|card
comma
id|c-&gt;arg
op_amp
l_int|0x0f
)paren
)paren
)paren
r_break
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;fsm_state
op_ne
id|ACT2000_STATE_NULL
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Dial on channel with state %d&bslash;n&quot;
comma
id|chan-&gt;fsm_state
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;ptype
op_eq
id|ISDN_PTYPE_EURO
)paren
id|tmp
(braket
l_int|0
)braket
op_assign
id|act2000_find_msn
c_func
(paren
id|card
comma
id|c-&gt;parm.setup.eazmsn
comma
l_int|1
)paren
suffix:semicolon
r_else
id|tmp
(braket
l_int|0
)braket
op_assign
id|c-&gt;parm.setup.eazmsn
(braket
l_int|0
)braket
suffix:semicolon
id|chan-&gt;fsm_state
op_assign
id|ACT2000_STATE_OCALL
suffix:semicolon
id|chan-&gt;callref
op_assign
l_int|0xffff
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|ret
op_assign
id|actcapi_connect_req
c_func
(paren
id|card
comma
id|chan
comma
id|c-&gt;parm.setup.phone
comma
id|tmp
(braket
l_int|0
)braket
comma
id|c-&gt;parm.setup.si1
comma
id|c-&gt;parm.setup.si2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_DHUP
suffix:semicolon
id|cmd.arg
op_and_assign
l_int|0x0f
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
r_case
id|ISDN_CMD_ACCEPTD
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ACT2000_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|chan
op_assign
id|find_channel
c_func
(paren
id|card
comma
id|c-&gt;arg
op_amp
l_int|0x0f
)paren
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;fsm_state
op_eq
id|ACT2000_STATE_ICALL
)paren
id|actcapi_select_b2_protocol_req
c_func
(paren
id|card
comma
id|chan
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ISDN_CMD_ACCEPTB
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ACT2000_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ISDN_CMD_HANGUP
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ACT2000_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|chan
op_assign
id|find_channel
c_func
(paren
id|card
comma
id|c-&gt;arg
op_amp
l_int|0x0f
)paren
)paren
)paren
r_break
suffix:semicolon
r_switch
c_cond
(paren
id|chan-&gt;fsm_state
)paren
(brace
r_case
id|ACT2000_STATE_ICALL
suffix:colon
r_case
id|ACT2000_STATE_BSETUP
suffix:colon
id|actcapi_connect_resp
c_func
(paren
id|card
comma
id|chan
comma
l_int|0x15
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACT2000_STATE_ACTIVE
suffix:colon
id|actcapi_disconnect_b3_req
c_func
(paren
id|card
comma
id|chan
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|ISDN_CMD_SETEAZ
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ACT2000_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|chan
op_assign
id|find_channel
c_func
(paren
id|card
comma
id|c-&gt;arg
op_amp
l_int|0x0f
)paren
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|c-&gt;parm.num
)paren
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;ptype
op_eq
id|ISDN_PTYPE_EURO
)paren
(brace
id|chan-&gt;eazmask
op_assign
id|act2000_find_msn
c_func
(paren
id|card
comma
id|c-&gt;parm.num
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;ptype
op_eq
id|ISDN_PTYPE_1TR6
)paren
(brace
r_int
id|i
suffix:semicolon
id|chan-&gt;eazmask
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|strlen
c_func
(paren
id|c-&gt;parm.num
)paren
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|isdigit
c_func
(paren
id|c-&gt;parm.num
(braket
id|i
)braket
)paren
)paren
id|chan-&gt;eazmask
op_or_assign
(paren
l_int|1
op_lshift
(paren
id|c-&gt;parm.num
(braket
id|i
)braket
op_minus
l_char|&squot;0&squot;
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
id|chan-&gt;eazmask
op_assign
l_int|0x3ff
suffix:semicolon
id|actcapi_listen_req
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ISDN_CMD_CLREAZ
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ACT2000_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|chan
op_assign
id|find_channel
c_func
(paren
id|card
comma
id|c-&gt;arg
op_amp
l_int|0x0f
)paren
)paren
)paren
r_break
suffix:semicolon
id|chan-&gt;eazmask
op_assign
l_int|0
suffix:semicolon
id|actcapi_listen_req
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ISDN_CMD_SETL2
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ACT2000_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|chan
op_assign
id|find_channel
c_func
(paren
id|card
comma
id|c-&gt;arg
op_amp
l_int|0x0f
)paren
)paren
)paren
r_break
suffix:semicolon
id|chan-&gt;l2prot
op_assign
(paren
id|c-&gt;arg
op_rshift
l_int|8
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ISDN_CMD_GETL2
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ACT2000_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|chan
op_assign
id|find_channel
c_func
(paren
id|card
comma
id|c-&gt;arg
op_amp
l_int|0x0f
)paren
)paren
)paren
r_break
suffix:semicolon
r_return
id|chan-&gt;l2prot
suffix:semicolon
r_case
id|ISDN_CMD_SETL3
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ACT2000_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
(paren
id|c-&gt;arg
op_rshift
l_int|8
)paren
op_ne
id|ISDN_PROTO_L3_TRANS
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;L3 protocol unknown&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|chan
op_assign
id|find_channel
c_func
(paren
id|card
comma
id|c-&gt;arg
op_amp
l_int|0x0f
)paren
)paren
)paren
r_break
suffix:semicolon
id|chan-&gt;l3prot
op_assign
(paren
id|c-&gt;arg
op_rshift
l_int|8
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ISDN_CMD_GETL3
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ACT2000_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|chan
op_assign
id|find_channel
c_func
(paren
id|card
comma
id|c-&gt;arg
op_amp
l_int|0x0f
)paren
)paren
)paren
r_break
suffix:semicolon
r_return
id|chan-&gt;l3prot
suffix:semicolon
r_case
id|ISDN_CMD_GETEAZ
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ACT2000_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;act2000 CMD_GETEAZ not implemented&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ISDN_CMD_SETSIL
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ACT2000_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;act2000 CMD_SETSIL not implemented&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ISDN_CMD_GETSIL
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ACT2000_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;act2000 CMD_GETSIL not implemented&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ISDN_CMD_LOCK
suffix:colon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ISDN_CMD_UNLOCK
suffix:colon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_static
r_int
DECL|function|act2000_sendbuf
id|act2000_sendbuf
c_func
(paren
id|act2000_card
op_star
id|card
comma
r_int
id|channel
comma
r_int
id|ack
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|sk_buff
op_star
id|xmit_skb
suffix:semicolon
r_int
id|len
suffix:semicolon
id|act2000_chan
op_star
id|chan
suffix:semicolon
id|actcapi_msg
op_star
id|msg
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|chan
op_assign
id|find_channel
c_func
(paren
id|card
comma
id|channel
)paren
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;fsm_state
op_ne
id|ACT2000_STATE_ACTIVE
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
(paren
id|chan-&gt;queued
op_plus
id|len
)paren
op_ge
id|ACT2000_MAX_QUEUED
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|skb_headroom
c_func
(paren
id|skb
)paren
OL
l_int|19
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;act2000_sendbuf: Headroom only %d&bslash;n&quot;
comma
id|skb_headroom
c_func
(paren
id|skb
)paren
)paren
suffix:semicolon
id|xmit_skb
op_assign
id|alloc_skb
c_func
(paren
id|len
op_plus
l_int|19
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|xmit_skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;act2000_sendbuf: Out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|xmit_skb
comma
l_int|19
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|xmit_skb
comma
id|len
)paren
comma
id|skb-&gt;data
comma
id|len
)paren
suffix:semicolon
)brace
r_else
(brace
id|xmit_skb
op_assign
id|skb_clone
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|xmit_skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;act2000_sendbuf: Out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|msg
op_assign
(paren
id|actcapi_msg
op_star
)paren
id|skb_push
c_func
(paren
id|xmit_skb
comma
l_int|19
)paren
suffix:semicolon
id|msg-&gt;hdr.len
op_assign
l_int|19
op_plus
id|len
suffix:semicolon
id|msg-&gt;hdr.applicationID
op_assign
l_int|1
suffix:semicolon
id|msg-&gt;hdr.cmd.cmd
op_assign
l_int|0x86
suffix:semicolon
id|msg-&gt;hdr.cmd.subcmd
op_assign
l_int|0x00
suffix:semicolon
id|msg-&gt;hdr.msgnum
op_assign
id|actcapi_nextsmsg
c_func
(paren
id|card
)paren
suffix:semicolon
id|msg-&gt;msg.data_b3_req.datalen
op_assign
id|len
suffix:semicolon
id|msg-&gt;msg.data_b3_req.blocknr
op_assign
(paren
id|msg-&gt;hdr.msgnum
op_amp
l_int|0xff
)paren
suffix:semicolon
id|msg-&gt;msg.data_b3_req.fakencci
op_assign
id|MAKE_NCCI
c_func
(paren
id|chan-&gt;plci
comma
l_int|0
comma
id|chan-&gt;ncci
)paren
suffix:semicolon
id|msg-&gt;msg.data_b3_req.flags
op_assign
id|ack
suffix:semicolon
multiline_comment|/* Will be set to 0 on actual sending */
id|actcapi_debug_msg
c_func
(paren
id|xmit_skb
comma
l_int|1
)paren
suffix:semicolon
id|chan-&gt;queued
op_add_assign
id|len
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|card-&gt;sndq
comma
id|xmit_skb
)paren
suffix:semicolon
id|act2000_schedule_tx
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/* Read the Status-replies from the Interface */
r_static
r_int
DECL|function|act2000_readstatus
id|act2000_readstatus
c_func
(paren
id|u_char
op_star
id|buf
comma
r_int
id|len
comma
r_int
id|user
comma
id|act2000_card
op_star
id|card
)paren
(brace
r_int
id|count
suffix:semicolon
id|u_char
op_star
id|p
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|buf
comma
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
id|len
suffix:semicolon
id|p
op_increment
comma
id|count
op_increment
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;status_buf_read
op_eq
id|card-&gt;status_buf_write
)paren
r_return
id|count
suffix:semicolon
r_if
c_cond
(paren
id|user
)paren
id|put_user
c_func
(paren
op_star
id|card-&gt;status_buf_read
op_increment
comma
id|p
)paren
suffix:semicolon
r_else
op_star
id|p
op_assign
op_star
id|card-&gt;status_buf_read
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;status_buf_read
OG
id|card-&gt;status_buf_end
)paren
id|card-&gt;status_buf_read
op_assign
id|card-&gt;status_buf
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/*&n; * Find card with given driverId&n; */
r_static
r_inline
id|act2000_card
op_star
DECL|function|act2000_findcard
id|act2000_findcard
c_func
(paren
r_int
id|driverid
)paren
(brace
id|act2000_card
op_star
id|p
op_assign
id|cards
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;myid
op_eq
id|driverid
)paren
r_return
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
suffix:semicolon
)brace
r_return
(paren
id|act2000_card
op_star
)paren
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Wrapper functions for interface to linklevel&n; */
r_static
r_int
DECL|function|if_command
id|if_command
c_func
(paren
id|isdn_ctrl
op_star
id|c
)paren
(brace
id|act2000_card
op_star
id|card
op_assign
id|act2000_findcard
c_func
(paren
id|c-&gt;driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card
)paren
r_return
(paren
id|act2000_command
c_func
(paren
id|card
comma
id|c
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;act2000: if_command %d called with invalid driverId %d!&bslash;n&quot;
comma
id|c-&gt;command
comma
id|c-&gt;driver
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_static
r_int
DECL|function|if_writecmd
id|if_writecmd
c_func
(paren
r_const
id|u_char
op_star
id|buf
comma
r_int
id|len
comma
r_int
id|user
comma
r_int
id|id
comma
r_int
id|channel
)paren
(brace
id|act2000_card
op_star
id|card
op_assign
id|act2000_findcard
c_func
(paren
id|id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ACT2000_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
(paren
id|len
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;act2000: if_writecmd called with invalid driverId!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_static
r_int
DECL|function|if_readstatus
id|if_readstatus
c_func
(paren
id|u_char
op_star
id|buf
comma
r_int
id|len
comma
r_int
id|user
comma
r_int
id|id
comma
r_int
id|channel
)paren
(brace
id|act2000_card
op_star
id|card
op_assign
id|act2000_findcard
c_func
(paren
id|id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ACT2000_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
(paren
id|act2000_readstatus
c_func
(paren
id|buf
comma
id|len
comma
id|user
comma
id|card
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;act2000: if_readstatus called with invalid driverId!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_static
r_int
DECL|function|if_sendbuf
id|if_sendbuf
c_func
(paren
r_int
id|id
comma
r_int
id|channel
comma
r_int
id|ack
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|act2000_card
op_star
id|card
op_assign
id|act2000_findcard
c_func
(paren
id|id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ACT2000_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
(paren
id|act2000_sendbuf
c_func
(paren
id|card
comma
id|channel
comma
id|ack
comma
id|skb
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;act2000: if_sendbuf called with invalid driverId!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n; * Allocate a new card-struct, initialize it&n; * link it into cards-list.&n; */
r_static
r_void
DECL|function|act2000_alloccard
id|act2000_alloccard
c_func
(paren
r_int
id|bus
comma
r_int
id|port
comma
r_int
id|irq
comma
r_char
op_star
id|id
)paren
(brace
r_int
id|i
suffix:semicolon
id|act2000_card
op_star
id|card
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|card
op_assign
(paren
id|act2000_card
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|act2000_card
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;act2000: (%s) Could not allocate card-struct.&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|card
comma
l_int|0
comma
r_sizeof
(paren
id|act2000_card
)paren
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|card-&gt;sndq
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|card-&gt;rcvq
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|card-&gt;ackq
)paren
suffix:semicolon
id|card-&gt;snd_tq.routine
op_assign
(paren
r_void
op_star
)paren
(paren
r_void
op_star
)paren
id|act2000_transmit
suffix:semicolon
id|card-&gt;snd_tq.data
op_assign
id|card
suffix:semicolon
id|card-&gt;rcv_tq.routine
op_assign
(paren
r_void
op_star
)paren
(paren
r_void
op_star
)paren
id|actcapi_dispatch
suffix:semicolon
id|card-&gt;rcv_tq.data
op_assign
id|card
suffix:semicolon
id|card-&gt;poll_tq.routine
op_assign
(paren
r_void
op_star
)paren
(paren
r_void
op_star
)paren
id|act2000_receive
suffix:semicolon
id|card-&gt;poll_tq.data
op_assign
id|card
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|card-&gt;ptimer
)paren
suffix:semicolon
id|card-&gt;interface.channels
op_assign
id|ACT2000_BCH
suffix:semicolon
id|card-&gt;interface.maxbufsize
op_assign
l_int|4000
suffix:semicolon
id|card-&gt;interface.command
op_assign
id|if_command
suffix:semicolon
id|card-&gt;interface.writebuf_skb
op_assign
id|if_sendbuf
suffix:semicolon
id|card-&gt;interface.writecmd
op_assign
id|if_writecmd
suffix:semicolon
id|card-&gt;interface.readstat
op_assign
id|if_readstatus
suffix:semicolon
id|card-&gt;interface.features
op_assign
id|ISDN_FEATURE_L2_X75I
op_or
id|ISDN_FEATURE_L2_HDLC
op_or
id|ISDN_FEATURE_L3_TRANS
op_or
id|ISDN_FEATURE_P_UNKNOWN
suffix:semicolon
id|card-&gt;interface.hl_hdrlen
op_assign
l_int|20
suffix:semicolon
id|card-&gt;ptype
op_assign
id|ISDN_PTYPE_EURO
suffix:semicolon
id|strncpy
c_func
(paren
id|card-&gt;interface.id
comma
id|id
comma
r_sizeof
(paren
id|card-&gt;interface.id
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ACT2000_BCH
suffix:semicolon
id|i
op_increment
)paren
(brace
id|card-&gt;bch
(braket
id|i
)braket
dot
id|plci
op_assign
l_int|0x8000
suffix:semicolon
id|card-&gt;bch
(braket
id|i
)braket
dot
id|ncci
op_assign
l_int|0x8000
suffix:semicolon
id|card-&gt;bch
(braket
id|i
)braket
dot
id|l2prot
op_assign
id|ISDN_PROTO_L2_X75I
suffix:semicolon
id|card-&gt;bch
(braket
id|i
)braket
dot
id|l3prot
op_assign
id|ISDN_PROTO_L3_TRANS
suffix:semicolon
)brace
id|card-&gt;myid
op_assign
op_minus
l_int|1
suffix:semicolon
id|card-&gt;bus
op_assign
id|bus
suffix:semicolon
id|card-&gt;port
op_assign
id|port
suffix:semicolon
id|card-&gt;irq
op_assign
id|irq
suffix:semicolon
id|card-&gt;next
op_assign
id|cards
suffix:semicolon
id|cards
op_assign
id|card
suffix:semicolon
)brace
multiline_comment|/*&n; * register card at linklevel&n; */
r_static
r_int
DECL|function|act2000_registercard
id|act2000_registercard
c_func
(paren
id|act2000_card
op_star
id|card
)paren
(brace
r_switch
c_cond
(paren
id|card-&gt;bus
)paren
(brace
r_case
id|ACT2000_BUS_ISA
suffix:colon
r_break
suffix:semicolon
r_case
id|ACT2000_BUS_MCA
suffix:colon
r_case
id|ACT2000_BUS_PCMCIA
suffix:colon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;act2000: Illegal BUS type %d&bslash;n&quot;
comma
id|card-&gt;bus
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|register_isdn
c_func
(paren
op_amp
id|card-&gt;interface
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;act2000: Unable to register %s&bslash;n&quot;
comma
id|card-&gt;interface.id
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|card-&gt;myid
op_assign
id|card-&gt;interface.channels
suffix:semicolon
id|sprintf
c_func
(paren
id|card-&gt;regname
comma
l_string|&quot;act2000-isdn (%s)&quot;
comma
id|card-&gt;interface.id
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|unregister_card
id|unregister_card
c_func
(paren
id|act2000_card
op_star
id|card
)paren
(brace
id|isdn_ctrl
id|cmd
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_UNLOAD
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|card-&gt;bus
)paren
(brace
r_case
id|ACT2000_BUS_ISA
suffix:colon
id|act2000_isa_release
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACT2000_BUS_MCA
suffix:colon
r_case
id|ACT2000_BUS_PCMCIA
suffix:colon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;act2000: Invalid BUS type %d&bslash;n&quot;
comma
id|card-&gt;bus
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|act2000_addcard
id|act2000_addcard
c_func
(paren
r_int
id|bus
comma
r_int
id|port
comma
r_int
id|irq
comma
r_char
op_star
id|id
)paren
(brace
id|act2000_card
op_star
id|p
suffix:semicolon
id|act2000_card
op_star
id|q
op_assign
l_int|NULL
suffix:semicolon
r_int
id|initialized
suffix:semicolon
r_int
id|added
op_assign
l_int|0
suffix:semicolon
r_int
id|failed
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bus
)paren
id|bus
op_assign
id|ACT2000_BUS_ISA
suffix:semicolon
r_if
c_cond
(paren
id|port
op_ne
op_minus
l_int|1
)paren
(brace
multiline_comment|/* Port defined, do fixed setup */
id|act2000_alloccard
c_func
(paren
id|bus
comma
id|port
comma
id|irq
comma
id|id
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* No port defined, perform autoprobing.&n;&t;&t; * This may result in more than one card detected.&n;&t;&t; */
r_switch
c_cond
(paren
id|bus
)paren
(brace
r_case
id|ACT2000_BUS_ISA
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISA_NRPORTS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|act2000_isa_detect
c_func
(paren
id|act2000_isa_ports
(braket
id|i
)braket
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;act2000: Detected ISA card at port 0x%x&bslash;n&quot;
comma
id|act2000_isa_ports
(braket
id|i
)braket
)paren
suffix:semicolon
id|act2000_alloccard
c_func
(paren
id|bus
comma
id|act2000_isa_ports
(braket
id|i
)braket
comma
id|irq
comma
id|id
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ACT2000_BUS_MCA
suffix:colon
r_case
id|ACT2000_BUS_PCMCIA
suffix:colon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;act2000: addcard: Invalid BUS type %d&bslash;n&quot;
comma
id|bus
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|cards
)paren
r_return
l_int|1
suffix:semicolon
id|p
op_assign
id|cards
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
id|initialized
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;interface.statcallb
)paren
(brace
multiline_comment|/* Not yet registered.&n;&t;&t;&t; * Try to register and activate it.&n;&t;&t;&t; */
id|added
op_increment
suffix:semicolon
r_switch
c_cond
(paren
id|p-&gt;bus
)paren
(brace
r_case
id|ACT2000_BUS_ISA
suffix:colon
r_if
c_cond
(paren
id|act2000_isa_detect
c_func
(paren
id|p-&gt;port
)paren
)paren
(brace
r_if
c_cond
(paren
id|act2000_registercard
c_func
(paren
id|p
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|act2000_isa_config_port
c_func
(paren
id|p
comma
id|p-&gt;port
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;act2000: Could not request port 0x%04x&bslash;n&quot;
comma
id|p-&gt;port
)paren
suffix:semicolon
id|unregister_card
c_func
(paren
id|p
)paren
suffix:semicolon
id|p-&gt;interface.statcallb
op_assign
l_int|NULL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|act2000_isa_config_irq
c_func
(paren
id|p
comma
id|p-&gt;irq
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;act2000: No IRQ available, fallback to polling&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Fall back to polled operation */
id|p-&gt;irq
op_assign
l_int|0
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;act2000: ISA&quot;
l_string|&quot;-type card at port &quot;
l_string|&quot;0x%04x &quot;
comma
id|p-&gt;port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;irq
)paren
id|printk
c_func
(paren
l_string|&quot;irq %d&bslash;n&quot;
comma
id|p-&gt;irq
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;polled&bslash;n&quot;
)paren
suffix:semicolon
id|initialized
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ACT2000_BUS_MCA
suffix:colon
r_case
id|ACT2000_BUS_PCMCIA
suffix:colon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;act2000: addcard: Invalid BUS type %d&bslash;n&quot;
comma
id|p-&gt;bus
)paren
suffix:semicolon
)brace
)brace
r_else
multiline_comment|/* Card already initialized */
id|initialized
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|initialized
)paren
(brace
multiline_comment|/* Init OK, next card ... */
id|q
op_assign
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Init failed, remove card from list, free memory */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;act2000: Initialization of %s failed&bslash;n&quot;
comma
id|p-&gt;interface.id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q
)paren
(brace
id|q-&gt;next
op_assign
id|p-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|p
)paren
suffix:semicolon
id|p
op_assign
id|q-&gt;next
suffix:semicolon
)brace
r_else
(brace
id|cards
op_assign
id|p-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|p
)paren
suffix:semicolon
id|p
op_assign
id|cards
suffix:semicolon
)brace
id|failed
op_increment
suffix:semicolon
)brace
)brace
r_return
(paren
id|added
op_minus
id|failed
)paren
suffix:semicolon
)brace
DECL|macro|DRIVERNAME
mdefine_line|#define DRIVERNAME &quot;IBM Active 2000 ISDN driver&quot;
macro_line|#ifdef MODULE
DECL|macro|act2000_init
mdefine_line|#define act2000_init init_module
macro_line|#endif
r_int
DECL|function|act2000_init
id|act2000_init
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&bslash;n&quot;
comma
id|DRIVERNAME
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cards
)paren
id|act2000_addcard
c_func
(paren
id|act_bus
comma
id|act_port
comma
id|act_irq
comma
id|act_id
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cards
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;act2000: No cards defined yet&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* No symbols to export, hide all symbols */
id|EXPORT_NO_SYMBOLS
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
r_void
DECL|function|cleanup_module
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|act2000_card
op_star
id|card
op_assign
id|cards
suffix:semicolon
id|act2000_card
op_star
id|last
suffix:semicolon
r_while
c_loop
(paren
id|card
)paren
(brace
id|unregister_card
c_func
(paren
id|card
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|card-&gt;ptimer
)paren
suffix:semicolon
id|card
op_assign
id|card-&gt;next
suffix:semicolon
)brace
id|card
op_assign
id|cards
suffix:semicolon
r_while
c_loop
(paren
id|card
)paren
(brace
id|last
op_assign
id|card
suffix:semicolon
id|card
op_assign
id|card-&gt;next
suffix:semicolon
id|act2000_clear_msn
c_func
(paren
id|last
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|last
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s unloaded&bslash;n&quot;
comma
id|DRIVERNAME
)paren
suffix:semicolon
)brace
macro_line|#else
r_void
DECL|function|act2000_setup
id|act2000_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
r_int
id|i
comma
id|j
comma
id|argc
comma
id|port
comma
id|irq
comma
id|bus
suffix:semicolon
id|argc
op_assign
id|ints
(braket
l_int|0
)braket
suffix:semicolon
id|i
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|argc
)paren
r_while
c_loop
(paren
id|argc
)paren
(brace
id|port
op_assign
id|irq
op_assign
op_minus
l_int|1
suffix:semicolon
id|bus
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|argc
)paren
(brace
id|bus
op_assign
id|ints
(braket
id|i
)braket
suffix:semicolon
id|i
op_increment
suffix:semicolon
id|argc
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|argc
)paren
(brace
id|port
op_assign
id|ints
(braket
id|i
)braket
suffix:semicolon
id|i
op_increment
suffix:semicolon
id|argc
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|argc
)paren
(brace
id|irq
op_assign
id|ints
(braket
id|i
)braket
suffix:semicolon
id|i
op_increment
suffix:semicolon
id|argc
op_decrement
suffix:semicolon
)brace
id|act2000_addcard
c_func
(paren
id|bus
comma
id|port
comma
id|irq
comma
id|act_id
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
eof
