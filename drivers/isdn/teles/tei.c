multiline_comment|/* $Id: tei.c,v 1.1 1996/04/13 10:28:25 fritz Exp $&n; *&n; * $Log: tei.c,v $&n; * Revision 1.1  1996/04/13 10:28:25  fritz&n; * Initial revision&n; *&n; *&n; */
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &quot;teles.h&quot;
r_extern
r_struct
id|IsdnCard
id|cards
(braket
)braket
suffix:semicolon
r_extern
r_int
id|nrcards
suffix:semicolon
r_static
r_struct
id|PStack
op_star
DECL|function|findces
id|findces
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_int
id|ces
)paren
(brace
r_struct
id|PStack
op_star
id|ptr
op_assign
op_star
(paren
id|st-&gt;l1.stlistp
)paren
suffix:semicolon
r_while
c_loop
(paren
id|ptr
)paren
r_if
c_cond
(paren
id|ptr-&gt;l2.ces
op_eq
id|ces
)paren
r_return
(paren
id|ptr
)paren
suffix:semicolon
r_else
id|ptr
op_assign
id|ptr-&gt;next
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
r_static
r_struct
id|PStack
op_star
DECL|function|findtei
id|findtei
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_int
id|tei
)paren
(brace
r_struct
id|PStack
op_star
id|ptr
op_assign
op_star
(paren
id|st-&gt;l1.stlistp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tei
op_eq
l_int|127
)paren
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
r_while
c_loop
(paren
id|ptr
)paren
r_if
c_cond
(paren
id|ptr-&gt;l2.tei
op_eq
id|tei
)paren
r_return
(paren
id|ptr
)paren
suffix:semicolon
r_else
id|ptr
op_assign
id|ptr-&gt;next
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
r_void
DECL|function|tei_handler
id|tei_handler
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
id|byte
id|pr
comma
r_struct
id|BufHeader
op_star
id|ibh
)paren
(brace
id|byte
op_star
id|bp
suffix:semicolon
r_int
r_int
id|tces
suffix:semicolon
r_struct
id|PStack
op_star
id|otsp
comma
op_star
id|ptr
suffix:semicolon
r_int
r_int
id|data
suffix:semicolon
r_if
c_cond
(paren
id|st-&gt;l2.debug
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;teihandler %d&bslash;n&quot;
comma
id|pr
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|pr
)paren
(brace
r_case
(paren
id|MDL_ASSIGN
)paren
suffix:colon
id|data
op_assign
(paren
r_int
r_int
)paren
id|ibh
suffix:semicolon
id|BufPoolGet
c_func
(paren
op_amp
id|ibh
comma
id|st-&gt;l1.smallpool
comma
id|GFP_ATOMIC
comma
(paren
r_void
op_star
)paren
id|st
comma
l_int|6
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ibh
)paren
r_return
suffix:semicolon
id|bp
op_assign
id|DATAPTR
c_func
(paren
id|ibh
)paren
suffix:semicolon
id|bp
op_add_assign
id|st-&gt;l2.uihsize
suffix:semicolon
id|bp
(braket
l_int|0
)braket
op_assign
l_int|0xf
suffix:semicolon
id|bp
(braket
l_int|1
)braket
op_assign
id|data
op_rshift
l_int|8
suffix:semicolon
id|bp
(braket
l_int|2
)braket
op_assign
id|data
op_amp
l_int|0xff
suffix:semicolon
id|bp
(braket
l_int|3
)braket
op_assign
l_int|0x1
suffix:semicolon
id|bp
(braket
l_int|4
)braket
op_assign
l_int|0xff
suffix:semicolon
id|ibh-&gt;datasize
op_assign
l_int|8
suffix:semicolon
id|st-&gt;l3
dot
id|l3l2
c_func
(paren
id|st
comma
id|DL_UNIT_DATA
comma
id|ibh
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|DL_UNIT_DATA
)paren
suffix:colon
id|bp
op_assign
id|DATAPTR
c_func
(paren
id|ibh
)paren
suffix:semicolon
id|bp
op_add_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|bp
(braket
l_int|0
)braket
op_ne
l_int|0xf
)paren
r_break
suffix:semicolon
r_switch
c_cond
(paren
id|bp
(braket
l_int|3
)braket
)paren
(brace
r_case
(paren
l_int|2
)paren
suffix:colon
id|tces
op_assign
(paren
id|bp
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_or
id|bp
(braket
l_int|2
)braket
suffix:semicolon
id|BufPoolRelease
c_func
(paren
id|ibh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st-&gt;l3.debug
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;tei identity assigned for %d=%d&bslash;n&quot;
comma
id|tces
comma
id|bp
(braket
l_int|4
)braket
op_rshift
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|otsp
op_assign
id|findces
c_func
(paren
id|st
comma
id|tces
)paren
)paren
)paren
id|otsp-&gt;ma
dot
id|teil2
c_func
(paren
id|otsp
comma
id|MDL_ASSIGN
comma
(paren
r_void
op_star
)paren
(paren
id|bp
(braket
l_int|4
)braket
op_rshift
l_int|1
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
l_int|4
)paren
suffix:colon
r_if
c_cond
(paren
id|st-&gt;l3.debug
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;checking identity for %d&bslash;n&quot;
comma
id|bp
(braket
l_int|4
)braket
op_rshift
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bp
(braket
l_int|4
)braket
op_rshift
l_int|1
op_eq
l_int|0x7f
)paren
(brace
id|BufPoolRelease
c_func
(paren
id|ibh
)paren
suffix:semicolon
id|ptr
op_assign
op_star
(paren
id|st-&gt;l1.stlistp
)paren
suffix:semicolon
r_while
c_loop
(paren
id|ptr
)paren
(brace
r_if
c_cond
(paren
(paren
id|ptr-&gt;l2.tei
op_amp
l_int|0x7f
)paren
op_ne
l_int|0x7f
)paren
(brace
r_if
c_cond
(paren
id|BufPoolGet
c_func
(paren
op_amp
id|ibh
comma
id|st-&gt;l1.smallpool
comma
id|GFP_ATOMIC
comma
(paren
r_void
op_star
)paren
id|st
comma
l_int|7
)paren
)paren
r_break
suffix:semicolon
id|bp
op_assign
id|DATAPTR
c_func
(paren
id|ibh
)paren
suffix:semicolon
id|bp
op_add_assign
l_int|3
suffix:semicolon
id|bp
(braket
l_int|0
)braket
op_assign
l_int|0xf
suffix:semicolon
id|bp
(braket
l_int|1
)braket
op_assign
id|ptr-&gt;l2.ces
op_rshift
l_int|8
suffix:semicolon
id|bp
(braket
l_int|2
)braket
op_assign
id|ptr-&gt;l2.ces
op_amp
l_int|0xff
suffix:semicolon
id|bp
(braket
l_int|3
)braket
op_assign
l_int|0x5
suffix:semicolon
id|bp
(braket
l_int|4
)braket
op_assign
(paren
id|ptr-&gt;l2.tei
op_lshift
l_int|1
)paren
op_or
l_int|1
suffix:semicolon
id|ibh-&gt;datasize
op_assign
l_int|8
suffix:semicolon
id|st-&gt;l3
dot
id|l3l2
c_func
(paren
id|st
comma
id|DL_UNIT_DATA
comma
id|ibh
)paren
suffix:semicolon
)brace
id|ptr
op_assign
id|ptr-&gt;next
suffix:semicolon
)brace
)brace
r_else
(brace
id|otsp
op_assign
id|findtei
c_func
(paren
id|st
comma
id|bp
(braket
l_int|4
)braket
op_rshift
l_int|1
)paren
suffix:semicolon
id|BufPoolRelease
c_func
(paren
id|ibh
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|otsp
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|st-&gt;l3.debug
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ces is %d&bslash;n&quot;
comma
id|otsp-&gt;l2.ces
)paren
suffix:semicolon
r_if
c_cond
(paren
id|BufPoolGet
c_func
(paren
op_amp
id|ibh
comma
id|st-&gt;l1.smallpool
comma
id|GFP_ATOMIC
comma
(paren
r_void
op_star
)paren
id|st
comma
l_int|7
)paren
)paren
r_break
suffix:semicolon
id|bp
op_assign
id|DATAPTR
c_func
(paren
id|ibh
)paren
suffix:semicolon
id|bp
op_add_assign
l_int|3
suffix:semicolon
id|bp
(braket
l_int|0
)braket
op_assign
l_int|0xf
suffix:semicolon
id|bp
(braket
l_int|1
)braket
op_assign
id|otsp-&gt;l2.ces
op_rshift
l_int|8
suffix:semicolon
id|bp
(braket
l_int|2
)braket
op_assign
id|otsp-&gt;l2.ces
op_amp
l_int|0xff
suffix:semicolon
id|bp
(braket
l_int|3
)braket
op_assign
l_int|0x5
suffix:semicolon
id|bp
(braket
l_int|4
)braket
op_assign
(paren
id|otsp-&gt;l2.tei
op_lshift
l_int|1
)paren
op_or
l_int|1
suffix:semicolon
id|ibh-&gt;datasize
op_assign
l_int|8
suffix:semicolon
id|st-&gt;l3
dot
id|l3l2
c_func
(paren
id|st
comma
id|DL_UNIT_DATA
comma
id|ibh
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|BufPoolRelease
c_func
(paren
id|ibh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st-&gt;l3.debug
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;tei message unknown %d ai %d&bslash;n&quot;
comma
id|bp
(braket
l_int|3
)braket
comma
id|bp
(braket
l_int|4
)braket
op_rshift
l_int|1
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;tei handler unknown primitive %d&bslash;n&quot;
comma
id|pr
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_int
r_int
DECL|function|randomces
id|randomces
c_func
(paren
r_void
)paren
(brace
r_int
id|x
op_assign
id|jiffies
op_amp
l_int|0xffff
suffix:semicolon
r_return
(paren
id|x
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|tei_man
id|tei_man
c_func
(paren
r_struct
id|PStack
op_star
id|sp
comma
r_int
id|i
comma
r_void
op_star
id|v
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;tei_man&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|tei_l2tei
id|tei_l2tei
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|sp
op_assign
id|st-&gt;l1.hardware
suffix:semicolon
id|tei_handler
c_func
(paren
id|sp-&gt;teistack
comma
id|pr
comma
id|arg
)paren
suffix:semicolon
)brace
r_void
DECL|function|setstack_tei
id|setstack_tei
c_func
(paren
r_struct
id|PStack
op_star
id|st
)paren
(brace
id|st-&gt;l2.l2tei
op_assign
id|tei_l2tei
suffix:semicolon
)brace
r_static
r_void
DECL|function|init_tei
id|init_tei
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|sp
comma
r_int
id|protocol
)paren
(brace
r_struct
id|PStack
op_star
id|st
suffix:semicolon
r_char
id|tmp
(braket
l_int|128
)braket
suffix:semicolon
DECL|macro|DIRTY_HACK_AGAINST_SIGSEGV
mdefine_line|#define DIRTY_HACK_AGAINST_SIGSEGV
id|st
op_assign
(paren
r_struct
id|PStack
op_star
)paren
id|Smalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|PStack
)paren
comma
id|GFP_KERNEL
comma
l_string|&quot;struct PStack&quot;
)paren
suffix:semicolon
macro_line|#ifdef DIRTY_HACK_AGAINST_SIGSEGV
id|sp-&gt;teistack
op_assign
id|st
suffix:semicolon
multiline_comment|/* struct is not initialized yet */
id|sp-&gt;teistack-&gt;protocol
op_assign
id|protocol
suffix:semicolon
multiline_comment|/* struct is not initialized yet */
macro_line|#endif&t;                                        /* DIRTY_HACK_AGAINST_SIGSEGV    */
id|setstack_teles
c_func
(paren
id|st
comma
id|sp
)paren
suffix:semicolon
id|st-&gt;l2.extended
op_assign
op_logical_neg
l_int|0
suffix:semicolon
id|st-&gt;l2.laptype
op_assign
id|LAPD
suffix:semicolon
id|st-&gt;l2.window
op_assign
l_int|1
suffix:semicolon
id|st-&gt;l2.orig
op_assign
op_logical_neg
l_int|0
suffix:semicolon
id|st-&gt;protocol
op_assign
id|protocol
suffix:semicolon
multiline_comment|/*&n; * the following is not necessary for tei mng. (broadcast only)&n; */
id|st-&gt;l2.t200
op_assign
l_int|500
suffix:semicolon
multiline_comment|/* 500 milliseconds */
id|st-&gt;l2.n200
op_assign
l_int|4
suffix:semicolon
multiline_comment|/* try 4 times */
id|st-&gt;l2.sap
op_assign
l_int|63
suffix:semicolon
id|st-&gt;l2.tei
op_assign
l_int|127
suffix:semicolon
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;Card %d tei &quot;
comma
id|sp-&gt;cardnr
)paren
suffix:semicolon
id|setstack_isdnl2
c_func
(paren
id|st
comma
id|tmp
)paren
suffix:semicolon
id|st-&gt;l2.debug
op_assign
l_int|0
suffix:semicolon
id|st-&gt;l3.debug
op_assign
l_int|0
suffix:semicolon
id|st-&gt;ma
dot
id|manl2
c_func
(paren
id|st
comma
id|MDL_NOTEIPROC
comma
l_int|NULL
)paren
suffix:semicolon
id|st-&gt;l2.l2l3
op_assign
(paren
r_void
op_star
)paren
id|tei_handler
suffix:semicolon
id|st-&gt;l1.l1man
op_assign
id|tei_man
suffix:semicolon
id|st-&gt;l2.l2man
op_assign
id|tei_man
suffix:semicolon
id|st-&gt;l4.l2writewakeup
op_assign
l_int|NULL
suffix:semicolon
id|teles_addlist
c_func
(paren
id|sp
comma
id|st
)paren
suffix:semicolon
id|sp-&gt;teistack
op_assign
id|st
suffix:semicolon
)brace
r_static
r_void
DECL|function|release_tei
id|release_tei
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|sp
)paren
(brace
r_struct
id|PStack
op_star
id|st
op_assign
id|sp-&gt;teistack
suffix:semicolon
id|teles_rmlist
c_func
(paren
id|sp
comma
id|st
)paren
suffix:semicolon
id|Sfree
c_func
(paren
(paren
r_void
op_star
)paren
id|st
)paren
suffix:semicolon
)brace
r_void
DECL|function|TeiNew
id|TeiNew
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nrcards
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|cards
(braket
id|i
)braket
dot
id|sp
)paren
id|init_tei
c_func
(paren
id|cards
(braket
id|i
)braket
dot
id|sp
comma
id|cards
(braket
id|i
)braket
dot
id|protocol
)paren
suffix:semicolon
)brace
r_void
DECL|function|TeiFree
id|TeiFree
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nrcards
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|cards
(braket
id|i
)braket
dot
id|sp
)paren
id|release_tei
c_func
(paren
id|cards
(braket
id|i
)braket
dot
id|sp
)paren
suffix:semicolon
)brace
eof
