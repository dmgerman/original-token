multiline_comment|/* $Id: isdnloop.c,v 1.11 2000/11/13 22:51:50 kai Exp $&n;&n; * ISDN low-level module implementing a dummy loop driver.&n; *&n; * Copyright 1997 by Fritz Elfert (fritz@isdn4linux.de)&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &quot;isdnloop.h&quot;
r_static
r_char
DECL|variable|revision
op_star
id|revision
op_assign
l_string|&quot;$Revision: 1.11 $&quot;
suffix:semicolon
r_static
r_int
id|isdnloop_addcard
c_func
(paren
r_char
op_star
)paren
suffix:semicolon
multiline_comment|/*&n; * Free queue completely.&n; *&n; * Parameter:&n; *   card    = pointer to card struct&n; *   channel = channel number&n; */
r_static
r_void
DECL|function|isdnloop_free_queue
id|isdnloop_free_queue
c_func
(paren
id|isdnloop_card
op_star
id|card
comma
r_int
id|channel
)paren
(brace
r_struct
id|sk_buff_head
op_star
id|queue
op_assign
op_amp
id|card-&gt;bqueue
(braket
id|channel
)braket
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
id|queue
)paren
)paren
)paren
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|card-&gt;sndcount
(braket
id|channel
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Send B-Channel data to another virtual card.&n; * This routine is called via timer-callback from isdnloop_pollbchan().&n; *&n; * Parameter:&n; *   card = pointer to card struct.&n; *   ch   = channel number (0-based)&n; */
r_static
r_void
DECL|function|isdnloop_bchan_send
id|isdnloop_bchan_send
c_func
(paren
id|isdnloop_card
op_star
id|card
comma
r_int
id|ch
)paren
(brace
id|isdnloop_card
op_star
id|rcard
op_assign
id|card-&gt;rcard
(braket
id|ch
)braket
suffix:semicolon
r_int
id|rch
op_assign
id|card-&gt;rch
(braket
id|ch
)braket
comma
id|len
comma
id|ack
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
r_while
c_loop
(paren
id|card-&gt;sndcount
(braket
id|ch
)braket
)paren
(brace
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|card-&gt;bqueue
(braket
id|ch
)braket
)paren
)paren
)paren
(brace
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
id|card-&gt;sndcount
(braket
id|ch
)braket
op_sub_assign
id|len
suffix:semicolon
id|ack
op_assign
op_star
(paren
id|skb-&gt;head
)paren
suffix:semicolon
multiline_comment|/* used as scratch area */
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.arg
op_assign
id|ch
suffix:semicolon
r_if
c_cond
(paren
id|rcard
)paren
(brace
id|rcard-&gt;interface
dot
id|rcvcallb_skb
c_func
(paren
id|rcard-&gt;myid
comma
id|rch
comma
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdnloop: no rcard, skb dropped&bslash;n&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_L1ERR
suffix:semicolon
id|cmd.parm.errcode
op_assign
id|ISDN_STAT_L1ERR_SEND
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
)brace
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_BSENT
suffix:semicolon
id|cmd.parm.length
op_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|ack
)paren
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
)brace
r_else
id|card-&gt;sndcount
(braket
id|ch
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Send/Receive Data to/from the B-Channel.&n; * This routine is called via timer-callback.&n; * It schedules itself while any B-Channel is open.&n; *&n; * Parameter:&n; *   data = pointer to card struct, set by kernel timer.data&n; */
r_static
r_void
DECL|function|isdnloop_pollbchan
id|isdnloop_pollbchan
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|isdnloop_card
op_star
id|card
op_assign
(paren
id|isdnloop_card
op_star
)paren
id|data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;flags
op_amp
id|ISDNLOOP_FLAGS_B1ACTIVE
)paren
id|isdnloop_bchan_send
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;flags
op_amp
id|ISDNLOOP_FLAGS_B2ACTIVE
)paren
id|isdnloop_bchan_send
c_func
(paren
id|card
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;flags
op_amp
(paren
id|ISDNLOOP_FLAGS_B1ACTIVE
op_or
id|ISDNLOOP_FLAGS_B2ACTIVE
)paren
)paren
(brace
multiline_comment|/* schedule b-channel polling again */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|card-&gt;rb_timer.expires
op_assign
id|jiffies
op_plus
id|ISDNLOOP_TIMER_BCREAD
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|card-&gt;rb_timer
)paren
suffix:semicolon
id|card-&gt;flags
op_or_assign
id|ISDNLOOP_FLAGS_RBTIMER
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_else
id|card-&gt;flags
op_and_assign
op_complement
id|ISDNLOOP_FLAGS_RBTIMER
suffix:semicolon
)brace
multiline_comment|/*&n; * Parse ICN-type setup string and fill fields of setup-struct&n; * with parsed data.&n; *&n; * Parameter:&n; *   setup = setup string, format: [caller-id],si1,si2,[called-id]&n; *   cmd   = pointer to struct to be filled.&n; */
r_static
r_void
DECL|function|isdnloop_parse_setup
id|isdnloop_parse_setup
c_func
(paren
r_char
op_star
id|setup
comma
id|isdn_ctrl
op_star
id|cmd
)paren
(brace
r_char
op_star
id|t
op_assign
id|setup
suffix:semicolon
r_char
op_star
id|s
op_assign
id|strpbrk
c_func
(paren
id|t
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
op_star
id|s
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|strncpy
c_func
(paren
id|cmd-&gt;parm.setup.phone
comma
id|t
comma
r_sizeof
(paren
id|cmd-&gt;parm.setup.phone
)paren
)paren
suffix:semicolon
id|s
op_assign
id|strpbrk
c_func
(paren
id|t
op_assign
id|s
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
op_star
id|s
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strlen
c_func
(paren
id|t
)paren
)paren
id|cmd-&gt;parm.setup.si1
op_assign
l_int|0
suffix:semicolon
r_else
id|cmd-&gt;parm.setup.si1
op_assign
id|simple_strtoul
c_func
(paren
id|t
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
id|s
op_assign
id|strpbrk
c_func
(paren
id|t
op_assign
id|s
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
op_star
id|s
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strlen
c_func
(paren
id|t
)paren
)paren
id|cmd-&gt;parm.setup.si2
op_assign
l_int|0
suffix:semicolon
r_else
id|cmd-&gt;parm.setup.si2
op_assign
id|simple_strtoul
c_func
(paren
id|t
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|cmd-&gt;parm.setup.eazmsn
comma
id|s
comma
r_sizeof
(paren
id|cmd-&gt;parm.setup.eazmsn
)paren
)paren
suffix:semicolon
id|cmd-&gt;parm.setup.plan
op_assign
l_int|0
suffix:semicolon
id|cmd-&gt;parm.setup.screen
op_assign
l_int|0
suffix:semicolon
)brace
DECL|struct|isdnloop_stat
r_typedef
r_struct
id|isdnloop_stat
(brace
DECL|member|statstr
r_char
op_star
id|statstr
suffix:semicolon
DECL|member|command
r_int
id|command
suffix:semicolon
DECL|member|action
r_int
id|action
suffix:semicolon
DECL|typedef|isdnloop_stat
)brace
id|isdnloop_stat
suffix:semicolon
multiline_comment|/* *INDENT-OFF* */
DECL|variable|isdnloop_stat_table
r_static
id|isdnloop_stat
id|isdnloop_stat_table
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;BCON_&quot;
comma
id|ISDN_STAT_BCONN
comma
l_int|1
)brace
comma
multiline_comment|/* B-Channel connected        */
(brace
l_string|&quot;BDIS_&quot;
comma
id|ISDN_STAT_BHUP
comma
l_int|2
)brace
comma
multiline_comment|/* B-Channel disconnected     */
(brace
l_string|&quot;DCON_&quot;
comma
id|ISDN_STAT_DCONN
comma
l_int|0
)brace
comma
multiline_comment|/* D-Channel connected        */
(brace
l_string|&quot;DDIS_&quot;
comma
id|ISDN_STAT_DHUP
comma
l_int|0
)brace
comma
multiline_comment|/* D-Channel disconnected     */
(brace
l_string|&quot;DCAL_I&quot;
comma
id|ISDN_STAT_ICALL
comma
l_int|3
)brace
comma
multiline_comment|/* Incoming call dialup-line  */
(brace
l_string|&quot;DSCA_I&quot;
comma
id|ISDN_STAT_ICALL
comma
l_int|3
)brace
comma
multiline_comment|/* Incoming call 1TR6-SPV     */
(brace
l_string|&quot;FCALL&quot;
comma
id|ISDN_STAT_ICALL
comma
l_int|4
)brace
comma
multiline_comment|/* Leased line connection up  */
(brace
l_string|&quot;CIF&quot;
comma
id|ISDN_STAT_CINF
comma
l_int|5
)brace
comma
multiline_comment|/* Charge-info, 1TR6-type     */
(brace
l_string|&quot;AOC&quot;
comma
id|ISDN_STAT_CINF
comma
l_int|6
)brace
comma
multiline_comment|/* Charge-info, DSS1-type     */
(brace
l_string|&quot;CAU&quot;
comma
id|ISDN_STAT_CAUSE
comma
l_int|7
)brace
comma
multiline_comment|/* Cause code                 */
(brace
l_string|&quot;TEI OK&quot;
comma
id|ISDN_STAT_RUN
comma
l_int|0
)brace
comma
multiline_comment|/* Card connected to wallplug */
(brace
l_string|&quot;NO D-CHAN&quot;
comma
id|ISDN_STAT_NODCH
comma
l_int|0
)brace
comma
multiline_comment|/* No D-channel available     */
(brace
l_string|&quot;E_L1: ACT FAIL&quot;
comma
id|ISDN_STAT_BHUP
comma
l_int|8
)brace
comma
multiline_comment|/* Layer-1 activation failed  */
(brace
l_string|&quot;E_L2: DATA LIN&quot;
comma
id|ISDN_STAT_BHUP
comma
l_int|8
)brace
comma
multiline_comment|/* Layer-2 data link lost     */
(brace
l_string|&quot;E_L1: ACTIVATION FAILED&quot;
comma
id|ISDN_STAT_BHUP
comma
l_int|8
)brace
comma
multiline_comment|/* Layer-1 activation failed  */
(brace
l_int|NULL
comma
l_int|0
comma
op_minus
l_int|1
)brace
)brace
suffix:semicolon
multiline_comment|/* *INDENT-ON* */
multiline_comment|/*&n; * Parse Status message-strings from virtual card.&n; * Depending on status, call statcallb for sending messages to upper&n; * levels. Also set/reset B-Channel active-flags.&n; *&n; * Parameter:&n; *   status  = status string to parse.&n; *   channel = channel where message comes from.&n; *   card    = card where message comes from.&n; */
r_static
r_void
DECL|function|isdnloop_parse_status
id|isdnloop_parse_status
c_func
(paren
id|u_char
op_star
id|status
comma
r_int
id|channel
comma
id|isdnloop_card
op_star
id|card
)paren
(brace
id|isdnloop_stat
op_star
id|s
op_assign
id|isdnloop_stat_table
suffix:semicolon
r_int
id|action
op_assign
op_minus
l_int|1
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
r_while
c_loop
(paren
id|s-&gt;statstr
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|status
comma
id|s-&gt;statstr
comma
id|strlen
c_func
(paren
id|s-&gt;statstr
)paren
)paren
)paren
(brace
id|cmd.command
op_assign
id|s-&gt;command
suffix:semicolon
id|action
op_assign
id|s-&gt;action
suffix:semicolon
r_break
suffix:semicolon
)brace
id|s
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|action
op_eq
op_minus
l_int|1
)paren
r_return
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.arg
op_assign
id|channel
suffix:semicolon
r_switch
c_cond
(paren
id|action
)paren
(brace
r_case
l_int|1
suffix:colon
multiline_comment|/* BCON_x */
id|card-&gt;flags
op_or_assign
(paren
id|channel
)paren
ques
c_cond
id|ISDNLOOP_FLAGS_B2ACTIVE
suffix:colon
id|ISDNLOOP_FLAGS_B1ACTIVE
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* BDIS_x */
id|card-&gt;flags
op_and_assign
op_complement
(paren
(paren
id|channel
)paren
ques
c_cond
id|ISDNLOOP_FLAGS_B2ACTIVE
suffix:colon
id|ISDNLOOP_FLAGS_B1ACTIVE
)paren
suffix:semicolon
id|isdnloop_free_queue
c_func
(paren
id|card
comma
id|channel
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* DCAL_I and DSCA_I */
id|isdnloop_parse_setup
c_func
(paren
id|status
op_plus
l_int|6
comma
op_amp
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
multiline_comment|/* FCALL */
id|sprintf
c_func
(paren
id|cmd.parm.setup.phone
comma
l_string|&quot;LEASED%d&quot;
comma
id|card-&gt;myid
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|cmd.parm.setup.eazmsn
comma
l_string|&quot;%d&quot;
comma
id|channel
op_plus
l_int|1
)paren
suffix:semicolon
id|cmd.parm.setup.si1
op_assign
l_int|7
suffix:semicolon
id|cmd.parm.setup.si2
op_assign
l_int|0
suffix:semicolon
id|cmd.parm.setup.plan
op_assign
l_int|0
suffix:semicolon
id|cmd.parm.setup.screen
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
multiline_comment|/* CIF */
id|strncpy
c_func
(paren
id|cmd.parm.num
comma
id|status
op_plus
l_int|3
comma
r_sizeof
(paren
id|cmd.parm.num
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
multiline_comment|/* AOC */
id|sprintf
c_func
(paren
id|cmd.parm.num
comma
l_string|&quot;%d&quot;
comma
(paren
r_int
)paren
id|simple_strtoul
c_func
(paren
id|status
op_plus
l_int|7
comma
l_int|NULL
comma
l_int|16
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
multiline_comment|/* CAU */
id|status
op_add_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|status
)paren
op_eq
l_int|4
)paren
id|sprintf
c_func
(paren
id|cmd.parm.num
comma
l_string|&quot;%s%c%c&quot;
comma
id|status
op_plus
l_int|2
comma
op_star
id|status
comma
op_star
(paren
id|status
op_plus
l_int|1
)paren
)paren
suffix:semicolon
r_else
id|strncpy
c_func
(paren
id|cmd.parm.num
comma
id|status
op_plus
l_int|1
comma
r_sizeof
(paren
id|cmd.parm.num
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
multiline_comment|/* Misc Errors on L1 and L2 */
id|card-&gt;flags
op_and_assign
op_complement
id|ISDNLOOP_FLAGS_B1ACTIVE
suffix:semicolon
id|isdnloop_free_queue
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
id|cmd.arg
op_assign
l_int|0
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_DHUP
suffix:semicolon
id|cmd.arg
op_assign
l_int|0
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_BHUP
suffix:semicolon
id|card-&gt;flags
op_and_assign
op_complement
id|ISDNLOOP_FLAGS_B2ACTIVE
suffix:semicolon
id|isdnloop_free_queue
c_func
(paren
id|card
comma
l_int|1
)paren
suffix:semicolon
id|cmd.arg
op_assign
l_int|1
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_DHUP
suffix:semicolon
id|cmd.arg
op_assign
l_int|1
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
r_break
suffix:semicolon
)brace
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Store a cwcharacter into ringbuffer for reading from /dev/isdnctrl&n; *&n; * Parameter:&n; *   card = pointer to card struct.&n; *   c    = char to store.&n; */
r_static
r_void
DECL|function|isdnloop_putmsg
id|isdnloop_putmsg
c_func
(paren
id|isdnloop_card
op_star
id|card
comma
r_int
r_char
id|c
)paren
(brace
id|ulong
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
op_star
id|card-&gt;msg_buf_write
op_increment
op_assign
(paren
id|c
op_eq
l_int|0xff
)paren
ques
c_cond
l_char|&squot;&bslash;n&squot;
suffix:colon
id|c
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;msg_buf_write
op_eq
id|card-&gt;msg_buf_read
)paren
(brace
r_if
c_cond
(paren
op_increment
id|card-&gt;msg_buf_read
OG
id|card-&gt;msg_buf_end
)paren
id|card-&gt;msg_buf_read
op_assign
id|card-&gt;msg_buf
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;msg_buf_write
OG
id|card-&gt;msg_buf_end
)paren
id|card-&gt;msg_buf_write
op_assign
id|card-&gt;msg_buf
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Poll a virtual cards message queue.&n; * If there are new status-replies from the card, copy them to&n; * ringbuffer for reading on /dev/isdnctrl and call&n; * isdnloop_parse_status() for processing them. Watch for special&n; * Firmware bootmessage and parse it, to get the D-Channel protocol.&n; * If there are B-Channels open, initiate a timer-callback to&n; * isdnloop_pollbchan().&n; * This routine is called periodically via timer interrupt.&n; *&n; * Parameter:&n; *   data = pointer to card struct&n; */
r_static
r_void
DECL|function|isdnloop_polldchan
id|isdnloop_polldchan
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|isdnloop_card
op_star
id|card
op_assign
(paren
id|isdnloop_card
op_star
)paren
id|data
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|avail
suffix:semicolon
r_int
id|left
suffix:semicolon
id|u_char
id|c
suffix:semicolon
r_int
id|ch
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|u_char
op_star
id|p
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|card-&gt;dqueue
)paren
)paren
)paren
id|avail
op_assign
id|skb-&gt;len
suffix:semicolon
r_else
id|avail
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|left
op_assign
id|avail
suffix:semicolon
id|left
OG
l_int|0
suffix:semicolon
id|left
op_decrement
)paren
(brace
id|c
op_assign
op_star
id|skb-&gt;data
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|1
)paren
suffix:semicolon
id|isdnloop_putmsg
c_func
(paren
id|card
comma
id|c
)paren
suffix:semicolon
id|card-&gt;imsg
(braket
id|card-&gt;iptr
)braket
op_assign
id|c
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;iptr
OL
l_int|59
)paren
id|card-&gt;iptr
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb-&gt;len
)paren
(brace
id|avail
op_increment
suffix:semicolon
id|isdnloop_putmsg
c_func
(paren
id|card
comma
l_char|&squot;&bslash;n&squot;
)paren
suffix:semicolon
id|card-&gt;imsg
(braket
id|card-&gt;iptr
)braket
op_assign
l_int|0
suffix:semicolon
id|card-&gt;iptr
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;imsg
(braket
l_int|0
)braket
op_eq
l_char|&squot;0&squot;
op_logical_and
id|card-&gt;imsg
(braket
l_int|1
)braket
op_ge
l_char|&squot;0&squot;
op_logical_and
id|card-&gt;imsg
(braket
l_int|1
)braket
op_le
l_char|&squot;2&squot;
op_logical_and
id|card-&gt;imsg
(braket
l_int|2
)braket
op_eq
l_char|&squot;;&squot;
)paren
(brace
id|ch
op_assign
(paren
id|card-&gt;imsg
(braket
l_int|1
)braket
op_minus
l_char|&squot;0&squot;
)paren
op_minus
l_int|1
suffix:semicolon
id|p
op_assign
op_amp
id|card-&gt;imsg
(braket
l_int|3
)braket
suffix:semicolon
id|isdnloop_parse_status
c_func
(paren
id|p
comma
id|ch
comma
id|card
)paren
suffix:semicolon
)brace
r_else
(brace
id|p
op_assign
id|card-&gt;imsg
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|p
comma
l_string|&quot;DRV1.&quot;
comma
l_int|5
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdnloop: (%s) %s&bslash;n&quot;
comma
id|CID
comma
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|p
op_plus
l_int|7
comma
l_string|&quot;TC&quot;
comma
l_int|2
)paren
)paren
(brace
id|card-&gt;ptype
op_assign
id|ISDN_PTYPE_1TR6
suffix:semicolon
id|card-&gt;interface.features
op_or_assign
id|ISDN_FEATURE_P_1TR6
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdnloop: (%s) 1TR6-Protocol loaded and running&bslash;n&quot;
comma
id|CID
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|p
op_plus
l_int|7
comma
l_string|&quot;EC&quot;
comma
l_int|2
)paren
)paren
(brace
id|card-&gt;ptype
op_assign
id|ISDN_PTYPE_EURO
suffix:semicolon
id|card-&gt;interface.features
op_or_assign
id|ISDN_FEATURE_P_EURO
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdnloop: (%s) Euro-Protocol loaded and running&bslash;n&quot;
comma
id|CID
)paren
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
)brace
)brace
)brace
r_if
c_cond
(paren
id|avail
)paren
(brace
id|cmd.command
op_assign
id|ISDN_STAT_STAVAIL
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.arg
op_assign
id|avail
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;flags
op_amp
(paren
id|ISDNLOOP_FLAGS_B1ACTIVE
op_or
id|ISDNLOOP_FLAGS_B2ACTIVE
)paren
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|card-&gt;flags
op_amp
id|ISDNLOOP_FLAGS_RBTIMER
)paren
)paren
(brace
multiline_comment|/* schedule b-channel polling */
id|card-&gt;flags
op_or_assign
id|ISDNLOOP_FLAGS_RBTIMER
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|card-&gt;rb_timer
)paren
suffix:semicolon
id|card-&gt;rb_timer.function
op_assign
id|isdnloop_pollbchan
suffix:semicolon
id|card-&gt;rb_timer.data
op_assign
(paren
r_int
r_int
)paren
id|card
suffix:semicolon
id|card-&gt;rb_timer.expires
op_assign
id|jiffies
op_plus
id|ISDNLOOP_TIMER_BCREAD
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|card-&gt;rb_timer
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* schedule again */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|card-&gt;st_timer.expires
op_assign
id|jiffies
op_plus
id|ISDNLOOP_TIMER_DCREAD
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|card-&gt;st_timer
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Append a packet to the transmit buffer-queue.&n; *&n; * Parameter:&n; *   channel = Number of B-channel&n; *   skb     = packet to send.&n; *   card    = pointer to card-struct&n; * Return:&n; *   Number of bytes transferred, -E??? on error&n; */
r_static
r_int
DECL|function|isdnloop_sendbuf
id|isdnloop_sendbuf
c_func
(paren
r_int
id|channel
comma
r_struct
id|sk_buff
op_star
id|skb
comma
id|isdnloop_card
op_star
id|card
)paren
(brace
r_int
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|sk_buff
op_star
id|nskb
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|4000
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdnloop: Send packet too large&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|card-&gt;flags
op_amp
(paren
id|channel
)paren
ques
c_cond
id|ISDNLOOP_FLAGS_B2ACTIVE
suffix:colon
id|ISDNLOOP_FLAGS_B1ACTIVE
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;sndcount
(braket
id|channel
)braket
OG
id|ISDNLOOP_MAX_SQUEUE
)paren
r_return
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|nskb
op_assign
id|skb_clone
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nskb
)paren
(brace
id|skb_queue_tail
c_func
(paren
op_amp
id|card-&gt;bqueue
(braket
id|channel
)braket
comma
id|nskb
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
id|len
op_assign
l_int|0
suffix:semicolon
id|card-&gt;sndcount
(braket
id|channel
)braket
op_add_assign
id|len
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; * Read the messages from the card&squot;s ringbuffer&n; *&n; * Parameter:&n; *   buf  = pointer to buffer.&n; *   len  = number of bytes to read.&n; *   user = flag, 1: called from userlevel 0: called from kernel.&n; *   card = pointer to card struct.&n; * Return:&n; *   number of bytes actually transferred.&n; */
r_static
r_int
DECL|function|isdnloop_readstatus
id|isdnloop_readstatus
c_func
(paren
id|u_char
op_star
id|buf
comma
r_int
id|len
comma
r_int
id|user
comma
id|isdnloop_card
op_star
id|card
)paren
(brace
r_int
id|count
suffix:semicolon
id|u_char
op_star
id|p
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|buf
comma
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
id|len
suffix:semicolon
id|p
op_increment
comma
id|count
op_increment
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;msg_buf_read
op_eq
id|card-&gt;msg_buf_write
)paren
r_return
id|count
suffix:semicolon
r_if
c_cond
(paren
id|user
)paren
id|put_user
c_func
(paren
op_star
id|card-&gt;msg_buf_read
op_increment
comma
id|p
)paren
suffix:semicolon
r_else
op_star
id|p
op_assign
op_star
id|card-&gt;msg_buf_read
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;msg_buf_read
OG
id|card-&gt;msg_buf_end
)paren
id|card-&gt;msg_buf_read
op_assign
id|card-&gt;msg_buf
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/*&n; * Simulate a card&squot;s response by appending it to the cards&n; * message queue.&n; *&n; * Parameter:&n; *   card = pointer to card struct.&n; *   s    = pointer to message-string.&n; *   ch   = channel: 0 = generic messages, 1 and 2 = D-channel messages.&n; * Return:&n; *   0 on success, 1 on memory squeeze.&n; */
r_static
r_int
DECL|function|isdnloop_fake
id|isdnloop_fake
c_func
(paren
id|isdnloop_card
op_star
id|card
comma
r_char
op_star
id|s
comma
r_int
id|ch
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|len
op_assign
id|strlen
c_func
(paren
id|s
)paren
op_plus
(paren
(paren
id|ch
op_ge
l_int|0
)paren
ques
c_cond
l_int|3
suffix:colon
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdnloop: Out of memory in isdnloop_fake&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ch
op_ge
l_int|0
)paren
id|sprintf
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
l_int|3
)paren
comma
l_string|&quot;%02d;&quot;
comma
id|ch
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|strlen
c_func
(paren
id|s
)paren
)paren
comma
id|s
comma
id|strlen
c_func
(paren
id|s
)paren
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|card-&gt;dqueue
comma
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* *INDENT-OFF* */
DECL|variable|isdnloop_cmd_table
r_static
id|isdnloop_stat
id|isdnloop_cmd_table
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;BCON_R&quot;
comma
l_int|0
comma
l_int|1
)brace
comma
multiline_comment|/* B-Channel connect        */
(brace
l_string|&quot;BCON_I&quot;
comma
l_int|0
comma
l_int|17
)brace
comma
multiline_comment|/* B-Channel connect ind    */
(brace
l_string|&quot;BDIS_R&quot;
comma
l_int|0
comma
l_int|2
)brace
comma
multiline_comment|/* B-Channel disconnect     */
(brace
l_string|&quot;DDIS_R&quot;
comma
l_int|0
comma
l_int|3
)brace
comma
multiline_comment|/* D-Channel disconnect     */
(brace
l_string|&quot;DCON_R&quot;
comma
l_int|0
comma
l_int|16
)brace
comma
multiline_comment|/* D-Channel connect        */
(brace
l_string|&quot;DSCA_R&quot;
comma
l_int|0
comma
l_int|4
)brace
comma
multiline_comment|/* Dial 1TR6-SPV     */
(brace
l_string|&quot;DCAL_R&quot;
comma
l_int|0
comma
l_int|5
)brace
comma
multiline_comment|/* Dial */
(brace
l_string|&quot;EAZC&quot;
comma
l_int|0
comma
l_int|6
)brace
comma
multiline_comment|/* Clear EAZ listener */
(brace
l_string|&quot;EAZ&quot;
comma
l_int|0
comma
l_int|7
)brace
comma
multiline_comment|/* Set EAZ listener */
(brace
l_string|&quot;SEEAZ&quot;
comma
l_int|0
comma
l_int|8
)brace
comma
multiline_comment|/* Get EAZ listener */
(brace
l_string|&quot;MSN&quot;
comma
l_int|0
comma
l_int|9
)brace
comma
multiline_comment|/* Set/Clear MSN listener */
(brace
l_string|&quot;MSALL&quot;
comma
l_int|0
comma
l_int|10
)brace
comma
multiline_comment|/* Set multi MSN listeners */
(brace
l_string|&quot;SETSIL&quot;
comma
l_int|0
comma
l_int|11
)brace
comma
multiline_comment|/* Set SI list     */
(brace
l_string|&quot;SEESIL&quot;
comma
l_int|0
comma
l_int|12
)brace
comma
multiline_comment|/* Get SI list     */
(brace
l_string|&quot;SILC&quot;
comma
l_int|0
comma
l_int|13
)brace
comma
multiline_comment|/* Clear SI list     */
(brace
l_string|&quot;LOCK&quot;
comma
l_int|0
comma
op_minus
l_int|1
)brace
comma
multiline_comment|/* LOCK channel     */
(brace
l_string|&quot;UNLOCK&quot;
comma
l_int|0
comma
op_minus
l_int|1
)brace
comma
multiline_comment|/* UNLOCK channel     */
(brace
l_string|&quot;FV2ON&quot;
comma
l_int|1
comma
l_int|14
)brace
comma
multiline_comment|/* Leased mode on               */
(brace
l_string|&quot;FV2OFF&quot;
comma
l_int|1
comma
l_int|15
)brace
comma
multiline_comment|/* Leased mode off              */
(brace
l_int|NULL
comma
l_int|0
comma
op_minus
l_int|1
)brace
)brace
suffix:semicolon
multiline_comment|/* *INDENT-ON* */
multiline_comment|/*&n; * Simulate an error-response from a card.&n; *&n; * Parameter:&n; *   card = pointer to card struct.&n; */
r_static
r_void
DECL|function|isdnloop_fake_err
id|isdnloop_fake_err
c_func
(paren
id|isdnloop_card
op_star
id|card
)paren
(brace
r_char
id|buf
(braket
l_int|60
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;E%s&quot;
comma
id|card-&gt;omsg
)paren
suffix:semicolon
id|isdnloop_fake
c_func
(paren
id|card
comma
id|buf
comma
op_minus
l_int|1
)paren
suffix:semicolon
id|isdnloop_fake
c_func
(paren
id|card
comma
l_string|&quot;NAK&quot;
comma
op_minus
l_int|1
)paren
suffix:semicolon
)brace
DECL|variable|ctable_eu
r_static
id|u_char
id|ctable_eu
(braket
)braket
op_assign
(brace
l_int|0x00
comma
l_int|0x11
comma
l_int|0x01
comma
l_int|0x12
)brace
suffix:semicolon
DECL|variable|ctable_1t
r_static
id|u_char
id|ctable_1t
(braket
)braket
op_assign
(brace
l_int|0x00
comma
l_int|0x3b
comma
l_int|0x01
comma
l_int|0x3a
)brace
suffix:semicolon
multiline_comment|/*&n; * Assemble a simplified cause message depending on the&n; * D-channel protocol used.&n; *&n; * Parameter:&n; *   card = pointer to card struct.&n; *   loc  = location: 0 = local, 1 = remote.&n; *   cau  = cause: 1 = busy, 2 = nonexistent callerid, 3 = no user responding.&n; * Return:&n; *   Pointer to buffer containing the assembled message.&n; */
r_static
r_char
op_star
DECL|function|isdnloop_unicause
id|isdnloop_unicause
c_func
(paren
id|isdnloop_card
op_star
id|card
comma
r_int
id|loc
comma
r_int
id|cau
)paren
(brace
r_static
r_char
id|buf
(braket
l_int|6
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|card-&gt;ptype
)paren
(brace
r_case
id|ISDN_PTYPE_EURO
suffix:colon
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;E%02X%02X&quot;
comma
(paren
id|loc
)paren
ques
c_cond
l_int|4
suffix:colon
l_int|2
comma
id|ctable_eu
(braket
id|cau
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_PTYPE_1TR6
suffix:colon
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%02X44&quot;
comma
id|ctable_1t
(braket
id|cau
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
(paren
l_string|&quot;0000&quot;
)paren
suffix:semicolon
)brace
r_return
(paren
id|buf
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Release a virtual connection. Called from timer interrupt, when&n; * called party did not respond.&n; *&n; * Parameter:&n; *   card = pointer to card struct.&n; *   ch   = channel (0-based)&n; */
r_static
r_void
DECL|function|isdnloop_atimeout
id|isdnloop_atimeout
c_func
(paren
id|isdnloop_card
op_star
id|card
comma
r_int
id|ch
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_char
id|buf
(braket
l_int|60
)braket
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;rcard
)paren
(brace
id|isdnloop_fake
c_func
(paren
id|card-&gt;rcard
(braket
id|ch
)braket
comma
l_string|&quot;DDIS_I&quot;
comma
id|card-&gt;rch
(braket
id|ch
)braket
op_plus
l_int|1
)paren
suffix:semicolon
id|card-&gt;rcard
(braket
id|ch
)braket
op_member_access_from_pointer
id|rcard
(braket
id|card-&gt;rch
(braket
id|ch
)braket
)braket
op_assign
l_int|NULL
suffix:semicolon
id|card-&gt;rcard
(braket
id|ch
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|isdnloop_fake
c_func
(paren
id|card
comma
l_string|&quot;DDIS_I&quot;
comma
id|ch
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* No user responding */
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;CAU%s&quot;
comma
id|isdnloop_unicause
c_func
(paren
id|card
comma
l_int|1
comma
l_int|3
)paren
)paren
suffix:semicolon
id|isdnloop_fake
c_func
(paren
id|card
comma
id|buf
comma
id|ch
op_plus
l_int|1
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Wrapper for isdnloop_atimeout().&n; */
r_static
r_void
DECL|function|isdnloop_atimeout0
id|isdnloop_atimeout0
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|isdnloop_card
op_star
id|card
op_assign
(paren
id|isdnloop_card
op_star
)paren
id|data
suffix:semicolon
id|isdnloop_atimeout
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Wrapper for isdnloop_atimeout().&n; */
r_static
r_void
DECL|function|isdnloop_atimeout1
id|isdnloop_atimeout1
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|isdnloop_card
op_star
id|card
op_assign
(paren
id|isdnloop_card
op_star
)paren
id|data
suffix:semicolon
id|isdnloop_atimeout
c_func
(paren
id|card
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Install a watchdog for a user, not responding.&n; *&n; * Parameter:&n; *   card = pointer to card struct.&n; *   ch   = channel to watch for.&n; */
r_static
r_void
DECL|function|isdnloop_start_ctimer
id|isdnloop_start_ctimer
c_func
(paren
id|isdnloop_card
op_star
id|card
comma
r_int
id|ch
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|card-&gt;c_timer
(braket
id|ch
)braket
)paren
suffix:semicolon
id|card-&gt;c_timer
(braket
id|ch
)braket
dot
id|expires
op_assign
id|jiffies
op_plus
id|ISDNLOOP_TIMER_ALERTWAIT
suffix:semicolon
r_if
c_cond
(paren
id|ch
)paren
id|card-&gt;c_timer
(braket
id|ch
)braket
dot
id|function
op_assign
id|isdnloop_atimeout1
suffix:semicolon
r_else
id|card-&gt;c_timer
(braket
id|ch
)braket
dot
id|function
op_assign
id|isdnloop_atimeout0
suffix:semicolon
id|card-&gt;c_timer
(braket
id|ch
)braket
dot
id|data
op_assign
(paren
r_int
r_int
)paren
id|card
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|card-&gt;c_timer
(braket
id|ch
)braket
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Kill a pending channel watchdog.&n; *&n; * Parameter:&n; *   card = pointer to card struct.&n; *   ch   = channel (0-based).&n; */
r_static
r_void
DECL|function|isdnloop_kill_ctimer
id|isdnloop_kill_ctimer
c_func
(paren
id|isdnloop_card
op_star
id|card
comma
r_int
id|ch
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|card-&gt;c_timer
(braket
id|ch
)braket
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|variable|si2bit
r_static
id|u_char
id|si2bit
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|2
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|bit2si
r_static
id|u_char
id|bit2si
(braket
)braket
op_assign
(brace
l_int|1
comma
l_int|5
comma
l_int|7
)brace
suffix:semicolon
multiline_comment|/*&n; * Try finding a listener for an outgoing call.&n; *&n; * Parameter:&n; *   card = pointer to calling card.&n; *   p    = pointer to ICN-type setup-string.&n; *   lch  = channel of calling card.&n; *   cmd  = pointer to struct to be filled when parsing setup.&n; * Return:&n; *   0 = found match, alerting should happen.&n; *   1 = found matching number but it is busy.&n; *   2 = no matching listener.&n; *   3 = found matching number but SI does not match.&n; */
r_static
r_int
DECL|function|isdnloop_try_call
id|isdnloop_try_call
c_func
(paren
id|isdnloop_card
op_star
id|card
comma
r_char
op_star
id|p
comma
r_int
id|lch
comma
id|isdn_ctrl
op_star
id|cmd
)paren
(brace
id|isdnloop_card
op_star
id|cc
op_assign
id|cards
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ch
suffix:semicolon
r_int
id|num_match
suffix:semicolon
r_int
id|i
suffix:semicolon
r_char
op_star
id|e
suffix:semicolon
r_char
id|nbuf
(braket
l_int|32
)braket
suffix:semicolon
id|isdnloop_parse_setup
c_func
(paren
id|p
comma
id|cmd
)paren
suffix:semicolon
r_while
c_loop
(paren
id|cc
)paren
(brace
r_for
c_loop
(paren
id|ch
op_assign
l_int|0
suffix:semicolon
id|ch
OL
l_int|2
suffix:semicolon
id|ch
op_increment
)paren
(brace
multiline_comment|/* Exclude ourself */
r_if
c_cond
(paren
(paren
id|cc
op_eq
id|card
)paren
op_logical_and
(paren
id|ch
op_eq
id|lch
)paren
)paren
r_continue
suffix:semicolon
id|num_match
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|cc-&gt;ptype
)paren
(brace
r_case
id|ISDN_PTYPE_EURO
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|strcmp
c_func
(paren
id|cc-&gt;s0num
(braket
id|i
)braket
comma
id|cmd-&gt;parm.setup.phone
)paren
)paren
)paren
id|num_match
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_PTYPE_1TR6
suffix:colon
id|e
op_assign
id|cc-&gt;eazlist
(braket
id|ch
)braket
suffix:semicolon
r_while
c_loop
(paren
op_star
id|e
)paren
(brace
id|sprintf
c_func
(paren
id|nbuf
comma
l_string|&quot;%s%c&quot;
comma
id|cc-&gt;s0num
(braket
l_int|0
)braket
comma
op_star
id|e
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|strcmp
c_func
(paren
id|nbuf
comma
id|cmd-&gt;parm.setup.phone
)paren
)paren
)paren
id|num_match
op_assign
l_int|1
suffix:semicolon
id|e
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|num_match
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* channel idle? */
r_if
c_cond
(paren
op_logical_neg
(paren
id|cc-&gt;rcard
(braket
id|ch
)braket
)paren
)paren
(brace
multiline_comment|/* Check SI */
r_if
c_cond
(paren
op_logical_neg
(paren
id|si2bit
(braket
id|cmd-&gt;parm.setup.si1
)braket
op_amp
id|cc-&gt;sil
(braket
id|ch
)braket
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|3
suffix:semicolon
)brace
multiline_comment|/* ch is idle, si and number matches */
id|cc-&gt;rcard
(braket
id|ch
)braket
op_assign
id|card
suffix:semicolon
id|cc-&gt;rch
(braket
id|ch
)braket
op_assign
id|lch
suffix:semicolon
id|card-&gt;rcard
(braket
id|lch
)braket
op_assign
id|cc
suffix:semicolon
id|card-&gt;rch
(braket
id|lch
)braket
op_assign
id|ch
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* num matches, but busy */
r_if
c_cond
(paren
id|ch
op_eq
l_int|1
)paren
r_return
l_int|1
suffix:semicolon
)brace
)brace
)brace
id|cc
op_assign
id|cc-&gt;next
suffix:semicolon
)brace
r_return
l_int|2
suffix:semicolon
)brace
multiline_comment|/*&n; * Depending on D-channel protocol and caller/called, modify&n; * phone number.&n; *&n; * Parameter:&n; *   card   = pointer to card struct.&n; *   phone  = pointer phone number.&n; *   caller = flag: 1 = caller, 0 = called.&n; * Return:&n; *   pointer to new phone number.&n; */
r_static
r_char
op_star
DECL|function|isdnloop_vstphone
id|isdnloop_vstphone
c_func
(paren
id|isdnloop_card
op_star
id|card
comma
r_char
op_star
id|phone
comma
r_int
id|caller
)paren
(brace
r_int
id|i
suffix:semicolon
r_static
r_char
id|nphone
(braket
l_int|30
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|card-&gt;ptype
)paren
(brace
r_case
id|ISDN_PTYPE_EURO
suffix:colon
r_if
c_cond
(paren
id|caller
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|strcmp
c_func
(paren
id|card-&gt;s0num
(braket
id|i
)braket
comma
id|phone
)paren
)paren
)paren
r_return
(paren
id|phone
)paren
suffix:semicolon
r_return
(paren
id|card-&gt;s0num
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
r_return
(paren
id|phone
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_PTYPE_1TR6
suffix:colon
r_if
c_cond
(paren
id|caller
)paren
(brace
id|sprintf
c_func
(paren
id|nphone
comma
l_string|&quot;%s%c&quot;
comma
id|card-&gt;s0num
(braket
l_int|0
)braket
comma
id|phone
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_return
(paren
id|nphone
)paren
suffix:semicolon
)brace
r_else
r_return
(paren
op_amp
id|phone
(braket
id|strlen
c_func
(paren
id|phone
)paren
op_minus
l_int|1
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
(paren
l_string|&quot;&bslash;0&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Parse an ICN-type command string sent to the &squot;card&squot;.&n; * Perform misc. actions depending on the command.&n; *&n; * Parameter:&n; *   card = pointer to card struct.&n; */
r_static
r_void
DECL|function|isdnloop_parse_cmd
id|isdnloop_parse_cmd
c_func
(paren
id|isdnloop_card
op_star
id|card
)paren
(brace
r_char
op_star
id|p
op_assign
id|card-&gt;omsg
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
r_char
id|buf
(braket
l_int|60
)braket
suffix:semicolon
id|isdnloop_stat
op_star
id|s
op_assign
id|isdnloop_cmd_table
suffix:semicolon
r_int
id|action
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|ch
suffix:semicolon
r_if
c_cond
(paren
(paren
id|card-&gt;omsg
(braket
l_int|0
)braket
op_ne
l_char|&squot;0&squot;
)paren
op_logical_and
(paren
id|card-&gt;omsg
(braket
l_int|2
)braket
op_ne
l_char|&squot;;&squot;
)paren
)paren
(brace
id|isdnloop_fake_err
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ch
op_assign
id|card-&gt;omsg
(braket
l_int|1
)braket
op_minus
l_char|&squot;0&squot;
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ch
OL
l_int|0
)paren
op_logical_or
(paren
id|ch
OG
l_int|2
)paren
)paren
(brace
id|isdnloop_fake_err
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|p
op_add_assign
l_int|3
suffix:semicolon
r_while
c_loop
(paren
id|s-&gt;statstr
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|p
comma
id|s-&gt;statstr
comma
id|strlen
c_func
(paren
id|s-&gt;statstr
)paren
)paren
)paren
(brace
id|action
op_assign
id|s-&gt;action
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;command
op_logical_and
(paren
id|ch
op_ne
l_int|0
)paren
)paren
(brace
id|isdnloop_fake_err
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|s
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|action
op_eq
op_minus
l_int|1
)paren
r_return
suffix:semicolon
r_switch
c_cond
(paren
id|action
)paren
(brace
r_case
l_int|1
suffix:colon
multiline_comment|/* 0x;BCON_R */
r_if
c_cond
(paren
id|card-&gt;rcard
(braket
id|ch
op_minus
l_int|1
)braket
)paren
(brace
id|isdnloop_fake
c_func
(paren
id|card-&gt;rcard
(braket
id|ch
op_minus
l_int|1
)braket
comma
l_string|&quot;BCON_I&quot;
comma
id|card-&gt;rch
(braket
id|ch
op_minus
l_int|1
)braket
op_plus
l_int|1
)paren
suffix:semicolon
id|isdnloop_fake
c_func
(paren
id|card
comma
l_string|&quot;BCON_C&quot;
comma
id|ch
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|17
suffix:colon
multiline_comment|/* 0x;BCON_I */
r_if
c_cond
(paren
id|card-&gt;rcard
(braket
id|ch
op_minus
l_int|1
)braket
)paren
(brace
id|isdnloop_fake
c_func
(paren
id|card-&gt;rcard
(braket
id|ch
op_minus
l_int|1
)braket
comma
l_string|&quot;BCON_C&quot;
comma
id|card-&gt;rch
(braket
id|ch
op_minus
l_int|1
)braket
op_plus
l_int|1
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* 0x;BDIS_R */
id|isdnloop_fake
c_func
(paren
id|card
comma
l_string|&quot;BDIS_C&quot;
comma
id|ch
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;rcard
(braket
id|ch
op_minus
l_int|1
)braket
)paren
(brace
id|isdnloop_fake
c_func
(paren
id|card-&gt;rcard
(braket
id|ch
op_minus
l_int|1
)braket
comma
l_string|&quot;BDIS_I&quot;
comma
id|card-&gt;rch
(braket
id|ch
op_minus
l_int|1
)braket
op_plus
l_int|1
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
multiline_comment|/* 0x;DCON_R */
id|isdnloop_kill_ctimer
c_func
(paren
id|card
comma
id|ch
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;rcard
(braket
id|ch
op_minus
l_int|1
)braket
)paren
(brace
id|isdnloop_kill_ctimer
c_func
(paren
id|card-&gt;rcard
(braket
id|ch
op_minus
l_int|1
)braket
comma
id|card-&gt;rch
(braket
id|ch
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|isdnloop_fake
c_func
(paren
id|card-&gt;rcard
(braket
id|ch
op_minus
l_int|1
)braket
comma
l_string|&quot;DCON_C&quot;
comma
id|card-&gt;rch
(braket
id|ch
op_minus
l_int|1
)braket
op_plus
l_int|1
)paren
suffix:semicolon
id|isdnloop_fake
c_func
(paren
id|card
comma
l_string|&quot;DCON_C&quot;
comma
id|ch
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* 0x;DDIS_R */
id|isdnloop_kill_ctimer
c_func
(paren
id|card
comma
id|ch
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;rcard
(braket
id|ch
op_minus
l_int|1
)braket
)paren
(brace
id|isdnloop_kill_ctimer
c_func
(paren
id|card-&gt;rcard
(braket
id|ch
op_minus
l_int|1
)braket
comma
id|card-&gt;rch
(braket
id|ch
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|isdnloop_fake
c_func
(paren
id|card-&gt;rcard
(braket
id|ch
op_minus
l_int|1
)braket
comma
l_string|&quot;DDIS_I&quot;
comma
id|card-&gt;rch
(braket
id|ch
op_minus
l_int|1
)braket
op_plus
l_int|1
)paren
suffix:semicolon
id|card-&gt;rcard
(braket
id|ch
op_minus
l_int|1
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|isdnloop_fake
c_func
(paren
id|card
comma
l_string|&quot;DDIS_C&quot;
comma
id|ch
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
multiline_comment|/* 0x;DSCA_Rdd,yy,zz,oo */
r_if
c_cond
(paren
id|card-&gt;ptype
op_ne
id|ISDN_PTYPE_1TR6
)paren
(brace
id|isdnloop_fake_err
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Fall through */
r_case
l_int|5
suffix:colon
multiline_comment|/* 0x;DCAL_Rdd,yy,zz,oo */
id|p
op_add_assign
l_int|6
suffix:semicolon
r_switch
c_cond
(paren
id|isdnloop_try_call
c_func
(paren
id|card
comma
id|p
comma
id|ch
op_minus
l_int|1
comma
op_amp
id|cmd
)paren
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* Alerting */
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;D%s_I%s,%02d,%02d,%s&quot;
comma
(paren
id|action
op_eq
l_int|4
)paren
ques
c_cond
l_string|&quot;SCA&quot;
suffix:colon
l_string|&quot;CAL&quot;
comma
id|isdnloop_vstphone
c_func
(paren
id|card
comma
id|cmd.parm.setup.eazmsn
comma
l_int|1
)paren
comma
id|cmd.parm.setup.si1
comma
id|cmd.parm.setup.si2
comma
id|isdnloop_vstphone
c_func
(paren
id|card-&gt;rcard
(braket
id|ch
)braket
comma
id|cmd.parm.setup.phone
comma
l_int|0
)paren
)paren
suffix:semicolon
id|isdnloop_fake
c_func
(paren
id|card-&gt;rcard
(braket
id|ch
op_minus
l_int|1
)braket
comma
id|buf
comma
id|card-&gt;rch
(braket
id|ch
op_minus
l_int|1
)braket
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Fall through */
r_case
l_int|3
suffix:colon
multiline_comment|/* si1 does not match, don&squot;t alert but start timer */
id|isdnloop_start_ctimer
c_func
(paren
id|card
comma
id|ch
op_minus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* Remote busy */
id|isdnloop_fake
c_func
(paren
id|card
comma
l_string|&quot;DDIS_I&quot;
comma
id|ch
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;CAU%s&quot;
comma
id|isdnloop_unicause
c_func
(paren
id|card
comma
l_int|1
comma
l_int|1
)paren
)paren
suffix:semicolon
id|isdnloop_fake
c_func
(paren
id|card
comma
id|buf
comma
id|ch
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* No such user */
id|isdnloop_fake
c_func
(paren
id|card
comma
l_string|&quot;DDIS_I&quot;
comma
id|ch
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;CAU%s&quot;
comma
id|isdnloop_unicause
c_func
(paren
id|card
comma
l_int|1
comma
l_int|2
)paren
)paren
suffix:semicolon
id|isdnloop_fake
c_func
(paren
id|card
comma
id|buf
comma
id|ch
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
multiline_comment|/* 0x;EAZC */
id|card-&gt;eazlist
(braket
id|ch
op_minus
l_int|1
)braket
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
multiline_comment|/* 0x;EAZ */
id|p
op_add_assign
l_int|3
suffix:semicolon
id|strcpy
c_func
(paren
id|card-&gt;eazlist
(braket
id|ch
op_minus
l_int|1
)braket
comma
id|p
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
multiline_comment|/* 0x;SEEAZ */
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;EAZ-LIST: %s&quot;
comma
id|card-&gt;eazlist
(braket
id|ch
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|isdnloop_fake
c_func
(paren
id|card
comma
id|buf
comma
id|ch
op_plus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|9
suffix:colon
multiline_comment|/* 0x;MSN */
r_break
suffix:semicolon
r_case
l_int|10
suffix:colon
multiline_comment|/* 0x;MSNALL */
r_break
suffix:semicolon
r_case
l_int|11
suffix:colon
multiline_comment|/* 0x;SETSIL */
id|p
op_add_assign
l_int|6
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|strchr
c_func
(paren
l_string|&quot;0157&quot;
comma
op_star
id|p
)paren
)paren
(brace
r_if
c_cond
(paren
id|i
)paren
id|card-&gt;sil
(braket
id|ch
op_minus
l_int|1
)braket
op_or_assign
id|si2bit
(braket
op_star
id|p
op_minus
l_char|&squot;0&squot;
)braket
suffix:semicolon
id|i
op_assign
(paren
op_star
id|p
op_increment
op_eq
l_char|&squot;0&squot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|p
)paren
id|isdnloop_fake_err
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|12
suffix:colon
multiline_comment|/* 0x;SEESIL */
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;SIN-LIST: &quot;
)paren
suffix:semicolon
id|p
op_assign
id|buf
op_plus
l_int|10
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|card-&gt;sil
(braket
id|ch
op_minus
l_int|1
)braket
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;%02d&quot;
comma
id|bit2si
(braket
id|i
)braket
)paren
suffix:semicolon
id|isdnloop_fake
c_func
(paren
id|card
comma
id|buf
comma
id|ch
op_plus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|13
suffix:colon
multiline_comment|/* 0x;SILC */
id|card-&gt;sil
(braket
id|ch
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|14
suffix:colon
multiline_comment|/* 00;FV2ON */
r_break
suffix:semicolon
r_case
l_int|15
suffix:colon
multiline_comment|/* 00;FV2OFF */
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Put command-strings into the of the &squot;card&squot;. In reality, execute them&n; * right in place by calling isdnloop_parse_cmd(). Also copy every&n; * command to the read message ringbuffer, preceeding it with a &squot;&gt;&squot;.&n; * These mesagges can be read at /dev/isdnctrl.&n; *&n; * Parameter:&n; *   buf  = pointer to command buffer.&n; *   len  = length of buffer data.&n; *   user = flag: 1 = called form userlevel, 0 called from kernel.&n; *   card = pointer to card struct.&n; * Return:&n; *   number of bytes transfered (currently always equals len).&n; */
r_static
r_int
DECL|function|isdnloop_writecmd
id|isdnloop_writecmd
c_func
(paren
r_const
id|u_char
op_star
id|buf
comma
r_int
id|len
comma
r_int
id|user
comma
id|isdnloop_card
op_star
id|card
)paren
(brace
r_int
id|xcount
op_assign
l_int|0
suffix:semicolon
r_int
id|ocount
op_assign
l_int|1
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
r_while
c_loop
(paren
id|len
)paren
(brace
r_int
id|count
op_assign
id|MIN
c_func
(paren
l_int|255
comma
id|len
)paren
suffix:semicolon
id|u_char
op_star
id|p
suffix:semicolon
id|u_char
id|msg
(braket
l_int|0x100
)braket
suffix:semicolon
r_if
c_cond
(paren
id|user
)paren
id|copy_from_user
c_func
(paren
id|msg
comma
id|buf
comma
id|count
)paren
suffix:semicolon
r_else
id|memcpy
c_func
(paren
id|msg
comma
id|buf
comma
id|count
)paren
suffix:semicolon
id|isdnloop_putmsg
c_func
(paren
id|card
comma
l_char|&squot;&gt;&squot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|msg
suffix:semicolon
id|count
OG
l_int|0
suffix:semicolon
id|count
op_decrement
comma
id|p
op_increment
)paren
(brace
id|len
op_decrement
suffix:semicolon
id|xcount
op_increment
suffix:semicolon
id|isdnloop_putmsg
c_func
(paren
id|card
comma
op_star
id|p
)paren
suffix:semicolon
id|card-&gt;omsg
(braket
id|card-&gt;optr
)braket
op_assign
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
op_eq
l_char|&squot;&bslash;n&squot;
)paren
(brace
id|card-&gt;omsg
(braket
id|card-&gt;optr
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|card-&gt;optr
op_assign
l_int|0
suffix:semicolon
id|isdnloop_parse_cmd
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
)paren
(brace
id|isdnloop_putmsg
c_func
(paren
id|card
comma
l_char|&squot;&gt;&squot;
)paren
suffix:semicolon
id|ocount
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|card-&gt;optr
OL
l_int|59
)paren
id|card-&gt;optr
op_increment
suffix:semicolon
)brace
id|ocount
op_increment
suffix:semicolon
)brace
)brace
id|cmd.command
op_assign
id|ISDN_STAT_STAVAIL
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.arg
op_assign
id|ocount
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
r_return
id|xcount
suffix:semicolon
)brace
multiline_comment|/*&n; * Delete card&squot;s pending timers, send STOP to linklevel&n; */
r_static
r_void
DECL|function|isdnloop_stopcard
id|isdnloop_stopcard
c_func
(paren
id|isdnloop_card
op_star
id|card
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;flags
op_amp
id|ISDNLOOP_FLAGS_RUNNING
)paren
(brace
id|card-&gt;flags
op_and_assign
op_complement
id|ISDNLOOP_FLAGS_RUNNING
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|card-&gt;st_timer
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|card-&gt;rb_timer
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|card-&gt;c_timer
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|card-&gt;c_timer
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_STOP
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Stop all cards before unload.&n; */
r_static
r_void
DECL|function|isdnloop_stopallcards
id|isdnloop_stopallcards
c_func
(paren
r_void
)paren
(brace
id|isdnloop_card
op_star
id|p
op_assign
id|cards
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
id|isdnloop_stopcard
c_func
(paren
id|p
)paren
suffix:semicolon
id|p
op_assign
id|p-&gt;next
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Start a &squot;card&squot;. Simulate card&squot;s boot message and set the phone&n; * number(s) of the virtual &squot;S0-Interface&squot;. Install D-channel&n; * poll timer.&n; *&n; * Parameter:&n; *   card  = pointer to card struct.&n; *   sdefp = pointer to struct holding ioctl parameters.&n; * Return:&n; *   0 on success, -E??? otherwise.&n; */
r_static
r_int
DECL|function|isdnloop_start
id|isdnloop_start
c_func
(paren
id|isdnloop_card
op_star
id|card
comma
id|isdnloop_sdef
op_star
id|sdefp
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|isdnloop_sdef
id|sdef
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;flags
op_amp
id|ISDNLOOP_FLAGS_RUNNING
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|copy_from_user
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|sdef
comma
(paren
r_char
op_star
)paren
id|sdefp
comma
r_sizeof
(paren
id|sdef
)paren
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|sdef.ptype
)paren
(brace
r_case
id|ISDN_PTYPE_EURO
suffix:colon
r_if
c_cond
(paren
id|isdnloop_fake
c_func
(paren
id|card
comma
l_string|&quot;DRV1.23EC-Q.931-CAPI-CNS-BASIS-20.02.96&quot;
comma
op_minus
l_int|1
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|card-&gt;sil
(braket
l_int|0
)braket
op_assign
id|card-&gt;sil
(braket
l_int|1
)braket
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|isdnloop_fake
c_func
(paren
id|card
comma
l_string|&quot;TEI OK&quot;
comma
l_int|0
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
id|strcpy
c_func
(paren
id|card-&gt;s0num
(braket
id|i
)braket
comma
id|sdef.num
(braket
id|i
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_PTYPE_1TR6
suffix:colon
r_if
c_cond
(paren
id|isdnloop_fake
c_func
(paren
id|card
comma
l_string|&quot;DRV1.04TC-1TR6-CAPI-CNS-BASIS-29.11.95&quot;
comma
op_minus
l_int|1
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|card-&gt;sil
(braket
l_int|0
)braket
op_assign
id|card-&gt;sil
(braket
l_int|1
)braket
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|isdnloop_fake
c_func
(paren
id|card
comma
l_string|&quot;TEI OK&quot;
comma
l_int|0
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|card-&gt;s0num
(braket
l_int|0
)braket
comma
id|sdef.num
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|card-&gt;s0num
(braket
l_int|1
)braket
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|card-&gt;s0num
(braket
l_int|2
)braket
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdnloop: Illegal D-channel protocol %d&bslash;n&quot;
comma
id|sdef.ptype
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|init_timer
c_func
(paren
op_amp
id|card-&gt;st_timer
)paren
suffix:semicolon
id|card-&gt;st_timer.expires
op_assign
id|jiffies
op_plus
id|ISDNLOOP_TIMER_DCREAD
suffix:semicolon
id|card-&gt;st_timer.function
op_assign
id|isdnloop_polldchan
suffix:semicolon
id|card-&gt;st_timer.data
op_assign
(paren
r_int
r_int
)paren
id|card
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|card-&gt;st_timer
)paren
suffix:semicolon
id|card-&gt;flags
op_or_assign
id|ISDNLOOP_FLAGS_RUNNING
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Main handler for commands sent by linklevel.&n; */
r_static
r_int
DECL|function|isdnloop_command
id|isdnloop_command
c_func
(paren
id|isdn_ctrl
op_star
id|c
comma
id|isdnloop_card
op_star
id|card
)paren
(brace
id|ulong
id|a
suffix:semicolon
r_int
id|i
suffix:semicolon
r_char
id|cbuf
(braket
l_int|60
)braket
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
id|isdnloop_cdef
id|cdef
suffix:semicolon
r_switch
c_cond
(paren
id|c-&gt;command
)paren
(brace
r_case
id|ISDN_CMD_IOCTL
suffix:colon
id|memcpy
c_func
(paren
op_amp
id|a
comma
id|c-&gt;parm.num
comma
r_sizeof
(paren
id|ulong
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|c-&gt;arg
)paren
(brace
r_case
id|ISDNLOOP_IOCTL_DEBUGVAR
suffix:colon
r_return
(paren
id|ulong
)paren
id|card
suffix:semicolon
r_case
id|ISDNLOOP_IOCTL_STARTUP
suffix:colon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|a
comma
r_sizeof
(paren
id|isdnloop_sdef
)paren
)paren
)paren
)paren
r_return
id|i
suffix:semicolon
r_return
(paren
id|isdnloop_start
c_func
(paren
id|card
comma
(paren
id|isdnloop_sdef
op_star
)paren
id|a
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDNLOOP_IOCTL_ADDCARD
suffix:colon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|a
comma
r_sizeof
(paren
id|isdnloop_cdef
)paren
)paren
)paren
)paren
r_return
id|i
suffix:semicolon
id|copy_from_user
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|cdef
comma
(paren
r_char
op_star
)paren
id|a
comma
r_sizeof
(paren
id|cdef
)paren
)paren
suffix:semicolon
r_return
(paren
id|isdnloop_addcard
c_func
(paren
id|cdef.id1
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDNLOOP_IOCTL_LEASEDCFG
suffix:colon
r_if
c_cond
(paren
id|a
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;leased
)paren
(brace
id|card-&gt;leased
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|card-&gt;ptype
op_eq
id|ISDN_PTYPE_UNKNOWN
)paren
(brace
id|schedule_timeout
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
id|schedule_timeout
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;00;FV2ON&bslash;n01;EAZ1&bslash;n02;EAZ2&bslash;n&quot;
)paren
suffix:semicolon
id|i
op_assign
id|isdnloop_writecmd
c_func
(paren
id|cbuf
comma
id|strlen
c_func
(paren
id|cbuf
)paren
comma
l_int|0
comma
id|card
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdnloop: (%s) Leased-line mode enabled&bslash;n&quot;
comma
id|CID
)paren
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_RUN
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.arg
op_assign
l_int|0
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|card-&gt;leased
)paren
(brace
id|card-&gt;leased
op_assign
l_int|0
suffix:semicolon
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;00;FV2OFF&bslash;n&quot;
)paren
suffix:semicolon
id|i
op_assign
id|isdnloop_writecmd
c_func
(paren
id|cbuf
comma
id|strlen
c_func
(paren
id|cbuf
)paren
comma
l_int|0
comma
id|card
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdnloop: (%s) Leased-line mode disabled&bslash;n&quot;
comma
id|CID
)paren
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_RUN
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.arg
op_assign
l_int|0
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_CMD_DIAL
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ISDNLOOP_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;leased
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
(paren
id|c-&gt;arg
op_amp
l_int|255
)paren
OL
id|ISDNLOOP_BCH
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
r_char
id|dial
(braket
l_int|50
)braket
suffix:semicolon
r_char
id|dcode
(braket
l_int|4
)braket
suffix:semicolon
id|a
op_assign
id|c-&gt;arg
suffix:semicolon
id|p
op_assign
id|c-&gt;parm.setup.phone
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
op_eq
l_char|&squot;s&squot;
op_logical_or
op_star
id|p
op_eq
l_char|&squot;S&squot;
)paren
(brace
multiline_comment|/* Dial for SPV */
id|p
op_increment
suffix:semicolon
id|strcpy
c_func
(paren
id|dcode
comma
l_string|&quot;SCA&quot;
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* Normal Dial */
id|strcpy
c_func
(paren
id|dcode
comma
l_string|&quot;CAL&quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|dial
comma
id|p
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;D%s_R%s,%02d,%02d,%s&bslash;n&quot;
comma
(paren
r_int
)paren
(paren
id|a
op_plus
l_int|1
)paren
comma
id|dcode
comma
id|dial
comma
id|c-&gt;parm.setup.si1
comma
id|c-&gt;parm.setup.si2
comma
id|c-&gt;parm.setup.eazmsn
)paren
suffix:semicolon
id|i
op_assign
id|isdnloop_writecmd
c_func
(paren
id|cbuf
comma
id|strlen
c_func
(paren
id|cbuf
)paren
comma
l_int|0
comma
id|card
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_CMD_ACCEPTD
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ISDNLOOP_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;arg
OL
id|ISDNLOOP_BCH
)paren
(brace
id|a
op_assign
id|c-&gt;arg
op_plus
l_int|1
suffix:semicolon
id|cbuf
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|card-&gt;l2_proto
(braket
id|a
op_minus
l_int|1
)braket
)paren
(brace
r_case
id|ISDN_PROTO_L2_X75I
suffix:colon
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;BX75&bslash;n&quot;
comma
(paren
r_int
)paren
id|a
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_X25
r_case
id|ISDN_PROTO_L2_X25DTE
suffix:colon
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;BX2T&bslash;n&quot;
comma
(paren
r_int
)paren
id|a
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_PROTO_L2_X25DCE
suffix:colon
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;BX2C&bslash;n&quot;
comma
(paren
r_int
)paren
id|a
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
id|ISDN_PROTO_L2_HDLC
suffix:colon
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;BTRA&bslash;n&quot;
comma
(paren
r_int
)paren
id|a
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|cbuf
)paren
)paren
id|i
op_assign
id|isdnloop_writecmd
c_func
(paren
id|cbuf
comma
id|strlen
c_func
(paren
id|cbuf
)paren
comma
l_int|0
comma
id|card
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;DCON_R&bslash;n&quot;
comma
(paren
r_int
)paren
id|a
)paren
suffix:semicolon
id|i
op_assign
id|isdnloop_writecmd
c_func
(paren
id|cbuf
comma
id|strlen
c_func
(paren
id|cbuf
)paren
comma
l_int|0
comma
id|card
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_CMD_ACCEPTB
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ISDNLOOP_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;arg
OL
id|ISDNLOOP_BCH
)paren
(brace
id|a
op_assign
id|c-&gt;arg
op_plus
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|card-&gt;l2_proto
(braket
id|a
op_minus
l_int|1
)braket
)paren
(brace
r_case
id|ISDN_PROTO_L2_X75I
suffix:colon
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;BCON_R,BX75&bslash;n&quot;
comma
(paren
r_int
)paren
id|a
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_X25
r_case
id|ISDN_PROTO_L2_X25DTE
suffix:colon
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;BCON_R,BX2T&bslash;n&quot;
comma
(paren
r_int
)paren
id|a
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_PROTO_L2_X25DCE
suffix:colon
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;BCON_R,BX2C&bslash;n&quot;
comma
(paren
r_int
)paren
id|a
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
id|ISDN_PROTO_L2_HDLC
suffix:colon
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;BCON_R,BTRA&bslash;n&quot;
comma
(paren
r_int
)paren
id|a
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;BCON_R&bslash;n&quot;
comma
(paren
r_int
)paren
id|a
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdnloop writecmd &squot;%s&squot;&bslash;n&quot;
comma
id|cbuf
)paren
suffix:semicolon
id|i
op_assign
id|isdnloop_writecmd
c_func
(paren
id|cbuf
comma
id|strlen
c_func
(paren
id|cbuf
)paren
comma
l_int|0
comma
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_CMD_HANGUP
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ISDNLOOP_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;arg
OL
id|ISDNLOOP_BCH
)paren
(brace
id|a
op_assign
id|c-&gt;arg
op_plus
l_int|1
suffix:semicolon
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;BDIS_R&bslash;n%02d;DDIS_R&bslash;n&quot;
comma
(paren
r_int
)paren
id|a
comma
(paren
r_int
)paren
id|a
)paren
suffix:semicolon
id|i
op_assign
id|isdnloop_writecmd
c_func
(paren
id|cbuf
comma
id|strlen
c_func
(paren
id|cbuf
)paren
comma
l_int|0
comma
id|card
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_CMD_SETEAZ
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ISDNLOOP_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;leased
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;arg
OL
id|ISDNLOOP_BCH
)paren
(brace
id|a
op_assign
id|c-&gt;arg
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;ptype
op_eq
id|ISDN_PTYPE_EURO
)paren
(brace
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;MS%s%s&bslash;n&quot;
comma
(paren
r_int
)paren
id|a
comma
id|c-&gt;parm.num
(braket
l_int|0
)braket
ques
c_cond
l_string|&quot;N&quot;
suffix:colon
l_string|&quot;ALL&quot;
comma
id|c-&gt;parm.num
)paren
suffix:semicolon
)brace
r_else
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;EAZ%s&bslash;n&quot;
comma
(paren
r_int
)paren
id|a
comma
id|c-&gt;parm.num
(braket
l_int|0
)braket
ques
c_cond
id|c-&gt;parm.num
suffix:colon
(paren
id|u_char
op_star
)paren
l_string|&quot;0123456789&quot;
)paren
suffix:semicolon
id|i
op_assign
id|isdnloop_writecmd
c_func
(paren
id|cbuf
comma
id|strlen
c_func
(paren
id|cbuf
)paren
comma
l_int|0
comma
id|card
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_CMD_CLREAZ
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ISDNLOOP_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;leased
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;arg
OL
id|ISDNLOOP_BCH
)paren
(brace
id|a
op_assign
id|c-&gt;arg
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;ptype
op_eq
id|ISDN_PTYPE_EURO
)paren
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;MSNC&bslash;n&quot;
comma
(paren
r_int
)paren
id|a
)paren
suffix:semicolon
r_else
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;EAZC&bslash;n&quot;
comma
(paren
r_int
)paren
id|a
)paren
suffix:semicolon
id|i
op_assign
id|isdnloop_writecmd
c_func
(paren
id|cbuf
comma
id|strlen
c_func
(paren
id|cbuf
)paren
comma
l_int|0
comma
id|card
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_CMD_SETL2
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ISDNLOOP_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
(paren
id|c-&gt;arg
op_amp
l_int|255
)paren
OL
id|ISDNLOOP_BCH
)paren
(brace
id|a
op_assign
id|c-&gt;arg
suffix:semicolon
r_switch
c_cond
(paren
id|a
op_rshift
l_int|8
)paren
(brace
r_case
id|ISDN_PROTO_L2_X75I
suffix:colon
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;BX75&bslash;n&quot;
comma
(paren
r_int
)paren
(paren
id|a
op_amp
l_int|255
)paren
op_plus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_X25
r_case
id|ISDN_PROTO_L2_X25DTE
suffix:colon
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;BX2T&bslash;n&quot;
comma
(paren
r_int
)paren
(paren
id|a
op_amp
l_int|255
)paren
op_plus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_PROTO_L2_X25DCE
suffix:colon
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;BX2C&bslash;n&quot;
comma
(paren
r_int
)paren
(paren
id|a
op_amp
l_int|255
)paren
op_plus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
id|ISDN_PROTO_L2_HDLC
suffix:colon
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;BTRA&bslash;n&quot;
comma
(paren
r_int
)paren
(paren
id|a
op_amp
l_int|255
)paren
op_plus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|i
op_assign
id|isdnloop_writecmd
c_func
(paren
id|cbuf
comma
id|strlen
c_func
(paren
id|cbuf
)paren
comma
l_int|0
comma
id|card
)paren
suffix:semicolon
id|card-&gt;l2_proto
(braket
id|a
op_amp
l_int|255
)braket
op_assign
(paren
id|a
op_rshift
l_int|8
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_CMD_GETL2
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ISDNLOOP_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
(paren
id|c-&gt;arg
op_amp
l_int|255
)paren
OL
id|ISDNLOOP_BCH
)paren
r_return
id|card-&gt;l2_proto
(braket
id|c-&gt;arg
op_amp
l_int|255
)braket
suffix:semicolon
r_else
r_return
op_minus
id|ENODEV
suffix:semicolon
r_case
id|ISDN_CMD_SETL3
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ISDNLOOP_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ISDN_CMD_GETL3
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ISDNLOOP_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
(paren
id|c-&gt;arg
op_amp
l_int|255
)paren
OL
id|ISDNLOOP_BCH
)paren
r_return
id|ISDN_PROTO_L3_TRANS
suffix:semicolon
r_else
r_return
op_minus
id|ENODEV
suffix:semicolon
r_case
id|ISDN_CMD_GETEAZ
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ISDNLOOP_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_CMD_SETSIL
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ISDNLOOP_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_CMD_GETSIL
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ISDNLOOP_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_CMD_LOCK
suffix:colon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_CMD_UNLOCK
suffix:colon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Find card with given driverId&n; */
r_static
r_inline
id|isdnloop_card
op_star
DECL|function|isdnloop_findcard
id|isdnloop_findcard
c_func
(paren
r_int
id|driverid
)paren
(brace
id|isdnloop_card
op_star
id|p
op_assign
id|cards
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;myid
op_eq
id|driverid
)paren
r_return
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
suffix:semicolon
)brace
r_return
(paren
id|isdnloop_card
op_star
)paren
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Wrapper functions for interface to linklevel&n; */
r_static
r_int
DECL|function|if_command
id|if_command
c_func
(paren
id|isdn_ctrl
op_star
id|c
)paren
(brace
id|isdnloop_card
op_star
id|card
op_assign
id|isdnloop_findcard
c_func
(paren
id|c-&gt;driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card
)paren
r_return
(paren
id|isdnloop_command
c_func
(paren
id|c
comma
id|card
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;isdnloop: if_command called with invalid driverId!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_static
r_int
DECL|function|if_writecmd
id|if_writecmd
c_func
(paren
r_const
id|u_char
op_star
id|buf
comma
r_int
id|len
comma
r_int
id|user
comma
r_int
id|id
comma
r_int
id|channel
)paren
(brace
id|isdnloop_card
op_star
id|card
op_assign
id|isdnloop_findcard
c_func
(paren
id|id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ISDNLOOP_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
(paren
id|isdnloop_writecmd
c_func
(paren
id|buf
comma
id|len
comma
id|user
comma
id|card
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;isdnloop: if_writecmd called with invalid driverId!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_static
r_int
DECL|function|if_readstatus
id|if_readstatus
c_func
(paren
id|u_char
op_star
id|buf
comma
r_int
id|len
comma
r_int
id|user
comma
r_int
id|id
comma
r_int
id|channel
)paren
(brace
id|isdnloop_card
op_star
id|card
op_assign
id|isdnloop_findcard
c_func
(paren
id|id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ISDNLOOP_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
(paren
id|isdnloop_readstatus
c_func
(paren
id|buf
comma
id|len
comma
id|user
comma
id|card
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;isdnloop: if_readstatus called with invalid driverId!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_static
r_int
DECL|function|if_sendbuf
id|if_sendbuf
c_func
(paren
r_int
id|id
comma
r_int
id|channel
comma
r_int
id|ack
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|isdnloop_card
op_star
id|card
op_assign
id|isdnloop_findcard
c_func
(paren
id|id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ISDNLOOP_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* ack request stored in skb scratch area */
op_star
(paren
id|skb-&gt;head
)paren
op_assign
id|ack
suffix:semicolon
r_return
(paren
id|isdnloop_sendbuf
c_func
(paren
id|channel
comma
id|skb
comma
id|card
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;isdnloop: if_sendbuf called with invalid driverId!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n; * Allocate a new card-struct, initialize it&n; * link it into cards-list and register it at linklevel.&n; */
r_static
id|isdnloop_card
op_star
DECL|function|isdnloop_initcard
id|isdnloop_initcard
c_func
(paren
r_char
op_star
id|id
)paren
(brace
id|isdnloop_card
op_star
id|card
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|card
op_assign
(paren
id|isdnloop_card
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|isdnloop_card
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdnloop: (%s) Could not allocate card-struct.&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
r_return
(paren
id|isdnloop_card
op_star
)paren
l_int|0
suffix:semicolon
)brace
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|card
comma
l_int|0
comma
r_sizeof
(paren
id|isdnloop_card
)paren
)paren
suffix:semicolon
id|card-&gt;interface.channels
op_assign
id|ISDNLOOP_BCH
suffix:semicolon
id|card-&gt;interface.hl_hdrlen
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* scratch area for storing ack flag*/
id|card-&gt;interface.maxbufsize
op_assign
l_int|4000
suffix:semicolon
id|card-&gt;interface.command
op_assign
id|if_command
suffix:semicolon
id|card-&gt;interface.writebuf_skb
op_assign
id|if_sendbuf
suffix:semicolon
id|card-&gt;interface.writecmd
op_assign
id|if_writecmd
suffix:semicolon
id|card-&gt;interface.readstat
op_assign
id|if_readstatus
suffix:semicolon
id|card-&gt;interface.features
op_assign
id|ISDN_FEATURE_L2_X75I
op_or
macro_line|#ifdef CONFIG_ISDN_X25
id|ISDN_FEATURE_L2_X25DTE
op_or
id|ISDN_FEATURE_L2_X25DCE
op_or
macro_line|#endif
id|ISDN_FEATURE_L2_HDLC
op_or
id|ISDN_FEATURE_L3_TRANS
op_or
id|ISDN_FEATURE_P_UNKNOWN
suffix:semicolon
id|card-&gt;ptype
op_assign
id|ISDN_PTYPE_UNKNOWN
suffix:semicolon
id|strncpy
c_func
(paren
id|card-&gt;interface.id
comma
id|id
comma
r_sizeof
(paren
id|card-&gt;interface.id
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|card-&gt;msg_buf_write
op_assign
id|card-&gt;msg_buf
suffix:semicolon
id|card-&gt;msg_buf_read
op_assign
id|card-&gt;msg_buf
suffix:semicolon
id|card-&gt;msg_buf_end
op_assign
op_amp
id|card-&gt;msg_buf
(braket
r_sizeof
(paren
id|card-&gt;msg_buf
)paren
op_minus
l_int|1
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDNLOOP_BCH
suffix:semicolon
id|i
op_increment
)paren
(brace
id|card-&gt;l2_proto
(braket
id|i
)braket
op_assign
id|ISDN_PROTO_L2_X75I
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|card-&gt;bqueue
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|skb_queue_head_init
c_func
(paren
op_amp
id|card-&gt;dqueue
)paren
suffix:semicolon
id|card-&gt;next
op_assign
id|cards
suffix:semicolon
id|cards
op_assign
id|card
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|register_isdn
c_func
(paren
op_amp
id|card-&gt;interface
)paren
)paren
(brace
id|cards
op_assign
id|cards-&gt;next
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdnloop: Unable to register %s&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
(paren
id|isdnloop_card
op_star
)paren
l_int|0
suffix:semicolon
)brace
id|card-&gt;myid
op_assign
id|card-&gt;interface.channels
suffix:semicolon
r_return
id|card
suffix:semicolon
)brace
r_static
r_int
DECL|function|isdnloop_addcard
id|isdnloop_addcard
c_func
(paren
r_char
op_star
id|id1
)paren
(brace
id|ulong
id|flags
suffix:semicolon
id|isdnloop_card
op_star
id|card
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|card
op_assign
id|isdnloop_initcard
c_func
(paren
id|id1
)paren
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdnloop: (%s) virtual card added&bslash;n&quot;
comma
id|card-&gt;interface.id
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|macro|isdnloop_init
mdefine_line|#define isdnloop_init init_module
macro_line|#else
r_void
DECL|function|isdnloop_setup
id|isdnloop_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
r_static
r_char
id|sid
(braket
l_int|20
)braket
suffix:semicolon
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|str
)paren
)paren
(brace
id|strcpy
c_func
(paren
id|sid
comma
id|str
)paren
suffix:semicolon
id|isdnloop_id
op_assign
id|sid
suffix:semicolon
)brace
)brace
macro_line|#endif
r_int
DECL|function|isdnloop_init
id|isdnloop_init
c_func
(paren
r_void
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
r_char
id|rev
(braket
l_int|10
)braket
suffix:semicolon
multiline_comment|/* No symbols to export, hide all symbols */
id|EXPORT_NO_SYMBOLS
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
op_assign
id|strchr
c_func
(paren
id|revision
comma
l_char|&squot;:&squot;
)paren
)paren
)paren
(brace
id|strcpy
c_func
(paren
id|rev
comma
id|p
op_plus
l_int|1
)paren
suffix:semicolon
id|p
op_assign
id|strchr
c_func
(paren
id|rev
comma
l_char|&squot;$&squot;
)paren
suffix:semicolon
op_star
id|p
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|strcpy
c_func
(paren
id|rev
comma
l_string|&quot; ??? &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;isdnloop-ISDN-driver Rev%s&bslash;n&quot;
comma
id|rev
)paren
suffix:semicolon
r_return
(paren
id|isdnloop_addcard
c_func
(paren
id|isdnloop_id
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
r_void
DECL|function|cleanup_module
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|isdn_ctrl
id|cmd
suffix:semicolon
id|isdnloop_card
op_star
id|card
op_assign
id|cards
suffix:semicolon
id|isdnloop_card
op_star
id|last
suffix:semicolon
r_int
id|i
suffix:semicolon
id|isdnloop_stopallcards
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|card
)paren
(brace
id|cmd.command
op_assign
id|ISDN_STAT_UNLOAD
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDNLOOP_BCH
suffix:semicolon
id|i
op_increment
)paren
id|isdnloop_free_queue
c_func
(paren
id|card
comma
id|i
)paren
suffix:semicolon
id|card
op_assign
id|card-&gt;next
suffix:semicolon
)brace
id|card
op_assign
id|cards
suffix:semicolon
r_while
c_loop
(paren
id|card
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|last
op_assign
id|card
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|card-&gt;dqueue
)paren
)paren
)paren
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|card
op_assign
id|card-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|last
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;isdnloop-ISDN-driver unloaded&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
