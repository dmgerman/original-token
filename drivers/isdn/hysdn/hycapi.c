multiline_comment|/* $Id: hycapi.c,v 1.8 2000/11/22 17:13:13 kai Exp $&n; *&n; * Linux driver for HYSDN cards, CAPI2.0-Interface.&n; * written by Ulrich Albrecht (u.albrecht@hypercope.de) for Hypercope GmbH&n; *&n; * Copyright 2000 by Hypercope GmbH&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; */
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
DECL|macro|VER_DRIVER
mdefine_line|#define&t;VER_DRIVER&t;0
DECL|macro|VER_CARDTYPE
mdefine_line|#define&t;VER_CARDTYPE&t;1
DECL|macro|VER_HWID
mdefine_line|#define&t;VER_HWID&t;2
DECL|macro|VER_SERIAL
mdefine_line|#define&t;VER_SERIAL&t;3
DECL|macro|VER_OPTION
mdefine_line|#define&t;VER_OPTION&t;4
DECL|macro|VER_PROTO
mdefine_line|#define&t;VER_PROTO&t;5
DECL|macro|VER_PROFILE
mdefine_line|#define&t;VER_PROFILE&t;6
DECL|macro|VER_CAPI
mdefine_line|#define&t;VER_CAPI&t;7
macro_line|#include &quot;hysdn_defs.h&quot;
macro_line|#include &lt;linux/kernelcapi.h&gt;
DECL|variable|hycapi_revision
r_static
r_char
id|hycapi_revision
(braket
)braket
op_assign
l_string|&quot;$Revision: 1.8 $&quot;
suffix:semicolon
DECL|struct|_hycapi_appl
r_typedef
r_struct
id|_hycapi_appl
(brace
DECL|member|ctrl_mask
r_int
r_int
id|ctrl_mask
suffix:semicolon
DECL|member|rp
id|capi_register_params
id|rp
suffix:semicolon
DECL|member|listen_req
r_struct
id|sk_buff
op_star
id|listen_req
(braket
id|CAPI_MAXCONTR
)braket
suffix:semicolon
DECL|typedef|hycapi_appl
)brace
id|hycapi_appl
suffix:semicolon
DECL|variable|hycapi_applications
r_static
id|hycapi_appl
id|hycapi_applications
(braket
id|CAPI_MAXAPPL
)braket
suffix:semicolon
DECL|function|_hycapi_appCheck
r_static
r_inline
r_int
id|_hycapi_appCheck
c_func
(paren
r_int
id|app_id
comma
r_int
id|ctrl_no
)paren
(brace
r_if
c_cond
(paren
(paren
id|ctrl_no
op_le
l_int|0
)paren
op_logical_or
(paren
id|ctrl_no
OG
id|CAPI_MAXCONTR
)paren
op_logical_or
(paren
id|app_id
op_le
l_int|0
)paren
op_logical_or
(paren
id|app_id
OG
id|CAPI_MAXAPPL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;HYCAPI: Invalid request app_id %d for controller %d&quot;
comma
id|app_id
comma
id|ctrl_no
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
(paren
(paren
id|hycapi_applications
(braket
id|app_id
op_minus
l_int|1
)braket
dot
id|ctrl_mask
op_amp
(paren
l_int|1
op_lshift
(paren
id|ctrl_no
op_minus
l_int|1
)paren
)paren
)paren
op_ne
l_int|0
)paren
suffix:semicolon
)brace
DECL|variable|hy_di
r_struct
id|capi_driver_interface
op_star
id|hy_di
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/******************************&n;Kernel-Capi callback reset_ctr&n;******************************/
r_void
DECL|function|hycapi_reset_ctr
id|hycapi_reset_ctr
c_func
(paren
r_struct
id|capi_ctr
op_star
id|ctrl
)paren
(brace
macro_line|#ifdef HYCAPI_PRINTFNAMES
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;HYCAPI hycapi_reset_ctr&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|ctrl
op_member_access_from_pointer
id|reseted
c_func
(paren
id|ctrl
)paren
suffix:semicolon
)brace
multiline_comment|/******************************&n;Kernel-Capi callback remove_ctr&n;******************************/
r_void
DECL|function|hycapi_remove_ctr
id|hycapi_remove_ctr
c_func
(paren
r_struct
id|capi_ctr
op_star
id|ctrl
)paren
(brace
r_int
id|i
suffix:semicolon
id|hycapictrl_info
op_star
id|cinfo
op_assign
l_int|NULL
suffix:semicolon
id|hysdn_card
op_star
id|card
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef HYCAPI_PRINTFNAMES
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;HYCAPI hycapi_remove_ctr&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif 
r_if
c_cond
(paren
op_logical_neg
id|hy_di
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;No capi_driver_interface set!&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|cinfo
op_assign
(paren
id|hycapictrl_info
op_star
)paren
(paren
id|ctrl-&gt;driverdata
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cinfo
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;No hycapictrl_info set!&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|card
op_assign
id|cinfo-&gt;card
suffix:semicolon
id|ctrl
op_member_access_from_pointer
id|suspend_output
c_func
(paren
id|ctrl
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CAPI_MAXAPPL
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|hycapi_applications
(braket
id|i
)braket
dot
id|listen_req
(braket
id|ctrl-&gt;cnr
op_minus
l_int|1
)braket
)paren
(brace
id|kfree_skb
c_func
(paren
id|hycapi_applications
(braket
id|i
)braket
dot
id|listen_req
(braket
id|ctrl-&gt;cnr
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|hycapi_applications
(braket
id|i
)braket
dot
id|listen_req
(braket
id|ctrl-&gt;cnr
op_minus
l_int|1
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|hy_di
op_member_access_from_pointer
id|detach_ctr
c_func
(paren
id|ctrl
)paren
suffix:semicolon
id|ctrl-&gt;driverdata
op_assign
l_int|0
suffix:semicolon
id|kfree
c_func
(paren
id|card-&gt;hyctrlinfo
)paren
suffix:semicolon
id|card-&gt;hyctrlinfo
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/***********************************************************&n;&n;Queue a CAPI-message to the controller.&n;&n;***********************************************************/
r_static
r_void
DECL|function|hycapi_sendmsg_internal
id|hycapi_sendmsg_internal
c_func
(paren
r_struct
id|capi_ctr
op_star
id|ctrl
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|hycapictrl_info
op_star
id|cinfo
op_assign
(paren
id|hycapictrl_info
op_star
)paren
(paren
id|ctrl-&gt;driverdata
)paren
suffix:semicolon
id|hysdn_card
op_star
id|card
op_assign
id|cinfo-&gt;card
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|cinfo-&gt;lock
)paren
suffix:semicolon
macro_line|#ifdef HYCAPI_PRINTFNAMES
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;hycapi_send_message&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|cinfo-&gt;skbs
(braket
id|cinfo-&gt;in_idx
op_increment
)braket
op_assign
id|skb
suffix:semicolon
multiline_comment|/* add to buffer list */
r_if
c_cond
(paren
id|cinfo-&gt;in_idx
op_ge
id|HYSDN_MAX_CAPI_SKB
)paren
id|cinfo-&gt;in_idx
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* wrap around */
id|cinfo-&gt;sk_count
op_increment
suffix:semicolon
multiline_comment|/* adjust counter */
r_if
c_cond
(paren
id|cinfo-&gt;sk_count
op_ge
id|HYSDN_MAX_CAPI_SKB
)paren
(brace
multiline_comment|/* inform upper layers we&squot;re full */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;HYSDN Card%d: CAPI-buffer overrun!&bslash;n&quot;
comma
id|card-&gt;myid
)paren
suffix:semicolon
id|ctrl
op_member_access_from_pointer
id|suspend_output
c_func
(paren
id|ctrl
)paren
suffix:semicolon
)brace
id|cinfo-&gt;tx_skb
op_assign
id|skb
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|cinfo-&gt;lock
)paren
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|card-&gt;irq_queue
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
multiline_comment|/***********************************************************&n;hycapi_register_internal&n;&n;Send down the CAPI_REGISTER-Command to the controller.&n;This functions will also be used if the adapter has been rebooted to&n;re-register any applications in the private list.&n;&n;************************************************************/
r_static
r_void
DECL|function|hycapi_register_internal
id|hycapi_register_internal
c_func
(paren
r_struct
id|capi_ctr
op_star
id|ctrl
comma
id|__u16
id|appl
comma
id|capi_register_params
op_star
id|rp
)paren
(brace
r_char
id|ExtFeatureDefaults
(braket
)braket
op_assign
l_string|&quot;49  /0/0/0/0,*/1,*/2,*/3,*/4,*/5,*/6,*/7,*/8,*/9,*&quot;
suffix:semicolon
id|hycapictrl_info
op_star
id|cinfo
op_assign
(paren
id|hycapictrl_info
op_star
)paren
(paren
id|ctrl-&gt;driverdata
)paren
suffix:semicolon
id|hysdn_card
op_star
id|card
op_assign
id|cinfo-&gt;card
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|__u16
id|len
suffix:semicolon
id|__u8
id|_command
op_assign
l_int|0xa0
comma
id|_subcommand
op_assign
l_int|0x80
suffix:semicolon
id|__u16
id|MessageNumber
op_assign
l_int|0x0000
suffix:semicolon
id|__u16
id|MessageBufferSize
op_assign
l_int|0
suffix:semicolon
r_int
id|slen
op_assign
id|strlen
c_func
(paren
id|ExtFeatureDefaults
)paren
suffix:semicolon
macro_line|#ifdef HYCAPI_PRINTFNAMES
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;hycapi_register_appl&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|MessageBufferSize
op_assign
id|rp-&gt;level3cnt
op_star
id|rp-&gt;datablkcnt
op_star
id|rp-&gt;datablklen
suffix:semicolon
id|len
op_assign
id|CAPI_MSG_BASELEN
op_plus
l_int|8
op_plus
id|slen
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|len
comma
id|GFP_ATOMIC
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;HYSDN card%d: memory squeeze in hycapi_register_appl&bslash;n&quot;
comma
id|card-&gt;myid
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
id|__u16
)paren
)paren
comma
op_amp
id|len
comma
r_sizeof
(paren
id|__u16
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
id|__u16
)paren
)paren
comma
op_amp
id|appl
comma
r_sizeof
(paren
id|__u16
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
id|__u8
)paren
)paren
comma
op_amp
id|_command
comma
r_sizeof
(paren
id|_command
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
id|__u8
)paren
)paren
comma
op_amp
id|_subcommand
comma
r_sizeof
(paren
id|_subcommand
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
id|__u16
)paren
)paren
comma
op_amp
id|MessageNumber
comma
r_sizeof
(paren
id|__u16
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
id|__u16
)paren
)paren
comma
op_amp
id|MessageBufferSize
comma
r_sizeof
(paren
id|__u16
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
id|__u16
)paren
)paren
comma
op_amp
(paren
id|rp-&gt;level3cnt
)paren
comma
r_sizeof
(paren
id|__u16
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
id|__u16
)paren
)paren
comma
op_amp
(paren
id|rp-&gt;datablkcnt
)paren
comma
r_sizeof
(paren
id|__u16
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
id|__u16
)paren
)paren
comma
op_amp
(paren
id|rp-&gt;datablklen
)paren
comma
r_sizeof
(paren
id|__u16
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|slen
)paren
comma
id|ExtFeatureDefaults
comma
id|slen
)paren
suffix:semicolon
id|hycapi_applications
(braket
id|appl
op_minus
l_int|1
)braket
dot
id|ctrl_mask
op_or_assign
(paren
l_int|1
op_lshift
(paren
id|ctrl-&gt;cnr
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|hycapi_send_message
c_func
(paren
id|ctrl
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/************************************************************&n;hycapi_restart_internal&n;&n;After an adapter has been rebootet, re-register all applications and&n;send a LISTEN_REQ (if there has been such a thing )&n;&n;*************************************************************/
DECL|function|hycapi_restart_internal
r_static
r_void
id|hycapi_restart_internal
c_func
(paren
r_struct
id|capi_ctr
op_star
id|ctrl
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
macro_line|#ifdef HYCAPI_PRINTFNAMES
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HYSDN: hycapi_restart_internal&quot;
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CAPI_MAXAPPL
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|_hycapi_appCheck
c_func
(paren
id|i
op_plus
l_int|1
comma
id|ctrl-&gt;cnr
)paren
op_eq
l_int|1
)paren
(brace
id|hycapi_register_internal
c_func
(paren
id|ctrl
comma
id|i
op_plus
l_int|1
comma
op_amp
id|hycapi_applications
(braket
id|i
)braket
dot
id|rp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hycapi_applications
(braket
id|i
)braket
dot
id|listen_req
(braket
id|ctrl-&gt;cnr
op_minus
l_int|1
)braket
)paren
(brace
id|skb
op_assign
id|skb_copy
c_func
(paren
id|hycapi_applications
(braket
id|i
)braket
dot
id|listen_req
(braket
id|ctrl-&gt;cnr
op_minus
l_int|1
)braket
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|hycapi_sendmsg_internal
c_func
(paren
id|ctrl
comma
id|skb
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/*************************************************************&n;Register an application.&n;Error-checking is done for CAPI-compliance.&n;&n;The application is recorded in the internal list.&n;*************************************************************/
r_void
DECL|function|hycapi_register_appl
id|hycapi_register_appl
c_func
(paren
r_struct
id|capi_ctr
op_star
id|ctrl
comma
id|__u16
id|appl
comma
id|capi_register_params
op_star
id|rp
)paren
(brace
r_int
id|MaxLogicalConnections
op_assign
l_int|0
comma
id|MaxBDataBlocks
op_assign
l_int|0
comma
id|MaxBDataLen
op_assign
l_int|0
suffix:semicolon
id|hycapictrl_info
op_star
id|cinfo
op_assign
(paren
id|hycapictrl_info
op_star
)paren
(paren
id|ctrl-&gt;driverdata
)paren
suffix:semicolon
id|hysdn_card
op_star
id|card
op_assign
id|cinfo-&gt;card
suffix:semicolon
r_int
id|chk
op_assign
id|_hycapi_appCheck
c_func
(paren
id|appl
comma
id|ctrl-&gt;cnr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chk
OL
l_int|0
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chk
op_eq
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HYSDN: apl %d allready registered&bslash;n&quot;
comma
id|appl
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|MaxBDataBlocks
op_assign
id|rp-&gt;datablkcnt
OG
id|CAPI_MAXDATAWINDOW
ques
c_cond
id|CAPI_MAXDATAWINDOW
suffix:colon
id|rp-&gt;datablkcnt
suffix:semicolon
id|rp-&gt;datablkcnt
op_assign
id|MaxBDataBlocks
suffix:semicolon
id|MaxBDataLen
op_assign
id|rp-&gt;datablklen
OL
l_int|1024
ques
c_cond
l_int|1024
suffix:colon
id|rp-&gt;datablklen
suffix:semicolon
id|rp-&gt;datablklen
op_assign
id|MaxBDataLen
suffix:semicolon
id|MaxLogicalConnections
op_assign
id|rp-&gt;level3cnt
suffix:semicolon
r_if
c_cond
(paren
id|MaxLogicalConnections
OL
l_int|0
)paren
(brace
id|MaxLogicalConnections
op_assign
id|card-&gt;bchans
op_star
op_minus
id|MaxLogicalConnections
suffix:semicolon
)brace
r_if
c_cond
(paren
id|MaxLogicalConnections
op_eq
l_int|0
)paren
(brace
id|MaxLogicalConnections
op_assign
id|card-&gt;bchans
suffix:semicolon
)brace
id|rp-&gt;level3cnt
op_assign
id|MaxLogicalConnections
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|hycapi_applications
(braket
id|appl
op_minus
l_int|1
)braket
dot
id|rp
comma
id|rp
comma
r_sizeof
(paren
id|capi_register_params
)paren
)paren
suffix:semicolon
multiline_comment|/*        MOD_INC_USE_COUNT; */
id|ctrl
op_member_access_from_pointer
id|appl_registered
c_func
(paren
id|ctrl
comma
id|appl
)paren
suffix:semicolon
)brace
multiline_comment|/*********************************************************************&n;&n;hycapi_release_internal&n;&n;Send down a CAPI_RELEASE to the controller.&n;*********************************************************************/
DECL|function|hycapi_release_internal
r_static
r_void
id|hycapi_release_internal
c_func
(paren
r_struct
id|capi_ctr
op_star
id|ctrl
comma
id|__u16
id|appl
)paren
(brace
id|hycapictrl_info
op_star
id|cinfo
op_assign
(paren
id|hycapictrl_info
op_star
)paren
(paren
id|ctrl-&gt;driverdata
)paren
suffix:semicolon
id|hysdn_card
op_star
id|card
op_assign
id|cinfo-&gt;card
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|__u16
id|len
suffix:semicolon
id|__u8
id|_command
op_assign
l_int|0xa1
comma
id|_subcommand
op_assign
l_int|0x80
suffix:semicolon
id|__u16
id|MessageNumber
op_assign
l_int|0x0000
suffix:semicolon
macro_line|#ifdef HYCAPI_PRINTFNAMES
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;hycapi_release_appl&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|len
op_assign
id|CAPI_MSG_BASELEN
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|len
comma
id|GFP_ATOMIC
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;HYSDN card%d: memory squeeze in hycapi_register_appl&bslash;n&quot;
comma
id|card-&gt;myid
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
id|__u16
)paren
)paren
comma
op_amp
id|len
comma
r_sizeof
(paren
id|__u16
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
id|__u16
)paren
)paren
comma
op_amp
id|appl
comma
r_sizeof
(paren
id|__u16
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
id|__u8
)paren
)paren
comma
op_amp
id|_command
comma
r_sizeof
(paren
id|_command
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
id|__u8
)paren
)paren
comma
op_amp
id|_subcommand
comma
r_sizeof
(paren
id|_subcommand
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
id|__u16
)paren
)paren
comma
op_amp
id|MessageNumber
comma
r_sizeof
(paren
id|__u16
)paren
)paren
suffix:semicolon
id|hycapi_send_message
c_func
(paren
id|ctrl
comma
id|skb
)paren
suffix:semicolon
id|hycapi_applications
(braket
id|appl
op_minus
l_int|1
)braket
dot
id|ctrl_mask
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|ctrl-&gt;cnr
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************&n;hycapi_release_appl&n;&n;Release the application from the internal list an remove it&squot;s &n;registration at controller-level&n;******************************************************************/
r_void
DECL|function|hycapi_release_appl
id|hycapi_release_appl
c_func
(paren
r_struct
id|capi_ctr
op_star
id|ctrl
comma
id|__u16
id|appl
)paren
(brace
r_int
id|chk
suffix:semicolon
id|chk
op_assign
id|_hycapi_appCheck
c_func
(paren
id|appl
comma
id|ctrl-&gt;cnr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chk
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;HYCAPI: Releasing invalid appl %d on controller %d&bslash;n&quot;
comma
id|appl
comma
id|ctrl-&gt;cnr
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hycapi_applications
(braket
id|appl
op_minus
l_int|1
)braket
dot
id|listen_req
(braket
id|ctrl-&gt;cnr
op_minus
l_int|1
)braket
)paren
(brace
id|kfree_skb
c_func
(paren
id|hycapi_applications
(braket
id|appl
op_minus
l_int|1
)braket
dot
id|listen_req
(braket
id|ctrl-&gt;cnr
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|hycapi_applications
(braket
id|appl
op_minus
l_int|1
)braket
dot
id|listen_req
(braket
id|ctrl-&gt;cnr
op_minus
l_int|1
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chk
op_eq
l_int|1
)paren
(brace
id|hycapi_release_internal
c_func
(paren
id|ctrl
comma
id|appl
)paren
suffix:semicolon
)brace
id|ctrl
op_member_access_from_pointer
id|appl_released
c_func
(paren
id|ctrl
comma
id|appl
)paren
suffix:semicolon
multiline_comment|/*        MOD_DEC_USE_COUNT;  */
)brace
multiline_comment|/**************************************************************&n;Kill a single controller.&n;**************************************************************/
DECL|function|hycapi_capi_release
r_int
id|hycapi_capi_release
c_func
(paren
id|hysdn_card
op_star
id|card
)paren
(brace
id|hycapictrl_info
op_star
id|cinfo
op_assign
id|card-&gt;hyctrlinfo
suffix:semicolon
r_struct
id|capi_ctr
op_star
id|ctrl
suffix:semicolon
macro_line|#ifdef HYCAPI_PRINTFNAMES
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;hycapi_capi_release&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|cinfo
)paren
(brace
id|ctrl
op_assign
id|cinfo-&gt;capi_ctrl
suffix:semicolon
id|hycapi_remove_ctr
c_func
(paren
id|ctrl
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**************************************************************&n;hycapi_capi_stop&n;&n;Stop CAPI-Output on a card. (e.g. during reboot)&n;***************************************************************/
DECL|function|hycapi_capi_stop
r_int
id|hycapi_capi_stop
c_func
(paren
id|hysdn_card
op_star
id|card
)paren
(brace
id|hycapictrl_info
op_star
id|cinfo
op_assign
id|card-&gt;hyctrlinfo
suffix:semicolon
r_struct
id|capi_ctr
op_star
id|ctrl
suffix:semicolon
macro_line|#ifdef HYCAPI_PRINTFNAMES
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;hycapi_capi_stop&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|cinfo
)paren
(brace
r_if
c_cond
(paren
id|cinfo-&gt;capi_ctrl
)paren
(brace
id|ctrl
op_assign
id|cinfo-&gt;capi_ctrl
suffix:semicolon
multiline_comment|/*&t;&t;&t;ctrl-&gt;suspend_output(ctrl); */
id|ctrl
op_member_access_from_pointer
id|reseted
c_func
(paren
id|ctrl
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;hycapi_capi_stop: cinfo but no capi_ctrl&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/***************************************************************&n;hycapi_send_message&n;&n;Send a message to the controller.&n;&n;Messages are parsed for their Command/Subcommand-type, and appropriate&n;action&squot;s are performed.&n;&n;Note that we have to muck around with a 64Bit-DATA_REQ as there are&n;firmware-releases that do not check the MsgLen-Indication!&n;&n;***************************************************************/
DECL|function|hycapi_send_message
r_void
id|hycapi_send_message
c_func
(paren
r_struct
id|capi_ctr
op_star
id|ctrl
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|__u16
id|appl_id
suffix:semicolon
r_int
id|_len
comma
id|_len2
suffix:semicolon
id|__u8
id|msghead
(braket
l_int|64
)braket
suffix:semicolon
id|appl_id
op_assign
id|CAPIMSG_APPID
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|_hycapi_appCheck
c_func
(paren
id|appl_id
comma
id|ctrl-&gt;cnr
)paren
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/*&t;&t;&t;printk(KERN_INFO &quot;Need to register&bslash;n&quot;); */
id|hycapi_register_internal
c_func
(paren
id|ctrl
comma
id|appl_id
comma
op_amp
(paren
id|hycapi_applications
(braket
id|appl_id
op_minus
l_int|1
)braket
dot
id|rp
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;HYCAPI: Controller mixup!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|CAPIMSG_CMD
c_func
(paren
id|skb-&gt;data
)paren
)paren
(brace
r_case
id|CAPI_DISCONNECT_B3_RESP
suffix:colon
id|ctrl
op_member_access_from_pointer
id|free_ncci
c_func
(paren
id|ctrl
comma
id|appl_id
comma
id|CAPIMSG_NCCI
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CAPI_DATA_B3_REQ
suffix:colon
id|_len
op_assign
id|CAPIMSG_LEN
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|_len
OG
l_int|22
)paren
(brace
id|_len2
op_assign
id|_len
op_minus
l_int|22
suffix:semicolon
id|memcpy
c_func
(paren
id|msghead
comma
id|skb-&gt;data
comma
l_int|22
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb-&gt;data
op_plus
id|_len2
comma
id|msghead
comma
l_int|22
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
id|_len2
)paren
suffix:semicolon
id|CAPIMSG_SETLEN
c_func
(paren
id|skb-&gt;data
comma
l_int|22
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CAPI_LISTEN_REQ
suffix:colon
r_if
c_cond
(paren
id|hycapi_applications
(braket
id|appl_id
op_minus
l_int|1
)braket
dot
id|listen_req
(braket
id|ctrl-&gt;cnr
op_minus
l_int|1
)braket
)paren
(brace
id|kfree_skb
c_func
(paren
id|hycapi_applications
(braket
id|appl_id
op_minus
l_int|1
)braket
dot
id|listen_req
(braket
id|ctrl-&gt;cnr
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|hycapi_applications
(braket
id|appl_id
op_minus
l_int|1
)braket
dot
id|listen_req
(braket
id|ctrl-&gt;cnr
op_minus
l_int|1
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|hycapi_applications
(braket
id|appl_id
op_minus
l_int|1
)braket
dot
id|listen_req
(braket
id|ctrl-&gt;cnr
op_minus
l_int|1
)braket
op_assign
id|skb_copy
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;HYSDN: memory squeeze in private_listen&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|hycapi_sendmsg_internal
c_func
(paren
id|ctrl
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*********************************************************************&n;hycapi_read_proc&n;&n;Informations provided in the /proc/capi-entries.&n;&n;*********************************************************************/
DECL|function|hycapi_read_proc
r_int
id|hycapi_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_struct
id|capi_ctr
op_star
id|ctrl
)paren
(brace
id|hycapictrl_info
op_star
id|cinfo
op_assign
(paren
id|hycapictrl_info
op_star
)paren
(paren
id|ctrl-&gt;driverdata
)paren
suffix:semicolon
id|hysdn_card
op_star
id|card
op_assign
id|cinfo-&gt;card
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|s
suffix:semicolon
macro_line|#ifdef HYCAPI_PRINTFNAMES
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;hycapi_read_proc&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;%-16s %s&bslash;n&quot;
comma
l_string|&quot;name&quot;
comma
id|cinfo-&gt;cardname
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;%-16s 0x%x&bslash;n&quot;
comma
l_string|&quot;io&quot;
comma
id|card-&gt;iobase
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;%-16s %d&bslash;n&quot;
comma
l_string|&quot;irq&quot;
comma
id|card-&gt;irq
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|card-&gt;brdtype
)paren
(brace
r_case
id|BD_PCCARD
suffix:colon
id|s
op_assign
l_string|&quot;HYSDN Hycard&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BD_ERGO
suffix:colon
id|s
op_assign
l_string|&quot;HYSDN Ergo2&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BD_METRO
suffix:colon
id|s
op_assign
l_string|&quot;HYSDN Metro4&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BD_CHAMP2
suffix:colon
id|s
op_assign
l_string|&quot;HYSDN Champ2&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BD_PLEXUS
suffix:colon
id|s
op_assign
l_string|&quot;HYSDN Plexus30&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|s
op_assign
l_string|&quot;???&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;%-16s %s&bslash;n&quot;
comma
l_string|&quot;type&quot;
comma
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|s
op_assign
id|cinfo-&gt;version
(braket
id|VER_DRIVER
)braket
)paren
op_ne
l_int|0
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;%-16s %s&bslash;n&quot;
comma
l_string|&quot;ver_driver&quot;
comma
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|s
op_assign
id|cinfo-&gt;version
(braket
id|VER_CARDTYPE
)braket
)paren
op_ne
l_int|0
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;%-16s %s&bslash;n&quot;
comma
l_string|&quot;ver_cardtype&quot;
comma
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|s
op_assign
id|cinfo-&gt;version
(braket
id|VER_SERIAL
)braket
)paren
op_ne
l_int|0
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;%-16s %s&bslash;n&quot;
comma
l_string|&quot;ver_serial&quot;
comma
id|s
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;%-16s %s&bslash;n&quot;
comma
l_string|&quot;cardname&quot;
comma
id|cinfo-&gt;cardname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|off
op_plus
id|count
op_ge
id|len
)paren
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|off
)paren
r_return
l_int|0
suffix:semicolon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
r_return
(paren
(paren
id|count
OL
id|len
op_minus
id|off
)paren
ques
c_cond
id|count
suffix:colon
id|len
op_minus
id|off
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************&n;hycapi_load_firmware&n;&n;This does NOT load any firmware, but the callback somehow is needed&n;on capi-interface registration.&n;&n;**************************************************************/
DECL|function|hycapi_load_firmware
r_int
id|hycapi_load_firmware
c_func
(paren
r_struct
id|capi_ctr
op_star
id|ctrl
comma
id|capiloaddata
op_star
id|data
)paren
(brace
macro_line|#ifdef HYCAPI_PRINTFNAMES
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;hycapi_load_firmware&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hycapi_procinfo
r_char
op_star
id|hycapi_procinfo
c_func
(paren
r_struct
id|capi_ctr
op_star
id|ctrl
)paren
(brace
id|hycapictrl_info
op_star
id|cinfo
op_assign
(paren
id|hycapictrl_info
op_star
)paren
(paren
id|ctrl-&gt;driverdata
)paren
suffix:semicolon
macro_line|#ifdef HYCAPI_PRINTFNAMES
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;hycapi_proc_info&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|cinfo
)paren
r_return
l_string|&quot;&quot;
suffix:semicolon
id|sprintf
c_func
(paren
id|cinfo-&gt;infobuf
comma
l_string|&quot;%s %s 0x%x %d %s&quot;
comma
id|cinfo-&gt;cardname
(braket
l_int|0
)braket
ques
c_cond
id|cinfo-&gt;cardname
suffix:colon
l_string|&quot;-&quot;
comma
id|cinfo-&gt;version
(braket
id|VER_DRIVER
)braket
ques
c_cond
id|cinfo-&gt;version
(braket
id|VER_DRIVER
)braket
suffix:colon
l_string|&quot;-&quot;
comma
id|cinfo-&gt;card
ques
c_cond
id|cinfo-&gt;card-&gt;iobase
suffix:colon
l_int|0x0
comma
id|cinfo-&gt;card
ques
c_cond
id|cinfo-&gt;card-&gt;irq
suffix:colon
l_int|0
comma
id|hycapi_revision
)paren
suffix:semicolon
r_return
id|cinfo-&gt;infobuf
suffix:semicolon
)brace
multiline_comment|/******************************************************************&n;hycapi_rx_capipkt&n;&n;Recieve a capi-message.&n;&n;All B3_DATA_IND are converted to 64K-extension compatible format.&n;New nccis are created if neccessary.&n;*******************************************************************/
r_void
DECL|function|hycapi_rx_capipkt
id|hycapi_rx_capipkt
c_func
(paren
id|hysdn_card
op_star
id|card
comma
id|uchar
op_star
id|buf
comma
id|word
id|len
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|hycapictrl_info
op_star
id|cinfo
op_assign
id|card-&gt;hyctrlinfo
suffix:semicolon
r_struct
id|capi_ctr
op_star
id|ctrl
suffix:semicolon
id|__u16
id|ApplId
suffix:semicolon
id|__u16
id|MsgLen
comma
id|info
suffix:semicolon
id|__u16
id|len2
comma
id|CapiCmd
suffix:semicolon
id|__u32
id|CP64
(braket
l_int|2
)braket
op_assign
(brace
l_int|0
comma
l_int|0
)brace
suffix:semicolon
macro_line|#ifdef HYCAPI_PRINTFNAMES
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;hycapi_rx_capipkt&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|cinfo
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;HYSDN Card%d: no HYCAPI-controller!&bslash;n&quot;
comma
id|card-&gt;myid
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ctrl
op_assign
id|cinfo-&gt;capi_ctrl
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ctrl
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;HYSDN Card%d: no CAPI-controller (1)!&bslash;n&quot;
comma
id|card-&gt;myid
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OL
id|CAPI_MSG_BASELEN
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;HYSDN Card%d: invalid CAPI-message, lenght %d!&bslash;n&quot;
comma
id|card-&gt;myid
comma
id|len
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|MsgLen
op_assign
id|CAPIMSG_LEN
c_func
(paren
id|buf
)paren
suffix:semicolon
id|ApplId
op_assign
id|CAPIMSG_APPID
c_func
(paren
id|buf
)paren
suffix:semicolon
id|CapiCmd
op_assign
id|CAPIMSG_CMD
c_func
(paren
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|CapiCmd
op_eq
id|CAPI_DATA_B3_IND
)paren
op_logical_and
(paren
id|MsgLen
OL
l_int|30
)paren
)paren
(brace
id|len2
op_assign
id|len
op_plus
(paren
l_int|30
op_minus
id|MsgLen
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|len2
comma
id|GFP_ATOMIC
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;HYSDN Card%d: incoming packet dropped&bslash;n&quot;
comma
id|card-&gt;myid
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|MsgLen
)paren
comma
id|buf
comma
id|MsgLen
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
l_int|2
op_star
r_sizeof
(paren
id|__u32
)paren
)paren
comma
id|CP64
comma
l_int|2
op_star
r_sizeof
(paren
id|__u32
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|len
op_minus
id|MsgLen
)paren
comma
id|buf
op_plus
id|MsgLen
comma
id|len
op_minus
id|MsgLen
)paren
suffix:semicolon
id|CAPIMSG_SETLEN
c_func
(paren
id|skb-&gt;data
comma
l_int|30
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|len
comma
id|GFP_ATOMIC
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;HYSDN Card%d: incoming packet dropped&bslash;n&quot;
comma
id|card-&gt;myid
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
comma
id|buf
comma
id|len
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|CAPIMSG_CMD
c_func
(paren
id|skb-&gt;data
)paren
)paren
(brace
r_case
id|CAPI_CONNECT_B3_CONF
suffix:colon
multiline_comment|/* Check info-field for error-indication: */
id|info
op_assign
id|CAPIMSG_U16
c_func
(paren
id|skb-&gt;data
comma
l_int|12
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|info
)paren
(brace
r_case
l_int|0
suffix:colon
id|ctrl
op_member_access_from_pointer
id|new_ncci
c_func
(paren
id|ctrl
comma
id|ApplId
comma
id|CAPIMSG_NCCI
c_func
(paren
id|skb-&gt;data
)paren
comma
id|hycapi_applications
(braket
id|ApplId
op_minus
l_int|1
)braket
dot
id|rp.datablkcnt
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0001
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;HYSDN Card%d: NCPI not supported by current &quot;
l_string|&quot;protocol. NCPI ignored.&bslash;n&quot;
comma
id|card-&gt;myid
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x2001
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;HYSDN Card%d: Message not supported in&quot;
l_string|&quot; current state&bslash;n&quot;
comma
id|card-&gt;myid
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x2002
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;HYSDN Card%d: illegal PLCI&bslash;n&quot;
comma
id|card-&gt;myid
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x2004
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;HYSDN Card%d: out of NCCI&bslash;n&quot;
comma
id|card-&gt;myid
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x3008
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;HYSDN Card%d: NCPI not supported&bslash;n&quot;
comma
id|card-&gt;myid
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;HYSDN Card%d: Info in CONNECT_B3_CONF: %d&bslash;n&quot;
comma
id|card-&gt;myid
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CAPI_CONNECT_B3_IND
suffix:colon
id|ctrl
op_member_access_from_pointer
id|new_ncci
c_func
(paren
id|ctrl
comma
id|ApplId
comma
id|CAPIMSG_NCCI
c_func
(paren
id|skb-&gt;data
)paren
comma
id|hycapi_applications
(braket
id|ApplId
op_minus
l_int|1
)braket
dot
id|rp.datablkcnt
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|ctrl
op_member_access_from_pointer
id|handle_capimsg
c_func
(paren
id|ctrl
comma
id|ApplId
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************&n;hycapi_tx_capiack&n;&n;Internally acknowledge a msg sent. This will remove the msg from the&n;internal queue.&n;&n;*******************************************************************/
DECL|function|hycapi_tx_capiack
r_void
id|hycapi_tx_capiack
c_func
(paren
id|hysdn_card
op_star
id|card
)paren
(brace
id|hycapictrl_info
op_star
id|cinfo
op_assign
id|card-&gt;hyctrlinfo
suffix:semicolon
macro_line|#ifdef HYCAPI_PRINTFNAMES
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;hycapi_tx_capiack&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|cinfo
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;HYSDN Card%d: no CAPI-controller (2)!&bslash;n&quot;
comma
id|card-&gt;myid
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_lock_irq
c_func
(paren
op_amp
id|cinfo-&gt;lock
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|cinfo-&gt;skbs
(braket
id|cinfo-&gt;out_idx
)braket
)paren
suffix:semicolon
multiline_comment|/* free skb */
id|cinfo-&gt;skbs
(braket
id|cinfo-&gt;out_idx
op_increment
)braket
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|cinfo-&gt;out_idx
op_ge
id|HYSDN_MAX_CAPI_SKB
)paren
id|cinfo-&gt;out_idx
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* wrap around */
r_if
c_cond
(paren
id|cinfo-&gt;sk_count
op_decrement
op_eq
id|HYSDN_MAX_CAPI_SKB
)paren
multiline_comment|/* dec usage count */
id|cinfo-&gt;capi_ctrl
op_member_access_from_pointer
id|resume_output
c_func
(paren
id|cinfo-&gt;capi_ctrl
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|cinfo-&gt;lock
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************&n;hycapi_tx_capiget(hysdn_card *card)&n;&n;This is called when polling for messages to SEND.&n;&n;****************************************************************/
r_struct
id|sk_buff
op_star
DECL|function|hycapi_tx_capiget
id|hycapi_tx_capiget
c_func
(paren
id|hysdn_card
op_star
id|card
)paren
(brace
id|hycapictrl_info
op_star
id|cinfo
op_assign
id|card-&gt;hyctrlinfo
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cinfo
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;HYSDN Card%d: no CAPI-controller! (3)&bslash;n&quot;
comma
id|card-&gt;myid
)paren
suffix:semicolon
r_return
(paren
r_struct
id|sk_buff
op_star
)paren
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|cinfo-&gt;sk_count
)paren
r_return
(paren
r_struct
id|sk_buff
op_star
)paren
l_int|NULL
suffix:semicolon
multiline_comment|/* nothing available */
r_return
(paren
id|cinfo-&gt;skbs
(braket
id|cinfo-&gt;out_idx
)braket
)paren
suffix:semicolon
multiline_comment|/* next packet to send */
)brace
DECL|variable|hycapi_driver
r_static
r_struct
id|capi_driver
id|hycapi_driver
op_assign
(brace
l_string|&quot;hysdn&quot;
comma
l_string|&quot;0.0&quot;
comma
id|hycapi_load_firmware
comma
id|hycapi_reset_ctr
comma
id|hycapi_remove_ctr
comma
id|hycapi_register_appl
comma
id|hycapi_release_appl
comma
id|hycapi_send_message
comma
id|hycapi_procinfo
comma
id|hycapi_read_proc
comma
l_int|0
comma
multiline_comment|/* use standard driver_read_proc */
l_int|0
comma
multiline_comment|/* no add_card function */
)brace
suffix:semicolon
multiline_comment|/**********************************************************&n;int hycapi_init()&n;&n;attach the capi-driver to the kernel-capi.&n;&n;***********************************************************/
DECL|function|hycapi_init
r_int
id|hycapi_init
c_func
(paren
)paren
(brace
r_struct
id|capi_driver
op_star
id|driver
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|hy_di
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;HyDI allready set&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|driver
op_assign
op_amp
id|hycapi_driver
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;HYSDN: Attaching capi-driver&bslash;n&quot;
)paren
suffix:semicolon
id|hy_di
op_assign
id|attach_capi_driver
c_func
(paren
id|driver
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hy_di
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;HYCAPI: failed to attach capi_driver&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CAPI_MAXAPPL
suffix:semicolon
id|i
op_increment
)paren
(brace
id|memset
c_func
(paren
op_amp
(paren
id|hycapi_applications
(braket
id|i
)braket
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|hycapi_appl
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**************************************************************&n;hycapi_cleanup(void)&n;&n;detach the capi-driver to the kernel-capi. Actually this should&n;free some more ressources. Do that later.&n;**************************************************************/
r_void
DECL|function|hycapi_cleanup
id|hycapi_cleanup
c_func
(paren
r_void
)paren
(brace
r_struct
id|capi_driver
op_star
id|driver
suffix:semicolon
id|driver
op_assign
op_amp
id|hycapi_driver
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hy_di
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;HYSDN: no capi-driver to detach (???)&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;HYSDN: Detaching capi-driver&bslash;n&quot;
)paren
suffix:semicolon
id|detach_capi_driver
c_func
(paren
id|driver
)paren
suffix:semicolon
id|hy_di
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/********************************************************************&n;hycapi_capi_create(hysdn_card *card)&n;&n;Attach the card with it&squot;s capi-ctrl.&n;*********************************************************************/
DECL|function|hycapi_fill_profile
r_static
r_void
id|hycapi_fill_profile
c_func
(paren
id|hysdn_card
op_star
id|card
)paren
(brace
id|hycapictrl_info
op_star
id|cinfo
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|capi_ctr
op_star
id|ctrl
op_assign
l_int|NULL
suffix:semicolon
id|cinfo
op_assign
id|card-&gt;hyctrlinfo
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cinfo
)paren
(brace
r_return
suffix:semicolon
)brace
id|ctrl
op_assign
id|cinfo-&gt;capi_ctrl
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ctrl
)paren
(brace
r_return
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|ctrl-&gt;manu
comma
l_string|&quot;Hypercope&quot;
)paren
suffix:semicolon
id|ctrl-&gt;version.majorversion
op_assign
l_int|2
suffix:semicolon
id|ctrl-&gt;version.minorversion
op_assign
l_int|0
suffix:semicolon
id|ctrl-&gt;version.majormanuversion
op_assign
l_int|3
suffix:semicolon
id|ctrl-&gt;version.minormanuversion
op_assign
l_int|2
suffix:semicolon
id|ctrl-&gt;profile.ncontroller
op_assign
id|card-&gt;myid
suffix:semicolon
id|ctrl-&gt;profile.nbchannel
op_assign
id|card-&gt;bchans
suffix:semicolon
id|ctrl-&gt;profile.goptions
op_assign
id|GLOBAL_OPTION_INTERNAL_CONTROLLER
op_or
id|GLOBAL_OPTION_B_CHANNEL_OPERATION
suffix:semicolon
id|ctrl-&gt;profile.support1
op_assign
id|B1_PROT_64KBIT_HDLC
op_or
(paren
id|card-&gt;faxchans
ques
c_cond
id|B1_PROT_T30
suffix:colon
l_int|0
)paren
op_or
id|B1_PROT_64KBIT_TRANSPARENT
suffix:semicolon
id|ctrl-&gt;profile.support2
op_assign
id|B2_PROT_ISO7776
op_or
(paren
id|card-&gt;faxchans
ques
c_cond
id|B2_PROT_T30
suffix:colon
l_int|0
)paren
op_or
id|B2_PROT_TRANSPARENT
suffix:semicolon
id|ctrl-&gt;profile.support3
op_assign
id|B3_PROT_TRANSPARENT
op_or
id|B3_PROT_T90NL
op_or
(paren
id|card-&gt;faxchans
ques
c_cond
id|B3_PROT_T30
suffix:colon
l_int|0
)paren
op_or
(paren
id|card-&gt;faxchans
ques
c_cond
id|B3_PROT_T30EXT
suffix:colon
l_int|0
)paren
op_or
id|B3_PROT_ISO8208
suffix:semicolon
)brace
r_int
DECL|function|hycapi_capi_create
id|hycapi_capi_create
c_func
(paren
id|hysdn_card
op_star
id|card
)paren
(brace
id|hycapictrl_info
op_star
id|cinfo
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|capi_ctr
op_star
id|ctrl
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef HYCAPI_PRINTFNAMES
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;hycapi_capi_create&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;hyctrlinfo
)paren
(brace
id|cinfo
op_assign
(paren
id|hycapictrl_info
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|hycapictrl_info
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cinfo
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HYSDN: no memory for capi-ctrl.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|cinfo
comma
l_int|0
comma
r_sizeof
(paren
id|hycapictrl_info
)paren
)paren
suffix:semicolon
id|card-&gt;hyctrlinfo
op_assign
id|cinfo
suffix:semicolon
id|cinfo-&gt;card
op_assign
id|card
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|cinfo-&gt;lock
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|card-&gt;brdtype
)paren
(brace
r_case
id|BD_PCCARD
suffix:colon
id|strcpy
c_func
(paren
id|cinfo-&gt;cardname
comma
l_string|&quot;HYSDN Hycard&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BD_ERGO
suffix:colon
id|strcpy
c_func
(paren
id|cinfo-&gt;cardname
comma
l_string|&quot;HYSDN Ergo2&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BD_METRO
suffix:colon
id|strcpy
c_func
(paren
id|cinfo-&gt;cardname
comma
l_string|&quot;HYSDN Metro4&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BD_CHAMP2
suffix:colon
id|strcpy
c_func
(paren
id|cinfo-&gt;cardname
comma
l_string|&quot;HYSDN Champ2&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BD_PLEXUS
suffix:colon
id|strcpy
c_func
(paren
id|cinfo-&gt;cardname
comma
l_string|&quot;HYSDN Plexus30&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|strcpy
c_func
(paren
id|cinfo-&gt;cardname
comma
l_string|&quot;HYSDN ???&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|cinfo-&gt;capi_ctrl
op_assign
id|hy_di
op_member_access_from_pointer
id|attach_ctr
c_func
(paren
op_amp
id|hycapi_driver
comma
id|cinfo-&gt;cardname
comma
id|cinfo
)paren
suffix:semicolon
id|ctrl
op_assign
id|cinfo-&gt;capi_ctrl
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ctrl
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: attach controller failed.&bslash;n&quot;
comma
id|hycapi_driver.name
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* fill in the blanks: */
id|hycapi_fill_profile
c_func
(paren
id|card
)paren
suffix:semicolon
id|ctrl
op_member_access_from_pointer
id|ready
c_func
(paren
id|ctrl
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* resume output on stopped ctrl */
id|ctrl
op_assign
id|card-&gt;hyctrlinfo-&gt;capi_ctrl
suffix:semicolon
r_if
c_cond
(paren
id|ctrl
)paren
(brace
id|hycapi_fill_profile
c_func
(paren
id|card
)paren
suffix:semicolon
id|ctrl
op_member_access_from_pointer
id|ready
c_func
(paren
id|ctrl
)paren
suffix:semicolon
id|hycapi_restart_internal
c_func
(paren
id|ctrl
)paren
suffix:semicolon
multiline_comment|/*&t;&t;&t;ctrl-&gt;resume_output(ctrl); */
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HYSDN: No ctrl???? How come?&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
eof
