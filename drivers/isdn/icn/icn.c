multiline_comment|/* $Id: icn.c,v 1.65 2000/11/13 22:51:48 kai Exp $&n;&n; * ISDN low-level module for the ICN active ISDN-Card.&n; *&n; * Copyright 1994,95,96 by Fritz Elfert (fritz@isdn4linux.de)&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; */
macro_line|#include &quot;icn.h&quot;
multiline_comment|/*&n; * Verbose bootcode- and protocol-downloading.&n; */
DECL|macro|BOOT_DEBUG
macro_line|#undef BOOT_DEBUG
multiline_comment|/*&n; * Verbose Shmem-Mapping.&n; */
DECL|macro|MAP_DEBUG
macro_line|#undef MAP_DEBUG
r_static
r_char
DECL|variable|revision
op_star
id|revision
op_assign
l_string|&quot;$Revision: 1.65 $&quot;
suffix:semicolon
r_static
r_int
id|icn_addcard
c_func
(paren
r_int
comma
r_char
op_star
comma
r_char
op_star
)paren
suffix:semicolon
multiline_comment|/*&n; * Free send-queue completely.&n; * Parameter:&n; *   card   = pointer to card struct&n; *   channel = channel number&n; */
r_static
r_void
DECL|function|icn_free_queue
id|icn_free_queue
c_func
(paren
id|icn_card
op_star
id|card
comma
r_int
id|channel
)paren
(brace
r_struct
id|sk_buff_head
op_star
id|queue
op_assign
op_amp
id|card-&gt;spqueue
(braket
id|channel
)braket
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
id|queue
)paren
)paren
)paren
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|card-&gt;xlen
(braket
id|channel
)braket
op_assign
l_int|0
suffix:semicolon
id|card-&gt;sndcount
(braket
id|channel
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|card-&gt;xskb
(braket
id|channel
)braket
)paren
)paren
(brace
id|card-&gt;xskb
(braket
id|channel
)braket
op_assign
l_int|NULL
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Put a value into a shift-register, highest bit first.&n; * Parameters:&n; *            port     = port for output (bit 0 is significant)&n; *            val      = value to be output&n; *            firstbit = Bit-Number of highest bit&n; *            bitcount = Number of bits to output&n; */
r_static
r_inline
r_void
DECL|function|icn_shiftout
id|icn_shiftout
c_func
(paren
r_int
r_int
id|port
comma
r_int
r_int
id|val
comma
r_int
id|firstbit
comma
r_int
id|bitcount
)paren
(brace
r_register
id|u_char
id|s
suffix:semicolon
r_register
id|u_char
id|c
suffix:semicolon
r_for
c_loop
(paren
id|s
op_assign
id|firstbit
comma
id|c
op_assign
id|bitcount
suffix:semicolon
id|c
OG
l_int|0
suffix:semicolon
id|s
op_decrement
comma
id|c
op_decrement
)paren
id|OUTB_P
c_func
(paren
(paren
id|u_char
)paren
(paren
(paren
id|val
op_rshift
id|s
)paren
op_amp
l_int|1
)paren
ques
c_cond
l_int|0xff
suffix:colon
l_int|0
comma
id|port
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * disable a cards shared memory&n; */
r_static
r_inline
r_void
DECL|function|icn_disable_ram
id|icn_disable_ram
c_func
(paren
id|icn_card
op_star
id|card
)paren
(brace
id|OUTB_P
c_func
(paren
l_int|0
comma
id|ICN_MAPRAM
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * enable a cards shared memory&n; */
r_static
r_inline
r_void
DECL|function|icn_enable_ram
id|icn_enable_ram
c_func
(paren
id|icn_card
op_star
id|card
)paren
(brace
id|OUTB_P
c_func
(paren
l_int|0xff
comma
id|ICN_MAPRAM
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Map a cards channel0 (Bank0/Bank8) or channel1 (Bank4/Bank12)&n; */
r_static
r_inline
r_void
DECL|function|icn_map_channel
id|icn_map_channel
c_func
(paren
id|icn_card
op_star
id|card
comma
r_int
id|channel
)paren
(brace
macro_line|#ifdef MAP_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;icn_map_channel %d %d&bslash;n&quot;
comma
id|dev.channel
comma
id|channel
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|channel
op_eq
id|dev.channel
)paren
op_logical_and
(paren
id|card
op_eq
id|dev.mcard
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|dev.mcard
)paren
id|icn_disable_ram
c_func
(paren
id|dev.mcard
)paren
suffix:semicolon
id|icn_shiftout
c_func
(paren
id|ICN_BANK
comma
id|chan2bank
(braket
id|channel
)braket
comma
l_int|3
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Select Bank          */
id|icn_enable_ram
c_func
(paren
id|card
)paren
suffix:semicolon
id|dev.mcard
op_assign
id|card
suffix:semicolon
id|dev.channel
op_assign
id|channel
suffix:semicolon
macro_line|#ifdef MAP_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;icn_map_channel done&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * Lock a cards channel.&n; * Return 0 if requested card/channel is unmapped (failure).&n; * Return 1 on success.&n; */
r_static
r_inline
r_int
DECL|function|icn_lock_channel
id|icn_lock_channel
c_func
(paren
id|icn_card
op_star
id|card
comma
r_int
id|channel
)paren
(brace
r_register
r_int
id|retval
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
macro_line|#ifdef MAP_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;icn_lock_channel %d&bslash;n&quot;
comma
id|channel
)paren
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev.channel
op_eq
id|channel
)paren
op_logical_and
(paren
id|card
op_eq
id|dev.mcard
)paren
)paren
(brace
id|dev.chanlock
op_increment
suffix:semicolon
id|retval
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef MAP_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;icn_lock_channel %d OK&bslash;n&quot;
comma
id|channel
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|retval
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef MAP_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;icn_lock_channel %d FAILED, dc=%d&bslash;n&quot;
comma
id|channel
comma
id|dev.channel
)paren
suffix:semicolon
macro_line|#endif
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * Release current card/channel lock&n; */
r_static
r_inline
r_void
DECL|function|icn_release_channel
id|icn_release_channel
c_func
(paren
r_void
)paren
(brace
id|ulong
id|flags
suffix:semicolon
macro_line|#ifdef MAP_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;icn_release_channel l=%d&bslash;n&quot;
comma
id|dev.chanlock
)paren
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev.chanlock
OG
l_int|0
)paren
id|dev.chanlock
op_decrement
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Try to map and lock a cards channel.&n; * Return 1 on success, 0 on failure.&n; */
r_static
r_inline
r_int
DECL|function|icn_trymaplock_channel
id|icn_trymaplock_channel
c_func
(paren
id|icn_card
op_star
id|card
comma
r_int
id|channel
)paren
(brace
id|ulong
id|flags
suffix:semicolon
macro_line|#ifdef MAP_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;trymaplock c=%d dc=%d l=%d&bslash;n&quot;
comma
id|channel
comma
id|dev.channel
comma
id|dev.chanlock
)paren
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|dev.chanlock
)paren
op_logical_or
(paren
(paren
id|dev.channel
op_eq
id|channel
)paren
op_logical_and
(paren
id|dev.mcard
op_eq
id|card
)paren
)paren
)paren
(brace
id|dev.chanlock
op_increment
suffix:semicolon
id|icn_map_channel
c_func
(paren
id|card
comma
id|channel
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#ifdef MAP_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;trymaplock %d OK&bslash;n&quot;
comma
id|channel
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|1
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#ifdef MAP_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;trymaplock %d FAILED&bslash;n&quot;
comma
id|channel
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Release current card/channel lock,&n; * then map same or other channel without locking.&n; */
r_static
r_inline
r_void
DECL|function|icn_maprelease_channel
id|icn_maprelease_channel
c_func
(paren
id|icn_card
op_star
id|card
comma
r_int
id|channel
)paren
(brace
id|ulong
id|flags
suffix:semicolon
macro_line|#ifdef MAP_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;map_release c=%d l=%d&bslash;n&quot;
comma
id|channel
comma
id|dev.chanlock
)paren
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev.chanlock
OG
l_int|0
)paren
id|dev.chanlock
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev.chanlock
)paren
id|icn_map_channel
c_func
(paren
id|card
comma
id|channel
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Get Data from the B-Channel, assemble fragmented packets and put them&n; * into receive-queue. Wake up any B-Channel-reading processes.&n; * This routine is called via timer-callback from icn_pollbchan().&n; */
r_static
r_void
DECL|function|icn_pollbchan_receive
id|icn_pollbchan_receive
c_func
(paren
r_int
id|channel
comma
id|icn_card
op_star
id|card
)paren
(brace
r_int
id|mch
op_assign
id|channel
op_plus
(paren
(paren
id|card-&gt;secondhalf
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|0
)paren
suffix:semicolon
r_int
id|eflag
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|icn_trymaplock_channel
c_func
(paren
id|card
comma
id|mch
)paren
)paren
(brace
r_while
c_loop
(paren
id|rbavl
)paren
(brace
id|cnt
op_assign
id|readb
c_func
(paren
op_amp
id|rbuf_l
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|card-&gt;rcvidx
(braket
id|channel
)braket
op_plus
id|cnt
)paren
OG
l_int|4000
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;icn: (%s) bogus packet on ch%d, dropping.&bslash;n&quot;
comma
id|CID
comma
id|channel
op_plus
l_int|1
)paren
suffix:semicolon
id|card-&gt;rcvidx
(braket
id|channel
)braket
op_assign
l_int|0
suffix:semicolon
id|eflag
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|memcpy_fromio
c_func
(paren
op_amp
id|card-&gt;rcvbuf
(braket
id|channel
)braket
(braket
id|card-&gt;rcvidx
(braket
id|channel
)braket
)braket
comma
op_amp
id|rbuf_d
comma
id|cnt
)paren
suffix:semicolon
id|card-&gt;rcvidx
(braket
id|channel
)braket
op_add_assign
id|cnt
suffix:semicolon
id|eflag
op_assign
id|readb
c_func
(paren
op_amp
id|rbuf_f
)paren
suffix:semicolon
)brace
id|rbnext
suffix:semicolon
id|icn_maprelease_channel
c_func
(paren
id|card
comma
id|mch
op_amp
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|eflag
)paren
(brace
r_if
c_cond
(paren
(paren
id|cnt
op_assign
id|card-&gt;rcvidx
(braket
id|channel
)braket
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|cnt
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;icn: receive out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|cnt
)paren
comma
id|card-&gt;rcvbuf
(braket
id|channel
)braket
comma
id|cnt
)paren
suffix:semicolon
id|card-&gt;rcvidx
(braket
id|channel
)braket
op_assign
l_int|0
suffix:semicolon
id|card-&gt;interface
dot
id|rcvcallb_skb
c_func
(paren
id|card-&gt;myid
comma
id|channel
comma
id|skb
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|icn_trymaplock_channel
c_func
(paren
id|card
comma
id|mch
)paren
)paren
r_break
suffix:semicolon
)brace
id|icn_maprelease_channel
c_func
(paren
id|card
comma
id|mch
op_amp
l_int|2
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Send data-packet to B-Channel, split it up into fragments of&n; * ICN_FRAGSIZE length. If last fragment is sent out, signal&n; * success to upper layers via statcallb with ISDN_STAT_BSENT argument.&n; * This routine is called via timer-callback from icn_pollbchan() or&n; * directly from icn_sendbuf().&n; */
r_static
r_void
DECL|function|icn_pollbchan_send
id|icn_pollbchan_send
c_func
(paren
r_int
id|channel
comma
id|icn_card
op_star
id|card
)paren
(brace
r_int
id|mch
op_assign
id|channel
op_plus
(paren
(paren
id|card-&gt;secondhalf
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|0
)paren
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|card-&gt;sndcount
(braket
id|channel
)braket
op_logical_or
id|card-&gt;xskb
(braket
id|channel
)braket
op_logical_or
id|skb_queue_len
c_func
(paren
op_amp
id|card-&gt;spqueue
(braket
id|channel
)braket
)paren
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|icn_trymaplock_channel
c_func
(paren
id|card
comma
id|mch
)paren
)paren
(brace
r_while
c_loop
(paren
id|sbfree
op_logical_and
(paren
id|card-&gt;sndcount
(braket
id|channel
)braket
op_logical_or
id|skb_queue_len
c_func
(paren
op_amp
id|card-&gt;spqueue
(braket
id|channel
)braket
)paren
op_logical_or
id|card-&gt;xskb
(braket
id|channel
)braket
)paren
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;xmit_lock
(braket
id|channel
)braket
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|card-&gt;xmit_lock
(braket
id|channel
)braket
op_increment
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|skb
op_assign
id|card-&gt;xskb
(braket
id|channel
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|card-&gt;spqueue
(braket
id|channel
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
multiline_comment|/* Pop ACK-flag off skb.&n;&t;&t;&t;&t;&t; * Store length to xlen.&n;&t;&t;&t;&t;&t; */
r_if
c_cond
(paren
op_star
(paren
id|skb_pull
c_func
(paren
id|skb
comma
l_int|1
)paren
)paren
)paren
id|card-&gt;xlen
(braket
id|channel
)braket
op_assign
id|skb-&gt;len
suffix:semicolon
r_else
id|card-&gt;xlen
(braket
id|channel
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
OG
id|ICN_FRAGSIZE
)paren
(brace
id|writeb
c_func
(paren
l_int|0xff
comma
op_amp
id|sbuf_f
)paren
suffix:semicolon
id|cnt
op_assign
id|ICN_FRAGSIZE
suffix:semicolon
)brace
r_else
(brace
id|writeb
c_func
(paren
l_int|0x0
comma
op_amp
id|sbuf_f
)paren
suffix:semicolon
id|cnt
op_assign
id|skb-&gt;len
suffix:semicolon
)brace
id|writeb
c_func
(paren
id|cnt
comma
op_amp
id|sbuf_l
)paren
suffix:semicolon
id|memcpy_toio
c_func
(paren
op_amp
id|sbuf_d
comma
id|skb-&gt;data
comma
id|cnt
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
id|cnt
)paren
suffix:semicolon
id|card-&gt;sndcount
(braket
id|channel
)braket
op_sub_assign
id|cnt
suffix:semicolon
id|sbnext
suffix:semicolon
multiline_comment|/* switch to next buffer        */
id|icn_maprelease_channel
c_func
(paren
id|card
comma
id|mch
op_amp
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb-&gt;len
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;xskb
(braket
id|channel
)braket
)paren
id|card-&gt;xskb
(braket
id|channel
)braket
op_assign
l_int|NULL
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;xlen
(braket
id|channel
)braket
)paren
(brace
id|cmd.command
op_assign
id|ISDN_STAT_BSENT
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.arg
op_assign
id|channel
suffix:semicolon
id|cmd.parm.length
op_assign
id|card-&gt;xlen
(braket
id|channel
)braket
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|card-&gt;xskb
(braket
id|channel
)braket
op_assign
id|skb
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
id|card-&gt;xmit_lock
(braket
id|channel
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|icn_trymaplock_channel
c_func
(paren
id|card
comma
id|mch
)paren
)paren
r_break
suffix:semicolon
)brace
id|icn_maprelease_channel
c_func
(paren
id|card
comma
id|mch
op_amp
l_int|2
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Send/Receive Data to/from the B-Channel.&n; * This routine is called via timer-callback.&n; * It schedules itself while any B-Channel is open.&n; */
r_static
r_void
DECL|function|icn_pollbchan
id|icn_pollbchan
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|icn_card
op_star
id|card
op_assign
(paren
id|icn_card
op_star
)paren
id|data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;flags
op_amp
id|ICN_FLAGS_B1ACTIVE
)paren
(brace
id|icn_pollbchan_receive
c_func
(paren
l_int|0
comma
id|card
)paren
suffix:semicolon
id|icn_pollbchan_send
c_func
(paren
l_int|0
comma
id|card
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;flags
op_amp
id|ICN_FLAGS_B2ACTIVE
)paren
(brace
id|icn_pollbchan_receive
c_func
(paren
l_int|1
comma
id|card
)paren
suffix:semicolon
id|icn_pollbchan_send
c_func
(paren
l_int|1
comma
id|card
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;flags
op_amp
(paren
id|ICN_FLAGS_B1ACTIVE
op_or
id|ICN_FLAGS_B2ACTIVE
)paren
)paren
(brace
multiline_comment|/* schedule b-channel polling again */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|card-&gt;rb_timer
comma
id|jiffies
op_plus
id|ICN_TIMER_BCREAD
)paren
suffix:semicolon
id|card-&gt;flags
op_or_assign
id|ICN_FLAGS_RBTIMER
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_else
id|card-&gt;flags
op_and_assign
op_complement
id|ICN_FLAGS_RBTIMER
suffix:semicolon
)brace
DECL|struct|icn_stat
r_typedef
r_struct
id|icn_stat
(brace
DECL|member|statstr
r_char
op_star
id|statstr
suffix:semicolon
DECL|member|command
r_int
id|command
suffix:semicolon
DECL|member|action
r_int
id|action
suffix:semicolon
DECL|typedef|icn_stat
)brace
id|icn_stat
suffix:semicolon
multiline_comment|/* *INDENT-OFF* */
DECL|variable|icn_stat_table
r_static
id|icn_stat
id|icn_stat_table
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;BCON_&quot;
comma
id|ISDN_STAT_BCONN
comma
l_int|1
)brace
comma
multiline_comment|/* B-Channel connected        */
(brace
l_string|&quot;BDIS_&quot;
comma
id|ISDN_STAT_BHUP
comma
l_int|2
)brace
comma
multiline_comment|/* B-Channel disconnected     */
multiline_comment|/*&n;&t;** add d-channel connect and disconnect support to link-level&n;&t;*/
(brace
l_string|&quot;DCON_&quot;
comma
id|ISDN_STAT_DCONN
comma
l_int|10
)brace
comma
multiline_comment|/* D-Channel connected        */
(brace
l_string|&quot;DDIS_&quot;
comma
id|ISDN_STAT_DHUP
comma
l_int|11
)brace
comma
multiline_comment|/* D-Channel disconnected     */
(brace
l_string|&quot;DCAL_I&quot;
comma
id|ISDN_STAT_ICALL
comma
l_int|3
)brace
comma
multiline_comment|/* Incoming call dialup-line  */
(brace
l_string|&quot;DSCA_I&quot;
comma
id|ISDN_STAT_ICALL
comma
l_int|3
)brace
comma
multiline_comment|/* Incoming call 1TR6-SPV     */
(brace
l_string|&quot;FCALL&quot;
comma
id|ISDN_STAT_ICALL
comma
l_int|4
)brace
comma
multiline_comment|/* Leased line connection up  */
(brace
l_string|&quot;CIF&quot;
comma
id|ISDN_STAT_CINF
comma
l_int|5
)brace
comma
multiline_comment|/* Charge-info, 1TR6-type     */
(brace
l_string|&quot;AOC&quot;
comma
id|ISDN_STAT_CINF
comma
l_int|6
)brace
comma
multiline_comment|/* Charge-info, DSS1-type     */
(brace
l_string|&quot;CAU&quot;
comma
id|ISDN_STAT_CAUSE
comma
l_int|7
)brace
comma
multiline_comment|/* Cause code                 */
(brace
l_string|&quot;TEI OK&quot;
comma
id|ISDN_STAT_RUN
comma
l_int|0
)brace
comma
multiline_comment|/* Card connected to wallplug */
(brace
l_string|&quot;NO D-CHAN&quot;
comma
id|ISDN_STAT_NODCH
comma
l_int|0
)brace
comma
multiline_comment|/* No D-channel available     */
(brace
l_string|&quot;E_L1: ACT FAIL&quot;
comma
id|ISDN_STAT_BHUP
comma
l_int|8
)brace
comma
multiline_comment|/* Layer-1 activation failed  */
(brace
l_string|&quot;E_L2: DATA LIN&quot;
comma
id|ISDN_STAT_BHUP
comma
l_int|8
)brace
comma
multiline_comment|/* Layer-2 data link lost     */
(brace
l_string|&quot;E_L1: ACTIVATION FAILED&quot;
comma
id|ISDN_STAT_BHUP
comma
l_int|8
)brace
comma
multiline_comment|/* Layer-1 activation failed  */
(brace
l_int|NULL
comma
l_int|0
comma
op_minus
l_int|1
)brace
)brace
suffix:semicolon
multiline_comment|/* *INDENT-ON* */
multiline_comment|/*&n; * Check Statusqueue-Pointer from isdn-cards.&n; * If there are new status-replies from the interface, check&n; * them against B-Channel-connects/disconnects and set flags accordingly.&n; * Wake-Up any processes, who are reading the status-device.&n; * If there are B-Channels open, initiate a timer-callback to&n; * icn_pollbchan().&n; * This routine is called periodically via timer.&n; */
r_static
r_void
DECL|function|icn_parse_status
id|icn_parse_status
c_func
(paren
id|u_char
op_star
id|status
comma
r_int
id|channel
comma
id|icn_card
op_star
id|card
)paren
(brace
id|icn_stat
op_star
id|s
op_assign
id|icn_stat_table
suffix:semicolon
r_int
id|action
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
r_while
c_loop
(paren
id|s-&gt;statstr
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|status
comma
id|s-&gt;statstr
comma
id|strlen
c_func
(paren
id|s-&gt;statstr
)paren
)paren
)paren
(brace
id|cmd.command
op_assign
id|s-&gt;command
suffix:semicolon
id|action
op_assign
id|s-&gt;action
suffix:semicolon
r_break
suffix:semicolon
)brace
id|s
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|action
op_eq
op_minus
l_int|1
)paren
r_return
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.arg
op_assign
id|channel
suffix:semicolon
r_switch
c_cond
(paren
id|action
)paren
(brace
r_case
l_int|11
suffix:colon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|icn_free_queue
c_func
(paren
id|card
comma
id|channel
)paren
suffix:semicolon
id|card-&gt;rcvidx
(braket
id|channel
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;flags
op_amp
(paren
(paren
id|channel
)paren
ques
c_cond
id|ICN_FLAGS_B2ACTIVE
suffix:colon
id|ICN_FLAGS_B1ACTIVE
)paren
)paren
(brace
id|isdn_ctrl
id|ncmd
suffix:semicolon
id|card-&gt;flags
op_and_assign
op_complement
(paren
(paren
id|channel
)paren
ques
c_cond
id|ICN_FLAGS_B2ACTIVE
suffix:colon
id|ICN_FLAGS_B1ACTIVE
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|ncmd
comma
l_int|0
comma
r_sizeof
(paren
id|ncmd
)paren
)paren
suffix:semicolon
id|ncmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|ncmd.arg
op_assign
id|channel
suffix:semicolon
id|ncmd.command
op_assign
id|ISDN_STAT_BHUP
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
)brace
r_else
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|icn_free_queue
c_func
(paren
id|card
comma
id|channel
)paren
suffix:semicolon
id|card-&gt;flags
op_or_assign
(paren
id|channel
)paren
ques
c_cond
id|ICN_FLAGS_B2ACTIVE
suffix:colon
id|ICN_FLAGS_B1ACTIVE
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|card-&gt;flags
op_and_assign
op_complement
(paren
(paren
id|channel
)paren
ques
c_cond
id|ICN_FLAGS_B2ACTIVE
suffix:colon
id|ICN_FLAGS_B1ACTIVE
)paren
suffix:semicolon
id|icn_free_queue
c_func
(paren
id|card
comma
id|channel
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|card-&gt;rcvidx
(braket
id|channel
)braket
op_assign
l_int|0
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
(brace
r_char
op_star
id|t
op_assign
id|status
op_plus
l_int|6
suffix:semicolon
r_char
op_star
id|s
op_assign
id|strpbrk
c_func
(paren
id|t
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
op_star
id|s
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|strncpy
c_func
(paren
id|cmd.parm.setup.phone
comma
id|t
comma
r_sizeof
(paren
id|cmd.parm.setup.phone
)paren
)paren
suffix:semicolon
id|s
op_assign
id|strpbrk
c_func
(paren
id|t
op_assign
id|s
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
op_star
id|s
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strlen
c_func
(paren
id|t
)paren
)paren
id|cmd.parm.setup.si1
op_assign
l_int|0
suffix:semicolon
r_else
id|cmd.parm.setup.si1
op_assign
id|simple_strtoul
c_func
(paren
id|t
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
id|s
op_assign
id|strpbrk
c_func
(paren
id|t
op_assign
id|s
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
op_star
id|s
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strlen
c_func
(paren
id|t
)paren
)paren
id|cmd.parm.setup.si2
op_assign
l_int|0
suffix:semicolon
r_else
id|cmd.parm.setup.si2
op_assign
id|simple_strtoul
c_func
(paren
id|t
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|cmd.parm.setup.eazmsn
comma
id|s
comma
r_sizeof
(paren
id|cmd.parm.setup.eazmsn
)paren
)paren
suffix:semicolon
)brace
id|cmd.parm.setup.plan
op_assign
l_int|0
suffix:semicolon
id|cmd.parm.setup.screen
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|sprintf
c_func
(paren
id|cmd.parm.setup.phone
comma
l_string|&quot;LEASED%d&quot;
comma
id|card-&gt;myid
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|cmd.parm.setup.eazmsn
comma
l_string|&quot;%d&quot;
comma
id|channel
op_plus
l_int|1
)paren
suffix:semicolon
id|cmd.parm.setup.si1
op_assign
l_int|7
suffix:semicolon
id|cmd.parm.setup.si2
op_assign
l_int|0
suffix:semicolon
id|cmd.parm.setup.plan
op_assign
l_int|0
suffix:semicolon
id|cmd.parm.setup.screen
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|strncpy
c_func
(paren
id|cmd.parm.num
comma
id|status
op_plus
l_int|3
comma
r_sizeof
(paren
id|cmd.parm.num
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|sprintf
c_func
(paren
id|cmd.parm.num
comma
l_string|&quot;%d&quot;
comma
(paren
r_int
)paren
id|simple_strtoul
c_func
(paren
id|status
op_plus
l_int|7
comma
l_int|NULL
comma
l_int|16
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|status
op_add_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|status
)paren
op_eq
l_int|4
)paren
id|sprintf
c_func
(paren
id|cmd.parm.num
comma
l_string|&quot;%s%c%c&quot;
comma
id|status
op_plus
l_int|2
comma
op_star
id|status
comma
op_star
(paren
id|status
op_plus
l_int|1
)paren
)paren
suffix:semicolon
r_else
id|strncpy
c_func
(paren
id|cmd.parm.num
comma
id|status
op_plus
l_int|1
comma
r_sizeof
(paren
id|cmd.parm.num
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|card-&gt;flags
op_and_assign
op_complement
id|ICN_FLAGS_B1ACTIVE
suffix:semicolon
id|icn_free_queue
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|card-&gt;rcvidx
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cmd.arg
op_assign
l_int|0
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_DHUP
suffix:semicolon
id|cmd.arg
op_assign
l_int|0
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_BHUP
suffix:semicolon
id|card-&gt;flags
op_and_assign
op_complement
id|ICN_FLAGS_B2ACTIVE
suffix:semicolon
id|icn_free_queue
c_func
(paren
id|card
comma
l_int|1
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|card-&gt;rcvidx
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cmd.arg
op_assign
l_int|1
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_DHUP
suffix:semicolon
id|cmd.arg
op_assign
l_int|1
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
r_break
suffix:semicolon
)brace
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_static
r_void
DECL|function|icn_putmsg
id|icn_putmsg
c_func
(paren
id|icn_card
op_star
id|card
comma
r_int
r_char
id|c
)paren
(brace
id|ulong
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
op_star
id|card-&gt;msg_buf_write
op_increment
op_assign
(paren
id|c
op_eq
l_int|0xff
)paren
ques
c_cond
l_char|&squot;&bslash;n&squot;
suffix:colon
id|c
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;msg_buf_write
op_eq
id|card-&gt;msg_buf_read
)paren
(brace
r_if
c_cond
(paren
op_increment
id|card-&gt;msg_buf_read
OG
id|card-&gt;msg_buf_end
)paren
id|card-&gt;msg_buf_read
op_assign
id|card-&gt;msg_buf
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;msg_buf_write
OG
id|card-&gt;msg_buf_end
)paren
id|card-&gt;msg_buf_write
op_assign
id|card-&gt;msg_buf
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|icn_polldchan
id|icn_polldchan
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|icn_card
op_star
id|card
op_assign
(paren
id|icn_card
op_star
)paren
id|data
suffix:semicolon
r_int
id|mch
op_assign
id|card-&gt;secondhalf
ques
c_cond
l_int|2
suffix:colon
l_int|0
suffix:semicolon
r_int
id|avail
op_assign
l_int|0
suffix:semicolon
r_int
id|left
suffix:semicolon
id|u_char
id|c
suffix:semicolon
r_int
id|ch
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u_char
op_star
id|p
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
r_if
c_cond
(paren
id|icn_trymaplock_channel
c_func
(paren
id|card
comma
id|mch
)paren
)paren
(brace
id|avail
op_assign
id|msg_avail
suffix:semicolon
r_for
c_loop
(paren
id|left
op_assign
id|avail
comma
id|i
op_assign
id|readb
c_func
(paren
op_amp
id|msg_o
)paren
suffix:semicolon
id|left
OG
l_int|0
suffix:semicolon
id|i
op_increment
comma
id|left
op_decrement
)paren
(brace
id|c
op_assign
id|readb
c_func
(paren
op_amp
id|dev.shmem-&gt;comm_buffers.iopc_buf
(braket
id|i
op_amp
l_int|0xff
)braket
)paren
suffix:semicolon
id|icn_putmsg
c_func
(paren
id|card
comma
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
op_eq
l_int|0xff
)paren
(brace
id|card-&gt;imsg
(braket
id|card-&gt;iptr
)braket
op_assign
l_int|0
suffix:semicolon
id|card-&gt;iptr
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;imsg
(braket
l_int|0
)braket
op_eq
l_char|&squot;0&squot;
op_logical_and
id|card-&gt;imsg
(braket
l_int|1
)braket
op_ge
l_char|&squot;0&squot;
op_logical_and
id|card-&gt;imsg
(braket
l_int|1
)braket
op_le
l_char|&squot;2&squot;
op_logical_and
id|card-&gt;imsg
(braket
l_int|2
)braket
op_eq
l_char|&squot;;&squot;
)paren
(brace
id|ch
op_assign
(paren
id|card-&gt;imsg
(braket
l_int|1
)braket
op_minus
l_char|&squot;0&squot;
)paren
op_minus
l_int|1
suffix:semicolon
id|p
op_assign
op_amp
id|card-&gt;imsg
(braket
l_int|3
)braket
suffix:semicolon
id|icn_parse_status
c_func
(paren
id|p
comma
id|ch
comma
id|card
)paren
suffix:semicolon
)brace
r_else
(brace
id|p
op_assign
id|card-&gt;imsg
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|p
comma
l_string|&quot;DRV1.&quot;
comma
l_int|5
)paren
)paren
(brace
id|u_char
id|vstr
(braket
l_int|10
)braket
suffix:semicolon
id|u_char
op_star
id|q
op_assign
id|vstr
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;icn: (%s) %s&bslash;n&quot;
comma
id|CID
comma
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|p
op_plus
l_int|7
comma
l_string|&quot;TC&quot;
comma
l_int|2
)paren
)paren
(brace
id|card-&gt;ptype
op_assign
id|ISDN_PTYPE_1TR6
suffix:semicolon
id|card-&gt;interface.features
op_or_assign
id|ISDN_FEATURE_P_1TR6
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;icn: (%s) 1TR6-Protocol loaded and running&bslash;n&quot;
comma
id|CID
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|p
op_plus
l_int|7
comma
l_string|&quot;EC&quot;
comma
l_int|2
)paren
)paren
(brace
id|card-&gt;ptype
op_assign
id|ISDN_PTYPE_EURO
suffix:semicolon
id|card-&gt;interface.features
op_or_assign
id|ISDN_FEATURE_P_EURO
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;icn: (%s) Euro-Protocol loaded and running&bslash;n&quot;
comma
id|CID
)paren
suffix:semicolon
)brace
id|p
op_assign
id|strstr
c_func
(paren
id|card-&gt;imsg
comma
l_string|&quot;BRV&quot;
)paren
op_plus
l_int|3
suffix:semicolon
r_while
c_loop
(paren
op_star
id|p
)paren
(brace
r_if
c_cond
(paren
op_star
id|p
op_ge
l_char|&squot;0&squot;
op_logical_and
op_star
id|p
op_le
l_char|&squot;9&squot;
)paren
op_star
id|q
op_increment
op_assign
op_star
id|p
suffix:semicolon
id|p
op_increment
suffix:semicolon
)brace
op_star
id|q
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|strcat
c_func
(paren
id|vstr
comma
l_string|&quot;000&quot;
)paren
suffix:semicolon
id|vstr
(braket
l_int|3
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|card-&gt;fw_rev
op_assign
(paren
r_int
)paren
id|simple_strtoul
c_func
(paren
id|vstr
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|card-&gt;imsg
(braket
id|card-&gt;iptr
)braket
op_assign
id|c
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;iptr
OL
l_int|59
)paren
id|card-&gt;iptr
op_increment
suffix:semicolon
)brace
)brace
id|writeb
c_func
(paren
(paren
id|readb
c_func
(paren
op_amp
id|msg_o
)paren
op_plus
id|avail
)paren
op_amp
l_int|0xff
comma
op_amp
id|msg_o
)paren
suffix:semicolon
id|icn_release_channel
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|avail
)paren
(brace
id|cmd.command
op_assign
id|ISDN_STAT_STAVAIL
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.arg
op_assign
id|avail
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;flags
op_amp
(paren
id|ICN_FLAGS_B1ACTIVE
op_or
id|ICN_FLAGS_B2ACTIVE
)paren
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|card-&gt;flags
op_amp
id|ICN_FLAGS_RBTIMER
)paren
)paren
(brace
multiline_comment|/* schedule b-channel polling */
id|card-&gt;flags
op_or_assign
id|ICN_FLAGS_RBTIMER
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|card-&gt;rb_timer
)paren
suffix:semicolon
id|card-&gt;rb_timer.function
op_assign
id|icn_pollbchan
suffix:semicolon
id|card-&gt;rb_timer.data
op_assign
(paren
r_int
r_int
)paren
id|card
suffix:semicolon
id|card-&gt;rb_timer.expires
op_assign
id|jiffies
op_plus
id|ICN_TIMER_BCREAD
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|card-&gt;rb_timer
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* schedule again */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|card-&gt;st_timer
comma
id|jiffies
op_plus
id|ICN_TIMER_DCREAD
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Append a packet to the transmit buffer-queue.&n; * Parameters:&n; *   channel = Number of B-channel&n; *   skb     = pointer to sk_buff&n; *   card    = pointer to card-struct&n; * Return:&n; *   Number of bytes transferred, -E??? on error&n; */
r_static
r_int
DECL|function|icn_sendbuf
id|icn_sendbuf
c_func
(paren
r_int
id|channel
comma
r_int
id|ack
comma
r_struct
id|sk_buff
op_star
id|skb
comma
id|icn_card
op_star
id|card
)paren
(brace
r_int
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|sk_buff
op_star
id|nskb
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|4000
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;icn: Send packet too large&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|card-&gt;flags
op_amp
(paren
id|channel
)paren
ques
c_cond
id|ICN_FLAGS_B2ACTIVE
suffix:colon
id|ICN_FLAGS_B1ACTIVE
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;sndcount
(braket
id|channel
)braket
OG
id|ICN_MAX_SQUEUE
)paren
r_return
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|nskb
op_assign
id|skb_clone
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nskb
)paren
(brace
multiline_comment|/* Push ACK flag as one&n;&t;&t;&t; * byte in front of data.&n;&t;&t;&t; */
op_star
(paren
id|skb_push
c_func
(paren
id|nskb
comma
l_int|1
)paren
)paren
op_assign
id|ack
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|card-&gt;spqueue
(braket
id|channel
)braket
comma
id|nskb
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
id|len
op_assign
l_int|0
suffix:semicolon
id|card-&gt;sndcount
(braket
id|channel
)braket
op_add_assign
id|len
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; * Check card&squot;s status after starting the bootstrap loader.&n; * On entry, the card&squot;s shared memory has already to be mapped.&n; * Return:&n; *   0 on success (Boot loader ready)&n; *   -EIO on failure (timeout)&n; */
r_static
r_int
DECL|function|icn_check_loader
id|icn_check_loader
c_func
(paren
r_int
id|cardnumber
)paren
(brace
r_int
id|timer
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
macro_line|#ifdef BOOT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Loader %d ?&bslash;n&quot;
comma
id|cardnumber
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|readb
c_func
(paren
op_amp
id|dev.shmem-&gt;data_control.scns
)paren
op_logical_or
id|readb
c_func
(paren
op_amp
id|dev.shmem-&gt;data_control.scnr
)paren
)paren
(brace
r_if
c_cond
(paren
id|timer
op_increment
OG
l_int|5
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;icn: Boot-Loader %d timed out.&bslash;n&quot;
comma
id|cardnumber
)paren
suffix:semicolon
id|icn_release_channel
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
macro_line|#ifdef BOOT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Loader %d TO?&bslash;n&quot;
comma
id|cardnumber
)paren
suffix:semicolon
macro_line|#endif
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|ICN_BOOT_TIMEOUT1
)paren
suffix:semicolon
)brace
r_else
(brace
macro_line|#ifdef BOOT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Loader %d OK&bslash;n&quot;
comma
id|cardnumber
)paren
suffix:semicolon
macro_line|#endif
id|icn_release_channel
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Load the boot-code into the interface-card&squot;s memory and start it.&n; * Always called from user-process.&n; *&n; * Parameters:&n; *            buffer = pointer to packet&n; * Return:&n; *        0 if successfully loaded&n; */
macro_line|#ifdef BOOT_DEBUG
DECL|macro|SLEEP
mdefine_line|#define SLEEP(sec) { &bslash;&n;int slsec = sec; &bslash;&n;  printk(KERN_DEBUG &quot;SLEEP(%d)&bslash;n&quot;,slsec); &bslash;&n;  while (slsec) { &bslash;&n;    current-&gt;state = TASK_INTERRUPTIBLE; &bslash;&n;    schedule_timeout(HZ); &bslash;&n;    slsec--; &bslash;&n;  } &bslash;&n;}
macro_line|#else
DECL|macro|SLEEP
mdefine_line|#define SLEEP(sec)
macro_line|#endif
r_static
r_int
DECL|function|icn_loadboot
id|icn_loadboot
c_func
(paren
id|u_char
op_star
id|buffer
comma
id|icn_card
op_star
id|card
)paren
(brace
r_int
id|ret
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
id|u_char
op_star
id|codebuf
suffix:semicolon
macro_line|#ifdef BOOT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;icn_loadboot called, buffaddr=%08lx&bslash;n&quot;
comma
(paren
id|ulong
)paren
id|buffer
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
(paren
id|codebuf
op_assign
id|kmalloc
c_func
(paren
id|ICN_CODE_STAGE1
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;icn: Could not allocate code buffer&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|copy_from_user
c_func
(paren
id|codebuf
comma
id|buffer
comma
id|ICN_CODE_STAGE1
)paren
)paren
)paren
(brace
id|kfree
c_func
(paren
id|codebuf
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;rvalid
)paren
(brace
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|card-&gt;port
comma
id|ICN_PORTLEN
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;icn: (%s) ports 0x%03x-0x%03x in use.&bslash;n&quot;
comma
id|CID
comma
id|card-&gt;port
comma
id|card-&gt;port
op_plus
id|ICN_PORTLEN
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|codebuf
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|card-&gt;port
comma
id|ICN_PORTLEN
comma
id|card-&gt;regname
)paren
suffix:semicolon
id|card-&gt;rvalid
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;doubleS0
)paren
id|card-&gt;other-&gt;rvalid
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dev.mvalid
)paren
(brace
r_if
c_cond
(paren
id|check_shmem
c_func
(paren
(paren
id|ulong
)paren
id|dev.shmem
comma
l_int|0x4000
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;icn: memory at 0x%08lx in use.&bslash;n&quot;
comma
(paren
id|ulong
)paren
id|dev.shmem
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|request_shmem
c_func
(paren
(paren
id|ulong
)paren
id|dev.shmem
comma
l_int|0x4000
comma
l_string|&quot;icn&quot;
)paren
suffix:semicolon
id|dev.mvalid
op_assign
l_int|1
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|OUTB_P
c_func
(paren
l_int|0
comma
id|ICN_RUN
)paren
suffix:semicolon
multiline_comment|/* Reset Controller */
id|OUTB_P
c_func
(paren
l_int|0
comma
id|ICN_MAPRAM
)paren
suffix:semicolon
multiline_comment|/* Disable RAM      */
id|icn_shiftout
c_func
(paren
id|ICN_CFG
comma
l_int|0x0f
comma
l_int|3
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Windowsize= 16k  */
id|icn_shiftout
c_func
(paren
id|ICN_CFG
comma
(paren
r_int
r_int
)paren
id|dev.shmem
comma
l_int|23
comma
l_int|10
)paren
suffix:semicolon
multiline_comment|/* Set RAM-Addr.    */
macro_line|#ifdef BOOT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;shmem=%08lx&bslash;n&quot;
comma
(paren
id|ulong
)paren
id|dev.shmem
)paren
suffix:semicolon
macro_line|#endif
id|SLEEP
c_func
(paren
l_int|1
)paren
suffix:semicolon
macro_line|#ifdef BOOT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Map Bank 0&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|icn_map_channel
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Select Bank 0    */
id|icn_lock_channel
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Lock Bank 0      */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|SLEEP
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|memcpy_toio
c_func
(paren
id|dev.shmem
comma
id|codebuf
comma
id|ICN_CODE_STAGE1
)paren
suffix:semicolon
multiline_comment|/* Copy code        */
macro_line|#ifdef BOOT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Bootloader transfered&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|card-&gt;doubleS0
)paren
(brace
id|SLEEP
c_func
(paren
l_int|1
)paren
suffix:semicolon
macro_line|#ifdef BOOT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Map Bank 8&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|icn_release_channel
c_func
(paren
)paren
suffix:semicolon
id|icn_map_channel
c_func
(paren
id|card
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Select Bank 8   */
id|icn_lock_channel
c_func
(paren
id|card
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Lock Bank 8     */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|SLEEP
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|memcpy_toio
c_func
(paren
id|dev.shmem
comma
id|codebuf
comma
id|ICN_CODE_STAGE1
)paren
suffix:semicolon
multiline_comment|/* Copy code        */
macro_line|#ifdef BOOT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Bootloader transfered&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
id|kfree
c_func
(paren
id|codebuf
)paren
suffix:semicolon
id|SLEEP
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|OUTB_P
c_func
(paren
l_int|0xff
comma
id|ICN_RUN
)paren
suffix:semicolon
multiline_comment|/* Start Boot-Code */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|icn_check_loader
c_func
(paren
id|card-&gt;doubleS0
ques
c_cond
l_int|2
suffix:colon
l_int|1
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;doubleS0
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* reached only, if we have a Double-S0-Card */
macro_line|#ifdef BOOT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Map Bank 0&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|icn_map_channel
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Select Bank 0   */
id|icn_lock_channel
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Lock Bank 0     */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|SLEEP
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_return
(paren
id|icn_check_loader
c_func
(paren
l_int|1
)paren
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|icn_loadproto
id|icn_loadproto
c_func
(paren
id|u_char
op_star
id|buffer
comma
id|icn_card
op_star
id|card
)paren
(brace
r_register
id|u_char
op_star
id|p
op_assign
id|buffer
suffix:semicolon
id|u_char
id|codebuf
(braket
l_int|256
)braket
suffix:semicolon
id|uint
id|left
op_assign
id|ICN_CODE_STAGE2
suffix:semicolon
id|uint
id|cnt
suffix:semicolon
r_int
id|timer
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#ifdef BOOT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;icn_loadproto called&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|buffer
comma
id|ICN_CODE_STAGE2
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
id|timer
op_assign
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;secondhalf
)paren
(brace
id|icn_map_channel
c_func
(paren
id|card
comma
l_int|2
)paren
suffix:semicolon
id|icn_lock_channel
c_func
(paren
id|card
comma
l_int|2
)paren
suffix:semicolon
)brace
r_else
(brace
id|icn_map_channel
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
id|icn_lock_channel
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|left
)paren
(brace
r_if
c_cond
(paren
id|sbfree
)paren
(brace
multiline_comment|/* If there is a free buffer...  */
id|cnt
op_assign
id|MIN
c_func
(paren
l_int|256
comma
id|left
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|codebuf
comma
id|p
comma
id|cnt
)paren
)paren
(brace
id|icn_maprelease_channel
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|memcpy_toio
c_func
(paren
op_amp
id|sbuf_l
comma
id|codebuf
comma
id|cnt
)paren
suffix:semicolon
multiline_comment|/* copy data                     */
id|sbnext
suffix:semicolon
multiline_comment|/* switch to next buffer         */
id|p
op_add_assign
id|cnt
suffix:semicolon
id|left
op_sub_assign
id|cnt
suffix:semicolon
id|timer
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
macro_line|#ifdef BOOT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;boot 2 !sbfree&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|timer
op_increment
OG
l_int|5
)paren
(brace
id|icn_maprelease_channel
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
)brace
id|writeb
c_func
(paren
l_int|0x20
comma
op_amp
id|sbuf_n
)paren
suffix:semicolon
id|timer
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|readb
c_func
(paren
op_amp
id|cmd_o
)paren
op_logical_or
id|readb
c_func
(paren
op_amp
id|cmd_i
)paren
)paren
(brace
macro_line|#ifdef BOOT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Proto?&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|timer
op_increment
OG
l_int|5
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;icn: (%s) Protocol timed out.&bslash;n&quot;
comma
id|CID
)paren
suffix:semicolon
macro_line|#ifdef BOOT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Proto TO!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|icn_maprelease_channel
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
macro_line|#ifdef BOOT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Proto TO?&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|ICN_BOOT_TIMEOUT1
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|card-&gt;secondhalf
)paren
op_logical_or
(paren
op_logical_neg
id|card-&gt;doubleS0
)paren
)paren
(brace
macro_line|#ifdef BOOT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Proto loaded, install poll-timer %d&bslash;n&quot;
comma
id|card-&gt;secondhalf
)paren
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|card-&gt;st_timer
)paren
suffix:semicolon
id|card-&gt;st_timer.expires
op_assign
id|jiffies
op_plus
id|ICN_TIMER_DCREAD
suffix:semicolon
id|card-&gt;st_timer.function
op_assign
id|icn_polldchan
suffix:semicolon
id|card-&gt;st_timer.data
op_assign
(paren
r_int
r_int
)paren
id|card
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|card-&gt;st_timer
)paren
suffix:semicolon
id|card-&gt;flags
op_or_assign
id|ICN_FLAGS_RUNNING
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;doubleS0
)paren
(brace
id|init_timer
c_func
(paren
op_amp
id|card-&gt;other-&gt;st_timer
)paren
suffix:semicolon
id|card-&gt;other-&gt;st_timer.expires
op_assign
id|jiffies
op_plus
id|ICN_TIMER_DCREAD
suffix:semicolon
id|card-&gt;other-&gt;st_timer.function
op_assign
id|icn_polldchan
suffix:semicolon
id|card-&gt;other-&gt;st_timer.data
op_assign
(paren
r_int
r_int
)paren
id|card-&gt;other
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|card-&gt;other-&gt;st_timer
)paren
suffix:semicolon
id|card-&gt;other-&gt;flags
op_or_assign
id|ICN_FLAGS_RUNNING
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
id|icn_maprelease_channel
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Read the Status-replies from the Interface */
r_static
r_int
DECL|function|icn_readstatus
id|icn_readstatus
c_func
(paren
id|u_char
op_star
id|buf
comma
r_int
id|len
comma
r_int
id|user
comma
id|icn_card
op_star
id|card
)paren
(brace
r_int
id|count
suffix:semicolon
id|u_char
op_star
id|p
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|buf
comma
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
id|len
suffix:semicolon
id|p
op_increment
comma
id|count
op_increment
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;msg_buf_read
op_eq
id|card-&gt;msg_buf_write
)paren
r_return
id|count
suffix:semicolon
r_if
c_cond
(paren
id|user
)paren
id|put_user
c_func
(paren
op_star
id|card-&gt;msg_buf_read
op_increment
comma
id|p
)paren
suffix:semicolon
r_else
op_star
id|p
op_assign
op_star
id|card-&gt;msg_buf_read
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;msg_buf_read
OG
id|card-&gt;msg_buf_end
)paren
id|card-&gt;msg_buf_read
op_assign
id|card-&gt;msg_buf
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/* Put command-strings into the command-queue of the Interface */
r_static
r_int
DECL|function|icn_writecmd
id|icn_writecmd
c_func
(paren
r_const
id|u_char
op_star
id|buf
comma
r_int
id|len
comma
r_int
id|user
comma
id|icn_card
op_star
id|card
)paren
(brace
r_int
id|mch
op_assign
id|card-&gt;secondhalf
ques
c_cond
l_int|2
suffix:colon
l_int|0
suffix:semicolon
r_int
id|avail
suffix:semicolon
r_int
id|pp
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|count
suffix:semicolon
r_int
id|xcount
suffix:semicolon
r_int
id|ocount
suffix:semicolon
r_int
id|loop
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|lastmap_channel
suffix:semicolon
r_struct
id|icn_card
op_star
id|lastmap_card
suffix:semicolon
id|u_char
op_star
id|p
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
id|u_char
id|msg
(braket
l_int|0x100
)braket
suffix:semicolon
id|ocount
op_assign
l_int|1
suffix:semicolon
id|xcount
op_assign
id|loop
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|len
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|lastmap_card
op_assign
id|dev.mcard
suffix:semicolon
id|lastmap_channel
op_assign
id|dev.channel
suffix:semicolon
id|icn_map_channel
c_func
(paren
id|card
comma
id|mch
)paren
suffix:semicolon
id|avail
op_assign
id|cmd_free
suffix:semicolon
id|count
op_assign
id|MIN
c_func
(paren
id|avail
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|user
)paren
id|copy_from_user
c_func
(paren
id|msg
comma
id|buf
comma
id|count
)paren
suffix:semicolon
r_else
id|memcpy
c_func
(paren
id|msg
comma
id|buf
comma
id|count
)paren
suffix:semicolon
id|icn_putmsg
c_func
(paren
id|card
comma
l_char|&squot;&gt;&squot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|msg
comma
id|pp
op_assign
id|readb
c_func
(paren
op_amp
id|cmd_i
)paren
comma
id|i
op_assign
id|count
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
comma
id|p
op_increment
comma
id|pp
op_increment
)paren
(brace
id|writeb
c_func
(paren
(paren
op_star
id|p
op_eq
l_char|&squot;&bslash;n&squot;
)paren
ques
c_cond
l_int|0xff
suffix:colon
op_star
id|p
comma
op_amp
id|dev.shmem-&gt;comm_buffers.pcio_buf
(braket
id|pp
op_amp
l_int|0xff
)braket
)paren
suffix:semicolon
id|len
op_decrement
suffix:semicolon
id|xcount
op_increment
suffix:semicolon
id|icn_putmsg
c_func
(paren
id|card
comma
op_star
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|p
op_eq
l_char|&squot;&bslash;n&squot;
)paren
op_logical_and
(paren
id|i
OG
l_int|1
)paren
)paren
(brace
id|icn_putmsg
c_func
(paren
id|card
comma
l_char|&squot;&gt;&squot;
)paren
suffix:semicolon
id|ocount
op_increment
suffix:semicolon
)brace
id|ocount
op_increment
suffix:semicolon
)brace
id|writeb
c_func
(paren
(paren
id|readb
c_func
(paren
op_amp
id|cmd_i
)paren
op_plus
id|count
)paren
op_amp
l_int|0xff
comma
op_amp
id|cmd_i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lastmap_card
)paren
id|icn_map_channel
c_func
(paren
id|lastmap_card
comma
id|lastmap_channel
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
)paren
(brace
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|loop
op_increment
OG
l_int|20
)paren
r_break
suffix:semicolon
)brace
r_else
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
op_logical_and
(paren
op_logical_neg
id|user
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;icn: writemsg incomplete!&bslash;n&quot;
)paren
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_STAVAIL
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.arg
op_assign
id|ocount
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
r_return
id|xcount
suffix:semicolon
)brace
multiline_comment|/*&n; * Delete card&squot;s pending timers, send STOP to linklevel&n; */
r_static
r_void
DECL|function|icn_stopcard
id|icn_stopcard
c_func
(paren
id|icn_card
op_star
id|card
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;flags
op_amp
id|ICN_FLAGS_RUNNING
)paren
(brace
id|card-&gt;flags
op_and_assign
op_complement
id|ICN_FLAGS_RUNNING
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|card-&gt;st_timer
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|card-&gt;rb_timer
)paren
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_STOP
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;doubleS0
)paren
id|icn_stopcard
c_func
(paren
id|card-&gt;other
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|icn_stopallcards
id|icn_stopallcards
c_func
(paren
r_void
)paren
(brace
id|icn_card
op_star
id|p
op_assign
id|cards
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
id|icn_stopcard
c_func
(paren
id|p
)paren
suffix:semicolon
id|p
op_assign
id|p-&gt;next
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Unmap all cards, because some of them may be mapped accidetly during&n; * autoprobing of some network drivers (SMC-driver?)&n; */
r_static
r_void
DECL|function|icn_disable_cards
id|icn_disable_cards
c_func
(paren
r_void
)paren
(brace
id|icn_card
op_star
id|card
op_assign
id|cards
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|card
)paren
(brace
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|card-&gt;port
comma
id|ICN_PORTLEN
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;icn: (%s) ports 0x%03x-0x%03x in use.&bslash;n&quot;
comma
id|CID
comma
id|card-&gt;port
comma
id|card-&gt;port
op_plus
id|ICN_PORTLEN
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|OUTB_P
c_func
(paren
l_int|0
comma
id|ICN_RUN
)paren
suffix:semicolon
multiline_comment|/* Reset Controller     */
id|OUTB_P
c_func
(paren
l_int|0
comma
id|ICN_MAPRAM
)paren
suffix:semicolon
multiline_comment|/* Disable RAM          */
)brace
id|card
op_assign
id|card-&gt;next
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|icn_command
id|icn_command
c_func
(paren
id|isdn_ctrl
op_star
id|c
comma
id|icn_card
op_star
id|card
)paren
(brace
id|ulong
id|a
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
r_char
id|cbuf
(braket
l_int|60
)braket
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
id|icn_cdef
id|cdef
suffix:semicolon
r_switch
c_cond
(paren
id|c-&gt;command
)paren
(brace
r_case
id|ISDN_CMD_IOCTL
suffix:colon
id|memcpy
c_func
(paren
op_amp
id|a
comma
id|c-&gt;parm.num
comma
r_sizeof
(paren
id|ulong
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|c-&gt;arg
)paren
(brace
r_case
id|ICN_IOCTL_SETMMIO
suffix:colon
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|dev.shmem
op_ne
(paren
id|a
op_amp
l_int|0x0ffc000
)paren
)paren
(brace
r_if
c_cond
(paren
id|check_shmem
c_func
(paren
(paren
id|ulong
)paren
(paren
id|a
op_amp
l_int|0x0ffc000
)paren
comma
l_int|0x4000
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;icn: memory at 0x%08lx in use.&bslash;n&quot;
comma
(paren
id|ulong
)paren
(paren
id|a
op_amp
l_int|0x0ffc000
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|icn_stopallcards
c_func
(paren
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev.mvalid
)paren
id|release_shmem
c_func
(paren
(paren
id|ulong
)paren
id|dev.shmem
comma
l_int|0x4000
)paren
suffix:semicolon
id|dev.mvalid
op_assign
l_int|0
suffix:semicolon
id|dev.shmem
op_assign
(paren
id|icn_shmem
op_star
)paren
(paren
id|a
op_amp
l_int|0x0ffc000
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;icn: (%s) mmio set to 0x%08lx&bslash;n&quot;
comma
id|CID
comma
(paren
r_int
r_int
)paren
id|dev.shmem
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ICN_IOCTL_GETMMIO
suffix:colon
r_return
(paren
r_int
)paren
id|dev.shmem
suffix:semicolon
r_case
id|ICN_IOCTL_SETPORT
suffix:colon
r_if
c_cond
(paren
id|a
op_eq
l_int|0x300
op_logical_or
id|a
op_eq
l_int|0x310
op_logical_or
id|a
op_eq
l_int|0x320
op_logical_or
id|a
op_eq
l_int|0x330
op_logical_or
id|a
op_eq
l_int|0x340
op_logical_or
id|a
op_eq
l_int|0x350
op_logical_or
id|a
op_eq
l_int|0x360
op_logical_or
id|a
op_eq
l_int|0x308
op_logical_or
id|a
op_eq
l_int|0x318
op_logical_or
id|a
op_eq
l_int|0x328
op_logical_or
id|a
op_eq
l_int|0x338
op_logical_or
id|a
op_eq
l_int|0x348
op_logical_or
id|a
op_eq
l_int|0x358
op_logical_or
id|a
op_eq
l_int|0x368
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;port
op_ne
(paren
r_int
r_int
)paren
id|a
)paren
(brace
r_if
c_cond
(paren
id|check_region
c_func
(paren
(paren
r_int
r_int
)paren
id|a
comma
id|ICN_PORTLEN
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;icn: (%s) ports 0x%03x-0x%03x in use.&bslash;n&quot;
comma
id|CID
comma
(paren
r_int
)paren
id|a
comma
(paren
r_int
)paren
id|a
op_plus
id|ICN_PORTLEN
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|icn_stopcard
c_func
(paren
id|card
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;rvalid
)paren
id|release_region
c_func
(paren
id|card-&gt;port
comma
id|ICN_PORTLEN
)paren
suffix:semicolon
id|card-&gt;port
op_assign
(paren
r_int
r_int
)paren
id|a
suffix:semicolon
id|card-&gt;rvalid
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;doubleS0
)paren
(brace
id|card-&gt;other-&gt;port
op_assign
(paren
r_int
r_int
)paren
id|a
suffix:semicolon
id|card-&gt;other-&gt;rvalid
op_assign
l_int|0
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;icn: (%s) port set to 0x%03x&bslash;n&quot;
comma
id|CID
comma
id|card-&gt;port
)paren
suffix:semicolon
)brace
)brace
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICN_IOCTL_GETPORT
suffix:colon
r_return
(paren
r_int
)paren
id|card-&gt;port
suffix:semicolon
r_case
id|ICN_IOCTL_GETDOUBLE
suffix:colon
r_return
(paren
r_int
)paren
id|card-&gt;doubleS0
suffix:semicolon
r_case
id|ICN_IOCTL_DEBUGVAR
suffix:colon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|a
comma
(paren
r_char
op_star
)paren
op_amp
id|card
comma
r_sizeof
(paren
id|ulong
)paren
)paren
)paren
)paren
r_return
id|i
suffix:semicolon
id|a
op_add_assign
r_sizeof
(paren
id|ulong
)paren
suffix:semicolon
(brace
id|ulong
id|l
op_assign
(paren
id|ulong
)paren
op_amp
id|dev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|a
comma
(paren
r_char
op_star
)paren
op_amp
id|l
comma
r_sizeof
(paren
id|ulong
)paren
)paren
)paren
)paren
r_return
id|i
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|ICN_IOCTL_LOADBOOT
suffix:colon
r_if
c_cond
(paren
id|dev.firstload
)paren
(brace
id|icn_disable_cards
c_func
(paren
)paren
suffix:semicolon
id|dev.firstload
op_assign
l_int|0
suffix:semicolon
)brace
id|icn_stopcard
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
(paren
id|icn_loadboot
c_func
(paren
(paren
id|u_char
op_star
)paren
id|a
comma
id|card
)paren
)paren
suffix:semicolon
r_case
id|ICN_IOCTL_LOADPROTO
suffix:colon
id|icn_stopcard
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
(paren
id|icn_loadproto
c_func
(paren
(paren
id|u_char
op_star
)paren
id|a
comma
id|card
)paren
)paren
)paren
)paren
r_return
id|i
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;doubleS0
)paren
id|i
op_assign
id|icn_loadproto
c_func
(paren
(paren
id|u_char
op_star
)paren
(paren
id|a
op_plus
id|ICN_CODE_STAGE2
)paren
comma
id|card-&gt;other
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICN_IOCTL_ADDCARD
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|dev.firstload
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|copy_from_user
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|cdef
comma
(paren
r_char
op_star
)paren
id|a
comma
r_sizeof
(paren
id|cdef
)paren
)paren
)paren
)paren
r_return
id|i
suffix:semicolon
r_return
(paren
id|icn_addcard
c_func
(paren
id|cdef.port
comma
id|cdef.id1
comma
id|cdef.id2
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICN_IOCTL_LEASEDCFG
suffix:colon
r_if
c_cond
(paren
id|a
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;leased
)paren
(brace
id|card-&gt;leased
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|card-&gt;ptype
op_eq
id|ISDN_PTYPE_UNKNOWN
)paren
(brace
id|schedule_timeout
c_func
(paren
id|ICN_BOOT_TIMEOUT1
)paren
suffix:semicolon
)brace
id|schedule_timeout
c_func
(paren
id|ICN_BOOT_TIMEOUT1
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;00;FV2ON&bslash;n01;EAZ%c&bslash;n02;EAZ%c&bslash;n&quot;
comma
(paren
id|a
op_amp
l_int|1
)paren
ques
c_cond
l_char|&squot;1&squot;
suffix:colon
l_char|&squot;C&squot;
comma
(paren
id|a
op_amp
l_int|2
)paren
ques
c_cond
l_char|&squot;2&squot;
suffix:colon
l_char|&squot;C&squot;
)paren
suffix:semicolon
id|i
op_assign
id|icn_writecmd
c_func
(paren
id|cbuf
comma
id|strlen
c_func
(paren
id|cbuf
)paren
comma
l_int|0
comma
id|card
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;icn: (%s) Leased-line mode enabled&bslash;n&quot;
comma
id|CID
)paren
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_RUN
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.arg
op_assign
l_int|0
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|card-&gt;leased
)paren
(brace
id|card-&gt;leased
op_assign
l_int|0
suffix:semicolon
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;00;FV2OFF&bslash;n&quot;
)paren
suffix:semicolon
id|i
op_assign
id|icn_writecmd
c_func
(paren
id|cbuf
comma
id|strlen
c_func
(paren
id|cbuf
)paren
comma
l_int|0
comma
id|card
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;icn: (%s) Leased-line mode disabled&bslash;n&quot;
comma
id|CID
)paren
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_RUN
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.arg
op_assign
l_int|0
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_CMD_DIAL
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ICN_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;leased
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
(paren
id|c-&gt;arg
op_amp
l_int|255
)paren
OL
id|ICN_BCH
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
r_char
id|dial
(braket
l_int|50
)braket
suffix:semicolon
r_char
id|dcode
(braket
l_int|4
)braket
suffix:semicolon
id|a
op_assign
id|c-&gt;arg
suffix:semicolon
id|p
op_assign
id|c-&gt;parm.setup.phone
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
op_eq
l_char|&squot;s&squot;
op_logical_or
op_star
id|p
op_eq
l_char|&squot;S&squot;
)paren
(brace
multiline_comment|/* Dial for SPV */
id|p
op_increment
suffix:semicolon
id|strcpy
c_func
(paren
id|dcode
comma
l_string|&quot;SCA&quot;
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* Normal Dial */
id|strcpy
c_func
(paren
id|dcode
comma
l_string|&quot;CAL&quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|dial
comma
id|p
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;D%s_R%s,%02d,%02d,%s&bslash;n&quot;
comma
(paren
r_int
)paren
(paren
id|a
op_plus
l_int|1
)paren
comma
id|dcode
comma
id|dial
comma
id|c-&gt;parm.setup.si1
comma
id|c-&gt;parm.setup.si2
comma
id|c-&gt;parm.setup.eazmsn
)paren
suffix:semicolon
id|i
op_assign
id|icn_writecmd
c_func
(paren
id|cbuf
comma
id|strlen
c_func
(paren
id|cbuf
)paren
comma
l_int|0
comma
id|card
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_CMD_ACCEPTD
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ICN_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;arg
OL
id|ICN_BCH
)paren
(brace
id|a
op_assign
id|c-&gt;arg
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;fw_rev
op_ge
l_int|300
)paren
(brace
r_switch
c_cond
(paren
id|card-&gt;l2_proto
(braket
id|a
op_minus
l_int|1
)braket
)paren
(brace
r_case
id|ISDN_PROTO_L2_X75I
suffix:colon
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;BX75&bslash;n&quot;
comma
(paren
r_int
)paren
id|a
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_PROTO_L2_HDLC
suffix:colon
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;BTRA&bslash;n&quot;
comma
(paren
r_int
)paren
id|a
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|i
op_assign
id|icn_writecmd
c_func
(paren
id|cbuf
comma
id|strlen
c_func
(paren
id|cbuf
)paren
comma
l_int|0
comma
id|card
)paren
suffix:semicolon
)brace
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;DCON_R&bslash;n&quot;
comma
(paren
r_int
)paren
id|a
)paren
suffix:semicolon
id|i
op_assign
id|icn_writecmd
c_func
(paren
id|cbuf
comma
id|strlen
c_func
(paren
id|cbuf
)paren
comma
l_int|0
comma
id|card
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_CMD_ACCEPTB
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ICN_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;arg
OL
id|ICN_BCH
)paren
(brace
id|a
op_assign
id|c-&gt;arg
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;fw_rev
op_ge
l_int|300
)paren
r_switch
c_cond
(paren
id|card-&gt;l2_proto
(braket
id|a
op_minus
l_int|1
)braket
)paren
(brace
r_case
id|ISDN_PROTO_L2_X75I
suffix:colon
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;BCON_R,BX75&bslash;n&quot;
comma
(paren
r_int
)paren
id|a
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_PROTO_L2_HDLC
suffix:colon
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;BCON_R,BTRA&bslash;n&quot;
comma
(paren
r_int
)paren
id|a
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;BCON_R&bslash;n&quot;
comma
(paren
r_int
)paren
id|a
)paren
suffix:semicolon
id|i
op_assign
id|icn_writecmd
c_func
(paren
id|cbuf
comma
id|strlen
c_func
(paren
id|cbuf
)paren
comma
l_int|0
comma
id|card
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_CMD_HANGUP
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ICN_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;arg
OL
id|ICN_BCH
)paren
(brace
id|a
op_assign
id|c-&gt;arg
op_plus
l_int|1
suffix:semicolon
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;BDIS_R&bslash;n%02d;DDIS_R&bslash;n&quot;
comma
(paren
r_int
)paren
id|a
comma
(paren
r_int
)paren
id|a
)paren
suffix:semicolon
id|i
op_assign
id|icn_writecmd
c_func
(paren
id|cbuf
comma
id|strlen
c_func
(paren
id|cbuf
)paren
comma
l_int|0
comma
id|card
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_CMD_SETEAZ
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ICN_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;leased
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;arg
OL
id|ICN_BCH
)paren
(brace
id|a
op_assign
id|c-&gt;arg
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;ptype
op_eq
id|ISDN_PTYPE_EURO
)paren
(brace
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;MS%s%s&bslash;n&quot;
comma
(paren
r_int
)paren
id|a
comma
id|c-&gt;parm.num
(braket
l_int|0
)braket
ques
c_cond
l_string|&quot;N&quot;
suffix:colon
l_string|&quot;ALL&quot;
comma
id|c-&gt;parm.num
)paren
suffix:semicolon
)brace
r_else
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;EAZ%s&bslash;n&quot;
comma
(paren
r_int
)paren
id|a
comma
id|c-&gt;parm.num
(braket
l_int|0
)braket
ques
c_cond
(paren
r_char
op_star
)paren
(paren
id|c-&gt;parm.num
)paren
suffix:colon
l_string|&quot;0123456789&quot;
)paren
suffix:semicolon
id|i
op_assign
id|icn_writecmd
c_func
(paren
id|cbuf
comma
id|strlen
c_func
(paren
id|cbuf
)paren
comma
l_int|0
comma
id|card
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_CMD_CLREAZ
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ICN_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;leased
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;arg
OL
id|ICN_BCH
)paren
(brace
id|a
op_assign
id|c-&gt;arg
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;ptype
op_eq
id|ISDN_PTYPE_EURO
)paren
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;MSNC&bslash;n&quot;
comma
(paren
r_int
)paren
id|a
)paren
suffix:semicolon
r_else
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;EAZC&bslash;n&quot;
comma
(paren
r_int
)paren
id|a
)paren
suffix:semicolon
id|i
op_assign
id|icn_writecmd
c_func
(paren
id|cbuf
comma
id|strlen
c_func
(paren
id|cbuf
)paren
comma
l_int|0
comma
id|card
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_CMD_SETL2
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ICN_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
(paren
id|c-&gt;arg
op_amp
l_int|255
)paren
OL
id|ICN_BCH
)paren
(brace
id|a
op_assign
id|c-&gt;arg
suffix:semicolon
r_switch
c_cond
(paren
id|a
op_rshift
l_int|8
)paren
(brace
r_case
id|ISDN_PROTO_L2_X75I
suffix:colon
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;BX75&bslash;n&quot;
comma
(paren
r_int
)paren
(paren
id|a
op_amp
l_int|255
)paren
op_plus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_PROTO_L2_HDLC
suffix:colon
id|sprintf
c_func
(paren
id|cbuf
comma
l_string|&quot;%02d;BTRA&bslash;n&quot;
comma
(paren
r_int
)paren
(paren
id|a
op_amp
l_int|255
)paren
op_plus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|i
op_assign
id|icn_writecmd
c_func
(paren
id|cbuf
comma
id|strlen
c_func
(paren
id|cbuf
)paren
comma
l_int|0
comma
id|card
)paren
suffix:semicolon
id|card-&gt;l2_proto
(braket
id|a
op_amp
l_int|255
)braket
op_assign
(paren
id|a
op_rshift
l_int|8
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_CMD_GETL2
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ICN_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
(paren
id|c-&gt;arg
op_amp
l_int|255
)paren
OL
id|ICN_BCH
)paren
r_return
id|card-&gt;l2_proto
(braket
id|c-&gt;arg
op_amp
l_int|255
)braket
suffix:semicolon
r_else
r_return
op_minus
id|ENODEV
suffix:semicolon
r_case
id|ISDN_CMD_SETL3
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ICN_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ISDN_CMD_GETL3
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ICN_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
(paren
id|c-&gt;arg
op_amp
l_int|255
)paren
OL
id|ICN_BCH
)paren
r_return
id|ISDN_PROTO_L3_TRANS
suffix:semicolon
r_else
r_return
op_minus
id|ENODEV
suffix:semicolon
r_case
id|ISDN_CMD_GETEAZ
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ICN_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_CMD_SETSIL
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ICN_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_CMD_GETSIL
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ICN_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_CMD_LOCK
suffix:colon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_CMD_UNLOCK
suffix:colon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Find card with given driverId&n; */
r_static
r_inline
id|icn_card
op_star
DECL|function|icn_findcard
id|icn_findcard
c_func
(paren
r_int
id|driverid
)paren
(brace
id|icn_card
op_star
id|p
op_assign
id|cards
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;myid
op_eq
id|driverid
)paren
r_return
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
suffix:semicolon
)brace
r_return
(paren
id|icn_card
op_star
)paren
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Wrapper functions for interface to linklevel&n; */
r_static
r_int
DECL|function|if_command
id|if_command
c_func
(paren
id|isdn_ctrl
op_star
id|c
)paren
(brace
id|icn_card
op_star
id|card
op_assign
id|icn_findcard
c_func
(paren
id|c-&gt;driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card
)paren
r_return
(paren
id|icn_command
c_func
(paren
id|c
comma
id|card
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;icn: if_command %d called with invalid driverId %d!&bslash;n&quot;
comma
id|c-&gt;command
comma
id|c-&gt;driver
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_static
r_int
DECL|function|if_writecmd
id|if_writecmd
c_func
(paren
r_const
id|u_char
op_star
id|buf
comma
r_int
id|len
comma
r_int
id|user
comma
r_int
id|id
comma
r_int
id|channel
)paren
(brace
id|icn_card
op_star
id|card
op_assign
id|icn_findcard
c_func
(paren
id|id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ICN_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
(paren
id|icn_writecmd
c_func
(paren
id|buf
comma
id|len
comma
id|user
comma
id|card
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;icn: if_writecmd called with invalid driverId!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_static
r_int
DECL|function|if_readstatus
id|if_readstatus
c_func
(paren
id|u_char
op_star
id|buf
comma
r_int
id|len
comma
r_int
id|user
comma
r_int
id|id
comma
r_int
id|channel
)paren
(brace
id|icn_card
op_star
id|card
op_assign
id|icn_findcard
c_func
(paren
id|id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ICN_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
(paren
id|icn_readstatus
c_func
(paren
id|buf
comma
id|len
comma
id|user
comma
id|card
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;icn: if_readstatus called with invalid driverId!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_static
r_int
DECL|function|if_sendbuf
id|if_sendbuf
c_func
(paren
r_int
id|id
comma
r_int
id|channel
comma
r_int
id|ack
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|icn_card
op_star
id|card
op_assign
id|icn_findcard
c_func
(paren
id|id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;flags
op_amp
id|ICN_FLAGS_RUNNING
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
(paren
id|icn_sendbuf
c_func
(paren
id|channel
comma
id|ack
comma
id|skb
comma
id|card
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;icn: if_sendbuf called with invalid driverId!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n; * Allocate a new card-struct, initialize it&n; * link it into cards-list and register it at linklevel.&n; */
r_static
id|icn_card
op_star
DECL|function|icn_initcard
id|icn_initcard
c_func
(paren
r_int
id|port
comma
r_char
op_star
id|id
)paren
(brace
id|icn_card
op_star
id|card
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|card
op_assign
(paren
id|icn_card
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|icn_card
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;icn: (%s) Could not allocate card-struct.&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
r_return
(paren
id|icn_card
op_star
)paren
l_int|0
suffix:semicolon
)brace
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|card
comma
l_int|0
comma
r_sizeof
(paren
id|icn_card
)paren
)paren
suffix:semicolon
id|card-&gt;port
op_assign
id|port
suffix:semicolon
id|card-&gt;interface.hl_hdrlen
op_assign
l_int|1
suffix:semicolon
id|card-&gt;interface.channels
op_assign
id|ICN_BCH
suffix:semicolon
id|card-&gt;interface.maxbufsize
op_assign
l_int|4000
suffix:semicolon
id|card-&gt;interface.command
op_assign
id|if_command
suffix:semicolon
id|card-&gt;interface.writebuf_skb
op_assign
id|if_sendbuf
suffix:semicolon
id|card-&gt;interface.writecmd
op_assign
id|if_writecmd
suffix:semicolon
id|card-&gt;interface.readstat
op_assign
id|if_readstatus
suffix:semicolon
id|card-&gt;interface.features
op_assign
id|ISDN_FEATURE_L2_X75I
op_or
id|ISDN_FEATURE_L2_HDLC
op_or
id|ISDN_FEATURE_L3_TRANS
op_or
id|ISDN_FEATURE_P_UNKNOWN
suffix:semicolon
id|card-&gt;ptype
op_assign
id|ISDN_PTYPE_UNKNOWN
suffix:semicolon
id|strncpy
c_func
(paren
id|card-&gt;interface.id
comma
id|id
comma
r_sizeof
(paren
id|card-&gt;interface.id
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|card-&gt;msg_buf_write
op_assign
id|card-&gt;msg_buf
suffix:semicolon
id|card-&gt;msg_buf_read
op_assign
id|card-&gt;msg_buf
suffix:semicolon
id|card-&gt;msg_buf_end
op_assign
op_amp
id|card-&gt;msg_buf
(braket
r_sizeof
(paren
id|card-&gt;msg_buf
)paren
op_minus
l_int|1
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ICN_BCH
suffix:semicolon
id|i
op_increment
)paren
(brace
id|card-&gt;l2_proto
(braket
id|i
)braket
op_assign
id|ISDN_PROTO_L2_X75I
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|card-&gt;spqueue
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|card-&gt;next
op_assign
id|cards
suffix:semicolon
id|cards
op_assign
id|card
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|register_isdn
c_func
(paren
op_amp
id|card-&gt;interface
)paren
)paren
(brace
id|cards
op_assign
id|cards-&gt;next
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;icn: Unable to register %s&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
(paren
id|icn_card
op_star
)paren
l_int|0
suffix:semicolon
)brace
id|card-&gt;myid
op_assign
id|card-&gt;interface.channels
suffix:semicolon
id|sprintf
c_func
(paren
id|card-&gt;regname
comma
l_string|&quot;icn-isdn (%s)&quot;
comma
id|card-&gt;interface.id
)paren
suffix:semicolon
r_return
id|card
suffix:semicolon
)brace
r_static
r_int
DECL|function|icn_addcard
id|icn_addcard
c_func
(paren
r_int
id|port
comma
r_char
op_star
id|id1
comma
r_char
op_star
id|id2
)paren
(brace
id|ulong
id|flags
suffix:semicolon
id|icn_card
op_star
id|card
suffix:semicolon
id|icn_card
op_star
id|card2
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|card
op_assign
id|icn_initcard
c_func
(paren
id|port
comma
id|id1
)paren
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strlen
c_func
(paren
id|id2
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;icn: (%s) ICN-2B, port 0x%x added&bslash;n&quot;
comma
id|card-&gt;interface.id
comma
id|port
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|card2
op_assign
id|icn_initcard
c_func
(paren
id|port
comma
id|id2
)paren
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;icn: (%s) half ICN-4B, port 0x%x added&bslash;n&quot;
comma
id|card2-&gt;interface.id
comma
id|port
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|card-&gt;doubleS0
op_assign
l_int|1
suffix:semicolon
id|card-&gt;secondhalf
op_assign
l_int|0
suffix:semicolon
id|card-&gt;other
op_assign
id|card2
suffix:semicolon
id|card2-&gt;doubleS0
op_assign
l_int|1
suffix:semicolon
id|card2-&gt;secondhalf
op_assign
l_int|1
suffix:semicolon
id|card2-&gt;other
op_assign
id|card
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;icn: (%s and %s) ICN-4B, port 0x%x added&bslash;n&quot;
comma
id|card-&gt;interface.id
comma
id|card2-&gt;interface.id
comma
id|port
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|macro|icn_init
mdefine_line|#define icn_init init_module
macro_line|#else
macro_line|#include &lt;linux/init.h&gt;
r_static
r_int
id|__init
DECL|function|icn_setup
id|icn_setup
c_func
(paren
r_char
op_star
id|line
)paren
(brace
r_char
op_star
id|p
comma
op_star
id|str
suffix:semicolon
r_int
id|ints
(braket
l_int|3
)braket
suffix:semicolon
r_static
r_char
id|sid
(braket
l_int|20
)braket
suffix:semicolon
r_static
r_char
id|sid2
(braket
l_int|20
)braket
suffix:semicolon
id|str
op_assign
id|get_options
c_func
(paren
id|line
comma
l_int|2
comma
id|ints
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
)paren
id|portbase
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
OG
l_int|1
)paren
id|membase
op_assign
id|ints
(braket
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|str
op_logical_and
op_star
id|str
)paren
(brace
id|strcpy
c_func
(paren
id|sid
comma
id|str
)paren
suffix:semicolon
id|icn_id
op_assign
id|sid
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
op_assign
id|strchr
c_func
(paren
id|sid
comma
l_char|&squot;,&squot;
)paren
)paren
)paren
(brace
op_star
id|p
op_increment
op_assign
l_int|0
suffix:semicolon
id|strcpy
c_func
(paren
id|sid2
comma
id|p
)paren
suffix:semicolon
id|icn_id2
op_assign
id|sid2
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;icn=&quot;
comma
id|icn_setup
)paren
suffix:semicolon
macro_line|#endif /* MODULES */
r_int
DECL|function|icn_init
id|icn_init
c_func
(paren
r_void
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
r_char
id|rev
(braket
l_int|10
)braket
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|dev
comma
l_int|0
comma
r_sizeof
(paren
id|icn_dev
)paren
)paren
suffix:semicolon
id|dev.shmem
op_assign
(paren
id|icn_shmem
op_star
)paren
(paren
(paren
r_int
r_int
)paren
id|membase
op_amp
l_int|0x0ffc000
)paren
suffix:semicolon
id|dev.channel
op_assign
op_minus
l_int|1
suffix:semicolon
id|dev.mcard
op_assign
l_int|NULL
suffix:semicolon
id|dev.firstload
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* No symbols to export, hide all symbols */
id|EXPORT_NO_SYMBOLS
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
op_assign
id|strchr
c_func
(paren
id|revision
comma
l_char|&squot;:&squot;
)paren
)paren
)paren
(brace
id|strcpy
c_func
(paren
id|rev
comma
id|p
op_plus
l_int|1
)paren
suffix:semicolon
id|p
op_assign
id|strchr
c_func
(paren
id|rev
comma
l_char|&squot;$&squot;
)paren
suffix:semicolon
op_star
id|p
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|strcpy
c_func
(paren
id|rev
comma
l_string|&quot; ??? &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;ICN-ISDN-driver Rev%smem=0x%08lx&bslash;n&quot;
comma
id|rev
comma
(paren
id|ulong
)paren
id|dev.shmem
)paren
suffix:semicolon
r_return
(paren
id|icn_addcard
c_func
(paren
id|portbase
comma
id|icn_id
comma
id|icn_id2
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
r_void
DECL|function|cleanup_module
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|isdn_ctrl
id|cmd
suffix:semicolon
id|icn_card
op_star
id|card
op_assign
id|cards
suffix:semicolon
id|icn_card
op_star
id|last
suffix:semicolon
r_int
id|i
suffix:semicolon
id|icn_stopallcards
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|card
)paren
(brace
id|cmd.command
op_assign
id|ISDN_STAT_UNLOAD
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;rvalid
)paren
(brace
id|OUTB_P
c_func
(paren
l_int|0
comma
id|ICN_RUN
)paren
suffix:semicolon
multiline_comment|/* Reset Controller     */
id|OUTB_P
c_func
(paren
l_int|0
comma
id|ICN_MAPRAM
)paren
suffix:semicolon
multiline_comment|/* Disable RAM          */
r_if
c_cond
(paren
id|card-&gt;secondhalf
op_logical_or
(paren
op_logical_neg
id|card-&gt;doubleS0
)paren
)paren
(brace
id|release_region
c_func
(paren
id|card-&gt;port
comma
id|ICN_PORTLEN
)paren
suffix:semicolon
id|card-&gt;rvalid
op_assign
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ICN_BCH
suffix:semicolon
id|i
op_increment
)paren
id|icn_free_queue
c_func
(paren
id|card
comma
id|i
)paren
suffix:semicolon
)brace
id|card
op_assign
id|card-&gt;next
suffix:semicolon
)brace
id|card
op_assign
id|cards
suffix:semicolon
r_while
c_loop
(paren
id|card
)paren
(brace
id|last
op_assign
id|card
suffix:semicolon
id|card
op_assign
id|card-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|last
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev.mvalid
)paren
id|release_shmem
c_func
(paren
(paren
id|ulong
)paren
id|dev.shmem
comma
l_int|0x4000
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;ICN-ISDN-driver unloaded&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
