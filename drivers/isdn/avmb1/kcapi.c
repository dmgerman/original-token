multiline_comment|/*&n; * $Id: kcapi.c,v 1.21.6.1 2000/12/10 23:39:19 kai Exp $&n; * &n; * Kernel CAPI 2.0 Module&n; * &n; * (c) Copyright 1999 by Carsten Paeth (calle@calle.in-berlin.de)&n; * &n; * $Log: kcapi.c,v $&n; * Revision 1.21.6.1  2000/12/10 23:39:19  kai&n; * in 2.4 we don&squot;t have tq_scheduler anymore.&n; * also add one supported card to hfc_pci.c&n; * (from main branch)&n; *&n; * Revision 1.21  2000/11/23 20:45:14  kai&n; * fixed module_init/exit stuff&n; * Note: compiled-in kernel doesn&squot;t work pre 2.2.18 anymore.&n; *&n; * Revision 1.20  2000/11/19 17:01:53  kai&n; * compatibility cleanup - part 2&n; *&n; * Revision 1.19  2000/11/01 14:05:02  calle&n; * - use module_init/module_exit from linux/init.h.&n; * - all static struct variables are initialized with &quot;membername:&quot; now.&n; * - avm_cs.c, let it work with newer pcmcia-cs.&n; *&n; * Revision 1.18  2000/07/20 10:22:27  calle&n; * - Made procfs function cleaner and removed variable &quot;begin&quot;.&n; *&n; * Revision 1.17  2000/04/21 13:00:56  calle&n; * Bugfix: driver_proc_info was also wrong.&n; *&n; * Revision 1.16  2000/04/21 12:38:42  calle&n; * Bugfix: error in proc_ functions, begin-off =&gt; off-begin&n; *&n; * Revision 1.15  2000/04/06 15:01:25  calle&n; * Bugfix: crash in capidrv.c when reseting a capi controller.&n; * - changed code order on remove of controller.&n; * - using tq_schedule for notifier in kcapi.c.&n; * - now using spin_lock_irqsave() and spin_unlock_irqrestore().&n; * strange: sometimes even MP hang on unload of isdn.o ...&n; *&n; * Revision 1.14  2000/04/03 13:29:25  calle&n; * make Tim Waugh happy (module unload races in 2.3.99-pre3).&n; * no real problem there, but now it is much cleaner ...&n; *&n; * Revision 1.13  2000/03/03 15:50:42  calle&n; * - kernel CAPI:&n; *   - Changed parameter &quot;param&quot; in capi_signal from __u32 to void *.&n; *   - rewrote notifier handling in kcapi.c&n; *   - new notifier NCCI_UP and NCCI_DOWN&n; * - User CAPI:&n; *   - /dev/capi20 is now a cloning device.&n; *   - middleware extentions prepared.&n; * - capidrv.c&n; *   - locking of list operations and module count updates.&n; *&n; * Revision 1.12  2000/01/28 16:45:39  calle&n; * new manufacturer command KCAPI_CMD_ADDCARD (generic addcard),&n; * will search named driver and call the add_card function if one exist.&n; *&n; * Revision 1.11  1999/11/23 13:29:29  calle&n; * Bugfix: incoming capi message were never traced.&n; *&n; * Revision 1.10  1999/10/26 15:30:32  calle&n; * Generate error message if user want to add card, but driver module is&n; * not loaded.&n; *&n; * Revision 1.9  1999/10/11 22:04:12  keil&n; * COMPAT_NEED_UACCESS (no include in isdn_compat.h)&n; *&n; * Revision 1.8  1999/09/10 17:24:18  calle&n; * Changes for proposed standard for CAPI2.0:&n; * - AK148 &quot;Linux Exention&quot;&n; *&n; * Revision 1.7  1999/09/04 06:20:05  keil&n; * Changes from kernel set_current_state()&n; *&n; * Revision 1.6  1999/07/20 06:41:49  calle&n; * Bugfix: After the redesign of the AVM B1 driver, the driver didn&squot;t even&n; *         compile, if not selected as modules.&n; *&n; * Revision 1.5  1999/07/09 15:05:48  keil&n; * compat.h is now isdn_compat.h&n; *&n; * Revision 1.4  1999/07/08 14:15:17  calle&n; * Forgot to count down ncards in drivercb_detach_ctr.&n; *&n; * Revision 1.3  1999/07/06 07:42:02  calle&n; * - changes in /proc interface&n; * - check and changed calls to [dev_]kfree_skb and [dev_]alloc_skb.&n; *&n; * Revision 1.2  1999/07/05 15:09:52  calle&n; * - renamed &quot;appl_release&quot; to &quot;appl_released&quot;.&n; * - version und profile data now cleared on controller reset&n; * - extended /proc interface, to allow driver and controller specific&n; *   informations to include by driver hackers.&n; *&n; * Revision 1.1  1999/07/01 15:26:42  calle&n; * complete new version (I love it):&n; * + new hardware independed &quot;capi_driver&quot; interface that will make it easy to:&n; *   - support other controllers with CAPI-2.0 (i.e. USB Controller)&n; *   - write a CAPI-2.0 for the passive cards&n; *   - support serial link CAPI-2.0 boxes.&n; * + wrote &quot;capi_driver&quot; for all supported cards.&n; * + &quot;capi_driver&quot; (supported cards) now have to be configured with&n; *   make menuconfig, in the past all supported cards where included&n; *   at once.&n; * + new and better informations in /proc/capi/&n; * + new ioctl to switch trace of capi messages per controller&n; *   using &quot;avmcapictrl trace [contr] on|off|....&quot;&n; * + complete testcircle with all supported cards and also the&n; *   PCMCIA cards (now patch for pcmcia-cs-3.0.13 needed) done.&n; *&n; */
DECL|macro|CONFIG_AVMB1_COMPAT
mdefine_line|#define CONFIG_AVMB1_COMPAT
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/tqueue.h&gt;
macro_line|#include &lt;linux/capi.h&gt;
macro_line|#include &lt;linux/kernelcapi.h&gt;
macro_line|#include &lt;linux/locks.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &quot;capicmd.h&quot;
macro_line|#include &quot;capiutil.h&quot;
macro_line|#include &quot;capilli.h&quot;
macro_line|#ifdef CONFIG_AVMB1_COMPAT
macro_line|#include &lt;linux/b1lli.h&gt;
macro_line|#endif
DECL|variable|revision
r_static
r_char
op_star
id|revision
op_assign
l_string|&quot;$Revision: 1.21.6.1 $&quot;
suffix:semicolon
multiline_comment|/* ------------------------------------------------------------- */
DECL|macro|CARD_FREE
mdefine_line|#define CARD_FREE&t;0
DECL|macro|CARD_DETECTED
mdefine_line|#define CARD_DETECTED&t;1
DECL|macro|CARD_LOADING
mdefine_line|#define CARD_LOADING&t;2
DECL|macro|CARD_RUNNING
mdefine_line|#define CARD_RUNNING&t;3
multiline_comment|/* ------------------------------------------------------------- */
DECL|variable|showcapimsgs
r_int
id|showcapimsgs
op_assign
l_int|0
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Carsten Paeth &lt;calle@calle.in-berlin.de&gt;&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|showcapimsgs
comma
l_string|&quot;0-4i&quot;
)paren
suffix:semicolon
multiline_comment|/* ------------------------------------------------------------- */
DECL|struct|msgidqueue
r_struct
id|msgidqueue
(brace
DECL|member|next
r_struct
id|msgidqueue
op_star
id|next
suffix:semicolon
DECL|member|msgid
id|__u16
id|msgid
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|capi_ncci
r_struct
id|capi_ncci
(brace
DECL|member|next
r_struct
id|capi_ncci
op_star
id|next
suffix:semicolon
DECL|member|applid
id|__u16
id|applid
suffix:semicolon
DECL|member|ncci
id|__u32
id|ncci
suffix:semicolon
DECL|member|winsize
id|__u32
id|winsize
suffix:semicolon
DECL|member|nmsg
r_int
id|nmsg
suffix:semicolon
DECL|member|msgidqueue
r_struct
id|msgidqueue
op_star
id|msgidqueue
suffix:semicolon
DECL|member|msgidlast
r_struct
id|msgidqueue
op_star
id|msgidlast
suffix:semicolon
DECL|member|msgidfree
r_struct
id|msgidqueue
op_star
id|msgidfree
suffix:semicolon
DECL|member|msgidpool
r_struct
id|msgidqueue
id|msgidpool
(braket
id|CAPI_MAXDATAWINDOW
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|capi_appl
r_struct
id|capi_appl
(brace
DECL|member|applid
id|__u16
id|applid
suffix:semicolon
DECL|member|rparam
id|capi_register_params
id|rparam
suffix:semicolon
DECL|member|releasing
r_int
id|releasing
suffix:semicolon
DECL|member|param
r_void
op_star
id|param
suffix:semicolon
DECL|member|signal
r_void
(paren
op_star
id|signal
)paren
(paren
id|__u16
id|applid
comma
r_void
op_star
id|param
)paren
suffix:semicolon
DECL|member|recv_queue
r_struct
id|sk_buff_head
id|recv_queue
suffix:semicolon
DECL|member|nncci
r_int
id|nncci
suffix:semicolon
DECL|member|nccilist
r_struct
id|capi_ncci
op_star
id|nccilist
suffix:semicolon
DECL|member|nrecvctlpkt
r_int
r_int
id|nrecvctlpkt
suffix:semicolon
DECL|member|nrecvdatapkt
r_int
r_int
id|nrecvdatapkt
suffix:semicolon
DECL|member|nsentctlpkt
r_int
r_int
id|nsentctlpkt
suffix:semicolon
DECL|member|nsentdatapkt
r_int
r_int
id|nsentdatapkt
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|capi_notifier
r_struct
id|capi_notifier
(brace
DECL|member|next
r_struct
id|capi_notifier
op_star
id|next
suffix:semicolon
DECL|member|cmd
r_int
r_int
id|cmd
suffix:semicolon
DECL|member|controller
id|__u32
id|controller
suffix:semicolon
DECL|member|applid
id|__u16
id|applid
suffix:semicolon
DECL|member|ncci
id|__u32
id|ncci
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* ------------------------------------------------------------- */
DECL|variable|driver_version
r_static
r_struct
id|capi_version
id|driver_version
op_assign
(brace
l_int|2
comma
l_int|0
comma
l_int|1
comma
l_int|1
op_lshift
l_int|4
)brace
suffix:semicolon
DECL|variable|driver_serial
r_static
r_char
id|driver_serial
(braket
id|CAPI_SERIAL_LEN
)braket
op_assign
l_string|&quot;0004711&quot;
suffix:semicolon
DECL|variable|capi_manufakturer
r_static
r_char
id|capi_manufakturer
(braket
l_int|64
)braket
op_assign
l_string|&quot;AVM Berlin&quot;
suffix:semicolon
DECL|macro|APPL
mdefine_line|#define APPL(a)&t;&t;   (&amp;applications[(a)-1])
DECL|macro|VALID_APPLID
mdefine_line|#define&t;VALID_APPLID(a)&t;   ((a) &amp;&amp; (a) &lt;= CAPI_MAXAPPL &amp;&amp; APPL(a)-&gt;applid == a)
DECL|macro|APPL_IS_FREE
mdefine_line|#define APPL_IS_FREE(a)    (APPL(a)-&gt;applid == 0)
DECL|macro|APPL_MARK_FREE
mdefine_line|#define APPL_MARK_FREE(a)  do{ APPL(a)-&gt;applid=0; MOD_DEC_USE_COUNT; }while(0);
DECL|macro|APPL_MARK_USED
mdefine_line|#define APPL_MARK_USED(a)  do{ APPL(a)-&gt;applid=(a); MOD_INC_USE_COUNT; }while(0);
DECL|macro|NCCI2CTRL
mdefine_line|#define NCCI2CTRL(ncci)    (((ncci) &gt;&gt; 24) &amp; 0x7f)
DECL|macro|VALID_CARD
mdefine_line|#define VALID_CARD(c)&t;   ((c) &gt; 0 &amp;&amp; (c) &lt;= CAPI_MAXCONTR)
DECL|macro|CARD
mdefine_line|#define CARD(c)&t;&t;   (&amp;cards[(c)-1])
DECL|macro|CARDNR
mdefine_line|#define CARDNR(cp)&t;   (((cp)-cards)+1)
DECL|variable|applications
r_static
r_struct
id|capi_appl
id|applications
(braket
id|CAPI_MAXAPPL
)braket
suffix:semicolon
DECL|variable|cards
r_static
r_struct
id|capi_ctr
id|cards
(braket
id|CAPI_MAXCONTR
)braket
suffix:semicolon
DECL|variable|ncards
r_static
r_int
id|ncards
op_assign
l_int|0
suffix:semicolon
DECL|variable|recv_queue
r_static
r_struct
id|sk_buff_head
id|recv_queue
suffix:semicolon
DECL|variable|capi_users
r_static
r_struct
id|capi_interface_user
op_star
id|capi_users
op_assign
l_int|0
suffix:semicolon
DECL|variable|capi_users_lock
r_static
id|spinlock_t
id|capi_users_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|drivers
r_static
r_struct
id|capi_driver
op_star
id|drivers
suffix:semicolon
DECL|variable|drivers_lock
r_static
id|spinlock_t
id|drivers_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|tq_state_notify
r_static
r_struct
id|tq_struct
id|tq_state_notify
suffix:semicolon
DECL|variable|tq_recv_notify
r_static
r_struct
id|tq_struct
id|tq_recv_notify
suffix:semicolon
multiline_comment|/* -------- util functions ------------------------------------ */
DECL|function|cardstate2str
r_static
r_char
op_star
id|cardstate2str
c_func
(paren
r_int
r_int
id|cardstate
)paren
(brace
r_switch
c_cond
(paren
id|cardstate
)paren
(brace
r_default
suffix:colon
r_case
id|CARD_FREE
suffix:colon
r_return
l_string|&quot;free&quot;
suffix:semicolon
r_case
id|CARD_DETECTED
suffix:colon
r_return
l_string|&quot;detected&quot;
suffix:semicolon
r_case
id|CARD_LOADING
suffix:colon
r_return
l_string|&quot;loading&quot;
suffix:semicolon
r_case
id|CARD_RUNNING
suffix:colon
r_return
l_string|&quot;running&quot;
suffix:semicolon
)brace
)brace
DECL|function|capi_cmd_valid
r_static
r_inline
r_int
id|capi_cmd_valid
c_func
(paren
id|__u8
id|cmd
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|CAPI_ALERT
suffix:colon
r_case
id|CAPI_CONNECT
suffix:colon
r_case
id|CAPI_CONNECT_ACTIVE
suffix:colon
r_case
id|CAPI_CONNECT_B3_ACTIVE
suffix:colon
r_case
id|CAPI_CONNECT_B3
suffix:colon
r_case
id|CAPI_CONNECT_B3_T90_ACTIVE
suffix:colon
r_case
id|CAPI_DATA_B3
suffix:colon
r_case
id|CAPI_DISCONNECT_B3
suffix:colon
r_case
id|CAPI_DISCONNECT
suffix:colon
r_case
id|CAPI_FACILITY
suffix:colon
r_case
id|CAPI_INFO
suffix:colon
r_case
id|CAPI_LISTEN
suffix:colon
r_case
id|CAPI_MANUFACTURER
suffix:colon
r_case
id|CAPI_RESET_B3
suffix:colon
r_case
id|CAPI_SELECT_B_PROTOCOL
suffix:colon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|capi_subcmd_valid
r_static
r_inline
r_int
id|capi_subcmd_valid
c_func
(paren
id|__u8
id|subcmd
)paren
(brace
r_switch
c_cond
(paren
id|subcmd
)paren
(brace
r_case
id|CAPI_REQ
suffix:colon
r_case
id|CAPI_CONF
suffix:colon
r_case
id|CAPI_IND
suffix:colon
r_case
id|CAPI_RESP
suffix:colon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* -------- /proc functions ----------------------------------- */
multiline_comment|/*&n; * /proc/capi/applications:&n; *      applid l3cnt dblkcnt dblklen #ncci recvqueuelen&n; */
DECL|function|proc_applications_read_proc
r_static
r_int
id|proc_applications_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|capi_appl
op_star
id|ap
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CAPI_MAXAPPL
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ap
op_assign
op_amp
id|applications
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;applid
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;%u %d %d %d %d %d&bslash;n&quot;
comma
id|ap-&gt;applid
comma
id|ap-&gt;rparam.level3cnt
comma
id|ap-&gt;rparam.datablkcnt
comma
id|ap-&gt;rparam.datablklen
comma
id|ap-&gt;nncci
comma
id|skb_queue_len
c_func
(paren
op_amp
id|ap-&gt;recv_queue
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
id|off
)paren
(brace
id|off
op_sub_assign
id|len
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|len
op_minus
id|off
OG
id|count
)paren
r_goto
id|endloop
suffix:semicolon
)brace
)brace
id|endloop
suffix:colon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|count
)paren
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|count
)paren
id|len
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; * /proc/capi/ncci:&n; *&t;applid ncci winsize nblk&n; */
DECL|function|proc_ncci_read_proc
r_static
r_int
id|proc_ncci_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|capi_appl
op_star
id|ap
suffix:semicolon
r_struct
id|capi_ncci
op_star
id|np
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CAPI_MAXAPPL
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ap
op_assign
op_amp
id|applications
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;applid
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
r_for
c_loop
(paren
id|np
op_assign
id|ap-&gt;nccilist
suffix:semicolon
id|np
suffix:semicolon
id|np
op_assign
id|np-&gt;next
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;%d 0x%x %d %d&bslash;n&quot;
comma
id|np-&gt;applid
comma
id|np-&gt;ncci
comma
id|np-&gt;winsize
comma
id|np-&gt;nmsg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
id|off
)paren
(brace
id|off
op_sub_assign
id|len
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|len
op_minus
id|off
OG
id|count
)paren
r_goto
id|endloop
suffix:semicolon
)brace
)brace
)brace
id|endloop
suffix:colon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|count
)paren
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|count
)paren
id|len
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; * /proc/capi/driver:&n; *&t;driver ncontroller&n; */
DECL|function|proc_driver_read_proc
r_static
r_int
id|proc_driver_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|capi_driver
op_star
id|driver
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|drivers_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|driver
op_assign
id|drivers
suffix:semicolon
id|driver
suffix:semicolon
id|driver
op_assign
id|driver-&gt;next
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;%-32s %d %s&bslash;n&quot;
comma
id|driver-&gt;name
comma
id|driver-&gt;ncontroller
comma
id|driver-&gt;revision
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
id|off
)paren
(brace
id|off
op_sub_assign
id|len
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|len
op_minus
id|off
OG
id|count
)paren
r_goto
id|endloop
suffix:semicolon
)brace
)brace
id|endloop
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|drivers_lock
)paren
suffix:semicolon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|count
)paren
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|count
)paren
id|len
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; * /proc/capi/users:&n; *&t;name&n; */
DECL|function|proc_users_read_proc
r_static
r_int
id|proc_users_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|capi_interface_user
op_star
id|cp
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|capi_users_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cp
op_assign
id|capi_users
suffix:semicolon
id|cp
suffix:semicolon
id|cp
op_assign
id|cp-&gt;next
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|cp-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
id|off
)paren
(brace
id|off
op_sub_assign
id|len
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|len
op_minus
id|off
OG
id|count
)paren
r_goto
id|endloop
suffix:semicolon
)brace
)brace
id|endloop
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|capi_users_lock
)paren
suffix:semicolon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|count
)paren
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|count
)paren
id|len
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; * /proc/capi/controller:&n; *&t;cnr driver cardstate name driverinfo&n; */
DECL|function|proc_controller_read_proc
r_static
r_int
id|proc_controller_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|capi_ctr
op_star
id|cp
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CAPI_MAXCONTR
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cp
op_assign
op_amp
id|cards
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|cp-&gt;cardstate
op_eq
id|CARD_FREE
)paren
r_continue
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;%d %-10s %-8s %-16s %s&bslash;n&quot;
comma
id|cp-&gt;cnr
comma
id|cp-&gt;driver-&gt;name
comma
id|cardstate2str
c_func
(paren
id|cp-&gt;cardstate
)paren
comma
id|cp-&gt;name
comma
id|cp-&gt;driver-&gt;procinfo
ques
c_cond
id|cp-&gt;driver
op_member_access_from_pointer
id|procinfo
c_func
(paren
id|cp
)paren
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
id|off
)paren
(brace
id|off
op_sub_assign
id|len
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|len
op_minus
id|off
OG
id|count
)paren
r_goto
id|endloop
suffix:semicolon
)brace
)brace
id|endloop
suffix:colon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|count
)paren
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|count
)paren
id|len
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; * /proc/capi/applstats:&n; *&t;applid nrecvctlpkt nrecvdatapkt nsentctlpkt nsentdatapkt&n; */
DECL|function|proc_applstats_read_proc
r_static
r_int
id|proc_applstats_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|capi_appl
op_star
id|ap
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CAPI_MAXAPPL
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ap
op_assign
op_amp
id|applications
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;applid
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;%u %lu %lu %lu %lu&bslash;n&quot;
comma
id|ap-&gt;applid
comma
id|ap-&gt;nrecvctlpkt
comma
id|ap-&gt;nrecvdatapkt
comma
id|ap-&gt;nsentctlpkt
comma
id|ap-&gt;nsentdatapkt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
id|off
)paren
(brace
id|off
op_sub_assign
id|len
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|len
op_minus
id|off
OG
id|count
)paren
r_goto
id|endloop
suffix:semicolon
)brace
)brace
id|endloop
suffix:colon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|count
)paren
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|count
)paren
id|len
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; * /proc/capi/contrstats:&n; *&t;cnr nrecvctlpkt nrecvdatapkt nsentctlpkt nsentdatapkt&n; */
DECL|function|proc_contrstats_read_proc
r_static
r_int
id|proc_contrstats_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|capi_ctr
op_star
id|cp
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CAPI_MAXCONTR
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cp
op_assign
op_amp
id|cards
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|cp-&gt;cardstate
op_eq
id|CARD_FREE
)paren
r_continue
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;%d %lu %lu %lu %lu&bslash;n&quot;
comma
id|cp-&gt;cnr
comma
id|cp-&gt;nrecvctlpkt
comma
id|cp-&gt;nrecvdatapkt
comma
id|cp-&gt;nsentctlpkt
comma
id|cp-&gt;nsentdatapkt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
id|off
)paren
(brace
id|off
op_sub_assign
id|len
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|len
op_minus
id|off
OG
id|count
)paren
r_goto
id|endloop
suffix:semicolon
)brace
)brace
id|endloop
suffix:colon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|count
)paren
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|count
)paren
id|len
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|struct|procfsentries
r_static
r_struct
id|procfsentries
(brace
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|mode
id|mode_t
id|mode
suffix:semicolon
DECL|member|read_proc
r_int
(paren
op_star
id|read_proc
)paren
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
DECL|member|procent
r_struct
id|proc_dir_entry
op_star
id|procent
suffix:semicolon
DECL|variable|procfsentries
)brace
id|procfsentries
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;capi&quot;
comma
id|S_IFDIR
comma
l_int|0
)brace
comma
(brace
l_string|&quot;capi/applications&quot;
comma
l_int|0
comma
id|proc_applications_read_proc
)brace
comma
(brace
l_string|&quot;capi/ncci&quot;
comma
l_int|0
comma
id|proc_ncci_read_proc
)brace
comma
(brace
l_string|&quot;capi/driver&quot;
comma
l_int|0
comma
id|proc_driver_read_proc
)brace
comma
(brace
l_string|&quot;capi/users&quot;
comma
l_int|0
comma
id|proc_users_read_proc
)brace
comma
(brace
l_string|&quot;capi/controller&quot;
comma
l_int|0
comma
id|proc_controller_read_proc
)brace
comma
(brace
l_string|&quot;capi/applstats&quot;
comma
l_int|0
comma
id|proc_applstats_read_proc
)brace
comma
(brace
l_string|&quot;capi/contrstats&quot;
comma
l_int|0
comma
id|proc_contrstats_read_proc
)brace
comma
(brace
l_string|&quot;capi/drivers&quot;
comma
id|S_IFDIR
comma
l_int|0
)brace
comma
(brace
l_string|&quot;capi/controllers&quot;
comma
id|S_IFDIR
comma
l_int|0
)brace
comma
)brace
suffix:semicolon
DECL|function|proc_capi_init
r_static
r_void
id|proc_capi_init
c_func
(paren
r_void
)paren
(brace
r_int
id|nelem
op_assign
r_sizeof
(paren
id|procfsentries
)paren
op_div
r_sizeof
(paren
id|procfsentries
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nelem
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|procfsentries
op_star
id|p
op_assign
id|procfsentries
op_plus
id|i
suffix:semicolon
id|p-&gt;procent
op_assign
id|create_proc_entry
c_func
(paren
id|p-&gt;name
comma
id|p-&gt;mode
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;procent
)paren
id|p-&gt;procent-&gt;read_proc
op_assign
id|p-&gt;read_proc
suffix:semicolon
)brace
)brace
DECL|function|proc_capi_exit
r_static
r_void
id|proc_capi_exit
c_func
(paren
r_void
)paren
(brace
r_int
id|nelem
op_assign
r_sizeof
(paren
id|procfsentries
)paren
op_div
r_sizeof
(paren
id|procfsentries
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|nelem
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_struct
id|procfsentries
op_star
id|p
op_assign
id|procfsentries
op_plus
id|i
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;procent
)paren
(brace
id|remove_proc_entry
c_func
(paren
id|p-&gt;name
comma
l_int|0
)paren
suffix:semicolon
id|p-&gt;procent
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* -------- Notifier handling --------------------------------- */
DECL|struct|capi_notifier_list
r_static
r_struct
id|capi_notifier_list
(brace
DECL|member|head
r_struct
id|capi_notifier
op_star
id|head
suffix:semicolon
DECL|member|tail
r_struct
id|capi_notifier
op_star
id|tail
suffix:semicolon
DECL|variable|notifier_list
)brace
id|notifier_list
suffix:semicolon
DECL|variable|notifier_lock
r_static
id|spinlock_t
id|notifier_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|function|notify_enqueue
r_static
r_inline
r_void
id|notify_enqueue
c_func
(paren
r_struct
id|capi_notifier
op_star
id|np
)paren
(brace
r_struct
id|capi_notifier_list
op_star
id|q
op_assign
op_amp
id|notifier_list
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|notifier_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q-&gt;tail
)paren
(brace
id|q-&gt;tail-&gt;next
op_assign
id|np
suffix:semicolon
id|q-&gt;tail
op_assign
id|np
suffix:semicolon
)brace
r_else
(brace
id|q-&gt;head
op_assign
id|q-&gt;tail
op_assign
id|np
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|notifier_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|notify_dequeue
r_static
r_inline
r_struct
id|capi_notifier
op_star
id|notify_dequeue
c_func
(paren
r_void
)paren
(brace
r_struct
id|capi_notifier_list
op_star
id|q
op_assign
op_amp
id|notifier_list
suffix:semicolon
r_struct
id|capi_notifier
op_star
id|np
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|notifier_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q-&gt;head
)paren
(brace
id|np
op_assign
id|q-&gt;head
suffix:semicolon
r_if
c_cond
(paren
(paren
id|q-&gt;head
op_assign
id|np-&gt;next
)paren
op_eq
l_int|0
)paren
id|q-&gt;tail
op_assign
l_int|0
suffix:semicolon
id|np-&gt;next
op_assign
l_int|0
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|notifier_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|np
suffix:semicolon
)brace
DECL|function|notify_push
r_static
r_int
id|notify_push
c_func
(paren
r_int
r_int
id|cmd
comma
id|__u32
id|controller
comma
id|__u16
id|applid
comma
id|__u32
id|ncci
)paren
(brace
r_struct
id|capi_notifier
op_star
id|np
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|np
op_assign
(paren
r_struct
id|capi_notifier
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|capi_notifier
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|np
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|np
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|capi_notifier
)paren
)paren
suffix:semicolon
id|np-&gt;cmd
op_assign
id|cmd
suffix:semicolon
id|np-&gt;controller
op_assign
id|controller
suffix:semicolon
id|np-&gt;applid
op_assign
id|applid
suffix:semicolon
id|np-&gt;ncci
op_assign
id|ncci
suffix:semicolon
id|notify_enqueue
c_func
(paren
id|np
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * The notifier will result in adding/deleteing&n;&t; * of devices. Devices can only removed in&n;&t; * user process, not in bh.&n;&t; */
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
id|schedule_task
c_func
(paren
op_amp
id|tq_state_notify
)paren
op_eq
l_int|0
)paren
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* -------- KCI_CONTRUP --------------------------------------- */
DECL|function|notify_up
r_static
r_void
id|notify_up
c_func
(paren
id|__u32
id|contr
)paren
(brace
r_struct
id|capi_interface_user
op_star
id|p
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;kcapi: notify up contr %d&bslash;n&quot;
comma
id|contr
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|capi_users_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|capi_users
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;callback
)paren
r_continue
suffix:semicolon
(paren
op_star
id|p-&gt;callback
)paren
(paren
id|KCI_CONTRUP
comma
id|contr
comma
op_amp
id|CARD
c_func
(paren
id|contr
)paren
op_member_access_from_pointer
id|profile
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|capi_users_lock
)paren
suffix:semicolon
)brace
multiline_comment|/* -------- KCI_CONTRDOWN ------------------------------------- */
DECL|function|notify_down
r_static
r_void
id|notify_down
c_func
(paren
id|__u32
id|contr
)paren
(brace
r_struct
id|capi_interface_user
op_star
id|p
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;kcapi: notify down contr %d&bslash;n&quot;
comma
id|contr
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|capi_users_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|capi_users
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;callback
)paren
r_continue
suffix:semicolon
(paren
op_star
id|p-&gt;callback
)paren
(paren
id|KCI_CONTRDOWN
comma
id|contr
comma
l_int|0
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|capi_users_lock
)paren
suffix:semicolon
)brace
multiline_comment|/* -------- KCI_NCCIUP ---------------------------------------- */
DECL|function|notify_ncciup
r_static
r_void
id|notify_ncciup
c_func
(paren
id|__u32
id|contr
comma
id|__u16
id|applid
comma
id|__u32
id|ncci
)paren
(brace
r_struct
id|capi_interface_user
op_star
id|p
suffix:semicolon
r_struct
id|capi_ncciinfo
id|n
suffix:semicolon
id|n.applid
op_assign
id|applid
suffix:semicolon
id|n.ncci
op_assign
id|ncci
suffix:semicolon
multiline_comment|/*printk(KERN_NOTICE &quot;kcapi: notify up contr %d&bslash;n&quot;, contr);*/
id|spin_lock
c_func
(paren
op_amp
id|capi_users_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|capi_users
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;callback
)paren
r_continue
suffix:semicolon
(paren
op_star
id|p-&gt;callback
)paren
(paren
id|KCI_NCCIUP
comma
id|contr
comma
op_amp
id|n
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|capi_users_lock
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* -------- KCI_NCCIDOWN -------------------------------------- */
DECL|function|notify_nccidown
r_static
r_void
id|notify_nccidown
c_func
(paren
id|__u32
id|contr
comma
id|__u16
id|applid
comma
id|__u32
id|ncci
)paren
(brace
r_struct
id|capi_interface_user
op_star
id|p
suffix:semicolon
r_struct
id|capi_ncciinfo
id|n
suffix:semicolon
id|n.applid
op_assign
id|applid
suffix:semicolon
id|n.ncci
op_assign
id|ncci
suffix:semicolon
multiline_comment|/*printk(KERN_NOTICE &quot;kcapi: notify down contr %d&bslash;n&quot;, contr);*/
id|spin_lock
c_func
(paren
op_amp
id|capi_users_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|capi_users
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;callback
)paren
r_continue
suffix:semicolon
(paren
op_star
id|p-&gt;callback
)paren
(paren
id|KCI_NCCIDOWN
comma
id|contr
comma
op_amp
id|n
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|capi_users_lock
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* ------------------------------------------------------------ */
DECL|function|notify_doit
r_static
r_void
r_inline
id|notify_doit
c_func
(paren
r_struct
id|capi_notifier
op_star
id|np
)paren
(brace
r_switch
c_cond
(paren
id|np-&gt;cmd
)paren
(brace
r_case
id|KCI_CONTRUP
suffix:colon
id|notify_up
c_func
(paren
id|np-&gt;controller
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|KCI_CONTRDOWN
suffix:colon
id|notify_down
c_func
(paren
id|np-&gt;controller
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|KCI_NCCIUP
suffix:colon
id|notify_ncciup
c_func
(paren
id|np-&gt;controller
comma
id|np-&gt;applid
comma
id|np-&gt;ncci
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|KCI_NCCIDOWN
suffix:colon
id|notify_nccidown
c_func
(paren
id|np-&gt;controller
comma
id|np-&gt;applid
comma
id|np-&gt;ncci
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|notify_handler
r_static
r_void
id|notify_handler
c_func
(paren
r_void
op_star
id|dummy
)paren
(brace
r_struct
id|capi_notifier
op_star
id|np
suffix:semicolon
r_while
c_loop
(paren
(paren
id|np
op_assign
id|notify_dequeue
c_func
(paren
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|notify_doit
c_func
(paren
id|np
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|np
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
multiline_comment|/* -------- NCCI Handling ------------------------------------- */
DECL|function|mq_init
r_static
r_inline
r_void
id|mq_init
c_func
(paren
r_struct
id|capi_ncci
op_star
id|np
)paren
(brace
r_int
id|i
suffix:semicolon
id|np-&gt;msgidqueue
op_assign
l_int|0
suffix:semicolon
id|np-&gt;msgidlast
op_assign
l_int|0
suffix:semicolon
id|np-&gt;nmsg
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|np-&gt;msgidpool
comma
l_int|0
comma
r_sizeof
(paren
id|np-&gt;msgidpool
)paren
)paren
suffix:semicolon
id|np-&gt;msgidfree
op_assign
op_amp
id|np-&gt;msgidpool
(braket
l_int|0
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|np-&gt;winsize
suffix:semicolon
id|i
op_increment
)paren
(brace
id|np-&gt;msgidpool
(braket
id|i
)braket
dot
id|next
op_assign
id|np-&gt;msgidfree
suffix:semicolon
id|np-&gt;msgidfree
op_assign
op_amp
id|np-&gt;msgidpool
(braket
id|i
)braket
suffix:semicolon
)brace
)brace
DECL|function|mq_enqueue
r_static
r_inline
r_int
id|mq_enqueue
c_func
(paren
r_struct
id|capi_ncci
op_star
id|np
comma
id|__u16
id|msgid
)paren
(brace
r_struct
id|msgidqueue
op_star
id|mq
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mq
op_assign
id|np-&gt;msgidfree
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|np-&gt;msgidfree
op_assign
id|mq-&gt;next
suffix:semicolon
id|mq-&gt;msgid
op_assign
id|msgid
suffix:semicolon
id|mq-&gt;next
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;msgidlast
)paren
id|np-&gt;msgidlast-&gt;next
op_assign
id|mq
suffix:semicolon
id|np-&gt;msgidlast
op_assign
id|mq
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|np-&gt;msgidqueue
)paren
id|np-&gt;msgidqueue
op_assign
id|mq
suffix:semicolon
id|np-&gt;nmsg
op_increment
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|mq_dequeue
r_static
r_inline
r_int
id|mq_dequeue
c_func
(paren
r_struct
id|capi_ncci
op_star
id|np
comma
id|__u16
id|msgid
)paren
(brace
r_struct
id|msgidqueue
op_star
op_star
id|pp
suffix:semicolon
r_for
c_loop
(paren
id|pp
op_assign
op_amp
id|np-&gt;msgidqueue
suffix:semicolon
op_star
id|pp
suffix:semicolon
id|pp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|msgid
op_eq
id|msgid
)paren
(brace
r_struct
id|msgidqueue
op_star
id|mq
op_assign
op_star
id|pp
suffix:semicolon
op_star
id|pp
op_assign
id|mq-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|mq
op_eq
id|np-&gt;msgidlast
)paren
id|np-&gt;msgidlast
op_assign
l_int|0
suffix:semicolon
id|mq-&gt;next
op_assign
id|np-&gt;msgidfree
suffix:semicolon
id|np-&gt;msgidfree
op_assign
id|mq
suffix:semicolon
id|np-&gt;nmsg
op_decrement
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|controllercb_appl_registered
r_static
r_void
id|controllercb_appl_registered
c_func
(paren
r_struct
id|capi_ctr
op_star
id|card
comma
id|__u16
id|appl
)paren
(brace
)brace
DECL|function|controllercb_appl_released
r_static
r_void
id|controllercb_appl_released
c_func
(paren
r_struct
id|capi_ctr
op_star
id|card
comma
id|__u16
id|appl
)paren
(brace
r_struct
id|capi_ncci
op_star
op_star
id|pp
comma
op_star
op_star
id|nextpp
suffix:semicolon
r_for
c_loop
(paren
id|pp
op_assign
op_amp
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|nccilist
suffix:semicolon
op_star
id|pp
suffix:semicolon
id|pp
op_assign
id|nextpp
)paren
(brace
r_if
c_cond
(paren
id|NCCI2CTRL
c_func
(paren
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|ncci
)paren
op_eq
id|card-&gt;cnr
)paren
(brace
r_struct
id|capi_ncci
op_star
id|np
op_assign
op_star
id|pp
suffix:semicolon
op_star
id|pp
op_assign
id|np-&gt;next
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;kcapi: appl %d ncci 0x%x down!&bslash;n&quot;
comma
id|appl
comma
id|np-&gt;ncci
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|np
)paren
suffix:semicolon
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|nncci
op_decrement
suffix:semicolon
id|nextpp
op_assign
id|pp
suffix:semicolon
)brace
r_else
(brace
id|nextpp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
)brace
)brace
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|releasing
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|releasing
op_le
l_int|0
)paren
(brace
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|signal
op_assign
l_int|0
suffix:semicolon
id|APPL_MARK_FREE
c_func
(paren
id|appl
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;kcapi: appl %d down&bslash;n&quot;
comma
id|appl
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * ncci managment&n; */
DECL|function|controllercb_new_ncci
r_static
r_void
id|controllercb_new_ncci
c_func
(paren
r_struct
id|capi_ctr
op_star
id|card
comma
id|__u16
id|appl
comma
id|__u32
id|ncci
comma
id|__u32
id|winsize
)paren
(brace
r_struct
id|capi_ncci
op_star
id|np
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|VALID_APPLID
c_func
(paren
id|appl
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;avmb1_handle_new_ncci: illegal appl %d&bslash;n&quot;
comma
id|appl
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|np
op_assign
(paren
r_struct
id|capi_ncci
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|capi_ncci
)paren
comma
id|GFP_ATOMIC
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capi_new_ncci: alloc failed ncci 0x%x&bslash;n&quot;
comma
id|ncci
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|winsize
OG
id|CAPI_MAXDATAWINDOW
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capi_new_ncci: winsize %d too big, set to %d&bslash;n&quot;
comma
id|winsize
comma
id|CAPI_MAXDATAWINDOW
)paren
suffix:semicolon
id|winsize
op_assign
id|CAPI_MAXDATAWINDOW
suffix:semicolon
)brace
id|np-&gt;applid
op_assign
id|appl
suffix:semicolon
id|np-&gt;ncci
op_assign
id|ncci
suffix:semicolon
id|np-&gt;winsize
op_assign
id|winsize
suffix:semicolon
id|mq_init
c_func
(paren
id|np
)paren
suffix:semicolon
id|np-&gt;next
op_assign
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|nccilist
suffix:semicolon
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|nccilist
op_assign
id|np
suffix:semicolon
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|nncci
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;kcapi: appl %d ncci 0x%x up&bslash;n&quot;
comma
id|appl
comma
id|ncci
)paren
suffix:semicolon
id|notify_push
c_func
(paren
id|KCI_NCCIUP
comma
id|CARDNR
c_func
(paren
id|card
)paren
comma
id|appl
comma
id|ncci
)paren
suffix:semicolon
)brace
DECL|function|controllercb_free_ncci
r_static
r_void
id|controllercb_free_ncci
c_func
(paren
r_struct
id|capi_ctr
op_star
id|card
comma
id|__u16
id|appl
comma
id|__u32
id|ncci
)paren
(brace
r_struct
id|capi_ncci
op_star
op_star
id|pp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|VALID_APPLID
c_func
(paren
id|appl
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;free_ncci: illegal appl %d&bslash;n&quot;
comma
id|appl
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|pp
op_assign
op_amp
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|nccilist
suffix:semicolon
op_star
id|pp
suffix:semicolon
id|pp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|ncci
op_eq
id|ncci
)paren
(brace
r_struct
id|capi_ncci
op_star
id|np
op_assign
op_star
id|pp
suffix:semicolon
op_star
id|pp
op_assign
id|np-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|np
)paren
suffix:semicolon
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|nncci
op_decrement
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;kcapi: appl %d ncci 0x%x down&bslash;n&quot;
comma
id|appl
comma
id|ncci
)paren
suffix:semicolon
id|notify_push
c_func
(paren
id|KCI_NCCIDOWN
comma
id|CARDNR
c_func
(paren
id|card
)paren
comma
id|appl
comma
id|ncci
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;free_ncci: ncci 0x%x not found&bslash;n&quot;
comma
id|ncci
)paren
suffix:semicolon
)brace
DECL|function|find_ncci
r_static
r_struct
id|capi_ncci
op_star
id|find_ncci
c_func
(paren
r_struct
id|capi_appl
op_star
id|app
comma
id|__u32
id|ncci
)paren
(brace
r_struct
id|capi_ncci
op_star
id|np
suffix:semicolon
r_for
c_loop
(paren
id|np
op_assign
id|app-&gt;nccilist
suffix:semicolon
id|np
suffix:semicolon
id|np
op_assign
id|np-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|np-&gt;ncci
op_eq
id|ncci
)paren
r_return
id|np
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* -------- Receiver ------------------------------------------ */
DECL|function|recv_handler
r_static
r_void
id|recv_handler
c_func
(paren
r_void
op_star
id|dummy
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|recv_queue
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|__u16
id|appl
op_assign
id|CAPIMSG_APPID
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
r_struct
id|capi_ncci
op_star
id|np
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|VALID_APPLID
c_func
(paren
id|appl
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;kcapi: recv_handler: applid %d ? (%s)&bslash;n&quot;
comma
id|appl
comma
id|capi_message2str
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|signal
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;kcapi: recv_handler: applid %d has no signal function&bslash;n&quot;
comma
id|appl
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CAPIMSG_COMMAND
c_func
(paren
id|skb-&gt;data
)paren
op_eq
id|CAPI_DATA_B3
op_logical_and
id|CAPIMSG_SUBCOMMAND
c_func
(paren
id|skb-&gt;data
)paren
op_eq
id|CAPI_CONF
op_logical_and
(paren
id|np
op_assign
id|find_ncci
c_func
(paren
id|APPL
c_func
(paren
id|appl
)paren
comma
id|CAPIMSG_NCCI
c_func
(paren
id|skb-&gt;data
)paren
)paren
)paren
op_ne
l_int|0
op_logical_and
id|mq_dequeue
c_func
(paren
id|np
comma
id|CAPIMSG_MSGID
c_func
(paren
id|skb-&gt;data
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;kcapi: msgid %hu ncci 0x%x not on queue&bslash;n&quot;
comma
id|CAPIMSG_MSGID
c_func
(paren
id|skb-&gt;data
)paren
comma
id|np-&gt;ncci
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CAPIMSG_COMMAND
c_func
(paren
id|skb-&gt;data
)paren
op_eq
id|CAPI_DATA_B3
op_logical_and
id|CAPIMSG_SUBCOMMAND
c_func
(paren
id|skb-&gt;data
)paren
op_eq
id|CAPI_IND
)paren
(brace
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|nrecvdatapkt
op_increment
suffix:semicolon
)brace
r_else
(brace
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|nrecvctlpkt
op_increment
suffix:semicolon
)brace
id|skb_queue_tail
c_func
(paren
op_amp
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|recv_queue
comma
id|skb
)paren
suffix:semicolon
(paren
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|signal
)paren
(paren
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|applid
comma
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|param
)paren
suffix:semicolon
)brace
)brace
DECL|function|controllercb_handle_capimsg
r_static
r_void
id|controllercb_handle_capimsg
c_func
(paren
r_struct
id|capi_ctr
op_star
id|card
comma
id|__u16
id|appl
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|showctl
op_assign
l_int|0
suffix:semicolon
id|__u8
id|cmd
comma
id|subcmd
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;cardstate
op_ne
id|CARD_RUNNING
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;kcapi: controller %d not active, got: %s&quot;
comma
id|card-&gt;cnr
comma
id|capi_message2str
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|cmd
op_assign
id|CAPIMSG_COMMAND
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
id|subcmd
op_assign
id|CAPIMSG_SUBCOMMAND
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|CAPI_DATA_B3
op_logical_and
id|subcmd
op_eq
id|CAPI_IND
)paren
(brace
id|card-&gt;nrecvdatapkt
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;traceflag
OG
l_int|2
)paren
id|showctl
op_or_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
id|card-&gt;nrecvctlpkt
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;traceflag
)paren
id|showctl
op_or_assign
l_int|2
suffix:semicolon
)brace
id|showctl
op_or_assign
(paren
id|card-&gt;traceflag
op_amp
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|showctl
op_amp
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|showctl
op_amp
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;kcapi: got [0x%lx] id#%d %s len=%u&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|card-&gt;cnr
comma
id|CAPIMSG_APPID
c_func
(paren
id|skb-&gt;data
)paren
comma
id|capi_cmd2str
c_func
(paren
id|cmd
comma
id|subcmd
)paren
comma
id|CAPIMSG_LEN
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;kcapi: got [0x%lx] %s&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|card-&gt;cnr
comma
id|capi_message2str
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
)brace
)brace
id|skb_queue_tail
c_func
(paren
op_amp
id|recv_queue
comma
id|skb
)paren
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|tq_recv_notify
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
r_return
suffix:semicolon
id|error
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
DECL|function|controllercb_ready
r_static
r_void
id|controllercb_ready
c_func
(paren
r_struct
id|capi_ctr
op_star
id|card
)paren
(brace
id|__u16
id|appl
suffix:semicolon
id|card-&gt;cardstate
op_assign
id|CARD_RUNNING
suffix:semicolon
r_for
c_loop
(paren
id|appl
op_assign
l_int|1
suffix:semicolon
id|appl
op_le
id|CAPI_MAXAPPL
suffix:semicolon
id|appl
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|VALID_APPLID
c_func
(paren
id|appl
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|releasing
)paren
r_continue
suffix:semicolon
id|card-&gt;driver
op_member_access_from_pointer
id|register_appl
c_func
(paren
id|card
comma
id|appl
comma
op_amp
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|rparam
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;kcapi: card %d &bslash;&quot;%s&bslash;&quot; ready.&bslash;n&quot;
comma
id|CARDNR
c_func
(paren
id|card
)paren
comma
id|card-&gt;name
)paren
suffix:semicolon
id|notify_push
c_func
(paren
id|KCI_CONTRUP
comma
id|CARDNR
c_func
(paren
id|card
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|controllercb_reseted
r_static
r_void
id|controllercb_reseted
c_func
(paren
r_struct
id|capi_ctr
op_star
id|card
)paren
(brace
id|__u16
id|appl
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;cardstate
op_eq
id|CARD_FREE
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;cardstate
op_eq
id|CARD_DETECTED
)paren
r_return
suffix:semicolon
id|card-&gt;cardstate
op_assign
id|CARD_DETECTED
suffix:semicolon
id|memset
c_func
(paren
id|card-&gt;manu
comma
l_int|0
comma
r_sizeof
(paren
id|card-&gt;manu
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|card-&gt;version
comma
l_int|0
comma
r_sizeof
(paren
id|card-&gt;version
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|card-&gt;profile
comma
l_int|0
comma
r_sizeof
(paren
id|card-&gt;profile
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|card-&gt;serial
comma
l_int|0
comma
r_sizeof
(paren
id|card-&gt;serial
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|appl
op_assign
l_int|1
suffix:semicolon
id|appl
op_le
id|CAPI_MAXAPPL
suffix:semicolon
id|appl
op_increment
)paren
(brace
r_struct
id|capi_ncci
op_star
op_star
id|pp
comma
op_star
op_star
id|nextpp
suffix:semicolon
r_for
c_loop
(paren
id|pp
op_assign
op_amp
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|nccilist
suffix:semicolon
op_star
id|pp
suffix:semicolon
id|pp
op_assign
id|nextpp
)paren
(brace
r_if
c_cond
(paren
id|NCCI2CTRL
c_func
(paren
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|ncci
)paren
op_eq
id|card-&gt;cnr
)paren
(brace
r_struct
id|capi_ncci
op_star
id|np
op_assign
op_star
id|pp
suffix:semicolon
op_star
id|pp
op_assign
id|np-&gt;next
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;kcapi: appl %d ncci 0x%x forced down!&bslash;n&quot;
comma
id|appl
comma
id|np-&gt;ncci
)paren
suffix:semicolon
id|notify_push
c_func
(paren
id|KCI_NCCIDOWN
comma
id|CARDNR
c_func
(paren
id|card
)paren
comma
id|appl
comma
id|np-&gt;ncci
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|np
)paren
suffix:semicolon
id|nextpp
op_assign
id|pp
suffix:semicolon
)brace
r_else
(brace
id|nextpp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
)brace
)brace
)brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;kcapi: card %d down.&bslash;n&quot;
comma
id|CARDNR
c_func
(paren
id|card
)paren
)paren
suffix:semicolon
id|notify_push
c_func
(paren
id|KCI_CONTRDOWN
comma
id|CARDNR
c_func
(paren
id|card
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|controllercb_suspend_output
r_static
r_void
id|controllercb_suspend_output
c_func
(paren
r_struct
id|capi_ctr
op_star
id|card
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;blocked
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;kcapi: card %d suspend&bslash;n&quot;
comma
id|CARDNR
c_func
(paren
id|card
)paren
)paren
suffix:semicolon
id|card-&gt;blocked
op_assign
l_int|1
suffix:semicolon
)brace
)brace
DECL|function|controllercb_resume_output
r_static
r_void
id|controllercb_resume_output
c_func
(paren
r_struct
id|capi_ctr
op_star
id|card
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;blocked
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;kcapi: card %d resume&bslash;n&quot;
comma
id|CARDNR
c_func
(paren
id|card
)paren
)paren
suffix:semicolon
id|card-&gt;blocked
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* ------------------------------------------------------------- */
r_struct
id|capi_ctr
op_star
DECL|function|drivercb_attach_ctr
id|drivercb_attach_ctr
c_func
(paren
r_struct
id|capi_driver
op_star
id|driver
comma
r_char
op_star
id|name
comma
r_void
op_star
id|driverdata
)paren
(brace
r_struct
id|capi_ctr
op_star
id|card
comma
op_star
op_star
id|pp
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CAPI_MAXCONTR
op_logical_and
id|cards
(braket
id|i
)braket
dot
id|cardstate
op_ne
id|CARD_FREE
suffix:semicolon
id|i
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|CAPI_MAXCONTR
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;kcapi: out of controller slots&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|card
op_assign
op_amp
id|cards
(braket
id|i
)braket
suffix:semicolon
id|memset
c_func
(paren
id|card
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|capi_ctr
)paren
)paren
suffix:semicolon
id|card-&gt;driver
op_assign
id|driver
suffix:semicolon
id|card-&gt;cnr
op_assign
id|CARDNR
c_func
(paren
id|card
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|card-&gt;name
comma
id|name
comma
r_sizeof
(paren
id|card-&gt;name
)paren
)paren
suffix:semicolon
id|card-&gt;cardstate
op_assign
id|CARD_DETECTED
suffix:semicolon
id|card-&gt;blocked
op_assign
l_int|0
suffix:semicolon
id|card-&gt;driverdata
op_assign
id|driverdata
suffix:semicolon
id|card-&gt;traceflag
op_assign
id|showcapimsgs
suffix:semicolon
id|card-&gt;ready
op_assign
id|controllercb_ready
suffix:semicolon
id|card-&gt;reseted
op_assign
id|controllercb_reseted
suffix:semicolon
id|card-&gt;suspend_output
op_assign
id|controllercb_suspend_output
suffix:semicolon
id|card-&gt;resume_output
op_assign
id|controllercb_resume_output
suffix:semicolon
id|card-&gt;handle_capimsg
op_assign
id|controllercb_handle_capimsg
suffix:semicolon
id|card-&gt;appl_registered
op_assign
id|controllercb_appl_registered
suffix:semicolon
id|card-&gt;appl_released
op_assign
id|controllercb_appl_released
suffix:semicolon
id|card-&gt;new_ncci
op_assign
id|controllercb_new_ncci
suffix:semicolon
id|card-&gt;free_ncci
op_assign
id|controllercb_free_ncci
suffix:semicolon
r_for
c_loop
(paren
id|pp
op_assign
op_amp
id|driver-&gt;controller
suffix:semicolon
op_star
id|pp
suffix:semicolon
id|pp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
)paren
suffix:semicolon
id|card-&gt;next
op_assign
l_int|0
suffix:semicolon
op_star
id|pp
op_assign
id|card
suffix:semicolon
id|driver-&gt;ncontroller
op_increment
suffix:semicolon
id|sprintf
c_func
(paren
id|card-&gt;procfn
comma
l_string|&quot;capi/controllers/%d&quot;
comma
id|card-&gt;cnr
)paren
suffix:semicolon
id|card-&gt;procent
op_assign
id|create_proc_entry
c_func
(paren
id|card-&gt;procfn
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;procent
)paren
(brace
id|card-&gt;procent-&gt;read_proc
op_assign
(paren
r_int
(paren
op_star
)paren
(paren
r_char
op_star
comma
r_char
op_star
op_star
comma
id|off_t
comma
r_int
comma
r_int
op_star
comma
r_void
op_star
)paren
)paren
id|driver-&gt;ctr_read_proc
suffix:semicolon
id|card-&gt;procent-&gt;data
op_assign
id|card
suffix:semicolon
)brace
id|ncards
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;kcapi: Controller %d: %s attached&bslash;n&quot;
comma
id|card-&gt;cnr
comma
id|card-&gt;name
)paren
suffix:semicolon
r_return
id|card
suffix:semicolon
)brace
DECL|function|drivercb_detach_ctr
r_static
r_int
id|drivercb_detach_ctr
c_func
(paren
r_struct
id|capi_ctr
op_star
id|card
)paren
(brace
r_struct
id|capi_driver
op_star
id|driver
op_assign
id|card-&gt;driver
suffix:semicolon
r_struct
id|capi_ctr
op_star
op_star
id|pp
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;cardstate
op_eq
id|CARD_FREE
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;cardstate
op_ne
id|CARD_DETECTED
)paren
id|controllercb_reseted
c_func
(paren
id|card
)paren
suffix:semicolon
r_for
c_loop
(paren
id|pp
op_assign
op_amp
id|driver-&gt;controller
suffix:semicolon
op_star
id|pp
suffix:semicolon
id|pp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
)paren
(brace
r_if
c_cond
(paren
op_star
id|pp
op_eq
id|card
)paren
(brace
op_star
id|pp
op_assign
id|card-&gt;next
suffix:semicolon
id|driver-&gt;ncontroller
op_decrement
suffix:semicolon
id|ncards
op_decrement
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|card-&gt;procent
)paren
(brace
id|remove_proc_entry
c_func
(paren
id|card-&gt;procfn
comma
l_int|0
)paren
suffix:semicolon
id|card-&gt;procent
op_assign
l_int|0
suffix:semicolon
)brace
id|card-&gt;cardstate
op_assign
id|CARD_FREE
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;kcapi: Controller %d: %s unregistered&bslash;n&quot;
comma
id|card-&gt;cnr
comma
id|card-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------- */
multiline_comment|/* fallback if no driver read_proc function defined by driver */
DECL|function|driver_read_proc
r_static
r_int
id|driver_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|capi_driver
op_star
id|driver
op_assign
(paren
r_struct
id|capi_driver
op_star
)paren
id|data
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;%-16s %s&bslash;n&quot;
comma
l_string|&quot;name&quot;
comma
id|driver-&gt;name
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;%-16s %s&bslash;n&quot;
comma
l_string|&quot;revision&quot;
comma
id|driver-&gt;revision
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|off
)paren
r_return
l_int|0
suffix:semicolon
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
r_return
(paren
(paren
id|count
OL
id|len
op_minus
id|off
)paren
ques
c_cond
id|count
suffix:colon
id|len
op_minus
id|off
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------- */
DECL|variable|di
r_static
r_struct
id|capi_driver_interface
id|di
op_assign
(brace
id|drivercb_attach_ctr
comma
id|drivercb_detach_ctr
comma
)brace
suffix:semicolon
DECL|function|attach_capi_driver
r_struct
id|capi_driver_interface
op_star
id|attach_capi_driver
c_func
(paren
r_struct
id|capi_driver
op_star
id|driver
)paren
(brace
r_struct
id|capi_driver
op_star
op_star
id|pp
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|drivers_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|pp
op_assign
op_amp
id|drivers
suffix:semicolon
op_star
id|pp
suffix:semicolon
id|pp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
)paren
suffix:semicolon
id|driver-&gt;next
op_assign
l_int|0
suffix:semicolon
op_star
id|pp
op_assign
id|driver
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|drivers_lock
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;kcapi: driver %s attached&bslash;n&quot;
comma
id|driver-&gt;name
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|driver-&gt;procfn
comma
l_string|&quot;capi/drivers/%s&quot;
comma
id|driver-&gt;name
)paren
suffix:semicolon
id|driver-&gt;procent
op_assign
id|create_proc_entry
c_func
(paren
id|driver-&gt;procfn
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|driver-&gt;procent
)paren
(brace
r_if
c_cond
(paren
id|driver-&gt;driver_read_proc
)paren
(brace
id|driver-&gt;procent-&gt;read_proc
op_assign
(paren
r_int
(paren
op_star
)paren
(paren
r_char
op_star
comma
r_char
op_star
op_star
comma
id|off_t
comma
r_int
comma
r_int
op_star
comma
r_void
op_star
)paren
)paren
id|driver-&gt;driver_read_proc
suffix:semicolon
)brace
r_else
(brace
id|driver-&gt;procent-&gt;read_proc
op_assign
id|driver_read_proc
suffix:semicolon
)brace
id|driver-&gt;procent-&gt;data
op_assign
id|driver
suffix:semicolon
)brace
r_return
op_amp
id|di
suffix:semicolon
)brace
DECL|function|detach_capi_driver
r_void
id|detach_capi_driver
c_func
(paren
r_struct
id|capi_driver
op_star
id|driver
)paren
(brace
r_struct
id|capi_driver
op_star
op_star
id|pp
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|drivers_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|pp
op_assign
op_amp
id|drivers
suffix:semicolon
op_star
id|pp
op_logical_and
op_star
id|pp
op_ne
id|driver
suffix:semicolon
id|pp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|pp
)paren
(brace
op_star
id|pp
op_assign
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;kcapi: driver %s detached&bslash;n&quot;
comma
id|driver-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;kcapi: driver %s double detach ?&bslash;n&quot;
comma
id|driver-&gt;name
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|drivers_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|driver-&gt;procent
)paren
(brace
id|remove_proc_entry
c_func
(paren
id|driver-&gt;procfn
comma
l_int|0
)paren
suffix:semicolon
id|driver-&gt;procent
op_assign
l_int|0
suffix:semicolon
)brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------- */
multiline_comment|/* -------- CAPI2.0 Interface ---------------------------------- */
multiline_comment|/* ------------------------------------------------------------- */
DECL|function|capi_isinstalled
r_static
id|__u16
id|capi_isinstalled
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CAPI_MAXCONTR
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cards
(braket
id|i
)braket
dot
id|cardstate
op_eq
id|CARD_RUNNING
)paren
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
r_return
id|CAPI_REGNOTINSTALLED
suffix:semicolon
)brace
DECL|function|capi_register
r_static
id|__u16
id|capi_register
c_func
(paren
id|capi_register_params
op_star
id|rparam
comma
id|__u16
op_star
id|applidp
)paren
(brace
r_int
id|appl
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|rparam-&gt;datablklen
OL
l_int|128
)paren
r_return
id|CAPI_LOGBLKSIZETOSMALL
suffix:semicolon
r_for
c_loop
(paren
id|appl
op_assign
l_int|1
suffix:semicolon
id|appl
op_le
id|CAPI_MAXAPPL
suffix:semicolon
id|appl
op_increment
)paren
(brace
r_if
c_cond
(paren
id|APPL_IS_FREE
c_func
(paren
id|appl
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|appl
OG
id|CAPI_MAXAPPL
)paren
r_return
id|CAPI_TOOMANYAPPLS
suffix:semicolon
id|APPL_MARK_USED
c_func
(paren
id|appl
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|recv_queue
)paren
suffix:semicolon
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|nncci
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|rparam
comma
id|rparam
comma
r_sizeof
(paren
id|capi_register_params
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CAPI_MAXCONTR
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cards
(braket
id|i
)braket
dot
id|cardstate
op_ne
id|CARD_RUNNING
)paren
r_continue
suffix:semicolon
id|cards
(braket
id|i
)braket
dot
id|driver
op_member_access_from_pointer
id|register_appl
c_func
(paren
op_amp
id|cards
(braket
id|i
)braket
comma
id|appl
comma
op_amp
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|rparam
)paren
suffix:semicolon
)brace
op_star
id|applidp
op_assign
id|appl
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;kcapi: appl %d up&bslash;n&quot;
comma
id|appl
)paren
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
DECL|function|capi_release
r_static
id|__u16
id|capi_release
c_func
(paren
id|__u16
id|applid
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|VALID_APPLID
c_func
(paren
id|applid
)paren
op_logical_or
id|APPL
c_func
(paren
id|applid
)paren
op_member_access_from_pointer
id|releasing
)paren
r_return
id|CAPI_ILLAPPNR
suffix:semicolon
id|APPL
c_func
(paren
id|applid
)paren
op_member_access_from_pointer
id|releasing
op_increment
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|APPL
c_func
(paren
id|applid
)paren
op_member_access_from_pointer
id|recv_queue
)paren
)paren
op_ne
l_int|0
)paren
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CAPI_MAXCONTR
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cards
(braket
id|i
)braket
dot
id|cardstate
op_ne
id|CARD_RUNNING
)paren
r_continue
suffix:semicolon
id|APPL
c_func
(paren
id|applid
)paren
op_member_access_from_pointer
id|releasing
op_increment
suffix:semicolon
id|cards
(braket
id|i
)braket
dot
id|driver
op_member_access_from_pointer
id|release_appl
c_func
(paren
op_amp
id|cards
(braket
id|i
)braket
comma
id|applid
)paren
suffix:semicolon
)brace
id|APPL
c_func
(paren
id|applid
)paren
op_member_access_from_pointer
id|releasing
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|APPL
c_func
(paren
id|applid
)paren
op_member_access_from_pointer
id|releasing
op_le
l_int|0
)paren
(brace
id|APPL
c_func
(paren
id|applid
)paren
op_member_access_from_pointer
id|signal
op_assign
l_int|0
suffix:semicolon
id|APPL_MARK_FREE
c_func
(paren
id|applid
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;kcapi: appl %d down&bslash;n&quot;
comma
id|applid
)paren
suffix:semicolon
)brace
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
DECL|function|capi_put_message
r_static
id|__u16
id|capi_put_message
c_func
(paren
id|__u16
id|applid
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|capi_ncci
op_star
id|np
suffix:semicolon
id|__u32
id|contr
suffix:semicolon
r_int
id|showctl
op_assign
l_int|0
suffix:semicolon
id|__u8
id|cmd
comma
id|subcmd
suffix:semicolon
r_if
c_cond
(paren
id|ncards
op_eq
l_int|0
)paren
r_return
id|CAPI_REGNOTINSTALLED
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|VALID_APPLID
c_func
(paren
id|applid
)paren
)paren
r_return
id|CAPI_ILLAPPNR
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
OL
l_int|12
op_logical_or
op_logical_neg
id|capi_cmd_valid
c_func
(paren
id|CAPIMSG_COMMAND
c_func
(paren
id|skb-&gt;data
)paren
)paren
op_logical_or
op_logical_neg
id|capi_subcmd_valid
c_func
(paren
id|CAPIMSG_SUBCOMMAND
c_func
(paren
id|skb-&gt;data
)paren
)paren
)paren
r_return
id|CAPI_ILLCMDORSUBCMDORMSGTOSMALL
suffix:semicolon
id|contr
op_assign
id|CAPIMSG_CONTROLLER
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|VALID_CARD
c_func
(paren
id|contr
)paren
op_logical_or
id|CARD
c_func
(paren
id|contr
)paren
op_member_access_from_pointer
id|cardstate
op_ne
id|CARD_RUNNING
)paren
(brace
id|contr
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|CARD
c_func
(paren
id|contr
)paren
op_member_access_from_pointer
id|cardstate
op_ne
id|CARD_RUNNING
)paren
r_return
id|CAPI_REGNOTINSTALLED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CARD
c_func
(paren
id|contr
)paren
op_member_access_from_pointer
id|blocked
)paren
r_return
id|CAPI_SENDQUEUEFULL
suffix:semicolon
id|cmd
op_assign
id|CAPIMSG_COMMAND
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
id|subcmd
op_assign
id|CAPIMSG_SUBCOMMAND
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|CAPI_DATA_B3
op_logical_and
id|subcmd
op_eq
id|CAPI_REQ
)paren
(brace
r_if
c_cond
(paren
(paren
id|np
op_assign
id|find_ncci
c_func
(paren
id|APPL
c_func
(paren
id|applid
)paren
comma
id|CAPIMSG_NCCI
c_func
(paren
id|skb-&gt;data
)paren
)paren
)paren
op_ne
l_int|0
op_logical_and
id|mq_enqueue
c_func
(paren
id|np
comma
id|CAPIMSG_MSGID
c_func
(paren
id|skb-&gt;data
)paren
)paren
op_eq
l_int|0
)paren
r_return
id|CAPI_SENDQUEUEFULL
suffix:semicolon
id|CARD
c_func
(paren
id|contr
)paren
op_member_access_from_pointer
id|nsentdatapkt
op_increment
suffix:semicolon
id|APPL
c_func
(paren
id|applid
)paren
op_member_access_from_pointer
id|nsentdatapkt
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|CARD
c_func
(paren
id|contr
)paren
op_member_access_from_pointer
id|traceflag
OG
l_int|2
)paren
id|showctl
op_or_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
id|CARD
c_func
(paren
id|contr
)paren
op_member_access_from_pointer
id|nsentctlpkt
op_increment
suffix:semicolon
id|APPL
c_func
(paren
id|applid
)paren
op_member_access_from_pointer
id|nsentctlpkt
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|CARD
c_func
(paren
id|contr
)paren
op_member_access_from_pointer
id|traceflag
)paren
id|showctl
op_or_assign
l_int|2
suffix:semicolon
)brace
id|showctl
op_or_assign
(paren
id|CARD
c_func
(paren
id|contr
)paren
op_member_access_from_pointer
id|traceflag
op_amp
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|showctl
op_amp
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|showctl
op_amp
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;kcapi: put [0x%lx] id#%d %s len=%u&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|contr
comma
id|CAPIMSG_APPID
c_func
(paren
id|skb-&gt;data
)paren
comma
id|capi_cmd2str
c_func
(paren
id|cmd
comma
id|subcmd
)paren
comma
id|CAPIMSG_LEN
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;kcapi: put [0x%lx] %s&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|contr
comma
id|capi_message2str
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
)brace
)brace
id|CARD
c_func
(paren
id|contr
)paren
op_member_access_from_pointer
id|driver
op_member_access_from_pointer
id|send_message
c_func
(paren
id|CARD
c_func
(paren
id|contr
)paren
comma
id|skb
)paren
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
DECL|function|capi_get_message
r_static
id|__u16
id|capi_get_message
c_func
(paren
id|__u16
id|applid
comma
r_struct
id|sk_buff
op_star
op_star
id|msgp
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|VALID_APPLID
c_func
(paren
id|applid
)paren
)paren
r_return
id|CAPI_ILLAPPNR
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|APPL
c_func
(paren
id|applid
)paren
op_member_access_from_pointer
id|recv_queue
)paren
)paren
op_eq
l_int|0
)paren
r_return
id|CAPI_RECEIVEQUEUEEMPTY
suffix:semicolon
op_star
id|msgp
op_assign
id|skb
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
DECL|function|capi_set_signal
r_static
id|__u16
id|capi_set_signal
c_func
(paren
id|__u16
id|applid
comma
r_void
(paren
op_star
id|signal
)paren
(paren
id|__u16
id|applid
comma
r_void
op_star
id|param
)paren
comma
r_void
op_star
id|param
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|VALID_APPLID
c_func
(paren
id|applid
)paren
)paren
r_return
id|CAPI_ILLAPPNR
suffix:semicolon
id|APPL
c_func
(paren
id|applid
)paren
op_member_access_from_pointer
id|signal
op_assign
id|signal
suffix:semicolon
id|APPL
c_func
(paren
id|applid
)paren
op_member_access_from_pointer
id|param
op_assign
id|param
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
DECL|function|capi_get_manufacturer
r_static
id|__u16
id|capi_get_manufacturer
c_func
(paren
id|__u32
id|contr
comma
id|__u8
id|buf
(braket
id|CAPI_MANUFACTURER_LEN
)braket
)paren
(brace
r_if
c_cond
(paren
id|contr
op_eq
l_int|0
)paren
(brace
id|strncpy
c_func
(paren
id|buf
comma
id|capi_manufakturer
comma
id|CAPI_MANUFACTURER_LEN
)paren
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|VALID_CARD
c_func
(paren
id|contr
)paren
op_logical_or
id|CARD
c_func
(paren
id|contr
)paren
op_member_access_from_pointer
id|cardstate
op_ne
id|CARD_RUNNING
)paren
r_return
id|CAPI_REGNOTINSTALLED
suffix:semicolon
id|strncpy
c_func
(paren
id|buf
comma
id|CARD
c_func
(paren
id|contr
)paren
op_member_access_from_pointer
id|manu
comma
id|CAPI_MANUFACTURER_LEN
)paren
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
DECL|function|capi_get_version
r_static
id|__u16
id|capi_get_version
c_func
(paren
id|__u32
id|contr
comma
r_struct
id|capi_version
op_star
id|verp
)paren
(brace
r_if
c_cond
(paren
id|contr
op_eq
l_int|0
)paren
(brace
op_star
id|verp
op_assign
id|driver_version
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|VALID_CARD
c_func
(paren
id|contr
)paren
op_logical_or
id|CARD
c_func
(paren
id|contr
)paren
op_member_access_from_pointer
id|cardstate
op_ne
id|CARD_RUNNING
)paren
r_return
id|CAPI_REGNOTINSTALLED
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|verp
comma
op_amp
id|CARD
c_func
(paren
id|contr
)paren
op_member_access_from_pointer
id|version
comma
r_sizeof
(paren
id|capi_version
)paren
)paren
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
DECL|function|capi_get_serial
r_static
id|__u16
id|capi_get_serial
c_func
(paren
id|__u32
id|contr
comma
id|__u8
id|serial
(braket
id|CAPI_SERIAL_LEN
)braket
)paren
(brace
r_if
c_cond
(paren
id|contr
op_eq
l_int|0
)paren
(brace
id|strncpy
c_func
(paren
id|serial
comma
id|driver_serial
comma
id|CAPI_SERIAL_LEN
)paren
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|VALID_CARD
c_func
(paren
id|contr
)paren
op_logical_or
id|CARD
c_func
(paren
id|contr
)paren
op_member_access_from_pointer
id|cardstate
op_ne
id|CARD_RUNNING
)paren
r_return
id|CAPI_REGNOTINSTALLED
suffix:semicolon
id|strncpy
c_func
(paren
(paren
r_void
op_star
)paren
id|serial
comma
id|CARD
c_func
(paren
id|contr
)paren
op_member_access_from_pointer
id|serial
comma
id|CAPI_SERIAL_LEN
)paren
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
DECL|function|capi_get_profile
r_static
id|__u16
id|capi_get_profile
c_func
(paren
id|__u32
id|contr
comma
r_struct
id|capi_profile
op_star
id|profp
)paren
(brace
r_if
c_cond
(paren
id|contr
op_eq
l_int|0
)paren
(brace
id|profp-&gt;ncontroller
op_assign
id|ncards
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|VALID_CARD
c_func
(paren
id|contr
)paren
op_logical_or
id|CARD
c_func
(paren
id|contr
)paren
op_member_access_from_pointer
id|cardstate
op_ne
id|CARD_RUNNING
)paren
r_return
id|CAPI_REGNOTINSTALLED
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|profp
comma
op_amp
id|CARD
c_func
(paren
id|contr
)paren
op_member_access_from_pointer
id|profile
comma
r_sizeof
(paren
r_struct
id|capi_profile
)paren
)paren
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
DECL|function|find_driver
r_static
r_struct
id|capi_driver
op_star
id|find_driver
c_func
(paren
r_char
op_star
id|name
)paren
(brace
r_struct
id|capi_driver
op_star
id|dp
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|drivers_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|dp
op_assign
id|drivers
suffix:semicolon
id|dp
suffix:semicolon
id|dp
op_assign
id|dp-&gt;next
)paren
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|dp-&gt;name
comma
id|name
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|drivers_lock
)paren
suffix:semicolon
r_return
id|dp
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_AVMB1_COMPAT
DECL|function|old_capi_manufacturer
r_static
r_int
id|old_capi_manufacturer
c_func
(paren
r_int
r_int
id|cmd
comma
r_void
op_star
id|data
)paren
(brace
id|avmb1_loadandconfigdef
id|ldef
suffix:semicolon
id|avmb1_extcarddef
id|cdef
suffix:semicolon
id|avmb1_resetdef
id|rdef
suffix:semicolon
id|avmb1_getdef
id|gdef
suffix:semicolon
r_struct
id|capi_driver
op_star
id|driver
suffix:semicolon
r_struct
id|capi_ctr
op_star
id|card
suffix:semicolon
id|capicardparams
id|cparams
suffix:semicolon
id|capiloaddata
id|ldata
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|AVMB1_ADDCARD
suffix:colon
r_case
id|AVMB1_ADDCARD_WITH_TYPE
suffix:colon
r_if
c_cond
(paren
id|cmd
op_eq
id|AVMB1_ADDCARD
)paren
(brace
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|cdef
comma
id|data
comma
r_sizeof
(paren
id|avmb1_carddef
)paren
)paren
)paren
)paren
r_return
id|retval
suffix:semicolon
id|cdef.cardtype
op_assign
id|AVM_CARDTYPE_B1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|cdef
comma
id|data
comma
r_sizeof
(paren
id|avmb1_extcarddef
)paren
)paren
)paren
)paren
r_return
id|retval
suffix:semicolon
)brace
id|cparams.port
op_assign
id|cdef.port
suffix:semicolon
id|cparams.irq
op_assign
id|cdef.irq
suffix:semicolon
id|cparams.cardnr
op_assign
id|cdef.cardnr
suffix:semicolon
r_switch
c_cond
(paren
id|cdef.cardtype
)paren
(brace
r_case
id|AVM_CARDTYPE_B1
suffix:colon
id|driver
op_assign
id|find_driver
c_func
(paren
l_string|&quot;b1isa&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AVM_CARDTYPE_T1
suffix:colon
id|driver
op_assign
id|find_driver
c_func
(paren
l_string|&quot;t1isa&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|driver
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|driver
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;kcapi: driver not loaded.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|driver-&gt;add_card
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;kcapi: driver has no add card function.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
id|driver
op_member_access_from_pointer
id|add_card
c_func
(paren
id|driver
comma
op_amp
id|cparams
)paren
suffix:semicolon
r_case
id|AVMB1_LOAD
suffix:colon
r_case
id|AVMB1_LOAD_AND_CONFIG
suffix:colon
r_if
c_cond
(paren
id|cmd
op_eq
id|AVMB1_LOAD
)paren
(brace
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|ldef
comma
id|data
comma
r_sizeof
(paren
id|avmb1_loaddef
)paren
)paren
)paren
)paren
r_return
id|retval
suffix:semicolon
id|ldef.t4config.len
op_assign
l_int|0
suffix:semicolon
id|ldef.t4config.data
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|ldef
comma
id|data
comma
r_sizeof
(paren
id|avmb1_loadandconfigdef
)paren
)paren
)paren
)paren
r_return
id|retval
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|VALID_CARD
c_func
(paren
id|ldef.contr
)paren
)paren
r_return
op_minus
id|ESRCH
suffix:semicolon
id|card
op_assign
id|CARD
c_func
(paren
id|ldef.contr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;cardstate
op_eq
id|CARD_FREE
)paren
r_return
op_minus
id|ESRCH
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;driver-&gt;load_firmware
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;kcapi: load: driver &bslash;%s&bslash;&quot; has no load function&bslash;n&quot;
comma
id|card-&gt;driver-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ESRCH
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ldef.t4file.len
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;kcapi: load: invalid parameter: length of t4file is %d ?&bslash;n&quot;
comma
id|ldef.t4file.len
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ldef.t4file.data
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;kcapi: load: invalid parameter: dataptr is 0&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|ldata.firmware.user
op_assign
l_int|1
suffix:semicolon
id|ldata.firmware.data
op_assign
id|ldef.t4file.data
suffix:semicolon
id|ldata.firmware.len
op_assign
id|ldef.t4file.len
suffix:semicolon
id|ldata.configuration.user
op_assign
l_int|1
suffix:semicolon
id|ldata.configuration.data
op_assign
id|ldef.t4config.data
suffix:semicolon
id|ldata.configuration.len
op_assign
id|ldef.t4config.len
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;cardstate
op_ne
id|CARD_DETECTED
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;kcapi: load: contr=%d not in detect state&bslash;n&quot;
comma
id|ldef.contr
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|card-&gt;cardstate
op_assign
id|CARD_LOADING
suffix:semicolon
id|retval
op_assign
id|card-&gt;driver
op_member_access_from_pointer
id|load_firmware
c_func
(paren
id|card
comma
op_amp
id|ldata
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|card-&gt;cardstate
op_assign
id|CARD_DETECTED
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_while
c_loop
(paren
id|card-&gt;cardstate
op_ne
id|CARD_RUNNING
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
multiline_comment|/* 0.1 sec */
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|AVMB1_RESETCARD
suffix:colon
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|rdef
comma
id|data
comma
r_sizeof
(paren
id|avmb1_resetdef
)paren
)paren
)paren
)paren
r_return
id|retval
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|VALID_CARD
c_func
(paren
id|rdef.contr
)paren
)paren
r_return
op_minus
id|ESRCH
suffix:semicolon
id|card
op_assign
id|CARD
c_func
(paren
id|rdef.contr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;cardstate
op_eq
id|CARD_FREE
)paren
r_return
op_minus
id|ESRCH
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;cardstate
op_eq
id|CARD_DETECTED
)paren
r_return
l_int|0
suffix:semicolon
id|card-&gt;driver
op_member_access_from_pointer
id|reset_ctr
c_func
(paren
id|card
)paren
suffix:semicolon
r_while
c_loop
(paren
id|card-&gt;cardstate
OG
id|CARD_DETECTED
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
multiline_comment|/* 0.1 sec */
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|AVMB1_GET_CARDINFO
suffix:colon
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|gdef
comma
id|data
comma
r_sizeof
(paren
id|avmb1_getdef
)paren
)paren
)paren
)paren
r_return
id|retval
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|VALID_CARD
c_func
(paren
id|gdef.contr
)paren
)paren
r_return
op_minus
id|ESRCH
suffix:semicolon
id|card
op_assign
id|CARD
c_func
(paren
id|gdef.contr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;cardstate
op_eq
id|CARD_FREE
)paren
r_return
op_minus
id|ESRCH
suffix:semicolon
id|gdef.cardstate
op_assign
id|card-&gt;cardstate
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;driver
op_eq
id|find_driver
c_func
(paren
l_string|&quot;t1isa&quot;
)paren
)paren
id|gdef.cardtype
op_assign
id|AVM_CARDTYPE_T1
suffix:semicolon
r_else
id|gdef.cardtype
op_assign
id|AVM_CARDTYPE_B1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|copy_to_user
c_func
(paren
id|data
comma
(paren
r_void
op_star
)paren
op_amp
id|gdef
comma
r_sizeof
(paren
id|avmb1_getdef
)paren
)paren
)paren
)paren
r_return
id|retval
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|AVMB1_REMOVECARD
suffix:colon
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|rdef
comma
id|data
comma
r_sizeof
(paren
id|avmb1_resetdef
)paren
)paren
)paren
)paren
r_return
id|retval
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|VALID_CARD
c_func
(paren
id|rdef.contr
)paren
)paren
r_return
op_minus
id|ESRCH
suffix:semicolon
id|card
op_assign
id|CARD
c_func
(paren
id|rdef.contr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;cardstate
op_eq
id|CARD_FREE
)paren
r_return
op_minus
id|ESRCH
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;cardstate
op_ne
id|CARD_DETECTED
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|card-&gt;driver
op_member_access_from_pointer
id|remove_ctr
c_func
(paren
id|card
)paren
suffix:semicolon
r_while
c_loop
(paren
id|card-&gt;cardstate
op_ne
id|CARD_FREE
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
multiline_comment|/* 0.1 sec */
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
macro_line|#endif
DECL|function|capi_manufacturer
r_static
r_int
id|capi_manufacturer
c_func
(paren
r_int
r_int
id|cmd
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|capi_ctr
op_star
id|card
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
macro_line|#ifdef CONFIG_AVMB1_COMPAT
r_case
id|AVMB1_ADDCARD
suffix:colon
r_case
id|AVMB1_ADDCARD_WITH_TYPE
suffix:colon
r_case
id|AVMB1_LOAD
suffix:colon
r_case
id|AVMB1_LOAD_AND_CONFIG
suffix:colon
r_case
id|AVMB1_RESETCARD
suffix:colon
r_case
id|AVMB1_GET_CARDINFO
suffix:colon
r_case
id|AVMB1_REMOVECARD
suffix:colon
r_return
id|old_capi_manufacturer
c_func
(paren
id|cmd
comma
id|data
)paren
suffix:semicolon
macro_line|#endif
r_case
id|KCAPI_CMD_TRACE
suffix:colon
(brace
id|kcapi_flagdef
id|fdef
suffix:semicolon
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|fdef
comma
id|data
comma
r_sizeof
(paren
id|kcapi_flagdef
)paren
)paren
)paren
)paren
r_return
id|retval
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|VALID_CARD
c_func
(paren
id|fdef.contr
)paren
)paren
r_return
op_minus
id|ESRCH
suffix:semicolon
id|card
op_assign
id|CARD
c_func
(paren
id|fdef.contr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;cardstate
op_eq
id|CARD_FREE
)paren
r_return
op_minus
id|ESRCH
suffix:semicolon
id|card-&gt;traceflag
op_assign
id|fdef.flag
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;kcapi: contr %d set trace=%d&bslash;n&quot;
comma
id|card-&gt;cnr
comma
id|card-&gt;traceflag
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|KCAPI_CMD_ADDCARD
suffix:colon
(brace
r_struct
id|capi_driver
op_star
id|driver
suffix:semicolon
id|capicardparams
id|cparams
suffix:semicolon
id|kcapi_carddef
id|cdef
suffix:semicolon
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|cdef
comma
id|data
comma
r_sizeof
(paren
id|cdef
)paren
)paren
)paren
)paren
r_return
id|retval
suffix:semicolon
id|cparams.port
op_assign
id|cdef.port
suffix:semicolon
id|cparams.irq
op_assign
id|cdef.irq
suffix:semicolon
id|cparams.membase
op_assign
id|cdef.membase
suffix:semicolon
id|cparams.cardnr
op_assign
id|cdef.cardnr
suffix:semicolon
id|cparams.cardtype
op_assign
l_int|0
suffix:semicolon
id|cdef.driver
(braket
r_sizeof
(paren
id|cdef.driver
)paren
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|driver
op_assign
id|find_driver
c_func
(paren
id|cdef.driver
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;kcapi: driver &bslash;&quot;%s&bslash;&quot; not loaded.&bslash;n&quot;
comma
id|cdef.driver
)paren
suffix:semicolon
r_return
op_minus
id|ESRCH
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|driver-&gt;add_card
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;kcapi: driver &bslash;&quot;%s&bslash;&quot; has no add card function.&bslash;n&quot;
comma
id|cdef.driver
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
id|driver
op_member_access_from_pointer
id|add_card
c_func
(paren
id|driver
comma
op_amp
id|cparams
)paren
suffix:semicolon
)brace
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;kcapi: manufacturer command %d unknown.&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|variable|avmb1_interface
r_struct
id|capi_interface
id|avmb1_interface
op_assign
(brace
id|capi_isinstalled
comma
id|capi_register
comma
id|capi_release
comma
id|capi_put_message
comma
id|capi_get_message
comma
id|capi_set_signal
comma
id|capi_get_manufacturer
comma
id|capi_get_version
comma
id|capi_get_serial
comma
id|capi_get_profile
comma
id|capi_manufacturer
)brace
suffix:semicolon
multiline_comment|/* ------------------------------------------------------------- */
multiline_comment|/* -------- Exported Functions --------------------------------- */
multiline_comment|/* ------------------------------------------------------------- */
DECL|function|attach_capi_interface
r_struct
id|capi_interface
op_star
id|attach_capi_interface
c_func
(paren
r_struct
id|capi_interface_user
op_star
id|userp
)paren
(brace
r_struct
id|capi_interface_user
op_star
id|p
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|capi_users_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|capi_users
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|p
op_eq
id|userp
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|capi_users_lock
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;kcapi: double attach from %s&bslash;n&quot;
comma
id|userp-&gt;name
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|userp-&gt;next
op_assign
id|capi_users
suffix:semicolon
id|capi_users
op_assign
id|userp
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|capi_users_lock
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;kcapi: %s attached&bslash;n&quot;
comma
id|userp-&gt;name
)paren
suffix:semicolon
r_return
op_amp
id|avmb1_interface
suffix:semicolon
)brace
DECL|function|detach_capi_interface
r_int
id|detach_capi_interface
c_func
(paren
r_struct
id|capi_interface_user
op_star
id|userp
)paren
(brace
r_struct
id|capi_interface_user
op_star
op_star
id|pp
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|capi_users_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|pp
op_assign
op_amp
id|capi_users
suffix:semicolon
op_star
id|pp
suffix:semicolon
id|pp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
)paren
(brace
r_if
c_cond
(paren
op_star
id|pp
op_eq
id|userp
)paren
(brace
op_star
id|pp
op_assign
id|userp-&gt;next
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|capi_users_lock
)paren
suffix:semicolon
id|userp-&gt;next
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;kcapi: %s detached&bslash;n&quot;
comma
id|userp-&gt;name
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|capi_users_lock
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;kcapi: double detach from %s&bslash;n&quot;
comma
id|userp-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------- */
multiline_comment|/* -------- Init &amp; Cleanup ------------------------------------- */
multiline_comment|/* ------------------------------------------------------------- */
DECL|variable|attach_capi_interface
id|EXPORT_SYMBOL
c_func
(paren
id|attach_capi_interface
)paren
suffix:semicolon
DECL|variable|detach_capi_interface
id|EXPORT_SYMBOL
c_func
(paren
id|detach_capi_interface
)paren
suffix:semicolon
DECL|variable|attach_capi_driver
id|EXPORT_SYMBOL
c_func
(paren
id|attach_capi_driver
)paren
suffix:semicolon
DECL|variable|detach_capi_driver
id|EXPORT_SYMBOL
c_func
(paren
id|detach_capi_driver
)paren
suffix:semicolon
multiline_comment|/*&n; * init / exit functions&n; */
DECL|function|kcapi_init
r_static
r_int
id|__init
id|kcapi_init
c_func
(paren
r_void
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
r_char
id|rev
(braket
l_int|10
)braket
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|recv_queue
)paren
suffix:semicolon
id|tq_state_notify.routine
op_assign
id|notify_handler
suffix:semicolon
id|tq_state_notify.data
op_assign
l_int|0
suffix:semicolon
id|tq_recv_notify.routine
op_assign
id|recv_handler
suffix:semicolon
id|tq_recv_notify.data
op_assign
l_int|0
suffix:semicolon
id|proc_capi_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
op_assign
id|strchr
c_func
(paren
id|revision
comma
l_char|&squot;:&squot;
)paren
)paren
)paren
(brace
id|strcpy
c_func
(paren
id|rev
comma
id|p
op_plus
l_int|1
)paren
suffix:semicolon
id|p
op_assign
id|strchr
c_func
(paren
id|rev
comma
l_char|&squot;$&squot;
)paren
suffix:semicolon
op_star
id|p
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|strcpy
c_func
(paren
id|rev
comma
l_string|&quot;1.0&quot;
)paren
suffix:semicolon
macro_line|#ifdef MODULE
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;CAPI-driver Rev%s: loaded&bslash;n&quot;
comma
id|rev
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;CAPI-driver Rev%s: started&bslash;n&quot;
comma
id|rev
)paren
suffix:semicolon
macro_line|#endif
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|kcapi_exit
r_static
r_void
id|__exit
id|kcapi_exit
c_func
(paren
r_void
)paren
(brace
r_char
id|rev
(braket
l_int|10
)braket
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
op_assign
id|strchr
c_func
(paren
id|revision
comma
l_char|&squot;:&squot;
)paren
)paren
)paren
(brace
id|strcpy
c_func
(paren
id|rev
comma
id|p
op_plus
l_int|1
)paren
suffix:semicolon
id|p
op_assign
id|strchr
c_func
(paren
id|rev
comma
l_char|&squot;$&squot;
)paren
suffix:semicolon
op_star
id|p
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|strcpy
c_func
(paren
id|rev
comma
l_string|&quot;1.0&quot;
)paren
suffix:semicolon
)brace
id|proc_capi_exit
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;CAPI-driver Rev%s: unloaded&bslash;n&quot;
comma
id|rev
)paren
suffix:semicolon
)brace
DECL|variable|kcapi_init
id|module_init
c_func
(paren
id|kcapi_init
)paren
suffix:semicolon
DECL|variable|kcapi_exit
id|module_exit
c_func
(paren
id|kcapi_exit
)paren
suffix:semicolon
eof
