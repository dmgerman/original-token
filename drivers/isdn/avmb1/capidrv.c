multiline_comment|/*&n; * $Id: capidrv.c,v 1.39 2000/11/23 20:45:14 kai Exp $&n; *&n; * ISDN4Linux Driver, using capi20 interface (kernelcapi)&n; *&n; * Copyright 1997 by Carsten Paeth (calle@calle.in-berlin.de)&n; *&n; * $Log: capidrv.c,v $&n; * Revision 1.39  2000/11/23 20:45:14  kai&n; * fixed module_init/exit stuff&n; * Note: compiled-in kernel doesn&squot;t work pre 2.2.18 anymore.&n; *&n; * Revision 1.38  2000/11/14 08:43:07  calle&n; * Bugfix for v110. Connectparamters where setup for sync ...&n; *&n; * Revision 1.37  2000/11/01 14:05:02  calle&n; * - use module_init/module_exit from linux/init.h.&n; * - all static struct variables are initialized with &quot;membername:&quot; now.&n; * - avm_cs.c, let it work with newer pcmcia-cs.&n; *&n; * Revision 1.36  2000/06/26 15:13:41  keil&n; * features should be or&squot;ed&n; *&n; * Revision 1.35  2000/06/19 15:11:25  keil&n; * avoid use of freed structs&n; * changes from 2.4.0-ac21&n; *&n; * Revision 1.34  2000/06/19 13:13:55  calle&n; * Added Modemsupport!&n; *&n; * Revision 1.33  2000/05/06 00:52:36  kai&n; * merged changes from kernel tree&n; * fixed timer and net_device-&gt;name breakage&n; *&n; * Revision 1.32  2000/04/07 15:19:58  calle&n; * remove warnings&n; *&n; * Revision 1.31  2000/04/06 15:01:25  calle&n; * Bugfix: crash in capidrv.c when reseting a capi controller.&n; * - changed code order on remove of controller.&n; * - using tq_schedule for notifier in kcapi.c.&n; * - now using spin_lock_irqsave() and spin_unlock_irqrestore().&n; * strange: sometimes even MP hang on unload of isdn.o ...&n; *&n; * Revision 1.30  2000/03/03 15:50:42  calle&n; * - kernel CAPI:&n; *   - Changed parameter &quot;param&quot; in capi_signal from __u32 to void *.&n; *   - rewrote notifier handling in kcapi.c&n; *   - new notifier NCCI_UP and NCCI_DOWN&n; * - User CAPI:&n; *   - /dev/capi20 is now a cloning device.&n; *   - middleware extentions prepared.&n; * - capidrv.c&n; *   - locking of list operations and module count updates.&n; *&n; * Revision 1.29  1999/12/06 17:13:06  calle&n; * Added controller watchdog.&n; *&n; * Revision 1.28  1999/11/05 16:22:37  calle&n; * Bugfix: Missing break in switch on ISDN_CMD_HANGUP.&n; *&n; * Revision 1.27  1999/09/16 15:13:04  calle&n; * forgot to change paramter type of contr for lower_callback ...&n; *&n; * Revision 1.26  1999/08/06 07:41:16  calle&n; * Added the &quot;vbox patch&quot;. if (si1 == 1) si2 = 0;&n; *&n; * Revision 1.25  1999/08/04 10:10:11  calle&n; * Bugfix: corrected /proc functions, added structure for new AVM cards.&n; *&n; * Revision 1.24  1999/07/20 06:48:02  calle&n; * Bugfix: firmware version check for D2 trace was too restrictiv.&n; *&n; * Revision 1.23  1999/07/09 15:05:44  keil&n; * compat.h is now isdn_compat.h&n; *&n; * Revision 1.22  1999/07/06 07:24:14  calle&n; * Bugfix: call to kfree_skb in capidrv_signal was too early,&n; *         thanks to Lars Heete &lt;hel@admin.de&gt;.&n; *&n; * Revision 1.21  1999/07/01 15:26:34  calle&n; * complete new version (I love it):&n; * + new hardware independed &quot;capi_driver&quot; interface that will make it easy to:&n; *   - support other controllers with CAPI-2.0 (i.e. USB Controller)&n; *   - write a CAPI-2.0 for the passive cards&n; *   - support serial link CAPI-2.0 boxes.&n; * + wrote &quot;capi_driver&quot; for all supported cards.&n; * + &quot;capi_driver&quot; (supported cards) now have to be configured with&n; *   make menuconfig, in the past all supported cards where included&n; *   at once.&n; * + new and better informations in /proc/capi/&n; * + new ioctl to switch trace of capi messages per controller&n; *   using &quot;avmcapictrl trace [contr] on|off|....&quot;&n; * + complete testcircle with all supported cards and also the&n; *   PCMCIA cards (now patch for pcmcia-cs-3.0.13 needed) done.&n; *&n; * Revision 1.20  1999/07/01 08:22:59  keil&n; * compatibility macros now in &lt;linux/isdn_compat.h&gt;&n; *&n; * Revision 1.19  1999/06/29 16:16:54  calle&n; * Let ISDN_CMD_UNLOAD work with open isdn devices without crash again.&n; * Also right unlocking (ISDN_CMD_UNLOCK) is done now.&n; * isdnlog should check returncode of read(2) calls.&n; *&n; * Revision 1.18  1999/06/21 15:24:15  calle&n; * extend information in /proc.&n; *&n; * Revision 1.17  1999/06/10 16:53:55  calle&n; * Removing of module b1pci will now remove card from lower level.&n; *&n; * Revision 1.16  1999/05/31 11:50:33  calle&n; * Bugfix: In if_sendbuf, skb_push&squot;ed DATA_B3 header was not skb_pull&squot;ed&n; *         on failure, result in data block with DATA_B3 header transmitted&n; *&n; * Revision 1.15  1999/05/25 21:26:16  calle&n; * Include CAPI-Channelallocation (leased lines) from the 2.0 tree.&n; *&n; * Revision 1.14  1999/05/22 07:55:06  calle&n; * Added *V110* to AVM B1 driver.&n; *&n; * Revision 1.13  1998/06/26 15:12:55  fritz&n; * Added handling of STAT_ICALL with incomplete CPN.&n; * Added AT&amp;L for ttyI emulator.&n; * Added more locking stuff in tty_write.&n; *&n; * Revision 1.12  1998/03/29 16:06:03  calle&n; * changes from 2.0 tree merged.&n; *&n; * Revision 1.3.2.10  1998/03/20 14:38:24  calle&n; * capidrv: prepared state machines for suspend/resume/hold&n; * capidrv: fix bug in state machine if B1/T1 is out of nccis&n; * b1capi: changed some errno returns.&n; * b1capi: detect if you try to add same T1 to different io address.&n; * b1capi: change number of nccis depending on number of channels.&n; * b1lli: cosmetics&n; *&n; * Revision 1.3.2.9  1998/03/20 09:01:12  calle&n; * Changes capi_register handling to get full support for 30 bchannels.&n; *&n; * Revision 1.3.2.8  1998/03/18 17:51:28  calle&n; * added controller number to error messages&n; *&n; * Revision 1.3.2.7  1998/02/27 15:40:47  calle&n; * T1 running with slow link. bugfix in capi_release.&n; *&n; * Revision 1.11  1998/02/13 07:09:15  calle&n; * change for 2.1.86 (removing FREE_READ/FREE_WRITE from [dev]_kfree_skb()&n; *&n; * Revision 1.10  1998/02/02 19:52:23  calle&n; * Fixed vbox (audio) acceptb.&n; *&n; * Revision 1.9  1998/01/31 11:14:45  calle&n; * merged changes to 2.0 tree, prepare 2.1.82 to work.&n; *&n; * Revision 1.8  1997/11/04 06:12:09  calle&n; * capi.c: new read/write in file_ops since 2.1.60&n; * capidrv.c: prepared isdnlog interface for d2-trace in newer firmware.&n; * capiutil.c: needs config.h (CONFIG_ISDN_DRV_AVMB1_VERBOSE_REASON)&n; * compat.h: added #define LinuxVersionCode&n; *&n; * Revision 1.7  1997/10/11 10:36:34  calle&n; * Added isdnlog support. patch to isdnlog needed.&n; *&n; * Revision 1.6  1997/10/11 10:25:55  calle&n; * New interface for lowlevel drivers. BSENT with nr. of bytes sent,&n; * allow sending without ACK.&n; *&n; * Revision 1.5  1997/10/01 09:21:16  fritz&n; * Removed old compatibility stuff for 2.0.X kernels.&n; * From now on, this code is for 2.1.X ONLY!&n; * Old stuff is still in the separate branch.&n; *&n; * Revision 1.4  1997/07/13 12:22:43  calle&n; * bug fix for more than one controller in connect_req.&n; * debugoutput now with contrnr.&n; *&n; * Revision 1.3  1997/05/18 09:24:15  calle&n; * added verbose disconnect reason reporting to avmb1.&n; * some fixes in capi20 interface.&n; * changed info messages for B1-PCI&n; *&n; * Revision 1.2  1997/03/05 21:19:59  fritz&n; * Removed include of config.h (mkdep stated this is unneded).&n; *&n; * Revision 1.1  1997/03/04 21:50:31  calle&n; * Frirst version in isdn4linux&n; *&n; * Revision 2.2  1997/02/12 09:31:39  calle&n; * new version&n; *&n; * Revision 1.1  1997/01/31 10:32:20  calle&n; * Initial revision&n; *&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/isdn.h&gt;
macro_line|#include &lt;linux/isdnif.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/capi.h&gt;
macro_line|#include &lt;linux/kernelcapi.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &quot;capiutil.h&quot;
macro_line|#include &quot;capicmd.h&quot;
macro_line|#include &quot;capidrv.h&quot;
DECL|variable|revision
r_static
r_char
op_star
id|revision
op_assign
l_string|&quot;$Revision: 1.39 $&quot;
suffix:semicolon
DECL|variable|debugmode
r_static
r_int
id|debugmode
op_assign
l_int|0
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Carsten Paeth &lt;calle@calle.in-berlin.de&gt;&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debugmode
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
multiline_comment|/* -------- type definitions ----------------------------------------- */
DECL|struct|capidrv_contr
r_struct
id|capidrv_contr
(brace
DECL|member|next
r_struct
id|capidrv_contr
op_star
id|next
suffix:semicolon
DECL|member|contrnr
id|__u32
id|contrnr
suffix:semicolon
DECL|member|name
r_char
id|name
(braket
l_int|20
)braket
suffix:semicolon
multiline_comment|/*&n;&t; * for isdn4linux&n;&t; */
DECL|member|interface
id|isdn_if
id|interface
suffix:semicolon
DECL|member|myid
r_int
id|myid
suffix:semicolon
multiline_comment|/*&n;&t; * LISTEN state&n;&t; */
DECL|member|state
r_int
id|state
suffix:semicolon
DECL|member|cipmask
id|__u32
id|cipmask
suffix:semicolon
DECL|member|cipmask2
id|__u32
id|cipmask2
suffix:semicolon
DECL|member|listentimer
r_struct
id|timer_list
id|listentimer
suffix:semicolon
multiline_comment|/*&n;&t; * ID of capi message sent&n;&t; */
DECL|member|msgid
id|__u16
id|msgid
suffix:semicolon
multiline_comment|/*&n;&t; * B-Channels&n;&t; */
DECL|member|nbchan
r_int
id|nbchan
suffix:semicolon
DECL|struct|capidrv_bchan
r_struct
id|capidrv_bchan
(brace
DECL|member|contr
r_struct
id|capidrv_contr
op_star
id|contr
suffix:semicolon
DECL|member|msn
id|__u8
id|msn
(braket
id|ISDN_MSNLEN
)braket
suffix:semicolon
DECL|member|l2
r_int
id|l2
suffix:semicolon
DECL|member|l3
r_int
id|l3
suffix:semicolon
DECL|member|num
id|__u8
id|num
(braket
id|ISDN_MSNLEN
)braket
suffix:semicolon
DECL|member|mynum
id|__u8
id|mynum
(braket
id|ISDN_MSNLEN
)braket
suffix:semicolon
DECL|member|si1
r_int
id|si1
suffix:semicolon
DECL|member|si2
r_int
id|si2
suffix:semicolon
DECL|member|incoming
r_int
id|incoming
suffix:semicolon
DECL|member|disconnecting
r_int
id|disconnecting
suffix:semicolon
DECL|struct|capidrv_plci
r_struct
id|capidrv_plci
(brace
DECL|member|next
r_struct
id|capidrv_plci
op_star
id|next
suffix:semicolon
DECL|member|plci
id|__u32
id|plci
suffix:semicolon
DECL|member|ncci
id|__u32
id|ncci
suffix:semicolon
multiline_comment|/* ncci for CONNECT_ACTIVE_IND */
DECL|member|msgid
id|__u16
id|msgid
suffix:semicolon
multiline_comment|/* to identfy CONNECT_CONF */
DECL|member|chan
r_int
id|chan
suffix:semicolon
DECL|member|state
r_int
id|state
suffix:semicolon
DECL|member|leasedline
r_int
id|leasedline
suffix:semicolon
DECL|struct|capidrv_ncci
r_struct
id|capidrv_ncci
(brace
DECL|member|next
r_struct
id|capidrv_ncci
op_star
id|next
suffix:semicolon
DECL|member|plcip
r_struct
id|capidrv_plci
op_star
id|plcip
suffix:semicolon
DECL|member|ncci
id|__u32
id|ncci
suffix:semicolon
DECL|member|msgid
id|__u16
id|msgid
suffix:semicolon
multiline_comment|/* to identfy CONNECT_B3_CONF */
DECL|member|chan
r_int
id|chan
suffix:semicolon
DECL|member|state
r_int
id|state
suffix:semicolon
DECL|member|oldstate
r_int
id|oldstate
suffix:semicolon
multiline_comment|/* */
DECL|member|datahandle
id|__u16
id|datahandle
suffix:semicolon
DECL|struct|ncci_datahandle_queue
r_struct
id|ncci_datahandle_queue
(brace
DECL|member|next
r_struct
id|ncci_datahandle_queue
op_star
id|next
suffix:semicolon
DECL|member|datahandle
id|__u16
id|datahandle
suffix:semicolon
DECL|member|len
r_int
id|len
suffix:semicolon
DECL|member|ackqueue
)brace
op_star
id|ackqueue
suffix:semicolon
DECL|member|ncci_list
)brace
op_star
id|ncci_list
suffix:semicolon
DECL|member|plcip
)brace
op_star
id|plcip
suffix:semicolon
DECL|member|nccip
r_struct
id|capidrv_ncci
op_star
id|nccip
suffix:semicolon
DECL|member|bchans
)brace
op_star
id|bchans
suffix:semicolon
DECL|member|plci_list
r_struct
id|capidrv_plci
op_star
id|plci_list
suffix:semicolon
multiline_comment|/* for q931 data */
DECL|member|q931_buf
id|__u8
id|q931_buf
(braket
l_int|4096
)braket
suffix:semicolon
DECL|member|q931_read
id|__u8
op_star
id|q931_read
suffix:semicolon
DECL|member|q931_write
id|__u8
op_star
id|q931_write
suffix:semicolon
DECL|member|q931_end
id|__u8
op_star
id|q931_end
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|capidrv_data
r_struct
id|capidrv_data
(brace
DECL|member|appid
id|__u16
id|appid
suffix:semicolon
DECL|member|ncontr
r_int
id|ncontr
suffix:semicolon
DECL|member|contr_list
r_struct
id|capidrv_contr
op_star
id|contr_list
suffix:semicolon
multiline_comment|/* statistic */
DECL|member|nrecvctlpkt
r_int
r_int
id|nrecvctlpkt
suffix:semicolon
DECL|member|nrecvdatapkt
r_int
r_int
id|nrecvdatapkt
suffix:semicolon
DECL|member|nsentctlpkt
r_int
r_int
id|nsentctlpkt
suffix:semicolon
DECL|member|nsentdatapkt
r_int
r_int
id|nsentdatapkt
suffix:semicolon
)brace
suffix:semicolon
DECL|typedef|capidrv_plci
r_typedef
r_struct
id|capidrv_plci
id|capidrv_plci
suffix:semicolon
DECL|typedef|capidrv_ncci
r_typedef
r_struct
id|capidrv_ncci
id|capidrv_ncci
suffix:semicolon
DECL|typedef|capidrv_contr
r_typedef
r_struct
id|capidrv_contr
id|capidrv_contr
suffix:semicolon
DECL|typedef|capidrv_data
r_typedef
r_struct
id|capidrv_data
id|capidrv_data
suffix:semicolon
DECL|typedef|capidrv_bchan
r_typedef
r_struct
id|capidrv_bchan
id|capidrv_bchan
suffix:semicolon
multiline_comment|/* -------- data definitions ----------------------------------------- */
DECL|variable|global
r_static
id|capidrv_data
id|global
suffix:semicolon
DECL|variable|global_lock
r_static
id|spinlock_t
id|global_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|capifuncs
r_static
r_struct
id|capi_interface
op_star
id|capifuncs
suffix:semicolon
r_static
r_void
id|handle_dtrace_data
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
r_int
id|send
comma
r_int
id|level2
comma
id|__u8
op_star
id|data
comma
id|__u16
id|len
)paren
suffix:semicolon
multiline_comment|/* -------- convert functions ---------------------------------------- */
DECL|function|b1prot
r_static
r_inline
id|__u32
id|b1prot
c_func
(paren
r_int
id|l2
comma
r_int
id|l3
)paren
(brace
r_switch
c_cond
(paren
id|l2
)paren
(brace
r_case
id|ISDN_PROTO_L2_X75I
suffix:colon
r_case
id|ISDN_PROTO_L2_X75UI
suffix:colon
r_case
id|ISDN_PROTO_L2_X75BUI
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|ISDN_PROTO_L2_HDLC
suffix:colon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|ISDN_PROTO_L2_TRANS
suffix:colon
r_return
l_int|1
suffix:semicolon
r_case
id|ISDN_PROTO_L2_V11096
suffix:colon
r_case
id|ISDN_PROTO_L2_V11019
suffix:colon
r_case
id|ISDN_PROTO_L2_V11038
suffix:colon
r_return
l_int|2
suffix:semicolon
r_case
id|ISDN_PROTO_L2_FAX
suffix:colon
r_return
l_int|4
suffix:semicolon
r_case
id|ISDN_PROTO_L2_MODEM
suffix:colon
r_return
l_int|8
suffix:semicolon
)brace
)brace
DECL|function|b2prot
r_static
r_inline
id|__u32
id|b2prot
c_func
(paren
r_int
id|l2
comma
r_int
id|l3
)paren
(brace
r_switch
c_cond
(paren
id|l2
)paren
(brace
r_case
id|ISDN_PROTO_L2_X75I
suffix:colon
r_case
id|ISDN_PROTO_L2_X75UI
suffix:colon
r_case
id|ISDN_PROTO_L2_X75BUI
suffix:colon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|ISDN_PROTO_L2_HDLC
suffix:colon
r_case
id|ISDN_PROTO_L2_TRANS
suffix:colon
r_case
id|ISDN_PROTO_L2_V11096
suffix:colon
r_case
id|ISDN_PROTO_L2_V11019
suffix:colon
r_case
id|ISDN_PROTO_L2_V11038
suffix:colon
r_case
id|ISDN_PROTO_L2_MODEM
suffix:colon
r_return
l_int|1
suffix:semicolon
r_case
id|ISDN_PROTO_L2_FAX
suffix:colon
r_return
l_int|4
suffix:semicolon
)brace
)brace
DECL|function|b3prot
r_static
r_inline
id|__u32
id|b3prot
c_func
(paren
r_int
id|l2
comma
r_int
id|l3
)paren
(brace
r_switch
c_cond
(paren
id|l2
)paren
(brace
r_case
id|ISDN_PROTO_L2_X75I
suffix:colon
r_case
id|ISDN_PROTO_L2_X75UI
suffix:colon
r_case
id|ISDN_PROTO_L2_X75BUI
suffix:colon
r_case
id|ISDN_PROTO_L2_HDLC
suffix:colon
r_case
id|ISDN_PROTO_L2_TRANS
suffix:colon
r_case
id|ISDN_PROTO_L2_V11096
suffix:colon
r_case
id|ISDN_PROTO_L2_V11019
suffix:colon
r_case
id|ISDN_PROTO_L2_V11038
suffix:colon
r_case
id|ISDN_PROTO_L2_MODEM
suffix:colon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|ISDN_PROTO_L2_FAX
suffix:colon
r_return
l_int|4
suffix:semicolon
)brace
)brace
DECL|function|b1config_async_v110
r_static
id|_cstruct
id|b1config_async_v110
c_func
(paren
id|__u16
id|rate
)paren
(brace
multiline_comment|/* CAPI-Spec &quot;B1 Configuration&quot; */
r_static
r_int
r_char
id|buf
(braket
l_int|9
)braket
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* len */
multiline_comment|/* maximum bitrate */
id|buf
(braket
l_int|1
)braket
op_assign
id|rate
op_amp
l_int|0xff
suffix:semicolon
id|buf
(braket
l_int|2
)braket
op_assign
(paren
id|rate
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|buf
(braket
l_int|3
)braket
op_assign
l_int|8
suffix:semicolon
id|buf
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 8 bits per character */
id|buf
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
id|buf
(braket
l_int|6
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* parity none */
id|buf
(braket
l_int|7
)braket
op_assign
l_int|0
suffix:semicolon
id|buf
(braket
l_int|8
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 1 stop bit */
r_return
id|buf
suffix:semicolon
)brace
DECL|function|b1config
r_static
id|_cstruct
id|b1config
c_func
(paren
r_int
id|l2
comma
r_int
id|l3
)paren
(brace
r_switch
c_cond
(paren
id|l2
)paren
(brace
r_case
id|ISDN_PROTO_L2_X75I
suffix:colon
r_case
id|ISDN_PROTO_L2_X75UI
suffix:colon
r_case
id|ISDN_PROTO_L2_X75BUI
suffix:colon
r_case
id|ISDN_PROTO_L2_HDLC
suffix:colon
r_case
id|ISDN_PROTO_L2_TRANS
suffix:colon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|ISDN_PROTO_L2_V11096
suffix:colon
r_return
id|b1config_async_v110
c_func
(paren
l_int|9600
)paren
suffix:semicolon
r_case
id|ISDN_PROTO_L2_V11019
suffix:colon
r_return
id|b1config_async_v110
c_func
(paren
l_int|19200
)paren
suffix:semicolon
r_case
id|ISDN_PROTO_L2_V11038
suffix:colon
r_return
id|b1config_async_v110
c_func
(paren
l_int|38400
)paren
suffix:semicolon
)brace
)brace
DECL|function|si2cip
r_static
r_inline
id|__u16
id|si2cip
c_func
(paren
id|__u8
id|si1
comma
id|__u8
id|si2
)paren
(brace
r_static
r_const
id|__u8
id|cip
(braket
l_int|17
)braket
(braket
l_int|5
)braket
op_assign
(brace
multiline_comment|/*  0  1  2  3  4  */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/*0 */
(brace
l_int|16
comma
l_int|16
comma
l_int|4
comma
l_int|26
comma
l_int|16
)brace
comma
multiline_comment|/*1 */
(brace
l_int|17
comma
l_int|17
comma
l_int|17
comma
l_int|4
comma
l_int|4
)brace
comma
multiline_comment|/*2 */
(brace
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
)brace
comma
multiline_comment|/*3 */
(brace
l_int|18
comma
l_int|18
comma
l_int|18
comma
l_int|18
comma
l_int|18
)brace
comma
multiline_comment|/*4 */
(brace
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
)brace
comma
multiline_comment|/*5 */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/*6 */
(brace
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
)brace
comma
multiline_comment|/*7 */
(brace
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
)brace
comma
multiline_comment|/*8 */
(brace
l_int|21
comma
l_int|21
comma
l_int|21
comma
l_int|21
comma
l_int|21
)brace
comma
multiline_comment|/*9 */
(brace
l_int|19
comma
l_int|19
comma
l_int|19
comma
l_int|19
comma
l_int|19
)brace
comma
multiline_comment|/*10 */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/*11 */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/*12 */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/*13 */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/*14 */
(brace
l_int|22
comma
l_int|22
comma
l_int|22
comma
l_int|22
comma
l_int|22
)brace
comma
multiline_comment|/*15 */
(brace
l_int|27
comma
l_int|27
comma
l_int|27
comma
l_int|28
comma
l_int|27
)brace
multiline_comment|/*16 */
)brace
suffix:semicolon
r_if
c_cond
(paren
id|si1
OG
l_int|16
)paren
id|si1
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|si2
OG
l_int|4
)paren
id|si2
op_assign
l_int|0
suffix:semicolon
r_return
(paren
id|__u16
)paren
id|cip
(braket
id|si1
)braket
(braket
id|si2
)braket
suffix:semicolon
)brace
DECL|function|cip2si1
r_static
r_inline
id|__u8
id|cip2si1
c_func
(paren
id|__u16
id|cipval
)paren
(brace
r_static
r_const
id|__u8
id|si
(braket
l_int|32
)braket
op_assign
(brace
l_int|7
comma
l_int|1
comma
l_int|7
comma
l_int|7
comma
l_int|1
comma
l_int|1
comma
l_int|7
comma
l_int|7
comma
multiline_comment|/*0-7 */
l_int|7
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/*8-15 */
l_int|1
comma
l_int|2
comma
l_int|4
comma
l_int|10
comma
l_int|9
comma
l_int|9
comma
l_int|15
comma
l_int|7
comma
multiline_comment|/*16-23 */
l_int|7
comma
l_int|7
comma
l_int|1
comma
l_int|16
comma
l_int|16
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/*24-31 */
r_if
c_cond
(paren
id|cipval
OG
l_int|31
)paren
id|cipval
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* .... */
r_return
id|si
(braket
id|cipval
)braket
suffix:semicolon
)brace
DECL|function|cip2si2
r_static
r_inline
id|__u8
id|cip2si2
c_func
(paren
id|__u16
id|cipval
)paren
(brace
r_static
r_const
id|__u8
id|si
(braket
l_int|32
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|2
comma
l_int|3
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/*0-7 */
l_int|0
comma
l_int|3
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/*8-15 */
l_int|1
comma
l_int|2
comma
l_int|0
comma
l_int|0
comma
l_int|9
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/*16-23 */
l_int|0
comma
l_int|0
comma
l_int|3
comma
l_int|2
comma
l_int|3
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/*24-31 */
r_if
c_cond
(paren
id|cipval
OG
l_int|31
)paren
id|cipval
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* .... */
r_return
id|si
(braket
id|cipval
)braket
suffix:semicolon
)brace
multiline_comment|/* -------- controller managment ------------------------------------- */
DECL|function|findcontrbydriverid
r_static
r_inline
id|capidrv_contr
op_star
id|findcontrbydriverid
c_func
(paren
r_int
id|driverid
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|capidrv_contr
op_star
id|p
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|global_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|global.contr_list
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
r_if
c_cond
(paren
id|p-&gt;myid
op_eq
id|driverid
)paren
r_break
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|global_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|p
suffix:semicolon
)brace
DECL|function|findcontrbynumber
r_static
id|capidrv_contr
op_star
id|findcontrbynumber
c_func
(paren
id|__u32
id|contr
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|capidrv_contr
op_star
id|p
op_assign
id|global.contr_list
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|global_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|global.contr_list
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
r_if
c_cond
(paren
id|p-&gt;contrnr
op_eq
id|contr
)paren
r_break
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|global_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|p
suffix:semicolon
)brace
multiline_comment|/* -------- plci management ------------------------------------------ */
DECL|function|new_plci
r_static
id|capidrv_plci
op_star
id|new_plci
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
r_int
id|chan
)paren
(brace
id|capidrv_plci
op_star
id|plcip
suffix:semicolon
id|plcip
op_assign
(paren
id|capidrv_plci
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|capidrv_plci
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|plcip
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|plcip
comma
l_int|0
comma
r_sizeof
(paren
id|capidrv_plci
)paren
)paren
suffix:semicolon
id|plcip-&gt;state
op_assign
id|ST_PLCI_NONE
suffix:semicolon
id|plcip-&gt;plci
op_assign
l_int|0
suffix:semicolon
id|plcip-&gt;msgid
op_assign
l_int|0
suffix:semicolon
id|plcip-&gt;chan
op_assign
id|chan
suffix:semicolon
id|plcip-&gt;next
op_assign
id|card-&gt;plci_list
suffix:semicolon
id|card-&gt;plci_list
op_assign
id|plcip
suffix:semicolon
id|card-&gt;bchans
(braket
id|chan
)braket
dot
id|plcip
op_assign
id|plcip
suffix:semicolon
r_return
id|plcip
suffix:semicolon
)brace
DECL|function|find_plci_by_plci
r_static
id|capidrv_plci
op_star
id|find_plci_by_plci
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
id|__u32
id|plci
)paren
(brace
id|capidrv_plci
op_star
id|p
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|card-&gt;plci_list
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
r_if
c_cond
(paren
id|p-&gt;plci
op_eq
id|plci
)paren
r_return
id|p
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|find_plci_by_msgid
r_static
id|capidrv_plci
op_star
id|find_plci_by_msgid
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
id|__u16
id|msgid
)paren
(brace
id|capidrv_plci
op_star
id|p
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|card-&gt;plci_list
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
r_if
c_cond
(paren
id|p-&gt;msgid
op_eq
id|msgid
)paren
r_return
id|p
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|find_plci_by_ncci
r_static
id|capidrv_plci
op_star
id|find_plci_by_ncci
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
id|__u32
id|ncci
)paren
(brace
id|capidrv_plci
op_star
id|p
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|card-&gt;plci_list
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
r_if
c_cond
(paren
id|p-&gt;plci
op_eq
(paren
id|ncci
op_amp
l_int|0xffff
)paren
)paren
r_return
id|p
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|free_plci
r_static
r_void
id|free_plci
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
id|capidrv_plci
op_star
id|plcip
)paren
(brace
id|capidrv_plci
op_star
op_star
id|pp
suffix:semicolon
r_for
c_loop
(paren
id|pp
op_assign
op_amp
id|card-&gt;plci_list
suffix:semicolon
op_star
id|pp
suffix:semicolon
id|pp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
)paren
(brace
r_if
c_cond
(paren
op_star
id|pp
op_eq
id|plcip
)paren
(brace
op_star
id|pp
op_assign
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
id|card-&gt;bchans
(braket
id|plcip-&gt;chan
)braket
dot
id|plcip
op_assign
l_int|0
suffix:semicolon
id|card-&gt;bchans
(braket
id|plcip-&gt;chan
)braket
dot
id|disconnecting
op_assign
l_int|0
suffix:semicolon
id|card-&gt;bchans
(braket
id|plcip-&gt;chan
)braket
dot
id|incoming
op_assign
l_int|0
suffix:semicolon
id|kfree
c_func
(paren
id|plcip
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv-%d: free_plci %p (0x%x) not found, Huh?&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|plcip
comma
id|plcip-&gt;plci
)paren
suffix:semicolon
)brace
multiline_comment|/* -------- ncci management ------------------------------------------ */
DECL|function|new_ncci
r_static
r_inline
id|capidrv_ncci
op_star
id|new_ncci
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
id|capidrv_plci
op_star
id|plcip
comma
id|__u32
id|ncci
)paren
(brace
id|capidrv_ncci
op_star
id|nccip
suffix:semicolon
id|nccip
op_assign
(paren
id|capidrv_ncci
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|capidrv_ncci
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nccip
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|nccip
comma
l_int|0
comma
r_sizeof
(paren
id|capidrv_ncci
)paren
)paren
suffix:semicolon
id|nccip-&gt;ncci
op_assign
id|ncci
suffix:semicolon
id|nccip-&gt;state
op_assign
id|ST_NCCI_NONE
suffix:semicolon
id|nccip-&gt;plcip
op_assign
id|plcip
suffix:semicolon
id|nccip-&gt;chan
op_assign
id|plcip-&gt;chan
suffix:semicolon
id|nccip-&gt;datahandle
op_assign
l_int|0
suffix:semicolon
id|nccip-&gt;next
op_assign
id|plcip-&gt;ncci_list
suffix:semicolon
id|plcip-&gt;ncci_list
op_assign
id|nccip
suffix:semicolon
id|card-&gt;bchans
(braket
id|plcip-&gt;chan
)braket
dot
id|nccip
op_assign
id|nccip
suffix:semicolon
r_return
id|nccip
suffix:semicolon
)brace
DECL|function|find_ncci
r_static
r_inline
id|capidrv_ncci
op_star
id|find_ncci
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
id|__u32
id|ncci
)paren
(brace
id|capidrv_plci
op_star
id|plcip
suffix:semicolon
id|capidrv_ncci
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
(paren
id|plcip
op_assign
id|find_plci_by_ncci
c_func
(paren
id|card
comma
id|ncci
)paren
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|plcip-&gt;ncci_list
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
r_if
c_cond
(paren
id|p-&gt;ncci
op_eq
id|ncci
)paren
r_return
id|p
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|find_ncci_by_msgid
r_static
r_inline
id|capidrv_ncci
op_star
id|find_ncci_by_msgid
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
id|__u32
id|ncci
comma
id|__u16
id|msgid
)paren
(brace
id|capidrv_plci
op_star
id|plcip
suffix:semicolon
id|capidrv_ncci
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
(paren
id|plcip
op_assign
id|find_plci_by_ncci
c_func
(paren
id|card
comma
id|ncci
)paren
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|plcip-&gt;ncci_list
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
r_if
c_cond
(paren
id|p-&gt;msgid
op_eq
id|msgid
)paren
r_return
id|p
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|free_ncci
r_static
r_void
id|free_ncci
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
r_struct
id|capidrv_ncci
op_star
id|nccip
)paren
(brace
r_struct
id|capidrv_ncci
op_star
op_star
id|pp
suffix:semicolon
r_for
c_loop
(paren
id|pp
op_assign
op_amp
(paren
id|nccip-&gt;plcip-&gt;ncci_list
)paren
suffix:semicolon
op_star
id|pp
suffix:semicolon
id|pp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
)paren
(brace
r_if
c_cond
(paren
op_star
id|pp
op_eq
id|nccip
)paren
(brace
op_star
id|pp
op_assign
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|card-&gt;bchans
(braket
id|nccip-&gt;chan
)braket
dot
id|nccip
op_assign
l_int|0
suffix:semicolon
id|kfree
c_func
(paren
id|nccip
)paren
suffix:semicolon
)brace
DECL|function|capidrv_add_ack
r_static
r_int
id|capidrv_add_ack
c_func
(paren
r_struct
id|capidrv_ncci
op_star
id|nccip
comma
id|__u16
id|datahandle
comma
r_int
id|len
)paren
(brace
r_struct
id|ncci_datahandle_queue
op_star
id|n
comma
op_star
op_star
id|pp
suffix:semicolon
id|n
op_assign
(paren
r_struct
id|ncci_datahandle_queue
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ncci_datahandle_queue
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|n
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: kmalloc ncci_datahandle failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|n-&gt;next
op_assign
l_int|0
suffix:semicolon
id|n-&gt;datahandle
op_assign
id|datahandle
suffix:semicolon
id|n-&gt;len
op_assign
id|len
suffix:semicolon
r_for
c_loop
(paren
id|pp
op_assign
op_amp
id|nccip-&gt;ackqueue
suffix:semicolon
op_star
id|pp
suffix:semicolon
id|pp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
)paren
suffix:semicolon
op_star
id|pp
op_assign
id|n
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|capidrv_del_ack
r_static
r_int
id|capidrv_del_ack
c_func
(paren
r_struct
id|capidrv_ncci
op_star
id|nccip
comma
id|__u16
id|datahandle
)paren
(brace
r_struct
id|ncci_datahandle_queue
op_star
op_star
id|pp
comma
op_star
id|p
suffix:semicolon
r_int
id|len
suffix:semicolon
r_for
c_loop
(paren
id|pp
op_assign
op_amp
id|nccip-&gt;ackqueue
suffix:semicolon
op_star
id|pp
suffix:semicolon
id|pp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|datahandle
op_eq
id|datahandle
)paren
(brace
id|p
op_assign
op_star
id|pp
suffix:semicolon
id|len
op_assign
id|p-&gt;len
suffix:semicolon
op_star
id|pp
op_assign
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
id|kfree
c_func
(paren
id|p
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* -------- convert and send capi message ---------------------------- */
DECL|function|send_message
r_static
r_void
id|send_message
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
id|_cmsg
op_star
id|cmsg
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|len
suffix:semicolon
id|capi_cmsg2message
c_func
(paren
id|cmsg
comma
id|cmsg-&gt;buf
)paren
suffix:semicolon
id|len
op_assign
id|CAPIMSG_LEN
c_func
(paren
id|cmsg-&gt;buf
)paren
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|len
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
comma
id|cmsg-&gt;buf
comma
id|len
)paren
suffix:semicolon
(paren
op_star
id|capifuncs-&gt;capi_put_message
)paren
(paren
id|global.appid
comma
id|skb
)paren
suffix:semicolon
id|global.nsentctlpkt
op_increment
suffix:semicolon
)brace
multiline_comment|/* -------- state machine -------------------------------------------- */
DECL|struct|listenstatechange
r_struct
id|listenstatechange
(brace
DECL|member|actstate
r_int
id|actstate
suffix:semicolon
DECL|member|nextstate
r_int
id|nextstate
suffix:semicolon
DECL|member|event
r_int
id|event
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|listentable
r_static
r_struct
id|listenstatechange
id|listentable
(braket
)braket
op_assign
(brace
(brace
id|ST_LISTEN_NONE
comma
id|ST_LISTEN_WAIT_CONF
comma
id|EV_LISTEN_REQ
)brace
comma
(brace
id|ST_LISTEN_ACTIVE
comma
id|ST_LISTEN_ACTIVE_WAIT_CONF
comma
id|EV_LISTEN_REQ
)brace
comma
(brace
id|ST_LISTEN_WAIT_CONF
comma
id|ST_LISTEN_NONE
comma
id|EV_LISTEN_CONF_ERROR
)brace
comma
(brace
id|ST_LISTEN_ACTIVE_WAIT_CONF
comma
id|ST_LISTEN_ACTIVE
comma
id|EV_LISTEN_CONF_ERROR
)brace
comma
(brace
id|ST_LISTEN_WAIT_CONF
comma
id|ST_LISTEN_NONE
comma
id|EV_LISTEN_CONF_EMPTY
)brace
comma
(brace
id|ST_LISTEN_ACTIVE_WAIT_CONF
comma
id|ST_LISTEN_NONE
comma
id|EV_LISTEN_CONF_EMPTY
)brace
comma
(brace
id|ST_LISTEN_WAIT_CONF
comma
id|ST_LISTEN_ACTIVE
comma
id|EV_LISTEN_CONF_OK
)brace
comma
(brace
id|ST_LISTEN_ACTIVE_WAIT_CONF
comma
id|ST_LISTEN_ACTIVE
comma
id|EV_LISTEN_CONF_OK
)brace
comma
(brace
)brace
comma
)brace
suffix:semicolon
DECL|function|listen_change_state
r_static
r_void
id|listen_change_state
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
r_int
id|event
)paren
(brace
r_struct
id|listenstatechange
op_star
id|p
op_assign
id|listentable
suffix:semicolon
r_while
c_loop
(paren
id|p-&gt;event
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;state
op_eq
id|p-&gt;actstate
op_logical_and
id|p-&gt;event
op_eq
id|event
)paren
(brace
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv-%d: listen_change_state %d -&gt; %d&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|card-&gt;state
comma
id|p-&gt;nextstate
)paren
suffix:semicolon
id|card-&gt;state
op_assign
id|p-&gt;nextstate
suffix:semicolon
r_return
suffix:semicolon
)brace
id|p
op_increment
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv-%d: listen_change_state state=%d event=%d ????&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|card-&gt;state
comma
id|event
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------ */
DECL|function|p0
r_static
r_void
id|p0
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
id|capidrv_plci
op_star
id|plci
)paren
(brace
id|isdn_ctrl
id|cmd
suffix:semicolon
id|card-&gt;bchans
(braket
id|plci-&gt;chan
)braket
dot
id|contr
op_assign
l_int|0
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_DHUP
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.arg
op_assign
id|plci-&gt;chan
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|free_plci
c_func
(paren
id|card
comma
id|plci
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------ */
DECL|struct|plcistatechange
r_struct
id|plcistatechange
(brace
DECL|member|actstate
r_int
id|actstate
suffix:semicolon
DECL|member|nextstate
r_int
id|nextstate
suffix:semicolon
DECL|member|event
r_int
id|event
suffix:semicolon
DECL|member|changefunc
r_void
(paren
op_star
id|changefunc
)paren
(paren
id|capidrv_contr
op_star
id|card
comma
id|capidrv_plci
op_star
id|plci
)paren
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|plcitable
r_static
r_struct
id|plcistatechange
id|plcitable
(braket
)braket
op_assign
(brace
multiline_comment|/* P-0 */
(brace
id|ST_PLCI_NONE
comma
id|ST_PLCI_OUTGOING
comma
id|EV_PLCI_CONNECT_REQ
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_NONE
comma
id|ST_PLCI_ALLOCATED
comma
id|EV_PLCI_FACILITY_IND_UP
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_NONE
comma
id|ST_PLCI_INCOMING
comma
id|EV_PLCI_CONNECT_IND
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_NONE
comma
id|ST_PLCI_RESUMEING
comma
id|EV_PLCI_RESUME_REQ
comma
l_int|0
)brace
comma
multiline_comment|/* P-0.1 */
(brace
id|ST_PLCI_OUTGOING
comma
id|ST_PLCI_NONE
comma
id|EV_PLCI_CONNECT_CONF_ERROR
comma
id|p0
)brace
comma
(brace
id|ST_PLCI_OUTGOING
comma
id|ST_PLCI_ALLOCATED
comma
id|EV_PLCI_CONNECT_CONF_OK
comma
l_int|0
)brace
comma
multiline_comment|/* P-1 */
(brace
id|ST_PLCI_ALLOCATED
comma
id|ST_PLCI_ACTIVE
comma
id|EV_PLCI_CONNECT_ACTIVE_IND
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_ALLOCATED
comma
id|ST_PLCI_DISCONNECTING
comma
id|EV_PLCI_DISCONNECT_REQ
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_ALLOCATED
comma
id|ST_PLCI_DISCONNECTING
comma
id|EV_PLCI_FACILITY_IND_DOWN
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_ALLOCATED
comma
id|ST_PLCI_DISCONNECTED
comma
id|EV_PLCI_DISCONNECT_IND
comma
l_int|0
)brace
comma
multiline_comment|/* P-ACT */
(brace
id|ST_PLCI_ACTIVE
comma
id|ST_PLCI_DISCONNECTING
comma
id|EV_PLCI_DISCONNECT_REQ
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_ACTIVE
comma
id|ST_PLCI_DISCONNECTING
comma
id|EV_PLCI_FACILITY_IND_DOWN
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_ACTIVE
comma
id|ST_PLCI_DISCONNECTED
comma
id|EV_PLCI_DISCONNECT_IND
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_ACTIVE
comma
id|ST_PLCI_HELD
comma
id|EV_PLCI_HOLD_IND
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_ACTIVE
comma
id|ST_PLCI_DISCONNECTING
comma
id|EV_PLCI_SUSPEND_IND
comma
l_int|0
)brace
comma
multiline_comment|/* P-2 */
(brace
id|ST_PLCI_INCOMING
comma
id|ST_PLCI_DISCONNECTING
comma
id|EV_PLCI_CONNECT_REJECT
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_INCOMING
comma
id|ST_PLCI_FACILITY_IND
comma
id|EV_PLCI_FACILITY_IND_UP
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_INCOMING
comma
id|ST_PLCI_ACCEPTING
comma
id|EV_PLCI_CONNECT_RESP
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_INCOMING
comma
id|ST_PLCI_DISCONNECTING
comma
id|EV_PLCI_DISCONNECT_REQ
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_INCOMING
comma
id|ST_PLCI_DISCONNECTING
comma
id|EV_PLCI_FACILITY_IND_DOWN
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_INCOMING
comma
id|ST_PLCI_DISCONNECTED
comma
id|EV_PLCI_DISCONNECT_IND
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_INCOMING
comma
id|ST_PLCI_DISCONNECTING
comma
id|EV_PLCI_CD_IND
comma
l_int|0
)brace
comma
multiline_comment|/* P-3 */
(brace
id|ST_PLCI_FACILITY_IND
comma
id|ST_PLCI_DISCONNECTING
comma
id|EV_PLCI_CONNECT_REJECT
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_FACILITY_IND
comma
id|ST_PLCI_ACCEPTING
comma
id|EV_PLCI_CONNECT_ACTIVE_IND
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_FACILITY_IND
comma
id|ST_PLCI_DISCONNECTING
comma
id|EV_PLCI_DISCONNECT_REQ
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_FACILITY_IND
comma
id|ST_PLCI_DISCONNECTING
comma
id|EV_PLCI_FACILITY_IND_DOWN
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_FACILITY_IND
comma
id|ST_PLCI_DISCONNECTED
comma
id|EV_PLCI_DISCONNECT_IND
comma
l_int|0
)brace
comma
multiline_comment|/* P-4 */
(brace
id|ST_PLCI_ACCEPTING
comma
id|ST_PLCI_ACTIVE
comma
id|EV_PLCI_CONNECT_ACTIVE_IND
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_ACCEPTING
comma
id|ST_PLCI_DISCONNECTING
comma
id|EV_PLCI_DISCONNECT_REQ
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_ACCEPTING
comma
id|ST_PLCI_DISCONNECTING
comma
id|EV_PLCI_FACILITY_IND_DOWN
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_ACCEPTING
comma
id|ST_PLCI_DISCONNECTED
comma
id|EV_PLCI_DISCONNECT_IND
comma
l_int|0
)brace
comma
multiline_comment|/* P-5 */
(brace
id|ST_PLCI_DISCONNECTING
comma
id|ST_PLCI_DISCONNECTED
comma
id|EV_PLCI_DISCONNECT_IND
comma
l_int|0
)brace
comma
multiline_comment|/* P-6 */
(brace
id|ST_PLCI_DISCONNECTED
comma
id|ST_PLCI_NONE
comma
id|EV_PLCI_DISCONNECT_RESP
comma
id|p0
)brace
comma
multiline_comment|/* P-0.Res */
(brace
id|ST_PLCI_RESUMEING
comma
id|ST_PLCI_NONE
comma
id|EV_PLCI_RESUME_CONF_ERROR
comma
id|p0
)brace
comma
(brace
id|ST_PLCI_RESUMEING
comma
id|ST_PLCI_RESUME
comma
id|EV_PLCI_RESUME_CONF_OK
comma
l_int|0
)brace
comma
multiline_comment|/* P-RES */
(brace
id|ST_PLCI_RESUME
comma
id|ST_PLCI_ACTIVE
comma
id|EV_PLCI_RESUME_IND
comma
l_int|0
)brace
comma
multiline_comment|/* P-HELD */
(brace
id|ST_PLCI_HELD
comma
id|ST_PLCI_ACTIVE
comma
id|EV_PLCI_RETRIEVE_IND
comma
l_int|0
)brace
comma
(brace
)brace
comma
)brace
suffix:semicolon
DECL|function|plci_change_state
r_static
r_void
id|plci_change_state
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
id|capidrv_plci
op_star
id|plci
comma
r_int
id|event
)paren
(brace
r_struct
id|plcistatechange
op_star
id|p
op_assign
id|plcitable
suffix:semicolon
r_while
c_loop
(paren
id|p-&gt;event
)paren
(brace
r_if
c_cond
(paren
id|plci-&gt;state
op_eq
id|p-&gt;actstate
op_logical_and
id|p-&gt;event
op_eq
id|event
)paren
(brace
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv-%d: plci_change_state:0x%x %d -&gt; %d&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|plci-&gt;plci
comma
id|plci-&gt;state
comma
id|p-&gt;nextstate
)paren
suffix:semicolon
id|plci-&gt;state
op_assign
id|p-&gt;nextstate
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;changefunc
)paren
id|p
op_member_access_from_pointer
id|changefunc
c_func
(paren
id|card
comma
id|plci
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|p
op_increment
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv-%d: plci_change_state:0x%x state=%d event=%d ????&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|plci-&gt;plci
comma
id|plci-&gt;state
comma
id|event
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------ */
DECL|variable|cmsg
r_static
id|_cmsg
id|cmsg
suffix:semicolon
DECL|function|n0
r_static
r_void
id|n0
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
id|capidrv_ncci
op_star
id|ncci
)paren
(brace
id|isdn_ctrl
id|cmd
suffix:semicolon
id|capi_fill_DISCONNECT_REQ
c_func
(paren
op_amp
id|cmsg
comma
id|global.appid
comma
id|card-&gt;msgid
op_increment
comma
id|ncci-&gt;plcip-&gt;plci
comma
l_int|0
comma
multiline_comment|/* BChannelinformation */
l_int|0
comma
multiline_comment|/* Keypadfacility */
l_int|0
comma
multiline_comment|/* Useruserdata */
multiline_comment|/* $$$$ */
l_int|0
multiline_comment|/* Facilitydataarray */
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
op_amp
id|cmsg
)paren
suffix:semicolon
id|plci_change_state
c_func
(paren
id|card
comma
id|ncci-&gt;plcip
comma
id|EV_PLCI_DISCONNECT_REQ
)paren
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_BHUP
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.arg
op_assign
id|ncci-&gt;chan
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|free_ncci
c_func
(paren
id|card
comma
id|ncci
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------ */
DECL|struct|nccistatechange
r_struct
id|nccistatechange
(brace
DECL|member|actstate
r_int
id|actstate
suffix:semicolon
DECL|member|nextstate
r_int
id|nextstate
suffix:semicolon
DECL|member|event
r_int
id|event
suffix:semicolon
DECL|member|changefunc
r_void
(paren
op_star
id|changefunc
)paren
(paren
id|capidrv_contr
op_star
id|card
comma
id|capidrv_ncci
op_star
id|ncci
)paren
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|nccitable
r_static
r_struct
id|nccistatechange
id|nccitable
(braket
)braket
op_assign
(brace
multiline_comment|/* N-0 */
(brace
id|ST_NCCI_NONE
comma
id|ST_NCCI_OUTGOING
comma
id|EV_NCCI_CONNECT_B3_REQ
comma
l_int|0
)brace
comma
(brace
id|ST_NCCI_NONE
comma
id|ST_NCCI_INCOMING
comma
id|EV_NCCI_CONNECT_B3_IND
comma
l_int|0
)brace
comma
multiline_comment|/* N-0.1 */
(brace
id|ST_NCCI_OUTGOING
comma
id|ST_NCCI_ALLOCATED
comma
id|EV_NCCI_CONNECT_B3_CONF_OK
comma
l_int|0
)brace
comma
(brace
id|ST_NCCI_OUTGOING
comma
id|ST_NCCI_NONE
comma
id|EV_NCCI_CONNECT_B3_CONF_ERROR
comma
id|n0
)brace
comma
multiline_comment|/* N-1 */
(brace
id|ST_NCCI_INCOMING
comma
id|ST_NCCI_DISCONNECTING
comma
id|EV_NCCI_CONNECT_B3_REJECT
comma
l_int|0
)brace
comma
(brace
id|ST_NCCI_INCOMING
comma
id|ST_NCCI_ALLOCATED
comma
id|EV_NCCI_CONNECT_B3_RESP
comma
l_int|0
)brace
comma
(brace
id|ST_NCCI_INCOMING
comma
id|ST_NCCI_DISCONNECTED
comma
id|EV_NCCI_DISCONNECT_B3_IND
comma
l_int|0
)brace
comma
(brace
id|ST_NCCI_INCOMING
comma
id|ST_NCCI_DISCONNECTING
comma
id|EV_NCCI_DISCONNECT_B3_REQ
comma
l_int|0
)brace
comma
multiline_comment|/* N-2 */
(brace
id|ST_NCCI_ALLOCATED
comma
id|ST_NCCI_ACTIVE
comma
id|EV_NCCI_CONNECT_B3_ACTIVE_IND
comma
l_int|0
)brace
comma
(brace
id|ST_NCCI_ALLOCATED
comma
id|ST_NCCI_DISCONNECTED
comma
id|EV_NCCI_DISCONNECT_B3_IND
comma
l_int|0
)brace
comma
(brace
id|ST_NCCI_ALLOCATED
comma
id|ST_NCCI_DISCONNECTING
comma
id|EV_NCCI_DISCONNECT_B3_REQ
comma
l_int|0
)brace
comma
multiline_comment|/* N-ACT */
(brace
id|ST_NCCI_ACTIVE
comma
id|ST_NCCI_ACTIVE
comma
id|EV_NCCI_RESET_B3_IND
comma
l_int|0
)brace
comma
(brace
id|ST_NCCI_ACTIVE
comma
id|ST_NCCI_RESETING
comma
id|EV_NCCI_RESET_B3_REQ
comma
l_int|0
)brace
comma
(brace
id|ST_NCCI_ACTIVE
comma
id|ST_NCCI_DISCONNECTED
comma
id|EV_NCCI_DISCONNECT_B3_IND
comma
l_int|0
)brace
comma
(brace
id|ST_NCCI_ACTIVE
comma
id|ST_NCCI_DISCONNECTING
comma
id|EV_NCCI_DISCONNECT_B3_REQ
comma
l_int|0
)brace
comma
multiline_comment|/* N-3 */
(brace
id|ST_NCCI_RESETING
comma
id|ST_NCCI_ACTIVE
comma
id|EV_NCCI_RESET_B3_IND
comma
l_int|0
)brace
comma
(brace
id|ST_NCCI_RESETING
comma
id|ST_NCCI_DISCONNECTED
comma
id|EV_NCCI_DISCONNECT_B3_IND
comma
l_int|0
)brace
comma
(brace
id|ST_NCCI_RESETING
comma
id|ST_NCCI_DISCONNECTING
comma
id|EV_NCCI_DISCONNECT_B3_REQ
comma
l_int|0
)brace
comma
multiline_comment|/* N-4 */
(brace
id|ST_NCCI_DISCONNECTING
comma
id|ST_NCCI_DISCONNECTED
comma
id|EV_NCCI_DISCONNECT_B3_IND
comma
l_int|0
)brace
comma
(brace
id|ST_NCCI_DISCONNECTING
comma
id|ST_NCCI_PREVIOUS
comma
id|EV_NCCI_DISCONNECT_B3_CONF_ERROR
comma
l_int|0
)brace
comma
multiline_comment|/* N-5 */
(brace
id|ST_NCCI_DISCONNECTED
comma
id|ST_NCCI_NONE
comma
id|EV_NCCI_DISCONNECT_B3_RESP
comma
id|n0
)brace
comma
(brace
)brace
comma
)brace
suffix:semicolon
DECL|function|ncci_change_state
r_static
r_void
id|ncci_change_state
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
id|capidrv_ncci
op_star
id|ncci
comma
r_int
id|event
)paren
(brace
r_struct
id|nccistatechange
op_star
id|p
op_assign
id|nccitable
suffix:semicolon
r_while
c_loop
(paren
id|p-&gt;event
)paren
(brace
r_if
c_cond
(paren
id|ncci-&gt;state
op_eq
id|p-&gt;actstate
op_logical_and
id|p-&gt;event
op_eq
id|event
)paren
(brace
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv-%d: ncci_change_state:0x%x %d -&gt; %d&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|ncci-&gt;ncci
comma
id|ncci-&gt;state
comma
id|p-&gt;nextstate
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;nextstate
op_eq
id|ST_NCCI_PREVIOUS
)paren
(brace
id|ncci-&gt;state
op_assign
id|ncci-&gt;oldstate
suffix:semicolon
id|ncci-&gt;oldstate
op_assign
id|p-&gt;actstate
suffix:semicolon
)brace
r_else
(brace
id|ncci-&gt;oldstate
op_assign
id|p-&gt;actstate
suffix:semicolon
id|ncci-&gt;state
op_assign
id|p-&gt;nextstate
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p-&gt;changefunc
)paren
id|p
op_member_access_from_pointer
id|changefunc
c_func
(paren
id|card
comma
id|ncci
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|p
op_increment
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv-%d: ncci_change_state:0x%x state=%d event=%d ????&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|ncci-&gt;ncci
comma
id|ncci-&gt;state
comma
id|event
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------- */
DECL|function|new_bchan
r_static
r_inline
r_int
id|new_bchan
c_func
(paren
id|capidrv_contr
op_star
id|card
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|card-&gt;nbchan
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;bchans
(braket
id|i
)braket
dot
id|plcip
op_eq
l_int|0
)paren
(brace
id|card-&gt;bchans
(braket
id|i
)braket
dot
id|disconnecting
op_assign
l_int|0
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------- */
DECL|function|handle_controller
r_static
r_void
id|handle_controller
c_func
(paren
id|_cmsg
op_star
id|cmsg
)paren
(brace
id|capidrv_contr
op_star
id|card
op_assign
id|findcontrbynumber
c_func
(paren
id|cmsg-&gt;adr.adrController
op_amp
l_int|0x7f
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: %s from unknown controller 0x%x&bslash;n&quot;
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;adr.adrController
op_amp
l_int|0x7f
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|CAPICMD
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
)paren
(brace
r_case
id|CAPI_LISTEN_CONF
suffix:colon
multiline_comment|/* Controller */
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv-%d: listenconf Info=0x%4x (%s) cipmask=0x%x&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|cmsg-&gt;Info
comma
id|capi_info2str
c_func
(paren
id|cmsg-&gt;Info
)paren
comma
id|card-&gt;cipmask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmsg-&gt;Info
)paren
(brace
id|listen_change_state
c_func
(paren
id|card
comma
id|EV_LISTEN_CONF_ERROR
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|card-&gt;cipmask
op_eq
l_int|0
)paren
(brace
id|listen_change_state
c_func
(paren
id|card
comma
id|EV_LISTEN_CONF_EMPTY
)paren
suffix:semicolon
)brace
r_else
(brace
id|listen_change_state
c_func
(paren
id|card
comma
id|EV_LISTEN_CONF_OK
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CAPI_MANUFACTURER_IND
suffix:colon
multiline_comment|/* Controller */
r_if
c_cond
(paren
id|cmsg-&gt;ManuID
op_eq
l_int|0x214D5641
op_logical_and
id|cmsg-&gt;Class
op_eq
l_int|0
op_logical_and
id|cmsg-&gt;Function
op_eq
l_int|1
)paren
(brace
id|__u8
op_star
id|data
op_assign
id|cmsg-&gt;ManuData
op_plus
l_int|3
suffix:semicolon
id|__u16
id|len
op_assign
id|cmsg-&gt;ManuData
(braket
l_int|0
)braket
suffix:semicolon
id|__u16
id|layer
suffix:semicolon
r_int
id|direction
suffix:semicolon
r_if
c_cond
(paren
id|len
op_eq
l_int|255
)paren
(brace
id|len
op_assign
(paren
id|cmsg-&gt;ManuData
(braket
l_int|1
)braket
op_or
(paren
id|cmsg-&gt;ManuData
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
id|data
op_add_assign
l_int|2
suffix:semicolon
)brace
id|len
op_sub_assign
l_int|2
suffix:semicolon
id|layer
op_assign
(paren
(paren
op_star
(paren
id|data
op_minus
l_int|1
)paren
)paren
op_lshift
l_int|8
)paren
op_or
op_star
(paren
id|data
op_minus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|layer
op_amp
l_int|0x300
)paren
id|direction
op_assign
(paren
id|layer
op_amp
l_int|0x200
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_else
id|direction
op_assign
(paren
id|layer
op_amp
l_int|0x800
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|layer
op_amp
l_int|0x0C00
)paren
(brace
r_if
c_cond
(paren
(paren
id|layer
op_amp
l_int|0xff
)paren
op_eq
l_int|0x80
)paren
(brace
id|handle_dtrace_data
c_func
(paren
id|card
comma
id|direction
comma
l_int|1
comma
id|data
comma
id|len
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|layer
op_amp
l_int|0xff
)paren
OL
l_int|0x80
)paren
(brace
id|handle_dtrace_data
c_func
(paren
id|card
comma
id|direction
comma
l_int|0
comma
id|data
comma
id|len
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv-%d: %s from controller 0x%x layer 0x%x, ignored&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;adr.adrController
comma
id|layer
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_goto
id|ignored
suffix:semicolon
r_case
id|CAPI_MANUFACTURER_CONF
suffix:colon
multiline_comment|/* Controller */
r_if
c_cond
(paren
id|cmsg-&gt;ManuID
op_eq
l_int|0x214D5641
)paren
(brace
r_char
op_star
id|s
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|cmsg-&gt;Class
)paren
(brace
r_case
l_int|0
suffix:colon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|s
op_assign
l_string|&quot;unknown class&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|s
op_assign
l_string|&quot;unknown function&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|s
op_assign
l_string|&quot;unkown error&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv-%d: %s from controller 0x%x function %d: %s&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;adr.adrController
comma
id|cmsg-&gt;Function
comma
id|s
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_goto
id|ignored
suffix:semicolon
r_case
id|CAPI_FACILITY_IND
suffix:colon
multiline_comment|/* Controller/plci/ncci */
r_goto
id|ignored
suffix:semicolon
r_case
id|CAPI_FACILITY_CONF
suffix:colon
multiline_comment|/* Controller/plci/ncci */
r_goto
id|ignored
suffix:semicolon
r_case
id|CAPI_INFO_IND
suffix:colon
multiline_comment|/* Controller/plci */
r_goto
id|ignored
suffix:semicolon
r_case
id|CAPI_INFO_CONF
suffix:colon
multiline_comment|/* Controller/plci */
r_goto
id|ignored
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv-%d: got %s from controller 0x%x ???&quot;
comma
id|card-&gt;contrnr
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;adr.adrController
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
id|ignored
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv-%d: %s from controller 0x%x ignored&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;adr.adrController
)paren
suffix:semicolon
)brace
DECL|function|handle_incoming_call
r_static
r_void
id|handle_incoming_call
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
id|_cmsg
op_star
id|cmsg
)paren
(brace
id|capidrv_plci
op_star
id|plcip
suffix:semicolon
id|capidrv_bchan
op_star
id|bchan
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
r_int
id|chan
suffix:semicolon
r_if
c_cond
(paren
(paren
id|chan
op_assign
id|new_bchan
c_func
(paren
id|card
)paren
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv-%d: incoming call on not existing bchan ?&bslash;n&quot;
comma
id|card-&gt;contrnr
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|bchan
op_assign
op_amp
id|card-&gt;bchans
(braket
id|chan
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|plcip
op_assign
id|new_plci
c_func
(paren
id|card
comma
id|chan
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv-%d: incoming call: no memory, sorry.&bslash;n&quot;
comma
id|card-&gt;contrnr
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|bchan-&gt;incoming
op_assign
l_int|1
suffix:semicolon
id|plcip-&gt;plci
op_assign
id|cmsg-&gt;adr.adrPLCI
suffix:semicolon
id|plci_change_state
c_func
(paren
id|card
comma
id|plcip
comma
id|EV_PLCI_CONNECT_IND
)paren
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_ICALL
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.arg
op_assign
id|chan
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|cmd.parm.setup
comma
l_int|0
comma
r_sizeof
(paren
id|cmd.parm.setup
)paren
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|cmd.parm.setup.phone
comma
id|cmsg-&gt;CallingPartyNumber
op_plus
l_int|3
comma
id|cmsg-&gt;CallingPartyNumber
(braket
l_int|0
)braket
op_minus
l_int|2
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|cmd.parm.setup.eazmsn
comma
id|cmsg-&gt;CalledPartyNumber
op_plus
l_int|2
comma
id|cmsg-&gt;CalledPartyNumber
(braket
l_int|0
)braket
op_minus
l_int|1
)paren
suffix:semicolon
id|cmd.parm.setup.si1
op_assign
id|cip2si1
c_func
(paren
id|cmsg-&gt;CIPValue
)paren
suffix:semicolon
id|cmd.parm.setup.si2
op_assign
id|cip2si2
c_func
(paren
id|cmsg-&gt;CIPValue
)paren
suffix:semicolon
id|cmd.parm.setup.plan
op_assign
id|cmsg-&gt;CallingPartyNumber
(braket
l_int|1
)braket
suffix:semicolon
id|cmd.parm.setup.screen
op_assign
id|cmsg-&gt;CallingPartyNumber
(braket
l_int|2
)braket
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv-%d: incoming call %s,%d,%d,%s&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|cmd.parm.setup.phone
comma
id|cmd.parm.setup.si1
comma
id|cmd.parm.setup.si2
comma
id|cmd.parm.setup.eazmsn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd.parm.setup.si1
op_eq
l_int|1
op_logical_and
id|cmd.parm.setup.si2
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv-%d: patching si2=%d to 0 for VBOX&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|cmd.parm.setup.si2
)paren
suffix:semicolon
id|cmd.parm.setup.si2
op_assign
l_int|0
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
)paren
(brace
r_case
l_int|0
suffix:colon
r_case
l_int|3
suffix:colon
multiline_comment|/* No device matching this call.&n;&t;&t; * and isdn_common.c has send a HANGUP command&n;&t;&t; * which is ignored in state ST_PLCI_INCOMING,&n;&t;&t; * so we send RESP to ignore the call&n;&t;&t; */
id|capi_cmsg_answer
c_func
(paren
id|cmsg
)paren
suffix:semicolon
id|cmsg-&gt;Reject
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* ignore */
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
id|plci_change_state
c_func
(paren
id|card
comma
id|plcip
comma
id|EV_PLCI_CONNECT_REJECT
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv-%d: incoming call %s,%d,%d,%s ignored&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|cmd.parm.setup.phone
comma
id|cmd.parm.setup.si1
comma
id|cmd.parm.setup.si2
comma
id|cmd.parm.setup.eazmsn
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* At least one device matching this call (RING on ttyI)&n;&t;&t; * HL-driver may send ALERTING on the D-channel in this&n;&t;&t; * case.&n;&t;&t; * really means: RING on ttyI or a net interface&n;&t;&t; * accepted this call already.&n;&t;&t; *&n;&t;&t; * If the call was accepted, state has already changed,&n;&t;&t; * and CONNECT_RESP already sent.&n;&t;&t; */
r_if
c_cond
(paren
id|plcip-&gt;state
op_eq
id|ST_PLCI_INCOMING
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv-%d: incoming call %s,%d,%d,%s tty alerting&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|cmd.parm.setup.phone
comma
id|cmd.parm.setup.si1
comma
id|cmd.parm.setup.si2
comma
id|cmd.parm.setup.eazmsn
)paren
suffix:semicolon
id|capi_fill_ALERT_REQ
c_func
(paren
id|cmsg
comma
id|global.appid
comma
id|card-&gt;msgid
op_increment
comma
id|plcip-&gt;plci
comma
multiline_comment|/* adr */
l_int|0
comma
multiline_comment|/* BChannelinformation */
l_int|0
comma
multiline_comment|/* Keypadfacility */
l_int|0
comma
multiline_comment|/* Useruserdata */
l_int|0
multiline_comment|/* Facilitydataarray */
)paren
suffix:semicolon
id|plcip-&gt;msgid
op_assign
id|cmsg-&gt;Messagenumber
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv-%d: incoming call %s,%d,%d,%s on netdev&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|cmd.parm.setup.phone
comma
id|cmd.parm.setup.si1
comma
id|cmd.parm.setup.si2
comma
id|cmd.parm.setup.eazmsn
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* Call will be rejected. */
id|capi_cmsg_answer
c_func
(paren
id|cmsg
)paren
suffix:semicolon
id|cmsg-&gt;Reject
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* reject call, normal call clearing */
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
id|plci_change_state
c_func
(paren
id|card
comma
id|plcip
comma
id|EV_PLCI_CONNECT_REJECT
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* An error happened. (Invalid parameters for example.) */
id|capi_cmsg_answer
c_func
(paren
id|cmsg
)paren
suffix:semicolon
id|cmsg-&gt;Reject
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* reject call,&n;&t;&t;&t;&t;&t;   destination out of order */
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
id|plci_change_state
c_func
(paren
id|card
comma
id|plcip
comma
id|EV_PLCI_CONNECT_REJECT
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|handle_plci
r_static
r_void
id|handle_plci
c_func
(paren
id|_cmsg
op_star
id|cmsg
)paren
(brace
id|capidrv_contr
op_star
id|card
op_assign
id|findcontrbynumber
c_func
(paren
id|cmsg-&gt;adr.adrController
op_amp
l_int|0x7f
)paren
suffix:semicolon
id|capidrv_plci
op_star
id|plcip
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: %s from unknown controller 0x%x&bslash;n&quot;
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;adr.adrController
op_amp
l_int|0x7f
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|CAPICMD
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
)paren
(brace
r_case
id|CAPI_DISCONNECT_IND
suffix:colon
multiline_comment|/* plci */
r_if
c_cond
(paren
id|cmsg-&gt;Reason
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv-%d: %s reason 0x%x (%s) for plci 0x%x&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;Reason
comma
id|capi_info2str
c_func
(paren
id|cmsg-&gt;Reason
)paren
comma
id|cmsg-&gt;adr.adrPLCI
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|plcip
op_assign
id|find_plci_by_plci
c_func
(paren
id|card
comma
id|cmsg-&gt;adr.adrPLCI
)paren
)paren
)paren
(brace
id|capi_cmsg_answer
c_func
(paren
id|cmsg
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
r_goto
id|notfound
suffix:semicolon
)brace
id|card-&gt;bchans
(braket
id|plcip-&gt;chan
)braket
dot
id|disconnecting
op_assign
l_int|1
suffix:semicolon
id|plci_change_state
c_func
(paren
id|card
comma
id|plcip
comma
id|EV_PLCI_DISCONNECT_IND
)paren
suffix:semicolon
id|capi_cmsg_answer
c_func
(paren
id|cmsg
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
id|plci_change_state
c_func
(paren
id|card
comma
id|plcip
comma
id|EV_PLCI_DISCONNECT_RESP
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CAPI_DISCONNECT_CONF
suffix:colon
multiline_comment|/* plci */
r_if
c_cond
(paren
id|cmsg-&gt;Info
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv-%d: %s info 0x%x (%s) for plci 0x%x&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;Info
comma
id|capi_info2str
c_func
(paren
id|cmsg-&gt;Info
)paren
comma
id|cmsg-&gt;adr.adrPLCI
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|plcip
op_assign
id|find_plci_by_plci
c_func
(paren
id|card
comma
id|cmsg-&gt;adr.adrPLCI
)paren
)paren
)paren
r_goto
id|notfound
suffix:semicolon
id|card-&gt;bchans
(braket
id|plcip-&gt;chan
)braket
dot
id|disconnecting
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CAPI_ALERT_CONF
suffix:colon
multiline_comment|/* plci */
r_if
c_cond
(paren
id|cmsg-&gt;Info
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv-%d: %s info 0x%x (%s) for plci 0x%x&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;Info
comma
id|capi_info2str
c_func
(paren
id|cmsg-&gt;Info
)paren
comma
id|cmsg-&gt;adr.adrPLCI
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CAPI_CONNECT_IND
suffix:colon
multiline_comment|/* plci */
id|handle_incoming_call
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CAPI_CONNECT_CONF
suffix:colon
multiline_comment|/* plci */
r_if
c_cond
(paren
id|cmsg-&gt;Info
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv-%d: %s info 0x%x (%s) for plci 0x%x&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;Info
comma
id|capi_info2str
c_func
(paren
id|cmsg-&gt;Info
)paren
comma
id|cmsg-&gt;adr.adrPLCI
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|plcip
op_assign
id|find_plci_by_msgid
c_func
(paren
id|card
comma
id|cmsg-&gt;Messagenumber
)paren
)paren
)paren
r_goto
id|notfound
suffix:semicolon
id|plcip-&gt;plci
op_assign
id|cmsg-&gt;adr.adrPLCI
suffix:semicolon
r_if
c_cond
(paren
id|cmsg-&gt;Info
)paren
(brace
id|plci_change_state
c_func
(paren
id|card
comma
id|plcip
comma
id|EV_PLCI_CONNECT_CONF_ERROR
)paren
suffix:semicolon
)brace
r_else
(brace
id|plci_change_state
c_func
(paren
id|card
comma
id|plcip
comma
id|EV_PLCI_CONNECT_CONF_OK
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CAPI_CONNECT_ACTIVE_IND
suffix:colon
multiline_comment|/* plci */
r_if
c_cond
(paren
op_logical_neg
(paren
id|plcip
op_assign
id|find_plci_by_plci
c_func
(paren
id|card
comma
id|cmsg-&gt;adr.adrPLCI
)paren
)paren
)paren
r_goto
id|notfound
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;bchans
(braket
id|plcip-&gt;chan
)braket
dot
id|incoming
)paren
(brace
id|capi_cmsg_answer
c_func
(paren
id|cmsg
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
id|plci_change_state
c_func
(paren
id|card
comma
id|plcip
comma
id|EV_PLCI_CONNECT_ACTIVE_IND
)paren
suffix:semicolon
)brace
r_else
(brace
id|capidrv_ncci
op_star
id|nccip
suffix:semicolon
id|capi_cmsg_answer
c_func
(paren
id|cmsg
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
id|nccip
op_assign
id|new_ncci
c_func
(paren
id|card
comma
id|plcip
comma
id|cmsg-&gt;adr.adrPLCI
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nccip
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv-%d: no mem for ncci, sorry&bslash;n&quot;
comma
id|card-&gt;contrnr
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* $$$$ */
)brace
id|capi_fill_CONNECT_B3_REQ
c_func
(paren
id|cmsg
comma
id|global.appid
comma
id|card-&gt;msgid
op_increment
comma
id|plcip-&gt;plci
comma
multiline_comment|/* adr */
l_int|0
multiline_comment|/* NCPI */
)paren
suffix:semicolon
id|nccip-&gt;msgid
op_assign
id|cmsg-&gt;Messagenumber
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_DCONN
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.arg
op_assign
id|plcip-&gt;chan
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|plci_change_state
c_func
(paren
id|card
comma
id|plcip
comma
id|EV_PLCI_CONNECT_ACTIVE_IND
)paren
suffix:semicolon
id|ncci_change_state
c_func
(paren
id|card
comma
id|nccip
comma
id|EV_NCCI_CONNECT_B3_REQ
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CAPI_INFO_IND
suffix:colon
multiline_comment|/* Controller/plci */
r_if
c_cond
(paren
op_logical_neg
(paren
id|plcip
op_assign
id|find_plci_by_plci
c_func
(paren
id|card
comma
id|cmsg-&gt;adr.adrPLCI
)paren
)paren
)paren
r_goto
id|notfound
suffix:semicolon
r_if
c_cond
(paren
id|cmsg-&gt;InfoNumber
op_eq
l_int|0x4000
)paren
(brace
r_if
c_cond
(paren
id|cmsg-&gt;InfoElement
(braket
l_int|0
)braket
op_eq
l_int|4
)paren
(brace
id|cmd.command
op_assign
id|ISDN_STAT_CINF
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.arg
op_assign
id|plcip-&gt;chan
suffix:semicolon
id|sprintf
c_func
(paren
id|cmd.parm.num
comma
l_string|&quot;%lu&quot;
comma
(paren
r_int
r_int
)paren
(paren
(paren
id|__u32
)paren
id|cmsg-&gt;InfoElement
(braket
l_int|1
)braket
op_or
(paren
(paren
id|__u32
)paren
(paren
id|cmsg-&gt;InfoElement
(braket
l_int|2
)braket
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|__u32
)paren
(paren
id|cmsg-&gt;InfoElement
(braket
l_int|3
)braket
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|__u32
)paren
(paren
id|cmsg-&gt;InfoElement
(braket
l_int|4
)braket
)paren
op_lshift
l_int|24
)paren
)paren
)paren
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv-%d: %s&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|capi_cmsg2str
c_func
(paren
id|cmsg
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CAPI_CONNECT_ACTIVE_CONF
suffix:colon
multiline_comment|/* plci */
r_goto
id|ignored
suffix:semicolon
r_case
id|CAPI_SELECT_B_PROTOCOL_CONF
suffix:colon
multiline_comment|/* plci */
r_goto
id|ignored
suffix:semicolon
r_case
id|CAPI_FACILITY_IND
suffix:colon
multiline_comment|/* Controller/plci/ncci */
r_goto
id|ignored
suffix:semicolon
r_case
id|CAPI_FACILITY_CONF
suffix:colon
multiline_comment|/* Controller/plci/ncci */
r_goto
id|ignored
suffix:semicolon
r_case
id|CAPI_INFO_CONF
suffix:colon
multiline_comment|/* Controller/plci */
r_goto
id|ignored
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv-%d: got %s for plci 0x%x ???&quot;
comma
id|card-&gt;contrnr
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;adr.adrPLCI
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
id|ignored
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv-%d: %s for plci 0x%x ignored&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;adr.adrPLCI
)paren
suffix:semicolon
r_return
suffix:semicolon
id|notfound
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv-%d: %s: plci 0x%x not found&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;adr.adrPLCI
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|handle_ncci
r_static
r_void
id|handle_ncci
c_func
(paren
id|_cmsg
op_star
id|cmsg
)paren
(brace
id|capidrv_contr
op_star
id|card
op_assign
id|findcontrbynumber
c_func
(paren
id|cmsg-&gt;adr.adrController
op_amp
l_int|0x7f
)paren
suffix:semicolon
id|capidrv_plci
op_star
id|plcip
suffix:semicolon
id|capidrv_ncci
op_star
id|nccip
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
r_int
id|len
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: %s from unknown controller 0x%x&bslash;n&quot;
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;adr.adrController
op_amp
l_int|0x7f
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|CAPICMD
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
)paren
(brace
r_case
id|CAPI_CONNECT_B3_ACTIVE_IND
suffix:colon
multiline_comment|/* ncci */
r_if
c_cond
(paren
op_logical_neg
(paren
id|nccip
op_assign
id|find_ncci
c_func
(paren
id|card
comma
id|cmsg-&gt;adr.adrNCCI
)paren
)paren
)paren
r_goto
id|notfound
suffix:semicolon
id|capi_cmsg_answer
c_func
(paren
id|cmsg
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
id|ncci_change_state
c_func
(paren
id|card
comma
id|nccip
comma
id|EV_NCCI_CONNECT_B3_ACTIVE_IND
)paren
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_BCONN
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.arg
op_assign
id|nccip-&gt;chan
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv-%d: chan %d up with ncci 0x%x&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|nccip-&gt;chan
comma
id|nccip-&gt;ncci
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CAPI_CONNECT_B3_ACTIVE_CONF
suffix:colon
multiline_comment|/* ncci */
r_goto
id|ignored
suffix:semicolon
r_case
id|CAPI_CONNECT_B3_IND
suffix:colon
multiline_comment|/* ncci */
id|plcip
op_assign
id|find_plci_by_ncci
c_func
(paren
id|card
comma
id|cmsg-&gt;adr.adrNCCI
)paren
suffix:semicolon
r_if
c_cond
(paren
id|plcip
)paren
(brace
id|nccip
op_assign
id|new_ncci
c_func
(paren
id|card
comma
id|plcip
comma
id|cmsg-&gt;adr.adrNCCI
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nccip
)paren
(brace
id|ncci_change_state
c_func
(paren
id|card
comma
id|nccip
comma
id|EV_NCCI_CONNECT_B3_IND
)paren
suffix:semicolon
id|capi_fill_CONNECT_B3_RESP
c_func
(paren
id|cmsg
comma
id|global.appid
comma
id|card-&gt;msgid
op_increment
comma
id|nccip-&gt;ncci
comma
multiline_comment|/* adr */
l_int|0
comma
multiline_comment|/* Reject */
l_int|0
multiline_comment|/* NCPI */
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
id|ncci_change_state
c_func
(paren
id|card
comma
id|nccip
comma
id|EV_NCCI_CONNECT_B3_RESP
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv-%d: no mem for ncci, sorry&bslash;n&quot;
comma
id|card-&gt;contrnr
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv-%d: %s: plci for ncci 0x%x not found&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;adr.adrNCCI
)paren
suffix:semicolon
)brace
id|capi_fill_CONNECT_B3_RESP
c_func
(paren
id|cmsg
comma
id|global.appid
comma
id|card-&gt;msgid
op_increment
comma
id|cmsg-&gt;adr.adrNCCI
comma
l_int|2
comma
multiline_comment|/* Reject */
l_int|0
multiline_comment|/* NCPI */
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CAPI_CONNECT_B3_CONF
suffix:colon
multiline_comment|/* ncci */
r_if
c_cond
(paren
op_logical_neg
(paren
id|nccip
op_assign
id|find_ncci_by_msgid
c_func
(paren
id|card
comma
id|cmsg-&gt;adr.adrNCCI
comma
id|cmsg-&gt;Messagenumber
)paren
)paren
)paren
r_goto
id|notfound
suffix:semicolon
id|nccip-&gt;ncci
op_assign
id|cmsg-&gt;adr.adrNCCI
suffix:semicolon
r_if
c_cond
(paren
id|cmsg-&gt;Info
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv-%d: %s info 0x%x (%s) for ncci 0x%x&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;Info
comma
id|capi_info2str
c_func
(paren
id|cmsg-&gt;Info
)paren
comma
id|cmsg-&gt;adr.adrNCCI
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmsg-&gt;Info
)paren
id|ncci_change_state
c_func
(paren
id|card
comma
id|nccip
comma
id|EV_NCCI_CONNECT_B3_CONF_ERROR
)paren
suffix:semicolon
r_else
id|ncci_change_state
c_func
(paren
id|card
comma
id|nccip
comma
id|EV_NCCI_CONNECT_B3_CONF_OK
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CAPI_CONNECT_B3_T90_ACTIVE_IND
suffix:colon
multiline_comment|/* ncci */
id|capi_cmsg_answer
c_func
(paren
id|cmsg
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CAPI_DATA_B3_IND
suffix:colon
multiline_comment|/* ncci */
multiline_comment|/* handled in handle_data() */
r_goto
id|ignored
suffix:semicolon
r_case
id|CAPI_DATA_B3_CONF
suffix:colon
multiline_comment|/* ncci */
r_if
c_cond
(paren
op_logical_neg
(paren
id|nccip
op_assign
id|find_ncci
c_func
(paren
id|card
comma
id|cmsg-&gt;adr.adrNCCI
)paren
)paren
)paren
r_goto
id|notfound
suffix:semicolon
id|len
op_assign
id|capidrv_del_ack
c_func
(paren
id|nccip
comma
id|cmsg-&gt;DataHandle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
r_break
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_BSENT
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.arg
op_assign
id|nccip-&gt;chan
suffix:semicolon
id|cmd.parm.length
op_assign
id|len
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CAPI_DISCONNECT_B3_IND
suffix:colon
multiline_comment|/* ncci */
r_if
c_cond
(paren
op_logical_neg
(paren
id|nccip
op_assign
id|find_ncci
c_func
(paren
id|card
comma
id|cmsg-&gt;adr.adrNCCI
)paren
)paren
)paren
r_goto
id|notfound
suffix:semicolon
id|card-&gt;bchans
(braket
id|nccip-&gt;chan
)braket
dot
id|disconnecting
op_assign
l_int|1
suffix:semicolon
id|ncci_change_state
c_func
(paren
id|card
comma
id|nccip
comma
id|EV_NCCI_DISCONNECT_B3_IND
)paren
suffix:semicolon
id|capi_cmsg_answer
c_func
(paren
id|cmsg
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
id|ncci_change_state
c_func
(paren
id|card
comma
id|nccip
comma
id|EV_NCCI_DISCONNECT_B3_RESP
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CAPI_DISCONNECT_B3_CONF
suffix:colon
multiline_comment|/* ncci */
r_if
c_cond
(paren
op_logical_neg
(paren
id|nccip
op_assign
id|find_ncci
c_func
(paren
id|card
comma
id|cmsg-&gt;adr.adrNCCI
)paren
)paren
)paren
r_goto
id|notfound
suffix:semicolon
r_if
c_cond
(paren
id|cmsg-&gt;Info
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv-%d: %s info 0x%x (%s) for ncci 0x%x&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;Info
comma
id|capi_info2str
c_func
(paren
id|cmsg-&gt;Info
)paren
comma
id|cmsg-&gt;adr.adrNCCI
)paren
suffix:semicolon
id|ncci_change_state
c_func
(paren
id|card
comma
id|nccip
comma
id|EV_NCCI_DISCONNECT_B3_CONF_ERROR
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CAPI_RESET_B3_IND
suffix:colon
multiline_comment|/* ncci */
r_if
c_cond
(paren
op_logical_neg
(paren
id|nccip
op_assign
id|find_ncci
c_func
(paren
id|card
comma
id|cmsg-&gt;adr.adrNCCI
)paren
)paren
)paren
r_goto
id|notfound
suffix:semicolon
id|ncci_change_state
c_func
(paren
id|card
comma
id|nccip
comma
id|EV_NCCI_RESET_B3_IND
)paren
suffix:semicolon
id|capi_cmsg_answer
c_func
(paren
id|cmsg
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CAPI_RESET_B3_CONF
suffix:colon
multiline_comment|/* ncci */
r_goto
id|ignored
suffix:semicolon
multiline_comment|/* $$$$ */
r_case
id|CAPI_FACILITY_IND
suffix:colon
multiline_comment|/* Controller/plci/ncci */
r_goto
id|ignored
suffix:semicolon
r_case
id|CAPI_FACILITY_CONF
suffix:colon
multiline_comment|/* Controller/plci/ncci */
r_goto
id|ignored
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv-%d: got %s for ncci 0x%x ???&quot;
comma
id|card-&gt;contrnr
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;adr.adrNCCI
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
id|ignored
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv-%d: %s for ncci 0x%x ignored&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;adr.adrNCCI
)paren
suffix:semicolon
r_return
suffix:semicolon
id|notfound
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv-%d: %s: ncci 0x%x not found&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;adr.adrNCCI
)paren
suffix:semicolon
)brace
DECL|function|handle_data
r_static
r_void
id|handle_data
c_func
(paren
id|_cmsg
op_star
id|cmsg
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|capidrv_contr
op_star
id|card
op_assign
id|findcontrbynumber
c_func
(paren
id|cmsg-&gt;adr.adrController
op_amp
l_int|0x7f
)paren
suffix:semicolon
id|capidrv_ncci
op_star
id|nccip
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: %s from unknown controller 0x%x&bslash;n&quot;
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;adr.adrController
op_amp
l_int|0x7f
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|nccip
op_assign
id|find_ncci
c_func
(paren
id|card
comma
id|cmsg-&gt;adr.adrNCCI
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv-%d: %s: ncci 0x%x not found&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;adr.adrNCCI
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
(paren
r_void
)paren
id|skb_pull
c_func
(paren
id|skb
comma
id|CAPIMSG_LEN
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
id|card-&gt;interface
dot
id|rcvcallb_skb
c_func
(paren
id|card-&gt;myid
comma
id|nccip-&gt;chan
comma
id|skb
)paren
suffix:semicolon
id|capi_cmsg_answer
c_func
(paren
id|cmsg
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
)brace
DECL|variable|s_cmsg
r_static
id|_cmsg
id|s_cmsg
suffix:semicolon
DECL|function|capidrv_signal
r_static
r_void
id|capidrv_signal
c_func
(paren
id|__u16
id|applid
comma
r_void
op_star
id|dummy
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
op_star
id|capifuncs-&gt;capi_get_message
)paren
(paren
id|global.appid
comma
op_amp
id|skb
)paren
op_eq
id|CAPI_NOERROR
)paren
(brace
id|capi_message2cmsg
c_func
(paren
op_amp
id|s_cmsg
comma
id|skb-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debugmode
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv_signal: applid=%d %s&bslash;n&quot;
comma
id|applid
comma
id|capi_cmsg2str
c_func
(paren
op_amp
id|s_cmsg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s_cmsg.Command
op_eq
id|CAPI_DATA_B3
op_logical_and
id|s_cmsg.Subcommand
op_eq
id|CAPI_IND
)paren
(brace
id|handle_data
c_func
(paren
op_amp
id|s_cmsg
comma
id|skb
)paren
suffix:semicolon
id|global.nrecvdatapkt
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|s_cmsg.adr.adrController
op_amp
l_int|0xffffff00
)paren
op_eq
l_int|0
)paren
id|handle_controller
c_func
(paren
op_amp
id|s_cmsg
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|s_cmsg.adr.adrPLCI
op_amp
l_int|0xffff0000
)paren
op_eq
l_int|0
)paren
id|handle_plci
c_func
(paren
op_amp
id|s_cmsg
)paren
suffix:semicolon
r_else
id|handle_ncci
c_func
(paren
op_amp
id|s_cmsg
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * data of skb used in s_cmsg,&n;&t;&t; * free data when s_cmsg is not used again&n;&t;&t; * thanks to Lars Heete &lt;hel@admin.de&gt;&n;&t;&t; */
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|global.nrecvctlpkt
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* ------------------------------------------------------------------- */
DECL|macro|PUTBYTE_TO_STATUS
mdefine_line|#define PUTBYTE_TO_STATUS(card, byte) &bslash;&n;&t;do { &bslash;&n;&t;&t;*(card)-&gt;q931_write++ = (byte); &bslash;&n;        &t;if ((card)-&gt;q931_write &gt; (card)-&gt;q931_end) &bslash;&n;&t;  &t;&t;(card)-&gt;q931_write = (card)-&gt;q931_buf; &bslash;&n;&t;} while (0)
DECL|function|handle_dtrace_data
r_static
r_void
id|handle_dtrace_data
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
r_int
id|send
comma
r_int
id|level2
comma
id|__u8
op_star
id|data
comma
id|__u16
id|len
)paren
(brace
id|__u8
op_star
id|p
comma
op_star
id|end
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv-%d: avmb1_q931_data: len == %d&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|len
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|level2
)paren
(brace
id|PUTBYTE_TO_STATUS
c_func
(paren
id|card
comma
l_char|&squot;D&squot;
)paren
suffix:semicolon
id|PUTBYTE_TO_STATUS
c_func
(paren
id|card
comma
l_char|&squot;2&squot;
)paren
suffix:semicolon
id|PUTBYTE_TO_STATUS
c_func
(paren
id|card
comma
id|send
ques
c_cond
l_char|&squot;&gt;&squot;
suffix:colon
l_char|&squot;&lt;&squot;
)paren
suffix:semicolon
id|PUTBYTE_TO_STATUS
c_func
(paren
id|card
comma
l_char|&squot;:&squot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|PUTBYTE_TO_STATUS
c_func
(paren
id|card
comma
l_char|&squot;D&squot;
)paren
suffix:semicolon
id|PUTBYTE_TO_STATUS
c_func
(paren
id|card
comma
l_char|&squot;3&squot;
)paren
suffix:semicolon
id|PUTBYTE_TO_STATUS
c_func
(paren
id|card
comma
id|send
ques
c_cond
l_char|&squot;&gt;&squot;
suffix:colon
l_char|&squot;&lt;&squot;
)paren
suffix:semicolon
id|PUTBYTE_TO_STATUS
c_func
(paren
id|card
comma
l_char|&squot;:&squot;
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|p
op_assign
id|data
comma
id|end
op_assign
id|data
op_plus
id|len
suffix:semicolon
id|p
OL
id|end
suffix:semicolon
id|p
op_increment
)paren
(brace
id|__u8
id|w
suffix:semicolon
id|PUTBYTE_TO_STATUS
c_func
(paren
id|card
comma
l_char|&squot; &squot;
)paren
suffix:semicolon
id|w
op_assign
(paren
op_star
id|p
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
suffix:semicolon
id|PUTBYTE_TO_STATUS
c_func
(paren
id|card
comma
(paren
id|w
OL
l_int|10
)paren
ques
c_cond
l_char|&squot;0&squot;
op_plus
id|w
suffix:colon
l_char|&squot;A&squot;
op_minus
l_int|10
op_plus
id|w
)paren
suffix:semicolon
id|w
op_assign
op_star
id|p
op_amp
l_int|0xf
suffix:semicolon
id|PUTBYTE_TO_STATUS
c_func
(paren
id|card
comma
(paren
id|w
OL
l_int|10
)paren
ques
c_cond
l_char|&squot;0&squot;
op_plus
id|w
suffix:colon
l_char|&squot;A&squot;
op_minus
l_int|10
op_plus
id|w
)paren
suffix:semicolon
)brace
id|PUTBYTE_TO_STATUS
c_func
(paren
id|card
comma
l_char|&squot;&bslash;n&squot;
)paren
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_STAVAIL
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.arg
op_assign
id|len
op_star
l_int|3
op_plus
l_int|5
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------- */
DECL|variable|cmdcmsg
r_static
id|_cmsg
id|cmdcmsg
suffix:semicolon
DECL|function|capidrv_ioctl
r_static
r_int
id|capidrv_ioctl
c_func
(paren
id|isdn_ctrl
op_star
id|c
comma
id|capidrv_contr
op_star
id|card
)paren
(brace
r_switch
c_cond
(paren
id|c-&gt;arg
)paren
(brace
r_case
l_int|1
suffix:colon
id|debugmode
op_assign
(paren
r_int
)paren
(paren
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|c-&gt;parm.num
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv-%d: debugmode=%d&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|debugmode
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv-%d: capidrv_ioctl(%ld) called ??&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|c-&gt;arg
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n; * Handle leased lines (CAPI-Bundling)&n; */
DECL|struct|internal_bchannelinfo
r_struct
id|internal_bchannelinfo
(brace
DECL|member|channelalloc
r_int
r_int
id|channelalloc
suffix:semicolon
DECL|member|operation
r_int
r_int
id|operation
suffix:semicolon
DECL|member|cmask
r_int
r_char
id|cmask
(braket
l_int|31
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|function|decodeFVteln
r_static
r_int
id|decodeFVteln
c_func
(paren
r_char
op_star
id|teln
comma
r_int
r_int
op_star
id|bmaskp
comma
r_int
op_star
id|activep
)paren
(brace
r_int
r_int
id|bmask
op_assign
l_int|0
suffix:semicolon
r_int
id|active
op_assign
op_logical_neg
l_int|0
suffix:semicolon
r_char
op_star
id|s
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|teln
comma
l_string|&quot;FV:&quot;
comma
l_int|3
)paren
op_ne
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
id|s
op_assign
id|teln
op_plus
l_int|3
suffix:semicolon
r_while
c_loop
(paren
op_star
id|s
op_logical_and
op_star
id|s
op_eq
l_char|&squot; &squot;
)paren
id|s
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|s
)paren
r_return
op_minus
l_int|2
suffix:semicolon
r_if
c_cond
(paren
op_star
id|s
op_eq
l_char|&squot;p&squot;
op_logical_or
op_star
id|s
op_eq
l_char|&squot;P&squot;
)paren
(brace
id|active
op_assign
l_int|0
suffix:semicolon
id|s
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|s
op_eq
l_char|&squot;a&squot;
op_logical_or
op_star
id|s
op_eq
l_char|&squot;A&squot;
)paren
(brace
id|active
op_assign
op_logical_neg
l_int|0
suffix:semicolon
id|s
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
op_star
id|s
)paren
(brace
r_int
id|digit1
op_assign
l_int|0
suffix:semicolon
r_int
id|digit2
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|isdigit
c_func
(paren
op_star
id|s
)paren
)paren
r_return
op_minus
l_int|3
suffix:semicolon
r_while
c_loop
(paren
id|isdigit
c_func
(paren
op_star
id|s
)paren
)paren
(brace
id|digit1
op_assign
id|digit1
op_star
l_int|10
op_plus
(paren
op_star
id|s
op_minus
l_char|&squot;0&squot;
)paren
suffix:semicolon
id|s
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|digit1
op_le
l_int|0
op_logical_and
id|digit1
OG
l_int|30
)paren
r_return
op_minus
l_int|4
suffix:semicolon
r_if
c_cond
(paren
op_star
id|s
op_eq
l_int|0
op_logical_or
op_star
id|s
op_eq
l_char|&squot;,&squot;
op_logical_or
op_star
id|s
op_eq
l_char|&squot; &squot;
)paren
(brace
id|bmask
op_or_assign
(paren
l_int|1
op_lshift
id|digit1
)paren
suffix:semicolon
id|digit1
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_star
id|s
)paren
id|s
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|s
op_ne
l_char|&squot;-&squot;
)paren
r_return
op_minus
l_int|5
suffix:semicolon
id|s
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|isdigit
c_func
(paren
op_star
id|s
)paren
)paren
r_return
op_minus
l_int|3
suffix:semicolon
r_while
c_loop
(paren
id|isdigit
c_func
(paren
op_star
id|s
)paren
)paren
(brace
id|digit2
op_assign
id|digit2
op_star
l_int|10
op_plus
(paren
op_star
id|s
op_minus
l_char|&squot;0&squot;
)paren
suffix:semicolon
id|s
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|digit2
op_le
l_int|0
op_logical_and
id|digit2
OG
l_int|30
)paren
r_return
op_minus
l_int|4
suffix:semicolon
r_if
c_cond
(paren
op_star
id|s
op_eq
l_int|0
op_logical_or
op_star
id|s
op_eq
l_char|&squot;,&squot;
op_logical_or
op_star
id|s
op_eq
l_char|&squot; &squot;
)paren
(brace
r_if
c_cond
(paren
id|digit1
OG
id|digit2
)paren
r_for
c_loop
(paren
id|i
op_assign
id|digit2
suffix:semicolon
id|i
op_le
id|digit1
suffix:semicolon
id|i
op_increment
)paren
id|bmask
op_or_assign
(paren
l_int|1
op_lshift
id|i
)paren
suffix:semicolon
r_else
r_for
c_loop
(paren
id|i
op_assign
id|digit1
suffix:semicolon
id|i
op_le
id|digit2
suffix:semicolon
id|i
op_increment
)paren
id|bmask
op_or_assign
(paren
l_int|1
op_lshift
id|i
)paren
suffix:semicolon
id|digit1
op_assign
id|digit2
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_star
id|s
)paren
id|s
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_return
op_minus
l_int|6
suffix:semicolon
)brace
r_if
c_cond
(paren
id|activep
)paren
op_star
id|activep
op_assign
id|active
suffix:semicolon
r_if
c_cond
(paren
id|bmaskp
)paren
op_star
id|bmaskp
op_assign
id|bmask
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|FVteln2capi20
r_static
r_int
id|FVteln2capi20
c_func
(paren
r_char
op_star
id|teln
comma
id|__u8
id|AdditionalInfo
(braket
l_int|1
op_plus
l_int|2
op_plus
l_int|2
op_plus
l_int|31
)braket
)paren
(brace
r_int
r_int
id|bmask
suffix:semicolon
r_int
id|active
suffix:semicolon
r_int
id|rc
comma
id|i
suffix:semicolon
id|rc
op_assign
id|decodeFVteln
c_func
(paren
id|teln
comma
op_amp
id|bmask
comma
op_amp
id|active
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
multiline_comment|/* Length */
id|AdditionalInfo
(braket
l_int|0
)braket
op_assign
l_int|2
op_plus
l_int|2
op_plus
l_int|31
suffix:semicolon
multiline_comment|/* Channel: 3 =&gt; use channel allocation */
id|AdditionalInfo
(braket
l_int|1
)braket
op_assign
l_int|3
suffix:semicolon
id|AdditionalInfo
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Operation: 0 =&gt; DTE mode, 1 =&gt; DCE mode */
r_if
c_cond
(paren
id|active
)paren
(brace
id|AdditionalInfo
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|AdditionalInfo
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|AdditionalInfo
(braket
l_int|3
)braket
op_assign
l_int|1
suffix:semicolon
id|AdditionalInfo
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Channel mask array */
id|AdditionalInfo
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* no D-Channel */
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_le
l_int|30
suffix:semicolon
id|i
op_increment
)paren
id|AdditionalInfo
(braket
l_int|5
op_plus
id|i
)braket
op_assign
(paren
id|bmask
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
ques
c_cond
l_int|0xff
suffix:colon
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|capidrv_command
r_static
r_int
id|capidrv_command
c_func
(paren
id|isdn_ctrl
op_star
id|c
comma
id|capidrv_contr
op_star
id|card
)paren
(brace
id|isdn_ctrl
id|cmd
suffix:semicolon
r_struct
id|capidrv_bchan
op_star
id|bchan
suffix:semicolon
r_struct
id|capidrv_plci
op_star
id|plcip
suffix:semicolon
id|__u8
id|AdditionalInfo
(braket
l_int|1
op_plus
l_int|2
op_plus
l_int|2
op_plus
l_int|31
)braket
suffix:semicolon
r_int
id|rc
comma
id|isleasedline
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;command
op_eq
id|ISDN_CMD_IOCTL
)paren
r_return
id|capidrv_ioctl
c_func
(paren
id|c
comma
id|card
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|c-&gt;command
)paren
(brace
r_case
id|ISDN_CMD_DIAL
suffix:colon
(brace
id|__u8
id|calling
(braket
id|ISDN_MSNLEN
op_plus
l_int|3
)braket
suffix:semicolon
id|__u8
id|called
(braket
id|ISDN_MSNLEN
op_plus
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv-%d: ISDN_CMD_DIAL(ch=%ld,&bslash;&quot;%s,%d,%d,%s&bslash;&quot;)&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|c-&gt;arg
comma
id|c-&gt;parm.setup.phone
comma
id|c-&gt;parm.setup.si1
comma
id|c-&gt;parm.setup.si2
comma
id|c-&gt;parm.setup.eazmsn
)paren
suffix:semicolon
id|bchan
op_assign
op_amp
id|card-&gt;bchans
(braket
id|c-&gt;arg
op_mod
id|card-&gt;nbchan
)braket
suffix:semicolon
r_if
c_cond
(paren
id|bchan-&gt;plcip
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv-%d: dail ch=%ld,&bslash;&quot;%s,%d,%d,%s&bslash;&quot; in use (plci=0x%x)&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|c-&gt;arg
comma
id|c-&gt;parm.setup.phone
comma
id|c-&gt;parm.setup.si1
comma
id|c-&gt;parm.setup.si2
comma
id|c-&gt;parm.setup.eazmsn
comma
id|bchan-&gt;plcip-&gt;plci
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|bchan-&gt;si1
op_assign
id|c-&gt;parm.setup.si1
suffix:semicolon
id|bchan-&gt;si2
op_assign
id|c-&gt;parm.setup.si2
suffix:semicolon
id|strncpy
c_func
(paren
id|bchan-&gt;num
comma
id|c-&gt;parm.setup.phone
comma
r_sizeof
(paren
id|bchan-&gt;num
)paren
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|bchan-&gt;mynum
comma
id|c-&gt;parm.setup.eazmsn
comma
r_sizeof
(paren
id|bchan-&gt;mynum
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|FVteln2capi20
c_func
(paren
id|bchan-&gt;num
comma
id|AdditionalInfo
)paren
suffix:semicolon
id|isleasedline
op_assign
(paren
id|rc
op_eq
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv-%d: WARNING: illegal leased linedefinition &bslash;&quot;%s&bslash;&quot;&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|bchan-&gt;num
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isleasedline
)paren
(brace
id|calling
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|called
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv-%d: connecting leased line&bslash;n&quot;
comma
id|card-&gt;contrnr
)paren
suffix:semicolon
)brace
r_else
(brace
id|calling
(braket
l_int|0
)braket
op_assign
id|strlen
c_func
(paren
id|bchan-&gt;mynum
)paren
op_plus
l_int|2
suffix:semicolon
id|calling
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|calling
(braket
l_int|2
)braket
op_assign
l_int|0x80
suffix:semicolon
id|strncpy
c_func
(paren
id|calling
op_plus
l_int|3
comma
id|bchan-&gt;mynum
comma
id|ISDN_MSNLEN
)paren
suffix:semicolon
id|called
(braket
l_int|0
)braket
op_assign
id|strlen
c_func
(paren
id|bchan-&gt;num
)paren
op_plus
l_int|1
suffix:semicolon
id|called
(braket
l_int|1
)braket
op_assign
l_int|0x80
suffix:semicolon
id|strncpy
c_func
(paren
id|called
op_plus
l_int|2
comma
id|bchan-&gt;num
comma
id|ISDN_MSNLEN
)paren
suffix:semicolon
)brace
id|capi_fill_CONNECT_REQ
c_func
(paren
op_amp
id|cmdcmsg
comma
id|global.appid
comma
id|card-&gt;msgid
op_increment
comma
id|card-&gt;contrnr
comma
multiline_comment|/* adr */
id|si2cip
c_func
(paren
id|bchan-&gt;si1
comma
id|bchan-&gt;si2
)paren
comma
multiline_comment|/* cipvalue */
id|called
comma
multiline_comment|/* CalledPartyNumber */
id|calling
comma
multiline_comment|/* CallingPartyNumber */
l_int|0
comma
multiline_comment|/* CalledPartySubaddress */
l_int|0
comma
multiline_comment|/* CallingPartySubaddress */
id|b1prot
c_func
(paren
id|bchan-&gt;l2
comma
id|bchan-&gt;l3
)paren
comma
multiline_comment|/* B1protocol */
id|b2prot
c_func
(paren
id|bchan-&gt;l2
comma
id|bchan-&gt;l3
)paren
comma
multiline_comment|/* B2protocol */
id|b3prot
c_func
(paren
id|bchan-&gt;l2
comma
id|bchan-&gt;l3
)paren
comma
multiline_comment|/* B3protocol */
id|b1config
c_func
(paren
id|bchan-&gt;l2
comma
id|bchan-&gt;l3
)paren
comma
multiline_comment|/* B1configuration */
l_int|0
comma
multiline_comment|/* B2configuration */
l_int|0
comma
multiline_comment|/* B3configuration */
l_int|0
comma
multiline_comment|/* BC */
l_int|0
comma
multiline_comment|/* LLC */
l_int|0
comma
multiline_comment|/* HLC */
multiline_comment|/* BChannelinformation */
id|isleasedline
ques
c_cond
id|AdditionalInfo
suffix:colon
l_int|0
comma
l_int|0
comma
multiline_comment|/* Keypadfacility */
l_int|0
comma
multiline_comment|/* Useruserdata */
l_int|0
multiline_comment|/* Facilitydataarray */
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|plcip
op_assign
id|new_plci
c_func
(paren
id|card
comma
(paren
id|c-&gt;arg
op_mod
id|card-&gt;nbchan
)paren
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|cmd.command
op_assign
id|ISDN_STAT_DHUP
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.arg
op_assign
(paren
id|c-&gt;arg
op_mod
id|card-&gt;nbchan
)paren
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|plcip-&gt;msgid
op_assign
id|cmdcmsg.Messagenumber
suffix:semicolon
id|plcip-&gt;leasedline
op_assign
id|isleasedline
suffix:semicolon
id|plci_change_state
c_func
(paren
id|card
comma
id|plcip
comma
id|EV_PLCI_CONNECT_REQ
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
op_amp
id|cmdcmsg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|ISDN_CMD_ACCEPTD
suffix:colon
id|bchan
op_assign
op_amp
id|card-&gt;bchans
(braket
id|c-&gt;arg
op_mod
id|card-&gt;nbchan
)braket
suffix:semicolon
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv-%d: ISDN_CMD_ACCEPTD(ch=%ld) l2=%d l3=%d&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|c-&gt;arg
comma
id|bchan-&gt;l2
comma
id|bchan-&gt;l3
)paren
suffix:semicolon
id|capi_fill_CONNECT_RESP
c_func
(paren
op_amp
id|cmdcmsg
comma
id|global.appid
comma
id|card-&gt;msgid
op_increment
comma
id|bchan-&gt;plcip-&gt;plci
comma
multiline_comment|/* adr */
l_int|0
comma
multiline_comment|/* Reject */
id|b1prot
c_func
(paren
id|bchan-&gt;l2
comma
id|bchan-&gt;l3
)paren
comma
multiline_comment|/* B1protocol */
id|b2prot
c_func
(paren
id|bchan-&gt;l2
comma
id|bchan-&gt;l3
)paren
comma
multiline_comment|/* B2protocol */
id|b3prot
c_func
(paren
id|bchan-&gt;l2
comma
id|bchan-&gt;l3
)paren
comma
multiline_comment|/* B3protocol */
id|b1config
c_func
(paren
id|bchan-&gt;l2
comma
id|bchan-&gt;l3
)paren
comma
multiline_comment|/* B1configuration */
l_int|0
comma
multiline_comment|/* B2configuration */
l_int|0
comma
multiline_comment|/* B3configuration */
l_int|0
comma
multiline_comment|/* ConnectedNumber */
l_int|0
comma
multiline_comment|/* ConnectedSubaddress */
l_int|0
comma
multiline_comment|/* LLC */
l_int|0
comma
multiline_comment|/* BChannelinformation */
l_int|0
comma
multiline_comment|/* Keypadfacility */
l_int|0
comma
multiline_comment|/* Useruserdata */
l_int|0
multiline_comment|/* Facilitydataarray */
)paren
suffix:semicolon
id|capi_cmsg2message
c_func
(paren
op_amp
id|cmdcmsg
comma
id|cmdcmsg.buf
)paren
suffix:semicolon
id|plci_change_state
c_func
(paren
id|card
comma
id|bchan-&gt;plcip
comma
id|EV_PLCI_CONNECT_RESP
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
op_amp
id|cmdcmsg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ISDN_CMD_ACCEPTB
suffix:colon
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv-%d: ISDN_CMD_ACCEPTB(ch=%ld)&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|c-&gt;arg
)paren
suffix:semicolon
r_return
op_minus
id|ENOSYS
suffix:semicolon
r_case
id|ISDN_CMD_HANGUP
suffix:colon
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv-%d: ISDN_CMD_HANGUP(ch=%ld)&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|c-&gt;arg
)paren
suffix:semicolon
id|bchan
op_assign
op_amp
id|card-&gt;bchans
(braket
id|c-&gt;arg
op_mod
id|card-&gt;nbchan
)braket
suffix:semicolon
r_if
c_cond
(paren
id|bchan-&gt;disconnecting
)paren
(brace
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv-%d: chan %ld already disconnecting ...&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|c-&gt;arg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bchan-&gt;nccip
)paren
(brace
id|bchan-&gt;disconnecting
op_assign
l_int|1
suffix:semicolon
id|capi_fill_DISCONNECT_B3_REQ
c_func
(paren
op_amp
id|cmdcmsg
comma
id|global.appid
comma
id|card-&gt;msgid
op_increment
comma
id|bchan-&gt;nccip-&gt;ncci
comma
l_int|0
multiline_comment|/* NCPI */
)paren
suffix:semicolon
id|ncci_change_state
c_func
(paren
id|card
comma
id|bchan-&gt;nccip
comma
id|EV_NCCI_DISCONNECT_B3_REQ
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
op_amp
id|cmdcmsg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bchan-&gt;plcip
)paren
(brace
r_if
c_cond
(paren
id|bchan-&gt;plcip-&gt;state
op_eq
id|ST_PLCI_INCOMING
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * just ignore, we a called from&n;&t;&t;&t;&t; * isdn_status_callback(),&n;&t;&t;&t;&t; * which will return 0 or 2, this is handled&n;&t;&t;&t;&t; * by the CONNECT_IND handler&n;&t;&t;&t;&t; */
id|bchan-&gt;disconnecting
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bchan-&gt;plcip-&gt;plci
)paren
(brace
id|bchan-&gt;disconnecting
op_assign
l_int|1
suffix:semicolon
id|capi_fill_DISCONNECT_REQ
c_func
(paren
op_amp
id|cmdcmsg
comma
id|global.appid
comma
id|card-&gt;msgid
op_increment
comma
id|bchan-&gt;plcip-&gt;plci
comma
l_int|0
comma
multiline_comment|/* BChannelinformation */
l_int|0
comma
multiline_comment|/* Keypadfacility */
l_int|0
comma
multiline_comment|/* Useruserdata */
l_int|0
multiline_comment|/* Facilitydataarray */
)paren
suffix:semicolon
id|plci_change_state
c_func
(paren
id|card
comma
id|bchan-&gt;plcip
comma
id|EV_PLCI_DISCONNECT_REQ
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
op_amp
id|cmdcmsg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv-%d: chan %ld disconnect request while waiting for CONNECT_CONF&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|c-&gt;arg
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv-%d: chan %ld disconnect request on free channel&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|c-&gt;arg
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* ready */
r_case
id|ISDN_CMD_SETL2
suffix:colon
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv-%d: set L2 on chan %ld to %ld&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
(paren
id|c-&gt;arg
op_amp
l_int|0xff
)paren
comma
(paren
id|c-&gt;arg
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
id|bchan
op_assign
op_amp
id|card-&gt;bchans
(braket
(paren
id|c-&gt;arg
op_amp
l_int|0xff
)paren
op_mod
id|card-&gt;nbchan
)braket
suffix:semicolon
id|bchan-&gt;l2
op_assign
(paren
id|c-&gt;arg
op_rshift
l_int|8
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ISDN_CMD_SETL3
suffix:colon
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv-%d: set L3 on chan %ld to %ld&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
(paren
id|c-&gt;arg
op_amp
l_int|0xff
)paren
comma
(paren
id|c-&gt;arg
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
id|bchan
op_assign
op_amp
id|card-&gt;bchans
(braket
(paren
id|c-&gt;arg
op_amp
l_int|0xff
)paren
op_mod
id|card-&gt;nbchan
)braket
suffix:semicolon
id|bchan-&gt;l3
op_assign
(paren
id|c-&gt;arg
op_rshift
l_int|8
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ISDN_CMD_SETEAZ
suffix:colon
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv-%d: set EAZ &bslash;&quot;%s&bslash;&quot; on chan %ld&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|c-&gt;parm.num
comma
id|c-&gt;arg
)paren
suffix:semicolon
id|bchan
op_assign
op_amp
id|card-&gt;bchans
(braket
id|c-&gt;arg
op_mod
id|card-&gt;nbchan
)braket
suffix:semicolon
id|strncpy
c_func
(paren
id|bchan-&gt;msn
comma
id|c-&gt;parm.num
comma
id|ISDN_MSNLEN
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ISDN_CMD_CLREAZ
suffix:colon
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv-%d: clearing EAZ on chan %ld&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|c-&gt;arg
)paren
suffix:semicolon
id|bchan
op_assign
op_amp
id|card-&gt;bchans
(braket
id|c-&gt;arg
op_mod
id|card-&gt;nbchan
)braket
suffix:semicolon
id|bchan-&gt;msn
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ISDN_CMD_LOCK
suffix:colon
r_if
c_cond
(paren
id|debugmode
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv-%d: ISDN_CMD_LOCK (%ld)&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|c-&gt;arg
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_CMD_UNLOCK
suffix:colon
r_if
c_cond
(paren
id|debugmode
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv-%d: ISDN_CMD_UNLOCK (%ld)&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|c-&gt;arg
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* never called */
r_case
id|ISDN_CMD_GETL2
suffix:colon
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv-%d: ISDN_CMD_GETL2&bslash;n&quot;
comma
id|card-&gt;contrnr
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
r_case
id|ISDN_CMD_GETL3
suffix:colon
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv-%d: ISDN_CMD_GETL3&bslash;n&quot;
comma
id|card-&gt;contrnr
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
r_case
id|ISDN_CMD_GETEAZ
suffix:colon
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv-%d: ISDN_CMD_GETEAZ&bslash;n&quot;
comma
id|card-&gt;contrnr
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
r_case
id|ISDN_CMD_SETSIL
suffix:colon
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv-%d: ISDN_CMD_SETSIL&bslash;n&quot;
comma
id|card-&gt;contrnr
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
r_case
id|ISDN_CMD_GETSIL
suffix:colon
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv-%d: ISDN_CMD_GETSIL&bslash;n&quot;
comma
id|card-&gt;contrnr
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv-%d: ISDN_CMD_%d, Huh?&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|c-&gt;command
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|if_command
r_static
r_int
id|if_command
c_func
(paren
id|isdn_ctrl
op_star
id|c
)paren
(brace
id|capidrv_contr
op_star
id|card
op_assign
id|findcontrbydriverid
c_func
(paren
id|c-&gt;driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card
)paren
r_return
id|capidrv_command
c_func
(paren
id|c
comma
id|card
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: if_command %d called with invalid driverId %d!&bslash;n&quot;
comma
id|c-&gt;command
comma
id|c-&gt;driver
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|variable|sendcmsg
r_static
id|_cmsg
id|sendcmsg
suffix:semicolon
DECL|function|if_sendbuf
r_static
r_int
id|if_sendbuf
c_func
(paren
r_int
id|id
comma
r_int
id|channel
comma
r_int
id|doack
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|capidrv_contr
op_star
id|card
op_assign
id|findcontrbydriverid
c_func
(paren
id|id
)paren
suffix:semicolon
id|capidrv_bchan
op_star
id|bchan
suffix:semicolon
id|capidrv_ncci
op_star
id|nccip
suffix:semicolon
r_int
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
r_int
id|msglen
suffix:semicolon
id|__u16
id|errcode
suffix:semicolon
id|__u16
id|datahandle
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv-%d: if_sendbuf called with invalid driverId %d!&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|id
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|debugmode
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv-%d: sendbuf len=%d skb=%p doack=%d&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|len
comma
id|skb
comma
id|doack
)paren
suffix:semicolon
id|bchan
op_assign
op_amp
id|card-&gt;bchans
(braket
id|channel
op_mod
id|card-&gt;nbchan
)braket
suffix:semicolon
id|nccip
op_assign
id|bchan-&gt;nccip
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nccip
op_logical_or
id|nccip-&gt;state
op_ne
id|ST_NCCI_ACTIVE
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv-%d: if_sendbuf: %s:%d: chan not up!&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|card-&gt;name
comma
id|channel
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|datahandle
op_assign
id|nccip-&gt;datahandle
suffix:semicolon
id|capi_fill_DATA_B3_REQ
c_func
(paren
op_amp
id|sendcmsg
comma
id|global.appid
comma
id|card-&gt;msgid
op_increment
comma
id|nccip-&gt;ncci
comma
multiline_comment|/* adr */
(paren
id|__u32
)paren
id|skb-&gt;data
comma
multiline_comment|/* Data */
id|skb-&gt;len
comma
multiline_comment|/* DataLength */
id|datahandle
comma
multiline_comment|/* DataHandle */
l_int|0
multiline_comment|/* Flags */
)paren
suffix:semicolon
r_if
c_cond
(paren
id|capidrv_add_ack
c_func
(paren
id|nccip
comma
id|datahandle
comma
id|doack
ques
c_cond
id|skb-&gt;len
suffix:colon
op_minus
l_int|1
)paren
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|capi_cmsg2message
c_func
(paren
op_amp
id|sendcmsg
comma
id|sendcmsg.buf
)paren
suffix:semicolon
id|msglen
op_assign
id|CAPIMSG_LEN
c_func
(paren
id|sendcmsg.buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb_headroom
c_func
(paren
id|skb
)paren
OL
id|msglen
)paren
(brace
r_struct
id|sk_buff
op_star
id|nskb
op_assign
id|skb_realloc_headroom
c_func
(paren
id|skb
comma
id|msglen
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nskb
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv-%d: if_sendbuf: no memory&bslash;n&quot;
comma
id|card-&gt;contrnr
)paren
suffix:semicolon
(paren
r_void
)paren
id|capidrv_del_ack
c_func
(paren
id|nccip
comma
id|datahandle
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv-%d: only %d bytes headroom, need %d&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|skb_headroom
c_func
(paren
id|skb
)paren
comma
id|msglen
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_push
c_func
(paren
id|nskb
comma
id|msglen
)paren
comma
id|sendcmsg.buf
comma
id|msglen
)paren
suffix:semicolon
id|errcode
op_assign
(paren
op_star
id|capifuncs-&gt;capi_put_message
)paren
(paren
id|global.appid
comma
id|nskb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errcode
op_eq
id|CAPI_NOERROR
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|nccip-&gt;datahandle
op_increment
suffix:semicolon
id|global.nsentdatapkt
op_increment
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
(paren
r_void
)paren
id|capidrv_del_ack
c_func
(paren
id|nccip
comma
id|datahandle
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|nskb
)paren
suffix:semicolon
r_return
id|errcode
op_eq
id|CAPI_SENDQUEUEFULL
ques
c_cond
l_int|0
suffix:colon
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|skb_push
c_func
(paren
id|skb
comma
id|msglen
)paren
comma
id|sendcmsg.buf
comma
id|msglen
)paren
suffix:semicolon
id|errcode
op_assign
(paren
op_star
id|capifuncs-&gt;capi_put_message
)paren
(paren
id|global.appid
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errcode
op_eq
id|CAPI_NOERROR
)paren
(brace
id|nccip-&gt;datahandle
op_increment
suffix:semicolon
id|global.nsentdatapkt
op_increment
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
id|skb_pull
c_func
(paren
id|skb
comma
id|msglen
)paren
suffix:semicolon
(paren
r_void
)paren
id|capidrv_del_ack
c_func
(paren
id|nccip
comma
id|datahandle
)paren
suffix:semicolon
r_return
id|errcode
op_eq
id|CAPI_SENDQUEUEFULL
ques
c_cond
l_int|0
suffix:colon
op_minus
l_int|1
suffix:semicolon
)brace
)brace
DECL|function|if_readstat
r_static
r_int
id|if_readstat
c_func
(paren
id|__u8
op_star
id|buf
comma
r_int
id|len
comma
r_int
id|user
comma
r_int
id|id
comma
r_int
id|channel
)paren
(brace
id|capidrv_contr
op_star
id|card
op_assign
id|findcontrbydriverid
c_func
(paren
id|id
)paren
suffix:semicolon
r_int
id|count
suffix:semicolon
id|__u8
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv-%d: if_readstat called with invalid driverId %d!&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|id
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_for
c_loop
(paren
id|p
op_assign
id|buf
comma
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
id|len
suffix:semicolon
id|p
op_increment
comma
id|count
op_increment
)paren
(brace
r_if
c_cond
(paren
id|user
)paren
id|put_user
c_func
(paren
op_star
id|card-&gt;q931_read
op_increment
comma
id|p
)paren
suffix:semicolon
r_else
op_star
id|p
op_assign
op_star
id|card-&gt;q931_read
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;q931_read
OG
id|card-&gt;q931_end
)paren
id|card-&gt;q931_read
op_assign
id|card-&gt;q931_buf
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
DECL|function|enable_dchannel_trace
r_static
r_void
id|enable_dchannel_trace
c_func
(paren
id|capidrv_contr
op_star
id|card
)paren
(brace
id|__u8
id|manufacturer
(braket
id|CAPI_MANUFACTURER_LEN
)braket
suffix:semicolon
id|capi_version
id|version
suffix:semicolon
id|__u16
id|contr
op_assign
id|card-&gt;contrnr
suffix:semicolon
id|__u16
id|errcode
suffix:semicolon
id|__u16
id|avmversion
(braket
l_int|3
)braket
suffix:semicolon
id|errcode
op_assign
(paren
op_star
id|capifuncs-&gt;capi_get_manufacturer
)paren
(paren
id|contr
comma
id|manufacturer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errcode
op_ne
id|CAPI_NOERROR
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: can&squot;t get manufacturer (0x%x)&bslash;n&quot;
comma
id|card-&gt;name
comma
id|errcode
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strstr
c_func
(paren
id|manufacturer
comma
l_string|&quot;AVM&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: not from AVM, no d-channel trace possible (%s)&bslash;n&quot;
comma
id|card-&gt;name
comma
id|manufacturer
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|errcode
op_assign
(paren
op_star
id|capifuncs-&gt;capi_get_version
)paren
(paren
id|contr
comma
op_amp
id|version
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errcode
op_ne
id|CAPI_NOERROR
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: can&squot;t get version (0x%x)&bslash;n&quot;
comma
id|card-&gt;name
comma
id|errcode
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|avmversion
(braket
l_int|0
)braket
op_assign
(paren
id|version.majormanuversion
op_rshift
l_int|4
)paren
op_amp
l_int|0x0f
suffix:semicolon
id|avmversion
(braket
l_int|1
)braket
op_assign
(paren
id|version.majormanuversion
op_lshift
l_int|4
)paren
op_amp
l_int|0xf0
suffix:semicolon
id|avmversion
(braket
l_int|1
)braket
op_or_assign
(paren
id|version.minormanuversion
op_rshift
l_int|4
)paren
op_amp
l_int|0x0f
suffix:semicolon
id|avmversion
(braket
l_int|2
)braket
op_or_assign
id|version.minormanuversion
op_amp
l_int|0x0f
suffix:semicolon
r_if
c_cond
(paren
id|avmversion
(braket
l_int|0
)braket
OG
l_int|3
op_logical_or
(paren
id|avmversion
(braket
l_int|0
)braket
op_eq
l_int|3
op_logical_and
id|avmversion
(braket
l_int|1
)braket
OG
l_int|5
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: D2 trace enabled&bslash;n&quot;
comma
id|card-&gt;name
)paren
suffix:semicolon
id|capi_fill_MANUFACTURER_REQ
c_func
(paren
op_amp
id|cmdcmsg
comma
id|global.appid
comma
id|card-&gt;msgid
op_increment
comma
id|contr
comma
l_int|0x214D5641
comma
multiline_comment|/* ManuID */
l_int|0
comma
multiline_comment|/* Class */
l_int|1
comma
multiline_comment|/* Function */
(paren
id|_cstruct
)paren
l_string|&quot;&bslash;004&bslash;200&bslash;014&bslash;000&bslash;000&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: D3 trace enabled&bslash;n&quot;
comma
id|card-&gt;name
)paren
suffix:semicolon
id|capi_fill_MANUFACTURER_REQ
c_func
(paren
op_amp
id|cmdcmsg
comma
id|global.appid
comma
id|card-&gt;msgid
op_increment
comma
id|contr
comma
l_int|0x214D5641
comma
multiline_comment|/* ManuID */
l_int|0
comma
multiline_comment|/* Class */
l_int|1
comma
multiline_comment|/* Function */
(paren
id|_cstruct
)paren
l_string|&quot;&bslash;004&bslash;002&bslash;003&bslash;000&bslash;000&quot;
)paren
suffix:semicolon
)brace
id|send_message
c_func
(paren
id|card
comma
op_amp
id|cmdcmsg
)paren
suffix:semicolon
)brace
DECL|function|send_listen
r_static
r_void
id|send_listen
c_func
(paren
id|capidrv_contr
op_star
id|card
)paren
(brace
id|capi_fill_LISTEN_REQ
c_func
(paren
op_amp
id|cmdcmsg
comma
id|global.appid
comma
id|card-&gt;msgid
op_increment
comma
id|card-&gt;contrnr
comma
multiline_comment|/* controller */
l_int|1
op_lshift
l_int|6
comma
multiline_comment|/* Infomask */
id|card-&gt;cipmask
comma
id|card-&gt;cipmask2
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
op_amp
id|cmdcmsg
)paren
suffix:semicolon
id|listen_change_state
c_func
(paren
id|card
comma
id|EV_LISTEN_REQ
)paren
suffix:semicolon
)brace
DECL|function|listentimerfunc
r_static
r_void
id|listentimerfunc
c_func
(paren
r_int
r_int
id|x
)paren
(brace
id|capidrv_contr
op_star
id|card
op_assign
(paren
id|capidrv_contr
op_star
)paren
id|x
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;state
op_ne
id|ST_LISTEN_NONE
op_logical_and
id|card-&gt;state
op_ne
id|ST_LISTEN_ACTIVE
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: controller dead ??&bslash;n&quot;
comma
id|card-&gt;name
)paren
suffix:semicolon
id|send_listen
c_func
(paren
id|card
)paren
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|card-&gt;listentimer
comma
id|jiffies
op_plus
l_int|60
op_star
id|HZ
)paren
suffix:semicolon
)brace
DECL|function|capidrv_addcontr
r_static
r_int
id|capidrv_addcontr
c_func
(paren
id|__u16
id|contr
comma
r_struct
id|capi_profile
op_star
id|profp
)paren
(brace
id|capidrv_contr
op_star
id|card
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
r_char
id|id
(braket
l_int|20
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|sprintf
c_func
(paren
id|id
comma
l_string|&quot;capidrv-%d&quot;
comma
id|contr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|card
op_assign
(paren
id|capidrv_contr
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|capidrv_contr
)paren
comma
id|GFP_ATOMIC
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;capidrv: (%s) Could not allocate contr-struct.&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|card
comma
l_int|0
comma
r_sizeof
(paren
id|capidrv_contr
)paren
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|card-&gt;listentimer
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|card-&gt;name
comma
id|id
)paren
suffix:semicolon
id|card-&gt;contrnr
op_assign
id|contr
suffix:semicolon
id|card-&gt;nbchan
op_assign
id|profp-&gt;nbchannel
suffix:semicolon
id|card-&gt;bchans
op_assign
(paren
id|capidrv_bchan
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|capidrv_bchan
)paren
op_star
id|card-&gt;nbchan
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;bchans
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;capidrv: (%s) Could not allocate bchan-structs.&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|card-&gt;interface.channels
op_assign
id|profp-&gt;nbchannel
suffix:semicolon
id|card-&gt;interface.maxbufsize
op_assign
l_int|2048
suffix:semicolon
id|card-&gt;interface.command
op_assign
id|if_command
suffix:semicolon
id|card-&gt;interface.writebuf_skb
op_assign
id|if_sendbuf
suffix:semicolon
id|card-&gt;interface.writecmd
op_assign
l_int|0
suffix:semicolon
id|card-&gt;interface.readstat
op_assign
id|if_readstat
suffix:semicolon
id|card-&gt;interface.features
op_assign
id|ISDN_FEATURE_L2_HDLC
op_or
id|ISDN_FEATURE_L2_TRANS
op_or
id|ISDN_FEATURE_L3_TRANS
op_or
id|ISDN_FEATURE_P_UNKNOWN
op_or
id|ISDN_FEATURE_L2_X75I
op_or
id|ISDN_FEATURE_L2_X75UI
op_or
id|ISDN_FEATURE_L2_X75BUI
suffix:semicolon
r_if
c_cond
(paren
id|profp-&gt;support1
op_amp
(paren
l_int|1
op_lshift
l_int|2
)paren
)paren
id|card-&gt;interface.features
op_or_assign
id|ISDN_FEATURE_L2_V11096
op_or
id|ISDN_FEATURE_L2_V11019
op_or
id|ISDN_FEATURE_L2_V11038
suffix:semicolon
r_if
c_cond
(paren
id|profp-&gt;support1
op_amp
(paren
l_int|1
op_lshift
l_int|8
)paren
)paren
id|card-&gt;interface.features
op_or_assign
id|ISDN_FEATURE_L2_MODEM
suffix:semicolon
id|card-&gt;interface.hl_hdrlen
op_assign
l_int|22
suffix:semicolon
multiline_comment|/* len of DATA_B3_REQ */
id|strncpy
c_func
(paren
id|card-&gt;interface.id
comma
id|id
comma
r_sizeof
(paren
id|card-&gt;interface.id
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|card-&gt;q931_read
op_assign
id|card-&gt;q931_buf
suffix:semicolon
id|card-&gt;q931_write
op_assign
id|card-&gt;q931_buf
suffix:semicolon
id|card-&gt;q931_end
op_assign
id|card-&gt;q931_buf
op_plus
r_sizeof
(paren
id|card-&gt;q931_buf
)paren
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|register_isdn
c_func
(paren
op_amp
id|card-&gt;interface
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: Unable to register contr %s&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card-&gt;bchans
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|card-&gt;myid
op_assign
id|card-&gt;interface.channels
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|global_lock
comma
id|flags
)paren
suffix:semicolon
id|card-&gt;next
op_assign
id|global.contr_list
suffix:semicolon
id|global.contr_list
op_assign
id|card
suffix:semicolon
id|global.ncontr
op_increment
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|global_lock
comma
id|flags
)paren
suffix:semicolon
id|memset
c_func
(paren
id|card-&gt;bchans
comma
l_int|0
comma
r_sizeof
(paren
id|capidrv_bchan
)paren
op_star
id|card-&gt;nbchan
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|card-&gt;nbchan
suffix:semicolon
id|i
op_increment
)paren
(brace
id|card-&gt;bchans
(braket
id|i
)braket
dot
id|contr
op_assign
id|card
suffix:semicolon
)brace
id|cmd.command
op_assign
id|ISDN_STAT_RUN
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|card-&gt;cipmask
op_assign
l_int|0x1FFF03FF
suffix:semicolon
multiline_comment|/* any */
id|card-&gt;cipmask2
op_assign
l_int|0
suffix:semicolon
id|send_listen
c_func
(paren
id|card
)paren
suffix:semicolon
id|card-&gt;listentimer.data
op_assign
(paren
r_int
r_int
)paren
id|card
suffix:semicolon
id|card-&gt;listentimer.function
op_assign
id|listentimerfunc
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|card-&gt;listentimer
comma
id|jiffies
op_plus
l_int|60
op_star
id|HZ
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: now up (%d B channels)&bslash;n&quot;
comma
id|card-&gt;name
comma
id|card-&gt;nbchan
)paren
suffix:semicolon
id|enable_dchannel_trace
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|capidrv_delcontr
r_static
r_int
id|capidrv_delcontr
c_func
(paren
id|__u16
id|contr
)paren
(brace
id|capidrv_contr
op_star
op_star
id|pp
comma
op_star
id|card
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|global_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|card
op_assign
id|global.contr_list
suffix:semicolon
id|card
suffix:semicolon
id|card
op_assign
id|card-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;contrnr
op_eq
id|contr
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|global_lock
comma
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: delcontr: no contr %u&bslash;n&quot;
comma
id|contr
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|global_lock
comma
id|flags
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|card-&gt;listentimer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv-%d: id=%d unloading&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|card-&gt;myid
)paren
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_STOP
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
r_while
c_loop
(paren
id|card-&gt;nbchan
)paren
(brace
id|cmd.command
op_assign
id|ISDN_STAT_DISCH
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.arg
op_assign
id|card-&gt;nbchan
op_minus
l_int|1
suffix:semicolon
id|cmd.parm.num
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv-%d: id=%d disable chan=%ld&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|card-&gt;myid
comma
id|cmd.arg
)paren
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;bchans
(braket
id|card-&gt;nbchan
op_minus
l_int|1
)braket
dot
id|nccip
)paren
id|free_ncci
c_func
(paren
id|card
comma
id|card-&gt;bchans
(braket
id|card-&gt;nbchan
op_minus
l_int|1
)braket
dot
id|nccip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;bchans
(braket
id|card-&gt;nbchan
op_minus
l_int|1
)braket
dot
id|plcip
)paren
id|free_plci
c_func
(paren
id|card
comma
id|card-&gt;bchans
(braket
id|card-&gt;nbchan
op_minus
l_int|1
)braket
dot
id|plcip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;plci_list
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: bug in free_plci()&bslash;n&quot;
)paren
suffix:semicolon
id|card-&gt;nbchan
op_decrement
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|card-&gt;bchans
)paren
suffix:semicolon
id|card-&gt;bchans
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv-%d: id=%d isdn unload&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|card-&gt;myid
)paren
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_UNLOAD
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv-%d: id=%d remove contr from list&bslash;n&quot;
comma
id|card-&gt;contrnr
comma
id|card-&gt;myid
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|global_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|pp
op_assign
op_amp
id|global.contr_list
suffix:semicolon
op_star
id|pp
suffix:semicolon
id|pp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
)paren
(brace
r_if
c_cond
(paren
op_star
id|pp
op_eq
id|card
)paren
(brace
op_star
id|pp
op_assign
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
id|card-&gt;next
op_assign
l_int|0
suffix:semicolon
id|global.ncontr
op_decrement
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|global_lock
comma
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: now down.&bslash;n&quot;
comma
id|card-&gt;name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lower_callback
r_static
r_void
id|lower_callback
c_func
(paren
r_int
r_int
id|cmd
comma
id|__u32
id|contr
comma
r_void
op_star
id|data
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|KCI_CONTRUP
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv: controller %hu up&bslash;n&quot;
comma
id|contr
)paren
suffix:semicolon
(paren
r_void
)paren
id|capidrv_addcontr
c_func
(paren
id|contr
comma
(paren
id|capi_profile
op_star
)paren
id|data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|KCI_CONTRDOWN
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv: controller %hu down&bslash;n&quot;
comma
id|contr
)paren
suffix:semicolon
(paren
r_void
)paren
id|capidrv_delcontr
c_func
(paren
id|contr
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * /proc/capi/capidrv:&n; * nrecvctlpkt nrecvdatapkt nsendctlpkt nsenddatapkt&n; */
DECL|function|proc_capidrv_read_proc
r_static
r_int
id|proc_capidrv_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;%lu %lu %lu %lu&bslash;n&quot;
comma
id|global.nrecvctlpkt
comma
id|global.nrecvdatapkt
comma
id|global.nsentctlpkt
comma
id|global.nsentdatapkt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|off
op_plus
id|count
op_ge
id|len
)paren
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|off
)paren
r_return
l_int|0
suffix:semicolon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
r_return
(paren
(paren
id|count
OL
id|len
op_minus
id|off
)paren
ques
c_cond
id|count
suffix:colon
id|len
op_minus
id|off
)paren
suffix:semicolon
)brace
DECL|struct|procfsentries
r_static
r_struct
id|procfsentries
(brace
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|mode
id|mode_t
id|mode
suffix:semicolon
DECL|member|read_proc
r_int
(paren
op_star
id|read_proc
)paren
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
DECL|member|procent
r_struct
id|proc_dir_entry
op_star
id|procent
suffix:semicolon
DECL|variable|procfsentries
)brace
id|procfsentries
(braket
)braket
op_assign
(brace
multiline_comment|/* { &quot;capi&quot;,&t;&t;  S_IFDIR, 0 }, */
(brace
l_string|&quot;capi/capidrv&quot;
comma
l_int|0
comma
id|proc_capidrv_read_proc
)brace
comma
)brace
suffix:semicolon
DECL|function|proc_init
r_static
r_void
id|__init
id|proc_init
c_func
(paren
r_void
)paren
(brace
r_int
id|nelem
op_assign
r_sizeof
(paren
id|procfsentries
)paren
op_div
r_sizeof
(paren
id|procfsentries
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nelem
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|procfsentries
op_star
id|p
op_assign
id|procfsentries
op_plus
id|i
suffix:semicolon
id|p-&gt;procent
op_assign
id|create_proc_entry
c_func
(paren
id|p-&gt;name
comma
id|p-&gt;mode
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;procent
)paren
id|p-&gt;procent-&gt;read_proc
op_assign
id|p-&gt;read_proc
suffix:semicolon
)brace
)brace
DECL|function|proc_exit
r_static
r_void
id|__exit
id|proc_exit
c_func
(paren
r_void
)paren
(brace
r_int
id|nelem
op_assign
r_sizeof
(paren
id|procfsentries
)paren
op_div
r_sizeof
(paren
id|procfsentries
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|nelem
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_struct
id|procfsentries
op_star
id|p
op_assign
id|procfsentries
op_plus
id|i
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;procent
)paren
(brace
id|remove_proc_entry
c_func
(paren
id|p-&gt;name
comma
l_int|0
)paren
suffix:semicolon
id|p-&gt;procent
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
DECL|variable|cuser
r_static
r_struct
id|capi_interface_user
id|cuser
op_assign
(brace
id|name
suffix:colon
l_string|&quot;capidrv&quot;
comma
id|callback
suffix:colon
id|lower_callback
)brace
suffix:semicolon
DECL|function|capidrv_init
r_static
r_int
id|__init
id|capidrv_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|capi_register_params
id|rparam
suffix:semicolon
id|capi_profile
id|profile
suffix:semicolon
r_char
id|rev
(braket
l_int|10
)braket
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
id|__u32
id|ncontr
comma
id|contr
suffix:semicolon
id|__u16
id|errcode
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|capifuncs
op_assign
id|attach_capi_interface
c_func
(paren
op_amp
id|cuser
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capifuncs
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|p
op_assign
id|strchr
c_func
(paren
id|revision
comma
l_char|&squot;:&squot;
)paren
)paren
)paren
(brace
id|strcpy
c_func
(paren
id|rev
comma
id|p
op_plus
l_int|1
)paren
suffix:semicolon
id|p
op_assign
id|strchr
c_func
(paren
id|rev
comma
l_char|&squot;$&squot;
)paren
suffix:semicolon
op_star
id|p
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|strcpy
c_func
(paren
id|rev
comma
l_string|&quot; ??? &quot;
)paren
suffix:semicolon
id|rparam.level3cnt
op_assign
op_minus
l_int|2
suffix:semicolon
multiline_comment|/* number of bchannels twice */
id|rparam.datablkcnt
op_assign
l_int|16
suffix:semicolon
id|rparam.datablklen
op_assign
l_int|2048
suffix:semicolon
id|errcode
op_assign
(paren
op_star
id|capifuncs-&gt;capi_register
)paren
(paren
op_amp
id|rparam
comma
op_amp
id|global.appid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errcode
)paren
(brace
id|detach_capi_interface
c_func
(paren
op_amp
id|cuser
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|errcode
op_assign
(paren
op_star
id|capifuncs-&gt;capi_get_profile
)paren
(paren
l_int|0
comma
op_amp
id|profile
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errcode
op_ne
id|CAPI_NOERROR
)paren
(brace
(paren
r_void
)paren
(paren
op_star
id|capifuncs-&gt;capi_release
)paren
(paren
id|global.appid
)paren
suffix:semicolon
id|detach_capi_interface
c_func
(paren
op_amp
id|cuser
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
(paren
r_void
)paren
(paren
op_star
id|capifuncs-&gt;capi_set_signal
)paren
(paren
id|global.appid
comma
id|capidrv_signal
comma
l_int|0
)paren
suffix:semicolon
id|ncontr
op_assign
id|profile.ncontroller
suffix:semicolon
r_for
c_loop
(paren
id|contr
op_assign
l_int|1
suffix:semicolon
id|contr
op_le
id|ncontr
suffix:semicolon
id|contr
op_increment
)paren
(brace
id|errcode
op_assign
(paren
op_star
id|capifuncs-&gt;capi_get_profile
)paren
(paren
id|contr
comma
op_amp
id|profile
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errcode
op_ne
id|CAPI_NOERROR
)paren
r_continue
suffix:semicolon
(paren
r_void
)paren
id|capidrv_addcontr
c_func
(paren
id|contr
comma
op_amp
id|profile
)paren
suffix:semicolon
)brace
id|proc_init
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;capidrv: Rev%s: loaded&bslash;n&quot;
comma
id|rev
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|capidrv_exit
r_static
r_void
id|__exit
id|capidrv_exit
c_func
(paren
r_void
)paren
(brace
r_char
id|rev
(braket
l_int|10
)braket
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
op_assign
id|strchr
c_func
(paren
id|revision
comma
l_char|&squot;:&squot;
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|strcpy
c_func
(paren
id|rev
comma
id|p
op_plus
l_int|1
)paren
suffix:semicolon
id|p
op_assign
id|strchr
c_func
(paren
id|rev
comma
l_char|&squot;$&squot;
)paren
suffix:semicolon
op_star
id|p
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|strcpy
c_func
(paren
id|rev
comma
l_string|&quot; ??? &quot;
)paren
suffix:semicolon
)brace
(paren
r_void
)paren
(paren
op_star
id|capifuncs-&gt;capi_release
)paren
(paren
id|global.appid
)paren
suffix:semicolon
id|detach_capi_interface
c_func
(paren
op_amp
id|cuser
)paren
suffix:semicolon
id|proc_exit
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;capidrv: Rev%s: unloaded&bslash;n&quot;
comma
id|rev
)paren
suffix:semicolon
)brace
DECL|variable|capidrv_init
id|module_init
c_func
(paren
id|capidrv_init
)paren
suffix:semicolon
DECL|variable|capidrv_exit
id|module_exit
c_func
(paren
id|capidrv_exit
)paren
suffix:semicolon
eof
