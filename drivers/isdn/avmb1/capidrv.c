multiline_comment|/*&n; * $Id: capidrv.c,v 1.3 1997/05/18 09:24:15 calle Exp $&n; *&n; * ISDN4Linux Driver, using capi20 interface (kernelcapi)&n; *&n; * Copyright 1997 by Carsten Paeth (calle@calle.in-berlin.de)&n; *&n; * $Log: capidrv.c,v $&n; * Revision 1.3  1997/05/18 09:24:15  calle&n; * added verbose disconnect reason reporting to avmb1.&n; * some fixes in capi20 interface.&n; * changed info messages for B1-PCI&n; *&n; * Revision 1.2  1997/03/05 21:19:59  fritz&n; * Removed include of config.h (mkdep stated this is unneded).&n; *&n; * Revision 1.1  1997/03/04 21:50:31  calle&n; * Frirst version in isdn4linux&n; *&n; * Revision 2.2  1997/02/12 09:31:39  calle&n; * new version&n; *&n; * Revision 1.1  1997/01/31 10:32:20  calle&n; * Initial revision&n; *&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/isdn.h&gt;
macro_line|#include &lt;linux/isdnif.h&gt;
macro_line|#include &lt;linux/capi.h&gt;
macro_line|#include &lt;linux/kernelcapi.h&gt;
macro_line|#include &quot;compat.h&quot;
macro_line|#include &quot;capiutil.h&quot;
macro_line|#include &quot;capicmd.h&quot;
macro_line|#include &quot;capidrv.h&quot;
DECL|variable|revision
r_static
r_char
op_star
id|revision
op_assign
l_string|&quot;$Revision: 1.3 $&quot;
suffix:semicolon
DECL|variable|debugmode
r_int
id|debugmode
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef HAS_NEW_SYMTAB
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Carsten Paeth &lt;calle@calle.in-berlin.de&gt;&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debugmode
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* -------- type definitions ----------------------------------------- */
DECL|struct|capidrv_contr
r_struct
id|capidrv_contr
(brace
DECL|member|next
r_struct
id|capidrv_contr
op_star
id|next
suffix:semicolon
DECL|member|contrnr
id|__u32
id|contrnr
suffix:semicolon
DECL|member|name
r_char
id|name
(braket
l_int|20
)braket
suffix:semicolon
multiline_comment|/*&n;&t; * for isdn4linux&n;&t; */
DECL|member|interface
id|isdn_if
id|interface
suffix:semicolon
DECL|member|myid
r_int
id|myid
suffix:semicolon
multiline_comment|/*&n;&t; * LISTEN state&n;&t; */
DECL|member|state
r_int
id|state
suffix:semicolon
DECL|member|cipmask
id|__u32
id|cipmask
suffix:semicolon
DECL|member|cipmask2
id|__u32
id|cipmask2
suffix:semicolon
multiline_comment|/*&n;&t; * ID of capi message sent&n;&t; */
DECL|member|msgid
id|__u16
id|msgid
suffix:semicolon
multiline_comment|/*&n;&t; * B-Channels&n;&t; */
DECL|member|nbchan
r_int
id|nbchan
suffix:semicolon
DECL|struct|capidrv_bchan
r_struct
id|capidrv_bchan
(brace
DECL|member|contr
r_struct
id|capidrv_contr
op_star
id|contr
suffix:semicolon
DECL|member|msn
id|__u8
id|msn
(braket
id|ISDN_MSNLEN
)braket
suffix:semicolon
DECL|member|l2
r_int
id|l2
suffix:semicolon
DECL|member|l3
r_int
id|l3
suffix:semicolon
DECL|member|num
id|__u8
id|num
(braket
id|ISDN_MSNLEN
)braket
suffix:semicolon
DECL|member|mynum
id|__u8
id|mynum
(braket
id|ISDN_MSNLEN
)braket
suffix:semicolon
DECL|member|si1
r_int
id|si1
suffix:semicolon
DECL|member|si2
r_int
id|si2
suffix:semicolon
DECL|member|incoming
r_int
id|incoming
suffix:semicolon
DECL|member|disconnecting
r_int
id|disconnecting
suffix:semicolon
DECL|struct|capidrv_plci
r_struct
id|capidrv_plci
(brace
DECL|member|next
r_struct
id|capidrv_plci
op_star
id|next
suffix:semicolon
DECL|member|plci
id|__u32
id|plci
suffix:semicolon
DECL|member|ncci
id|__u32
id|ncci
suffix:semicolon
multiline_comment|/* ncci for CONNECT_ACTIVE_IND */
DECL|member|msgid
id|__u16
id|msgid
suffix:semicolon
multiline_comment|/* to identfy CONNECT_CONF */
DECL|member|chan
r_int
id|chan
suffix:semicolon
DECL|member|state
r_int
id|state
suffix:semicolon
DECL|struct|capidrv_ncci
r_struct
id|capidrv_ncci
(brace
DECL|member|next
r_struct
id|capidrv_ncci
op_star
id|next
suffix:semicolon
DECL|member|plcip
r_struct
id|capidrv_plci
op_star
id|plcip
suffix:semicolon
DECL|member|ncci
id|__u32
id|ncci
suffix:semicolon
DECL|member|msgid
id|__u16
id|msgid
suffix:semicolon
multiline_comment|/* to identfy CONNECT_B3_CONF */
DECL|member|chan
r_int
id|chan
suffix:semicolon
DECL|member|state
r_int
id|state
suffix:semicolon
DECL|member|oldstate
r_int
id|oldstate
suffix:semicolon
multiline_comment|/* */
DECL|member|datahandle
id|__u16
id|datahandle
suffix:semicolon
DECL|member|ncci_list
)brace
op_star
id|ncci_list
suffix:semicolon
DECL|member|plcip
)brace
op_star
id|plcip
suffix:semicolon
DECL|member|nccip
r_struct
id|capidrv_ncci
op_star
id|nccip
suffix:semicolon
DECL|member|bchans
)brace
op_star
id|bchans
suffix:semicolon
DECL|member|plci_list
r_struct
id|capidrv_plci
op_star
id|plci_list
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|capidrv_data
r_struct
id|capidrv_data
(brace
DECL|member|appid
id|__u16
id|appid
suffix:semicolon
DECL|member|ncontr
r_int
id|ncontr
suffix:semicolon
DECL|member|contr_list
r_struct
id|capidrv_contr
op_star
id|contr_list
suffix:semicolon
)brace
suffix:semicolon
DECL|typedef|capidrv_plci
r_typedef
r_struct
id|capidrv_plci
id|capidrv_plci
suffix:semicolon
DECL|typedef|capidrv_ncci
r_typedef
r_struct
id|capidrv_ncci
id|capidrv_ncci
suffix:semicolon
DECL|typedef|capidrv_contr
r_typedef
r_struct
id|capidrv_contr
id|capidrv_contr
suffix:semicolon
DECL|typedef|capidrv_data
r_typedef
r_struct
id|capidrv_data
id|capidrv_data
suffix:semicolon
DECL|typedef|capidrv_bchan
r_typedef
r_struct
id|capidrv_bchan
id|capidrv_bchan
suffix:semicolon
multiline_comment|/* -------- data definitions ----------------------------------------- */
DECL|variable|global
r_static
id|capidrv_data
id|global
suffix:semicolon
DECL|variable|capifuncs
r_static
r_struct
id|capi_interface
op_star
id|capifuncs
suffix:semicolon
multiline_comment|/* -------- convert functions ---------------------------------------- */
DECL|function|b1prot
r_static
r_inline
id|__u32
id|b1prot
c_func
(paren
r_int
id|l2
comma
r_int
id|l3
)paren
(brace
r_switch
c_cond
(paren
id|l2
)paren
(brace
r_case
id|ISDN_PROTO_L2_X75I
suffix:colon
r_case
id|ISDN_PROTO_L2_X75UI
suffix:colon
r_case
id|ISDN_PROTO_L2_X75BUI
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|ISDN_PROTO_L2_HDLC
suffix:colon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|ISDN_PROTO_L2_TRANS
suffix:colon
r_return
l_int|1
suffix:semicolon
)brace
)brace
DECL|function|b2prot
r_static
r_inline
id|__u32
id|b2prot
c_func
(paren
r_int
id|l2
comma
r_int
id|l3
)paren
(brace
r_switch
c_cond
(paren
id|l2
)paren
(brace
r_case
id|ISDN_PROTO_L2_X75I
suffix:colon
r_case
id|ISDN_PROTO_L2_X75UI
suffix:colon
r_case
id|ISDN_PROTO_L2_X75BUI
suffix:colon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|ISDN_PROTO_L2_HDLC
suffix:colon
r_return
l_int|1
suffix:semicolon
r_case
id|ISDN_PROTO_L2_TRANS
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|b3prot
r_static
r_inline
id|__u32
id|b3prot
c_func
(paren
r_int
id|l2
comma
r_int
id|l3
)paren
(brace
r_switch
c_cond
(paren
id|l2
)paren
(brace
r_case
id|ISDN_PROTO_L2_X75I
suffix:colon
r_case
id|ISDN_PROTO_L2_X75UI
suffix:colon
r_case
id|ISDN_PROTO_L2_X75BUI
suffix:colon
r_case
id|ISDN_PROTO_L2_HDLC
suffix:colon
r_case
id|ISDN_PROTO_L2_TRANS
suffix:colon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|si2cip
r_static
r_inline
id|__u16
id|si2cip
c_func
(paren
id|__u8
id|si1
comma
id|__u8
id|si2
)paren
(brace
r_static
r_const
id|__u8
id|cip
(braket
l_int|17
)braket
(braket
l_int|5
)braket
op_assign
(brace
multiline_comment|/*  0  1  2  3  4  */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/*0 */
(brace
l_int|16
comma
l_int|16
comma
l_int|4
comma
l_int|26
comma
l_int|16
)brace
comma
multiline_comment|/*1 */
(brace
l_int|17
comma
l_int|17
comma
l_int|17
comma
l_int|4
comma
l_int|4
)brace
comma
multiline_comment|/*2 */
(brace
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
)brace
comma
multiline_comment|/*3 */
(brace
l_int|18
comma
l_int|18
comma
l_int|18
comma
l_int|18
comma
l_int|18
)brace
comma
multiline_comment|/*4 */
(brace
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
)brace
comma
multiline_comment|/*5 */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/*6 */
(brace
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
)brace
comma
multiline_comment|/*7 */
(brace
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
)brace
comma
multiline_comment|/*8 */
(brace
l_int|21
comma
l_int|21
comma
l_int|21
comma
l_int|21
comma
l_int|21
)brace
comma
multiline_comment|/*9 */
(brace
l_int|19
comma
l_int|19
comma
l_int|19
comma
l_int|19
comma
l_int|19
)brace
comma
multiline_comment|/*10 */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/*11 */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/*12 */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/*13 */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/*14 */
(brace
l_int|22
comma
l_int|22
comma
l_int|22
comma
l_int|22
comma
l_int|22
)brace
comma
multiline_comment|/*15 */
(brace
l_int|27
comma
l_int|27
comma
l_int|27
comma
l_int|28
comma
l_int|27
)brace
multiline_comment|/*16 */
)brace
suffix:semicolon
r_if
c_cond
(paren
id|si1
OG
l_int|16
)paren
id|si1
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|si2
OG
l_int|4
)paren
id|si2
op_assign
l_int|0
suffix:semicolon
r_return
(paren
id|__u16
)paren
id|cip
(braket
id|si1
)braket
(braket
id|si2
)braket
suffix:semicolon
)brace
DECL|function|cip2si1
r_static
r_inline
id|__u8
id|cip2si1
c_func
(paren
id|__u16
id|cipval
)paren
(brace
r_static
r_const
id|__u8
id|si
(braket
l_int|32
)braket
op_assign
(brace
l_int|7
comma
l_int|1
comma
l_int|7
comma
l_int|7
comma
l_int|1
comma
l_int|1
comma
l_int|7
comma
l_int|7
comma
multiline_comment|/*0-7 */
l_int|7
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/*8-15 */
l_int|1
comma
l_int|2
comma
l_int|4
comma
l_int|10
comma
l_int|9
comma
l_int|9
comma
l_int|15
comma
l_int|7
comma
multiline_comment|/*16-23 */
l_int|7
comma
l_int|7
comma
l_int|1
comma
l_int|16
comma
l_int|16
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/*24-31 */
r_if
c_cond
(paren
id|cipval
OG
l_int|31
)paren
id|cipval
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* .... */
r_return
id|si
(braket
id|cipval
)braket
suffix:semicolon
)brace
DECL|function|cip2si2
r_static
r_inline
id|__u8
id|cip2si2
c_func
(paren
id|__u16
id|cipval
)paren
(brace
r_static
r_const
id|__u8
id|si
(braket
l_int|32
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|2
comma
l_int|3
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/*0-7 */
l_int|0
comma
l_int|3
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/*8-15 */
l_int|1
comma
l_int|2
comma
l_int|0
comma
l_int|0
comma
l_int|9
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/*16-23 */
l_int|0
comma
l_int|0
comma
l_int|3
comma
l_int|2
comma
l_int|3
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/*24-31 */
r_if
c_cond
(paren
id|cipval
OG
l_int|31
)paren
id|cipval
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* .... */
r_return
id|si
(braket
id|cipval
)braket
suffix:semicolon
)brace
multiline_comment|/* -------- controller managment ------------------------------------- */
DECL|function|findcontrbydriverid
r_static
r_inline
id|capidrv_contr
op_star
id|findcontrbydriverid
c_func
(paren
r_int
id|driverid
)paren
(brace
id|capidrv_contr
op_star
id|p
op_assign
id|global.contr_list
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;myid
op_eq
id|driverid
)paren
r_return
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
suffix:semicolon
)brace
r_return
(paren
id|capidrv_contr
op_star
)paren
l_int|0
suffix:semicolon
)brace
DECL|function|findcontrbynumber
r_static
id|capidrv_contr
op_star
id|findcontrbynumber
c_func
(paren
id|__u32
id|contr
)paren
(brace
id|capidrv_contr
op_star
id|p
op_assign
id|global.contr_list
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;contrnr
op_eq
id|contr
)paren
r_return
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
suffix:semicolon
)brace
r_return
(paren
id|capidrv_contr
op_star
)paren
l_int|0
suffix:semicolon
)brace
multiline_comment|/* -------- plci management ------------------------------------------ */
DECL|function|new_plci
r_static
id|capidrv_plci
op_star
id|new_plci
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
r_int
id|chan
)paren
(brace
id|capidrv_plci
op_star
id|plcip
suffix:semicolon
id|plcip
op_assign
(paren
id|capidrv_plci
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|capidrv_plci
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|plcip
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|plcip
comma
l_int|0
comma
r_sizeof
(paren
id|capidrv_plci
)paren
)paren
suffix:semicolon
id|plcip-&gt;state
op_assign
id|ST_PLCI_NONE
suffix:semicolon
id|plcip-&gt;plci
op_assign
l_int|0
suffix:semicolon
id|plcip-&gt;msgid
op_assign
l_int|0
suffix:semicolon
id|plcip-&gt;chan
op_assign
id|chan
suffix:semicolon
id|plcip-&gt;next
op_assign
id|card-&gt;plci_list
suffix:semicolon
id|card-&gt;plci_list
op_assign
id|plcip
suffix:semicolon
id|card-&gt;bchans
(braket
id|chan
)braket
dot
id|plcip
op_assign
id|plcip
suffix:semicolon
r_return
id|plcip
suffix:semicolon
)brace
DECL|function|find_plci_by_plci
r_static
id|capidrv_plci
op_star
id|find_plci_by_plci
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
id|__u32
id|plci
)paren
(brace
id|capidrv_plci
op_star
id|p
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|card-&gt;plci_list
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
r_if
c_cond
(paren
id|p-&gt;plci
op_eq
id|plci
)paren
r_return
id|p
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|find_plci_by_msgid
r_static
id|capidrv_plci
op_star
id|find_plci_by_msgid
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
id|__u16
id|msgid
)paren
(brace
id|capidrv_plci
op_star
id|p
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|card-&gt;plci_list
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
r_if
c_cond
(paren
id|p-&gt;msgid
op_eq
id|msgid
)paren
r_return
id|p
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|find_plci_by_ncci
r_static
id|capidrv_plci
op_star
id|find_plci_by_ncci
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
id|__u32
id|ncci
)paren
(brace
id|capidrv_plci
op_star
id|p
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|card-&gt;plci_list
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
r_if
c_cond
(paren
id|p-&gt;plci
op_eq
(paren
id|ncci
op_amp
l_int|0xffff
)paren
)paren
r_return
id|p
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|free_plci
r_static
r_void
id|free_plci
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
id|capidrv_plci
op_star
id|plcip
)paren
(brace
id|capidrv_plci
op_star
op_star
id|pp
suffix:semicolon
r_for
c_loop
(paren
id|pp
op_assign
op_amp
id|card-&gt;plci_list
suffix:semicolon
op_star
id|pp
suffix:semicolon
id|pp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
)paren
(brace
r_if
c_cond
(paren
op_star
id|pp
op_eq
id|plcip
)paren
(brace
op_star
id|pp
op_assign
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
id|card-&gt;bchans
(braket
id|plcip-&gt;chan
)braket
dot
id|plcip
op_assign
l_int|0
suffix:semicolon
id|card-&gt;bchans
(braket
id|plcip-&gt;chan
)braket
dot
id|disconnecting
op_assign
l_int|0
suffix:semicolon
id|card-&gt;bchans
(braket
id|plcip-&gt;chan
)braket
dot
id|incoming
op_assign
l_int|0
suffix:semicolon
id|kfree
c_func
(paren
id|plcip
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: free_plci %p (0x%x) not found, Huh?&bslash;n&quot;
comma
id|plcip
comma
id|plcip-&gt;plci
)paren
suffix:semicolon
)brace
multiline_comment|/* -------- ncci management ------------------------------------------ */
DECL|function|new_ncci
r_static
r_inline
id|capidrv_ncci
op_star
id|new_ncci
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
id|capidrv_plci
op_star
id|plcip
comma
id|__u32
id|ncci
)paren
(brace
id|capidrv_ncci
op_star
id|nccip
suffix:semicolon
id|nccip
op_assign
(paren
id|capidrv_ncci
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|capidrv_ncci
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nccip
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|nccip
comma
l_int|0
comma
r_sizeof
(paren
id|capidrv_ncci
)paren
)paren
suffix:semicolon
id|nccip-&gt;ncci
op_assign
id|ncci
suffix:semicolon
id|nccip-&gt;state
op_assign
id|ST_NCCI_NONE
suffix:semicolon
id|nccip-&gt;plcip
op_assign
id|plcip
suffix:semicolon
id|nccip-&gt;chan
op_assign
id|plcip-&gt;chan
suffix:semicolon
id|nccip-&gt;datahandle
op_assign
l_int|0
suffix:semicolon
id|nccip-&gt;next
op_assign
id|plcip-&gt;ncci_list
suffix:semicolon
id|plcip-&gt;ncci_list
op_assign
id|nccip
suffix:semicolon
id|card-&gt;bchans
(braket
id|plcip-&gt;chan
)braket
dot
id|nccip
op_assign
id|nccip
suffix:semicolon
r_return
id|nccip
suffix:semicolon
)brace
DECL|function|find_ncci
r_static
r_inline
id|capidrv_ncci
op_star
id|find_ncci
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
id|__u32
id|ncci
)paren
(brace
id|capidrv_plci
op_star
id|plcip
suffix:semicolon
id|capidrv_ncci
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
(paren
id|plcip
op_assign
id|find_plci_by_ncci
c_func
(paren
id|card
comma
id|ncci
)paren
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|plcip-&gt;ncci_list
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
r_if
c_cond
(paren
id|p-&gt;ncci
op_eq
id|ncci
)paren
r_return
id|p
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|find_ncci_by_msgid
r_static
r_inline
id|capidrv_ncci
op_star
id|find_ncci_by_msgid
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
id|__u32
id|ncci
comma
id|__u16
id|msgid
)paren
(brace
id|capidrv_plci
op_star
id|plcip
suffix:semicolon
id|capidrv_ncci
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
(paren
id|plcip
op_assign
id|find_plci_by_ncci
c_func
(paren
id|card
comma
id|ncci
)paren
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|plcip-&gt;ncci_list
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
r_if
c_cond
(paren
id|p-&gt;msgid
op_eq
id|msgid
)paren
r_return
id|p
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|free_ncci
r_static
r_void
id|free_ncci
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
r_struct
id|capidrv_ncci
op_star
id|nccip
)paren
(brace
r_struct
id|capidrv_ncci
op_star
op_star
id|pp
suffix:semicolon
r_for
c_loop
(paren
id|pp
op_assign
op_amp
(paren
id|nccip-&gt;plcip-&gt;ncci_list
)paren
suffix:semicolon
op_star
id|pp
suffix:semicolon
id|pp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
)paren
(brace
r_if
c_cond
(paren
op_star
id|pp
op_eq
id|nccip
)paren
(brace
op_star
id|pp
op_assign
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|card-&gt;bchans
(braket
id|nccip-&gt;chan
)braket
dot
id|nccip
op_assign
l_int|0
suffix:semicolon
id|kfree
c_func
(paren
id|nccip
)paren
suffix:semicolon
)brace
multiline_comment|/* -------- convert and send capi message ---------------------------- */
DECL|function|send_message
r_static
r_void
id|send_message
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
id|_cmsg
op_star
id|cmsg
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|len
suffix:semicolon
id|capi_cmsg2message
c_func
(paren
id|cmsg
comma
id|cmsg-&gt;buf
)paren
suffix:semicolon
id|len
op_assign
id|CAPIMSG_LEN
c_func
(paren
id|cmsg-&gt;buf
)paren
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
)paren
suffix:semicolon
id|SET_SKB_FREE
c_func
(paren
id|skb
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
comma
id|cmsg-&gt;buf
comma
id|len
)paren
suffix:semicolon
(paren
op_star
id|capifuncs-&gt;capi_put_message
)paren
(paren
id|global.appid
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/* -------- state machine -------------------------------------------- */
DECL|struct|listenstatechange
r_struct
id|listenstatechange
(brace
DECL|member|actstate
r_int
id|actstate
suffix:semicolon
DECL|member|nextstate
r_int
id|nextstate
suffix:semicolon
DECL|member|event
r_int
id|event
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|listentable
r_static
r_struct
id|listenstatechange
id|listentable
(braket
)braket
op_assign
(brace
(brace
id|ST_LISTEN_NONE
comma
id|ST_LISTEN_WAIT_CONF
comma
id|EV_LISTEN_REQ
)brace
comma
(brace
id|ST_LISTEN_ACTIVE
comma
id|ST_LISTEN_ACTIVE_WAIT_CONF
comma
id|EV_LISTEN_REQ
)brace
comma
(brace
id|ST_LISTEN_WAIT_CONF
comma
id|ST_LISTEN_NONE
comma
id|EV_LISTEN_CONF_ERROR
)brace
comma
(brace
id|ST_LISTEN_ACTIVE_WAIT_CONF
comma
id|ST_LISTEN_ACTIVE
comma
id|EV_LISTEN_CONF_ERROR
)brace
comma
(brace
id|ST_LISTEN_WAIT_CONF
comma
id|ST_LISTEN_NONE
comma
id|EV_LISTEN_CONF_EMPTY
)brace
comma
(brace
id|ST_LISTEN_ACTIVE_WAIT_CONF
comma
id|ST_LISTEN_NONE
comma
id|EV_LISTEN_CONF_EMPTY
)brace
comma
(brace
id|ST_LISTEN_WAIT_CONF
comma
id|ST_LISTEN_ACTIVE
comma
id|EV_LISTEN_CONF_OK
)brace
comma
(brace
id|ST_LISTEN_ACTIVE_WAIT_CONF
comma
id|ST_LISTEN_ACTIVE
comma
id|EV_LISTEN_CONF_OK
)brace
comma
(brace
)brace
comma
)brace
suffix:semicolon
DECL|function|listen_change_state
r_static
r_void
id|listen_change_state
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
r_int
id|event
)paren
(brace
r_struct
id|listenstatechange
op_star
id|p
op_assign
id|listentable
suffix:semicolon
r_while
c_loop
(paren
id|p-&gt;event
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;state
op_eq
id|p-&gt;actstate
op_logical_and
id|p-&gt;event
op_eq
id|event
)paren
(brace
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv: listen_change_state %d -&gt; %d&bslash;n&quot;
comma
id|card-&gt;state
comma
id|p-&gt;nextstate
)paren
suffix:semicolon
id|card-&gt;state
op_assign
id|p-&gt;nextstate
suffix:semicolon
r_return
suffix:semicolon
)brace
id|p
op_increment
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: listen_change_state state=%d event=%d ????&bslash;n&quot;
comma
id|card-&gt;state
comma
id|event
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------ */
DECL|function|p0
r_static
r_void
id|p0
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
id|capidrv_plci
op_star
id|plci
)paren
(brace
id|isdn_ctrl
id|cmd
suffix:semicolon
id|card-&gt;bchans
(braket
id|plci-&gt;chan
)braket
dot
id|contr
op_assign
l_int|0
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_DHUP
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.arg
op_assign
id|plci-&gt;chan
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|free_plci
c_func
(paren
id|card
comma
id|plci
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------ */
DECL|struct|plcistatechange
r_struct
id|plcistatechange
(brace
DECL|member|actstate
r_int
id|actstate
suffix:semicolon
DECL|member|nextstate
r_int
id|nextstate
suffix:semicolon
DECL|member|event
r_int
id|event
suffix:semicolon
DECL|member|changefunc
r_void
(paren
op_star
id|changefunc
)paren
(paren
id|capidrv_contr
op_star
id|card
comma
id|capidrv_plci
op_star
id|plci
)paren
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|plcitable
r_static
r_struct
id|plcistatechange
id|plcitable
(braket
)braket
op_assign
(brace
multiline_comment|/* P-0 */
(brace
id|ST_PLCI_NONE
comma
id|ST_PLCI_OUTGOING
comma
id|EV_PLCI_CONNECT_REQ
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_NONE
comma
id|ST_PLCI_ALLOCATED
comma
id|EV_PLCI_FACILITY_IND_UP
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_NONE
comma
id|ST_PLCI_INCOMING
comma
id|EV_PLCI_CONNECT_IND
comma
l_int|0
)brace
comma
multiline_comment|/* P-0.1 */
(brace
id|ST_PLCI_OUTGOING
comma
id|ST_PLCI_NONE
comma
id|EV_PLCI_CONNECT_CONF_ERROR
comma
id|p0
)brace
comma
(brace
id|ST_PLCI_OUTGOING
comma
id|ST_PLCI_ALLOCATED
comma
id|EV_PLCI_CONNECT_CONF_OK
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_OUTGOING
comma
id|ST_PLCI_DISCONNECTING
comma
id|EV_PLCI_DISCONNECT_REQ
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_OUTGOING
comma
id|ST_PLCI_DISCONNECTING
comma
id|EV_PLCI_FACILITY_IND_DOWN
comma
l_int|0
)brace
comma
multiline_comment|/* P-1 */
(brace
id|ST_PLCI_ALLOCATED
comma
id|ST_PLCI_ACTIVE
comma
id|EV_PLCI_CONNECT_ACTIVE_IND
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_ALLOCATED
comma
id|ST_PLCI_DISCONNECTING
comma
id|EV_PLCI_DISCONNECT_REQ
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_ALLOCATED
comma
id|ST_PLCI_DISCONNECTING
comma
id|EV_PLCI_FACILITY_IND_DOWN
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_ALLOCATED
comma
id|ST_PLCI_DISCONNECTED
comma
id|EV_PLCI_DISCONNECT_IND
comma
l_int|0
)brace
comma
multiline_comment|/* P-ACT */
(brace
id|ST_PLCI_ACTIVE
comma
id|ST_PLCI_DISCONNECTING
comma
id|EV_PLCI_DISCONNECT_REQ
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_ACTIVE
comma
id|ST_PLCI_DISCONNECTING
comma
id|EV_PLCI_FACILITY_IND_DOWN
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_ACTIVE
comma
id|ST_PLCI_DISCONNECTED
comma
id|EV_PLCI_DISCONNECT_IND
comma
l_int|0
)brace
comma
multiline_comment|/* P-2 */
(brace
id|ST_PLCI_INCOMING
comma
id|ST_PLCI_DISCONNECTING
comma
id|EV_PLCI_CONNECT_REJECT
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_INCOMING
comma
id|ST_PLCI_FACILITY_IND
comma
id|EV_PLCI_FACILITY_IND_UP
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_INCOMING
comma
id|ST_PLCI_ACCEPTING
comma
id|EV_PLCI_CONNECT_RESP
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_INCOMING
comma
id|ST_PLCI_DISCONNECTING
comma
id|EV_PLCI_DISCONNECT_REQ
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_INCOMING
comma
id|ST_PLCI_DISCONNECTING
comma
id|EV_PLCI_FACILITY_IND_DOWN
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_INCOMING
comma
id|ST_PLCI_DISCONNECTED
comma
id|EV_PLCI_DISCONNECT_IND
comma
l_int|0
)brace
comma
multiline_comment|/* P-3 */
(brace
id|ST_PLCI_FACILITY_IND
comma
id|ST_PLCI_DISCONNECTING
comma
id|EV_PLCI_CONNECT_REJECT
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_FACILITY_IND
comma
id|ST_PLCI_ACCEPTING
comma
id|EV_PLCI_CONNECT_ACTIVE_IND
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_FACILITY_IND
comma
id|ST_PLCI_DISCONNECTING
comma
id|EV_PLCI_DISCONNECT_REQ
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_FACILITY_IND
comma
id|ST_PLCI_DISCONNECTING
comma
id|EV_PLCI_FACILITY_IND_DOWN
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_FACILITY_IND
comma
id|ST_PLCI_DISCONNECTED
comma
id|EV_PLCI_DISCONNECT_IND
comma
l_int|0
)brace
comma
multiline_comment|/* P-4 */
(brace
id|ST_PLCI_ACCEPTING
comma
id|ST_PLCI_ACTIVE
comma
id|EV_PLCI_CONNECT_ACTIVE_IND
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_ACCEPTING
comma
id|ST_PLCI_DISCONNECTING
comma
id|EV_PLCI_DISCONNECT_REQ
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_ACCEPTING
comma
id|ST_PLCI_DISCONNECTING
comma
id|EV_PLCI_FACILITY_IND_DOWN
comma
l_int|0
)brace
comma
(brace
id|ST_PLCI_ACCEPTING
comma
id|ST_PLCI_DISCONNECTED
comma
id|EV_PLCI_DISCONNECT_IND
comma
l_int|0
)brace
comma
multiline_comment|/* P-5 */
(brace
id|ST_PLCI_DISCONNECTING
comma
id|ST_PLCI_DISCONNECTED
comma
id|EV_PLCI_DISCONNECT_IND
comma
l_int|0
)brace
comma
multiline_comment|/* P-6 */
(brace
id|ST_PLCI_DISCONNECTED
comma
id|ST_PLCI_NONE
comma
id|EV_PLCI_DISCONNECT_RESP
comma
id|p0
)brace
comma
(brace
)brace
comma
)brace
suffix:semicolon
DECL|function|plci_change_state
r_static
r_void
id|plci_change_state
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
id|capidrv_plci
op_star
id|plci
comma
r_int
id|event
)paren
(brace
r_struct
id|plcistatechange
op_star
id|p
op_assign
id|plcitable
suffix:semicolon
r_while
c_loop
(paren
id|p-&gt;event
)paren
(brace
r_if
c_cond
(paren
id|plci-&gt;state
op_eq
id|p-&gt;actstate
op_logical_and
id|p-&gt;event
op_eq
id|event
)paren
(brace
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv: plci_change_state:0x%x %d -&gt; %d&bslash;n&quot;
comma
id|plci-&gt;plci
comma
id|plci-&gt;state
comma
id|p-&gt;nextstate
)paren
suffix:semicolon
id|plci-&gt;state
op_assign
id|p-&gt;nextstate
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;changefunc
)paren
id|p
op_member_access_from_pointer
id|changefunc
c_func
(paren
id|card
comma
id|plci
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|p
op_increment
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: plci_change_state:0x%x state=%d event=%d ????&bslash;n&quot;
comma
id|plci-&gt;plci
comma
id|plci-&gt;state
comma
id|event
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------ */
DECL|variable|cmsg
r_static
id|_cmsg
id|cmsg
suffix:semicolon
DECL|function|n0
r_static
r_void
id|n0
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
id|capidrv_ncci
op_star
id|ncci
)paren
(brace
id|isdn_ctrl
id|cmd
suffix:semicolon
id|capi_fill_DISCONNECT_REQ
c_func
(paren
op_amp
id|cmsg
comma
id|global.appid
comma
id|card-&gt;msgid
op_increment
comma
id|ncci-&gt;plcip-&gt;plci
comma
l_int|0
comma
multiline_comment|/* BChannelinformation */
l_int|0
comma
multiline_comment|/* Keypadfacility */
l_int|0
comma
multiline_comment|/* Useruserdata */
l_int|0
multiline_comment|/* Facilitydataarray */
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
op_amp
id|cmsg
)paren
suffix:semicolon
id|plci_change_state
c_func
(paren
id|card
comma
id|ncci-&gt;plcip
comma
id|EV_PLCI_DISCONNECT_REQ
)paren
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_BHUP
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.arg
op_assign
id|ncci-&gt;chan
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|free_ncci
c_func
(paren
id|card
comma
id|ncci
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------ */
DECL|struct|nccistatechange
r_struct
id|nccistatechange
(brace
DECL|member|actstate
r_int
id|actstate
suffix:semicolon
DECL|member|nextstate
r_int
id|nextstate
suffix:semicolon
DECL|member|event
r_int
id|event
suffix:semicolon
DECL|member|changefunc
r_void
(paren
op_star
id|changefunc
)paren
(paren
id|capidrv_contr
op_star
id|card
comma
id|capidrv_ncci
op_star
id|ncci
)paren
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|nccitable
r_static
r_struct
id|nccistatechange
id|nccitable
(braket
)braket
op_assign
(brace
multiline_comment|/* N-0 */
(brace
id|ST_NCCI_NONE
comma
id|ST_NCCI_OUTGOING
comma
id|EV_NCCI_CONNECT_B3_REQ
comma
l_int|0
)brace
comma
(brace
id|ST_NCCI_NONE
comma
id|ST_NCCI_INCOMING
comma
id|EV_NCCI_CONNECT_B3_IND
comma
l_int|0
)brace
comma
multiline_comment|/* N-0.1 */
(brace
id|ST_NCCI_OUTGOING
comma
id|ST_NCCI_ALLOCATED
comma
id|EV_NCCI_CONNECT_B3_CONF_OK
comma
l_int|0
)brace
comma
(brace
id|ST_NCCI_OUTGOING
comma
id|ST_NCCI_NONE
comma
id|EV_NCCI_CONNECT_B3_CONF_ERROR
comma
l_int|0
)brace
comma
multiline_comment|/* N-1 */
(brace
id|ST_NCCI_INCOMING
comma
id|ST_NCCI_DISCONNECTING
comma
id|EV_NCCI_CONNECT_B3_REJECT
comma
l_int|0
)brace
comma
(brace
id|ST_NCCI_INCOMING
comma
id|ST_NCCI_ALLOCATED
comma
id|EV_NCCI_CONNECT_B3_RESP
comma
l_int|0
)brace
comma
(brace
id|ST_NCCI_INCOMING
comma
id|ST_NCCI_DISCONNECTED
comma
id|EV_NCCI_DISCONNECT_B3_IND
comma
l_int|0
)brace
comma
(brace
id|ST_NCCI_INCOMING
comma
id|ST_NCCI_DISCONNECTING
comma
id|EV_NCCI_DISCONNECT_B3_REQ
comma
l_int|0
)brace
comma
multiline_comment|/* N-2 */
(brace
id|ST_NCCI_ALLOCATED
comma
id|ST_NCCI_ACTIVE
comma
id|EV_NCCI_CONNECT_B3_ACTIVE_IND
comma
l_int|0
)brace
comma
(brace
id|ST_NCCI_ALLOCATED
comma
id|ST_NCCI_DISCONNECTED
comma
id|EV_NCCI_DISCONNECT_B3_IND
comma
l_int|0
)brace
comma
(brace
id|ST_NCCI_ALLOCATED
comma
id|ST_NCCI_DISCONNECTING
comma
id|EV_NCCI_DISCONNECT_B3_REQ
comma
l_int|0
)brace
comma
multiline_comment|/* N-ACT */
(brace
id|ST_NCCI_ACTIVE
comma
id|ST_NCCI_RESETING
comma
id|EV_NCCI_RESET_B3_REQ
comma
l_int|0
)brace
comma
(brace
id|ST_NCCI_ACTIVE
comma
id|ST_NCCI_DISCONNECTED
comma
id|EV_NCCI_DISCONNECT_B3_IND
comma
l_int|0
)brace
comma
(brace
id|ST_NCCI_ACTIVE
comma
id|ST_NCCI_DISCONNECTING
comma
id|EV_NCCI_DISCONNECT_B3_REQ
comma
l_int|0
)brace
comma
multiline_comment|/* N-3 */
(brace
id|ST_NCCI_RESETING
comma
id|ST_NCCI_ACTIVE
comma
id|EV_NCCI_RESET_B3_IND
comma
l_int|0
)brace
comma
(brace
id|ST_NCCI_RESETING
comma
id|ST_NCCI_DISCONNECTED
comma
id|EV_NCCI_DISCONNECT_B3_IND
comma
l_int|0
)brace
comma
(brace
id|ST_NCCI_RESETING
comma
id|ST_NCCI_DISCONNECTING
comma
id|EV_NCCI_DISCONNECT_B3_REQ
comma
l_int|0
)brace
comma
multiline_comment|/* N-4 */
(brace
id|ST_NCCI_DISCONNECTING
comma
id|ST_NCCI_DISCONNECTED
comma
id|EV_NCCI_DISCONNECT_B3_IND
comma
l_int|0
)brace
comma
(brace
id|ST_NCCI_DISCONNECTING
comma
id|ST_NCCI_PREVIOUS
comma
id|EV_NCCI_DISCONNECT_B3_CONF_ERROR
comma
l_int|0
)brace
comma
multiline_comment|/* N-5 */
(brace
id|ST_NCCI_DISCONNECTED
comma
id|ST_NCCI_NONE
comma
id|EV_NCCI_DISCONNECT_B3_RESP
comma
id|n0
)brace
comma
(brace
)brace
comma
)brace
suffix:semicolon
DECL|function|ncci_change_state
r_static
r_void
id|ncci_change_state
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
id|capidrv_ncci
op_star
id|ncci
comma
r_int
id|event
)paren
(brace
r_struct
id|nccistatechange
op_star
id|p
op_assign
id|nccitable
suffix:semicolon
r_while
c_loop
(paren
id|p-&gt;event
)paren
(brace
r_if
c_cond
(paren
id|ncci-&gt;state
op_eq
id|p-&gt;actstate
op_logical_and
id|p-&gt;event
op_eq
id|event
)paren
(brace
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv: ncci_change_state:0x%x %d -&gt; %d&bslash;n&quot;
comma
id|ncci-&gt;ncci
comma
id|ncci-&gt;state
comma
id|p-&gt;nextstate
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;nextstate
op_eq
id|ST_NCCI_PREVIOUS
)paren
(brace
id|ncci-&gt;state
op_assign
id|ncci-&gt;oldstate
suffix:semicolon
id|ncci-&gt;oldstate
op_assign
id|p-&gt;actstate
suffix:semicolon
)brace
r_else
(brace
id|ncci-&gt;oldstate
op_assign
id|p-&gt;actstate
suffix:semicolon
id|ncci-&gt;state
op_assign
id|p-&gt;nextstate
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p-&gt;changefunc
)paren
id|p
op_member_access_from_pointer
id|changefunc
c_func
(paren
id|card
comma
id|ncci
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|p
op_increment
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: ncci_change_state:0x%x state=%d event=%d ????&bslash;n&quot;
comma
id|ncci-&gt;ncci
comma
id|ncci-&gt;state
comma
id|event
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------- */
DECL|function|new_bchan
r_static
r_inline
r_int
id|new_bchan
c_func
(paren
id|capidrv_contr
op_star
id|card
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|card-&gt;nbchan
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;bchans
(braket
id|i
)braket
dot
id|plcip
op_eq
l_int|0
)paren
(brace
id|card-&gt;bchans
(braket
id|i
)braket
dot
id|disconnecting
op_assign
l_int|0
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------- */
DECL|function|handle_controller
r_static
r_void
id|handle_controller
c_func
(paren
id|_cmsg
op_star
id|cmsg
)paren
(brace
id|capidrv_contr
op_star
id|card
op_assign
id|findcontrbynumber
c_func
(paren
id|cmsg-&gt;adr.adrController
op_amp
l_int|0x7f
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: %s from unknown controller 0x%x&bslash;n&quot;
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;adr.adrController
op_amp
l_int|0x7f
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|CAPICMD
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
)paren
(brace
r_case
id|CAPI_LISTEN_CONF
suffix:colon
multiline_comment|/* Controller */
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv: listenconf Info=0x%4x (%s) cipmask=0x%x&bslash;n&quot;
comma
id|cmsg-&gt;Info
comma
id|capi_info2str
c_func
(paren
id|cmsg-&gt;Info
)paren
comma
id|card-&gt;cipmask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmsg-&gt;Info
)paren
(brace
id|listen_change_state
c_func
(paren
id|card
comma
id|EV_LISTEN_CONF_ERROR
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|card-&gt;cipmask
op_eq
l_int|0
)paren
(brace
id|listen_change_state
c_func
(paren
id|card
comma
id|EV_LISTEN_CONF_EMPTY
)paren
suffix:semicolon
)brace
r_else
(brace
id|listen_change_state
c_func
(paren
id|card
comma
id|EV_LISTEN_CONF_OK
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CAPI_MANUFACTURER_IND
suffix:colon
multiline_comment|/* Controller */
r_goto
id|ignored
suffix:semicolon
r_case
id|CAPI_MANUFACTURER_CONF
suffix:colon
multiline_comment|/* Controller */
r_goto
id|ignored
suffix:semicolon
r_case
id|CAPI_FACILITY_IND
suffix:colon
multiline_comment|/* Controller/plci/ncci */
r_goto
id|ignored
suffix:semicolon
r_case
id|CAPI_FACILITY_CONF
suffix:colon
multiline_comment|/* Controller/plci/ncci */
r_goto
id|ignored
suffix:semicolon
r_case
id|CAPI_INFO_IND
suffix:colon
multiline_comment|/* Controller/plci */
r_goto
id|ignored
suffix:semicolon
r_case
id|CAPI_INFO_CONF
suffix:colon
multiline_comment|/* Controller/plci */
r_goto
id|ignored
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: got %s from controller 0x%x ???&quot;
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;adr.adrController
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
id|ignored
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv: %s from controller 0x%x ignored&bslash;n&quot;
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;adr.adrController
)paren
suffix:semicolon
)brace
DECL|function|handle_incoming_call
r_static
r_void
id|handle_incoming_call
c_func
(paren
id|capidrv_contr
op_star
id|card
comma
id|_cmsg
op_star
id|cmsg
)paren
(brace
id|capidrv_plci
op_star
id|plcip
suffix:semicolon
id|capidrv_bchan
op_star
id|bchan
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
r_int
id|chan
suffix:semicolon
r_if
c_cond
(paren
(paren
id|chan
op_assign
id|new_bchan
c_func
(paren
id|card
)paren
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: incoming call on not existing bchan ?&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|bchan
op_assign
op_amp
id|card-&gt;bchans
(braket
id|chan
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|plcip
op_assign
id|new_plci
c_func
(paren
id|card
comma
id|chan
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: incoming call: no memory, sorry.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|bchan-&gt;incoming
op_assign
l_int|1
suffix:semicolon
id|plcip-&gt;plci
op_assign
id|cmsg-&gt;adr.adrPLCI
suffix:semicolon
id|plci_change_state
c_func
(paren
id|card
comma
id|plcip
comma
id|EV_PLCI_CONNECT_IND
)paren
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_ICALL
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.arg
op_assign
id|chan
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|cmd.parm.setup
comma
l_int|0
comma
r_sizeof
(paren
id|cmd.parm.setup
)paren
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|cmd.parm.setup.phone
comma
id|cmsg-&gt;CallingPartyNumber
op_plus
l_int|3
comma
id|cmsg-&gt;CallingPartyNumber
(braket
l_int|0
)braket
op_minus
l_int|2
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|cmd.parm.setup.eazmsn
comma
id|cmsg-&gt;CalledPartyNumber
op_plus
l_int|2
comma
id|cmsg-&gt;CalledPartyNumber
(braket
l_int|0
)braket
op_minus
l_int|1
)paren
suffix:semicolon
id|cmd.parm.setup.si1
op_assign
id|cip2si1
c_func
(paren
id|cmsg-&gt;CIPValue
)paren
suffix:semicolon
id|cmd.parm.setup.si2
op_assign
id|cip2si2
c_func
(paren
id|cmsg-&gt;CIPValue
)paren
suffix:semicolon
id|cmd.parm.setup.plan
op_assign
id|cmsg-&gt;CallingPartyNumber
(braket
l_int|1
)braket
suffix:semicolon
id|cmd.parm.setup.screen
op_assign
id|cmsg-&gt;CallingPartyNumber
(braket
l_int|2
)braket
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv: incoming call %s,%d,%d,%s&bslash;n&quot;
comma
id|cmd.parm.setup.phone
comma
id|cmd.parm.setup.si1
comma
id|cmd.parm.setup.si2
comma
id|cmd.parm.setup.eazmsn
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* No device matching this call.&n;&t;&t; * and isdn_common.c has send a HANGUP command&n;&t;&t; * which is ignored in state ST_PLCI_INCOMING,&n;&t;&t; * so we send RESP to ignore the call&n;&t;&t; */
id|capi_cmsg_answer
c_func
(paren
id|cmsg
)paren
suffix:semicolon
id|cmsg-&gt;Reject
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* ignore */
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
id|plci_change_state
c_func
(paren
id|card
comma
id|plcip
comma
id|EV_PLCI_CONNECT_REJECT
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv: incoming call %s,%d,%d,%s ignored&bslash;n&quot;
comma
id|cmd.parm.setup.phone
comma
id|cmd.parm.setup.si1
comma
id|cmd.parm.setup.si2
comma
id|cmd.parm.setup.eazmsn
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* At least one device matching this call (RING on ttyI)&n;&t;&t; * HL-driver may send ALERTING on the D-channel in this&n;&t;&t; * case.&n;&t;&t; * really means: RING on ttyI or a net interface&n;&t;&t; * accepted this call already.&n;&t;&t; *&n;&t;&t; * If the call was accepted, state has already changed,&n;&t;&t; * and CONNECT_RESP already sent.&n;&t;&t; */
r_if
c_cond
(paren
id|plcip-&gt;state
op_eq
id|ST_PLCI_INCOMING
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv: incoming call %s,%d,%d,%s tty alerting&bslash;n&quot;
comma
id|cmd.parm.setup.phone
comma
id|cmd.parm.setup.si1
comma
id|cmd.parm.setup.si2
comma
id|cmd.parm.setup.eazmsn
)paren
suffix:semicolon
id|capi_fill_ALERT_REQ
c_func
(paren
id|cmsg
comma
id|global.appid
comma
id|card-&gt;msgid
op_increment
comma
id|plcip-&gt;plci
comma
multiline_comment|/* adr */
l_int|0
comma
multiline_comment|/* BChannelinformation */
l_int|0
comma
multiline_comment|/* Keypadfacility */
l_int|0
comma
multiline_comment|/* Useruserdata */
l_int|0
multiline_comment|/* Facilitydataarray */
)paren
suffix:semicolon
id|plcip-&gt;msgid
op_assign
id|cmsg-&gt;Messagenumber
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv: incoming call %s,%d,%d,%s on netdev&bslash;n&quot;
comma
id|cmd.parm.setup.phone
comma
id|cmd.parm.setup.si1
comma
id|cmd.parm.setup.si2
comma
id|cmd.parm.setup.eazmsn
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* Call will be rejected. */
id|capi_cmsg_answer
c_func
(paren
id|cmsg
)paren
suffix:semicolon
id|cmsg-&gt;Reject
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* reject call, normal call clearing */
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
id|plci_change_state
c_func
(paren
id|card
comma
id|plcip
comma
id|EV_PLCI_CONNECT_REJECT
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* An error happened. (Invalid parameters for example.) */
id|capi_cmsg_answer
c_func
(paren
id|cmsg
)paren
suffix:semicolon
id|cmsg-&gt;Reject
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* reject call,&n;&t;&t;&t;&t;&t;   destination out of order */
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
id|plci_change_state
c_func
(paren
id|card
comma
id|plcip
comma
id|EV_PLCI_CONNECT_REJECT
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|handle_plci
r_static
r_void
id|handle_plci
c_func
(paren
id|_cmsg
op_star
id|cmsg
)paren
(brace
id|capidrv_contr
op_star
id|card
op_assign
id|findcontrbynumber
c_func
(paren
id|cmsg-&gt;adr.adrController
op_amp
l_int|0x7f
)paren
suffix:semicolon
id|capidrv_plci
op_star
id|plcip
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: %s from unknown controller 0x%x&bslash;n&quot;
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;adr.adrController
op_amp
l_int|0x7f
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|CAPICMD
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
)paren
(brace
r_case
id|CAPI_DISCONNECT_IND
suffix:colon
multiline_comment|/* plci */
r_if
c_cond
(paren
id|cmsg-&gt;Reason
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv: %s reason 0x%x (%s) for plci 0x%x&bslash;n&quot;
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;Reason
comma
id|capi_info2str
c_func
(paren
id|cmsg-&gt;Reason
)paren
comma
id|cmsg-&gt;adr.adrPLCI
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|plcip
op_assign
id|find_plci_by_plci
c_func
(paren
id|card
comma
id|cmsg-&gt;adr.adrPLCI
)paren
)paren
)paren
(brace
id|capi_cmsg_answer
c_func
(paren
id|cmsg
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
r_goto
id|notfound
suffix:semicolon
)brace
id|card-&gt;bchans
(braket
id|plcip-&gt;chan
)braket
dot
id|disconnecting
op_assign
l_int|1
suffix:semicolon
id|plci_change_state
c_func
(paren
id|card
comma
id|plcip
comma
id|EV_PLCI_DISCONNECT_IND
)paren
suffix:semicolon
id|capi_cmsg_answer
c_func
(paren
id|cmsg
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
id|plci_change_state
c_func
(paren
id|card
comma
id|plcip
comma
id|EV_PLCI_DISCONNECT_RESP
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CAPI_DISCONNECT_CONF
suffix:colon
multiline_comment|/* plci */
r_if
c_cond
(paren
id|cmsg-&gt;Info
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv: %s info 0x%x (%s) for plci 0x%x&bslash;n&quot;
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;Info
comma
id|capi_info2str
c_func
(paren
id|cmsg-&gt;Info
)paren
comma
id|cmsg-&gt;adr.adrPLCI
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|plcip
op_assign
id|find_plci_by_plci
c_func
(paren
id|card
comma
id|cmsg-&gt;adr.adrPLCI
)paren
)paren
)paren
r_goto
id|notfound
suffix:semicolon
id|card-&gt;bchans
(braket
id|plcip-&gt;chan
)braket
dot
id|disconnecting
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CAPI_ALERT_CONF
suffix:colon
multiline_comment|/* plci */
r_if
c_cond
(paren
id|cmsg-&gt;Info
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv: %s info 0x%x (%s) for plci 0x%x&bslash;n&quot;
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;Info
comma
id|capi_info2str
c_func
(paren
id|cmsg-&gt;Info
)paren
comma
id|cmsg-&gt;adr.adrPLCI
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CAPI_CONNECT_IND
suffix:colon
multiline_comment|/* plci */
id|handle_incoming_call
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CAPI_CONNECT_CONF
suffix:colon
multiline_comment|/* plci */
r_if
c_cond
(paren
id|cmsg-&gt;Info
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv: %s info 0x%x (%s) for plci 0x%x&bslash;n&quot;
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;Info
comma
id|capi_info2str
c_func
(paren
id|cmsg-&gt;Info
)paren
comma
id|cmsg-&gt;adr.adrPLCI
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|plcip
op_assign
id|find_plci_by_msgid
c_func
(paren
id|card
comma
id|cmsg-&gt;Messagenumber
)paren
)paren
)paren
r_goto
id|notfound
suffix:semicolon
id|plcip-&gt;plci
op_assign
id|cmsg-&gt;adr.adrPLCI
suffix:semicolon
r_if
c_cond
(paren
id|cmsg-&gt;Info
)paren
(brace
id|plci_change_state
c_func
(paren
id|card
comma
id|plcip
comma
id|EV_PLCI_CONNECT_CONF_ERROR
)paren
suffix:semicolon
)brace
r_else
(brace
id|plci_change_state
c_func
(paren
id|card
comma
id|plcip
comma
id|EV_PLCI_CONNECT_CONF_OK
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CAPI_CONNECT_ACTIVE_IND
suffix:colon
multiline_comment|/* plci */
r_if
c_cond
(paren
op_logical_neg
(paren
id|plcip
op_assign
id|find_plci_by_plci
c_func
(paren
id|card
comma
id|cmsg-&gt;adr.adrPLCI
)paren
)paren
)paren
r_goto
id|notfound
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;bchans
(braket
id|plcip-&gt;chan
)braket
dot
id|incoming
)paren
(brace
id|capi_cmsg_answer
c_func
(paren
id|cmsg
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
id|plci_change_state
c_func
(paren
id|card
comma
id|plcip
comma
id|EV_PLCI_CONNECT_ACTIVE_IND
)paren
suffix:semicolon
)brace
r_else
(brace
id|capidrv_ncci
op_star
id|nccip
suffix:semicolon
id|capi_cmsg_answer
c_func
(paren
id|cmsg
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
id|nccip
op_assign
id|new_ncci
c_func
(paren
id|card
comma
id|plcip
comma
id|cmsg-&gt;adr.adrPLCI
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nccip
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: no mem for ncci, sorry&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* $$$$ */
)brace
id|capi_fill_CONNECT_B3_REQ
c_func
(paren
id|cmsg
comma
id|global.appid
comma
id|card-&gt;msgid
op_increment
comma
id|plcip-&gt;plci
comma
multiline_comment|/* adr */
l_int|0
multiline_comment|/* NCPI */
)paren
suffix:semicolon
id|nccip-&gt;msgid
op_assign
id|cmsg-&gt;Messagenumber
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_DCONN
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.arg
op_assign
id|plcip-&gt;chan
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|plci_change_state
c_func
(paren
id|card
comma
id|plcip
comma
id|EV_PLCI_CONNECT_ACTIVE_IND
)paren
suffix:semicolon
id|ncci_change_state
c_func
(paren
id|card
comma
id|nccip
comma
id|EV_NCCI_CONNECT_B3_REQ
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CAPI_INFO_IND
suffix:colon
multiline_comment|/* Controller/plci */
r_if
c_cond
(paren
op_logical_neg
(paren
id|plcip
op_assign
id|find_plci_by_plci
c_func
(paren
id|card
comma
id|cmsg-&gt;adr.adrPLCI
)paren
)paren
)paren
r_goto
id|notfound
suffix:semicolon
r_if
c_cond
(paren
id|cmsg-&gt;InfoNumber
op_eq
l_int|0x4000
)paren
(brace
r_if
c_cond
(paren
id|cmsg-&gt;InfoElement
(braket
l_int|0
)braket
op_eq
l_int|4
)paren
(brace
id|cmd.command
op_assign
id|ISDN_STAT_CINF
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.arg
op_assign
id|plcip-&gt;chan
suffix:semicolon
id|sprintf
c_func
(paren
id|cmd.parm.num
comma
l_string|&quot;%lu&quot;
comma
(paren
r_int
r_int
)paren
(paren
(paren
id|__u32
)paren
id|cmsg-&gt;InfoElement
(braket
l_int|1
)braket
op_or
(paren
(paren
id|__u32
)paren
(paren
id|cmsg-&gt;InfoElement
(braket
l_int|2
)braket
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|__u32
)paren
(paren
id|cmsg-&gt;InfoElement
(braket
l_int|3
)braket
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|__u32
)paren
(paren
id|cmsg-&gt;InfoElement
(braket
l_int|4
)braket
)paren
op_lshift
l_int|24
)paren
)paren
)paren
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: %s&bslash;n&quot;
comma
id|capi_cmsg2str
c_func
(paren
id|cmsg
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CAPI_CONNECT_ACTIVE_CONF
suffix:colon
multiline_comment|/* plci */
r_goto
id|ignored
suffix:semicolon
r_case
id|CAPI_SELECT_B_PROTOCOL_CONF
suffix:colon
multiline_comment|/* plci */
r_goto
id|ignored
suffix:semicolon
r_case
id|CAPI_FACILITY_IND
suffix:colon
multiline_comment|/* Controller/plci/ncci */
r_goto
id|ignored
suffix:semicolon
r_case
id|CAPI_FACILITY_CONF
suffix:colon
multiline_comment|/* Controller/plci/ncci */
r_goto
id|ignored
suffix:semicolon
r_case
id|CAPI_INFO_CONF
suffix:colon
multiline_comment|/* Controller/plci */
r_goto
id|ignored
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: got %s for plci 0x%x ???&quot;
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;adr.adrPLCI
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
id|ignored
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv: %s for plci 0x%x ignored&bslash;n&quot;
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;adr.adrPLCI
)paren
suffix:semicolon
r_return
suffix:semicolon
id|notfound
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: %s: plci 0x%x not found&bslash;n&quot;
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;adr.adrPLCI
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|handle_ncci
r_static
r_void
id|handle_ncci
c_func
(paren
id|_cmsg
op_star
id|cmsg
)paren
(brace
id|capidrv_contr
op_star
id|card
op_assign
id|findcontrbynumber
c_func
(paren
id|cmsg-&gt;adr.adrController
op_amp
l_int|0x7f
)paren
suffix:semicolon
id|capidrv_plci
op_star
id|plcip
suffix:semicolon
id|capidrv_ncci
op_star
id|nccip
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: %s from unknown controller 0x%x&bslash;n&quot;
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;adr.adrController
op_amp
l_int|0x7f
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|CAPICMD
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
)paren
(brace
r_case
id|CAPI_CONNECT_B3_ACTIVE_IND
suffix:colon
multiline_comment|/* ncci */
r_if
c_cond
(paren
op_logical_neg
(paren
id|nccip
op_assign
id|find_ncci
c_func
(paren
id|card
comma
id|cmsg-&gt;adr.adrNCCI
)paren
)paren
)paren
r_goto
id|notfound
suffix:semicolon
id|capi_cmsg_answer
c_func
(paren
id|cmsg
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
id|ncci_change_state
c_func
(paren
id|card
comma
id|nccip
comma
id|EV_NCCI_CONNECT_B3_ACTIVE_IND
)paren
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_BCONN
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.arg
op_assign
id|nccip-&gt;chan
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv: chan %d up with ncci 0x%x&bslash;n&quot;
comma
id|nccip-&gt;chan
comma
id|nccip-&gt;ncci
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CAPI_CONNECT_B3_ACTIVE_CONF
suffix:colon
multiline_comment|/* ncci */
r_goto
id|ignored
suffix:semicolon
r_case
id|CAPI_CONNECT_B3_IND
suffix:colon
multiline_comment|/* ncci */
id|plcip
op_assign
id|find_plci_by_ncci
c_func
(paren
id|card
comma
id|cmsg-&gt;adr.adrNCCI
)paren
suffix:semicolon
r_if
c_cond
(paren
id|plcip
)paren
(brace
id|nccip
op_assign
id|new_ncci
c_func
(paren
id|card
comma
id|plcip
comma
id|cmsg-&gt;adr.adrNCCI
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nccip
)paren
(brace
id|ncci_change_state
c_func
(paren
id|card
comma
id|nccip
comma
id|EV_NCCI_CONNECT_B3_IND
)paren
suffix:semicolon
id|capi_fill_CONNECT_B3_RESP
c_func
(paren
id|cmsg
comma
id|global.appid
comma
id|card-&gt;msgid
op_increment
comma
id|nccip-&gt;ncci
comma
multiline_comment|/* adr */
l_int|0
comma
multiline_comment|/* Reject */
l_int|0
multiline_comment|/* NCPI */
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
id|ncci_change_state
c_func
(paren
id|card
comma
id|nccip
comma
id|EV_NCCI_CONNECT_B3_RESP
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: no mem for ncci, sorry&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: %s: plci for ncci 0x%x not found&bslash;n&quot;
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;adr.adrNCCI
)paren
suffix:semicolon
)brace
id|capi_fill_CONNECT_B3_RESP
c_func
(paren
id|cmsg
comma
id|global.appid
comma
id|card-&gt;msgid
op_increment
comma
id|cmsg-&gt;adr.adrNCCI
comma
l_int|2
comma
multiline_comment|/* Reject */
l_int|0
multiline_comment|/* NCPI */
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CAPI_CONNECT_B3_CONF
suffix:colon
multiline_comment|/* ncci */
r_if
c_cond
(paren
op_logical_neg
(paren
id|nccip
op_assign
id|find_ncci_by_msgid
c_func
(paren
id|card
comma
id|cmsg-&gt;adr.adrNCCI
comma
id|cmsg-&gt;Messagenumber
)paren
)paren
)paren
r_goto
id|notfound
suffix:semicolon
id|nccip-&gt;ncci
op_assign
id|cmsg-&gt;adr.adrNCCI
suffix:semicolon
r_if
c_cond
(paren
id|cmsg-&gt;Info
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv: %s info 0x%x (%s) for ncci 0x%x&bslash;n&quot;
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;Info
comma
id|capi_info2str
c_func
(paren
id|cmsg-&gt;Info
)paren
comma
id|cmsg-&gt;adr.adrNCCI
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmsg-&gt;Info
)paren
id|ncci_change_state
c_func
(paren
id|card
comma
id|nccip
comma
id|EV_NCCI_CONNECT_B3_CONF_ERROR
)paren
suffix:semicolon
r_else
id|ncci_change_state
c_func
(paren
id|card
comma
id|nccip
comma
id|EV_NCCI_CONNECT_B3_CONF_OK
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CAPI_CONNECT_B3_T90_ACTIVE_IND
suffix:colon
multiline_comment|/* ncci */
id|capi_cmsg_answer
c_func
(paren
id|cmsg
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CAPI_DATA_B3_IND
suffix:colon
multiline_comment|/* ncci */
multiline_comment|/* handled in handle_data() */
r_goto
id|ignored
suffix:semicolon
r_case
id|CAPI_DATA_B3_CONF
suffix:colon
multiline_comment|/* ncci */
r_if
c_cond
(paren
op_logical_neg
(paren
id|nccip
op_assign
id|find_ncci
c_func
(paren
id|card
comma
id|cmsg-&gt;adr.adrNCCI
)paren
)paren
)paren
r_goto
id|notfound
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_BSENT
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.arg
op_assign
id|nccip-&gt;chan
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CAPI_DISCONNECT_B3_IND
suffix:colon
multiline_comment|/* ncci */
r_if
c_cond
(paren
op_logical_neg
(paren
id|nccip
op_assign
id|find_ncci
c_func
(paren
id|card
comma
id|cmsg-&gt;adr.adrNCCI
)paren
)paren
)paren
r_goto
id|notfound
suffix:semicolon
id|card-&gt;bchans
(braket
id|nccip-&gt;chan
)braket
dot
id|disconnecting
op_assign
l_int|1
suffix:semicolon
id|ncci_change_state
c_func
(paren
id|card
comma
id|nccip
comma
id|EV_NCCI_DISCONNECT_B3_IND
)paren
suffix:semicolon
id|capi_cmsg_answer
c_func
(paren
id|cmsg
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
id|ncci_change_state
c_func
(paren
id|card
comma
id|nccip
comma
id|EV_NCCI_DISCONNECT_B3_RESP
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CAPI_DISCONNECT_B3_CONF
suffix:colon
multiline_comment|/* ncci */
r_if
c_cond
(paren
op_logical_neg
(paren
id|nccip
op_assign
id|find_ncci
c_func
(paren
id|card
comma
id|cmsg-&gt;adr.adrNCCI
)paren
)paren
)paren
r_goto
id|notfound
suffix:semicolon
r_if
c_cond
(paren
id|cmsg-&gt;Info
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv: %s info 0x%x (%s) for ncci 0x%x&bslash;n&quot;
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;Info
comma
id|capi_info2str
c_func
(paren
id|cmsg-&gt;Info
)paren
comma
id|cmsg-&gt;adr.adrNCCI
)paren
suffix:semicolon
id|ncci_change_state
c_func
(paren
id|card
comma
id|nccip
comma
id|EV_NCCI_DISCONNECT_B3_CONF_ERROR
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CAPI_RESET_B3_IND
suffix:colon
multiline_comment|/* ncci */
id|capi_cmsg_answer
c_func
(paren
id|cmsg
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CAPI_RESET_B3_CONF
suffix:colon
multiline_comment|/* ncci */
r_goto
id|ignored
suffix:semicolon
multiline_comment|/* $$$$ */
r_case
id|CAPI_FACILITY_IND
suffix:colon
multiline_comment|/* Controller/plci/ncci */
r_goto
id|ignored
suffix:semicolon
r_case
id|CAPI_FACILITY_CONF
suffix:colon
multiline_comment|/* Controller/plci/ncci */
r_goto
id|ignored
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: got %s for ncci 0x%x ???&quot;
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;adr.adrNCCI
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
id|ignored
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capidrv: %s for ncci 0x%x ignored&bslash;n&quot;
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;adr.adrNCCI
)paren
suffix:semicolon
r_return
suffix:semicolon
id|notfound
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: %s: ncci 0x%x not found&bslash;n&quot;
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;adr.adrNCCI
)paren
suffix:semicolon
)brace
DECL|function|handle_data
r_static
r_void
id|handle_data
c_func
(paren
id|_cmsg
op_star
id|cmsg
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|capidrv_contr
op_star
id|card
op_assign
id|findcontrbynumber
c_func
(paren
id|cmsg-&gt;adr.adrController
op_amp
l_int|0x7f
)paren
suffix:semicolon
id|capidrv_ncci
op_star
id|nccip
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: %s from unknown controller 0x%x&bslash;n&quot;
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;adr.adrController
op_amp
l_int|0x7f
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|nccip
op_assign
id|find_ncci
c_func
(paren
id|card
comma
id|cmsg-&gt;adr.adrNCCI
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: %s: ncci 0x%x not found&bslash;n&quot;
comma
id|capi_cmd2str
c_func
(paren
id|cmsg-&gt;Command
comma
id|cmsg-&gt;Subcommand
)paren
comma
id|cmsg-&gt;adr.adrNCCI
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
(paren
r_void
)paren
id|skb_pull
c_func
(paren
id|skb
comma
id|CAPIMSG_LEN
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
id|card-&gt;interface
dot
id|rcvcallb_skb
c_func
(paren
id|card-&gt;myid
comma
id|nccip-&gt;chan
comma
id|skb
)paren
suffix:semicolon
id|capi_cmsg_answer
c_func
(paren
id|cmsg
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
id|cmsg
)paren
suffix:semicolon
)brace
DECL|variable|s_cmsg
r_static
id|_cmsg
id|s_cmsg
suffix:semicolon
DECL|function|capidrv_signal
r_static
r_void
id|capidrv_signal
c_func
(paren
id|__u16
id|applid
comma
id|__u32
id|dummy
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
op_star
id|capifuncs-&gt;capi_get_message
)paren
(paren
id|global.appid
comma
op_amp
id|skb
)paren
op_eq
id|CAPI_NOERROR
)paren
(brace
id|capi_message2cmsg
c_func
(paren
op_amp
id|s_cmsg
comma
id|skb-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debugmode
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv_signal: %s&bslash;n&quot;
comma
id|capi_cmsg2str
c_func
(paren
op_amp
id|s_cmsg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s_cmsg.Command
op_eq
id|CAPI_DATA_B3
op_logical_and
id|s_cmsg.Subcommand
op_eq
id|CAPI_IND
)paren
(brace
id|handle_data
c_func
(paren
op_amp
id|s_cmsg
comma
id|skb
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|s_cmsg.adr.adrController
op_amp
l_int|0xffffff00
)paren
op_eq
l_int|0
)paren
id|handle_controller
c_func
(paren
op_amp
id|s_cmsg
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|s_cmsg.adr.adrPLCI
op_amp
l_int|0xffff0000
)paren
op_eq
l_int|0
)paren
id|handle_plci
c_func
(paren
op_amp
id|s_cmsg
)paren
suffix:semicolon
r_else
id|handle_ncci
c_func
(paren
op_amp
id|s_cmsg
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* ------------------------------------------------------------------- */
DECL|variable|cmdcmsg
r_static
id|_cmsg
id|cmdcmsg
suffix:semicolon
DECL|function|capidrv_ioctl
r_static
r_int
id|capidrv_ioctl
c_func
(paren
id|isdn_ctrl
op_star
id|c
comma
id|capidrv_contr
op_star
id|card
)paren
(brace
r_switch
c_cond
(paren
id|c-&gt;arg
)paren
(brace
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv: capidrv_ioctl(%ld) called ??&bslash;n&quot;
comma
id|c-&gt;arg
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|capidrv_command
r_static
r_int
id|capidrv_command
c_func
(paren
id|isdn_ctrl
op_star
id|c
comma
id|capidrv_contr
op_star
id|card
)paren
(brace
id|isdn_ctrl
id|cmd
suffix:semicolon
r_struct
id|capidrv_bchan
op_star
id|bchan
suffix:semicolon
r_struct
id|capidrv_plci
op_star
id|plcip
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;command
op_eq
id|ISDN_CMD_IOCTL
)paren
r_return
id|capidrv_ioctl
c_func
(paren
id|c
comma
id|card
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|c-&gt;command
)paren
(brace
r_case
id|ISDN_CMD_DIAL
suffix:colon
(brace
id|__u8
id|calling
(braket
id|ISDN_MSNLEN
op_plus
l_int|3
)braket
suffix:semicolon
id|__u8
id|called
(braket
id|ISDN_MSNLEN
op_plus
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv: ISDN_CMD_DIAL(ch=%ld,&bslash;&quot;%s,%d,%d,%s&bslash;&quot;)&bslash;n&quot;
comma
id|c-&gt;arg
comma
id|c-&gt;parm.setup.phone
comma
id|c-&gt;parm.setup.si1
comma
id|c-&gt;parm.setup.si2
comma
id|c-&gt;parm.setup.eazmsn
)paren
suffix:semicolon
id|bchan
op_assign
op_amp
id|card-&gt;bchans
(braket
id|c-&gt;arg
op_mod
id|card-&gt;nbchan
)braket
suffix:semicolon
r_if
c_cond
(paren
id|bchan-&gt;plcip
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: dail ch=%ld,&bslash;&quot;%s,%d,%d,%s&bslash;&quot; in use (plci=0x%x)&bslash;n&quot;
comma
id|c-&gt;arg
comma
id|c-&gt;parm.setup.phone
comma
id|c-&gt;parm.setup.si1
comma
id|c-&gt;parm.setup.si2
comma
id|c-&gt;parm.setup.eazmsn
comma
id|bchan-&gt;plcip-&gt;plci
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|bchan-&gt;si1
op_assign
id|c-&gt;parm.setup.si1
suffix:semicolon
id|bchan-&gt;si2
op_assign
id|c-&gt;parm.setup.si2
suffix:semicolon
id|strncpy
c_func
(paren
id|bchan-&gt;num
comma
id|c-&gt;parm.setup.phone
comma
r_sizeof
(paren
id|bchan-&gt;num
)paren
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|bchan-&gt;mynum
comma
id|c-&gt;parm.setup.eazmsn
comma
r_sizeof
(paren
id|bchan-&gt;mynum
)paren
)paren
suffix:semicolon
id|calling
(braket
l_int|0
)braket
op_assign
id|strlen
c_func
(paren
id|bchan-&gt;mynum
)paren
op_plus
l_int|2
suffix:semicolon
id|calling
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|calling
(braket
l_int|2
)braket
op_assign
l_int|0x80
suffix:semicolon
id|strncpy
c_func
(paren
id|calling
op_plus
l_int|3
comma
id|bchan-&gt;mynum
comma
id|ISDN_MSNLEN
)paren
suffix:semicolon
id|called
(braket
l_int|0
)braket
op_assign
id|strlen
c_func
(paren
id|bchan-&gt;num
)paren
op_plus
l_int|1
suffix:semicolon
id|called
(braket
l_int|1
)braket
op_assign
l_int|0x80
suffix:semicolon
id|strncpy
c_func
(paren
id|called
op_plus
l_int|2
comma
id|bchan-&gt;num
comma
id|ISDN_MSNLEN
)paren
suffix:semicolon
id|capi_fill_CONNECT_REQ
c_func
(paren
op_amp
id|cmdcmsg
comma
id|global.appid
comma
id|card-&gt;msgid
op_increment
comma
l_int|1
comma
multiline_comment|/* adr */
id|si2cip
c_func
(paren
id|bchan-&gt;si1
comma
id|bchan-&gt;si2
)paren
comma
multiline_comment|/* cipvalue */
id|called
comma
multiline_comment|/* CalledPartyNumber */
id|calling
comma
multiline_comment|/* CallingPartyNumber */
l_int|0
comma
multiline_comment|/* CalledPartySubaddress */
l_int|0
comma
multiline_comment|/* CallingPartySubaddress */
id|b1prot
c_func
(paren
id|bchan-&gt;l2
comma
id|bchan-&gt;l3
)paren
comma
multiline_comment|/* B1protocol */
id|b2prot
c_func
(paren
id|bchan-&gt;l2
comma
id|bchan-&gt;l3
)paren
comma
multiline_comment|/* B2protocol */
id|b3prot
c_func
(paren
id|bchan-&gt;l2
comma
id|bchan-&gt;l3
)paren
comma
multiline_comment|/* B3protocol */
l_int|0
comma
multiline_comment|/* B1configuration */
l_int|0
comma
multiline_comment|/* B2configuration */
l_int|0
comma
multiline_comment|/* B3configuration */
l_int|0
comma
multiline_comment|/* BC */
l_int|0
comma
multiline_comment|/* LLC */
l_int|0
comma
multiline_comment|/* HLC */
l_int|0
comma
multiline_comment|/* BChannelinformation */
l_int|0
comma
multiline_comment|/* Keypadfacility */
l_int|0
comma
multiline_comment|/* Useruserdata */
l_int|0
multiline_comment|/* Facilitydataarray */
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|plcip
op_assign
id|new_plci
c_func
(paren
id|card
comma
(paren
id|c-&gt;arg
op_mod
id|card-&gt;nbchan
)paren
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|cmd.command
op_assign
id|ISDN_STAT_DHUP
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.arg
op_assign
(paren
id|c-&gt;arg
op_mod
id|card-&gt;nbchan
)paren
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|plcip-&gt;msgid
op_assign
id|cmdcmsg.Messagenumber
suffix:semicolon
id|plci_change_state
c_func
(paren
id|card
comma
id|plcip
comma
id|EV_PLCI_CONNECT_REQ
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
op_amp
id|cmdcmsg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|ISDN_CMD_ACCEPTD
suffix:colon
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv: ISDN_CMD_ACCEPTD(ch=%ld)&bslash;n&quot;
comma
id|c-&gt;arg
)paren
suffix:semicolon
id|bchan
op_assign
op_amp
id|card-&gt;bchans
(braket
id|c-&gt;arg
op_mod
id|card-&gt;nbchan
)braket
suffix:semicolon
id|capi_fill_CONNECT_RESP
c_func
(paren
op_amp
id|cmdcmsg
comma
id|global.appid
comma
id|card-&gt;msgid
op_increment
comma
id|bchan-&gt;plcip-&gt;plci
comma
multiline_comment|/* adr */
l_int|0
comma
multiline_comment|/* Reject */
id|b1prot
c_func
(paren
id|bchan-&gt;l2
comma
id|bchan-&gt;l3
)paren
comma
multiline_comment|/* B1protocol */
id|b2prot
c_func
(paren
id|bchan-&gt;l2
comma
id|bchan-&gt;l3
)paren
comma
multiline_comment|/* B2protocol */
id|b3prot
c_func
(paren
id|bchan-&gt;l2
comma
id|bchan-&gt;l3
)paren
comma
multiline_comment|/* B3protocol */
l_int|0
comma
multiline_comment|/* B1configuration */
l_int|0
comma
multiline_comment|/* B2configuration */
l_int|0
comma
multiline_comment|/* B3configuration */
l_int|0
comma
multiline_comment|/* ConnectedNumber */
l_int|0
comma
multiline_comment|/* ConnectedSubaddress */
l_int|0
comma
multiline_comment|/* LLC */
l_int|0
comma
multiline_comment|/* BChannelinformation */
l_int|0
comma
multiline_comment|/* Keypadfacility */
l_int|0
comma
multiline_comment|/* Useruserdata */
l_int|0
multiline_comment|/* Facilitydataarray */
)paren
suffix:semicolon
id|capi_cmsg2message
c_func
(paren
op_amp
id|cmdcmsg
comma
id|cmdcmsg.buf
)paren
suffix:semicolon
id|plci_change_state
c_func
(paren
id|card
comma
id|bchan-&gt;plcip
comma
id|EV_PLCI_CONNECT_RESP
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
op_amp
id|cmdcmsg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ISDN_CMD_ACCEPTB
suffix:colon
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv: ISDN_CMD_ACCEPTB(ch=%ld)&bslash;n&quot;
comma
id|c-&gt;arg
)paren
suffix:semicolon
r_return
op_minus
id|ENOSYS
suffix:semicolon
r_case
id|ISDN_CMD_HANGUP
suffix:colon
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv: ISDN_CMD_HANGUP(ch=%ld)&bslash;n&quot;
comma
id|c-&gt;arg
)paren
suffix:semicolon
id|bchan
op_assign
op_amp
id|card-&gt;bchans
(braket
id|c-&gt;arg
op_mod
id|card-&gt;nbchan
)braket
suffix:semicolon
r_if
c_cond
(paren
id|bchan-&gt;disconnecting
)paren
(brace
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv: chan %ld already disconnecting ...&bslash;n&quot;
comma
id|c-&gt;arg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bchan-&gt;nccip
)paren
(brace
id|bchan-&gt;disconnecting
op_assign
l_int|1
suffix:semicolon
id|capi_fill_DISCONNECT_B3_REQ
c_func
(paren
op_amp
id|cmdcmsg
comma
id|global.appid
comma
id|card-&gt;msgid
op_increment
comma
id|bchan-&gt;nccip-&gt;ncci
comma
l_int|0
multiline_comment|/* NCPI */
)paren
suffix:semicolon
id|ncci_change_state
c_func
(paren
id|card
comma
id|bchan-&gt;nccip
comma
id|EV_NCCI_DISCONNECT_B3_REQ
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
op_amp
id|cmdcmsg
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bchan-&gt;plcip
)paren
(brace
id|bchan-&gt;disconnecting
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|bchan-&gt;plcip-&gt;state
op_eq
id|ST_PLCI_INCOMING
)paren
(brace
multiline_comment|/* just ignore, we a called from isdn_status_callback(),&n;&t;&t;&t;&t; * which will return 0 or 2, this is handled by the&n;&t;&t;&t;&t; * CONNECT_IND handler&n;&t;&t;&t;&t; */
)brace
r_else
(brace
id|capi_fill_DISCONNECT_REQ
c_func
(paren
op_amp
id|cmdcmsg
comma
id|global.appid
comma
id|card-&gt;msgid
op_increment
comma
id|bchan-&gt;plcip-&gt;plci
comma
l_int|0
comma
multiline_comment|/* BChannelinformation */
l_int|0
comma
multiline_comment|/* Keypadfacility */
l_int|0
comma
multiline_comment|/* Useruserdata */
l_int|0
multiline_comment|/* Facilitydataarray */
)paren
suffix:semicolon
id|plci_change_state
c_func
(paren
id|card
comma
id|bchan-&gt;plcip
comma
id|EV_PLCI_DISCONNECT_REQ
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
op_amp
id|cmdcmsg
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* ready */
r_case
id|ISDN_CMD_SETL2
suffix:colon
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv: set L2 on chan %ld to %ld&bslash;n&quot;
comma
(paren
id|c-&gt;arg
op_amp
l_int|0xff
)paren
comma
(paren
id|c-&gt;arg
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
id|bchan
op_assign
op_amp
id|card-&gt;bchans
(braket
id|c-&gt;arg
op_mod
id|card-&gt;nbchan
)braket
suffix:semicolon
id|bchan-&gt;l2
op_assign
(paren
id|c-&gt;arg
op_rshift
l_int|8
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ISDN_CMD_SETL3
suffix:colon
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv: set L3 on chan %ld to %ld&bslash;n&quot;
comma
(paren
id|c-&gt;arg
op_amp
l_int|0xff
)paren
comma
(paren
id|c-&gt;arg
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
id|bchan
op_assign
op_amp
id|card-&gt;bchans
(braket
id|c-&gt;arg
op_mod
id|card-&gt;nbchan
)braket
suffix:semicolon
id|bchan-&gt;l3
op_assign
(paren
id|c-&gt;arg
op_rshift
l_int|8
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ISDN_CMD_SETEAZ
suffix:colon
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv: set EAZ &bslash;&quot;%s&bslash;&quot; on chan %ld&bslash;n&quot;
comma
id|c-&gt;parm.num
comma
id|c-&gt;arg
)paren
suffix:semicolon
id|bchan
op_assign
op_amp
id|card-&gt;bchans
(braket
id|c-&gt;arg
op_mod
id|card-&gt;nbchan
)braket
suffix:semicolon
id|strncpy
c_func
(paren
id|bchan-&gt;msn
comma
id|c-&gt;parm.num
comma
id|ISDN_MSNLEN
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ISDN_CMD_CLREAZ
suffix:colon
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv: clearing EAZ on chan %ld&bslash;n&quot;
comma
id|c-&gt;arg
)paren
suffix:semicolon
id|bchan
op_assign
op_amp
id|card-&gt;bchans
(braket
id|c-&gt;arg
op_mod
id|card-&gt;nbchan
)braket
suffix:semicolon
id|bchan-&gt;msn
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ISDN_CMD_LOCK
suffix:colon
r_if
c_cond
(paren
id|debugmode
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv: ISDN_CMD_LOCK (%ld)&bslash;n&quot;
comma
id|c-&gt;arg
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_CMD_UNLOCK
suffix:colon
r_if
c_cond
(paren
id|debugmode
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv: ISDN_CMD_UNLOCK (%ld)&bslash;n&quot;
comma
id|c-&gt;arg
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* never called */
r_case
id|ISDN_CMD_GETL2
suffix:colon
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv: ISDN_CMD_GETL2&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
r_case
id|ISDN_CMD_GETL3
suffix:colon
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv: ISDN_CMD_GETL3&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
r_case
id|ISDN_CMD_GETEAZ
suffix:colon
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv: ISDN_CMD_GETEAZ&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
r_case
id|ISDN_CMD_SETSIL
suffix:colon
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv: ISDN_CMD_SETSIL&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
r_case
id|ISDN_CMD_GETSIL
suffix:colon
r_if
c_cond
(paren
id|debugmode
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv: ISDN_CMD_GETSIL&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: ISDN_CMD_%d, Huh?&bslash;n&quot;
comma
id|c-&gt;command
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|if_command
r_static
r_int
id|if_command
c_func
(paren
id|isdn_ctrl
op_star
id|c
)paren
(brace
id|capidrv_contr
op_star
id|card
op_assign
id|findcontrbydriverid
c_func
(paren
id|c-&gt;driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card
)paren
r_return
id|capidrv_command
c_func
(paren
id|c
comma
id|card
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: if_command %d called with invalid driverId %d!&bslash;n&quot;
comma
id|c-&gt;command
comma
id|c-&gt;driver
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|variable|sendcmsg
r_static
id|_cmsg
id|sendcmsg
suffix:semicolon
DECL|function|if_sendbuf
r_static
r_int
id|if_sendbuf
c_func
(paren
r_int
id|id
comma
r_int
id|channel
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|capidrv_contr
op_star
id|card
op_assign
id|findcontrbydriverid
c_func
(paren
id|id
)paren
suffix:semicolon
id|capidrv_bchan
op_star
id|bchan
suffix:semicolon
id|capidrv_ncci
op_star
id|nccip
suffix:semicolon
r_int
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
r_int
id|msglen
suffix:semicolon
id|__u16
id|errcode
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: if_sendbuf called with invalid driverId %d!&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|bchan
op_assign
op_amp
id|card-&gt;bchans
(braket
id|channel
op_mod
id|card-&gt;nbchan
)braket
suffix:semicolon
id|nccip
op_assign
id|bchan-&gt;nccip
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nccip
op_logical_or
id|nccip-&gt;state
op_ne
id|ST_NCCI_ACTIVE
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: if_sendbuf: %s:%d: chan not up!&bslash;n&quot;
comma
id|card-&gt;name
comma
id|channel
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|capi_fill_DATA_B3_REQ
c_func
(paren
op_amp
id|sendcmsg
comma
id|global.appid
comma
id|card-&gt;msgid
op_increment
comma
id|nccip-&gt;ncci
comma
multiline_comment|/* adr */
(paren
id|__u32
)paren
id|skb-&gt;data
comma
multiline_comment|/* Data */
id|skb-&gt;len
comma
multiline_comment|/* DataLength */
id|nccip-&gt;datahandle
op_increment
comma
multiline_comment|/* DataHandle */
l_int|0
multiline_comment|/* Flags */
)paren
suffix:semicolon
id|capi_cmsg2message
c_func
(paren
op_amp
id|sendcmsg
comma
id|sendcmsg.buf
)paren
suffix:semicolon
id|msglen
op_assign
id|CAPIMSG_LEN
c_func
(paren
id|sendcmsg.buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb_headroom
c_func
(paren
id|skb
)paren
OL
id|msglen
)paren
(brace
r_struct
id|sk_buff
op_star
id|nskb
op_assign
id|dev_alloc_skb
c_func
(paren
id|msglen
op_plus
id|skb-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nskb
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: if_sendbuf: no memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if 0
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capidrv: only %d bytes headroom&bslash;n&quot;
comma
id|skb_headroom
c_func
(paren
id|skb
)paren
)paren
suffix:semicolon
macro_line|#endif
id|SET_SKB_FREE
c_func
(paren
id|nskb
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|nskb
comma
id|msglen
)paren
comma
id|sendcmsg.buf
comma
id|msglen
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|nskb
comma
id|skb-&gt;len
)paren
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|errcode
op_assign
(paren
op_star
id|capifuncs-&gt;capi_put_message
)paren
(paren
id|global.appid
comma
id|nskb
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|errcode
)paren
(brace
r_case
id|CAPI_NOERROR
suffix:colon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
r_case
id|CAPI_SENDQUEUEFULL
suffix:colon
id|dev_kfree_skb
c_func
(paren
id|nskb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|skb_push
c_func
(paren
id|skb
comma
id|msglen
)paren
comma
id|sendcmsg.buf
comma
id|msglen
)paren
suffix:semicolon
id|errcode
op_assign
(paren
op_star
id|capifuncs-&gt;capi_put_message
)paren
(paren
id|global.appid
comma
id|skb
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|errcode
)paren
(brace
r_case
id|CAPI_NOERROR
suffix:colon
r_return
id|len
suffix:semicolon
r_case
id|CAPI_SENDQUEUEFULL
suffix:colon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
)brace
DECL|function|capidrv_addcontr
r_static
r_int
id|capidrv_addcontr
c_func
(paren
id|__u16
id|contr
comma
r_struct
id|capi_profile
op_star
id|profp
)paren
(brace
id|capidrv_contr
op_star
id|card
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
r_char
id|id
(braket
l_int|20
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
id|sprintf
c_func
(paren
id|id
comma
l_string|&quot;capidrv-%d&quot;
comma
id|contr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|card
op_assign
(paren
id|capidrv_contr
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|capidrv_contr
)paren
comma
id|GFP_ATOMIC
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;capidrv: (%s) Could not allocate contr-struct.&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|card
comma
l_int|0
comma
r_sizeof
(paren
id|capidrv_contr
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|card-&gt;name
comma
id|id
)paren
suffix:semicolon
id|card-&gt;contrnr
op_assign
id|contr
suffix:semicolon
id|card-&gt;nbchan
op_assign
id|profp-&gt;nbchannel
suffix:semicolon
id|card-&gt;bchans
op_assign
(paren
id|capidrv_bchan
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|capidrv_bchan
)paren
op_star
id|card-&gt;nbchan
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;bchans
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;capidrv: (%s) Could not allocate bchan-structs.&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|card-&gt;interface.channels
op_assign
id|profp-&gt;nbchannel
suffix:semicolon
id|card-&gt;interface.maxbufsize
op_assign
l_int|2048
suffix:semicolon
id|card-&gt;interface.command
op_assign
id|if_command
suffix:semicolon
id|card-&gt;interface.writebuf_skb
op_assign
id|if_sendbuf
suffix:semicolon
id|card-&gt;interface.writecmd
op_assign
l_int|0
suffix:semicolon
id|card-&gt;interface.readstat
op_assign
l_int|0
suffix:semicolon
id|card-&gt;interface.features
op_assign
id|ISDN_FEATURE_L2_X75I
op_or
id|ISDN_FEATURE_L2_X75UI
op_or
id|ISDN_FEATURE_L2_X75BUI
op_or
id|ISDN_FEATURE_L2_HDLC
op_or
id|ISDN_FEATURE_L2_TRANS
op_or
id|ISDN_FEATURE_L3_TRANS
op_or
id|ISDN_FEATURE_P_UNKNOWN
suffix:semicolon
id|card-&gt;interface.hl_hdrlen
op_assign
l_int|22
suffix:semicolon
multiline_comment|/* len of DATA_B3_REQ */
id|strncpy
c_func
(paren
id|card-&gt;interface.id
comma
id|id
comma
r_sizeof
(paren
id|card-&gt;interface.id
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|card-&gt;next
op_assign
id|global.contr_list
suffix:semicolon
id|global.contr_list
op_assign
id|card
suffix:semicolon
id|global.ncontr
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|register_isdn
c_func
(paren
op_amp
id|card-&gt;interface
)paren
)paren
(brace
id|global.contr_list
op_assign
id|global.contr_list-&gt;next
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: Unable to register contr %s&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card-&gt;bchans
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|card-&gt;myid
op_assign
id|card-&gt;interface.channels
suffix:semicolon
id|memset
c_func
(paren
id|card-&gt;bchans
comma
l_int|0
comma
r_sizeof
(paren
id|capidrv_bchan
)paren
op_star
id|card-&gt;nbchan
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|card-&gt;nbchan
suffix:semicolon
id|i
op_increment
)paren
(brace
id|card-&gt;bchans
(braket
id|i
)braket
dot
id|contr
op_assign
id|card
suffix:semicolon
)brace
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_RUN
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|card-&gt;cipmask
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* any */
id|card-&gt;cipmask2
op_assign
l_int|0
suffix:semicolon
id|capi_fill_LISTEN_REQ
c_func
(paren
op_amp
id|cmdcmsg
comma
id|global.appid
comma
id|card-&gt;msgid
op_increment
comma
id|contr
comma
multiline_comment|/* controller */
l_int|1
op_lshift
l_int|6
comma
multiline_comment|/* Infomask */
id|card-&gt;cipmask
comma
id|card-&gt;cipmask2
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|send_message
c_func
(paren
id|card
comma
op_amp
id|cmdcmsg
)paren
suffix:semicolon
id|listen_change_state
c_func
(paren
id|card
comma
id|EV_LISTEN_REQ
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: now up (%d B channels)&bslash;n&quot;
comma
id|card-&gt;name
comma
id|card-&gt;nbchan
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|capidrv_delcontr
r_static
r_int
id|capidrv_delcontr
c_func
(paren
id|__u16
id|contr
)paren
(brace
id|capidrv_contr
op_star
op_star
id|pp
comma
op_star
id|card
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|pp
op_assign
op_amp
id|global.contr_list
suffix:semicolon
op_star
id|pp
suffix:semicolon
id|pp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|contrnr
op_eq
id|contr
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
op_star
id|pp
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: delcontr: no contr %u&bslash;n&quot;
comma
id|contr
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|card
op_assign
op_star
id|pp
suffix:semicolon
op_star
id|pp
op_assign
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
id|global.ncontr
op_decrement
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|card-&gt;nbchan
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;bchans
(braket
id|i
)braket
dot
id|nccip
)paren
id|free_ncci
c_func
(paren
id|card
comma
id|card-&gt;bchans
(braket
id|i
)braket
dot
id|nccip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;bchans
(braket
id|i
)braket
dot
id|plcip
)paren
id|free_plci
c_func
(paren
id|card
comma
id|card-&gt;bchans
(braket
id|i
)braket
dot
id|plcip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;plci_list
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capidrv: bug in free_plci()&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|card-&gt;bchans
)paren
suffix:semicolon
id|cmd.command
op_assign
id|ISDN_STAT_UNLOAD
suffix:semicolon
id|cmd.driver
op_assign
id|card-&gt;myid
suffix:semicolon
id|card-&gt;interface
dot
id|statcallb
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: now down.&bslash;n&quot;
comma
id|card-&gt;name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lower_callback
r_static
r_void
id|lower_callback
c_func
(paren
r_int
r_int
id|cmd
comma
id|__u16
id|contr
comma
r_void
op_star
id|data
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|KCI_CONTRUP
suffix:colon
(paren
r_void
)paren
id|capidrv_addcontr
c_func
(paren
id|contr
comma
(paren
id|capi_profile
op_star
)paren
id|data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|KCI_CONTRDOWN
suffix:colon
(paren
r_void
)paren
id|capidrv_delcontr
c_func
(paren
id|contr
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|variable|cuser
r_static
r_struct
id|capi_interface_user
id|cuser
op_assign
(brace
l_string|&quot;capidrv&quot;
comma
id|lower_callback
)brace
suffix:semicolon
macro_line|#ifdef MODULE
DECL|macro|capidrv_init
mdefine_line|#define capidrv_init init_module
macro_line|#endif
DECL|function|capidrv_init
r_int
id|capidrv_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|capi_register_params
id|rparam
suffix:semicolon
id|capi_profile
id|profile
suffix:semicolon
r_char
id|rev
(braket
l_int|10
)braket
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
id|__u32
id|ncontr
comma
id|contr
suffix:semicolon
id|__u16
id|errcode
suffix:semicolon
id|capifuncs
op_assign
id|attach_capi_interface
c_func
(paren
op_amp
id|cuser
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capifuncs
)paren
r_return
op_minus
id|EIO
suffix:semicolon
macro_line|#ifndef HAS_NEW_SYMTAB
multiline_comment|/* No symbols to export, hide all symbols */
id|register_symtab
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|p
op_assign
id|strchr
c_func
(paren
id|revision
comma
l_char|&squot;:&squot;
)paren
)paren
)paren
(brace
id|strcpy
c_func
(paren
id|rev
comma
id|p
op_plus
l_int|1
)paren
suffix:semicolon
id|p
op_assign
id|strchr
c_func
(paren
id|rev
comma
l_char|&squot;$&squot;
)paren
suffix:semicolon
op_star
id|p
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|strcpy
c_func
(paren
id|rev
comma
l_string|&quot; ??? &quot;
)paren
suffix:semicolon
id|rparam.level3cnt
op_assign
l_int|2
suffix:semicolon
id|rparam.datablkcnt
op_assign
l_int|8
suffix:semicolon
id|rparam.datablklen
op_assign
l_int|2048
suffix:semicolon
id|errcode
op_assign
(paren
op_star
id|capifuncs-&gt;capi_register
)paren
(paren
op_amp
id|rparam
comma
op_amp
id|global.appid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errcode
)paren
(brace
id|detach_capi_interface
c_func
(paren
op_amp
id|cuser
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|errcode
op_assign
(paren
op_star
id|capifuncs-&gt;capi_get_profile
)paren
(paren
l_int|0
comma
op_amp
id|profile
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errcode
op_ne
id|CAPI_NOERROR
)paren
(brace
(paren
r_void
)paren
(paren
op_star
id|capifuncs-&gt;capi_release
)paren
(paren
id|global.appid
)paren
suffix:semicolon
id|detach_capi_interface
c_func
(paren
op_amp
id|cuser
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
(paren
r_void
)paren
(paren
op_star
id|capifuncs-&gt;capi_set_signal
)paren
(paren
id|global.appid
comma
id|capidrv_signal
comma
l_int|0
)paren
suffix:semicolon
id|ncontr
op_assign
id|profile.ncontroller
suffix:semicolon
r_for
c_loop
(paren
id|contr
op_assign
l_int|1
suffix:semicolon
id|contr
op_le
id|ncontr
suffix:semicolon
id|contr
op_increment
)paren
(brace
id|errcode
op_assign
(paren
op_star
id|capifuncs-&gt;capi_get_profile
)paren
(paren
id|contr
comma
op_amp
id|profile
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errcode
op_ne
id|CAPI_NOERROR
)paren
r_continue
suffix:semicolon
(paren
r_void
)paren
id|capidrv_addcontr
c_func
(paren
id|contr
comma
op_amp
id|profile
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|capidrv_contr
op_star
id|card
comma
op_star
id|next
suffix:semicolon
r_char
id|rev
(braket
l_int|10
)braket
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
op_assign
id|strchr
c_func
(paren
id|revision
comma
l_char|&squot;:&squot;
)paren
)paren
)paren
(brace
id|strcpy
c_func
(paren
id|rev
comma
id|p
op_plus
l_int|1
)paren
suffix:semicolon
id|p
op_assign
id|strchr
c_func
(paren
id|rev
comma
l_char|&squot;$&squot;
)paren
suffix:semicolon
op_star
id|p
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|strcpy
c_func
(paren
id|rev
comma
l_string|&quot; ??? &quot;
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|card
op_assign
id|global.contr_list
suffix:semicolon
id|card
suffix:semicolon
id|card
op_assign
id|next
)paren
(brace
id|next
op_assign
id|card-&gt;next
suffix:semicolon
id|capidrv_delcontr
c_func
(paren
id|card-&gt;contrnr
)paren
suffix:semicolon
)brace
(paren
r_void
)paren
(paren
op_star
id|capifuncs-&gt;capi_release
)paren
(paren
id|global.appid
)paren
suffix:semicolon
id|detach_capi_interface
c_func
(paren
op_amp
id|cuser
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;capidrv: Rev%s: unloaded&bslash;n&quot;
comma
id|rev
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
