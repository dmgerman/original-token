multiline_comment|/*&n; * $Id: capi.c,v 1.45 2000/12/02 19:47:29 kai Exp $&n; *&n; * CAPI 2.0 Interface for Linux&n; *&n; * Copyright 1996 by Carsten Paeth (calle@calle.in-berlin.de)&n; *&n; * $Log: capi.c,v $&n; * Revision 1.45  2000/12/02 19:47:29  kai&n; * Change the Makefiles to new style.&n; * There may be problems there that I missed, so this shouldn&squot;t go into&n; * an offical kernel any time soon.&n; * However, if I didn&squot;t commit it, we wouldn&squot;t find the bugs...&n; *&n; * Revision 1.44  2000/11/25 17:00:59  kai&n; * compatibility cleanup - final part for the time being&n; *&n; * Revision 1.43  2000/11/23 20:45:14  kai&n; * fixed module_init/exit stuff&n; * Note: compiled-in kernel doesn&squot;t work pre 2.2.18 anymore.&n; *&n; * Revision 1.42  2000/11/19 17:03:55  kai&n; * compatibility cleanup - part 5&n; *&n; * Revision 1.41  2000/11/01 14:05:02  calle&n; * - use module_init/module_exit from linux/init.h.&n; * - all static struct variables are initialized with &quot;membername:&quot; now.&n; * - avm_cs.c, let it work with newer pcmcia-cs.&n; *&n; * Revision 1.40  2000/10/24 15:15:04  calle&n; * Workaround: pppd calls restoretty before reseting the ldisc and&n; *   ldisc &quot;ppp_sync&quot; didn&squot;t support this. So we call n_tty_ioctl&n; *   in the driver ioctl function. (remember: driver ioctl function is&n; *   only called if ldisc ioctl function did not handle the call)&n; *&n; * Revision 1.39  2000/07/24 13:42:50  calle&n; * - lock_kernel/unlock_kernel for _release functions. (from 2.4)&n; *&n; * Revision 1.38  2000/07/24 08:49:09  calle&n; * - Bugfix: capiminor_del_all_ack completely wrong :-(&n; *&n; * Revision 1.37  2000/07/20 10:22:27  calle&n; * - Made procfs function cleaner and removed variable &quot;begin&quot;.&n; *&n; * Revision 1.36  2000/06/29 13:59:35  calle&n; * - call to devfs_register was wrong&n; *&n; * Revision 1.35  2000/06/19 15:11:24  keil&n; * avoid use of freed structs&n; * changes from 2.4.0-ac21&n; *&n; * Revision 1.34  2000/06/18 16:09:54  keil&n; * more changes for 2.4&n; *&n; * Revision 1.33  2000/05/18 16:35:43  calle&n; * Uaaahh. Bad memory leak fixed.&n; *&n; * Revision 1.32  2000/04/21 12:38:42  calle&n; * Bugfix: error in proc_ functions, begin-off =&gt; off-begin&n; *&n; * Revision 1.31  2000/04/03 13:29:24  calle&n; * make Tim Waugh happy (module unload races in 2.3.99-pre3).&n; * no real problem there, but now it is much cleaner ...&n; *&n; * Revision 1.30  2000/03/19 12:31:36  calle&n; * PPP over CAPI raw driver disabled for now, ppp_generic has been changed.&n; *&n; * Revision 1.29  2000/03/13 17:48:13  calle&n; * removed unused variable.&n; *&n; * Revision 1.28  2000/03/08 17:06:33  calle&n; * - changes for devfs and 2.3.49&n; * - capifs now configurable (no need with devfs)&n; * - New Middleware ioctl CAPI_NCCI_GETUNIT&n; * - Middleware again tested with 2.2.14 and 2.3.49 (with and without devfs)&n; *&n; * Revision 1.27  2000/03/06 18:00:23  calle&n; * - Middleware extention now working with 2.3.49 (capifs).&n; * - Fixed typos in debug section of capi.c&n; * - Bugfix: Makefile corrected for b1pcmcia.c&n; *&n; * Revision 1.26  2000/03/03 16:48:38  calle&n; * - Added CAPI2.0 Middleware support (CONFIG_ISDN_CAPI)&n; *   It is now possible to create a connection with a CAPI2.0 applikation&n; *   and than to handle the data connection from /dev/capi/ (capifs) and also&n; *   using async or sync PPP on this connection.&n; *   The two major device number 190 and 191 are not confirmed yet,&n; *   but I want to save the code in cvs, before I go on.&n; *&n; * Revision 1.25  2000/03/03 16:37:11  kai&n; * incorporated some cosmetic changes from the official kernel tree back&n; * into CVS&n; *&n; * Revision 1.24  2000/03/03 15:50:42  calle&n; * - kernel CAPI:&n; *   - Changed parameter &quot;param&quot; in capi_signal from __u32 to void *.&n; *   - rewrote notifier handling in kcapi.c&n; *   - new notifier NCCI_UP and NCCI_DOWN&n; * - User CAPI:&n; *   - /dev/capi20 is now a cloning device.&n; *   - middleware extentions prepared.&n; * - capidrv.c&n; *   - locking of list operations and module count updates.&n; *&n; * Revision 1.23  2000/02/26 01:00:53  keil&n; * changes from 2.3.47&n; *&n; * Revision 1.22  1999/11/13 21:27:16  keil&n; * remove KERNELVERSION&n; *&n; * Revision 1.21  1999/09/10 17:24:18  calle&n; * Changes for proposed standard for CAPI2.0:&n; * - AK148 &quot;Linux Exention&quot;&n; *&n; * Revision 1.20  1999/09/07 09:02:53  calle&n; * SETDATA removed. Now inside the kernel the datapart of DATA_B3_REQ and&n; * DATA_B3_IND is always directly after the CAPI message. The &quot;Data&quot; member&n; * ist never used inside the kernel.&n; *&n; * Revision 1.19  1999/07/09 15:05:42  keil&n; * compat.h is now isdn_compat.h&n; *&n; * Revision 1.18  1999/07/06 07:42:01  calle&n; * - changes in /proc interface&n; * - check and changed calls to [dev_]kfree_skb and [dev_]alloc_skb.&n; *&n; * Revision 1.17  1999/07/01 15:26:30  calle&n; * complete new version (I love it):&n; * + new hardware independed &quot;capi_driver&quot; interface that will make it easy to:&n; *   - support other controllers with CAPI-2.0 (i.e. USB Controller)&n; *   - write a CAPI-2.0 for the passive cards&n; *   - support serial link CAPI-2.0 boxes.&n; * + wrote &quot;capi_driver&quot; for all supported cards.&n; * + &quot;capi_driver&quot; (supported cards) now have to be configured with&n; *   make menuconfig, in the past all supported cards where included&n; *   at once.&n; * + new and better informations in /proc/capi/&n; * + new ioctl to switch trace of capi messages per controller&n; *   using &quot;avmcapictrl trace [contr] on|off|....&quot;&n; * + complete testcircle with all supported cards and also the&n; *   PCMCIA cards (now patch for pcmcia-cs-3.0.13 needed) done.&n; *&n; * Revision 1.16  1999/07/01 08:22:57  keil&n; * compatibility macros now in &lt;linux/isdn_compat.h&gt;&n; *&n; * Revision 1.15  1999/06/21 15:24:11  calle&n; * extend information in /proc.&n; *&n; * Revision 1.14  1999/06/10 16:51:03  calle&n; * Bugfix: open/release of control device was not handled correct.&n; *&n; * Revision 1.13  1998/08/28 04:32:25  calle&n; * Added patch send by Michael.Mueller4@post.rwth-aachen.de, to get AVM B1&n; * driver running with 2.1.118.&n; *&n; * Revision 1.12  1998/05/26 22:39:34  he&n; * sync&squot;ed with 2.1.102 where appropriate (CAPABILITY changes)&n; * concap typo&n; * cleared dev.tbusy in isdn_net BCONN status callback&n; *&n; * Revision 1.11  1998/03/09 17:46:37  he&n; * merged in 2.1.89 changes&n; *&n; * Revision 1.10  1998/02/13 07:09:13  calle&n; * change for 2.1.86 (removing FREE_READ/FREE_WRITE from [dev]_kfree_skb()&n; *&n; * Revision 1.9  1998/01/31 11:14:44  calle&n; * merged changes to 2.0 tree, prepare 2.1.82 to work.&n; *&n; * Revision 1.8  1997/11/04 06:12:08  calle&n; * capi.c: new read/write in file_ops since 2.1.60&n; * capidrv.c: prepared isdnlog interface for d2-trace in newer firmware.&n; * capiutil.c: needs config.h (CONFIG_ISDN_DRV_AVMB1_VERBOSE_REASON)&n; * compat.h: added #define LinuxVersionCode&n; *&n; * Revision 1.7  1997/10/11 10:29:34  calle&n; * llseek() parameters changed in 2.1.56.&n; *&n; * Revision 1.6  1997/10/01 09:21:15  fritz&n; * Removed old compatibility stuff for 2.0.X kernels.&n; * From now on, this code is for 2.1.X ONLY!&n; * Old stuff is still in the separate branch.&n; *&n; * Revision 1.5  1997/08/21 23:11:55  fritz&n; * Added changes for kernels &gt;= 2.1.45&n; *&n; * Revision 1.4  1997/05/27 15:17:50  fritz&n; * Added changes for recent 2.1.x kernels:&n; *   changed return type of isdn_close&n; *   queue_task_* -&gt; queue_task&n; *   clear/set_bit -&gt; test_and_... where apropriate.&n; *   changed type of hard_header_cache parameter.&n; *&n; * Revision 1.3  1997/05/18 09:24:14  calle&n; * added verbose disconnect reason reporting to avmb1.&n; * some fixes in capi20 interface.&n; * changed info messages for B1-PCI&n; *&n; * Revision 1.2  1997/03/05 21:17:59  fritz&n; * Added capi_poll for compiling under 2.1.27&n; *&n; * Revision 1.1  1997/03/04 21:50:29  calle&n; * Frirst version in isdn4linux&n; *&n; * Revision 2.2  1997/02/12 09:31:39  calle&n; * new version&n; *&n; * Revision 1.1  1997/01/31 10:32:20  calle&n; * Initial revision&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#ifdef CONFIG_PPP
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/ppp_defs.h&gt;
macro_line|#include &lt;linux/if_ppp.h&gt;
DECL|macro|CAPI_PPP_ON_RAW_DEVICE
macro_line|#undef CAPI_PPP_ON_RAW_DEVICE
macro_line|#endif /* CONFIG_PPP */
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/capi.h&gt;
macro_line|#include &lt;linux/kernelcapi.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/devfs_fs_kernel.h&gt;
macro_line|#include &quot;capiutil.h&quot;
macro_line|#include &quot;capicmd.h&quot;
macro_line|#if defined(CONFIG_ISDN_CAPI_CAPIFS) || defined(CONFIG_ISDN_CAPI_CAPIFS_MODULE)
macro_line|#include &quot;capifs.h&quot;
macro_line|#endif
macro_line|#include &lt;linux/slab.h&gt;
DECL|variable|revision
r_static
r_char
op_star
id|revision
op_assign
l_string|&quot;$Revision: 1.45 $&quot;
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Carsten Paeth (calle@calle.in-berlin.de)&quot;
)paren
suffix:semicolon
DECL|macro|_DEBUG_REFCOUNT
macro_line|#undef _DEBUG_REFCOUNT&t;&t;/* alloc/free and open/close debug */
DECL|macro|_DEBUG_TTYFUNCS
macro_line|#undef _DEBUG_TTYFUNCS&t;&t;/* call to tty_driver */
DECL|macro|_DEBUG_DATAFLOW
macro_line|#undef _DEBUG_DATAFLOW&t;&t;/* data flow */
multiline_comment|/* -------- driver information -------------------------------------- */
DECL|variable|capi_major
r_int
id|capi_major
op_assign
l_int|68
suffix:semicolon
multiline_comment|/* allocated */
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
DECL|variable|capi_rawmajor
r_int
id|capi_rawmajor
op_assign
l_int|190
suffix:semicolon
DECL|variable|capi_ttymajor
r_int
id|capi_ttymajor
op_assign
l_int|191
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
id|MODULE_PARM
c_func
(paren
id|capi_major
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
id|MODULE_PARM
c_func
(paren
id|capi_rawmajor
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|capi_ttymajor
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
multiline_comment|/* -------- defines ------------------------------------------------- */
DECL|macro|CAPINC_MAX_RECVQUEUE
mdefine_line|#define CAPINC_MAX_RECVQUEUE&t;10
DECL|macro|CAPINC_MAX_SENDQUEUE
mdefine_line|#define CAPINC_MAX_SENDQUEUE&t;10
DECL|macro|CAPI_MAX_BLKSIZE
mdefine_line|#define CAPI_MAX_BLKSIZE&t;2048
multiline_comment|/* -------- data structures ----------------------------------------- */
r_struct
id|capidev
suffix:semicolon
r_struct
id|capincci
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
r_struct
id|capiminor
suffix:semicolon
DECL|struct|capiminor
r_struct
id|capiminor
(brace
DECL|member|next
r_struct
id|capiminor
op_star
id|next
suffix:semicolon
DECL|member|nccip
r_struct
id|capincci
op_star
id|nccip
suffix:semicolon
DECL|member|minor
r_int
r_int
id|minor
suffix:semicolon
DECL|member|applid
id|__u16
id|applid
suffix:semicolon
DECL|member|ncci
id|__u32
id|ncci
suffix:semicolon
DECL|member|datahandle
id|__u16
id|datahandle
suffix:semicolon
DECL|member|msgid
id|__u16
id|msgid
suffix:semicolon
DECL|member|file
r_struct
id|file
op_star
id|file
suffix:semicolon
DECL|member|tty
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
DECL|member|ttyinstop
r_int
id|ttyinstop
suffix:semicolon
DECL|member|ttyoutstop
r_int
id|ttyoutstop
suffix:semicolon
DECL|member|ttyskb
r_struct
id|sk_buff
op_star
id|ttyskb
suffix:semicolon
DECL|member|ttyopencount
id|atomic_t
id|ttyopencount
suffix:semicolon
DECL|member|inqueue
r_struct
id|sk_buff_head
id|inqueue
suffix:semicolon
DECL|member|inbytes
r_int
id|inbytes
suffix:semicolon
DECL|member|outqueue
r_struct
id|sk_buff_head
id|outqueue
suffix:semicolon
DECL|member|outbytes
r_int
id|outbytes
suffix:semicolon
multiline_comment|/* for raw device */
DECL|member|recvqueue
r_struct
id|sk_buff_head
id|recvqueue
suffix:semicolon
DECL|member|recvwait
id|wait_queue_head_t
id|recvwait
suffix:semicolon
DECL|member|sendwait
id|wait_queue_head_t
id|sendwait
suffix:semicolon
multiline_comment|/* transmit path */
DECL|struct|datahandle_queue
r_struct
id|datahandle_queue
(brace
DECL|member|next
r_struct
id|datahandle_queue
op_star
id|next
suffix:semicolon
DECL|member|datahandle
id|__u16
id|datahandle
suffix:semicolon
DECL|member|ackqueue
)brace
op_star
id|ackqueue
suffix:semicolon
DECL|member|nack
r_int
id|nack
suffix:semicolon
)brace
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
DECL|struct|capincci
r_struct
id|capincci
(brace
DECL|member|next
r_struct
id|capincci
op_star
id|next
suffix:semicolon
DECL|member|ncci
id|__u32
id|ncci
suffix:semicolon
DECL|member|cdev
r_struct
id|capidev
op_star
id|cdev
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
DECL|member|minorp
r_struct
id|capiminor
op_star
id|minorp
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
)brace
suffix:semicolon
DECL|struct|capidev
r_struct
id|capidev
(brace
DECL|member|next
r_struct
id|capidev
op_star
id|next
suffix:semicolon
DECL|member|file
r_struct
id|file
op_star
id|file
suffix:semicolon
DECL|member|applid
id|__u16
id|applid
suffix:semicolon
DECL|member|errcode
id|__u16
id|errcode
suffix:semicolon
DECL|member|minor
r_int
r_int
id|minor
suffix:semicolon
DECL|member|userflags
r_int
id|userflags
suffix:semicolon
DECL|member|recvqueue
r_struct
id|sk_buff_head
id|recvqueue
suffix:semicolon
DECL|member|recvwait
id|wait_queue_head_t
id|recvwait
suffix:semicolon
multiline_comment|/* Statistic */
DECL|member|nrecvctlpkt
r_int
r_int
id|nrecvctlpkt
suffix:semicolon
DECL|member|nrecvdatapkt
r_int
r_int
id|nrecvdatapkt
suffix:semicolon
DECL|member|nsentctlpkt
r_int
r_int
id|nsentctlpkt
suffix:semicolon
DECL|member|nsentdatapkt
r_int
r_int
id|nsentdatapkt
suffix:semicolon
DECL|member|nccis
r_struct
id|capincci
op_star
id|nccis
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* -------- global variables ---------------------------------------- */
DECL|variable|capifuncs
r_static
r_struct
id|capi_interface
op_star
id|capifuncs
op_assign
l_int|0
suffix:semicolon
DECL|variable|capidev_openlist
r_static
r_struct
id|capidev
op_star
id|capidev_openlist
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
DECL|variable|minors
r_static
r_struct
id|capiminor
op_star
id|minors
op_assign
l_int|0
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
DECL|variable|capidev_cachep
r_static
id|kmem_cache_t
op_star
id|capidev_cachep
op_assign
l_int|0
suffix:semicolon
DECL|variable|capincci_cachep
r_static
id|kmem_cache_t
op_star
id|capincci_cachep
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
DECL|variable|capiminor_cachep
r_static
id|kmem_cache_t
op_star
id|capiminor_cachep
op_assign
l_int|0
suffix:semicolon
DECL|variable|capidh_cachep
r_static
id|kmem_cache_t
op_star
id|capidh_cachep
op_assign
l_int|0
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
multiline_comment|/* -------- datahandles --------------------------------------------- */
DECL|function|capincci_add_ack
r_int
id|capincci_add_ack
c_func
(paren
r_struct
id|capiminor
op_star
id|mp
comma
id|__u16
id|datahandle
)paren
(brace
r_struct
id|datahandle_queue
op_star
id|n
comma
op_star
op_star
id|pp
suffix:semicolon
id|n
op_assign
(paren
r_struct
id|datahandle_queue
op_star
)paren
id|kmem_cache_alloc
c_func
(paren
id|capidh_cachep
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|n
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capi: alloc datahandle failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|n-&gt;next
op_assign
l_int|0
suffix:semicolon
id|n-&gt;datahandle
op_assign
id|datahandle
suffix:semicolon
r_for
c_loop
(paren
id|pp
op_assign
op_amp
id|mp-&gt;ackqueue
suffix:semicolon
op_star
id|pp
suffix:semicolon
id|pp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
)paren
suffix:semicolon
op_star
id|pp
op_assign
id|n
suffix:semicolon
id|mp-&gt;nack
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|capiminor_del_ack
r_int
id|capiminor_del_ack
c_func
(paren
r_struct
id|capiminor
op_star
id|mp
comma
id|__u16
id|datahandle
)paren
(brace
r_struct
id|datahandle_queue
op_star
op_star
id|pp
comma
op_star
id|p
suffix:semicolon
r_for
c_loop
(paren
id|pp
op_assign
op_amp
id|mp-&gt;ackqueue
suffix:semicolon
op_star
id|pp
suffix:semicolon
id|pp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|datahandle
op_eq
id|datahandle
)paren
(brace
id|p
op_assign
op_star
id|pp
suffix:semicolon
op_star
id|pp
op_assign
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
id|kmem_cache_free
c_func
(paren
id|capidh_cachep
comma
id|p
)paren
suffix:semicolon
id|mp-&gt;nack
op_decrement
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|capiminor_del_all_ack
r_void
id|capiminor_del_all_ack
c_func
(paren
r_struct
id|capiminor
op_star
id|mp
)paren
(brace
r_struct
id|datahandle_queue
op_star
op_star
id|pp
comma
op_star
id|p
suffix:semicolon
id|pp
op_assign
op_amp
id|mp-&gt;ackqueue
suffix:semicolon
r_while
c_loop
(paren
op_star
id|pp
)paren
(brace
id|p
op_assign
op_star
id|pp
suffix:semicolon
op_star
id|pp
op_assign
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
id|kmem_cache_free
c_func
(paren
id|capidh_cachep
comma
id|p
)paren
suffix:semicolon
id|mp-&gt;nack
op_decrement
suffix:semicolon
)brace
)brace
multiline_comment|/* -------- struct capiminor ---------------------------------------- */
DECL|function|capiminor_alloc
r_struct
id|capiminor
op_star
id|capiminor_alloc
c_func
(paren
id|__u16
id|applid
comma
id|__u32
id|ncci
)paren
(brace
r_struct
id|capiminor
op_star
id|mp
comma
op_star
op_star
id|pp
suffix:semicolon
r_int
r_int
id|minor
op_assign
l_int|0
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|mp
op_assign
(paren
r_struct
id|capiminor
op_star
)paren
id|kmem_cache_alloc
c_func
(paren
id|capiminor_cachep
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mp
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capi: can&squot;t alloc capiminor&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef _DEBUG_REFCOUNT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capiminor_alloc %d&bslash;n&quot;
comma
id|GET_USE_COUNT
c_func
(paren
id|THIS_MODULE
)paren
)paren
suffix:semicolon
macro_line|#endif
id|memset
c_func
(paren
id|mp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|capiminor
)paren
)paren
suffix:semicolon
id|mp-&gt;applid
op_assign
id|applid
suffix:semicolon
id|mp-&gt;ncci
op_assign
id|ncci
suffix:semicolon
id|mp-&gt;msgid
op_assign
l_int|0
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|mp-&gt;ttyopencount
comma
l_int|0
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|mp-&gt;inqueue
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|mp-&gt;outqueue
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|mp-&gt;recvqueue
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|mp-&gt;recvwait
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|mp-&gt;sendwait
)paren
suffix:semicolon
r_for
c_loop
(paren
id|pp
op_assign
op_amp
id|minors
suffix:semicolon
op_star
id|pp
suffix:semicolon
id|pp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|minor
OL
id|minor
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|minor
OG
id|minor
)paren
r_break
suffix:semicolon
id|minor
op_increment
suffix:semicolon
)brace
id|mp-&gt;minor
op_assign
id|minor
suffix:semicolon
id|mp-&gt;next
op_assign
op_star
id|pp
suffix:semicolon
op_star
id|pp
op_assign
id|mp
suffix:semicolon
r_return
id|mp
suffix:semicolon
)brace
DECL|function|capiminor_free
r_void
id|capiminor_free
c_func
(paren
r_struct
id|capiminor
op_star
id|mp
)paren
(brace
r_struct
id|capiminor
op_star
op_star
id|pp
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|pp
op_assign
op_amp
id|minors
suffix:semicolon
r_while
c_loop
(paren
op_star
id|pp
)paren
(brace
r_if
c_cond
(paren
op_star
id|pp
op_eq
id|mp
)paren
(brace
op_star
id|pp
op_assign
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;ttyskb
)paren
id|kfree_skb
c_func
(paren
id|mp-&gt;ttyskb
)paren
suffix:semicolon
id|mp-&gt;ttyskb
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|mp-&gt;recvqueue
)paren
)paren
op_ne
l_int|0
)paren
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|mp-&gt;inqueue
)paren
)paren
op_ne
l_int|0
)paren
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|mp-&gt;outqueue
)paren
)paren
op_ne
l_int|0
)paren
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|capiminor_del_all_ack
c_func
(paren
id|mp
)paren
suffix:semicolon
id|kmem_cache_free
c_func
(paren
id|capiminor_cachep
comma
id|mp
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
macro_line|#ifdef _DEBUG_REFCOUNT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capiminor_free %d&bslash;n&quot;
comma
id|GET_USE_COUNT
c_func
(paren
id|THIS_MODULE
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
r_else
(brace
id|pp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
)brace
)brace
)brace
DECL|function|capiminor_find
r_struct
id|capiminor
op_star
id|capiminor_find
c_func
(paren
r_int
r_int
id|minor
)paren
(brace
r_struct
id|capiminor
op_star
id|p
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|minors
suffix:semicolon
id|p
op_logical_and
id|p-&gt;minor
op_ne
id|minor
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
suffix:semicolon
r_return
id|p
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
multiline_comment|/* -------- struct capincci ----------------------------------------- */
DECL|function|capincci_alloc
r_static
r_struct
id|capincci
op_star
id|capincci_alloc
c_func
(paren
r_struct
id|capidev
op_star
id|cdev
comma
id|__u32
id|ncci
)paren
(brace
r_struct
id|capincci
op_star
id|np
comma
op_star
op_star
id|pp
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
r_struct
id|capiminor
op_star
id|mp
op_assign
l_int|0
suffix:semicolon
id|kdev_t
id|kdev
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
id|np
op_assign
(paren
r_struct
id|capincci
op_star
)paren
id|kmem_cache_alloc
c_func
(paren
id|capincci_cachep
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|np
)paren
r_return
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|np
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|capincci
)paren
)paren
suffix:semicolon
id|np-&gt;ncci
op_assign
id|ncci
suffix:semicolon
id|np-&gt;cdev
op_assign
id|cdev
suffix:semicolon
r_for
c_loop
(paren
id|pp
op_assign
op_amp
id|cdev-&gt;nccis
suffix:semicolon
op_star
id|pp
suffix:semicolon
id|pp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
)paren
suffix:semicolon
op_star
id|pp
op_assign
id|np
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
id|mp
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cdev-&gt;userflags
op_amp
id|CAPIFLAG_HIGHJACKING
)paren
id|mp
op_assign
id|np-&gt;minorp
op_assign
id|capiminor_alloc
c_func
(paren
id|cdev-&gt;applid
comma
id|ncci
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mp
)paren
(brace
id|mp-&gt;nccip
op_assign
id|np
suffix:semicolon
macro_line|#ifdef _DEBUG_REFCOUNT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;set mp-&gt;nccip&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if defined(CONFIG_ISDN_CAPI_CAPIFS) || defined(CONFIG_ISDN_CAPI_CAPIFS_MODULE)
id|kdev
op_assign
id|MKDEV
c_func
(paren
id|capi_rawmajor
comma
id|mp-&gt;minor
)paren
suffix:semicolon
id|capifs_new_ncci
c_func
(paren
l_char|&squot;r&squot;
comma
id|mp-&gt;minor
comma
id|kdev
)paren
suffix:semicolon
id|kdev
op_assign
id|MKDEV
c_func
(paren
id|capi_ttymajor
comma
id|mp-&gt;minor
)paren
suffix:semicolon
id|capifs_new_ncci
c_func
(paren
l_int|0
comma
id|mp-&gt;minor
comma
id|kdev
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
r_return
id|np
suffix:semicolon
)brace
DECL|function|capincci_free
r_static
r_void
id|capincci_free
c_func
(paren
r_struct
id|capidev
op_star
id|cdev
comma
id|__u32
id|ncci
)paren
(brace
r_struct
id|capincci
op_star
id|np
comma
op_star
op_star
id|pp
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
r_struct
id|capiminor
op_star
id|mp
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
id|pp
op_assign
op_amp
id|cdev-&gt;nccis
suffix:semicolon
r_while
c_loop
(paren
op_star
id|pp
)paren
(brace
id|np
op_assign
op_star
id|pp
suffix:semicolon
r_if
c_cond
(paren
id|ncci
op_eq
l_int|0xffffffff
op_logical_or
id|np-&gt;ncci
op_eq
id|ncci
)paren
(brace
op_star
id|pp
op_assign
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
r_if
c_cond
(paren
(paren
id|mp
op_assign
id|np-&gt;minorp
)paren
op_ne
l_int|0
)paren
(brace
macro_line|#if defined(CONFIG_ISDN_CAPI_CAPIFS) || defined(CONFIG_ISDN_CAPI_CAPIFS_MODULE)
id|capifs_free_ncci
c_func
(paren
l_char|&squot;r&squot;
comma
id|mp-&gt;minor
)paren
suffix:semicolon
id|capifs_free_ncci
c_func
(paren
l_int|0
comma
id|mp-&gt;minor
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|mp-&gt;tty
)paren
(brace
id|mp-&gt;nccip
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef _DEBUG_REFCOUNT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;reset mp-&gt;nccip&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tty_hangup
c_func
(paren
id|mp-&gt;tty
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mp-&gt;file
)paren
(brace
id|mp-&gt;nccip
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef _DEBUG_REFCOUNT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;reset mp-&gt;nccip&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|wake_up_interruptible
c_func
(paren
op_amp
id|mp-&gt;recvwait
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|mp-&gt;sendwait
)paren
suffix:semicolon
)brace
r_else
(brace
id|capiminor_free
c_func
(paren
id|mp
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
id|kmem_cache_free
c_func
(paren
id|capincci_cachep
comma
id|np
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|pp
op_eq
l_int|0
)paren
r_return
suffix:semicolon
)brace
r_else
(brace
id|pp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
)brace
)brace
)brace
DECL|function|capincci_find
r_struct
id|capincci
op_star
id|capincci_find
c_func
(paren
r_struct
id|capidev
op_star
id|cdev
comma
id|__u32
id|ncci
)paren
(brace
r_struct
id|capincci
op_star
id|p
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|cdev-&gt;nccis
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;ncci
op_eq
id|ncci
)paren
r_break
suffix:semicolon
)brace
r_return
id|p
suffix:semicolon
)brace
multiline_comment|/* -------- struct capidev ------------------------------------------ */
DECL|function|capidev_alloc
r_static
r_struct
id|capidev
op_star
id|capidev_alloc
c_func
(paren
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|capidev
op_star
id|cdev
suffix:semicolon
r_struct
id|capidev
op_star
op_star
id|pp
suffix:semicolon
id|cdev
op_assign
(paren
r_struct
id|capidev
op_star
)paren
id|kmem_cache_alloc
c_func
(paren
id|capidev_cachep
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cdev
)paren
r_return
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|cdev
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|capidev
)paren
)paren
suffix:semicolon
id|cdev-&gt;file
op_assign
id|file
suffix:semicolon
id|cdev-&gt;minor
op_assign
id|MINOR
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_rdev
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|cdev-&gt;recvqueue
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|cdev-&gt;recvwait
)paren
suffix:semicolon
id|pp
op_assign
op_amp
id|capidev_openlist
suffix:semicolon
r_while
c_loop
(paren
op_star
id|pp
)paren
id|pp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
op_star
id|pp
op_assign
id|cdev
suffix:semicolon
r_return
id|cdev
suffix:semicolon
)brace
DECL|function|capidev_free
r_static
r_void
id|capidev_free
c_func
(paren
r_struct
id|capidev
op_star
id|cdev
)paren
(brace
r_struct
id|capidev
op_star
op_star
id|pp
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|cdev-&gt;applid
)paren
(paren
op_star
id|capifuncs-&gt;capi_release
)paren
(paren
id|cdev-&gt;applid
)paren
suffix:semicolon
id|cdev-&gt;applid
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|cdev-&gt;recvqueue
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
id|pp
op_assign
op_amp
id|capidev_openlist
suffix:semicolon
r_while
c_loop
(paren
op_star
id|pp
op_logical_and
op_star
id|pp
op_ne
id|cdev
)paren
id|pp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
r_if
c_cond
(paren
op_star
id|pp
)paren
op_star
id|pp
op_assign
id|cdev-&gt;next
suffix:semicolon
id|kmem_cache_free
c_func
(paren
id|capidev_cachep
comma
id|cdev
)paren
suffix:semicolon
)brace
DECL|function|capidev_find
r_static
r_struct
id|capidev
op_star
id|capidev_find
c_func
(paren
id|__u16
id|applid
)paren
(brace
r_struct
id|capidev
op_star
id|p
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|capidev_openlist
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;applid
op_eq
id|applid
)paren
r_break
suffix:semicolon
)brace
r_return
id|p
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
multiline_comment|/* -------- handle data queue --------------------------------------- */
r_struct
id|sk_buff
op_star
DECL|function|gen_data_b3_resp_for
id|gen_data_b3_resp_for
c_func
(paren
r_struct
id|capiminor
op_star
id|mp
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|sk_buff
op_star
id|nskb
suffix:semicolon
id|nskb
op_assign
id|alloc_skb
c_func
(paren
id|CAPI_DATA_B3_RESP_LEN
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nskb
)paren
(brace
id|__u16
id|datahandle
op_assign
id|CAPIMSG_U16
c_func
(paren
id|skb-&gt;data
comma
id|CAPIMSG_BASELEN
op_plus
l_int|4
op_plus
l_int|4
op_plus
l_int|2
)paren
suffix:semicolon
r_int
r_char
op_star
id|s
op_assign
id|skb_put
c_func
(paren
id|nskb
comma
id|CAPI_DATA_B3_RESP_LEN
)paren
suffix:semicolon
id|capimsg_setu16
c_func
(paren
id|s
comma
l_int|0
comma
id|CAPI_DATA_B3_RESP_LEN
)paren
suffix:semicolon
id|capimsg_setu16
c_func
(paren
id|s
comma
l_int|2
comma
id|mp-&gt;applid
)paren
suffix:semicolon
id|capimsg_setu8
(paren
id|s
comma
l_int|4
comma
id|CAPI_DATA_B3
)paren
suffix:semicolon
id|capimsg_setu8
(paren
id|s
comma
l_int|5
comma
id|CAPI_RESP
)paren
suffix:semicolon
id|capimsg_setu16
c_func
(paren
id|s
comma
l_int|6
comma
id|mp-&gt;msgid
op_increment
)paren
suffix:semicolon
id|capimsg_setu32
c_func
(paren
id|s
comma
l_int|8
comma
id|mp-&gt;ncci
)paren
suffix:semicolon
id|capimsg_setu16
c_func
(paren
id|s
comma
l_int|12
comma
id|datahandle
)paren
suffix:semicolon
)brace
r_return
id|nskb
suffix:semicolon
)brace
DECL|function|handle_recv_skb
r_int
id|handle_recv_skb
c_func
(paren
r_struct
id|capiminor
op_star
id|mp
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|sk_buff
op_star
id|nskb
suffix:semicolon
r_int
r_int
id|datalen
suffix:semicolon
id|__u16
id|errcode
comma
id|datahandle
suffix:semicolon
id|datalen
op_assign
id|skb-&gt;len
op_minus
id|CAPIMSG_LEN
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;tty
)paren
(brace
r_if
c_cond
(paren
id|mp-&gt;tty-&gt;ldisc.receive_buf
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capi: ldisc has no receive_buf function&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mp-&gt;ttyinstop
)paren
(brace
macro_line|#if defined(_DEBUG_DATAFLOW) || defined(_DEBUG_TTYFUNCS)
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capi: recv tty throttled&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mp-&gt;tty-&gt;ldisc.receive_room
op_logical_and
id|mp-&gt;tty-&gt;ldisc
dot
id|receive_room
c_func
(paren
id|mp-&gt;tty
)paren
OL
id|datalen
)paren
(brace
macro_line|#if defined(_DEBUG_DATAFLOW) || defined(_DEBUG_TTYFUNCS)
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capi: no room in tty&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|nskb
op_assign
id|gen_data_b3_resp_for
c_func
(paren
id|mp
comma
id|skb
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capi: gen_data_b3_resp failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|datahandle
op_assign
id|CAPIMSG_U16
c_func
(paren
id|skb-&gt;data
comma
id|CAPIMSG_BASELEN
op_plus
l_int|4
)paren
suffix:semicolon
id|errcode
op_assign
(paren
op_star
id|capifuncs-&gt;capi_put_message
)paren
(paren
id|mp-&gt;applid
comma
id|nskb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errcode
op_ne
id|CAPI_NOERROR
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capi: send DATA_B3_RESP failed=%x&bslash;n&quot;
comma
id|errcode
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|nskb
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
(paren
r_void
)paren
id|skb_pull
c_func
(paren
id|skb
comma
id|CAPIMSG_LEN
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
macro_line|#ifdef _DEBUG_DATAFLOW
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capi: DATA_B3_RESP %u len=%d =&gt; ldisc&bslash;n&quot;
comma
id|datahandle
comma
id|skb-&gt;len
)paren
suffix:semicolon
macro_line|#endif
id|mp-&gt;tty-&gt;ldisc
dot
id|receive_buf
c_func
(paren
id|mp-&gt;tty
comma
id|skb-&gt;data
comma
l_int|0
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mp-&gt;file
)paren
(brace
r_if
c_cond
(paren
id|skb_queue_len
c_func
(paren
op_amp
id|mp-&gt;recvqueue
)paren
OG
id|CAPINC_MAX_RECVQUEUE
)paren
(brace
macro_line|#if defined(_DEBUG_DATAFLOW) || defined(_DEBUG_TTYFUNCS)
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capi: no room in raw queue&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|nskb
op_assign
id|gen_data_b3_resp_for
c_func
(paren
id|mp
comma
id|skb
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capi: gen_data_b3_resp failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|datahandle
op_assign
id|CAPIMSG_U16
c_func
(paren
id|skb-&gt;data
comma
id|CAPIMSG_BASELEN
op_plus
l_int|4
)paren
suffix:semicolon
id|errcode
op_assign
(paren
op_star
id|capifuncs-&gt;capi_put_message
)paren
(paren
id|mp-&gt;applid
comma
id|nskb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errcode
op_ne
id|CAPI_NOERROR
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capi: send DATA_B3_RESP failed=%x&bslash;n&quot;
comma
id|errcode
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|nskb
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
(paren
r_void
)paren
id|skb_pull
c_func
(paren
id|skb
comma
id|CAPIMSG_LEN
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
macro_line|#ifdef _DEBUG_DATAFLOW
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capi: DATA_B3_RESP %u len=%d =&gt; raw&bslash;n&quot;
comma
id|datahandle
comma
id|skb-&gt;len
)paren
suffix:semicolon
macro_line|#endif
id|skb_queue_tail
c_func
(paren
op_amp
id|mp-&gt;recvqueue
comma
id|skb
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|mp-&gt;recvwait
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef _DEBUG_DATAFLOW
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capi: currently no receiver&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|handle_minor_recv
r_void
id|handle_minor_recv
c_func
(paren
r_struct
id|capiminor
op_star
id|mp
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|mp-&gt;inqueue
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_int
r_int
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
id|mp-&gt;inbytes
op_sub_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|handle_recv_skb
c_func
(paren
id|mp
comma
id|skb
)paren
OL
l_int|0
)paren
(brace
id|skb_queue_head
c_func
(paren
op_amp
id|mp-&gt;inqueue
comma
id|skb
)paren
suffix:semicolon
id|mp-&gt;inbytes
op_add_assign
id|len
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
)brace
DECL|function|handle_minor_send
r_int
id|handle_minor_send
c_func
(paren
r_struct
id|capiminor
op_star
id|mp
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|__u16
id|len
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
id|__u16
id|errcode
suffix:semicolon
id|__u16
id|datahandle
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;tty
op_logical_and
id|mp-&gt;ttyoutstop
)paren
(brace
macro_line|#if defined(_DEBUG_DATAFLOW) || defined(_DEBUG_TTYFUNCS)
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capi: send: tty stopped&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|mp-&gt;outqueue
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|datahandle
op_assign
id|mp-&gt;datahandle
suffix:semicolon
id|len
op_assign
(paren
id|__u16
)paren
id|skb-&gt;len
suffix:semicolon
id|skb_push
c_func
(paren
id|skb
comma
id|CAPI_DATA_B3_REQ_LEN
)paren
suffix:semicolon
id|memset
c_func
(paren
id|skb-&gt;data
comma
l_int|0
comma
id|CAPI_DATA_B3_REQ_LEN
)paren
suffix:semicolon
id|capimsg_setu16
c_func
(paren
id|skb-&gt;data
comma
l_int|0
comma
id|CAPI_DATA_B3_REQ_LEN
)paren
suffix:semicolon
id|capimsg_setu16
c_func
(paren
id|skb-&gt;data
comma
l_int|2
comma
id|mp-&gt;applid
)paren
suffix:semicolon
id|capimsg_setu8
(paren
id|skb-&gt;data
comma
l_int|4
comma
id|CAPI_DATA_B3
)paren
suffix:semicolon
id|capimsg_setu8
(paren
id|skb-&gt;data
comma
l_int|5
comma
id|CAPI_REQ
)paren
suffix:semicolon
id|capimsg_setu16
c_func
(paren
id|skb-&gt;data
comma
l_int|6
comma
id|mp-&gt;msgid
op_increment
)paren
suffix:semicolon
id|capimsg_setu32
c_func
(paren
id|skb-&gt;data
comma
l_int|8
comma
id|mp-&gt;ncci
)paren
suffix:semicolon
multiline_comment|/* NCCI */
id|capimsg_setu32
c_func
(paren
id|skb-&gt;data
comma
l_int|12
comma
(paren
id|__u32
)paren
id|skb-&gt;data
)paren
suffix:semicolon
multiline_comment|/* Data32 */
id|capimsg_setu16
c_func
(paren
id|skb-&gt;data
comma
l_int|16
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* Data length */
id|capimsg_setu16
c_func
(paren
id|skb-&gt;data
comma
l_int|18
comma
id|datahandle
)paren
suffix:semicolon
id|capimsg_setu16
c_func
(paren
id|skb-&gt;data
comma
l_int|20
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Flags */
r_if
c_cond
(paren
id|capincci_add_ack
c_func
(paren
id|mp
comma
id|datahandle
)paren
OL
l_int|0
)paren
(brace
id|skb_pull
c_func
(paren
id|skb
comma
id|CAPI_DATA_B3_REQ_LEN
)paren
suffix:semicolon
id|skb_queue_head
c_func
(paren
op_amp
id|mp-&gt;outqueue
comma
id|skb
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
id|errcode
op_assign
(paren
op_star
id|capifuncs-&gt;capi_put_message
)paren
(paren
id|mp-&gt;applid
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errcode
op_eq
id|CAPI_NOERROR
)paren
(brace
id|mp-&gt;datahandle
op_increment
suffix:semicolon
id|count
op_increment
suffix:semicolon
id|mp-&gt;outbytes
op_sub_assign
id|len
suffix:semicolon
macro_line|#ifdef _DEBUG_DATAFLOW
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capi: DATA_B3_REQ %u len=%u&bslash;n&quot;
comma
id|datahandle
comma
id|len
)paren
suffix:semicolon
macro_line|#endif
r_continue
suffix:semicolon
)brace
id|capiminor_del_ack
c_func
(paren
id|mp
comma
id|datahandle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errcode
op_eq
id|CAPI_SENDQUEUEFULL
)paren
(brace
id|skb_pull
c_func
(paren
id|skb
comma
id|CAPI_DATA_B3_REQ_LEN
)paren
suffix:semicolon
id|skb_queue_head
c_func
(paren
op_amp
id|mp-&gt;outqueue
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* ups, drop packet */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capi: put_message = %x&bslash;n&quot;
comma
id|errcode
)paren
suffix:semicolon
id|mp-&gt;outbytes
op_sub_assign
id|len
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|mp-&gt;sendwait
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
multiline_comment|/* -------- function called by lower level -------------------------- */
DECL|function|capi_signal
r_static
r_void
id|capi_signal
c_func
(paren
id|__u16
id|applid
comma
r_void
op_star
id|param
)paren
(brace
r_struct
id|capidev
op_star
id|cdev
op_assign
(paren
r_struct
id|capidev
op_star
)paren
id|param
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
r_struct
id|capiminor
op_star
id|mp
suffix:semicolon
id|__u16
id|datahandle
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
r_struct
id|capincci
op_star
id|np
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
l_int|0
suffix:semicolon
id|__u32
id|ncci
suffix:semicolon
(paren
r_void
)paren
(paren
op_star
id|capifuncs-&gt;capi_get_message
)paren
(paren
id|applid
comma
op_amp
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;BUG: capi_signal: no skb&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CAPIMSG_COMMAND
c_func
(paren
id|skb-&gt;data
)paren
op_ne
id|CAPI_DATA_B3
)paren
(brace
id|skb_queue_tail
c_func
(paren
op_amp
id|cdev-&gt;recvqueue
comma
id|skb
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|cdev-&gt;recvwait
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ncci
op_assign
id|CAPIMSG_CONTROL
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
r_for
c_loop
(paren
id|np
op_assign
id|cdev-&gt;nccis
suffix:semicolon
id|np
op_logical_and
id|np-&gt;ncci
op_ne
id|ncci
suffix:semicolon
id|np
op_assign
id|np-&gt;next
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|np
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;BUG: capi_signal: ncci not found&bslash;n&quot;
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|cdev-&gt;recvqueue
comma
id|skb
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|cdev-&gt;recvwait
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#ifndef CONFIG_ISDN_CAPI_MIDDLEWARE
id|skb_queue_tail
c_func
(paren
op_amp
id|cdev-&gt;recvqueue
comma
id|skb
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|cdev-&gt;recvwait
)paren
suffix:semicolon
macro_line|#else /* CONFIG_ISDN_CAPI_MIDDLEWARE */
id|mp
op_assign
id|np-&gt;minorp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mp
)paren
(brace
id|skb_queue_tail
c_func
(paren
op_amp
id|cdev-&gt;recvqueue
comma
id|skb
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|cdev-&gt;recvwait
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CAPIMSG_SUBCOMMAND
c_func
(paren
id|skb-&gt;data
)paren
op_eq
id|CAPI_IND
)paren
(brace
id|datahandle
op_assign
id|CAPIMSG_U16
c_func
(paren
id|skb-&gt;data
comma
id|CAPIMSG_BASELEN
op_plus
l_int|4
op_plus
l_int|4
op_plus
l_int|2
)paren
suffix:semicolon
macro_line|#ifdef _DEBUG_DATAFLOW
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capi_signal: DATA_B3_IND %u len=%d&bslash;n&quot;
comma
id|datahandle
comma
id|skb-&gt;len
op_minus
id|CAPIMSG_LEN
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
macro_line|#endif
id|skb_queue_tail
c_func
(paren
op_amp
id|mp-&gt;inqueue
comma
id|skb
)paren
suffix:semicolon
id|mp-&gt;inbytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|handle_minor_recv
c_func
(paren
id|mp
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|CAPIMSG_SUBCOMMAND
c_func
(paren
id|skb-&gt;data
)paren
op_eq
id|CAPI_CONF
)paren
(brace
id|datahandle
op_assign
id|CAPIMSG_U16
c_func
(paren
id|skb-&gt;data
comma
id|CAPIMSG_BASELEN
op_plus
l_int|4
)paren
suffix:semicolon
macro_line|#ifdef _DEBUG_DATAFLOW
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capi_signal: DATA_B3_CONF %u 0x%x&bslash;n&quot;
comma
id|datahandle
comma
id|CAPIMSG_U16
c_func
(paren
id|skb-&gt;data
comma
id|CAPIMSG_BASELEN
op_plus
l_int|4
op_plus
l_int|2
)paren
)paren
suffix:semicolon
macro_line|#endif
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
(paren
r_void
)paren
id|capiminor_del_ack
c_func
(paren
id|mp
comma
id|datahandle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;tty
)paren
(brace
r_if
c_cond
(paren
id|mp-&gt;tty-&gt;ldisc.write_wakeup
)paren
id|mp-&gt;tty-&gt;ldisc
dot
id|write_wakeup
c_func
(paren
id|mp-&gt;tty
)paren
suffix:semicolon
)brace
r_else
(brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|mp-&gt;sendwait
)paren
suffix:semicolon
)brace
(paren
r_void
)paren
id|handle_minor_send
c_func
(paren
id|mp
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* ups, let capi application handle it :-) */
id|skb_queue_tail
c_func
(paren
op_amp
id|cdev-&gt;recvqueue
comma
id|skb
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|cdev-&gt;recvwait
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
)brace
multiline_comment|/* -------- file_operations for capidev ----------------------------- */
r_static
id|loff_t
DECL|function|capi_llseek
id|capi_llseek
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|loff_t
id|offset
comma
r_int
id|origin
)paren
(brace
r_return
op_minus
id|ESPIPE
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|capi_read
id|capi_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|capidev
op_star
id|cdev
op_assign
(paren
r_struct
id|capidev
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_int
id|copied
suffix:semicolon
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|file-&gt;f_pos
)paren
r_return
op_minus
id|ESPIPE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cdev-&gt;applid
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|cdev-&gt;recvqueue
)paren
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|cdev-&gt;recvwait
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|cdev-&gt;recvqueue
)paren
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb
op_eq
l_int|0
)paren
r_return
op_minus
id|ERESTARTNOHAND
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;len
OG
id|count
)paren
(brace
id|skb_queue_head
c_func
(paren
op_amp
id|cdev-&gt;recvqueue
comma
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|EMSGSIZE
suffix:semicolon
)brace
id|retval
op_assign
id|copy_to_user
c_func
(paren
id|buf
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|skb_queue_head
c_func
(paren
op_amp
id|cdev-&gt;recvqueue
comma
id|skb
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
id|copied
op_assign
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|CAPIMSG_CMD
c_func
(paren
id|skb-&gt;data
)paren
op_eq
id|CAPI_DATA_B3_IND
)paren
(brace
id|cdev-&gt;nrecvdatapkt
op_increment
suffix:semicolon
)brace
r_else
(brace
id|cdev-&gt;nrecvctlpkt
op_increment
suffix:semicolon
)brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
id|copied
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|capi_write
id|capi_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|capidev
op_star
id|cdev
op_assign
(paren
r_struct
id|capidev
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|__u16
id|mlen
suffix:semicolon
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|file-&gt;f_pos
)paren
r_return
op_minus
id|ESPIPE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cdev-&gt;applid
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|count
comma
id|GFP_USER
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|copy_from_user
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|count
)paren
comma
id|buf
comma
id|count
)paren
)paren
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
id|mlen
op_assign
id|CAPIMSG_LEN
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CAPIMSG_CMD
c_func
(paren
id|skb-&gt;data
)paren
op_eq
id|CAPI_DATA_B3_REQ
)paren
(brace
r_if
c_cond
(paren
id|mlen
op_plus
id|CAPIMSG_DATALEN
c_func
(paren
id|skb-&gt;data
)paren
op_ne
id|count
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|mlen
op_ne
id|count
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
id|CAPIMSG_SETAPPID
c_func
(paren
id|skb-&gt;data
comma
id|cdev-&gt;applid
)paren
suffix:semicolon
id|cdev-&gt;errcode
op_assign
(paren
op_star
id|capifuncs-&gt;capi_put_message
)paren
(paren
id|cdev-&gt;applid
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev-&gt;errcode
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CAPIMSG_CMD
c_func
(paren
id|skb-&gt;data
)paren
op_eq
id|CAPI_DATA_B3_REQ
)paren
(brace
id|cdev-&gt;nsentdatapkt
op_increment
suffix:semicolon
)brace
r_else
(brace
id|cdev-&gt;nsentctlpkt
op_increment
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
r_static
r_int
r_int
DECL|function|capi_poll
id|capi_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|poll_table
op_star
id|wait
)paren
(brace
r_struct
id|capidev
op_star
id|cdev
op_assign
(paren
r_struct
id|capidev
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_int
r_int
id|mask
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cdev-&gt;applid
)paren
r_return
id|POLLERR
suffix:semicolon
id|poll_wait
c_func
(paren
id|file
comma
op_amp
(paren
id|cdev-&gt;recvwait
)paren
comma
id|wait
)paren
suffix:semicolon
id|mask
op_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb_queue_empty
c_func
(paren
op_amp
id|cdev-&gt;recvqueue
)paren
)paren
id|mask
op_or_assign
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
r_return
id|mask
suffix:semicolon
)brace
r_static
r_int
DECL|function|capi_ioctl
id|capi_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|capidev
op_star
id|cdev
op_assign
(paren
r_struct
id|capidev
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
id|capi_ioctl_struct
id|data
suffix:semicolon
r_int
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|CAPI_REGISTER
suffix:colon
(brace
id|retval
op_assign
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|data.rparams
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|capi_register_params
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|cdev-&gt;applid
)paren
r_return
op_minus
id|EEXIST
suffix:semicolon
id|cdev-&gt;errcode
op_assign
(paren
op_star
id|capifuncs-&gt;capi_register
)paren
(paren
op_amp
id|data.rparams
comma
op_amp
id|cdev-&gt;applid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev-&gt;errcode
)paren
(brace
id|cdev-&gt;applid
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
(paren
r_void
)paren
(paren
op_star
id|capifuncs-&gt;capi_set_signal
)paren
(paren
id|cdev-&gt;applid
comma
id|capi_signal
comma
id|cdev
)paren
suffix:semicolon
)brace
r_return
(paren
r_int
)paren
id|cdev-&gt;applid
suffix:semicolon
r_case
id|CAPI_GET_VERSION
suffix:colon
(brace
id|retval
op_assign
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|data.contr
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|data.contr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|cdev-&gt;errcode
op_assign
(paren
op_star
id|capifuncs-&gt;capi_get_version
)paren
(paren
id|data.contr
comma
op_amp
id|data.version
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev-&gt;errcode
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|retval
op_assign
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
op_amp
id|data.version
comma
r_sizeof
(paren
id|data.version
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|CAPI_GET_SERIAL
suffix:colon
(brace
id|retval
op_assign
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|data.contr
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|data.contr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|cdev-&gt;errcode
op_assign
(paren
op_star
id|capifuncs-&gt;capi_get_serial
)paren
(paren
id|data.contr
comma
id|data.serial
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev-&gt;errcode
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|retval
op_assign
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
id|data.serial
comma
r_sizeof
(paren
id|data.serial
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|CAPI_GET_PROFILE
suffix:colon
(brace
id|retval
op_assign
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|data.contr
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|data.contr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|data.contr
op_eq
l_int|0
)paren
(brace
id|cdev-&gt;errcode
op_assign
(paren
op_star
id|capifuncs-&gt;capi_get_profile
)paren
(paren
id|data.contr
comma
op_amp
id|data.profile
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev-&gt;errcode
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|retval
op_assign
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
op_amp
id|data.profile.ncontroller
comma
r_sizeof
(paren
id|data.profile.ncontroller
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|cdev-&gt;errcode
op_assign
(paren
op_star
id|capifuncs-&gt;capi_get_profile
)paren
(paren
id|data.contr
comma
op_amp
id|data.profile
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev-&gt;errcode
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|retval
op_assign
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
op_amp
id|data.profile
comma
r_sizeof
(paren
id|data.profile
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|retval
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|CAPI_GET_MANUFACTURER
suffix:colon
(brace
id|retval
op_assign
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|data.contr
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|data.contr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|cdev-&gt;errcode
op_assign
(paren
op_star
id|capifuncs-&gt;capi_get_manufacturer
)paren
(paren
id|data.contr
comma
id|data.manufacturer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev-&gt;errcode
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|retval
op_assign
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
id|data.manufacturer
comma
r_sizeof
(paren
id|data.manufacturer
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|CAPI_GET_ERRCODE
suffix:colon
id|data.errcode
op_assign
id|cdev-&gt;errcode
suffix:semicolon
id|cdev-&gt;errcode
op_assign
id|CAPI_NOERROR
suffix:semicolon
r_if
c_cond
(paren
id|arg
)paren
(brace
id|retval
op_assign
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
op_amp
id|data.errcode
comma
r_sizeof
(paren
id|data.errcode
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
id|data.errcode
suffix:semicolon
r_case
id|CAPI_INSTALLED
suffix:colon
r_if
c_cond
(paren
(paren
op_star
id|capifuncs-&gt;capi_isinstalled
)paren
(paren
)paren
op_eq
id|CAPI_NOERROR
)paren
r_return
l_int|0
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
r_case
id|CAPI_MANUFACTURER_CMD
suffix:colon
(brace
r_struct
id|capi_manufacturer_cmd
id|mcmd
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|retval
op_assign
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|mcmd
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|mcmd
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
(paren
op_star
id|capifuncs-&gt;capi_manufacturer
)paren
(paren
id|mcmd.cmd
comma
id|mcmd.data
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|CAPI_SET_FLAGS
suffix:colon
r_case
id|CAPI_CLR_FLAGS
suffix:colon
(brace
r_int
id|userflags
suffix:semicolon
id|retval
op_assign
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|userflags
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|userflags
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|CAPI_SET_FLAGS
)paren
id|cdev-&gt;userflags
op_or_assign
id|userflags
suffix:semicolon
r_else
id|cdev-&gt;userflags
op_and_assign
op_complement
id|userflags
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|CAPI_GET_FLAGS
suffix:colon
(brace
id|retval
op_assign
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
op_amp
id|cdev-&gt;userflags
comma
r_sizeof
(paren
id|cdev-&gt;userflags
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|CAPI_NCCI_OPENCOUNT
suffix:colon
(brace
r_struct
id|capincci
op_star
id|nccip
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
r_struct
id|capiminor
op_star
id|mp
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
r_int
id|ncci
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
id|retval
op_assign
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|ncci
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|ncci
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|nccip
op_assign
id|capincci_find
c_func
(paren
id|cdev
comma
(paren
id|__u32
)paren
id|ncci
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nccip
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
r_if
c_cond
(paren
(paren
id|mp
op_assign
id|nccip-&gt;minorp
)paren
op_ne
l_int|0
)paren
(brace
id|count
op_add_assign
id|atomic_read
c_func
(paren
op_amp
id|mp-&gt;ttyopencount
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;file
)paren
id|count
op_increment
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
r_return
id|count
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
r_case
id|CAPI_NCCI_GETUNIT
suffix:colon
(brace
r_struct
id|capincci
op_star
id|nccip
suffix:semicolon
r_struct
id|capiminor
op_star
id|mp
suffix:semicolon
r_int
id|ncci
suffix:semicolon
id|retval
op_assign
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|ncci
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|ncci
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|nccip
op_assign
id|capincci_find
c_func
(paren
id|cdev
comma
(paren
id|__u32
)paren
id|ncci
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nccip
op_logical_or
(paren
id|mp
op_assign
id|nccip-&gt;minorp
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|ESRCH
suffix:semicolon
r_return
id|mp-&gt;minor
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_static
r_int
DECL|function|capi_open
id|capi_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_if
c_cond
(paren
id|file-&gt;private_data
)paren
r_return
op_minus
id|EEXIST
suffix:semicolon
r_if
c_cond
(paren
(paren
id|file-&gt;private_data
op_assign
id|capidev_alloc
c_func
(paren
id|file
)paren
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
macro_line|#ifdef _DEBUG_REFCOUNT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capi_open %d&bslash;n&quot;
comma
id|GET_USE_COUNT
c_func
(paren
id|THIS_MODULE
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|capi_release
id|capi_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|capidev
op_star
id|cdev
op_assign
(paren
r_struct
id|capidev
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|capincci_free
c_func
(paren
id|cdev
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|capidev_free
c_func
(paren
id|cdev
)paren
suffix:semicolon
id|file-&gt;private_data
op_assign
l_int|NULL
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
macro_line|#ifdef _DEBUG_REFCOUNT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capi_release %d&bslash;n&quot;
comma
id|GET_USE_COUNT
c_func
(paren
id|THIS_MODULE
)paren
)paren
suffix:semicolon
macro_line|#endif
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|capi_fops
r_static
r_struct
id|file_operations
id|capi_fops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|llseek
suffix:colon
id|capi_llseek
comma
id|read
suffix:colon
id|capi_read
comma
id|write
suffix:colon
id|capi_write
comma
id|poll
suffix:colon
id|capi_poll
comma
id|ioctl
suffix:colon
id|capi_ioctl
comma
id|open
suffix:colon
id|capi_open
comma
id|release
suffix:colon
id|capi_release
comma
)brace
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
multiline_comment|/* -------- file_operations for capincci ---------------------------- */
r_static
r_int
DECL|function|capinc_raw_open
id|capinc_raw_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|capiminor
op_star
id|mp
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;private_data
)paren
r_return
op_minus
id|EEXIST
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mp
op_assign
id|capiminor_find
c_func
(paren
id|MINOR
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_rdev
)paren
)paren
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;nccip
op_eq
l_int|0
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;file
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
macro_line|#ifdef _DEBUG_REFCOUNT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capi_raw_open %d&bslash;n&quot;
comma
id|GET_USE_COUNT
c_func
(paren
id|THIS_MODULE
)paren
)paren
suffix:semicolon
macro_line|#endif
id|mp-&gt;datahandle
op_assign
l_int|0
suffix:semicolon
id|mp-&gt;file
op_assign
id|file
suffix:semicolon
id|file-&gt;private_data
op_assign
(paren
r_void
op_star
)paren
id|mp
suffix:semicolon
id|handle_minor_recv
c_func
(paren
id|mp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
id|loff_t
DECL|function|capinc_raw_llseek
id|capinc_raw_llseek
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|loff_t
id|offset
comma
r_int
id|origin
)paren
(brace
r_return
op_minus
id|ESPIPE
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|capinc_raw_read
id|capinc_raw_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|capiminor
op_star
id|mp
op_assign
(paren
r_struct
id|capiminor
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_int
id|copied
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|file-&gt;f_pos
)paren
r_return
op_minus
id|ESPIPE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mp
op_logical_or
op_logical_neg
id|mp-&gt;nccip
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|mp-&gt;recvqueue
)paren
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|mp-&gt;recvwait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;nccip
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|mp-&gt;recvqueue
)paren
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb
op_eq
l_int|0
)paren
r_return
op_minus
id|ERESTARTNOHAND
suffix:semicolon
)brace
r_do
(brace
r_if
c_cond
(paren
id|count
OL
id|skb-&gt;len
)paren
(brace
id|retval
op_assign
id|copy_to_user
c_func
(paren
id|buf
comma
id|skb-&gt;data
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|skb_queue_head
c_func
(paren
op_amp
id|mp-&gt;recvqueue
comma
id|skb
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
id|skb_pull
c_func
(paren
id|skb
comma
id|count
)paren
suffix:semicolon
id|skb_queue_head
c_func
(paren
op_amp
id|mp-&gt;recvqueue
comma
id|skb
)paren
suffix:semicolon
id|copied
op_add_assign
id|count
suffix:semicolon
r_return
id|copied
suffix:semicolon
)brace
r_else
(brace
id|retval
op_assign
id|copy_to_user
c_func
(paren
id|buf
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|skb_queue_head
c_func
(paren
op_amp
id|mp-&gt;recvqueue
comma
id|skb
)paren
suffix:semicolon
r_return
id|copied
suffix:semicolon
)brace
id|copied
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|count
op_sub_assign
id|skb-&gt;len
suffix:semicolon
id|buf
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|mp-&gt;recvqueue
)paren
)paren
op_ne
l_int|0
)paren
suffix:semicolon
r_return
id|copied
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|capinc_raw_write
id|capinc_raw_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|capiminor
op_star
id|mp
op_assign
(paren
r_struct
id|capiminor
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|file-&gt;f_pos
)paren
r_return
op_minus
id|ESPIPE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mp
op_logical_or
op_logical_neg
id|mp-&gt;nccip
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|CAPI_DATA_B3_REQ_LEN
op_plus
id|count
comma
id|GFP_USER
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
id|CAPI_DATA_B3_REQ_LEN
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|copy_from_user
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|count
)paren
comma
id|buf
comma
id|count
)paren
)paren
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_while
c_loop
(paren
id|skb_queue_len
c_func
(paren
op_amp
id|mp-&gt;outqueue
)paren
OG
id|CAPINC_MAX_SENDQUEUE
)paren
(brace
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|mp-&gt;sendwait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;nccip
op_eq
l_int|0
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|ERESTARTNOHAND
suffix:semicolon
)brace
id|skb_queue_tail
c_func
(paren
op_amp
id|mp-&gt;outqueue
comma
id|skb
)paren
suffix:semicolon
id|mp-&gt;outbytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
(paren
r_void
)paren
id|handle_minor_send
c_func
(paren
id|mp
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_static
r_int
r_int
DECL|function|capinc_raw_poll
id|capinc_raw_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|poll_table
op_star
id|wait
)paren
(brace
r_struct
id|capiminor
op_star
id|mp
op_assign
(paren
r_struct
id|capiminor
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_int
r_int
id|mask
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mp
op_logical_or
op_logical_neg
id|mp-&gt;nccip
)paren
r_return
id|POLLERR
op_or
id|POLLHUP
suffix:semicolon
id|poll_wait
c_func
(paren
id|file
comma
op_amp
(paren
id|mp-&gt;recvwait
)paren
comma
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb_queue_empty
c_func
(paren
op_amp
id|mp-&gt;recvqueue
)paren
)paren
id|mask
op_or_assign
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
id|poll_wait
c_func
(paren
id|file
comma
op_amp
(paren
id|mp-&gt;sendwait
)paren
comma
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb_queue_len
c_func
(paren
op_amp
id|mp-&gt;outqueue
)paren
OG
id|CAPINC_MAX_SENDQUEUE
)paren
id|mask
op_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
r_return
id|mask
suffix:semicolon
)brace
r_static
r_int
DECL|function|capinc_raw_ioctl
id|capinc_raw_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|capiminor
op_star
id|mp
op_assign
(paren
r_struct
id|capiminor
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mp
op_logical_or
op_logical_neg
id|mp-&gt;nccip
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_static
r_int
DECL|function|capinc_raw_release
id|capinc_raw_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|capiminor
op_star
id|mp
op_assign
(paren
r_struct
id|capiminor
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|mp
)paren
(brace
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|mp-&gt;file
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;nccip
op_eq
l_int|0
)paren
(brace
id|capiminor_free
c_func
(paren
id|mp
)paren
suffix:semicolon
id|file-&gt;private_data
op_assign
l_int|NULL
suffix:semicolon
)brace
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef _DEBUG_REFCOUNT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_raw_release %d&bslash;n&quot;
comma
id|GET_USE_COUNT
c_func
(paren
id|THIS_MODULE
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|capinc_raw_fops
r_static
r_struct
id|file_operations
id|capinc_raw_fops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|llseek
suffix:colon
id|capinc_raw_llseek
comma
id|read
suffix:colon
id|capinc_raw_read
comma
id|write
suffix:colon
id|capinc_raw_write
comma
id|poll
suffix:colon
id|capinc_raw_poll
comma
id|ioctl
suffix:colon
id|capinc_raw_ioctl
comma
id|open
suffix:colon
id|capinc_raw_open
comma
id|release
suffix:colon
id|capinc_raw_release
comma
)brace
suffix:semicolon
multiline_comment|/* -------- tty_operations for capincci ----------------------------- */
DECL|function|capinc_tty_open
r_int
id|capinc_tty_open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|capiminor
op_star
id|mp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mp
op_assign
id|capiminor_find
c_func
(paren
id|MINOR
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_rdev
)paren
)paren
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;nccip
op_eq
l_int|0
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;file
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|mp-&gt;recvqueue
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|mp-&gt;recvwait
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|mp-&gt;sendwait
)paren
suffix:semicolon
id|tty-&gt;driver_data
op_assign
(paren
r_void
op_star
)paren
id|mp
suffix:semicolon
macro_line|#ifdef _DEBUG_REFCOUNT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capi_tty_open %d&bslash;n&quot;
comma
id|GET_USE_COUNT
c_func
(paren
id|THIS_MODULE
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|mp-&gt;ttyopencount
)paren
op_eq
l_int|0
)paren
id|mp-&gt;tty
op_assign
id|tty
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|mp-&gt;ttyopencount
)paren
suffix:semicolon
macro_line|#ifdef _DEBUG_REFCOUNT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_open ocount=%d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|mp-&gt;ttyopencount
)paren
)paren
suffix:semicolon
macro_line|#endif
id|handle_minor_recv
c_func
(paren
id|mp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|capinc_tty_close
r_void
id|capinc_tty_close
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|capiminor
op_star
id|mp
suffix:semicolon
id|mp
op_assign
(paren
r_struct
id|capiminor
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|mp
)paren
(brace
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|mp-&gt;ttyopencount
)paren
)paren
(brace
macro_line|#ifdef _DEBUG_REFCOUNT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_close lastclose&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tty-&gt;driver_data
op_assign
(paren
r_void
op_star
)paren
l_int|0
suffix:semicolon
id|mp-&gt;tty
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef _DEBUG_REFCOUNT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_close ocount=%d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|mp-&gt;ttyopencount
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|mp-&gt;nccip
op_eq
l_int|0
)paren
id|capiminor_free
c_func
(paren
id|mp
)paren
suffix:semicolon
)brace
macro_line|#ifdef _DEBUG_REFCOUNT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_close&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|capinc_tty_write
r_int
id|capinc_tty_write
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|from_user
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|capiminor
op_star
id|mp
op_assign
(paren
r_struct
id|capiminor
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|retval
suffix:semicolon
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_write(from_user=%d,count=%d)&bslash;n&quot;
comma
id|from_user
comma
id|count
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|mp
op_logical_or
op_logical_neg
id|mp-&gt;nccip
)paren
(brace
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_write: mp or mp-&gt;ncci NULL&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
id|skb
op_assign
id|mp-&gt;ttyskb
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|mp-&gt;ttyskb
op_assign
l_int|0
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|mp-&gt;outqueue
comma
id|skb
)paren
suffix:semicolon
id|mp-&gt;outbytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
)brace
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|CAPI_DATA_B3_REQ_LEN
op_plus
id|count
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capinc_tty_write: alloc_skb failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb
comma
id|CAPI_DATA_B3_REQ_LEN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|from_user
)paren
(brace
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|copy_from_user
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|count
)paren
comma
id|buf
comma
id|count
)paren
)paren
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_write: copy_from_user=%d&bslash;n&quot;
comma
id|retval
)paren
suffix:semicolon
macro_line|#endif
r_return
id|retval
suffix:semicolon
)brace
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|count
)paren
comma
id|buf
comma
id|count
)paren
suffix:semicolon
)brace
id|skb_queue_tail
c_func
(paren
op_amp
id|mp-&gt;outqueue
comma
id|skb
)paren
suffix:semicolon
id|mp-&gt;outbytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
(paren
r_void
)paren
id|handle_minor_send
c_func
(paren
id|mp
)paren
suffix:semicolon
(paren
r_void
)paren
id|handle_minor_recv
c_func
(paren
id|mp
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|capinc_tty_put_char
r_void
id|capinc_tty_put_char
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
r_char
id|ch
)paren
(brace
r_struct
id|capiminor
op_star
id|mp
op_assign
(paren
r_struct
id|capiminor
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_put_char(%u)&bslash;n&quot;
comma
id|ch
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|mp
op_logical_or
op_logical_neg
id|mp-&gt;nccip
)paren
(brace
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_put_char: mp or mp-&gt;ncci NULL&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
id|skb
op_assign
id|mp-&gt;ttyskb
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
r_if
c_cond
(paren
id|skb_tailroom
c_func
(paren
id|skb
)paren
OG
l_int|0
)paren
(brace
op_star
(paren
id|skb_put
c_func
(paren
id|skb
comma
l_int|1
)paren
)paren
op_assign
id|ch
suffix:semicolon
r_return
suffix:semicolon
)brace
id|mp-&gt;ttyskb
op_assign
l_int|0
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|mp-&gt;outqueue
comma
id|skb
)paren
suffix:semicolon
id|mp-&gt;outbytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
(paren
r_void
)paren
id|handle_minor_send
c_func
(paren
id|mp
)paren
suffix:semicolon
)brace
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|CAPI_DATA_B3_REQ_LEN
op_plus
id|CAPI_MAX_BLKSIZE
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|skb_reserve
c_func
(paren
id|skb
comma
id|CAPI_DATA_B3_REQ_LEN
)paren
suffix:semicolon
op_star
(paren
id|skb_put
c_func
(paren
id|skb
comma
l_int|1
)paren
)paren
op_assign
id|ch
suffix:semicolon
id|mp-&gt;ttyskb
op_assign
id|skb
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capinc_put_char: char %u lost&bslash;n&quot;
comma
id|ch
)paren
suffix:semicolon
)brace
)brace
DECL|function|capinc_tty_flush_chars
r_void
id|capinc_tty_flush_chars
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|capiminor
op_star
id|mp
op_assign
(paren
r_struct
id|capiminor
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_flush_chars&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|mp
op_logical_or
op_logical_neg
id|mp-&gt;nccip
)paren
(brace
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_flush_chars: mp or mp-&gt;ncci NULL&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
id|skb
op_assign
id|mp-&gt;ttyskb
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|mp-&gt;ttyskb
op_assign
l_int|0
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|mp-&gt;outqueue
comma
id|skb
)paren
suffix:semicolon
id|mp-&gt;outbytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
(paren
r_void
)paren
id|handle_minor_send
c_func
(paren
id|mp
)paren
suffix:semicolon
)brace
(paren
r_void
)paren
id|handle_minor_recv
c_func
(paren
id|mp
)paren
suffix:semicolon
)brace
DECL|function|capinc_tty_write_room
r_int
id|capinc_tty_write_room
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|capiminor
op_star
id|mp
op_assign
(paren
r_struct
id|capiminor
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
id|room
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mp
op_logical_or
op_logical_neg
id|mp-&gt;nccip
)paren
(brace
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_write_room: mp or mp-&gt;ncci NULL&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
id|room
op_assign
id|CAPINC_MAX_SENDQUEUE
op_minus
id|skb_queue_len
c_func
(paren
op_amp
id|mp-&gt;outqueue
)paren
suffix:semicolon
id|room
op_mul_assign
id|CAPI_MAX_BLKSIZE
suffix:semicolon
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_write_room = %d&bslash;n&quot;
comma
id|room
)paren
suffix:semicolon
macro_line|#endif
r_return
id|room
suffix:semicolon
)brace
DECL|function|capinc_tty_chars_in_buffer
r_int
id|capinc_tty_chars_in_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|capiminor
op_star
id|mp
op_assign
(paren
r_struct
id|capiminor
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mp
op_logical_or
op_logical_neg
id|mp-&gt;nccip
)paren
(brace
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_chars_in_buffer: mp or mp-&gt;ncci NULL&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_chars_in_buffer = %d nack=%d sq=%d rq=%d&bslash;n&quot;
comma
id|mp-&gt;outbytes
comma
id|mp-&gt;nack
comma
id|skb_queue_len
c_func
(paren
op_amp
id|mp-&gt;outqueue
)paren
comma
id|skb_queue_len
c_func
(paren
op_amp
id|mp-&gt;inqueue
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
id|mp-&gt;outbytes
suffix:semicolon
)brace
DECL|function|capinc_tty_ioctl
r_int
id|capinc_tty_ioctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_default
suffix:colon
id|error
op_assign
id|n_tty_ioctl
(paren
id|tty
comma
id|file
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|error
suffix:semicolon
)brace
DECL|function|capinc_tty_set_termios
r_void
id|capinc_tty_set_termios
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|termios
op_star
id|old
)paren
(brace
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_set_termios&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|capinc_tty_throttle
r_void
id|capinc_tty_throttle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|capiminor
op_star
id|mp
op_assign
(paren
r_struct
id|capiminor
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_throttle&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|mp
)paren
id|mp-&gt;ttyinstop
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|capinc_tty_unthrottle
r_void
id|capinc_tty_unthrottle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|capiminor
op_star
id|mp
op_assign
(paren
r_struct
id|capiminor
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_unthrottle&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|mp
)paren
(brace
id|mp-&gt;ttyinstop
op_assign
l_int|0
suffix:semicolon
id|handle_minor_recv
c_func
(paren
id|mp
)paren
suffix:semicolon
)brace
)brace
DECL|function|capinc_tty_stop
r_void
id|capinc_tty_stop
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|capiminor
op_star
id|mp
op_assign
(paren
r_struct
id|capiminor
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_stop&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|mp
)paren
(brace
id|mp-&gt;ttyoutstop
op_assign
l_int|1
suffix:semicolon
)brace
)brace
DECL|function|capinc_tty_start
r_void
id|capinc_tty_start
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|capiminor
op_star
id|mp
op_assign
(paren
r_struct
id|capiminor
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_start&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|mp
)paren
(brace
id|mp-&gt;ttyoutstop
op_assign
l_int|0
suffix:semicolon
(paren
r_void
)paren
id|handle_minor_send
c_func
(paren
id|mp
)paren
suffix:semicolon
)brace
)brace
DECL|function|capinc_tty_hangup
r_void
id|capinc_tty_hangup
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_hangup&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|capinc_tty_break_ctl
r_void
id|capinc_tty_break_ctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|state
)paren
(brace
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_break_ctl(%d)&bslash;n&quot;
comma
id|state
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|capinc_tty_flush_buffer
r_void
id|capinc_tty_flush_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_flush_buffer&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|capinc_tty_set_ldisc
r_void
id|capinc_tty_set_ldisc
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_set_ldisc&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|capinc_tty_send_xchar
r_void
id|capinc_tty_send_xchar
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_char
id|ch
)paren
(brace
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_send_xchar(%d)&bslash;n&quot;
comma
id|ch
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|capinc_tty_read_proc
r_int
id|capinc_tty_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|capinc_write_proc
r_int
id|capinc_write_proc
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|CAPINC_NR_PORTS
mdefine_line|#define CAPINC_NR_PORTS 256
DECL|variable|capinc_tty_driver
r_static
r_struct
id|tty_driver
id|capinc_tty_driver
suffix:semicolon
DECL|variable|capinc_tty_refcount
r_static
r_int
id|capinc_tty_refcount
suffix:semicolon
DECL|variable|capinc_tty_table
r_static
r_struct
id|tty_struct
op_star
id|capinc_tty_table
(braket
id|CAPINC_NR_PORTS
)braket
suffix:semicolon
DECL|variable|capinc_tty_termios
r_static
r_struct
id|termios
op_star
id|capinc_tty_termios
(braket
id|CAPINC_NR_PORTS
)braket
suffix:semicolon
DECL|variable|capinc_tty_termios_locked
r_static
r_struct
id|termios
op_star
id|capinc_tty_termios_locked
(braket
id|CAPINC_NR_PORTS
)braket
suffix:semicolon
DECL|function|capinc_tty_init
r_int
id|capinc_tty_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|tty_driver
op_star
id|drv
op_assign
op_amp
id|capinc_tty_driver
suffix:semicolon
multiline_comment|/* Initialize the tty_driver structure */
id|memset
c_func
(paren
id|drv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tty_driver
)paren
)paren
suffix:semicolon
id|drv-&gt;magic
op_assign
id|TTY_DRIVER_MAGIC
suffix:semicolon
macro_line|#if (LINUX_VERSION_CODE &gt; 0x20100)
id|drv-&gt;driver_name
op_assign
l_string|&quot;capi_nc&quot;
suffix:semicolon
macro_line|#endif
id|drv-&gt;name
op_assign
l_string|&quot;capi/%d&quot;
suffix:semicolon
id|drv-&gt;major
op_assign
id|capi_ttymajor
suffix:semicolon
id|drv-&gt;minor_start
op_assign
l_int|0
suffix:semicolon
id|drv-&gt;num
op_assign
id|CAPINC_NR_PORTS
suffix:semicolon
id|drv-&gt;type
op_assign
id|TTY_DRIVER_TYPE_SERIAL
suffix:semicolon
id|drv-&gt;subtype
op_assign
id|SERIAL_TYPE_NORMAL
suffix:semicolon
id|drv-&gt;init_termios
op_assign
id|tty_std_termios
suffix:semicolon
id|drv-&gt;init_termios.c_iflag
op_assign
id|ICRNL
suffix:semicolon
id|drv-&gt;init_termios.c_oflag
op_assign
id|OPOST
op_or
id|ONLCR
suffix:semicolon
id|drv-&gt;init_termios.c_cflag
op_assign
id|B9600
op_or
id|CS8
op_or
id|CREAD
op_or
id|HUPCL
op_or
id|CLOCAL
suffix:semicolon
id|drv-&gt;init_termios.c_lflag
op_assign
l_int|0
suffix:semicolon
id|drv-&gt;flags
op_assign
id|TTY_DRIVER_REAL_RAW
op_or
id|TTY_DRIVER_RESET_TERMIOS
suffix:semicolon
id|drv-&gt;refcount
op_assign
op_amp
id|capinc_tty_refcount
suffix:semicolon
id|drv-&gt;table
op_assign
id|capinc_tty_table
suffix:semicolon
id|drv-&gt;termios
op_assign
id|capinc_tty_termios
suffix:semicolon
id|drv-&gt;termios_locked
op_assign
id|capinc_tty_termios_locked
suffix:semicolon
id|drv-&gt;open
op_assign
id|capinc_tty_open
suffix:semicolon
id|drv-&gt;close
op_assign
id|capinc_tty_close
suffix:semicolon
id|drv-&gt;write
op_assign
id|capinc_tty_write
suffix:semicolon
id|drv-&gt;put_char
op_assign
id|capinc_tty_put_char
suffix:semicolon
id|drv-&gt;flush_chars
op_assign
id|capinc_tty_flush_chars
suffix:semicolon
id|drv-&gt;write_room
op_assign
id|capinc_tty_write_room
suffix:semicolon
id|drv-&gt;chars_in_buffer
op_assign
id|capinc_tty_chars_in_buffer
suffix:semicolon
id|drv-&gt;ioctl
op_assign
id|capinc_tty_ioctl
suffix:semicolon
id|drv-&gt;set_termios
op_assign
id|capinc_tty_set_termios
suffix:semicolon
id|drv-&gt;throttle
op_assign
id|capinc_tty_throttle
suffix:semicolon
id|drv-&gt;unthrottle
op_assign
id|capinc_tty_unthrottle
suffix:semicolon
id|drv-&gt;stop
op_assign
id|capinc_tty_stop
suffix:semicolon
id|drv-&gt;start
op_assign
id|capinc_tty_start
suffix:semicolon
id|drv-&gt;hangup
op_assign
id|capinc_tty_hangup
suffix:semicolon
macro_line|#if (LINUX_VERSION_CODE &gt;= 131394) /* Linux 2.1.66 */
id|drv-&gt;break_ctl
op_assign
id|capinc_tty_break_ctl
suffix:semicolon
macro_line|#endif
id|drv-&gt;flush_buffer
op_assign
id|capinc_tty_flush_buffer
suffix:semicolon
id|drv-&gt;set_ldisc
op_assign
id|capinc_tty_set_ldisc
suffix:semicolon
macro_line|#if (LINUX_VERSION_CODE &gt;= 131343)
id|drv-&gt;send_xchar
op_assign
id|capinc_tty_send_xchar
suffix:semicolon
id|drv-&gt;read_proc
op_assign
id|capinc_tty_read_proc
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|tty_register_driver
c_func
(paren
id|drv
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Couldn&squot;t register capi_nc driver&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|capinc_tty_exit
r_void
id|capinc_tty_exit
c_func
(paren
r_void
)paren
(brace
r_struct
id|tty_driver
op_star
id|drv
op_assign
op_amp
id|capinc_tty_driver
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|tty_unregister_driver
c_func
(paren
id|drv
)paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capi: failed to unregister capi_nc driver (%d)&bslash;n&quot;
comma
id|retval
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
multiline_comment|/* -------- /proc functions ----------------------------------------- */
multiline_comment|/*&n; * /proc/capi/capi20:&n; *  minor applid nrecvctlpkt nrecvdatapkt nsendctlpkt nsenddatapkt&n; */
DECL|function|proc_capidev_read_proc
r_static
r_int
id|proc_capidev_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|capidev
op_star
id|cdev
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|cdev
op_assign
id|capidev_openlist
suffix:semicolon
id|cdev
suffix:semicolon
id|cdev
op_assign
id|cdev-&gt;next
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;%d %d %lu %lu %lu %lu&bslash;n&quot;
comma
id|cdev-&gt;minor
comma
id|cdev-&gt;applid
comma
id|cdev-&gt;nrecvctlpkt
comma
id|cdev-&gt;nrecvdatapkt
comma
id|cdev-&gt;nsentctlpkt
comma
id|cdev-&gt;nsentdatapkt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
id|off
)paren
(brace
id|off
op_sub_assign
id|len
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|len
op_minus
id|off
OG
id|count
)paren
r_goto
id|endloop
suffix:semicolon
)brace
)brace
id|endloop
suffix:colon
r_if
c_cond
(paren
id|len
OL
id|count
)paren
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|count
)paren
id|len
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; * /proc/capi/capi20ncci:&n; *  applid ncci&n; */
DECL|function|proc_capincci_read_proc
r_static
r_int
id|proc_capincci_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|capidev
op_star
id|cdev
suffix:semicolon
r_struct
id|capincci
op_star
id|np
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|cdev
op_assign
id|capidev_openlist
suffix:semicolon
id|cdev
suffix:semicolon
id|cdev
op_assign
id|cdev-&gt;next
)paren
(brace
r_for
c_loop
(paren
id|np
op_assign
id|cdev-&gt;nccis
suffix:semicolon
id|np
suffix:semicolon
id|np
op_assign
id|np-&gt;next
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;%d 0x%x%s&bslash;n&quot;
comma
id|cdev-&gt;applid
comma
id|np-&gt;ncci
comma
macro_line|#ifndef CONFIG_ISDN_CAPI_MIDDLEWARE
l_string|&quot;&quot;
)paren
suffix:semicolon
macro_line|#else /* CONFIG_ISDN_CAPI_MIDDLEWARE */
id|np-&gt;minorp
op_logical_and
id|np-&gt;minorp-&gt;file
ques
c_cond
l_string|&quot; open&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
r_if
c_cond
(paren
id|len
op_le
id|off
)paren
(brace
id|off
op_sub_assign
id|len
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|len
op_minus
id|off
OG
id|count
)paren
r_goto
id|endloop
suffix:semicolon
)brace
)brace
)brace
id|endloop
suffix:colon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|count
)paren
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|count
)paren
id|len
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|struct|procfsentries
r_static
r_struct
id|procfsentries
(brace
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|mode
id|mode_t
id|mode
suffix:semicolon
DECL|member|read_proc
r_int
(paren
op_star
id|read_proc
)paren
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
DECL|member|procent
r_struct
id|proc_dir_entry
op_star
id|procent
suffix:semicolon
DECL|variable|procfsentries
)brace
id|procfsentries
(braket
)braket
op_assign
(brace
multiline_comment|/* { &quot;capi&quot;,&t;&t;  S_IFDIR, 0 }, */
(brace
l_string|&quot;capi/capi20&quot;
comma
l_int|0
comma
id|proc_capidev_read_proc
)brace
comma
(brace
l_string|&quot;capi/capi20ncci&quot;
comma
l_int|0
comma
id|proc_capincci_read_proc
)brace
comma
)brace
suffix:semicolon
DECL|function|proc_init
r_static
r_void
id|__init
id|proc_init
c_func
(paren
r_void
)paren
(brace
r_int
id|nelem
op_assign
r_sizeof
(paren
id|procfsentries
)paren
op_div
r_sizeof
(paren
id|procfsentries
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nelem
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|procfsentries
op_star
id|p
op_assign
id|procfsentries
op_plus
id|i
suffix:semicolon
id|p-&gt;procent
op_assign
id|create_proc_entry
c_func
(paren
id|p-&gt;name
comma
id|p-&gt;mode
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;procent
)paren
id|p-&gt;procent-&gt;read_proc
op_assign
id|p-&gt;read_proc
suffix:semicolon
)brace
)brace
DECL|function|proc_exit
r_static
r_void
id|__exit
id|proc_exit
c_func
(paren
r_void
)paren
(brace
r_int
id|nelem
op_assign
r_sizeof
(paren
id|procfsentries
)paren
op_div
r_sizeof
(paren
id|procfsentries
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|nelem
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_struct
id|procfsentries
op_star
id|p
op_assign
id|procfsentries
op_plus
id|i
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;procent
)paren
(brace
id|remove_proc_entry
c_func
(paren
id|p-&gt;name
comma
l_int|0
)paren
suffix:semicolon
id|p-&gt;procent
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* -------- init function and module interface ---------------------- */
DECL|function|alloc_exit
r_static
r_void
id|__exit
id|alloc_exit
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|capidev_cachep
)paren
(brace
(paren
r_void
)paren
id|kmem_cache_destroy
c_func
(paren
id|capidev_cachep
)paren
suffix:semicolon
id|capidev_cachep
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|capincci_cachep
)paren
(brace
(paren
r_void
)paren
id|kmem_cache_destroy
c_func
(paren
id|capincci_cachep
)paren
suffix:semicolon
id|capincci_cachep
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
r_if
c_cond
(paren
id|capidh_cachep
)paren
(brace
(paren
r_void
)paren
id|kmem_cache_destroy
c_func
(paren
id|capidh_cachep
)paren
suffix:semicolon
id|capidh_cachep
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|capiminor_cachep
)paren
(brace
(paren
r_void
)paren
id|kmem_cache_destroy
c_func
(paren
id|capiminor_cachep
)paren
suffix:semicolon
id|capiminor_cachep
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
)brace
DECL|function|alloc_init
r_static
r_int
id|__init
id|alloc_init
c_func
(paren
r_void
)paren
(brace
id|capidev_cachep
op_assign
id|kmem_cache_create
c_func
(paren
l_string|&quot;capi20_dev&quot;
comma
r_sizeof
(paren
r_struct
id|capidev
)paren
comma
l_int|0
comma
id|SLAB_HWCACHE_ALIGN
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capidev_cachep
)paren
(brace
id|alloc_exit
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|capincci_cachep
op_assign
id|kmem_cache_create
c_func
(paren
l_string|&quot;capi20_ncci&quot;
comma
r_sizeof
(paren
r_struct
id|capincci
)paren
comma
l_int|0
comma
id|SLAB_HWCACHE_ALIGN
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capincci_cachep
)paren
(brace
id|alloc_exit
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
id|capidh_cachep
op_assign
id|kmem_cache_create
c_func
(paren
l_string|&quot;capi20_dh&quot;
comma
r_sizeof
(paren
r_struct
id|datahandle_queue
)paren
comma
l_int|0
comma
id|SLAB_HWCACHE_ALIGN
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capidh_cachep
)paren
(brace
id|alloc_exit
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|capiminor_cachep
op_assign
id|kmem_cache_create
c_func
(paren
l_string|&quot;capi20_minor&quot;
comma
r_sizeof
(paren
r_struct
id|capiminor
)paren
comma
l_int|0
comma
id|SLAB_HWCACHE_ALIGN
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capiminor_cachep
)paren
(brace
id|alloc_exit
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lower_callback
r_static
r_void
id|lower_callback
c_func
(paren
r_int
r_int
id|cmd
comma
id|__u32
id|contr
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|capi_ncciinfo
op_star
id|np
suffix:semicolon
r_struct
id|capidev
op_star
id|cdev
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|KCI_CONTRUP
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capi: controller %hu up&bslash;n&quot;
comma
id|contr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|KCI_CONTRDOWN
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;capi: controller %hu down&bslash;n&quot;
comma
id|contr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|KCI_NCCIUP
suffix:colon
id|np
op_assign
(paren
r_struct
id|capi_ncciinfo
op_star
)paren
id|data
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cdev
op_assign
id|capidev_find
c_func
(paren
id|np-&gt;applid
)paren
)paren
op_eq
l_int|0
)paren
r_return
suffix:semicolon
(paren
r_void
)paren
id|capincci_alloc
c_func
(paren
id|cdev
comma
id|np-&gt;ncci
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|KCI_NCCIDOWN
suffix:colon
id|np
op_assign
(paren
r_struct
id|capi_ncciinfo
op_star
)paren
id|data
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cdev
op_assign
id|capidev_find
c_func
(paren
id|np-&gt;applid
)paren
)paren
op_eq
l_int|0
)paren
r_return
suffix:semicolon
(paren
r_void
)paren
id|capincci_free
c_func
(paren
id|cdev
comma
id|np-&gt;ncci
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|variable|cuser
r_static
r_struct
id|capi_interface_user
id|cuser
op_assign
(brace
id|name
suffix:colon
l_string|&quot;capi20&quot;
comma
id|callback
suffix:colon
id|lower_callback
comma
)brace
suffix:semicolon
DECL|variable|rev
r_static
r_char
id|rev
(braket
l_int|10
)braket
suffix:semicolon
DECL|function|capi_init
r_static
r_int
id|__init
id|capi_init
c_func
(paren
r_void
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
op_assign
id|strchr
c_func
(paren
id|revision
comma
l_char|&squot;:&squot;
)paren
)paren
)paren
(brace
id|strcpy
c_func
(paren
id|rev
comma
id|p
op_plus
l_int|2
)paren
suffix:semicolon
id|p
op_assign
id|strchr
c_func
(paren
id|rev
comma
l_char|&squot;$&squot;
)paren
suffix:semicolon
op_star
(paren
id|p
op_minus
l_int|1
)paren
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|strcpy
c_func
(paren
id|rev
comma
l_string|&quot;???&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devfs_register_chrdev
c_func
(paren
id|capi_major
comma
l_string|&quot;capi20&quot;
comma
op_amp
id|capi_fops
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capi20: unable to get major %d&bslash;n&quot;
comma
id|capi_major
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
r_if
c_cond
(paren
id|devfs_register_chrdev
c_func
(paren
id|capi_rawmajor
comma
l_string|&quot;capi/r%d&quot;
comma
op_amp
id|capinc_raw_fops
)paren
)paren
(brace
id|devfs_unregister_chrdev
c_func
(paren
id|capi_major
comma
l_string|&quot;capi20&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capi20: unable to get major %d&bslash;n&quot;
comma
id|capi_rawmajor
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|devfs_register_series
(paren
l_int|NULL
comma
l_string|&quot;capi/r%u&quot;
comma
id|CAPINC_NR_PORTS
comma
id|DEVFS_FL_DEFAULT
comma
id|capi_rawmajor
comma
l_int|0
comma
id|S_IFCHR
op_or
id|S_IRUSR
op_or
id|S_IWUSR
comma
op_amp
id|capinc_raw_fops
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
id|devfs_register
(paren
l_int|NULL
comma
l_string|&quot;isdn/capi20&quot;
comma
id|DEVFS_FL_DEFAULT
comma
id|capi_major
comma
l_int|0
comma
id|S_IFCHR
op_or
id|S_IRUSR
op_or
id|S_IWUSR
comma
op_amp
id|capi_fops
comma
l_int|NULL
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;capi20: started up with major %d&bslash;n&quot;
comma
id|capi_major
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|capifuncs
op_assign
id|attach_capi_interface
c_func
(paren
op_amp
id|cuser
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|devfs_unregister_chrdev
c_func
(paren
id|capi_major
comma
l_string|&quot;capi20&quot;
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
id|devfs_unregister_chrdev
c_func
(paren
id|capi_rawmajor
comma
l_string|&quot;capi/r%d&quot;
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
id|devfs_unregister
c_func
(paren
id|devfs_find_handle
c_func
(paren
l_int|NULL
comma
l_string|&quot;capi20&quot;
comma
id|capi_major
comma
l_int|0
comma
id|DEVFS_SPECIAL_CHR
comma
l_int|0
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
r_if
c_cond
(paren
id|capinc_tty_init
c_func
(paren
)paren
OL
l_int|0
)paren
(brace
(paren
r_void
)paren
id|detach_capi_interface
c_func
(paren
op_amp
id|cuser
)paren
suffix:semicolon
id|devfs_unregister_chrdev
c_func
(paren
id|capi_major
comma
l_string|&quot;capi20&quot;
)paren
suffix:semicolon
id|devfs_unregister_chrdev
c_func
(paren
id|capi_rawmajor
comma
l_string|&quot;capi/r%d&quot;
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
r_if
c_cond
(paren
id|alloc_init
c_func
(paren
)paren
OL
l_int|0
)paren
(brace
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
r_int
r_int
id|j
suffix:semicolon
id|devfs_unregister_chrdev
c_func
(paren
id|capi_rawmajor
comma
l_string|&quot;capi/r%d&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|CAPINC_NR_PORTS
suffix:semicolon
id|j
op_increment
)paren
(brace
r_char
id|devname
(braket
l_int|32
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|devname
comma
l_string|&quot;capi/r%u&quot;
comma
id|j
)paren
suffix:semicolon
id|devfs_unregister
c_func
(paren
id|devfs_find_handle
c_func
(paren
l_int|NULL
comma
id|devname
comma
id|capi_rawmajor
comma
id|j
comma
id|DEVFS_SPECIAL_CHR
comma
l_int|0
)paren
)paren
suffix:semicolon
)brace
id|capinc_tty_exit
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
(paren
r_void
)paren
id|detach_capi_interface
c_func
(paren
op_amp
id|cuser
)paren
suffix:semicolon
id|devfs_unregister_chrdev
c_func
(paren
id|capi_major
comma
l_string|&quot;capi20&quot;
)paren
suffix:semicolon
id|devfs_unregister
c_func
(paren
id|devfs_find_handle
c_func
(paren
l_int|NULL
comma
l_string|&quot;capi20&quot;
comma
id|capi_major
comma
l_int|0
comma
id|DEVFS_SPECIAL_CHR
comma
l_int|0
)paren
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
(paren
r_void
)paren
id|proc_init
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;capi20: Rev%s: started up with major %d&bslash;n&quot;
comma
id|rev
comma
id|capi_major
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|capi_exit
r_static
r_void
id|__exit
id|capi_exit
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
r_int
r_int
id|j
suffix:semicolon
macro_line|#endif
id|alloc_exit
c_func
(paren
)paren
suffix:semicolon
(paren
r_void
)paren
id|proc_exit
c_func
(paren
)paren
suffix:semicolon
id|devfs_unregister_chrdev
c_func
(paren
id|capi_major
comma
l_string|&quot;capi20&quot;
)paren
suffix:semicolon
id|devfs_unregister
c_func
(paren
id|devfs_find_handle
c_func
(paren
l_int|NULL
comma
l_string|&quot;isdn/capi20&quot;
comma
id|capi_major
comma
l_int|0
comma
id|DEVFS_SPECIAL_CHR
comma
l_int|0
)paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
id|capinc_tty_exit
c_func
(paren
)paren
suffix:semicolon
id|devfs_unregister_chrdev
c_func
(paren
id|capi_rawmajor
comma
l_string|&quot;capi/r%d&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|CAPINC_NR_PORTS
suffix:semicolon
id|j
op_increment
)paren
(brace
r_char
id|devname
(braket
l_int|32
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|devname
comma
l_string|&quot;capi/r%u&quot;
comma
id|j
)paren
suffix:semicolon
id|devfs_unregister
c_func
(paren
id|devfs_find_handle
c_func
(paren
l_int|NULL
comma
id|devname
comma
id|capi_rawmajor
comma
id|j
comma
id|DEVFS_SPECIAL_CHR
comma
l_int|0
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
(paren
r_void
)paren
id|detach_capi_interface
c_func
(paren
op_amp
id|cuser
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;capi: Rev%s: unloaded&bslash;n&quot;
comma
id|rev
)paren
suffix:semicolon
)brace
DECL|variable|capi_init
id|module_init
c_func
(paren
id|capi_init
)paren
suffix:semicolon
DECL|variable|capi_exit
id|module_exit
c_func
(paren
id|capi_exit
)paren
suffix:semicolon
eof
