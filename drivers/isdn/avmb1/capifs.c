multiline_comment|/*&n; * $Id: capifs.c,v 1.14.6.1 2000/11/28 12:02:45 kai Exp $&n; * &n; * (c) Copyright 2000 by Carsten Paeth (calle@calle.de)&n; *&n; * Heavily based on devpts filesystem from H. Peter Anvin&n; * &n; * $Log: capifs.c,v $&n; * Revision 1.14.6.1  2000/11/28 12:02:45  kai&n; * MODULE_DEVICE_TABLE for 2.4&n; *&n; * Revision 1.14.2.1  2000/11/26 17:47:53  kai&n; * added PCI_DEV_TABLE for 2.4&n; *&n; * Revision 1.14  2000/11/23 20:45:14  kai&n; * fixed module_init/exit stuff&n; * Note: compiled-in kernel doesn&squot;t work pre 2.2.18 anymore.&n; *&n; * Revision 1.13  2000/11/18 16:17:25  kai&n; * change from 2.4 tree&n; *&n; * Revision 1.12  2000/11/01 14:05:02  calle&n; * - use module_init/module_exit from linux/init.h.&n; * - all static struct variables are initialized with &quot;membername:&quot; now.&n; * - avm_cs.c, let it work with newer pcmcia-cs.&n; *&n; * Revision 1.11  2000/10/24 15:08:47  calle&n; * Too much includes.&n; *&n; * Revision 1.10  2000/10/12 10:12:35  calle&n; * Bugfix: second iput(inode) on umount, destroies a foreign inode.&n; *&n; * Revision 1.9  2000/08/20 07:30:13  keil&n; * changes for 2.4&n; *&n; * Revision 1.8  2000/07/20 10:23:13  calle&n; * Include isdn_compat.h for people that don&squot;t use -p option of std2kern.&n; *&n; * Revision 1.7  2000/06/18 16:09:54  keil&n; * more changes for 2.4&n; *&n; * Revision 1.6  2000/04/03 13:29:25  calle&n; * make Tim Waugh happy (module unload races in 2.3.99-pre3).&n; * no real problem there, but now it is much cleaner ...&n; *&n; * Revision 1.5  2000/03/13 17:49:52  calle&n; * make it running with 2.3.51.&n; *&n; * Revision 1.4  2000/03/08 17:06:33  calle&n; * - changes for devfs and 2.3.49&n; * - capifs now configurable (no need with devfs)&n; * - New Middleware ioctl CAPI_NCCI_GETUNIT&n; * - Middleware again tested with 2.2.14 and 2.3.49 (with and without devfs)&n; *&n; * Revision 1.3  2000/03/06 18:00:23  calle&n; * - Middleware extention now working with 2.3.49 (capifs).&n; * - Fixed typos in debug section of capi.c&n; * - Bugfix: Makefile corrected for b1pcmcia.c&n; *&n; * Revision 1.2  2000/03/06 09:17:07  calle&n; * - capifs: fileoperations now in inode (change for 2.3.49)&n; * - Config.in: Middleware extention not a tristate, uups.&n; *&n; * Revision 1.1  2000/03/03 16:48:38  calle&n; * - Added CAPI2.0 Middleware support (CONFIG_ISDN_CAPI)&n; *   It is now possible to create a connection with a CAPI2.0 applikation&n; *   and than to handle the data connection from /dev/capi/ (capifs) and also&n; *   using async or sync PPP on this connection.&n; *   The two major device number 190 and 191 are not confirmed yet,&n; *   but I want to save the code in cvs, before I go on.&n; *&n; *&n; */
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/param.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kdev_t.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/locks.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Carsten Paeth &lt;calle@calle.de&gt;&quot;
)paren
suffix:semicolon
DECL|variable|revision
r_static
r_char
op_star
id|revision
op_assign
l_string|&quot;$Revision: 1.14.6.1 $&quot;
suffix:semicolon
DECL|struct|capifs_ncci
r_struct
id|capifs_ncci
(brace
DECL|member|inode
r_struct
id|inode
op_star
id|inode
suffix:semicolon
DECL|member|used
r_char
id|used
suffix:semicolon
DECL|member|type
r_char
id|type
suffix:semicolon
DECL|member|num
r_int
r_int
id|num
suffix:semicolon
DECL|member|kdev
id|kdev_t
id|kdev
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|capifs_sb_info
r_struct
id|capifs_sb_info
(brace
DECL|member|magic
id|u32
id|magic
suffix:semicolon
DECL|member|next
r_struct
id|super_block
op_star
id|next
suffix:semicolon
DECL|member|back
r_struct
id|super_block
op_star
op_star
id|back
suffix:semicolon
DECL|member|setuid
r_int
id|setuid
suffix:semicolon
DECL|member|setgid
r_int
id|setgid
suffix:semicolon
DECL|member|uid
id|uid_t
id|uid
suffix:semicolon
DECL|member|gid
id|gid_t
id|gid
suffix:semicolon
DECL|member|mode
id|umode_t
id|mode
suffix:semicolon
DECL|member|max_ncci
r_int
r_int
id|max_ncci
suffix:semicolon
DECL|member|nccis
r_struct
id|capifs_ncci
op_star
id|nccis
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|CAPIFS_SUPER_MAGIC
mdefine_line|#define CAPIFS_SUPER_MAGIC ((&squot;C&squot;&lt;&lt;8)|&squot;N&squot;)
DECL|macro|CAPIFS_SBI_MAGIC
mdefine_line|#define CAPIFS_SBI_MAGIC   ((&squot;C&squot;&lt;&lt;24)|(&squot;A&squot;&lt;&lt;16)|(&squot;P&squot;&lt;&lt;8)|&squot;I&squot;)
DECL|function|SBI
r_static
r_inline
r_struct
id|capifs_sb_info
op_star
id|SBI
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_return
(paren
r_struct
id|capifs_sb_info
op_star
)paren
(paren
id|sb-&gt;u.generic_sbp
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------ */
r_static
r_int
id|capifs_root_readdir
c_func
(paren
r_struct
id|file
op_star
comma
r_void
op_star
comma
id|filldir_t
)paren
suffix:semicolon
r_static
r_struct
id|dentry
op_star
id|capifs_root_lookup
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|dentry
op_star
)paren
suffix:semicolon
r_static
r_int
id|capifs_revalidate
c_func
(paren
r_struct
id|dentry
op_star
comma
r_int
)paren
suffix:semicolon
DECL|variable|capifs_root_operations
r_static
r_struct
id|file_operations
id|capifs_root_operations
op_assign
(brace
id|read
suffix:colon
id|generic_read_dir
comma
id|readdir
suffix:colon
id|capifs_root_readdir
comma
)brace
suffix:semicolon
DECL|variable|capifs_root_inode_operations
r_struct
id|inode_operations
id|capifs_root_inode_operations
op_assign
(brace
id|lookup
suffix:colon
id|capifs_root_lookup
comma
)brace
suffix:semicolon
DECL|variable|capifs_dentry_operations
r_static
r_struct
id|dentry_operations
id|capifs_dentry_operations
op_assign
(brace
id|d_revalidate
suffix:colon
id|capifs_revalidate
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * /dev/capi/%d&n; * /dev/capi/r%d&n; */
DECL|function|capifs_root_readdir
r_static
r_int
id|capifs_root_readdir
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_void
op_star
id|dirent
comma
id|filldir_t
id|filldir
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|filp-&gt;f_dentry-&gt;d_inode
suffix:semicolon
r_struct
id|capifs_sb_info
op_star
id|sbi
op_assign
id|SBI
c_func
(paren
id|filp-&gt;f_dentry-&gt;d_inode-&gt;i_sb
)paren
suffix:semicolon
id|off_t
id|nr
suffix:semicolon
r_char
id|numbuf
(braket
l_int|32
)braket
suffix:semicolon
id|nr
op_assign
id|filp-&gt;f_pos
suffix:semicolon
r_switch
c_cond
(paren
id|nr
)paren
(brace
r_case
l_int|0
suffix:colon
r_if
c_cond
(paren
id|filldir
c_func
(paren
id|dirent
comma
l_string|&quot;.&quot;
comma
l_int|1
comma
id|nr
comma
id|inode-&gt;i_ino
comma
id|DT_DIR
)paren
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|filp-&gt;f_pos
op_assign
op_increment
id|nr
suffix:semicolon
multiline_comment|/* fall through */
r_case
l_int|1
suffix:colon
r_if
c_cond
(paren
id|filldir
c_func
(paren
id|dirent
comma
l_string|&quot;..&quot;
comma
l_int|2
comma
id|nr
comma
id|inode-&gt;i_ino
comma
id|DT_DIR
)paren
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|filp-&gt;f_pos
op_assign
op_increment
id|nr
suffix:semicolon
multiline_comment|/* fall through */
r_default
suffix:colon
(brace
)brace
r_while
c_loop
(paren
id|nr
OL
id|sbi-&gt;max_ncci
)paren
(brace
r_int
id|n
op_assign
id|nr
op_minus
l_int|2
suffix:semicolon
r_struct
id|capifs_ncci
op_star
id|np
op_assign
op_amp
id|sbi-&gt;nccis
(braket
id|n
)braket
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;inode
op_logical_and
id|np-&gt;used
)paren
(brace
r_char
op_star
id|p
op_assign
id|numbuf
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;type
)paren
op_star
id|p
op_increment
op_assign
id|np-&gt;type
suffix:semicolon
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;%u&quot;
comma
id|np-&gt;num
)paren
suffix:semicolon
r_if
c_cond
(paren
id|filldir
c_func
(paren
id|dirent
comma
id|numbuf
comma
id|strlen
c_func
(paren
id|numbuf
)paren
comma
id|nr
comma
id|nr
comma
id|DT_UNKNOWN
)paren
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
id|filp-&gt;f_pos
op_assign
op_increment
id|nr
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Revalidate is called on every cache lookup.  We use it to check that&n; * the ncci really does still exist.  Never revalidate negative dentries;&n; * for simplicity (fix later?)&n; */
DECL|function|capifs_revalidate
r_static
r_int
id|capifs_revalidate
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|flags
)paren
(brace
r_struct
id|capifs_sb_info
op_star
id|sbi
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dentry-&gt;d_inode
)paren
r_return
l_int|0
suffix:semicolon
id|sbi
op_assign
id|SBI
c_func
(paren
id|dentry-&gt;d_inode-&gt;i_sb
)paren
suffix:semicolon
r_return
(paren
id|sbi-&gt;nccis
(braket
id|dentry-&gt;d_inode-&gt;i_ino
op_minus
l_int|2
)braket
dot
id|inode
op_eq
id|dentry-&gt;d_inode
)paren
suffix:semicolon
)brace
DECL|function|capifs_root_lookup
r_static
r_struct
id|dentry
op_star
id|capifs_root_lookup
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_struct
id|capifs_sb_info
op_star
id|sbi
op_assign
id|SBI
c_func
(paren
id|dir-&gt;i_sb
)paren
suffix:semicolon
r_struct
id|capifs_ncci
op_star
id|np
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
r_char
id|numbuf
(braket
l_int|32
)braket
suffix:semicolon
r_char
op_star
id|p
comma
op_star
id|tmp
suffix:semicolon
r_int
r_int
id|num
suffix:semicolon
r_char
id|type
op_assign
l_int|0
suffix:semicolon
id|dentry-&gt;d_inode
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Assume failure */
id|dentry-&gt;d_op
op_assign
op_amp
id|capifs_dentry_operations
suffix:semicolon
r_if
c_cond
(paren
id|dentry-&gt;d_name.len
op_ge
r_sizeof
(paren
id|numbuf
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
id|strncpy
c_func
(paren
id|numbuf
comma
id|dentry-&gt;d_name.name
comma
id|dentry-&gt;d_name.len
)paren
suffix:semicolon
id|numbuf
(braket
id|dentry-&gt;d_name.len
)braket
op_assign
l_int|0
suffix:semicolon
id|p
op_assign
id|numbuf
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|isdigit
c_func
(paren
op_star
id|p
)paren
)paren
id|type
op_assign
op_star
id|p
op_increment
suffix:semicolon
id|tmp
op_assign
id|p
suffix:semicolon
id|num
op_assign
(paren
r_int
r_int
)paren
id|simple_strtoul
c_func
(paren
id|p
comma
op_amp
id|tmp
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_eq
id|p
op_logical_or
op_star
id|tmp
)paren
r_return
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|np
op_assign
id|sbi-&gt;nccis
suffix:semicolon
id|i
OL
id|sbi-&gt;max_ncci
suffix:semicolon
id|i
op_increment
comma
id|np
op_increment
)paren
(brace
r_if
c_cond
(paren
id|np-&gt;used
op_logical_and
id|np-&gt;num
op_eq
id|num
op_logical_and
id|np-&gt;type
op_eq
id|type
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ge
id|sbi-&gt;max_ncci
)paren
r_return
l_int|NULL
suffix:semicolon
id|dentry-&gt;d_inode
op_assign
id|np-&gt;inode
suffix:semicolon
r_if
c_cond
(paren
id|dentry-&gt;d_inode
)paren
id|atomic_inc
c_func
(paren
op_amp
id|dentry-&gt;d_inode-&gt;i_count
)paren
suffix:semicolon
id|d_add
c_func
(paren
id|dentry
comma
id|dentry-&gt;d_inode
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------ */
DECL|variable|mounts
r_static
r_struct
id|super_block
op_star
id|mounts
op_assign
l_int|NULL
suffix:semicolon
DECL|function|capifs_put_super
r_static
r_void
id|capifs_put_super
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_struct
id|capifs_sb_info
op_star
id|sbi
op_assign
id|SBI
c_func
(paren
id|sb
)paren
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sbi-&gt;max_ncci
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|inode
op_assign
id|sbi-&gt;nccis
(braket
id|i
)braket
dot
id|inode
)paren
)paren
(brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|inode-&gt;i_count
)paren
op_ne
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;capifs_put_super: badness: entry %d count %d&bslash;n&quot;
comma
id|i
comma
(paren
r_int
)paren
id|atomic_read
c_func
(paren
op_amp
id|inode-&gt;i_count
)paren
)paren
suffix:semicolon
id|inode-&gt;i_nlink
op_decrement
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
)brace
op_star
id|sbi-&gt;back
op_assign
id|sbi-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|sbi-&gt;next
)paren
id|SBI
c_func
(paren
id|sbi-&gt;next
)paren
op_member_access_from_pointer
id|back
op_assign
id|sbi-&gt;back
suffix:semicolon
id|kfree
c_func
(paren
id|sbi-&gt;nccis
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sbi
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,51)
id|MOD_DEC_USE_COUNT
suffix:semicolon
macro_line|#endif
)brace
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,51)
r_static
r_int
id|capifs_statfs
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|statfs
op_star
id|buf
comma
r_int
id|bufsiz
)paren
suffix:semicolon
DECL|function|capifs_write_inode
r_static
r_void
id|capifs_write_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
)brace
suffix:semicolon
macro_line|#else
r_static
r_int
id|capifs_statfs
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|statfs
op_star
id|buf
)paren
suffix:semicolon
macro_line|#endif
r_static
r_void
id|capifs_read_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
suffix:semicolon
DECL|variable|capifs_sops
r_static
r_struct
id|super_operations
id|capifs_sops
op_assign
(brace
id|read_inode
suffix:colon
id|capifs_read_inode
comma
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,51)
id|write_inode
suffix:colon
id|capifs_write_inode
comma
macro_line|#endif
id|put_super
suffix:colon
id|capifs_put_super
comma
id|statfs
suffix:colon
id|capifs_statfs
comma
)brace
suffix:semicolon
DECL|function|capifs_parse_options
r_static
r_int
id|capifs_parse_options
c_func
(paren
r_char
op_star
id|options
comma
r_struct
id|capifs_sb_info
op_star
id|sbi
)paren
(brace
r_int
id|setuid
op_assign
l_int|0
suffix:semicolon
r_int
id|setgid
op_assign
l_int|0
suffix:semicolon
id|uid_t
id|uid
op_assign
l_int|0
suffix:semicolon
id|gid_t
id|gid
op_assign
l_int|0
suffix:semicolon
id|umode_t
id|mode
op_assign
l_int|0600
suffix:semicolon
r_int
r_int
id|maxncci
op_assign
l_int|512
suffix:semicolon
r_char
op_star
id|this_char
comma
op_star
id|value
suffix:semicolon
id|this_char
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|options
)paren
id|this_char
op_assign
id|strtok
c_func
(paren
id|options
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|this_char
suffix:semicolon
id|this_char
op_assign
id|strtok
c_func
(paren
l_int|NULL
comma
l_string|&quot;,&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|value
op_assign
id|strchr
c_func
(paren
id|this_char
comma
l_char|&squot;=&squot;
)paren
)paren
op_ne
l_int|NULL
)paren
op_star
id|value
op_increment
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;uid&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
op_logical_or
op_logical_neg
op_star
id|value
)paren
r_return
l_int|1
suffix:semicolon
id|uid
op_assign
id|simple_strtoul
c_func
(paren
id|value
comma
op_amp
id|value
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|value
)paren
r_return
l_int|1
suffix:semicolon
id|setuid
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;gid&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
op_logical_or
op_logical_neg
op_star
id|value
)paren
r_return
l_int|1
suffix:semicolon
id|gid
op_assign
id|simple_strtoul
c_func
(paren
id|value
comma
op_amp
id|value
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|value
)paren
r_return
l_int|1
suffix:semicolon
id|setgid
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;mode&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
op_logical_or
op_logical_neg
op_star
id|value
)paren
r_return
l_int|1
suffix:semicolon
id|mode
op_assign
id|simple_strtoul
c_func
(paren
id|value
comma
op_amp
id|value
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|value
)paren
r_return
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;maxncci&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
op_logical_or
op_logical_neg
op_star
id|value
)paren
r_return
l_int|1
suffix:semicolon
id|maxncci
op_assign
id|simple_strtoul
c_func
(paren
id|value
comma
op_amp
id|value
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|value
)paren
r_return
l_int|1
suffix:semicolon
)brace
r_else
r_return
l_int|1
suffix:semicolon
)brace
id|sbi-&gt;setuid
op_assign
id|setuid
suffix:semicolon
id|sbi-&gt;setgid
op_assign
id|setgid
suffix:semicolon
id|sbi-&gt;uid
op_assign
id|uid
suffix:semicolon
id|sbi-&gt;gid
op_assign
id|gid
suffix:semicolon
id|sbi-&gt;mode
op_assign
id|mode
op_amp
op_complement
id|S_IFMT
suffix:semicolon
id|sbi-&gt;max_ncci
op_assign
id|maxncci
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|capifs_read_super
r_struct
id|super_block
op_star
id|capifs_read_super
c_func
(paren
r_struct
id|super_block
op_star
id|s
comma
r_void
op_star
id|data
comma
r_int
id|silent
)paren
(brace
r_struct
id|inode
op_star
id|root_inode
suffix:semicolon
r_struct
id|dentry
op_star
id|root
suffix:semicolon
r_struct
id|capifs_sb_info
op_star
id|sbi
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,51)
id|MOD_INC_USE_COUNT
suffix:semicolon
id|lock_super
c_func
(paren
id|s
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Super block already completed? */
r_if
c_cond
(paren
id|s-&gt;s_root
)paren
r_goto
id|out
suffix:semicolon
id|sbi
op_assign
(paren
r_struct
id|capifs_sb_info
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|capifs_sb_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sbi
)paren
r_goto
id|fail
suffix:semicolon
id|memset
c_func
(paren
id|sbi
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|capifs_sb_info
)paren
)paren
suffix:semicolon
id|sbi-&gt;magic
op_assign
id|CAPIFS_SBI_MAGIC
suffix:semicolon
r_if
c_cond
(paren
id|capifs_parse_options
c_func
(paren
id|data
comma
id|sbi
)paren
)paren
(brace
id|kfree
c_func
(paren
id|sbi
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;capifs: called with bogus options&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|sbi-&gt;nccis
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|capifs_ncci
)paren
op_star
id|sbi-&gt;max_ncci
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sbi-&gt;nccis
)paren
(brace
id|kfree
c_func
(paren
id|sbi
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|memset
c_func
(paren
id|sbi-&gt;nccis
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|capifs_ncci
)paren
op_star
id|sbi-&gt;max_ncci
)paren
suffix:semicolon
id|s-&gt;u.generic_sbp
op_assign
(paren
r_void
op_star
)paren
id|sbi
suffix:semicolon
id|s-&gt;s_blocksize
op_assign
l_int|1024
suffix:semicolon
id|s-&gt;s_blocksize_bits
op_assign
l_int|10
suffix:semicolon
id|s-&gt;s_magic
op_assign
id|CAPIFS_SUPER_MAGIC
suffix:semicolon
id|s-&gt;s_op
op_assign
op_amp
id|capifs_sops
suffix:semicolon
id|s-&gt;s_root
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;&t; * Get the root inode and dentry, but defer checking for errors.&n;&t; */
id|root_inode
op_assign
id|iget
c_func
(paren
id|s
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* inode 1 == root directory */
id|root
op_assign
id|d_alloc_root
c_func
(paren
id|root_inode
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Check whether somebody else completed the super block.&n;&t; */
r_if
c_cond
(paren
id|s-&gt;s_root
)paren
(brace
r_if
c_cond
(paren
id|root
)paren
id|dput
c_func
(paren
id|root
)paren
suffix:semicolon
r_else
id|iput
c_func
(paren
id|root_inode
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|root
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;capifs: get root dentry failed&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; &t;* iput() can block, so we clear the super block first.&n;&t; &t;*/
id|iput
c_func
(paren
id|root_inode
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sbi-&gt;nccis
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sbi
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Check whether somebody else completed the super block.&n;&t; */
r_if
c_cond
(paren
id|s-&gt;s_root
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/*&n;&t; * Success! Install the root dentry now to indicate completion.&n;&t; */
id|s-&gt;s_root
op_assign
id|root
suffix:semicolon
id|sbi-&gt;next
op_assign
id|mounts
suffix:semicolon
r_if
c_cond
(paren
id|sbi-&gt;next
)paren
id|SBI
c_func
(paren
id|sbi-&gt;next
)paren
op_member_access_from_pointer
id|back
op_assign
op_amp
(paren
id|sbi-&gt;next
)paren
suffix:semicolon
id|sbi-&gt;back
op_assign
op_amp
id|mounts
suffix:semicolon
id|mounts
op_assign
id|s
suffix:semicolon
id|out
suffix:colon
multiline_comment|/* Success ... somebody else completed the super block for us. */
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,51)
id|unlock_super
c_func
(paren
id|s
)paren
suffix:semicolon
macro_line|#endif
r_return
id|s
suffix:semicolon
id|fail
suffix:colon
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,51)
id|unlock_super
c_func
(paren
id|s
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
macro_line|#endif
r_return
l_int|NULL
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,51)
DECL|function|capifs_statfs
r_static
r_int
id|capifs_statfs
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|statfs
op_star
id|buf
comma
r_int
id|bufsiz
)paren
(brace
r_struct
id|statfs
id|tmp
suffix:semicolon
id|tmp.f_type
op_assign
id|CAPIFS_SUPER_MAGIC
suffix:semicolon
id|tmp.f_bsize
op_assign
l_int|1024
suffix:semicolon
id|tmp.f_blocks
op_assign
l_int|0
suffix:semicolon
id|tmp.f_bfree
op_assign
l_int|0
suffix:semicolon
id|tmp.f_bavail
op_assign
l_int|0
suffix:semicolon
id|tmp.f_files
op_assign
l_int|0
suffix:semicolon
id|tmp.f_ffree
op_assign
l_int|0
suffix:semicolon
id|tmp.f_namelen
op_assign
id|NAME_MAX
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
id|buf
comma
op_amp
id|tmp
comma
id|bufsiz
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
)brace
macro_line|#else
DECL|function|capifs_statfs
r_static
r_int
id|capifs_statfs
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|statfs
op_star
id|buf
)paren
(brace
id|buf-&gt;f_type
op_assign
id|CAPIFS_SUPER_MAGIC
suffix:semicolon
id|buf-&gt;f_bsize
op_assign
l_int|1024
suffix:semicolon
id|buf-&gt;f_blocks
op_assign
l_int|0
suffix:semicolon
id|buf-&gt;f_bfree
op_assign
l_int|0
suffix:semicolon
id|buf-&gt;f_bavail
op_assign
l_int|0
suffix:semicolon
id|buf-&gt;f_files
op_assign
l_int|0
suffix:semicolon
id|buf-&gt;f_ffree
op_assign
l_int|0
suffix:semicolon
id|buf-&gt;f_namelen
op_assign
id|NAME_MAX
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|function|capifs_read_inode
r_static
r_void
id|capifs_read_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
id|ino_t
id|ino
op_assign
id|inode-&gt;i_ino
suffix:semicolon
r_struct
id|capifs_sb_info
op_star
id|sbi
op_assign
id|SBI
c_func
(paren
id|inode-&gt;i_sb
)paren
suffix:semicolon
id|inode-&gt;i_mode
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;i_nlink
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;i_mtime
op_assign
id|inode-&gt;i_atime
op_assign
id|inode-&gt;i_ctime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|inode-&gt;i_blocks
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;i_blksize
op_assign
l_int|1024
suffix:semicolon
id|inode-&gt;i_uid
op_assign
id|inode-&gt;i_gid
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ino
op_eq
l_int|1
)paren
(brace
id|inode-&gt;i_mode
op_assign
id|S_IFDIR
op_or
id|S_IRUGO
op_or
id|S_IXUGO
op_or
id|S_IWUSR
suffix:semicolon
id|inode-&gt;i_op
op_assign
op_amp
id|capifs_root_inode_operations
suffix:semicolon
id|inode-&gt;i_fop
op_assign
op_amp
id|capifs_root_operations
suffix:semicolon
id|inode-&gt;i_nlink
op_assign
l_int|2
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ino
op_sub_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|ino
op_ge
id|sbi-&gt;max_ncci
)paren
r_return
suffix:semicolon
multiline_comment|/* Bogus */
id|init_special_inode
c_func
(paren
id|inode
comma
id|S_IFCHR
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,51)
DECL|variable|capifs_fs_type
r_static
r_struct
id|file_system_type
id|capifs_fs_type
op_assign
(brace
l_string|&quot;capifs&quot;
comma
l_int|0
comma
id|capifs_read_super
comma
l_int|NULL
)brace
suffix:semicolon
macro_line|#else
r_static
id|DECLARE_FSTYPE
c_func
(paren
id|capifs_fs_type
comma
l_string|&quot;capifs&quot;
comma
id|capifs_read_super
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
DECL|function|capifs_new_ncci
r_void
id|capifs_new_ncci
c_func
(paren
r_char
id|type
comma
r_int
r_int
id|num
comma
id|kdev_t
id|device
)paren
(brace
r_struct
id|super_block
op_star
id|sb
suffix:semicolon
r_struct
id|capifs_sb_info
op_star
id|sbi
suffix:semicolon
r_struct
id|capifs_ncci
op_star
id|np
suffix:semicolon
id|ino_t
id|ino
suffix:semicolon
r_for
c_loop
(paren
id|sb
op_assign
id|mounts
suffix:semicolon
id|sb
suffix:semicolon
id|sb
op_assign
id|sbi-&gt;next
)paren
(brace
id|sbi
op_assign
id|SBI
c_func
(paren
id|sb
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ino
op_assign
l_int|0
comma
id|np
op_assign
id|sbi-&gt;nccis
suffix:semicolon
id|ino
OL
id|sbi-&gt;max_ncci
suffix:semicolon
id|ino
op_increment
comma
id|np
op_increment
)paren
(brace
r_if
c_cond
(paren
id|np-&gt;used
op_eq
l_int|0
)paren
(brace
id|np-&gt;used
op_assign
l_int|1
suffix:semicolon
id|np-&gt;type
op_assign
id|type
suffix:semicolon
id|np-&gt;num
op_assign
id|num
suffix:semicolon
id|np-&gt;kdev
op_assign
id|device
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|np-&gt;inode
op_assign
id|iget
c_func
(paren
id|sb
comma
id|ino
op_plus
l_int|2
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|np-&gt;inode
suffix:semicolon
id|inode-&gt;i_uid
op_assign
id|sbi-&gt;setuid
ques
c_cond
id|sbi-&gt;uid
suffix:colon
id|current-&gt;fsuid
suffix:semicolon
id|inode-&gt;i_gid
op_assign
id|sbi-&gt;setgid
ques
c_cond
id|sbi-&gt;gid
suffix:colon
id|current-&gt;fsgid
suffix:semicolon
id|inode-&gt;i_mode
op_assign
id|sbi-&gt;mode
op_or
id|S_IFCHR
suffix:semicolon
id|inode-&gt;i_rdev
op_assign
id|np-&gt;kdev
suffix:semicolon
id|inode-&gt;i_nlink
op_increment
suffix:semicolon
)brace
)brace
)brace
DECL|function|capifs_free_ncci
r_void
id|capifs_free_ncci
c_func
(paren
r_char
id|type
comma
r_int
r_int
id|num
)paren
(brace
r_struct
id|super_block
op_star
id|sb
suffix:semicolon
r_struct
id|capifs_sb_info
op_star
id|sbi
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_struct
id|capifs_ncci
op_star
id|np
suffix:semicolon
id|ino_t
id|ino
suffix:semicolon
r_for
c_loop
(paren
id|sb
op_assign
id|mounts
suffix:semicolon
id|sb
suffix:semicolon
id|sb
op_assign
id|sbi-&gt;next
)paren
(brace
id|sbi
op_assign
id|SBI
c_func
(paren
id|sb
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ino
op_assign
l_int|0
comma
id|np
op_assign
id|sbi-&gt;nccis
suffix:semicolon
id|ino
OL
id|sbi-&gt;max_ncci
suffix:semicolon
id|ino
op_increment
comma
id|np
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|np-&gt;used
op_logical_or
id|np-&gt;type
op_ne
id|type
op_logical_or
id|np-&gt;num
op_ne
id|num
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;inode
)paren
(brace
id|inode
op_assign
id|np-&gt;inode
suffix:semicolon
id|np-&gt;inode
op_assign
l_int|0
suffix:semicolon
id|np-&gt;used
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;i_nlink
op_decrement
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
)brace
DECL|function|capifs_init
r_static
r_int
id|__init
id|capifs_init
c_func
(paren
r_void
)paren
(brace
r_char
id|rev
(braket
l_int|10
)braket
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_int
id|err
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
op_assign
id|strchr
c_func
(paren
id|revision
comma
l_char|&squot;:&squot;
)paren
)paren
)paren
(brace
id|strcpy
c_func
(paren
id|rev
comma
id|p
op_plus
l_int|1
)paren
suffix:semicolon
id|p
op_assign
id|strchr
c_func
(paren
id|rev
comma
l_char|&squot;$&squot;
)paren
suffix:semicolon
op_star
id|p
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|strcpy
c_func
(paren
id|rev
comma
l_string|&quot;1.0&quot;
)paren
suffix:semicolon
id|err
op_assign
id|register_filesystem
c_func
(paren
op_amp
id|capifs_fs_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;capifs: Rev%s: loaded&bslash;n&quot;
comma
id|rev
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;capifs: Rev%s: started&bslash;n&quot;
comma
id|rev
)paren
suffix:semicolon
macro_line|#endif
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|capifs_exit
r_static
r_void
id|__exit
id|capifs_exit
c_func
(paren
r_void
)paren
(brace
id|unregister_filesystem
c_func
(paren
op_amp
id|capifs_fs_type
)paren
suffix:semicolon
)brace
DECL|variable|capifs_new_ncci
id|EXPORT_SYMBOL
c_func
(paren
id|capifs_new_ncci
)paren
suffix:semicolon
DECL|variable|capifs_free_ncci
id|EXPORT_SYMBOL
c_func
(paren
id|capifs_free_ncci
)paren
suffix:semicolon
DECL|variable|capifs_init
id|module_init
c_func
(paren
id|capifs_init
)paren
suffix:semicolon
DECL|variable|capifs_exit
id|module_exit
c_func
(paren
id|capifs_exit
)paren
suffix:semicolon
eof
