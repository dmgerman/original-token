multiline_comment|/*&n; * $Id: b1capi.c,v 1.10 1998/02/13 07:09:10 calle Exp $&n; * &n; * CAPI 2.0 Module for AVM B1-card.&n; * &n; * (c) Copyright 1997 by Carsten Paeth (calle@calle.in-berlin.de)&n; * &n; * $Log: b1capi.c,v $&n; * Revision 1.10  1998/02/13 07:09:10  calle&n; * change for 2.1.86 (removing FREE_READ/FREE_WRITE from [dev]_kfree_skb()&n; *&n; * Revision 1.9  1998/01/31 11:14:39  calle&n; * merged changes to 2.0 tree, prepare 2.1.82 to work.&n; *&n; * Revision 1.8  1997/12/10 20:00:46  calle&n; * get changes from 2.0 version&n; *&n; * Revision 1.4.2.5  1997/12/07 19:59:54  calle&n; * more changes for M1/T1/B1 + config&n; *&n; * Revision 1.4.2.4  1997/11/26 16:57:20  calle&n; * more changes for B1/M1/T1.&n; *&n; * Revision 1.7  1997/10/19 14:45:40  calle&n; * fixed capi_get_version.&n; *&n; * Revision 1.6  1997/10/01 09:21:09  fritz&n; * Removed old compatibility stuff for 2.0.X kernels.&n; * From now on, this code is for 2.1.X ONLY!&n; * Old stuff is still in the separate branch.&n; *&n; * Revision 1.5  1997/07/12 08:22:26  calle&n; * Correct bug in CARD_NR macro, so now more than one card will work.&n; * Allow card reset, even if card is in running state.&n; *&n; *&n; * Revision 1.4  1997/05/27 15:17:45  fritz&n; * Added changes for recent 2.1.x kernels:&n; *   changed return type of isdn_close&n; *   queue_task_* -&gt; queue_task&n; *   clear/set_bit -&gt; test_and_... where apropriate.&n; *   changed type of hard_header_cache parameter.&n; *&n; * Revision 1.3  1997/05/18 09:24:09  calle&n; * added verbose disconnect reason reporting to avmb1.&n; * some fixes in capi20 interface.&n; * changed info messages for B1-PCI&n; *&n; * Revision 1.2  1997/03/05 21:20:41  fritz&n; * Removed include of config.h (mkdep stated this is unneded).&n; *&n; * Revision 1.1  1997/03/04 21:50:27  calle&n; * Frirst version in isdn4linux&n; *&n; * Revision 2.2  1997/02/12 09:31:39  calle&n; * new version&n; *&n; * Revision 1.1  1997/01/31 10:32:20  calle&n; * Initial revision&n; *&n; * &n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/tqueue.h&gt;
macro_line|#include &lt;linux/capi.h&gt;
macro_line|#include &lt;linux/b1lli.h&gt;
macro_line|#include &lt;linux/kernelcapi.h&gt;
macro_line|#include &quot;compat.h&quot;
macro_line|#include &quot;capicmd.h&quot;
macro_line|#include &quot;capiutil.h&quot;
DECL|variable|revision
r_static
r_char
op_star
id|revision
op_assign
l_string|&quot;$Revision: 1.10 $&quot;
suffix:semicolon
multiline_comment|/* ------------------------------------------------------------- */
DECL|variable|showcapimsgs
r_int
id|showcapimsgs
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* used in lli.c */
DECL|variable|loaddebug
r_int
id|loaddebug
op_assign
l_int|0
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Carsten Paeth &lt;calle@calle.in-berlin.de&gt;&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|showcapimsgs
comma
l_string|&quot;0-3i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|loaddebug
comma
l_string|&quot;0-1i&quot;
)paren
suffix:semicolon
multiline_comment|/* ------------------------------------------------------------- */
DECL|struct|msgidqueue
r_struct
id|msgidqueue
(brace
DECL|member|next
r_struct
id|msgidqueue
op_star
id|next
suffix:semicolon
DECL|member|msgid
id|__u16
id|msgid
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|avmb1_ncci
r_typedef
r_struct
id|avmb1_ncci
(brace
DECL|member|next
r_struct
id|avmb1_ncci
op_star
id|next
suffix:semicolon
DECL|member|applid
id|__u16
id|applid
suffix:semicolon
DECL|member|ncci
id|__u32
id|ncci
suffix:semicolon
DECL|member|winsize
id|__u32
id|winsize
suffix:semicolon
DECL|member|msgidqueue
r_struct
id|msgidqueue
op_star
id|msgidqueue
suffix:semicolon
DECL|member|msgidlast
r_struct
id|msgidqueue
op_star
id|msgidlast
suffix:semicolon
DECL|member|msgidfree
r_struct
id|msgidqueue
op_star
id|msgidfree
suffix:semicolon
DECL|member|msgidpool
r_struct
id|msgidqueue
id|msgidpool
(braket
id|CAPI_MAXDATAWINDOW
)braket
suffix:semicolon
DECL|typedef|avmb1_ncci
)brace
id|avmb1_ncci
suffix:semicolon
DECL|struct|avmb1_appl
r_typedef
r_struct
id|avmb1_appl
(brace
DECL|member|applid
id|__u16
id|applid
suffix:semicolon
DECL|member|rparam
id|capi_register_params
id|rparam
suffix:semicolon
DECL|member|releasing
r_int
id|releasing
suffix:semicolon
DECL|member|param
id|__u32
id|param
suffix:semicolon
DECL|member|signal
r_void
(paren
op_star
id|signal
)paren
(paren
id|__u16
id|applid
comma
id|__u32
id|param
)paren
suffix:semicolon
DECL|member|recv_queue
r_struct
id|sk_buff_head
id|recv_queue
suffix:semicolon
DECL|member|nccilist
r_struct
id|avmb1_ncci
op_star
id|nccilist
suffix:semicolon
DECL|typedef|avmb1_appl
)brace
id|avmb1_appl
suffix:semicolon
multiline_comment|/* ------------------------------------------------------------- */
DECL|variable|driver_version
r_static
r_struct
id|capi_version
id|driver_version
op_assign
(brace
l_int|2
comma
l_int|0
comma
l_int|1
comma
l_int|1
op_lshift
l_int|4
)brace
suffix:semicolon
DECL|variable|driver_serial
r_static
r_char
id|driver_serial
(braket
id|CAPI_SERIAL_LEN
)braket
op_assign
l_string|&quot;4711&quot;
suffix:semicolon
DECL|variable|capi_manufakturer
r_static
r_char
id|capi_manufakturer
(braket
l_int|64
)braket
op_assign
l_string|&quot;AVM Berlin&quot;
suffix:semicolon
DECL|macro|APPL
mdefine_line|#define APPL(a)&t;&t;   (&amp;applications[(a)-1])
DECL|macro|VALID_APPLID
mdefine_line|#define&t;VALID_APPLID(a)&t;   ((a) &amp;&amp; (a) &lt;= CAPI_MAXAPPL &amp;&amp; APPL(a)-&gt;applid == a)
DECL|macro|APPL_IS_FREE
mdefine_line|#define APPL_IS_FREE(a)    (APPL(a)-&gt;applid == 0)
DECL|macro|APPL_MARK_FREE
mdefine_line|#define APPL_MARK_FREE(a)  do{ APPL(a)-&gt;applid=0; MOD_DEC_USE_COUNT; }while(0);
DECL|macro|APPL_MARK_USED
mdefine_line|#define APPL_MARK_USED(a)  do{ APPL(a)-&gt;applid=(a); MOD_INC_USE_COUNT; }while(0);
DECL|macro|NCCI2CTRL
mdefine_line|#define NCCI2CTRL(ncci)    (((ncci) &gt;&gt; 24) &amp; 0x7f)
DECL|macro|VALID_CARD
mdefine_line|#define VALID_CARD(c)&t;   ((c) &gt; 0 &amp;&amp; (c) &lt;= CAPI_MAXCONTR)
DECL|macro|CARD
mdefine_line|#define CARD(c)&t;&t;   (&amp;cards[(c)-1])
DECL|macro|CARDNR
mdefine_line|#define CARDNR(cp)&t;   (((cp)-cards)+1)
DECL|variable|applications
r_static
id|avmb1_appl
id|applications
(braket
id|CAPI_MAXAPPL
)braket
suffix:semicolon
DECL|variable|cards
r_static
id|avmb1_card
id|cards
(braket
id|CAPI_MAXCONTR
)braket
suffix:semicolon
DECL|variable|ncards
r_static
r_int
id|ncards
op_assign
l_int|0
suffix:semicolon
DECL|variable|recv_queue
r_static
r_struct
id|sk_buff_head
id|recv_queue
suffix:semicolon
DECL|variable|capi_users
r_static
r_struct
id|capi_interface_user
op_star
id|capi_users
op_assign
l_int|0
suffix:semicolon
DECL|variable|notify_up_set
r_static
r_int
id|notify_up_set
op_assign
l_int|0
suffix:semicolon
DECL|variable|notify_down_set
r_static
r_int
id|notify_down_set
op_assign
l_int|0
suffix:semicolon
DECL|variable|tq_state_notify
r_static
r_struct
id|tq_struct
id|tq_state_notify
suffix:semicolon
DECL|variable|tq_recv_notify
r_static
r_struct
id|tq_struct
id|tq_recv_notify
suffix:semicolon
multiline_comment|/* -------- util functions ------------------------------------ */
DECL|function|cardtype2str
r_static
r_char
op_star
id|cardtype2str
c_func
(paren
r_int
id|cardtype
)paren
(brace
r_switch
c_cond
(paren
id|cardtype
)paren
(brace
r_default
suffix:colon
r_case
id|AVM_CARDTYPE_B1
suffix:colon
r_return
l_string|&quot;B1&quot;
suffix:semicolon
r_case
id|AVM_CARDTYPE_M1
suffix:colon
r_return
l_string|&quot;M1&quot;
suffix:semicolon
r_case
id|AVM_CARDTYPE_M2
suffix:colon
r_return
l_string|&quot;M2&quot;
suffix:semicolon
r_case
id|AVM_CARDTYPE_T1
suffix:colon
r_return
l_string|&quot;T1&quot;
suffix:semicolon
)brace
)brace
DECL|function|capi_cmd_valid
r_static
r_inline
r_int
id|capi_cmd_valid
c_func
(paren
id|__u8
id|cmd
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|CAPI_ALERT
suffix:colon
r_case
id|CAPI_CONNECT
suffix:colon
r_case
id|CAPI_CONNECT_ACTIVE
suffix:colon
r_case
id|CAPI_CONNECT_B3_ACTIVE
suffix:colon
r_case
id|CAPI_CONNECT_B3
suffix:colon
r_case
id|CAPI_CONNECT_B3_T90_ACTIVE
suffix:colon
r_case
id|CAPI_DATA_B3
suffix:colon
r_case
id|CAPI_DISCONNECT_B3
suffix:colon
r_case
id|CAPI_DISCONNECT
suffix:colon
r_case
id|CAPI_FACILITY
suffix:colon
r_case
id|CAPI_INFO
suffix:colon
r_case
id|CAPI_LISTEN
suffix:colon
r_case
id|CAPI_MANUFACTURER
suffix:colon
r_case
id|CAPI_RESET_B3
suffix:colon
r_case
id|CAPI_SELECT_B_PROTOCOL
suffix:colon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|capi_subcmd_valid
r_static
r_inline
r_int
id|capi_subcmd_valid
c_func
(paren
id|__u8
id|subcmd
)paren
(brace
r_switch
c_cond
(paren
id|subcmd
)paren
(brace
r_case
id|CAPI_REQ
suffix:colon
r_case
id|CAPI_CONF
suffix:colon
r_case
id|CAPI_IND
suffix:colon
r_case
id|CAPI_RESP
suffix:colon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* -------- NCCI Handling ------------------------------------- */
DECL|function|mq_init
r_static
r_inline
r_void
id|mq_init
c_func
(paren
id|avmb1_ncci
op_star
id|np
)paren
(brace
r_int
id|i
suffix:semicolon
id|np-&gt;msgidqueue
op_assign
l_int|0
suffix:semicolon
id|np-&gt;msgidlast
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|np-&gt;msgidpool
comma
l_int|0
comma
r_sizeof
(paren
id|np-&gt;msgidpool
)paren
)paren
suffix:semicolon
id|np-&gt;msgidfree
op_assign
op_amp
id|np-&gt;msgidpool
(braket
l_int|0
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|np-&gt;winsize
suffix:semicolon
id|i
op_increment
)paren
(brace
id|np-&gt;msgidpool
(braket
id|i
)braket
dot
id|next
op_assign
id|np-&gt;msgidfree
suffix:semicolon
id|np-&gt;msgidfree
op_assign
op_amp
id|np-&gt;msgidpool
(braket
id|i
)braket
suffix:semicolon
)brace
)brace
DECL|function|mq_enqueue
r_static
r_inline
r_int
id|mq_enqueue
c_func
(paren
id|avmb1_ncci
op_star
id|np
comma
id|__u16
id|msgid
)paren
(brace
r_struct
id|msgidqueue
op_star
id|mq
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mq
op_assign
id|np-&gt;msgidfree
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|np-&gt;msgidfree
op_assign
id|mq-&gt;next
suffix:semicolon
id|mq-&gt;msgid
op_assign
id|msgid
suffix:semicolon
id|mq-&gt;next
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;msgidlast
)paren
id|np-&gt;msgidlast-&gt;next
op_assign
id|mq
suffix:semicolon
id|np-&gt;msgidlast
op_assign
id|mq
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|np-&gt;msgidqueue
)paren
id|np-&gt;msgidqueue
op_assign
id|mq
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|mq_dequeue
r_static
r_inline
r_int
id|mq_dequeue
c_func
(paren
id|avmb1_ncci
op_star
id|np
comma
id|__u16
id|msgid
)paren
(brace
r_struct
id|msgidqueue
op_star
op_star
id|pp
suffix:semicolon
r_for
c_loop
(paren
id|pp
op_assign
op_amp
id|np-&gt;msgidqueue
suffix:semicolon
op_star
id|pp
suffix:semicolon
id|pp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|msgid
op_eq
id|msgid
)paren
(brace
r_struct
id|msgidqueue
op_star
id|mq
op_assign
op_star
id|pp
suffix:semicolon
op_star
id|pp
op_assign
id|mq-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|mq
op_eq
id|np-&gt;msgidlast
)paren
id|np-&gt;msgidlast
op_assign
l_int|0
suffix:semicolon
id|mq-&gt;next
op_assign
id|np-&gt;msgidfree
suffix:semicolon
id|np-&gt;msgidfree
op_assign
id|mq
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|avmb1_handle_new_ncci
r_void
id|avmb1_handle_new_ncci
c_func
(paren
id|avmb1_card
op_star
id|card
comma
id|__u16
id|appl
comma
id|__u32
id|ncci
comma
id|__u32
id|winsize
)paren
(brace
id|avmb1_ncci
op_star
id|np
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|VALID_APPLID
c_func
(paren
id|appl
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;avmb1_handle_new_ncci: illegal appl %d&bslash;n&quot;
comma
id|appl
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|np
op_assign
(paren
id|avmb1_ncci
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|avmb1_ncci
)paren
comma
id|GFP_ATOMIC
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;avmb1_handle_new_ncci: alloc failed ncci 0x%x&bslash;n&quot;
comma
id|ncci
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|winsize
OG
id|CAPI_MAXDATAWINDOW
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;avmb1_handle_new_ncci: winsize %d too big, set to %d&bslash;n&quot;
comma
id|winsize
comma
id|CAPI_MAXDATAWINDOW
)paren
suffix:semicolon
id|winsize
op_assign
id|CAPI_MAXDATAWINDOW
suffix:semicolon
)brace
id|np-&gt;applid
op_assign
id|appl
suffix:semicolon
id|np-&gt;ncci
op_assign
id|ncci
suffix:semicolon
id|np-&gt;winsize
op_assign
id|winsize
suffix:semicolon
id|mq_init
c_func
(paren
id|np
)paren
suffix:semicolon
id|np-&gt;next
op_assign
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|nccilist
suffix:semicolon
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|nccilist
op_assign
id|np
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;b1capi: appl %d ncci 0x%x up&bslash;n&quot;
comma
id|appl
comma
id|ncci
)paren
suffix:semicolon
)brace
DECL|function|avmb1_handle_free_ncci
r_void
id|avmb1_handle_free_ncci
c_func
(paren
id|avmb1_card
op_star
id|card
comma
id|__u16
id|appl
comma
id|__u32
id|ncci
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|VALID_APPLID
c_func
(paren
id|appl
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;avmb1_handle_free_ncci: illegal appl %d&bslash;n&quot;
comma
id|appl
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ncci
op_ne
l_int|0xffffffff
)paren
(brace
id|avmb1_ncci
op_star
op_star
id|pp
suffix:semicolon
r_for
c_loop
(paren
id|pp
op_assign
op_amp
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|nccilist
suffix:semicolon
op_star
id|pp
suffix:semicolon
id|pp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|ncci
op_eq
id|ncci
)paren
(brace
id|avmb1_ncci
op_star
id|np
op_assign
op_star
id|pp
suffix:semicolon
op_star
id|pp
op_assign
id|np-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|np
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;b1capi: appl %d ncci 0x%x down&bslash;n&quot;
comma
id|appl
comma
id|ncci
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;avmb1_handle_free_ncci: ncci 0x%x not found&bslash;n&quot;
comma
id|ncci
)paren
suffix:semicolon
)brace
r_else
(brace
id|avmb1_ncci
op_star
op_star
id|pp
comma
op_star
op_star
id|nextpp
suffix:semicolon
r_for
c_loop
(paren
id|pp
op_assign
op_amp
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|nccilist
suffix:semicolon
op_star
id|pp
suffix:semicolon
id|pp
op_assign
id|nextpp
)paren
(brace
r_if
c_cond
(paren
id|NCCI2CTRL
c_func
(paren
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|ncci
)paren
op_eq
id|card-&gt;cnr
)paren
(brace
id|avmb1_ncci
op_star
id|np
op_assign
op_star
id|pp
suffix:semicolon
op_star
id|pp
op_assign
id|np-&gt;next
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;b1capi: appl %d ncci 0x%x down!&bslash;n&quot;
comma
id|appl
comma
id|np-&gt;ncci
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|np
)paren
suffix:semicolon
id|nextpp
op_assign
id|pp
suffix:semicolon
)brace
r_else
(brace
id|nextpp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
)brace
)brace
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|releasing
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|releasing
op_eq
l_int|0
)paren
(brace
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|signal
op_assign
l_int|0
suffix:semicolon
id|APPL_MARK_FREE
c_func
(paren
id|appl
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;b1capi: appl %d down&bslash;n&quot;
comma
id|appl
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|find_ncci
r_static
id|avmb1_ncci
op_star
id|find_ncci
c_func
(paren
id|avmb1_appl
op_star
id|app
comma
id|__u32
id|ncci
)paren
(brace
id|avmb1_ncci
op_star
id|np
suffix:semicolon
r_for
c_loop
(paren
id|np
op_assign
id|app-&gt;nccilist
suffix:semicolon
id|np
suffix:semicolon
id|np
op_assign
id|np-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|np-&gt;ncci
op_eq
id|ncci
)paren
r_return
id|np
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* -------- Receiver ------------------------------------------ */
DECL|function|recv_handler
r_static
r_void
id|recv_handler
c_func
(paren
r_void
op_star
id|dummy
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|recv_queue
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|__u16
id|appl
op_assign
id|CAPIMSG_APPID
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
r_struct
id|avmb1_ncci
op_star
id|np
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|VALID_APPLID
c_func
(paren
id|appl
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;b1capi: recv_handler: applid %d ? (%s)&bslash;n&quot;
comma
id|appl
comma
id|capi_message2str
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|signal
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;b1capi: recv_handler: applid %d has no signal function&bslash;n&quot;
comma
id|appl
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CAPIMSG_COMMAND
c_func
(paren
id|skb-&gt;data
)paren
op_eq
id|CAPI_DATA_B3
op_logical_and
id|CAPIMSG_SUBCOMMAND
c_func
(paren
id|skb-&gt;data
)paren
op_eq
id|CAPI_CONF
op_logical_and
(paren
id|np
op_assign
id|find_ncci
c_func
(paren
id|APPL
c_func
(paren
id|appl
)paren
comma
id|CAPIMSG_NCCI
c_func
(paren
id|skb-&gt;data
)paren
)paren
)paren
op_ne
l_int|0
op_logical_and
id|mq_dequeue
c_func
(paren
id|np
comma
id|CAPIMSG_MSGID
c_func
(paren
id|skb-&gt;data
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;b1capi: msgid %hu ncci 0x%x not on queue&bslash;n&quot;
comma
id|CAPIMSG_MSGID
c_func
(paren
id|skb-&gt;data
)paren
comma
id|np-&gt;ncci
)paren
suffix:semicolon
)brace
id|skb_queue_tail
c_func
(paren
op_amp
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|recv_queue
comma
id|skb
)paren
suffix:semicolon
(paren
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|signal
)paren
(paren
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|applid
comma
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|param
)paren
suffix:semicolon
)brace
)brace
DECL|function|avmb1_handle_capimsg
r_void
id|avmb1_handle_capimsg
c_func
(paren
id|avmb1_card
op_star
id|card
comma
id|__u16
id|appl
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;cardstate
op_ne
id|CARD_RUNNING
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;b1capi: controller %d not active, got: %s&quot;
comma
id|card-&gt;cnr
comma
id|capi_message2str
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb_queue_tail
c_func
(paren
op_amp
id|recv_queue
comma
id|skb
)paren
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|tq_recv_notify
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
r_return
suffix:semicolon
id|error
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
DECL|function|avmb1_interrupt
r_void
id|avmb1_interrupt
c_func
(paren
r_int
id|interrupt
comma
r_void
op_star
id|devptr
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|avmb1_card
op_star
id|card
suffix:semicolon
id|card
op_assign
(paren
id|avmb1_card
op_star
)paren
id|devptr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;avmb1_interrupt: wrong device&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;interrupt
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;avmb1_interrupt: reentering interrupt hander&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|card-&gt;interrupt
op_assign
l_int|1
suffix:semicolon
id|B1_handle_interrupt
c_func
(paren
id|card
)paren
suffix:semicolon
id|card-&gt;interrupt
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* -------- Notifier ------------------------------------------ */
DECL|function|notify_up
r_static
r_void
id|notify_up
c_func
(paren
id|__u16
id|contr
)paren
(brace
r_struct
id|capi_interface_user
op_star
id|p
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;b1capi: notify up contr %d&bslash;n&quot;
comma
id|contr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|capi_users
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;callback
)paren
(paren
op_star
id|p-&gt;callback
)paren
(paren
id|KCI_CONTRUP
comma
id|contr
comma
(paren
id|capi_profile
op_star
)paren
id|CARD
c_func
(paren
id|contr
)paren
op_member_access_from_pointer
id|version
(braket
id|VER_PROFILE
)braket
)paren
suffix:semicolon
)brace
)brace
DECL|function|notify_down
r_static
r_void
id|notify_down
c_func
(paren
id|__u16
id|contr
)paren
(brace
r_struct
id|capi_interface_user
op_star
id|p
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;b1capi: notify down contr %d&bslash;n&quot;
comma
id|contr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|capi_users
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;callback
)paren
(paren
op_star
id|p-&gt;callback
)paren
(paren
id|KCI_CONTRDOWN
comma
id|contr
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
DECL|function|notify_handler
r_static
r_void
id|notify_handler
c_func
(paren
r_void
op_star
id|dummy
)paren
(brace
id|__u16
id|contr
suffix:semicolon
r_for
c_loop
(paren
id|contr
op_assign
l_int|1
suffix:semicolon
id|VALID_CARD
c_func
(paren
id|contr
)paren
suffix:semicolon
id|contr
op_increment
)paren
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|contr
comma
op_amp
id|notify_up_set
)paren
)paren
id|notify_up
c_func
(paren
id|contr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|contr
op_assign
l_int|1
suffix:semicolon
id|VALID_CARD
c_func
(paren
id|contr
)paren
suffix:semicolon
id|contr
op_increment
)paren
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|contr
comma
op_amp
id|notify_down_set
)paren
)paren
id|notify_down
c_func
(paren
id|contr
)paren
suffix:semicolon
)brace
multiline_comment|/* -------- card ready callback ------------------------------- */
DECL|function|avmb1_card_ready
r_void
id|avmb1_card_ready
c_func
(paren
id|avmb1_card
op_star
id|card
)paren
(brace
r_struct
id|capi_profile
op_star
id|profp
op_assign
(paren
r_struct
id|capi_profile
op_star
)paren
id|card-&gt;version
(braket
id|VER_PROFILE
)braket
suffix:semicolon
r_char
op_star
id|dversion
op_assign
id|card-&gt;version
(braket
id|VER_DRIVER
)braket
suffix:semicolon
id|__u16
id|appl
suffix:semicolon
r_char
op_star
id|cardname
comma
id|cname
(braket
l_int|20
)braket
suffix:semicolon
id|__u32
id|flag
suffix:semicolon
id|card-&gt;cversion.majorversion
op_assign
l_int|2
suffix:semicolon
id|card-&gt;cversion.minorversion
op_assign
l_int|0
suffix:semicolon
id|card-&gt;cversion.majormanuversion
op_assign
(paren
(paren
(paren
id|dversion
(braket
l_int|0
)braket
op_minus
l_char|&squot;0&squot;
)paren
op_amp
l_int|0xf
)paren
op_lshift
l_int|4
)paren
suffix:semicolon
id|card-&gt;cversion.majormanuversion
op_or_assign
(paren
(paren
id|dversion
(braket
l_int|2
)braket
op_minus
l_char|&squot;0&squot;
)paren
op_amp
l_int|0xf
)paren
suffix:semicolon
id|card-&gt;cversion.minormanuversion
op_assign
(paren
id|dversion
(braket
l_int|3
)braket
op_minus
l_char|&squot;0&squot;
)paren
op_lshift
l_int|4
suffix:semicolon
id|card-&gt;cversion.minormanuversion
op_or_assign
(paren
id|dversion
(braket
l_int|5
)braket
op_minus
l_char|&squot;0&squot;
)paren
op_star
l_int|10
op_plus
(paren
(paren
id|dversion
(braket
l_int|6
)braket
op_minus
l_char|&squot;0&squot;
)paren
op_amp
l_int|0xf
)paren
suffix:semicolon
id|card-&gt;cardstate
op_assign
id|CARD_RUNNING
suffix:semicolon
r_for
c_loop
(paren
id|appl
op_assign
l_int|1
suffix:semicolon
id|appl
op_le
id|CAPI_MAXAPPL
suffix:semicolon
id|appl
op_increment
)paren
(brace
r_if
c_cond
(paren
id|VALID_APPLID
c_func
(paren
id|appl
)paren
op_logical_and
op_logical_neg
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|releasing
)paren
(brace
id|B1_send_register
c_func
(paren
id|card-&gt;port
comma
id|appl
comma
l_int|1024
op_star
(paren
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|rparam.level3cnt
op_plus
l_int|1
)paren
comma
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|rparam.level3cnt
comma
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|rparam.datablkcnt
comma
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|rparam.datablklen
)paren
suffix:semicolon
)brace
)brace
id|set_bit
c_func
(paren
id|CARDNR
c_func
(paren
id|card
)paren
comma
op_amp
id|notify_up_set
)paren
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|tq_state_notify
comma
op_amp
id|tq_scheduler
)paren
suffix:semicolon
id|flag
op_assign
(paren
(paren
id|__u8
op_star
)paren
(paren
id|profp-&gt;manu
)paren
)paren
(braket
l_int|1
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|flag
)paren
(brace
r_case
l_int|0
suffix:colon
id|cardname
op_assign
id|cardtype2str
c_func
(paren
id|card-&gt;cardtype
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|cardname
op_assign
l_string|&quot;PCMCIA B&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|cardname
op_assign
l_string|&quot;PCMCIA M1&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|cardname
op_assign
l_string|&quot;PCMCIA M2&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|cardname
op_assign
l_string|&quot;B1 V3.0&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|cardname
op_assign
l_string|&quot;B1 PCI&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|cardname
op_assign
id|cname
suffix:semicolon
r_break
suffix:semicolon
id|sprintf
c_func
(paren
id|cname
comma
l_string|&quot;AVM?%u&quot;
comma
(paren
r_int
r_int
)paren
id|flag
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;b1capi: card %d &bslash;&quot;%s&bslash;&quot; ready.&bslash;n&quot;
comma
id|CARDNR
c_func
(paren
id|card
)paren
comma
id|cardname
)paren
suffix:semicolon
id|flag
op_assign
(paren
(paren
id|__u8
op_star
)paren
(paren
id|profp-&gt;manu
)paren
)paren
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|flag
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;b1capi: card %d Protocol:%s%s%s%s%s%s%s&bslash;n&quot;
comma
id|CARDNR
c_func
(paren
id|card
)paren
comma
(paren
id|flag
op_amp
l_int|0x01
)paren
ques
c_cond
l_string|&quot; DSS1&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|flag
op_amp
l_int|0x02
)paren
ques
c_cond
l_string|&quot; CT1&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|flag
op_amp
l_int|0x04
)paren
ques
c_cond
l_string|&quot; VN3&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|flag
op_amp
l_int|0x08
)paren
ques
c_cond
l_string|&quot; NI1&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|flag
op_amp
l_int|0x10
)paren
ques
c_cond
l_string|&quot; AUSTEL&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|flag
op_amp
l_int|0x20
)paren
ques
c_cond
l_string|&quot; ESS&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|flag
op_amp
l_int|0x40
)paren
ques
c_cond
l_string|&quot; 1TR6&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|flag
op_assign
(paren
(paren
id|__u8
op_star
)paren
(paren
id|profp-&gt;manu
)paren
)paren
(braket
l_int|5
)braket
suffix:semicolon
r_if
c_cond
(paren
id|flag
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;b1capi: card %d Linetype:%s%s%s%s&bslash;n&quot;
comma
id|CARDNR
c_func
(paren
id|card
)paren
comma
(paren
id|flag
op_amp
l_int|0x01
)paren
ques
c_cond
l_string|&quot; point to point&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|flag
op_amp
l_int|0x02
)paren
ques
c_cond
l_string|&quot; point to multipoint&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|flag
op_amp
l_int|0x08
)paren
ques
c_cond
l_string|&quot; leased line without D-channel&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|flag
op_amp
l_int|0x04
)paren
ques
c_cond
l_string|&quot; leased line with D-channel&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
DECL|function|avmb1_card_down
r_static
r_void
id|avmb1_card_down
c_func
(paren
id|avmb1_card
op_star
id|card
comma
r_int
id|notify
)paren
(brace
id|__u16
id|appl
suffix:semicolon
id|card-&gt;cardstate
op_assign
id|CARD_DETECTED
suffix:semicolon
r_for
c_loop
(paren
id|appl
op_assign
l_int|1
suffix:semicolon
id|appl
op_le
id|CAPI_MAXAPPL
suffix:semicolon
id|appl
op_increment
)paren
(brace
id|avmb1_ncci
op_star
op_star
id|pp
comma
op_star
op_star
id|nextpp
suffix:semicolon
r_for
c_loop
(paren
id|pp
op_assign
op_amp
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|nccilist
suffix:semicolon
op_star
id|pp
suffix:semicolon
id|pp
op_assign
id|nextpp
)paren
(brace
r_if
c_cond
(paren
id|NCCI2CTRL
c_func
(paren
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|ncci
)paren
op_eq
id|card-&gt;cnr
)paren
(brace
id|avmb1_ncci
op_star
id|np
op_assign
op_star
id|pp
suffix:semicolon
op_star
id|pp
op_assign
id|np-&gt;next
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;b1capi: appl %d ncci 0x%x forced down!&bslash;n&quot;
comma
id|appl
comma
id|np-&gt;ncci
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|np
)paren
suffix:semicolon
id|nextpp
op_assign
id|pp
suffix:semicolon
)brace
r_else
(brace
id|nextpp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
)brace
)brace
)brace
id|set_bit
c_func
(paren
id|CARDNR
c_func
(paren
id|card
)paren
comma
op_amp
id|notify_down_set
)paren
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|tq_state_notify
comma
op_amp
id|tq_scheduler
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;b1capi: card %d down.&bslash;n&quot;
comma
id|CARDNR
c_func
(paren
id|card
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------- */
DECL|function|avmb1_registercard
r_int
id|avmb1_registercard
c_func
(paren
r_int
id|port
comma
r_int
id|irq
comma
r_int
id|cardtype
comma
r_int
id|allocio
)paren
(brace
r_struct
id|avmb1_card
op_star
id|card
suffix:semicolon
r_int
id|irqval
comma
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CAPI_MAXCONTR
op_logical_and
id|cards
(braket
id|i
)braket
dot
id|cardstate
op_ne
id|CARD_FREE
suffix:semicolon
id|i
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|CAPI_MAXCONTR
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;b1capi: out of controller slots&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENFILE
suffix:semicolon
)brace
id|card
op_assign
op_amp
id|cards
(braket
id|i
)braket
suffix:semicolon
id|memset
c_func
(paren
id|card
comma
l_int|0
comma
r_sizeof
(paren
id|avmb1_card
)paren
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|card-&gt;name
comma
l_string|&quot;avmb1-%d&quot;
comma
id|CARDNR
c_func
(paren
id|card
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|allocio
)paren
id|request_region
c_func
(paren
id|port
comma
id|AVMB1_PORTLEN
comma
id|card-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|irqval
op_assign
id|request_irq
c_func
(paren
id|irq
comma
id|avmb1_interrupt
comma
id|SA_SHIRQ
comma
id|card-&gt;name
comma
id|card
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;b1capi: unable to get IRQ %d (irqval=%d).&bslash;n&quot;
comma
id|irq
comma
id|irqval
)paren
suffix:semicolon
id|release_region
c_func
(paren
(paren
r_int
r_int
)paren
id|port
comma
id|AVMB1_PORTLEN
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|card-&gt;cardstate
op_assign
id|CARD_DETECTED
suffix:semicolon
id|ncards
op_increment
suffix:semicolon
id|card-&gt;cnr
op_assign
id|CARDNR
c_func
(paren
id|card
)paren
suffix:semicolon
id|card-&gt;port
op_assign
id|port
suffix:semicolon
id|card-&gt;irq
op_assign
id|irq
suffix:semicolon
id|card-&gt;cardtype
op_assign
id|cardtype
suffix:semicolon
r_return
id|card-&gt;cnr
suffix:semicolon
)brace
DECL|function|avmb1_addcard
r_int
id|avmb1_addcard
c_func
(paren
r_int
id|port
comma
r_int
id|irq
comma
r_int
id|cardtype
)paren
(brace
r_return
id|avmb1_registercard
c_func
(paren
id|port
comma
id|irq
comma
id|cardtype
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|avmb1_detectcard
r_int
id|avmb1_detectcard
c_func
(paren
r_int
id|port
comma
r_int
id|irq
comma
r_int
id|cardtype
)paren
(brace
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|B1_valid_irq
c_func
(paren
id|irq
comma
id|cardtype
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;b1capi: irq %d not valid for %s-card.&bslash;n&quot;
comma
id|irq
comma
id|cardtype2str
c_func
(paren
id|cardtype
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|B1_detect
c_func
(paren
id|port
comma
id|cardtype
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;b1capi: NO %s-card at 0x%x (%d)&bslash;n&quot;
comma
id|cardtype2str
c_func
(paren
id|cardtype
)paren
comma
id|port
comma
id|rc
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|B1_reset
c_func
(paren
id|port
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cardtype
)paren
(brace
r_default
suffix:colon
r_case
id|AVM_CARDTYPE_M1
suffix:colon
r_case
id|AVM_CARDTYPE_M2
suffix:colon
r_case
id|AVM_CARDTYPE_B1
suffix:colon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;b1capi: AVM-%s-Controller detected at 0x%x&bslash;n&quot;
comma
id|cardtype2str
c_func
(paren
id|cardtype
)paren
comma
id|port
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AVM_CARDTYPE_T1
suffix:colon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;b1capi: AVM-%s-Controller may be at 0x%x&bslash;n&quot;
comma
id|cardtype2str
c_func
(paren
id|cardtype
)paren
comma
id|port
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|avmb1_probecard
r_int
id|avmb1_probecard
c_func
(paren
r_int
id|port
comma
r_int
id|irq
comma
r_int
id|cardtype
)paren
(brace
r_if
c_cond
(paren
id|check_region
c_func
(paren
(paren
r_int
r_int
)paren
id|port
comma
id|AVMB1_PORTLEN
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;b1capi: ports 0x%03x-0x%03x in use.&bslash;n&quot;
comma
id|port
comma
id|port
op_plus
id|AVMB1_PORTLEN
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
id|avmb1_detectcard
c_func
(paren
id|port
comma
id|irq
comma
id|cardtype
)paren
suffix:semicolon
)brace
DECL|function|avmb1_unregistercard
r_int
id|avmb1_unregistercard
c_func
(paren
r_int
id|cnr
comma
r_int
id|freeio
)paren
(brace
id|avmb1_card
op_star
id|card
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|VALID_CARD
c_func
(paren
id|cnr
)paren
)paren
r_return
op_minus
id|ESRCH
suffix:semicolon
id|card
op_assign
id|CARD
c_func
(paren
id|cnr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;cardstate
op_eq
id|CARD_FREE
)paren
r_return
op_minus
id|ESRCH
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;cardstate
op_eq
id|CARD_RUNNING
)paren
id|avmb1_card_down
c_func
(paren
id|card
comma
id|freeio
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|card-&gt;irq
comma
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|freeio
)paren
id|release_region
c_func
(paren
id|card-&gt;port
comma
id|AVMB1_PORTLEN
)paren
suffix:semicolon
id|card-&gt;cardstate
op_assign
id|CARD_FREE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|avmb1_resetcard
r_int
id|avmb1_resetcard
c_func
(paren
r_int
id|cnr
)paren
(brace
id|avmb1_card
op_star
id|card
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|VALID_CARD
c_func
(paren
id|cnr
)paren
)paren
r_return
op_minus
id|ESRCH
suffix:semicolon
id|card
op_assign
id|CARD
c_func
(paren
id|cnr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;cardstate
op_eq
id|CARD_FREE
)paren
r_return
op_minus
id|ESRCH
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;cardstate
op_eq
id|CARD_RUNNING
)paren
id|avmb1_card_down
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
id|B1_reset
c_func
(paren
id|card-&gt;port
)paren
suffix:semicolon
id|B1_reset
c_func
(paren
id|card-&gt;port
)paren
suffix:semicolon
id|card-&gt;cardstate
op_assign
id|CARD_DETECTED
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------- */
multiline_comment|/* -------- CAPI2.0 Interface ---------------------------------- */
multiline_comment|/* ------------------------------------------------------------- */
DECL|function|capi_installed
r_static
r_int
id|capi_installed
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CAPI_MAXCONTR
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cards
(braket
id|i
)braket
dot
id|cardstate
op_eq
id|CARD_RUNNING
)paren
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|capi_register
r_static
id|__u16
id|capi_register
c_func
(paren
id|capi_register_params
op_star
id|rparam
comma
id|__u16
op_star
id|applidp
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|appl
suffix:semicolon
r_if
c_cond
(paren
id|rparam-&gt;datablklen
OL
l_int|128
)paren
r_return
id|CAPI_LOGBLKSIZETOSMALL
suffix:semicolon
r_for
c_loop
(paren
id|appl
op_assign
l_int|1
suffix:semicolon
id|appl
op_le
id|CAPI_MAXAPPL
suffix:semicolon
id|appl
op_increment
)paren
(brace
r_if
c_cond
(paren
id|APPL_IS_FREE
c_func
(paren
id|appl
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|appl
OG
id|CAPI_MAXAPPL
)paren
r_return
id|CAPI_TOOMANYAPPLS
suffix:semicolon
id|APPL_MARK_USED
c_func
(paren
id|appl
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|recv_queue
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|rparam
comma
id|rparam
comma
r_sizeof
(paren
id|capi_register_params
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CAPI_MAXCONTR
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cards
(braket
id|i
)braket
dot
id|cardstate
op_ne
id|CARD_RUNNING
)paren
r_continue
suffix:semicolon
id|B1_send_register
c_func
(paren
id|cards
(braket
id|i
)braket
dot
id|port
comma
id|appl
comma
l_int|1024
op_star
(paren
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|rparam.level3cnt
op_plus
l_int|1
)paren
comma
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|rparam.level3cnt
comma
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|rparam.datablkcnt
comma
id|APPL
c_func
(paren
id|appl
)paren
op_member_access_from_pointer
id|rparam.datablklen
)paren
suffix:semicolon
)brace
op_star
id|applidp
op_assign
id|appl
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;b1capi: appl %d up&bslash;n&quot;
comma
id|appl
)paren
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
DECL|function|capi_release
r_static
id|__u16
id|capi_release
c_func
(paren
id|__u16
id|applid
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|ncards
op_eq
l_int|0
)paren
r_return
id|CAPI_REGNOTINSTALLED
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|VALID_APPLID
c_func
(paren
id|applid
)paren
op_logical_or
id|APPL
c_func
(paren
id|applid
)paren
op_member_access_from_pointer
id|releasing
)paren
r_return
id|CAPI_ILLAPPNR
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|APPL
c_func
(paren
id|applid
)paren
op_member_access_from_pointer
id|recv_queue
)paren
)paren
op_ne
l_int|0
)paren
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CAPI_MAXCONTR
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cards
(braket
id|i
)braket
dot
id|cardstate
op_ne
id|CARD_RUNNING
)paren
(brace
r_continue
suffix:semicolon
)brace
id|APPL
c_func
(paren
id|applid
)paren
op_member_access_from_pointer
id|releasing
op_increment
suffix:semicolon
id|B1_send_release
c_func
(paren
id|cards
(braket
id|i
)braket
dot
id|port
comma
id|applid
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|APPL
c_func
(paren
id|applid
)paren
op_member_access_from_pointer
id|releasing
op_eq
l_int|0
)paren
(brace
id|APPL
c_func
(paren
id|applid
)paren
op_member_access_from_pointer
id|signal
op_assign
l_int|0
suffix:semicolon
id|APPL_MARK_FREE
c_func
(paren
id|applid
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;b1capi: appl %d down&bslash;n&quot;
comma
id|applid
)paren
suffix:semicolon
)brace
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
DECL|function|capi_put_message
r_static
id|__u16
id|capi_put_message
c_func
(paren
id|__u16
id|applid
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|avmb1_ncci
op_star
id|np
suffix:semicolon
r_int
id|contr
suffix:semicolon
r_if
c_cond
(paren
id|ncards
op_eq
l_int|0
)paren
r_return
id|CAPI_REGNOTINSTALLED
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|VALID_APPLID
c_func
(paren
id|applid
)paren
)paren
r_return
id|CAPI_ILLAPPNR
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
OL
l_int|12
op_logical_or
op_logical_neg
id|capi_cmd_valid
c_func
(paren
id|CAPIMSG_COMMAND
c_func
(paren
id|skb-&gt;data
)paren
)paren
op_logical_or
op_logical_neg
id|capi_subcmd_valid
c_func
(paren
id|CAPIMSG_SUBCOMMAND
c_func
(paren
id|skb-&gt;data
)paren
)paren
)paren
r_return
id|CAPI_ILLCMDORSUBCMDORMSGTOSMALL
suffix:semicolon
id|contr
op_assign
id|CAPIMSG_CONTROLLER
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|VALID_CARD
c_func
(paren
id|contr
)paren
op_logical_or
id|CARD
c_func
(paren
id|contr
)paren
op_member_access_from_pointer
id|cardstate
op_ne
id|CARD_RUNNING
)paren
(brace
id|contr
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|CARD
c_func
(paren
id|contr
)paren
op_member_access_from_pointer
id|cardstate
op_ne
id|CARD_RUNNING
)paren
r_return
id|CAPI_REGNOTINSTALLED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CARD
c_func
(paren
id|contr
)paren
op_member_access_from_pointer
id|blocked
)paren
r_return
id|CAPI_SENDQUEUEFULL
suffix:semicolon
r_if
c_cond
(paren
id|CAPIMSG_COMMAND
c_func
(paren
id|skb-&gt;data
)paren
op_eq
id|CAPI_DATA_B3
op_logical_and
id|CAPIMSG_SUBCOMMAND
c_func
(paren
id|skb-&gt;data
)paren
op_eq
id|CAPI_REQ
op_logical_and
(paren
id|np
op_assign
id|find_ncci
c_func
(paren
id|APPL
c_func
(paren
id|applid
)paren
comma
id|CAPIMSG_NCCI
c_func
(paren
id|skb-&gt;data
)paren
)paren
)paren
op_ne
l_int|0
op_logical_and
id|mq_enqueue
c_func
(paren
id|np
comma
id|CAPIMSG_MSGID
c_func
(paren
id|skb-&gt;data
)paren
)paren
op_eq
l_int|0
)paren
r_return
id|CAPI_SENDQUEUEFULL
suffix:semicolon
id|B1_send_message
c_func
(paren
id|CARD
c_func
(paren
id|contr
)paren
op_member_access_from_pointer
id|port
comma
id|skb
)paren
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
DECL|function|capi_get_message
r_static
id|__u16
id|capi_get_message
c_func
(paren
id|__u16
id|applid
comma
r_struct
id|sk_buff
op_star
op_star
id|msgp
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|VALID_APPLID
c_func
(paren
id|applid
)paren
)paren
r_return
id|CAPI_ILLAPPNR
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|APPL
c_func
(paren
id|applid
)paren
op_member_access_from_pointer
id|recv_queue
)paren
)paren
op_eq
l_int|0
)paren
r_return
id|CAPI_RECEIVEQUEUEEMPTY
suffix:semicolon
op_star
id|msgp
op_assign
id|skb
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
DECL|function|capi_set_signal
r_static
id|__u16
id|capi_set_signal
c_func
(paren
id|__u16
id|applid
comma
r_void
(paren
op_star
id|signal
)paren
(paren
id|__u16
id|applid
comma
id|__u32
id|param
)paren
comma
id|__u32
id|param
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|VALID_APPLID
c_func
(paren
id|applid
)paren
)paren
r_return
id|CAPI_ILLAPPNR
suffix:semicolon
id|APPL
c_func
(paren
id|applid
)paren
op_member_access_from_pointer
id|signal
op_assign
id|signal
suffix:semicolon
id|APPL
c_func
(paren
id|applid
)paren
op_member_access_from_pointer
id|param
op_assign
id|param
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
DECL|function|capi_get_manufacturer
r_static
id|__u16
id|capi_get_manufacturer
c_func
(paren
id|__u16
id|contr
comma
id|__u8
id|buf
(braket
id|CAPI_MANUFACTURER_LEN
)braket
)paren
(brace
r_if
c_cond
(paren
id|contr
op_eq
l_int|0
)paren
(brace
id|strncpy
c_func
(paren
id|buf
comma
id|capi_manufakturer
comma
id|CAPI_MANUFACTURER_LEN
)paren
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|VALID_CARD
c_func
(paren
id|contr
)paren
op_logical_or
id|CARD
c_func
(paren
id|contr
)paren
op_member_access_from_pointer
id|cardstate
op_ne
id|CARD_RUNNING
)paren
r_return
l_int|0x2002
suffix:semicolon
id|strncpy
c_func
(paren
id|buf
comma
id|capi_manufakturer
comma
id|CAPI_MANUFACTURER_LEN
)paren
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
DECL|function|capi_get_version
r_static
id|__u16
id|capi_get_version
c_func
(paren
id|__u16
id|contr
comma
r_struct
id|capi_version
op_star
id|verp
)paren
(brace
r_if
c_cond
(paren
id|contr
op_eq
l_int|0
)paren
(brace
op_star
id|verp
op_assign
id|driver_version
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|VALID_CARD
c_func
(paren
id|contr
)paren
op_logical_or
id|CARD
c_func
(paren
id|contr
)paren
op_member_access_from_pointer
id|cardstate
op_ne
id|CARD_RUNNING
)paren
r_return
l_int|0x2002
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|verp
comma
op_amp
id|CARD
c_func
(paren
id|contr
)paren
op_member_access_from_pointer
id|cversion
comma
r_sizeof
(paren
id|capi_version
)paren
)paren
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
DECL|function|capi_get_serial
r_static
id|__u16
id|capi_get_serial
c_func
(paren
id|__u16
id|contr
comma
id|__u8
id|serial
(braket
id|CAPI_SERIAL_LEN
)braket
)paren
(brace
r_if
c_cond
(paren
id|contr
op_eq
l_int|0
)paren
(brace
id|strncpy
c_func
(paren
id|serial
comma
id|driver_serial
comma
l_int|8
)paren
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|VALID_CARD
c_func
(paren
id|contr
)paren
op_logical_or
id|CARD
c_func
(paren
id|contr
)paren
op_member_access_from_pointer
id|cardstate
op_ne
id|CARD_RUNNING
)paren
r_return
l_int|0x2002
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|serial
comma
id|CARD
c_func
(paren
id|contr
)paren
op_member_access_from_pointer
id|version
(braket
id|VER_SERIAL
)braket
comma
id|CAPI_SERIAL_LEN
)paren
suffix:semicolon
id|serial
(braket
id|CAPI_SERIAL_LEN
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
DECL|function|capi_get_profile
r_static
id|__u16
id|capi_get_profile
c_func
(paren
id|__u16
id|contr
comma
r_struct
id|capi_profile
op_star
id|profp
)paren
(brace
r_if
c_cond
(paren
id|contr
op_eq
l_int|0
)paren
(brace
id|profp-&gt;ncontroller
op_assign
id|ncards
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|VALID_CARD
c_func
(paren
id|contr
)paren
op_logical_or
id|CARD
c_func
(paren
id|contr
)paren
op_member_access_from_pointer
id|cardstate
op_ne
id|CARD_RUNNING
)paren
r_return
l_int|0x2002
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|profp
comma
id|CARD
c_func
(paren
id|contr
)paren
op_member_access_from_pointer
id|version
(braket
id|VER_PROFILE
)braket
comma
r_sizeof
(paren
r_struct
id|capi_profile
)paren
)paren
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
DECL|function|capi_manufacturer
r_static
r_int
id|capi_manufacturer
c_func
(paren
r_int
r_int
id|cmd
comma
r_void
op_star
id|data
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|avmb1_loadandconfigdef
id|ldef
suffix:semicolon
id|avmb1_extcarddef
id|cdef
suffix:semicolon
id|avmb1_resetdef
id|rdef
suffix:semicolon
id|avmb1_getdef
id|gdef
suffix:semicolon
id|avmb1_card
op_star
id|card
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|AVMB1_ADDCARD
suffix:colon
r_case
id|AVMB1_ADDCARD_WITH_TYPE
suffix:colon
r_if
c_cond
(paren
id|cmd
op_eq
id|AVMB1_ADDCARD
)paren
(brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|cdef
comma
id|data
comma
r_sizeof
(paren
id|avmb1_carddef
)paren
)paren
)paren
)paren
r_return
id|rc
suffix:semicolon
id|cdef.cardtype
op_assign
id|AVM_CARDTYPE_B1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|cdef
comma
id|data
comma
r_sizeof
(paren
id|avmb1_extcarddef
)paren
)paren
)paren
)paren
r_return
id|rc
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|avmb1_probecard
c_func
(paren
id|cdef.port
comma
id|cdef.irq
comma
id|cdef.cardtype
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_return
id|avmb1_addcard
c_func
(paren
id|cdef.port
comma
id|cdef.irq
comma
id|cdef.cardtype
)paren
suffix:semicolon
r_case
id|AVMB1_LOAD
suffix:colon
r_case
id|AVMB1_LOAD_AND_CONFIG
suffix:colon
r_if
c_cond
(paren
id|cmd
op_eq
id|AVMB1_LOAD
)paren
(brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|ldef
comma
id|data
comma
r_sizeof
(paren
id|avmb1_loaddef
)paren
)paren
)paren
)paren
r_return
id|rc
suffix:semicolon
id|ldef.t4config.len
op_assign
l_int|0
suffix:semicolon
id|ldef.t4config.data
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|ldef
comma
id|data
comma
r_sizeof
(paren
id|avmb1_loadandconfigdef
)paren
)paren
)paren
)paren
r_return
id|rc
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|VALID_CARD
c_func
(paren
id|ldef.contr
)paren
)paren
r_return
op_minus
id|ESRCH
suffix:semicolon
r_if
c_cond
(paren
id|ldef.t4file.len
op_le
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|loaddebug
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;b1capi: load: invalid parameter length of t4file is %d ?&bslash;n&quot;
comma
id|ldef.t4file.len
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|card
op_assign
id|CARD
c_func
(paren
id|ldef.contr
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;cardstate
op_ne
id|CARD_DETECTED
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|loaddebug
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;b1capi: load: contr=%d not in detect state&bslash;n&quot;
comma
id|ldef.contr
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|card-&gt;cardstate
op_assign
id|CARD_LOADING
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|loaddebug
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;b1capi: load: reseting contr %d&bslash;n&quot;
comma
id|ldef.contr
)paren
suffix:semicolon
)brace
id|B1_reset
c_func
(paren
id|card-&gt;port
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|B1_load_t4file
c_func
(paren
id|card-&gt;port
comma
op_amp
id|ldef.t4file
)paren
)paren
)paren
(brace
id|B1_reset
c_func
(paren
id|card-&gt;port
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;b1capi: failed to load t4file!!&bslash;n&quot;
)paren
suffix:semicolon
id|card-&gt;cardstate
op_assign
id|CARD_DETECTED
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|B1_disable_irq
c_func
(paren
id|card-&gt;port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ldef.t4config.len
OG
l_int|0
)paren
(brace
multiline_comment|/* load config */
r_if
c_cond
(paren
id|loaddebug
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;b1capi: loading config to contr %d&bslash;n&quot;
comma
id|ldef.contr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|B1_load_config
c_func
(paren
id|card-&gt;port
comma
op_amp
id|ldef.t4config
)paren
)paren
)paren
(brace
id|B1_reset
c_func
(paren
id|card-&gt;port
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;b1capi: failed to load config!!&bslash;n&quot;
)paren
suffix:semicolon
id|card-&gt;cardstate
op_assign
id|CARD_DETECTED
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|loaddebug
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;b1capi: load: ready contr %d: checking&bslash;n&quot;
comma
id|ldef.contr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|B1_loaded
c_func
(paren
id|card-&gt;port
)paren
)paren
(brace
id|card-&gt;cardstate
op_assign
id|CARD_DETECTED
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;b1capi: failed to load t4file.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * enable interrupt&n;&t;&t; */
id|card-&gt;cardstate
op_assign
id|CARD_INITSTATE
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|B1_assign_irq
c_func
(paren
id|card-&gt;port
comma
id|card-&gt;irq
comma
id|card-&gt;cardtype
)paren
suffix:semicolon
id|B1_enable_irq
c_func
(paren
id|card-&gt;port
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|loaddebug
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;b1capi: load: irq enabled contr %d&bslash;n&quot;
comma
id|ldef.contr
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * init card&n;&t;&t; */
id|B1_send_init
c_func
(paren
id|card-&gt;port
comma
id|AVM_NAPPS
comma
id|AVM_NNCCI
comma
id|card-&gt;cnr
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|loaddebug
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;b1capi: load: waiting for init reply contr %d&bslash;n&quot;
comma
id|ldef.contr
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|card-&gt;cardstate
op_ne
id|CARD_RUNNING
)paren
(brace
id|current-&gt;timeout
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|10
suffix:semicolon
multiline_comment|/* 0.1 sec */
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|AVMB1_RESETCARD
suffix:colon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|rdef
comma
id|data
comma
r_sizeof
(paren
id|avmb1_resetdef
)paren
)paren
)paren
)paren
r_return
id|rc
suffix:semicolon
r_return
id|avmb1_resetcard
c_func
(paren
id|rdef.contr
)paren
suffix:semicolon
r_case
id|AVMB1_GET_CARDINFO
suffix:colon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|gdef
comma
id|data
comma
r_sizeof
(paren
id|avmb1_getdef
)paren
)paren
)paren
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|VALID_CARD
c_func
(paren
id|gdef.contr
)paren
)paren
r_return
op_minus
id|ESRCH
suffix:semicolon
id|card
op_assign
id|CARD
c_func
(paren
id|gdef.contr
)paren
suffix:semicolon
id|gdef.cardstate
op_assign
id|card-&gt;cardstate
suffix:semicolon
id|gdef.cardtype
op_assign
id|card-&gt;cardtype
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|copy_to_user
c_func
(paren
id|data
comma
(paren
r_void
op_star
)paren
op_amp
id|gdef
comma
r_sizeof
(paren
id|avmb1_getdef
)paren
)paren
)paren
)paren
r_return
id|rc
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|variable|avmb1_interface
r_struct
id|capi_interface
id|avmb1_interface
op_assign
(brace
id|capi_installed
comma
id|capi_register
comma
id|capi_release
comma
id|capi_put_message
comma
id|capi_get_message
comma
id|capi_set_signal
comma
id|capi_get_manufacturer
comma
id|capi_get_version
comma
id|capi_get_serial
comma
id|capi_get_profile
comma
id|capi_manufacturer
)brace
suffix:semicolon
multiline_comment|/* ------------------------------------------------------------- */
multiline_comment|/* -------- Exported Functions --------------------------------- */
multiline_comment|/* ------------------------------------------------------------- */
DECL|function|attach_capi_interface
r_struct
id|capi_interface
op_star
id|attach_capi_interface
c_func
(paren
r_struct
id|capi_interface_user
op_star
id|userp
)paren
(brace
r_struct
id|capi_interface_user
op_star
id|p
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|capi_users
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|p
op_eq
id|userp
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;b1capi: double attach from %s&bslash;n&quot;
comma
id|userp-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|userp-&gt;next
op_assign
id|capi_users
suffix:semicolon
id|capi_users
op_assign
id|userp
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
op_amp
id|avmb1_interface
suffix:semicolon
)brace
DECL|function|detach_capi_interface
r_int
id|detach_capi_interface
c_func
(paren
r_struct
id|capi_interface_user
op_star
id|userp
)paren
(brace
r_struct
id|capi_interface_user
op_star
op_star
id|pp
suffix:semicolon
r_for
c_loop
(paren
id|pp
op_assign
op_amp
id|capi_users
suffix:semicolon
op_star
id|pp
suffix:semicolon
id|pp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
)paren
(brace
r_if
c_cond
(paren
op_star
id|pp
op_eq
id|userp
)paren
(brace
op_star
id|pp
op_assign
id|userp-&gt;next
suffix:semicolon
id|userp-&gt;next
op_assign
l_int|0
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;b1capi: double detach from %s&bslash;n&quot;
comma
id|userp-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------- */
multiline_comment|/* -------- Init &amp; Cleanup ------------------------------------- */
multiline_comment|/* ------------------------------------------------------------- */
DECL|variable|attach_capi_interface
id|EXPORT_SYMBOL
c_func
(paren
id|attach_capi_interface
)paren
suffix:semicolon
DECL|variable|detach_capi_interface
id|EXPORT_SYMBOL
c_func
(paren
id|detach_capi_interface
)paren
suffix:semicolon
DECL|variable|avmb1_addcard
id|EXPORT_SYMBOL
c_func
(paren
id|avmb1_addcard
)paren
suffix:semicolon
DECL|variable|avmb1_probecard
id|EXPORT_SYMBOL
c_func
(paren
id|avmb1_probecard
)paren
suffix:semicolon
DECL|variable|avmb1_registercard
id|EXPORT_SYMBOL
c_func
(paren
id|avmb1_registercard
)paren
suffix:semicolon
DECL|variable|avmb1_unregistercard
id|EXPORT_SYMBOL
c_func
(paren
id|avmb1_unregistercard
)paren
suffix:semicolon
DECL|variable|avmb1_resetcard
id|EXPORT_SYMBOL
c_func
(paren
id|avmb1_resetcard
)paren
suffix:semicolon
DECL|variable|avmb1_detectcard
id|EXPORT_SYMBOL
c_func
(paren
id|avmb1_detectcard
)paren
suffix:semicolon
multiline_comment|/*&n; * init / exit functions&n; */
macro_line|#ifdef MODULE
DECL|macro|avmb1_init
mdefine_line|#define avmb1_init init_module
macro_line|#endif
DECL|function|avmb1_init
r_int
id|avmb1_init
c_func
(paren
r_void
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
r_char
id|rev
(braket
l_int|10
)braket
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|recv_queue
)paren
suffix:semicolon
multiline_comment|/* init_bh(CAPI_BH, do_capi_bh); */
id|tq_state_notify.routine
op_assign
id|notify_handler
suffix:semicolon
id|tq_state_notify.data
op_assign
l_int|0
suffix:semicolon
id|tq_recv_notify.routine
op_assign
id|recv_handler
suffix:semicolon
id|tq_recv_notify.data
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
op_assign
id|strchr
c_func
(paren
id|revision
comma
l_char|&squot;:&squot;
)paren
)paren
)paren
(brace
id|strcpy
c_func
(paren
id|rev
comma
id|p
op_plus
l_int|1
)paren
suffix:semicolon
id|p
op_assign
id|strchr
c_func
(paren
id|rev
comma
l_char|&squot;$&squot;
)paren
suffix:semicolon
op_star
id|p
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|strcpy
c_func
(paren
id|rev
comma
l_string|&quot; ??? &quot;
)paren
suffix:semicolon
macro_line|#ifdef MODULE
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;AVM-B1-CAPI-driver Rev%s: loaded&bslash;n&quot;
comma
id|rev
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;AVM-B1-CAPI-driver Rev%s: started&bslash;n&quot;
comma
id|rev
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_char
id|rev
(braket
l_int|10
)braket
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
op_assign
id|strchr
c_func
(paren
id|revision
comma
l_char|&squot;:&squot;
)paren
)paren
)paren
(brace
id|strcpy
c_func
(paren
id|rev
comma
id|p
op_plus
l_int|1
)paren
suffix:semicolon
id|p
op_assign
id|strchr
c_func
(paren
id|rev
comma
l_char|&squot;$&squot;
)paren
suffix:semicolon
op_star
id|p
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|strcpy
c_func
(paren
id|rev
comma
l_string|&quot; ??? &quot;
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CAPI_MAXCONTR
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cards
(braket
id|i
)braket
dot
id|cardstate
op_ne
id|CARD_FREE
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * disable card&n;&t;&t;&t; */
id|B1_disable_irq
c_func
(paren
id|cards
(braket
id|i
)braket
dot
id|port
)paren
suffix:semicolon
id|avmb1_resetcard
c_func
(paren
id|i
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * free kernel resources&n;&t;&t;&t; */
id|avmb1_unregistercard
c_func
(paren
id|i
op_plus
l_int|1
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* execute queued tasks .... */
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;AVM-B1-CAPI-driver Rev%s: unloaded&bslash;n&quot;
comma
id|rev
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
