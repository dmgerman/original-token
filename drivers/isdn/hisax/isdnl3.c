multiline_comment|/* $Id: isdnl3.c,v 2.5 1998/02/12 23:07:52 keil Exp $&n;&n; * Author       Karsten Keil (keil@temic-ech.spacenet.de)&n; *              based on the teles driver from Jan den Ouden&n; *&n; * Thanks to    Jan den Ouden&n; *              Fritz Elfert&n; *&n; * $Log: isdnl3.c,v $&n; * Revision 2.5  1998/02/12 23:07:52  keil&n; * change for 2.1.86 (removing FREE_READ/FREE_WRITE from [dev]_kfree_skb()&n; *&n; * Revision 2.4  1997/11/06 17:09:25  keil&n; * New 2.1 init code&n; *&n; * Revision 2.3  1997/10/29 19:07:53  keil&n; * changes for 2.1&n; *&n; * Revision 2.2  1997/10/01 09:21:41  fritz&n; * Removed old compatibility stuff for 2.0.X kernels.&n; * From now on, this code is for 2.1.X ONLY!&n; * Old stuff is still in the separate branch.&n; *&n; * Revision 2.1  1997/08/03 14:36:32  keil&n; * Implement RESTART procedure&n; *&n; * Revision 2.0  1997/07/27 21:15:42  keil&n; * New Callref based layer3&n; *&n; * Revision 1.11  1997/06/26 11:11:44  keil&n; * SET_SKBFREE now on creation of a SKB&n; *&n; * Revision 1.10  1997/04/06 22:54:16  keil&n; * Using SKB&squot;s&n; *&n; * Revision 1.9  1997/03/25 23:11:25  keil&n; * US NI-1 protocol&n; *&n; * Revision 1.8  1997/03/21 18:53:44  keil&n; * Report no protocol error to syslog too&n; *&n; * Remove old logs /KKe&n; *&n; */
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &quot;hisax.h&quot;
macro_line|#include &quot;isdnl3.h&quot;
macro_line|#include &lt;linux/config.h&gt;
DECL|variable|l3_revision
r_const
r_char
op_star
id|l3_revision
op_assign
l_string|&quot;$Revision: 2.5 $&quot;
suffix:semicolon
id|u_char
op_star
DECL|function|findie
id|findie
c_func
(paren
id|u_char
op_star
id|p
comma
r_int
id|size
comma
id|u_char
id|ie
comma
r_int
id|wanted_set
)paren
(brace
r_int
id|l
comma
id|codeset
comma
id|maincodeset
suffix:semicolon
id|u_char
op_star
id|pend
op_assign
id|p
op_plus
id|size
suffix:semicolon
multiline_comment|/* skip protocol discriminator, callref and message type */
id|p
op_increment
suffix:semicolon
id|l
op_assign
(paren
op_star
id|p
op_increment
)paren
op_amp
l_int|0xf
suffix:semicolon
id|p
op_add_assign
id|l
suffix:semicolon
id|p
op_increment
suffix:semicolon
id|codeset
op_assign
l_int|0
suffix:semicolon
id|maincodeset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* while there are bytes left... */
r_while
c_loop
(paren
id|p
OL
id|pend
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|p
op_amp
l_int|0xf0
)paren
op_eq
l_int|0x90
)paren
(brace
id|codeset
op_assign
op_star
id|p
op_amp
l_int|0x07
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|p
op_amp
l_int|0x08
)paren
)paren
id|maincodeset
op_assign
id|codeset
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|p
op_amp
l_int|0x80
)paren
id|p
op_increment
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|codeset
op_eq
id|wanted_set
)paren
(brace
r_if
c_cond
(paren
op_star
id|p
op_eq
id|ie
)paren
r_return
(paren
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
OG
id|ie
)paren
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
id|p
op_increment
suffix:semicolon
id|l
op_assign
op_star
id|p
op_increment
suffix:semicolon
id|p
op_add_assign
id|l
suffix:semicolon
id|codeset
op_assign
id|maincodeset
suffix:semicolon
)brace
)brace
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
r_int
DECL|function|getcallref
id|getcallref
c_func
(paren
id|u_char
op_star
id|p
)paren
(brace
r_int
id|l
comma
id|m
op_assign
l_int|1
comma
id|cr
op_assign
l_int|0
suffix:semicolon
id|p
op_increment
suffix:semicolon
multiline_comment|/* prot discr */
id|l
op_assign
l_int|0xf
op_amp
op_star
id|p
op_increment
suffix:semicolon
multiline_comment|/* callref length */
r_if
c_cond
(paren
op_logical_neg
id|l
)paren
multiline_comment|/* dummy CallRef */
r_return
op_minus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|l
op_decrement
)paren
(brace
id|cr
op_add_assign
id|m
op_star
(paren
op_star
id|p
op_increment
)paren
suffix:semicolon
id|m
op_mul_assign
l_int|8
suffix:semicolon
)brace
r_return
(paren
id|cr
)paren
suffix:semicolon
)brace
DECL|variable|OrigCallRef
r_static
r_int
id|OrigCallRef
op_assign
l_int|0
suffix:semicolon
r_int
DECL|function|newcallref
id|newcallref
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|OrigCallRef
op_eq
l_int|127
)paren
id|OrigCallRef
op_assign
l_int|1
suffix:semicolon
r_else
id|OrigCallRef
op_increment
suffix:semicolon
r_return
(paren
id|OrigCallRef
)paren
suffix:semicolon
)brace
r_void
DECL|function|l3_debug
id|l3_debug
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_char
op_star
id|s
)paren
(brace
r_char
id|str
(braket
l_int|256
)braket
comma
id|tm
(braket
l_int|32
)braket
suffix:semicolon
id|jiftime
c_func
(paren
id|tm
comma
id|jiffies
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|str
comma
l_string|&quot;%s l3 %s&bslash;n&quot;
comma
id|tm
comma
id|s
)paren
suffix:semicolon
id|HiSax_putstatus
c_func
(paren
id|st-&gt;l1.hardware
comma
id|str
)paren
suffix:semicolon
)brace
r_void
DECL|function|newl3state
id|newl3state
c_func
(paren
r_struct
id|l3_process
op_star
id|pc
comma
r_int
id|state
)paren
(brace
r_char
id|tmp
(braket
l_int|80
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pc-&gt;debug
op_amp
id|L3_DEB_STATE
)paren
(brace
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;newstate cr %d %d --&gt; %d&quot;
comma
id|pc-&gt;callref
comma
id|pc-&gt;state
comma
id|state
)paren
suffix:semicolon
id|l3_debug
c_func
(paren
id|pc-&gt;st
comma
id|tmp
)paren
suffix:semicolon
)brace
id|pc-&gt;state
op_assign
id|state
suffix:semicolon
)brace
r_static
r_void
DECL|function|L3ExpireTimer
id|L3ExpireTimer
c_func
(paren
r_struct
id|L3Timer
op_star
id|t
)paren
(brace
id|t-&gt;pc-&gt;st-&gt;lli
dot
id|l4l3
c_func
(paren
id|t-&gt;pc-&gt;st
comma
id|t-&gt;event
comma
id|t-&gt;pc
)paren
suffix:semicolon
)brace
r_void
DECL|function|L3InitTimer
id|L3InitTimer
c_func
(paren
r_struct
id|l3_process
op_star
id|pc
comma
r_struct
id|L3Timer
op_star
id|t
)paren
(brace
id|t-&gt;pc
op_assign
id|pc
suffix:semicolon
id|t-&gt;tl.function
op_assign
(paren
r_void
op_star
)paren
id|L3ExpireTimer
suffix:semicolon
id|t-&gt;tl.data
op_assign
(paren
r_int
)paren
id|t
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|t-&gt;tl
)paren
suffix:semicolon
)brace
r_void
DECL|function|L3DelTimer
id|L3DelTimer
c_func
(paren
r_struct
id|L3Timer
op_star
id|t
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|t-&gt;tl
)paren
suffix:semicolon
)brace
r_int
DECL|function|L3AddTimer
id|L3AddTimer
c_func
(paren
r_struct
id|L3Timer
op_star
id|t
comma
r_int
id|millisec
comma
r_int
id|event
)paren
(brace
r_if
c_cond
(paren
id|t-&gt;tl.next
op_logical_or
id|t-&gt;tl.prev
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;L3AddTimer: timer already active!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|init_timer
c_func
(paren
op_amp
id|t-&gt;tl
)paren
suffix:semicolon
id|t-&gt;event
op_assign
id|event
suffix:semicolon
id|t-&gt;tl.expires
op_assign
id|jiffies
op_plus
(paren
id|millisec
op_star
id|HZ
)paren
op_div
l_int|1000
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|t-&gt;tl
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|StopAllL3Timer
id|StopAllL3Timer
c_func
(paren
r_struct
id|l3_process
op_star
id|pc
)paren
(brace
id|L3DelTimer
c_func
(paren
op_amp
id|pc-&gt;timer
)paren
suffix:semicolon
)brace
r_struct
id|sk_buff
op_star
DECL|function|l3_alloc_skb
id|l3_alloc_skb
c_func
(paren
r_int
id|len
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|len
op_plus
id|MAX_HEADER_LEN
comma
id|GFP_ATOMIC
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HiSax: No skb for D-channel&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb
comma
id|MAX_HEADER_LEN
)paren
suffix:semicolon
r_return
(paren
id|skb
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|no_l3_proto
id|no_l3_proto
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|arg
suffix:semicolon
id|HiSax_putstatus
c_func
(paren
id|st-&gt;l1.hardware
comma
l_string|&quot;L3 no D protocol&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef&t;CONFIG_HISAX_EURO
r_extern
r_void
id|setstack_dss1
c_func
(paren
r_struct
id|PStack
op_star
id|st
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef        CONFIG_HISAX_NI1
r_extern
r_void
id|setstack_ni1
c_func
(paren
r_struct
id|PStack
op_star
id|st
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef&t;CONFIG_HISAX_1TR6
r_extern
r_void
id|setstack_1tr6
c_func
(paren
r_struct
id|PStack
op_star
id|st
)paren
suffix:semicolon
macro_line|#endif
r_struct
id|l3_process
DECL|function|getl3proc
op_star
id|getl3proc
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_int
id|cr
)paren
(brace
r_struct
id|l3_process
op_star
id|p
op_assign
id|st-&gt;l3.proc
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
r_if
c_cond
(paren
id|p-&gt;callref
op_eq
id|cr
)paren
r_return
(paren
id|p
)paren
suffix:semicolon
r_else
id|p
op_assign
id|p-&gt;next
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
r_struct
id|l3_process
DECL|function|new_l3_process
op_star
id|new_l3_process
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_int
id|cr
)paren
(brace
r_struct
id|l3_process
op_star
id|p
comma
op_star
id|np
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|p
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|l3_process
)paren
comma
id|GFP_ATOMIC
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;HiSax can&squot;t get memory for cr %d&bslash;n&quot;
comma
id|cr
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|st-&gt;l3.proc
)paren
id|st-&gt;l3.proc
op_assign
id|p
suffix:semicolon
r_else
(brace
id|np
op_assign
id|st-&gt;l3.proc
suffix:semicolon
r_while
c_loop
(paren
id|np-&gt;next
)paren
id|np
op_assign
id|np-&gt;next
suffix:semicolon
id|np-&gt;next
op_assign
id|p
suffix:semicolon
)brace
id|p-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|p-&gt;debug
op_assign
id|L3_DEB_WARN
suffix:semicolon
id|p-&gt;callref
op_assign
id|cr
suffix:semicolon
id|p-&gt;state
op_assign
l_int|0
suffix:semicolon
id|p-&gt;chan
op_assign
l_int|NULL
suffix:semicolon
id|p-&gt;st
op_assign
id|st
suffix:semicolon
id|p-&gt;N303
op_assign
id|st-&gt;l3.N303
suffix:semicolon
id|L3InitTimer
c_func
(paren
id|p
comma
op_amp
id|p-&gt;timer
)paren
suffix:semicolon
r_return
(paren
id|p
)paren
suffix:semicolon
)brace
suffix:semicolon
r_void
DECL|function|release_l3_process
id|release_l3_process
c_func
(paren
r_struct
id|l3_process
op_star
id|p
)paren
(brace
r_struct
id|l3_process
op_star
id|np
comma
op_star
id|pp
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
r_return
suffix:semicolon
id|np
op_assign
id|p-&gt;st-&gt;l3.proc
suffix:semicolon
r_while
c_loop
(paren
id|np
)paren
(brace
r_if
c_cond
(paren
id|np
op_eq
id|p
)paren
(brace
id|StopAllL3Timer
c_func
(paren
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pp
)paren
id|pp-&gt;next
op_assign
id|np-&gt;next
suffix:semicolon
r_else
id|p-&gt;st-&gt;l3.proc
op_assign
id|np-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|p
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|pp
op_assign
id|np
suffix:semicolon
id|np
op_assign
id|np-&gt;next
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;HiSax internal L3 error CR not in list&bslash;n&quot;
)paren
suffix:semicolon
)brace
suffix:semicolon
r_void
DECL|function|setstack_isdnl3
id|setstack_isdnl3
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_struct
id|Channel
op_star
id|chanp
)paren
(brace
r_char
id|tmp
(braket
l_int|64
)braket
suffix:semicolon
id|st-&gt;l3.proc
op_assign
l_int|NULL
suffix:semicolon
id|st-&gt;l3.global
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef&t;CONFIG_HISAX_EURO
r_if
c_cond
(paren
id|st-&gt;protocol
op_eq
id|ISDN_PTYPE_EURO
)paren
(brace
id|setstack_dss1
c_func
(paren
id|st
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif
macro_line|#ifdef        CONFIG_HISAX_NI1
r_if
c_cond
(paren
id|st-&gt;protocol
op_eq
id|ISDN_PTYPE_NI1
)paren
(brace
id|setstack_ni1
c_func
(paren
id|st
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif
macro_line|#ifdef&t;CONFIG_HISAX_1TR6
r_if
c_cond
(paren
id|st-&gt;protocol
op_eq
id|ISDN_PTYPE_1TR6
)paren
(brace
id|setstack_1tr6
c_func
(paren
id|st
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif
r_if
c_cond
(paren
id|st-&gt;protocol
op_eq
id|ISDN_PTYPE_LEASED
)paren
(brace
id|st-&gt;lli.l4l3
op_assign
id|no_l3_proto
suffix:semicolon
id|st-&gt;l2.l2l3
op_assign
id|no_l3_proto
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HiSax: Leased line mode&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|st-&gt;lli.l4l3
op_assign
id|no_l3_proto
suffix:semicolon
id|st-&gt;l2.l2l3
op_assign
id|no_l3_proto
suffix:semicolon
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;protocol %s not supported&quot;
comma
(paren
id|st-&gt;protocol
op_eq
id|ISDN_PTYPE_1TR6
)paren
ques
c_cond
l_string|&quot;1tr6&quot;
suffix:colon
(paren
id|st-&gt;protocol
op_eq
id|ISDN_PTYPE_EURO
)paren
ques
c_cond
l_string|&quot;euro&quot;
suffix:colon
(paren
id|st-&gt;protocol
op_eq
id|ISDN_PTYPE_NI1
)paren
ques
c_cond
l_string|&quot;ni1&quot;
suffix:colon
l_string|&quot;unknown&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HiSax: %s&bslash;n&quot;
comma
id|tmp
)paren
suffix:semicolon
id|st-&gt;protocol
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_void
DECL|function|releasestack_isdnl3
id|releasestack_isdnl3
c_func
(paren
r_struct
id|PStack
op_star
id|st
)paren
(brace
r_while
c_loop
(paren
id|st-&gt;l3.proc
)paren
id|release_l3_process
c_func
(paren
id|st-&gt;l3.proc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st-&gt;l3.global
)paren
(brace
id|StopAllL3Timer
c_func
(paren
id|st-&gt;l3.global
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|st-&gt;l3.global
)paren
suffix:semicolon
id|st-&gt;l3.global
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
eof
