multiline_comment|/* $Id: isdnl3.c,v 1.10 1997/04/06 22:54:16 keil Exp $&n;&n; * Author       Karsten Keil (keil@temic-ech.spacenet.de)&n; *              based on the teles driver from Jan den Ouden&n; *&n; * Thanks to    Jan den Ouden&n; *              Fritz Elfert&n; *&n; * $Log: isdnl3.c,v $&n; * Revision 1.10  1997/04/06 22:54:16  keil&n; * Using SKB&squot;s&n; *&n; * Revision 1.9  1997/03/25 23:11:25  keil&n; * US NI-1 protocol&n; *&n; * Revision 1.8  1997/03/21 18:53:44  keil&n; * Report no protocol error to syslog too&n; *&n; * Revision 1.7  1997/03/17 18:34:38  keil&n; * fixed oops if no protocol selected during config&n; *&n; * Revision 1.6  1997/02/16 01:04:08  fritz&n; * Bugfix: Changed timer handling caused hang with 2.1.X&n; *&n; * Revision 1.5  1997/02/09 00:26:27  keil&n; * new interface handling, one interface per card&n; * leased line changes&n; *&n; * Revision 1.4  1997/01/27 23:17:44  keil&n; * delete timers while unloading&n; *&n; * Revision 1.3  1997/01/21 22:31:12  keil&n; * new statemachine; L3 timers&n; *&n; * Revision 1.2  1996/11/05 19:42:04  keil&n; * using config.h&n; *&n; * Revision 1.1  1996/10/13 20:04:54  keil&n; * Initial revision&n; *&n; *&n; *&n; */
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &quot;hisax.h&quot;
macro_line|#include &quot;isdnl3.h&quot;
macro_line|#include &lt;linux/config.h&gt;
DECL|variable|l3_revision
r_const
r_char
op_star
id|l3_revision
op_assign
l_string|&quot;$Revision: 1.10 $&quot;
suffix:semicolon
r_void
DECL|function|l3_debug
id|l3_debug
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_char
op_star
id|s
)paren
(brace
r_char
id|str
(braket
l_int|256
)braket
comma
id|tm
(braket
l_int|32
)braket
suffix:semicolon
id|jiftime
c_func
(paren
id|tm
comma
id|jiffies
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|str
comma
l_string|&quot;%s Channel %d l3 %s&bslash;n&quot;
comma
id|tm
comma
id|st-&gt;l3.channr
comma
id|s
)paren
suffix:semicolon
id|HiSax_putstatus
c_func
(paren
id|st-&gt;l1.hardware
comma
id|str
)paren
suffix:semicolon
)brace
r_void
DECL|function|newl3state
id|newl3state
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_int
id|state
)paren
(brace
r_char
id|tmp
(braket
l_int|80
)braket
suffix:semicolon
r_if
c_cond
(paren
id|st-&gt;l3.debug
op_amp
id|L3_DEB_STATE
)paren
(brace
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;newstate  %d --&gt; %d&quot;
comma
id|st-&gt;l3.state
comma
id|state
)paren
suffix:semicolon
id|l3_debug
c_func
(paren
id|st
comma
id|tmp
)paren
suffix:semicolon
)brace
id|st-&gt;l3.state
op_assign
id|state
suffix:semicolon
)brace
r_static
r_void
DECL|function|L3ExpireTimer
id|L3ExpireTimer
c_func
(paren
r_struct
id|L3Timer
op_star
id|t
)paren
(brace
id|t-&gt;st-&gt;l4
dot
id|l4l3
c_func
(paren
id|t-&gt;st
comma
id|t-&gt;event
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_void
DECL|function|L3InitTimer
id|L3InitTimer
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_struct
id|L3Timer
op_star
id|t
)paren
(brace
id|t-&gt;st
op_assign
id|st
suffix:semicolon
id|t-&gt;tl.function
op_assign
(paren
r_void
op_star
)paren
id|L3ExpireTimer
suffix:semicolon
id|t-&gt;tl.data
op_assign
(paren
r_int
)paren
id|t
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|t-&gt;tl
)paren
suffix:semicolon
)brace
r_void
DECL|function|L3DelTimer
id|L3DelTimer
c_func
(paren
r_struct
id|L3Timer
op_star
id|t
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|t-&gt;tl
)paren
suffix:semicolon
)brace
r_int
DECL|function|L3AddTimer
id|L3AddTimer
c_func
(paren
r_struct
id|L3Timer
op_star
id|t
comma
r_int
id|millisec
comma
r_int
id|event
)paren
(brace
r_if
c_cond
(paren
id|t-&gt;tl.next
op_logical_or
id|t-&gt;tl.prev
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;L3AddTimer: timer already active!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|init_timer
c_func
(paren
op_amp
id|t-&gt;tl
)paren
suffix:semicolon
id|t-&gt;event
op_assign
id|event
suffix:semicolon
id|t-&gt;tl.expires
op_assign
id|jiffies
op_plus
(paren
id|millisec
op_star
id|HZ
)paren
op_div
l_int|1000
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|t-&gt;tl
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|StopAllL3Timer
id|StopAllL3Timer
c_func
(paren
r_struct
id|PStack
op_star
id|st
)paren
(brace
id|L3DelTimer
c_func
(paren
op_amp
id|st-&gt;l3.timer
)paren
suffix:semicolon
)brace
r_struct
id|sk_buff
op_star
DECL|function|l3_alloc_skb
id|l3_alloc_skb
c_func
(paren
r_int
id|len
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|len
op_plus
id|MAX_HEADER_LEN
comma
id|GFP_ATOMIC
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HiSax: No skb for D-channel&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb
comma
id|MAX_HEADER_LEN
)paren
suffix:semicolon
r_return
(paren
id|skb
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|no_l3_proto
id|no_l3_proto
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|arg
suffix:semicolon
id|l3_debug
c_func
(paren
id|st
comma
l_string|&quot;no protocol&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|SET_SKB_FREE
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_READ
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef&t;CONFIG_HISAX_EURO
r_extern
r_void
id|setstack_dss1
c_func
(paren
r_struct
id|PStack
op_star
id|st
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef        CONFIG_HISAX_NI1
r_extern
r_void
id|setstack_ni1
c_func
(paren
r_struct
id|PStack
op_star
id|st
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef&t;CONFIG_HISAX_1TR6
r_extern
r_void
id|setstack_1tr6
c_func
(paren
r_struct
id|PStack
op_star
id|st
)paren
suffix:semicolon
macro_line|#endif
r_void
DECL|function|setstack_isdnl3
id|setstack_isdnl3
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_struct
id|Channel
op_star
id|chanp
)paren
(brace
r_char
id|tmp
(braket
l_int|64
)braket
suffix:semicolon
id|st-&gt;l3.debug
op_assign
id|L3_DEB_WARN
suffix:semicolon
id|st-&gt;l3.channr
op_assign
id|chanp-&gt;chan
suffix:semicolon
id|L3InitTimer
c_func
(paren
id|st
comma
op_amp
id|st-&gt;l3.timer
)paren
suffix:semicolon
macro_line|#ifdef&t;CONFIG_HISAX_EURO
r_if
c_cond
(paren
id|st-&gt;protocol
op_eq
id|ISDN_PTYPE_EURO
)paren
(brace
id|setstack_dss1
c_func
(paren
id|st
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif
macro_line|#ifdef        CONFIG_HISAX_NI1
r_if
c_cond
(paren
id|st-&gt;protocol
op_eq
id|ISDN_PTYPE_NI1
)paren
(brace
id|setstack_ni1
c_func
(paren
id|st
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif
macro_line|#ifdef&t;CONFIG_HISAX_1TR6
r_if
c_cond
(paren
id|st-&gt;protocol
op_eq
id|ISDN_PTYPE_1TR6
)paren
(brace
id|setstack_1tr6
c_func
(paren
id|st
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif
r_if
c_cond
(paren
id|st-&gt;protocol
op_eq
id|ISDN_PTYPE_LEASED
)paren
(brace
id|st-&gt;l4.l4l3
op_assign
id|no_l3_proto
suffix:semicolon
id|st-&gt;l2.l2l3
op_assign
id|no_l3_proto
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;HiSax: Leased line mode&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|st-&gt;l4.l4l3
op_assign
id|no_l3_proto
suffix:semicolon
id|st-&gt;l2.l2l3
op_assign
id|no_l3_proto
suffix:semicolon
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;protocol %s not supported&quot;
comma
(paren
id|st-&gt;protocol
op_eq
id|ISDN_PTYPE_1TR6
)paren
ques
c_cond
l_string|&quot;1tr6&quot;
suffix:colon
(paren
id|st-&gt;protocol
op_eq
id|ISDN_PTYPE_EURO
)paren
ques
c_cond
l_string|&quot;euro&quot;
suffix:colon
(paren
id|st-&gt;protocol
op_eq
id|ISDN_PTYPE_NI1
)paren
ques
c_cond
l_string|&quot;ni1&quot;
suffix:colon
l_string|&quot;unknown&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HiSax: %s&bslash;n&quot;
comma
id|tmp
)paren
suffix:semicolon
id|l3_debug
c_func
(paren
id|st
comma
id|tmp
)paren
suffix:semicolon
id|st-&gt;protocol
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
id|st-&gt;l3.state
op_assign
l_int|0
suffix:semicolon
id|st-&gt;l3.callref
op_assign
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|releasestack_isdnl3
id|releasestack_isdnl3
c_func
(paren
r_struct
id|PStack
op_star
id|st
)paren
(brace
id|StopAllL3Timer
c_func
(paren
id|st
)paren
suffix:semicolon
)brace
eof
