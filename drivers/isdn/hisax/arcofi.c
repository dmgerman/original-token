multiline_comment|/* $Id: arcofi.c,v 1.12 2000/11/25 17:01:00 kai Exp $&n; *&n; * arcofi.c   Ansteuerung ARCOFI 2165&n; *&n; * Author     Karsten Keil (keil@isdn4linux.de)&n; *&n; * This file is (c) under GNU PUBLIC LICENSE&n; *&n; */
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &quot;hisax.h&quot;
macro_line|#include &quot;isdnl1.h&quot;
macro_line|#include &quot;isac.h&quot;
macro_line|#include &quot;arcofi.h&quot;
DECL|macro|ARCOFI_TIMER_VALUE
mdefine_line|#define ARCOFI_TIMER_VALUE&t;20
r_static
r_void
DECL|function|add_arcofi_timer
id|add_arcofi_timer
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|FLG_ARCOFI_TIMER
comma
op_amp
id|cs-&gt;HW_Flags
)paren
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|cs-&gt;dc.isac.arcofitimer
)paren
suffix:semicolon
)brace
id|init_timer
c_func
(paren
op_amp
id|cs-&gt;dc.isac.arcofitimer
)paren
suffix:semicolon
id|cs-&gt;dc.isac.arcofitimer.expires
op_assign
id|jiffies
op_plus
(paren
(paren
id|ARCOFI_TIMER_VALUE
op_star
id|HZ
)paren
op_div
l_int|1000
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|cs-&gt;dc.isac.arcofitimer
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|send_arcofi
id|send_arcofi
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
id|u_char
id|val
suffix:semicolon
id|add_arcofi_timer
c_func
(paren
id|cs
)paren
suffix:semicolon
id|cs-&gt;dc.isac.mon_txp
op_assign
l_int|0
suffix:semicolon
id|cs-&gt;dc.isac.mon_txc
op_assign
id|cs-&gt;dc.isac.arcofi_list-&gt;len
suffix:semicolon
id|memcpy
c_func
(paren
id|cs-&gt;dc.isac.mon_tx
comma
id|cs-&gt;dc.isac.arcofi_list-&gt;msg
comma
id|cs-&gt;dc.isac.mon_txc
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cs-&gt;dc.isac.arcofi_bc
)paren
(brace
r_case
l_int|0
suffix:colon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|cs-&gt;dc.isac.mon_tx
(braket
l_int|1
)braket
op_or_assign
l_int|0x40
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|cs-&gt;dc.isac.mocr
op_and_assign
l_int|0x0f
suffix:semicolon
id|cs-&gt;dc.isac.mocr
op_or_assign
l_int|0xa0
suffix:semicolon
id|cs
op_member_access_from_pointer
id|writeisac
c_func
(paren
id|cs
comma
id|ISAC_MOCR
comma
id|cs-&gt;dc.isac.mocr
)paren
suffix:semicolon
id|val
op_assign
id|cs
op_member_access_from_pointer
id|readisac
c_func
(paren
id|cs
comma
id|ISAC_MOSR
)paren
suffix:semicolon
id|cs
op_member_access_from_pointer
id|writeisac
c_func
(paren
id|cs
comma
id|ISAC_MOX1
comma
id|cs-&gt;dc.isac.mon_tx
(braket
id|cs-&gt;dc.isac.mon_txp
op_increment
)braket
)paren
suffix:semicolon
id|cs-&gt;dc.isac.mocr
op_or_assign
l_int|0x10
suffix:semicolon
id|cs
op_member_access_from_pointer
id|writeisac
c_func
(paren
id|cs
comma
id|ISAC_MOCR
comma
id|cs-&gt;dc.isac.mocr
)paren
suffix:semicolon
)brace
r_int
DECL|function|arcofi_fsm
id|arcofi_fsm
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_int
id|event
comma
r_void
op_star
id|data
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_MONITOR
)paren
(brace
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;arcofi state %d event %d&quot;
comma
id|cs-&gt;dc.isac.arcofi_state
comma
id|event
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_eq
id|ARCOFI_TIMEOUT
)paren
(brace
id|cs-&gt;dc.isac.arcofi_state
op_assign
id|ARCOFI_NOP
suffix:semicolon
id|test_and_set_bit
c_func
(paren
id|FLG_ARCOFI_ERROR
comma
op_amp
id|cs-&gt;HW_Flags
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|cs-&gt;dc.isac.arcofi_wait
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cs-&gt;dc.isac.arcofi_state
)paren
(brace
r_case
id|ARCOFI_NOP
suffix:colon
r_if
c_cond
(paren
id|event
op_eq
id|ARCOFI_START
)paren
(brace
id|cs-&gt;dc.isac.arcofi_list
op_assign
id|data
suffix:semicolon
id|cs-&gt;dc.isac.arcofi_state
op_assign
id|ARCOFI_TRANSMIT
suffix:semicolon
id|send_arcofi
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ARCOFI_TRANSMIT
suffix:colon
r_if
c_cond
(paren
id|event
op_eq
id|ARCOFI_TX_END
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;dc.isac.arcofi_list-&gt;receive
)paren
(brace
id|add_arcofi_timer
c_func
(paren
id|cs
)paren
suffix:semicolon
id|cs-&gt;dc.isac.arcofi_state
op_assign
id|ARCOFI_RECEIVE
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|cs-&gt;dc.isac.arcofi_list-&gt;next
)paren
(brace
id|cs-&gt;dc.isac.arcofi_list
op_assign
id|cs-&gt;dc.isac.arcofi_list-&gt;next
suffix:semicolon
id|send_arcofi
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|FLG_ARCOFI_TIMER
comma
op_amp
id|cs-&gt;HW_Flags
)paren
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|cs-&gt;dc.isac.arcofitimer
)paren
suffix:semicolon
)brace
id|cs-&gt;dc.isac.arcofi_state
op_assign
id|ARCOFI_NOP
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|cs-&gt;dc.isac.arcofi_wait
)paren
suffix:semicolon
)brace
)brace
)brace
r_break
suffix:semicolon
r_case
id|ARCOFI_RECEIVE
suffix:colon
r_if
c_cond
(paren
id|event
op_eq
id|ARCOFI_RX_END
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;dc.isac.arcofi_list-&gt;next
)paren
(brace
id|cs-&gt;dc.isac.arcofi_list
op_assign
id|cs-&gt;dc.isac.arcofi_list-&gt;next
suffix:semicolon
id|cs-&gt;dc.isac.arcofi_state
op_assign
id|ARCOFI_TRANSMIT
suffix:semicolon
id|send_arcofi
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|FLG_ARCOFI_TIMER
comma
op_amp
id|cs-&gt;HW_Flags
)paren
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|cs-&gt;dc.isac.arcofitimer
)paren
suffix:semicolon
)brace
id|cs-&gt;dc.isac.arcofi_state
op_assign
id|ARCOFI_NOP
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|cs-&gt;dc.isac.arcofi_wait
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;Arcofi unknown state %x&quot;
comma
id|cs-&gt;dc.isac.arcofi_state
)paren
suffix:semicolon
r_return
l_int|2
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|arcofi_timer
id|arcofi_timer
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
id|arcofi_fsm
c_func
(paren
id|cs
comma
id|ARCOFI_TIMEOUT
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_void
DECL|function|clear_arcofi
id|clear_arcofi
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|FLG_ARCOFI_TIMER
comma
op_amp
id|cs-&gt;HW_Flags
)paren
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|cs-&gt;dc.isac.arcofitimer
)paren
suffix:semicolon
)brace
)brace
r_void
DECL|function|init_arcofi
id|init_arcofi
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
id|cs-&gt;dc.isac.arcofitimer.function
op_assign
(paren
r_void
op_star
)paren
id|arcofi_timer
suffix:semicolon
id|cs-&gt;dc.isac.arcofitimer.data
op_assign
(paren
r_int
)paren
id|cs
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|cs-&gt;dc.isac.arcofitimer
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|cs-&gt;dc.isac.arcofi_wait
)paren
suffix:semicolon
id|test_and_set_bit
c_func
(paren
id|HW_ARCOFI
comma
op_amp
id|cs-&gt;HW_Flags
)paren
suffix:semicolon
)brace
eof
