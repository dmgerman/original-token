multiline_comment|/* $Id: amd7930.c,v 1.5 2000/11/24 17:05:37 kai Exp $&n; *&n; * HiSax ISDN driver - chip specific routines for AMD 7930&n; *&n; * Author       Brent Baccala (baccala@FreeSoft.org)&n; *&n; *    - Existing ISDN HiSax driver provides all the smarts&n; *    - it compiles, runs, talks to an isolated phone switch, connects&n; *      to a Cisco, pings go through&n; *    - AMD 7930 support only (no DBRI yet)&n; *    - no US NI-1 support (may not work on US phone system - untested)&n; *    - periodic packet loss, apparently due to lost interrupts&n; *    - ISDN sometimes freezes, requiring reboot before it will work again&n; *&n; * The code is unreliable enough to be consider alpha&n; *&n; * This file is (c) under GNU PUBLIC LICENSE&n; *&n; * Advanced Micro Devices&squot; Am79C30A is an ISDN/audio chip used in the&n; * SparcStation 1+.  The chip provides microphone and speaker interfaces&n; * which provide mono-channel audio at 8K samples per second via either&n; * 8-bit A-law or 8-bit mu-law encoding.  Also, the chip features an&n; * ISDN BRI Line Interface Unit (LIU), I.430 S/T physical interface,&n; * which performs basic D channel LAPD processing and provides raw&n; * B channel data.  The digital audio channel, the two ISDN B channels,&n; * and two 64 Kbps channels to the microprocessor are all interconnected&n; * via a multiplexer.&n; *&n; * This driver interfaces to the Linux HiSax ISDN driver, which performs&n; * all high-level Q.921 and Q.931 ISDN functions.  The file is not&n; * itself a hardware driver; rather it uses functions exported by&n; * the AMD7930 driver in the sparcaudio subsystem (drivers/sbus/audio),&n; * allowing the chip to be simultaneously used for both audio and ISDN data.&n; * The hardware driver does _no_ buffering, but provides several callbacks&n; * which are called during interrupt service and should therefore run quickly.&n; *&n; * D channel transmission is performed by passing the hardware driver the&n; * address and size of an skb&squot;s data area, then waiting for a callback&n; * to signal successful transmission of the packet.  A task is then&n; * queued to notify the HiSax driver that another packet may be transmitted.&n; *&n; * D channel reception is quite simple, mainly because of:&n; *   1) the slow speed of the D channel - 16 kbps, and&n; *   2) the presence of an 8- or 32-byte (depending on chip version) FIFO&n; *      to buffer the D channel data on the chip&n; * Worst case scenario of back-to-back packets with the 8 byte buffer&n; * at 16 kbps yields an service time of 4 ms - long enough to preclude&n; * the need for fancy buffering.  We queue a background task that copies&n; * data out of the receive buffer into an skb, and the hardware driver&n; * simply does nothing until we&squot;re done with the receive buffer and&n; * reset it for a new packet.&n; *&n; * B channel processing is more complex, because of:&n; *   1) the faster speed - 64 kbps,&n; *   2) the lack of any on-chip buffering (it interrupts for every byte), and&n; *   3) the lack of any chip support for HDLC encapsulation&n; *&n; * The HiSax driver can put each B channel into one of three modes -&n; * L1_MODE_NULL (channel disabled), L1_MODE_TRANS (transparent data relay),&n; * and L1_MODE_HDLC (HDLC encapsulation by low-level driver).&n; * L1_MODE_HDLC is the most common, used for almost all &quot;pure&quot; digital&n; * data sessions.  L1_MODE_TRANS is used for ISDN audio.&n; *&n; * HDLC B channel transmission is performed via a large buffer into&n; * which the skb is copied while performing HDLC bit-stuffing.  A CRC&n; * is computed and attached to the end of the buffer, which is then&n; * passed to the low-level routines for raw transmission.  Once&n; * transmission is complete, the hardware driver is set to enter HDLC&n; * idle by successive transmission of mark (all 1) bytes, waiting for&n; * the ISDN driver to prepare another packet for transmission and&n; * deliver it.&n; *&n; * HDLC B channel reception is performed via an X-byte ring buffer&n; * divided into N sections of X/N bytes each.  Defaults: X=256 bytes, N=4.&n; * As the hardware driver notifies us that each section is full, we&n; * hand it the next section and schedule a background task to peruse&n; * the received section, bit-by-bit, with an HDLC decoder.  As&n; * packets are detected, they are copied into a large buffer while&n; * decoding HDLC bit-stuffing.  The ending CRC is verified, and if&n; * it is correct, we alloc a new skb of the correct length (which we&n; * now know), copy the packet into it, and hand it to the upper layers.&n; * Optimization: for large packets, we hand the buffer (which also&n; * happens to be an skb) directly to the upper layer after an skb_trim,&n; * and alloc a new large buffer for future packets, thus avoiding a copy.&n; * Then we return to HDLC processing; state is saved between calls.&n; * &n; */
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &quot;hisax.h&quot;
macro_line|#include &quot;../../sbus/audio/amd7930.h&quot;
macro_line|#include &quot;isac.h&quot;
macro_line|#include &quot;isdnl1.h&quot;
macro_line|#include &quot;rawhdlc.h&quot;
macro_line|#include &lt;linux/interrupt.h&gt;
DECL|variable|amd7930_revision
r_static
r_const
r_char
op_star
id|amd7930_revision
op_assign
l_string|&quot;$Revision: 1.5 $&quot;
suffix:semicolon
DECL|macro|RCV_BUFSIZE
mdefine_line|#define RCV_BUFSIZE&t;1024&t;/* Size of raw receive buffer in bytes */
DECL|macro|RCV_BUFBLKS
mdefine_line|#define RCV_BUFBLKS&t;4&t;/* Number of blocks to divide buffer into&n;&t;&t;&t;&t; * (must divide RCV_BUFSIZE) */
r_static
r_void
id|Bchan_fill_fifo
c_func
(paren
r_struct
id|BCState
op_star
comma
r_struct
id|sk_buff
op_star
)paren
suffix:semicolon
r_static
r_void
DECL|function|Bchan_xmt_bh
id|Bchan_xmt_bh
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|bcs-&gt;hw.amd7930.tx_skb
op_ne
l_int|NULL
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|bcs-&gt;hw.amd7930.tx_skb
)paren
suffix:semicolon
id|bcs-&gt;hw.amd7930.tx_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|bcs-&gt;squeue
)paren
)paren
)paren
(brace
id|Bchan_fill_fifo
c_func
(paren
id|bcs
comma
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
id|clear_bit
c_func
(paren
id|BC_FLG_BUSY
comma
op_amp
id|bcs-&gt;Flag
)paren
suffix:semicolon
id|bcs-&gt;event
op_or_assign
l_int|1
op_lshift
id|B_XMTBUFREADY
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|bcs-&gt;tqueue
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|Bchan_xmit_callback
id|Bchan_xmit_callback
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
)paren
(brace
id|queue_task
c_func
(paren
op_amp
id|bcs-&gt;hw.amd7930.tq_xmt
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
multiline_comment|/* B channel transmission: two modes (three, if you count L1_MODE_NULL)&n; *&n; * L1_MODE_HDLC - We need to do HDLC encapsulation before transmiting&n; * the packet (i.e. make_raw_hdlc_data).  Since this can be a&n; * time-consuming operation, our completion callback just schedules&n; * a bottom half to do encapsulation for the next packet.  In between,&n; * the link will just idle&n; *&n; * L1_MODE_TRANS - Data goes through, well, transparent.  No HDLC encap,&n; * and we can&squot;t just let the link idle, so the &quot;bottom half&quot; actually&n; * gets called during the top half (it&squot;s our callback routine in this case),&n; * but it&squot;s a lot faster now since we don&squot;t call make_raw_hdlc_data&n; */
r_static
r_void
DECL|function|Bchan_fill_fifo
id|Bchan_fill_fifo
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|cs
op_assign
id|bcs-&gt;cs
suffix:semicolon
r_int
id|len
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_HSCX
)paren
op_logical_or
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_HSCX_FIFO
)paren
)paren
(brace
r_char
id|tmp
(braket
l_int|1024
)braket
suffix:semicolon
r_char
op_star
id|t
op_assign
id|tmp
suffix:semicolon
id|t
op_add_assign
id|sprintf
c_func
(paren
id|t
comma
l_string|&quot;amd7930_fill_fifo %c cnt %d&quot;
comma
id|bcs-&gt;channel
ques
c_cond
l_char|&squot;B&squot;
suffix:colon
l_char|&squot;A&squot;
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_HSCX_FIFO
)paren
id|QuickHex
c_func
(paren
id|t
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
id|tmp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bcs-&gt;mode
op_eq
id|L1_MODE_HDLC
)paren
(brace
id|len
op_assign
id|make_raw_hdlc_data
c_func
(paren
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|bcs-&gt;hw.amd7930.tx_buff
comma
id|RAW_BUFMAX
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
id|amd7930_bxmit
c_func
(paren
l_int|0
comma
id|bcs-&gt;channel
comma
id|bcs-&gt;hw.amd7930.tx_buff
comma
id|len
comma
(paren
r_void
op_star
)paren
op_amp
id|Bchan_xmit_callback
comma
(paren
r_void
op_star
)paren
id|bcs
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bcs-&gt;mode
op_eq
id|L1_MODE_TRANS
)paren
(brace
id|amd7930_bxmit
c_func
(paren
l_int|0
comma
id|bcs-&gt;channel
comma
id|bcs-&gt;hw.amd7930.tx_buff
comma
id|skb-&gt;len
comma
(paren
r_void
op_star
)paren
op_amp
id|Bchan_xmt_bh
comma
(paren
r_void
op_star
)paren
id|bcs
)paren
suffix:semicolon
id|bcs-&gt;hw.amd7930.tx_skb
op_assign
id|skb
suffix:semicolon
)brace
r_else
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|Bchan_mode
id|Bchan_mode
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
comma
r_int
id|mode
comma
r_int
id|bc
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|cs
op_assign
id|bcs-&gt;cs
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_HSCX
)paren
(brace
r_char
id|tmp
(braket
l_int|40
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;AMD 7930 mode %d bchan %d/%d&quot;
comma
id|mode
comma
id|bc
comma
id|bcs-&gt;channel
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
id|tmp
)paren
suffix:semicolon
)brace
id|bcs-&gt;mode
op_assign
id|mode
suffix:semicolon
)brace
multiline_comment|/* Bchan_l2l1 is the entry point for upper layer routines that want to&n; * transmit on the B channel.  PH_DATA_REQ is a normal packet that&n; * we either start transmitting (if idle) or queue (if busy).&n; * PH_PULL_REQ can be called to request a callback message (PH_PULL_CNF)&n; * once the link is idle.  After a &quot;pull&quot; callback, the upper layer&n; * routines can use PH_PULL_IND to send data.&n; */
r_static
r_void
DECL|function|Bchan_l2l1
id|Bchan_l2l1
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|arg
suffix:semicolon
r_switch
c_cond
(paren
id|pr
)paren
(brace
r_case
(paren
id|PH_DATA_REQ
)paren
suffix:colon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|BC_FLG_BUSY
comma
op_amp
id|st-&gt;l1.bcs-&gt;Flag
)paren
)paren
(brace
id|skb_queue_tail
c_func
(paren
op_amp
id|st-&gt;l1.bcs-&gt;squeue
comma
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
id|test_and_set_bit
c_func
(paren
id|BC_FLG_BUSY
comma
op_amp
id|st-&gt;l1.bcs-&gt;Flag
)paren
suffix:semicolon
id|Bchan_fill_fifo
c_func
(paren
id|st-&gt;l1.bcs
comma
id|skb
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
(paren
id|PH_PULL_IND
)paren
suffix:colon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|BC_FLG_BUSY
comma
op_amp
id|st-&gt;l1.bcs-&gt;Flag
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;amd7930: this shouldn&squot;t happen&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|test_and_set_bit
c_func
(paren
id|BC_FLG_BUSY
comma
op_amp
id|st-&gt;l1.bcs-&gt;Flag
)paren
suffix:semicolon
id|Bchan_fill_fifo
c_func
(paren
id|st-&gt;l1.bcs
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|PH_PULL_REQ
)paren
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|BC_FLG_BUSY
comma
op_amp
id|st-&gt;l1.bcs-&gt;Flag
)paren
)paren
(brace
id|clear_bit
c_func
(paren
id|FLG_L1_PULL_REQ
comma
op_amp
id|st-&gt;l1.Flags
)paren
suffix:semicolon
id|st-&gt;l1
dot
id|l1l2
c_func
(paren
id|st
comma
id|PH_PULL_CNF
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_else
id|set_bit
c_func
(paren
id|FLG_L1_PULL_REQ
comma
op_amp
id|st-&gt;l1.Flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Receiver callback and bottom half - decodes HDLC at leisure (if&n; * L1_MODE_HDLC) and passes newly received skb on via bcs-&gt;rqueue.  If&n; * a large packet is received, stick rv_skb (the buffer that the&n; * packet has been decoded into) on the receive queue and alloc a new&n; * (large) skb to act as buffer for future receives.  If a small&n; * packet is received, leave rv_skb alone, alloc a new skb of the&n; * correct size, and copy the packet into it&n; */
r_static
r_void
DECL|function|Bchan_recv_callback
id|Bchan_recv_callback
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
)paren
(brace
r_struct
id|amd7930_hw
op_star
id|hw
op_assign
op_amp
id|bcs-&gt;hw.amd7930
suffix:semicolon
id|hw-&gt;rv_buff_in
op_add_assign
id|RCV_BUFSIZE
op_div
id|RCV_BUFBLKS
suffix:semicolon
id|hw-&gt;rv_buff_in
op_mod_assign
id|RCV_BUFSIZE
suffix:semicolon
r_if
c_cond
(paren
id|hw-&gt;rv_buff_in
op_ne
id|hw-&gt;rv_buff_out
)paren
(brace
id|amd7930_brecv
c_func
(paren
l_int|0
comma
id|bcs-&gt;channel
comma
id|hw-&gt;rv_buff
op_plus
id|hw-&gt;rv_buff_in
comma
id|RCV_BUFSIZE
op_div
id|RCV_BUFBLKS
comma
(paren
r_void
op_star
)paren
op_amp
id|Bchan_recv_callback
comma
(paren
r_void
op_star
)paren
id|bcs
)paren
suffix:semicolon
)brace
id|queue_task
c_func
(paren
op_amp
id|hw-&gt;tq_rcv
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|Bchan_rcv_bh
id|Bchan_rcv_bh
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|cs
op_assign
id|bcs-&gt;cs
suffix:semicolon
r_struct
id|amd7930_hw
op_star
id|hw
op_assign
op_amp
id|bcs-&gt;hw.amd7930
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|len
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_HSCX
)paren
(brace
r_char
id|tmp
(braket
l_int|1024
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;amd7930_Bchan_rcv (%d/%d)&quot;
comma
id|hw-&gt;rv_buff_in
comma
id|hw-&gt;rv_buff_out
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
id|tmp
)paren
suffix:semicolon
id|QuickHex
c_func
(paren
id|tmp
comma
id|hw-&gt;rv_buff
op_plus
id|hw-&gt;rv_buff_out
comma
id|RCV_BUFSIZE
op_div
id|RCV_BUFBLKS
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
id|tmp
)paren
suffix:semicolon
)brace
r_do
(brace
r_if
c_cond
(paren
id|bcs-&gt;mode
op_eq
id|L1_MODE_HDLC
)paren
(brace
r_while
c_loop
(paren
(paren
id|len
op_assign
id|read_raw_hdlc_data
c_func
(paren
id|hw-&gt;hdlc_state
comma
id|hw-&gt;rv_buff
op_plus
id|hw-&gt;rv_buff_out
comma
id|RCV_BUFSIZE
op_div
id|RCV_BUFBLKS
comma
id|hw-&gt;rv_skb-&gt;tail
comma
id|HSCX_BUFMAX
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|len
OG
l_int|0
op_logical_and
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_HSCX_FIFO
)paren
)paren
(brace
r_char
id|tmp
(braket
l_int|1024
)braket
suffix:semicolon
r_char
op_star
id|t
op_assign
id|tmp
suffix:semicolon
id|t
op_add_assign
id|sprintf
c_func
(paren
id|t
comma
l_string|&quot;amd7930_Bchan_rcv %c cnt %d&quot;
comma
id|bcs-&gt;channel
ques
c_cond
l_char|&squot;B&squot;
suffix:colon
l_char|&squot;A&squot;
comma
id|len
)paren
suffix:semicolon
id|QuickHex
c_func
(paren
id|t
comma
id|hw-&gt;rv_skb-&gt;tail
comma
id|len
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
id|tmp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OG
id|HSCX_BUFMAX
op_div
l_int|2
)paren
(brace
multiline_comment|/* Large packet received */
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|HSCX_BUFMAX
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;amd7930: receive out of memory&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|skb_put
c_func
(paren
id|hw-&gt;rv_skb
comma
id|len
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|bcs-&gt;rqueue
comma
id|hw-&gt;rv_skb
)paren
suffix:semicolon
id|hw-&gt;rv_skb
op_assign
id|skb
suffix:semicolon
id|bcs-&gt;event
op_or_assign
l_int|1
op_lshift
id|B_RCVBUFREADY
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|bcs-&gt;tqueue
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
multiline_comment|/* Small packet received */
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;amd7930: receive out of memory&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
comma
id|hw-&gt;rv_skb-&gt;tail
comma
id|len
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|bcs-&gt;rqueue
comma
id|skb
)paren
suffix:semicolon
id|bcs-&gt;event
op_or_assign
l_int|1
op_lshift
id|B_RCVBUFREADY
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|bcs-&gt;tqueue
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Reception Error */
multiline_comment|/* printk(&quot;amd7930: B channel receive error&bslash;n&quot;); */
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|bcs-&gt;mode
op_eq
id|L1_MODE_TRANS
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|RCV_BUFSIZE
op_div
id|RCV_BUFBLKS
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;amd7930: receive out of memory&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|RCV_BUFSIZE
op_div
id|RCV_BUFBLKS
)paren
comma
id|hw-&gt;rv_buff
op_plus
id|hw-&gt;rv_buff_out
comma
id|RCV_BUFSIZE
op_div
id|RCV_BUFBLKS
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|bcs-&gt;rqueue
comma
id|skb
)paren
suffix:semicolon
id|bcs-&gt;event
op_or_assign
l_int|1
op_lshift
id|B_RCVBUFREADY
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|bcs-&gt;tqueue
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|hw-&gt;rv_buff_in
op_eq
id|hw-&gt;rv_buff_out
)paren
(brace
multiline_comment|/* Buffer was filled up - need to restart receiver */
id|amd7930_brecv
c_func
(paren
l_int|0
comma
id|bcs-&gt;channel
comma
id|hw-&gt;rv_buff
op_plus
id|hw-&gt;rv_buff_in
comma
id|RCV_BUFSIZE
op_div
id|RCV_BUFBLKS
comma
(paren
r_void
op_star
)paren
op_amp
id|Bchan_recv_callback
comma
(paren
r_void
op_star
)paren
id|bcs
)paren
suffix:semicolon
)brace
id|hw-&gt;rv_buff_out
op_add_assign
id|RCV_BUFSIZE
op_div
id|RCV_BUFBLKS
suffix:semicolon
id|hw-&gt;rv_buff_out
op_mod_assign
id|RCV_BUFSIZE
suffix:semicolon
)brace
r_while
c_loop
(paren
id|hw-&gt;rv_buff_in
op_ne
id|hw-&gt;rv_buff_out
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|Bchan_close
id|Bchan_close
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|Bchan_mode
c_func
(paren
id|bcs
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|amd7930_bclose
c_func
(paren
l_int|0
comma
id|bcs-&gt;channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|BC_FLG_INIT
comma
op_amp
id|bcs-&gt;Flag
)paren
)paren
(brace
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|bcs-&gt;rqueue
)paren
)paren
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|bcs-&gt;squeue
)paren
)paren
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
id|test_and_clear_bit
c_func
(paren
id|BC_FLG_INIT
comma
op_amp
id|bcs-&gt;Flag
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|Bchan_open
id|Bchan_open
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
)paren
(brace
r_struct
id|amd7930_hw
op_star
id|hw
op_assign
op_amp
id|bcs-&gt;hw.amd7930
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_and_set_bit
c_func
(paren
id|BC_FLG_INIT
comma
op_amp
id|bcs-&gt;Flag
)paren
)paren
(brace
id|skb_queue_head_init
c_func
(paren
op_amp
id|bcs-&gt;rqueue
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|bcs-&gt;squeue
)paren
suffix:semicolon
)brace
id|test_and_clear_bit
c_func
(paren
id|BC_FLG_BUSY
comma
op_amp
id|bcs-&gt;Flag
)paren
suffix:semicolon
id|amd7930_bopen
c_func
(paren
l_int|0
comma
id|bcs-&gt;channel
comma
l_int|0xff
)paren
suffix:semicolon
id|hw-&gt;rv_buff_in
op_assign
l_int|0
suffix:semicolon
id|hw-&gt;rv_buff_out
op_assign
l_int|0
suffix:semicolon
id|hw-&gt;tx_skb
op_assign
l_int|NULL
suffix:semicolon
id|init_hdlc_state
c_func
(paren
id|hw-&gt;hdlc_state
comma
l_int|0
)paren
suffix:semicolon
id|amd7930_brecv
c_func
(paren
l_int|0
comma
id|bcs-&gt;channel
comma
id|hw-&gt;rv_buff
op_plus
id|hw-&gt;rv_buff_in
comma
id|RCV_BUFSIZE
op_div
id|RCV_BUFBLKS
comma
(paren
r_void
op_star
)paren
op_amp
id|Bchan_recv_callback
comma
(paren
r_void
op_star
)paren
id|bcs
)paren
suffix:semicolon
id|bcs-&gt;event
op_assign
l_int|0
suffix:semicolon
id|bcs-&gt;tx_cnt
op_assign
l_int|0
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|Bchan_init
id|Bchan_init
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|bcs-&gt;hw.amd7930.tx_buff
op_assign
id|kmalloc
c_func
(paren
id|RAW_BUFMAX
comma
id|GFP_ATOMIC
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HiSax: No memory for amd7930.tx_buff&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|bcs-&gt;hw.amd7930.rv_buff
op_assign
id|kmalloc
c_func
(paren
id|RCV_BUFSIZE
comma
id|GFP_ATOMIC
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HiSax: No memory for amd7930.rv_buff&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|bcs-&gt;hw.amd7930.rv_skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|HSCX_BUFMAX
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HiSax: No memory for amd7930.rv_skb&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|bcs-&gt;hw.amd7930.hdlc_state
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|hdlc_state
)paren
comma
id|GFP_ATOMIC
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HiSax: No memory for amd7930.hdlc_state&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|bcs-&gt;hw.amd7930.tq_rcv.sync
op_assign
l_int|0
suffix:semicolon
id|bcs-&gt;hw.amd7930.tq_rcv.routine
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_void
op_star
)paren
)paren
op_amp
id|Bchan_rcv_bh
suffix:semicolon
id|bcs-&gt;hw.amd7930.tq_rcv.data
op_assign
(paren
r_void
op_star
)paren
id|bcs
suffix:semicolon
id|bcs-&gt;hw.amd7930.tq_xmt.sync
op_assign
l_int|0
suffix:semicolon
id|bcs-&gt;hw.amd7930.tq_xmt.routine
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_void
op_star
)paren
)paren
op_amp
id|Bchan_xmt_bh
suffix:semicolon
id|bcs-&gt;hw.amd7930.tq_xmt.data
op_assign
(paren
r_void
op_star
)paren
id|bcs
suffix:semicolon
)brace
r_static
r_void
DECL|function|Bchan_manl1
id|Bchan_manl1
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
r_switch
c_cond
(paren
id|pr
)paren
(brace
r_case
(paren
id|PH_ACTIVATE_REQ
)paren
suffix:colon
id|test_and_set_bit
c_func
(paren
id|BC_FLG_ACTIV
comma
op_amp
id|st-&gt;l1.bcs-&gt;Flag
)paren
suffix:semicolon
id|Bchan_mode
c_func
(paren
id|st-&gt;l1.bcs
comma
id|st-&gt;l1.mode
comma
id|st-&gt;l1.bc
)paren
suffix:semicolon
id|st-&gt;l1
dot
id|l1man
c_func
(paren
id|st
comma
id|PH_ACTIVATE_CNF
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|PH_DEACTIVATE_REQ
)paren
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|BC_FLG_BUSY
comma
op_amp
id|st-&gt;l1.bcs-&gt;Flag
)paren
)paren
id|Bchan_mode
c_func
(paren
id|st-&gt;l1.bcs
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|test_and_clear_bit
c_func
(paren
id|BC_FLG_ACTIV
comma
op_amp
id|st-&gt;l1.bcs-&gt;Flag
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_int
DECL|function|setstack_amd7930
id|setstack_amd7930
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_struct
id|BCState
op_star
id|bcs
)paren
(brace
r_if
c_cond
(paren
id|Bchan_open
c_func
(paren
id|bcs
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|st-&gt;l1.bcs
op_assign
id|bcs
suffix:semicolon
id|st-&gt;l2.l2l1
op_assign
id|Bchan_l2l1
suffix:semicolon
id|st-&gt;ma.manl1
op_assign
id|Bchan_manl1
suffix:semicolon
id|setstack_manager
c_func
(paren
id|st
)paren
suffix:semicolon
id|bcs-&gt;st
op_assign
id|st
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|amd7930_drecv_callback
id|amd7930_drecv_callback
c_func
(paren
r_void
op_star
id|arg
comma
r_int
id|error
comma
r_int
r_int
id|count
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|cs
op_assign
(paren
r_struct
id|IsdnCardState
op_star
)paren
id|arg
suffix:semicolon
r_static
r_struct
id|tq_struct
id|task
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
multiline_comment|/* NOTE: This function is called directly from an interrupt handler */
r_if
c_cond
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|count
comma
id|GFP_ATOMIC
)paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HiSax: D receive out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|count
)paren
comma
id|cs-&gt;rcvbuf
comma
id|count
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|cs-&gt;rq
comma
id|skb
)paren
suffix:semicolon
)brace
id|task.routine
op_assign
(paren
r_void
op_star
)paren
id|DChannel_proc_rcv
suffix:semicolon
id|task.data
op_assign
(paren
r_void
op_star
)paren
id|cs
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|task
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC_FIFO
)paren
(brace
r_char
id|tmp
(braket
l_int|128
)braket
suffix:semicolon
r_char
op_star
id|t
op_assign
id|tmp
suffix:semicolon
id|t
op_add_assign
id|sprintf
c_func
(paren
id|t
comma
l_string|&quot;amd7930 Drecv cnt %d&quot;
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
id|t
op_add_assign
id|sprintf
c_func
(paren
id|t
comma
l_string|&quot; ERR %x&quot;
comma
id|error
)paren
suffix:semicolon
id|QuickHex
c_func
(paren
id|t
comma
id|cs-&gt;rcvbuf
comma
id|count
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
id|tmp
)paren
suffix:semicolon
)brace
id|amd7930_drecv
c_func
(paren
l_int|0
comma
id|cs-&gt;rcvbuf
comma
id|MAX_DFRAME_LEN
comma
op_amp
id|amd7930_drecv_callback
comma
id|cs
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|amd7930_dxmit_callback
id|amd7930_dxmit_callback
c_func
(paren
r_void
op_star
id|arg
comma
r_int
id|error
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|cs
op_assign
(paren
r_struct
id|IsdnCardState
op_star
)paren
id|arg
suffix:semicolon
r_static
r_struct
id|tq_struct
id|task
suffix:semicolon
multiline_comment|/* NOTE: This function is called directly from an interrupt handler */
multiline_comment|/* may wish to do retransmission here, if error indicates collision */
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC_FIFO
)paren
(brace
r_char
id|tmp
(braket
l_int|128
)braket
suffix:semicolon
r_char
op_star
id|t
op_assign
id|tmp
suffix:semicolon
id|t
op_add_assign
id|sprintf
c_func
(paren
id|t
comma
l_string|&quot;amd7930 Dxmit cnt %d&quot;
comma
id|cs-&gt;tx_skb-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
id|t
op_add_assign
id|sprintf
c_func
(paren
id|t
comma
l_string|&quot; ERR %x&quot;
comma
id|error
)paren
suffix:semicolon
id|QuickHex
c_func
(paren
id|t
comma
id|cs-&gt;tx_skb-&gt;data
comma
id|cs-&gt;tx_skb-&gt;len
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
id|tmp
)paren
suffix:semicolon
)brace
id|cs-&gt;tx_skb
op_assign
l_int|NULL
suffix:semicolon
id|task.routine
op_assign
(paren
r_void
op_star
)paren
id|DChannel_proc_xmt
suffix:semicolon
id|task.data
op_assign
(paren
r_void
op_star
)paren
id|cs
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|task
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|amd7930_Dchan_l2l1
id|amd7930_Dchan_l2l1
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|cs
op_assign
(paren
r_struct
id|IsdnCardState
op_star
)paren
id|st-&gt;l1.hardware
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|arg
suffix:semicolon
r_char
id|str
(braket
l_int|64
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|pr
)paren
(brace
r_case
(paren
id|PH_DATA_REQ
)paren
suffix:colon
r_if
c_cond
(paren
id|cs-&gt;tx_skb
)paren
(brace
id|skb_queue_tail
c_func
(paren
op_amp
id|cs-&gt;sq
comma
id|skb
)paren
suffix:semicolon
macro_line|#ifdef L2FRAME_DEBUG&t;&t;/* psa */
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_LAPD
)paren
id|Logl2Frame
c_func
(paren
id|cs
comma
id|skb
comma
l_string|&quot;PH_DATA Queued&quot;
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|cs-&gt;dlogflag
)paren
op_logical_and
(paren
op_logical_neg
(paren
id|skb-&gt;data
(braket
l_int|2
)braket
op_amp
l_int|1
)paren
)paren
)paren
(brace
multiline_comment|/* I-FRAME */
id|LogFrame
c_func
(paren
id|cs
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|str
comma
l_string|&quot;Q.931 frame user-&gt;network tei %d&quot;
comma
id|st-&gt;l2.tei
)paren
suffix:semicolon
id|dlogframe
c_func
(paren
id|cs
comma
id|skb-&gt;data
op_plus
l_int|4
comma
id|skb-&gt;len
op_minus
l_int|4
comma
id|str
)paren
suffix:semicolon
)brace
id|cs-&gt;tx_skb
op_assign
id|skb
suffix:semicolon
id|cs-&gt;tx_cnt
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef L2FRAME_DEBUG&t;&t;/* psa */
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_LAPD
)paren
id|Logl2Frame
c_func
(paren
id|cs
comma
id|skb
comma
l_string|&quot;PH_DATA&quot;
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|amd7930_dxmit
c_func
(paren
l_int|0
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
op_amp
id|amd7930_dxmit_callback
comma
id|cs
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
(paren
id|PH_PULL_IND
)paren
suffix:colon
r_if
c_cond
(paren
id|cs-&gt;tx_skb
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_WARN
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot; l2l1 tx_skb exist this shouldn&squot;t happen&quot;
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|cs-&gt;sq
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|cs-&gt;dlogflag
)paren
op_logical_and
(paren
op_logical_neg
(paren
id|skb-&gt;data
(braket
l_int|2
)braket
op_amp
l_int|1
)paren
)paren
)paren
(brace
multiline_comment|/* I-FRAME */
id|LogFrame
c_func
(paren
id|cs
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|str
comma
l_string|&quot;Q.931 frame user-&gt;network tei %d&quot;
comma
id|st-&gt;l2.tei
)paren
suffix:semicolon
id|dlogframe
c_func
(paren
id|cs
comma
id|skb-&gt;data
op_plus
l_int|4
comma
id|skb-&gt;len
op_minus
l_int|4
comma
id|str
)paren
suffix:semicolon
)brace
id|cs-&gt;tx_skb
op_assign
id|skb
suffix:semicolon
id|cs-&gt;tx_cnt
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef L2FRAME_DEBUG&t;&t;/* psa */
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_LAPD
)paren
id|Logl2Frame
c_func
(paren
id|cs
comma
id|skb
comma
l_string|&quot;PH_DATA_PULLED&quot;
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|amd7930_dxmit
c_func
(paren
l_int|0
comma
id|cs-&gt;tx_skb-&gt;data
comma
id|cs-&gt;tx_skb-&gt;len
comma
op_amp
id|amd7930_dxmit_callback
comma
id|cs
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|PH_PULL_REQ
)paren
suffix:colon
macro_line|#ifdef L2FRAME_DEBUG&t;&t;/* psa */
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_LAPD
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;-&gt; PH_REQUEST_PULL&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|cs-&gt;tx_skb
)paren
(brace
id|test_and_clear_bit
c_func
(paren
id|FLG_L1_PULL_REQ
comma
op_amp
id|st-&gt;l1.Flags
)paren
suffix:semicolon
id|st-&gt;l1
dot
id|l1l2
c_func
(paren
id|st
comma
id|PH_PULL_CNF
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_else
id|test_and_set_bit
c_func
(paren
id|FLG_L1_PULL_REQ
comma
op_amp
id|st-&gt;l1.Flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_int
DECL|function|setDstack_amd7930
id|setDstack_amd7930
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
id|st-&gt;l2.l2l1
op_assign
id|amd7930_Dchan_l2l1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cs-&gt;rcvbuf
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;setDstack_amd7930: No cs-&gt;rcvbuf!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|amd7930_drecv
c_func
(paren
l_int|0
comma
id|cs-&gt;rcvbuf
comma
id|MAX_DFRAME_LEN
comma
op_amp
id|amd7930_drecv_callback
comma
id|cs
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|manl1_msg
id|manl1_msg
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_int
id|msg
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|PStack
op_star
id|st
suffix:semicolon
id|st
op_assign
id|cs-&gt;stlist
suffix:semicolon
r_while
c_loop
(paren
id|st
)paren
(brace
id|st-&gt;ma
dot
id|manl1
c_func
(paren
id|st
comma
id|msg
comma
id|arg
)paren
suffix:semicolon
id|st
op_assign
id|st-&gt;next
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|amd7930_new_ph
id|amd7930_new_ph
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
r_switch
c_cond
(paren
id|amd7930_get_liu_state
c_func
(paren
l_int|0
)paren
)paren
(brace
r_case
l_int|3
suffix:colon
id|manl1_msg
c_func
(paren
id|cs
comma
id|PH_POWERUP_CNF
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|manl1_msg
c_func
(paren
id|cs
comma
id|PH_I4_P8_IND
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|manl1_msg
c_func
(paren
id|cs
comma
id|PH_RSYNC_IND
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* amd7930 LIU state change callback */
r_static
r_void
DECL|function|amd7930_liu_callback
id|amd7930_liu_callback
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
r_static
r_struct
id|tq_struct
id|task
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cs
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
(brace
r_char
id|tmp
(braket
l_int|32
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;amd7930_liu state %d&quot;
comma
id|amd7930_get_liu_state
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
id|tmp
)paren
suffix:semicolon
)brace
id|task.sync
op_assign
l_int|0
suffix:semicolon
id|task.routine
op_assign
(paren
r_void
op_star
)paren
op_amp
id|amd7930_new_ph
suffix:semicolon
id|task.data
op_assign
(paren
r_void
op_star
)paren
id|cs
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|task
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
r_void
DECL|function|amd7930_l1cmd
id|amd7930_l1cmd
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_int
id|msg
comma
r_void
op_star
id|arg
)paren
(brace
id|u_char
id|val
suffix:semicolon
r_char
id|tmp
(braket
l_int|32
)braket
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
(brace
r_char
id|tmp
(braket
l_int|32
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;amd7930_l1cmd msg %x&quot;
comma
id|msg
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
id|tmp
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|msg
)paren
(brace
r_case
id|PH_RESET_REQ
suffix:colon
r_if
c_cond
(paren
id|amd7930_get_liu_state
c_func
(paren
l_int|0
)paren
op_le
l_int|3
)paren
id|amd7930_liu_activate
c_func
(paren
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_else
id|amd7930_liu_deactivate
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PH_ENABLE_REQ
suffix:colon
r_break
suffix:semicolon
r_case
id|PH_INFO3_REQ
suffix:colon
id|amd7930_liu_activate
c_func
(paren
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PH_TESTLOOP_REQ
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_WARN
)paren
(brace
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;amd7930_l1cmd unknown %4x&quot;
comma
id|msg
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
id|tmp
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
DECL|function|init_amd7930
r_static
r_void
id|init_amd7930
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
id|Bchan_init
c_func
(paren
op_amp
id|cs-&gt;bcs
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|Bchan_init
c_func
(paren
op_amp
id|cs-&gt;bcs
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|cs-&gt;bcs
(braket
l_int|0
)braket
dot
id|BC_SetStack
op_assign
id|setstack_amd7930
suffix:semicolon
id|cs-&gt;bcs
(braket
l_int|1
)braket
dot
id|BC_SetStack
op_assign
id|setstack_amd7930
suffix:semicolon
id|cs-&gt;bcs
(braket
l_int|0
)braket
dot
id|BC_Close
op_assign
id|Bchan_close
suffix:semicolon
id|cs-&gt;bcs
(braket
l_int|1
)braket
dot
id|BC_Close
op_assign
id|Bchan_close
suffix:semicolon
id|Bchan_mode
c_func
(paren
id|cs-&gt;bcs
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|Bchan_mode
c_func
(paren
id|cs-&gt;bcs
op_plus
l_int|1
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
r_void
DECL|function|release_amd7930
id|release_amd7930
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
)brace
r_static
r_int
DECL|function|amd7930_card_msg
id|amd7930_card_msg
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_int
id|mt
comma
r_void
op_star
id|arg
)paren
(brace
r_switch
c_cond
(paren
id|mt
)paren
(brace
r_case
id|CARD_RESET
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|CARD_RELEASE
suffix:colon
id|release_amd7930
c_func
(paren
id|cs
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|CARD_INIT
suffix:colon
id|cs-&gt;l1cmd
op_assign
id|amd7930_l1cmd
suffix:semicolon
id|amd7930_liu_init
c_func
(paren
l_int|0
comma
op_amp
id|amd7930_liu_callback
comma
(paren
r_void
op_star
)paren
id|cs
)paren
suffix:semicolon
id|init_amd7930
c_func
(paren
id|cs
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|CARD_TEST
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_int
id|__init
DECL|function|setup_amd7930
id|setup_amd7930
c_func
(paren
r_struct
id|IsdnCard
op_star
id|card
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|cs
op_assign
id|card-&gt;cs
suffix:semicolon
r_char
id|tmp
(braket
l_int|64
)braket
suffix:semicolon
id|strcpy
c_func
(paren
id|tmp
comma
id|amd7930_revision
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HiSax: AMD7930 driver Rev. %s&bslash;n&quot;
comma
id|HiSax_getrev
c_func
(paren
id|tmp
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;typ
op_ne
id|ISDN_CTYPE_AMD7930
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|cs-&gt;irq
op_assign
id|amd7930_get_irqnum
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;irq
op_eq
l_int|0
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|cs-&gt;cardmsg
op_assign
op_amp
id|amd7930_card_msg
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
eof
