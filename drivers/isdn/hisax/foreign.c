multiline_comment|/* $Id: foreign.c,v 1.1 1998/11/09 07:48:48 baccala Exp $&n; *&n; * HiSax ISDN driver - foreign chipset interface&n; *&n; * Author       Brent Baccala (baccala@FreeSoft.org)&n; *&n; *&n; *&n; * $Log: foreign.c,v $&n; * Revision 1.1  1998/11/09 07:48:48  baccala&n; * Initial DBRI ISDN code.  Sometimes works (brings up the link and you&n; * can telnet through it), sometimes doesn&squot;t (crashes the machine)&n; *&n; * Revision 1.2  1998/02/12 23:07:10  keil&n; * change for 2.1.86 (removing FREE_READ/FREE_WRITE from [dev]_kfree_skb()&n; *&n; * Revision 1.1  1998/02/03 23:20:51  keil&n; * New files for SPARC isdn support&n; *&n; * Revision 1.1  1998/01/08 04:17:12  baccala&n; * ISDN comes to the Sparc.  Key points:&n; *&n; *    - Existing ISDN HiSax driver provides all the smarts&n; *    - it compiles, runs, talks to an isolated phone switch, connects&n; *      to a Cisco, pings go through&n; *    - AMD 7930 support only (no DBRI yet)&n; *    - no US NI-1 support (may not work on US phone system - untested)&n; *    - periodic packet loss, apparently due to lost interrupts&n; *    - ISDN sometimes freezes, requiring reboot before it will work again&n; *&n; * The code is unreliable enough to be consider alpha&n; *&n; *&n; * &n; */
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &quot;hisax.h&quot;
macro_line|#include &quot;isac.h&quot;
macro_line|#include &quot;isdnl1.h&quot;
macro_line|#include &quot;foreign.h&quot;
macro_line|#include &quot;rawhdlc.h&quot;
macro_line|#include &lt;linux/interrupt.h&gt;
DECL|variable|foreign_revision
r_static
r_const
r_char
op_star
id|foreign_revision
op_assign
l_string|&quot;$Revision: 1.1 $&quot;
suffix:semicolon
DECL|macro|RCV_BUFSIZE
mdefine_line|#define RCV_BUFSIZE&t;1024&t;/* Size of raw receive buffer in bytes */
DECL|macro|RCV_BUFBLKS
mdefine_line|#define RCV_BUFBLKS&t;4&t;/* Number of blocks to divide buffer into&n;&t;&t;&t;&t; * (must divide RCV_BUFSIZE) */
r_static
r_void
id|Bchan_fill_fifo
c_func
(paren
r_struct
id|BCState
op_star
comma
r_struct
id|sk_buff
op_star
)paren
suffix:semicolon
r_static
r_void
DECL|function|Bchan_xmt_bh
id|Bchan_xmt_bh
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|bcs-&gt;hw.foreign.tx_skb
op_ne
l_int|NULL
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|bcs-&gt;hw.foreign.tx_skb
)paren
suffix:semicolon
id|bcs-&gt;hw.foreign.tx_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|bcs-&gt;squeue
)paren
)paren
)paren
(brace
id|Bchan_fill_fifo
c_func
(paren
id|bcs
comma
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
id|clear_bit
c_func
(paren
id|BC_FLG_BUSY
comma
op_amp
id|bcs-&gt;Flag
)paren
suffix:semicolon
id|bcs-&gt;event
op_or_assign
l_int|1
op_lshift
id|B_XMTBUFREADY
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|bcs-&gt;tqueue
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|Bchan_xmit_callback
id|Bchan_xmit_callback
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
)paren
(brace
id|queue_task
c_func
(paren
op_amp
id|bcs-&gt;hw.foreign.tq_xmt
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
multiline_comment|/* B channel transmission: two modes (three, if you count L1_MODE_NULL)&n; *&n; * L1_MODE_HDLC - We need to do HDLC encapsulation before transmiting&n; * the packet (i.e. make_raw_hdlc_data).  Since this can be a&n; * time-consuming operation, our completion callback just schedules&n; * a bottom half to do encapsulation for the next packet.  In between,&n; * the link will just idle&n; *&n; * L1_MODE_TRANS - Data goes through, well, transparent.  No HDLC encap,&n; * and we can&squot;t just let the link idle, so the &quot;bottom half&quot; actually&n; * gets called during the top half (it&squot;s our callback routine in this case),&n; * but it&squot;s a lot faster now since we don&squot;t call make_raw_hdlc_data&n; */
r_static
r_void
DECL|function|Bchan_fill_fifo
id|Bchan_fill_fifo
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|cs
op_assign
id|bcs-&gt;cs
suffix:semicolon
r_struct
id|foreign_hw
op_star
id|hw
op_assign
op_amp
id|bcs-&gt;hw.foreign
suffix:semicolon
r_int
id|len
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_HSCX
)paren
op_logical_or
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_HSCX_FIFO
)paren
)paren
(brace
r_char
id|tmp
(braket
l_int|2048
)braket
suffix:semicolon
r_char
op_star
id|t
op_assign
id|tmp
suffix:semicolon
id|t
op_add_assign
id|sprintf
c_func
(paren
id|t
comma
l_string|&quot;Bchan_fill_fifo %c cnt %d&quot;
comma
id|bcs-&gt;channel
ques
c_cond
l_char|&squot;B&squot;
suffix:colon
l_char|&squot;A&squot;
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_HSCX_FIFO
)paren
id|QuickHex
c_func
(paren
id|t
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
id|tmp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hw-&gt;doHDLCprocessing
)paren
(brace
id|len
op_assign
id|make_raw_hdlc_data
c_func
(paren
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|bcs-&gt;hw.foreign.tx_buff
comma
id|RAW_BUFMAX
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
id|cs-&gt;hw.foreign
op_member_access_from_pointer
id|bxmit
c_func
(paren
l_int|0
comma
id|bcs-&gt;channel
comma
id|bcs-&gt;hw.foreign.tx_buff
comma
id|len
comma
(paren
r_void
op_star
)paren
op_amp
id|Bchan_xmit_callback
comma
(paren
r_void
op_star
)paren
id|bcs
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
id|cs-&gt;hw.foreign
op_member_access_from_pointer
id|bxmit
c_func
(paren
l_int|0
comma
id|bcs-&gt;channel
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
(paren
r_void
op_star
)paren
op_amp
id|Bchan_xmit_callback
comma
(paren
r_void
op_star
)paren
id|bcs
)paren
suffix:semicolon
id|bcs-&gt;hw.foreign.tx_skb
op_assign
id|skb
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|Bchan_mode
id|Bchan_mode
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
comma
r_int
id|mode
comma
r_int
id|bc
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|cs
op_assign
id|bcs-&gt;cs
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_HSCX
)paren
(brace
r_char
id|tmp
(braket
l_int|40
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;foreign mode %d bchan %d/%d&quot;
comma
id|mode
comma
id|bc
comma
id|bcs-&gt;channel
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
id|tmp
)paren
suffix:semicolon
)brace
id|bcs-&gt;mode
op_assign
id|mode
suffix:semicolon
)brace
multiline_comment|/* Bchan_l2l1 is the entry point for upper layer routines that want to&n; * transmit on the B channel.  PH_DATA_REQ is a normal packet that&n; * we either start transmitting (if idle) or queue (if busy).&n; * PH_PULL_REQ can be called to request a callback message (PH_PULL_CNF)&n; * once the link is idle.  After a &quot;pull&quot; callback, the upper layer&n; * routines can use PH_PULL_IND to send data.&n; */
r_static
r_void
DECL|function|Bchan_l2l1
id|Bchan_l2l1
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|arg
suffix:semicolon
r_switch
c_cond
(paren
id|pr
)paren
(brace
r_case
(paren
id|PH_DATA_REQ
)paren
suffix:colon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|BC_FLG_BUSY
comma
op_amp
id|st-&gt;l1.bcs-&gt;Flag
)paren
)paren
(brace
id|skb_queue_tail
c_func
(paren
op_amp
id|st-&gt;l1.bcs-&gt;squeue
comma
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
id|test_and_set_bit
c_func
(paren
id|BC_FLG_BUSY
comma
op_amp
id|st-&gt;l1.bcs-&gt;Flag
)paren
suffix:semicolon
id|Bchan_fill_fifo
c_func
(paren
id|st-&gt;l1.bcs
comma
id|skb
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
(paren
id|PH_PULL_IND
)paren
suffix:colon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|BC_FLG_BUSY
comma
op_amp
id|st-&gt;l1.bcs-&gt;Flag
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;foreign: this shouldn&squot;t happen&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|test_and_set_bit
c_func
(paren
id|BC_FLG_BUSY
comma
op_amp
id|st-&gt;l1.bcs-&gt;Flag
)paren
suffix:semicolon
id|Bchan_fill_fifo
c_func
(paren
id|st-&gt;l1.bcs
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|PH_PULL_REQ
)paren
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|BC_FLG_BUSY
comma
op_amp
id|st-&gt;l1.bcs-&gt;Flag
)paren
)paren
(brace
id|clear_bit
c_func
(paren
id|FLG_L1_PULL_REQ
comma
op_amp
id|st-&gt;l1.Flags
)paren
suffix:semicolon
id|st-&gt;l1
dot
id|l1l2
c_func
(paren
id|st
comma
id|PH_PULL_CNF
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_else
id|set_bit
c_func
(paren
id|FLG_L1_PULL_REQ
comma
op_amp
id|st-&gt;l1.Flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;****************************************************************************&n;***************** Receiver callback and bottom half ************************&n;****************************************************************************&n;*/
multiline_comment|/* Bchan_recv_done() is called when a frame has been completely decoded&n; * into hw-&gt;rv_skb and we&squot;re ready to hand it off to the HiSax upper&n; * layer.  If a &quot;large&quot; packet is received, stick rv_skb on the&n; * receive queue and alloc a new (large) skb to act as buffer for&n; * future receives.  If a small packet is received, leave rv_skb&n; * alone, alloc a new skb of the correct size, and copy the packet&n; * into it.  In any case, flag the channel as B_RCVBUFREADY and&n; * queue the upper layer&squot;s task.&n; */
r_static
r_void
DECL|function|Bchan_recv_done
id|Bchan_recv_done
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
comma
r_int
r_int
id|len
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|cs
op_assign
id|bcs-&gt;cs
suffix:semicolon
r_struct
id|foreign_hw
op_star
id|hw
op_assign
op_amp
id|bcs-&gt;hw.foreign
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_HSCX_FIFO
)paren
(brace
r_char
id|tmp
(braket
l_int|2048
)braket
suffix:semicolon
r_char
op_star
id|t
op_assign
id|tmp
suffix:semicolon
id|t
op_add_assign
id|sprintf
c_func
(paren
id|t
comma
l_string|&quot;Bchan_rcv %c cnt %d (%x)&quot;
comma
id|bcs-&gt;channel
ques
c_cond
l_char|&squot;B&squot;
suffix:colon
l_char|&squot;A&squot;
comma
id|len
comma
id|hw-&gt;rv_skb-&gt;tail
)paren
suffix:semicolon
id|QuickHex
c_func
(paren
id|t
comma
id|hw-&gt;rv_skb-&gt;tail
comma
id|len
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
id|tmp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OG
id|HSCX_BUFMAX
op_div
l_int|2
)paren
(brace
multiline_comment|/* Large packet received */
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|HSCX_BUFMAX
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;foreign: receive out of memory&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|skb_put
c_func
(paren
id|hw-&gt;rv_skb
comma
id|len
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|bcs-&gt;rqueue
comma
id|hw-&gt;rv_skb
)paren
suffix:semicolon
id|hw-&gt;rv_skb
op_assign
id|skb
suffix:semicolon
id|bcs-&gt;event
op_or_assign
l_int|1
op_lshift
id|B_RCVBUFREADY
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|bcs-&gt;tqueue
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Small packet received */
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;foreign: receive out of memory&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
comma
id|hw-&gt;rv_skb-&gt;tail
comma
id|len
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|bcs-&gt;rqueue
comma
id|skb
)paren
suffix:semicolon
id|bcs-&gt;event
op_or_assign
l_int|1
op_lshift
id|B_RCVBUFREADY
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|bcs-&gt;tqueue
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Bchan_recv_callback()&squot;s behavior depends on whether we&squot;re doing local&n; * HDLC processing.  If so, receive into hw-&gt;rv_buff and queue Bchan_rcv_bh&n; * to decode the HDLC at leisure.  Otherwise, receive directly into hw-&gt;rv_skb&n; * and call Bchan_recv_done().  In either case, prepare a new buffer for&n; * further receives and hand it to the hardware driver.&n; */
r_static
r_void
DECL|function|Bchan_recv_callback
id|Bchan_recv_callback
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
comma
r_int
id|error
comma
r_int
r_int
id|len
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|cs
op_assign
id|bcs-&gt;cs
suffix:semicolon
r_struct
id|foreign_hw
op_star
id|hw
op_assign
op_amp
id|bcs-&gt;hw.foreign
suffix:semicolon
r_if
c_cond
(paren
id|hw-&gt;doHDLCprocessing
)paren
(brace
id|hw-&gt;rv_buff_in
op_add_assign
id|RCV_BUFSIZE
op_div
id|RCV_BUFBLKS
suffix:semicolon
id|hw-&gt;rv_buff_in
op_mod_assign
id|RCV_BUFSIZE
suffix:semicolon
r_if
c_cond
(paren
id|hw-&gt;rv_buff_in
op_ne
id|hw-&gt;rv_buff_out
)paren
(brace
id|cs-&gt;hw.foreign
op_member_access_from_pointer
id|brecv
c_func
(paren
l_int|0
comma
id|bcs-&gt;channel
comma
id|hw-&gt;rv_buff
op_plus
id|hw-&gt;rv_buff_in
comma
id|RCV_BUFSIZE
op_div
id|RCV_BUFBLKS
comma
(paren
r_void
op_star
)paren
op_amp
id|Bchan_recv_callback
comma
(paren
r_void
op_star
)paren
id|bcs
)paren
suffix:semicolon
)brace
id|queue_task
c_func
(paren
op_amp
id|hw-&gt;tq_rcv
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|error
)paren
(brace
r_char
id|tmp
(braket
l_int|256
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;B channel %c receive error %x&quot;
comma
id|bcs-&gt;channel
ques
c_cond
l_char|&squot;B&squot;
suffix:colon
l_char|&squot;A&squot;
comma
id|error
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
id|tmp
)paren
suffix:semicolon
)brace
r_else
(brace
id|Bchan_recv_done
c_func
(paren
id|bcs
comma
id|len
)paren
suffix:semicolon
)brace
id|cs-&gt;hw.foreign
op_member_access_from_pointer
id|brecv
c_func
(paren
l_int|0
comma
id|bcs-&gt;channel
comma
id|hw-&gt;rv_skb-&gt;tail
comma
id|HSCX_BUFMAX
comma
(paren
r_void
op_star
)paren
op_amp
id|Bchan_recv_callback
comma
(paren
r_void
op_star
)paren
id|bcs
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Bchan_rcv_bh() is a &quot;shim&quot; bottom half handler stuck in between&n; * Bchan_recv_callback() and the HiSax upper layer if we need to&n; * do local HDLC processing.&n; */
r_static
r_void
DECL|function|Bchan_rcv_bh
id|Bchan_rcv_bh
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|cs
op_assign
id|bcs-&gt;cs
suffix:semicolon
r_struct
id|foreign_hw
op_star
id|hw
op_assign
op_amp
id|bcs-&gt;hw.foreign
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|len
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_HSCX
)paren
(brace
r_char
id|tmp
(braket
l_int|1024
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;foreign_Bchan_rcv (%d/%d)&quot;
comma
id|hw-&gt;rv_buff_in
comma
id|hw-&gt;rv_buff_out
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
id|tmp
)paren
suffix:semicolon
)brace
r_do
(brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_HSCX
)paren
(brace
r_char
id|tmp
(braket
l_int|1024
)braket
suffix:semicolon
id|QuickHex
c_func
(paren
id|tmp
comma
id|hw-&gt;rv_buff
op_plus
id|hw-&gt;rv_buff_out
comma
id|RCV_BUFSIZE
op_div
id|RCV_BUFBLKS
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
id|tmp
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|len
op_assign
id|read_raw_hdlc_data
c_func
(paren
id|hw-&gt;hdlc_state
comma
id|hw-&gt;rv_buff
op_plus
id|hw-&gt;rv_buff_out
comma
id|RCV_BUFSIZE
op_div
id|RCV_BUFBLKS
comma
id|hw-&gt;rv_skb-&gt;tail
comma
id|HSCX_BUFMAX
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
id|Bchan_recv_done
c_func
(paren
id|bcs
comma
id|len
)paren
suffix:semicolon
)brace
r_else
(brace
r_char
id|tmp
(braket
l_int|256
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;B channel %c receive error&quot;
comma
id|bcs-&gt;channel
ques
c_cond
l_char|&squot;B&squot;
suffix:colon
l_char|&squot;A&squot;
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
id|tmp
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|hw-&gt;rv_buff_in
op_eq
id|hw-&gt;rv_buff_out
)paren
(brace
multiline_comment|/* Buffer was filled up - need to restart receiver */
id|cs-&gt;hw.foreign
op_member_access_from_pointer
id|brecv
c_func
(paren
l_int|0
comma
id|bcs-&gt;channel
comma
id|hw-&gt;rv_buff
op_plus
id|hw-&gt;rv_buff_in
comma
id|RCV_BUFSIZE
op_div
id|RCV_BUFBLKS
comma
(paren
r_void
op_star
)paren
op_amp
id|Bchan_recv_callback
comma
(paren
r_void
op_star
)paren
id|bcs
)paren
suffix:semicolon
)brace
id|hw-&gt;rv_buff_out
op_add_assign
id|RCV_BUFSIZE
op_div
id|RCV_BUFBLKS
suffix:semicolon
id|hw-&gt;rv_buff_out
op_mod_assign
id|RCV_BUFSIZE
suffix:semicolon
)brace
r_while
c_loop
(paren
id|hw-&gt;rv_buff_in
op_ne
id|hw-&gt;rv_buff_out
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|Bchan_close
id|Bchan_close
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|cs
op_assign
id|bcs-&gt;cs
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|Bchan_mode
c_func
(paren
id|bcs
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|cs-&gt;hw.foreign
op_member_access_from_pointer
id|bclose
c_func
(paren
l_int|0
comma
id|bcs-&gt;channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|BC_FLG_INIT
comma
op_amp
id|bcs-&gt;Flag
)paren
)paren
(brace
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|bcs-&gt;rqueue
)paren
)paren
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|bcs-&gt;squeue
)paren
)paren
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
id|test_and_clear_bit
c_func
(paren
id|BC_FLG_INIT
comma
op_amp
id|bcs-&gt;Flag
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|Bchan_open
id|Bchan_open
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|cs
op_assign
id|bcs-&gt;cs
suffix:semicolon
r_struct
id|foreign_hw
op_star
id|hw
op_assign
op_amp
id|bcs-&gt;hw.foreign
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_and_set_bit
c_func
(paren
id|BC_FLG_INIT
comma
op_amp
id|bcs-&gt;Flag
)paren
)paren
(brace
id|skb_queue_head_init
c_func
(paren
op_amp
id|bcs-&gt;rqueue
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|bcs-&gt;squeue
)paren
suffix:semicolon
)brace
id|test_and_clear_bit
c_func
(paren
id|BC_FLG_BUSY
comma
op_amp
id|bcs-&gt;Flag
)paren
suffix:semicolon
id|hw-&gt;doHDLCprocessing
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|bcs-&gt;mode
op_eq
id|L1_MODE_HDLC
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;hw.foreign
op_member_access_from_pointer
id|bopen
c_func
(paren
l_int|0
comma
id|bcs-&gt;channel
comma
l_int|1
comma
l_int|0xff
)paren
op_eq
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;hw.foreign
op_member_access_from_pointer
id|bopen
c_func
(paren
l_int|0
comma
id|bcs-&gt;channel
comma
l_int|0
comma
l_int|0xff
)paren
op_eq
op_minus
l_int|1
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|hw-&gt;doHDLCprocessing
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|cs-&gt;hw.foreign
op_member_access_from_pointer
id|bopen
c_func
(paren
l_int|0
comma
id|bcs-&gt;channel
comma
l_int|0
comma
l_int|0xff
)paren
op_eq
op_minus
l_int|1
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
)brace
id|hw-&gt;rv_buff_in
op_assign
l_int|0
suffix:semicolon
id|hw-&gt;rv_buff_out
op_assign
l_int|0
suffix:semicolon
id|hw-&gt;tx_skb
op_assign
l_int|NULL
suffix:semicolon
id|init_hdlc_state
c_func
(paren
id|hw-&gt;hdlc_state
comma
l_int|0
)paren
suffix:semicolon
id|cs-&gt;hw.foreign
op_member_access_from_pointer
id|brecv
c_func
(paren
l_int|0
comma
id|bcs-&gt;channel
comma
id|hw-&gt;rv_buff
op_plus
id|hw-&gt;rv_buff_in
comma
id|RCV_BUFSIZE
op_div
id|RCV_BUFBLKS
comma
(paren
r_void
op_star
)paren
op_amp
id|Bchan_recv_callback
comma
(paren
r_void
op_star
)paren
id|bcs
)paren
suffix:semicolon
id|bcs-&gt;event
op_assign
l_int|0
suffix:semicolon
id|bcs-&gt;tx_cnt
op_assign
l_int|0
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|Bchan_init
id|Bchan_init
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|bcs-&gt;hw.foreign.tx_buff
op_assign
id|kmalloc
c_func
(paren
id|RAW_BUFMAX
comma
id|GFP_ATOMIC
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HiSax: No memory for foreign.tx_buff&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|bcs-&gt;hw.foreign.rv_buff
op_assign
id|kmalloc
c_func
(paren
id|RCV_BUFSIZE
comma
id|GFP_ATOMIC
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HiSax: No memory for foreign.rv_buff&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|bcs-&gt;hw.foreign.rv_skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|HSCX_BUFMAX
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HiSax: No memory for foreign.rv_skb&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|bcs-&gt;hw.foreign.hdlc_state
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|hdlc_state
)paren
comma
id|GFP_ATOMIC
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HiSax: No memory for foreign.hdlc_state&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|bcs-&gt;hw.foreign.tq_rcv.sync
op_assign
l_int|0
suffix:semicolon
id|bcs-&gt;hw.foreign.tq_rcv.routine
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_void
op_star
)paren
)paren
op_amp
id|Bchan_rcv_bh
suffix:semicolon
id|bcs-&gt;hw.foreign.tq_rcv.data
op_assign
(paren
r_void
op_star
)paren
id|bcs
suffix:semicolon
id|bcs-&gt;hw.foreign.tq_xmt.sync
op_assign
l_int|0
suffix:semicolon
id|bcs-&gt;hw.foreign.tq_xmt.routine
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_void
op_star
)paren
)paren
op_amp
id|Bchan_xmt_bh
suffix:semicolon
id|bcs-&gt;hw.foreign.tq_xmt.data
op_assign
(paren
r_void
op_star
)paren
id|bcs
suffix:semicolon
)brace
r_static
r_void
DECL|function|Bchan_manl1
id|Bchan_manl1
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
r_switch
c_cond
(paren
id|pr
)paren
(brace
r_case
(paren
id|PH_ACTIVATE_REQ
)paren
suffix:colon
id|test_and_set_bit
c_func
(paren
id|BC_FLG_ACTIV
comma
op_amp
id|st-&gt;l1.bcs-&gt;Flag
)paren
suffix:semicolon
id|Bchan_mode
c_func
(paren
id|st-&gt;l1.bcs
comma
id|st-&gt;l1.mode
comma
id|st-&gt;l1.bc
)paren
suffix:semicolon
id|st-&gt;l1
dot
id|l1man
c_func
(paren
id|st
comma
id|PH_ACTIVATE_CNF
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|PH_DEACTIVATE_REQ
)paren
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|BC_FLG_BUSY
comma
op_amp
id|st-&gt;l1.bcs-&gt;Flag
)paren
)paren
id|Bchan_mode
c_func
(paren
id|st-&gt;l1.bcs
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|test_and_clear_bit
c_func
(paren
id|BC_FLG_ACTIV
comma
op_amp
id|st-&gt;l1.bcs-&gt;Flag
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_int
DECL|function|setstack_foreign
id|setstack_foreign
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_struct
id|BCState
op_star
id|bcs
)paren
(brace
r_if
c_cond
(paren
id|Bchan_open
c_func
(paren
id|bcs
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|st-&gt;l1.bcs
op_assign
id|bcs
suffix:semicolon
id|st-&gt;l2.l2l1
op_assign
id|Bchan_l2l1
suffix:semicolon
id|st-&gt;ma.manl1
op_assign
id|Bchan_manl1
suffix:semicolon
id|setstack_manager
c_func
(paren
id|st
)paren
suffix:semicolon
id|bcs-&gt;st
op_assign
id|st
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|foreign_drecv_callback
id|foreign_drecv_callback
c_func
(paren
r_void
op_star
id|arg
comma
r_int
id|error
comma
r_int
r_int
id|count
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|cs
op_assign
(paren
r_struct
id|IsdnCardState
op_star
)paren
id|arg
suffix:semicolon
r_static
r_struct
id|tq_struct
id|task
op_assign
(brace
l_int|0
comma
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|DChannel_proc_rcv
comma
l_int|0
)brace
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
multiline_comment|/* NOTE: This function is called directly from an interrupt handler */
r_if
c_cond
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|count
comma
id|GFP_ATOMIC
)paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HiSax: D receive out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|count
)paren
comma
id|cs-&gt;rcvbuf
comma
id|count
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|cs-&gt;rq
comma
id|skb
)paren
suffix:semicolon
)brace
id|task.data
op_assign
(paren
r_void
op_star
)paren
id|cs
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|task
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC_FIFO
)paren
(brace
r_char
id|tmp
(braket
l_int|128
)braket
suffix:semicolon
r_char
op_star
id|t
op_assign
id|tmp
suffix:semicolon
id|t
op_add_assign
id|sprintf
c_func
(paren
id|t
comma
l_string|&quot;foreign Drecv cnt %d&quot;
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
id|t
op_add_assign
id|sprintf
c_func
(paren
id|t
comma
l_string|&quot; ERR %x&quot;
comma
id|error
)paren
suffix:semicolon
id|QuickHex
c_func
(paren
id|t
comma
id|cs-&gt;rcvbuf
comma
id|count
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
id|tmp
)paren
suffix:semicolon
)brace
id|cs-&gt;hw.foreign
op_member_access_from_pointer
id|drecv
c_func
(paren
l_int|0
comma
id|cs-&gt;rcvbuf
comma
id|MAX_DFRAME_LEN
comma
op_amp
id|foreign_drecv_callback
comma
id|cs
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|foreign_dxmit_callback
id|foreign_dxmit_callback
c_func
(paren
r_void
op_star
id|arg
comma
r_int
id|error
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|cs
op_assign
(paren
r_struct
id|IsdnCardState
op_star
)paren
id|arg
suffix:semicolon
r_static
r_struct
id|tq_struct
id|task
op_assign
(brace
l_int|0
comma
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|DChannel_proc_xmt
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/* NOTE: This function is called directly from an interrupt handler */
multiline_comment|/* may wish to do retransmission here, if error indicates collision */
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC_FIFO
)paren
(brace
r_char
id|tmp
(braket
l_int|128
)braket
suffix:semicolon
r_char
op_star
id|t
op_assign
id|tmp
suffix:semicolon
id|t
op_add_assign
id|sprintf
c_func
(paren
id|t
comma
l_string|&quot;foreign Dxmit cnt %d&quot;
comma
id|cs-&gt;tx_skb-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
id|t
op_add_assign
id|sprintf
c_func
(paren
id|t
comma
l_string|&quot; ERR %x&quot;
comma
id|error
)paren
suffix:semicolon
id|QuickHex
c_func
(paren
id|t
comma
id|cs-&gt;tx_skb-&gt;data
comma
id|cs-&gt;tx_skb-&gt;len
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
id|tmp
)paren
suffix:semicolon
)brace
id|cs-&gt;tx_skb
op_assign
l_int|NULL
suffix:semicolon
id|task.data
op_assign
(paren
r_void
op_star
)paren
id|cs
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|task
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|foreign_Dchan_l2l1
id|foreign_Dchan_l2l1
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|cs
op_assign
(paren
r_struct
id|IsdnCardState
op_star
)paren
id|st-&gt;l1.hardware
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|arg
suffix:semicolon
r_char
id|str
(braket
l_int|64
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|pr
)paren
(brace
r_case
(paren
id|PH_DATA_REQ
)paren
suffix:colon
r_if
c_cond
(paren
id|cs-&gt;tx_skb
)paren
(brace
id|skb_queue_tail
c_func
(paren
op_amp
id|cs-&gt;sq
comma
id|skb
)paren
suffix:semicolon
macro_line|#ifdef L2FRAME_DEBUG&t;&t;/* psa */
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_LAPD
)paren
id|Logl2Frame
c_func
(paren
id|cs
comma
id|skb
comma
l_string|&quot;PH_DATA Queued&quot;
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|cs-&gt;dlogflag
)paren
op_logical_and
(paren
op_logical_neg
(paren
id|skb-&gt;data
(braket
l_int|2
)braket
op_amp
l_int|1
)paren
)paren
)paren
(brace
multiline_comment|/* I-FRAME */
id|LogFrame
c_func
(paren
id|cs
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|str
comma
l_string|&quot;Q.931 frame user-&gt;network tei %d&quot;
comma
id|st-&gt;l2.tei
)paren
suffix:semicolon
id|dlogframe
c_func
(paren
id|cs
comma
id|skb-&gt;data
op_plus
l_int|4
comma
id|skb-&gt;len
op_minus
l_int|4
comma
id|str
)paren
suffix:semicolon
)brace
id|cs-&gt;tx_skb
op_assign
id|skb
suffix:semicolon
id|cs-&gt;tx_cnt
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef L2FRAME_DEBUG&t;&t;/* psa */
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_LAPD
)paren
id|Logl2Frame
c_func
(paren
id|cs
comma
id|skb
comma
l_string|&quot;PH_DATA&quot;
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|cs-&gt;hw.foreign
op_member_access_from_pointer
id|dxmit
c_func
(paren
l_int|0
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
op_amp
id|foreign_dxmit_callback
comma
id|cs
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
(paren
id|PH_PULL_IND
)paren
suffix:colon
r_if
c_cond
(paren
id|cs-&gt;tx_skb
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_WARN
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot; l2l1 tx_skb exist this shouldn&squot;t happen&quot;
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|cs-&gt;sq
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|cs-&gt;dlogflag
)paren
op_logical_and
(paren
op_logical_neg
(paren
id|skb-&gt;data
(braket
l_int|2
)braket
op_amp
l_int|1
)paren
)paren
)paren
(brace
multiline_comment|/* I-FRAME */
id|LogFrame
c_func
(paren
id|cs
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|str
comma
l_string|&quot;Q.931 frame user-&gt;network tei %d&quot;
comma
id|st-&gt;l2.tei
)paren
suffix:semicolon
id|dlogframe
c_func
(paren
id|cs
comma
id|skb-&gt;data
op_plus
l_int|4
comma
id|skb-&gt;len
op_minus
l_int|4
comma
id|str
)paren
suffix:semicolon
)brace
id|cs-&gt;tx_skb
op_assign
id|skb
suffix:semicolon
id|cs-&gt;tx_cnt
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef L2FRAME_DEBUG&t;&t;/* psa */
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_LAPD
)paren
id|Logl2Frame
c_func
(paren
id|cs
comma
id|skb
comma
l_string|&quot;PH_DATA_PULLED&quot;
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|cs-&gt;hw.foreign
op_member_access_from_pointer
id|dxmit
c_func
(paren
l_int|0
comma
id|cs-&gt;tx_skb-&gt;data
comma
id|cs-&gt;tx_skb-&gt;len
comma
op_amp
id|foreign_dxmit_callback
comma
id|cs
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|PH_PULL_REQ
)paren
suffix:colon
macro_line|#ifdef L2FRAME_DEBUG&t;&t;/* psa */
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_LAPD
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;-&gt; PH_REQUEST_PULL&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|cs-&gt;tx_skb
)paren
(brace
id|test_and_clear_bit
c_func
(paren
id|FLG_L1_PULL_REQ
comma
op_amp
id|st-&gt;l1.Flags
)paren
suffix:semicolon
id|st-&gt;l1
dot
id|l1l2
c_func
(paren
id|st
comma
id|PH_PULL_CNF
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_else
id|test_and_set_bit
c_func
(paren
id|FLG_L1_PULL_REQ
comma
op_amp
id|st-&gt;l1.Flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_int
DECL|function|setDstack_foreign
id|setDstack_foreign
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
id|st-&gt;l2.l2l1
op_assign
id|foreign_Dchan_l2l1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cs-&gt;rcvbuf
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;setDstack_foreign: No cs-&gt;rcvbuf!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|cs-&gt;hw.foreign
op_member_access_from_pointer
id|drecv
c_func
(paren
l_int|0
comma
id|cs-&gt;rcvbuf
comma
id|MAX_DFRAME_LEN
comma
op_amp
id|foreign_drecv_callback
comma
id|cs
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|manl1_msg
id|manl1_msg
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_int
id|msg
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|PStack
op_star
id|st
suffix:semicolon
id|st
op_assign
id|cs-&gt;stlist
suffix:semicolon
r_while
c_loop
(paren
id|st
)paren
(brace
id|st-&gt;ma
dot
id|manl1
c_func
(paren
id|st
comma
id|msg
comma
id|arg
)paren
suffix:semicolon
id|st
op_assign
id|st-&gt;next
suffix:semicolon
)brace
)brace
r_void
DECL|function|foreign_l1cmd
id|foreign_l1cmd
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_int
id|msg
comma
r_void
op_star
id|arg
)paren
(brace
id|u_char
id|val
suffix:semicolon
r_char
id|tmp
(braket
l_int|32
)braket
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
(brace
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;foreign_l1cmd msg %x&quot;
comma
id|msg
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
id|tmp
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|msg
)paren
(brace
r_case
id|PH_RESET_REQ
suffix:colon
id|cs-&gt;hw.foreign
op_member_access_from_pointer
id|liu_deactivate
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|manl1_msg
c_func
(paren
id|cs
comma
id|PH_POWERUP_CNF
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PH_ENABLE_REQ
suffix:colon
r_break
suffix:semicolon
r_case
id|PH_INFO3_REQ
suffix:colon
id|cs-&gt;hw.foreign
op_member_access_from_pointer
id|liu_activate
c_func
(paren
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PH_TESTLOOP_REQ
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_WARN
)paren
(brace
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;foreign_l1cmd unknown %4x&quot;
comma
id|msg
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
id|tmp
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|foreign_new_ph
id|foreign_new_ph
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
r_switch
c_cond
(paren
id|cs-&gt;hw.foreign
op_member_access_from_pointer
id|get_liu_state
c_func
(paren
l_int|0
)paren
)paren
(brace
r_case
l_int|3
suffix:colon
id|manl1_msg
c_func
(paren
id|cs
comma
id|PH_POWERUP_CNF
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|manl1_msg
c_func
(paren
id|cs
comma
id|PH_I4_P8_IND
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|manl1_msg
c_func
(paren
id|cs
comma
id|PH_RSYNC_IND
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* LIU state change callback */
r_static
r_void
DECL|function|foreign_liu_callback
id|foreign_liu_callback
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
r_static
r_struct
id|tq_struct
id|task
op_assign
(brace
l_int|0
comma
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|foreign_new_ph
comma
l_int|0
)brace
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cs
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
(brace
r_char
id|tmp
(braket
l_int|32
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;foreign LIU state %d&quot;
comma
id|cs-&gt;hw.foreign
op_member_access_from_pointer
id|get_liu_state
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
id|tmp
)paren
suffix:semicolon
)brace
id|task.data
op_assign
(paren
r_void
op_star
)paren
id|cs
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|task
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
DECL|function|init_foreign
r_static
r_void
id|init_foreign
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
id|Bchan_init
c_func
(paren
op_amp
id|cs-&gt;bcs
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|Bchan_init
c_func
(paren
op_amp
id|cs-&gt;bcs
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|cs-&gt;bcs
(braket
l_int|0
)braket
dot
id|BC_SetStack
op_assign
id|setstack_foreign
suffix:semicolon
id|cs-&gt;bcs
(braket
l_int|1
)braket
dot
id|BC_SetStack
op_assign
id|setstack_foreign
suffix:semicolon
id|cs-&gt;bcs
(braket
l_int|0
)braket
dot
id|BC_Close
op_assign
id|Bchan_close
suffix:semicolon
id|cs-&gt;bcs
(braket
l_int|1
)braket
dot
id|BC_Close
op_assign
id|Bchan_close
suffix:semicolon
id|Bchan_mode
c_func
(paren
id|cs-&gt;bcs
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|Bchan_mode
c_func
(paren
id|cs-&gt;bcs
op_plus
l_int|1
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|foreign_card_msg
id|foreign_card_msg
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_int
id|mt
comma
r_void
op_star
id|arg
)paren
(brace
r_switch
c_cond
(paren
id|mt
)paren
(brace
r_case
id|CARD_RESET
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|CARD_RELEASE
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|CARD_SETIRQ
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|CARD_INIT
suffix:colon
id|cs-&gt;l1cmd
op_assign
id|foreign_l1cmd
suffix:semicolon
id|cs-&gt;setstack_d
op_assign
id|setDstack_foreign
suffix:semicolon
id|cs-&gt;hw.foreign
op_member_access_from_pointer
id|liu_init
c_func
(paren
l_int|0
comma
op_amp
id|foreign_liu_callback
comma
(paren
r_void
op_star
)paren
id|cs
)paren
suffix:semicolon
id|init_foreign
c_func
(paren
id|cs
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|CARD_TEST
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if CARD_AMD7930
r_extern
r_struct
id|foreign_interface
id|amd7930_foreign_interface
suffix:semicolon
macro_line|#endif
macro_line|#if CARD_DBRI
r_extern
r_struct
id|foreign_interface
id|dbri_foreign_interface
suffix:semicolon
macro_line|#endif
r_int
id|__init
DECL|function|setup_foreign
id|setup_foreign
c_func
(paren
r_struct
id|IsdnCard
op_star
id|card
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|cs
op_assign
id|card-&gt;cs
suffix:semicolon
r_char
id|tmp
(braket
l_int|64
)braket
suffix:semicolon
id|strcpy
c_func
(paren
id|tmp
comma
id|foreign_revision
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HiSax: Foreign chip driver Rev. %s&bslash;n&quot;
comma
id|HiSax_getrev
c_func
(paren
id|tmp
)paren
)paren
suffix:semicolon
macro_line|#if CARD_AMD7930
r_if
c_cond
(paren
id|cs-&gt;typ
op_eq
id|ISDN_CTYPE_AMD7930
)paren
(brace
id|cs-&gt;hw.foreign
op_assign
op_amp
id|amd7930_foreign_interface
suffix:semicolon
id|cs-&gt;irq
op_assign
id|cs-&gt;hw.foreign
op_member_access_from_pointer
id|get_irqnum
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;irq
op_eq
l_int|0
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|cs-&gt;cardmsg
op_assign
op_amp
id|foreign_card_msg
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if CARD_DBRI
r_if
c_cond
(paren
id|cs-&gt;typ
op_eq
id|ISDN_CTYPE_DBRI
)paren
(brace
id|cs-&gt;hw.foreign
op_assign
op_amp
id|dbri_foreign_interface
suffix:semicolon
id|cs-&gt;irq
op_assign
id|cs-&gt;hw.foreign
op_member_access_from_pointer
id|get_irqnum
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;irq
op_eq
l_int|0
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|cs-&gt;cardmsg
op_assign
op_amp
id|foreign_card_msg
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
eof
