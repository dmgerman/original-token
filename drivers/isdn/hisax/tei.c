multiline_comment|/* $Id: tei.c,v 1.8 1997/04/07 22:59:08 keil Exp $&n;&n; * Author       Karsten Keil (keil@temic-ech.spacenet.de)&n; *              based on the teles driver from Jan den Ouden&n; *&n; * Thanks to    Jan den Ouden&n; *              Fritz Elfert&n; *&n; * $Log: tei.c,v $&n; * Revision 1.8  1997/04/07 22:59:08  keil&n; * GFP_KERNEL --&gt; GFP_ATOMIC&n; *&n; * Revision 1.7  1997/04/06 22:54:03  keil&n; * Using SKB&squot;s&n; *&n; * Revision 1.6  1997/02/09 00:25:12  keil&n; * new interface handling, one interface per card&n; *&n; * Revision 1.5  1997/01/27 15:57:51  keil&n; * cosmetics&n; *&n; * Revision 1.4  1997/01/21 22:32:44  keil&n; * Tei verify request&n; *&n; * Revision 1.3  1997/01/04 13:45:02  keil&n; * cleanup,adding remove tei request (thanks to Sim Yskes)&n; *&n; * Revision 1.2  1996/12/08 19:52:39  keil&n; * minor debug fix&n; *&n; * Revision 1.1  1996/10/13 20:04:57  keil&n; * Initial revision&n; *&n; *&n; *&n; */
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &quot;hisax.h&quot;
r_extern
r_struct
id|IsdnCard
id|cards
(braket
)braket
suffix:semicolon
r_extern
r_int
id|nrcards
suffix:semicolon
DECL|variable|tei_revision
r_const
r_char
op_star
id|tei_revision
op_assign
l_string|&quot;$Revision: 1.8 $&quot;
suffix:semicolon
r_static
r_struct
id|PStack
op_star
DECL|function|findces
id|findces
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_int
id|ces
)paren
(brace
r_struct
id|PStack
op_star
id|ptr
op_assign
op_star
(paren
id|st-&gt;l1.stlistp
)paren
suffix:semicolon
r_while
c_loop
(paren
id|ptr
)paren
r_if
c_cond
(paren
id|ptr-&gt;l2.ces
op_eq
id|ces
)paren
r_return
(paren
id|ptr
)paren
suffix:semicolon
r_else
id|ptr
op_assign
id|ptr-&gt;next
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
r_static
r_struct
id|PStack
op_star
DECL|function|findtei
id|findtei
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_int
id|tei
)paren
(brace
r_struct
id|PStack
op_star
id|ptr
op_assign
op_star
(paren
id|st-&gt;l1.stlistp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tei
op_eq
l_int|127
)paren
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
r_while
c_loop
(paren
id|ptr
)paren
r_if
c_cond
(paren
id|ptr-&gt;l2.tei
op_eq
id|tei
)paren
r_return
(paren
id|ptr
)paren
suffix:semicolon
r_else
id|ptr
op_assign
id|ptr-&gt;next
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|mdl_unit_data_res
id|mdl_unit_data_res
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_int
r_int
id|ri
comma
id|u_char
id|mt
comma
id|u_char
id|ai
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|u_char
op_star
id|bp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|alloc_skb
c_func
(paren
l_int|6
op_plus
id|MAX_HEADER_LEN
comma
id|GFP_ATOMIC
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HiSax: No skb for TEI manager&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb
comma
id|MAX_HEADER_LEN
)paren
suffix:semicolon
id|bp
op_assign
id|skb_put
c_func
(paren
id|skb
comma
l_int|5
)paren
suffix:semicolon
id|bp
(braket
l_int|0
)braket
op_assign
l_int|0xf
suffix:semicolon
id|bp
(braket
l_int|1
)braket
op_assign
id|ri
op_rshift
l_int|8
suffix:semicolon
id|bp
(braket
l_int|2
)braket
op_assign
id|ri
op_amp
l_int|0xff
suffix:semicolon
id|bp
(braket
l_int|3
)braket
op_assign
id|mt
suffix:semicolon
id|bp
(braket
l_int|4
)braket
op_assign
(paren
id|ai
op_lshift
l_int|1
)paren
op_or
l_int|1
suffix:semicolon
id|st-&gt;l3
dot
id|l3l2
c_func
(paren
id|st
comma
id|DL_UNIT_DATA
comma
id|skb
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|mdl_unit_data_ind
id|mdl_unit_data_ind
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_int
r_int
id|ri
comma
id|u_char
id|mt
comma
id|u_char
id|ai
)paren
(brace
r_int
r_int
id|tces
suffix:semicolon
r_struct
id|PStack
op_star
id|otsp
comma
op_star
id|ptr
suffix:semicolon
r_char
id|tmp
(braket
l_int|64
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|mt
)paren
(brace
r_case
(paren
l_int|2
)paren
suffix:colon
id|tces
op_assign
id|ri
suffix:semicolon
r_if
c_cond
(paren
id|st-&gt;l3.debug
)paren
(brace
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;identity assign ces %d ai %d&quot;
comma
id|tces
comma
id|ai
)paren
suffix:semicolon
id|st-&gt;l2.l2m
dot
id|printdebug
c_func
(paren
op_amp
id|st-&gt;l2.l2m
comma
id|tmp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|otsp
op_assign
id|findces
c_func
(paren
id|st
comma
id|tces
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|st-&gt;l3.debug
)paren
(brace
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;ces %d --&gt; tei %d&quot;
comma
id|tces
comma
id|ai
)paren
suffix:semicolon
id|st-&gt;l2.l2m
dot
id|printdebug
c_func
(paren
op_amp
id|st-&gt;l2.l2m
comma
id|tmp
)paren
suffix:semicolon
)brace
id|otsp-&gt;ma
dot
id|teil2
c_func
(paren
id|otsp
comma
id|MDL_ASSIGN
comma
(paren
r_void
op_star
)paren
(paren
r_int
)paren
id|ai
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
(paren
l_int|3
)paren
suffix:colon
id|tces
op_assign
id|ri
suffix:semicolon
r_if
c_cond
(paren
id|st-&gt;l3.debug
)paren
(brace
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;identity denied for ces %d ai %d&quot;
comma
id|tces
comma
id|ai
)paren
suffix:semicolon
id|st-&gt;l2.l2m
dot
id|printdebug
c_func
(paren
op_amp
id|st-&gt;l2.l2m
comma
id|tmp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|otsp
op_assign
id|findces
c_func
(paren
id|st
comma
id|tces
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|st-&gt;l3.debug
)paren
(brace
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;ces %d denied tei %d&quot;
comma
id|tces
comma
id|ai
)paren
suffix:semicolon
id|st-&gt;l2.l2m
dot
id|printdebug
c_func
(paren
op_amp
id|st-&gt;l2.l2m
comma
id|tmp
)paren
suffix:semicolon
)brace
id|otsp-&gt;l2.tei
op_assign
l_int|255
suffix:semicolon
id|otsp-&gt;l2.ces
op_assign
id|randomces
c_func
(paren
)paren
suffix:semicolon
id|otsp-&gt;ma
dot
id|teil2
c_func
(paren
id|otsp
comma
id|MDL_REMOVE
comma
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
(paren
l_int|4
)paren
suffix:colon
r_if
c_cond
(paren
id|st-&gt;l3.debug
)paren
(brace
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;checking identity for %d&quot;
comma
id|ai
)paren
suffix:semicolon
id|st-&gt;l2.l2m
dot
id|printdebug
c_func
(paren
op_amp
id|st-&gt;l2.l2m
comma
id|tmp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ai
op_eq
l_int|0x7f
)paren
(brace
id|ptr
op_assign
op_star
(paren
id|st-&gt;l1.stlistp
)paren
suffix:semicolon
r_while
c_loop
(paren
id|ptr
)paren
(brace
r_if
c_cond
(paren
(paren
id|ptr-&gt;l2.tei
op_amp
l_int|0x7f
)paren
op_ne
l_int|0x7f
)paren
(brace
r_if
c_cond
(paren
id|st-&gt;l3.debug
)paren
(brace
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;check response for ces %d with tei %d&quot;
comma
id|ptr-&gt;l2.ces
comma
id|ptr-&gt;l2.tei
)paren
suffix:semicolon
id|st-&gt;l2.l2m
dot
id|printdebug
c_func
(paren
op_amp
id|st-&gt;l2.l2m
comma
id|tmp
)paren
suffix:semicolon
)brace
multiline_comment|/* send identity check response (user-&gt;network) */
id|mdl_unit_data_res
c_func
(paren
id|st
comma
id|ptr-&gt;l2.ces
comma
l_int|5
comma
id|ptr-&gt;l2.tei
)paren
suffix:semicolon
)brace
id|ptr
op_assign
id|ptr-&gt;next
suffix:semicolon
)brace
)brace
r_else
(brace
id|otsp
op_assign
id|findtei
c_func
(paren
id|st
comma
id|ai
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|otsp
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|st-&gt;l3.debug
)paren
(brace
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;check response for ces %d with tei %d&quot;
comma
id|otsp-&gt;l2.ces
comma
id|otsp-&gt;l2.tei
)paren
suffix:semicolon
id|st-&gt;l2.l2m
dot
id|printdebug
c_func
(paren
op_amp
id|st-&gt;l2.l2m
comma
id|tmp
)paren
suffix:semicolon
)brace
multiline_comment|/* send identity check response (user-&gt;network) */
id|mdl_unit_data_res
c_func
(paren
id|st
comma
id|otsp-&gt;l2.ces
comma
l_int|5
comma
id|otsp-&gt;l2.tei
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
(paren
l_int|6
)paren
suffix:colon
r_if
c_cond
(paren
id|st-&gt;l3.debug
)paren
(brace
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;removal for %d&quot;
comma
id|ai
)paren
suffix:semicolon
id|st-&gt;l2.l2m
dot
id|printdebug
c_func
(paren
op_amp
id|st-&gt;l2.l2m
comma
id|tmp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ai
op_eq
l_int|0x7f
)paren
(brace
id|ptr
op_assign
op_star
(paren
id|st-&gt;l1.stlistp
)paren
suffix:semicolon
r_while
c_loop
(paren
id|ptr
)paren
(brace
r_if
c_cond
(paren
(paren
id|ptr-&gt;l2.tei
op_amp
l_int|0x7f
)paren
op_ne
l_int|0x7f
)paren
(brace
r_if
c_cond
(paren
id|st-&gt;l3.debug
)paren
(brace
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;rem ces %d with tei %d&quot;
comma
id|ptr-&gt;l2.ces
comma
id|ptr-&gt;l2.tei
)paren
suffix:semicolon
id|st-&gt;l2.l2m
dot
id|printdebug
c_func
(paren
op_amp
id|st-&gt;l2.l2m
comma
id|tmp
)paren
suffix:semicolon
)brace
id|ptr-&gt;ma
dot
id|teil2
c_func
(paren
id|ptr
comma
id|MDL_REMOVE
comma
l_int|0
)paren
suffix:semicolon
)brace
id|ptr
op_assign
id|ptr-&gt;next
suffix:semicolon
)brace
)brace
r_else
(brace
id|otsp
op_assign
id|findtei
c_func
(paren
id|st
comma
id|ai
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|otsp
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|st-&gt;l3.debug
)paren
(brace
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;rem ces %d with tei %d&quot;
comma
id|otsp-&gt;l2.ces
comma
id|otsp-&gt;l2.tei
)paren
suffix:semicolon
id|st-&gt;l2.l2m
dot
id|printdebug
c_func
(paren
op_amp
id|st-&gt;l2.l2m
comma
id|tmp
)paren
suffix:semicolon
)brace
id|otsp-&gt;ma
dot
id|teil2
c_func
(paren
id|otsp
comma
id|MDL_REMOVE
comma
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|st-&gt;l3.debug
)paren
(brace
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;message unknown %d ai %d&quot;
comma
id|mt
comma
id|ai
)paren
suffix:semicolon
id|st-&gt;l2.l2m
dot
id|printdebug
c_func
(paren
op_amp
id|st-&gt;l2.l2m
comma
id|tmp
)paren
suffix:semicolon
)brace
)brace
)brace
r_void
DECL|function|tei_handler
id|tei_handler
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
id|u_char
id|pr
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|u_char
op_star
id|bp
suffix:semicolon
r_int
r_int
id|data
suffix:semicolon
r_char
id|tmp
(braket
l_int|32
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|pr
)paren
(brace
r_case
(paren
id|MDL_ASSIGN
)paren
suffix:colon
id|data
op_assign
(paren
r_int
r_int
)paren
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|st-&gt;l3.debug
)paren
(brace
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;ces %d assign request&quot;
comma
id|data
)paren
suffix:semicolon
id|st-&gt;l2.l2m
dot
id|printdebug
c_func
(paren
op_amp
id|st-&gt;l2.l2m
comma
id|tmp
)paren
suffix:semicolon
)brace
id|mdl_unit_data_res
c_func
(paren
id|st
comma
id|data
comma
l_int|1
comma
l_int|127
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|MDL_VERIFY
)paren
suffix:colon
id|data
op_assign
(paren
r_int
r_int
)paren
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|st-&gt;l3.debug
)paren
(brace
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;%d id verify request&quot;
comma
id|data
)paren
suffix:semicolon
id|st-&gt;l2.l2m
dot
id|printdebug
c_func
(paren
op_amp
id|st-&gt;l2.l2m
comma
id|tmp
)paren
suffix:semicolon
)brace
id|mdl_unit_data_res
c_func
(paren
id|st
comma
l_int|0
comma
l_int|7
comma
id|data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|DL_UNIT_DATA
)paren
suffix:colon
id|bp
op_assign
id|skb-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|bp
(braket
l_int|0
)braket
op_ne
l_int|0xf
)paren
(brace
multiline_comment|/* wrong management entity identifier, ignore */
multiline_comment|/* shouldn&squot;t ibh be released??? */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;tei handler wrong entity id %x&bslash;n&quot;
comma
id|bp
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
r_else
id|mdl_unit_data_ind
c_func
(paren
id|st
comma
(paren
id|bp
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_or
id|bp
(braket
l_int|2
)braket
comma
id|bp
(braket
l_int|3
)braket
comma
id|bp
(braket
l_int|4
)braket
op_rshift
l_int|1
)paren
suffix:semicolon
id|SET_SKB_FREE
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
r_int
r_int
DECL|function|randomces
id|randomces
c_func
(paren
r_void
)paren
(brace
r_int
id|x
op_assign
id|jiffies
op_amp
l_int|0xffff
suffix:semicolon
r_return
(paren
id|x
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|tei_man
id|tei_man
c_func
(paren
r_struct
id|PStack
op_star
id|sp
comma
r_int
id|i
comma
r_void
op_star
id|v
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;tei_man&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|tei_l2tei
id|tei_l2tei
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|sp
op_assign
id|st-&gt;l1.hardware
suffix:semicolon
id|tei_handler
c_func
(paren
id|sp-&gt;teistack
comma
id|pr
comma
id|arg
)paren
suffix:semicolon
)brace
r_void
DECL|function|setstack_tei
id|setstack_tei
c_func
(paren
r_struct
id|PStack
op_star
id|st
)paren
(brace
id|st-&gt;l2.l2tei
op_assign
id|tei_l2tei
suffix:semicolon
)brace
r_void
DECL|function|init_tei
id|init_tei
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|sp
comma
r_int
id|protocol
)paren
(brace
r_struct
id|PStack
op_star
id|st
suffix:semicolon
r_char
id|tmp
(braket
l_int|128
)braket
suffix:semicolon
id|st
op_assign
(paren
r_struct
id|PStack
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|PStack
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|setstack_HiSax
c_func
(paren
id|st
comma
id|sp
)paren
suffix:semicolon
id|st-&gt;l2.extended
op_assign
op_logical_neg
l_int|0
suffix:semicolon
id|st-&gt;l2.laptype
op_assign
id|LAPD
suffix:semicolon
id|st-&gt;l2.window
op_assign
l_int|1
suffix:semicolon
id|st-&gt;l2.orig
op_assign
op_logical_neg
l_int|0
suffix:semicolon
id|st-&gt;protocol
op_assign
id|protocol
suffix:semicolon
multiline_comment|/*&n; * the following is not necessary for tei mng. (broadcast only)&n; */
id|st-&gt;l2.t200
op_assign
l_int|500
suffix:semicolon
multiline_comment|/* 500 milliseconds */
id|st-&gt;l2.n200
op_assign
l_int|4
suffix:semicolon
multiline_comment|/* try 4 times */
id|st-&gt;l2.sap
op_assign
l_int|63
suffix:semicolon
id|st-&gt;l2.tei
op_assign
l_int|127
suffix:semicolon
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;Card %d tei&quot;
comma
id|sp-&gt;cardnr
op_plus
l_int|1
)paren
suffix:semicolon
id|setstack_isdnl2
c_func
(paren
id|st
comma
id|tmp
)paren
suffix:semicolon
id|st-&gt;l2.debug
op_assign
l_int|0
suffix:semicolon
id|st-&gt;l3.debug
op_assign
l_int|0
suffix:semicolon
id|st-&gt;ma
dot
id|manl2
c_func
(paren
id|st
comma
id|MDL_NOTEIPROC
comma
l_int|NULL
)paren
suffix:semicolon
id|st-&gt;l2.l2l3
op_assign
(paren
r_void
op_star
)paren
id|tei_handler
suffix:semicolon
id|st-&gt;l1.l1man
op_assign
id|tei_man
suffix:semicolon
id|st-&gt;l2.l2man
op_assign
id|tei_man
suffix:semicolon
id|st-&gt;l4.l2writewakeup
op_assign
l_int|NULL
suffix:semicolon
id|HiSax_addlist
c_func
(paren
id|sp
comma
id|st
)paren
suffix:semicolon
id|sp-&gt;teistack
op_assign
id|st
suffix:semicolon
)brace
r_void
DECL|function|release_tei
id|release_tei
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|sp
)paren
(brace
r_struct
id|PStack
op_star
id|st
op_assign
id|sp-&gt;teistack
suffix:semicolon
id|HiSax_rmlist
c_func
(paren
id|sp
comma
id|st
)paren
suffix:semicolon
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|st
)paren
suffix:semicolon
)brace
eof
