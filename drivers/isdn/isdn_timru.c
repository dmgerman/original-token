multiline_comment|/* $Id: isdn_timru.c,v 1.2 1998/03/07 23:17:28 fritz Exp $&n; *&n; * Linux ISDN subsystem, timeout-rules for network interfaces.&n; *&n; * Copyright 1997       by Christian Lademann &lt;cal@zls.de&gt;&n; * &n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA. &n; *&n; * $Log: isdn_timru.c,v $&n; * Revision 1.2  1998/03/07 23:17:28  fritz&n; * Added RCS keywords&n; * Bugfix: Did not compile without isdn_dumppkt beeing enabled.&n; *&n; */
multiline_comment|/*&n;02.06.97:cal:&n;    - ISDN_TIMRU_PACKET_NONE = 0 definiert, die anderen ISDN_TIMRU_PACKET_* -&n;      Definitionen jeweils inkrementiert&n;&n;    - isdn_net_recalc_timeout():&n;      - In der Schleife zum Finden einer passenden Regel wurde in jedem Fall&n;        die Wildcard-Kette durchsucht. Jetzt nicht mehr.&n;      - beim Testen einer Bringup-Regel wird der anfaengliche Timeout auf den&n;        Hangup-Timeout des Devices gesetzt (lp-&gt;onhtime).&n;&n;10.06.97:cal:&n;    - isdn_net_recalc_timeout(): rule-&gt;neg-Handling gesaeubert: eine Regel passt&n;      genau dann, wenn match(rule) XOR rule-&gt;neg und das bei allen Regeltypen.&n;    - isdn_net_add_rule(): rule-&gt;timeout bei BRINGUP immer 1, sonst &gt; 0.&n;    - alle return(-1), die zu ioctl-Calls zurueckgehen --&gt; return(-EINVAL).&n;    - div. Leerzeilen geloescht / eingefuegt; alle return&squot;s &quot;geklammert&quot;.&n;&n;12.06.97:cal:&n;    - isdn_net_recalc_timeout(): Falls IP-Masquerading verwendet wird, kann mit&n;      der neuen Option CONFIG_TIMRU_USE_MASQ der Regel-Match auf die ursprueng-&n;      lichen Adressen und nicht auf die der Firewall angewendet werden. Dazu ist&n;      ein Patch in net/ipv4/ip_masq.c notwendig: ip_masq_in_get_2 muss&n;      exportiert werden.&n;&n;26.06.97:cal:&n;    - isdn_net_add_rule(): rule-&gt;timeout darf bei BRINGUP &gt;= 0 sein. Damit&n;      laesst sich folgende Systax erreichen: &quot;Falls Paket passt, starte die&n;      Verbindung NICHT&quot;, wie es im Stand 970602 moeglich war.&n;    - isdn_net_recalc_timeout(): BRINGUP: initial timeout wird auf den in der&n;      passenden Regel gefundenen Timeout gesetzt. Ist dieser 0, so wird die&n;      Verbindung nicht aufgebaut.&n;&n;16.10.97:cal:&n;    - isdn_net_recalc_timeout(): beachte Fake-Header, der bei ausgehenden&n;      SyncPPP-Paketen eingesetzt wird;&n;      TimRu&squot;s &quot;recalc timeout:&quot; - Meldungen in einer Zeile&n;&n;04.11.97:cal:&n;    - isdn_net.c, isdn_net_new(): Timeout-Rules nicht mehr automatisch&n;      alloziieren;&n;    - isdn_net.c, isdn_net_autohup(): AutoHup auch durchfuehren, wenn keine&n;      Timeout-Rules alloziiert sind.&n;*/
multiline_comment|/*&n;TODO:&n;&n;- Masq-Adressen statt Paketadresse ausgeben, falls die Masq-Adressen verwendet&n;  werden.&n;&n;- Masq-Adressen-Verwendung als Option in den Regeln vorsehen&n;&n;- TCP-Flags als Regel-Optionen&n;&n;- weitere Verfeinerungen fuer Nicht-TCP/IP-Pakete&n;*/
macro_line|#include &lt;linux/config.h&gt;
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/isdn.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;net/icmp.h&gt;
macro_line|#include &lt;net/tcp.h&gt;
macro_line|#include &lt;net/udp.h&gt;
macro_line|#ifdef CONFIG_ISDN_TIMRU_USE_MASQ
macro_line|#ifdef CONFIG_IP_MASQUERADE
macro_line|#include &lt;net/ip_masq.h&gt;
macro_line|#endif
macro_line|#endif
macro_line|#include &quot;isdn_common.h&quot;
macro_line|#include &quot;isdn_net.h&quot;
macro_line|#ifdef CONFIG_ISDN_PPP
macro_line|#include &quot;isdn_ppp.h&quot;
macro_line|#endif
macro_line|#ifdef CONFIG_ISDN_TIMEOUT_RULES
r_static
r_int
id|isdn_timru_match
c_func
(paren
id|isdn_timeout_rule
op_star
id|this
comma
id|isdn_timeout_rule
op_star
id|rule
)paren
suffix:semicolon
DECL|macro|printk_ip
mdefine_line|#define printk_ip(a)&t; printk(&quot;%ld.%ld.%ld.%ld&quot;,(ntohl(a)&gt;&gt;24)&amp;0xFF,&bslash;&n;&t;&t;&t;&t;&t;      (ntohl(a)&gt;&gt;16)&amp;0xFF,&bslash;&n;&t;&t;&t;&t;&t;      (ntohl(a)&gt;&gt;8)&amp;0xFF,&bslash;&n;&t;&t;&t;&t;&t;      (ntohl(a))&amp;0xFF)
DECL|macro|printk_port
mdefine_line|#define printk_port(a)&t; printk(&quot;%d&quot;,ntohs(a))
DECL|macro|VERBOSE_PRINTK
mdefine_line|#define&t;VERBOSE_PRINTK(v, l, p...)&t;{ &bslash;&n;&t;if(dev-&gt;net_verbose &gt;= (v)) { &bslash;&n;&t;&t;printk(l ## p); &bslash;&n;&t;} else { ; } &bslash;&n;}
r_int
DECL|function|isdn_net_recalc_timeout
id|isdn_net_recalc_timeout
c_func
(paren
r_int
id|type
comma
r_int
id|prot
comma
r_struct
id|device
op_star
id|ndev
comma
r_void
op_star
id|buf
comma
id|ulong
id|arg
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|ndev-&gt;priv
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|iphdr
op_star
id|ip
suffix:semicolon
r_struct
id|icmphdr
op_star
id|icmp
suffix:semicolon
r_struct
id|tcphdr
op_star
id|tcp
suffix:semicolon
r_struct
id|udphdr
op_star
id|udp
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_TIMRU_USE_MASQ
macro_line|#ifdef CONFIG_IP_MASQUERADE
r_struct
id|ip_masq
op_star
id|masq
suffix:semicolon
r_int
id|m_prot
suffix:semicolon
id|__u32
id|m_saddr
comma
id|m_daddr
suffix:semicolon
id|__u16
id|m_sport
comma
id|m_dport
suffix:semicolon
r_int
id|check_for_masq
suffix:semicolon
macro_line|#endif
macro_line|#endif
id|isdn_timeout_rule
id|match_rule
suffix:semicolon
multiline_comment|/*&n;&t;char&t;&t;&t;*cbuf;&n;*/
r_int
id|ppp_proto
comma
id|ppp_hdrlen
op_assign
l_int|0
comma
id|new_timeout
suffix:semicolon
id|match_rule.type
op_assign
id|type
suffix:semicolon
id|match_rule.protfam
op_assign
id|ISDN_TIMRU_PROTFAM_WILDCARD
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;net_verbose
OG
l_int|4
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;recalc_timeout:&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|ISDN_TIMRU_BRINGUP
suffix:colon
id|printk
c_func
(paren
l_string|&quot;BRINGUP, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_TIMRU_KEEPUP_IN
suffix:colon
id|printk
c_func
(paren
l_string|&quot;KEEPUP_IN, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_TIMRU_KEEPUP_OUT
suffix:colon
id|printk
c_func
(paren
l_string|&quot;KEEPUP_OUT, &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;ERROR&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_switch
c_cond
(paren
id|prot
)paren
(brace
r_case
id|ISDN_TIMRU_PACKET_PPP
suffix:colon
r_case
id|ISDN_TIMRU_PACKET_PPP_NO_HEADER
suffix:colon
r_if
c_cond
(paren
id|prot
op_eq
id|ISDN_TIMRU_PACKET_PPP
)paren
(brace
id|ppp_proto
op_assign
id|PPP_PROTOCOL
c_func
(paren
(paren
r_char
op_star
)paren
id|buf
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;cbuf = (char *)(buf + PPP_HDRLEN);&n;*/
)brace
r_else
(brace
id|ppp_proto
op_assign
(paren
r_int
)paren
id|arg
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;cbuf = (char *)buf;&n;*/
)brace
id|match_rule.protfam
op_assign
id|ISDN_TIMRU_PROTFAM_PPP
suffix:semicolon
id|match_rule.rule.ppp.protocol
op_assign
id|ISDN_TIMRU_PPP_WILDCARD
suffix:semicolon
r_switch
c_cond
(paren
id|ppp_proto
)paren
(brace
r_case
id|PPP_IPCP
suffix:colon
id|match_rule.rule.ppp.protocol
op_assign
id|ISDN_TIMRU_PPP_IPCP
suffix:semicolon
id|VERBOSE_PRINTK
c_func
(paren
l_int|5
comma
l_string|&quot;&quot;
comma
l_string|&quot;PPP/IPCP&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PPP_IPXCP
suffix:colon
id|match_rule.rule.ppp.protocol
op_assign
id|ISDN_TIMRU_PPP_IPXCP
suffix:semicolon
id|VERBOSE_PRINTK
c_func
(paren
l_int|5
comma
l_string|&quot;&quot;
comma
l_string|&quot;PPP/IPXCP&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PPP_CCP
suffix:colon
id|match_rule.rule.ppp.protocol
op_assign
id|ISDN_TIMRU_PPP_CCP
suffix:semicolon
id|VERBOSE_PRINTK
c_func
(paren
l_int|5
comma
l_string|&quot;&quot;
comma
l_string|&quot;PPP/CCP&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PPP_LCP
suffix:colon
id|match_rule.rule.ppp.protocol
op_assign
id|ISDN_TIMRU_PPP_LCP
suffix:semicolon
id|VERBOSE_PRINTK
c_func
(paren
l_int|5
comma
l_string|&quot;&quot;
comma
l_string|&quot;PPP/LCP&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PPP_PAP
suffix:colon
id|match_rule.rule.ppp.protocol
op_assign
id|ISDN_TIMRU_PPP_PAP
suffix:semicolon
id|VERBOSE_PRINTK
c_func
(paren
l_int|5
comma
l_string|&quot;&quot;
comma
l_string|&quot;PPP/PAP&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PPP_LQR
suffix:colon
id|match_rule.rule.ppp.protocol
op_assign
id|ISDN_TIMRU_PPP_LQR
suffix:semicolon
id|VERBOSE_PRINTK
c_func
(paren
l_int|5
comma
l_string|&quot;&quot;
comma
l_string|&quot;PPP/LQR&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PPP_CHAP
suffix:colon
id|match_rule.rule.ppp.protocol
op_assign
id|ISDN_TIMRU_PPP_CHAP
suffix:semicolon
id|VERBOSE_PRINTK
c_func
(paren
l_int|5
comma
l_string|&quot;&quot;
comma
l_string|&quot;PPP/CHAP&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|match_rule.rule.ppp.protocol
op_assign
id|ISDN_TIMRU_PPP_WILDCARD
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;net_verbose
op_ge
l_int|5
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PPP/? (%x)&bslash;n&quot;
comma
id|ppp_proto
)paren
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_NET_DUMP
id|isdn_dumppkt
c_func
(paren
l_string|&quot;R:&quot;
comma
(paren
id|u_char
op_star
)paren
id|buf
comma
l_int|40
comma
l_int|40
)paren
suffix:semicolon
macro_line|#endif
)brace
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_TIMRU_PACKET_SKB
suffix:colon
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|buf
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_PPP
r_if
c_cond
(paren
(paren
id|type
op_eq
id|ISDN_TIMRU_BRINGUP
op_logical_or
id|type
op_eq
id|ISDN_TIMRU_KEEPUP_OUT
)paren
op_logical_and
id|lp-&gt;p_encap
op_eq
id|ISDN_NET_ENCAP_SYNCPPP
)paren
(brace
multiline_comment|/* jump over fake header. */
id|ppp_hdrlen
op_assign
id|IPPP_MAX_HEADER
suffix:semicolon
)brace
macro_line|#endif
r_switch
c_cond
(paren
id|ntohs
c_func
(paren
id|skb-&gt;protocol
)paren
)paren
(brace
r_case
id|ETH_P_IP
suffix:colon
multiline_comment|/*&n;&t;&t;&t;if(!(ip = skb-&gt;ip_hdr))&n;*/
id|ip
op_assign
(paren
r_struct
id|iphdr
op_star
)paren
(paren
id|skb-&gt;data
op_plus
id|ppp_hdrlen
)paren
suffix:semicolon
id|match_rule.protfam
op_assign
id|ISDN_TIMRU_PROTFAM_IP
suffix:semicolon
id|match_rule.rule.ip.saddr.s_addr
op_assign
id|ip-&gt;saddr
suffix:semicolon
id|match_rule.rule.ip.daddr.s_addr
op_assign
id|ip-&gt;daddr
suffix:semicolon
id|match_rule.rule.ip.protocol
op_assign
id|ISDN_TIMRU_IP_WILDCARD
suffix:semicolon
r_switch
c_cond
(paren
id|ip-&gt;protocol
)paren
(brace
r_case
id|IPPROTO_ICMP
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|icmp
op_assign
(paren
r_struct
id|icmphdr
op_star
)paren
(paren
(paren
r_int
r_int
op_star
)paren
id|ip
op_plus
id|ip-&gt;ihl
)paren
)paren
)paren
(brace
id|VERBOSE_PRINTK
c_func
(paren
l_int|5
comma
l_string|&quot;&quot;
comma
l_string|&quot;IP/ICMP HDR-ERR&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|match_rule.rule.ip.protocol
op_assign
id|ISDN_TIMRU_IP_ICMP
suffix:semicolon
id|match_rule.rule.ip.pt.type.from
op_assign
id|icmp-&gt;type
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;net_verbose
op_ge
l_int|5
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IP/ICMP &quot;
)paren
suffix:semicolon
id|printk_ip
c_func
(paren
id|ip-&gt;saddr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; --&gt; &quot;
)paren
suffix:semicolon
id|printk_ip
c_func
(paren
id|ip-&gt;daddr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;/&quot;
)paren
suffix:semicolon
id|printk_port
c_func
(paren
id|icmp-&gt;type
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|IPPROTO_IGMP
suffix:colon
id|match_rule.rule.ip.protocol
op_assign
id|ISDN_TIMRU_IP_WILDCARD
suffix:semicolon
id|VERBOSE_PRINTK
c_func
(paren
l_int|5
comma
l_string|&quot;&quot;
comma
l_string|&quot;IP/IGMP&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPPROTO_IPIP
suffix:colon
id|match_rule.rule.ip.protocol
op_assign
id|ISDN_TIMRU_IP_WILDCARD
suffix:semicolon
id|VERBOSE_PRINTK
c_func
(paren
l_int|5
comma
l_string|&quot;&quot;
comma
l_string|&quot;IP/IPIP&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPPROTO_TCP
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|tcp
op_assign
(paren
r_struct
id|tcphdr
op_star
)paren
(paren
(paren
r_int
r_int
op_star
)paren
id|ip
op_plus
id|ip-&gt;ihl
)paren
)paren
)paren
(brace
id|VERBOSE_PRINTK
c_func
(paren
l_int|5
comma
l_string|&quot;&quot;
comma
l_string|&quot;IP/TCP HDR-ERR&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|match_rule.rule.ip.protocol
op_assign
id|ISDN_TIMRU_IP_TCP
suffix:semicolon
id|match_rule.rule.ip.pt.port.s_from
op_assign
id|tcp-&gt;source
suffix:semicolon
id|match_rule.rule.ip.pt.port.d_from
op_assign
id|tcp-&gt;dest
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;net_verbose
op_ge
l_int|5
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IP/TCP &quot;
)paren
suffix:semicolon
id|printk_ip
c_func
(paren
id|ip-&gt;saddr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;/&quot;
)paren
suffix:semicolon
id|printk_port
c_func
(paren
id|tcp-&gt;source
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; --&gt; &quot;
)paren
suffix:semicolon
id|printk_ip
c_func
(paren
id|ip-&gt;daddr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;/&quot;
)paren
suffix:semicolon
id|printk_port
c_func
(paren
id|tcp-&gt;dest
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|IPPROTO_EGP
suffix:colon
id|match_rule.rule.ip.protocol
op_assign
id|ISDN_TIMRU_IP_WILDCARD
suffix:semicolon
id|VERBOSE_PRINTK
c_func
(paren
l_int|5
comma
l_string|&quot;&quot;
comma
l_string|&quot;IP/EGP&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPPROTO_PUP
suffix:colon
id|match_rule.rule.ip.protocol
op_assign
id|ISDN_TIMRU_IP_WILDCARD
suffix:semicolon
id|VERBOSE_PRINTK
c_func
(paren
l_int|5
comma
l_string|&quot;&quot;
l_string|&quot;IP/PUP&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPPROTO_UDP
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|udp
op_assign
(paren
r_struct
id|udphdr
op_star
)paren
(paren
(paren
r_int
r_int
op_star
)paren
id|ip
op_plus
id|ip-&gt;ihl
)paren
)paren
)paren
(brace
id|VERBOSE_PRINTK
c_func
(paren
l_int|5
comma
l_string|&quot;&quot;
comma
l_string|&quot;IP/UDP HDR-ERR&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|match_rule.rule.ip.protocol
op_assign
id|ISDN_TIMRU_IP_UDP
suffix:semicolon
id|match_rule.rule.ip.pt.port.s_from
op_assign
id|udp-&gt;source
suffix:semicolon
id|match_rule.rule.ip.pt.port.d_from
op_assign
id|udp-&gt;dest
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;net_verbose
op_ge
l_int|5
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IP/UDP &quot;
)paren
suffix:semicolon
id|printk_ip
c_func
(paren
id|ip-&gt;saddr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;/&quot;
)paren
suffix:semicolon
id|printk_port
c_func
(paren
id|udp-&gt;source
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; --&gt; &quot;
)paren
suffix:semicolon
id|printk_ip
c_func
(paren
id|ip-&gt;daddr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;/&quot;
)paren
suffix:semicolon
id|printk_port
c_func
(paren
id|udp-&gt;dest
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|IPPROTO_IDP
suffix:colon
id|match_rule.rule.ip.protocol
op_assign
id|ISDN_TIMRU_IP_WILDCARD
suffix:semicolon
id|VERBOSE_PRINTK
c_func
(paren
l_int|5
comma
l_string|&quot;&quot;
comma
l_string|&quot;IP/IDP&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|match_rule.rule.ip.protocol
op_assign
id|ISDN_TIMRU_IP_WILDCARD
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;net_verbose
op_ge
l_int|5
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IP/? (%x)&bslash;n&quot;
comma
id|ip-&gt;protocol
)paren
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_NET_DUMP
id|isdn_dumppkt
c_func
(paren
l_string|&quot;R:&quot;
comma
(paren
id|u_char
op_star
)paren
id|skb
comma
id|skb-&gt;len
comma
l_int|180
)paren
suffix:semicolon
macro_line|#endif
)brace
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ETH_P_ARP
suffix:colon
id|VERBOSE_PRINTK
c_func
(paren
l_int|5
comma
l_string|&quot;&quot;
comma
l_string|&quot;ARP/?&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_IPX
suffix:colon
id|VERBOSE_PRINTK
c_func
(paren
l_int|5
comma
l_string|&quot;&quot;
comma
l_string|&quot;IPX/?&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_802_2
suffix:colon
id|VERBOSE_PRINTK
c_func
(paren
l_int|5
comma
l_string|&quot;&quot;
comma
l_string|&quot;802.2/?&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_802_3
suffix:colon
id|VERBOSE_PRINTK
c_func
(paren
l_int|5
comma
l_string|&quot;&quot;
comma
l_string|&quot;802.3/?&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|dev-&gt;net_verbose
op_ge
l_int|5
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;?/? (%x)&bslash;n&quot;
comma
id|ntohs
c_func
(paren
id|skb-&gt;protocol
)paren
)paren
suffix:semicolon
macro_line|#ifdef ISDN_DEBUG_NET_DUMP
id|isdn_dumppkt
c_func
(paren
l_string|&quot;R:&quot;
comma
(paren
id|u_char
op_star
)paren
id|skb
comma
id|skb-&gt;len
comma
l_int|1800
)paren
suffix:semicolon
macro_line|#endif
)brace
r_break
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ISDN_TIMRU_USE_MASQ
macro_line|#ifdef CONFIG_IP_MASQUERADE
id|check_for_masq
op_assign
l_int|0
suffix:semicolon
id|m_saddr
op_assign
id|m_daddr
op_assign
(paren
id|__u32
)paren
l_int|0
suffix:semicolon
id|m_sport
op_assign
id|m_dport
op_assign
(paren
id|__u16
)paren
l_int|0
suffix:semicolon
id|m_prot
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|match_rule.protfam
)paren
(brace
r_case
id|ISDN_TIMRU_PROTFAM_IP
suffix:colon
id|m_saddr
op_assign
id|match_rule.rule.ip.saddr.s_addr
suffix:semicolon
id|m_daddr
op_assign
id|match_rule.rule.ip.daddr.s_addr
suffix:semicolon
r_switch
c_cond
(paren
id|match_rule.rule.ip.protocol
)paren
(brace
r_case
id|ISDN_TIMRU_IP_TCP
suffix:colon
id|m_prot
op_assign
id|IPPROTO_TCP
suffix:semicolon
id|m_sport
op_assign
id|match_rule.rule.ip.pt.port.s_from
suffix:semicolon
id|m_dport
op_assign
id|match_rule.rule.ip.pt.port.d_from
suffix:semicolon
id|check_for_masq
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_TIMRU_IP_UDP
suffix:colon
id|m_prot
op_assign
id|IPPROTO_UDP
suffix:semicolon
id|m_sport
op_assign
id|match_rule.rule.ip.pt.port.s_from
suffix:semicolon
id|m_dport
op_assign
id|match_rule.rule.ip.pt.port.d_from
suffix:semicolon
id|check_for_masq
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
macro_line|#if 0
macro_line|#ifdef CONFIG_IP_MASQUERADE_ICMP
r_case
id|ISDN_TIMRU_IP_ICMP
suffix:colon
id|m_sport
op_assign
id|match_rule.rule.ip.pt.type.from
suffix:semicolon
id|m_dport
op_assign
l_int|0
suffix:semicolon
id|check_for_masq
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#endif
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|check_for_masq
)paren
(brace
id|masq
op_assign
l_int|NULL
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|ISDN_TIMRU_BRINGUP
suffix:colon
r_case
id|ISDN_TIMRU_KEEPUP_OUT
suffix:colon
r_if
c_cond
(paren
(paren
id|masq
op_assign
id|ip_masq_in_get_2
c_func
(paren
id|m_prot
comma
id|m_daddr
comma
id|m_dport
comma
id|m_saddr
comma
id|m_sport
)paren
)paren
)paren
(brace
id|match_rule.rule.ip.saddr.s_addr
op_assign
id|m_saddr
suffix:semicolon
id|match_rule.rule.ip.daddr.s_addr
op_assign
id|m_daddr
suffix:semicolon
r_switch
c_cond
(paren
id|m_prot
)paren
(brace
r_case
id|IPPROTO_TCP
suffix:colon
r_case
id|IPPROTO_UDP
suffix:colon
id|match_rule.rule.ip.pt.port.s_from
op_assign
id|m_sport
suffix:semicolon
id|match_rule.rule.ip.pt.port.d_from
op_assign
id|m_dport
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|ISDN_TIMRU_KEEPUP_IN
suffix:colon
r_if
c_cond
(paren
(paren
id|masq
op_assign
id|ip_masq_in_get_2
c_func
(paren
id|m_prot
comma
id|m_saddr
comma
id|m_sport
comma
id|m_daddr
comma
id|m_dport
)paren
)paren
)paren
(brace
id|match_rule.rule.ip.saddr.s_addr
op_assign
id|m_daddr
suffix:semicolon
id|match_rule.rule.ip.daddr.s_addr
op_assign
id|m_saddr
suffix:semicolon
r_switch
c_cond
(paren
id|m_prot
)paren
(brace
r_case
id|IPPROTO_TCP
suffix:colon
r_case
id|IPPROTO_UDP
suffix:colon
id|match_rule.rule.ip.pt.port.s_from
op_assign
id|m_sport
suffix:semicolon
id|match_rule.rule.ip.pt.port.d_from
op_assign
id|m_dport
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|masq
op_logical_and
id|dev-&gt;net_verbose
op_ge
l_int|5
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;MASQ-TIMRU: &quot;
)paren
suffix:semicolon
id|printk_ip
c_func
(paren
id|masq-&gt;maddr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;/&quot;
)paren
suffix:semicolon
id|printk_port
c_func
(paren
id|masq-&gt;mport
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;: &quot;
)paren
suffix:semicolon
id|printk_ip
c_func
(paren
id|masq-&gt;saddr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;/&quot;
)paren
suffix:semicolon
id|printk_port
c_func
(paren
id|masq-&gt;sport
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; --&gt; &quot;
)paren
suffix:semicolon
id|printk_ip
c_func
(paren
id|masq-&gt;daddr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;/&quot;
)paren
suffix:semicolon
id|printk_port
c_func
(paren
id|masq-&gt;dport
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
macro_line|#endif
r_break
suffix:semicolon
)brace
id|new_timeout
op_assign
id|lp-&gt;onhtime
suffix:semicolon
r_if
c_cond
(paren
id|prot
op_logical_and
id|lp-&gt;timeout_rules
)paren
(brace
id|isdn_timeout_rule
op_star
id|head
comma
op_star
id|tor
suffix:semicolon
r_int
id|pf
comma
id|found_match
comma
id|i
suffix:semicolon
id|pf
op_assign
id|match_rule.protfam
suffix:semicolon
id|found_match
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|head
op_assign
id|tor
op_assign
id|lp-&gt;timeout_rules-&gt;timru
(braket
id|type
)braket
(braket
id|pf
)braket
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|tor
)paren
(brace
r_if
c_cond
(paren
(paren
id|isdn_timru_match
c_func
(paren
op_amp
id|match_rule
comma
id|tor
)paren
OG
l_int|0
)paren
op_xor
(paren
id|tor-&gt;neg
OG
l_int|0
)paren
)paren
(brace
id|found_match
op_assign
l_int|1
suffix:semicolon
id|new_timeout
op_assign
id|tor-&gt;timeout
suffix:semicolon
)brace
r_if
c_cond
(paren
id|found_match
)paren
(brace
macro_line|#ifdef DEBUG_RULES
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Rule %d-%d-%d matches&bslash;n&quot;
comma
id|type
comma
id|pf
comma
id|i
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tor-&gt;next
op_eq
id|head
)paren
(brace
id|tor
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|tor
op_assign
id|tor-&gt;next
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|found_match
op_logical_and
id|pf
op_ne
id|ISDN_TIMRU_PROTFAM_WILDCARD
)paren
(brace
id|pf
op_assign
id|ISDN_TIMRU_PROTFAM_WILDCARD
suffix:semicolon
)brace
r_else
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|found_match
)paren
(brace
id|new_timeout
op_assign
id|lp-&gt;timeout_rules-&gt;defaults
(braket
id|type
)braket
suffix:semicolon
macro_line|#ifdef DEBUG_RULES
id|printk
c_func
(paren
l_string|&quot;No rule matches: using default&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
r_if
c_cond
(paren
id|type
op_eq
id|ISDN_TIMRU_BRINGUP
)paren
(brace
r_if
c_cond
(paren
id|new_timeout
OG
l_int|0
)paren
(brace
id|lp-&gt;huptimeout
op_assign
id|new_timeout
suffix:semicolon
id|lp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|new_timeout
OG
id|lp-&gt;huptimeout
op_logical_or
id|lp-&gt;huptimeout
op_minus
id|lp-&gt;huptimer
OL
id|new_timeout
)paren
(brace
id|lp-&gt;huptimeout
op_assign
id|new_timeout
suffix:semicolon
id|lp-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_return
id|new_timeout
suffix:semicolon
)brace
r_static
r_int
DECL|function|isdn_timru_match
id|isdn_timru_match
c_func
(paren
id|isdn_timeout_rule
op_star
id|this
comma
id|isdn_timeout_rule
op_star
id|rule
)paren
(brace
r_if
c_cond
(paren
id|this-&gt;protfam
op_ne
id|rule-&gt;protfam
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|rule-&gt;protfam
)paren
(brace
r_case
id|ISDN_TIMRU_PROTFAM_WILDCARD
suffix:colon
r_return
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_TIMRU_PROTFAM_PPP
suffix:colon
r_if
c_cond
(paren
id|rule-&gt;rule.ppp.protocol
op_eq
id|ISDN_TIMRU_PPP_WILDCARD
op_logical_or
id|rule-&gt;rule.ppp.protocol
op_eq
id|this-&gt;rule.ppp.protocol
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_TIMRU_PROTFAM_IP
suffix:colon
r_if
c_cond
(paren
(paren
id|this-&gt;rule.ip.saddr.s_addr
op_amp
id|rule-&gt;rule.ip.smask.s_addr
)paren
op_ne
id|rule-&gt;rule.ip.saddr.s_addr
op_logical_or
(paren
id|this-&gt;rule.ip.daddr.s_addr
op_amp
id|rule-&gt;rule.ip.dmask.s_addr
)paren
op_ne
id|rule-&gt;rule.ip.daddr.s_addr
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rule-&gt;rule.ip.protocol
op_eq
id|ISDN_TIMRU_IP_WILDCARD
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rule-&gt;rule.ip.protocol
op_ne
id|this-&gt;rule.ip.protocol
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|rule-&gt;rule.ip.protocol
)paren
(brace
r_case
id|ISDN_TIMRU_IP_ICMP
suffix:colon
r_if
c_cond
(paren
id|this-&gt;rule.ip.pt.type.from
template_param
id|rule-&gt;rule.ip.pt.type.to
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_TIMRU_IP_TCP
suffix:colon
r_case
id|ISDN_TIMRU_IP_UDP
suffix:colon
r_if
c_cond
(paren
id|this-&gt;rule.ip.pt.port.s_from
template_param
id|rule-&gt;rule.ip.pt.port.s_to
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|this-&gt;rule.ip.pt.port.d_from
template_param
id|rule-&gt;rule.ip.pt.port.d_to
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
r_static
r_int
DECL|function|isdn_timru_rule_equals
id|isdn_timru_rule_equals
c_func
(paren
id|isdn_timeout_rule
op_star
id|this
comma
id|isdn_timeout_rule
op_star
id|rule
)paren
(brace
r_if
c_cond
(paren
id|this-&gt;neg
op_ne
id|rule-&gt;neg
op_logical_or
id|this-&gt;protfam
op_ne
id|rule-&gt;protfam
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|rule-&gt;protfam
)paren
(brace
r_case
id|ISDN_TIMRU_PROTFAM_PPP
suffix:colon
r_if
c_cond
(paren
id|this-&gt;rule.ppp.protocol
op_ne
id|rule-&gt;rule.ppp.protocol
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_TIMRU_PROTFAM_IP
suffix:colon
r_if
c_cond
(paren
id|this-&gt;rule.ip.protocol
op_ne
id|rule-&gt;rule.ip.protocol
op_logical_or
id|this-&gt;rule.ip.saddr.s_addr
op_ne
id|rule-&gt;rule.ip.saddr.s_addr
op_logical_or
id|this-&gt;rule.ip.smask.s_addr
op_ne
id|rule-&gt;rule.ip.smask.s_addr
op_logical_or
id|this-&gt;rule.ip.daddr.s_addr
op_ne
id|rule-&gt;rule.ip.daddr.s_addr
op_logical_or
id|this-&gt;rule.ip.dmask.s_addr
op_ne
id|rule-&gt;rule.ip.dmask.s_addr
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|rule-&gt;rule.ip.protocol
)paren
(brace
r_case
id|ISDN_TIMRU_IP_ICMP
suffix:colon
r_if
c_cond
(paren
id|this-&gt;rule.ip.pt.type.from
op_ne
id|rule-&gt;rule.ip.pt.type.from
op_logical_or
id|this-&gt;rule.ip.pt.type.to
op_ne
id|rule-&gt;rule.ip.pt.type.to
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISDN_TIMRU_IP_TCP
suffix:colon
r_case
id|ISDN_TIMRU_IP_UDP
suffix:colon
r_if
c_cond
(paren
id|this-&gt;rule.ip.pt.port.s_from
op_ne
id|rule-&gt;rule.ip.pt.port.s_from
op_logical_or
id|this-&gt;rule.ip.pt.port.s_to
op_ne
id|rule-&gt;rule.ip.pt.port.s_to
op_logical_or
id|this-&gt;rule.ip.pt.port.d_from
op_ne
id|rule-&gt;rule.ip.pt.port.d_from
op_logical_or
id|this-&gt;rule.ip.pt.port.d_to
op_ne
id|rule-&gt;rule.ip.pt.port.d_to
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
r_int
DECL|function|isdn_timru_alloc_timeout_rules
id|isdn_timru_alloc_timeout_rules
c_func
(paren
r_struct
id|device
op_star
id|ndev
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|ndev-&gt;priv
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|lp-&gt;timeout_rules
op_assign
(paren
r_struct
id|isdn_timeout_rules
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|isdn_timeout_rules
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_timru: failed to allocate memory.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|lp-&gt;timeout_rules
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|isdn_timeout_rules
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_TIMRU_NUM_CHECK
suffix:semicolon
id|i
op_increment
)paren
(brace
id|lp-&gt;timeout_rules-&gt;defaults
(braket
id|i
)braket
op_assign
id|lp-&gt;onhtime
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|ISDN_TIMRU_NUM_PROTFAM
suffix:semicolon
id|j
op_increment
)paren
(brace
id|lp-&gt;timeout_rules-&gt;timru
(braket
id|i
)braket
(braket
id|j
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|isdn_timru_free_timeout_rules
id|isdn_timru_free_timeout_rules
c_func
(paren
r_struct
id|device
op_star
id|ndev
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|ndev-&gt;priv
suffix:semicolon
id|isdn_timeout_rule
op_star
id|head
comma
op_star
id|this
comma
op_star
id|next
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;timeout_rules
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISDN_TIMRU_NUM_CHECK
suffix:semicolon
id|i
op_increment
)paren
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|ISDN_TIMRU_NUM_CHECK
suffix:semicolon
id|j
op_increment
)paren
r_if
c_cond
(paren
(paren
id|head
op_assign
id|lp-&gt;timeout_rules-&gt;timru
(braket
id|i
)braket
(braket
id|j
)braket
)paren
)paren
(brace
id|this
op_assign
id|head
suffix:semicolon
r_do
(brace
id|next
op_assign
id|this-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|this
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|next
op_eq
id|head
)paren
(brace
suffix:semicolon
)brace
)brace
id|kfree
c_func
(paren
id|lp-&gt;timeout_rules
)paren
suffix:semicolon
id|lp-&gt;timeout_rules
op_assign
l_int|NULL
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|isdn_timru_add_rule
id|isdn_timru_add_rule
c_func
(paren
r_int
id|where
comma
r_struct
id|device
op_star
id|ndev
comma
id|isdn_timeout_rule
op_star
id|rule
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|ndev-&gt;priv
suffix:semicolon
id|isdn_timeout_rule
op_star
op_star
id|head
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;timeout_rules
)paren
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|isdn_timru_alloc_timeout_rules
c_func
(paren
id|ndev
)paren
)paren
)paren
(brace
r_return
id|ret
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rule-&gt;timeout
OL
l_int|0
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|head
op_assign
op_amp
(paren
id|lp-&gt;timeout_rules-&gt;timru
(braket
id|rule-&gt;type
)braket
(braket
id|rule-&gt;protfam
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|head
)paren
(brace
id|rule-&gt;next
op_assign
id|rule-&gt;prev
op_assign
op_star
id|head
op_assign
id|rule
suffix:semicolon
)brace
r_else
(brace
id|rule-&gt;next
op_assign
op_star
id|head
suffix:semicolon
id|rule-&gt;prev
op_assign
(paren
op_star
id|head
)paren
op_member_access_from_pointer
id|prev
suffix:semicolon
(paren
op_star
id|head
)paren
op_member_access_from_pointer
id|prev-&gt;next
op_assign
id|rule
suffix:semicolon
(paren
op_star
id|head
)paren
op_member_access_from_pointer
id|prev
op_assign
id|rule
suffix:semicolon
r_if
c_cond
(paren
id|where
op_eq
l_int|0
)paren
(brace
multiline_comment|/* add to head of chain */
op_star
id|head
op_assign
id|rule
suffix:semicolon
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|isdn_timru_del_rule
id|isdn_timru_del_rule
c_func
(paren
r_struct
id|device
op_star
id|ndev
comma
id|isdn_timeout_rule
op_star
id|rule
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|ndev-&gt;priv
suffix:semicolon
id|isdn_timeout_rule
op_star
op_star
id|head
comma
op_star
id|this
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;timeout_rules
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|head
op_assign
op_amp
(paren
id|lp-&gt;timeout_rules-&gt;timru
(braket
id|rule-&gt;type
)braket
(braket
id|rule-&gt;protfam
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|head
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|this
op_assign
op_star
id|head
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|isdn_timru_rule_equals
c_func
(paren
id|this
comma
id|rule
)paren
)paren
(brace
r_if
c_cond
(paren
id|this-&gt;next
op_ne
id|this
)paren
(brace
multiline_comment|/* more than one rule */
id|this-&gt;prev-&gt;next
op_assign
id|this-&gt;next
suffix:semicolon
id|this-&gt;next-&gt;prev
op_assign
id|this-&gt;prev
suffix:semicolon
r_if
c_cond
(paren
id|this
op_eq
op_star
id|head
)paren
(brace
op_star
id|head
op_assign
id|this-&gt;next
suffix:semicolon
)brace
)brace
r_else
op_star
id|head
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|this
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
id|this
op_assign
id|this-&gt;next
suffix:semicolon
)brace
r_while
c_loop
(paren
id|this
op_eq
op_star
id|head
)paren
(brace
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_int
DECL|function|isdn_timru_set_default
id|isdn_timru_set_default
c_func
(paren
r_int
id|type
comma
r_struct
id|device
op_star
id|ndev
comma
r_int
id|def
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|ndev-&gt;priv
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;timeout_rules
)paren
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|isdn_timru_alloc_timeout_rules
c_func
(paren
id|ndev
)paren
)paren
)paren
(brace
r_return
id|ret
suffix:semicolon
)brace
r_if
c_cond
(paren
id|def
OL
l_int|0
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|lp-&gt;timeout_rules-&gt;defaults
(braket
id|type
)braket
op_assign
id|def
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|isdn_timru_get_rule
id|isdn_timru_get_rule
c_func
(paren
r_struct
id|device
op_star
id|ndev
comma
id|isdn_timeout_rule
op_star
op_star
id|rule
comma
r_int
id|i
comma
r_int
id|j
comma
r_int
id|k
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|ndev-&gt;priv
suffix:semicolon
id|isdn_timeout_rule
op_star
id|head
comma
op_star
id|this
suffix:semicolon
r_int
id|l
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;timeout_rules
op_logical_or
id|i
template_param
id|ISDN_TIMRU_NUM_CHECK
op_logical_or
id|j
template_param
id|ISDN_TIMRU_NUM_PROTFAM
op_logical_or
id|k
OL
l_int|0
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|this
op_assign
id|head
op_assign
id|lp-&gt;timeout_rules-&gt;timru
(braket
id|i
)braket
(braket
id|j
)braket
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
id|k
suffix:semicolon
id|l
op_increment
)paren
(brace
r_if
c_cond
(paren
id|this-&gt;next
op_eq
id|head
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|this
op_assign
id|this-&gt;next
suffix:semicolon
)brace
op_star
id|rule
op_assign
id|this
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|isdn_timru_get_default
id|isdn_timru_get_default
c_func
(paren
r_int
id|type
comma
r_struct
id|device
op_star
id|ndev
comma
r_int
op_star
id|ret
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
(paren
id|isdn_net_local
op_star
)paren
id|ndev-&gt;priv
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;timeout_rules
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
op_star
id|ret
op_assign
id|lp-&gt;timeout_rules-&gt;defaults
(braket
id|type
)braket
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|isdn_timru_ioctl_add_rule
id|isdn_timru_ioctl_add_rule
c_func
(paren
id|isdn_ioctl_timeout_rule
op_star
id|iorule
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|isdn_net_findif
c_func
(paren
id|iorule-&gt;name
)paren
suffix:semicolon
id|isdn_timeout_rule
op_star
id|r
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
id|iorule-&gt;where
OL
l_int|0
)paren
(brace
multiline_comment|/* set default */
r_return
id|isdn_timru_set_default
c_func
(paren
id|iorule-&gt;type
comma
op_amp
id|p-&gt;dev
comma
id|iorule-&gt;defval
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|r
op_assign
(paren
id|isdn_timeout_rule
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|isdn_timeout_rule
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|r
comma
(paren
r_char
op_star
)paren
op_amp
id|iorule-&gt;rule
comma
r_sizeof
(paren
id|isdn_timeout_rule
)paren
)paren
suffix:semicolon
r_return
id|isdn_timru_add_rule
c_func
(paren
id|iorule-&gt;where
comma
op_amp
id|p-&gt;dev
comma
id|r
)paren
suffix:semicolon
)brace
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_int
DECL|function|isdn_timru_ioctl_del_rule
id|isdn_timru_ioctl_del_rule
c_func
(paren
id|isdn_ioctl_timeout_rule
op_star
id|iorule
)paren
(brace
id|isdn_net_dev
op_star
id|p
op_assign
id|isdn_net_findif
c_func
(paren
id|iorule-&gt;name
)paren
suffix:semicolon
id|isdn_timeout_rule
op_star
id|r
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|r
op_assign
(paren
id|isdn_timeout_rule
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|isdn_timeout_rule
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|r
comma
(paren
r_char
op_star
)paren
op_amp
id|iorule-&gt;rule
comma
r_sizeof
(paren
id|isdn_timeout_rule
)paren
)paren
suffix:semicolon
r_return
id|isdn_timru_del_rule
c_func
(paren
op_amp
id|p-&gt;dev
comma
id|r
)paren
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_int
DECL|function|isdn_timru_ioctl_get_rule
id|isdn_timru_ioctl_get_rule
c_func
(paren
id|isdn_ioctl_timeout_rule
op_star
id|iorule
)paren
(brace
r_int
id|ret
comma
id|def
suffix:semicolon
id|isdn_net_dev
op_star
id|p
op_assign
id|isdn_net_findif
c_func
(paren
id|iorule-&gt;name
)paren
suffix:semicolon
id|isdn_timeout_rule
op_star
id|r
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
id|iorule-&gt;where
OL
l_int|0
)paren
(brace
multiline_comment|/* get default */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|isdn_timru_get_default
c_func
(paren
id|iorule-&gt;type
comma
op_amp
id|p-&gt;dev
comma
op_amp
id|def
)paren
)paren
OL
l_int|0
)paren
(brace
r_return
id|ret
suffix:semicolon
)brace
id|iorule-&gt;protfam
op_assign
id|p-&gt;local-&gt;huptimer
suffix:semicolon
id|iorule-&gt;index
op_assign
id|p-&gt;local-&gt;huptimeout
suffix:semicolon
id|iorule-&gt;defval
op_assign
id|def
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|isdn_timru_get_rule
c_func
(paren
op_amp
id|p-&gt;dev
comma
op_amp
id|r
comma
id|iorule-&gt;type
comma
id|iorule-&gt;protfam
comma
id|iorule-&gt;index
)paren
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|iorule-&gt;rule
comma
(paren
r_char
op_star
)paren
id|r
comma
r_sizeof
(paren
id|isdn_timeout_rule
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
macro_line|#endif
eof
