multiline_comment|/*&n; *&n; * Copyright (C) Eicon Technology Corporation, 2000.&n; *&n; * This source file is supplied for the exclusive use with Eicon&n; * Technology Corporation&squot;s range of DIVA Server Adapters.&n; *&n; * Eicon File Revision :    1.9  &n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY OF ANY KIND WHATSOEVER INCLUDING ANY &n; * implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  &n; * See the GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; */
macro_line|#include &lt;linux/fs.h&gt;
DECL|macro|N_DATA
macro_line|#undef N_DATA   /* Because we have our own definition */
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;sys.h&quot;
macro_line|#include &quot;idi.h&quot;
macro_line|#include &quot;constant.h&quot;
macro_line|#include &quot;divas.h&quot;
DECL|macro|ID_MASK
macro_line|#undef ID_MASK
macro_line|#include &quot;pc.h&quot;
macro_line|#include &quot;pr_pc.h&quot;
macro_line|#include &quot;adapter.h&quot;
macro_line|#include &quot;uxio.h&quot;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
DECL|macro|HW_ID_EICON_PCI
mdefine_line|#define HW_ID_EICON_PCI&t;&t;&t;0x1133
DECL|macro|HW_ID_DIVA_SERVER_P
mdefine_line|#define HW_ID_DIVA_SERVER_P&t;&t;0xE014
DECL|macro|HW_ID_DIVA_SERVER_B_ST
mdefine_line|#define HW_ID_DIVA_SERVER_B_ST&t;0xE010
DECL|macro|HW_ID_DIVA_SERVER_B_U
mdefine_line|#define HW_ID_DIVA_SERVER_B_U&t;0xE013
DECL|macro|HW_ID_DIVA_SERVER_Q
mdefine_line|#define HW_ID_DIVA_SERVER_Q   &t;0xE012
DECL|variable|Divas_fops
r_struct
id|file_operations
id|Divas_fops
suffix:semicolon
DECL|variable|Divas_major
r_int
id|Divas_major
suffix:semicolon
r_extern
r_int
id|do_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|pDivasInode
comma
r_struct
id|file
op_star
id|pDivasFile
comma
r_int
r_int
id|command
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_extern
r_int
r_int
id|do_poll
c_func
(paren
r_struct
id|file
op_star
id|pFile
comma
r_struct
id|poll_table_struct
op_star
id|pPollTable
)paren
suffix:semicolon
r_extern
id|ssize_t
id|do_read
c_func
(paren
r_struct
id|file
op_star
id|pFile
comma
r_char
op_star
id|pUserBuffer
comma
r_int
id|BufferSize
comma
id|loff_t
op_star
id|pOffset
)paren
suffix:semicolon
r_extern
r_int
id|do_open
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
)paren
suffix:semicolon
r_extern
r_int
id|do_release
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
)paren
suffix:semicolon
DECL|variable|FPGA_Done
r_int
id|FPGA_Done
op_assign
l_int|0
suffix:semicolon
DECL|function|DivasCardsDiscover
r_int
id|DivasCardsDiscover
c_func
(paren
r_void
)paren
(brace
id|word
id|wNumCards
op_assign
l_int|0
comma
id|wDeviceIndex
op_assign
l_int|0
suffix:semicolon
id|byte
id|byBus
comma
id|byFunc
suffix:semicolon
id|word
id|wPCIConsultation
comma
id|PCItmp
suffix:semicolon
id|dword
id|j
comma
id|i
suffix:semicolon
r_int
r_int
id|PCIserial
suffix:semicolon
id|dia_card_t
id|Card
suffix:semicolon
id|byte
op_star
id|b
suffix:semicolon
r_while
c_loop
(paren
id|wDeviceIndex
OL
l_int|10
)paren
(brace
id|wPCIConsultation
op_assign
id|pcibios_find_device
c_func
(paren
id|HW_ID_EICON_PCI
comma
id|HW_ID_DIVA_SERVER_Q
comma
id|wDeviceIndex
comma
op_amp
id|byBus
comma
op_amp
id|byFunc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wPCIConsultation
op_eq
id|PCIBIOS_SUCCESSFUL
)paren
(brace
id|dword
id|dwRAM
comma
id|dwDivasIOBase
comma
id|dwCFG
comma
id|dwCTL
suffix:semicolon
id|byte
id|byIRQ
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Divas: DIVA Server 4BRI Found&bslash;n&quot;
)paren
suffix:semicolon
id|pcibios_read_config_dword
c_func
(paren
id|byBus
comma
id|byFunc
comma
id|PCI_BASE_ADDRESS_2
comma
(paren
r_int
r_int
op_star
)paren
op_amp
id|dwRAM
)paren
suffix:semicolon
id|dwRAM
op_and_assign
l_int|0xFFC00000
suffix:semicolon
id|pcibios_read_config_dword
c_func
(paren
id|byBus
comma
id|byFunc
comma
id|PCI_BASE_ADDRESS_1
comma
(paren
r_int
r_int
op_star
)paren
op_amp
id|dwDivasIOBase
)paren
suffix:semicolon
id|dwDivasIOBase
op_and_assign
l_int|0xFFFFFF00
suffix:semicolon
id|pcibios_read_config_dword
c_func
(paren
id|byBus
comma
id|byFunc
comma
id|PCI_BASE_ADDRESS_0
comma
(paren
r_int
r_int
op_star
)paren
op_amp
id|dwCFG
)paren
suffix:semicolon
id|dwCFG
op_and_assign
l_int|0xFFFFFF00
suffix:semicolon
id|pcibios_read_config_dword
c_func
(paren
id|byBus
comma
id|byFunc
comma
id|PCI_BASE_ADDRESS_3
comma
(paren
r_int
r_int
op_star
)paren
op_amp
id|dwCTL
)paren
suffix:semicolon
id|dwCTL
op_and_assign
l_int|0xFFFFE000
suffix:semicolon
id|pcibios_read_config_byte
c_func
(paren
id|byBus
comma
id|byFunc
comma
id|PCI_INTERRUPT_LINE
comma
op_amp
id|byIRQ
)paren
suffix:semicolon
multiline_comment|/* Retrieve the serial number */
id|pcibios_write_config_word
c_func
(paren
id|byBus
comma
id|byFunc
comma
l_int|0x4E
comma
l_int|0x00FC
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
comma
id|PCItmp
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|10000
op_logical_and
op_logical_neg
id|PCItmp
suffix:semicolon
id|j
op_increment
)paren
(brace
id|pcibios_read_config_word
c_func
(paren
id|byBus
comma
id|byFunc
comma
l_int|0x4E
comma
op_amp
id|PCItmp
)paren
suffix:semicolon
id|PCItmp
op_and_assign
l_int|0x8000
suffix:semicolon
singleline_comment|// extract done flag
)brace
id|pcibios_read_config_dword
c_func
(paren
id|byBus
comma
id|byFunc
comma
l_int|0x50
comma
op_amp
id|PCIserial
)paren
suffix:semicolon
id|Card.memory
(braket
id|DIVAS_RAM_MEMORY
)braket
op_assign
id|ioremap
c_func
(paren
id|dwRAM
comma
l_int|0x400000
)paren
suffix:semicolon
id|Card.memory
(braket
id|DIVAS_CTL_MEMORY
)braket
op_assign
id|ioremap
c_func
(paren
id|dwCTL
comma
l_int|0x2000
)paren
suffix:semicolon
id|Card.memory
(braket
id|DIVAS_CFG_MEMORY
)braket
op_assign
id|ioremap
c_func
(paren
id|dwCFG
comma
l_int|0x100
)paren
suffix:semicolon
id|Card.io_base
op_assign
id|dwDivasIOBase
suffix:semicolon
id|Card.irq
op_assign
id|byIRQ
suffix:semicolon
id|Card.card_type
op_assign
id|DIA_CARD_TYPE_DIVA_SERVER_Q
suffix:semicolon
id|Card.bus_type
op_assign
id|DIA_BUS_TYPE_PCI
suffix:semicolon
id|FPGA_Done
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Create four virtual card structures as we want to treat &n;&t;&t;&t;   the 4Bri card as 4 Bri cards*/
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|b
op_assign
id|Card.memory
(braket
id|DIVAS_RAM_MEMORY
)braket
suffix:semicolon
id|b
op_add_assign
(paren
id|MQ_PROTCODE_OFFSET
)paren
op_star
(paren
id|i
op_eq
l_int|0
ques
c_cond
l_int|0
suffix:colon
l_int|1
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;divas: offset = 0x%x&quot;
comma
id|i
op_star
id|MQ_PROTCODE_OFFSET
)paren
)paren
suffix:semicolon
id|Card.memory
(braket
id|DIVAS_RAM_MEMORY
)braket
op_assign
id|b
suffix:semicolon
id|b
op_assign
id|Card.memory
(braket
id|DIVAS_RAM_MEMORY
)braket
suffix:semicolon
id|b
op_add_assign
id|MQ_SM_OFFSET
suffix:semicolon
id|Card.memory
(braket
id|DIVAS_SHARED_MEMORY
)braket
op_assign
id|b
suffix:semicolon
id|Card.bus_num
op_assign
id|byBus
suffix:semicolon
id|Card.func_num
op_assign
id|byFunc
suffix:semicolon
id|Card.slot
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Fill in Name */
id|Card.name
(braket
l_int|0
)braket
op_assign
l_char|&squot;D&squot;
suffix:semicolon
id|Card.name
(braket
l_int|1
)braket
op_assign
l_char|&squot;I&squot;
suffix:semicolon
id|Card.name
(braket
l_int|2
)braket
op_assign
l_char|&squot;V&squot;
suffix:semicolon
id|Card.name
(braket
l_int|3
)braket
op_assign
l_char|&squot;A&squot;
suffix:semicolon
id|Card.name
(braket
l_int|4
)braket
op_assign
l_char|&squot;S&squot;
suffix:semicolon
id|Card.name
(braket
l_int|5
)braket
op_assign
l_char|&squot;Q&squot;
suffix:semicolon
id|Card.name
(braket
l_int|6
)braket
op_assign
l_char|&squot;0&squot;
op_plus
id|i
suffix:semicolon
id|Card.name
(braket
l_int|7
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|Card.serial
op_assign
id|PCIserial
suffix:semicolon
id|Card.card_id
op_assign
id|wNumCards
suffix:semicolon
r_if
c_cond
(paren
id|DivasCardNew
c_func
(paren
op_amp
id|Card
)paren
op_ne
l_int|0
)paren
(brace
singleline_comment|// Force for loop to terminate
id|i
op_assign
l_int|4
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|wNumCards
op_increment
suffix:semicolon
)brace
singleline_comment|//for
)brace
id|wDeviceIndex
op_increment
suffix:semicolon
)brace
id|wDeviceIndex
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|wDeviceIndex
OL
l_int|10
)paren
(brace
id|wPCIConsultation
op_assign
id|pcibios_find_device
c_func
(paren
id|HW_ID_EICON_PCI
comma
id|HW_ID_DIVA_SERVER_B_ST
comma
id|wDeviceIndex
comma
op_amp
id|byBus
comma
op_amp
id|byFunc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wPCIConsultation
op_eq
id|PCIBIOS_SUCCESSFUL
)paren
(brace
id|dword
id|dwPLXIOBase
comma
id|dwDivasIOBase
suffix:semicolon
id|byte
id|byIRQ
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Divas: DIVA Server BRI (S/T) Found&bslash;n&quot;
)paren
suffix:semicolon
id|pcibios_read_config_dword
c_func
(paren
id|byBus
comma
id|byFunc
comma
id|PCI_BASE_ADDRESS_1
comma
(paren
r_int
r_int
op_star
)paren
op_amp
id|dwPLXIOBase
)paren
suffix:semicolon
id|dwPLXIOBase
op_and_assign
l_int|0xFFFFFF80
suffix:semicolon
id|pcibios_read_config_dword
c_func
(paren
id|byBus
comma
id|byFunc
comma
id|PCI_BASE_ADDRESS_2
comma
(paren
r_int
r_int
op_star
)paren
op_amp
id|dwDivasIOBase
)paren
suffix:semicolon
id|dwDivasIOBase
op_and_assign
l_int|0xFFFFFFFC
suffix:semicolon
id|pcibios_read_config_byte
c_func
(paren
id|byBus
comma
id|byFunc
comma
id|PCI_INTERRUPT_LINE
comma
op_amp
id|byIRQ
)paren
suffix:semicolon
id|Card.card_id
op_assign
id|wNumCards
suffix:semicolon
id|Card.card_type
op_assign
id|DIA_CARD_TYPE_DIVA_SERVER_B
suffix:semicolon
id|Card.bus_type
op_assign
id|DIA_BUS_TYPE_PCI
suffix:semicolon
id|Card.irq
op_assign
id|byIRQ
suffix:semicolon
id|Card.reset_base
op_assign
id|dwPLXIOBase
suffix:semicolon
id|Card.io_base
op_assign
id|dwDivasIOBase
suffix:semicolon
id|Card.bus_num
op_assign
id|byBus
suffix:semicolon
id|Card.func_num
op_assign
id|byFunc
suffix:semicolon
id|Card.slot
op_assign
op_minus
l_int|1
suffix:semicolon
id|Card.name
(braket
l_int|0
)braket
op_assign
l_char|&squot;D&squot;
suffix:semicolon
id|Card.name
(braket
l_int|1
)braket
op_assign
l_char|&squot;I&squot;
suffix:semicolon
id|Card.name
(braket
l_int|2
)braket
op_assign
l_char|&squot;V&squot;
suffix:semicolon
id|Card.name
(braket
l_int|3
)braket
op_assign
l_char|&squot;A&squot;
suffix:semicolon
id|Card.name
(braket
l_int|4
)braket
op_assign
l_char|&squot;S&squot;
suffix:semicolon
id|Card.name
(braket
l_int|5
)braket
op_assign
l_char|&squot;B&squot;
suffix:semicolon
id|Card.name
(braket
l_int|6
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|Card.io_base
comma
l_int|0x20
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Divas: DIVA I/O Base already in use 0x%x-0x%x&bslash;n&quot;
comma
id|Card.io_base
comma
id|Card.io_base
op_plus
l_int|0x1F
)paren
suffix:semicolon
id|wDeviceIndex
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|Card.reset_base
comma
l_int|0x80
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Divas: PLX I/O Base already in use 0x%x-0x%x&bslash;n&quot;
comma
id|Card.reset_base
comma
id|Card.reset_base
op_plus
l_int|0x7F
)paren
suffix:semicolon
id|wDeviceIndex
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|DivasCardNew
c_func
(paren
op_amp
id|Card
)paren
op_ne
l_int|0
)paren
(brace
id|wDeviceIndex
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|wNumCards
op_increment
suffix:semicolon
)brace
id|wPCIConsultation
op_assign
id|pcibios_find_device
c_func
(paren
id|HW_ID_EICON_PCI
comma
id|HW_ID_DIVA_SERVER_B_U
comma
id|wDeviceIndex
comma
op_amp
id|byBus
comma
op_amp
id|byFunc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wPCIConsultation
op_eq
id|PCIBIOS_SUCCESSFUL
)paren
(brace
id|dword
id|dwPLXIOBase
comma
id|dwDivasIOBase
suffix:semicolon
id|byte
id|byIRQ
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Divas: DIVA Server BRI (U) Found&bslash;n&quot;
)paren
suffix:semicolon
id|pcibios_read_config_dword
c_func
(paren
id|byBus
comma
id|byFunc
comma
id|PCI_BASE_ADDRESS_1
comma
(paren
r_int
r_int
op_star
)paren
op_amp
id|dwPLXIOBase
)paren
suffix:semicolon
id|dwPLXIOBase
op_and_assign
l_int|0xFFFFFF80
suffix:semicolon
id|pcibios_read_config_dword
c_func
(paren
id|byBus
comma
id|byFunc
comma
id|PCI_BASE_ADDRESS_2
comma
(paren
r_int
r_int
op_star
)paren
op_amp
id|dwDivasIOBase
)paren
suffix:semicolon
id|dwDivasIOBase
op_and_assign
l_int|0xFFFFFFFC
suffix:semicolon
id|pcibios_read_config_byte
c_func
(paren
id|byBus
comma
id|byFunc
comma
id|PCI_INTERRUPT_LINE
comma
op_amp
id|byIRQ
)paren
suffix:semicolon
id|Card.card_id
op_assign
id|wNumCards
suffix:semicolon
id|Card.card_type
op_assign
id|DIA_CARD_TYPE_DIVA_SERVER_B
suffix:semicolon
id|Card.bus_type
op_assign
id|DIA_BUS_TYPE_PCI
suffix:semicolon
id|Card.irq
op_assign
id|byIRQ
suffix:semicolon
id|Card.reset_base
op_assign
id|dwPLXIOBase
suffix:semicolon
id|Card.io_base
op_assign
id|dwDivasIOBase
suffix:semicolon
id|Card.bus_num
op_assign
id|byBus
suffix:semicolon
id|Card.func_num
op_assign
id|byFunc
suffix:semicolon
id|Card.slot
op_assign
op_minus
l_int|1
suffix:semicolon
id|Card.name
(braket
l_int|0
)braket
op_assign
l_char|&squot;D&squot;
suffix:semicolon
id|Card.name
(braket
l_int|1
)braket
op_assign
l_char|&squot;I&squot;
suffix:semicolon
id|Card.name
(braket
l_int|2
)braket
op_assign
l_char|&squot;V&squot;
suffix:semicolon
id|Card.name
(braket
l_int|3
)braket
op_assign
l_char|&squot;A&squot;
suffix:semicolon
id|Card.name
(braket
l_int|4
)braket
op_assign
l_char|&squot;S&squot;
suffix:semicolon
id|Card.name
(braket
l_int|5
)braket
op_assign
l_char|&squot;B&squot;
suffix:semicolon
id|Card.name
(braket
l_int|6
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|Card.io_base
comma
l_int|0x20
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Divas: DIVA I/O Base already in use 0x%x-0x%x&bslash;n&quot;
comma
id|Card.io_base
comma
id|Card.io_base
op_plus
l_int|0x1F
)paren
suffix:semicolon
id|wDeviceIndex
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|Card.reset_base
comma
l_int|0x80
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Divas: PLX I/O Base already in use 0x%x-0x%x&bslash;n&quot;
comma
id|Card.reset_base
comma
id|Card.reset_base
op_plus
l_int|0x7F
)paren
suffix:semicolon
id|wDeviceIndex
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|DivasCardNew
c_func
(paren
op_amp
id|Card
)paren
op_ne
l_int|0
)paren
(brace
id|wDeviceIndex
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|wNumCards
op_increment
suffix:semicolon
)brace
id|wDeviceIndex
op_increment
suffix:semicolon
)brace
id|wDeviceIndex
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|wDeviceIndex
OL
l_int|10
)paren
(brace
id|wPCIConsultation
op_assign
id|pcibios_find_device
c_func
(paren
id|HW_ID_EICON_PCI
comma
id|HW_ID_DIVA_SERVER_P
comma
id|wDeviceIndex
comma
op_amp
id|byBus
comma
op_amp
id|byFunc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wPCIConsultation
op_eq
id|PCIBIOS_SUCCESSFUL
)paren
(brace
id|dword
id|dwRAM
comma
id|dwREG
comma
id|dwCFG
suffix:semicolon
id|byte
id|byIRQ
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Divas: DIVA Server PRI Found&bslash;n&quot;
)paren
suffix:semicolon
id|pcibios_read_config_dword
c_func
(paren
id|byBus
comma
id|byFunc
comma
id|PCI_BASE_ADDRESS_0
comma
(paren
r_int
r_int
op_star
)paren
op_amp
id|dwRAM
)paren
suffix:semicolon
id|dwRAM
op_and_assign
l_int|0xFFFFF000
suffix:semicolon
id|pcibios_read_config_dword
c_func
(paren
id|byBus
comma
id|byFunc
comma
id|PCI_BASE_ADDRESS_2
comma
(paren
r_int
r_int
op_star
)paren
op_amp
id|dwREG
)paren
suffix:semicolon
id|dwREG
op_and_assign
l_int|0xFFFFF000
suffix:semicolon
id|pcibios_read_config_dword
c_func
(paren
id|byBus
comma
id|byFunc
comma
id|PCI_BASE_ADDRESS_4
comma
(paren
r_int
r_int
op_star
)paren
op_amp
id|dwCFG
)paren
suffix:semicolon
id|dwCFG
op_and_assign
l_int|0xFFFFF000
suffix:semicolon
id|pcibios_read_config_byte
c_func
(paren
id|byBus
comma
id|byFunc
comma
id|PCI_INTERRUPT_LINE
comma
op_amp
id|byIRQ
)paren
suffix:semicolon
id|Card.memory
(braket
id|DIVAS_RAM_MEMORY
)braket
op_assign
id|ioremap
c_func
(paren
id|dwRAM
comma
l_int|0x10000
)paren
suffix:semicolon
id|Card.memory
(braket
id|DIVAS_REG_MEMORY
)braket
op_assign
id|ioremap
c_func
(paren
id|dwREG
comma
l_int|0x4000
)paren
suffix:semicolon
id|Card.memory
(braket
id|DIVAS_CFG_MEMORY
)braket
op_assign
id|ioremap
c_func
(paren
id|dwCFG
comma
l_int|0x1000
)paren
suffix:semicolon
id|Card.memory
(braket
id|DIVAS_SHARED_MEMORY
)braket
op_assign
id|Card.memory
(braket
id|DIVAS_RAM_MEMORY
)braket
op_plus
id|DIVAS_SHARED_OFFSET
suffix:semicolon
multiline_comment|/*&t;&t;&t;pcibios_read_config_dword(byBus, byFunc, PCI_BASE_ADDRESS_1, (unsigned int *) &amp;dwPLXIOBase);&n;&t;&t;&t;dwPLXIOBase &amp;= 0xFFFFFFFc;&n;&n;&t;&t;&t;pcibios_read_config_dword(byBus, byFunc, PCI_BASE_ADDRESS_2, (unsigned int *) &amp;dwDivasIOBase);&n;&t;&t;&t;dwDivasIOBase &amp;= 0xFFFFFF80;&n;&n;&t;&t;&t;pcibios_read_config_byte(byBus, byFunc, PCI_INTERRUPT_LINE, &amp;byIRQ);&n;*/
id|Card.card_id
op_assign
id|wNumCards
suffix:semicolon
id|Card.card_type
op_assign
id|DIA_CARD_TYPE_DIVA_SERVER
suffix:semicolon
id|Card.bus_type
op_assign
id|DIA_BUS_TYPE_PCI
suffix:semicolon
id|Card.irq
op_assign
id|byIRQ
suffix:semicolon
multiline_comment|/*&t;&t;&t;Card.reset_base = dwPLXIOBase;&n;&t;&t;&t;Card.io_base = dwDivasIOBase;*/
id|Card.bus_num
op_assign
id|byBus
suffix:semicolon
id|Card.func_num
op_assign
id|byFunc
suffix:semicolon
id|Card.slot
op_assign
op_minus
l_int|1
suffix:semicolon
id|Card.name
(braket
l_int|0
)braket
op_assign
l_char|&squot;D&squot;
suffix:semicolon
id|Card.name
(braket
l_int|1
)braket
op_assign
l_char|&squot;I&squot;
suffix:semicolon
id|Card.name
(braket
l_int|2
)braket
op_assign
l_char|&squot;V&squot;
suffix:semicolon
id|Card.name
(braket
l_int|3
)braket
op_assign
l_char|&squot;A&squot;
suffix:semicolon
id|Card.name
(braket
l_int|4
)braket
op_assign
l_char|&squot;S&squot;
suffix:semicolon
id|Card.name
(braket
l_int|5
)braket
op_assign
l_char|&squot;P&squot;
suffix:semicolon
id|Card.name
(braket
l_int|6
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|DivasCardNew
c_func
(paren
op_amp
id|Card
)paren
op_ne
l_int|0
)paren
(brace
id|wDeviceIndex
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|wNumCards
op_increment
suffix:semicolon
)brace
id|wDeviceIndex
op_increment
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Divas: %d cards detected&bslash;n&quot;
comma
id|wNumCards
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wNumCards
op_eq
l_int|0
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|Divas_fops.ioctl
op_assign
id|do_ioctl
suffix:semicolon
id|Divas_fops.poll
op_assign
id|do_poll
suffix:semicolon
id|Divas_fops.read
op_assign
id|do_read
suffix:semicolon
id|Divas_fops.open
op_assign
id|do_open
suffix:semicolon
id|Divas_fops.release
op_assign
id|do_release
suffix:semicolon
id|Divas_major
op_assign
id|register_chrdev
c_func
(paren
l_int|0
comma
l_string|&quot;Divas&quot;
comma
op_amp
id|Divas_fops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Divas_major
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Divas: Unable to register character driver&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Error return -1 */
DECL|function|DivasConfigGet
r_int
id|DivasConfigGet
c_func
(paren
id|dia_card_t
op_star
id|card
)paren
(brace
multiline_comment|/* Retrieve Config from O/S? Not in Linux */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|DivasConfig
id|dia_config_t
op_star
id|DivasConfig
c_func
(paren
id|card_t
op_star
id|card
comma
id|dia_config_t
op_star
id|config
)paren
(brace
multiline_comment|/*&t;If config retrieved from OS then copy the data into a dia_config_t structure here&n;&t;&t;and return the pointer here. If the config &squot;came from above&squot; then just &n;&n;&t;&t;&t;return config;&n;&t;*/
r_return
id|config
suffix:semicolon
)brace
eof
