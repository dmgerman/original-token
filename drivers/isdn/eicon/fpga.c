multiline_comment|/*&n; *&n; * Copyright (C) Eicon Technology Corporation, 2000.&n; *&n; * This source file is supplied for the exclusive use with Eicon&n; * Technology Corporation&squot;s range of DIVA Server Adapters.&n; *&n; * Eicon File Revision :    1.2  &n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY OF ANY KIND WHATSOEVER INCLUDING ANY &n; * implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  &n; * See the GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; */
macro_line|#include &quot;sys.h&quot;
macro_line|#include &quot;idi.h&quot;
macro_line|#include &quot;uxio.h&quot;
DECL|macro|FPGA_PORT
mdefine_line|#define FPGA_PORT&t;&t;0x6E
DECL|macro|FPGA_DLOAD_BUFLEN
mdefine_line|#define FPGA_DLOAD_BUFLEN   &t;256
DECL|macro|NAME_OFFSET
mdefine_line|#define NAME_OFFSET         &t;0x10
DECL|macro|NAME_MAXLEN
mdefine_line|#define NAME_MAXLEN         &t;12
DECL|macro|DATE_OFFSET
mdefine_line|#define DATE_OFFSET         &t;0x2c
DECL|macro|DATE_MAXLEN
mdefine_line|#define DATE_MAXLEN         &t;10
id|word
id|UxCardPortIoInW
c_func
(paren
id|ux_diva_card_t
op_star
id|card
comma
id|byte
op_star
id|base
comma
r_int
id|offset
)paren
suffix:semicolon
r_void
id|UxCardPortIoOutW
c_func
(paren
id|ux_diva_card_t
op_star
id|card
comma
id|byte
op_star
id|base
comma
r_int
id|offset
comma
id|word
)paren
suffix:semicolon
r_void
id|UxPause
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* Loads the FPGA configuration file onto the hardware.                    */
multiline_comment|/* Function returns 0 on success, else an error number.                    */
multiline_comment|/* On success, an identifier string is returned in the buffer              */
multiline_comment|/*                                                                         */
multiline_comment|/* A buffer of FPGA_BUFSIZE, a handle to the already opened bitstream      */
multiline_comment|/* file and a file read function has to be provided by the operating       */
multiline_comment|/* system part.                                                            */
multiline_comment|/* ----------------------------------------------------------------------- */
DECL|function|FPGA_Download
r_int
id|FPGA_Download
c_func
(paren
id|word
id|cardtype
comma
id|dword
id|RegBase
comma
id|byte
op_star
id|strbuf
comma
id|byte
id|FPGA_SRC
(braket
)braket
comma
r_int
id|FPGA_LEN
)paren
(brace
id|word
id|i
comma
id|j
comma
id|k
suffix:semicolon
id|word
id|baseval
comma
id|Mask_PROGRAM
comma
id|Mask_DONE
comma
id|Mask_CCLK
comma
id|Mask_DIN
suffix:semicolon
id|dword
id|addr
suffix:semicolon
id|byte
op_star
id|pFPGA
suffix:semicolon
singleline_comment|//--- check for legal cardtype
r_switch
c_cond
(paren
id|cardtype
)paren
(brace
r_case
id|IDI_ADAPTER_MAESTRAQ
suffix:colon
id|addr
op_assign
id|RegBase
suffix:semicolon
singleline_comment|// address where to access FPGA
id|Mask_PROGRAM
op_assign
l_int|0x0001
suffix:semicolon
singleline_comment|// FPGA pins at address
id|Mask_DONE
op_assign
l_int|0x0002
suffix:semicolon
id|Mask_CCLK
op_assign
l_int|0x0100
suffix:semicolon
id|Mask_DIN
op_assign
l_int|0x0400
suffix:semicolon
id|baseval
op_assign
l_int|0x000d
suffix:semicolon
singleline_comment|// PROGRAM hi, CCLK lo, DIN lo by default
r_break
suffix:semicolon
r_default
suffix:colon
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;divas: FPGA Download ,Illegal Card&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
singleline_comment|// illegal card 
)brace
singleline_comment|//--- generate id string from file content
r_for
c_loop
(paren
id|j
op_assign
id|NAME_OFFSET
comma
id|k
op_assign
l_int|0
suffix:semicolon
id|j
OL
(paren
id|NAME_OFFSET
op_plus
id|NAME_MAXLEN
)paren
suffix:semicolon
id|j
op_increment
comma
id|k
op_increment
)paren
singleline_comment|//name
(brace
r_if
c_cond
(paren
op_logical_neg
id|FPGA_SRC
(braket
id|j
)braket
)paren
r_break
suffix:semicolon
id|strbuf
(braket
id|k
)braket
op_assign
id|FPGA_SRC
(braket
id|j
)braket
suffix:semicolon
)brace
id|strbuf
(braket
id|k
op_increment
)braket
op_assign
l_char|&squot; &squot;
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
id|DATE_OFFSET
suffix:semicolon
id|j
OL
(paren
id|DATE_OFFSET
op_plus
id|DATE_MAXLEN
)paren
suffix:semicolon
id|j
op_increment
comma
id|k
op_increment
)paren
singleline_comment|// date
(brace
r_if
c_cond
(paren
op_logical_neg
id|FPGA_SRC
(braket
id|j
)braket
)paren
r_break
suffix:semicolon
id|strbuf
(braket
id|k
)braket
op_assign
id|FPGA_SRC
(braket
id|j
)braket
suffix:semicolon
)brace
id|strbuf
(braket
id|k
)braket
op_assign
l_int|0
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;divas: FPGA Download - %s&quot;
comma
id|strbuf
)paren
)paren
suffix:semicolon
singleline_comment|//--- prepare download, Pulse PROGRAM pin down.
id|UxCardPortIoOutW
c_func
(paren
l_int|NULL
comma
(paren
id|byte
op_star
)paren
id|addr
comma
id|FPGA_PORT
comma
id|baseval
op_amp
op_complement
id|Mask_PROGRAM
)paren
suffix:semicolon
singleline_comment|// PROGRAM low pulse
id|UxCardPortIoOutW
c_func
(paren
l_int|NULL
comma
(paren
id|byte
op_star
)paren
id|addr
comma
id|FPGA_PORT
comma
id|baseval
)paren
suffix:semicolon
singleline_comment|// release
id|UxPause
c_func
(paren
l_int|50
)paren
suffix:semicolon
singleline_comment|// wait until FPGA finised internal memory clear
singleline_comment|//--- check done pin, must be low
r_if
c_cond
(paren
id|UxCardPortIoInW
c_func
(paren
l_int|NULL
comma
(paren
id|byte
op_star
)paren
id|addr
comma
id|FPGA_PORT
)paren
op_amp
id|Mask_DONE
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;divas: FPGA_ERR_DONE_WRONG_LEVEL&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|pFPGA
op_assign
id|FPGA_SRC
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Move past the header */
r_while
c_loop
(paren
(paren
id|FPGA_SRC
(braket
id|i
)braket
op_ne
l_int|0xFF
)paren
op_logical_and
(paren
id|i
OL
id|FPGA_LEN
)paren
)paren
(brace
id|i
op_increment
suffix:semicolon
)brace
singleline_comment|// We&squot;ve hit the 0xFF so move on to the next byte
singleline_comment|// i++;
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;divas: FPGA Code starts at offset %d&quot;
comma
id|i
)paren
)paren
suffix:semicolon
singleline_comment|//--- put data onto the FPGA
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
id|FPGA_LEN
suffix:semicolon
id|i
op_increment
)paren
(brace
singleline_comment|//--- put byte onto FPGA
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|FPGA_SRC
(braket
id|i
)braket
op_amp
(paren
l_int|0x80
op_rshift
id|j
)paren
)paren
id|baseval
op_or_assign
id|Mask_DIN
suffix:semicolon
singleline_comment|// write a hi
r_else
id|baseval
op_and_assign
op_complement
id|Mask_DIN
suffix:semicolon
singleline_comment|// write a lo
id|UxCardPortIoOutW
c_func
(paren
l_int|NULL
comma
(paren
id|byte
op_star
)paren
id|addr
comma
id|FPGA_PORT
comma
id|baseval
)paren
suffix:semicolon
id|UxCardPortIoOutW
c_func
(paren
l_int|NULL
comma
(paren
id|byte
op_star
)paren
id|addr
comma
id|FPGA_PORT
comma
id|baseval
op_or
id|Mask_CCLK
)paren
suffix:semicolon
singleline_comment|// set CCLK hi
id|UxCardPortIoOutW
c_func
(paren
l_int|NULL
comma
(paren
id|byte
op_star
)paren
id|addr
comma
id|FPGA_PORT
comma
id|baseval
)paren
suffix:semicolon
singleline_comment|// set CCLK lo
)brace
)brace
singleline_comment|//--- add some additional startup clock cycles and check done pin
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
(brace
id|UxCardPortIoOutW
c_func
(paren
l_int|NULL
comma
(paren
id|byte
op_star
)paren
id|addr
comma
id|FPGA_PORT
comma
id|baseval
op_or
id|Mask_CCLK
)paren
suffix:semicolon
singleline_comment|// set CCLK hi
id|UxCardPortIoOutW
c_func
(paren
l_int|NULL
comma
(paren
id|byte
op_star
)paren
id|addr
comma
id|FPGA_PORT
comma
id|baseval
)paren
suffix:semicolon
singleline_comment|// set CCLK lo
)brace
id|UxPause
c_func
(paren
l_int|100
)paren
suffix:semicolon
r_if
c_cond
(paren
id|UxCardPortIoInW
c_func
(paren
l_int|NULL
comma
(paren
id|byte
op_star
)paren
id|addr
comma
id|FPGA_PORT
)paren
op_amp
id|Mask_DONE
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;divas: FPGA download successful&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;divas: FPGA download failed - 0x%x&quot;
comma
id|UxCardPortIoInW
c_func
(paren
l_int|NULL
comma
(paren
id|byte
op_star
)paren
id|addr
comma
id|FPGA_PORT
)paren
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
eof
