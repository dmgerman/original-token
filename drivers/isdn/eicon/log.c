multiline_comment|/*&n; *&n; * Copyright (C) Eicon Technology Corporation, 2000.&n; *&n; * This source file is supplied for the exclusive use with Eicon&n; * Technology Corporation&squot;s range of DIVA Server Adapters.&n; *&n; * Eicon File Revision :    1.5  &n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY OF ANY KIND WHATSOEVER INCLUDING ANY &n; * implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  &n; * See the GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; */
multiline_comment|/*&n; * Source file for diva log facility&n; */
macro_line|#include &quot;sys.h&quot;
macro_line|#include &quot;idi.h&quot;
macro_line|#include &quot;divas.h&quot;
macro_line|#include &quot;adapter.h&quot;
macro_line|#include &quot;divalog.h&quot;
macro_line|#include &quot;uxio.h&quot;
multiline_comment|/*Counter to monitor number of messages */
DECL|variable|m_count
r_static
r_int
id|m_count
suffix:semicolon
DECL|macro|MAX_BUFFERED_MSGS
mdefine_line|#define     MAX_BUFFERED_MSGS   (1000)
multiline_comment|/* Our Linked List Structure to hold message */
DECL|struct|klog_link
r_typedef
r_struct
id|klog_link
(brace
DECL|member|klog
id|klog_t
id|klog
suffix:semicolon
DECL|member|next
r_struct
id|klog_link
op_star
id|next
suffix:semicolon
DECL|typedef|KNODE
)brace
id|KNODE
suffix:semicolon
multiline_comment|/* First &amp; Last structures in list*/
DECL|variable|head
id|KNODE
op_star
id|head
suffix:semicolon
DECL|variable|tail
id|KNODE
op_star
id|tail
suffix:semicolon
multiline_comment|/* &n; * retrieve message from FIFO buffer&n; * returns NULL if buffer empty&n; * otherwise returns pointer to entry &n; */
DECL|function|DivasLogFifoRead
r_char
op_star
id|DivasLogFifoRead
c_func
(paren
r_void
)paren
(brace
id|KNODE
op_star
id|old_head
suffix:semicolon
r_if
c_cond
(paren
id|head
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Buffer Empty - No Messages */
r_return
l_int|NULL
suffix:semicolon
)brace
id|m_count
op_decrement
suffix:semicolon
multiline_comment|/* Keep track of message to be read &amp; increment to next message*/
id|old_head
op_assign
id|head
suffix:semicolon
id|head
op_assign
id|head-&gt;next
suffix:semicolon
multiline_comment|/*Return ptr to Msg */
r_return
(paren
r_char
op_star
)paren
id|old_head
suffix:semicolon
)brace
multiline_comment|/* &n; * write message into FIFO buffer&n; */
DECL|function|DivasLogFifoWrite
r_void
id|DivasLogFifoWrite
c_func
(paren
r_char
op_star
id|entry
comma
r_int
id|length
)paren
(brace
id|KNODE
op_star
id|new_klog
suffix:semicolon
r_if
c_cond
(paren
id|head
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* No Entries in Log */
id|tail
op_assign
l_int|NULL
suffix:semicolon
id|m_count
op_assign
l_int|0
suffix:semicolon
id|new_klog
op_assign
id|UxAlloc
c_func
(paren
r_sizeof
(paren
id|KNODE
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_klog
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
id|m_count
op_increment
suffix:semicolon
id|bzero
c_func
(paren
id|new_klog
comma
r_sizeof
(paren
id|KNODE
)paren
)paren
suffix:semicolon
multiline_comment|/* Set head &amp; tail to point to the new Msg Struct */
id|head
op_assign
id|tail
op_assign
id|new_klog
suffix:semicolon
id|tail-&gt;next
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|new_klog
op_assign
id|UxAlloc
c_func
(paren
r_sizeof
(paren
id|KNODE
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_klog
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
id|m_count
op_increment
suffix:semicolon
id|bzero
c_func
(paren
id|new_klog
comma
r_sizeof
(paren
id|KNODE
)paren
)paren
suffix:semicolon
multiline_comment|/* Let last Msg Struct point to new Msg Struct &amp; inc tail */
id|tail-&gt;next
op_assign
id|new_klog
suffix:semicolon
id|tail
op_assign
id|new_klog
suffix:semicolon
id|tail-&gt;next
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|length
OG
r_sizeof
(paren
id|klog_t
)paren
)paren
(brace
id|length
op_assign
r_sizeof
(paren
id|klog_t
)paren
suffix:semicolon
)brace
id|bcopy
c_func
(paren
id|entry
comma
op_amp
id|tail-&gt;klog
comma
id|length
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * DivaslogFifoEmpty:return TRUE if FIFO buffer is empty,otherwise FALSE&n; */
DECL|function|DivasLogFifoEmpty
r_int
id|DivasLogFifoEmpty
c_func
(paren
r_void
)paren
(brace
r_return
(paren
id|m_count
op_eq
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *DivasLogFifoFull:return TRUE if FIFO buffer is full,otherwise FALSE&n; */
DECL|function|DivasLogFifoFull
r_int
id|DivasLogFifoFull
c_func
(paren
r_void
)paren
(brace
r_return
(paren
id|m_count
op_eq
id|MAX_BUFFERED_MSGS
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * generate an IDI log entry&n; */
DECL|function|DivasLogIdi
r_void
id|DivasLogIdi
c_func
(paren
id|card_t
op_star
id|card
comma
id|ENTITY
op_star
id|e
comma
r_int
id|request
)paren
(brace
id|klog_t
id|klog
suffix:semicolon
id|bzero
c_func
(paren
op_amp
id|klog
comma
r_sizeof
(paren
id|klog
)paren
)paren
suffix:semicolon
id|klog.time_stamp
op_assign
id|UxTimeGet
c_func
(paren
)paren
suffix:semicolon
id|klog.length
op_assign
r_sizeof
(paren
id|ENTITY
)paren
OG
r_sizeof
(paren
id|klog.buffer
)paren
ques
c_cond
r_sizeof
(paren
id|klog.buffer
)paren
suffix:colon
r_sizeof
(paren
id|ENTITY
)paren
suffix:semicolon
id|klog.card
op_assign
(paren
r_int
)paren
(paren
id|card
op_minus
id|DivasCards
)paren
suffix:semicolon
id|klog.type
op_assign
id|request
ques
c_cond
id|KLOG_IDI_REQ
suffix:colon
id|KLOG_IDI_CALLBACK
suffix:semicolon
id|klog.code
op_assign
l_int|0
suffix:semicolon
id|bcopy
c_func
(paren
id|e
comma
id|klog.buffer
comma
id|klog.length
)paren
suffix:semicolon
multiline_comment|/* send to the log driver and return */
id|DivasLogAdd
c_func
(paren
op_amp
id|klog
comma
r_sizeof
(paren
id|klog
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
eof
