multiline_comment|/* $Id: eicon_isa.c,v 1.16 2000/06/12 12:44:02 armin Exp $&n; *&n; * ISDN low-level module for Eicon active ISDN-Cards.&n; * Hardware-specific code for old ISA cards.&n; *&n; * Copyright 1998      by Fritz Elfert (fritz@isdn4linux.de)&n; * Copyright 1998-2000 by Armin Schindler (mac@melware.de)&n; * Copyright 1999,2000 Cytronics &amp; Melware (info@melware.de)&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA. &n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &quot;eicon.h&quot;
macro_line|#include &quot;eicon_isa.h&quot;
DECL|macro|check_shmem
mdefine_line|#define check_shmem   check_region
DECL|macro|release_shmem
mdefine_line|#define release_shmem release_region
DECL|macro|request_shmem
mdefine_line|#define request_shmem request_region
DECL|variable|eicon_isa_revision
r_char
op_star
id|eicon_isa_revision
op_assign
l_string|&quot;$Revision: 1.16 $&quot;
suffix:semicolon
DECL|macro|EICON_MCA_DEBUG
macro_line|#undef EICON_MCA_DEBUG
macro_line|#ifdef CONFIG_ISDN_DRV_EICON_ISA
multiline_comment|/* Mask for detecting invalid IRQ parameter */
DECL|variable|eicon_isa_valid_irq
r_static
r_int
id|eicon_isa_valid_irq
(braket
)braket
op_assign
(brace
l_int|0x1c1c
comma
multiline_comment|/* 2, 3, 4, 10, 11, 12 (S)*/
l_int|0x1c1c
comma
multiline_comment|/* 2, 3, 4, 10, 11, 12 (SX) */
l_int|0x1cbc
comma
multiline_comment|/* 2, 3, 4, 5, 7, 10, 11, 12 (SCOM) */
l_int|0x1cbc
comma
multiline_comment|/* 2, 3, 4, 5, 6, 10, 11, 12 (Quadro) */
l_int|0x1cbc
multiline_comment|/* 2, 3, 4, 5, 7, 10, 11, 12 (S2M) */
)brace
suffix:semicolon
r_static
r_void
DECL|function|eicon_isa_release_shmem
id|eicon_isa_release_shmem
c_func
(paren
id|eicon_isa_card
op_star
id|card
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;mvalid
)paren
(brace
id|iounmap
c_func
(paren
id|card-&gt;shmem
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|card-&gt;physmem
comma
id|card-&gt;ramsize
)paren
suffix:semicolon
)brace
id|card-&gt;mvalid
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|eicon_isa_release_irq
id|eicon_isa_release_irq
c_func
(paren
id|eicon_isa_card
op_star
id|card
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;master
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;ivalid
)paren
id|free_irq
c_func
(paren
id|card-&gt;irq
comma
id|card
)paren
suffix:semicolon
id|card-&gt;ivalid
op_assign
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|eicon_isa_release
id|eicon_isa_release
c_func
(paren
id|eicon_isa_card
op_star
id|card
)paren
(brace
id|eicon_isa_release_irq
c_func
(paren
id|card
)paren
suffix:semicolon
id|eicon_isa_release_shmem
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
r_void
DECL|function|eicon_isa_printpar
id|eicon_isa_printpar
c_func
(paren
id|eicon_isa_card
op_star
id|card
)paren
(brace
r_switch
c_cond
(paren
id|card-&gt;type
)paren
(brace
r_case
id|EICON_CTYPE_S
suffix:colon
r_case
id|EICON_CTYPE_SX
suffix:colon
r_case
id|EICON_CTYPE_SCOM
suffix:colon
r_case
id|EICON_CTYPE_QUADRO
suffix:colon
r_case
id|EICON_CTYPE_S2M
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Eicon %s at 0x%lx, irq %d.&bslash;n&quot;
comma
id|eicon_ctype_name
(braket
id|card-&gt;type
)braket
comma
id|card-&gt;physmem
comma
id|card-&gt;irq
)paren
suffix:semicolon
)brace
)brace
r_int
DECL|function|eicon_isa_find_card
id|eicon_isa_find_card
c_func
(paren
r_int
id|Mem
comma
r_int
id|Irq
comma
r_char
op_star
id|Id
)paren
(brace
r_int
id|primary
op_assign
l_int|1
suffix:semicolon
r_int
r_int
id|amem
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strlen
c_func
(paren
id|Id
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|Mem
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Check for valid membase address */
r_if
c_cond
(paren
(paren
id|Mem
OL
l_int|0x0c0000
)paren
op_logical_or
(paren
id|Mem
OG
l_int|0x0fc000
)paren
op_logical_or
(paren
id|Mem
op_amp
l_int|0xfff
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eicon_isa: illegal membase 0x%x for %s&bslash;n&quot;
comma
id|Mem
comma
id|Id
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|check_mem_region
c_func
(paren
id|Mem
comma
id|RAMSIZE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eicon_isa_boot: memory at 0x%x already in use.&bslash;n&quot;
comma
id|Mem
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|amem
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
id|Mem
comma
id|RAMSIZE
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0x55aa
comma
id|amem
op_plus
l_int|0x402
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readw
c_func
(paren
id|amem
op_plus
l_int|0x402
)paren
op_ne
l_int|0x55aa
)paren
id|primary
op_assign
l_int|0
suffix:semicolon
id|writew
c_func
(paren
l_int|0
comma
id|amem
op_plus
l_int|0x402
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readw
c_func
(paren
id|amem
op_plus
l_int|0x402
)paren
op_ne
l_int|0
)paren
id|primary
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Eicon: Driver-ID: %s&bslash;n&quot;
comma
id|Id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|primary
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Eicon: assuming pri card at 0x%x&bslash;n&quot;
comma
id|Mem
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
id|amem
op_plus
l_int|0x3ffe
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|amem
)paren
suffix:semicolon
r_return
id|EICON_CTYPE_ISAPRI
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Eicon: assuming bri card at 0x%x&bslash;n&quot;
comma
id|Mem
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
id|amem
op_plus
l_int|0x400
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|amem
)paren
suffix:semicolon
r_return
id|EICON_CTYPE_ISABRI
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_int
DECL|function|eicon_isa_bootload
id|eicon_isa_bootload
c_func
(paren
id|eicon_isa_card
op_star
id|card
comma
id|eicon_isa_codebuf
op_star
id|cb
)paren
(brace
r_int
id|tmp
suffix:semicolon
r_int
id|timeout
suffix:semicolon
id|eicon_isa_codebuf
id|cbuf
suffix:semicolon
r_int
r_char
op_star
id|code
suffix:semicolon
id|eicon_isa_boot
op_star
id|boot
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|cbuf
comma
id|cb
comma
r_sizeof
(paren
id|eicon_isa_codebuf
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* Allocate code-buffer and copy code from userspace */
r_if
c_cond
(paren
id|cbuf.bootstrap_len
OG
l_int|1024
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eicon_isa_boot: Invalid startup-code size %ld&bslash;n&quot;
comma
id|cbuf.bootstrap_len
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|code
op_assign
id|kmalloc
c_func
(paren
id|cbuf.bootstrap_len
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eicon_isa_boot: Couldn&squot;t allocate code buffer&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|code
comma
op_amp
id|cb-&gt;code
comma
id|cbuf.bootstrap_len
)paren
)paren
(brace
id|kfree
c_func
(paren
id|code
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;type
op_eq
id|EICON_CTYPE_ISAPRI
)paren
id|card-&gt;ramsize
op_assign
id|RAMSIZE_P
suffix:semicolon
r_else
id|card-&gt;ramsize
op_assign
id|RAMSIZE
suffix:semicolon
r_if
c_cond
(paren
id|check_mem_region
c_func
(paren
id|card-&gt;physmem
comma
id|card-&gt;ramsize
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eicon_isa_boot: memory at 0x%lx already in use.&bslash;n&quot;
comma
id|card-&gt;physmem
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|code
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|request_mem_region
c_func
(paren
id|card-&gt;physmem
comma
id|card-&gt;ramsize
comma
l_string|&quot;Eicon ISA ISDN&quot;
)paren
suffix:semicolon
id|card-&gt;shmem
op_assign
(paren
id|eicon_isa_shmem
op_star
)paren
id|ioremap
c_func
(paren
id|card-&gt;physmem
comma
id|card-&gt;ramsize
)paren
suffix:semicolon
macro_line|#ifdef EICON_MCA_DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;eicon_isa_boot: card-&gt;ramsize = %d.&bslash;n&quot;
comma
id|card-&gt;ramsize
)paren
suffix:semicolon
macro_line|#endif
id|card-&gt;mvalid
op_assign
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|card-&gt;type
)paren
(brace
r_case
id|EICON_CTYPE_S
suffix:colon
r_case
id|EICON_CTYPE_SX
suffix:colon
r_case
id|EICON_CTYPE_SCOM
suffix:colon
r_case
id|EICON_CTYPE_QUADRO
suffix:colon
r_case
id|EICON_CTYPE_ISABRI
suffix:colon
id|card-&gt;intack
op_assign
(paren
id|__u8
op_star
)paren
id|card-&gt;shmem
op_plus
id|INTACK
suffix:semicolon
id|card-&gt;startcpu
op_assign
(paren
id|__u8
op_star
)paren
id|card-&gt;shmem
op_plus
id|STARTCPU
suffix:semicolon
id|card-&gt;stopcpu
op_assign
(paren
id|__u8
op_star
)paren
id|card-&gt;shmem
op_plus
id|STOPCPU
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EICON_CTYPE_S2M
suffix:colon
r_case
id|EICON_CTYPE_ISAPRI
suffix:colon
id|card-&gt;intack
op_assign
(paren
id|__u8
op_star
)paren
id|card-&gt;shmem
op_plus
id|INTACK_P
suffix:semicolon
id|card-&gt;startcpu
op_assign
(paren
id|__u8
op_star
)paren
id|card-&gt;shmem
op_plus
id|STARTCPU_P
suffix:semicolon
id|card-&gt;stopcpu
op_assign
(paren
id|__u8
op_star
)paren
id|card-&gt;shmem
op_plus
id|STOPCPU_P
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eicon_isa_boot: Invalid card type %d&bslash;n&quot;
comma
id|card-&gt;type
)paren
suffix:semicolon
id|eicon_isa_release_shmem
c_func
(paren
id|card
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|code
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* clear any pending irq&squot;s */
id|readb
c_func
(paren
id|card-&gt;intack
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_MCA
r_if
c_cond
(paren
id|MCA_bus
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;type
op_eq
id|EICON_CTYPE_SCOM
)paren
(brace
id|outb_p
c_func
(paren
l_int|0
comma
id|card-&gt;io
op_plus
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eicon_isa_boot: Card type not supported yet.&bslash;n&quot;
)paren
suffix:semicolon
id|eicon_isa_release_shmem
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
suffix:semicolon
macro_line|#ifdef EICON_MCA_DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;eicon_isa_boot: card-&gt;io      = %x.&bslash;n&quot;
comma
id|card-&gt;io
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;eicon_isa_boot: card-&gt;irq     = %d.&bslash;n&quot;
comma
(paren
r_int
)paren
id|card-&gt;irq
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#else
multiline_comment|/* set reset-line active */
id|writeb
c_func
(paren
l_int|0
comma
id|card-&gt;stopcpu
)paren
suffix:semicolon
macro_line|#endif  /* CONFIG_MCA */
multiline_comment|/* clear irq-requests */
id|writeb
c_func
(paren
l_int|0
comma
id|card-&gt;intack
)paren
suffix:semicolon
id|readb
c_func
(paren
id|card-&gt;intack
)paren
suffix:semicolon
multiline_comment|/* Copy code into card */
id|memcpy_toio
c_func
(paren
op_amp
id|card-&gt;shmem-&gt;c
comma
id|code
comma
id|cbuf.bootstrap_len
)paren
suffix:semicolon
multiline_comment|/* Check for properly loaded code */
r_if
c_cond
(paren
op_logical_neg
id|check_signature
c_func
(paren
(paren
r_int
r_int
)paren
op_amp
id|card-&gt;shmem-&gt;c
comma
id|code
comma
l_int|1020
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eicon_isa_boot: Could not load startup-code&bslash;n&quot;
)paren
suffix:semicolon
id|eicon_isa_release_shmem
c_func
(paren
id|card
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|code
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* if 16k-ramsize, duplicate the reset-jump-code */
r_if
c_cond
(paren
id|card-&gt;ramsize
op_eq
id|RAMSIZE_P
)paren
id|memcpy_toio
c_func
(paren
(paren
id|__u8
op_star
)paren
id|card-&gt;shmem
op_plus
l_int|0x3ff0
comma
op_amp
id|code
(braket
l_int|0x3f0
)braket
comma
l_int|12
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|code
)paren
suffix:semicolon
id|boot
op_assign
op_amp
id|card-&gt;shmem-&gt;boot
suffix:semicolon
multiline_comment|/* Delay 0.2 sec. */
id|SLEEP
c_func
(paren
l_int|20
)paren
suffix:semicolon
multiline_comment|/* Start CPU */
id|writeb
c_func
(paren
id|cbuf.boot_opt
comma
op_amp
id|boot-&gt;ctrl
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_MCA
r_if
c_cond
(paren
id|MCA_bus
)paren
(brace
id|outb_p
c_func
(paren
l_int|0
comma
id|card-&gt;io
)paren
suffix:semicolon
)brace
macro_line|#else 
id|writeb
c_func
(paren
l_int|0
comma
id|card-&gt;startcpu
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_MCA */
multiline_comment|/* Delay 0.2 sec. */
id|SLEEP
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_star
l_int|22
)paren
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
id|jiffies
)paren
(brace
r_if
c_cond
(paren
id|readb
c_func
(paren
op_amp
id|boot-&gt;ctrl
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|SLEEP
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|readb
c_func
(paren
op_amp
id|boot-&gt;ctrl
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eicon_isa_boot: CPU test failed.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef EICON_MCA_DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;eicon_isa_boot: &amp;boot-&gt;ctrl = %d.&bslash;n&quot;
comma
id|readb
c_func
(paren
op_amp
id|boot-&gt;ctrl
)paren
)paren
suffix:semicolon
macro_line|#endif
id|eicon_isa_release_shmem
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* Check for memory-test errors */
r_if
c_cond
(paren
id|readw
c_func
(paren
op_amp
id|boot-&gt;ebit
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eicon_isa_boot: memory test failed (bit 0x%04x at 0x%08x)&bslash;n&quot;
comma
id|readw
c_func
(paren
op_amp
id|boot-&gt;ebit
)paren
comma
id|readl
c_func
(paren
op_amp
id|boot-&gt;eloc
)paren
)paren
suffix:semicolon
id|eicon_isa_release_shmem
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* Check card type and memory size */
id|tmp
op_assign
id|readb
c_func
(paren
op_amp
id|boot-&gt;card
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
OL
l_int|0
)paren
op_logical_or
(paren
id|tmp
OG
l_int|4
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eicon_isa_boot: Type detect failed&bslash;n&quot;
)paren
suffix:semicolon
id|eicon_isa_release_shmem
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|card-&gt;type
op_assign
id|tmp
suffix:semicolon
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|type
op_assign
id|tmp
suffix:semicolon
id|tmp
op_assign
id|readb
c_func
(paren
op_amp
id|boot-&gt;msize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_ne
l_int|8
op_logical_and
id|tmp
op_ne
l_int|16
op_logical_and
id|tmp
op_ne
l_int|24
op_logical_and
id|tmp
op_ne
l_int|32
op_logical_and
id|tmp
op_ne
l_int|48
op_logical_and
id|tmp
op_ne
l_int|60
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eicon_isa_boot: invalid memsize&bslash;n&quot;
)paren
suffix:semicolon
id|eicon_isa_release_shmem
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: startup-code loaded&bslash;n&quot;
comma
id|eicon_ctype_name
(braket
id|card-&gt;type
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|card-&gt;type
op_eq
id|EICON_CTYPE_QUADRO
)paren
op_logical_and
(paren
id|card-&gt;master
)paren
)paren
(brace
id|tmp
op_assign
id|eicon_addcard
c_func
(paren
id|card-&gt;type
comma
id|card-&gt;physmem
comma
id|card-&gt;irq
comma
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|regname
comma
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Eicon: %d adapters added&bslash;n&quot;
comma
id|tmp
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|eicon_isa_load
id|eicon_isa_load
c_func
(paren
id|eicon_isa_card
op_star
id|card
comma
id|eicon_isa_codebuf
op_star
id|cb
)paren
(brace
id|eicon_isa_boot
op_star
id|boot
suffix:semicolon
r_int
id|tmp
suffix:semicolon
r_int
id|timeout
suffix:semicolon
r_int
id|j
suffix:semicolon
id|eicon_isa_codebuf
id|cbuf
suffix:semicolon
r_int
r_char
op_star
id|code
suffix:semicolon
r_int
r_char
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|cbuf
comma
id|cb
comma
r_sizeof
(paren
id|eicon_isa_codebuf
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|code
op_assign
id|kmalloc
c_func
(paren
id|cbuf.firmware_len
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eicon_isa_load: Couldn&squot;t allocate code buffer&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|code
comma
op_amp
id|cb-&gt;code
comma
id|cbuf.firmware_len
)paren
)paren
(brace
id|kfree
c_func
(paren
id|code
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|boot
op_assign
op_amp
id|card-&gt;shmem-&gt;boot
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|card-&gt;ivalid
)paren
op_logical_and
id|card-&gt;master
)paren
(brace
id|card-&gt;irqprobe
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Check for valid IRQ */
r_if
c_cond
(paren
(paren
id|card-&gt;irq
OL
l_int|0
)paren
op_logical_or
(paren
id|card-&gt;irq
OG
l_int|15
)paren
op_logical_or
(paren
op_logical_neg
(paren
(paren
l_int|1
op_lshift
id|card-&gt;irq
)paren
op_amp
id|eicon_isa_valid_irq
(braket
id|card-&gt;type
op_amp
l_int|0x0f
)braket
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eicon_isa_load: illegal irq: %d&bslash;n&quot;
comma
id|card-&gt;irq
)paren
suffix:semicolon
id|eicon_isa_release_shmem
c_func
(paren
id|card
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|code
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Register irq */
r_if
c_cond
(paren
op_logical_neg
id|request_irq
c_func
(paren
id|card-&gt;irq
comma
op_amp
id|eicon_irq
comma
l_int|0
comma
l_string|&quot;Eicon ISA ISDN&quot;
comma
id|card
)paren
)paren
id|card-&gt;ivalid
op_assign
l_int|1
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eicon_isa_load: irq %d already in use.&bslash;n&quot;
comma
id|card-&gt;irq
)paren
suffix:semicolon
id|eicon_isa_release_shmem
c_func
(paren
id|card
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|code
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
)brace
id|tmp
op_assign
id|readb
c_func
(paren
op_amp
id|boot-&gt;msize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_ne
l_int|8
op_logical_and
id|tmp
op_ne
l_int|16
op_logical_and
id|tmp
op_ne
l_int|24
op_logical_and
id|tmp
op_ne
l_int|32
op_logical_and
id|tmp
op_ne
l_int|48
op_logical_and
id|tmp
op_ne
l_int|60
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eicon_isa_load: invalid memsize&bslash;n&quot;
)paren
suffix:semicolon
id|eicon_isa_release_shmem
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|eicon_isa_printpar
c_func
(paren
id|card
)paren
suffix:semicolon
multiline_comment|/* Download firmware */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s %dkB, loading firmware ...&bslash;n&quot;
comma
id|eicon_ctype_name
(braket
id|card-&gt;type
)braket
comma
id|tmp
op_star
l_int|16
)paren
suffix:semicolon
id|tmp
op_assign
id|cbuf.firmware_len
op_rshift
l_int|8
suffix:semicolon
id|p
op_assign
id|code
suffix:semicolon
r_while
c_loop
(paren
id|tmp
op_decrement
)paren
(brace
id|memcpy_toio
c_func
(paren
op_amp
id|boot-&gt;b
comma
id|p
comma
l_int|256
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|1
comma
op_amp
id|boot-&gt;ctrl
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
l_int|10
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
id|jiffies
)paren
(brace
r_if
c_cond
(paren
id|readb
c_func
(paren
op_amp
id|boot-&gt;ctrl
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|SLEEP
c_func
(paren
l_int|2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|readb
c_func
(paren
op_amp
id|boot-&gt;ctrl
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eicon_isa_load: download timeout at 0x%x&bslash;n&quot;
comma
id|p
op_minus
id|code
)paren
suffix:semicolon
id|eicon_isa_release
c_func
(paren
id|card
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|code
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|p
op_add_assign
l_int|256
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|code
)paren
suffix:semicolon
multiline_comment|/* Initialize firmware parameters */
id|memcpy_toio
c_func
(paren
op_amp
id|card-&gt;shmem-&gt;c
(braket
l_int|8
)braket
comma
op_amp
id|cbuf.tei
comma
l_int|14
)paren
suffix:semicolon
id|memcpy_toio
c_func
(paren
op_amp
id|card-&gt;shmem-&gt;c
(braket
l_int|32
)braket
comma
op_amp
id|cbuf.oad
comma
l_int|96
)paren
suffix:semicolon
id|memcpy_toio
c_func
(paren
op_amp
id|card-&gt;shmem-&gt;c
(braket
l_int|128
)braket
comma
op_amp
id|cbuf.oad
comma
l_int|96
)paren
suffix:semicolon
multiline_comment|/* Start firmware, wait for signature */
id|writeb
c_func
(paren
l_int|2
comma
op_amp
id|boot-&gt;ctrl
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
(paren
l_int|5
op_star
id|HZ
)paren
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
id|jiffies
)paren
(brace
r_if
c_cond
(paren
id|readw
c_func
(paren
op_amp
id|boot-&gt;signature
)paren
op_eq
l_int|0x4447
)paren
r_break
suffix:semicolon
id|SLEEP
c_func
(paren
l_int|2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|readw
c_func
(paren
op_amp
id|boot-&gt;signature
)paren
op_ne
l_int|0x4447
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eicon_isa_load: firmware selftest failed %04x&bslash;n&quot;
comma
id|readw
c_func
(paren
op_amp
id|boot-&gt;signature
)paren
)paren
suffix:semicolon
id|eicon_isa_release
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|card-&gt;channels
op_assign
id|readb
c_func
(paren
op_amp
id|card-&gt;shmem-&gt;c
(braket
l_int|0x3f6
)braket
)paren
suffix:semicolon
multiline_comment|/* clear irq-requests, reset irq-count */
id|readb
c_func
(paren
id|card-&gt;intack
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
id|card-&gt;intack
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;master
)paren
(brace
id|card-&gt;irqprobe
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Trigger an interrupt and check if it is delivered */
id|tmp
op_assign
id|readb
c_func
(paren
op_amp
id|card-&gt;shmem-&gt;com.ReadyInt
)paren
suffix:semicolon
id|tmp
op_increment
suffix:semicolon
id|writeb
c_func
(paren
id|tmp
comma
op_amp
id|card-&gt;shmem-&gt;com.ReadyInt
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
l_int|20
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
id|jiffies
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;irqprobe
OG
l_int|1
)paren
r_break
suffix:semicolon
id|SLEEP
c_func
(paren
l_int|2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;irqprobe
op_eq
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eicon_isa_load: IRQ # %d test failed&bslash;n&quot;
comma
id|card-&gt;irq
)paren
suffix:semicolon
id|eicon_isa_release
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
macro_line|#ifdef EICON_MCA_DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;eicon_isa_load: IRQ # %d test succeeded.&bslash;n&quot;
comma
id|card-&gt;irq
)paren
suffix:semicolon
macro_line|#endif
id|writeb
c_func
(paren
id|card-&gt;irq
comma
op_amp
id|card-&gt;shmem-&gt;com.Int
)paren
suffix:semicolon
multiline_comment|/* initializing some variables */
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|ReadyInt
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|ref_in
op_assign
l_int|1
suffix:semicolon
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|ref_out
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|256
suffix:semicolon
id|j
op_increment
)paren
(brace
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|IdTable
(braket
id|j
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
(paren
id|card-&gt;channels
op_plus
l_int|1
)paren
suffix:semicolon
id|j
op_increment
)paren
(brace
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|bch
(braket
id|j
)braket
dot
id|e.busy
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|bch
(braket
id|j
)braket
dot
id|e.D3Id
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|bch
(braket
id|j
)braket
dot
id|e.B2Id
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|bch
(braket
id|j
)braket
dot
id|e.ref
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|bch
(braket
id|j
)braket
dot
id|e.Req
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|bch
(braket
id|j
)braket
dot
id|e.complete
op_assign
l_int|1
suffix:semicolon
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|bch
(braket
id|j
)braket
dot
id|fsm_state
op_assign
id|EICON_STATE_NULL
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Eicon: Supported channels: %d&bslash;n&quot;
comma
id|card-&gt;channels
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s successfully started&bslash;n&quot;
comma
id|eicon_ctype_name
(braket
id|card-&gt;type
)braket
)paren
suffix:semicolon
multiline_comment|/* Enable normal IRQ processing */
id|card-&gt;irqprobe
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ISDN_DRV_EICON_ISA */
eof
