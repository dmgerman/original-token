multiline_comment|/*&n; *&n; * Copyright (C) Eicon Technology Corporation, 2000.&n; *&n; * This source file is supplied for the exclusive use with Eicon&n; * Technology Corporation&squot;s range of DIVA Server Adapters.&n; *&n; * Eicon File Revision :    1.8  &n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY OF ANY KIND WHATSOEVER INCLUDING ANY &n; * implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  &n; * See the GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; */
multiline_comment|/*&n; * Core driver for Diva Server cards&n; * Implements the IDI interface&n; */
macro_line|#include &quot;idi.h&quot;
macro_line|#include &quot;adapter.h&quot;
macro_line|#include &quot;pc.h&quot;
macro_line|#include &quot;pr_pc.h&quot;
macro_line|#include &quot;sys.h&quot;
macro_line|#include &quot;uxio.h&quot;
multiline_comment|/* IDI request functions */
r_static
r_void
id|request
c_func
(paren
id|card_t
op_star
id|card
comma
id|ENTITY
op_star
id|e
)paren
suffix:semicolon
DECL|function|req_0
r_static
r_void
id|req_0
c_func
(paren
id|ENTITY
op_star
id|e
)paren
(brace
id|request
c_func
(paren
op_amp
id|DivasCards
(braket
l_int|0
)braket
comma
id|e
)paren
suffix:semicolon
)brace
DECL|function|req_1
r_static
r_void
id|req_1
c_func
(paren
id|ENTITY
op_star
id|e
)paren
(brace
id|request
c_func
(paren
op_amp
id|DivasCards
(braket
l_int|1
)braket
comma
id|e
)paren
suffix:semicolon
)brace
DECL|function|req_2
r_static
r_void
id|req_2
c_func
(paren
id|ENTITY
op_star
id|e
)paren
(brace
id|request
c_func
(paren
op_amp
id|DivasCards
(braket
l_int|2
)braket
comma
id|e
)paren
suffix:semicolon
)brace
DECL|function|req_3
r_static
r_void
id|req_3
c_func
(paren
id|ENTITY
op_star
id|e
)paren
(brace
id|request
c_func
(paren
op_amp
id|DivasCards
(braket
l_int|3
)braket
comma
id|e
)paren
suffix:semicolon
)brace
DECL|function|req_4
r_static
r_void
id|req_4
c_func
(paren
id|ENTITY
op_star
id|e
)paren
(brace
id|request
c_func
(paren
op_amp
id|DivasCards
(braket
l_int|4
)braket
comma
id|e
)paren
suffix:semicolon
)brace
DECL|function|req_5
r_static
r_void
id|req_5
c_func
(paren
id|ENTITY
op_star
id|e
)paren
(brace
id|request
c_func
(paren
op_amp
id|DivasCards
(braket
l_int|5
)braket
comma
id|e
)paren
suffix:semicolon
)brace
DECL|function|req_6
r_static
r_void
id|req_6
c_func
(paren
id|ENTITY
op_star
id|e
)paren
(brace
id|request
c_func
(paren
op_amp
id|DivasCards
(braket
l_int|6
)braket
comma
id|e
)paren
suffix:semicolon
)brace
DECL|function|req_7
r_static
r_void
id|req_7
c_func
(paren
id|ENTITY
op_star
id|e
)paren
(brace
id|request
c_func
(paren
op_amp
id|DivasCards
(braket
l_int|7
)braket
comma
id|e
)paren
suffix:semicolon
)brace
DECL|function|req_8
r_static
r_void
id|req_8
c_func
(paren
id|ENTITY
op_star
id|e
)paren
(brace
id|request
c_func
(paren
op_amp
id|DivasCards
(braket
l_int|8
)braket
comma
id|e
)paren
suffix:semicolon
)brace
DECL|function|req_9
r_static
r_void
id|req_9
c_func
(paren
id|ENTITY
op_star
id|e
)paren
(brace
id|request
c_func
(paren
op_amp
id|DivasCards
(braket
l_int|9
)braket
comma
id|e
)paren
suffix:semicolon
)brace
DECL|function|req_10
r_static
r_void
id|req_10
c_func
(paren
id|ENTITY
op_star
id|e
)paren
(brace
id|request
c_func
(paren
op_amp
id|DivasCards
(braket
l_int|10
)braket
comma
id|e
)paren
suffix:semicolon
)brace
DECL|function|req_11
r_static
r_void
id|req_11
c_func
(paren
id|ENTITY
op_star
id|e
)paren
(brace
id|request
c_func
(paren
op_amp
id|DivasCards
(braket
l_int|11
)braket
comma
id|e
)paren
suffix:semicolon
)brace
DECL|function|req_12
r_static
r_void
id|req_12
c_func
(paren
id|ENTITY
op_star
id|e
)paren
(brace
id|request
c_func
(paren
op_amp
id|DivasCards
(braket
l_int|12
)braket
comma
id|e
)paren
suffix:semicolon
)brace
DECL|function|req_13
r_static
r_void
id|req_13
c_func
(paren
id|ENTITY
op_star
id|e
)paren
(brace
id|request
c_func
(paren
op_amp
id|DivasCards
(braket
l_int|13
)braket
comma
id|e
)paren
suffix:semicolon
)brace
DECL|function|req_14
r_static
r_void
id|req_14
c_func
(paren
id|ENTITY
op_star
id|e
)paren
(brace
id|request
c_func
(paren
op_amp
id|DivasCards
(braket
l_int|14
)braket
comma
id|e
)paren
suffix:semicolon
)brace
DECL|function|req_15
r_static
r_void
id|req_15
c_func
(paren
id|ENTITY
op_star
id|e
)paren
(brace
id|request
c_func
(paren
op_amp
id|DivasCards
(braket
l_int|15
)braket
comma
id|e
)paren
suffix:semicolon
)brace
DECL|variable|DivasIdiRequest
id|IDI_CALL
id|DivasIdiRequest
(braket
l_int|16
)braket
op_assign
(brace
op_amp
id|req_0
comma
op_amp
id|req_1
comma
op_amp
id|req_2
comma
op_amp
id|req_3
comma
op_amp
id|req_4
comma
op_amp
id|req_5
comma
op_amp
id|req_6
comma
op_amp
id|req_7
comma
op_amp
id|req_8
comma
op_amp
id|req_9
comma
op_amp
id|req_10
comma
op_amp
id|req_11
comma
op_amp
id|req_12
comma
op_amp
id|req_13
comma
op_amp
id|req_14
comma
op_amp
id|req_15
)brace
suffix:semicolon
DECL|macro|PR_RAM
mdefine_line|#define PR_RAM  ((struct pr_ram *)0)
DECL|macro|RAM
mdefine_line|#define RAM ((struct dual *)0)
multiline_comment|/*------------------------------------------------------------------*/
multiline_comment|/* local function prototypes                                        */
multiline_comment|/*------------------------------------------------------------------*/
r_static
id|byte
id|isdn_rc
c_func
(paren
id|ADAPTER
op_star
comma
id|byte
comma
id|byte
comma
id|byte
comma
id|word
)paren
suffix:semicolon
r_static
id|byte
id|isdn_ind
c_func
(paren
id|ADAPTER
op_star
comma
id|byte
comma
id|byte
comma
id|byte
comma
id|PBUFFER
op_star
comma
id|byte
comma
id|word
)paren
suffix:semicolon
multiline_comment|/*&n; * IDI related functions&n; */
r_static
DECL|function|entity_ptr
id|ENTITY
op_star
id|entity_ptr
c_func
(paren
id|ADAPTER
op_star
id|a
comma
id|byte
id|e_no
)paren
(brace
id|card_t
op_star
id|card
suffix:semicolon
id|card
op_assign
id|a-&gt;io
suffix:semicolon
r_return
id|card-&gt;e_tbl
(braket
id|e_no
)braket
dot
id|e
suffix:semicolon
)brace
r_static
DECL|function|CALLBACK
r_void
id|CALLBACK
c_func
(paren
id|ADAPTER
op_star
id|a
comma
id|ENTITY
op_star
id|e
)paren
(brace
id|card_t
op_star
id|card
op_assign
id|a-&gt;io
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;log_types
op_amp
id|DIVAS_LOG_IDI
)paren
(brace
id|DivasLogIdi
c_func
(paren
id|card
comma
id|e
comma
id|FALSE
)paren
suffix:semicolon
)brace
(paren
op_star
id|e-&gt;callback
)paren
(paren
id|e
)paren
suffix:semicolon
)brace
r_static
DECL|function|PTR_P
r_void
op_star
id|PTR_P
c_func
(paren
id|ADAPTER
op_star
id|a
comma
id|ENTITY
op_star
id|e
comma
r_void
op_star
id|P
)paren
(brace
r_return
id|P
suffix:semicolon
)brace
r_static
DECL|function|PTR_R
r_void
op_star
id|PTR_R
c_func
(paren
id|ADAPTER
op_star
id|a
comma
id|ENTITY
op_star
id|e
)paren
(brace
r_return
(paren
r_void
op_star
)paren
id|e-&gt;R
suffix:semicolon
)brace
r_static
DECL|function|PTR_X
r_void
op_star
id|PTR_X
c_func
(paren
id|ADAPTER
op_star
id|a
comma
id|ENTITY
op_star
id|e
)paren
(brace
r_return
(paren
r_void
op_star
)paren
id|e-&gt;X
suffix:semicolon
)brace
r_static
DECL|function|free_entity
r_void
id|free_entity
c_func
(paren
id|ADAPTER
op_star
id|a
comma
id|byte
id|e_no
)paren
(brace
id|card_t
op_star
id|card
suffix:semicolon
r_int
id|ipl
suffix:semicolon
id|card
op_assign
id|a-&gt;io
suffix:semicolon
id|ipl
op_assign
id|UxCardLock
c_func
(paren
id|card-&gt;hw
)paren
suffix:semicolon
id|card-&gt;e_tbl
(braket
id|e_no
)braket
dot
id|e
op_assign
l_int|NULL
suffix:semicolon
id|card-&gt;e_count
op_decrement
suffix:semicolon
id|UxCardUnlock
c_func
(paren
id|card-&gt;hw
comma
id|ipl
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_static
DECL|function|assign_queue
r_void
id|assign_queue
c_func
(paren
id|ADAPTER
op_star
id|a
comma
id|byte
id|e_no
comma
id|word
id|ref
)paren
(brace
id|card_t
op_star
id|card
suffix:semicolon
r_int
id|ipl
suffix:semicolon
id|card
op_assign
id|a-&gt;io
suffix:semicolon
id|ipl
op_assign
id|UxCardLock
c_func
(paren
id|card-&gt;hw
)paren
suffix:semicolon
id|card-&gt;e_tbl
(braket
id|e_no
)braket
dot
id|assign_ref
op_assign
id|ref
suffix:semicolon
id|card-&gt;e_tbl
(braket
id|e_no
)braket
dot
id|next
op_assign
id|card-&gt;assign
suffix:semicolon
id|card-&gt;assign
op_assign
id|e_no
suffix:semicolon
id|UxCardUnlock
c_func
(paren
id|card-&gt;hw
comma
id|ipl
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_static
DECL|function|get_assign
id|byte
id|get_assign
c_func
(paren
id|ADAPTER
op_star
id|a
comma
id|word
id|ref
)paren
(brace
id|card_t
op_star
id|card
suffix:semicolon
id|byte
id|e_no
suffix:semicolon
r_int
id|ipl
suffix:semicolon
id|card
op_assign
id|a-&gt;io
suffix:semicolon
id|ipl
op_assign
id|UxCardLock
c_func
(paren
id|card-&gt;hw
)paren
suffix:semicolon
id|e_no
op_assign
(paren
id|byte
)paren
id|card-&gt;assign
suffix:semicolon
r_while
c_loop
(paren
id|e_no
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;e_tbl
(braket
id|e_no
)braket
dot
id|assign_ref
op_eq
id|ref
)paren
(brace
r_break
suffix:semicolon
)brace
id|e_no
op_assign
id|card-&gt;e_tbl
(braket
id|e_no
)braket
dot
id|next
suffix:semicolon
)brace
id|UxCardUnlock
c_func
(paren
id|card-&gt;hw
comma
id|ipl
)paren
suffix:semicolon
r_return
id|e_no
suffix:semicolon
)brace
r_static
DECL|function|req_queue
r_void
id|req_queue
c_func
(paren
id|ADAPTER
op_star
id|a
comma
id|byte
id|e_no
)paren
(brace
id|card_t
op_star
id|card
suffix:semicolon
r_int
id|ipl
suffix:semicolon
id|card
op_assign
id|a-&gt;io
suffix:semicolon
id|ipl
op_assign
id|UxCardLock
c_func
(paren
id|card-&gt;hw
)paren
suffix:semicolon
id|card-&gt;e_tbl
(braket
id|e_no
)braket
dot
id|next
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;e_head
)paren
(brace
id|card-&gt;e_tbl
(braket
id|card-&gt;e_tail
)braket
dot
id|next
op_assign
id|e_no
suffix:semicolon
id|card-&gt;e_tail
op_assign
id|e_no
suffix:semicolon
)brace
r_else
(brace
id|card-&gt;e_head
op_assign
id|e_no
suffix:semicolon
id|card-&gt;e_tail
op_assign
id|e_no
suffix:semicolon
)brace
id|UxCardUnlock
c_func
(paren
id|card-&gt;hw
comma
id|ipl
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_static
DECL|function|look_req
id|byte
id|look_req
c_func
(paren
id|ADAPTER
op_star
id|a
)paren
(brace
id|card_t
op_star
id|card
suffix:semicolon
id|card
op_assign
id|a-&gt;io
suffix:semicolon
r_return
id|card-&gt;e_head
suffix:semicolon
)brace
r_static
DECL|function|next_req
r_void
id|next_req
c_func
(paren
id|ADAPTER
op_star
id|a
)paren
(brace
id|card_t
op_star
id|card
suffix:semicolon
r_int
id|ipl
suffix:semicolon
id|card
op_assign
id|a-&gt;io
suffix:semicolon
id|ipl
op_assign
id|UxCardLock
c_func
(paren
id|card-&gt;hw
)paren
suffix:semicolon
id|card-&gt;e_head
op_assign
id|card-&gt;e_tbl
(braket
id|card-&gt;e_head
)braket
dot
id|next
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;e_head
)paren
(brace
id|card-&gt;e_tail
op_assign
l_int|0
suffix:semicolon
)brace
id|UxCardUnlock
c_func
(paren
id|card-&gt;hw
comma
id|ipl
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * IDI request function for active cards&n; */
r_static
DECL|function|request
r_void
id|request
c_func
(paren
id|card_t
op_star
id|card
comma
id|ENTITY
op_star
id|e
)paren
(brace
id|word
op_star
id|special_req
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|ipl
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;log_types
op_amp
id|DIVAS_LOG_IDI
)paren
(brace
id|DivasLogIdi
c_func
(paren
id|card
comma
id|e
comma
id|TRUE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|e-&gt;Req
)paren
(brace
id|special_req
op_assign
(paren
id|word
op_star
)paren
id|e
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|special_req
)paren
(brace
r_case
id|REQ_REMOVE
suffix:colon
r_return
suffix:semicolon
r_case
id|REQ_NAME
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DIM
c_func
(paren
id|card-&gt;cfg.name
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
(paren
(paren
r_struct
id|get_name_s
op_star
)paren
id|e
)paren
op_member_access_from_pointer
id|name
(braket
id|i
)braket
op_assign
id|card-&gt;cfg.name
(braket
id|i
)braket
suffix:semicolon
)brace
r_return
suffix:semicolon
r_case
id|REQ_SERIAL
suffix:colon
r_case
id|REQ_XLOG
suffix:colon
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;IDI: attempted REQ_SERIAL or REQ_XLOG&quot;
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
r_return
suffix:semicolon
)brace
)brace
id|ipl
op_assign
id|UxCardLock
c_func
(paren
id|card-&gt;hw
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|e-&gt;Id
op_amp
l_int|0x1f
)paren
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;IDI: ASSIGN req&quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|card-&gt;e_max
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;e_tbl
(braket
id|i
)braket
dot
id|e
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i
op_eq
id|card-&gt;e_max
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;IDI: request all ids in use (IDI req ignored)&quot;
)paren
)paren
suffix:semicolon
id|UxCardUnlock
c_func
(paren
id|card-&gt;hw
comma
id|ipl
)paren
suffix:semicolon
id|e-&gt;Rc
op_assign
id|OUT_OF_RESOURCES
suffix:semicolon
r_return
suffix:semicolon
)brace
id|card-&gt;e_tbl
(braket
id|i
)braket
dot
id|e
op_assign
id|e
suffix:semicolon
id|card-&gt;e_count
op_increment
suffix:semicolon
id|e-&gt;No
op_assign
(paren
id|byte
)paren
id|i
suffix:semicolon
id|e-&gt;More
op_assign
l_int|0
suffix:semicolon
id|e-&gt;RCurrent
op_assign
l_int|0xff
suffix:semicolon
)brace
r_else
(brace
id|i
op_assign
id|e-&gt;No
suffix:semicolon
)brace
r_if
c_cond
(paren
id|e-&gt;More
op_amp
id|XBUSY
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;IDI: request - entity is busy&quot;
)paren
)paren
suffix:semicolon
id|UxCardUnlock
c_func
(paren
id|card-&gt;hw
comma
id|ipl
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|e-&gt;More
op_or_assign
id|XBUSY
suffix:semicolon
id|e-&gt;More
op_and_assign
op_complement
id|XMOREF
suffix:semicolon
id|e-&gt;XCurrent
op_assign
l_int|0
suffix:semicolon
id|e-&gt;XOffset
op_assign
l_int|0
suffix:semicolon
id|card-&gt;e_tbl
(braket
id|i
)braket
dot
id|next
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;e_head
)paren
(brace
id|card-&gt;e_tbl
(braket
id|card-&gt;e_tail
)braket
dot
id|next
op_assign
id|i
suffix:semicolon
id|card-&gt;e_tail
op_assign
id|i
suffix:semicolon
)brace
r_else
(brace
id|card-&gt;e_head
op_assign
id|i
suffix:semicolon
id|card-&gt;e_tail
op_assign
id|i
suffix:semicolon
)brace
id|UxCardUnlock
c_func
(paren
id|card-&gt;hw
comma
id|ipl
)paren
suffix:semicolon
id|DivasScheduleRequestDpc
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|pr_ready
r_static
id|byte
id|pr_ready
c_func
(paren
id|ADAPTER
op_star
id|a
)paren
(brace
id|byte
id|ReadyCount
suffix:semicolon
id|ReadyCount
op_assign
(paren
id|byte
)paren
(paren
id|a
op_member_access_from_pointer
id|ram_in
c_func
(paren
id|a
comma
op_amp
id|PR_RAM-&gt;ReqOutput
)paren
op_minus
id|a
op_member_access_from_pointer
id|ram_in
c_func
(paren
id|a
comma
op_amp
id|PR_RAM-&gt;ReqInput
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ReadyCount
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|a-&gt;ReadyInt
)paren
(brace
id|a
op_member_access_from_pointer
id|ram_inc
c_func
(paren
id|a
comma
op_amp
id|PR_RAM-&gt;ReadyInt
)paren
suffix:semicolon
id|a-&gt;ReadyInt
op_increment
suffix:semicolon
)brace
)brace
r_return
id|ReadyCount
suffix:semicolon
)brace
multiline_comment|/*------------------------------------------------------------------*/
multiline_comment|/* output function                                                  */
multiline_comment|/*------------------------------------------------------------------*/
DECL|function|DivasOut
r_void
id|DivasOut
c_func
(paren
id|ADAPTER
op_star
id|a
)paren
(brace
id|byte
id|e_no
suffix:semicolon
id|ENTITY
op_star
id|this
op_assign
l_int|NULL
suffix:semicolon
id|BUFFERS
op_star
id|X
suffix:semicolon
id|word
id|length
suffix:semicolon
id|word
id|i
suffix:semicolon
id|word
id|clength
suffix:semicolon
id|REQ
op_star
id|ReqOut
suffix:semicolon
id|byte
id|more
suffix:semicolon
id|byte
id|ReadyCount
suffix:semicolon
id|byte
id|ReqCount
suffix:semicolon
id|byte
id|Id
suffix:semicolon
multiline_comment|/* while a request is pending ...                           */
id|e_no
op_assign
id|look_req
c_func
(paren
id|a
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|e_no
)paren
(brace
r_return
suffix:semicolon
)brace
id|ReadyCount
op_assign
id|pr_ready
c_func
(paren
id|a
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ReadyCount
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;IDI: card not ready for next request&quot;
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ReqCount
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|e_no
op_logical_and
id|ReadyCount
)paren
(brace
id|next_req
c_func
(paren
id|a
)paren
suffix:semicolon
id|this
op_assign
id|entity_ptr
c_func
(paren
id|a
comma
id|e_no
)paren
suffix:semicolon
macro_line|#ifdef&t;USE_EXTENDED_DEBUGS
r_if
c_cond
(paren
op_logical_neg
id|this
)paren
(brace
id|ISDN_ADAPTER
op_star
id|io
op_assign
(paren
id|ISDN_ADAPTER
op_star
)paren
id|a-&gt;io
suffix:semicolon
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;!A%d ==&gt; NULL entity ptr - try to ignore&quot;
comma
(paren
r_int
)paren
id|io-&gt;ANum
)paren
)paren
id|e_no
op_assign
id|look_req
c_func
(paren
id|a
)paren
suffix:semicolon
id|ReadyCount
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
(brace
id|ISDN_ADAPTER
op_star
id|io
op_assign
(paren
id|ISDN_ADAPTER
op_star
)paren
id|a-&gt;io
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;IDI: &gt;A%d Id=0x%x Req=0x%x&quot;
comma
id|io-&gt;ANum
comma
id|this-&gt;Id
comma
id|this-&gt;Req
)paren
)paren
)brace
macro_line|#else
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;IDI: &gt;REQ=%x,Id=%x,Ch=%x&quot;
comma
id|this-&gt;Req
comma
id|this-&gt;Id
comma
id|this-&gt;ReqCh
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* get address of next available request buffer             */
id|ReqOut
op_assign
(paren
id|REQ
op_star
)paren
op_amp
id|PR_RAM-&gt;B
(braket
id|a
op_member_access_from_pointer
id|ram_inw
c_func
(paren
id|a
comma
op_amp
id|PR_RAM-&gt;NextReq
)paren
)braket
suffix:semicolon
multiline_comment|/* now copy the data from the current data buffer into the  */
multiline_comment|/* adapters request buffer                                  */
id|length
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|this-&gt;XCurrent
suffix:semicolon
id|X
op_assign
id|PTR_X
c_func
(paren
id|a
comma
id|this
)paren
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
id|this-&gt;XNum
op_logical_and
id|length
OL
l_int|270
)paren
(brace
id|clength
op_assign
id|MIN
c_func
(paren
(paren
id|word
)paren
(paren
l_int|270
op_minus
id|length
)paren
comma
id|X
(braket
id|i
)braket
dot
id|PLength
op_minus
id|this-&gt;XOffset
)paren
suffix:semicolon
id|a
op_member_access_from_pointer
id|ram_out_buffer
c_func
(paren
id|a
comma
op_amp
id|ReqOut-&gt;XBuffer.P
(braket
id|length
)braket
comma
id|PTR_P
c_func
(paren
id|a
comma
id|this
comma
op_amp
id|X
(braket
id|i
)braket
dot
id|P
(braket
id|this-&gt;XOffset
)braket
)paren
comma
id|clength
)paren
suffix:semicolon
id|length
op_add_assign
id|clength
suffix:semicolon
id|this-&gt;XOffset
op_add_assign
id|clength
suffix:semicolon
r_if
c_cond
(paren
id|this-&gt;XOffset
op_eq
id|X
(braket
id|i
)braket
dot
id|PLength
)paren
(brace
id|this-&gt;XCurrent
op_assign
(paren
id|byte
)paren
op_increment
id|i
suffix:semicolon
id|this-&gt;XOffset
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|a
op_member_access_from_pointer
id|ram_outw
c_func
(paren
id|a
comma
op_amp
id|ReqOut-&gt;XBuffer.length
comma
id|length
)paren
suffix:semicolon
id|a
op_member_access_from_pointer
id|ram_out
c_func
(paren
id|a
comma
op_amp
id|ReqOut-&gt;ReqId
comma
id|this-&gt;Id
)paren
suffix:semicolon
id|a
op_member_access_from_pointer
id|ram_out
c_func
(paren
id|a
comma
op_amp
id|ReqOut-&gt;ReqCh
comma
id|this-&gt;ReqCh
)paren
suffix:semicolon
multiline_comment|/* if its a specific request (no ASSIGN) ...                */
r_if
c_cond
(paren
id|this-&gt;Id
op_amp
l_int|0x1f
)paren
(brace
multiline_comment|/* if buffers are left in the list of data buffers do       */
multiline_comment|/* do chaining (LL_MDATA, N_MDATA)                          */
id|this-&gt;More
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
id|this-&gt;XNum
op_logical_and
id|this-&gt;MInd
)paren
(brace
id|a
op_member_access_from_pointer
id|ram_out
c_func
(paren
id|a
comma
op_amp
id|ReqOut-&gt;Req
comma
id|this-&gt;MInd
)paren
suffix:semicolon
id|more
op_assign
id|TRUE
suffix:semicolon
)brace
r_else
(brace
id|this-&gt;More
op_or_assign
id|XMOREF
suffix:semicolon
id|a
op_member_access_from_pointer
id|ram_out
c_func
(paren
id|a
comma
op_amp
id|ReqOut-&gt;Req
comma
id|this-&gt;Req
)paren
suffix:semicolon
id|more
op_assign
id|FALSE
suffix:semicolon
)brace
multiline_comment|/* if we did chaining, this entity is put back into the     */
multiline_comment|/* request queue                                            */
r_if
c_cond
(paren
id|more
)paren
(brace
id|req_queue
c_func
(paren
id|a
comma
id|this-&gt;No
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* else it&squot;s a ASSIGN                                       */
r_else
(brace
multiline_comment|/* save the request code used for buffer chaining           */
id|this-&gt;MInd
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|this-&gt;Id
op_eq
id|BLLC_ID
)paren
id|this-&gt;MInd
op_assign
id|LL_MDATA
suffix:semicolon
r_if
c_cond
(paren
id|this-&gt;Id
op_eq
id|NL_ID
op_logical_or
id|this-&gt;Id
op_eq
id|TASK_ID
op_logical_or
id|this-&gt;Id
op_eq
id|MAN_ID
)paren
id|this-&gt;MInd
op_assign
id|N_MDATA
suffix:semicolon
multiline_comment|/* send the ASSIGN                                          */
id|this-&gt;More
op_or_assign
id|XMOREF
suffix:semicolon
id|a
op_member_access_from_pointer
id|ram_out
c_func
(paren
id|a
comma
op_amp
id|ReqOut-&gt;Req
comma
id|this-&gt;Req
)paren
suffix:semicolon
multiline_comment|/* save the reference of the ASSIGN                         */
id|assign_queue
c_func
(paren
id|a
comma
id|this-&gt;No
comma
id|a
op_member_access_from_pointer
id|ram_inw
c_func
(paren
id|a
comma
op_amp
id|ReqOut-&gt;Reference
)paren
)paren
suffix:semicolon
)brace
id|a
op_member_access_from_pointer
id|ram_outw
c_func
(paren
id|a
comma
op_amp
id|PR_RAM-&gt;NextReq
comma
id|a
op_member_access_from_pointer
id|ram_inw
c_func
(paren
id|a
comma
op_amp
id|ReqOut-&gt;next
)paren
)paren
suffix:semicolon
id|ReadyCount
op_decrement
suffix:semicolon
id|ReqCount
op_increment
suffix:semicolon
id|e_no
op_assign
id|look_req
c_func
(paren
id|a
)paren
suffix:semicolon
)brace
multiline_comment|/* send the filled request buffers to the ISDN adapter      */
id|a
op_member_access_from_pointer
id|ram_out
c_func
(paren
id|a
comma
op_amp
id|PR_RAM-&gt;ReqInput
comma
(paren
id|byte
)paren
(paren
id|a
op_member_access_from_pointer
id|ram_in
c_func
(paren
id|a
comma
op_amp
id|PR_RAM-&gt;ReqInput
)paren
op_plus
id|ReqCount
)paren
)paren
suffix:semicolon
multiline_comment|/* if it is a &squot;unreturncoded&squot; UREMOVE request, remove the  */
multiline_comment|/* Id from our table after sending the request             */
r_if
c_cond
(paren
id|this-&gt;Req
op_eq
id|UREMOVE
op_logical_and
id|this-&gt;Id
)paren
(brace
id|Id
op_assign
id|this-&gt;Id
suffix:semicolon
id|e_no
op_assign
id|a-&gt;IdTable
(braket
id|Id
)braket
suffix:semicolon
id|free_entity
c_func
(paren
id|a
comma
id|e_no
)paren
suffix:semicolon
id|a-&gt;IdTable
(braket
id|Id
)braket
op_assign
l_int|0
suffix:semicolon
id|this-&gt;Id
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/*------------------------------------------------------------------*/
multiline_comment|/* isdn interrupt handler                                           */
multiline_comment|/*------------------------------------------------------------------*/
DECL|function|DivasDpc
id|byte
id|DivasDpc
c_func
(paren
id|ADAPTER
op_star
id|a
)paren
(brace
id|byte
id|Count
suffix:semicolon
id|RC
op_star
id|RcIn
suffix:semicolon
id|IND
op_star
id|IndIn
suffix:semicolon
id|byte
id|c
suffix:semicolon
id|byte
id|RNRId
suffix:semicolon
id|byte
id|Rc
suffix:semicolon
id|byte
id|Ind
suffix:semicolon
multiline_comment|/* if return codes are available ...                        */
r_if
c_cond
(paren
(paren
id|Count
op_assign
id|a
op_member_access_from_pointer
id|ram_in
c_func
(paren
id|a
comma
op_amp
id|PR_RAM-&gt;RcOutput
)paren
)paren
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;IDI: #Rc=%x&quot;
comma
id|Count
)paren
)paren
suffix:semicolon
multiline_comment|/* get the buffer address of the first return code          */
id|RcIn
op_assign
(paren
id|RC
op_star
)paren
op_amp
id|PR_RAM-&gt;B
(braket
id|a
op_member_access_from_pointer
id|ram_inw
c_func
(paren
id|a
comma
op_amp
id|PR_RAM-&gt;NextRc
)paren
)braket
suffix:semicolon
multiline_comment|/* for all return codes do ...                              */
r_while
c_loop
(paren
id|Count
op_decrement
)paren
(brace
r_if
c_cond
(paren
(paren
id|Rc
op_assign
id|a
op_member_access_from_pointer
id|ram_in
c_func
(paren
id|a
comma
op_amp
id|RcIn-&gt;Rc
)paren
)paren
)paren
(brace
multiline_comment|/* call return code handler, if it is not our return code   */
multiline_comment|/* the handler returns 2                                    */
multiline_comment|/* for all return codes we process, we clear the Rc field   */
id|isdn_rc
c_func
(paren
id|a
comma
id|Rc
comma
id|a
op_member_access_from_pointer
id|ram_in
c_func
(paren
id|a
comma
op_amp
id|RcIn-&gt;RcId
)paren
comma
id|a
op_member_access_from_pointer
id|ram_in
c_func
(paren
id|a
comma
op_amp
id|RcIn-&gt;RcCh
)paren
comma
id|a
op_member_access_from_pointer
id|ram_inw
c_func
(paren
id|a
comma
op_amp
id|RcIn-&gt;Reference
)paren
)paren
suffix:semicolon
id|a
op_member_access_from_pointer
id|ram_out
c_func
(paren
id|a
comma
op_amp
id|RcIn-&gt;Rc
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* get buffer address of next return code                   */
id|RcIn
op_assign
(paren
id|RC
op_star
)paren
op_amp
id|PR_RAM-&gt;B
(braket
id|a
op_member_access_from_pointer
id|ram_inw
c_func
(paren
id|a
comma
op_amp
id|RcIn-&gt;next
)paren
)braket
suffix:semicolon
)brace
multiline_comment|/* clear all return codes (no chaining!)                    */
id|a
op_member_access_from_pointer
id|ram_out
c_func
(paren
id|a
comma
op_amp
id|PR_RAM-&gt;RcOutput
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* call output function                                     */
id|DivasOut
c_func
(paren
id|a
)paren
suffix:semicolon
)brace
multiline_comment|/* clear RNR flag                                           */
id|RNRId
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* if indications are available ...                         */
r_if
c_cond
(paren
(paren
id|Count
op_assign
id|a
op_member_access_from_pointer
id|ram_in
c_func
(paren
id|a
comma
op_amp
id|PR_RAM-&gt;IndOutput
)paren
)paren
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;IDI: #Ind=%x&quot;
comma
id|Count
)paren
)paren
suffix:semicolon
multiline_comment|/* get the buffer address of the first indication           */
id|IndIn
op_assign
(paren
id|IND
op_star
)paren
op_amp
id|PR_RAM-&gt;B
(braket
id|a
op_member_access_from_pointer
id|ram_inw
c_func
(paren
id|a
comma
op_amp
id|PR_RAM-&gt;NextInd
)paren
)braket
suffix:semicolon
multiline_comment|/* for all indications do ...                               */
r_while
c_loop
(paren
id|Count
op_decrement
)paren
(brace
multiline_comment|/* if the application marks an indication as RNR, all       */
multiline_comment|/* indications from the same Id delivered in this interrupt */
multiline_comment|/* are marked RNR                                           */
r_if
c_cond
(paren
id|RNRId
op_logical_and
id|RNRId
op_eq
id|a
op_member_access_from_pointer
id|ram_in
c_func
(paren
id|a
comma
op_amp
id|IndIn-&gt;IndId
)paren
)paren
(brace
id|a
op_member_access_from_pointer
id|ram_out
c_func
(paren
id|a
comma
op_amp
id|IndIn-&gt;Ind
comma
l_int|0
)paren
suffix:semicolon
id|a
op_member_access_from_pointer
id|ram_out
c_func
(paren
id|a
comma
op_amp
id|IndIn-&gt;RNR
comma
id|TRUE
)paren
suffix:semicolon
)brace
r_else
(brace
id|Ind
op_assign
id|a
op_member_access_from_pointer
id|ram_in
c_func
(paren
id|a
comma
op_amp
id|IndIn-&gt;Ind
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Ind
)paren
(brace
id|RNRId
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* call indication handler, a return value of 2 means chain */
multiline_comment|/* a return value of 1 means RNR                            */
multiline_comment|/* for all indications we process, we clear the Ind field   */
id|c
op_assign
id|isdn_ind
c_func
(paren
id|a
comma
id|Ind
comma
id|a
op_member_access_from_pointer
id|ram_in
c_func
(paren
id|a
comma
op_amp
id|IndIn-&gt;IndId
)paren
comma
id|a
op_member_access_from_pointer
id|ram_in
c_func
(paren
id|a
comma
op_amp
id|IndIn-&gt;IndCh
)paren
comma
op_amp
id|IndIn-&gt;RBuffer
comma
id|a
op_member_access_from_pointer
id|ram_in
c_func
(paren
id|a
comma
op_amp
id|IndIn-&gt;MInd
)paren
comma
id|a
op_member_access_from_pointer
id|ram_inw
c_func
(paren
id|a
comma
op_amp
id|IndIn-&gt;MLength
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
op_eq
l_int|1
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;IDI: RNR&quot;
)paren
)paren
suffix:semicolon
id|a
op_member_access_from_pointer
id|ram_out
c_func
(paren
id|a
comma
op_amp
id|IndIn-&gt;Ind
comma
l_int|0
)paren
suffix:semicolon
id|RNRId
op_assign
id|a
op_member_access_from_pointer
id|ram_in
c_func
(paren
id|a
comma
op_amp
id|IndIn-&gt;IndId
)paren
suffix:semicolon
id|a
op_member_access_from_pointer
id|ram_out
c_func
(paren
id|a
comma
op_amp
id|IndIn-&gt;RNR
comma
id|TRUE
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* get buffer address of next indication                    */
id|IndIn
op_assign
(paren
id|IND
op_star
)paren
op_amp
id|PR_RAM-&gt;B
(braket
id|a
op_member_access_from_pointer
id|ram_inw
c_func
(paren
id|a
comma
op_amp
id|IndIn-&gt;next
)paren
)braket
suffix:semicolon
)brace
id|a
op_member_access_from_pointer
id|ram_out
c_func
(paren
id|a
comma
op_amp
id|PR_RAM-&gt;IndOutput
comma
l_int|0
)paren
suffix:semicolon
)brace
r_return
id|FALSE
suffix:semicolon
)brace
DECL|function|DivasTestInt
id|byte
id|DivasTestInt
c_func
(paren
id|ADAPTER
op_star
id|a
)paren
(brace
r_return
id|a
op_member_access_from_pointer
id|ram_in
c_func
(paren
id|a
comma
(paren
r_void
op_star
)paren
l_int|0x3fe
)paren
suffix:semicolon
)brace
DECL|function|DivasClearInt
r_void
id|DivasClearInt
c_func
(paren
id|ADAPTER
op_star
id|a
)paren
(brace
id|a
op_member_access_from_pointer
id|ram_out
c_func
(paren
id|a
comma
(paren
r_void
op_star
)paren
l_int|0x3fe
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*------------------------------------------------------------------*/
multiline_comment|/* return code handler                                              */
multiline_comment|/*------------------------------------------------------------------*/
r_static
DECL|function|isdn_rc
id|byte
id|isdn_rc
c_func
(paren
id|ADAPTER
op_star
id|a
comma
id|byte
id|Rc
comma
id|byte
id|Id
comma
id|byte
id|Ch
comma
id|word
id|Ref
)paren
(brace
id|ENTITY
op_star
id|this
suffix:semicolon
id|byte
id|e_no
suffix:semicolon
macro_line|#ifdef&t;USE_EXTENDED_DEBUGS
(brace
id|ISDN_ADAPTER
op_star
id|io
op_assign
(paren
id|ISDN_ADAPTER
op_star
)paren
id|a-&gt;io
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;IDI: &lt;A%d Id=0x%x Rc=0x%x&quot;
comma
id|io-&gt;ANum
comma
id|Id
comma
id|Rc
)paren
)paren
)brace
macro_line|#else
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;IDI: &lt;RC(Rc=%x,Id=%x,Ch=%x)&quot;
comma
id|Rc
comma
id|Id
comma
id|Ch
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* check for ready interrupt                                */
r_if
c_cond
(paren
id|Rc
op_eq
id|READY_INT
)paren
(brace
r_if
c_cond
(paren
id|a-&gt;ReadyInt
)paren
(brace
id|a-&gt;ReadyInt
op_decrement
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|2
suffix:semicolon
)brace
multiline_comment|/* if we know this Id ...                                   */
id|e_no
op_assign
id|a-&gt;IdTable
(braket
id|Id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|e_no
)paren
(brace
id|this
op_assign
id|entity_ptr
c_func
(paren
id|a
comma
id|e_no
)paren
suffix:semicolon
id|this-&gt;RcCh
op_assign
id|Ch
suffix:semicolon
multiline_comment|/* if it is a return code to a REMOVE request, remove the   */
multiline_comment|/* Id from our table                                        */
r_if
c_cond
(paren
id|this-&gt;Req
op_eq
id|REMOVE
op_logical_and
id|Rc
op_eq
id|OK
)paren
(brace
id|free_entity
c_func
(paren
id|a
comma
id|e_no
)paren
suffix:semicolon
id|a-&gt;IdTable
(braket
id|Id
)braket
op_assign
l_int|0
suffix:semicolon
id|this-&gt;Id
op_assign
l_int|0
suffix:semicolon
multiline_comment|/**************************************************************/
r_if
c_cond
(paren
(paren
id|this-&gt;More
op_amp
id|XMOREC
)paren
OG
l_int|1
)paren
(brace
id|this-&gt;More
op_and_assign
op_complement
id|XMOREC
suffix:semicolon
id|this-&gt;More
op_or_assign
l_int|1
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;isdn_rc, Id=%x, correct More on REMOVE&quot;
comma
id|Id
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|Rc
op_eq
id|OK_FC
)paren
(brace
id|this-&gt;Rc
op_assign
id|Rc
suffix:semicolon
id|this-&gt;More
op_assign
(paren
id|this-&gt;More
op_amp
(paren
op_complement
id|XBUSY
op_or
id|XMOREC
)paren
)paren
op_or
l_int|1
suffix:semicolon
id|this-&gt;complete
op_assign
l_int|0xFF
suffix:semicolon
id|CALLBACK
c_func
(paren
id|a
comma
id|this
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|this-&gt;More
op_amp
id|XMOREC
)paren
(brace
id|this-&gt;More
op_decrement
suffix:semicolon
)brace
multiline_comment|/* call the application callback function                   */
r_if
c_cond
(paren
id|this-&gt;More
op_amp
id|XMOREF
op_logical_and
op_logical_neg
(paren
id|this-&gt;More
op_amp
id|XMOREC
)paren
)paren
(brace
id|this-&gt;Rc
op_assign
id|Rc
suffix:semicolon
id|this-&gt;More
op_and_assign
op_complement
id|XBUSY
suffix:semicolon
id|this-&gt;complete
op_assign
l_int|0xff
suffix:semicolon
id|CALLBACK
c_func
(paren
id|a
comma
id|this
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* if it&squot;s an ASSIGN return code check if it&squot;s a return     */
multiline_comment|/* code to an ASSIGN request from us                        */
r_if
c_cond
(paren
(paren
id|Rc
op_amp
l_int|0xf0
)paren
op_eq
id|ASSIGN_RC
)paren
(brace
id|e_no
op_assign
id|get_assign
c_func
(paren
id|a
comma
id|Ref
)paren
suffix:semicolon
r_if
c_cond
(paren
id|e_no
)paren
(brace
id|this
op_assign
id|entity_ptr
c_func
(paren
id|a
comma
id|e_no
)paren
suffix:semicolon
id|this-&gt;Id
op_assign
id|Id
suffix:semicolon
multiline_comment|/* call the application callback function                   */
id|this-&gt;Rc
op_assign
id|Rc
suffix:semicolon
id|this-&gt;More
op_and_assign
op_complement
id|XBUSY
suffix:semicolon
id|this-&gt;complete
op_assign
l_int|0xff
suffix:semicolon
id|CALLBACK
c_func
(paren
id|a
comma
id|this
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Rc
op_eq
id|ASSIGN_OK
)paren
(brace
id|a-&gt;IdTable
(braket
id|Id
)braket
op_assign
id|e_no
suffix:semicolon
)brace
r_else
(brace
id|free_entity
c_func
(paren
id|a
comma
id|e_no
)paren
suffix:semicolon
id|a-&gt;IdTable
(braket
id|Id
)braket
op_assign
l_int|0
suffix:semicolon
id|this-&gt;Id
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|2
suffix:semicolon
)brace
multiline_comment|/*------------------------------------------------------------------*/
multiline_comment|/* indication handler                                               */
multiline_comment|/*------------------------------------------------------------------*/
r_static
DECL|function|isdn_ind
id|byte
id|isdn_ind
c_func
(paren
id|ADAPTER
op_star
id|a
comma
id|byte
id|Ind
comma
id|byte
id|Id
comma
id|byte
id|Ch
comma
id|PBUFFER
op_star
id|RBuffer
comma
id|byte
id|MInd
comma
id|word
id|MLength
)paren
(brace
id|ENTITY
op_star
id|this
suffix:semicolon
id|word
id|clength
suffix:semicolon
id|word
id|offset
suffix:semicolon
id|BUFFERS
op_star
id|R
suffix:semicolon
macro_line|#ifdef&t;USE_EXTENDED_DEBUGS
(brace
id|ISDN_ADAPTER
op_star
id|io
op_assign
(paren
id|ISDN_ADAPTER
op_star
)paren
id|a-&gt;io
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;IDI: &lt;A%d Id=0x%x Ind=0x%x&quot;
comma
id|io-&gt;ANum
comma
id|Id
comma
id|Ind
)paren
)paren
)brace
macro_line|#else
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;IDI: &lt;IND(Ind=%x,Id=%x,Ch=%x)&quot;
comma
id|Ind
comma
id|Id
comma
id|Ch
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|a-&gt;IdTable
(braket
id|Id
)braket
)paren
(brace
id|this
op_assign
id|entity_ptr
c_func
(paren
id|a
comma
id|a-&gt;IdTable
(braket
id|Id
)braket
)paren
suffix:semicolon
id|this-&gt;IndCh
op_assign
id|Ch
suffix:semicolon
multiline_comment|/* if the Receive More flag is not yet set, this is the     */
multiline_comment|/* first buffer of the packet                               */
r_if
c_cond
(paren
id|this-&gt;RCurrent
op_eq
l_int|0xff
)paren
(brace
multiline_comment|/* check for receive buffer chaining                        */
r_if
c_cond
(paren
id|Ind
op_eq
id|this-&gt;MInd
)paren
(brace
id|this-&gt;complete
op_assign
l_int|0
suffix:semicolon
id|this-&gt;Ind
op_assign
id|MInd
suffix:semicolon
)brace
r_else
(brace
id|this-&gt;complete
op_assign
l_int|1
suffix:semicolon
id|this-&gt;Ind
op_assign
id|Ind
suffix:semicolon
)brace
multiline_comment|/* call the application callback function for the receive   */
multiline_comment|/* look ahead                                               */
id|this-&gt;RLength
op_assign
id|MLength
suffix:semicolon
id|a
op_member_access_from_pointer
id|ram_look_ahead
c_func
(paren
id|a
comma
id|RBuffer
comma
id|this
)paren
suffix:semicolon
id|this-&gt;RNum
op_assign
l_int|0
suffix:semicolon
id|CALLBACK
c_func
(paren
id|a
comma
id|this
)paren
suffix:semicolon
multiline_comment|/* map entity ptr, selector could be re-mapped by call to   */
multiline_comment|/* IDI from within callback                                 */
id|this
op_assign
id|entity_ptr
c_func
(paren
id|a
comma
id|a-&gt;IdTable
(braket
id|Id
)braket
)paren
suffix:semicolon
multiline_comment|/* check for RNR                                            */
r_if
c_cond
(paren
id|this-&gt;RNR
op_eq
l_int|1
)paren
(brace
id|this-&gt;RNR
op_assign
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* if no buffers are provided by the application, the       */
multiline_comment|/* application want to copy the data itself including       */
multiline_comment|/* N_MDATA/LL_MDATA chaining                                */
r_if
c_cond
(paren
op_logical_neg
id|this-&gt;RNR
op_logical_and
op_logical_neg
id|this-&gt;RNum
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* if there is no RNR, set the More flag                    */
id|this-&gt;RCurrent
op_assign
l_int|0
suffix:semicolon
id|this-&gt;ROffset
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|this-&gt;RNR
op_eq
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|Ind
op_ne
id|this-&gt;MInd
)paren
(brace
id|this-&gt;RCurrent
op_assign
l_int|0xff
suffix:semicolon
id|this-&gt;RNR
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* if we have received buffers from the application, copy   */
multiline_comment|/* the data into these buffers                              */
id|offset
op_assign
l_int|0
suffix:semicolon
id|R
op_assign
id|PTR_R
c_func
(paren
id|a
comma
id|this
)paren
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|this-&gt;ROffset
op_eq
id|R
(braket
id|this-&gt;RCurrent
)braket
dot
id|PLength
)paren
(brace
id|this-&gt;ROffset
op_assign
l_int|0
suffix:semicolon
id|this-&gt;RCurrent
op_increment
suffix:semicolon
)brace
id|clength
op_assign
id|MIN
c_func
(paren
id|a
op_member_access_from_pointer
id|ram_inw
c_func
(paren
id|a
comma
op_amp
id|RBuffer-&gt;length
)paren
op_minus
id|offset
comma
id|R
(braket
id|this-&gt;RCurrent
)braket
dot
id|PLength
op_minus
id|this-&gt;ROffset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|R
(braket
id|this-&gt;RCurrent
)braket
dot
id|P
)paren
(brace
id|a
op_member_access_from_pointer
id|ram_in_buffer
c_func
(paren
id|a
comma
op_amp
id|RBuffer-&gt;P
(braket
id|offset
)braket
comma
id|PTR_P
c_func
(paren
id|a
comma
id|this
comma
op_amp
id|R
(braket
id|this-&gt;RCurrent
)braket
dot
id|P
(braket
id|this-&gt;ROffset
)braket
)paren
comma
id|clength
)paren
suffix:semicolon
)brace
id|offset
op_add_assign
id|clength
suffix:semicolon
id|this-&gt;ROffset
op_add_assign
id|clength
suffix:semicolon
)brace
r_while
c_loop
(paren
id|offset
OL
(paren
id|a
op_member_access_from_pointer
id|ram_inw
c_func
(paren
id|a
comma
op_amp
id|RBuffer-&gt;length
)paren
)paren
)paren
(brace
suffix:semicolon
)brace
multiline_comment|/* if it&squot;s the last buffer of the packet, call the          */
multiline_comment|/* application callback function for the receive complete   */
multiline_comment|/* call                                                     */
r_if
c_cond
(paren
id|Ind
op_ne
id|this-&gt;MInd
)paren
(brace
id|R
(braket
id|this-&gt;RCurrent
)braket
dot
id|PLength
op_assign
id|this-&gt;ROffset
suffix:semicolon
r_if
c_cond
(paren
id|this-&gt;ROffset
)paren
(brace
id|this-&gt;RCurrent
op_increment
suffix:semicolon
)brace
id|this-&gt;RNum
op_assign
id|this-&gt;RCurrent
suffix:semicolon
id|this-&gt;RCurrent
op_assign
l_int|0xff
suffix:semicolon
id|this-&gt;Ind
op_assign
id|Ind
suffix:semicolon
id|this-&gt;complete
op_assign
l_int|2
suffix:semicolon
id|CALLBACK
c_func
(paren
id|a
comma
id|this
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|2
suffix:semicolon
)brace
eof
