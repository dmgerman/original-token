multiline_comment|/* $Id: eicon_pci.c,v 1.11 2000/01/23 21:21:23 armin Exp $&n; *&n; * ISDN low-level module for Eicon active ISDN-Cards.&n; * Hardware-specific code for PCI cards.&n; *&n; * Copyright 1998-2000 by Armin Schindler (mac@melware.de)&n; * Copyright 1999,2000 Cytronics &amp; Melware (info@melware.de)&n; *&n; * Thanks to&t;Eicon Technology GmbH &amp; Co. oHG for &n; *&t;&t;documents, informations and hardware. &n; *&n; *&t;&t;Deutsche Telekom AG for S2M support.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA. &n; *&n; * $Log: eicon_pci.c,v $&n; * Revision 1.11  2000/01/23 21:21:23  armin&n; * Added new trace capability and some updates.&n; * DIVA Server BRI now supports data for ISDNLOG.&n; *&n; * Revision 1.10  1999/08/22 20:26:49  calle&n; * backported changes from kernel 2.3.14:&n; * - several #include &quot;config.h&quot; gone, others come.&n; * - &quot;struct device&quot; changed to &quot;struct net_device&quot; in 2.3.14, added a&n; *   define in isdn_compat.h for older kernel versions.&n; *&n; * Revision 1.9  1999/08/11 21:01:11  keil&n; * new PCI codefix&n; *&n; * Revision 1.8  1999/08/10 16:02:20  calle&n; * struct pci_dev changed in 2.3.13. Made the necessary changes.&n; *&n; * Revision 1.7  1999/06/09 19:31:29  armin&n; * Wrong PLX size for request_region() corrected.&n; * Added first MCA code from Erik Weber.&n; *&n; * Revision 1.6  1999/04/01 12:48:37  armin&n; * Changed some log outputs.&n; *&n; * Revision 1.5  1999/03/29 11:19:49  armin&n; * I/O stuff now in seperate file (eicon_io.c)&n; * Old ISA type cards (S,SX,SCOM,Quadro,S2M) implemented.&n; *&n; * Revision 1.4  1999/03/02 12:37:48  armin&n; * Added some important checks.&n; * Analog Modem with DSP.&n; * Channels will be added to Link-Level after loading firmware.&n; *&n; * Revision 1.3  1999/01/24 20:14:24  armin&n; * Changed and added debug stuff.&n; * Better data sending. (still problems with tty&squot;s flip buffer)&n; *&n; * Revision 1.2  1999/01/10 18:46:06  armin&n; * Bug with wrong values in HLC fixed.&n; * Bytes to send are counted and limited now.&n; *&n; * Revision 1.1  1999/01/01 18:09:45  armin&n; * First checkin of new eicon driver.&n; * DIVA-Server BRI/PCI and PRI/PCI are supported.&n; * Old diehl code is obsolete.&n; *&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &quot;eicon.h&quot;
macro_line|#include &quot;eicon_pci.h&quot;
DECL|variable|eicon_pci_revision
r_char
op_star
id|eicon_pci_revision
op_assign
l_string|&quot;$Revision: 1.11 $&quot;
suffix:semicolon
macro_line|#if CONFIG_PCI&t;         /* intire stuff is only for PCI */
DECL|macro|EICON_PCI_DEBUG
macro_line|#undef EICON_PCI_DEBUG 
DECL|function|eicon_pci_find_card
r_int
id|eicon_pci_find_card
c_func
(paren
r_char
op_star
id|ID
)paren
(brace
r_if
c_cond
(paren
id|pci_present
c_func
(paren
)paren
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
l_int|NULL
suffix:semicolon
r_int
id|pci_nextindex
op_assign
l_int|0
comma
id|pci_cards
op_assign
l_int|0
comma
id|pci_akt
op_assign
l_int|0
suffix:semicolon
r_int
id|pci_type
op_assign
id|PCI_MAESTRA
suffix:semicolon
r_int
id|NoMorePCICards
op_assign
id|FALSE
suffix:semicolon
r_char
op_star
id|ram
comma
op_star
id|reg
comma
op_star
id|cfg
suffix:semicolon
r_int
r_int
id|pram
op_assign
l_int|0
comma
id|preg
op_assign
l_int|0
comma
id|pcfg
op_assign
l_int|0
suffix:semicolon
r_char
id|did
(braket
l_int|12
)braket
suffix:semicolon
id|eicon_pci_card
op_star
id|aparms
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|aparms
op_assign
(paren
id|eicon_pci_card
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|eicon_pci_card
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eicon_pci: Could not allocate card-struct.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|pci_cards
op_assign
l_int|0
suffix:semicolon
id|pci_cards
OL
l_int|0x0f
suffix:semicolon
id|pci_cards
op_increment
)paren
(brace
r_do
(brace
r_if
c_cond
(paren
(paren
id|pdev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_EICON
comma
id|pci_type
comma
id|pdev
)paren
)paren
)paren
(brace
id|pci_nextindex
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
id|pci_nextindex
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|pci_type
)paren
multiline_comment|/* switch to next card type */
(brace
r_case
id|PCI_MAESTRA
suffix:colon
id|pci_type
op_assign
id|PCI_MAESTRAQ
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_MAESTRAQ
suffix:colon
id|pci_type
op_assign
id|PCI_MAESTRAQ_U
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_MAESTRAQ_U
suffix:colon
id|pci_type
op_assign
id|PCI_MAESTRAP
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_case
id|PCI_MAESTRAP
suffix:colon
id|NoMorePCICards
op_assign
id|TRUE
suffix:semicolon
)brace
)brace
)brace
r_while
c_loop
(paren
op_logical_neg
id|NoMorePCICards
)paren
suffix:semicolon
r_if
c_cond
(paren
id|NoMorePCICards
)paren
(brace
r_if
c_cond
(paren
id|pci_cards
OL
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Eicon: No supported PCI cards found.&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|aparms
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Eicon: %d PCI card%s registered.&bslash;n&quot;
comma
id|pci_cards
comma
(paren
id|pci_cards
OG
l_int|1
)paren
ques
c_cond
l_string|&quot;s&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|aparms
)paren
suffix:semicolon
r_return
(paren
id|pci_cards
)paren
suffix:semicolon
)brace
)brace
id|pci_enable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
multiline_comment|/* XXX handle error return */
id|pci_akt
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|pci_type
)paren
(brace
r_case
id|PCI_MAESTRA
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Eicon: DIVA Server BRI/PCI detected !&bslash;n&quot;
)paren
suffix:semicolon
id|aparms-&gt;type
op_assign
id|EICON_CTYPE_MAESTRA
suffix:semicolon
id|aparms-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|preg
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|2
)paren
suffix:semicolon
id|pcfg
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
suffix:semicolon
macro_line|#ifdef EICON_PCI_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;eicon_pci: irq=%d&bslash;n&quot;
comma
id|aparms-&gt;irq
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;eicon_pci: reg=0x%x&bslash;n&quot;
comma
id|preg
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;eicon_pci: cfg=0x%x&bslash;n&quot;
comma
id|pcfg
)paren
suffix:semicolon
macro_line|#endif
id|pci_akt
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_MAESTRAQ
suffix:colon
r_case
id|PCI_MAESTRAQ_U
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Eicon: DIVA Server 4BRI/PCI detected but not supported !&bslash;n&quot;
)paren
suffix:semicolon
id|pci_cards
op_decrement
suffix:semicolon
id|pci_akt
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_MAESTRAP
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Eicon: DIVA Server PRI/PCI detected !&bslash;n&quot;
)paren
suffix:semicolon
id|aparms-&gt;type
op_assign
id|EICON_CTYPE_MAESTRAP
suffix:semicolon
multiline_comment|/*includes 9M,30M*/
id|aparms-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|pram
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|preg
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|2
)paren
suffix:semicolon
id|pcfg
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|4
)paren
suffix:semicolon
macro_line|#ifdef EICON_PCI_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;eicon_pci: irq=%d&bslash;n&quot;
comma
id|aparms-&gt;irq
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;eicon_pci: ram=0x%x&bslash;n&quot;
comma
(paren
id|pram
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;eicon_pci: reg=0x%x&bslash;n&quot;
comma
(paren
id|preg
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;eicon_pci: cfg=0x%x&bslash;n&quot;
comma
(paren
id|pcfg
)paren
)paren
suffix:semicolon
macro_line|#endif
id|pci_akt
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;eicon_pci: Unknown PCI card detected !&bslash;n&quot;
)paren
suffix:semicolon
id|pci_cards
op_decrement
suffix:semicolon
id|pci_akt
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_akt
)paren
(brace
multiline_comment|/* remapping memory */
r_switch
c_cond
(paren
id|pci_type
)paren
(brace
r_case
id|PCI_MAESTRA
suffix:colon
id|aparms-&gt;PCIreg
op_assign
(paren
r_int
r_int
)paren
id|preg
suffix:semicolon
id|aparms-&gt;PCIcfg
op_assign
(paren
r_int
r_int
)paren
id|pcfg
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
(paren
id|aparms-&gt;PCIreg
)paren
comma
l_int|0x20
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eicon_pci: reg port already in use !&bslash;n&quot;
)paren
suffix:semicolon
id|aparms-&gt;PCIreg
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
id|request_region
c_func
(paren
id|aparms-&gt;PCIreg
comma
l_int|0x20
comma
l_string|&quot;eicon reg&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|check_region
c_func
(paren
(paren
id|aparms-&gt;PCIcfg
)paren
comma
l_int|0x80
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eicon_pci: cfg port already in use !&bslash;n&quot;
)paren
suffix:semicolon
id|aparms-&gt;PCIcfg
op_assign
l_int|0
suffix:semicolon
id|release_region
c_func
(paren
id|aparms-&gt;PCIreg
comma
l_int|0x20
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
id|request_region
c_func
(paren
id|aparms-&gt;PCIcfg
comma
l_int|0x80
comma
l_string|&quot;eicon cfg&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PCI_MAESTRAQ
suffix:colon
r_case
id|PCI_MAESTRAQ_U
suffix:colon
r_case
id|PCI_MAESTRAP
suffix:colon
id|aparms-&gt;shmem
op_assign
(paren
id|eicon_pci_shmem
op_star
)paren
id|ioremap
c_func
(paren
id|pram
comma
l_int|0x10000
)paren
suffix:semicolon
id|ram
op_assign
(paren
id|u8
op_star
)paren
(paren
(paren
id|u32
)paren
id|aparms-&gt;shmem
op_plus
id|MP_SHARED_RAM_OFFSET
)paren
suffix:semicolon
id|reg
op_assign
id|ioremap
c_func
(paren
id|preg
comma
l_int|0x4000
)paren
suffix:semicolon
id|cfg
op_assign
id|ioremap
c_func
(paren
id|pcfg
comma
l_int|0x1000
)paren
suffix:semicolon
id|aparms-&gt;PCIram
op_assign
(paren
r_int
r_int
)paren
id|ram
suffix:semicolon
id|aparms-&gt;PCIreg
op_assign
(paren
r_int
r_int
)paren
id|reg
suffix:semicolon
id|aparms-&gt;PCIcfg
op_assign
(paren
r_int
r_int
)paren
id|cfg
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
op_logical_neg
id|aparms-&gt;PCIreg
)paren
op_logical_or
(paren
op_logical_neg
id|aparms-&gt;PCIcfg
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;eicon_pci: Card could not be added !&bslash;n&quot;
)paren
suffix:semicolon
id|pci_cards
op_decrement
suffix:semicolon
)brace
r_else
(brace
id|aparms-&gt;mvalid
op_assign
l_int|1
suffix:semicolon
id|sprintf
c_func
(paren
id|did
comma
l_string|&quot;%s%d&quot;
comma
(paren
id|strlen
c_func
(paren
id|ID
)paren
OL
l_int|1
)paren
ques
c_cond
l_string|&quot;eicon&quot;
suffix:colon
id|ID
comma
id|pci_cards
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: DriverID: &squot;%s&squot;&bslash;n&quot;
comma
id|eicon_ctype_name
(braket
id|aparms-&gt;type
)braket
comma
id|did
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|eicon_addcard
c_func
(paren
id|aparms-&gt;type
comma
(paren
r_int
)paren
id|aparms
comma
id|aparms-&gt;irq
comma
id|did
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;eicon_pci: Card could not be added !&bslash;n&quot;
)paren
suffix:semicolon
id|pci_cards
op_decrement
suffix:semicolon
)brace
)brace
)brace
)brace
)brace
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;eicon_pci: Kernel compiled with PCI but no PCI-bios found !&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Checks protocol file id for &quot;F#xxxx&quot; string fragment to&n; * extract the features, supported by this protocol version.&n; * binary representation of the feature string value is returned&n; * in *value. The function returns 0 if feature string was not&n; * found or has a wrong format, else 1.&n; */
DECL|function|GetProtFeatureValue
r_static
r_int
id|GetProtFeatureValue
c_func
(paren
r_char
op_star
id|sw_id
comma
r_int
op_star
id|value
)paren
(brace
id|__u8
id|i
comma
id|offset
suffix:semicolon
r_while
c_loop
(paren
op_star
id|sw_id
)paren
(brace
r_if
c_cond
(paren
(paren
id|sw_id
(braket
l_int|0
)braket
op_eq
l_char|&squot;F&squot;
)paren
op_logical_and
(paren
id|sw_id
(braket
l_int|1
)braket
op_eq
l_char|&squot;#&squot;
)paren
)paren
(brace
id|sw_id
op_assign
op_amp
id|sw_id
(braket
l_int|2
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
op_star
id|value
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
comma
id|sw_id
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|sw_id
op_ge
l_char|&squot;0&squot;
)paren
op_logical_and
(paren
op_star
id|sw_id
op_le
l_char|&squot;9&squot;
)paren
)paren
(brace
id|offset
op_assign
l_char|&squot;0&squot;
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
op_star
id|sw_id
op_ge
l_char|&squot;A&squot;
)paren
op_logical_and
(paren
op_star
id|sw_id
op_le
l_char|&squot;F&squot;
)paren
)paren
(brace
id|offset
op_assign
l_char|&squot;A&squot;
op_plus
l_int|10
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
op_star
id|sw_id
op_ge
l_char|&squot;a&squot;
)paren
op_logical_and
(paren
op_star
id|sw_id
op_le
l_char|&squot;f&squot;
)paren
)paren
(brace
id|offset
op_assign
l_char|&squot;a&squot;
op_plus
l_int|10
suffix:semicolon
)brace
r_else
(brace
r_return
l_int|0
suffix:semicolon
)brace
op_star
id|value
op_or_assign
(paren
op_star
id|sw_id
op_minus
id|offset
)paren
op_lshift
(paren
l_int|4
op_star
(paren
l_int|3
op_minus
id|i
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|sw_id
op_increment
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|eicon_pci_printpar
id|eicon_pci_printpar
c_func
(paren
id|eicon_pci_card
op_star
id|card
)paren
(brace
r_switch
c_cond
(paren
id|card-&gt;type
)paren
(brace
r_case
id|EICON_CTYPE_MAESTRA
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s at 0x%x / 0x%x, irq %d&bslash;n&quot;
comma
id|eicon_ctype_name
(braket
id|card-&gt;type
)braket
comma
(paren
r_int
r_int
)paren
id|card-&gt;PCIreg
comma
(paren
r_int
r_int
)paren
id|card-&gt;PCIcfg
comma
id|card-&gt;irq
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EICON_CTYPE_MAESTRAQ
suffix:colon
r_case
id|EICON_CTYPE_MAESTRAQ_U
suffix:colon
r_case
id|EICON_CTYPE_MAESTRAP
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s at 0x%x, irq %d&bslash;n&quot;
comma
id|eicon_ctype_name
(braket
id|card-&gt;type
)braket
comma
(paren
r_int
r_int
)paren
id|card-&gt;shmem
comma
id|card-&gt;irq
)paren
suffix:semicolon
macro_line|#ifdef EICON_PCI_DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;eicon_pci: remapped ram= 0x%x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|card-&gt;PCIram
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;eicon_pci: remapped reg= 0x%x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|card-&gt;PCIreg
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;eicon_pci: remapped cfg= 0x%x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|card-&gt;PCIcfg
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|eicon_pci_release_shmem
id|eicon_pci_release_shmem
c_func
(paren
id|eicon_pci_card
op_star
id|card
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;master
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;mvalid
)paren
(brace
r_switch
c_cond
(paren
id|card-&gt;type
)paren
(brace
r_case
id|EICON_CTYPE_MAESTRA
suffix:colon
multiline_comment|/* reset board */
id|outb
c_func
(paren
l_int|0
comma
id|card-&gt;PCIcfg
op_plus
l_int|0x4c
)paren
suffix:semicolon
multiline_comment|/* disable interrupts from PLX */
id|outb
c_func
(paren
l_int|0
comma
id|card-&gt;PCIreg
op_plus
id|M_RESET
)paren
suffix:semicolon
id|SLEEP
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|card-&gt;PCIreg
op_plus
id|M_ADDRH
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|card-&gt;PCIreg
op_plus
id|M_ADDR
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|card-&gt;PCIreg
op_plus
id|M_DATA
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|card-&gt;PCIreg
comma
l_int|0x20
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|card-&gt;PCIcfg
comma
l_int|0x80
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EICON_CTYPE_MAESTRAQ
suffix:colon
r_case
id|EICON_CTYPE_MAESTRAQ_U
suffix:colon
r_case
id|EICON_CTYPE_MAESTRAP
suffix:colon
multiline_comment|/* reset board */
id|writeb
c_func
(paren
id|_MP_RISC_RESET
op_or
id|_MP_LED1
op_or
id|_MP_LED2
comma
id|card-&gt;PCIreg
op_plus
id|MP_RESET
)paren
suffix:semicolon
id|SLEEP
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
id|card-&gt;PCIreg
op_plus
id|MP_RESET
)paren
suffix:semicolon
id|SLEEP
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|card-&gt;shmem
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|card-&gt;PCIreg
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|card-&gt;PCIcfg
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|card-&gt;mvalid
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|eicon_pci_release_irq
id|eicon_pci_release_irq
c_func
(paren
id|eicon_pci_card
op_star
id|card
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;master
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;ivalid
)paren
id|free_irq
c_func
(paren
id|card-&gt;irq
comma
id|card
)paren
suffix:semicolon
id|card-&gt;ivalid
op_assign
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|eicon_pci_release
id|eicon_pci_release
c_func
(paren
id|eicon_pci_card
op_star
id|card
)paren
(brace
id|eicon_pci_release_irq
c_func
(paren
id|card
)paren
suffix:semicolon
id|eicon_pci_release_shmem
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Upload buffer content to adapters shared memory&n; * on verify error, 1 is returned and a message is printed on screen&n; * else 0 is returned&n; * Can serve IO-Type and Memory type adapters&n; */
DECL|function|eicon_upload
r_int
id|eicon_upload
c_func
(paren
id|t_dsp_download_space
op_star
id|p_para
comma
id|__u16
id|length
comma
multiline_comment|/* byte count */
id|__u8
op_star
id|buffer
comma
r_int
id|verify
)paren
(brace
id|__u32
id|i
comma
id|dwdata
op_assign
l_int|0
comma
id|val
op_assign
l_int|0
comma
id|timeout
suffix:semicolon
id|__u16
id|data
suffix:semicolon
id|eicon_pci_boot
op_star
id|boot
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|p_para-&gt;type
)paren
multiline_comment|/* actions depend on type of union */
(brace
r_case
id|DL_PARA_IO_TYPE
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|length
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
(brace
id|outb
(paren
(paren
id|u8
)paren
(paren
(paren
id|p_para-&gt;dat.io.r3addr
op_plus
id|i
)paren
op_rshift
l_int|16
)paren
comma
id|p_para-&gt;dat.io.ioADDRH
)paren
suffix:semicolon
id|outw
(paren
(paren
id|u16
)paren
(paren
id|p_para-&gt;dat.io.r3addr
op_plus
id|i
)paren
comma
id|p_para-&gt;dat.io.ioADDR
)paren
suffix:semicolon
multiline_comment|/* outw (((u16 *)code)[i &gt;&gt; 1], p_para-&gt;dat.io.ioDATA); */
id|outw
(paren
op_star
(paren
id|u16
op_star
)paren
op_amp
id|buffer
(braket
id|i
)braket
comma
id|p_para-&gt;dat.io.ioDATA
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|verify
)paren
multiline_comment|/* check written block */
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|length
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
(brace
id|outb
(paren
(paren
id|u8
)paren
(paren
(paren
id|p_para-&gt;dat.io.r3addr
op_plus
id|i
)paren
op_rshift
l_int|16
)paren
comma
id|p_para-&gt;dat.io.ioADDRH
)paren
suffix:semicolon
id|outw
(paren
(paren
id|u16
)paren
(paren
id|p_para-&gt;dat.io.r3addr
op_plus
id|i
)paren
comma
id|p_para-&gt;dat.io.ioADDR
)paren
suffix:semicolon
id|data
op_assign
id|inw
c_func
(paren
id|p_para-&gt;dat.io.ioDATA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
op_ne
op_star
(paren
id|u16
op_star
)paren
op_amp
id|buffer
(braket
id|i
)braket
)paren
(brace
id|p_para-&gt;dat.io.r3addr
op_add_assign
id|i
suffix:semicolon
id|p_para-&gt;dat.io.BadData
op_assign
id|data
suffix:semicolon
id|p_para-&gt;dat.io.GoodData
op_assign
op_star
(paren
id|u16
op_star
)paren
op_amp
id|buffer
(braket
id|i
)braket
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
)brace
r_break
suffix:semicolon
r_case
id|DL_PARA_MEM_TYPE
suffix:colon
id|boot
op_assign
id|p_para-&gt;dat.mem.boot
suffix:semicolon
id|writel
c_func
(paren
id|p_para-&gt;dat.mem.r3addr
comma
op_amp
id|boot-&gt;addr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|length
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
(brace
id|writel
c_func
(paren
(paren
(paren
id|u32
op_star
)paren
id|buffer
)paren
(braket
id|i
op_rshift
l_int|2
)braket
comma
op_amp
id|boot-&gt;data
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|verify
)paren
multiline_comment|/* check written block */
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|length
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
(brace
id|dwdata
op_assign
id|readl
c_func
(paren
op_amp
id|boot-&gt;data
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|u32
op_star
)paren
id|buffer
)paren
(braket
id|i
op_rshift
l_int|2
)braket
op_ne
id|dwdata
)paren
(brace
id|p_para-&gt;dat.mem.r3addr
op_add_assign
id|i
suffix:semicolon
id|p_para-&gt;dat.mem.BadData
op_assign
id|dwdata
suffix:semicolon
id|p_para-&gt;dat.mem.GoodData
op_assign
(paren
(paren
id|u32
op_star
)paren
id|buffer
)paren
(braket
id|i
op_rshift
l_int|2
)braket
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
)brace
id|writel
c_func
(paren
(paren
(paren
id|length
op_plus
l_int|3
)paren
op_div
l_int|4
)paren
comma
op_amp
id|boot-&gt;len
)paren
suffix:semicolon
multiline_comment|/* len in dwords */
id|writel
c_func
(paren
l_int|2
comma
op_amp
id|boot-&gt;cmd
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
l_int|20
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
id|jiffies
)paren
(brace
id|val
op_assign
id|readl
c_func
(paren
op_amp
id|boot-&gt;cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|val
)paren
r_break
suffix:semicolon
id|SLEEP
c_func
(paren
l_int|2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|val
)paren
(brace
id|p_para-&gt;dat.mem.timeout
op_assign
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* show header information of code file */
r_static
DECL|function|eicon_pci_print_hdr
r_int
id|eicon_pci_print_hdr
c_func
(paren
r_int
r_char
op_star
id|code
comma
r_int
id|offset
)paren
(brace
r_int
r_char
id|hdr
(braket
l_int|80
)braket
suffix:semicolon
r_int
id|i
comma
id|fvalue
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|i
OL
(paren
r_sizeof
(paren
id|hdr
)paren
op_minus
l_int|1
)paren
)paren
op_logical_and
(paren
id|code
(braket
id|offset
op_plus
id|i
)braket
op_ne
l_char|&squot;&bslash;0&squot;
)paren
op_logical_and
(paren
id|code
(braket
id|offset
op_plus
id|i
)braket
op_ne
l_char|&squot;&bslash;r&squot;
)paren
op_logical_and
(paren
id|code
(braket
id|offset
op_plus
id|i
)braket
op_ne
l_char|&squot;&bslash;n&squot;
)paren
)paren
(brace
id|hdr
(braket
id|i
)braket
op_assign
id|code
(braket
id|offset
op_plus
id|i
)braket
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
id|hdr
(braket
id|i
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Eicon: loading %s&bslash;n&quot;
comma
id|hdr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|GetProtFeatureValue
c_func
(paren
id|hdr
comma
op_amp
id|fvalue
)paren
)paren
r_return
id|fvalue
suffix:semicolon
r_else
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Configure a card, download code into BRI card,&n; * check if we get interrupts and return 0 on succes.&n; * Return -ERRNO on failure.&n; */
r_int
DECL|function|eicon_pci_load_bri
id|eicon_pci_load_bri
c_func
(paren
id|eicon_pci_card
op_star
id|card
comma
id|eicon_pci_codebuf
op_star
id|cb
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_int
id|timeout
suffix:semicolon
r_int
r_int
id|offset
comma
id|offp
op_assign
l_int|0
comma
id|size
comma
id|length
suffix:semicolon
r_int
id|signature
op_assign
l_int|0
suffix:semicolon
r_int
id|FeatureValue
op_assign
l_int|0
suffix:semicolon
id|eicon_pci_codebuf
id|cbuf
suffix:semicolon
id|t_dsp_download_space
id|dl_para
suffix:semicolon
id|t_dsp_download_desc
id|dsp_download_table
suffix:semicolon
r_int
r_char
op_star
id|code
suffix:semicolon
r_int
r_int
id|reg
suffix:semicolon
r_int
r_int
id|cfg
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|cbuf
comma
id|cb
comma
r_sizeof
(paren
id|eicon_pci_codebuf
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|reg
op_assign
id|card-&gt;PCIreg
suffix:semicolon
id|cfg
op_assign
id|card-&gt;PCIcfg
suffix:semicolon
multiline_comment|/* reset board */
id|outb
c_func
(paren
l_int|0
comma
id|reg
op_plus
id|M_RESET
)paren
suffix:semicolon
id|SLEEP
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|reg
op_plus
id|M_ADDRH
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|reg
op_plus
id|M_ADDR
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|reg
op_plus
id|M_DATA
)paren
suffix:semicolon
macro_line|#ifdef EICON_PCI_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;eicon_pci: reset card&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* clear shared memory */
id|outb
c_func
(paren
l_int|0xff
comma
id|reg
op_plus
id|M_ADDRH
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|reg
op_plus
id|M_ADDR
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0xffff
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outw
c_func
(paren
l_int|0
comma
id|reg
op_plus
id|M_DATA
)paren
suffix:semicolon
)brace
id|SLEEP
c_func
(paren
l_int|10
)paren
suffix:semicolon
macro_line|#ifdef EICON_PCI_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;eicon_pci: clear shared memory&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* download protocol and dsp file */
macro_line|#ifdef EICON_PCI_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;eicon_pci: downloading firmware...&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Allocate code-buffer */
r_if
c_cond
(paren
op_logical_neg
(paren
id|code
op_assign
id|kmalloc
c_func
(paren
l_int|400
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eicon_pci_boot: Couldn&squot;t allocate code buffer&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* prepare protocol upload */
id|dl_para.type
op_assign
id|DL_PARA_IO_TYPE
suffix:semicolon
id|dl_para.dat.io.ioADDR
op_assign
id|reg
op_plus
id|M_ADDR
suffix:semicolon
id|dl_para.dat.io.ioADDRH
op_assign
id|reg
op_plus
id|M_ADDRH
suffix:semicolon
id|dl_para.dat.io.ioDATA
op_assign
id|reg
op_plus
id|M_DATA
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
op_le
id|cbuf.dsp_code_num
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|j
op_eq
l_int|0
)paren
id|size
op_assign
id|cbuf.protocol_len
suffix:semicolon
r_else
id|size
op_assign
id|cbuf.dsp_code_len
(braket
id|j
)braket
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|j
op_eq
l_int|0
)paren
id|dl_para.dat.io.r3addr
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|j
op_eq
l_int|1
)paren
id|dl_para.dat.io.r3addr
op_assign
id|M_DSP_CODE_BASE
op_plus
(paren
(paren
r_sizeof
(paren
id|__u32
)paren
op_plus
(paren
r_sizeof
(paren
id|dsp_download_table
)paren
op_star
l_int|35
)paren
op_plus
l_int|3
)paren
op_amp
l_int|0xfffffffc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|j
op_eq
l_int|2
)paren
id|dl_para.dat.io.r3addr
op_assign
id|M_DSP_CODE_BASE
suffix:semicolon
r_if
c_cond
(paren
id|j
op_eq
l_int|3
)paren
id|dl_para.dat.io.r3addr
op_assign
id|M_DSP_CODE_BASE
op_plus
r_sizeof
(paren
id|__u32
)paren
suffix:semicolon
r_do
multiline_comment|/* download block of up to 400 bytes */
(brace
id|length
op_assign
(paren
(paren
id|size
op_minus
id|offset
)paren
op_ge
l_int|400
)paren
ques
c_cond
l_int|400
suffix:colon
(paren
id|size
op_minus
id|offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|code
comma
(paren
op_amp
id|cb-&gt;code
)paren
op_plus
id|offp
op_plus
id|offset
comma
id|length
)paren
)paren
(brace
id|kfree
c_func
(paren
id|code
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|offset
op_eq
l_int|0
)paren
op_logical_and
(paren
id|j
OL
l_int|2
)paren
)paren
(brace
id|FeatureValue
op_assign
id|eicon_pci_print_hdr
c_func
(paren
id|code
comma
id|j
ques
c_cond
l_int|0x00
suffix:colon
l_int|0x80
)paren
suffix:semicolon
macro_line|#ifdef EICON_PCI_DEBUG
r_if
c_cond
(paren
id|FeatureValue
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;eicon_pci: Feature Value : 0x%04x.&bslash;n&quot;
comma
id|FeatureValue
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|j
op_eq
l_int|0
)paren
op_logical_and
(paren
op_logical_neg
(paren
id|FeatureValue
op_amp
id|PROTCAP_TELINDUS
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;eicon_pci: Protocol Code cannot handle Telindus&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|code
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|Feature
op_assign
id|FeatureValue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|eicon_upload
c_func
(paren
op_amp
id|dl_para
comma
id|length
comma
id|code
comma
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;eicon_pci: code block check failed at 0x%x !&bslash;n&quot;
comma
id|dl_para.dat.io.r3addr
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|code
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* move onto next block */
id|offset
op_add_assign
id|length
suffix:semicolon
id|dl_para.dat.io.r3addr
op_add_assign
id|length
suffix:semicolon
)brace
r_while
c_loop
(paren
id|offset
OL
id|size
)paren
suffix:semicolon
macro_line|#ifdef EICON_PCI_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Eicon: %d bytes loaded.&bslash;n&quot;
comma
id|offset
)paren
suffix:semicolon
macro_line|#endif
id|offp
op_add_assign
id|size
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|code
)paren
suffix:semicolon
multiline_comment|/* clear signature */
id|outb
c_func
(paren
l_int|0xff
comma
id|reg
op_plus
id|M_ADDRH
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x1e
comma
id|reg
op_plus
id|M_ADDR
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|reg
op_plus
id|M_DATA
)paren
suffix:semicolon
macro_line|#ifdef EICON_PCI_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;eicon_pci: copy configuration data into shared memory...&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* copy configuration data into shared memory */
id|outw
c_func
(paren
l_int|8
comma
id|reg
op_plus
id|M_ADDR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|cbuf.tei
comma
id|reg
op_plus
id|M_DATA
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|9
comma
id|reg
op_plus
id|M_ADDR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|cbuf.nt2
comma
id|reg
op_plus
id|M_DATA
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|10
comma
id|reg
op_plus
id|M_ADDR
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|reg
op_plus
id|M_DATA
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|11
comma
id|reg
op_plus
id|M_ADDR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|cbuf.WatchDog
comma
id|reg
op_plus
id|M_DATA
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|12
comma
id|reg
op_plus
id|M_ADDR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|cbuf.Permanent
comma
id|reg
op_plus
id|M_DATA
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|13
comma
id|reg
op_plus
id|M_ADDR
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|reg
op_plus
id|M_DATA
)paren
suffix:semicolon
multiline_comment|/* XInterface */
id|outw
c_func
(paren
l_int|14
comma
id|reg
op_plus
id|M_ADDR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|cbuf.StableL2
comma
id|reg
op_plus
id|M_DATA
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|15
comma
id|reg
op_plus
id|M_ADDR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|cbuf.NoOrderCheck
comma
id|reg
op_plus
id|M_DATA
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|16
comma
id|reg
op_plus
id|M_ADDR
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|reg
op_plus
id|M_DATA
)paren
suffix:semicolon
multiline_comment|/* HandsetType */
id|outw
c_func
(paren
l_int|17
comma
id|reg
op_plus
id|M_ADDR
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|reg
op_plus
id|M_DATA
)paren
suffix:semicolon
multiline_comment|/* SigFlags */
id|outw
c_func
(paren
l_int|18
comma
id|reg
op_plus
id|M_ADDR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|cbuf.LowChannel
comma
id|reg
op_plus
id|M_DATA
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|19
comma
id|reg
op_plus
id|M_ADDR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|cbuf.ProtVersion
comma
id|reg
op_plus
id|M_DATA
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|20
comma
id|reg
op_plus
id|M_ADDR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|cbuf.Crc4
comma
id|reg
op_plus
id|M_DATA
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|21
comma
id|reg
op_plus
id|M_ADDR
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|cbuf.Loopback
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|0
comma
id|reg
op_plus
id|M_DATA
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outw
c_func
(paren
l_int|32
op_plus
id|i
comma
id|reg
op_plus
id|M_ADDR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|cbuf.l
(braket
l_int|0
)braket
dot
id|oad
(braket
id|i
)braket
comma
id|reg
op_plus
id|M_DATA
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|64
op_plus
id|i
comma
id|reg
op_plus
id|M_ADDR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|cbuf.l
(braket
l_int|0
)braket
dot
id|osa
(braket
id|i
)braket
comma
id|reg
op_plus
id|M_DATA
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|96
op_plus
id|i
comma
id|reg
op_plus
id|M_ADDR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|cbuf.l
(braket
l_int|0
)braket
dot
id|spid
(braket
id|i
)braket
comma
id|reg
op_plus
id|M_DATA
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|128
op_plus
id|i
comma
id|reg
op_plus
id|M_ADDR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|cbuf.l
(braket
l_int|1
)braket
dot
id|oad
(braket
id|i
)braket
comma
id|reg
op_plus
id|M_DATA
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|160
op_plus
id|i
comma
id|reg
op_plus
id|M_ADDR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|cbuf.l
(braket
l_int|1
)braket
dot
id|osa
(braket
id|i
)braket
comma
id|reg
op_plus
id|M_DATA
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|192
op_plus
id|i
comma
id|reg
op_plus
id|M_ADDR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|cbuf.l
(braket
l_int|1
)braket
dot
id|spid
(braket
id|i
)braket
comma
id|reg
op_plus
id|M_DATA
)paren
suffix:semicolon
)brace
macro_line|#ifdef EICON_PCI_DEBUG
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;eicon_pci: starting CPU...&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* let the CPU run */
id|outw
c_func
(paren
l_int|0x08
comma
id|reg
op_plus
id|M_RESET
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
(paren
l_int|5
op_star
id|HZ
)paren
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
id|jiffies
)paren
(brace
id|outw
c_func
(paren
l_int|0x1e
comma
id|reg
op_plus
id|M_ADDR
)paren
suffix:semicolon
id|signature
op_assign
id|inw
c_func
(paren
id|reg
op_plus
id|M_DATA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signature
op_eq
id|DIVAS_SIGNATURE
)paren
r_break
suffix:semicolon
id|SLEEP
c_func
(paren
l_int|2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|signature
op_ne
id|DIVAS_SIGNATURE
)paren
(brace
macro_line|#ifdef EICON_PCI_DEBUG
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;eicon_pci: signature 0x%x expected 0x%x&bslash;n&quot;
comma
id|signature
comma
id|DIVAS_SIGNATURE
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;eicon_pci: Timeout, protocol code not running !&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
macro_line|#ifdef EICON_PCI_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;eicon_pci: Protocol code running, signature OK&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* get serial number and number of channels supported by card */
id|outb
c_func
(paren
l_int|0xff
comma
id|reg
op_plus
id|M_ADDRH
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x3f6
comma
id|reg
op_plus
id|M_ADDR
)paren
suffix:semicolon
id|card-&gt;channels
op_assign
id|inw
c_func
(paren
id|reg
op_plus
id|M_DATA
)paren
suffix:semicolon
id|card-&gt;serial
op_assign
(paren
id|u32
)paren
id|inw
c_func
(paren
id|cfg
op_plus
l_int|0x22
)paren
op_lshift
l_int|16
op_or
(paren
id|u32
)paren
id|inw
c_func
(paren
id|cfg
op_plus
l_int|0x26
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Eicon: Supported channels : %d&bslash;n&quot;
comma
id|card-&gt;channels
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Eicon: Card serial no. = %lu&bslash;n&quot;
comma
id|card-&gt;serial
)paren
suffix:semicolon
multiline_comment|/* test interrupt */
id|card-&gt;irqprobe
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;ivalid
)paren
(brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|card-&gt;irq
comma
op_amp
id|eicon_irq
comma
l_int|0
comma
l_string|&quot;Eicon PCI ISDN&quot;
comma
id|card-&gt;card
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;eicon_pci: Couldn&squot;t request irq %d&bslash;n&quot;
comma
id|card-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
id|card-&gt;ivalid
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef EICON_PCI_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;eicon_pci: testing interrupt&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Trigger an interrupt and check if it is delivered */
id|outb
c_func
(paren
l_int|0x41
comma
id|cfg
op_plus
l_int|0x4c
)paren
suffix:semicolon
multiline_comment|/* enable PLX for interrupts */
id|outb
c_func
(paren
l_int|0x89
comma
id|reg
op_plus
id|M_RESET
)paren
suffix:semicolon
multiline_comment|/* place int request */
id|timeout
op_assign
id|jiffies
op_plus
l_int|20
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
id|jiffies
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;irqprobe
op_ne
l_int|1
)paren
r_break
suffix:semicolon
id|SLEEP
c_func
(paren
l_int|5
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;irqprobe
op_eq
l_int|1
)paren
(brace
id|free_irq
c_func
(paren
id|card-&gt;irq
comma
id|card
)paren
suffix:semicolon
id|card-&gt;ivalid
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;eicon_pci: Getting no interrupts !&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* initializing some variables */
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|ReadyInt
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|256
suffix:semicolon
id|j
op_increment
)paren
(brace
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|IdTable
(braket
id|j
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
(paren
id|card-&gt;channels
op_plus
l_int|1
)paren
suffix:semicolon
id|j
op_increment
)paren
(brace
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|bch
(braket
id|j
)braket
dot
id|e.busy
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|bch
(braket
id|j
)braket
dot
id|e.D3Id
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|bch
(braket
id|j
)braket
dot
id|e.B2Id
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|bch
(braket
id|j
)braket
dot
id|e.ref
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|bch
(braket
id|j
)braket
dot
id|e.Req
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|bch
(braket
id|j
)braket
dot
id|e.complete
op_assign
l_int|1
suffix:semicolon
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|bch
(braket
id|j
)braket
dot
id|fsm_state
op_assign
id|EICON_STATE_NULL
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Eicon: Card successfully started&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Configure a card, download code into PRI card,&n; * check if we get interrupts and return 0 on succes.&n; * Return -ERRNO on failure.&n; */
r_int
DECL|function|eicon_pci_load_pri
id|eicon_pci_load_pri
c_func
(paren
id|eicon_pci_card
op_star
id|card
comma
id|eicon_pci_codebuf
op_star
id|cb
)paren
(brace
id|eicon_pci_boot
op_star
id|boot
suffix:semicolon
id|eicon_pr_ram
op_star
id|prram
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
r_int
id|timeout
suffix:semicolon
r_int
id|FeatureValue
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|offset
comma
id|offp
op_assign
l_int|0
comma
id|size
comma
id|length
suffix:semicolon
r_int
r_int
r_int
id|signature
op_assign
l_int|0
suffix:semicolon
id|t_dsp_download_space
id|dl_para
suffix:semicolon
id|t_dsp_download_desc
id|dsp_download_table
suffix:semicolon
id|eicon_pci_codebuf
id|cbuf
suffix:semicolon
r_int
r_char
op_star
id|code
suffix:semicolon
r_int
r_char
id|req_int
suffix:semicolon
r_char
op_star
id|ram
comma
op_star
id|reg
comma
op_star
id|cfg
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|cbuf
comma
id|cb
comma
r_sizeof
(paren
id|eicon_pci_codebuf
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|boot
op_assign
op_amp
id|card-&gt;shmem-&gt;boot
suffix:semicolon
id|ram
op_assign
(paren
r_char
op_star
)paren
id|card-&gt;PCIram
suffix:semicolon
id|reg
op_assign
(paren
r_char
op_star
)paren
id|card-&gt;PCIreg
suffix:semicolon
id|cfg
op_assign
(paren
r_char
op_star
)paren
id|card-&gt;PCIcfg
suffix:semicolon
id|prram
op_assign
(paren
id|eicon_pr_ram
op_star
)paren
id|ram
suffix:semicolon
multiline_comment|/* reset board */
id|writeb
c_func
(paren
id|_MP_RISC_RESET
op_or
id|_MP_LED1
op_or
id|_MP_LED2
comma
id|card-&gt;PCIreg
op_plus
id|MP_RESET
)paren
suffix:semicolon
id|SLEEP
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
id|card-&gt;PCIreg
op_plus
id|MP_RESET
)paren
suffix:semicolon
id|SLEEP
c_func
(paren
l_int|20
)paren
suffix:semicolon
multiline_comment|/* set command count to 0 */
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|boot-&gt;reserved
)paren
suffix:semicolon
multiline_comment|/* check if CPU increments the life word */
id|i
op_assign
id|readw
c_func
(paren
op_amp
id|boot-&gt;live
)paren
suffix:semicolon
id|SLEEP
c_func
(paren
l_int|20
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|readw
c_func
(paren
op_amp
id|boot-&gt;live
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;eicon_pci: card is reset, but CPU not running !&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
macro_line|#ifdef EICON_PCI_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;eicon_pci: reset card OK (CPU running)&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* download firmware : DSP and Protocol */
macro_line|#ifdef EICON_PCI_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;eicon_pci: downloading firmware...&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Allocate code-buffer */
r_if
c_cond
(paren
op_logical_neg
(paren
id|code
op_assign
id|kmalloc
c_func
(paren
l_int|400
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eicon_pci_boot: Couldn&squot;t allocate code buffer&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* prepare protocol upload */
id|dl_para.type
op_assign
id|DL_PARA_MEM_TYPE
suffix:semicolon
id|dl_para.dat.mem.boot
op_assign
id|boot
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
op_le
id|cbuf.dsp_code_num
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|j
op_eq
l_int|0
)paren
id|size
op_assign
id|cbuf.protocol_len
suffix:semicolon
r_else
id|size
op_assign
id|cbuf.dsp_code_len
(braket
id|j
)braket
suffix:semicolon
r_if
c_cond
(paren
id|j
op_eq
l_int|1
)paren
id|writel
c_func
(paren
id|MP_DSP_ADDR
comma
op_amp
id|boot-&gt;addr
)paren
suffix:semicolon
multiline_comment|/* DSP code entry point */
r_if
c_cond
(paren
id|j
op_eq
l_int|0
)paren
id|dl_para.dat.io.r3addr
op_assign
id|MP_PROTOCOL_ADDR
suffix:semicolon
r_if
c_cond
(paren
id|j
op_eq
l_int|1
)paren
id|dl_para.dat.io.r3addr
op_assign
id|MP_DSP_CODE_BASE
op_plus
(paren
(paren
r_sizeof
(paren
id|__u32
)paren
op_plus
(paren
r_sizeof
(paren
id|dsp_download_table
)paren
op_star
l_int|35
)paren
op_plus
l_int|3
)paren
op_amp
l_int|0xfffffffc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|j
op_eq
l_int|2
)paren
id|dl_para.dat.io.r3addr
op_assign
id|MP_DSP_CODE_BASE
suffix:semicolon
r_if
c_cond
(paren
id|j
op_eq
l_int|3
)paren
id|dl_para.dat.io.r3addr
op_assign
id|MP_DSP_CODE_BASE
op_plus
r_sizeof
(paren
id|__u32
)paren
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
r_do
multiline_comment|/* download block of up to 400 bytes */
(brace
id|length
op_assign
(paren
(paren
id|size
op_minus
id|offset
)paren
op_ge
l_int|400
)paren
ques
c_cond
l_int|400
suffix:colon
(paren
id|size
op_minus
id|offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|code
comma
(paren
op_amp
id|cb-&gt;code
)paren
op_plus
id|offp
op_plus
id|offset
comma
id|length
)paren
)paren
(brace
id|kfree
c_func
(paren
id|code
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|offset
op_eq
l_int|0
)paren
op_logical_and
(paren
id|j
OL
l_int|2
)paren
)paren
(brace
id|FeatureValue
op_assign
id|eicon_pci_print_hdr
c_func
(paren
id|code
comma
id|j
ques
c_cond
l_int|0x00
suffix:colon
l_int|0x80
)paren
suffix:semicolon
macro_line|#ifdef EICON_PCI_DEBUG
r_if
c_cond
(paren
id|FeatureValue
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;eicon_pci: Feature Value : 0x%x.&bslash;n&quot;
comma
id|FeatureValue
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|j
op_eq
l_int|0
)paren
op_logical_and
(paren
op_logical_neg
(paren
id|FeatureValue
op_amp
id|PROTCAP_TELINDUS
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;eicon_pci: Protocol Code cannot handle Telindus&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|code
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|Feature
op_assign
id|FeatureValue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|eicon_upload
c_func
(paren
op_amp
id|dl_para
comma
id|length
comma
id|code
comma
l_int|1
)paren
)paren
(brace
r_if
c_cond
(paren
id|dl_para.dat.mem.timeout
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;eicon_pci: code block check failed at 0x%x !&bslash;n&quot;
comma
id|dl_para.dat.io.r3addr
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;eicon_pci: timeout, no ACK to load !&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|code
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* move onto next block */
id|offset
op_add_assign
id|length
suffix:semicolon
id|dl_para.dat.mem.r3addr
op_add_assign
id|length
suffix:semicolon
)brace
r_while
c_loop
(paren
id|offset
OL
id|size
)paren
suffix:semicolon
macro_line|#ifdef EICON_PCI_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;eicon_pci: %d bytes loaded.&bslash;n&quot;
comma
id|offset
)paren
suffix:semicolon
macro_line|#endif
id|offp
op_add_assign
id|size
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|code
)paren
suffix:semicolon
multiline_comment|/* initialize the adapter data structure */
macro_line|#ifdef EICON_PCI_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;eicon_pci: copy configuration data into shared memory...&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* clear out config space */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_increment
)paren
id|writeb
c_func
(paren
l_int|0
comma
op_amp
id|ram
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/* copy configuration down to the card */
id|writeb
c_func
(paren
id|cbuf.tei
comma
op_amp
id|ram
(braket
l_int|8
)braket
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|cbuf.nt2
comma
op_amp
id|ram
(braket
l_int|9
)braket
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
op_amp
id|ram
(braket
l_int|10
)braket
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|cbuf.WatchDog
comma
op_amp
id|ram
(braket
l_int|11
)braket
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|cbuf.Permanent
comma
op_amp
id|ram
(braket
l_int|12
)braket
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|cbuf.XInterface
comma
op_amp
id|ram
(braket
l_int|13
)braket
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|cbuf.StableL2
comma
op_amp
id|ram
(braket
l_int|14
)braket
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|cbuf.NoOrderCheck
comma
op_amp
id|ram
(braket
l_int|15
)braket
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|cbuf.HandsetType
comma
op_amp
id|ram
(braket
l_int|16
)braket
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
op_amp
id|ram
(braket
l_int|17
)braket
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|cbuf.LowChannel
comma
op_amp
id|ram
(braket
l_int|18
)braket
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|cbuf.ProtVersion
comma
op_amp
id|ram
(braket
l_int|19
)braket
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|cbuf.Crc4
comma
op_amp
id|ram
(braket
l_int|20
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|writeb
c_func
(paren
id|cbuf.l
(braket
l_int|0
)braket
dot
id|oad
(braket
id|i
)braket
comma
op_amp
id|ram
(braket
l_int|32
op_plus
id|i
)braket
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|cbuf.l
(braket
l_int|0
)braket
dot
id|osa
(braket
id|i
)braket
comma
op_amp
id|ram
(braket
l_int|64
op_plus
id|i
)braket
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|cbuf.l
(braket
l_int|0
)braket
dot
id|spid
(braket
id|i
)braket
comma
op_amp
id|ram
(braket
l_int|96
op_plus
id|i
)braket
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|cbuf.l
(braket
l_int|1
)braket
dot
id|oad
(braket
id|i
)braket
comma
op_amp
id|ram
(braket
l_int|128
op_plus
id|i
)braket
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|cbuf.l
(braket
l_int|1
)braket
dot
id|osa
(braket
id|i
)braket
comma
op_amp
id|ram
(braket
l_int|160
op_plus
id|i
)braket
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|cbuf.l
(braket
l_int|1
)braket
dot
id|spid
(braket
id|i
)braket
comma
op_amp
id|ram
(braket
l_int|192
op_plus
id|i
)braket
)paren
suffix:semicolon
)brace
macro_line|#ifdef EICON_PCI_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;eicon_pci: configured card OK&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* start adapter */
macro_line|#ifdef EICON_PCI_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;eicon_pci: tell card to start...&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|writel
c_func
(paren
id|MP_PROTOCOL_ADDR
comma
op_amp
id|boot-&gt;addr
)paren
suffix:semicolon
multiline_comment|/* RISC code entry point */
id|writel
c_func
(paren
l_int|3
comma
op_amp
id|boot-&gt;cmd
)paren
suffix:semicolon
multiline_comment|/* DIVAS_START_CMD */
multiline_comment|/* wait till card ACKs */
id|timeout
op_assign
id|jiffies
op_plus
(paren
l_int|5
op_star
id|HZ
)paren
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
id|jiffies
)paren
(brace
id|signature
op_assign
id|readl
c_func
(paren
op_amp
id|boot-&gt;signature
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|signature
op_rshift
l_int|16
)paren
op_eq
id|DIVAS_SIGNATURE
)paren
r_break
suffix:semicolon
id|SLEEP
c_func
(paren
l_int|2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|signature
op_rshift
l_int|16
)paren
op_ne
id|DIVAS_SIGNATURE
)paren
(brace
macro_line|#ifdef EICON_PCI_DEBUG
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;eicon_pci: signature 0x%lx expected 0x%x&bslash;n&quot;
comma
(paren
id|signature
op_rshift
l_int|16
)paren
comma
id|DIVAS_SIGNATURE
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;eicon_pci: timeout, protocol code not running !&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
macro_line|#ifdef EICON_PCI_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;eicon_pci: Protocol code running, signature OK&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* get serial number and number of channels supported by card */
id|card-&gt;channels
op_assign
id|readb
c_func
(paren
op_amp
id|ram
(braket
l_int|0x3f6
)braket
)paren
suffix:semicolon
id|card-&gt;serial
op_assign
id|readl
c_func
(paren
op_amp
id|ram
(braket
l_int|0x3f0
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Eicon: Supported channels : %d&bslash;n&quot;
comma
id|card-&gt;channels
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Eicon: Card serial no. = %lu&bslash;n&quot;
comma
id|card-&gt;serial
)paren
suffix:semicolon
multiline_comment|/* test interrupt */
id|readb
c_func
(paren
op_amp
id|ram
(braket
l_int|0x3fe
)braket
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
op_amp
id|ram
(braket
l_int|0x3fe
)braket
)paren
suffix:semicolon
multiline_comment|/* reset any pending interrupt */
id|readb
c_func
(paren
op_amp
id|ram
(braket
l_int|0x3fe
)braket
)paren
suffix:semicolon
id|writew
c_func
(paren
id|MP_IRQ_RESET_VAL
comma
op_amp
id|cfg
(braket
id|MP_IRQ_RESET
)braket
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0
comma
op_amp
id|cfg
(braket
id|MP_IRQ_RESET
op_plus
l_int|2
)braket
)paren
suffix:semicolon
id|card-&gt;irqprobe
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;ivalid
)paren
(brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|card-&gt;irq
comma
op_amp
id|eicon_irq
comma
l_int|0
comma
l_string|&quot;Eicon PCI ISDN&quot;
comma
id|card-&gt;card
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;eicon_pci: Couldn&squot;t request irq %d&bslash;n&quot;
comma
id|card-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
id|card-&gt;ivalid
op_assign
l_int|1
suffix:semicolon
id|req_int
op_assign
id|readb
c_func
(paren
op_amp
id|prram-&gt;ReadyInt
)paren
suffix:semicolon
macro_line|#ifdef EICON_PCI_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;eicon_pci: testing interrupt&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|req_int
op_increment
suffix:semicolon
multiline_comment|/* Trigger an interrupt and check if it is delivered */
id|writeb
c_func
(paren
id|req_int
comma
op_amp
id|prram-&gt;ReadyInt
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
l_int|20
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
id|jiffies
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;irqprobe
op_ne
l_int|1
)paren
r_break
suffix:semicolon
id|SLEEP
c_func
(paren
l_int|2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;irqprobe
op_eq
l_int|1
)paren
(brace
id|free_irq
c_func
(paren
id|card-&gt;irq
comma
id|card
)paren
suffix:semicolon
id|card-&gt;ivalid
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;eicon_pci: Getting no interrupts !&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* initializing some variables */
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|ReadyInt
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|256
suffix:semicolon
id|j
op_increment
)paren
(brace
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|IdTable
(braket
id|j
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
(paren
id|card-&gt;channels
op_plus
l_int|1
)paren
suffix:semicolon
id|j
op_increment
)paren
(brace
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|bch
(braket
id|j
)braket
dot
id|e.busy
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|bch
(braket
id|j
)braket
dot
id|e.D3Id
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|bch
(braket
id|j
)braket
dot
id|e.B2Id
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|bch
(braket
id|j
)braket
dot
id|e.ref
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|bch
(braket
id|j
)braket
dot
id|e.Req
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|bch
(braket
id|j
)braket
dot
id|e.complete
op_assign
l_int|1
suffix:semicolon
(paren
(paren
id|eicon_card
op_star
)paren
id|card-&gt;card
)paren
op_member_access_from_pointer
id|bch
(braket
id|j
)braket
dot
id|fsm_state
op_assign
id|EICON_STATE_NULL
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Eicon: Card successfully started&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif&t;/* CONFIG_PCI */
eof
