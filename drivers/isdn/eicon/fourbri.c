multiline_comment|/*&n; *&n; * Copyright (C) Eicon Technology Corporation, 2000.&n; *&n; * This source file is supplied for the exclusive use with Eicon&n; * Technology Corporation&squot;s range of DIVA Server Adapters.&n; *&n; * Eicon File Revision :    1.7  &n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY OF ANY KIND WHATSOEVER INCLUDING ANY &n; * implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  &n; * See the GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; */
multiline_comment|/* Diva Server 4BRI specific part of initialisation */
macro_line|#include &quot;sys.h&quot;
macro_line|#include &quot;idi.h&quot;
macro_line|#include &quot;divas.h&quot;
macro_line|#include &quot;pc.h&quot;
macro_line|#include &quot;pr_pc.h&quot;
macro_line|#include &quot;dsp_defs.h&quot;
macro_line|#include &quot;constant.h&quot;
macro_line|#include &quot;adapter.h&quot;
macro_line|#include &quot;uxio.h&quot;
DECL|macro|TEST_INT_DIVAS_Q
mdefine_line|#define TEST_INT_DIVAS_Q&t;0x13
DECL|macro|DIVAS_MAINT_OFFSET
mdefine_line|#define&t;DIVAS_MAINT_OFFSET&t;0xff00&t;/* value for 4BRI card */
DECL|macro|MQ_BOARD_DSP_OFFSET
mdefine_line|#define MQ_BOARD_DSP_OFFSET 0x00a00000
DECL|macro|MQ_DSP1_ADDR_OFFSET
mdefine_line|#define MQ_DSP1_ADDR_OFFSET 0x00000008
DECL|macro|MQ_DSP_JUNK_OFFSET
mdefine_line|#define MQ_DSP_JUNK_OFFSET  0x00000400
DECL|macro|MQ_DSP1_DATA_OFFSET
mdefine_line|#define MQ_DSP1_DATA_OFFSET 0x00000000
DECL|macro|MQ_BOARD_ISAC_DSP_RESET
mdefine_line|#define MQ_BOARD_ISAC_DSP_RESET  0x00800028
DECL|macro|MQ_BREG_RISC
mdefine_line|#define MQ_BREG_RISC  0x1200      /* RISC Reset */
DECL|macro|MQ_ISAC_DSP_RESET
mdefine_line|#define MQ_ISAC_DSP_RESET 0x0028 /* ISAC and DSP reset address offset */
DECL|macro|MQ_RISC_COLD_RESET_MASK
mdefine_line|#define MQ_RISC_COLD_RESET_MASK         0x0001      /* RISC Cold reset                        */
DECL|macro|MQ_RISC_WARM_RESET_MASK
mdefine_line|#define MQ_RISC_WARM_RESET_MASK         0x0002      /* RISC Warm reset                        */
DECL|macro|MQ_IRQ_REQ_ON
mdefine_line|#define MQ_IRQ_REQ_ON                   0x1
DECL|macro|MQ_IRQ_REQ_OFF
mdefine_line|#define MQ_IRQ_REQ_OFF                  0x0
DECL|macro|MQ_BREG_IRQ_TEST
mdefine_line|#define MQ_BREG_IRQ_TEST                0x0608
DECL|macro|PLX9054_INTCSR
mdefine_line|#define PLX9054_INTCSR      0x69 
DECL|macro|PLX9054_INT_ENA
mdefine_line|#define PLX9054_INT_ENA     0x09
DECL|macro|DIVAS_IOBASE
mdefine_line|#define DIVAS_IOBASE&t;0x01
DECL|macro|M_PCI_RESET
mdefine_line|#define M_PCI_RESET&t;0x10
id|byte
id|mem_in
c_func
(paren
id|ADAPTER
op_star
id|a
comma
r_void
op_star
id|adr
)paren
suffix:semicolon
id|word
id|mem_inw
c_func
(paren
id|ADAPTER
op_star
id|a
comma
r_void
op_star
id|adr
)paren
suffix:semicolon
r_void
id|mem_in_buffer
c_func
(paren
id|ADAPTER
op_star
id|a
comma
r_void
op_star
id|adr
comma
r_void
op_star
id|P
comma
id|word
id|length
)paren
suffix:semicolon
r_void
id|mem_look_ahead
c_func
(paren
id|ADAPTER
op_star
id|a
comma
id|PBUFFER
op_star
id|RBuffer
comma
id|ENTITY
op_star
id|e
)paren
suffix:semicolon
r_void
id|mem_out
c_func
(paren
id|ADAPTER
op_star
id|a
comma
r_void
op_star
id|adr
comma
id|byte
id|data
)paren
suffix:semicolon
r_void
id|mem_outw
c_func
(paren
id|ADAPTER
op_star
id|a
comma
r_void
op_star
id|adr
comma
id|word
id|data
)paren
suffix:semicolon
r_void
id|mem_out_buffer
c_func
(paren
id|ADAPTER
op_star
id|a
comma
r_void
op_star
id|adr
comma
r_void
op_star
id|P
comma
id|word
id|length
)paren
suffix:semicolon
r_void
id|mem_inc
c_func
(paren
id|ADAPTER
op_star
id|a
comma
r_void
op_star
id|adr
)paren
suffix:semicolon
r_int
id|Divas4BRIInitPCI
c_func
(paren
id|card_t
op_star
id|card
comma
id|dia_card_t
op_star
id|cfg
)paren
suffix:semicolon
r_int
id|fourbri_ISR
(paren
id|card_t
op_star
id|card
)paren
suffix:semicolon
r_int
id|FPGA_Download
c_func
(paren
id|word
comma
id|dword
comma
id|byte
op_star
comma
id|byte
op_star
comma
r_int
)paren
suffix:semicolon
r_extern
id|byte
id|FPGA_Bytes
(braket
)braket
suffix:semicolon
r_extern
r_void
op_star
id|get_card
c_func
(paren
r_int
)paren
suffix:semicolon
id|byte
id|UxCardPortIoIn
c_func
(paren
id|ux_diva_card_t
op_star
id|card
comma
id|byte
op_star
id|base
comma
r_int
id|offset
)paren
suffix:semicolon
r_void
id|UxCardPortIoOut
c_func
(paren
id|ux_diva_card_t
op_star
id|card
comma
id|byte
op_star
id|base
comma
r_int
id|offset
comma
id|byte
)paren
suffix:semicolon
id|word
id|GetProtFeatureValue
c_func
(paren
r_char
op_star
id|sw_id
)paren
suffix:semicolon
r_void
id|memcp
c_func
(paren
id|byte
op_star
id|dst
comma
id|byte
op_star
id|src
comma
id|dword
id|dwLen
)paren
suffix:semicolon
r_int
id|memcm
c_func
(paren
id|byte
op_star
id|dst
comma
id|byte
op_star
id|src
comma
id|dword
id|dwLen
)paren
suffix:semicolon
DECL|function|diva_server_4bri_reset
r_static
r_int
id|diva_server_4bri_reset
c_func
(paren
id|card_t
op_star
id|card
)paren
(brace
id|byte
op_star
id|ctl
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;divas: reset Diva Server 4BRI&quot;
)paren
)paren
suffix:semicolon
id|ctl
op_assign
id|UxCardMemAttach
c_func
(paren
id|card-&gt;hw
comma
id|DIVAS_CTL_MEMORY
)paren
suffix:semicolon
multiline_comment|/* stop RISC, DSP&squot;s and ISAC  */
id|UxCardMemOut
c_func
(paren
id|card-&gt;hw
comma
op_amp
id|ctl
(braket
id|MQ_BREG_RISC
)braket
comma
l_int|0
)paren
suffix:semicolon
id|UxCardMemOut
c_func
(paren
id|card-&gt;hw
comma
op_amp
id|ctl
(braket
id|MQ_ISAC_DSP_RESET
)braket
comma
l_int|0
)paren
suffix:semicolon
id|UxCardMemDetach
c_func
(paren
id|card-&gt;hw
comma
id|ctl
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|diva_server_4bri_config
r_static
r_int
id|diva_server_4bri_config
c_func
(paren
id|card_t
op_star
id|card
comma
id|dia_config_t
op_star
id|config
)paren
(brace
id|byte
op_star
id|shared
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;divas: configure Diva Server 4BRI&quot;
)paren
)paren
suffix:semicolon
id|shared
op_assign
(paren
id|byte
op_star
)paren
id|UxCardMemAttach
c_func
(paren
id|card-&gt;hw
comma
id|DIVAS_SHARED_MEMORY
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_increment
)paren
(brace
id|UxCardMemOut
c_func
(paren
id|card-&gt;hw
comma
op_amp
id|shared
(braket
id|i
)braket
comma
l_int|0
)paren
suffix:semicolon
)brace
id|UxCardMemOut
c_func
(paren
id|card-&gt;hw
comma
op_amp
id|shared
(braket
l_int|8
)braket
comma
id|config-&gt;tei
)paren
suffix:semicolon
id|UxCardMemOut
c_func
(paren
id|card-&gt;hw
comma
op_amp
id|shared
(braket
l_int|9
)braket
comma
id|config-&gt;nt2
)paren
suffix:semicolon
id|UxCardMemOut
c_func
(paren
id|card-&gt;hw
comma
op_amp
id|shared
(braket
l_int|10
)braket
comma
l_int|0
)paren
suffix:semicolon
id|UxCardMemOut
c_func
(paren
id|card-&gt;hw
comma
op_amp
id|shared
(braket
l_int|11
)braket
comma
id|config-&gt;watchdog
)paren
suffix:semicolon
id|UxCardMemOut
c_func
(paren
id|card-&gt;hw
comma
op_amp
id|shared
(braket
l_int|12
)braket
comma
id|config-&gt;permanent
)paren
suffix:semicolon
id|UxCardMemOut
c_func
(paren
id|card-&gt;hw
comma
op_amp
id|shared
(braket
l_int|13
)braket
comma
id|config-&gt;x_interface
)paren
suffix:semicolon
id|UxCardMemOut
c_func
(paren
id|card-&gt;hw
comma
op_amp
id|shared
(braket
l_int|14
)braket
comma
id|config-&gt;stable_l2
)paren
suffix:semicolon
id|UxCardMemOut
c_func
(paren
id|card-&gt;hw
comma
op_amp
id|shared
(braket
l_int|15
)braket
comma
id|config-&gt;no_order_check
)paren
suffix:semicolon
id|UxCardMemOut
c_func
(paren
id|card-&gt;hw
comma
op_amp
id|shared
(braket
l_int|16
)braket
comma
id|config-&gt;handset_type
)paren
suffix:semicolon
id|UxCardMemOut
c_func
(paren
id|card-&gt;hw
comma
op_amp
id|shared
(braket
l_int|17
)braket
comma
l_int|0
)paren
suffix:semicolon
id|UxCardMemOut
c_func
(paren
id|card-&gt;hw
comma
op_amp
id|shared
(braket
l_int|18
)braket
comma
id|config-&gt;low_channel
)paren
suffix:semicolon
id|UxCardMemOut
c_func
(paren
id|card-&gt;hw
comma
op_amp
id|shared
(braket
l_int|19
)braket
comma
id|config-&gt;prot_version
)paren
suffix:semicolon
id|UxCardMemOut
c_func
(paren
id|card-&gt;hw
comma
op_amp
id|shared
(braket
l_int|20
)braket
comma
id|config-&gt;crc4
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|card-&gt;hw-&gt;features
)paren
op_logical_and
(paren
id|card-&gt;hw-&gt;features
op_amp
id|PROTCAP_V90D
)paren
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;divas: Signifying V.90&quot;
)paren
)paren
suffix:semicolon
id|UxCardMemOut
c_func
(paren
id|card-&gt;hw
comma
op_amp
id|shared
(braket
l_int|22
)braket
comma
l_int|4
)paren
suffix:semicolon
)brace
r_else
(brace
id|UxCardMemOut
c_func
(paren
id|card-&gt;hw
comma
op_amp
id|shared
(braket
l_int|22
)braket
comma
l_int|0
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|32
suffix:semicolon
id|j
op_increment
)paren
(brace
id|UxCardMemOut
c_func
(paren
id|card-&gt;hw
comma
op_amp
id|shared
(braket
l_int|32
op_plus
(paren
id|i
op_star
l_int|96
)paren
op_plus
id|j
)braket
comma
id|config-&gt;terminal
(braket
id|i
)braket
dot
id|oad
(braket
id|j
)braket
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|32
suffix:semicolon
id|j
op_increment
)paren
(brace
id|UxCardMemOut
c_func
(paren
id|card-&gt;hw
comma
op_amp
id|shared
(braket
l_int|64
op_plus
(paren
id|i
op_star
l_int|96
)paren
op_plus
id|j
)braket
comma
id|config-&gt;terminal
(braket
id|i
)braket
dot
id|osa
(braket
id|j
)braket
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|32
suffix:semicolon
id|j
op_increment
)paren
(brace
id|UxCardMemOut
c_func
(paren
id|card-&gt;hw
comma
op_amp
id|shared
(braket
l_int|96
op_plus
(paren
id|i
op_star
l_int|96
)paren
op_plus
id|j
)braket
comma
id|config-&gt;terminal
(braket
id|i
)braket
dot
id|spid
(braket
id|j
)braket
)paren
suffix:semicolon
)brace
)brace
id|UxCardMemDetach
c_func
(paren
id|card-&gt;hw
comma
id|shared
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
DECL|function|diva_server_4bri_reset_int
r_void
id|diva_server_4bri_reset_int
c_func
(paren
id|card_t
op_star
id|card
)paren
(brace
id|byte
op_star
id|ctl
suffix:semicolon
id|ctl
op_assign
id|UxCardMemAttach
c_func
(paren
id|card-&gt;hw
comma
id|DIVAS_CTL_MEMORY
)paren
suffix:semicolon
id|UxCardMemOut
c_func
(paren
id|card-&gt;hw
comma
op_amp
id|ctl
(braket
id|MQ_BREG_IRQ_TEST
)braket
comma
id|MQ_IRQ_REQ_OFF
)paren
suffix:semicolon
id|UxCardMemDetach
c_func
(paren
id|card-&gt;hw
comma
id|ctl
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|diva_server_4bri_test_int
r_static
r_int
id|diva_server_4bri_test_int
c_func
(paren
id|card_t
op_star
id|card
)paren
(brace
id|byte
op_star
id|ctl
comma
id|i
suffix:semicolon
id|byte
op_star
id|reg
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;divas: test interrupt for Diva Server 4BRI&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* We get the last (dummy) adapter in so we need to go back to the first */
id|card
op_assign
id|get_card
c_func
(paren
id|card-&gt;cfg.card_id
op_minus
l_int|3
)paren
suffix:semicolon
multiline_comment|/* Enable interrupts on PLX chip */
id|reg
op_assign
id|UxCardMemAttach
c_func
(paren
id|card-&gt;hw
comma
id|DIVAS_REG_MEMORY
)paren
suffix:semicolon
id|UxCardPortIoOut
c_func
(paren
id|card-&gt;hw
comma
id|reg
comma
id|PLX9054_INTCSR
comma
id|PLX9054_INT_ENA
)paren
suffix:semicolon
id|UxCardMemDetach
c_func
(paren
id|card-&gt;hw
comma
id|reg
)paren
suffix:semicolon
multiline_comment|/* Set the test interrupt flag */
id|card-&gt;test_int_pend
op_assign
id|TEST_INT_DIVAS_Q
suffix:semicolon
multiline_comment|/* Now to trigger the interrupt */
id|ctl
op_assign
id|UxCardMemAttach
c_func
(paren
id|card-&gt;hw
comma
id|DIVAS_CTL_MEMORY
)paren
suffix:semicolon
id|UxCardMemOut
c_func
(paren
id|card-&gt;hw
comma
op_amp
id|ctl
(braket
id|MQ_BREG_IRQ_TEST
)braket
comma
id|MQ_IRQ_REQ_ON
)paren
suffix:semicolon
id|UxCardMemDetach
c_func
(paren
id|card-&gt;hw
comma
id|ctl
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|50
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;test_int_pend
)paren
(brace
r_break
suffix:semicolon
)brace
id|UxPause
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;test_int_pend
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;active: timeout waiting for card to interrupt&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|print_hdr
r_static
r_void
id|print_hdr
c_func
(paren
r_int
r_char
op_star
id|code
comma
r_int
id|offset
)paren
(brace
r_int
r_char
id|hdr
(braket
l_int|80
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|i
OL
(paren
id|DIM
c_func
(paren
id|hdr
)paren
op_minus
l_int|1
)paren
)paren
op_logical_and
(paren
id|code
(braket
id|offset
op_plus
id|i
)braket
op_ne
l_char|&squot;&bslash;0&squot;
)paren
op_logical_and
(paren
id|code
(braket
id|offset
op_plus
id|i
)braket
op_ne
l_char|&squot;&bslash;r&squot;
)paren
op_logical_and
(paren
id|code
(braket
id|offset
op_plus
id|i
)braket
op_ne
l_char|&squot;&bslash;n&squot;
)paren
)paren
(brace
id|hdr
(braket
id|i
)braket
op_assign
id|code
(braket
id|offset
op_plus
id|i
)braket
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
id|hdr
(braket
id|i
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;divas: loading %s&quot;
comma
id|hdr
)paren
)paren
suffix:semicolon
)brace
DECL|function|diva_server_4bri_load
r_static
r_int
id|diva_server_4bri_load
c_func
(paren
id|card_t
op_star
id|card
comma
id|dia_load_t
op_star
id|load
)paren
(brace
id|byte
op_star
id|pRAM
op_assign
l_int|NULL
suffix:semicolon
r_int
id|download_offset
op_assign
l_int|0
suffix:semicolon
id|card_t
op_star
id|FirstCard
suffix:semicolon
id|byte
id|sw_id
(braket
l_int|80
)braket
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;divas: loading Diva Server 4BRI[%d]&quot;
comma
id|load-&gt;card_id
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|load-&gt;code_type
)paren
(brace
r_case
id|DIA_CPU_CODE
suffix:colon
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;divas: RISC code&quot;
)paren
)paren
suffix:semicolon
id|print_hdr
c_func
(paren
id|load-&gt;code
comma
l_int|0x80
)paren
suffix:semicolon
id|card-&gt;hw-&gt;features
op_assign
id|GetProtFeatureValue
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|load-&gt;code
(braket
l_int|0x80
)braket
)paren
suffix:semicolon
id|download_offset
op_assign
l_int|0
suffix:semicolon
singleline_comment|// Protocol code written to offset 0
id|pRAM
op_assign
id|UxCardMemAttach
c_func
(paren
id|card-&gt;hw
comma
id|DIVAS_RAM_MEMORY
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DIA_DSP_CODE
suffix:colon
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;divas: DSP code&quot;
)paren
)paren
suffix:semicolon
id|print_hdr
c_func
(paren
id|load-&gt;code
comma
l_int|0x0
)paren
suffix:semicolon
id|FirstCard
op_assign
id|get_card
c_func
(paren
id|load-&gt;card_id
op_minus
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|card-&gt;hw-&gt;features
)paren
op_logical_and
(paren
id|card-&gt;hw-&gt;features
op_amp
id|PROTCAP_V90D
)paren
)paren
(brace
id|download_offset
op_assign
id|MQ_V90D_DSP_CODE_BASE
suffix:semicolon
)brace
r_else
(brace
id|download_offset
op_assign
id|MQ_ORG_DSP_CODE_BASE
suffix:semicolon
)brace
id|pRAM
op_assign
id|UxCardMemAttach
c_func
(paren
id|FirstCard-&gt;hw
comma
id|DIVAS_RAM_MEMORY
)paren
suffix:semicolon
id|download_offset
op_add_assign
(paren
(paren
(paren
r_sizeof
(paren
id|dword
)paren
op_plus
(paren
r_sizeof
(paren
id|t_dsp_download_desc
)paren
op_star
id|DSP_MAX_DOWNLOAD_COUNT
)paren
)paren
op_plus
l_int|3
)paren
op_amp
l_int|0xFFFFFFFC
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DIA_TABLE_CODE
suffix:colon
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;divas: TABLE code&quot;
)paren
)paren
suffix:semicolon
id|FirstCard
op_assign
id|get_card
c_func
(paren
id|load-&gt;card_id
op_minus
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|card-&gt;hw-&gt;features
)paren
op_logical_and
(paren
id|card-&gt;hw-&gt;features
op_amp
id|PROTCAP_V90D
)paren
)paren
(brace
id|download_offset
op_assign
id|MQ_V90D_DSP_CODE_BASE
op_plus
r_sizeof
(paren
id|dword
)paren
suffix:semicolon
)brace
r_else
(brace
id|download_offset
op_assign
id|MQ_ORG_DSP_CODE_BASE
op_plus
r_sizeof
(paren
id|dword
)paren
suffix:semicolon
)brace
id|pRAM
op_assign
id|UxCardMemAttach
c_func
(paren
id|FirstCard-&gt;hw
comma
id|DIVAS_RAM_MEMORY
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DIA_CONT_CODE
suffix:colon
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;divas: continuation code&quot;
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DIA_DLOAD_CNT
suffix:colon
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;divas: COUNT code&quot;
)paren
)paren
suffix:semicolon
id|FirstCard
op_assign
id|get_card
c_func
(paren
id|load-&gt;card_id
op_minus
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|card-&gt;hw-&gt;features
)paren
op_logical_and
(paren
id|card-&gt;hw-&gt;features
op_amp
id|PROTCAP_V90D
)paren
)paren
(brace
id|download_offset
op_assign
id|MQ_V90D_DSP_CODE_BASE
suffix:semicolon
)brace
r_else
(brace
id|download_offset
op_assign
id|MQ_ORG_DSP_CODE_BASE
suffix:semicolon
)brace
id|pRAM
op_assign
id|UxCardMemAttach
c_func
(paren
id|FirstCard-&gt;hw
comma
id|DIVAS_RAM_MEMORY
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DIA_FPGA_CODE
suffix:colon
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;divas: 4BRI FPGA download - %d bytes&quot;
comma
id|load-&gt;length
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|FPGA_Download
c_func
(paren
id|IDI_ADAPTER_MAESTRAQ
comma
id|card-&gt;hw-&gt;io_base
comma
id|sw_id
comma
id|load-&gt;code
comma
id|load-&gt;length
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;divas: FPGA download failed&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* NOW reset the 4BRI */
id|diva_server_4bri_reset
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
singleline_comment|// No need for anything further loading
r_default
suffix:colon
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;divas: unknown code type&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memcp
c_func
(paren
id|pRAM
op_plus
(paren
id|download_offset
op_amp
l_int|0x3FFFFF
)paren
comma
id|load-&gt;code
comma
id|load-&gt;length
)paren
suffix:semicolon
(brace
r_int
id|mism_off
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mism_off
op_assign
id|memcm
c_func
(paren
id|pRAM
op_plus
(paren
id|download_offset
op_amp
l_int|0x3FFFFF
)paren
comma
id|load-&gt;code
comma
id|load-&gt;length
)paren
)paren
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;divas: memory mismatch at offset %d&quot;
comma
id|mism_off
)paren
)paren
suffix:semicolon
id|UxCardMemDetach
c_func
(paren
id|card-&gt;hw
comma
id|pRAM
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
id|UxCardMemDetach
c_func
(paren
id|card-&gt;hw
comma
id|pRAM
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|diva_server_4bri_start
r_static
r_int
id|diva_server_4bri_start
c_func
(paren
id|card_t
op_star
id|card
comma
id|byte
op_star
id|channels
)paren
(brace
id|byte
op_star
id|ctl
suffix:semicolon
id|byte
op_star
id|shared
comma
id|i
suffix:semicolon
r_int
id|adapter_num
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;divas: start Diva Server 4BRI&quot;
)paren
)paren
suffix:semicolon
op_star
id|channels
op_assign
l_int|0
suffix:semicolon
id|card-&gt;is_live
op_assign
id|FALSE
suffix:semicolon
id|ctl
op_assign
id|UxCardMemAttach
c_func
(paren
id|card-&gt;hw
comma
id|DIVAS_CTL_MEMORY
)paren
suffix:semicolon
id|UxCardMemOutW
c_func
(paren
id|card-&gt;hw
comma
op_amp
id|ctl
(braket
id|MQ_BREG_RISC
)braket
comma
id|MQ_RISC_COLD_RESET_MASK
)paren
suffix:semicolon
id|UxPause
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|UxCardMemOutW
c_func
(paren
id|card-&gt;hw
comma
op_amp
id|ctl
(braket
id|MQ_BREG_RISC
)braket
comma
id|MQ_RISC_WARM_RESET_MASK
op_or
id|MQ_RISC_COLD_RESET_MASK
)paren
suffix:semicolon
id|UxPause
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|UxCardMemDetach
c_func
(paren
id|card-&gt;hw
comma
id|ctl
)paren
suffix:semicolon
id|shared
op_assign
(paren
id|byte
op_star
)paren
id|UxCardMemAttach
c_func
(paren
id|card-&gt;hw
comma
id|DIVAS_SHARED_MEMORY
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|300
suffix:semicolon
op_increment
id|i
)paren
(brace
id|UxPause
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|UxCardMemInW
c_func
(paren
id|card-&gt;hw
comma
op_amp
id|shared
(braket
l_int|0x1E
)braket
)paren
op_eq
l_int|0x4447
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;divas: Protocol startup time %d.%02d seconds&quot;
comma
(paren
id|i
op_div
l_int|100
)paren
comma
(paren
id|i
op_mod
l_int|100
)paren
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|300
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;divas: Timeout starting card&quot;
)paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;divas: Signature == 0x%04X&quot;
comma
id|UxCardMemInW
c_func
(paren
id|card-&gt;hw
comma
op_amp
id|shared
(braket
l_int|0x1E
)braket
)paren
)paren
)paren
suffix:semicolon
id|UxCardMemDetach
c_func
(paren
id|card-&gt;hw
comma
id|shared
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|UxCardMemDetach
c_func
(paren
id|card-&gt;hw
comma
id|shared
)paren
suffix:semicolon
r_for
c_loop
(paren
id|adapter_num
op_assign
l_int|3
suffix:semicolon
id|adapter_num
op_ge
l_int|0
suffix:semicolon
id|adapter_num
op_decrement
)paren
(brace
id|card_t
op_star
id|qbri_card
suffix:semicolon
id|qbri_card
op_assign
id|get_card
c_func
(paren
id|card-&gt;cfg.card_id
op_minus
id|adapter_num
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qbri_card
)paren
(brace
id|qbri_card-&gt;is_live
op_assign
id|TRUE
suffix:semicolon
id|shared
op_assign
id|UxCardMemAttach
c_func
(paren
id|qbri_card-&gt;hw
comma
id|DIVAS_SHARED_MEMORY
)paren
suffix:semicolon
op_star
id|channels
op_add_assign
id|UxCardMemIn
c_func
(paren
id|qbri_card-&gt;hw
comma
op_amp
id|shared
(braket
l_int|0x3F6
)braket
)paren
suffix:semicolon
id|UxCardMemDetach
c_func
(paren
id|qbri_card-&gt;hw
comma
id|shared
)paren
suffix:semicolon
)brace
r_else
(brace
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;divas: Couldn&squot;t get card info %d&quot;
comma
id|card-&gt;cfg.card_id
)paren
)paren
suffix:semicolon
)brace
)brace
id|diva_server_4bri_test_int
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
DECL|function|diva_server_4bri_mem_get
r_int
id|diva_server_4bri_mem_get
c_func
(paren
id|card_t
op_star
id|card
comma
id|mem_block_t
op_star
id|mem_block
)paren
(brace
id|byte
op_star
id|a
suffix:semicolon
id|byte
op_star
id|card_addr
suffix:semicolon
id|word
id|length
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|a
op_assign
id|UxCardMemAttach
c_func
(paren
id|card-&gt;hw
comma
id|DIVAS_RAM_MEMORY
)paren
suffix:semicolon
id|card_addr
op_assign
id|a
suffix:semicolon
id|card_addr
op_add_assign
id|mem_block-&gt;addr
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|mem_block-&gt;data
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mem_block-&gt;data
(braket
id|i
)braket
op_assign
id|UxCardMemIn
c_func
(paren
id|card-&gt;hw
comma
id|card_addr
)paren
suffix:semicolon
id|card_addr
op_increment
suffix:semicolon
id|length
op_increment
suffix:semicolon
)brace
id|UxCardMemDetach
c_func
(paren
id|card-&gt;hw
comma
id|a
)paren
suffix:semicolon
r_return
id|length
suffix:semicolon
)brace
multiline_comment|/*&n; * Initialise 4BRI specific entry points&n; */
DECL|function|Divas4BriInit
r_int
id|Divas4BriInit
c_func
(paren
id|card_t
op_star
id|card
comma
id|dia_card_t
op_star
id|cfg
)paren
(brace
singleline_comment|//&t;byte sw_id[80];
singleline_comment|//&t;extern int FPGA_Done;
id|DPRINTF
c_func
(paren
(paren
l_string|&quot;divas: initialise Diva Server 4BRI&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Divas4BRIInitPCI
c_func
(paren
id|card
comma
id|cfg
)paren
op_eq
op_minus
l_int|1
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Need to download the FPGA */
multiline_comment|/*&t;if (!FPGA_Done)&n;&t;{&n;&t;&t;int retVal;&n;&n;&t;&t;retVal=FPGA_Download(IDI_ADAPTER_MAESTRAQ,&n; &t;&t;&t;cfg-&gt;io_base,&n;&t;&t;&t; sw_id,&n;&t;&t;&t; FPGA_Bytes&n;&t;&t;&t;);&n;&t;&t;if(retVal==-1)&n;&t;&t;{&n;&t;&t;&n;&t;&t;&t;DPRINTF((&quot;divas: FPGA Download Failed&quot;));&n;&t;&t;&t;return -1;&n;&n;&t;&t;}&n;&t;&t;FPGA_Done = 1;&n;&t;} */
id|card-&gt;card_reset
op_assign
id|diva_server_4bri_reset
suffix:semicolon
id|card-&gt;card_load
op_assign
id|diva_server_4bri_load
suffix:semicolon
id|card-&gt;card_config
op_assign
id|diva_server_4bri_config
suffix:semicolon
id|card-&gt;card_start
op_assign
id|diva_server_4bri_start
suffix:semicolon
id|card-&gt;reset_int
op_assign
id|diva_server_4bri_reset_int
suffix:semicolon
id|card-&gt;card_mem_get
op_assign
id|diva_server_4bri_mem_get
suffix:semicolon
id|card-&gt;xlog_offset
op_assign
id|DIVAS_MAINT_OFFSET
suffix:semicolon
id|card-&gt;out
op_assign
id|DivasOut
suffix:semicolon
id|card-&gt;test_int
op_assign
id|DivasTestInt
suffix:semicolon
id|card-&gt;dpc
op_assign
id|DivasDpc
suffix:semicolon
id|card-&gt;clear_int
op_assign
id|DivasClearInt
suffix:semicolon
id|card-&gt;card_isr
op_assign
id|fourbri_ISR
suffix:semicolon
id|card-&gt;a.ram_out
op_assign
id|mem_out
suffix:semicolon
id|card-&gt;a.ram_outw
op_assign
id|mem_outw
suffix:semicolon
id|card-&gt;a.ram_out_buffer
op_assign
id|mem_out_buffer
suffix:semicolon
id|card-&gt;a.ram_inc
op_assign
id|mem_inc
suffix:semicolon
id|card-&gt;a.ram_in
op_assign
id|mem_in
suffix:semicolon
id|card-&gt;a.ram_inw
op_assign
id|mem_inw
suffix:semicolon
id|card-&gt;a.ram_in_buffer
op_assign
id|mem_in_buffer
suffix:semicolon
id|card-&gt;a.ram_look_ahead
op_assign
id|mem_look_ahead
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|memcp
r_void
id|memcp
c_func
(paren
id|byte
op_star
id|dst
comma
id|byte
op_star
id|src
comma
id|dword
id|dwLen
)paren
(brace
r_while
c_loop
(paren
id|dwLen
)paren
(brace
op_star
id|dst
op_assign
op_star
id|src
suffix:semicolon
id|dst
op_increment
suffix:semicolon
id|src
op_increment
suffix:semicolon
id|dwLen
op_decrement
suffix:semicolon
)brace
)brace
DECL|function|memcm
r_int
id|memcm
c_func
(paren
id|byte
op_star
id|dst
comma
id|byte
op_star
id|src
comma
id|dword
id|dwLen
)paren
(brace
r_int
id|offset
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|offset
OL
id|dwLen
)paren
(brace
r_if
c_cond
(paren
op_star
id|dst
op_ne
op_star
id|src
)paren
(brace
r_return
(paren
id|offset
op_plus
l_int|1
)paren
suffix:semicolon
)brace
id|offset
op_increment
suffix:semicolon
id|src
op_increment
suffix:semicolon
id|dst
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*int fourbri_ISR (card_t* card) &n;{&n;&t;int served = 0;&n;&t;byte *DivasIOBase = UxCardMemAttach(card-&gt;hw, DIVAS_IOBASE);&n;&t;&n;&n;&t;if (UxCardPortIoIn (card-&gt;hw, DivasIOBase, M_PCI_RESET) &amp; 0x01) &n;&t;{&n;&t;&t;served = 1;&n;&t;&t;card-&gt;int_pend  += 1;&n;&t;&t;DivasDpcSchedule(); &n;&t;&t;UxCardPortIoOut (card-&gt;hw, DivasIOBase, M_PCI_RESET, 0x08);&n;&t;}&n;&n;&t;UxCardMemDetach(card-&gt;hw, DivasIOBase);&n;&n;&t;return (served != 0);&n;}*/
DECL|function|fourbri_ISR
r_int
id|fourbri_ISR
(paren
id|card_t
op_star
id|card
)paren
(brace
r_int
id|served
op_assign
l_int|0
suffix:semicolon
id|byte
op_star
id|ctl
suffix:semicolon
id|byte
op_star
id|reg
op_assign
id|UxCardMemAttach
c_func
(paren
id|card-&gt;hw
comma
id|DIVAS_REG_MEMORY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|UxCardPortIoIn
c_func
(paren
id|card-&gt;hw
comma
id|reg
comma
id|PLX9054_INTCSR
)paren
op_amp
l_int|0x80
)paren
(brace
id|served
op_assign
l_int|1
suffix:semicolon
id|card-&gt;int_pend
op_add_assign
l_int|1
suffix:semicolon
id|DivasDpcSchedule
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* ISR DPC */
id|ctl
op_assign
id|UxCardMemAttach
c_func
(paren
id|card-&gt;hw
comma
id|DIVAS_CTL_MEMORY
)paren
suffix:semicolon
id|UxCardMemOut
c_func
(paren
id|card-&gt;hw
comma
op_amp
id|ctl
(braket
id|MQ_BREG_IRQ_TEST
)braket
comma
id|MQ_IRQ_REQ_OFF
)paren
suffix:semicolon
id|UxCardMemDetach
c_func
(paren
id|card-&gt;hw
comma
id|ctl
)paren
suffix:semicolon
)brace
id|UxCardMemDetach
c_func
(paren
id|card-&gt;hw
comma
id|reg
)paren
suffix:semicolon
r_return
(paren
id|served
op_ne
l_int|0
)paren
suffix:semicolon
)brace
eof
