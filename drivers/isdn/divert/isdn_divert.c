multiline_comment|/* &n; * $Id: isdn_divert.c,v 1.6 2000/11/13 22:51:47 kai Exp $&n; *&n; * DSS1 main diversion supplementary handling for i4l.&n; *&n; * Copyright 1999       by Werner Cornelius (werner@isdn4linux.de)&n; * &n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA. &n; *&n; */
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &quot;isdn_divert.h&quot;
multiline_comment|/**********************************/
multiline_comment|/* structure keeping calling info */
multiline_comment|/**********************************/
DECL|struct|call_struc
r_struct
id|call_struc
DECL|member|ics
(brace
id|isdn_ctrl
id|ics
suffix:semicolon
multiline_comment|/* delivered setup + driver parameters */
DECL|member|divert_id
id|ulong
id|divert_id
suffix:semicolon
multiline_comment|/* Id delivered to user */
DECL|member|akt_state
r_int
r_char
id|akt_state
suffix:semicolon
multiline_comment|/* actual state */
DECL|member|deflect_dest
r_char
id|deflect_dest
(braket
l_int|35
)braket
suffix:semicolon
multiline_comment|/* deflection destination */
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
multiline_comment|/* timer control structure */
DECL|member|info
r_char
id|info
(braket
l_int|90
)braket
suffix:semicolon
multiline_comment|/* device info output */
DECL|member|next
r_struct
id|call_struc
op_star
id|next
suffix:semicolon
multiline_comment|/* pointer to next entry */
DECL|member|prev
r_struct
id|call_struc
op_star
id|prev
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/********************************************/
multiline_comment|/* structure keeping deflection table entry */
multiline_comment|/********************************************/
DECL|struct|deflect_struc
r_struct
id|deflect_struc
DECL|member|next
DECL|member|prev
(brace
r_struct
id|deflect_struc
op_star
id|next
comma
op_star
id|prev
suffix:semicolon
DECL|member|rule
id|divert_rule
id|rule
suffix:semicolon
multiline_comment|/* used rule */
)brace
suffix:semicolon
multiline_comment|/*****************************************/
multiline_comment|/* variables for main diversion services */
multiline_comment|/*****************************************/
multiline_comment|/* diversion/deflection processes */
DECL|variable|divert_head
r_static
r_struct
id|call_struc
op_star
id|divert_head
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* head of remembered entrys */
DECL|variable|next_id
r_static
id|ulong
id|next_id
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* next info id */
DECL|variable|table_head
r_static
r_struct
id|deflect_struc
op_star
id|table_head
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|table_tail
r_static
r_struct
id|deflect_struc
op_star
id|table_tail
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|extern_wait_max
r_static
r_int
r_char
id|extern_wait_max
op_assign
l_int|4
suffix:semicolon
multiline_comment|/* maximum wait in s for external process */
multiline_comment|/***************************/
multiline_comment|/* timer callback function */
multiline_comment|/***************************/
DECL|function|deflect_timer_expire
r_static
r_void
id|deflect_timer_expire
c_func
(paren
id|ulong
id|arg
)paren
(brace
r_int
id|flags
suffix:semicolon
r_struct
id|call_struc
op_star
id|cs
op_assign
(paren
r_struct
id|call_struc
op_star
)paren
id|arg
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|cs-&gt;timer
)paren
suffix:semicolon
multiline_comment|/* delete active timer */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cs-&gt;akt_state
)paren
(brace
r_case
id|DEFLECT_PROCEED
suffix:colon
id|cs-&gt;ics.command
op_assign
id|ISDN_CMD_HANGUP
suffix:semicolon
multiline_comment|/* cancel action */
id|divert_if
dot
id|ll_cmd
c_func
(paren
op_amp
id|cs-&gt;ics
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|cs-&gt;akt_state
op_assign
id|DEFLECT_AUTODEL
suffix:semicolon
multiline_comment|/* delete after timeout */
id|cs-&gt;timer.expires
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_star
id|AUTODEL_TIME
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|cs-&gt;timer
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DEFLECT_ALERT
suffix:colon
id|cs-&gt;ics.command
op_assign
id|ISDN_CMD_REDIR
suffix:semicolon
multiline_comment|/* protocol */
id|strcpy
c_func
(paren
id|cs-&gt;ics.parm.setup.phone
comma
id|cs-&gt;deflect_dest
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|cs-&gt;ics.parm.setup.eazmsn
comma
l_string|&quot;Testtext delayed&quot;
)paren
suffix:semicolon
id|divert_if
dot
id|ll_cmd
c_func
(paren
op_amp
id|cs-&gt;ics
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|cs-&gt;akt_state
op_assign
id|DEFLECT_AUTODEL
suffix:semicolon
multiline_comment|/* delete after timeout */
id|cs-&gt;timer.expires
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_star
id|AUTODEL_TIME
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|cs-&gt;timer
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DEFLECT_AUTODEL
suffix:colon
r_default
suffix:colon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;prev
)paren
id|cs-&gt;prev-&gt;next
op_assign
id|cs-&gt;next
suffix:semicolon
multiline_comment|/* forward link */
r_else
id|divert_head
op_assign
id|cs-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;next
)paren
id|cs-&gt;next-&gt;prev
op_assign
id|cs-&gt;prev
suffix:semicolon
multiline_comment|/* back link */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|cs
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* switch */
)brace
multiline_comment|/* deflect_timer_func */
multiline_comment|/*****************************************/
multiline_comment|/* handle call forwarding de/activations */
multiline_comment|/* 0 = deact, 1 = act, 2 = interrogate   */
multiline_comment|/*****************************************/
DECL|function|cf_command
r_int
id|cf_command
c_func
(paren
r_int
id|drvid
comma
r_int
id|mode
comma
id|u_char
id|proc
comma
r_char
op_star
id|msn
comma
id|u_char
id|service
comma
r_char
op_star
id|fwd_nr
comma
id|ulong
op_star
id|procid
)paren
(brace
r_int
id|retval
comma
id|msnlen
comma
id|flags
suffix:semicolon
r_int
id|fwd_len
suffix:semicolon
r_char
op_star
id|p
comma
op_star
id|ielenp
comma
id|tmp
(braket
l_int|60
)braket
suffix:semicolon
r_struct
id|call_struc
op_star
id|cs
suffix:semicolon
r_if
c_cond
(paren
id|strchr
c_func
(paren
id|msn
comma
l_char|&squot;.&squot;
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* subaddress not allowed in msn */
r_if
c_cond
(paren
(paren
id|proc
op_amp
l_int|0x7F
)paren
OG
l_int|2
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|proc
op_and_assign
l_int|3
suffix:semicolon
id|p
op_assign
id|tmp
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|0x30
suffix:semicolon
multiline_comment|/* enumeration */
id|ielenp
op_assign
id|p
op_increment
suffix:semicolon
multiline_comment|/* remember total length position */
op_star
id|p
op_increment
op_assign
l_int|0xa
suffix:semicolon
multiline_comment|/* proc tag */
op_star
id|p
op_increment
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* length */
op_star
id|p
op_increment
op_assign
id|proc
op_amp
l_int|0x7F
suffix:semicolon
multiline_comment|/* procedure to de/activate/interrogate */
op_star
id|p
op_increment
op_assign
l_int|0xa
suffix:semicolon
multiline_comment|/* service tag */
op_star
id|p
op_increment
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* length */
op_star
id|p
op_increment
op_assign
id|service
suffix:semicolon
multiline_comment|/* service to handle */
r_if
c_cond
(paren
id|mode
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_star
id|fwd_nr
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* destination missing */
r_if
c_cond
(paren
id|strchr
c_func
(paren
id|fwd_nr
comma
l_char|&squot;.&squot;
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* subaddress not allowed */
id|fwd_len
op_assign
id|strlen
c_func
(paren
id|fwd_nr
)paren
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|0x30
suffix:semicolon
multiline_comment|/* number enumeration */
op_star
id|p
op_increment
op_assign
id|fwd_len
op_plus
l_int|2
suffix:semicolon
multiline_comment|/* complete forward to len */
op_star
id|p
op_increment
op_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* fwd to nr */
op_star
id|p
op_increment
op_assign
id|fwd_len
suffix:semicolon
multiline_comment|/* length of number */
id|strcpy
c_func
(paren
id|p
comma
id|fwd_nr
)paren
suffix:semicolon
multiline_comment|/* copy number */
id|p
op_add_assign
id|fwd_len
suffix:semicolon
multiline_comment|/* pointer beyond fwd */
)brace
multiline_comment|/* activate */
id|msnlen
op_assign
id|strlen
c_func
(paren
id|msn
)paren
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* msn number */
r_if
c_cond
(paren
id|msnlen
OG
l_int|1
)paren
(brace
op_star
id|p
op_increment
op_assign
id|msnlen
suffix:semicolon
multiline_comment|/* length */
id|strcpy
c_func
(paren
id|p
comma
id|msn
)paren
suffix:semicolon
id|p
op_add_assign
id|msnlen
suffix:semicolon
)brace
r_else
op_star
id|p
op_increment
op_assign
l_int|0
suffix:semicolon
op_star
id|ielenp
op_assign
id|p
op_minus
id|ielenp
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* set total IE length */
multiline_comment|/* allocate mem for information struct */
r_if
c_cond
(paren
op_logical_neg
(paren
id|cs
op_assign
(paren
r_struct
id|call_struc
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|call_struc
)paren
comma
id|GFP_ATOMIC
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* no memory */
id|init_timer
c_func
(paren
op_amp
id|cs-&gt;timer
)paren
suffix:semicolon
id|cs-&gt;info
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|cs-&gt;timer.function
op_assign
id|deflect_timer_expire
suffix:semicolon
id|cs-&gt;timer.data
op_assign
(paren
id|ulong
)paren
id|cs
suffix:semicolon
multiline_comment|/* pointer to own structure */
id|cs-&gt;ics.driver
op_assign
id|drvid
suffix:semicolon
id|cs-&gt;ics.command
op_assign
id|ISDN_CMD_PROT_IO
suffix:semicolon
multiline_comment|/* protocol specific io */
id|cs-&gt;ics.arg
op_assign
id|DSS1_CMD_INVOKE
suffix:semicolon
multiline_comment|/* invoke supplementary service */
id|cs-&gt;ics.parm.dss1_io.proc
op_assign
(paren
id|mode
op_eq
l_int|1
)paren
ques
c_cond
l_int|7
suffix:colon
(paren
id|mode
op_eq
l_int|2
)paren
ques
c_cond
l_int|11
suffix:colon
l_int|8
suffix:semicolon
multiline_comment|/* operation */
id|cs-&gt;ics.parm.dss1_io.timeout
op_assign
l_int|4000
suffix:semicolon
multiline_comment|/* from ETS 300 207-1 */
id|cs-&gt;ics.parm.dss1_io.datalen
op_assign
id|p
op_minus
id|tmp
suffix:semicolon
multiline_comment|/* total len */
id|cs-&gt;ics.parm.dss1_io.data
op_assign
id|tmp
suffix:semicolon
multiline_comment|/* start of buffer */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|cs-&gt;ics.parm.dss1_io.ll_id
op_assign
id|next_id
op_increment
suffix:semicolon
multiline_comment|/* id for callback */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
op_star
id|procid
op_assign
id|cs-&gt;ics.parm.dss1_io.ll_id
suffix:semicolon
id|sprintf
c_func
(paren
id|cs-&gt;info
comma
l_string|&quot;%d 0x%lx %s%s 0 %s %0x %d%s%s&bslash;n&quot;
comma
(paren
op_logical_neg
id|mode
)paren
ques
c_cond
id|DIVERT_DEACTIVATE
suffix:colon
(paren
id|mode
op_eq
l_int|1
)paren
ques
c_cond
id|DIVERT_ACTIVATE
suffix:colon
id|DIVERT_REPORT
comma
id|cs-&gt;ics.parm.dss1_io.ll_id
comma
(paren
id|mode
op_ne
l_int|2
)paren
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;0 &quot;
comma
id|divert_if
dot
id|drv_to_name
c_func
(paren
id|cs-&gt;ics.driver
)paren
comma
id|msn
comma
id|service
op_amp
l_int|0xFF
comma
id|proc
comma
(paren
id|mode
op_ne
l_int|1
)paren
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot; 0 &quot;
comma
(paren
id|mode
op_ne
l_int|1
)paren
ques
c_cond
l_string|&quot;&quot;
suffix:colon
id|fwd_nr
)paren
suffix:semicolon
id|retval
op_assign
id|divert_if
dot
id|ll_cmd
c_func
(paren
op_amp
id|cs-&gt;ics
)paren
suffix:semicolon
multiline_comment|/* excute command */
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
id|cs-&gt;prev
op_assign
l_int|NULL
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|cs-&gt;next
op_assign
id|divert_head
suffix:semicolon
id|divert_head
op_assign
id|cs
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_else
id|kfree
c_func
(paren
id|cs
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* cf_command */
multiline_comment|/****************************************/
multiline_comment|/* handle a external deflection command */
multiline_comment|/****************************************/
DECL|function|deflect_extern_action
r_int
id|deflect_extern_action
c_func
(paren
id|u_char
id|cmd
comma
id|ulong
id|callid
comma
r_char
op_star
id|to_nr
)paren
(brace
r_struct
id|call_struc
op_star
id|cs
suffix:semicolon
id|isdn_ctrl
id|ic
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cmd
op_amp
l_int|0x7F
)paren
OG
l_int|2
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* invalid command */
id|cs
op_assign
id|divert_head
suffix:semicolon
multiline_comment|/* start of parameter list */
r_while
c_loop
(paren
id|cs
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;divert_id
op_eq
id|callid
)paren
r_break
suffix:semicolon
multiline_comment|/* found */
id|cs
op_assign
id|cs-&gt;next
suffix:semicolon
)brace
multiline_comment|/* search entry */
r_if
c_cond
(paren
op_logical_neg
id|cs
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* invalid callid */
id|ic.driver
op_assign
id|cs-&gt;ics.driver
suffix:semicolon
id|ic.arg
op_assign
id|cs-&gt;ics.arg
suffix:semicolon
id|i
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;akt_state
op_eq
id|DEFLECT_AUTODEL
)paren
r_return
id|i
suffix:semicolon
multiline_comment|/* no valid call */
r_switch
c_cond
(paren
id|cmd
op_amp
l_int|0x7F
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* hangup */
id|del_timer
c_func
(paren
op_amp
id|cs-&gt;timer
)paren
suffix:semicolon
id|ic.command
op_assign
id|ISDN_CMD_HANGUP
suffix:semicolon
id|i
op_assign
id|divert_if
dot
id|ll_cmd
c_func
(paren
op_amp
id|ic
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|cs-&gt;akt_state
op_assign
id|DEFLECT_AUTODEL
suffix:semicolon
multiline_comment|/* delete after timeout */
id|cs-&gt;timer.expires
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_star
id|AUTODEL_TIME
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|cs-&gt;timer
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* alert */
r_if
c_cond
(paren
id|cs-&gt;akt_state
op_eq
id|DEFLECT_ALERT
)paren
r_return
l_int|0
suffix:semicolon
id|cmd
op_and_assign
l_int|0x7F
suffix:semicolon
multiline_comment|/* never wait */
id|del_timer
c_func
(paren
op_amp
id|cs-&gt;timer
)paren
suffix:semicolon
id|ic.command
op_assign
id|ISDN_CMD_ALERT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|divert_if
dot
id|ll_cmd
c_func
(paren
op_amp
id|ic
)paren
)paren
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|cs-&gt;akt_state
op_assign
id|DEFLECT_AUTODEL
suffix:semicolon
multiline_comment|/* delete after timeout */
id|cs-&gt;timer.expires
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_star
id|AUTODEL_TIME
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|cs-&gt;timer
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_else
id|cs-&gt;akt_state
op_assign
id|DEFLECT_ALERT
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* redir */
id|del_timer
c_func
(paren
op_amp
id|cs-&gt;timer
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|cs-&gt;ics.parm.setup.phone
comma
id|to_nr
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|cs-&gt;ics.parm.setup.eazmsn
comma
l_string|&quot;Testtext manual&quot;
)paren
suffix:semicolon
id|ic.command
op_assign
id|ISDN_CMD_REDIR
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|divert_if
dot
id|ll_cmd
c_func
(paren
op_amp
id|ic
)paren
)paren
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|cs-&gt;akt_state
op_assign
id|DEFLECT_AUTODEL
suffix:semicolon
multiline_comment|/* delete after timeout */
id|cs-&gt;timer.expires
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_star
id|AUTODEL_TIME
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|cs-&gt;timer
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_else
id|cs-&gt;akt_state
op_assign
id|DEFLECT_ALERT
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* switch */
r_return
id|i
suffix:semicolon
)brace
multiline_comment|/* deflect_extern_action */
multiline_comment|/********************************/
multiline_comment|/* insert a new rule before idx */
multiline_comment|/********************************/
DECL|function|insertrule
r_int
id|insertrule
c_func
(paren
r_int
id|idx
comma
id|divert_rule
op_star
id|newrule
)paren
(brace
r_struct
id|deflect_struc
op_star
id|ds
comma
op_star
id|ds1
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ds
op_assign
(paren
r_struct
id|deflect_struc
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|deflect_struc
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* no memory */
id|ds-&gt;rule
op_assign
op_star
id|newrule
suffix:semicolon
multiline_comment|/* set rule */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idx
op_ge
l_int|0
)paren
(brace
id|ds1
op_assign
id|table_head
suffix:semicolon
r_while
c_loop
(paren
(paren
id|ds1
)paren
op_logical_and
(paren
id|idx
OG
l_int|0
)paren
)paren
(brace
id|idx
op_decrement
suffix:semicolon
id|ds1
op_assign
id|ds1-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ds1
)paren
id|idx
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|idx
OL
l_int|0
)paren
(brace
id|ds-&gt;prev
op_assign
id|table_tail
suffix:semicolon
multiline_comment|/* previous entry */
id|ds-&gt;next
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* end of chain */
r_if
c_cond
(paren
id|ds-&gt;prev
)paren
id|ds-&gt;prev-&gt;next
op_assign
id|ds
suffix:semicolon
multiline_comment|/* last forward */
r_else
id|table_head
op_assign
id|ds
suffix:semicolon
multiline_comment|/* is first entry */
id|table_tail
op_assign
id|ds
suffix:semicolon
multiline_comment|/* end of queue */
)brace
r_else
(brace
id|ds-&gt;next
op_assign
id|ds1
suffix:semicolon
multiline_comment|/* next entry */
id|ds-&gt;prev
op_assign
id|ds1-&gt;prev
suffix:semicolon
multiline_comment|/* prev entry */
id|ds1-&gt;prev
op_assign
id|ds
suffix:semicolon
multiline_comment|/* backward chain old element */
r_if
c_cond
(paren
op_logical_neg
id|ds-&gt;prev
)paren
id|table_head
op_assign
id|ds
suffix:semicolon
multiline_comment|/* first element */
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* insertrule */
multiline_comment|/***********************************/
multiline_comment|/* delete the rule at position idx */
multiline_comment|/***********************************/
DECL|function|deleterule
r_int
id|deleterule
c_func
(paren
r_int
id|idx
)paren
(brace
r_struct
id|deflect_struc
op_star
id|ds
comma
op_star
id|ds1
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|idx
OL
l_int|0
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|ds
op_assign
id|table_head
suffix:semicolon
id|table_head
op_assign
l_int|NULL
suffix:semicolon
id|table_tail
op_assign
l_int|NULL
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|ds
)paren
(brace
id|ds1
op_assign
id|ds
suffix:semicolon
id|ds
op_assign
id|ds-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|ds1
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|ds
op_assign
id|table_head
suffix:semicolon
r_while
c_loop
(paren
(paren
id|ds
)paren
op_logical_and
(paren
id|idx
OG
l_int|0
)paren
)paren
(brace
id|idx
op_decrement
suffix:semicolon
id|ds
op_assign
id|ds-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ds
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ds-&gt;next
)paren
id|ds-&gt;next-&gt;prev
op_assign
id|ds-&gt;prev
suffix:semicolon
multiline_comment|/* backward chain */
r_else
id|table_tail
op_assign
id|ds-&gt;prev
suffix:semicolon
multiline_comment|/* end of chain */
r_if
c_cond
(paren
id|ds-&gt;prev
)paren
id|ds-&gt;prev-&gt;next
op_assign
id|ds-&gt;next
suffix:semicolon
multiline_comment|/* forward chain */
r_else
id|table_head
op_assign
id|ds-&gt;next
suffix:semicolon
multiline_comment|/* start of chain */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ds
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* deleterule */
multiline_comment|/*******************************************/
multiline_comment|/* get a pointer to a specific rule number */
multiline_comment|/*******************************************/
DECL|function|getruleptr
id|divert_rule
op_star
id|getruleptr
c_func
(paren
r_int
id|idx
)paren
(brace
r_struct
id|deflect_struc
op_star
id|ds
op_assign
id|table_head
suffix:semicolon
r_if
c_cond
(paren
id|idx
OL
l_int|0
)paren
r_return
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
(paren
id|ds
)paren
op_logical_and
(paren
id|idx
op_ge
l_int|0
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|idx
op_decrement
)paren
)paren
(brace
r_return
op_amp
id|ds-&gt;rule
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ds
op_assign
id|ds-&gt;next
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* getruleptr */
multiline_comment|/*************************************************/
multiline_comment|/* called from common module on an incoming call */
multiline_comment|/*************************************************/
DECL|function|isdn_divert_icall
r_int
id|isdn_divert_icall
c_func
(paren
id|isdn_ctrl
op_star
id|ic
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_struct
id|call_struc
op_star
id|cs
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|deflect_struc
op_star
id|dv
suffix:semicolon
r_char
op_star
id|p
comma
op_star
id|p1
suffix:semicolon
id|u_char
id|accept
suffix:semicolon
multiline_comment|/* first check the internal deflection table */
r_for
c_loop
(paren
id|dv
op_assign
id|table_head
suffix:semicolon
id|dv
suffix:semicolon
id|dv
op_assign
id|dv-&gt;next
)paren
(brace
multiline_comment|/* scan table */
r_if
c_cond
(paren
(paren
(paren
id|dv-&gt;rule.callopt
op_eq
l_int|1
)paren
op_logical_and
(paren
id|ic-&gt;command
op_eq
id|ISDN_STAT_ICALLW
)paren
)paren
op_logical_or
(paren
(paren
id|dv-&gt;rule.callopt
op_eq
l_int|2
)paren
op_logical_and
(paren
id|ic-&gt;command
op_eq
id|ISDN_STAT_ICALL
)paren
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* call option check */
r_if
c_cond
(paren
op_logical_neg
(paren
id|dv-&gt;rule.drvid
op_amp
(paren
l_int|1L
op_lshift
id|ic-&gt;driver
)paren
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* driver not matching */
r_if
c_cond
(paren
(paren
id|dv-&gt;rule.si1
)paren
op_logical_and
(paren
id|dv-&gt;rule.si1
op_ne
id|ic-&gt;parm.setup.si1
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* si1 not matching */
r_if
c_cond
(paren
(paren
id|dv-&gt;rule.si2
)paren
op_logical_and
(paren
id|dv-&gt;rule.si2
op_ne
id|ic-&gt;parm.setup.si2
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* si2 not matching */
id|p
op_assign
id|dv-&gt;rule.my_msn
suffix:semicolon
id|p1
op_assign
id|ic-&gt;parm.setup.eazmsn
suffix:semicolon
id|accept
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_star
id|p
)paren
(brace
multiline_comment|/* complete compare */
r_if
c_cond
(paren
op_star
id|p
op_eq
l_char|&squot;-&squot;
)paren
(brace
id|accept
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* call accepted */
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|p
op_increment
op_ne
op_star
id|p1
op_increment
)paren
r_break
suffix:semicolon
multiline_comment|/* not accepted */
r_if
c_cond
(paren
(paren
op_logical_neg
op_star
id|p
)paren
op_logical_and
(paren
op_logical_neg
op_star
id|p1
)paren
)paren
id|accept
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* complete compare */
r_if
c_cond
(paren
op_logical_neg
id|accept
)paren
r_continue
suffix:semicolon
multiline_comment|/* not accepted */
r_if
c_cond
(paren
(paren
id|strcmp
c_func
(paren
id|dv-&gt;rule.caller
comma
l_string|&quot;0&quot;
)paren
)paren
op_logical_or
(paren
id|ic-&gt;parm.setup.phone
(braket
l_int|0
)braket
)paren
)paren
(brace
id|p
op_assign
id|dv-&gt;rule.caller
suffix:semicolon
id|p1
op_assign
id|ic-&gt;parm.setup.phone
suffix:semicolon
id|accept
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_star
id|p
)paren
(brace
multiline_comment|/* complete compare */
r_if
c_cond
(paren
op_star
id|p
op_eq
l_char|&squot;-&squot;
)paren
(brace
id|accept
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* call accepted */
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|p
op_increment
op_ne
op_star
id|p1
op_increment
)paren
r_break
suffix:semicolon
multiline_comment|/* not accepted */
r_if
c_cond
(paren
(paren
op_logical_neg
op_star
id|p
)paren
op_logical_and
(paren
op_logical_neg
op_star
id|p1
)paren
)paren
id|accept
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* complete compare */
r_if
c_cond
(paren
op_logical_neg
id|accept
)paren
r_continue
suffix:semicolon
multiline_comment|/* not accepted */
)brace
r_switch
c_cond
(paren
id|dv-&gt;rule.action
)paren
(brace
r_case
id|DEFLECT_IGNORE
suffix:colon
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DEFLECT_ALERT
suffix:colon
r_case
id|DEFLECT_PROCEED
suffix:colon
r_case
id|DEFLECT_REPORT
suffix:colon
r_case
id|DEFLECT_REJECT
suffix:colon
r_if
c_cond
(paren
id|dv-&gt;rule.action
op_eq
id|DEFLECT_PROCEED
)paren
r_if
c_cond
(paren
(paren
op_logical_neg
id|if_used
)paren
op_logical_or
(paren
(paren
op_logical_neg
id|extern_wait_max
)paren
op_logical_and
(paren
op_logical_neg
id|dv-&gt;rule.waittime
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* no external deflection needed */
r_if
c_cond
(paren
op_logical_neg
(paren
id|cs
op_assign
(paren
r_struct
id|call_struc
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|call_struc
)paren
comma
id|GFP_ATOMIC
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* no memory */
id|init_timer
c_func
(paren
op_amp
id|cs-&gt;timer
)paren
suffix:semicolon
id|cs-&gt;info
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|cs-&gt;timer.function
op_assign
id|deflect_timer_expire
suffix:semicolon
id|cs-&gt;timer.data
op_assign
(paren
id|ulong
)paren
id|cs
suffix:semicolon
multiline_comment|/* pointer to own structure */
id|cs-&gt;ics
op_assign
op_star
id|ic
suffix:semicolon
multiline_comment|/* copy incoming data */
r_if
c_cond
(paren
op_logical_neg
id|cs-&gt;ics.parm.setup.phone
(braket
l_int|0
)braket
)paren
id|strcpy
c_func
(paren
id|cs-&gt;ics.parm.setup.phone
comma
l_string|&quot;0&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cs-&gt;ics.parm.setup.eazmsn
(braket
l_int|0
)braket
)paren
id|strcpy
c_func
(paren
id|cs-&gt;ics.parm.setup.eazmsn
comma
l_string|&quot;0&quot;
)paren
suffix:semicolon
id|cs-&gt;ics.parm.setup.screen
op_assign
id|dv-&gt;rule.screen
suffix:semicolon
r_if
c_cond
(paren
id|dv-&gt;rule.waittime
)paren
id|cs-&gt;timer.expires
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_star
id|dv-&gt;rule.waittime
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|dv-&gt;rule.action
op_eq
id|DEFLECT_PROCEED
)paren
id|cs-&gt;timer.expires
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_star
id|extern_wait_max
)paren
suffix:semicolon
r_else
id|cs-&gt;timer.expires
op_assign
l_int|0
suffix:semicolon
id|cs-&gt;akt_state
op_assign
id|dv-&gt;rule.action
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|cs-&gt;divert_id
op_assign
id|next_id
op_increment
suffix:semicolon
multiline_comment|/* new sequence number */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cs-&gt;prev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;akt_state
op_eq
id|DEFLECT_ALERT
)paren
(brace
id|strcpy
c_func
(paren
id|cs-&gt;deflect_dest
comma
id|dv-&gt;rule.to_nr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cs-&gt;timer.expires
)paren
(brace
id|strcpy
c_func
(paren
id|ic-&gt;parm.setup.eazmsn
comma
l_string|&quot;Testtext direct&quot;
)paren
suffix:semicolon
id|ic-&gt;parm.setup.screen
op_assign
id|dv-&gt;rule.screen
suffix:semicolon
id|strcpy
c_func
(paren
id|ic-&gt;parm.setup.phone
comma
id|dv-&gt;rule.to_nr
)paren
suffix:semicolon
id|cs-&gt;akt_state
op_assign
id|DEFLECT_AUTODEL
suffix:semicolon
multiline_comment|/* delete after timeout */
id|cs-&gt;timer.expires
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_star
id|AUTODEL_TIME
)paren
suffix:semicolon
id|retval
op_assign
l_int|5
suffix:semicolon
)brace
r_else
id|retval
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* alerting */
)brace
r_else
(brace
id|cs-&gt;deflect_dest
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|retval
op_assign
l_int|4
suffix:semicolon
multiline_comment|/* only proceed */
)brace
id|sprintf
c_func
(paren
id|cs-&gt;info
comma
l_string|&quot;%d 0x%lx %s %s %s %s 0x%x 0x%x %d %d %s&bslash;n&quot;
comma
id|cs-&gt;akt_state
comma
id|cs-&gt;divert_id
comma
id|divert_if
dot
id|drv_to_name
c_func
(paren
id|cs-&gt;ics.driver
)paren
comma
(paren
id|ic-&gt;command
op_eq
id|ISDN_STAT_ICALLW
)paren
ques
c_cond
l_string|&quot;1&quot;
suffix:colon
l_string|&quot;0&quot;
comma
id|cs-&gt;ics.parm.setup.phone
comma
id|cs-&gt;ics.parm.setup.eazmsn
comma
id|cs-&gt;ics.parm.setup.si1
comma
id|cs-&gt;ics.parm.setup.si2
comma
id|cs-&gt;ics.parm.setup.screen
comma
id|dv-&gt;rule.waittime
comma
id|cs-&gt;deflect_dest
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dv-&gt;rule.action
op_eq
id|DEFLECT_REPORT
)paren
op_logical_or
(paren
id|dv-&gt;rule.action
op_eq
id|DEFLECT_REJECT
)paren
)paren
(brace
id|put_info_buffer
c_func
(paren
id|cs-&gt;info
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|cs
)paren
suffix:semicolon
multiline_comment|/* remove */
r_return
(paren
id|dv-&gt;rule.action
op_eq
id|DEFLECT_REPORT
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|2
suffix:semicolon
multiline_comment|/* nothing to do */
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* ignore call */
r_break
suffix:semicolon
)brace
multiline_comment|/* switch action */
r_break
suffix:semicolon
)brace
multiline_comment|/* scan_table */
r_if
c_cond
(paren
id|cs
)paren
(brace
id|cs-&gt;prev
op_assign
l_int|NULL
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|cs-&gt;next
op_assign
id|divert_head
suffix:semicolon
id|divert_head
op_assign
id|cs
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;timer.expires
)paren
id|add_timer
c_func
(paren
op_amp
id|cs-&gt;timer
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|put_info_buffer
c_func
(paren
id|cs-&gt;info
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_else
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* isdn_divert_icall */
DECL|function|deleteprocs
r_void
id|deleteprocs
c_func
(paren
r_void
)paren
(brace
r_struct
id|call_struc
op_star
id|cs
comma
op_star
id|cs1
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|cs
op_assign
id|divert_head
suffix:semicolon
id|divert_head
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
id|cs
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|cs-&gt;timer
)paren
suffix:semicolon
id|cs1
op_assign
id|cs
suffix:semicolon
id|cs
op_assign
id|cs-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|cs1
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* deleteprocs */
multiline_comment|/****************************************************/
multiline_comment|/* put a address including address type into buffer */
multiline_comment|/****************************************************/
DECL|function|put_address
r_int
id|put_address
c_func
(paren
r_char
op_star
id|st
comma
id|u_char
op_star
id|p
comma
r_int
id|len
)paren
(brace
id|u_char
id|retval
op_assign
l_int|0
suffix:semicolon
id|u_char
id|adr_typ
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* network standard */
r_if
c_cond
(paren
id|len
OL
l_int|2
)paren
r_return
id|retval
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
op_eq
l_int|0xA1
)paren
(brace
id|retval
op_assign
op_star
(paren
op_increment
id|p
)paren
op_plus
l_int|2
suffix:semicolon
multiline_comment|/* total length */
r_if
c_cond
(paren
id|retval
OG
id|len
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* too short */
id|len
op_assign
id|retval
op_minus
l_int|2
suffix:semicolon
multiline_comment|/* remaining length */
r_if
c_cond
(paren
id|len
OL
l_int|3
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
(paren
op_increment
id|p
)paren
op_ne
l_int|0x0A
)paren
op_logical_or
(paren
op_star
(paren
op_increment
id|p
)paren
op_ne
l_int|1
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|adr_typ
op_assign
op_star
(paren
op_increment
id|p
)paren
suffix:semicolon
id|len
op_sub_assign
l_int|3
suffix:semicolon
id|p
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|2
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
op_increment
op_ne
l_int|0x12
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
OG
id|len
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* check number length */
id|len
op_assign
op_star
id|p
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_star
id|p
op_eq
l_int|0x80
)paren
(brace
id|retval
op_assign
op_star
(paren
op_increment
id|p
)paren
op_plus
l_int|2
suffix:semicolon
multiline_comment|/* total length */
r_if
c_cond
(paren
id|retval
OG
id|len
)paren
r_return
l_int|0
suffix:semicolon
id|len
op_assign
id|retval
op_minus
l_int|2
suffix:semicolon
id|p
op_increment
suffix:semicolon
)brace
r_else
r_return
l_int|0
suffix:semicolon
multiline_comment|/* invalid address information */
id|sprintf
c_func
(paren
id|st
comma
l_string|&quot;%d &quot;
comma
id|adr_typ
)paren
suffix:semicolon
id|st
op_add_assign
id|strlen
c_func
(paren
id|st
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
op_star
id|st
op_increment
op_assign
l_char|&squot;-&squot;
suffix:semicolon
r_else
r_while
c_loop
(paren
id|len
op_decrement
)paren
op_star
id|st
op_increment
op_assign
op_star
id|p
op_increment
suffix:semicolon
op_star
id|st
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* put_address */
multiline_comment|/*************************************/
multiline_comment|/* report a succesfull interrogation */
multiline_comment|/*************************************/
DECL|function|interrogate_success
r_int
id|interrogate_success
c_func
(paren
id|isdn_ctrl
op_star
id|ic
comma
r_struct
id|call_struc
op_star
id|cs
)paren
(brace
r_char
op_star
id|src
op_assign
id|ic-&gt;parm.dss1_io.data
suffix:semicolon
r_int
id|restlen
op_assign
id|ic-&gt;parm.dss1_io.datalen
suffix:semicolon
r_int
id|cnt
op_assign
l_int|1
suffix:semicolon
id|u_char
id|n
comma
id|n1
suffix:semicolon
r_char
id|st
(braket
l_int|90
)braket
comma
op_star
id|p
comma
op_star
id|stp
suffix:semicolon
r_if
c_cond
(paren
id|restlen
OL
l_int|2
)paren
r_return
op_minus
l_int|100
suffix:semicolon
multiline_comment|/* frame too short */
r_if
c_cond
(paren
op_star
id|src
op_increment
op_ne
l_int|0x30
)paren
r_return
op_minus
l_int|101
suffix:semicolon
r_if
c_cond
(paren
(paren
id|n
op_assign
op_star
id|src
op_increment
)paren
OG
l_int|0x81
)paren
r_return
op_minus
l_int|102
suffix:semicolon
multiline_comment|/* invalid length field */
id|restlen
op_sub_assign
l_int|2
suffix:semicolon
multiline_comment|/* remaining bytes */
r_if
c_cond
(paren
id|n
op_eq
l_int|0x80
)paren
(brace
r_if
c_cond
(paren
id|restlen
OL
l_int|2
)paren
r_return
op_minus
l_int|103
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
(paren
id|src
op_plus
id|restlen
op_minus
l_int|1
)paren
)paren
op_logical_or
(paren
op_star
(paren
id|src
op_plus
id|restlen
op_minus
l_int|2
)paren
)paren
)paren
r_return
op_minus
l_int|104
suffix:semicolon
id|restlen
op_sub_assign
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|n
op_eq
l_int|0x81
)paren
(brace
id|n
op_assign
op_star
id|src
op_increment
suffix:semicolon
id|restlen
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
id|restlen
)paren
r_return
op_minus
l_int|105
suffix:semicolon
id|restlen
op_assign
id|n
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|n
OG
id|restlen
)paren
r_return
op_minus
l_int|106
suffix:semicolon
r_else
id|restlen
op_assign
id|n
suffix:semicolon
multiline_comment|/* standard format */
r_if
c_cond
(paren
id|restlen
OL
l_int|3
)paren
r_return
op_minus
l_int|107
suffix:semicolon
multiline_comment|/* no procedure */
r_if
c_cond
(paren
(paren
op_star
id|src
op_increment
op_ne
l_int|2
)paren
op_logical_or
(paren
op_star
id|src
op_increment
op_ne
l_int|1
)paren
op_logical_or
(paren
op_star
id|src
op_increment
op_ne
l_int|0x0B
)paren
)paren
r_return
op_minus
l_int|108
suffix:semicolon
id|restlen
op_sub_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|restlen
OL
l_int|2
)paren
r_return
op_minus
l_int|109
suffix:semicolon
multiline_comment|/* list missing */
r_if
c_cond
(paren
op_star
id|src
op_eq
l_int|0x31
)paren
(brace
id|src
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|n
op_assign
op_star
id|src
op_increment
)paren
OG
l_int|0x81
)paren
r_return
op_minus
l_int|110
suffix:semicolon
multiline_comment|/* invalid length field */
id|restlen
op_sub_assign
l_int|2
suffix:semicolon
multiline_comment|/* remaining bytes */
r_if
c_cond
(paren
id|n
op_eq
l_int|0x80
)paren
(brace
r_if
c_cond
(paren
id|restlen
OL
l_int|2
)paren
r_return
op_minus
l_int|111
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
(paren
id|src
op_plus
id|restlen
op_minus
l_int|1
)paren
)paren
op_logical_or
(paren
op_star
(paren
id|src
op_plus
id|restlen
op_minus
l_int|2
)paren
)paren
)paren
r_return
op_minus
l_int|112
suffix:semicolon
id|restlen
op_sub_assign
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|n
op_eq
l_int|0x81
)paren
(brace
id|n
op_assign
op_star
id|src
op_increment
suffix:semicolon
id|restlen
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
id|restlen
)paren
r_return
op_minus
l_int|113
suffix:semicolon
id|restlen
op_assign
id|n
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|n
OG
id|restlen
)paren
r_return
op_minus
l_int|114
suffix:semicolon
r_else
id|restlen
op_assign
id|n
suffix:semicolon
multiline_comment|/* standard format */
)brace
multiline_comment|/* result list header */
r_while
c_loop
(paren
id|restlen
op_ge
l_int|2
)paren
(brace
id|stp
op_assign
id|st
suffix:semicolon
id|sprintf
c_func
(paren
id|stp
comma
l_string|&quot;%d 0x%lx %d %s &quot;
comma
id|DIVERT_REPORT
comma
id|ic-&gt;parm.dss1_io.ll_id
comma
id|cnt
op_increment
comma
id|divert_if
dot
id|drv_to_name
c_func
(paren
id|ic-&gt;driver
)paren
)paren
suffix:semicolon
id|stp
op_add_assign
id|strlen
c_func
(paren
id|stp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|src
op_increment
op_ne
l_int|0x30
)paren
r_return
op_minus
l_int|115
suffix:semicolon
multiline_comment|/* invalid enum */
id|n
op_assign
op_star
id|src
op_increment
suffix:semicolon
id|restlen
op_sub_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
id|restlen
)paren
r_return
op_minus
l_int|116
suffix:semicolon
multiline_comment|/* enum length wrong */
id|restlen
op_sub_assign
id|n
suffix:semicolon
id|p
op_assign
id|src
suffix:semicolon
multiline_comment|/* one entry */
id|src
op_add_assign
id|n
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|n1
op_assign
id|put_address
c_func
(paren
id|stp
comma
id|p
comma
id|n
op_amp
l_int|0xFF
)paren
)paren
)paren
r_continue
suffix:semicolon
id|stp
op_add_assign
id|strlen
c_func
(paren
id|stp
)paren
suffix:semicolon
id|p
op_add_assign
id|n1
suffix:semicolon
id|n
op_sub_assign
id|n1
suffix:semicolon
r_if
c_cond
(paren
id|n
OL
l_int|6
)paren
r_continue
suffix:semicolon
multiline_comment|/* no service and proc */
r_if
c_cond
(paren
(paren
op_star
id|p
op_increment
op_ne
l_int|0x0A
)paren
op_logical_or
(paren
op_star
id|p
op_increment
op_ne
l_int|1
)paren
)paren
r_continue
suffix:semicolon
id|sprintf
c_func
(paren
id|stp
comma
l_string|&quot; 0x%02x &quot;
comma
(paren
op_star
id|p
op_increment
)paren
op_amp
l_int|0xFF
)paren
suffix:semicolon
id|stp
op_add_assign
id|strlen
c_func
(paren
id|stp
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|p
op_increment
op_ne
l_int|0x0A
)paren
op_logical_or
(paren
op_star
id|p
op_increment
op_ne
l_int|1
)paren
)paren
r_continue
suffix:semicolon
id|sprintf
c_func
(paren
id|stp
comma
l_string|&quot;%d &quot;
comma
(paren
op_star
id|p
op_increment
)paren
op_amp
l_int|0xFF
)paren
suffix:semicolon
id|stp
op_add_assign
id|strlen
c_func
(paren
id|stp
)paren
suffix:semicolon
id|n
op_sub_assign
l_int|6
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
l_int|2
)paren
(brace
r_if
c_cond
(paren
op_star
id|p
op_increment
op_ne
l_int|0x30
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
OG
(paren
id|n
op_minus
l_int|2
)paren
)paren
r_continue
suffix:semicolon
id|n
op_assign
op_star
id|p
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|n1
op_assign
id|put_address
c_func
(paren
id|stp
comma
id|p
comma
id|n
op_amp
l_int|0xFF
)paren
)paren
)paren
r_continue
suffix:semicolon
id|stp
op_add_assign
id|strlen
c_func
(paren
id|stp
)paren
suffix:semicolon
)brace
id|sprintf
c_func
(paren
id|stp
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|put_info_buffer
c_func
(paren
id|st
)paren
suffix:semicolon
)brace
multiline_comment|/* while restlen */
r_if
c_cond
(paren
id|restlen
)paren
r_return
op_minus
l_int|117
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* interrogate_success */
multiline_comment|/*********************************************/
multiline_comment|/* callback for protocol specific extensions */
multiline_comment|/*********************************************/
DECL|function|prot_stat_callback
r_int
id|prot_stat_callback
c_func
(paren
id|isdn_ctrl
op_star
id|ic
)paren
(brace
r_struct
id|call_struc
op_star
id|cs
comma
op_star
id|cs1
suffix:semicolon
r_int
id|i
comma
id|flags
suffix:semicolon
id|cs
op_assign
id|divert_head
suffix:semicolon
multiline_comment|/* start of list */
id|cs1
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
id|cs
)paren
(brace
r_if
c_cond
(paren
id|ic-&gt;driver
op_eq
id|cs-&gt;ics.driver
)paren
(brace
r_switch
c_cond
(paren
id|cs-&gt;ics.arg
)paren
(brace
r_case
id|DSS1_CMD_INVOKE
suffix:colon
r_if
c_cond
(paren
(paren
id|cs-&gt;ics.parm.dss1_io.ll_id
op_eq
id|ic-&gt;parm.dss1_io.ll_id
)paren
op_logical_and
(paren
id|cs-&gt;ics.parm.dss1_io.hl_id
op_eq
id|ic-&gt;parm.dss1_io.hl_id
)paren
)paren
(brace
r_switch
c_cond
(paren
id|ic-&gt;arg
)paren
(brace
r_case
id|DSS1_STAT_INVOKE_ERR
suffix:colon
id|sprintf
c_func
(paren
id|cs-&gt;info
comma
l_string|&quot;128 0x%lx 0x%x&bslash;n&quot;
comma
id|ic-&gt;parm.dss1_io.ll_id
comma
id|ic-&gt;parm.dss1_io.timeout
)paren
suffix:semicolon
id|put_info_buffer
c_func
(paren
id|cs-&gt;info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DSS1_STAT_INVOKE_RES
suffix:colon
r_switch
c_cond
(paren
id|cs-&gt;ics.parm.dss1_io.proc
)paren
(brace
r_case
l_int|7
suffix:colon
r_case
l_int|8
suffix:colon
id|put_info_buffer
c_func
(paren
id|cs-&gt;info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|11
suffix:colon
id|i
op_assign
id|interrogate_success
c_func
(paren
id|ic
comma
id|cs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
id|sprintf
c_func
(paren
id|cs-&gt;info
comma
l_string|&quot;%d 0x%lx %d&bslash;n&quot;
comma
id|DIVERT_REPORT
comma
id|ic-&gt;parm.dss1_io.ll_id
comma
id|i
)paren
suffix:semicolon
id|put_info_buffer
c_func
(paren
id|cs-&gt;info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;dss1_divert: unknown proc %d&bslash;n&quot;
comma
id|cs-&gt;ics.parm.dss1_io.proc
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;dss1_divert unknown invoke answer %lx&bslash;n&quot;
comma
id|ic-&gt;arg
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|cs1
op_assign
id|cs
suffix:semicolon
multiline_comment|/* remember structure */
id|cs
op_assign
l_int|NULL
suffix:semicolon
r_continue
suffix:semicolon
multiline_comment|/* abort search */
)brace
multiline_comment|/* id found */
r_break
suffix:semicolon
r_case
id|DSS1_CMD_INVOKE_ABORT
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;dss1_divert unhandled invoke abort&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;dss1_divert unknown cmd 0x%lx&bslash;n&quot;
comma
id|cs-&gt;ics.arg
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* switch ics.arg */
id|cs
op_assign
id|cs-&gt;next
suffix:semicolon
)brace
multiline_comment|/* driver ok */
)brace
r_if
c_cond
(paren
op_logical_neg
id|cs1
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;dss1_divert unhandled process&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cs1-&gt;ics.driver
op_eq
op_minus
l_int|1
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|cs1-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs1-&gt;prev
)paren
id|cs1-&gt;prev-&gt;next
op_assign
id|cs1-&gt;next
suffix:semicolon
multiline_comment|/* forward link */
r_else
id|divert_head
op_assign
id|cs1-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|cs1-&gt;next
)paren
id|cs1-&gt;next-&gt;prev
op_assign
id|cs1-&gt;prev
suffix:semicolon
multiline_comment|/* back link */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|cs1
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* prot_stat_callback */
multiline_comment|/***************************/
multiline_comment|/* status callback from HL */
multiline_comment|/***************************/
DECL|function|isdn_divert_stat_callback
r_int
id|isdn_divert_stat_callback
c_func
(paren
id|isdn_ctrl
op_star
id|ic
)paren
(brace
r_struct
id|call_struc
op_star
id|cs
comma
op_star
id|cs1
suffix:semicolon
r_int
id|flags
comma
id|retval
suffix:semicolon
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
id|cs
op_assign
id|divert_head
suffix:semicolon
multiline_comment|/* start of list */
r_while
c_loop
(paren
id|cs
)paren
(brace
r_if
c_cond
(paren
(paren
id|ic-&gt;driver
op_eq
id|cs-&gt;ics.driver
)paren
op_logical_and
(paren
id|ic-&gt;arg
op_eq
id|cs-&gt;ics.arg
)paren
)paren
(brace
r_switch
c_cond
(paren
id|ic-&gt;command
)paren
(brace
r_case
id|ISDN_STAT_DHUP
suffix:colon
id|sprintf
c_func
(paren
id|cs-&gt;info
comma
l_string|&quot;129 0x%lx&bslash;n&quot;
comma
id|cs-&gt;divert_id
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|cs-&gt;timer
)paren
suffix:semicolon
id|cs-&gt;ics.driver
op_assign
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_STAT_CAUSE
suffix:colon
id|sprintf
c_func
(paren
id|cs-&gt;info
comma
l_string|&quot;130 0x%lx %s&bslash;n&quot;
comma
id|cs-&gt;divert_id
comma
id|ic-&gt;parm.num
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_STAT_REDIR
suffix:colon
id|sprintf
c_func
(paren
id|cs-&gt;info
comma
l_string|&quot;131 0x%lx&bslash;n&quot;
comma
id|cs-&gt;divert_id
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|cs-&gt;timer
)paren
suffix:semicolon
id|cs-&gt;ics.driver
op_assign
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|sprintf
c_func
(paren
id|cs-&gt;info
comma
l_string|&quot;999 0x%lx 0x%x&bslash;n&quot;
comma
id|cs-&gt;divert_id
comma
(paren
r_int
)paren
(paren
id|ic-&gt;command
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|put_info_buffer
c_func
(paren
id|cs-&gt;info
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
)brace
id|cs1
op_assign
id|cs
suffix:semicolon
id|cs
op_assign
id|cs-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|cs1-&gt;ics.driver
op_eq
op_minus
l_int|1
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs1-&gt;prev
)paren
id|cs1-&gt;prev-&gt;next
op_assign
id|cs1-&gt;next
suffix:semicolon
multiline_comment|/* forward link */
r_else
id|divert_head
op_assign
id|cs1-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|cs1-&gt;next
)paren
id|cs1-&gt;next-&gt;prev
op_assign
id|cs1-&gt;prev
suffix:semicolon
multiline_comment|/* back link */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|cs1
)paren
suffix:semicolon
)brace
)brace
r_return
id|retval
suffix:semicolon
multiline_comment|/* not found */
)brace
multiline_comment|/* isdn_divert_stat_callback */
multiline_comment|/********************/
multiline_comment|/* callback from ll */
multiline_comment|/********************/
DECL|function|ll_callback
r_int
id|ll_callback
c_func
(paren
id|isdn_ctrl
op_star
id|ic
)paren
(brace
r_switch
c_cond
(paren
id|ic-&gt;command
)paren
(brace
r_case
id|ISDN_STAT_ICALL
suffix:colon
r_case
id|ISDN_STAT_ICALLW
suffix:colon
r_return
id|isdn_divert_icall
c_func
(paren
id|ic
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISDN_STAT_PROT
suffix:colon
r_if
c_cond
(paren
(paren
id|ic-&gt;arg
op_amp
l_int|0xFF
)paren
op_eq
id|ISDN_PTYPE_EURO
)paren
(brace
r_if
c_cond
(paren
id|ic-&gt;arg
op_ne
id|DSS1_STAT_INVOKE_BRD
)paren
r_return
id|prot_stat_callback
c_func
(paren
id|ic
)paren
suffix:semicolon
r_else
r_return
l_int|0
suffix:semicolon
multiline_comment|/* DSS1 invoke broadcast */
)brace
r_else
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* protocol not euro */
r_default
suffix:colon
r_return
id|isdn_divert_stat_callback
c_func
(paren
id|ic
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* ll_callback */
eof
