multiline_comment|/* IEEE-1284 operations for parport.&n; *&n; * This file is for generic IEEE 1284 operations.  The idea is that&n; * they are used by the low-level drivers.  If they have a special way&n; * of doing something, they can provide their own routines (and put&n; * the function pointers in port-&gt;ops); if not, they can just use these&n; * as a fallback.&n; *&n; * Note: Make no assumptions about hardware or architecture in this file!&n; *&n; * Author: Tim Waugh &lt;tim@cyberelk.demon.co.uk&gt;&n; * Fixed AUTOFD polarity in ecp_forward_to_reverse().  Fred Barnes, 1999&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/parport.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
DECL|macro|DEBUG
mdefine_line|#define DEBUG /* undef me for production */
macro_line|#ifdef CONFIG_LP_CONSOLE
DECL|macro|DEBUG
macro_line|#undef DEBUG /* Don&squot;t want a garbled console */
macro_line|#endif
macro_line|#ifdef DEBUG
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(stuff...) printk (stuff)
macro_line|#else
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(stuff...)
macro_line|#endif
multiline_comment|/***                                *&n; * One-way data transfer functions. *&n; *                                ***/
multiline_comment|/* Compatibility mode. */
DECL|function|parport_ieee1284_write_compat
r_int
id|parport_ieee1284_write_compat
(paren
r_struct
id|parport
op_star
id|port
comma
r_const
r_void
op_star
id|buffer
comma
r_int
id|len
comma
r_int
id|flags
)paren
(brace
r_int
id|no_irq
op_assign
l_int|1
suffix:semicolon
id|ssize_t
id|count
op_assign
l_int|0
suffix:semicolon
r_const
r_int
r_char
op_star
id|addr
op_assign
id|buffer
suffix:semicolon
r_int
r_char
id|byte
suffix:semicolon
r_struct
id|pardevice
op_star
id|dev
op_assign
id|port-&gt;physport-&gt;cad
suffix:semicolon
r_int
r_char
id|ctl
op_assign
(paren
id|PARPORT_CONTROL_SELECT
op_or
id|PARPORT_CONTROL_INIT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;irq
op_ne
id|PARPORT_IRQ_NONE
)paren
(brace
id|parport_enable_irq
(paren
id|port
)paren
suffix:semicolon
id|no_irq
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear out previous irqs. */
r_while
c_loop
(paren
op_logical_neg
id|down_trylock
(paren
op_amp
id|port-&gt;physport-&gt;ieee1284.irq
)paren
)paren
suffix:semicolon
)brace
id|port-&gt;physport-&gt;ieee1284.phase
op_assign
id|IEEE1284_PH_FWD_DATA
suffix:semicolon
id|parport_write_control
(paren
id|port
comma
id|ctl
)paren
suffix:semicolon
id|parport_data_forward
(paren
id|port
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
OL
id|len
)paren
(brace
r_int
id|expire
op_assign
id|jiffies
op_plus
id|dev-&gt;timeout
suffix:semicolon
r_int
id|wait
op_assign
(paren
id|HZ
op_plus
l_int|99
)paren
op_div
l_int|100
suffix:semicolon
r_int
r_char
id|mask
op_assign
(paren
id|PARPORT_STATUS_ERROR
op_or
id|PARPORT_STATUS_BUSY
)paren
suffix:semicolon
r_int
r_char
id|val
op_assign
(paren
id|PARPORT_STATUS_ERROR
op_or
id|PARPORT_STATUS_BUSY
)paren
suffix:semicolon
multiline_comment|/* Wait until the peripheral&squot;s ready */
r_do
(brace
multiline_comment|/* Is the peripheral ready yet? */
r_if
c_cond
(paren
op_logical_neg
id|parport_wait_peripheral
(paren
id|port
comma
id|mask
comma
id|val
)paren
)paren
multiline_comment|/* Skip the loop */
r_goto
id|ready
suffix:semicolon
multiline_comment|/* Is the peripheral upset? */
r_if
c_cond
(paren
(paren
id|parport_read_status
(paren
id|port
)paren
op_amp
(paren
id|PARPORT_STATUS_PAPEROUT
op_or
id|PARPORT_STATUS_SELECT
op_or
id|PARPORT_STATUS_ERROR
)paren
)paren
op_ne
(paren
id|PARPORT_STATUS_SELECT
op_or
id|PARPORT_STATUS_ERROR
)paren
)paren
multiline_comment|/* If nFault is asserted (i.e. no&n;&t;&t;&t;&t; * error) and PAPEROUT and SELECT are&n;&t;&t;&t;&t; * just red herrings, give the driver&n;&t;&t;&t;&t; * a chance to check it&squot;s happy with&n;&t;&t;&t;&t; * that before continuing. */
r_goto
id|stop
suffix:semicolon
multiline_comment|/* Have we run out of time? */
r_if
c_cond
(paren
op_logical_neg
id|time_before
(paren
id|jiffies
comma
id|expire
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* Yield the port for a while.  If this is the&n;                           first time around the loop, don&squot;t let go of&n;                           the port.  This way, we find out if we have&n;                           our interrupt handler called. */
r_if
c_cond
(paren
id|count
op_logical_and
id|no_irq
)paren
(brace
id|parport_release
(paren
id|dev
)paren
suffix:semicolon
id|__set_current_state
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
(paren
id|wait
)paren
suffix:semicolon
id|parport_claim_or_block
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* We must have the device claimed here */
id|parport_wait_event
(paren
id|port
comma
id|wait
)paren
suffix:semicolon
multiline_comment|/* Is there a signal pending? */
r_if
c_cond
(paren
id|signal_pending
(paren
id|current
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* Wait longer next time. */
id|wait
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_while
c_loop
(paren
id|time_before
(paren
id|jiffies
comma
id|expire
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
(paren
id|current
)paren
)paren
r_break
suffix:semicolon
id|DPRINTK
(paren
id|KERN_DEBUG
l_string|&quot;%s: Timed out&bslash;n&quot;
comma
id|port-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
id|ready
suffix:colon
multiline_comment|/* Write the character to the data lines. */
id|byte
op_assign
op_star
id|addr
op_increment
suffix:semicolon
id|parport_write_data
(paren
id|port
comma
id|byte
)paren
suffix:semicolon
id|udelay
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Pulse strobe. */
id|parport_write_control
(paren
id|port
comma
id|ctl
op_or
id|PARPORT_CONTROL_STROBE
)paren
suffix:semicolon
id|udelay
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* strobe */
id|parport_write_control
(paren
id|port
comma
id|ctl
)paren
suffix:semicolon
id|udelay
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* hold */
multiline_comment|/* Assume the peripheral received it. */
id|count
op_increment
suffix:semicolon
multiline_comment|/* Let another process run if it needs to. */
r_if
c_cond
(paren
id|time_before
(paren
id|jiffies
comma
id|expire
)paren
)paren
r_if
c_cond
(paren
op_logical_neg
id|parport_yield_blocking
(paren
id|dev
)paren
op_logical_and
id|current-&gt;need_resched
)paren
id|schedule
(paren
)paren
suffix:semicolon
)brace
id|stop
suffix:colon
id|port-&gt;physport-&gt;ieee1284.phase
op_assign
id|IEEE1284_PH_FWD_IDLE
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/* Nibble mode. */
DECL|function|parport_ieee1284_read_nibble
r_int
id|parport_ieee1284_read_nibble
(paren
r_struct
id|parport
op_star
id|port
comma
r_void
op_star
id|buffer
comma
r_int
id|len
comma
r_int
id|flags
)paren
(brace
macro_line|#ifndef CONFIG_PARPORT_1284
r_return
l_int|0
suffix:semicolon
macro_line|#else
r_int
r_char
op_star
id|buf
op_assign
id|buffer
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_char
id|byte
op_assign
l_int|0
suffix:semicolon
id|len
op_mul_assign
l_int|2
suffix:semicolon
multiline_comment|/* in nibbles */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_char
id|nibble
suffix:semicolon
multiline_comment|/* Does the error line indicate end of data? */
r_if
c_cond
(paren
(paren
(paren
id|i
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|parport_read_status
c_func
(paren
id|port
)paren
op_amp
id|PARPORT_STATUS_ERROR
)paren
)paren
(brace
id|port-&gt;physport-&gt;ieee1284.phase
op_assign
id|IEEE1284_PH_HBUSY_DNA
suffix:semicolon
id|DPRINTK
(paren
id|KERN_DEBUG
l_string|&quot;%s: No more nibble data (%d bytes)&bslash;n&quot;
comma
id|port-&gt;name
comma
id|i
op_div
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Go to reverse idle phase. */
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_AUTOFD
comma
id|PARPORT_CONTROL_AUTOFD
)paren
suffix:semicolon
id|port-&gt;physport-&gt;ieee1284.phase
op_assign
id|IEEE1284_PH_REV_IDLE
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Event 7: Set nAutoFd low. */
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_AUTOFD
comma
id|PARPORT_CONTROL_AUTOFD
)paren
suffix:semicolon
multiline_comment|/* Event 9: nAck goes low. */
id|port-&gt;ieee1284.phase
op_assign
id|IEEE1284_PH_REV_DATA
suffix:semicolon
r_if
c_cond
(paren
id|parport_wait_peripheral
(paren
id|port
comma
id|PARPORT_STATUS_ACK
comma
l_int|0
)paren
)paren
(brace
multiline_comment|/* Timeout -- no more data? */
id|DPRINTK
(paren
id|KERN_DEBUG
l_string|&quot;%s: Nibble timeout at event 9 (%d bytes)&bslash;n&quot;
comma
id|port-&gt;name
comma
id|i
op_div
l_int|2
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Read a nibble. */
id|nibble
op_assign
id|parport_read_status
(paren
id|port
)paren
op_rshift
l_int|3
suffix:semicolon
id|nibble
op_and_assign
op_complement
l_int|8
suffix:semicolon
r_if
c_cond
(paren
(paren
id|nibble
op_amp
l_int|0x10
)paren
op_eq
l_int|0
)paren
id|nibble
op_or_assign
l_int|8
suffix:semicolon
id|nibble
op_and_assign
l_int|0xf
suffix:semicolon
multiline_comment|/* Event 10: Set nAutoFd high. */
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_AUTOFD
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Event 11: nAck goes high. */
r_if
c_cond
(paren
id|parport_wait_peripheral
(paren
id|port
comma
id|PARPORT_STATUS_ACK
comma
id|PARPORT_STATUS_ACK
)paren
)paren
(brace
multiline_comment|/* Timeout -- no more data? */
id|DPRINTK
(paren
id|KERN_DEBUG
l_string|&quot;%s: Nibble timeout at event 11&bslash;n&quot;
comma
id|port-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_amp
l_int|1
)paren
(brace
multiline_comment|/* Second nibble */
id|byte
op_or_assign
id|nibble
op_lshift
l_int|4
suffix:semicolon
op_star
id|buf
op_increment
op_assign
id|byte
suffix:semicolon
)brace
r_else
id|byte
op_assign
id|nibble
suffix:semicolon
)brace
id|i
op_div_assign
l_int|2
suffix:semicolon
multiline_comment|/* i is now in bytes */
r_if
c_cond
(paren
id|i
op_eq
id|len
)paren
(brace
multiline_comment|/* Read the last nibble without checking data avail. */
id|port
op_assign
id|port-&gt;physport
suffix:semicolon
r_if
c_cond
(paren
id|parport_read_status
(paren
id|port
)paren
op_amp
id|PARPORT_STATUS_ERROR
)paren
id|port-&gt;ieee1284.phase
op_assign
id|IEEE1284_PH_HBUSY_DNA
suffix:semicolon
r_else
id|port-&gt;ieee1284.phase
op_assign
id|IEEE1284_PH_HBUSY_DAVAIL
suffix:semicolon
)brace
r_return
id|i
suffix:semicolon
macro_line|#endif /* IEEE1284 support */
)brace
multiline_comment|/* Byte mode. */
DECL|function|parport_ieee1284_read_byte
r_int
id|parport_ieee1284_read_byte
(paren
r_struct
id|parport
op_star
id|port
comma
r_void
op_star
id|buffer
comma
r_int
id|len
comma
r_int
id|flags
)paren
(brace
macro_line|#ifndef CONFIG_PARPORT_1284
r_return
l_int|0
suffix:semicolon
macro_line|#else
r_int
r_char
op_star
id|buf
op_assign
id|buffer
suffix:semicolon
id|ssize_t
id|count
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
id|len
suffix:semicolon
id|count
op_increment
)paren
(brace
r_int
r_char
id|byte
suffix:semicolon
multiline_comment|/* Data available? */
r_if
c_cond
(paren
id|parport_read_status
(paren
id|port
)paren
op_amp
id|PARPORT_STATUS_ERROR
)paren
(brace
id|port-&gt;physport-&gt;ieee1284.phase
op_assign
id|IEEE1284_PH_HBUSY_DNA
suffix:semicolon
id|DPRINTK
(paren
id|KERN_DEBUG
l_string|&quot;%s: No more byte data (%Zd bytes)&bslash;n&quot;
comma
id|port-&gt;name
comma
id|count
)paren
suffix:semicolon
multiline_comment|/* Go to reverse idle phase. */
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_AUTOFD
comma
id|PARPORT_CONTROL_AUTOFD
)paren
suffix:semicolon
id|port-&gt;physport-&gt;ieee1284.phase
op_assign
id|IEEE1284_PH_REV_IDLE
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Event 14: Place data bus in high impedance state. */
id|parport_data_reverse
(paren
id|port
)paren
suffix:semicolon
multiline_comment|/* Event 7: Set nAutoFd low. */
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_AUTOFD
comma
id|PARPORT_CONTROL_AUTOFD
)paren
suffix:semicolon
multiline_comment|/* Event 9: nAck goes low. */
id|port-&gt;physport-&gt;ieee1284.phase
op_assign
id|IEEE1284_PH_REV_DATA
suffix:semicolon
r_if
c_cond
(paren
id|parport_wait_peripheral
(paren
id|port
comma
id|PARPORT_STATUS_ACK
comma
l_int|0
)paren
)paren
(brace
multiline_comment|/* Timeout -- no more data? */
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_AUTOFD
comma
l_int|0
)paren
suffix:semicolon
id|DPRINTK
(paren
id|KERN_DEBUG
l_string|&quot;%s: Byte timeout at event 9&bslash;n&quot;
comma
id|port-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|byte
op_assign
id|parport_read_data
(paren
id|port
)paren
suffix:semicolon
op_star
id|buf
op_increment
op_assign
id|byte
suffix:semicolon
multiline_comment|/* Event 10: Set nAutoFd high */
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_AUTOFD
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Event 11: nAck goes high. */
r_if
c_cond
(paren
id|parport_wait_peripheral
(paren
id|port
comma
id|PARPORT_STATUS_ACK
comma
id|PARPORT_STATUS_ACK
)paren
)paren
(brace
multiline_comment|/* Timeout -- no more data? */
id|DPRINTK
(paren
id|KERN_DEBUG
l_string|&quot;%s: Byte timeout at event 11&bslash;n&quot;
comma
id|port-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Event 16: Set nStrobe low. */
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_STROBE
comma
id|PARPORT_CONTROL_STROBE
)paren
suffix:semicolon
id|udelay
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* Event 17: Set nStrobe high. */
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_STROBE
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
op_eq
id|len
)paren
(brace
multiline_comment|/* Read the last byte without checking data avail. */
id|port
op_assign
id|port-&gt;physport
suffix:semicolon
r_if
c_cond
(paren
id|parport_read_status
(paren
id|port
)paren
op_amp
id|PARPORT_STATUS_ERROR
)paren
id|port-&gt;ieee1284.phase
op_assign
id|IEEE1284_PH_HBUSY_DNA
suffix:semicolon
r_else
id|port-&gt;ieee1284.phase
op_assign
id|IEEE1284_PH_HBUSY_DAVAIL
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
macro_line|#endif /* IEEE1284 support */
)brace
multiline_comment|/***              *&n; * ECP Functions. *&n; *              ***/
macro_line|#ifdef CONFIG_PARPORT_1284
r_static
r_inline
DECL|function|ecp_forward_to_reverse
r_int
id|ecp_forward_to_reverse
(paren
r_struct
id|parport
op_star
id|port
)paren
(brace
r_int
id|retval
suffix:semicolon
multiline_comment|/* Event 38: Set nAutoFd low */
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_AUTOFD
comma
id|PARPORT_CONTROL_AUTOFD
)paren
suffix:semicolon
id|parport_data_reverse
(paren
id|port
)paren
suffix:semicolon
id|udelay
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* Event 39: Set nInit low to initiate bus reversal */
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_INIT
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Event 40: PError goes low */
id|retval
op_assign
id|parport_wait_peripheral
(paren
id|port
comma
id|PARPORT_STATUS_PAPEROUT
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
id|DPRINTK
(paren
id|KERN_DEBUG
l_string|&quot;%s: ECP direction: reverse&bslash;n&quot;
comma
id|port-&gt;name
)paren
suffix:semicolon
id|port-&gt;ieee1284.phase
op_assign
id|IEEE1284_PH_REV_IDLE
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
r_static
r_inline
DECL|function|ecp_reverse_to_forward
r_int
id|ecp_reverse_to_forward
(paren
r_struct
id|parport
op_star
id|port
)paren
(brace
r_int
id|retval
suffix:semicolon
multiline_comment|/* Event 47: Set nInit high */
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_INIT
op_or
id|PARPORT_CONTROL_AUTOFD
comma
id|PARPORT_CONTROL_INIT
op_or
id|PARPORT_CONTROL_AUTOFD
)paren
suffix:semicolon
multiline_comment|/* Event 49: PError goes high */
id|retval
op_assign
id|parport_wait_peripheral
(paren
id|port
comma
id|PARPORT_STATUS_PAPEROUT
comma
id|PARPORT_STATUS_PAPEROUT
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
id|parport_data_forward
(paren
id|port
)paren
suffix:semicolon
id|DPRINTK
(paren
id|KERN_DEBUG
l_string|&quot;%s: ECP direction: forward&bslash;n&quot;
comma
id|port-&gt;name
)paren
suffix:semicolon
id|port-&gt;ieee1284.phase
op_assign
id|IEEE1284_PH_FWD_IDLE
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
macro_line|#endif /* IEEE1284 support */
multiline_comment|/* ECP mode, forward channel, data. */
DECL|function|parport_ieee1284_ecp_write_data
r_int
id|parport_ieee1284_ecp_write_data
(paren
r_struct
id|parport
op_star
id|port
comma
r_const
r_void
op_star
id|buffer
comma
r_int
id|len
comma
r_int
id|flags
)paren
(brace
macro_line|#ifndef CONFIG_PARPORT_1284
r_return
l_int|0
suffix:semicolon
macro_line|#else
r_const
r_int
r_char
op_star
id|buf
op_assign
id|buffer
suffix:semicolon
r_int
id|written
suffix:semicolon
r_int
id|retry
suffix:semicolon
id|port
op_assign
id|port-&gt;physport
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;ieee1284.phase
op_ne
id|IEEE1284_PH_FWD_IDLE
)paren
r_if
c_cond
(paren
id|ecp_reverse_to_forward
(paren
id|port
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|port-&gt;ieee1284.phase
op_assign
id|IEEE1284_PH_FWD_DATA
suffix:semicolon
multiline_comment|/* HostAck high (data, not command) */
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_AUTOFD
op_or
id|PARPORT_CONTROL_STROBE
op_or
id|PARPORT_CONTROL_INIT
comma
id|PARPORT_CONTROL_INIT
)paren
suffix:semicolon
r_for
c_loop
(paren
id|written
op_assign
l_int|0
suffix:semicolon
id|written
OL
id|len
suffix:semicolon
id|written
op_increment
comma
id|buf
op_increment
)paren
(brace
r_int
id|expire
op_assign
id|jiffies
op_plus
id|port-&gt;cad-&gt;timeout
suffix:semicolon
r_int
r_char
id|byte
suffix:semicolon
id|byte
op_assign
op_star
id|buf
suffix:semicolon
id|try_again
suffix:colon
id|parport_write_data
(paren
id|port
comma
id|byte
)paren
suffix:semicolon
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_STROBE
comma
id|PARPORT_CONTROL_STROBE
)paren
suffix:semicolon
id|udelay
(paren
l_int|5
)paren
suffix:semicolon
r_for
c_loop
(paren
id|retry
op_assign
l_int|0
suffix:semicolon
id|retry
OL
l_int|100
suffix:semicolon
id|retry
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|parport_wait_peripheral
(paren
id|port
comma
id|PARPORT_STATUS_BUSY
comma
l_int|0
)paren
)paren
r_goto
id|success
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
(paren
id|current
)paren
)paren
(brace
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_STROBE
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Time for Host Transfer Recovery (page 41 of IEEE1284) */
id|DPRINTK
(paren
id|KERN_DEBUG
l_string|&quot;%s: ECP transfer stalled!&bslash;n&quot;
comma
id|port-&gt;name
)paren
suffix:semicolon
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_INIT
comma
id|PARPORT_CONTROL_INIT
)paren
suffix:semicolon
id|udelay
(paren
l_int|50
)paren
suffix:semicolon
r_if
c_cond
(paren
id|parport_read_status
(paren
id|port
)paren
op_amp
id|PARPORT_STATUS_PAPEROUT
)paren
(brace
multiline_comment|/* It&squot;s buggered. */
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_INIT
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_INIT
comma
l_int|0
)paren
suffix:semicolon
id|udelay
(paren
l_int|50
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|parport_read_status
(paren
id|port
)paren
op_amp
id|PARPORT_STATUS_PAPEROUT
)paren
)paren
r_break
suffix:semicolon
id|DPRINTK
(paren
id|KERN_DEBUG
l_string|&quot;%s: Host transfer recovered&bslash;n&quot;
comma
id|port-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_after_eq
(paren
id|jiffies
comma
id|expire
)paren
)paren
r_break
suffix:semicolon
r_goto
id|try_again
suffix:semicolon
id|success
suffix:colon
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_STROBE
comma
l_int|0
)paren
suffix:semicolon
id|udelay
(paren
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|parport_wait_peripheral
(paren
id|port
comma
id|PARPORT_STATUS_BUSY
comma
id|PARPORT_STATUS_BUSY
)paren
)paren
multiline_comment|/* Peripheral hasn&squot;t accepted the data. */
r_break
suffix:semicolon
)brace
id|port-&gt;ieee1284.phase
op_assign
id|IEEE1284_PH_FWD_IDLE
suffix:semicolon
r_return
id|written
suffix:semicolon
macro_line|#endif /* IEEE1284 support */
)brace
multiline_comment|/* ECP mode, reverse channel, data. */
DECL|function|parport_ieee1284_ecp_read_data
r_int
id|parport_ieee1284_ecp_read_data
(paren
r_struct
id|parport
op_star
id|port
comma
r_void
op_star
id|buffer
comma
r_int
id|len
comma
r_int
id|flags
)paren
(brace
macro_line|#ifndef CONFIG_PARPORT_1284
r_return
l_int|0
suffix:semicolon
macro_line|#else
r_struct
id|pardevice
op_star
id|dev
op_assign
id|port-&gt;cad
suffix:semicolon
r_int
r_char
op_star
id|buf
op_assign
id|buffer
suffix:semicolon
r_int
id|rle_count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* shut gcc up */
r_int
id|rle
op_assign
l_int|0
suffix:semicolon
id|ssize_t
id|count
op_assign
l_int|0
suffix:semicolon
id|port
op_assign
id|port-&gt;physport
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;ieee1284.phase
op_ne
id|IEEE1284_PH_REV_IDLE
)paren
r_if
c_cond
(paren
id|ecp_forward_to_reverse
(paren
id|port
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|port-&gt;ieee1284.phase
op_assign
id|IEEE1284_PH_REV_DATA
suffix:semicolon
multiline_comment|/* Set HostAck low to start accepting data. */
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_AUTOFD
op_or
id|PARPORT_CONTROL_STROBE
op_or
id|PARPORT_CONTROL_INIT
comma
id|PARPORT_CONTROL_AUTOFD
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
OL
id|len
)paren
(brace
r_int
id|expire
op_assign
id|jiffies
op_plus
id|dev-&gt;timeout
suffix:semicolon
r_int
r_char
id|byte
suffix:semicolon
r_int
id|command
suffix:semicolon
multiline_comment|/* Event 43: Peripheral sets nAck low. It can take as&n;                   long as it wants. */
r_while
c_loop
(paren
id|parport_wait_peripheral
(paren
id|port
comma
id|PARPORT_STATUS_ACK
comma
l_int|0
)paren
)paren
(brace
multiline_comment|/* The peripheral hasn&squot;t given us data in&n;&t;&t;&t;   35ms.  If we have data to give back to the&n;&t;&t;&t;   caller, do it now. */
r_if
c_cond
(paren
id|count
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* If we&squot;ve used up all the time we were allowed,&n;&t;&t;&t;   give up altogether. */
r_if
c_cond
(paren
op_logical_neg
id|time_before
(paren
id|jiffies
comma
id|expire
)paren
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Yield the port for a while. */
r_if
c_cond
(paren
id|count
op_logical_and
id|dev-&gt;port-&gt;irq
op_ne
id|PARPORT_IRQ_NONE
)paren
(brace
id|parport_release
(paren
id|dev
)paren
suffix:semicolon
id|__set_current_state
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
(paren
(paren
id|HZ
op_plus
l_int|24
)paren
op_div
l_int|25
)paren
suffix:semicolon
id|parport_claim_or_block
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* We must have the device claimed here. */
id|parport_wait_event
(paren
id|port
comma
(paren
id|HZ
op_plus
l_int|24
)paren
op_div
l_int|25
)paren
suffix:semicolon
multiline_comment|/* Is there a signal pending? */
r_if
c_cond
(paren
id|signal_pending
(paren
id|current
)paren
)paren
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Is this a command? */
r_if
c_cond
(paren
id|rle
)paren
multiline_comment|/* The last byte was a run-length count, so&n;                           this can&squot;t be as well. */
id|command
op_assign
l_int|0
suffix:semicolon
r_else
id|command
op_assign
(paren
id|parport_read_status
(paren
id|port
)paren
op_amp
id|PARPORT_STATUS_BUSY
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/* Read the data. */
id|byte
op_assign
id|parport_read_data
(paren
id|port
)paren
suffix:semicolon
multiline_comment|/* If this is a channel command, rather than an RLE&n;                   command or a normal data byte, don&squot;t accept it. */
r_if
c_cond
(paren
id|command
)paren
(brace
r_if
c_cond
(paren
id|byte
op_amp
l_int|0x80
)paren
(brace
id|DPRINTK
(paren
id|KERN_DEBUG
l_string|&quot;%s: stopping short at &quot;
l_string|&quot;channel command (%02x)&bslash;n&quot;
comma
id|port-&gt;name
comma
id|byte
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|port-&gt;ieee1284.mode
op_ne
id|IEEE1284_MODE_ECPRLE
)paren
id|DPRINTK
(paren
id|KERN_DEBUG
l_string|&quot;%s: device illegally &quot;
l_string|&quot;using RLE; accepting anyway&bslash;n&quot;
comma
id|port-&gt;name
)paren
suffix:semicolon
id|rle_count
op_assign
id|byte
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* Are we allowed to read that many bytes? */
r_if
c_cond
(paren
id|rle_count
OG
(paren
id|len
op_minus
id|count
)paren
)paren
(brace
id|DPRINTK
(paren
id|KERN_DEBUG
l_string|&quot;%s: leaving %d RLE bytes &quot;
l_string|&quot;for next time&bslash;n&quot;
comma
id|port-&gt;name
comma
id|rle_count
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|rle
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Event 44: Set HostAck high, acknowledging handshake. */
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_AUTOFD
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Event 45: The peripheral has 35ms to set nAck high. */
r_if
c_cond
(paren
id|parport_wait_peripheral
(paren
id|port
comma
id|PARPORT_STATUS_ACK
comma
id|PARPORT_STATUS_ACK
)paren
)paren
(brace
multiline_comment|/* It&squot;s gone wrong.  Return what data we have&n;                           to the caller. */
id|DPRINTK
(paren
id|KERN_DEBUG
l_string|&quot;ECP read timed out at 45&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|command
)paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: command ignored (%02x)&bslash;n&quot;
comma
id|port-&gt;name
comma
id|byte
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Event 46: Set HostAck low and accept the data. */
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_AUTOFD
comma
id|PARPORT_CONTROL_AUTOFD
)paren
suffix:semicolon
multiline_comment|/* If we just read a run-length count, fetch the data. */
r_if
c_cond
(paren
id|command
)paren
r_continue
suffix:semicolon
multiline_comment|/* If this is the byte after a run-length count, decompress. */
r_if
c_cond
(paren
id|rle
)paren
(brace
id|rle
op_assign
l_int|0
suffix:semicolon
id|memset
(paren
id|buf
comma
id|byte
comma
id|rle_count
)paren
suffix:semicolon
id|buf
op_add_assign
id|rle_count
suffix:semicolon
id|count
op_add_assign
id|rle_count
suffix:semicolon
id|DPRINTK
(paren
id|KERN_DEBUG
l_string|&quot;%s: decompressed to %d bytes&bslash;n&quot;
comma
id|port-&gt;name
comma
id|rle_count
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Normal data byte. */
op_star
id|buf
op_assign
id|byte
suffix:semicolon
id|buf
op_increment
comma
id|count
op_increment
suffix:semicolon
)brace
)brace
id|out
suffix:colon
id|port-&gt;ieee1284.phase
op_assign
id|IEEE1284_PH_REV_IDLE
suffix:semicolon
r_return
id|count
suffix:semicolon
macro_line|#endif /* IEEE1284 support */
)brace
multiline_comment|/* ECP mode, forward channel, commands. */
DECL|function|parport_ieee1284_ecp_write_addr
r_int
id|parport_ieee1284_ecp_write_addr
(paren
r_struct
id|parport
op_star
id|port
comma
r_const
r_void
op_star
id|buffer
comma
r_int
id|len
comma
r_int
id|flags
)paren
(brace
macro_line|#ifndef CONFIG_PARPORT_1284
r_return
l_int|0
suffix:semicolon
macro_line|#else
r_const
r_int
r_char
op_star
id|buf
op_assign
id|buffer
suffix:semicolon
r_int
id|written
suffix:semicolon
r_int
id|retry
suffix:semicolon
id|port
op_assign
id|port-&gt;physport
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;ieee1284.phase
op_ne
id|IEEE1284_PH_FWD_IDLE
)paren
r_if
c_cond
(paren
id|ecp_reverse_to_forward
(paren
id|port
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|port-&gt;ieee1284.phase
op_assign
id|IEEE1284_PH_FWD_DATA
suffix:semicolon
multiline_comment|/* HostAck low (command, not data) */
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_AUTOFD
op_or
id|PARPORT_CONTROL_STROBE
op_or
id|PARPORT_CONTROL_INIT
comma
id|PARPORT_CONTROL_AUTOFD
op_or
id|PARPORT_CONTROL_INIT
)paren
suffix:semicolon
r_for
c_loop
(paren
id|written
op_assign
l_int|0
suffix:semicolon
id|written
OL
id|len
suffix:semicolon
id|written
op_increment
comma
id|buf
op_increment
)paren
(brace
r_int
id|expire
op_assign
id|jiffies
op_plus
id|port-&gt;cad-&gt;timeout
suffix:semicolon
r_int
r_char
id|byte
suffix:semicolon
id|byte
op_assign
op_star
id|buf
suffix:semicolon
id|try_again
suffix:colon
id|parport_write_data
(paren
id|port
comma
id|byte
)paren
suffix:semicolon
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_STROBE
comma
id|PARPORT_CONTROL_STROBE
)paren
suffix:semicolon
id|udelay
(paren
l_int|5
)paren
suffix:semicolon
r_for
c_loop
(paren
id|retry
op_assign
l_int|0
suffix:semicolon
id|retry
OL
l_int|100
suffix:semicolon
id|retry
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|parport_wait_peripheral
(paren
id|port
comma
id|PARPORT_STATUS_BUSY
comma
l_int|0
)paren
)paren
r_goto
id|success
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
(paren
id|current
)paren
)paren
(brace
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_STROBE
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Time for Host Transfer Recovery (page 41 of IEEE1284) */
id|DPRINTK
(paren
id|KERN_DEBUG
l_string|&quot;%s: ECP transfer stalled!&bslash;n&quot;
comma
id|port-&gt;name
)paren
suffix:semicolon
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_INIT
comma
id|PARPORT_CONTROL_INIT
)paren
suffix:semicolon
id|udelay
(paren
l_int|50
)paren
suffix:semicolon
r_if
c_cond
(paren
id|parport_read_status
(paren
id|port
)paren
op_amp
id|PARPORT_STATUS_PAPEROUT
)paren
(brace
multiline_comment|/* It&squot;s buggered. */
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_INIT
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_INIT
comma
l_int|0
)paren
suffix:semicolon
id|udelay
(paren
l_int|50
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|parport_read_status
(paren
id|port
)paren
op_amp
id|PARPORT_STATUS_PAPEROUT
)paren
)paren
r_break
suffix:semicolon
id|DPRINTK
(paren
id|KERN_DEBUG
l_string|&quot;%s: Host transfer recovered&bslash;n&quot;
comma
id|port-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_after_eq
(paren
id|jiffies
comma
id|expire
)paren
)paren
r_break
suffix:semicolon
r_goto
id|try_again
suffix:semicolon
id|success
suffix:colon
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_STROBE
comma
l_int|0
)paren
suffix:semicolon
id|udelay
(paren
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|parport_wait_peripheral
(paren
id|port
comma
id|PARPORT_STATUS_BUSY
comma
id|PARPORT_STATUS_BUSY
)paren
)paren
multiline_comment|/* Peripheral hasn&squot;t accepted the data. */
r_break
suffix:semicolon
)brace
id|port-&gt;ieee1284.phase
op_assign
id|IEEE1284_PH_FWD_IDLE
suffix:semicolon
r_return
id|written
suffix:semicolon
macro_line|#endif /* IEEE1284 support */
)brace
multiline_comment|/***              *&n; * EPP functions. *&n; *              ***/
multiline_comment|/* EPP mode, forward channel, data. */
DECL|function|parport_ieee1284_epp_write_data
r_int
id|parport_ieee1284_epp_write_data
(paren
r_struct
id|parport
op_star
id|port
comma
r_const
r_void
op_star
id|buffer
comma
r_int
id|len
comma
r_int
id|flags
)paren
(brace
multiline_comment|/* This is untested */
r_int
r_char
op_star
id|bp
op_assign
(paren
r_int
r_char
op_star
)paren
id|buffer
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_STROBE
op_or
id|PARPORT_CONTROL_AUTOFD
op_or
id|PARPORT_CONTROL_SELECT
comma
id|PARPORT_CONTROL_STROBE
op_or
id|PARPORT_CONTROL_SELECT
)paren
suffix:semicolon
id|port-&gt;ops-&gt;data_forward
(paren
id|port
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|len
OG
l_int|0
suffix:semicolon
id|len
op_decrement
comma
id|bp
op_increment
)paren
(brace
multiline_comment|/* Event 62: Write data and strobe data */
id|parport_write_data
(paren
id|port
comma
op_star
id|bp
)paren
suffix:semicolon
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_AUTOFD
comma
id|PARPORT_CONTROL_AUTOFD
)paren
suffix:semicolon
multiline_comment|/* Event 58 */
r_if
c_cond
(paren
id|parport_poll_peripheral
(paren
id|port
comma
id|PARPORT_STATUS_BUSY
comma
l_int|0
comma
l_int|10
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* Event 63 */
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_AUTOFD
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Event 60 */
r_if
c_cond
(paren
id|parport_poll_peripheral
(paren
id|port
comma
id|PARPORT_STATUS_BUSY
comma
id|PARPORT_STATUS_BUSY
comma
l_int|5
)paren
)paren
r_break
suffix:semicolon
id|ret
op_increment
suffix:semicolon
)brace
multiline_comment|/* Event 61 */
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_STROBE
comma
l_int|0
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* EPP mode, reverse channel, data. */
DECL|function|parport_ieee1284_epp_read_data
r_int
id|parport_ieee1284_epp_read_data
(paren
r_struct
id|parport
op_star
id|port
comma
r_void
op_star
id|buffer
comma
r_int
id|len
comma
r_int
id|flags
)paren
(brace
multiline_comment|/* This is untested. */
r_int
r_char
op_star
id|bp
op_assign
(paren
r_int
r_char
op_star
)paren
id|buffer
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_STROBE
op_or
id|PARPORT_CONTROL_SELECT
comma
l_int|0
)paren
suffix:semicolon
id|port-&gt;ops-&gt;data_reverse
(paren
id|port
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|len
OG
l_int|0
suffix:semicolon
id|len
op_decrement
comma
id|bp
op_increment
)paren
(brace
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_AUTOFD
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Event 58 */
r_if
c_cond
(paren
id|parport_poll_peripheral
(paren
id|port
comma
id|PARPORT_STATUS_BUSY
comma
id|PARPORT_STATUS_BUSY
comma
l_int|10
)paren
)paren
r_break
suffix:semicolon
op_star
id|bp
op_assign
id|parport_read_data
(paren
id|port
)paren
suffix:semicolon
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_AUTOFD
comma
id|PARPORT_CONTROL_AUTOFD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|parport_poll_peripheral
(paren
id|port
comma
id|PARPORT_STATUS_BUSY
comma
l_int|0
comma
l_int|5
)paren
)paren
r_break
suffix:semicolon
id|ret
op_increment
suffix:semicolon
)brace
id|port-&gt;ops-&gt;data_forward
(paren
id|port
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* EPP mode, forward channel, addresses. */
DECL|function|parport_ieee1284_epp_write_addr
r_int
id|parport_ieee1284_epp_write_addr
(paren
r_struct
id|parport
op_star
id|port
comma
r_const
r_void
op_star
id|buffer
comma
r_int
id|len
comma
r_int
id|flags
)paren
(brace
multiline_comment|/* This is untested */
r_int
r_char
op_star
id|bp
op_assign
(paren
r_int
r_char
op_star
)paren
id|buffer
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_STROBE
op_or
id|PARPORT_CONTROL_SELECT
op_or
id|PARPORT_CONTROL_AUTOFD
comma
id|PARPORT_CONTROL_STROBE
op_or
id|PARPORT_CONTROL_SELECT
)paren
suffix:semicolon
id|port-&gt;ops-&gt;data_forward
(paren
id|port
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|len
OG
l_int|0
suffix:semicolon
id|len
op_decrement
comma
id|bp
op_increment
)paren
(brace
multiline_comment|/* Write data and assert nAStrb. */
id|parport_write_data
(paren
id|port
comma
op_star
id|bp
)paren
suffix:semicolon
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_SELECT
comma
id|PARPORT_CONTROL_SELECT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|parport_poll_peripheral
(paren
id|port
comma
id|PARPORT_STATUS_BUSY
comma
id|PARPORT_STATUS_BUSY
comma
l_int|10
)paren
)paren
r_break
suffix:semicolon
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_SELECT
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|parport_poll_peripheral
(paren
id|port
comma
id|PARPORT_STATUS_BUSY
comma
l_int|0
comma
l_int|5
)paren
)paren
r_break
suffix:semicolon
id|ret
op_increment
suffix:semicolon
)brace
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_STROBE
comma
l_int|0
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* EPP mode, reverse channel, addresses. */
DECL|function|parport_ieee1284_epp_read_addr
r_int
id|parport_ieee1284_epp_read_addr
(paren
r_struct
id|parport
op_star
id|port
comma
r_void
op_star
id|buffer
comma
r_int
id|len
comma
r_int
id|flags
)paren
(brace
multiline_comment|/* This is untested. */
r_int
r_char
op_star
id|bp
op_assign
(paren
r_int
r_char
op_star
)paren
id|buffer
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_STROBE
op_or
id|PARPORT_CONTROL_AUTOFD
comma
l_int|0
)paren
suffix:semicolon
id|port-&gt;ops-&gt;data_reverse
(paren
id|port
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|len
OG
l_int|0
suffix:semicolon
id|len
op_decrement
comma
id|bp
op_increment
)paren
(brace
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_SELECT
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Event 58 */
r_if
c_cond
(paren
id|parport_poll_peripheral
(paren
id|port
comma
id|PARPORT_STATUS_BUSY
comma
id|PARPORT_STATUS_BUSY
comma
l_int|10
)paren
)paren
r_break
suffix:semicolon
op_star
id|bp
op_assign
id|parport_read_data
(paren
id|port
)paren
suffix:semicolon
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_SELECT
comma
id|PARPORT_CONTROL_SELECT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|parport_poll_peripheral
(paren
id|port
comma
id|PARPORT_STATUS_BUSY
comma
l_int|0
comma
l_int|5
)paren
)paren
r_break
suffix:semicolon
id|ret
op_increment
suffix:semicolon
)brace
id|port-&gt;ops-&gt;data_forward
(paren
id|port
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
eof
