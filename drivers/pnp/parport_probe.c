multiline_comment|/* $Id: parport_probe.c,v 1.3 1997/10/19 18:18:46 phil Exp $ &n; * Parallel port device probing code&n; * &n; * Authors:    Carsten Gross, carsten@sol.wohnheim.uni-ulm.de&n; *             Philip Blundell &lt;Philip.Blundell@pobox.com&gt;&n; */
macro_line|#include &lt;linux/tasks.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;linux/parport.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/lp.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
DECL|macro|DEBUG_PROBE
macro_line|#undef DEBUG_PROBE
DECL|function|read_nibble
r_static
r_inline
r_int
id|read_nibble
c_func
(paren
r_struct
id|parport
op_star
id|port
)paren
(brace
r_int
r_char
id|i
suffix:semicolon
id|i
op_assign
id|parport_read_status
c_func
(paren
id|port
)paren
op_rshift
l_int|3
suffix:semicolon
id|i
op_and_assign
op_complement
l_int|8
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_amp
l_int|0x10
)paren
op_eq
l_int|0
)paren
id|i
op_or_assign
l_int|8
suffix:semicolon
r_return
(paren
id|i
op_amp
l_int|0x0f
)paren
suffix:semicolon
)brace
DECL|function|read_terminate
r_static
r_void
id|read_terminate
c_func
(paren
r_struct
id|parport
op_star
id|port
)paren
(brace
id|parport_write_control
c_func
(paren
id|port
comma
(paren
id|parport_read_control
c_func
(paren
id|port
)paren
op_amp
op_complement
l_int|2
)paren
op_or
l_int|8
)paren
suffix:semicolon
multiline_comment|/* SelectIN high, AutoFeed low */
r_if
c_cond
(paren
id|parport_wait_peripheral
c_func
(paren
id|port
comma
l_int|0x80
comma
l_int|0
)paren
)paren
multiline_comment|/* timeout, SelectIN high, Autofeed low */
r_return
suffix:semicolon
id|parport_write_control
c_func
(paren
id|port
comma
id|parport_read_control
c_func
(paren
id|port
)paren
op_or
l_int|2
)paren
suffix:semicolon
multiline_comment|/* AutoFeed high */
id|parport_wait_peripheral
c_func
(paren
id|port
comma
l_int|0x80
comma
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/* no timeout possible, Autofeed low, SelectIN high */
id|parport_write_control
c_func
(paren
id|port
comma
(paren
id|parport_read_control
c_func
(paren
id|port
)paren
op_amp
op_complement
l_int|2
)paren
op_or
l_int|8
)paren
suffix:semicolon
)brace
DECL|function|read_polled
r_static
r_int
id|read_polled
c_func
(paren
r_struct
id|parport
op_star
id|port
comma
r_char
op_star
id|buf
comma
r_int
r_int
id|length
)paren
(brace
r_int
id|i
suffix:semicolon
r_char
op_star
id|temp
op_assign
id|buf
suffix:semicolon
r_int
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|z
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|Byte
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
suffix:semicolon
id|i
op_increment
)paren
(brace
id|parport_write_control
c_func
(paren
id|port
comma
id|parport_read_control
c_func
(paren
id|port
)paren
op_or
l_int|2
)paren
suffix:semicolon
multiline_comment|/* AutoFeed high */
r_if
c_cond
(paren
id|parport_wait_peripheral
c_func
(paren
id|port
comma
l_int|0x40
comma
l_int|0
)paren
)paren
(brace
macro_line|#ifdef DEBUG_PROBE
multiline_comment|/* Some peripherals just time out when they&squot;ve sent&n;&t;&t;&t;   all their data.  */
id|printk
c_func
(paren
l_string|&quot;%s: read1 timeout.&bslash;n&quot;
comma
id|port-&gt;name
)paren
suffix:semicolon
macro_line|#endif
id|parport_write_control
c_func
(paren
id|port
comma
id|parport_read_control
c_func
(paren
id|port
)paren
op_amp
op_complement
l_int|2
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|z
op_assign
id|read_nibble
c_func
(paren
id|port
)paren
suffix:semicolon
id|parport_write_control
c_func
(paren
id|port
comma
id|parport_read_control
c_func
(paren
id|port
)paren
op_amp
op_complement
l_int|2
)paren
suffix:semicolon
multiline_comment|/* AutoFeed low */
r_if
c_cond
(paren
id|parport_wait_peripheral
c_func
(paren
id|port
comma
l_int|0x40
comma
l_int|0x40
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: read2 timeout.&bslash;n&quot;
comma
id|port-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|i
op_amp
l_int|1
)paren
op_ne
l_int|0
)paren
(brace
id|Byte
op_or_assign
(paren
id|z
op_lshift
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|temp
)paren
op_star
(paren
id|temp
op_increment
)paren
op_assign
id|Byte
suffix:semicolon
r_if
c_cond
(paren
id|count
op_increment
op_eq
id|length
)paren
id|temp
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Does the error line indicate end of data? */
r_if
c_cond
(paren
(paren
id|parport_read_status
c_func
(paren
id|port
)paren
op_amp
id|LP_PERRORP
)paren
op_eq
id|LP_PERRORP
)paren
r_break
suffix:semicolon
)brace
r_else
id|Byte
op_assign
id|z
suffix:semicolon
)brace
id|read_terminate
c_func
(paren
id|port
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|parport_probe
r_int
id|parport_probe
c_func
(paren
r_struct
id|parport
op_star
id|port
comma
r_char
op_star
id|buffer
comma
r_int
id|len
)paren
(brace
r_struct
id|pardevice
op_star
id|dev
op_assign
id|parport_register_device
c_func
(paren
id|port
comma
l_string|&quot;IEEE 1284 probe&quot;
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
id|PARPORT_DEV_TRAN
comma
op_amp
id|dev
)paren
suffix:semicolon
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: unable to register for probe.&bslash;n&quot;
comma
id|port-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|parport_claim_or_block
c_func
(paren
id|dev
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|parport_ieee1284_nibble_mode_ok
c_func
(paren
id|port
comma
l_int|4
)paren
)paren
(brace
r_case
l_int|1
suffix:colon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|current-&gt;timeout
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* HACK: wait 10ms because printer seems to&n;&t;&t;&t;&t; * ack wrong */
id|result
op_assign
id|read_polled
c_func
(paren
id|port
comma
id|buffer
comma
id|len
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0
suffix:colon
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
id|parport_release
c_func
(paren
id|dev
)paren
suffix:semicolon
id|parport_unregister_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_static
r_struct
(brace
DECL|member|token
r_char
op_star
id|token
suffix:semicolon
DECL|member|descr
r_char
op_star
id|descr
suffix:semicolon
DECL|variable|classes
)brace
id|classes
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;&quot;
comma
l_string|&quot;Legacy device&quot;
)brace
comma
(brace
l_string|&quot;PRINTER&quot;
comma
l_string|&quot;Printer&quot;
)brace
comma
(brace
l_string|&quot;MODEM&quot;
comma
l_string|&quot;Modem&quot;
)brace
comma
(brace
l_string|&quot;NET&quot;
comma
l_string|&quot;Network device&quot;
)brace
comma
(brace
l_string|&quot;HDC&quot;
comma
l_string|&quot;Hard disk&quot;
)brace
comma
(brace
l_string|&quot;PCMCIA&quot;
comma
l_string|&quot;PCMCIA&quot;
)brace
comma
(brace
l_string|&quot;MEDIA&quot;
comma
l_string|&quot;Multimedia device&quot;
)brace
comma
(brace
l_string|&quot;FDC&quot;
comma
l_string|&quot;Floppy disk&quot;
)brace
comma
(brace
l_string|&quot;PORTS&quot;
comma
l_string|&quot;Ports&quot;
)brace
comma
(brace
l_string|&quot;SCANNER&quot;
comma
l_string|&quot;Scanner&quot;
)brace
comma
(brace
l_string|&quot;DIGICAM&quot;
comma
l_string|&quot;Digital camera&quot;
)brace
comma
(brace
l_string|&quot;&quot;
comma
l_string|&quot;Unknown device&quot;
)brace
comma
(brace
l_string|&quot;&quot;
comma
l_string|&quot;Unspecified&quot;
)brace
comma
(brace
l_int|NULL
comma
l_int|NULL
)brace
)brace
suffix:semicolon
DECL|function|strdup
r_static
r_char
op_star
id|strdup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_int
id|n
op_assign
id|strlen
c_func
(paren
id|str
)paren
op_plus
l_int|1
suffix:semicolon
r_char
op_star
id|s
op_assign
id|kmalloc
c_func
(paren
id|n
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s
)paren
r_return
l_int|NULL
suffix:semicolon
r_return
id|strcpy
c_func
(paren
id|s
comma
id|str
)paren
suffix:semicolon
)brace
DECL|function|parse_data
r_static
r_void
id|parse_data
c_func
(paren
r_struct
id|parport
op_star
id|port
comma
r_char
op_star
id|str
)paren
(brace
r_char
op_star
id|txt
op_assign
id|kmalloc
c_func
(paren
id|strlen
c_func
(paren
id|str
)paren
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_char
op_star
id|p
op_assign
id|txt
comma
op_star
id|q
suffix:semicolon
r_int
id|guessed_class
op_assign
id|PARPORT_CLASS_UNSPEC
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|txt
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s probe: memory squeeze&bslash;n&quot;
comma
id|port-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|txt
comma
id|str
)paren
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
r_char
op_star
id|sep
suffix:semicolon
id|q
op_assign
id|strchr
c_func
(paren
id|p
comma
l_char|&squot;;&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q
)paren
op_star
id|q
op_assign
l_int|0
suffix:semicolon
id|sep
op_assign
id|strchr
c_func
(paren
id|p
comma
l_char|&squot;:&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sep
)paren
(brace
r_char
op_star
id|u
op_assign
id|p
suffix:semicolon
op_star
(paren
id|sep
op_increment
)paren
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_star
id|u
)paren
(brace
op_star
id|u
op_assign
id|toupper
c_func
(paren
op_star
id|u
)paren
suffix:semicolon
id|u
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|p
comma
l_string|&quot;MFG&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
c_func
(paren
id|p
comma
l_string|&quot;MANUFACTURER&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
id|port-&gt;probe_info.mfr
)paren
id|kfree
(paren
id|port-&gt;probe_info.mfr
)paren
suffix:semicolon
id|port-&gt;probe_info.mfr
op_assign
id|strdup
c_func
(paren
id|sep
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|p
comma
l_string|&quot;MDL&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
c_func
(paren
id|p
comma
l_string|&quot;MODEL&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
id|port-&gt;probe_info.model
)paren
id|kfree
(paren
id|port-&gt;probe_info.model
)paren
suffix:semicolon
id|port-&gt;probe_info.model
op_assign
id|strdup
c_func
(paren
id|sep
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|p
comma
l_string|&quot;CLS&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
c_func
(paren
id|p
comma
l_string|&quot;CLASS&quot;
)paren
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;probe_info.class_name
)paren
id|kfree
(paren
id|port-&gt;probe_info.class_name
)paren
suffix:semicolon
id|port-&gt;probe_info.class_name
op_assign
id|strdup
c_func
(paren
id|sep
)paren
suffix:semicolon
r_for
c_loop
(paren
id|u
op_assign
id|sep
suffix:semicolon
op_star
id|u
suffix:semicolon
id|u
op_increment
)paren
op_star
id|u
op_assign
id|toupper
c_func
(paren
op_star
id|u
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|classes
(braket
id|i
)braket
dot
id|token
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|classes
(braket
id|i
)braket
dot
id|token
comma
id|sep
)paren
)paren
(brace
id|port-&gt;probe_info
dot
r_class
op_assign
id|i
suffix:semicolon
r_goto
id|rock_on
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s probe: warning, class &squot;%s&squot; not understood.&bslash;n&quot;
comma
id|port-&gt;name
comma
id|sep
)paren
suffix:semicolon
id|port-&gt;probe_info
dot
r_class
op_assign
id|PARPORT_CLASS_OTHER
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|p
comma
l_string|&quot;CMD&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
c_func
(paren
id|p
comma
l_string|&quot;COMMAND SET&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
id|port-&gt;probe_info.cmdset
)paren
id|kfree
(paren
id|port-&gt;probe_info.cmdset
)paren
suffix:semicolon
id|port-&gt;probe_info.cmdset
op_assign
id|strdup
c_func
(paren
id|sep
)paren
suffix:semicolon
multiline_comment|/* if it speaks printer language, it&squot;s&n;&t;&t;&t;&t;   probably a printer */
r_if
c_cond
(paren
id|strstr
c_func
(paren
id|sep
comma
l_string|&quot;PJL&quot;
)paren
op_logical_or
id|strstr
c_func
(paren
id|sep
comma
l_string|&quot;PCL&quot;
)paren
)paren
id|guessed_class
op_assign
id|PARPORT_CLASS_PRINTER
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|p
comma
l_string|&quot;DES&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
c_func
(paren
id|p
comma
l_string|&quot;DESCRIPTION&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
id|port-&gt;probe_info.description
)paren
id|kfree
(paren
id|port-&gt;probe_info.description
)paren
suffix:semicolon
id|port-&gt;probe_info.description
op_assign
id|strdup
c_func
(paren
id|sep
)paren
suffix:semicolon
)brace
)brace
id|rock_on
suffix:colon
r_if
c_cond
(paren
id|q
)paren
id|p
op_assign
id|q
op_plus
l_int|1
suffix:semicolon
r_else
id|p
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* If the device didn&squot;t tell us its class, maybe we have managed to&n;&t;   guess one from the things it did say. */
r_if
c_cond
(paren
id|port-&gt;probe_info
dot
r_class
op_eq
id|PARPORT_CLASS_UNSPEC
)paren
id|port-&gt;probe_info
dot
r_class
op_assign
id|guessed_class
suffix:semicolon
id|kfree
c_func
(paren
id|txt
)paren
suffix:semicolon
)brace
DECL|function|pretty_print
r_static
r_void
id|pretty_print
c_func
(paren
r_struct
id|parport
op_star
id|port
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s&quot;
comma
id|port-&gt;name
comma
id|classes
(braket
id|port-&gt;probe_info
dot
r_class
)braket
dot
id|descr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;probe_info
dot
r_class
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;, %s %s&quot;
comma
id|port-&gt;probe_info.mfr
comma
id|port-&gt;probe_info.model
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|parport_probe_one
r_void
id|parport_probe_one
c_func
(paren
r_struct
id|parport
op_star
id|port
)paren
(brace
r_char
op_star
id|buffer
op_assign
id|kmalloc
c_func
(paren
l_int|2048
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_int
id|r
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|port-&gt;probe_info.model
op_assign
id|strdup
(paren
l_string|&quot;Unknown device&quot;
)paren
suffix:semicolon
id|port-&gt;probe_info.mfr
op_assign
id|strdup
(paren
l_string|&quot;Unknown vendor&quot;
)paren
suffix:semicolon
id|port-&gt;probe_info.description
op_assign
id|port-&gt;probe_info.cmdset
op_assign
l_int|NULL
suffix:semicolon
id|port-&gt;probe_info
dot
r_class
op_assign
id|PARPORT_CLASS_UNSPEC
suffix:semicolon
id|port-&gt;probe_info.class_name
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s probe: Memory squeeze.&bslash;n&quot;
comma
id|port-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|r
op_assign
id|parport_probe
c_func
(paren
id|port
comma
id|buffer
comma
l_int|2047
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: no IEEE-1284 device present.&bslash;n&quot;
comma
id|port-&gt;name
)paren
suffix:semicolon
id|port-&gt;probe_info
dot
r_class
op_assign
id|PARPORT_CLASS_LEGACY
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|r
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: no ID data returned by device.&bslash;n&quot;
comma
id|port-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
id|buffer
(braket
id|r
)braket
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef DEBUG_PROBE
id|printk
c_func
(paren
l_string|&quot;%s id: %s&bslash;n&quot;
comma
id|port-&gt;name
comma
id|buffer
op_plus
l_int|2
)paren
suffix:semicolon
macro_line|#endif
id|parse_data
c_func
(paren
id|port
comma
id|buffer
op_plus
l_int|2
)paren
suffix:semicolon
id|pretty_print
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|buffer
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
macro_line|#if MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_struct
id|parport
op_star
id|p
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|parport_enumerate
c_func
(paren
)paren
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
id|parport_probe_one
c_func
(paren
id|p
)paren
suffix:semicolon
id|parport_probe_hook
op_assign
op_amp
id|parport_probe_one
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|parport_probe_hook
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#endif
eof
