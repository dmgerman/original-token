multiline_comment|/*&n;   * Copyright 1996 The Australian National University.&n;   * Copyright 1996 Fujitsu Laboratories Limited&n;   * &n;   * This software may be distributed under the terms of the Gnu&n;   * Public License version 2 or later&n;  */
multiline_comment|/* &n; * ddv.c - Single AP1000 block driver.&n; *&n; * This block driver performs io operations to the ddv option&n; * board. (Hopefully:)&n; *&n; */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/ext2_fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
DECL|macro|__KERNEL_SYSCALLS__
mdefine_line|#define __KERNEL_SYSCALLS__
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;asm/ap1000/apreg.h&gt;
macro_line|#include &lt;asm/ap1000/DdvReqTable.h&gt;
DECL|macro|MAJOR_NR
mdefine_line|#define MAJOR_NR DDV_MAJOR
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/genhd.h&gt;
macro_line|#include &lt;linux/hdreg.h&gt; 
DECL|macro|DDV_DEBUG
mdefine_line|#define DDV_DEBUG 0
DECL|macro|AIR_DISK
mdefine_line|#define AIR_DISK 1
DECL|macro|SECTOR_SIZE
mdefine_line|#define SECTOR_SIZE 512
multiline_comment|/* we can have lots of partitions */
DECL|macro|PARTN_BITS
mdefine_line|#define PARTN_BITS 6
DECL|macro|NUM_DDVDEVS
mdefine_line|#define NUM_DDVDEVS (1&lt;&lt;PARTN_BITS)
DECL|macro|PARDISK_BASE
mdefine_line|#define PARDISK_BASE (1&lt;&lt;5) /* partitions above this number are &n;&t;&t;&t;       striped&t;across all the cells */
DECL|macro|STRIPE_SHIFT
mdefine_line|#define STRIPE_SHIFT   6
DECL|macro|STRIPE_SECTORS
mdefine_line|#define STRIPE_SECTORS (1&lt;&lt;STRIPE_SHIFT) /* number of sectors per stripe */
DECL|macro|MAX_BNUM
mdefine_line|#define MAX_BNUM 16
DECL|macro|MAX_REQUEST
mdefine_line|#define MAX_REQUEST (TABLE_SIZE - 2)
DECL|macro|REQUEST_LOW
mdefine_line|#define REQUEST_LOW 16
DECL|macro|REQUEST_HIGH
mdefine_line|#define REQUEST_HIGH 4
multiline_comment|/* we fake up a block size larger than the physical block size to try&n;   to make things a bit more efficient */
DECL|macro|SECTOR_BLOCK_SHIFT
mdefine_line|#define SECTOR_BLOCK_SHIFT 9
multiline_comment|/* try to read ahead a bit */
DECL|macro|DDV_READ_AHEAD
mdefine_line|#define DDV_READ_AHEAD 64
DECL|variable|have_ddv_board
r_static
r_int
id|have_ddv_board
op_assign
l_int|1
suffix:semicolon
DECL|variable|num_options
r_static
r_int
id|num_options
op_assign
l_int|0
suffix:semicolon
DECL|variable|this_option
r_static
r_int
id|this_option
op_assign
l_int|0
suffix:semicolon
r_extern
r_int
id|ddv_get_mlist
c_func
(paren
r_int
id|mptr
(braket
)braket
comma
r_int
id|bnum
)paren
suffix:semicolon
r_extern
r_int
id|ddv_set_request
c_func
(paren
r_struct
id|request
op_star
id|req
comma
r_int
id|request_type
comma
r_int
id|bnum
comma
r_int
id|mlist
comma
r_int
id|len
comma
r_int
id|offset
)paren
suffix:semicolon
r_extern
r_void
id|ddv_load_kernel
c_func
(paren
r_char
op_star
id|opcodep
)paren
suffix:semicolon
r_extern
r_int
id|ddv_restart_cpu
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_int
id|ddv_mlist_available
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|ddv_revalidate
c_func
(paren
id|kdev_t
id|dev
comma
r_struct
id|gendisk
op_star
id|gdev
)paren
suffix:semicolon
r_static
r_void
id|ddv_geninit
c_func
(paren
r_struct
id|gendisk
op_star
id|ignored
)paren
suffix:semicolon
r_static
r_void
id|ddv_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_void
id|ddv_request1
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|variable|ddv_opcodep
r_static
r_char
op_star
id|ddv_opcodep
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|next_request
r_static
r_struct
id|request
op_star
id|next_request
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|busy_wait
r_static
r_struct
id|wait_queue
op_star
id|busy_wait
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|ddv_blocksizes
r_static
r_int
id|ddv_blocksizes
(braket
id|NUM_DDVDEVS
)braket
suffix:semicolon
multiline_comment|/* in bytes */
DECL|variable|ddv_sect_length
r_int
id|ddv_sect_length
(braket
id|NUM_DDVDEVS
)braket
suffix:semicolon
multiline_comment|/* in sectors */
DECL|variable|ddv_blk_length
r_int
id|ddv_blk_length
(braket
id|NUM_DDVDEVS
)braket
suffix:semicolon
multiline_comment|/* in blocks */
multiline_comment|/* these are used by the ddv_daemon, which services remote disk requests */
DECL|variable|rem_queue
r_static
r_struct
id|remote_request
op_star
id|rem_queue
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|rem_queue_end
r_static
r_struct
id|remote_request
op_star
id|rem_queue_end
suffix:semicolon
DECL|variable|ddv_daemon_wait
r_static
r_struct
id|wait_queue
op_star
id|ddv_daemon_wait
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|opiu_kernel_loaded
r_static
r_int
id|opiu_kernel_loaded
op_assign
l_int|0
suffix:semicolon
r_static
r_struct
(brace
DECL|member|reads
DECL|member|writes
DECL|member|blocks
DECL|member|rq_started
DECL|member|rq_finished
DECL|member|errors
r_int
id|reads
comma
id|writes
comma
id|blocks
comma
id|rq_started
comma
id|rq_finished
comma
id|errors
suffix:semicolon
DECL|member|sectors_read
DECL|member|sectors_written
r_int
id|sectors_read
comma
id|sectors_written
suffix:semicolon
DECL|variable|ddv_stats
)brace
id|ddv_stats
suffix:semicolon
DECL|variable|partition_tables
r_static
r_struct
id|hd_struct
id|partition_tables
(braket
id|NUM_DDVDEVS
)braket
suffix:semicolon
DECL|variable|ddv_gendisk
r_static
r_struct
id|gendisk
id|ddv_gendisk
op_assign
(brace
id|MAJOR_NR
comma
multiline_comment|/* Major number */
id|DEVICE_NAME
comma
multiline_comment|/* Major name */
id|PARTN_BITS
comma
multiline_comment|/* Bits to shift to get real from partition */
l_int|1
op_lshift
id|PARTN_BITS
comma
multiline_comment|/* Number of partitions per real */
l_int|1
comma
multiline_comment|/* maximum number of real */
macro_line|#ifdef MODULE
l_int|NULL
comma
multiline_comment|/* called from init_module */
macro_line|#else
id|ddv_geninit
comma
multiline_comment|/* init function */
macro_line|#endif
id|partition_tables
comma
multiline_comment|/* hd struct */
id|ddv_blk_length
comma
multiline_comment|/* block sizes */
l_int|1
comma
multiline_comment|/* number */
(paren
r_void
op_star
)paren
l_int|NULL
comma
multiline_comment|/* internal */
l_int|NULL
multiline_comment|/* next */
)brace
suffix:semicolon
DECL|struct|ddv_geometry
r_struct
id|ddv_geometry
(brace
DECL|member|heads
r_int
r_char
id|heads
suffix:semicolon
DECL|member|sectors
r_int
r_char
id|sectors
suffix:semicolon
DECL|member|cylinders
r_int
r_int
id|cylinders
suffix:semicolon
DECL|member|start
r_int
r_int
id|start
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|ddv_geometry
r_static
r_struct
id|ddv_geometry
id|ddv_geometry
suffix:semicolon
DECL|struct|remote_request
r_struct
id|remote_request
(brace
r_union
(brace
DECL|member|next
r_struct
id|remote_request
op_star
id|next
suffix:semicolon
DECL|member|fn
r_void
(paren
op_star
id|fn
)paren
(paren
r_void
)paren
suffix:semicolon
DECL|member|u
)brace
id|u
suffix:semicolon
DECL|member|bnum
r_int
id|bnum
suffix:semicolon
multiline_comment|/* how many blocks does this contain */
DECL|member|reqp
r_struct
id|request
op_star
id|reqp
suffix:semicolon
multiline_comment|/* pointer to the request on the original cell */
DECL|member|cell
r_int
id|cell
suffix:semicolon
multiline_comment|/* what cell is the request from */
DECL|member|req
r_struct
id|request
id|req
suffix:semicolon
multiline_comment|/* details of the request */
)brace
suffix:semicolon
DECL|function|ddv_set_optadr
r_static
r_void
id|ddv_set_optadr
c_func
(paren
r_void
)paren
(brace
r_int
id|addr
op_assign
l_int|0x11000000
suffix:semicolon
id|OPT_IO
c_func
(paren
id|OBASE
)paren
op_assign
id|addr
suffix:semicolon
id|MSC_IO
c_func
(paren
id|MSC_OPTADR
)paren
op_assign
(paren
(paren
id|addr
op_amp
l_int|0xff000000
)paren
op_rshift
l_int|16
)paren
op_or
(paren
(paren
id|OPTION_BASE
op_amp
l_int|0xf0000000
)paren
op_rshift
l_int|24
)paren
op_or
(paren
(paren
id|OPTION_BASE
op_plus
l_int|0x10000000
)paren
op_rshift
l_int|28
)paren
suffix:semicolon
id|OPT_IO
c_func
(paren
id|PRST
)paren
op_assign
l_int|0
suffix:semicolon
)brace
r_extern
r_struct
id|RequestTable
op_star
id|RTable
suffix:semicolon
r_extern
r_struct
id|OPrintBufArray
op_star
id|PrintBufs
suffix:semicolon
r_extern
r_struct
id|OAlignBufArray
op_star
id|AlignBufs
suffix:semicolon
r_extern
r_struct
id|DiskInfo
op_star
id|DiskInfo
suffix:semicolon
DECL|function|ddv_release
r_static
r_void
id|ddv_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;ddv_release started&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|sync_dev
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;ddv_release done&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|variable|in_request
r_static
r_int
id|in_request
op_assign
l_int|0
suffix:semicolon
DECL|variable|req_queued
r_static
r_int
id|req_queued
op_assign
l_int|0
suffix:semicolon
DECL|function|ddv_end_request
r_static
r_void
id|ddv_end_request
c_func
(paren
r_int
id|uptodate
comma
r_struct
id|request
op_star
id|req
)paren
(brace
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
id|ddv_stats.rq_finished
op_increment
suffix:semicolon
multiline_comment|/*&t;printk(&quot;ddv_end_request(%d,%p)&bslash;n&quot;,uptodate,req); */
id|req-&gt;errors
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|uptodate
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;end_request: I/O error, dev %s, sector %lu&bslash;n&quot;
comma
id|kdevname
c_func
(paren
id|req-&gt;rq_dev
)paren
comma
id|req-&gt;sector
)paren
suffix:semicolon
id|req-&gt;nr_sectors
op_decrement
suffix:semicolon
id|req-&gt;nr_sectors
op_and_assign
op_complement
id|SECTOR_MASK
suffix:semicolon
id|req-&gt;sector
op_add_assign
(paren
id|BLOCK_SIZE
op_div
id|SECTOR_SIZE
)paren
suffix:semicolon
id|req-&gt;sector
op_and_assign
op_complement
id|SECTOR_MASK
suffix:semicolon
id|ddv_stats.errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|bh
op_assign
id|req-&gt;bh
)paren
op_ne
l_int|NULL
)paren
(brace
id|req-&gt;bh
op_assign
id|bh-&gt;b_reqnext
suffix:semicolon
id|bh-&gt;b_reqnext
op_assign
l_int|NULL
suffix:semicolon
id|mark_buffer_uptodate
c_func
(paren
id|bh
comma
id|uptodate
)paren
suffix:semicolon
id|unlock_buffer
c_func
(paren
id|bh
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|bh
op_assign
id|req-&gt;bh
)paren
op_ne
l_int|NULL
)paren
(brace
id|req-&gt;current_nr_sectors
op_assign
id|bh-&gt;b_size
op_rshift
l_int|9
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;nr_sectors
OL
id|req-&gt;current_nr_sectors
)paren
(brace
id|req-&gt;nr_sectors
op_assign
id|req-&gt;current_nr_sectors
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;end_request: buffer-list destroyed&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|req-&gt;buffer
op_assign
id|bh-&gt;b_data
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;WARNING: ddv: more sectors!&bslash;n&quot;
)paren
suffix:semicolon
id|ddv_stats.errors
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|req-&gt;sem
op_ne
l_int|NULL
)paren
id|up
c_func
(paren
id|req-&gt;sem
)paren
suffix:semicolon
id|req-&gt;rq_status
op_assign
id|RQ_INACTIVE
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|wait_for_request
)paren
suffix:semicolon
)brace
multiline_comment|/* check that a request is all OK to process */
DECL|function|request_ok
r_static
r_int
id|request_ok
c_func
(paren
r_struct
id|request
op_star
id|req
)paren
(brace
r_int
id|minor
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|req
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|MAJOR
c_func
(paren
id|req-&gt;rq_dev
)paren
op_ne
id|MAJOR_NR
)paren
id|panic
c_func
(paren
id|DEVICE_NAME
l_string|&quot;: bad major number&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer_locked
c_func
(paren
id|req-&gt;bh
)paren
)paren
id|panic
c_func
(paren
id|DEVICE_NAME
l_string|&quot;: block not locked&quot;
)paren
suffix:semicolon
id|minor
op_assign
id|MINOR
c_func
(paren
id|req-&gt;rq_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|minor
op_ge
id|NUM_DDVDEVS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ddv_request: Invalid minor (%d)&bslash;n&quot;
comma
id|minor
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|req-&gt;sector
op_plus
id|req-&gt;current_nr_sectors
)paren
OG
id|ddv_sect_length
(braket
id|minor
)braket
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ddv: out of range minor=%d offset=%d len=%d sect_length=%d&bslash;n&quot;
comma
id|minor
comma
(paren
r_int
)paren
id|req-&gt;sector
comma
(paren
r_int
)paren
id|req-&gt;current_nr_sectors
comma
id|ddv_sect_length
(braket
id|minor
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req-&gt;cmd
op_ne
id|READ
op_logical_and
id|req-&gt;cmd
op_ne
id|WRITE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;unknown request type %d&bslash;n&quot;
comma
id|req-&gt;cmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* it seems to be OK */
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|complete_request
r_static
r_void
id|complete_request
c_func
(paren
r_struct
id|request
op_star
id|req
comma
r_int
id|bnum
)paren
(brace
r_while
c_loop
(paren
id|bnum
op_decrement
)paren
(brace
id|ddv_end_request
c_func
(paren
l_int|1
comma
id|req
)paren
suffix:semicolon
id|req
op_assign
id|req-&gt;next
suffix:semicolon
)brace
)brace
DECL|variable|completion_pointer
r_static
r_int
id|completion_pointer
op_assign
l_int|0
suffix:semicolon
DECL|function|check_completion
r_static
r_void
id|check_completion
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|bnum
suffix:semicolon
r_struct
id|request
op_star
id|req
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|RTable
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
(paren
id|i
op_assign
id|completion_pointer
)paren
op_ne
id|RTable-&gt;ddv_pointer
op_logical_and
id|RTable-&gt;async_info
(braket
id|i
)braket
dot
id|status
op_eq
id|DDV_REQ_FREE
suffix:semicolon
id|completion_pointer
op_assign
id|INC_T
c_func
(paren
id|completion_pointer
)paren
)paren
(brace
id|req
op_assign
(paren
r_struct
id|request
op_star
)paren
id|RTable-&gt;async_info
(braket
id|i
)braket
dot
id|argv
(braket
l_int|7
)braket
suffix:semicolon
id|bnum
op_assign
id|RTable-&gt;async_info
(braket
id|i
)braket
dot
id|bnum
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|req
op_logical_or
op_logical_neg
id|bnum
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s(%d)&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
id|ddv_stats.errors
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|RTable-&gt;async_info
(braket
id|i
)braket
dot
id|status
op_assign
l_int|0
suffix:semicolon
id|RTable-&gt;async_info
(braket
id|i
)braket
dot
id|argv
(braket
l_int|7
)braket
op_assign
l_int|0
suffix:semicolon
id|complete_request
c_func
(paren
id|req
comma
id|bnum
)paren
suffix:semicolon
id|in_request
op_decrement
suffix:semicolon
)brace
)brace
DECL|function|get_request_queue
r_static
r_struct
id|request
op_star
id|get_request_queue
c_func
(paren
r_struct
id|request
op_star
id|oldq
)paren
(brace
r_struct
id|request
op_star
id|req
comma
op_star
id|req2
suffix:semicolon
multiline_comment|/* skip any non-active or bad requests */
id|skip1
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|CURRENT
)paren
)paren
r_return
id|oldq
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;rq_status
op_ne
id|RQ_ACTIVE
)paren
(brace
id|CURRENT
op_assign
id|req-&gt;next
suffix:semicolon
r_goto
id|skip1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|request_ok
c_func
(paren
id|req
)paren
)paren
(brace
id|ddv_end_request
c_func
(paren
l_int|0
comma
id|req
)paren
suffix:semicolon
id|CURRENT
op_assign
id|req-&gt;next
suffix:semicolon
r_goto
id|skip1
suffix:semicolon
)brace
multiline_comment|/* now grab as many as we can */
id|req_queued
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|req2
op_assign
id|req
suffix:semicolon
id|req2-&gt;next
op_logical_and
id|req2-&gt;next-&gt;rq_status
op_eq
id|RQ_ACTIVE
op_logical_and
id|request_ok
c_func
(paren
id|req2-&gt;next
)paren
suffix:semicolon
id|req2
op_assign
id|req2-&gt;next
)paren
id|req_queued
op_increment
suffix:semicolon
multiline_comment|/* leave CURRENT pointing at the bad ones */
id|CURRENT
op_assign
id|req2-&gt;next
suffix:semicolon
multiline_comment|/* chop our list at that point */
id|req2-&gt;next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|oldq
)paren
r_return
id|req
suffix:semicolon
r_for
c_loop
(paren
id|req2
op_assign
id|oldq
suffix:semicolon
id|req2-&gt;next
suffix:semicolon
id|req2
op_assign
id|req2-&gt;next
)paren
suffix:semicolon
id|req2-&gt;next
op_assign
id|req
suffix:semicolon
r_return
id|oldq
suffix:semicolon
)brace
DECL|function|ddv_rem_complete
r_static
r_void
id|ddv_rem_complete
c_func
(paren
r_struct
id|remote_request
op_star
id|rem
)paren
(brace
r_int
id|flags
suffix:semicolon
r_int
id|bnum
op_assign
id|rem-&gt;bnum
suffix:semicolon
r_struct
id|request
op_star
id|req
op_assign
id|rem-&gt;reqp
suffix:semicolon
id|complete_request
c_func
(paren
id|req
comma
id|bnum
)paren
suffix:semicolon
id|in_request
op_decrement
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|ddv_request1
c_func
(paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * The background ddv daemon. This receives remote disk requests&n; * and processes them via the normal block operations&n; */
DECL|function|ddv_daemon
r_static
r_int
id|ddv_daemon
c_func
(paren
r_void
op_star
id|unused
)paren
(brace
id|current-&gt;session
op_assign
l_int|1
suffix:semicolon
id|current-&gt;pgrp
op_assign
l_int|1
suffix:semicolon
id|sprintf
c_func
(paren
id|current-&gt;comm
comma
l_string|&quot;ddv_daemon&quot;
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|current-&gt;sigmask_lock
)paren
suffix:semicolon
id|sigfillset
c_func
(paren
op_amp
id|current-&gt;blocked
)paren
suffix:semicolon
multiline_comment|/* block all signals */
id|recalc_sigpending
c_func
(paren
id|current
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|current-&gt;sigmask_lock
)paren
suffix:semicolon
multiline_comment|/* Give it a realtime priority. */
id|current-&gt;policy
op_assign
id|SCHED_FIFO
suffix:semicolon
id|current-&gt;priority
op_assign
l_int|32
suffix:semicolon
multiline_comment|/* Fixme --- we need to standardise our&n;&t;&t;&t;&t;    namings for POSIX.4 realtime scheduling&n;&t;&t;&t;&t;    priorities.  */
id|printk
c_func
(paren
l_string|&quot;Started ddv_daemon&bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_struct
id|remote_request
op_star
id|rem
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bhlist
(braket
id|MAX_BNUM
op_star
l_int|4
)braket
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|minor
comma
id|len
comma
id|shift
comma
id|offset
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|rem_queue
)paren
(brace
id|spin_lock_irq
c_func
(paren
op_amp
id|current-&gt;sigmask_lock
)paren
suffix:semicolon
id|flush_signals
c_func
(paren
id|current
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|current-&gt;sigmask_lock
)paren
suffix:semicolon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|ddv_daemon_wait
)paren
suffix:semicolon
)brace
id|rem
op_assign
id|rem_queue
suffix:semicolon
id|rem_queue
op_assign
id|rem-&gt;u.next
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|minor
op_assign
id|MINOR
c_func
(paren
id|rem-&gt;req.rq_dev
)paren
suffix:semicolon
id|len
op_assign
id|rem-&gt;req.current_nr_sectors
suffix:semicolon
id|offset
op_assign
id|rem-&gt;req.sector
suffix:semicolon
multiline_comment|/* work out the conversion to the local block size from&n;&t;&t;   sectors */
r_for
c_loop
(paren
id|shift
op_assign
l_int|0
suffix:semicolon
(paren
id|SECTOR_SIZE
op_lshift
id|shift
)paren
op_ne
id|ddv_blocksizes
(braket
id|minor
)braket
suffix:semicolon
id|shift
op_increment
)paren
suffix:semicolon
multiline_comment|/* do the request */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|bhlist
(braket
id|i
)braket
op_assign
id|getblk
c_func
(paren
id|rem-&gt;req.rq_dev
comma
id|offset
op_rshift
id|shift
comma
id|ddv_blocksizes
(braket
id|minor
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer_uptodate
c_func
(paren
id|bhlist
(braket
id|i
)braket
)paren
)paren
id|ll_rw_block
c_func
(paren
id|READ
comma
l_int|1
comma
op_amp
id|bhlist
(braket
id|i
)braket
)paren
suffix:semicolon
id|offset
op_add_assign
l_int|1
op_lshift
id|shift
suffix:semicolon
id|len
op_sub_assign
l_int|1
op_lshift
id|shift
suffix:semicolon
)brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|i
suffix:semicolon
id|j
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|buffer_uptodate
c_func
(paren
id|bhlist
(braket
id|j
)braket
)paren
)paren
id|wait_on_buffer
c_func
(paren
id|bhlist
(braket
id|j
)braket
)paren
suffix:semicolon
multiline_comment|/* put() the data */
multiline_comment|/* release the buffers */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|i
suffix:semicolon
id|j
op_increment
)paren
id|brelse
c_func
(paren
id|bhlist
(braket
id|j
)braket
)paren
suffix:semicolon
multiline_comment|/* tell the originator that its done */
id|rem-&gt;u.fn
op_assign
id|ddv_rem_complete
suffix:semicolon
id|tnet_rpc
c_func
(paren
id|rem-&gt;cell
comma
id|rem
comma
r_sizeof
(paren
r_int
)paren
op_star
l_int|3
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* receive a remote disk request */
DECL|function|ddv_rem_queue
r_static
r_void
id|ddv_rem_queue
c_func
(paren
r_char
op_star
id|data
comma
r_int
id|size
)paren
(brace
r_int
id|flags
suffix:semicolon
r_struct
id|remote_request
op_star
id|rem
op_assign
(paren
r_struct
id|remote_request
op_star
)paren
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rem
)paren
(brace
multiline_comment|/* oh bugger! */
id|ddv_stats.errors
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|rem
comma
id|data
comma
id|size
)paren
suffix:semicolon
id|rem-&gt;u.next
op_assign
l_int|NULL
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* add it to our remote request queue */
r_if
c_cond
(paren
op_logical_neg
id|rem_queue
)paren
id|rem_queue
op_assign
id|rem
suffix:semicolon
r_else
id|rem_queue_end-&gt;u.next
op_assign
id|rem
suffix:semicolon
id|rem_queue_end
op_assign
id|rem
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|ddv_daemon_wait
)paren
suffix:semicolon
)brace
multiline_comment|/* which disk should this request go to */
DECL|function|pardisk_num
r_static
r_inline
r_int
id|pardisk_num
c_func
(paren
r_struct
id|request
op_star
id|req
)paren
(brace
r_int
id|minor
op_assign
id|MINOR
c_func
(paren
id|req-&gt;rq_dev
)paren
suffix:semicolon
r_int
id|stripe
suffix:semicolon
r_int
id|cell
suffix:semicolon
r_if
c_cond
(paren
id|minor
OL
id|PARDISK_BASE
)paren
r_return
id|this_option
suffix:semicolon
id|stripe
op_assign
id|req-&gt;sector
op_rshift
id|STRIPE_SHIFT
suffix:semicolon
id|cell
op_assign
id|stripe
op_mod
id|num_options
suffix:semicolon
r_return
id|cell
suffix:semicolon
)brace
multiline_comment|/* check if a 2nd request can be tacked onto the first */
DECL|function|contiguous
r_static
r_inline
r_int
id|contiguous
c_func
(paren
r_struct
id|request
op_star
id|req1
comma
r_struct
id|request
op_star
id|req2
)paren
(brace
r_if
c_cond
(paren
id|req2-&gt;cmd
op_ne
id|req1-&gt;cmd
op_logical_or
id|req2-&gt;rq_dev
op_ne
id|req1-&gt;rq_dev
op_logical_or
id|req2-&gt;sector
op_ne
id|req1-&gt;sector
op_plus
id|req1-&gt;current_nr_sectors
op_logical_or
id|req2-&gt;current_nr_sectors
op_ne
id|req1-&gt;current_nr_sectors
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pardisk_num
c_func
(paren
id|req1
)paren
op_ne
id|pardisk_num
c_func
(paren
id|req2
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|ddv_request1
r_static
r_void
id|ddv_request1
c_func
(paren
r_void
)paren
(brace
r_struct
id|request
op_star
id|req
comma
op_star
id|req1
comma
op_star
id|req2
suffix:semicolon
r_int
id|offset
comma
id|len
comma
id|req_num
comma
id|mlist
comma
id|bnum
comma
id|available
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|mptrs
(braket
id|MAX_BNUM
)braket
suffix:semicolon
r_int
id|cell
suffix:semicolon
r_if
c_cond
(paren
id|in_request
OG
id|REQUEST_HIGH
)paren
r_return
suffix:semicolon
id|next_request
op_assign
id|get_request_queue
c_func
(paren
id|next_request
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|req
op_assign
id|next_request
)paren
)paren
(brace
r_int
id|minor
suffix:semicolon
r_if
c_cond
(paren
id|in_request
op_ge
id|MAX_REQUEST
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|in_request
OG
l_int|1
op_logical_and
id|req_queued
OL
id|REQUEST_LOW
)paren
r_return
suffix:semicolon
multiline_comment|/* make sure we have room for a request */
id|available
op_assign
id|ddv_mlist_available
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|available
OL
l_int|1
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|available
OG
id|MAX_BNUM
)paren
id|available
op_assign
id|MAX_BNUM
suffix:semicolon
id|offset
op_assign
id|req-&gt;sector
suffix:semicolon
id|len
op_assign
id|req-&gt;current_nr_sectors
suffix:semicolon
id|minor
op_assign
id|MINOR
c_func
(paren
id|req-&gt;rq_dev
)paren
suffix:semicolon
id|mptrs
(braket
l_int|0
)braket
op_assign
(paren
r_int
)paren
id|req-&gt;buffer
suffix:semicolon
r_for
c_loop
(paren
id|bnum
op_assign
l_int|1
comma
id|req1
op_assign
id|req
comma
id|req2
op_assign
id|req-&gt;next
suffix:semicolon
id|req2
op_logical_and
id|bnum
OL
id|available
op_logical_and
id|contiguous
c_func
(paren
id|req1
comma
id|req2
)paren
suffix:semicolon
id|req1
op_assign
id|req2
comma
id|req2
op_assign
id|req2-&gt;next
)paren
(brace
id|mptrs
(braket
id|bnum
op_increment
)braket
op_assign
(paren
r_int
)paren
id|req2-&gt;buffer
suffix:semicolon
)brace
id|next_request
op_assign
id|req2
suffix:semicolon
id|req_queued
op_sub_assign
id|bnum
suffix:semicolon
id|ddv_stats.blocks
op_add_assign
id|bnum
suffix:semicolon
id|ddv_stats.rq_started
op_add_assign
id|bnum
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;cmd
op_eq
id|READ
)paren
(brace
id|ddv_stats.reads
op_increment
suffix:semicolon
id|ddv_stats.sectors_read
op_add_assign
id|len
op_star
id|bnum
suffix:semicolon
)brace
r_else
(brace
id|ddv_stats.writes
op_increment
suffix:semicolon
id|ddv_stats.sectors_written
op_add_assign
id|len
op_star
id|bnum
suffix:semicolon
)brace
r_if
c_cond
(paren
id|minor
op_ge
id|PARDISK_BASE
)paren
(brace
multiline_comment|/* translate the request to the normal partition */
r_int
id|stripe
suffix:semicolon
id|minor
op_sub_assign
id|PARDISK_BASE
suffix:semicolon
id|stripe
op_assign
id|offset
op_rshift
id|STRIPE_SHIFT
suffix:semicolon
id|stripe
op_div_assign
id|num_options
suffix:semicolon
id|offset
op_assign
(paren
id|stripe
op_lshift
id|STRIPE_SHIFT
)paren
op_plus
(paren
id|offset
op_amp
(paren
(paren
l_int|1
op_lshift
id|STRIPE_SHIFT
)paren
op_minus
l_int|1
)paren
)paren
suffix:semicolon
macro_line|#if AIR_DISK 
multiline_comment|/* like an air-guitar :-) */
id|complete_request
c_func
(paren
id|req
comma
id|bnum
)paren
suffix:semicolon
r_continue
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
(paren
id|cell
op_assign
id|pardisk_num
c_func
(paren
id|req
)paren
)paren
op_ne
id|this_option
)paren
(brace
multiline_comment|/* its a remote request */
r_struct
id|remote_request
op_star
id|rem
suffix:semicolon
r_int
op_star
id|remlist
suffix:semicolon
r_int
id|size
op_assign
r_sizeof
(paren
op_star
id|rem
)paren
op_plus
r_sizeof
(paren
r_int
)paren
op_star
id|bnum
suffix:semicolon
id|rem
op_assign
(paren
r_struct
id|remote_request
op_star
)paren
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rem
)paren
(brace
multiline_comment|/* hopefully we can get it on the next go */
r_return
suffix:semicolon
)brace
id|remlist
op_assign
(paren
r_int
op_star
)paren
(paren
id|rem
op_plus
l_int|1
)paren
suffix:semicolon
id|rem-&gt;u.fn
op_assign
id|ddv_rem_queue
suffix:semicolon
id|rem-&gt;cell
op_assign
id|this_option
suffix:semicolon
id|rem-&gt;bnum
op_assign
id|bnum
suffix:semicolon
id|rem-&gt;req
op_assign
op_star
id|req
suffix:semicolon
id|rem-&gt;reqp
op_assign
id|req
suffix:semicolon
id|rem-&gt;req.rq_dev
op_assign
id|MKDEV
c_func
(paren
id|MAJOR_NR
comma
id|minor
)paren
suffix:semicolon
id|rem-&gt;req.sector
op_assign
id|offset
suffix:semicolon
id|memcpy
c_func
(paren
id|remlist
comma
id|mptrs
comma
r_sizeof
(paren
id|mptrs
(braket
l_int|0
)braket
)paren
op_star
id|bnum
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tnet_rpc
c_func
(paren
id|cell
comma
id|rem
comma
id|size
comma
l_int|1
)paren
op_ne
l_int|0
)paren
(brace
id|kfree_s
c_func
(paren
id|rem
comma
id|size
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* its a local request */
r_if
c_cond
(paren
(paren
id|mlist
op_assign
id|ddv_get_mlist
c_func
(paren
id|mptrs
comma
id|bnum
)paren
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|ddv_stats.errors
op_increment
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;ddv: mlist corrupted&quot;
)paren
suffix:semicolon
)brace
id|req_num
op_assign
id|RTable-&gt;cell_pointer
suffix:semicolon
id|RTable-&gt;async_info
(braket
id|req_num
)braket
dot
id|status
op_assign
id|req-&gt;cmd
op_eq
id|READ
ques
c_cond
id|DDV_RAWREAD_REQ
suffix:colon
id|DDV_RAWWRITE_REQ
suffix:semicolon
id|RTable-&gt;async_info
(braket
id|req_num
)braket
dot
id|bnum
op_assign
id|bnum
suffix:semicolon
id|RTable-&gt;async_info
(braket
id|req_num
)braket
dot
id|argv
(braket
l_int|0
)braket
op_assign
id|mlist
suffix:semicolon
id|RTable-&gt;async_info
(braket
id|req_num
)braket
dot
id|argv
(braket
l_int|1
)braket
op_assign
id|len
suffix:semicolon
id|RTable-&gt;async_info
(braket
id|req_num
)braket
dot
id|argv
(braket
l_int|2
)braket
op_assign
id|offset
op_plus
id|partition_tables
(braket
id|minor
)braket
dot
id|start_sect
suffix:semicolon
id|RTable-&gt;async_info
(braket
id|req_num
)braket
dot
id|argv
(braket
l_int|3
)braket
op_assign
id|bnum
suffix:semicolon
id|RTable-&gt;async_info
(braket
id|req_num
)braket
dot
id|argv
(braket
l_int|7
)braket
op_assign
(paren
r_int
)paren
id|req
suffix:semicolon
id|RTable-&gt;cell_pointer
op_assign
id|INC_T
c_func
(paren
id|RTable-&gt;cell_pointer
)paren
suffix:semicolon
)brace
id|in_request
op_increment
suffix:semicolon
)brace
)brace
DECL|function|ddv_request
r_static
r_void
id|ddv_request
c_func
(paren
r_void
)paren
(brace
id|cli
c_func
(paren
)paren
suffix:semicolon
id|ddv_request1
c_func
(paren
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|check_printbufs
r_static
r_void
id|check_printbufs
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|PrintBufs
)paren
r_return
suffix:semicolon
r_while
c_loop
(paren
id|PrintBufs-&gt;option_counter
op_ne
id|PrintBufs-&gt;cell_counter
)paren
(brace
id|i
op_assign
id|PrintBufs-&gt;cell_counter
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;opiu (%d): &quot;
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_int
)paren
id|PrintBufs-&gt;bufs
(braket
id|i
)braket
dot
id|fmt
)paren
OG
l_int|0x100000
)paren
id|printk
c_func
(paren
l_string|&quot;Error: bad format in printk at %p&bslash;n&quot;
comma
id|PrintBufs-&gt;bufs
(braket
id|i
)braket
dot
id|fmt
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|PrintBufs-&gt;bufs
(braket
id|i
)braket
dot
id|fmt
op_plus
id|OPIBUS_BASE
comma
id|PrintBufs-&gt;bufs
(braket
id|i
)braket
dot
id|args
(braket
l_int|0
)braket
comma
id|PrintBufs-&gt;bufs
(braket
id|i
)braket
dot
id|args
(braket
l_int|1
)braket
comma
id|PrintBufs-&gt;bufs
(braket
id|i
)braket
dot
id|args
(braket
l_int|2
)braket
comma
id|PrintBufs-&gt;bufs
(braket
id|i
)braket
dot
id|args
(braket
l_int|3
)braket
comma
id|PrintBufs-&gt;bufs
(braket
id|i
)braket
dot
id|args
(braket
l_int|4
)braket
comma
id|PrintBufs-&gt;bufs
(braket
id|i
)braket
dot
id|args
(braket
l_int|5
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|PrintBufs-&gt;cell_counter
op_eq
id|PRINT_BUFS
)paren
id|PrintBufs-&gt;cell_counter
op_assign
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|ddv_interrupt
r_static
r_void
id|ddv_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|OPT_IO
c_func
(paren
id|IRC1
)paren
op_assign
l_int|0x80000000
suffix:semicolon
id|check_printbufs
c_func
(paren
)paren
suffix:semicolon
id|check_completion
c_func
(paren
)paren
suffix:semicolon
id|ddv_request1
c_func
(paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|ddv_open
r_static
r_int
id|ddv_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_int
id|minor
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|have_ddv_board
op_logical_or
id|minor
op_ge
id|NUM_DDVDEVS
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|minor
op_ge
id|PARDISK_BASE
)paren
(brace
id|ddv_sect_length
(braket
id|minor
)braket
op_assign
id|ddv_sect_length
(braket
id|minor
op_minus
id|PARDISK_BASE
)braket
suffix:semicolon
id|ddv_blk_length
(braket
id|minor
)braket
op_assign
id|ddv_blk_length
(braket
id|minor
op_minus
id|PARDISK_BASE
)braket
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ddv_open_reply
r_static
r_void
id|ddv_open_reply
c_func
(paren
r_struct
id|cap_request
op_star
id|creq
)paren
(brace
r_int
id|size
op_assign
id|creq-&gt;size
op_minus
r_sizeof
(paren
op_star
id|creq
)paren
suffix:semicolon
id|ddv_opcodep
op_assign
(paren
r_char
op_star
)paren
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|read_bif
c_func
(paren
id|ddv_opcodep
comma
id|size
)paren
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;received opiu kernel of size %d&bslash;n&quot;
comma
id|size
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|size
op_eq
l_int|0
)paren
id|have_ddv_board
op_assign
l_int|0
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|busy_wait
)paren
suffix:semicolon
)brace
DECL|function|ddv_load_opiu
r_static
r_void
id|ddv_load_opiu
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|cap_request
id|creq
suffix:semicolon
multiline_comment|/* if the opiu kernel is already loaded then we don&squot;t do anything */
r_if
c_cond
(paren
op_logical_neg
id|have_ddv_board
op_logical_or
id|opiu_kernel_loaded
)paren
r_return
suffix:semicolon
id|bif_register_request
c_func
(paren
id|REQ_DDVOPEN
comma
id|ddv_open_reply
)paren
suffix:semicolon
multiline_comment|/* send the open request to the front end */
id|creq.cid
op_assign
id|mpp_cid
c_func
(paren
)paren
suffix:semicolon
id|creq.type
op_assign
id|REQ_DDVOPEN
suffix:semicolon
id|creq.header
op_assign
l_int|0
suffix:semicolon
id|creq.size
op_assign
r_sizeof
(paren
id|creq
)paren
suffix:semicolon
id|bif_queue
c_func
(paren
op_amp
id|creq
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|ddv_set_optadr
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|ddv_opcodep
)paren
id|sleep_on
c_func
(paren
op_amp
id|busy_wait
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|have_ddv_board
)paren
r_return
suffix:semicolon
id|ddv_load_kernel
c_func
(paren
id|ddv_opcodep
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ddv_opcodep
)paren
suffix:semicolon
id|ddv_opcodep
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|ddv_restart_cpu
c_func
(paren
)paren
)paren
r_return
suffix:semicolon
id|ddv_sect_length
(braket
l_int|0
)braket
op_assign
id|DiskInfo-&gt;blocks
suffix:semicolon
id|ddv_blk_length
(braket
l_int|0
)braket
op_assign
id|DiskInfo-&gt;blocks
op_rshift
l_int|1
suffix:semicolon
id|ddv_blocksizes
(braket
l_int|0
)braket
op_assign
id|BLOCK_SIZE
suffix:semicolon
id|ddv_geometry.cylinders
op_assign
id|ddv_sect_length
(braket
l_int|0
)braket
op_div
(paren
id|ddv_geometry.heads
op_star
id|ddv_geometry.sectors
)paren
suffix:semicolon
id|ddv_gendisk.part
(braket
l_int|0
)braket
dot
id|start_sect
op_assign
l_int|0
suffix:semicolon
id|ddv_gendisk.part
(braket
l_int|0
)braket
dot
id|nr_sects
op_assign
id|ddv_sect_length
(braket
l_int|0
)braket
suffix:semicolon
id|resetup_one_dev
c_func
(paren
op_amp
id|ddv_gendisk
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PARDISK_BASE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ddv_sect_length
(braket
id|i
)braket
op_assign
id|ddv_gendisk.part
(braket
id|i
)braket
dot
id|nr_sects
suffix:semicolon
id|ddv_blk_length
(braket
id|i
)braket
op_assign
id|ddv_gendisk.part
(braket
id|i
)braket
dot
id|nr_sects
op_rshift
l_int|1
suffix:semicolon
)brace
multiline_comment|/* setup the parallel partitions by multiplying the normal&n;&t;   partition by the number of options */
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
id|NUM_DDVDEVS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ddv_sect_length
(braket
id|i
)braket
op_assign
id|ddv_sect_length
(braket
id|i
op_minus
id|PARDISK_BASE
)braket
op_star
id|num_options
suffix:semicolon
id|ddv_blk_length
(braket
id|i
)braket
op_assign
id|ddv_blk_length
(braket
id|i
op_minus
id|PARDISK_BASE
)braket
op_star
id|num_options
suffix:semicolon
id|ddv_gendisk.part
(braket
id|i
)braket
dot
id|start_sect
op_assign
id|ddv_gendisk.part
(braket
id|i
op_minus
id|PARDISK_BASE
)braket
dot
id|start_sect
suffix:semicolon
id|ddv_gendisk.part
(braket
id|i
)braket
dot
id|nr_sects
op_assign
id|ddv_sect_length
(braket
id|i
)braket
suffix:semicolon
)brace
id|opiu_kernel_loaded
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * This routine is called to flush all partitions and partition tables&n; * for a changed disk, and then re-read the new partition table.&n; */
DECL|function|ddv_revalidate
r_static
r_int
id|ddv_revalidate
c_func
(paren
id|kdev_t
id|dev
comma
r_struct
id|gendisk
op_star
id|gdev
)paren
(brace
r_int
id|target
suffix:semicolon
r_int
id|max_p
suffix:semicolon
r_int
id|start
suffix:semicolon
r_int
id|i
suffix:semicolon
id|target
op_assign
id|DEVICE_NR
c_func
(paren
id|dev
)paren
suffix:semicolon
id|max_p
op_assign
id|gdev-&gt;max_p
suffix:semicolon
id|start
op_assign
id|target
op_lshift
id|gdev-&gt;minor_shift
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ddv_revalidate dev=%d target=%d max_p=%d start=%d&bslash;n&quot;
comma
id|dev
comma
id|target
comma
id|max_p
comma
id|start
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|max_p
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_int
id|minor
op_assign
id|start
op_plus
id|i
suffix:semicolon
id|kdev_t
id|devi
op_assign
id|MKDEV
c_func
(paren
id|gdev-&gt;major
comma
id|minor
)paren
suffix:semicolon
id|sync_dev
c_func
(paren
id|devi
)paren
suffix:semicolon
id|invalidate_inodes
c_func
(paren
id|devi
)paren
suffix:semicolon
id|invalidate_buffers
c_func
(paren
id|devi
)paren
suffix:semicolon
id|gdev-&gt;part
(braket
id|minor
)braket
dot
id|start_sect
op_assign
l_int|0
suffix:semicolon
id|gdev-&gt;part
(braket
id|minor
)braket
dot
id|nr_sects
op_assign
l_int|0
suffix:semicolon
)brace
suffix:semicolon
id|ddv_sect_length
(braket
id|start
)braket
op_assign
id|DiskInfo-&gt;blocks
suffix:semicolon
id|ddv_blk_length
(braket
id|start
)braket
op_assign
id|DiskInfo-&gt;blocks
op_rshift
l_int|1
suffix:semicolon
id|gdev-&gt;part
(braket
id|start
)braket
dot
id|nr_sects
op_assign
id|ddv_sect_length
(braket
id|start
)braket
suffix:semicolon
id|resetup_one_dev
c_func
(paren
id|gdev
comma
id|target
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;sect_length[%d]=%d blk_length[%d]=%d&bslash;n&quot;
comma
id|start
comma
id|ddv_sect_length
(braket
id|start
)braket
comma
id|start
comma
id|ddv_blk_length
(braket
id|start
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|max_p
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ddv_sect_length
(braket
id|start
op_plus
id|i
)braket
op_assign
id|gdev-&gt;part
(braket
id|start
op_plus
id|i
)braket
dot
id|nr_sects
suffix:semicolon
id|ddv_blk_length
(braket
id|start
op_plus
id|i
)braket
op_assign
id|gdev-&gt;part
(braket
id|start
op_plus
id|i
)braket
dot
id|nr_sects
op_rshift
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|gdev-&gt;part
(braket
id|start
op_plus
id|i
)braket
dot
id|nr_sects
)paren
id|printk
c_func
(paren
l_string|&quot;partition[%d] start=%d length=%d&bslash;n&quot;
comma
id|i
comma
(paren
r_int
)paren
id|gdev-&gt;part
(braket
id|start
op_plus
id|i
)braket
dot
id|start_sect
comma
(paren
r_int
)paren
id|gdev-&gt;part
(braket
id|start
op_plus
id|i
)braket
dot
id|nr_sects
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ddv_ioctl
r_static
r_int
id|ddv_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|err
suffix:semicolon
r_struct
id|ddv_geometry
op_star
id|loc
op_assign
(paren
r_struct
id|ddv_geometry
op_star
)paren
id|arg
suffix:semicolon
r_int
id|dev
suffix:semicolon
r_int
id|minor
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|inode
)paren
op_logical_or
op_logical_neg
(paren
id|inode-&gt;i_rdev
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dev
op_assign
id|DEVICE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;ddv_ioctl: cmd=%x dev=%x minor=%d&bslash;n&quot;
comma
id|cmd
comma
id|dev
comma
id|minor
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|HDIO_GETGEO
suffix:colon
id|printk
c_func
(paren
l_string|&quot;&bslash;tHDIO_GETGEO&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|loc
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|ddv_geometry.heads
comma
(paren
r_char
op_star
)paren
op_amp
id|loc-&gt;heads
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|ddv_geometry.sectors
comma
(paren
r_char
op_star
)paren
op_amp
id|loc-&gt;sectors
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|ddv_geometry.cylinders
comma
(paren
r_int
op_star
)paren
op_amp
id|loc-&gt;cylinders
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|ddv_geometry.start
comma
(paren
r_int
op_star
)paren
op_amp
id|loc-&gt;start
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|HDIO_GET_MULTCOUNT
suffix:colon
id|printk
c_func
(paren
l_string|&quot;&bslash;tHDIO_GET_MULTCOUNT&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|HDIO_GET_IDENTITY
suffix:colon
id|printk
c_func
(paren
l_string|&quot;&bslash;tHDIO_GET_IDENTITY&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|HDIO_GET_NOWERR
suffix:colon
id|printk
c_func
(paren
l_string|&quot;&bslash;tHDIO_GET_NOWERR&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|HDIO_SET_NOWERR
suffix:colon
id|printk
c_func
(paren
l_string|&quot;&bslash;tHDIO_SET_NOWERR&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|BLKRRPART
suffix:colon
id|printk
c_func
(paren
l_string|&quot;&bslash;tBLKRRPART&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ddv_revalidate
c_func
(paren
id|inode-&gt;i_rdev
comma
op_amp
id|ddv_gendisk
)paren
suffix:semicolon
r_case
id|BLKGETSIZE
suffix:colon
multiline_comment|/* Return device size */
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|ddv_sect_length
(braket
id|minor
)braket
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;BLKGETSIZE gave %d&bslash;n&quot;
comma
id|ddv_sect_length
(braket
id|minor
)braket
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;ddv_ioctl: Invalid cmd=%d(0x%x)&bslash;n&quot;
comma
id|cmd
comma
id|cmd
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
suffix:semicolon
)brace
DECL|variable|ddv_fops
r_static
r_struct
id|file_operations
id|ddv_fops
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* lseek - default */
id|block_read
comma
multiline_comment|/* read */
id|block_write
comma
multiline_comment|/* write */
l_int|NULL
comma
multiline_comment|/* readdir - bad */
l_int|NULL
comma
multiline_comment|/* poll */
id|ddv_ioctl
comma
multiline_comment|/* ioctl */
l_int|NULL
comma
multiline_comment|/* mmap */
id|ddv_open
comma
multiline_comment|/* open */
id|ddv_release
comma
id|block_fsync
multiline_comment|/* fsync */
)brace
suffix:semicolon
DECL|function|ddv_status
r_static
r_void
id|ddv_status
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|have_ddv_board
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;no ddv board&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
"&quot;"
id|in_request
op_mod
id|u
id|req_queued
op_mod
id|u
id|MTable
suffix:colon
id|start
op_assign
op_mod
id|u
id|end
op_assign
op_mod
id|u
id|Requests
suffix:colon
id|started
op_assign
op_mod
id|u
id|finished
op_assign
op_mod
id|u
id|Requests
suffix:colon
id|completion_pointer
op_assign
op_mod
id|u
id|ddv_pointer
op_assign
op_mod
id|u
id|cell_pointer
op_assign
op_mod
id|u
id|PrintBufs
suffix:colon
id|option_counter
op_assign
op_mod
id|u
id|cell_counter
op_assign
op_mod
id|u
id|ddv_stats
suffix:colon
id|reads
op_assign
op_mod
id|u
id|writes
op_assign
op_mod
id|u
id|blocks
op_assign
op_mod
id|u
id|ddv_stats
suffix:colon
id|sectors_read
op_assign
op_mod
id|u
id|sectors_written
op_assign
op_mod
id|u
id|CURRENT
op_assign
op_mod
id|p
id|next_request
op_assign
op_mod
id|p
id|errors
op_assign
op_mod
id|u
"&quot;"
comma
id|in_request
comma
id|req_queued
comma
id|RTable-&gt;start_mtable
comma
id|RTable-&gt;end_mtable
comma
id|ddv_stats.rq_started
comma
id|ddv_stats.rq_finished
comma
id|completion_pointer
comma
id|RTable-&gt;ddv_pointer
comma
id|RTable-&gt;cell_pointer
comma
id|PrintBufs-&gt;option_counter
comma
id|PrintBufs-&gt;cell_counter
comma
id|ddv_stats.reads
comma
id|ddv_stats.writes
comma
id|ddv_stats.blocks
comma
id|ddv_stats.sectors_read
comma
id|ddv_stats.sectors_written
comma
id|CURRENT
comma
id|next_request
comma
id|ddv_stats.errors
)paren
suffix:semicolon
)brace
DECL|function|ddv_init
r_int
id|ddv_init
c_func
(paren
r_void
)paren
(brace
r_int
id|cid
suffix:semicolon
id|cid
op_assign
id|mpp_cid
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|register_blkdev
c_func
(paren
id|MAJOR_NR
comma
id|DEVICE_NAME
comma
op_amp
id|ddv_fops
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ap: unable to get major %d for ap block dev&bslash;n&quot;
comma
id|MAJOR_NR
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;ddv_init: register dev %d&bslash;n&quot;
comma
id|MAJOR_NR
)paren
suffix:semicolon
id|blk_dev
(braket
id|MAJOR_NR
)braket
dot
id|request_fn
op_assign
id|DEVICE_REQUEST
suffix:semicolon
id|read_ahead
(braket
id|MAJOR_NR
)braket
op_assign
id|DDV_READ_AHEAD
suffix:semicolon
id|bif_add_debug_key
c_func
(paren
l_char|&squot;d&squot;
comma
id|ddv_status
comma
l_string|&quot;DDV status&quot;
)paren
suffix:semicolon
id|ddv_gendisk.next
op_assign
id|gendisk_head
suffix:semicolon
id|gendisk_head
op_assign
op_amp
id|ddv_gendisk
suffix:semicolon
id|num_options
op_assign
id|mpp_num_cells
c_func
(paren
)paren
suffix:semicolon
id|this_option
op_assign
id|mpp_cid
c_func
(paren
)paren
suffix:semicolon
id|kernel_thread
c_func
(paren
id|ddv_daemon
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ddv_geninit
r_static
r_void
id|ddv_geninit
c_func
(paren
r_struct
id|gendisk
op_star
id|ignored
)paren
(brace
r_int
id|i
suffix:semicolon
r_static
r_int
id|done
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|done
)paren
id|printk
c_func
(paren
l_string|&quot;ddv_geninit already done!&bslash;n&quot;
)paren
suffix:semicolon
id|done
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ddv_geninit&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* request interrupt line 2 */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|APOPT0_IRQ
comma
id|ddv_interrupt
comma
id|SA_INTERRUPT
comma
l_string|&quot;apddv&quot;
comma
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Failed to install ddv interrupt handler&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_DDVDEVS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ddv_blocksizes
(braket
id|i
)braket
op_assign
id|BLOCK_SIZE
suffix:semicolon
id|ddv_sect_length
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|ddv_blk_length
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|ddv_geometry.heads
op_assign
l_int|32
suffix:semicolon
id|ddv_geometry.sectors
op_assign
l_int|32
suffix:semicolon
id|ddv_geometry.cylinders
op_assign
l_int|1
suffix:semicolon
id|ddv_geometry.start
op_assign
l_int|0
suffix:semicolon
id|blksize_size
(braket
id|MAJOR_NR
)braket
op_assign
id|ddv_blocksizes
suffix:semicolon
id|ddv_load_opiu
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* loadable module support */
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|error
op_assign
id|ddv_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
(brace
id|ddv_geninit
c_func
(paren
op_amp
(paren
r_struct
id|gendisk
)paren
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;DDV: Loaded as module.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* Before freeing the module, invalidate all of the protected buffers! */
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|gendisk
op_star
op_star
id|gdp
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_DDVDEVS
suffix:semicolon
id|i
op_increment
)paren
id|invalidate_buffers
c_func
(paren
id|MKDEV
c_func
(paren
id|MAJOR_NR
comma
id|i
)paren
)paren
suffix:semicolon
multiline_comment|/* reset the opiu */
id|OPT_IO
c_func
(paren
id|OPIU_OP
)paren
op_assign
id|OPIU_RESET
suffix:semicolon
id|OPT_IO
c_func
(paren
id|PRST
)paren
op_assign
id|PRST_IRST
suffix:semicolon
id|unregister_blkdev
c_func
(paren
id|MAJOR_NR
comma
id|DEVICE_NAME
)paren
suffix:semicolon
r_for
c_loop
(paren
id|gdp
op_assign
op_amp
id|gendisk_head
suffix:semicolon
op_star
id|gdp
suffix:semicolon
id|gdp
op_assign
op_amp
(paren
(paren
op_star
id|gdp
)paren
op_member_access_from_pointer
id|next
)paren
)paren
r_if
c_cond
(paren
op_star
id|gdp
op_eq
op_amp
id|ddv_gendisk
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_star
id|gdp
)paren
op_star
id|gdp
op_assign
(paren
op_star
id|gdp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
id|free_irq
c_func
(paren
id|APOPT0_IRQ
comma
l_int|NULL
)paren
suffix:semicolon
id|blk_dev
(braket
id|MAJOR_NR
)braket
dot
id|request_fn
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif  /* MODULE */
eof
