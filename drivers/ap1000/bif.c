multiline_comment|/*&n;   * Copyright 1996 The Australian National University.&n;   * Copyright 1996 Fujitsu Laboratories Limited&n;   * &n;   * This software may be distributed under the terms of the Gnu&n;   * Public License version 2 or later&n;  */
multiline_comment|/*&n; * $Id: bif.c,v 1.13 1996/12/18 01:45:52 tridge Exp $&n; *&n; * Network interface definitions for bif device.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/if_ether.h&gt;&t;/* For the statistics structure. */
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;&t;/* For ARPHRD_BIF */
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;asm/ap1000/apservice.h&gt;
macro_line|#include &lt;asm/ap1000/apreg.h&gt;
DECL|macro|BIF_DEBUG
mdefine_line|#define BIF_DEBUG 0
macro_line|#if BIF_DEBUG
DECL|variable|seq
r_static
r_int
id|seq
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
DECL|macro|BIF_MTU
mdefine_line|#define BIF_MTU 10240
DECL|variable|bif_device
r_static
r_struct
id|device
op_star
id|bif_device
op_assign
l_int|0
suffix:semicolon
DECL|variable|bif_stats
r_static
r_struct
id|net_device_stats
op_star
id|bif_stats
op_assign
l_int|0
suffix:semicolon
r_int
id|bif_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_int
id|bif_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|bif_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_int
id|bif_rx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_int
id|bif_stop
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|bif_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
DECL|function|bif_hard_header
r_static
r_int
id|bif_hard_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
(brace
macro_line|#if BIF_DEBUG
id|printk
c_func
(paren
l_string|&quot;bif_hard_header()&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|skb_push
c_func
(paren
id|skb
comma
id|dev-&gt;hard_header_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|daddr
)paren
id|skb-&gt;arp
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* tell IP how much space we took */
r_return
(paren
id|dev-&gt;hard_header_len
)paren
suffix:semicolon
)brace
DECL|function|bif_rebuild_header
r_static
r_int
id|bif_rebuild_header
c_func
(paren
r_void
op_star
id|buff
comma
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|raddr
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
multiline_comment|/* this would normally be used to fill in hardware addresses after&n;     an ARP */
macro_line|#if BIF_DEBUG
id|printk
c_func
(paren
l_string|&quot;bif_rebuild_header()&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|skb
)paren
id|skb-&gt;arp
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bif_set_mac_address
r_static
r_int
id|bif_set_mac_address
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_void
op_star
id|addr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;BIF: set_mac_address called&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|bif_set_multicast_list
r_static
r_void
id|bif_set_multicast_list
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_return
suffix:semicolon
)brace
DECL|function|bif_do_ioctl
r_static
r_int
id|bif_do_ioctl
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;BIF: Called do_ioctl&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|bif_set_config
r_static
r_int
id|bif_set_config
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|ifmap
op_star
id|map
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;BIF: Called bif_set_config&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Initialise bif network interface.&n; */
DECL|function|bif_init
r_int
id|bif_init
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;bif_init(): Initialising bif interface&bslash;n&quot;
)paren
suffix:semicolon
id|bif_device
op_assign
id|dev
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|BIF_MTU
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|bif_xmit
suffix:semicolon
id|dev-&gt;hard_header
op_assign
id|bif_hard_header
suffix:semicolon
id|dev-&gt;hard_header_len
op_assign
r_sizeof
(paren
r_struct
id|cap_request
)paren
suffix:semicolon
id|dev-&gt;addr_len
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tx_queue_len
op_assign
l_int|50000
suffix:semicolon
multiline_comment|/* no limit (almost!) */
id|dev-&gt;type
op_assign
id|ARPHRD_BIF
suffix:semicolon
id|dev-&gt;rebuild_header
op_assign
id|bif_rebuild_header
suffix:semicolon
id|dev-&gt;open
op_assign
id|bif_open
suffix:semicolon
id|dev-&gt;flags
op_assign
id|IFF_NOARP
suffix:semicolon
multiline_comment|/* Don&squot;t use ARP on this device */
id|dev-&gt;family
op_assign
id|AF_INET
suffix:semicolon
id|dev-&gt;priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|net_device_stats
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|dev-&gt;priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|net_device_stats
)paren
)paren
suffix:semicolon
id|bif_stats
op_assign
(paren
r_struct
id|net_device_stats
op_star
)paren
id|bif_device-&gt;priv
suffix:semicolon
id|dev-&gt;stop
op_assign
id|bif_stop
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|bif_get_stats
suffix:semicolon
multiline_comment|/* Initialise the bif device structure */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DEV_NUMBUFFS
suffix:semicolon
id|i
op_increment
)paren
id|skb_queue_head_init
c_func
(paren
op_amp
id|dev-&gt;buffs
(braket
id|i
)braket
)paren
suffix:semicolon
id|dev-&gt;set_mac_address
op_assign
id|bif_set_mac_address
suffix:semicolon
id|dev-&gt;header_cache_update
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|bif_do_ioctl
suffix:semicolon
id|dev-&gt;set_config
op_assign
id|bif_set_config
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|bif_set_multicast_list
suffix:semicolon
id|memset
c_func
(paren
id|dev-&gt;broadcast
comma
l_int|0xFF
comma
id|ETH_ALEN
)paren
suffix:semicolon
id|dev-&gt;pa_addr
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pa_brdaddr
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pa_mask
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pa_alen
op_assign
l_int|4
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bif_open
r_int
id|bif_open
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;In bif_open&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if BIF_DEBUG
DECL|function|dump_packet
r_static
r_void
id|dump_packet
c_func
(paren
r_char
op_star
id|action
comma
r_char
op_star
id|buf
comma
r_int
id|len
comma
r_int
id|seq
)paren
(brace
r_int
id|flags
suffix:semicolon
r_char
op_star
id|sep
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s packet %d of %d bytes at %d:&bslash;n&quot;
comma
id|action
comma
id|seq
comma
id|len
comma
(paren
r_int
)paren
id|jiffies
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  from %x to %x pktid=%d ttl=%d pcol=%d len=%d&bslash;n&quot;
comma
op_star
(paren
r_int
op_star
)paren
(paren
id|buf
op_plus
l_int|12
)paren
comma
op_star
(paren
r_int
op_star
)paren
(paren
id|buf
op_plus
l_int|16
)paren
comma
op_star
(paren
id|u_short
op_star
)paren
(paren
id|buf
op_plus
l_int|4
)paren
comma
op_star
(paren
r_int
r_char
op_star
)paren
(paren
id|buf
op_plus
l_int|8
)paren
comma
id|buf
(braket
l_int|9
)braket
comma
op_star
(paren
id|u_short
op_star
)paren
(paren
id|buf
op_plus
l_int|2
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf
(braket
l_int|9
)braket
op_eq
l_int|6
op_logical_or
id|buf
(braket
l_int|9
)braket
op_eq
l_int|17
)paren
(brace
multiline_comment|/* TCP or UDP */
id|printk
c_func
(paren
l_string|&quot;  sport=%d dport=%d&quot;
comma
op_star
(paren
id|u_short
op_star
)paren
(paren
id|buf
op_plus
l_int|20
)paren
comma
op_star
(paren
id|u_short
op_star
)paren
(paren
id|buf
op_plus
l_int|22
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf
(braket
l_int|9
)braket
op_eq
l_int|6
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; seq=%d ack=%d win=%d flags=&lt;&quot;
comma
op_star
(paren
r_int
op_star
)paren
(paren
id|buf
op_plus
l_int|24
)paren
comma
op_star
(paren
r_int
op_star
)paren
(paren
id|buf
op_plus
l_int|28
)paren
comma
op_star
(paren
r_int
r_int
op_star
)paren
(paren
id|buf
op_plus
l_int|34
)paren
)paren
suffix:semicolon
id|flags
op_assign
id|buf
(braket
l_int|33
)braket
suffix:semicolon
id|sep
op_assign
l_string|&quot;&quot;
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&gt;&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;  protocol = %d&bslash;n&quot;
comma
id|buf
(braket
l_int|9
)braket
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
DECL|function|bif_xmit
r_static
r_int
id|bif_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_extern
r_int
id|bif_send_ip
c_func
(paren
r_int
id|cid
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_extern
r_int
id|tnet_send_ip
c_func
(paren
r_int
id|cid
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_extern
r_int
id|msc_blocked
comma
id|tnet_ip_enabled
suffix:semicolon
id|u_long
id|destip
suffix:semicolon
r_int
id|cid
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
op_logical_or
id|dev
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|destip
op_assign
op_star
(paren
id|u_long
op_star
)paren
(paren
id|skb-&gt;data
op_plus
r_sizeof
(paren
r_struct
id|cap_request
)paren
op_plus
l_int|16
)paren
suffix:semicolon
id|cid
op_assign
id|ap_ip_to_cid
c_func
(paren
id|destip
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|cid
op_ne
op_minus
l_int|1
op_logical_and
id|tnet_ip_enabled
op_logical_and
op_logical_neg
id|msc_blocked
)paren
(brace
id|tnet_send_ip
c_func
(paren
id|cid
comma
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
id|bif_send_ip
c_func
(paren
id|cid
comma
id|skb
)paren
suffix:semicolon
)brace
id|dev-&gt;tbusy
op_assign
l_int|0
suffix:semicolon
id|bif_stats-&gt;tx_packets
op_increment
suffix:semicolon
id|mark_bh
c_func
(paren
id|NET_BH
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Receive a packet from the BIF - called from interrupt handler.&n; */
DECL|function|bif_rx
r_int
id|bif_rx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
macro_line|#if BIF_DEBUG
id|dump_packet
c_func
(paren
l_string|&quot;bif_rx:&quot;
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|seq
op_increment
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|bif_device
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;bif: bif_device is NULL in bif_rx&bslash;n&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|bif_device
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|ETH_P_IP
suffix:semicolon
macro_line|#if 1
multiline_comment|/* try disabling checksums on receive */
r_if
c_cond
(paren
id|ap_ip_to_cid
c_func
(paren
op_star
(paren
id|u_long
op_star
)paren
(paren
(paren
(paren
r_char
op_star
)paren
id|skb-&gt;data
)paren
op_plus
l_int|12
)paren
)paren
op_ne
op_minus
l_int|1
)paren
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_UNNECESSARY
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * Inform the network layer of the new packet.&n;&t; */
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bif_stats
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;bif: bif_stats is NULL is bif_rx&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|bif_stats-&gt;rx_packets
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bif_stop
r_int
id|bif_stop
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;in bif_close&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;tbusy
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;start
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Return statistics of bif driver.&n; */
DECL|function|bif_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|bif_get_stats
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_return
(paren
r_struct
id|net_device_stats
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
)brace
eof
