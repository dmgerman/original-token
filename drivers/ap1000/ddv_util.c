multiline_comment|/*&n;   * Copyright 1996 The Australian National University.&n;   * Copyright 1996 Fujitsu Laboratories Limited&n;   * &n;   * This software may be distributed under the terms of the Gnu&n;   * Public License version 2 or later&n;  */
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/genhd.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/ap1000/apreg.h&gt;
macro_line|#include &lt;asm/ap1000/DdvReqTable.h&gt;
DECL|macro|GENDISK_STRUCT
mdefine_line|#define GENDISK_STRUCT ddv_gendisk
DECL|variable|RTable
r_struct
id|RequestTable
op_star
id|RTable
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|PrintBufs
r_struct
id|OPrintBufArray
op_star
id|PrintBufs
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|AlignBufs
r_struct
id|OAlignBufArray
op_star
id|AlignBufs
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|DiskInfo
r_struct
id|DiskInfo
op_star
id|DiskInfo
op_assign
l_int|NULL
suffix:semicolon
r_extern
r_int
id|ddv_length
(braket
)braket
suffix:semicolon
DECL|function|ddv_mlist_available
r_int
id|ddv_mlist_available
c_func
(paren
r_void
)paren
(brace
r_int
id|start
op_assign
id|RTable-&gt;start_mtable
suffix:semicolon
r_int
id|end
op_assign
id|RTable-&gt;end_mtable
suffix:semicolon
r_if
c_cond
(paren
id|start
op_ge
id|end
)paren
r_return
(paren
id|MTABLE_SIZE
op_minus
id|start
)paren
suffix:semicolon
r_return
(paren
id|end
op_plus
l_int|1
)paren
op_minus
id|start
suffix:semicolon
)brace
DECL|function|ddv_get_mlist
r_int
id|ddv_get_mlist
c_func
(paren
r_int
id|mptr
(braket
)braket
comma
r_int
id|bnum
)paren
(brace
r_int
id|available
op_assign
id|ddv_mlist_available
c_func
(paren
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|start
op_assign
id|RTable-&gt;start_mtable
suffix:semicolon
r_if
c_cond
(paren
id|available
OL
id|bnum
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|bnum
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|phys
op_assign
(paren
r_int
)paren
id|mmu_v2p
c_func
(paren
(paren
r_int
)paren
id|mptr
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|phys
op_eq
op_minus
l_int|1
)paren
id|panic
c_func
(paren
l_string|&quot;bad address %x in ddv_get_mlist&bslash;n&quot;
comma
id|mptr
(braket
id|i
)braket
)paren
suffix:semicolon
id|RTable-&gt;mtable
(braket
id|RTable-&gt;start_mtable
)braket
op_assign
id|phys
suffix:semicolon
id|RTable-&gt;start_mtable
op_assign
id|INC_ML
c_func
(paren
id|RTable-&gt;start_mtable
)paren
suffix:semicolon
)brace
r_return
id|start
suffix:semicolon
)brace
DECL|function|ddv_load_kernel
r_void
id|ddv_load_kernel
c_func
(paren
r_char
op_star
id|opcodep
)paren
(brace
r_int
id|tsize
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_struct
id|exec
op_star
id|mhead
suffix:semicolon
id|mhead
op_assign
(paren
r_struct
id|exec
op_star
)paren
id|opcodep
suffix:semicolon
id|p
op_assign
id|opcodep
op_plus
r_sizeof
(paren
op_star
id|mhead
)paren
suffix:semicolon
id|tsize
op_assign
(paren
id|mhead-&gt;a_text
op_plus
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
op_amp
op_complement
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|OPIBUS_BASE
op_plus
id|mhead-&gt;a_entry
comma
id|p
comma
id|mhead-&gt;a_text
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|OPIBUS_BASE
op_plus
id|mhead-&gt;a_entry
op_plus
id|tsize
comma
id|p
op_plus
id|mhead-&gt;a_text
comma
id|mhead-&gt;a_data
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|OPIBUS_BASE
op_plus
id|mhead-&gt;a_entry
op_plus
id|tsize
op_plus
id|mhead-&gt;a_data
comma
l_int|0
comma
id|mhead-&gt;a_bss
op_plus
id|PAGE_SIZE
)paren
suffix:semicolon
macro_line|#ifdef DDV_DEBUG  
id|printk
c_func
(paren
l_string|&quot;CELL(%d) loaded opiu kernel of size %ld %ld %ld (%ld)&bslash;n&quot;
comma
id|ap_getcid
c_func
(paren
)paren
comma
id|mhead-&gt;a_text
comma
id|mhead-&gt;a_data
comma
id|mhead-&gt;a_bss
comma
id|mhead-&gt;a_entry
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|ddv_restart_cpu
r_int
id|ddv_restart_cpu
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|timeout
suffix:semicolon
id|OPT_IO
c_func
(paren
id|OPIU_OP
)paren
op_assign
id|OPIU_RESET
suffix:semicolon
id|OPT_IO
c_func
(paren
id|PRST
)paren
op_assign
id|PRST_IRST
suffix:semicolon
r_if
c_cond
(paren
id|OPT_IO
c_func
(paren
id|PRST
)paren
op_ne
id|PRST_IRST
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;_iu_load reset release error.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|timeout
op_assign
id|jiffies
op_plus
l_int|10
suffix:semicolon
id|time_before
c_func
(paren
id|jiffies
comma
id|timeout
)paren
op_logical_or
(paren
id|OPT_IO
c_func
(paren
id|PBUF0
)paren
op_eq
l_int|0
)paren
suffix:semicolon
)paren
multiline_comment|/* wait */
suffix:semicolon
r_if
c_cond
(paren
id|OPT_IO
c_func
(paren
id|PBUF0
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;WARNING: option kernel didn&squot;t startup&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;option kernel IU running&bslash;n&quot;
)paren
suffix:semicolon
id|DiskInfo
op_assign
(paren
r_struct
id|DiskInfo
op_star
)paren
(paren
id|OPT_IO
c_func
(paren
id|PBUF0
)paren
op_plus
id|OPIBUS_BASE
)paren
suffix:semicolon
id|RTable
op_assign
(paren
r_struct
id|RequestTable
op_star
)paren
(paren
id|DiskInfo-&gt;ptrs
(braket
l_int|0
)braket
op_plus
id|OPIBUS_BASE
)paren
suffix:semicolon
id|PrintBufs
op_assign
(paren
r_struct
id|OPrintBufArray
op_star
)paren
(paren
id|DiskInfo-&gt;ptrs
(braket
l_int|1
)braket
op_plus
id|OPIBUS_BASE
)paren
suffix:semicolon
id|AlignBufs
op_assign
(paren
r_struct
id|OAlignBufArray
op_star
)paren
(paren
id|DiskInfo-&gt;ptrs
(braket
l_int|2
)braket
op_plus
id|OPIBUS_BASE
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Disk capacity: %d blocks of size %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|DiskInfo-&gt;blocks
comma
(paren
r_int
)paren
id|DiskInfo-&gt;blk_size
)paren
suffix:semicolon
id|OPT_IO
c_func
(paren
id|PBUF0
)paren
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
eof
