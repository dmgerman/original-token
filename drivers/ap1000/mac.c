multiline_comment|/*&n;   * Copyright 1996 The Australian National University.&n;   * Copyright 1996 Fujitsu Laboratories Limited&n;   * &n;   * This software may be distributed under the terms of the Gnu&n;   * Public License version 2 or later&n;  */
multiline_comment|/*&n; * Routines for controlling the FORMAC+&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/if_ether.h&gt;&t;/* For the statistics structure. */
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;asm/ap1000/apreg.h&gt;
macro_line|#include &lt;asm/ap1000/apservice.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &quot;apfddi.h&quot;
macro_line|#include &quot;smt-types.h&quot;
macro_line|#include &quot;am79c830.h&quot;
macro_line|#include &quot;mac.h&quot;
macro_line|#include &quot;plc.h&quot;
macro_line|#include &quot;apfddi-reg.h&quot;
DECL|macro|MAC_DEBUG
mdefine_line|#define MAC_DEBUG 0
multiline_comment|/* Values for dma_state */
DECL|macro|IDLE
mdefine_line|#define IDLE            0
DECL|macro|XMITTING
mdefine_line|#define XMITTING&t;1
DECL|macro|RECVING
mdefine_line|#define RECVING&t;&t;2
multiline_comment|/*&n; * Messages greater than this value are transferred to the FDDI send buffer&n; * using DMA.&n; */
DECL|macro|DMA_XMIT_THRESHOLD
mdefine_line|#define DMA_XMIT_THRESHOLD 64
DECL|macro|DMA_RECV_THRESHOLD
mdefine_line|#define DMA_RECV_THRESHOLD 64
multiline_comment|/*&n; * If the FDDI receive buffer is occupied by less than this value, then&n; * sending has priority.&n; */
DECL|macro|RECV_THRESHOLD
mdefine_line|#define RECV_THRESHOLD (20*1024)
DECL|macro|DMA_RESET_MASKS
mdefine_line|#define DMA_RESET_MASKS ((AP_CLR_INTR_MASK&lt;&lt;DMA_INTR_NORMAL_SH) | &bslash;&n;&t;&t;&t; (AP_CLR_INTR_MASK&lt;&lt;DMA_INTR_ERROR_SH))
DECL|macro|DMA_INTR_REQS
mdefine_line|#define DMA_INTR_REQS ((AP_INTR_REQ&lt;&lt;DMA_INTR_NORMAL_SH) | &bslash;&n;&t;&t;       (AP_INTR_REQ&lt;&lt;DMA_INTR_ERROR_SH))
r_static
r_void
id|mac_print_state
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|typedef|mac_status_t
r_typedef
r_int
r_int
id|mac_status_t
suffix:semicolon
DECL|variable|mac_queue_top
r_static
r_volatile
r_struct
id|mac_queue
op_star
id|mac_queue_top
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|mac_queue_bottom
r_static
r_volatile
r_struct
id|mac_queue
op_star
id|mac_queue_bottom
op_assign
l_int|NULL
suffix:semicolon
DECL|struct|formac_state
r_struct
id|formac_state
(brace
DECL|member|loopback
id|LoopbackType
id|loopback
suffix:semicolon
DECL|member|ring_op
r_int
id|ring_op
suffix:semicolon
DECL|member|recv_ptr
r_int
id|recv_ptr
suffix:semicolon
DECL|member|recv_empty
r_int
id|recv_empty
suffix:semicolon
DECL|member|recv_ovf
r_int
id|recv_ovf
suffix:semicolon
DECL|member|xmit_ptr
r_int
id|xmit_ptr
suffix:semicolon
DECL|member|xmit_free
r_int
id|xmit_free
suffix:semicolon
DECL|member|xmit_start
r_int
id|xmit_start
suffix:semicolon
DECL|member|xmit_chains
r_int
id|xmit_chains
suffix:semicolon
DECL|member|xmit_more_ptr
r_int
id|xmit_more_ptr
suffix:semicolon
DECL|member|frames_xmitted
r_int
id|frames_xmitted
suffix:semicolon
DECL|member|xmit_chain_start
r_int
id|xmit_chain_start
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|frames_recvd
r_int
id|frames_recvd
suffix:semicolon
DECL|member|recv_aborted
r_int
id|recv_aborted
suffix:semicolon
DECL|member|xmit_aborted
r_int
id|xmit_aborted
suffix:semicolon
DECL|member|wrong_bb
r_int
id|wrong_bb
suffix:semicolon
DECL|member|recv_error
r_int
id|recv_error
suffix:semicolon
DECL|member|cur_macq
r_volatile
r_struct
id|mac_queue
op_star
id|cur_macq
suffix:semicolon
multiline_comment|/* Current queue el for send DMA   */
DECL|member|cur_mbuf
r_volatile
r_struct
id|mac_buf
id|cur_mbuf
suffix:semicolon
multiline_comment|/* Current mac_buf for send DMA    */
DECL|member|cur_skb
r_struct
id|sk_buff
op_star
id|cur_skb
suffix:semicolon
multiline_comment|/* skb for received packets by DMA */
DECL|member|dma_state
r_int
id|dma_state
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|SPFRAMES_SIZE
mdefine_line|#define SPFRAMES_SIZE&t;64&t;&t;/* # words for special frames area */
DECL|macro|RECV_BUF_START
mdefine_line|#define RECV_BUF_START&t;SPFRAMES_SIZE
DECL|macro|RECV_BUF_END
mdefine_line|#define RECV_BUF_END&t;(BUFFER_SIZE / 2 + 2048)
DECL|macro|RECV_BUF_SIZE
mdefine_line|#define RECV_BUF_SIZE&t;(RECV_BUF_END - RECV_BUF_START)
DECL|macro|XMIT_BUF_START
mdefine_line|#define XMIT_BUF_START&t;RECV_BUF_END
DECL|macro|XMIT_BUF_END
mdefine_line|#define XMIT_BUF_END&t;BUFFER_SIZE
DECL|macro|S2_RMT_EVENTS
mdefine_line|#define S2_RMT_EVENTS&t;(S2_CLAIM_STATE | S2_MY_CLAIM | S2_HIGHER_CLAIM | &bslash;&n;&t;&t;&t; S2_LOWER_CLAIM | S2_BEACON_STATE | S2_MY_BEACON | &bslash;&n;&t;&t;&t; S2_OTHER_BEACON | S2_RING_OP | S2_MULTIPLE_DA | &bslash;&n;&t;&t;&t; S2_TOKEN_ERR | S2_DUPL_CLAIM | S2_TRT_EXP_RECOV)
DECL|variable|this_mac_info
r_struct
id|mac_info
op_star
id|this_mac_info
suffix:semicolon
DECL|variable|this_mac_state
r_struct
id|formac_state
id|this_mac_state
suffix:semicolon
r_int
DECL|function|mac_init
id|mac_init
c_func
(paren
r_struct
id|mac_info
op_star
id|mip
)paren
(brace
r_struct
id|formac_state
op_star
id|msp
op_assign
op_amp
id|this_mac_state
suffix:semicolon
id|bif_add_debug_key
c_func
(paren
l_char|&squot;f&squot;
comma
id|mac_print_state
comma
l_string|&quot;show FDDI mac state&quot;
)paren
suffix:semicolon
id|this_mac_info
op_assign
id|mip
suffix:semicolon
id|mac-&gt;cmdreg1
op_assign
id|C1_SOFTWARE_RESET
suffix:semicolon
id|mac-&gt;said
op_assign
(paren
id|mip-&gt;s_address
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_plus
id|mip-&gt;s_address
(braket
l_int|1
)braket
suffix:semicolon
id|mac-&gt;laim
op_assign
(paren
id|mip-&gt;l_address
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_plus
id|mip-&gt;l_address
(braket
l_int|1
)braket
suffix:semicolon
id|mac-&gt;laic
op_assign
(paren
id|mip-&gt;l_address
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_plus
id|mip-&gt;l_address
(braket
l_int|3
)braket
suffix:semicolon
id|mac-&gt;lail
op_assign
(paren
id|mip-&gt;l_address
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_plus
id|mip-&gt;l_address
(braket
l_int|5
)braket
suffix:semicolon
id|mac-&gt;sagp
op_assign
(paren
id|mip-&gt;s_group_adrs
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_plus
id|mip-&gt;s_group_adrs
(braket
l_int|1
)braket
suffix:semicolon
id|mac-&gt;lagm
op_assign
(paren
id|mip-&gt;l_group_adrs
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_plus
id|mip-&gt;l_group_adrs
(braket
l_int|1
)braket
suffix:semicolon
id|mac-&gt;lagc
op_assign
(paren
id|mip-&gt;l_group_adrs
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_plus
id|mip-&gt;l_group_adrs
(braket
l_int|3
)braket
suffix:semicolon
id|mac-&gt;lagl
op_assign
(paren
id|mip-&gt;l_group_adrs
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_plus
id|mip-&gt;l_group_adrs
(braket
l_int|5
)braket
suffix:semicolon
id|mac-&gt;tmax
op_assign
id|mip-&gt;tmax
op_rshift
l_int|5
suffix:semicolon
id|mac-&gt;tvx
op_assign
(paren
id|mip-&gt;tvx
op_minus
l_int|254
)paren
op_div
l_int|255
suffix:semicolon
multiline_comment|/* it&squot;s -ve, round downwards */
id|mac-&gt;treq0
op_assign
id|mip-&gt;treq
suffix:semicolon
id|mac-&gt;treq1
op_assign
id|mip-&gt;treq
op_rshift
l_int|16
suffix:semicolon
id|mac-&gt;pri0
op_assign
op_complement
l_int|0
suffix:semicolon
id|mac-&gt;pri1
op_assign
op_complement
l_int|0
suffix:semicolon
id|mac-&gt;pri2
op_assign
op_complement
l_int|0
suffix:semicolon
id|mac-&gt;mdreg2
op_assign
multiline_comment|/*M2_STRIP_FCS +*/
id|M2_CHECK_PARITY
op_plus
id|M2_EVEN_PARITY
op_plus
l_int|3
op_star
id|M2_RCV_BYTE_BDRY
op_plus
id|M2_ENABLE_HSREQ
op_plus
id|M2_ENABLE_NPDMA
op_plus
id|M2_SYNC_NPDMA
op_plus
id|M2_RECV_BAD_FRAMES
suffix:semicolon
id|mac-&gt;eacb
op_assign
id|RECV_BUF_START
op_minus
l_int|1
suffix:semicolon
id|mac-&gt;earv
op_assign
id|XMIT_BUF_START
op_minus
l_int|1
suffix:semicolon
id|mac-&gt;eas
op_assign
id|mac-&gt;earv
suffix:semicolon
id|mac-&gt;eaa0
op_assign
id|BUFFER_SIZE
op_minus
l_int|1
suffix:semicolon
id|mac-&gt;eaa1
op_assign
id|mac-&gt;eaa0
suffix:semicolon
id|mac-&gt;eaa2
op_assign
id|mac-&gt;eaa1
suffix:semicolon
id|mac-&gt;wpxsf
op_assign
l_int|0
suffix:semicolon
id|mac-&gt;rpr
op_assign
id|RECV_BUF_START
suffix:semicolon
id|mac-&gt;wpr
op_assign
id|RECV_BUF_START
op_plus
l_int|1
suffix:semicolon
id|mac-&gt;swpr
op_assign
id|RECV_BUF_START
suffix:semicolon
id|mac-&gt;wpxs
op_assign
id|mac-&gt;eas
suffix:semicolon
id|mac-&gt;swpxs
op_assign
id|mac-&gt;eas
suffix:semicolon
id|mac-&gt;rpxs
op_assign
id|mac-&gt;eas
suffix:semicolon
id|mac-&gt;wpxa0
op_assign
id|XMIT_BUF_START
suffix:semicolon
id|mac-&gt;rpxa0
op_assign
id|XMIT_BUF_START
suffix:semicolon
id|memset
c_func
(paren
id|msp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|msp
)paren
)paren
suffix:semicolon
id|msp-&gt;recv_ptr
op_assign
id|RECV_BUF_START
suffix:semicolon
id|msp-&gt;recv_empty
op_assign
l_int|1
suffix:semicolon
id|msp-&gt;xmit_ptr
op_assign
id|XMIT_BUF_START
suffix:semicolon
id|msp-&gt;xmit_free
op_assign
id|XMIT_BUF_START
op_plus
l_int|1
suffix:semicolon
id|msp-&gt;xmit_start
op_assign
id|XMIT_BUF_START
suffix:semicolon
id|msp-&gt;xmit_chains
op_assign
l_int|0
suffix:semicolon
id|msp-&gt;frames_xmitted
op_assign
l_int|0
suffix:semicolon
id|msp-&gt;frames_recvd
op_assign
l_int|0
suffix:semicolon
id|msp-&gt;recv_aborted
op_assign
l_int|0
suffix:semicolon
id|mac-&gt;mdreg1
op_assign
id|M1_MODE_MEMORY
suffix:semicolon
id|mac_make_spframes
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|mac_inited
id|mac_inited
c_func
(paren
r_struct
id|mac_info
op_star
id|mip
)paren
(brace
r_struct
id|formac_state
op_star
id|msp
op_assign
op_amp
id|this_mac_state
suffix:semicolon
id|mac_status_t
id|st1
comma
id|st2
suffix:semicolon
r_if
c_cond
(paren
id|mac-&gt;said
op_ne
(paren
id|mip-&gt;s_address
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_plus
id|mip-&gt;s_address
(braket
l_int|1
)braket
op_logical_or
id|mac-&gt;laim
op_ne
(paren
id|mip-&gt;l_address
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_plus
id|mip-&gt;l_address
(braket
l_int|1
)braket
op_logical_or
id|mac-&gt;laic
op_ne
(paren
id|mip-&gt;l_address
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_plus
id|mip-&gt;l_address
(braket
l_int|3
)braket
op_logical_or
id|mac-&gt;lail
op_ne
(paren
id|mip-&gt;l_address
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_plus
id|mip-&gt;l_address
(braket
l_int|5
)braket
op_logical_or
id|mac-&gt;sagp
op_ne
(paren
id|mip-&gt;s_group_adrs
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_plus
id|mip-&gt;s_group_adrs
(braket
l_int|1
)braket
op_logical_or
id|mac-&gt;lagm
op_ne
(paren
id|mip-&gt;l_group_adrs
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_plus
id|mip-&gt;l_group_adrs
(braket
l_int|1
)braket
op_logical_or
id|mac-&gt;lagc
op_ne
(paren
id|mip-&gt;l_group_adrs
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_plus
id|mip-&gt;l_group_adrs
(braket
l_int|3
)braket
op_logical_or
id|mac-&gt;lagl
op_ne
(paren
id|mip-&gt;l_group_adrs
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_plus
id|mip-&gt;l_group_adrs
(braket
l_int|5
)braket
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mac-&gt;mdreg1
op_amp
op_complement
id|M1_ADDET
)paren
op_ne
(paren
id|M1_MODE_ONLINE
op_or
id|M1_SELECT_RA
op_or
id|M1_FULL_DUPLEX
)paren
)paren
r_return
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|mac-&gt;treq0
op_ne
(paren
id|mip-&gt;treq
op_amp
l_int|0xffff
)paren
op_logical_or
id|mac-&gt;treq1
op_ne
(paren
(paren
r_int
)paren
id|mip-&gt;treq
op_rshift
l_int|16
)paren
)paren
r_return
l_int|4
suffix:semicolon
id|st1
op_assign
(paren
id|mac-&gt;st1u
op_lshift
l_int|16
)paren
op_plus
id|mac-&gt;st1l
suffix:semicolon
id|st2
op_assign
(paren
id|mac-&gt;st2u
op_lshift
l_int|16
)paren
op_plus
id|mac-&gt;st2l
suffix:semicolon
r_if
c_cond
(paren
(paren
id|st2
op_amp
id|S2_RING_OP
)paren
op_eq
l_int|0
)paren
r_return
l_int|5
suffix:semicolon
multiline_comment|/* It&squot;s probably OK, reset some things to be safe. */
id|this_mac_info
op_assign
id|mip
suffix:semicolon
op_star
id|csr0
op_and_assign
op_complement
id|CS0_HREQ
suffix:semicolon
id|mac-&gt;tmax
op_assign
id|mip-&gt;tmax
op_rshift
l_int|5
suffix:semicolon
id|mac-&gt;tvx
op_assign
(paren
id|mip-&gt;tvx
op_minus
l_int|254
)paren
op_div
l_int|255
suffix:semicolon
multiline_comment|/* it&squot;s -ve, round downwards */
id|mac-&gt;pri0
op_assign
op_complement
l_int|0
suffix:semicolon
id|mac-&gt;pri1
op_assign
op_complement
l_int|0
suffix:semicolon
id|mac-&gt;pri2
op_assign
op_complement
l_int|0
suffix:semicolon
id|mac-&gt;mdreg2
op_assign
multiline_comment|/*M2_STRIP_FCS +*/
id|M2_CHECK_PARITY
op_plus
id|M2_EVEN_PARITY
op_plus
l_int|3
op_star
id|M2_RCV_BYTE_BDRY
op_plus
id|M2_ENABLE_HSREQ
op_plus
id|M2_ENABLE_NPDMA
op_plus
id|M2_SYNC_NPDMA
op_plus
id|M2_RECV_BAD_FRAMES
suffix:semicolon
multiline_comment|/* clear out the receive queue */
id|mac-&gt;mdreg1
op_assign
(paren
id|mac-&gt;mdreg1
op_amp
op_complement
id|M1_ADDET
)paren
op_or
id|M1_ADDET_DISABLE_RECV
suffix:semicolon
id|mac-&gt;rpr
op_assign
id|RECV_BUF_START
suffix:semicolon
id|mac-&gt;wpr
op_assign
id|RECV_BUF_START
op_plus
l_int|1
suffix:semicolon
id|mac-&gt;swpr
op_assign
id|RECV_BUF_START
suffix:semicolon
id|memset
c_func
(paren
id|msp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|msp
)paren
)paren
suffix:semicolon
id|msp-&gt;recv_ptr
op_assign
id|RECV_BUF_START
suffix:semicolon
id|msp-&gt;recv_empty
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* XXX reset transmit pointers */
id|mac-&gt;cmdreg2
op_assign
id|C2_ABORT_XMIT
suffix:semicolon
id|mac-&gt;cmdreg2
op_assign
id|C2_RESET_XMITQS
suffix:semicolon
id|mac-&gt;wpxa0
op_assign
id|XMIT_BUF_START
suffix:semicolon
id|mac-&gt;rpxa0
op_assign
id|XMIT_BUF_START
suffix:semicolon
id|msp-&gt;xmit_ptr
op_assign
id|XMIT_BUF_START
suffix:semicolon
id|msp-&gt;xmit_free
op_assign
id|XMIT_BUF_START
op_plus
l_int|1
suffix:semicolon
id|msp-&gt;xmit_start
op_assign
id|XMIT_BUF_START
suffix:semicolon
id|msp-&gt;xmit_chains
op_assign
l_int|0
suffix:semicolon
id|mac_make_spframes
c_func
(paren
)paren
suffix:semicolon
id|mac-&gt;cmdreg1
op_assign
id|C1_CLR_ALL_LOCKS
suffix:semicolon
id|msp-&gt;frames_xmitted
op_assign
l_int|0
suffix:semicolon
id|msp-&gt;frames_recvd
op_assign
l_int|0
suffix:semicolon
id|msp-&gt;recv_aborted
op_assign
l_int|0
suffix:semicolon
id|msp-&gt;ring_op
op_assign
l_int|1
suffix:semicolon
id|mac-&gt;mdreg1
op_assign
(paren
id|mac-&gt;mdreg1
op_amp
op_complement
id|M1_ADDET
)paren
op_or
id|M1_ADDET_NSA
suffix:semicolon
id|mac-&gt;imsk1u
op_assign
op_complement
(paren
id|S1_XMIT_ABORT
op_or
id|S1_END_FRAME_ASYNC0
)paren
op_rshift
l_int|16
suffix:semicolon
id|mac-&gt;imsk1l
op_assign
op_complement
(paren
id|S1_PAR_ERROR_ASYNC0
op_or
id|S1_QUEUE_LOCK_ASYNC0
)paren
suffix:semicolon
id|mac-&gt;imsk2u
op_assign
op_complement
(paren
id|S2_RECV_COMPLETE
op_or
id|S2_RECV_BUF_FULL
op_or
id|S2_RECV_FIFO_OVF
op_or
id|S2_ERR_SPECIAL_FR
op_or
id|S2_RMT_EVENTS
op_or
id|S2_NP_SIMULT_LOAD
)paren
op_rshift
l_int|16
suffix:semicolon
id|mac-&gt;imsk2l
op_assign
op_complement
(paren
id|S2_RMT_EVENTS
op_or
id|S2_MISSED_FRAME
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mac_make_spframes
r_void
id|mac_make_spframes
c_func
(paren
r_void
)paren
(brace
r_volatile
r_int
op_star
id|bp
suffix:semicolon
r_struct
id|mac_info
op_star
id|mip
op_assign
id|this_mac_info
suffix:semicolon
r_int
id|sa
suffix:semicolon
r_struct
id|formac_state
op_star
id|msp
op_assign
op_amp
id|this_mac_state
suffix:semicolon
multiline_comment|/* initialize memory to avoid parity errors */
op_star
id|csr0
op_and_assign
op_complement
id|CS0_HREQ
suffix:semicolon
op_star
id|csr1
op_and_assign
op_complement
id|CS1_BUF_WR_TAG
suffix:semicolon
r_for
c_loop
(paren
id|bp
op_assign
op_amp
id|buffer_mem
(braket
id|BUFFER_SIZE
)braket
suffix:semicolon
id|bp
OG
op_amp
id|buffer_mem
(braket
id|XMIT_BUF_START
)braket
suffix:semicolon
)paren
op_star
op_decrement
id|bp
op_assign
l_int|0xdeadbeef
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|bp
OG
id|buffer_mem
suffix:semicolon
)paren
op_star
op_decrement
id|bp
op_assign
l_int|0xfeedf00d
suffix:semicolon
id|buffer_mem
(braket
id|msp-&gt;recv_ptr
)braket
op_assign
l_int|0
suffix:semicolon
id|bp
op_assign
id|buffer_mem
suffix:semicolon
op_star
id|bp
op_increment
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* auto-void frame pointer (not used) */
multiline_comment|/* make claim frame */
id|sa
op_assign
id|bp
op_minus
id|buffer_mem
suffix:semicolon
op_star
id|bp
op_increment
op_assign
l_int|0xd8000011
suffix:semicolon
multiline_comment|/* claim frame descr. + length */
op_star
id|bp
op_increment
op_assign
l_int|0xc3
suffix:semicolon
multiline_comment|/* FC value for claim frame, long addr */
op_star
id|bp
op_increment
op_assign
(paren
id|mip-&gt;l_address
(braket
l_int|0
)braket
op_lshift
l_int|24
)paren
op_plus
(paren
id|mip-&gt;l_address
(braket
l_int|1
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|mip-&gt;l_address
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_plus
id|mip-&gt;l_address
(braket
l_int|3
)braket
suffix:semicolon
op_star
id|bp
op_increment
op_assign
(paren
id|mip-&gt;l_address
(braket
l_int|4
)braket
op_lshift
l_int|24
)paren
op_plus
(paren
id|mip-&gt;l_address
(braket
l_int|5
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|mip-&gt;l_address
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_plus
id|mip-&gt;l_address
(braket
l_int|1
)braket
suffix:semicolon
op_star
id|bp
op_increment
op_assign
(paren
id|mip-&gt;l_address
(braket
l_int|2
)braket
op_lshift
l_int|24
)paren
op_plus
(paren
id|mip-&gt;l_address
(braket
l_int|3
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|mip-&gt;l_address
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_plus
id|mip-&gt;l_address
(braket
l_int|5
)braket
suffix:semicolon
op_star
id|bp
op_increment
op_assign
id|mip-&gt;treq
suffix:semicolon
id|mac-&gt;sacl
op_assign
id|bp
op_minus
id|buffer_mem
suffix:semicolon
multiline_comment|/* points to pointer to claim frame */
op_star
id|bp
op_increment
op_assign
l_int|0xa0000000
op_plus
id|sa
suffix:semicolon
multiline_comment|/* pointer to start of claim frame */
multiline_comment|/* make beacon frame */
id|sa
op_assign
id|bp
op_minus
id|buffer_mem
suffix:semicolon
op_star
id|bp
op_increment
op_assign
l_int|0xd8000011
suffix:semicolon
multiline_comment|/* beacon frame descr. + length */
op_star
id|bp
op_increment
op_assign
l_int|0xc2
suffix:semicolon
multiline_comment|/* FC value for beacon frame, long addr */
op_star
id|bp
op_increment
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* DA = 0 */
op_star
id|bp
op_increment
op_assign
(paren
id|mip-&gt;l_address
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_plus
id|mip-&gt;l_address
(braket
l_int|1
)braket
suffix:semicolon
op_star
id|bp
op_increment
op_assign
(paren
id|mip-&gt;l_address
(braket
l_int|2
)braket
op_lshift
l_int|24
)paren
op_plus
(paren
id|mip-&gt;l_address
(braket
l_int|3
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|mip-&gt;l_address
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_plus
id|mip-&gt;l_address
(braket
l_int|5
)braket
suffix:semicolon
op_star
id|bp
op_increment
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* beacon reason = failed claim */
id|mac-&gt;sabc
op_assign
id|bp
op_minus
id|buffer_mem
suffix:semicolon
op_star
id|bp
op_increment
op_assign
l_int|0xa0000000
op_plus
id|sa
suffix:semicolon
multiline_comment|/* pointer to start of beacon frame */
)brace
DECL|function|mac_reset
r_void
id|mac_reset
c_func
(paren
id|LoopbackType
id|loopback
)paren
(brace
r_int
id|mode
suffix:semicolon
r_struct
id|formac_state
op_star
id|msp
op_assign
op_amp
id|this_mac_state
suffix:semicolon
id|msp-&gt;loopback
op_assign
id|loopback
suffix:semicolon
r_switch
c_cond
(paren
id|loopback
)paren
(brace
r_case
id|loop_none
suffix:colon
id|mode
op_assign
id|M1_MODE_ONLINE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|loop_formac
suffix:colon
id|mode
op_assign
id|M1_MODE_INT_LOOP
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|mode
op_assign
id|M1_MODE_EXT_LOOP
suffix:semicolon
r_break
suffix:semicolon
)brace
id|mac-&gt;mdreg1
op_assign
id|mode
op_or
id|M1_ADDET_NSA
op_or
id|M1_SELECT_RA
op_or
id|M1_FULL_DUPLEX
suffix:semicolon
id|mac-&gt;cmdreg1
op_assign
id|C1_IDLE_LISTEN
suffix:semicolon
id|mac-&gt;cmdreg1
op_assign
id|C1_CLR_ALL_LOCKS
suffix:semicolon
id|mac-&gt;imsk1u
op_assign
op_complement
(paren
id|S1_XMIT_ABORT
op_or
id|S1_END_FRAME_ASYNC0
)paren
op_rshift
l_int|16
suffix:semicolon
id|mac-&gt;imsk1l
op_assign
op_complement
(paren
id|S1_PAR_ERROR_ASYNC0
op_or
id|S1_QUEUE_LOCK_ASYNC0
)paren
suffix:semicolon
id|mac-&gt;imsk2u
op_assign
op_complement
(paren
id|S2_RECV_COMPLETE
op_or
id|S2_RECV_BUF_FULL
op_or
id|S2_RECV_FIFO_OVF
op_or
id|S2_ERR_SPECIAL_FR
op_or
id|S2_RMT_EVENTS
op_or
id|S2_NP_SIMULT_LOAD
)paren
op_rshift
l_int|16
suffix:semicolon
id|mac-&gt;imsk2l
op_assign
op_complement
(paren
id|S2_RMT_EVENTS
op_or
id|S2_MISSED_FRAME
)paren
suffix:semicolon
)brace
DECL|function|mac_claim
r_void
id|mac_claim
c_func
(paren
r_void
)paren
(brace
id|mac-&gt;cmdreg1
op_assign
id|C1_CLAIM_LISTEN
suffix:semicolon
)brace
DECL|function|mac_disable
r_void
id|mac_disable
c_func
(paren
r_void
)paren
(brace
id|mac-&gt;mdreg1
op_assign
id|M1_MODE_MEMORY
suffix:semicolon
id|mac-&gt;imsk1u
op_assign
op_complement
l_int|0
suffix:semicolon
id|mac-&gt;imsk1l
op_assign
op_complement
l_int|0
suffix:semicolon
id|mac-&gt;imsk2u
op_assign
op_complement
l_int|0
suffix:semicolon
id|mac-&gt;imsk2l
op_assign
op_complement
l_int|0
suffix:semicolon
id|mac-&gt;wpr
op_assign
id|mac-&gt;swpr
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|mac-&gt;wpr
OG
id|mac-&gt;earv
)paren
id|mac-&gt;wpr
op_assign
id|mac-&gt;eacb
op_plus
l_int|1
suffix:semicolon
id|buffer_mem
(braket
id|mac-&gt;swpr
)braket
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|mac_stats
r_void
id|mac_stats
c_func
(paren
r_void
)paren
(brace
r_struct
id|formac_state
op_star
id|msp
op_assign
op_amp
id|this_mac_state
suffix:semicolon
r_if
c_cond
(paren
id|msp-&gt;recv_ovf
)paren
id|printk
c_func
(paren
l_string|&quot;%d receive buffer overflows&bslash;n&quot;
comma
id|msp-&gt;recv_ovf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msp-&gt;wrong_bb
)paren
id|printk
c_func
(paren
l_string|&quot;%d frames on wrong byte bdry&bslash;n&quot;
comma
id|msp-&gt;wrong_bb
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%d frames transmitted, %d aborted&bslash;n&quot;
comma
id|msp-&gt;frames_xmitted
comma
id|msp-&gt;xmit_aborted
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%d frames received, %d aborted&bslash;n&quot;
comma
id|msp-&gt;frames_recvd
comma
id|msp-&gt;recv_aborted
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%d frames received with errors&bslash;n&quot;
comma
id|msp-&gt;recv_error
)paren
suffix:semicolon
)brace
DECL|function|mac_sleep
r_void
id|mac_sleep
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* disable the receiver */
id|mac-&gt;mdreg1
op_assign
(paren
id|mac-&gt;mdreg1
op_amp
op_complement
id|M1_ADDET
)paren
op_or
id|M1_ADDET_DISABLE_RECV
suffix:semicolon
)brace
DECL|function|mac_poll
r_void
id|mac_poll
c_func
(paren
r_void
)paren
(brace
id|mac_status_t
id|st1
comma
id|st2
suffix:semicolon
r_struct
id|formac_state
op_star
id|msp
op_assign
op_amp
id|this_mac_state
suffix:semicolon
r_int
id|up
comma
id|f
comma
id|d
comma
id|l
comma
id|r
comma
id|e
comma
id|i
suffix:semicolon
id|st1
op_assign
(paren
id|mac-&gt;st1u
op_lshift
l_int|16
)paren
op_plus
id|mac-&gt;st1l
suffix:semicolon
id|st2
op_assign
(paren
id|mac-&gt;st2u
op_lshift
l_int|16
)paren
op_plus
id|mac-&gt;st2l
suffix:semicolon
r_if
c_cond
(paren
id|st2
op_amp
id|S2_NP_SIMULT_LOAD
)paren
id|panic
c_func
(paren
l_string|&quot;NP/formac simultaneous load!!!&quot;
)paren
suffix:semicolon
id|up
op_assign
(paren
id|st2
op_amp
id|S2_RING_OP
)paren
op_ne
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|up
op_ne
id|msp-&gt;ring_op
)paren
(brace
multiline_comment|/* ring has come up or down */
id|msp-&gt;ring_op
op_assign
id|up
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;mac: ring %s&bslash;n&quot;
comma
id|up
ques
c_cond
l_string|&quot;up&quot;
suffix:colon
l_string|&quot;down&quot;
)paren
suffix:semicolon
id|set_ring_op
c_func
(paren
id|up
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|up
)paren
(brace
r_if
c_cond
(paren
id|st1
op_amp
id|S1_XMIT_ABORT
)paren
(brace
op_increment
id|msp-&gt;xmit_aborted
suffix:semicolon
r_if
c_cond
(paren
id|st1
op_amp
id|S1_QUEUE_LOCK_ASYNC0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;mac: xmit queue locked, resetting xmit buffer&bslash;n&quot;
)paren
suffix:semicolon
id|mac-&gt;cmdreg2
op_assign
id|C2_RESET_XMITQS
suffix:semicolon
multiline_comment|/* XXX bit gross */
id|mac-&gt;rpxa0
op_assign
id|XMIT_BUF_START
suffix:semicolon
id|buffer_mem
(braket
id|XMIT_BUF_START
)braket
op_assign
l_int|0
suffix:semicolon
id|msp-&gt;xmit_ptr
op_assign
id|XMIT_BUF_START
suffix:semicolon
id|msp-&gt;xmit_start
op_assign
id|XMIT_BUF_START
suffix:semicolon
id|msp-&gt;xmit_chains
op_assign
l_int|0
suffix:semicolon
id|mac-&gt;cmdreg1
op_assign
id|C1_CLR_ASYNCQ0_LOCK
suffix:semicolon
id|st1
op_and_assign
op_complement
(paren
id|S1_END_CHAIN_ASYNC0
op_or
id|S1_END_FRAME_ASYNC0
op_or
id|S1_XINSTR_FULL_ASYNC0
)paren
suffix:semicolon
)brace
r_else
id|st1
op_or_assign
id|S1_END_FRAME_ASYNC0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|st1
op_amp
id|S1_QUEUE_LOCK_ASYNC0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;mac: xmit queue locked, why?&bslash;n&quot;
)paren
suffix:semicolon
id|mac-&gt;cmdreg1
op_assign
id|C1_CLR_ASYNCQ0_LOCK
suffix:semicolon
)brace
r_if
c_cond
(paren
id|st1
op_amp
id|S1_END_FRAME_ASYNC0
)paren
(brace
multiline_comment|/* advance xmit_start */
id|e
op_assign
id|msp-&gt;xmit_start
suffix:semicolon
r_while
c_loop
(paren
id|e
op_ne
id|msp-&gt;xmit_ptr
)paren
(brace
multiline_comment|/* find the end of the current frame */
id|f
op_assign
id|buffer_mem
(braket
id|e
)braket
suffix:semicolon
multiline_comment|/* read pointer */
r_if
c_cond
(paren
id|f
op_eq
l_int|0
)paren
r_break
suffix:semicolon
multiline_comment|/* huh?? */
id|f
op_and_assign
l_int|0xffff
suffix:semicolon
id|d
op_assign
id|buffer_mem
(braket
id|f
)braket
suffix:semicolon
multiline_comment|/* read descriptor */
id|l
op_assign
(paren
(paren
id|d
op_amp
l_int|0xffff
)paren
op_plus
(paren
(paren
id|d
op_rshift
id|TD_BYTE_BDRY_LG
)paren
op_amp
l_int|3
)paren
op_plus
l_int|3
)paren
op_rshift
l_int|2
suffix:semicolon
id|e
op_assign
id|f
op_plus
l_int|1
op_plus
id|l
suffix:semicolon
multiline_comment|/* index of ptr at end of frame */
id|r
op_assign
id|mac-&gt;rpxa0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|r
op_le
id|msp-&gt;xmit_ptr
op_logical_and
id|r
OL
id|e
op_logical_and
id|e
op_le
id|msp-&gt;xmit_ptr
)paren
op_logical_or
(paren
id|r
OG
id|msp-&gt;xmit_ptr
op_logical_and
(paren
id|r
OL
id|e
op_logical_or
id|e
op_le
id|msp-&gt;xmit_ptr
)paren
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* up to current frame */
multiline_comment|/* printk(&quot;frame @ %x done&bslash;n&quot;, msp-&gt;xmit_start); */
id|msp-&gt;xmit_start
op_assign
id|e
suffix:semicolon
r_if
c_cond
(paren
(paren
id|st1
op_amp
id|S1_XMIT_ABORT
)paren
op_eq
l_int|0
)paren
op_increment
id|msp-&gt;frames_xmitted
suffix:semicolon
r_if
c_cond
(paren
(paren
id|msp-&gt;xmit_chains
op_eq
l_int|1
op_logical_and
id|e
op_eq
id|msp-&gt;xmit_ptr
)paren
op_logical_or
(paren
id|msp-&gt;xmit_chains
OG
l_int|1
op_logical_and
id|e
op_eq
id|msp-&gt;xmit_chain_start
(braket
l_int|1
)braket
)paren
)paren
(brace
multiline_comment|/* we&squot;ve finished chain 0 */
op_decrement
id|msp-&gt;xmit_chains
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|msp-&gt;xmit_chains
suffix:semicolon
op_increment
id|i
)paren
id|msp-&gt;xmit_chain_start
(braket
id|i
)braket
op_assign
id|msp-&gt;xmit_chain_start
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|msp-&gt;xmit_chains
op_ge
l_int|2
)paren
(brace
id|mac-&gt;cmdreg2
op_assign
id|C2_XMIT_ASYNCQ0
suffix:semicolon
multiline_comment|/* printk(&quot;mac_poll: xmit chain&bslash;n&quot;); */
)brace
r_if
c_cond
(paren
id|msp-&gt;xmit_chains
op_eq
l_int|0
)paren
op_star
id|csr0
op_and_assign
op_complement
id|CS0_LED1
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;     * Now that we have a bit more space in the transmit buffer,&n;&t;     * see if we want to put another frame in.&n;&t;     */
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;Removed space in transmit buffer.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|mac_process
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|st2
op_amp
id|S2_RMT_EVENTS
)paren
(brace
id|rmt_event
c_func
(paren
id|st2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|st2
op_amp
id|S2_RECV_COMPLETE
)paren
(brace
multiline_comment|/*&n;&t; * A frame has just finished arriving in the receive buffer.&n;&t; */
op_star
id|csr0
op_or_assign
id|CS0_LED2
suffix:semicolon
id|msp-&gt;recv_empty
op_assign
l_int|0
suffix:semicolon
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;Frame has just trickled in...&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|mac_process
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|st2
op_amp
id|S2_RECV_BUF_FULL
)paren
(brace
multiline_comment|/*&n;&t; * receive buffer overflow: reset and unlock the receive buffer.&n;&t; */
multiline_comment|/*&t;printk(&quot;mac: receive buffer full&bslash;n&quot;); */
id|mac-&gt;rpr
op_assign
id|RECV_BUF_START
suffix:semicolon
id|mac-&gt;wpr
op_assign
id|RECV_BUF_START
op_plus
l_int|1
suffix:semicolon
id|mac-&gt;swpr
op_assign
id|RECV_BUF_START
suffix:semicolon
id|msp-&gt;recv_ptr
op_assign
id|RECV_BUF_START
suffix:semicolon
id|msp-&gt;recv_empty
op_assign
l_int|1
suffix:semicolon
id|buffer_mem
(braket
id|RECV_BUF_START
)braket
op_assign
l_int|0
suffix:semicolon
id|mac-&gt;cmdreg1
op_assign
id|C1_CLR_RECVQ_LOCK
suffix:semicolon
op_increment
id|msp-&gt;recv_ovf
suffix:semicolon
macro_line|#if 0
)brace
r_else
r_if
c_cond
(paren
id|st2
op_amp
id|S2_RECV_FIFO_OVF
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;mac: receive FIFO overflow&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* any further action required here? */
)brace
r_else
r_if
c_cond
(paren
id|st2
op_amp
id|S2_MISSED_FRAME
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;mac: missed frame&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|st2
op_amp
id|S2_ERR_SPECIAL_FR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;mac: bug: error in special frame&bslash;n&quot;
)paren
suffix:semicolon
id|mac_disable
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_void
DECL|function|mac_xmit_alloc
id|mac_xmit_alloc
c_func
(paren
id|sp
comma
id|bb
)paren
r_struct
id|mac_buf
op_star
id|sp
suffix:semicolon
r_int
id|bb
suffix:semicolon
(brace
r_int
id|nwords
suffix:semicolon
id|nwords
op_assign
(paren
id|sp-&gt;length
op_plus
id|bb
op_plus
l_int|3
)paren
op_rshift
l_int|2
suffix:semicolon
id|sp-&gt;fr_start
op_assign
id|mac_xalloc
c_func
(paren
id|nwords
op_plus
l_int|2
)paren
suffix:semicolon
id|sp-&gt;fr_end
op_assign
id|sp-&gt;fr_start
op_plus
id|nwords
op_plus
l_int|1
suffix:semicolon
id|sp-&gt;ptr
op_assign
(paren
r_char
op_star
)paren
op_amp
id|buffer_mem
(braket
id|sp-&gt;fr_start
op_plus
l_int|1
)braket
op_plus
id|bb
suffix:semicolon
id|buffer_mem
(braket
id|sp-&gt;fr_start
)braket
op_assign
id|TD_MAGIC
op_plus
(paren
id|bb
op_lshift
id|TD_BYTE_BDRY_LG
)paren
op_plus
id|sp-&gt;length
suffix:semicolon
)brace
r_void
DECL|function|mac_queue_frame
id|mac_queue_frame
c_func
(paren
id|sp
)paren
r_struct
id|mac_buf
op_star
id|sp
suffix:semicolon
(brace
r_struct
id|formac_state
op_star
id|msp
op_assign
op_amp
id|this_mac_state
suffix:semicolon
id|buffer_mem
(braket
id|sp-&gt;fr_end
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* null pointer at end of frame */
id|buffer_mem
(braket
id|msp-&gt;xmit_ptr
)braket
op_assign
id|PT_MAGIC
op_plus
id|sp-&gt;fr_start
suffix:semicolon
r_if
c_cond
(paren
id|msp-&gt;xmit_chains
op_le
l_int|2
)paren
(brace
id|msp-&gt;xmit_chain_start
(braket
id|msp-&gt;xmit_chains
)braket
op_assign
id|msp-&gt;xmit_ptr
suffix:semicolon
r_if
c_cond
(paren
id|msp-&gt;xmit_chains
OL
l_int|2
)paren
id|mac-&gt;cmdreg2
op_assign
id|C2_XMIT_ASYNCQ0
suffix:semicolon
op_increment
id|msp-&gt;xmit_chains
suffix:semicolon
)brace
r_else
(brace
id|buffer_mem
(braket
id|msp-&gt;xmit_more_ptr
)braket
op_or_assign
id|TD_MORE
suffix:semicolon
)brace
id|msp-&gt;xmit_ptr
op_assign
id|sp-&gt;fr_end
suffix:semicolon
id|msp-&gt;xmit_more_ptr
op_assign
id|sp-&gt;fr_start
suffix:semicolon
op_star
id|csr0
op_or_assign
id|CS0_LED1
suffix:semicolon
)brace
r_int
DECL|function|mac_xalloc
id|mac_xalloc
c_func
(paren
r_int
id|nwords
)paren
(brace
r_int
id|fr_start
suffix:semicolon
r_struct
id|formac_state
op_star
id|msp
op_assign
op_amp
id|this_mac_state
suffix:semicolon
multiline_comment|/*&n;     * Find some room in the transmit buffer.&n;     */
id|fr_start
op_assign
id|msp-&gt;xmit_free
suffix:semicolon
r_if
c_cond
(paren
id|fr_start
OG
id|msp-&gt;xmit_start
)paren
(brace
r_if
c_cond
(paren
id|fr_start
op_plus
id|nwords
OG
id|XMIT_BUF_END
)paren
(brace
multiline_comment|/* no space at end - see if we can start again from the front */
id|fr_start
op_assign
id|XMIT_BUF_START
suffix:semicolon
r_if
c_cond
(paren
id|fr_start
op_plus
id|nwords
OG
id|msp-&gt;xmit_start
)paren
id|panic
c_func
(paren
l_string|&quot;no space in xmit buffer (1)&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|fr_start
op_plus
id|nwords
OG
id|msp-&gt;xmit_start
)paren
id|panic
c_func
(paren
l_string|&quot;no space in xmit buffer (2)&quot;
)paren
suffix:semicolon
)brace
id|msp-&gt;xmit_free
op_assign
id|fr_start
op_plus
id|nwords
suffix:semicolon
r_return
id|fr_start
suffix:semicolon
)brace
r_int
DECL|function|mac_recv_frame
id|mac_recv_frame
c_func
(paren
id|sp
)paren
r_struct
id|mac_buf
op_star
id|sp
suffix:semicolon
(brace
r_struct
id|formac_state
op_star
id|msp
op_assign
op_amp
id|this_mac_state
suffix:semicolon
r_int
id|status
comma
id|bb
comma
id|orig_recv_ptr
suffix:semicolon
id|orig_recv_ptr
op_assign
id|msp-&gt;recv_ptr
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|status
op_assign
id|buffer_mem
(braket
id|msp-&gt;recv_ptr
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|RS_VALID
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|status
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;recv buf out of sync: recv_ptr=%x status=%x&bslash;n&quot;
comma
id|msp-&gt;recv_ptr
comma
id|status
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; rpr=%x swpr=%x, buf[rpr]=%x&bslash;n&quot;
comma
id|mac-&gt;rpr
comma
id|mac-&gt;swpr
comma
id|buffer_mem
(braket
id|mac-&gt;rpr
)braket
)paren
suffix:semicolon
id|msp-&gt;recv_ptr
op_assign
id|mac-&gt;swpr
suffix:semicolon
)brace
op_star
id|csr0
op_and_assign
op_complement
id|CS0_LED2
suffix:semicolon
id|msp-&gt;recv_empty
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|mac-&gt;rpr
op_eq
id|orig_recv_ptr
)paren
id|mac-&gt;rpr
op_assign
id|msp-&gt;recv_ptr
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|RS_ABORTED
)paren
op_increment
id|msp-&gt;recv_aborted
suffix:semicolon
r_else
(brace
id|bb
op_assign
(paren
id|status
op_rshift
id|RS_BYTE_BDRY_LG
)paren
op_amp
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|bb
op_ne
l_int|3
)paren
(brace
op_increment
id|msp-&gt;wrong_bb
suffix:semicolon
id|bb
op_assign
l_int|3
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|status
op_amp
id|RS_ERROR
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
op_increment
id|msp-&gt;recv_error
suffix:semicolon
id|msp-&gt;recv_ptr
op_add_assign
id|NWORDS
c_func
(paren
(paren
id|status
op_amp
id|RS_LENGTH
)paren
op_plus
id|bb
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_increment
id|msp-&gt;recv_ptr
op_ge
id|RECV_BUF_END
)paren
id|msp-&gt;recv_ptr
op_sub_assign
id|RECV_BUF_SIZE
suffix:semicolon
)brace
op_increment
id|msp-&gt;frames_recvd
suffix:semicolon
r_if
c_cond
(paren
id|mac-&gt;rpr
op_eq
id|orig_recv_ptr
)paren
id|mac-&gt;rpr
op_assign
id|msp-&gt;recv_ptr
suffix:semicolon
id|sp-&gt;fr_start
op_assign
id|msp-&gt;recv_ptr
suffix:semicolon
id|sp-&gt;length
op_assign
(paren
id|status
op_amp
id|RS_LENGTH
)paren
op_plus
id|bb
suffix:semicolon
multiline_comment|/* + 4 (status) - 4 (FCS) */
id|sp-&gt;ptr
op_assign
(paren
r_void
op_star
)paren
op_amp
id|buffer_mem
(braket
id|sp-&gt;fr_start
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|msp-&gt;recv_ptr
op_add_assign
id|NWORDS
c_func
(paren
id|sp-&gt;length
)paren
op_plus
l_int|1
)paren
op_ge
id|RECV_BUF_END
)paren
id|msp-&gt;recv_ptr
op_sub_assign
id|RECV_BUF_SIZE
suffix:semicolon
id|sp-&gt;fr_end
op_assign
id|msp-&gt;recv_ptr
suffix:semicolon
id|sp-&gt;wraplen
op_assign
(paren
id|RECV_BUF_END
op_minus
id|sp-&gt;fr_start
)paren
op_star
l_int|4
suffix:semicolon
id|sp-&gt;wrapptr
op_assign
(paren
r_void
op_star
)paren
op_amp
id|buffer_mem
(braket
id|RECV_BUF_START
)braket
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_void
DECL|function|mac_discard_frame
id|mac_discard_frame
c_func
(paren
id|sp
)paren
r_struct
id|mac_buf
op_star
id|sp
suffix:semicolon
(brace
id|mac-&gt;rpr
op_assign
id|sp-&gt;fr_end
suffix:semicolon
)brace
multiline_comment|/*&n; * Return the number of bytes free in the async 0 transmit queue.&n; */
r_int
DECL|function|mac_xmit_space
id|mac_xmit_space
c_func
(paren
r_void
)paren
(brace
r_struct
id|formac_state
op_star
id|msp
op_assign
op_amp
id|this_mac_state
suffix:semicolon
r_int
id|nw
suffix:semicolon
r_if
c_cond
(paren
id|msp-&gt;xmit_free
OG
id|msp-&gt;xmit_start
)paren
(brace
id|nw
op_assign
id|XMIT_BUF_END
op_minus
id|msp-&gt;xmit_free
suffix:semicolon
r_if
c_cond
(paren
id|nw
OL
id|msp-&gt;xmit_start
op_minus
id|XMIT_BUF_START
)paren
id|nw
op_assign
id|msp-&gt;xmit_start
op_minus
id|XMIT_BUF_START
suffix:semicolon
)brace
r_else
id|nw
op_assign
id|msp-&gt;xmit_start
op_minus
id|msp-&gt;xmit_free
suffix:semicolon
r_return
id|nw
op_le
l_int|2
ques
c_cond
l_int|0
suffix:colon
(paren
id|nw
op_minus
l_int|2
)paren
op_lshift
l_int|2
suffix:semicolon
)brace
multiline_comment|/*&n; * Return the number of bytes of frames available in the receive queue.&n; */
r_int
DECL|function|mac_recv_level
id|mac_recv_level
c_func
(paren
r_void
)paren
(brace
r_int
id|nw
suffix:semicolon
id|nw
op_assign
id|mac-&gt;swpr
op_minus
id|mac-&gt;rpr
suffix:semicolon
r_if
c_cond
(paren
id|nw
OL
l_int|0
)paren
id|nw
op_add_assign
id|mac-&gt;earv
op_minus
id|mac-&gt;eacb
suffix:semicolon
r_return
id|nw
op_lshift
l_int|2
suffix:semicolon
)brace
multiline_comment|/*&n; * Return 1 iff all transmission has been completed, 0 otherwise.&n; */
DECL|function|mac_xmit_done
r_int
id|mac_xmit_done
c_func
(paren
r_void
)paren
(brace
r_struct
id|formac_state
op_star
id|msp
op_assign
op_amp
id|this_mac_state
suffix:semicolon
r_return
id|msp-&gt;xmit_chains
op_eq
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Append skbuff packet to queue.&n; */
DECL|function|mac_queue_append
r_int
id|mac_queue_append
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|mac_queue
op_star
id|el
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;Appending queue element skb 0x%x&bslash;n&quot;
comma
id|skb
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|el
op_assign
(paren
r_struct
id|mac_queue
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|el
)paren
comma
id|GFP_ATOMIC
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|el-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|el-&gt;skb
op_assign
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|mac_queue_top
op_eq
l_int|NULL
)paren
(brace
id|mac_queue_top
op_assign
id|mac_queue_bottom
op_assign
id|el
suffix:semicolon
)brace
r_else
(brace
id|mac_queue_bottom-&gt;next
op_assign
id|el
suffix:semicolon
id|mac_queue_bottom
op_assign
id|el
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * If the packet originated from the same FDDI subnet as we are on,&n; * there is no need to perform checksumming as FDDI will does this&n; * us.  &n; */
DECL|macro|CHECK_IF_CHECKSUM_REQUIRED
mdefine_line|#define CHECK_IF_CHECKSUM_REQUIRED(skb) &bslash;&n;    if ((skb)-&gt;protocol == ETH_P_IP) { &bslash;&n;&t;extern struct cap_init cap_init; &bslash;&n;&t;int *from_ip = (int *)((skb)-&gt;data+12); &bslash;&n;&t;int *to_ip = (int *)((skb)-&gt;data+16); &bslash;&n;&t;if ((*from_ip &amp; cap_init.netmask) == (*to_ip &amp; cap_init.netmask)) &bslash;&n;&t;    (skb)-&gt;ip_summed = CHECKSUM_UNNECESSARY; &bslash;&n;    }
multiline_comment|/*&n; * Try to send and/or recv frames.&n; */
DECL|function|mac_process
r_void
id|mac_process
c_func
(paren
r_void
)paren
(brace
r_volatile
r_struct
id|dma_chan
op_star
id|dma
op_assign
(paren
r_volatile
r_struct
id|dma_chan
op_star
)paren
id|DMA3
suffix:semicolon
r_struct
id|formac_state
op_star
id|msp
op_assign
op_amp
id|this_mac_state
suffix:semicolon
r_struct
id|mac_queue
op_star
id|el
suffix:semicolon
r_int
id|nw
op_assign
l_int|0
comma
id|mrl
op_assign
l_int|0
comma
id|fstart
comma
id|send_buffer_full
op_assign
l_int|0
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;In mac_process()&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;     * Check if the DMA is being used.&n;     */
r_if
c_cond
(paren
id|msp-&gt;dma_state
op_ne
id|IDLE
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
id|mac_queue_top
op_ne
l_int|NULL
op_logical_or
multiline_comment|/* Something to transmit */
(paren
id|mrl
op_assign
id|mac_recv_level
c_func
(paren
)paren
)paren
OG
l_int|0
)paren
(brace
multiline_comment|/* Frames in receive buffer */
id|send_buffer_full
op_assign
l_int|0
suffix:semicolon
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;mac_process(): something to do... mqt %x mrl is %d&bslash;n&quot;
comma
id|mac_queue_top
comma
id|mrl
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|mac_queue_top
op_ne
l_int|NULL
op_logical_and
id|mrl
OL
id|RECV_THRESHOLD
)paren
(brace
id|el
op_assign
(paren
r_struct
id|mac_queue
op_star
)paren
id|mac_queue_top
suffix:semicolon
multiline_comment|/*&n;&t;     * Check there is enough space in the FDDI send buffer.&n;&t;     */
r_if
c_cond
(paren
id|mac_xmit_space
c_func
(paren
)paren
OL
id|el-&gt;skb-&gt;len
)paren
(brace
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;process_queue(): FDDI send buffer is full&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|send_buffer_full
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;mac_process(): sending a frame&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t;&t; * Update mac_queue_top.&n;&t;&t; */
id|mac_queue_top
op_assign
id|mac_queue_top-&gt;next
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Allocate space in the FDDI send buffer.&n;&t;&t; */
id|msp-&gt;cur_mbuf.length
op_assign
id|el-&gt;skb-&gt;len
op_minus
l_int|3
suffix:semicolon
id|mac_xmit_alloc
c_func
(paren
(paren
r_struct
id|mac_buf
op_star
)paren
op_amp
id|msp-&gt;cur_mbuf
comma
l_int|3
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * If message size is greater than DMA_XMIT_THRESHOLD, send&n;&t;&t; * using DMA, otherwise use memcpy().&n;&t;&t; */
r_if
c_cond
(paren
id|el-&gt;skb-&gt;len
OG
id|DMA_XMIT_THRESHOLD
)paren
(brace
multiline_comment|/*&n;&t;&t;     * Start the DMA.&n;&t;&t;     */
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;mac_process(): Starting send DMA...&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|nw
op_assign
id|msp-&gt;cur_mbuf.fr_end
op_minus
id|msp-&gt;cur_mbuf.fr_start
op_plus
l_int|1
suffix:semicolon
id|mac-&gt;wpxa0
op_assign
id|msp-&gt;cur_mbuf.fr_start
op_plus
l_int|1
suffix:semicolon
op_star
id|csr0
op_or_assign
id|CS0_HREQ_WA0
suffix:semicolon
id|msp-&gt;cur_macq
op_assign
id|el
suffix:semicolon
id|msp-&gt;dma_state
op_assign
id|XMITTING
suffix:semicolon
id|dma-&gt;st
op_assign
id|DMA_DMST_RST
suffix:semicolon
id|dma-&gt;st
op_assign
id|DMA_RESET_MASKS
suffix:semicolon
id|dma-&gt;hskip
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* skip = 0, count = 1 */
id|dma-&gt;vskip
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* skip = 0, count = 1 */
id|dma-&gt;maddr
op_assign
(paren
id|u_char
op_star
)paren
id|mmu_v2p
c_func
(paren
(paren
r_int
r_int
)paren
id|el-&gt;skb-&gt;data
)paren
suffix:semicolon
id|dma-&gt;cmd
op_assign
id|DMA_DCMD_ST
op_plus
id|DMA_DCMD_TYP_AUTO
op_plus
id|DMA_DCMD_TD_MD
op_plus
id|nw
suffix:semicolon
op_star
id|csr0
op_and_assign
op_complement
id|CS0_DMA_RECV
suffix:semicolon
op_star
id|csr0
op_or_assign
id|CS0_DMA_ENABLE
suffix:semicolon
multiline_comment|/*&n;&t;&t;     * Don&squot;t process any more packets since the DMA is &n;&t;&t;     * being used.&n;&t;&t;     */
r_break
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* el-&gt;skb-&gt;len &lt;= DMA_XMIT_THRESHOLD */
multiline_comment|/*&n;&t;&t;     * Copy the data directly into the FDDI buffer.&n;&t;&t;     */
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;mac_proces(): Copying send data...&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|memcpy
c_func
(paren
id|msp-&gt;cur_mbuf.ptr
op_minus
l_int|3
comma
id|el-&gt;skb-&gt;data
comma
id|ROUND4
c_func
(paren
id|el-&gt;skb-&gt;len
)paren
)paren
suffix:semicolon
id|mac_queue_frame
c_func
(paren
(paren
r_struct
id|mac_buf
op_star
)paren
op_amp
id|msp-&gt;cur_mbuf
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|el-&gt;skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|el
comma
r_sizeof
(paren
op_star
id|el
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;     * We have reached here if there is not enough space in the&n;&t;     * send buffer.  Try to receive some packets instead.&n;&t;     */
)brace
r_if
c_cond
(paren
id|mac_recv_frame
c_func
(paren
(paren
r_struct
id|mac_buf
op_star
)paren
op_amp
id|msp-&gt;cur_mbuf
)paren
)paren
(brace
r_volatile
r_int
id|fc
comma
id|llc_header_word2
suffix:semicolon
r_int
id|pkt_len
op_assign
l_int|0
suffix:semicolon
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;mac_process(): Receiving frames...&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* &n;&t;     * Get the fc, note only word accesses are allowed from the&n;&t;     * FDDI buffers.&n;&t;     */
r_if
c_cond
(paren
id|msp-&gt;cur_mbuf.wraplen
OG
l_int|4
)paren
(brace
id|fc
op_assign
op_star
(paren
r_int
op_star
)paren
(paren
id|msp-&gt;cur_mbuf.ptr
op_plus
l_int|4
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * fc_word must be at the start of the FDDI buffer.&n;&t;&t; */
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;Grabbed fc_word from wrapptr, wraplen %d&bslash;n&quot;
comma
id|msp-&gt;cur_mbuf.wraplen
)paren
suffix:semicolon
macro_line|#endif
id|fc
op_assign
op_star
(paren
r_int
op_star
)paren
id|msp-&gt;cur_mbuf.wrapptr
suffix:semicolon
)brace
id|fc
op_and_assign
l_int|0xff
suffix:semicolon
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;fc is 0x%x&bslash;n&quot;
comma
id|fc
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|fc
template_param
l_int|0x57
)paren
(brace
id|mac_discard_frame
c_func
(paren
(paren
r_struct
id|mac_buf
op_star
)paren
op_amp
id|msp-&gt;cur_mbuf
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/*&n;&t;     * Determine the size of the packet data and allocate a socket&n;&t;     * buffer.&n;&t;     */
id|pkt_len
op_assign
id|msp-&gt;cur_mbuf.length
op_minus
id|FDDI_HARDHDR_LEN
suffix:semicolon
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;Packet of length %d&bslash;n&quot;
comma
id|pkt_len
)paren
suffix:semicolon
macro_line|#endif
id|msp-&gt;cur_skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|ROUND4
c_func
(paren
id|pkt_len
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msp-&gt;cur_skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;mac_process(): Memory squeeze, dropping packet.&bslash;n&quot;
)paren
suffix:semicolon
id|apfddi_stats-&gt;rx_dropped
op_increment
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|msp-&gt;cur_skb-&gt;dev
op_assign
id|apfddi_device
suffix:semicolon
multiline_comment|/*&n;&t;     * Hardware header isn&squot;t copied to skbuff.&n;&t;     */
id|msp-&gt;cur_skb-&gt;mac.raw
op_assign
id|msp-&gt;cur_skb-&gt;data
suffix:semicolon
id|apfddi_stats-&gt;rx_packets
op_increment
suffix:semicolon
multiline_comment|/*&n;&t;     * Determine protocol from llc header.&n;&t;     */
r_if
c_cond
(paren
id|msp-&gt;cur_mbuf.wraplen
OL
id|FDDI_HARDHDR_LEN
)paren
(brace
id|llc_header_word2
op_assign
op_star
(paren
r_int
op_star
)paren
(paren
id|msp-&gt;cur_mbuf.wrapptr
op_plus
(paren
id|FDDI_HARDHDR_LEN
op_minus
id|msp-&gt;cur_mbuf.wraplen
op_minus
l_int|4
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|llc_header_word2
op_assign
op_star
(paren
r_int
op_star
)paren
(paren
id|msp-&gt;cur_mbuf.ptr
op_plus
id|FDDI_HARDHDR_LEN
op_minus
l_int|4
)paren
suffix:semicolon
)brace
id|msp-&gt;cur_skb-&gt;protocol
op_assign
id|llc_header_word2
op_amp
l_int|0xFFFF
suffix:semicolon
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;Got protocol 0x%x&bslash;n&quot;
comma
id|msp-&gt;cur_skb-&gt;protocol
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t;     * Copy data into socket buffer, which may be wrapped around the &n;&t;     * FDDI buffer.  Use memcpy if the size of the data is less&n;&t;     * than DMA_RECV_THRESHOLD.  Note if DMA is used, then wrap-&n;&t;     * arounds are handled automatically.&n;&t;     */
r_if
c_cond
(paren
id|pkt_len
OL
id|DMA_RECV_THRESHOLD
)paren
(brace
r_if
c_cond
(paren
id|msp-&gt;cur_mbuf.length
OL
id|msp-&gt;cur_mbuf.wraplen
)paren
(brace
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|msp-&gt;cur_skb
comma
id|ROUND4
c_func
(paren
id|pkt_len
)paren
)paren
comma
id|msp-&gt;cur_mbuf.ptr
op_plus
id|FDDI_HARDHDR_LEN
comma
id|ROUND4
c_func
(paren
id|pkt_len
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|msp-&gt;cur_mbuf.wraplen
OL
id|FDDI_HARDHDR_LEN
)paren
(brace
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;Wrap case 2&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|msp-&gt;cur_skb
comma
id|ROUND4
c_func
(paren
id|pkt_len
)paren
)paren
comma
id|msp-&gt;cur_mbuf.wrapptr
op_plus
(paren
id|FDDI_HARDHDR_LEN
op_minus
id|msp-&gt;cur_mbuf.wraplen
)paren
comma
id|ROUND4
c_func
(paren
id|pkt_len
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;wrap case 3&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|msp-&gt;cur_skb
comma
id|ROUND4
c_func
(paren
id|msp-&gt;cur_mbuf.wraplen
op_minus
id|FDDI_HARDHDR_LEN
)paren
)paren
comma
id|msp-&gt;cur_mbuf.ptr
op_plus
id|FDDI_HARDHDR_LEN
comma
id|ROUND4
c_func
(paren
id|msp-&gt;cur_mbuf.wraplen
op_minus
id|FDDI_HARDHDR_LEN
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|msp-&gt;cur_skb
comma
id|ROUND4
c_func
(paren
id|msp-&gt;cur_mbuf.length
op_minus
id|msp-&gt;cur_mbuf.wraplen
)paren
)paren
comma
id|msp-&gt;cur_mbuf.wrapptr
comma
id|ROUND4
c_func
(paren
id|msp-&gt;cur_mbuf.length
op_minus
id|msp-&gt;cur_mbuf.wraplen
)paren
)paren
suffix:semicolon
)brace
macro_line|#if MAC_DEBUG
r_if
c_cond
(paren
id|msp-&gt;cur_skb-&gt;protocol
op_eq
id|ETH_P_IP
)paren
(brace
id|dump_packet
c_func
(paren
l_string|&quot;apfddi_rx:&quot;
comma
id|msp-&gt;cur_skb-&gt;data
comma
id|pkt_len
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|msp-&gt;cur_skb-&gt;protocol
op_eq
id|ETH_P_ARP
)paren
(brace
r_struct
id|arphdr
op_star
id|arp
op_assign
(paren
r_struct
id|arphdr
op_star
)paren
id|msp-&gt;cur_skb-&gt;data
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;arp-&gt;ar_op is 0x%x ar_hrd %d ar_pro 0x%x ar_hln %d ar_ln %d&bslash;n&quot;
comma
id|arp-&gt;ar_op
comma
id|arp-&gt;ar_hrd
comma
id|arp-&gt;ar_pro
comma
id|arp-&gt;ar_hln
comma
id|arp-&gt;ar_pln
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;sender hardware address: %x:%x:%x:%x:%x:%x&bslash;n&quot;
comma
op_star
(paren
(paren
id|u_char
op_star
)paren
id|msp-&gt;cur_skb-&gt;data
op_plus
l_int|8
)paren
comma
op_star
(paren
(paren
id|u_char
op_star
)paren
id|msp-&gt;cur_skb-&gt;data
op_plus
l_int|9
)paren
comma
op_star
(paren
(paren
id|u_char
op_star
)paren
id|msp-&gt;cur_skb-&gt;data
op_plus
l_int|10
)paren
comma
op_star
(paren
(paren
id|u_char
op_star
)paren
id|msp-&gt;cur_skb-&gt;data
op_plus
l_int|11
)paren
comma
op_star
(paren
(paren
id|u_char
op_star
)paren
id|msp-&gt;cur_skb-&gt;data
op_plus
l_int|12
)paren
comma
op_star
(paren
(paren
id|u_char
op_star
)paren
id|msp-&gt;cur_skb-&gt;data
op_plus
l_int|13
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;sender IP number %d.%d.%d.%d&bslash;n&quot;
comma
op_star
(paren
(paren
id|u_char
op_star
)paren
id|msp-&gt;cur_skb-&gt;data
op_plus
l_int|14
)paren
comma
op_star
(paren
(paren
id|u_char
op_star
)paren
id|msp-&gt;cur_skb-&gt;data
op_plus
l_int|15
)paren
comma
op_star
(paren
(paren
id|u_char
op_star
)paren
id|msp-&gt;cur_skb-&gt;data
op_plus
l_int|16
)paren
comma
op_star
(paren
(paren
id|u_char
op_star
)paren
id|msp-&gt;cur_skb-&gt;data
op_plus
l_int|17
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;receiver hardware address: %x:%x:%x:%x:%x:%x&bslash;n&quot;
comma
op_star
(paren
(paren
id|u_char
op_star
)paren
id|msp-&gt;cur_skb-&gt;data
op_plus
l_int|18
)paren
comma
op_star
(paren
(paren
id|u_char
op_star
)paren
id|msp-&gt;cur_skb-&gt;data
op_plus
l_int|19
)paren
comma
op_star
(paren
(paren
id|u_char
op_star
)paren
id|msp-&gt;cur_skb-&gt;data
op_plus
l_int|20
)paren
comma
op_star
(paren
(paren
id|u_char
op_star
)paren
id|msp-&gt;cur_skb-&gt;data
op_plus
l_int|21
)paren
comma
op_star
(paren
(paren
id|u_char
op_star
)paren
id|msp-&gt;cur_skb-&gt;data
op_plus
l_int|22
)paren
comma
op_star
(paren
(paren
id|u_char
op_star
)paren
id|msp-&gt;cur_skb-&gt;data
op_plus
l_int|23
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;receiver IP number %d.%d.%d.%d&bslash;n&quot;
comma
op_star
(paren
(paren
id|u_char
op_star
)paren
id|msp-&gt;cur_skb-&gt;data
op_plus
l_int|24
)paren
comma
op_star
(paren
(paren
id|u_char
op_star
)paren
id|msp-&gt;cur_skb-&gt;data
op_plus
l_int|25
)paren
comma
op_star
(paren
(paren
id|u_char
op_star
)paren
id|msp-&gt;cur_skb-&gt;data
op_plus
l_int|26
)paren
comma
op_star
(paren
(paren
id|u_char
op_star
)paren
id|msp-&gt;cur_skb-&gt;data
op_plus
l_int|27
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
id|CHECK_IF_CHECKSUM_REQUIRED
c_func
(paren
id|msp-&gt;cur_skb
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Inform the network layer of the new packet.&n;&t;&t; */
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;Calling netif_rx()&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|netif_rx
c_func
(paren
id|msp-&gt;cur_skb
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Remove frame from FDDI buffer.&n;&t;&t; */
id|mac_discard_frame
c_func
(paren
(paren
r_struct
id|mac_buf
op_star
)paren
op_amp
id|msp-&gt;cur_mbuf
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * Set up dma and break.&n;&t;&t; */
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;mac_process(): Starting receive DMA...&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|nw
op_assign
id|NWORDS
c_func
(paren
id|pkt_len
)paren
suffix:semicolon
id|msp-&gt;dma_state
op_assign
id|RECVING
suffix:semicolon
op_star
id|csr0
op_and_assign
op_complement
(paren
id|CS0_HREQ
op_or
id|CS0_DMA_ENABLE
)paren
suffix:semicolon
multiline_comment|/*&t;&t;*csr1 |= CS1_RESET_FIFO;&n;&t;&t;*csr1 &amp;= ~CS1_RESET_FIFO; */
r_if
c_cond
(paren
(paren
op_star
id|csr1
op_amp
id|CS1_FIFO_LEVEL
)paren
op_ne
l_int|0
)paren
(brace
r_int
id|x
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;fifo not empty! (csr1 = 0x%x) emptying...&quot;
comma
op_star
id|csr1
)paren
suffix:semicolon
r_do
(brace
id|x
op_assign
op_star
id|fifo
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
op_star
id|csr1
op_amp
id|CS1_FIFO_LEVEL
)paren
op_ne
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;done&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|fstart
op_assign
id|msp-&gt;cur_mbuf.fr_start
op_plus
id|NWORDS
c_func
(paren
id|FDDI_HARDHDR_LEN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fstart
op_ge
id|RECV_BUF_END
)paren
id|fstart
op_sub_assign
id|RECV_BUF_SIZE
suffix:semicolon
id|mac-&gt;rpr
op_assign
id|fstart
suffix:semicolon
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;rpr=0x%x, nw=0x%x, stat=0x%x&bslash;n&quot;
comma
id|mac-&gt;rpr
comma
id|nw
comma
id|buffer_mem
(braket
id|msp-&gt;cur_mbuf.fr_start
)braket
)paren
suffix:semicolon
macro_line|#endif
id|dma-&gt;st
op_assign
id|DMA_DMST_RST
suffix:semicolon
id|dma-&gt;st
op_assign
id|DMA_RESET_MASKS
suffix:semicolon
id|dma-&gt;hskip
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* skip = 0, count = 1 */
id|dma-&gt;vskip
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* skip = 0, count = 1 */
id|dma-&gt;maddr
op_assign
(paren
id|u_char
op_star
)paren
id|mmu_v2p
c_func
(paren
(paren
r_int
r_int
)paren
id|skb_put
c_func
(paren
id|msp-&gt;cur_skb
comma
id|ROUND4
c_func
(paren
id|pkt_len
)paren
)paren
)paren
suffix:semicolon
id|dma-&gt;cmd
op_assign
id|DMA_DCMD_ST
op_plus
id|DMA_DCMD_TYP_AUTO
op_plus
id|DMA_DCMD_TD_DM
op_plus
id|nw
op_minus
l_int|4
suffix:semicolon
op_star
id|csr0
op_or_assign
id|CS0_HREQ_RECV
op_or
id|CS0_DMA_RECV
suffix:semicolon
op_star
id|csr0
op_or_assign
id|CS0_DMA_ENABLE
suffix:semicolon
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;mac_process(): DMA is away!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;mac_recv_frame failed&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|msp-&gt;recv_empty
op_logical_and
id|send_buffer_full
)paren
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;     * Update mac_queue_bottom.&n;     */
r_if
c_cond
(paren
id|mac_queue_top
op_eq
l_int|NULL
)paren
id|mac_queue_bottom
op_assign
l_int|NULL
suffix:semicolon
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;End of mac_process()&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|macro|DMA_IN
mdefine_line|#define DMA_IN(reg) (*(volatile unsigned *)(reg))
DECL|macro|DMA_OUT
mdefine_line|#define DMA_OUT(reg,v) (*(volatile unsigned *)(reg) = (v))
multiline_comment|/*&n; * DMA completion handler.&n; */
DECL|function|mac_dma_complete
r_void
id|mac_dma_complete
c_func
(paren
r_void
)paren
(brace
r_volatile
r_struct
id|dma_chan
op_star
id|dma
suffix:semicolon
r_struct
id|formac_state
op_star
id|msp
op_assign
op_amp
id|this_mac_state
suffix:semicolon
r_int
id|a
suffix:semicolon
id|a
op_assign
id|DMA_IN
c_func
(paren
id|DMA3_DMST
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|a
op_amp
id|DMA_INTR_REQS
)paren
)paren
(brace
r_if
c_cond
(paren
id|msp-&gt;dma_state
op_ne
id|IDLE
op_logical_and
(paren
id|a
op_amp
id|DMA_DMST_AC
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;dma completed but no interrupt!&bslash;n&quot;
)paren
suffix:semicolon
id|msp-&gt;dma_state
op_assign
id|IDLE
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
id|DMA_OUT
c_func
(paren
id|DMA3_DMST
comma
id|AP_CLR_INTR_REQ
op_lshift
id|DMA_INTR_NORMAL_SH
)paren
suffix:semicolon
id|DMA_OUT
c_func
(paren
id|DMA3_DMST
comma
id|AP_CLR_INTR_REQ
op_lshift
id|DMA_INTR_ERROR_SH
)paren
suffix:semicolon
id|dma
op_assign
(paren
r_volatile
r_struct
id|dma_chan
op_star
)paren
id|DMA3
suffix:semicolon
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;In mac_dma_complete&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|msp-&gt;dma_state
op_eq
id|XMITTING
op_logical_and
(paren
(paren
id|dma-&gt;st
op_amp
id|DMA_DMST_AC
)paren
op_eq
l_int|0
)paren
)paren
(brace
multiline_comment|/*&n;&t; * Transmit DMA finished.&n;&t; */
r_int
id|i
op_assign
l_int|20
suffix:semicolon
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;In mac_dma_complete for transmit complete&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_while
c_loop
(paren
op_star
id|csr1
op_amp
id|CS1_FIFO_LEVEL
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|i
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;csr0=0x%x csr1=0x%x: fifo not emptying&bslash;n&quot;
comma
op_star
id|csr0
comma
op_star
id|csr1
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
op_star
id|csr0
op_and_assign
op_complement
(paren
id|CS0_HREQ
op_or
id|CS0_DMA_ENABLE
)paren
suffix:semicolon
id|msp-&gt;dma_state
op_assign
id|IDLE
suffix:semicolon
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;mac_dma_complete(): Calling mac_queue_frame&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|mac_queue_frame
c_func
(paren
(paren
r_struct
id|mac_buf
op_star
)paren
op_amp
id|msp-&gt;cur_mbuf
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|msp-&gt;cur_macq-&gt;skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
(paren
r_struct
id|mac_buf
op_star
)paren
id|msp-&gt;cur_macq
comma
r_sizeof
(paren
op_star
(paren
id|msp-&gt;cur_macq
)paren
)paren
)paren
suffix:semicolon
id|msp-&gt;cur_macq
op_assign
l_int|NULL
suffix:semicolon
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;mac_dma_complete(): Calling mac_process()&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|mac_process
c_func
(paren
)paren
suffix:semicolon
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;End of mac_dma_complete transmitting&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
r_if
c_cond
(paren
id|msp-&gt;dma_state
op_eq
id|RECVING
op_logical_and
(paren
(paren
id|dma-&gt;st
op_amp
id|DMA_DMST_AC
)paren
op_eq
l_int|0
)paren
)paren
(brace
multiline_comment|/*&n;&t; * Receive DMA finished.  Copy the last four words from the&n;&t; * fifo into the buffer, after turning off the host requests.&n;&t; * We do this to avoid reading past the end of frame.&n;&t; */
r_int
op_star
id|ip
comma
id|i
suffix:semicolon
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;In mac_dma_complete for receive complete&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|msp-&gt;dma_state
op_assign
id|IDLE
suffix:semicolon
id|ip
op_assign
(paren
r_int
op_star
)paren
id|mmu_p2v
c_func
(paren
(paren
r_int
r_int
)paren
id|dma-&gt;cmaddr
)paren
suffix:semicolon
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;ip is 0x%x, skb-&gt;data is 0x%x&bslash;n&quot;
comma
id|ip
comma
id|msp-&gt;cur_skb-&gt;data
)paren
suffix:semicolon
macro_line|#endif
op_star
id|csr0
op_and_assign
op_complement
(paren
id|CS0_DMA_ENABLE
op_or
id|CS0_HREQ
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
op_star
id|csr1
op_amp
id|CS1_FIFO_LEVEL
)paren
suffix:semicolon
op_increment
id|i
)paren
id|ip
(braket
id|i
)braket
op_assign
op_star
id|fifo
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
l_int|4
)paren
id|printk
c_func
(paren
l_string|&quot;mac_dma_complete(): not four words remaining in fifo?&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;Copied last four words out of fifo&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * Remove the frame from the FDDI receive buffer.&n;&t; */
id|mac_discard_frame
c_func
(paren
(paren
r_struct
id|mac_buf
op_star
)paren
op_amp
id|msp-&gt;cur_mbuf
)paren
suffix:semicolon
id|CHECK_IF_CHECKSUM_REQUIRED
c_func
(paren
id|msp-&gt;cur_skb
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Now inject the packet into the network system.&n;&t; */
id|netif_rx
c_func
(paren
id|msp-&gt;cur_skb
)paren
suffix:semicolon
macro_line|#if MAC_DEBUG
id|dump_packet
c_func
(paren
l_string|&quot;mac_dma_complete:&quot;
comma
id|msp-&gt;cur_skb-&gt;data
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * Check if any more frames can be processed.&n;&t; */
id|mac_process
c_func
(paren
)paren
suffix:semicolon
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;End of mac_dma_complete receiving&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#if MAC_DEBUG
id|printk
c_func
(paren
l_string|&quot;End of mac_dma_complete()&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|mac_print_state
r_static
r_void
id|mac_print_state
c_func
(paren
r_void
)paren
(brace
r_struct
id|formac_state
op_star
id|msp
op_assign
op_amp
id|this_mac_state
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;DMA3_DMST is 0x%x dma_state is %d&bslash;n&quot;
comma
id|DMA_IN
c_func
(paren
id|DMA3_DMST
)paren
comma
id|msp-&gt;dma_state
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;csr0 = 0x%x, csr1 = 0x%x&bslash;n&quot;
comma
op_star
id|csr0
comma
op_star
id|csr1
)paren
suffix:semicolon
)brace
eof
