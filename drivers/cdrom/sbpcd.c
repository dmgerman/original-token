multiline_comment|/*&n; *  sbpcd.c   CD-ROM device driver for the whole family of traditional,&n; *            non-ATAPI IDE-style Matsushita/Panasonic CR-5xx drives.&n; *            Works with SoundBlaster compatible cards and with &quot;no-sound&quot;&n; *            interface cards like Lasermate, Panasonic CI-101P, Teac, ...&n; *            Also for the Longshine LCS-7260 drive.&n; *            Also for the IBM &quot;External ISA CD-Rom&quot; drive.&n; *            Also for the CreativeLabs CD200 drive.&n; *            Also for the TEAC CD-55A drive.&n; *            Also for the ECS-AT &quot;Vertos 100&quot; drive.&n; *            Not for Sanyo drives (but for the H94A, sjcd is there...).&n; *            Not for any other Funai drives than the CD200 types (sometimes&n; *             labelled E2550UA or MK4015 or 2800F).&n; */
DECL|macro|VERSION
mdefine_line|#define VERSION &quot;v4.63 Andrew J. Kroll &lt;ag784@freenet.buffalo.edu&gt; Wed Jul 26 04:24:10 EDT 2000&quot;
multiline_comment|/*   Copyright (C) 1993, 1994, 1995  Eberhard Moenkeberg &lt;emoenke@gwdg.de&gt;&n; *&n; *   This program is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU General Public License as published by&n; *   the Free Software Foundation; either version 2, or (at your option)&n; *   any later version.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   (for example /usr/src/linux/COPYING); if not, write to the Free&n; *   Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; *   If you change this software, you should mail a .diff file with some&n; *   description lines to emoenke@gwdg.de. I want to know about it.&n; *&n; *   If you are the editor of a Linux CD, you should enable sbpcd.c within&n; *   your boot floppy kernel and send me one of your CDs for free.&n; *&n; *   If you would like to port the driver to an other operating system (f.e.&n; *   FreeBSD or NetBSD) or use it as an information source, you shall not be&n; *   restricted by the GPL under the following conditions:&n; *     a) the source code of your work is freely available&n; *     b) my part of the work gets mentioned at all places where your &n; *        authorship gets mentioned&n; *     c) I receive a copy of your code together with a full installation&n; *        package of your operating system for free.&n; *&n; *&n; *  VERSION HISTORY&n; *&n; *  0.1  initial release, April/May 93, after mcd.c (Martin Harriss)&n; *&n; *  0.2  thek &quot;repeat:&quot;-loop in do_sbpcd_request did not check for&n; *       end-of-request_queue (resulting in kernel panic).&n; *       Flow control seems stable, but throughput is not better.  &n; *&n; *  0.3  interrupt locking totally eliminated (maybe &quot;inb&quot; and &quot;outb&quot;&n; *       are still locking) - 0.2 made keyboard-type-ahead losses.&n; *       check_sbpcd_media_change added (to use by isofs/inode.c)&n; *       - but it detects almost nothing.&n; *&n; *  0.4  use MAJOR 25 definitely.&n; *       Almost total re-design to support double-speed drives and&n; *       &quot;naked&quot; (no sound) interface cards (&quot;LaserMate&quot; interface type).&n; *       Flow control should be exact now.&n; *       Don&squot;t occupy the SbPro IRQ line (not needed either); will&n; *       live together with Hannu Savolainen&squot;s sndkit now.&n; *       Speeded up data transfer to 150 kB/sec, with help from Kai&n; *       Makisara, the &quot;provider&quot; of the &quot;mt&quot; tape utility.&n; *       Give &quot;SpinUp&quot; command if necessary.&n; *       First steps to support up to 4 drives (but currently only one).&n; *       Implemented audio capabilities - workman should work, xcdplayer&n; *       gives some problems.&n; *       This version is still consuming too much CPU time, and&n; *       sleeping still has to be worked on.&n; *       During &quot;long&quot; implied seeks, it seems possible that a &n; *       ReadStatus command gets ignored. That gives the message&n; *       &quot;ResponseStatus timed out&quot; (happens about 6 times here during&n; *       a &quot;ls -alR&quot; of the YGGDRASIL LGX-Beta CD). Such a case is&n; *       handled without data error, but it should get done better.&n; *&n; *  0.5  Free CPU during waits (again with help from Kai Makisara).&n; *       Made it work together with the LILO/kernel setup standard.&n; *       Included auto-probing code, as suggested by YGGDRASIL.&n; *       Formal redesign to add DDI debugging.&n; *       There are still flaws in IOCTL (workman with double speed drive).&n; *&n; *  1.0  Added support for all drive IDs (0...3, no longer only 0)&n; *       and up to 4 drives on one controller.&n; *       Added &quot;#define MANY_SESSION&quot; for &quot;old&quot; multi session CDs.&n; *&n; *  1.1  Do SpinUp for new drives, too.&n; *       Revised for clean compile under &quot;old&quot; kernels (0.99pl9).&n; *&n; *  1.2  Found the &quot;workman with double-speed drive&quot; bug: use the driver&squot;s&n; *       audio_state, not what the drive is reporting with ReadSubQ.&n; *&n; *  1.3  Minor cleanups.&n; *       Refinements regarding Workman.&n; *&n; *  1.4  Read XA disks (PhotoCDs) with &quot;old&quot; drives, too (but only the first&n; *       session - no chance to fully access a &quot;multi-session&quot; CD).&n; *       This currently still is too slow (50 kB/sec) - but possibly&n; *       the old drives won&squot;t do it faster.&n; *       Implemented &quot;door (un)lock&quot; for new drives (still does not work&n; *       as wanted - no lock possible after an unlock).&n; *       Added some debugging printout for the UPC/EAN code - but my drives &n; *       return only zeroes. Is there no UPC/EAN code written?&n; *&n; *  1.5  Laborate with UPC/EAN code (not better yet).&n; *       Adapt to kernel 1.1.8 change (have to explicitly include&n; *       &lt;linux/string.h&gt; now).&n; *&n; *  1.6  Trying to read audio frames as data. Impossible with the current&n; *       drive firmware levels, as it seems. Awaiting any hint. ;-)&n; *       Changed &quot;door unlock&quot;: repeat it until success.&n; *       Changed CDROMSTOP routine (stop somewhat &quot;softer&quot; so that Workman&n; *       won&squot;t get confused).&n; *       Added a third interface type: Sequoia S-1000, as used with the SPEA&n; *       Media FX sound card. This interface (usable for Sony and Mitsumi &n; *       drives, too) needs a special configuration setup and behaves like a &n; *       LaserMate type after that. Still experimental - I do not have such&n; *       an interface.&n; *       Use the &quot;variable BLOCK_SIZE&quot; feature (2048). But it does only work&n; *       if you give the mount option &quot;block=2048&quot;.&n; *       The media_check routine is currently disabled; now that it gets&n; *       called as it should I fear it must get synchronized for not to&n; *       disturb the normal driver&squot;s activity.&n; *&n; *  2.0  Version number bumped - two reasons:&n; *       - reading audio tracks as data works now with CR-562 and CR-563. We&n; *       currently do it by an IOCTL (yet has to get standardized), one frame&n; *       at a time; that is pretty slow. But it works.&n; *       - we are maintaining now up to 4 interfaces (each up to 4 drives):&n; *       did it the easy way - a different MAJOR (25, 26, ...) and a different&n; *       copy of the driver (sbpcd.c, sbpcd2.c, sbpcd3.c, sbpcd4.c - only&n; *       distinguished by the value of SBPCD_ISSUE and the driver&squot;s name),&n; *       and a common sbpcd.h file.&n; *       Bettered the &quot;ReadCapacity error&quot; problem with old CR-52x drives (the&n; *       drives sometimes need a manual &quot;eject/insert&quot; before work): just&n; *       reset the drive and do again. Needs lots of resets here and sometimes&n; *       that does not cure, so this can&squot;t be the solution.&n; *&n; *  2.1  Found bug with multisession CDs (accessing frame 16).&n; *       &quot;read audio&quot; works now with address type CDROM_MSF, too.&n; *       Bigger audio frame buffer: allows reading max. 4 frames at time; this&n; *       gives a significant speedup, but reading more than one frame at once&n; *       gives missing chunks at each single frame boundary.&n; *&n; *  2.2  Kernel interface cleanups: timers, init, setup, media check.&n; *&n; *  2.3  Let &quot;door lock&quot; and &quot;eject&quot; live together.&n; *       Implemented &quot;close tray&quot; (done automatically during open).&n; *&n; *  2.4  Use different names for device registering.&n; *&n; *  2.5  Added &quot;#if EJECT&quot; code (default: enabled) to automatically eject&n; *       the tray during last call to &quot;sbpcd_release&quot;.&n; *       Added &quot;#if JUKEBOX&quot; code (default: disabled) to automatically eject&n; *       the tray during call to &quot;sbpcd_open&quot; if no disk is in.&n; *       Turn on the CD volume of &quot;compatible&quot; sound cards, too; just define&n; *       SOUND_BASE (in sbpcd.h) accordingly (default: disabled).&n; *&n; *  2.6  Nothing new.  &n; *&n; *  2.7  Added CDROMEJECT_SW ioctl to set the &quot;EJECT&quot; behavior on the fly:&n; *       0 disables, 1 enables auto-ejecting. Useful to keep the tray in&n; *       during shutdown.&n; *&n; *  2.8  Added first support (still BETA, I need feedback or a drive) for&n; *       the Longshine LCS-7260 drives. They appear as double-speed drives&n; *       using the &quot;old&quot; command scheme, extended by tray control and door&n; *       lock functions.&n; *       Found (and fixed preliminary) a flaw with some multisession CDs: we&n; *       have to re-direct not only the accesses to frame 16 (the isofs&n; *       routines drive it up to max. 100), but also those to the continuation&n; *       (repetition) frames (as far as they exist - currently set fix as&n; *       16..20).&n; *       Changed default of the &quot;JUKEBOX&quot; define. If you use this default,&n; *       your tray will eject if you try to mount without a disk in. Next&n; *       mount command will insert the tray - so, just fill in a disk. ;-)&n; *&n; *  2.9  Fulfilled the Longshine LCS-7260 support; with great help and&n; *       experiments by Serge Robyns.&n; *       First attempts to support the TEAC CD-55A drives; but still not&n; *       usable yet.&n; *       Implemented the CDROMMULTISESSION ioctl; this is an attempt to handle&n; *       multi session CDs more &quot;transparent&quot; (redirection handling has to be&n; *       done within the isofs routines, and only for the special purpose of&n; *       obtaining the &quot;right&quot; volume descriptor; accesses to the raw device&n; *       should not get redirected).&n; *&n; *  3.0  Just a &quot;normal&quot; increment, with some provisions to do it better. ;-)&n; *       Introduced &quot;#define READ_AUDIO&quot; to specify the maximum number of &n; *       audio frames to grab with one request. This defines a buffer size&n; *       within kernel space; a value of 0 will reserve no such space and&n; *       disable the CDROMREADAUDIO ioctl. A value of 75 enables the reading&n; *       of a whole second with one command, but will use a buffer of more&n; *       than 172 kB.&n; *       Started CD200 support. Drive detection should work, but nothing&n; *       more.&n; *&n; *  3.1  Working to support the CD200 and the Teac CD-55A drives.&n; *       AT-BUS style device numbering no longer used: use SCSI style now.&n; *       So, the first &quot;found&quot; device has MINOR 0, regardless of the&n; *       jumpered drive ID. This implies modifications to the /dev/sbpcd*&n; *       entries for some people, but will help the DAU (german TLA, english:&n; *       &quot;newbie&quot;, maybe ;-) to install his &quot;first&quot; system from a CD.&n; *&n; *  3.2  Still testing with CD200 and CD-55A drives.&n; *&n; *  3.3  Working with CD200 support.&n; *&n; *  3.4  Auto-probing stops if an address of 0 is seen (to be entered with&n; *       the kernel command line).&n; *       Made the driver &quot;loadable&quot;. If used as a module, &quot;audio copy&quot; is&n; *       disabled, and the internal read ahead data buffer has a reduced size&n; *       of 4 kB; so, throughput may be reduced a little bit with slow CPUs.&n; *&n; *  3.5  Provisions to handle weird photoCDs which have an interrupted&n; *       &quot;formatting&quot; immediately after the last frames of some files: simply&n; *       never &quot;read ahead&quot; with MultiSession CDs. By this, CPU usage may be&n; *       increased with those CDs, and there may be a loss in speed.&n; *       Re-structured the messaging system.&n; *       The &quot;loadable&quot; version no longer has a limited READ_AUDIO buffer&n; *       size.&n; *       Removed &quot;MANY_SESSION&quot; handling for &quot;old&quot; multi session CDs.&n; *       Added &quot;private&quot; IOCTLs CDROMRESET and CDROMVOLREAD.&n; *       Started again to support the TEAC CD-55A drives, now that I found&n; *       the money for &quot;my own&quot; drive. ;-)&n; *       The TEAC CD-55A support is fairly working now.&n; *       I have measured that the drive &quot;delivers&quot; at 600 kB/sec (even with&n; *       bigger requests than the drive&squot;s 64 kB buffer can satisfy), but&n; *       the &quot;real&quot; rate does not exceed 520 kB/sec at the moment. &n; *       Caused by the various changes to build in TEAC support, the timed&n; *       loops are de-optimized at the moment (less throughput with CR-52x&n; *       drives, and the TEAC will give speed only with SBP_BUFFER_FRAMES 64).&n; *&n; *  3.6  Fixed TEAC data read problems with SbPro interfaces.&n; *       Initial size of the READ_AUDIO buffer is 0. Can get set to any size&n; *       during runtime.&n; *&n; *  3.7  Introduced MAX_DRIVES for some poor interface cards (seen with TEAC&n; *       drives) which allow only one drive (ID 0); this avoids repetitive&n; *       detection under IDs 1..3. &n; *       Elongated cmd_out_T response waiting; necessary for photo CDs with&n; *       a lot of sessions.&n; *       Bettered the sbpcd_open() behavior with TEAC drives.&n; *&n; *  3.8  Elongated max_latency for CR-56x drives.&n; *&n; *  3.9  Finally fixed the long-known SoundScape/SPEA/Sequoia S-1000 interface&n; *       configuration bug.&n; *       Now Corey, Heiko, Ken, Leo, Vadim/Eric &amp; Werner are invited to copy&n; *       the config_spea() routine into their drivers. ;-)&n; *&n; *  4.0  No &quot;big step&quot; - normal version increment.&n; *       Adapted the benefits from 1.3.33.&n; *       Fiddled with CDROMREADAUDIO flaws.&n; *       Avoid ReadCapacity command with CD200 drives (the MKE 1.01 version&n; *       seems not to support it).&n; *       Fulfilled &quot;read audio&quot; for CD200 drives, with help of Pete Heist&n; *       (heistp@rpi.edu).&n; *&n; *  4.1  Use loglevel KERN_INFO with printk().&n; *       Added support for &quot;Vertos 100&quot; drive (&quot;ECS-AT&quot;) - it is very similar&n; *       to the Longshine LCS-7260. Give feedback if you can - I never saw&n; *       such a drive, and I have no specs.&n; *&n; *  4.2  Support for Teac 16-bit interface cards. Can&squot;t get auto-detected,&n; *       so you have to jumper your card to 0x2C0. Still not 100% - come&n; *       in contact if you can give qualified feedback.&n; *       Use loglevel KERN_NOTICE with printk(). If you get annoyed by a&n; *       flood of unwanted messages and the accompanied delay, try to read&n; *       my documentation. Especially the Linux CDROM drivers have to do an&n; *       important job for the newcomers, so the &quot;distributed&quot; version has&n; *       to fit some special needs. Since generations, the flood of messages&n; *       is user-configurable (even at runtime), but to get aware of this, one&n; *       needs a special mental quality: the ability to read.&n; *       &n; *  4.3  CD200F does not like to receive a command while the drive is&n; *       reading the ToC; still trying to solve it.&n; *       Removed some redundant verify_area calls (yes, Heiko Eissfeldt&n; *       is visiting all the Linux CDROM drivers ;-).&n; *       &n; *  4.4  Adapted one idea from tiensivu@pilot.msu.edu&squot;s &quot;stripping-down&quot;&n; *       experiments: &quot;KLOGD_PAUSE&quot;.&n; *       Inhibited &quot;play audio&quot; attempts with data CDs. Provisions for a&n; *       &quot;data-safe&quot; handling of &quot;mixed&quot; (data plus audio) Cds.&n; *&n; *  4.5  Meanwhile Gonzalo Tornaria &lt;tornaria@cmat.edu.uy&gt; (GTL) built a&n; *       special end_request routine: we seem to have to take care for not&n; *       to have two processes working at the request list. My understanding&n; *       was and is that ll_rw_blk should not call do_sbpcd_request as long&n; *       as there is still one call active (the first call will care for all&n; *       outstanding I/Os, and if a second call happens, that is a bug in&n; *       ll_rw_blk.c).&n; *       &quot;Check media change&quot; without touching any drive.&n; *&n; *  4.6  Use a semaphore to synchronize multi-activity; elaborated by Rob&n; *       Riggs &lt;rriggs@tesser.com&gt;. At the moment, we simply block &quot;read&quot;&n; *       against &quot;ioctl&quot; and vice versa. This could be refined further, but&n; *       I guess with almost no performance increase.&n; *       Experiments to speed up the CD-55A; again with help of Rob Riggs&n; *       (to be true, he gave both, idea &amp; code. ;-)&n; *&n; *  4.61 Ported to Uniform CD-ROM driver by &n; *       Heiko Eissfeldt &lt;heiko@colossus.escape.de&gt; with additional&n; *       changes by Erik Andersen &lt;andersee@debian.org&gt;&n; *&n; *  4.62 Fix a bug where playing audio left the drive in an unusable state.&n; *         Heiko Eissfeldt &lt;heiko@colossus.escape.de&gt;&n; *&n; *  November 1999 -- Make kernel-parameter implementation work with 2.3.x &n; *&t;             Removed init_module &amp; cleanup_module in favor of &n; *&t;             module_init &amp; module_exit.&n; *&t;             Torben Mathiasen &lt;tmm@image.dk&gt;&n; *&n; *  4.63 Bug fixes for audio annoyances, new legacy CDROM maintainer.&n; *&t;&t;Annoying things fixed:&n; *&t;&t;TOC reread on automated disk changes&n; *&t;&t;TOC reread on manual cd changes&n; *&t;&t;Play IOCTL tries to play CD before it&squot;s actually ready... sometimes.&n; *&t;&t;CD_AUDIO_COMPLETED state so workman (and other playes) can repeat play.&n; *&t;&t;Andrew J. Kroll &lt;ag784@freenet.buffalo.edu&gt; Wed Jul 26 04:24:10 EDT 2000&n; *&n; *&n; *  TODO&n; *     implement &quot;read all subchannel data&quot; (96 bytes per frame)&n; *     remove alot of the virtual status bits and deal with hardware status&n; *     move the change of cd for audio to a better place&n; *     add debug levels to insmod parameters (trivial)&n; *&n; *     special thanks to Kai Makisara (kai.makisara@vtt.fi) for his fine&n; *     elaborated speed-up experiments (and the fabulous results!), for&n; *     the &quot;push&quot; towards load-free wait loops, and for the extensive mail&n; *     thread which brought additional hints and bug fixes.&n; *&n; */
macro_line|#ifndef SBPCD_ISSUE
DECL|macro|SBPCD_ISSUE
mdefine_line|#define SBPCD_ISSUE 1
macro_line|#endif SBPCD_ISSUE
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/cdrom.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/devfs_fs_kernel.h&gt;
macro_line|#include &lt;linux/major.h&gt; 
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;stdarg.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &quot;sbpcd.h&quot;
macro_line|#if !(SBPCD_ISSUE-1)
DECL|macro|MAJOR_NR
mdefine_line|#define MAJOR_NR MATSUSHITA_CDROM_MAJOR
macro_line|#endif
macro_line|#if !(SBPCD_ISSUE-2)
DECL|macro|MAJOR_NR
mdefine_line|#define MAJOR_NR MATSUSHITA_CDROM2_MAJOR /* second driver issue */
macro_line|#endif
macro_line|#if !(SBPCD_ISSUE-3)
DECL|macro|MAJOR_NR
mdefine_line|#define MAJOR_NR MATSUSHITA_CDROM3_MAJOR /* third driver issue */
macro_line|#endif
macro_line|#if !(SBPCD_ISSUE-4)
DECL|macro|MAJOR_NR
mdefine_line|#define MAJOR_NR MATSUSHITA_CDROM4_MAJOR /* fourth driver issue */
macro_line|#endif
macro_line|#include &lt;linux/blk.h&gt;
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; * provisions for more than 1 driver issues&n; * currently up to 4 drivers, expandable&n; */
macro_line|#if !(SBPCD_ISSUE-1)
DECL|macro|DO_SBPCD_REQUEST
mdefine_line|#define DO_SBPCD_REQUEST(a) do_sbpcd_request(a)
DECL|macro|SBPCD_INIT
mdefine_line|#define SBPCD_INIT(a) sbpcd_init(a)
macro_line|#endif
macro_line|#if !(SBPCD_ISSUE-2)
DECL|macro|DO_SBPCD_REQUEST
mdefine_line|#define DO_SBPCD_REQUEST(a) do_sbpcd2_request(a)
DECL|macro|SBPCD_INIT
mdefine_line|#define SBPCD_INIT(a) sbpcd2_init(a)
macro_line|#endif
macro_line|#if !(SBPCD_ISSUE-3)
DECL|macro|DO_SBPCD_REQUEST
mdefine_line|#define DO_SBPCD_REQUEST(a) do_sbpcd3_request(a)
DECL|macro|SBPCD_INIT
mdefine_line|#define SBPCD_INIT(a) sbpcd3_init(a)
macro_line|#endif
macro_line|#if !(SBPCD_ISSUE-4)
DECL|macro|DO_SBPCD_REQUEST
mdefine_line|#define DO_SBPCD_REQUEST(a) do_sbpcd4_request(a)
DECL|macro|SBPCD_INIT
mdefine_line|#define SBPCD_INIT(a) sbpcd4_init(a)
macro_line|#endif
multiline_comment|/*==========================================================================*/
macro_line|#if SBPCD_DIS_IRQ
DECL|macro|SBPCD_CLI
mdefine_line|#define SBPCD_CLI cli()
DECL|macro|SBPCD_STI
mdefine_line|#define SBPCD_STI sti()
macro_line|#else
DECL|macro|SBPCD_CLI
mdefine_line|#define SBPCD_CLI
DECL|macro|SBPCD_STI
mdefine_line|#define SBPCD_STI
macro_line|#endif SBPCD_DIS_IRQ
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; * auto-probing address list&n; * inspired by Adam J. Richter from Yggdrasil&n; *&n; * still not good enough - can cause a hang.&n; *   example: a NE 2000 ethernet card at 300 will cause a hang probing 310.&n; * if that happens, reboot and use the LILO (kernel) command line.&n; * The possibly conflicting ethernet card addresses get NOT probed &n; * by default - to minimize the hang possibilities. &n; *&n; * The SB Pro addresses get &quot;mirrored&quot; at 0x6xx and some more locations - to&n; * avoid a type error, the 0x2xx-addresses must get checked before 0x6xx.&n; *&n; * send mail to emoenke@gwdg.de if your interface card is not FULLY&n; * represented here.&n; */
macro_line|#if !(SBPCD_ISSUE-1)
DECL|variable|sbpcd
r_static
r_int
id|sbpcd
(braket
)braket
op_assign
(brace
id|CDROM_PORT
comma
id|SBPRO
comma
multiline_comment|/* probe with user&squot;s setup first */
macro_line|#if DISTRIBUTION
l_int|0x230
comma
l_int|1
comma
multiline_comment|/* Soundblaster Pro and 16 (default) */
macro_line|#if 0
l_int|0x300
comma
l_int|0
comma
multiline_comment|/* CI-101P (default), WDH-7001C (default),&n;&t;&t;     Galaxy (default), Reveal (one default) */
l_int|0x250
comma
l_int|1
comma
multiline_comment|/* OmniCD default, Soundblaster Pro and 16 */
l_int|0x2C0
comma
l_int|3
comma
multiline_comment|/* Teac 16-bit cards */
l_int|0x260
comma
l_int|1
comma
multiline_comment|/* OmniCD */
l_int|0x320
comma
l_int|0
comma
multiline_comment|/* Lasermate, CI-101P, WDH-7001C, Galaxy, Reveal (other default),&n;&t;&t;     Longshine LCS-6853 (default) */
l_int|0x338
comma
l_int|0
comma
multiline_comment|/* Reveal Sound Wave 32 card model #SC600 */
l_int|0x340
comma
l_int|0
comma
multiline_comment|/* Mozart sound card (default), Lasermate, CI-101P */
l_int|0x360
comma
l_int|0
comma
multiline_comment|/* Lasermate, CI-101P */
l_int|0x270
comma
l_int|1
comma
multiline_comment|/* Soundblaster 16 */
l_int|0x670
comma
l_int|0
comma
multiline_comment|/* &quot;sound card #9&quot; */
l_int|0x690
comma
l_int|0
comma
multiline_comment|/* &quot;sound card #9&quot; */
l_int|0x338
comma
l_int|2
comma
multiline_comment|/* SPEA Media FX, Ensonic SoundScape (default) */
l_int|0x328
comma
l_int|2
comma
multiline_comment|/* SPEA Media FX */
l_int|0x348
comma
l_int|2
comma
multiline_comment|/* SPEA Media FX */
l_int|0x634
comma
l_int|0
comma
multiline_comment|/* some newer sound cards */
l_int|0x638
comma
l_int|0
comma
multiline_comment|/* some newer sound cards */
l_int|0x230
comma
l_int|1
comma
multiline_comment|/* some newer sound cards */
multiline_comment|/* due to incomplete address decoding of the SbPro card, these must be last */
l_int|0x630
comma
l_int|0
comma
multiline_comment|/* &quot;sound card #9&quot; (default) */
l_int|0x650
comma
l_int|0
comma
multiline_comment|/* &quot;sound card #9&quot; */
macro_line|#ifdef MODULE
multiline_comment|/*&n;&t; * some &quot;hazardous&quot; locations (no harm with the loadable version)&n;&t; * (will stop the bus if a NE2000 ethernet card resides at offset -0x10)&n;&t; */
l_int|0x330
comma
l_int|0
comma
multiline_comment|/* Lasermate, CI-101P, WDH-7001C */
l_int|0x350
comma
l_int|0
comma
multiline_comment|/* Lasermate, CI-101P */
l_int|0x358
comma
l_int|2
comma
multiline_comment|/* SPEA Media FX */
l_int|0x370
comma
l_int|0
comma
multiline_comment|/* Lasermate, CI-101P */
l_int|0x290
comma
l_int|1
comma
multiline_comment|/* Soundblaster 16 */
l_int|0x310
comma
l_int|0
comma
multiline_comment|/* Lasermate, CI-101P, WDH-7001C */
macro_line|#endif MODULE
macro_line|#endif
macro_line|#endif DISTRIBUTION
)brace
suffix:semicolon
macro_line|#else
DECL|variable|sbpcd
r_static
r_int
id|sbpcd
(braket
)braket
op_assign
(brace
id|CDROM_PORT
comma
id|SBPRO
)brace
suffix:semicolon
multiline_comment|/* probe with user&squot;s setup only */
macro_line|#endif
id|MODULE_PARM
c_func
(paren
id|sbpcd
comma
l_string|&quot;2i&quot;
)paren
suffix:semicolon
DECL|macro|NUM_PROBE
mdefine_line|#define NUM_PROBE  (sizeof(sbpcd) / sizeof(int))
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; * the external references:&n; */
macro_line|#if !(SBPCD_ISSUE-1)
macro_line|#ifdef CONFIG_SBPCD2
r_extern
r_int
id|sbpcd2_init
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_SBPCD3
r_extern
r_int
id|sbpcd3_init
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_SBPCD4
r_extern
r_int
id|sbpcd4_init
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
multiline_comment|/*==========================================================================*/
DECL|macro|INLINE
mdefine_line|#define INLINE inline
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; * the forward references:&n; */
r_static
r_void
id|sbp_sleep
c_func
(paren
id|u_int
)paren
suffix:semicolon
r_static
r_void
id|mark_timeout_delay
c_func
(paren
id|u_long
)paren
suffix:semicolon
r_static
r_void
id|mark_timeout_data
c_func
(paren
id|u_long
)paren
suffix:semicolon
macro_line|#if 0
r_static
r_void
id|mark_timeout_audio
c_func
(paren
id|u_long
)paren
suffix:semicolon
macro_line|#endif
r_static
r_void
id|sbp_read_cmd
c_func
(paren
r_struct
id|request
op_star
id|req
)paren
suffix:semicolon
r_static
r_int
id|sbp_data
c_func
(paren
r_struct
id|request
op_star
id|req
)paren
suffix:semicolon
r_static
r_int
id|cmd_out
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|DiskInfo
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|sbpcd_chk_disk_change
c_func
(paren
id|kdev_t
)paren
suffix:semicolon
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; * pattern for printk selection:&n; *&n; * (1&lt;&lt;DBG_INF)  necessary information&n; * (1&lt;&lt;DBG_BSZ)  BLOCK_SIZE trace&n; * (1&lt;&lt;DBG_REA)  &quot;read&quot; status trace&n; * (1&lt;&lt;DBG_CHK)  &quot;media check&quot; trace&n; * (1&lt;&lt;DBG_TIM)  datarate timer test&n; * (1&lt;&lt;DBG_INI)  initialization trace&n; * (1&lt;&lt;DBG_TOC)  tell TocEntry values&n; * (1&lt;&lt;DBG_IOC)  ioctl trace&n; * (1&lt;&lt;DBG_STA)  &quot;ResponseStatus&quot; trace&n; * (1&lt;&lt;DBG_ERR)  &quot;cc_ReadError&quot; trace&n; * (1&lt;&lt;DBG_CMD)  &quot;cmd_out&quot; trace&n; * (1&lt;&lt;DBG_WRN)  give explanation before auto-probing&n; * (1&lt;&lt;DBG_MUL)  multi session code test&n; * (1&lt;&lt;DBG_IDX)  &quot;drive_id != 0&quot; test code&n; * (1&lt;&lt;DBG_IOX)  some special information&n; * (1&lt;&lt;DBG_DID)  drive ID test&n; * (1&lt;&lt;DBG_RES)  drive reset info&n; * (1&lt;&lt;DBG_SPI)  SpinUp test info&n; * (1&lt;&lt;DBG_IOS)  ioctl trace: &quot;subchannel&quot;&n; * (1&lt;&lt;DBG_IO2)  ioctl trace: general&n; * (1&lt;&lt;DBG_UPC)  show UPC info&n; * (1&lt;&lt;DBG_XA1)  XA mode debugging&n; * (1&lt;&lt;DBG_LCK)  door (un)lock info&n; * (1&lt;&lt;DBG_SQ1)   dump SubQ frame&n; * (1&lt;&lt;DBG_AUD)  &quot;read audio&quot; debugging&n; * (1&lt;&lt;DBG_SEQ)  Sequoia interface configuration trace&n; * (1&lt;&lt;DBG_LCS)  Longshine LCS-7260 debugging trace&n; * (1&lt;&lt;DBG_CD2)  MKE/Funai CD200 debugging trace&n; * (1&lt;&lt;DBG_TEA)  TEAC CD-55A debugging trace&n; * (1&lt;&lt;DBG_ECS)  ECS-AT (Vertos-100) debugging trace&n; * (1&lt;&lt;DBG_000)  unnecessary information&n; */
macro_line|#if DISTRIBUTION
DECL|variable|sbpcd_debug
r_static
r_int
id|sbpcd_debug
op_assign
(paren
l_int|1
op_lshift
id|DBG_INF
)paren
suffix:semicolon
macro_line|#else
DECL|variable|sbpcd_debug
r_static
r_int
id|sbpcd_debug
op_assign
l_int|0
op_amp
(paren
(paren
l_int|1
op_lshift
id|DBG_INF
)paren
op_or
(paren
l_int|1
op_lshift
id|DBG_TOC
)paren
op_or
(paren
l_int|1
op_lshift
id|DBG_MUL
)paren
op_or
(paren
l_int|1
op_lshift
id|DBG_UPC
)paren
)paren
suffix:semicolon
macro_line|#endif DISTRIBUTION
DECL|variable|sbpcd_ioaddr
r_static
r_int
id|sbpcd_ioaddr
op_assign
id|CDROM_PORT
suffix:semicolon
multiline_comment|/* default I/O base address */
DECL|variable|sbpro_type
r_static
r_int
id|sbpro_type
op_assign
id|SBPRO
suffix:semicolon
DECL|variable|setup_done
r_static
r_int
r_char
id|setup_done
suffix:semicolon
DECL|variable|f_16bit
r_static
r_int
r_char
id|f_16bit
suffix:semicolon
DECL|variable|do_16bit
r_static
r_int
r_char
id|do_16bit
suffix:semicolon
DECL|variable|CDo_command
DECL|variable|CDo_reset
r_static
r_int
id|CDo_command
comma
id|CDo_reset
suffix:semicolon
DECL|variable|CDo_sel_i_d
DECL|variable|CDo_enable
r_static
r_int
id|CDo_sel_i_d
comma
id|CDo_enable
suffix:semicolon
DECL|variable|CDi_info
DECL|variable|CDi_status
DECL|variable|CDi_data
r_static
r_int
id|CDi_info
comma
id|CDi_status
comma
id|CDi_data
suffix:semicolon
DECL|variable|msf
r_static
r_struct
id|cdrom_msf
id|msf
suffix:semicolon
DECL|variable|ti
r_static
r_struct
id|cdrom_ti
id|ti
suffix:semicolon
DECL|variable|tochdr
r_static
r_struct
id|cdrom_tochdr
id|tochdr
suffix:semicolon
DECL|variable|tocentry
r_static
r_struct
id|cdrom_tocentry
id|tocentry
suffix:semicolon
DECL|variable|SC
r_static
r_struct
id|cdrom_subchnl
id|SC
suffix:semicolon
DECL|variable|volctrl
r_static
r_struct
id|cdrom_volctrl
id|volctrl
suffix:semicolon
DECL|variable|read_audio
r_static
r_struct
id|cdrom_read_audio
id|read_audio
suffix:semicolon
DECL|variable|msgnum
r_static
r_int
r_char
id|msgnum
suffix:semicolon
DECL|variable|msgbuf
r_static
r_char
id|msgbuf
(braket
l_int|80
)braket
suffix:semicolon
DECL|variable|str_sb
r_static
r_const
r_char
op_star
id|str_sb
op_assign
l_string|&quot;SoundBlaster&quot;
suffix:semicolon
DECL|variable|str_sb_l
r_static
r_const
r_char
op_star
id|str_sb_l
op_assign
l_string|&quot;soundblaster&quot;
suffix:semicolon
DECL|variable|str_lm
r_static
r_const
r_char
op_star
id|str_lm
op_assign
l_string|&quot;LaserMate&quot;
suffix:semicolon
DECL|variable|str_sp
r_static
r_const
r_char
op_star
id|str_sp
op_assign
l_string|&quot;SPEA&quot;
suffix:semicolon
DECL|variable|str_sp_l
r_static
r_const
r_char
op_star
id|str_sp_l
op_assign
l_string|&quot;spea&quot;
suffix:semicolon
DECL|variable|str_ss
r_static
r_const
r_char
op_star
id|str_ss
op_assign
l_string|&quot;SoundScape&quot;
suffix:semicolon
DECL|variable|str_ss_l
r_static
r_const
r_char
op_star
id|str_ss_l
op_assign
l_string|&quot;soundscape&quot;
suffix:semicolon
DECL|variable|str_t16
r_static
r_const
r_char
op_star
id|str_t16
op_assign
l_string|&quot;Teac16bit&quot;
suffix:semicolon
DECL|variable|str_t16_l
r_static
r_const
r_char
op_star
id|str_t16_l
op_assign
l_string|&quot;teac16bit&quot;
suffix:semicolon
DECL|variable|type
r_static
r_const
r_char
op_star
id|type
suffix:semicolon
macro_line|#if !(SBPCD_ISSUE-1)
DECL|variable|major_name
r_static
r_const
r_char
op_star
id|major_name
op_assign
l_string|&quot;sbpcd&quot;
suffix:semicolon
macro_line|#endif
macro_line|#if !(SBPCD_ISSUE-2)
DECL|variable|major_name
r_static
r_const
r_char
op_star
id|major_name
op_assign
l_string|&quot;sbpcd2&quot;
suffix:semicolon
macro_line|#endif
macro_line|#if !(SBPCD_ISSUE-3)
DECL|variable|major_name
r_static
r_const
r_char
op_star
id|major_name
op_assign
l_string|&quot;sbpcd3&quot;
suffix:semicolon
macro_line|#endif
macro_line|#if !(SBPCD_ISSUE-4)
DECL|variable|major_name
r_static
r_const
r_char
op_star
id|major_name
op_assign
l_string|&quot;sbpcd4&quot;
suffix:semicolon
macro_line|#endif
multiline_comment|/*==========================================================================*/
macro_line|#if FUTURE
r_static
id|DECLARE_WAIT_QUEUE_HEAD
c_func
(paren
id|sbp_waitq
)paren
suffix:semicolon
macro_line|#endif FUTURE
DECL|variable|teac
r_static
r_int
id|teac
op_assign
id|SBP_TEAC_SPEED
suffix:semicolon
DECL|variable|buffers
r_static
r_int
id|buffers
op_assign
id|SBP_BUFFER_FRAMES
suffix:semicolon
DECL|variable|family0
r_static
id|u_char
id|family0
(braket
)braket
op_assign
l_string|&quot;MATSHITA&quot;
suffix:semicolon
multiline_comment|/* MKE CR-521, CR-522, CR-523 */
DECL|variable|family1
r_static
id|u_char
id|family1
(braket
)braket
op_assign
l_string|&quot;CR-56&quot;
suffix:semicolon
multiline_comment|/* MKE CR-562, CR-563 */
DECL|variable|family2
r_static
id|u_char
id|family2
(braket
)braket
op_assign
l_string|&quot;CD200&quot;
suffix:semicolon
multiline_comment|/* MKE CD200, Funai CD200F */
DECL|variable|familyL
r_static
id|u_char
id|familyL
(braket
)braket
op_assign
l_string|&quot;LCS-7260&quot;
suffix:semicolon
multiline_comment|/* Longshine LCS-7260 */
DECL|variable|familyT
r_static
id|u_char
id|familyT
(braket
)braket
op_assign
l_string|&quot;CD-55&quot;
suffix:semicolon
multiline_comment|/* TEAC CD-55A */
DECL|variable|familyV
r_static
id|u_char
id|familyV
(braket
)braket
op_assign
l_string|&quot;ECS-AT&quot;
suffix:semicolon
multiline_comment|/* ECS Vertos 100 */
DECL|variable|recursion
r_static
id|u_int
id|recursion
suffix:semicolon
multiline_comment|/* internal testing only */
DECL|variable|fatal_err
r_static
id|u_int
id|fatal_err
suffix:semicolon
multiline_comment|/* internal testing only */
DECL|variable|response_count
r_static
id|u_int
id|response_count
suffix:semicolon
DECL|variable|flags_cmd_out
r_static
id|u_int
id|flags_cmd_out
suffix:semicolon
DECL|variable|cmd_type
r_static
id|u_char
id|cmd_type
suffix:semicolon
DECL|variable|drvcmd
r_static
id|u_char
id|drvcmd
(braket
l_int|10
)braket
suffix:semicolon
DECL|variable|infobuf
r_static
id|u_char
id|infobuf
(braket
l_int|20
)braket
suffix:semicolon
DECL|variable|xa_head_buf
r_static
id|u_char
id|xa_head_buf
(braket
id|CD_XA_HEAD
)braket
suffix:semicolon
DECL|variable|xa_tail_buf
r_static
id|u_char
id|xa_tail_buf
(braket
id|CD_XA_TAIL
)braket
suffix:semicolon
macro_line|#if OLD_BUSY
DECL|variable|busy_data
r_static
r_volatile
id|u_char
id|busy_data
suffix:semicolon
DECL|variable|busy_audio
r_static
r_volatile
id|u_char
id|busy_audio
suffix:semicolon
multiline_comment|/* true semaphores would be safer */
macro_line|#endif OLD_BUSY
r_static
id|DECLARE_MUTEX
c_func
(paren
id|ioctl_read_sem
)paren
suffix:semicolon
DECL|variable|timeout
r_static
id|u_long
id|timeout
suffix:semicolon
DECL|variable|timed_out_delay
r_static
r_volatile
id|u_char
id|timed_out_delay
suffix:semicolon
DECL|variable|timed_out_data
r_static
r_volatile
id|u_char
id|timed_out_data
suffix:semicolon
macro_line|#if 0
r_static
r_volatile
id|u_char
id|timed_out_audio
suffix:semicolon
macro_line|#endif
DECL|variable|datarate
r_static
id|u_int
id|datarate
op_assign
l_int|1000000
suffix:semicolon
DECL|variable|maxtim16
r_static
id|u_int
id|maxtim16
op_assign
l_int|16000000
suffix:semicolon
DECL|variable|maxtim04
r_static
id|u_int
id|maxtim04
op_assign
l_int|4000000
suffix:semicolon
DECL|variable|maxtim02
r_static
id|u_int
id|maxtim02
op_assign
l_int|2000000
suffix:semicolon
DECL|variable|maxtim_8
r_static
id|u_int
id|maxtim_8
op_assign
l_int|30000
suffix:semicolon
macro_line|#if LONG_TIMING
DECL|variable|maxtim_data
r_static
id|u_int
id|maxtim_data
op_assign
l_int|9000
suffix:semicolon
macro_line|#else
DECL|variable|maxtim_data
r_static
id|u_int
id|maxtim_data
op_assign
l_int|3000
suffix:semicolon
macro_line|#endif LONG_TIMING
macro_line|#if DISTRIBUTION
DECL|variable|n_retries
r_static
r_int
id|n_retries
op_assign
l_int|6
suffix:semicolon
macro_line|#else
DECL|variable|n_retries
r_static
r_int
id|n_retries
op_assign
l_int|6
suffix:semicolon
macro_line|#endif
multiline_comment|/*==========================================================================*/
DECL|variable|ndrives
r_static
r_int
id|ndrives
suffix:semicolon
DECL|variable|drv_pattern
r_static
id|u_char
id|drv_pattern
(braket
id|NR_SBPCD
)braket
op_assign
initialization_block
suffix:semicolon
DECL|variable|sbpcd_blocksizes
r_static
r_int
id|sbpcd_blocksizes
(braket
id|NR_SBPCD
)braket
suffix:semicolon
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; * drive space begins here (needed separate for each unit) &n; */
DECL|variable|d
r_static
r_int
id|d
suffix:semicolon
multiline_comment|/* DriveStruct index: drive number */
r_static
r_struct
(brace
DECL|member|drv_id
r_char
id|drv_id
suffix:semicolon
multiline_comment|/* &quot;jumpered&quot; drive ID or -1 */
DECL|member|drv_sel
r_char
id|drv_sel
suffix:semicolon
multiline_comment|/* drive select lines bits */
DECL|member|drive_model
r_char
id|drive_model
(braket
l_int|9
)braket
suffix:semicolon
DECL|member|firmware_version
id|u_char
id|firmware_version
(braket
l_int|4
)braket
suffix:semicolon
DECL|member|f_eject
r_char
id|f_eject
suffix:semicolon
multiline_comment|/* auto-eject flag: 0 or 1 */
DECL|member|sbp_buf
id|u_char
op_star
id|sbp_buf
suffix:semicolon
multiline_comment|/* Pointer to internal data buffer,&n;&t;&t;&t;&t;  space allocated during sbpcd_init() */
DECL|member|sbp_bufsiz
id|u_int
id|sbp_bufsiz
suffix:semicolon
multiline_comment|/* size of sbp_buf (# of frames) */
DECL|member|sbp_first_frame
r_int
id|sbp_first_frame
suffix:semicolon
multiline_comment|/* First frame in buffer */
DECL|member|sbp_last_frame
r_int
id|sbp_last_frame
suffix:semicolon
multiline_comment|/* Last frame in buffer  */
DECL|member|sbp_read_frames
r_int
id|sbp_read_frames
suffix:semicolon
multiline_comment|/* Number of frames being read to buffer */
DECL|member|sbp_current
r_int
id|sbp_current
suffix:semicolon
multiline_comment|/* Frame being currently read */
DECL|member|mode
id|u_char
id|mode
suffix:semicolon
multiline_comment|/* read_mode: READ_M1, READ_M2, READ_SC, READ_AU */
DECL|member|aud_buf
id|u_char
op_star
id|aud_buf
suffix:semicolon
multiline_comment|/* Pointer to audio data buffer,&n;&t;&t;&t;&t;  space allocated during sbpcd_init() */
DECL|member|sbp_audsiz
id|u_int
id|sbp_audsiz
suffix:semicolon
multiline_comment|/* size of aud_buf (# of raw frames) */
DECL|member|drv_type
id|u_int
id|drv_type
suffix:semicolon
DECL|member|drv_options
id|u_char
id|drv_options
suffix:semicolon
DECL|member|status_bits
r_int
id|status_bits
suffix:semicolon
DECL|member|diskstate_flags
id|u_char
id|diskstate_flags
suffix:semicolon
DECL|member|sense_byte
id|u_char
id|sense_byte
suffix:semicolon
DECL|member|CD_changed
id|u_char
id|CD_changed
suffix:semicolon
DECL|member|open_count
r_char
id|open_count
suffix:semicolon
DECL|member|error_byte
id|u_char
id|error_byte
suffix:semicolon
DECL|member|f_multisession
id|u_char
id|f_multisession
suffix:semicolon
DECL|member|lba_multi
id|u_int
id|lba_multi
suffix:semicolon
DECL|member|first_session
r_int
id|first_session
suffix:semicolon
DECL|member|last_session
r_int
id|last_session
suffix:semicolon
DECL|member|track_of_last_session
r_int
id|track_of_last_session
suffix:semicolon
DECL|member|audio_state
id|u_char
id|audio_state
suffix:semicolon
DECL|member|pos_audio_start
id|u_int
id|pos_audio_start
suffix:semicolon
DECL|member|pos_audio_end
id|u_int
id|pos_audio_end
suffix:semicolon
DECL|member|vol_chan0
r_char
id|vol_chan0
suffix:semicolon
DECL|member|vol_ctrl0
id|u_char
id|vol_ctrl0
suffix:semicolon
DECL|member|vol_chan1
r_char
id|vol_chan1
suffix:semicolon
DECL|member|vol_ctrl1
id|u_char
id|vol_ctrl1
suffix:semicolon
macro_line|#if 000 /* no supported drive has it */
r_char
id|vol_chan2
suffix:semicolon
id|u_char
id|vol_ctrl2
suffix:semicolon
r_char
id|vol_chan3
suffix:semicolon
id|u_char
id|vol_ctrl3
suffix:semicolon
macro_line|#endif 000
DECL|member|volume_control
id|u_char
id|volume_control
suffix:semicolon
multiline_comment|/* TEAC on/off bits */
DECL|member|SubQ_ctl_adr
id|u_char
id|SubQ_ctl_adr
suffix:semicolon
DECL|member|SubQ_trk
id|u_char
id|SubQ_trk
suffix:semicolon
DECL|member|SubQ_pnt_idx
id|u_char
id|SubQ_pnt_idx
suffix:semicolon
DECL|member|SubQ_run_tot
id|u_int
id|SubQ_run_tot
suffix:semicolon
DECL|member|SubQ_run_trk
id|u_int
id|SubQ_run_trk
suffix:semicolon
DECL|member|SubQ_whatisthis
id|u_char
id|SubQ_whatisthis
suffix:semicolon
DECL|member|UPC_ctl_adr
id|u_char
id|UPC_ctl_adr
suffix:semicolon
DECL|member|UPC_buf
id|u_char
id|UPC_buf
(braket
l_int|7
)braket
suffix:semicolon
DECL|member|frame_size
r_int
id|frame_size
suffix:semicolon
DECL|member|CDsize_frm
r_int
id|CDsize_frm
suffix:semicolon
DECL|member|xa_byte
id|u_char
id|xa_byte
suffix:semicolon
multiline_comment|/* 0x20: XA capabilities */
DECL|member|n_first_track
id|u_char
id|n_first_track
suffix:semicolon
multiline_comment|/* binary */
DECL|member|n_last_track
id|u_char
id|n_last_track
suffix:semicolon
multiline_comment|/* binary (not bcd), 0x01...0x63 */
DECL|member|size_msf
id|u_int
id|size_msf
suffix:semicolon
multiline_comment|/* time of whole CD, position of LeadOut track */
DECL|member|size_blk
id|u_int
id|size_blk
suffix:semicolon
DECL|member|TocEnt_nixbyte
id|u_char
id|TocEnt_nixbyte
suffix:semicolon
multiline_comment|/* em */
DECL|member|TocEnt_ctl_adr
id|u_char
id|TocEnt_ctl_adr
suffix:semicolon
DECL|member|TocEnt_number
id|u_char
id|TocEnt_number
suffix:semicolon
DECL|member|TocEnt_format
id|u_char
id|TocEnt_format
suffix:semicolon
multiline_comment|/* em */
DECL|member|TocEnt_address
id|u_int
id|TocEnt_address
suffix:semicolon
macro_line|#if SAFE_MIXED
DECL|member|has_data
r_char
id|has_data
suffix:semicolon
macro_line|#endif SAFE_MIXED
DECL|member|ored_ctl_adr
id|u_char
id|ored_ctl_adr
suffix:semicolon
multiline_comment|/* to detect if CDROM contains data tracks */
r_struct
(brace
DECL|member|nixbyte
id|u_char
id|nixbyte
suffix:semicolon
multiline_comment|/* em */
DECL|member|ctl_adr
id|u_char
id|ctl_adr
suffix:semicolon
multiline_comment|/* 0x4x: data, 0x0x: audio */
DECL|member|number
id|u_char
id|number
suffix:semicolon
DECL|member|format
id|u_char
id|format
suffix:semicolon
multiline_comment|/* em */
multiline_comment|/* 0x00: lba, 0x01: msf */
DECL|member|address
id|u_int
id|address
suffix:semicolon
DECL|member|TocBuffer
)brace
id|TocBuffer
(braket
id|MAX_TRACKS
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* last entry faked */
DECL|member|in_SpinUp
r_int
id|in_SpinUp
suffix:semicolon
multiline_comment|/* CR-52x test flag */
DECL|member|n_bytes
r_int
id|n_bytes
suffix:semicolon
multiline_comment|/* TEAC awaited response count */
DECL|member|error_state
DECL|member|b3
DECL|member|b4
id|u_char
id|error_state
comma
id|b3
comma
id|b4
suffix:semicolon
multiline_comment|/* TEAC command error state */
DECL|member|f_drv_error
id|u_char
id|f_drv_error
suffix:semicolon
multiline_comment|/* TEAC command error flag */
DECL|member|speed_byte
id|u_char
id|speed_byte
suffix:semicolon
DECL|member|frmsiz
r_int
id|frmsiz
suffix:semicolon
DECL|member|f_XA
id|u_char
id|f_XA
suffix:semicolon
multiline_comment|/* 1: XA */
DECL|member|type_byte
id|u_char
id|type_byte
suffix:semicolon
multiline_comment|/* 0, 1, 3 */
DECL|member|mode_xb_6
id|u_char
id|mode_xb_6
suffix:semicolon
DECL|member|mode_yb_7
id|u_char
id|mode_yb_7
suffix:semicolon
DECL|member|mode_xb_8
id|u_char
id|mode_xb_8
suffix:semicolon
DECL|member|delay
id|u_char
id|delay
suffix:semicolon
DECL|member|sbpcd_infop
r_struct
id|cdrom_device_info
op_star
id|sbpcd_infop
suffix:semicolon
DECL|variable|D_S
)brace
id|D_S
(braket
id|NR_SBPCD
)braket
suffix:semicolon
multiline_comment|/*&n; * drive space ends here (needed separate for each unit)&n; */
multiline_comment|/*==========================================================================*/
macro_line|#if 0
r_int
r_int
id|cli_sti
suffix:semicolon
multiline_comment|/* for saving the processor flags */
macro_line|#endif
multiline_comment|/*==========================================================================*/
DECL|variable|delay_timer
r_static
r_struct
id|timer_list
id|delay_timer
op_assign
(brace
id|function
suffix:colon
id|mark_timeout_delay
)brace
suffix:semicolon
DECL|variable|data_timer
r_static
r_struct
id|timer_list
id|data_timer
op_assign
(brace
id|function
suffix:colon
id|mark_timeout_data
)brace
suffix:semicolon
macro_line|#if 0
r_static
r_struct
id|timer_list
id|audio_timer
op_assign
(brace
id|function
suffix:colon
id|mark_timeout_audio
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; * DDI interface&n; */
DECL|function|msg
r_static
r_void
id|msg
c_func
(paren
r_int
id|level
comma
r_const
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
macro_line|#if DISTRIBUTION
DECL|macro|MSG_LEVEL
mdefine_line|#define MSG_LEVEL KERN_NOTICE
macro_line|#else
mdefine_line|#define MSG_LEVEL KERN_INFO
macro_line|#endif DISTRIBUTION
r_char
id|buf
(braket
l_int|256
)braket
suffix:semicolon
id|va_list
id|args
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sbpcd_debug
op_amp
(paren
l_int|1
op_lshift
id|level
)paren
)paren
)paren
r_return
suffix:semicolon
id|msgnum
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|msgnum
OG
l_int|99
)paren
id|msgnum
op_assign
l_int|0
suffix:semicolon
id|sprintf
c_func
(paren
id|buf
comma
id|MSG_LEVEL
l_string|&quot;%s-%d [%02d]:  &quot;
comma
id|major_name
comma
id|d
comma
id|msgnum
)paren
suffix:semicolon
id|va_start
c_func
(paren
id|args
comma
id|fmt
)paren
suffix:semicolon
id|vsprintf
c_func
(paren
op_amp
id|buf
(braket
l_int|18
)braket
comma
id|fmt
comma
id|args
)paren
suffix:semicolon
id|va_end
c_func
(paren
id|args
)paren
suffix:semicolon
id|printk
c_func
(paren
id|buf
)paren
suffix:semicolon
macro_line|#if KLOGD_PAUSE
id|sbp_sleep
c_func
(paren
id|KLOGD_PAUSE
)paren
suffix:semicolon
multiline_comment|/* else messages get lost */
macro_line|#endif KLOGD_PAUSE
r_return
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; * DDI interface: runtime trace bit pattern maintenance&n; */
DECL|function|sbpcd_dbg_ioctl
r_static
r_int
id|sbpcd_dbg_ioctl
c_func
(paren
r_int
r_int
id|arg
comma
r_int
id|level
)paren
(brace
r_switch
c_cond
(paren
id|arg
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* OFF */
id|sbpcd_debug
op_assign
id|DBG_INF
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|arg
op_ge
l_int|128
)paren
id|sbpcd_debug
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|arg
op_minus
l_int|128
)paren
)paren
suffix:semicolon
r_else
id|sbpcd_debug
op_or_assign
(paren
l_int|1
op_lshift
id|arg
)paren
suffix:semicolon
)brace
r_return
(paren
id|arg
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|mark_timeout_delay
r_static
r_void
id|mark_timeout_delay
c_func
(paren
id|u_long
id|i
)paren
(brace
id|timed_out_delay
op_assign
l_int|1
suffix:semicolon
macro_line|#if 0
id|msg
c_func
(paren
id|DBG_TIM
comma
l_string|&quot;delay timer expired.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*==========================================================================*/
DECL|function|mark_timeout_data
r_static
r_void
id|mark_timeout_data
c_func
(paren
id|u_long
id|i
)paren
(brace
id|timed_out_data
op_assign
l_int|1
suffix:semicolon
macro_line|#if 0
id|msg
c_func
(paren
id|DBG_TIM
comma
l_string|&quot;data timer expired.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*==========================================================================*/
macro_line|#if 0
r_static
r_void
id|mark_timeout_audio
c_func
(paren
id|u_long
id|i
)paren
(brace
id|timed_out_audio
op_assign
l_int|1
suffix:semicolon
macro_line|#if 0
id|msg
c_func
(paren
id|DBG_TIM
comma
l_string|&quot;audio timer expired.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#endif
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; * Wait a little while (used for polling the drive).&n; */
DECL|function|sbp_sleep
r_static
r_void
id|sbp_sleep
c_func
(paren
id|u_int
id|time
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|time
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|macro|RETURN_UP
mdefine_line|#define RETURN_UP(rc) {up(&amp;ioctl_read_sem); return(rc);}
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; *  convert logical_block_address to m-s-f_number (3 bytes only)&n; */
DECL|function|lba2msf
r_static
id|INLINE
r_void
id|lba2msf
c_func
(paren
r_int
id|lba
comma
id|u_char
op_star
id|msf
)paren
(brace
id|lba
op_add_assign
id|CD_MSF_OFFSET
suffix:semicolon
id|msf
(braket
l_int|0
)braket
op_assign
id|lba
op_div
(paren
id|CD_SECS
op_star
id|CD_FRAMES
)paren
suffix:semicolon
id|lba
op_mod_assign
id|CD_SECS
op_star
id|CD_FRAMES
suffix:semicolon
id|msf
(braket
l_int|1
)braket
op_assign
id|lba
op_div
id|CD_FRAMES
suffix:semicolon
id|msf
(braket
l_int|2
)braket
op_assign
id|lba
op_mod
id|CD_FRAMES
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; *  convert msf-bin to msf-bcd&n; */
DECL|function|bin2bcdx
r_static
id|INLINE
r_void
id|bin2bcdx
c_func
(paren
id|u_char
op_star
id|p
)paren
multiline_comment|/* must work only up to 75 or 99 */
(brace
op_star
id|p
op_assign
(paren
(paren
op_star
id|p
op_div
l_int|10
)paren
op_lshift
l_int|4
)paren
op_or
(paren
op_star
id|p
op_mod
l_int|10
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|blk2msf
r_static
id|INLINE
id|u_int
id|blk2msf
c_func
(paren
id|u_int
id|blk
)paren
(brace
id|MSF
id|msf
suffix:semicolon
id|u_int
id|mm
suffix:semicolon
id|msf.c
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msf.c
(braket
l_int|2
)braket
op_assign
(paren
id|blk
op_plus
id|CD_MSF_OFFSET
)paren
op_div
(paren
id|CD_SECS
op_star
id|CD_FRAMES
)paren
suffix:semicolon
id|mm
op_assign
(paren
id|blk
op_plus
id|CD_MSF_OFFSET
)paren
op_mod
(paren
id|CD_SECS
op_star
id|CD_FRAMES
)paren
suffix:semicolon
id|msf.c
(braket
l_int|1
)braket
op_assign
id|mm
op_div
id|CD_FRAMES
suffix:semicolon
id|msf.c
(braket
l_int|0
)braket
op_assign
id|mm
op_mod
id|CD_FRAMES
suffix:semicolon
r_return
(paren
id|msf.n
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|make16
r_static
id|INLINE
id|u_int
id|make16
c_func
(paren
id|u_char
id|rh
comma
id|u_char
id|rl
)paren
(brace
r_return
(paren
(paren
id|rh
op_lshift
l_int|8
)paren
op_or
id|rl
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|make32
r_static
id|INLINE
id|u_int
id|make32
c_func
(paren
id|u_int
id|rh
comma
id|u_int
id|rl
)paren
(brace
r_return
(paren
(paren
id|rh
op_lshift
l_int|16
)paren
op_or
id|rl
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|swap_nibbles
r_static
id|INLINE
id|u_char
id|swap_nibbles
c_func
(paren
id|u_char
id|i
)paren
(brace
r_return
(paren
(paren
id|i
op_lshift
l_int|4
)paren
op_or
(paren
id|i
op_rshift
l_int|4
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|byt2bcd
r_static
id|INLINE
id|u_char
id|byt2bcd
c_func
(paren
id|u_char
id|i
)paren
(brace
r_return
(paren
(paren
(paren
id|i
op_div
l_int|10
)paren
op_lshift
l_int|4
)paren
op_plus
id|i
op_mod
l_int|10
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|bcd2bin
r_static
id|INLINE
id|u_char
id|bcd2bin
c_func
(paren
id|u_char
id|bcd
)paren
(brace
r_return
(paren
(paren
id|bcd
op_rshift
l_int|4
)paren
op_star
l_int|10
op_plus
(paren
id|bcd
op_amp
l_int|0x0F
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|msf2blk
r_static
id|INLINE
r_int
id|msf2blk
c_func
(paren
r_int
id|msfx
)paren
(brace
id|MSF
id|msf
suffix:semicolon
r_int
id|i
suffix:semicolon
id|msf.n
op_assign
id|msfx
suffix:semicolon
id|i
op_assign
(paren
id|msf.c
(braket
l_int|2
)braket
op_star
id|CD_SECS
op_plus
id|msf.c
(braket
l_int|1
)braket
)paren
op_star
id|CD_FRAMES
op_plus
id|msf.c
(braket
l_int|0
)braket
op_minus
id|CD_MSF_OFFSET
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; *  convert m-s-f_number (3 bytes only) to logical_block_address &n; */
DECL|function|msf2lba
r_static
id|INLINE
r_int
id|msf2lba
c_func
(paren
id|u_char
op_star
id|msf
)paren
(brace
r_int
id|i
suffix:semicolon
id|i
op_assign
(paren
id|msf
(braket
l_int|0
)braket
op_star
id|CD_SECS
op_plus
id|msf
(braket
l_int|1
)braket
)paren
op_star
id|CD_FRAMES
op_plus
id|msf
(braket
l_int|2
)braket
op_minus
id|CD_MSF_OFFSET
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/* evaluate cc_ReadError code */
DECL|function|sta2err
r_static
r_int
id|sta2err
c_func
(paren
r_int
id|sta
)paren
(brace
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
r_if
c_cond
(paren
id|sta
op_eq
l_int|0x00
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sta
op_eq
l_int|0x01
)paren
r_return
(paren
op_minus
l_int|604
)paren
suffix:semicolon
multiline_comment|/* CRC error */
r_if
c_cond
(paren
id|sta
op_eq
l_int|0x02
)paren
r_return
(paren
op_minus
l_int|602
)paren
suffix:semicolon
multiline_comment|/* drive not ready */
r_if
c_cond
(paren
id|sta
op_eq
l_int|0x03
)paren
r_return
(paren
op_minus
l_int|607
)paren
suffix:semicolon
multiline_comment|/* unknown media */
r_if
c_cond
(paren
id|sta
op_eq
l_int|0x04
)paren
r_return
(paren
op_minus
l_int|612
)paren
suffix:semicolon
multiline_comment|/* general failure */
r_if
c_cond
(paren
id|sta
op_eq
l_int|0x05
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sta
op_eq
l_int|0x06
)paren
r_return
(paren
op_minus
id|ERR_DISKCHANGE
)paren
suffix:semicolon
multiline_comment|/* disk change */
r_if
c_cond
(paren
id|sta
op_eq
l_int|0x0b
)paren
r_return
(paren
op_minus
l_int|612
)paren
suffix:semicolon
multiline_comment|/* general failure */
r_if
c_cond
(paren
id|sta
op_eq
l_int|0xff
)paren
r_return
(paren
op_minus
l_int|612
)paren
suffix:semicolon
multiline_comment|/* general failure */
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|sta
op_le
l_int|2
)paren
r_return
(paren
id|sta
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sta
op_eq
l_int|0x05
)paren
r_return
(paren
op_minus
l_int|604
)paren
suffix:semicolon
multiline_comment|/* CRC error */
r_if
c_cond
(paren
id|sta
op_eq
l_int|0x06
)paren
r_return
(paren
op_minus
l_int|606
)paren
suffix:semicolon
multiline_comment|/* seek error */
r_if
c_cond
(paren
id|sta
op_eq
l_int|0x0d
)paren
r_return
(paren
op_minus
l_int|606
)paren
suffix:semicolon
multiline_comment|/* seek error */
r_if
c_cond
(paren
id|sta
op_eq
l_int|0x0e
)paren
r_return
(paren
op_minus
l_int|603
)paren
suffix:semicolon
multiline_comment|/* unknown command */
r_if
c_cond
(paren
id|sta
op_eq
l_int|0x14
)paren
r_return
(paren
op_minus
l_int|603
)paren
suffix:semicolon
multiline_comment|/* unknown command */
r_if
c_cond
(paren
id|sta
op_eq
l_int|0x0c
)paren
r_return
(paren
op_minus
l_int|611
)paren
suffix:semicolon
multiline_comment|/* read fault */
r_if
c_cond
(paren
id|sta
op_eq
l_int|0x0f
)paren
r_return
(paren
op_minus
l_int|611
)paren
suffix:semicolon
multiline_comment|/* read fault */
r_if
c_cond
(paren
id|sta
op_eq
l_int|0x10
)paren
r_return
(paren
op_minus
l_int|611
)paren
suffix:semicolon
multiline_comment|/* read fault */
r_if
c_cond
(paren
id|sta
op_ge
l_int|0x16
)paren
r_return
(paren
op_minus
l_int|612
)paren
suffix:semicolon
multiline_comment|/* general failure */
r_if
c_cond
(paren
id|sta
op_eq
l_int|0x11
)paren
r_return
(paren
op_minus
id|ERR_DISKCHANGE
)paren
suffix:semicolon
multiline_comment|/* disk change (LCS: removed) */
r_if
c_cond
(paren
id|famL_drive
)paren
r_if
c_cond
(paren
id|sta
op_eq
l_int|0x12
)paren
r_return
(paren
op_minus
id|ERR_DISKCHANGE
)paren
suffix:semicolon
multiline_comment|/* disk change (inserted) */
r_return
(paren
op_minus
l_int|602
)paren
suffix:semicolon
multiline_comment|/* drive not ready */
)brace
)brace
multiline_comment|/*==========================================================================*/
DECL|function|clr_cmdbuf
r_static
id|INLINE
r_void
id|clr_cmdbuf
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
id|drvcmd
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|cmd_type
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|flush_status
r_static
r_void
id|flush_status
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|15
op_star
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|maxtim_data
suffix:semicolon
id|i
op_ne
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
)brace
multiline_comment|/*====================================================================*/
multiline_comment|/*&n; * CDi status loop for Teac CD-55A (Rob Riggs)&n; *&n; * This is needed because for some strange reason&n; * the CD-55A can take a real long time to give a&n; * status response. This seems to happen after we&n; * issue a READ command where a long seek is involved.&n; *&n; * I tried to ensure that we get max throughput with&n; * minimal busy waiting. We busy wait at first, then&n; * &quot;switch gears&quot; and start sleeping. We sleep for&n; * longer periods of time the longer we wait.&n; *&n; */
DECL|function|CDi_stat_loop_T
r_static
r_int
id|CDi_stat_loop_T
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|gear
op_assign
l_int|1
suffix:semicolon
id|u_long
id|timeout_1
comma
id|timeout_2
comma
id|timeout_3
comma
id|timeout_4
suffix:semicolon
id|timeout_1
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|50
suffix:semicolon
multiline_comment|/* sbp_sleep(0) for a short period */
id|timeout_2
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|5
suffix:semicolon
multiline_comment|/* nap for no more than 200ms */
id|timeout_3
op_assign
id|jiffies
op_plus
l_int|5
op_star
id|HZ
suffix:semicolon
multiline_comment|/* sleep for up to 5s */
id|timeout_4
op_assign
id|jiffies
op_plus
l_int|45
op_star
id|HZ
suffix:semicolon
multiline_comment|/* long sleep for up to 45s. */
r_do
(brace
id|i
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|i
op_amp
id|s_not_data_ready
)paren
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|i
op_amp
id|s_not_result_ready
)paren
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|gear
)paren
(brace
r_case
l_int|4
suffix:colon
id|sbp_sleep
c_func
(paren
id|HZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|timeout_4
)paren
)paren
id|gear
op_increment
suffix:semicolon
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;CDi_stat_loop_T: long sleep active.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|sbp_sleep
c_func
(paren
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|timeout_3
)paren
)paren
id|gear
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|sbp_sleep
c_func
(paren
id|HZ
op_div
l_int|100
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|timeout_2
)paren
)paren
id|gear
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|sbp_sleep
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|timeout_1
)paren
)paren
id|gear
op_increment
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|gear
OL
l_int|5
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|CDi_stat_loop
r_static
r_int
id|CDi_stat_loop
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_for
c_loop
(paren
id|timeout
op_assign
id|jiffies
op_plus
l_int|10
op_star
id|HZ
comma
id|i
op_assign
id|maxtim_data
suffix:semicolon
id|time_before
c_func
(paren
id|jiffies
comma
id|timeout
)paren
suffix:semicolon
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
id|i
op_ne
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|j
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|j
op_amp
id|s_not_data_ready
)paren
)paren
r_return
(paren
id|j
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|j
op_amp
id|s_not_result_ready
)paren
)paren
r_return
(paren
id|j
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fam0L_drive
)paren
r_if
c_cond
(paren
id|j
op_amp
id|s_attention
)paren
r_return
(paren
id|j
)paren
suffix:semicolon
)brace
id|sbp_sleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|i
op_assign
l_int|1
suffix:semicolon
)brace
id|msg
c_func
(paren
id|DBG_LCS
comma
l_string|&quot;CDi_stat_loop failed in line %d&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
macro_line|#if 00000
multiline_comment|/*==========================================================================*/
r_static
r_int
id|tst_DataReady
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|i
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_amp
id|s_not_data_ready
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
r_static
r_int
id|tst_ResultReady
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|i
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_amp
id|s_not_result_ready
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
r_static
r_int
id|tst_Attention
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|i
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_amp
id|s_attention
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
macro_line|#endif 00000
multiline_comment|/*==========================================================================*/
DECL|function|ResponseInfo
r_static
r_int
id|ResponseInfo
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
comma
id|st
op_assign
l_int|0
suffix:semicolon
id|u_long
id|timeout
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|timeout
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
id|i
OL
id|response_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
id|maxtim_data
suffix:semicolon
suffix:semicolon
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
id|j
op_ne
l_int|0
suffix:semicolon
id|j
op_decrement
)paren
(brace
id|st
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|st
op_amp
id|s_not_result_ready
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|j
op_ne
l_int|0
)paren
op_logical_or
id|time_after_eq
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
r_break
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|j
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|time_after_eq
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
r_break
suffix:semicolon
id|infobuf
(braket
id|i
)braket
op_assign
id|inb
c_func
(paren
id|CDi_info
)paren
suffix:semicolon
)brace
macro_line|#if 000
r_while
c_loop
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|CDi_status
)paren
op_amp
id|s_not_result_ready
)paren
)paren
(brace
id|infobuf
(braket
id|i
op_increment
)braket
op_assign
id|inb
c_func
(paren
id|CDi_info
)paren
suffix:semicolon
)brace
id|j
op_assign
id|i
op_minus
id|response_count
suffix:semicolon
r_if
c_cond
(paren
id|j
OG
l_int|0
)paren
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;ResponseInfo: got %d trailing bytes.&bslash;n&quot;
comma
id|j
)paren
suffix:semicolon
macro_line|#endif 000
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|i
suffix:semicolon
id|j
op_increment
)paren
id|sprintf
c_func
(paren
op_amp
id|msgbuf
(braket
id|j
op_star
l_int|3
)braket
comma
l_string|&quot; %02X&quot;
comma
id|infobuf
(braket
id|j
)braket
)paren
suffix:semicolon
id|msgbuf
(braket
id|j
op_star
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
c_func
(paren
id|DBG_CMD
comma
l_string|&quot;ResponseInfo:%s (%d,%d)&bslash;n&quot;
comma
id|msgbuf
comma
id|response_count
comma
id|i
)paren
suffix:semicolon
id|j
op_assign
id|response_count
op_minus
id|i
suffix:semicolon
r_if
c_cond
(paren
id|j
OG
l_int|0
)paren
r_return
(paren
op_minus
id|j
)paren
suffix:semicolon
r_else
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|EvaluateStatus
r_static
r_void
id|EvaluateStatus
c_func
(paren
r_int
id|st
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|fam1_drive
)paren
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_assign
id|st
op_or
id|p_success
suffix:semicolon
r_else
r_if
c_cond
(paren
id|fam0_drive
)paren
(brace
r_if
c_cond
(paren
id|st
op_amp
id|p_caddin_old
)paren
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_or_assign
id|p_door_closed
op_or
id|p_caddy_in
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p_spinning
)paren
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_or_assign
id|p_spinning
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p_check
)paren
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_or_assign
id|p_check
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p_success_old
)paren
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_or_assign
id|p_success
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p_busy_old
)paren
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_or_assign
id|p_busy_new
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p_disk_ok
)paren
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_or_assign
id|p_disk_ok
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famLV_drive
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_or_assign
id|p_success
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p_caddin_old
)paren
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_or_assign
id|p_disk_ok
op_or
id|p_caddy_in
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p_spinning
)paren
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_or_assign
id|p_spinning
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p_check
)paren
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_or_assign
id|p_check
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p_busy_old
)paren
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_or_assign
id|p_busy_new
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p_lcs_door_closed
)paren
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_or_assign
id|p_door_closed
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p_lcs_door_locked
)paren
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_or_assign
id|p_door_locked
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam2_drive
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_or_assign
id|p_success
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p2_check
)paren
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_or_assign
id|p1_check
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p2_door_closed
)paren
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_or_assign
id|p1_door_closed
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p2_disk_in
)paren
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_or_assign
id|p1_disk_in
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p2_busy1
)paren
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_or_assign
id|p1_busy
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p2_busy2
)paren
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_or_assign
id|p1_busy
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p2_spinning
)paren
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_or_assign
id|p1_spinning
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p2_door_locked
)paren
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_or_assign
id|p1_door_locked
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p2_disk_ok
)paren
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_or_assign
id|p1_disk_ok
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
r_return
suffix:semicolon
multiline_comment|/* still needs to get coded */
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_or_assign
id|p_success
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p2_check
)paren
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_or_assign
id|p1_check
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p2_door_closed
)paren
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_or_assign
id|p1_door_closed
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p2_disk_in
)paren
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_or_assign
id|p1_disk_in
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p2_busy1
)paren
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_or_assign
id|p1_busy
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p2_busy2
)paren
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_or_assign
id|p1_busy
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p2_spinning
)paren
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_or_assign
id|p1_spinning
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p2_door_locked
)paren
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_or_assign
id|p1_door_locked
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p2_disk_ok
)paren
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_or_assign
id|p1_disk_ok
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|get_state_T
r_static
r_int
id|get_state_T
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_static
r_int
id|cmd_out_T
c_func
(paren
r_void
)paren
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|n_bytes
op_assign
l_int|1
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMDT_STATUS
suffix:semicolon
id|i
op_assign
id|cmd_out_T
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
l_int|0
)paren
id|i
op_assign
id|infobuf
(braket
l_int|0
)braket
suffix:semicolon
r_else
(brace
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;get_state_T error %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ge
l_int|0
)paren
multiline_comment|/* 2: closed, disk in */
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_assign
id|p1_door_closed
op_or
id|p1_disk_in
op_or
id|p1_spinning
op_or
id|p1_disk_ok
suffix:semicolon
r_else
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|error_state
op_eq
l_int|6
)paren
(brace
multiline_comment|/* 3: closed, disk in, changed (&quot;06 xx xx&quot;) */
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_assign
id|p1_door_closed
op_or
id|p1_disk_in
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|CD_changed
op_assign
l_int|0xFF
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|diskstate_flags
op_and_assign
op_complement
id|toc_bit
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|D_S
(braket
id|d
)braket
dot
id|error_state
op_ne
l_int|2
)paren
op_logical_or
(paren
id|D_S
(braket
id|d
)braket
dot
id|b3
op_ne
l_int|0x3A
)paren
op_logical_or
(paren
id|D_S
(braket
id|d
)braket
dot
id|b4
op_eq
l_int|0x00
)paren
)paren
(brace
multiline_comment|/* 1: closed, no disk (&quot;xx yy zz&quot;or &quot;02 3A 00&quot;) */
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_assign
id|p1_door_closed
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|open_count
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|b4
op_eq
l_int|0x01
)paren
(brace
multiline_comment|/* 0: open (&quot;02 3A 01&quot;) */
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_assign
l_int|0
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|open_count
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* 1: closed, no disk (&quot;02 3A xx&quot;) */
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_assign
id|p1_door_closed
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|open_count
op_assign
l_int|0
suffix:semicolon
)brace
r_return
(paren
id|D_S
(braket
id|d
)braket
dot
id|status_bits
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|ResponseStatus
r_static
r_int
id|ResponseStatus
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
id|u_long
id|timeout
suffix:semicolon
id|msg
c_func
(paren
id|DBG_STA
comma
l_string|&quot;doing ResponseStatus...&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|famT_drive
)paren
r_return
(paren
id|get_state_T
c_func
(paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags_cmd_out
op_amp
id|f_respo3
)paren
id|timeout
op_assign
id|jiffies
suffix:semicolon
r_else
r_if
c_cond
(paren
id|flags_cmd_out
op_amp
id|f_respo2
)paren
id|timeout
op_assign
id|jiffies
op_plus
l_int|16
op_star
id|HZ
suffix:semicolon
r_else
id|timeout
op_assign
id|jiffies
op_plus
l_int|4
op_star
id|HZ
suffix:semicolon
id|j
op_assign
id|maxtim_8
suffix:semicolon
r_do
(brace
r_for
c_loop
(paren
suffix:semicolon
id|j
op_ne
l_int|0
suffix:semicolon
id|j
op_decrement
)paren
(brace
id|i
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|i
op_amp
id|s_not_result_ready
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|j
op_ne
l_int|0
)paren
op_logical_or
id|time_after
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
r_break
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|j
op_assign
l_int|1
suffix:semicolon
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|j
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|flags_cmd_out
op_amp
id|f_respo3
)paren
op_eq
l_int|0
)paren
id|msg
c_func
(paren
id|DBG_STA
comma
l_string|&quot;ResponseStatus: timeout.&bslash;n&quot;
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|status_bits
op_assign
l_int|0
suffix:semicolon
r_return
(paren
op_minus
l_int|401
)paren
suffix:semicolon
)brace
id|i
op_assign
id|inb
c_func
(paren
id|CDi_info
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_STA
comma
l_string|&quot;ResponseStatus: response %02X.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|EvaluateStatus
c_func
(paren
id|i
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_STA
comma
l_string|&quot;status_bits=%02X, i=%02X&bslash;n&quot;
comma
id|D_S
(braket
id|d
)braket
dot
id|status_bits
comma
id|i
)paren
suffix:semicolon
r_return
(paren
id|D_S
(braket
id|d
)braket
dot
id|status_bits
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|cc_ReadStatus
r_static
r_void
id|cc_ReadStatus
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|msg
c_func
(paren
id|DBG_STA
comma
l_string|&quot;giving cc_ReadStatus command&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|famT_drive
)paren
r_return
suffix:semicolon
id|SBPCD_CLI
suffix:semicolon
r_if
c_cond
(paren
id|fam0LV_drive
)paren
id|OUT
c_func
(paren
id|CDo_command
comma
id|CMD0_STATUS
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|fam1_drive
)paren
id|OUT
c_func
(paren
id|CDo_command
comma
id|CMD1_STATUS
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|fam2_drive
)paren
id|OUT
c_func
(paren
id|CDo_command
comma
id|CMD2_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fam0LV_drive
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|OUT
c_func
(paren
id|CDo_command
comma
l_int|0
)paren
suffix:semicolon
id|SBPCD_STI
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|cc_ReadError
r_static
r_int
id|cc_ReadError
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_ERR
comma
l_string|&quot;giving cc_ReadError command.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fam1_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD1_READ_ERR
suffix:semicolon
id|response_count
op_assign
l_int|8
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam0LV_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD0_READ_ERR
suffix:semicolon
id|response_count
op_assign
l_int|6
suffix:semicolon
r_if
c_cond
(paren
id|famLV_drive
)paren
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
r_else
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_getsta
op_or
id|f_ResponseStatus
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam2_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD2_READ_ERR
suffix:semicolon
id|response_count
op_assign
l_int|6
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
id|response_count
op_assign
l_int|5
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMDT_READ_ERR
suffix:semicolon
)brace
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|error_byte
op_assign
l_int|0
suffix:semicolon
id|msg
c_func
(paren
id|DBG_ERR
comma
l_string|&quot;cc_ReadError: cmd_out(CMDx_READ_ERR) returns %d (%02X)&bslash;n&quot;
comma
id|i
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fam0V_drive
)paren
id|i
op_assign
l_int|1
suffix:semicolon
r_else
id|i
op_assign
l_int|2
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|error_byte
op_assign
id|infobuf
(braket
id|i
)braket
suffix:semicolon
id|msg
c_func
(paren
id|DBG_ERR
comma
l_string|&quot;cc_ReadError: infobuf[%d] is %d (%02X)&bslash;n&quot;
comma
id|i
comma
id|D_S
(braket
id|d
)braket
dot
id|error_byte
comma
id|D_S
(braket
id|d
)braket
dot
id|error_byte
)paren
suffix:semicolon
id|i
op_assign
id|sta2err
c_func
(paren
id|infobuf
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
op_minus
id|ERR_DISKCHANGE
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|CD_changed
op_assign
l_int|0xFF
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|diskstate_flags
op_and_assign
op_complement
id|toc_bit
suffix:semicolon
)brace
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|cmd_out_T
r_static
r_int
id|cmd_out_T
c_func
(paren
r_void
)paren
(brace
DECL|macro|CMDT_TRIES
macro_line|#undef CMDT_TRIES
DECL|macro|CMDT_TRIES
mdefine_line|#define CMDT_TRIES 1000
DECL|macro|TEST_FALSE_FF
mdefine_line|#define TEST_FALSE_FF 1
r_static
r_int
id|cc_DriveReset
c_func
(paren
r_void
)paren
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|l
op_assign
l_int|0
comma
id|m
comma
id|ntries
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|error_state
op_assign
l_int|0
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|b3
op_assign
l_int|0
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|b4
op_assign
l_int|0
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|f_drv_error
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
id|sprintf
c_func
(paren
op_amp
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
comma
l_string|&quot; %02X&quot;
comma
id|drvcmd
(braket
id|i
)braket
)paren
suffix:semicolon
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
c_func
(paren
id|DBG_CMD
comma
l_string|&quot;cmd_out_T:%s&bslash;n&quot;
comma
id|msgbuf
)paren
suffix:semicolon
id|OUT
c_func
(paren
id|CDo_sel_i_d
comma
l_int|0
)paren
suffix:semicolon
id|OUT
c_func
(paren
id|CDo_enable
comma
id|D_S
(braket
id|d
)braket
dot
id|drv_sel
)paren
suffix:semicolon
id|i
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
id|do_16bit
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|f_16bit
)paren
op_logical_and
(paren
op_logical_neg
(paren
id|i
op_amp
l_int|0x80
)paren
)paren
)paren
(brace
id|do_16bit
op_assign
l_int|1
suffix:semicolon
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;cmd_out_T: do_16bit set.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|i
op_amp
id|s_not_result_ready
)paren
)paren
r_do
(brace
id|j
op_assign
id|inb
c_func
(paren
id|CDi_info
)paren
suffix:semicolon
id|i
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;cmd_out_T: spurious !s_not_result_ready. (%02X)&bslash;n&quot;
comma
id|j
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|i
op_amp
id|s_not_result_ready
)paren
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
id|OUT
c_func
(paren
id|CDo_command
comma
id|drvcmd
(braket
id|i
)braket
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ntries
op_assign
id|CMDT_TRIES
suffix:semicolon
id|ntries
OG
l_int|0
suffix:semicolon
id|ntries
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|drvcmd
(braket
l_int|0
)braket
op_eq
id|CMDT_READ_VER
)paren
id|sbp_sleep
c_func
(paren
id|HZ
)paren
suffix:semicolon
multiline_comment|/* fixme */
macro_line|#if 01
id|OUT
c_func
(paren
id|CDo_sel_i_d
comma
l_int|1
)paren
suffix:semicolon
macro_line|#endif 01
r_if
c_cond
(paren
id|teac
op_eq
l_int|2
)paren
(brace
r_if
c_cond
(paren
(paren
id|i
op_assign
id|CDi_stat_loop_T
c_func
(paren
)paren
)paren
op_eq
op_minus
l_int|1
)paren
r_break
suffix:semicolon
)brace
r_else
(brace
macro_line|#if 0
id|OUT
c_func
(paren
id|CDo_sel_i_d
comma
l_int|1
)paren
suffix:semicolon
macro_line|#endif 0
id|i
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|i
op_amp
id|s_not_data_ready
)paren
)paren
multiline_comment|/* f.e. CMDT_DISKINFO */
(brace
id|OUT
c_func
(paren
id|CDo_sel_i_d
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|drvcmd
(braket
l_int|0
)braket
op_eq
id|CMDT_READ
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* handled elsewhere */
r_if
c_cond
(paren
id|drvcmd
(braket
l_int|0
)braket
op_eq
id|CMDT_DISKINFO
)paren
(brace
id|l
op_assign
l_int|0
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|do_16bit
)paren
(brace
id|i
op_assign
id|inw
c_func
(paren
id|CDi_data
)paren
suffix:semicolon
id|infobuf
(braket
id|l
op_increment
)braket
op_assign
id|i
op_amp
l_int|0x0ff
suffix:semicolon
id|infobuf
(braket
id|l
op_increment
)braket
op_assign
id|i
op_rshift
l_int|8
suffix:semicolon
macro_line|#if TEST_FALSE_FF
r_if
c_cond
(paren
(paren
id|l
op_eq
l_int|2
)paren
op_logical_and
(paren
id|infobuf
(braket
l_int|0
)braket
op_eq
l_int|0x0ff
)paren
)paren
(brace
id|infobuf
(braket
l_int|0
)braket
op_assign
id|infobuf
(braket
l_int|1
)braket
suffix:semicolon
id|l
op_assign
l_int|1
suffix:semicolon
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;cmd_out_T: do_16bit: false first byte!&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif TEST_FALSE_FF
)brace
r_else
id|infobuf
(braket
id|l
op_increment
)braket
op_assign
id|inb
c_func
(paren
id|CDi_data
)paren
suffix:semicolon
id|i
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|i
op_amp
id|s_not_data_ready
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|l
suffix:semicolon
id|j
op_increment
)paren
id|sprintf
c_func
(paren
op_amp
id|msgbuf
(braket
id|j
op_star
l_int|3
)braket
comma
l_string|&quot; %02X&quot;
comma
id|infobuf
(braket
id|j
)braket
)paren
suffix:semicolon
id|msgbuf
(braket
id|j
op_star
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
c_func
(paren
id|DBG_CMD
comma
l_string|&quot;cmd_out_T data response:%s&bslash;n&quot;
comma
id|msgbuf
)paren
suffix:semicolon
)brace
r_else
(brace
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;cmd_out_T: data response with cmd_%02X!&bslash;n&quot;
comma
id|drvcmd
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|j
op_assign
l_int|0
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|do_16bit
)paren
id|i
op_assign
id|inw
c_func
(paren
id|CDi_data
)paren
suffix:semicolon
r_else
id|i
op_assign
id|inb
c_func
(paren
id|CDi_data
)paren
suffix:semicolon
id|j
op_increment
suffix:semicolon
id|i
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|i
op_amp
id|s_not_data_ready
)paren
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;cmd_out_T: data response: discarded %d bytes/words.&bslash;n&quot;
comma
id|j
)paren
suffix:semicolon
id|fatal_err
op_increment
suffix:semicolon
)brace
)brace
id|i
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|i
op_amp
id|s_not_result_ready
)paren
)paren
(brace
id|OUT
c_func
(paren
id|CDo_sel_i_d
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|drvcmd
(braket
l_int|0
)braket
op_eq
id|CMDT_DISKINFO
)paren
id|m
op_assign
id|l
suffix:semicolon
r_else
id|m
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|infobuf
(braket
id|m
op_increment
)braket
op_assign
id|inb
c_func
(paren
id|CDi_info
)paren
suffix:semicolon
id|i
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|i
op_amp
id|s_not_result_ready
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|m
suffix:semicolon
id|j
op_increment
)paren
id|sprintf
c_func
(paren
op_amp
id|msgbuf
(braket
id|j
op_star
l_int|3
)braket
comma
l_string|&quot; %02X&quot;
comma
id|infobuf
(braket
id|j
)braket
)paren
suffix:semicolon
id|msgbuf
(braket
id|j
op_star
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
c_func
(paren
id|DBG_CMD
comma
l_string|&quot;cmd_out_T info response:%s&bslash;n&quot;
comma
id|msgbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|drvcmd
(braket
l_int|0
)braket
op_eq
id|CMDT_DISKINFO
)paren
(brace
id|infobuf
(braket
l_int|0
)braket
op_assign
id|infobuf
(braket
id|l
)braket
suffix:semicolon
r_if
c_cond
(paren
id|infobuf
(braket
l_int|0
)braket
op_ne
l_int|0x02
)paren
r_return
(paren
id|l
)paren
suffix:semicolon
multiline_comment|/* data length */
)brace
r_else
r_if
c_cond
(paren
id|infobuf
(braket
l_int|0
)braket
op_ne
l_int|0x02
)paren
r_return
(paren
id|m
)paren
suffix:semicolon
multiline_comment|/* info length */
r_do
(brace
op_increment
id|recursion
suffix:semicolon
r_if
c_cond
(paren
id|recursion
OG
l_int|1
)paren
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;cmd_out_T READ_ERR recursion (%02X): %d !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&bslash;n&quot;
comma
id|drvcmd
(braket
l_int|0
)braket
comma
id|recursion
)paren
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMDT_READ_ERR
suffix:semicolon
id|j
op_assign
id|cmd_out_T
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* !!! recursive here !!! */
op_decrement
id|recursion
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|j
OL
l_int|0
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|error_state
op_assign
id|infobuf
(braket
l_int|2
)braket
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|b3
op_assign
id|infobuf
(braket
l_int|3
)braket
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|b4
op_assign
id|infobuf
(braket
l_int|4
)braket
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|f_drv_error
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|f_drv_error
op_assign
l_int|0
suffix:semicolon
id|cc_DriveReset
c_func
(paren
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|error_state
op_assign
l_int|2
suffix:semicolon
)brace
r_return
(paren
op_minus
id|D_S
(braket
id|d
)braket
dot
id|error_state
op_minus
l_int|400
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|drvcmd
(braket
l_int|0
)braket
op_eq
id|CMDT_READ
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* handled elsewhere */
r_if
c_cond
(paren
(paren
id|teac
op_eq
l_int|0
)paren
op_logical_or
(paren
id|ntries
OL
(paren
id|CMDT_TRIES
op_minus
l_int|5
)paren
)paren
)paren
id|sbp_sleep
c_func
(paren
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
r_else
id|sbp_sleep
c_func
(paren
id|HZ
op_div
l_int|100
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ntries
OG
(paren
id|CMDT_TRIES
op_minus
l_int|50
)paren
)paren
r_continue
suffix:semicolon
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;cmd_out_T: next CMDT_TRIES (%02X): %d.&bslash;n&quot;
comma
id|drvcmd
(braket
l_int|0
)braket
comma
id|ntries
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|D_S
(braket
id|d
)braket
dot
id|f_drv_error
op_assign
l_int|1
suffix:semicolon
id|cc_DriveReset
c_func
(paren
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|error_state
op_assign
l_int|2
suffix:semicolon
r_return
(paren
op_minus
l_int|99
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|cmd_out
r_static
r_int
id|cmd_out
c_func
(paren
r_void
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|famT_drive
)paren
r_return
id|cmd_out_T
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags_cmd_out
op_amp
id|f_putcmd
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
)paren
id|sprintf
c_func
(paren
op_amp
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
comma
l_string|&quot; %02X&quot;
comma
id|drvcmd
(braket
id|i
)braket
)paren
suffix:semicolon
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
c_func
(paren
id|DBG_CMD
comma
l_string|&quot;cmd_out:%s&bslash;n&quot;
comma
id|msgbuf
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
)paren
id|OUT
c_func
(paren
id|CDo_command
comma
id|drvcmd
(braket
id|i
)braket
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|response_count
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|cmd_type
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|sbpro_type
op_eq
l_int|1
)paren
id|OUT
c_func
(paren
id|CDo_sel_i_d
comma
l_int|1
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;misleaded to try ResponseData.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbpro_type
op_eq
l_int|1
)paren
id|OUT
c_func
(paren
id|CDo_sel_i_d
comma
l_int|0
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|22
)paren
suffix:semicolon
)brace
r_else
id|i
op_assign
id|ResponseInfo
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|in_SpinUp
)paren
id|msg
c_func
(paren
id|DBG_SPI
comma
l_string|&quot;in_SpinUp: to CDi_stat_loop.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags_cmd_out
op_amp
id|f_lopsta
)paren
(brace
id|i
op_assign
id|CDi_stat_loop
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
OL
l_int|0
)paren
op_logical_or
op_logical_neg
(paren
id|i
op_amp
id|s_attention
)paren
)paren
r_return
(paren
op_minus
l_int|8
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|flags_cmd_out
op_amp
id|f_getsta
)paren
)paren
r_goto
id|LOC_229
suffix:semicolon
id|LOC_228
suffix:colon
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|in_SpinUp
)paren
id|msg
c_func
(paren
id|DBG_SPI
comma
l_string|&quot;in_SpinUp: to cc_ReadStatus.&bslash;n&quot;
)paren
suffix:semicolon
id|cc_ReadStatus
c_func
(paren
)paren
suffix:semicolon
id|LOC_229
suffix:colon
r_if
c_cond
(paren
id|flags_cmd_out
op_amp
id|f_ResponseStatus
)paren
(brace
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|in_SpinUp
)paren
id|msg
c_func
(paren
id|DBG_SPI
comma
l_string|&quot;in_SpinUp: to ResponseStatus.&bslash;n&quot;
)paren
suffix:semicolon
id|i
op_assign
id|ResponseStatus
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* builds status_bits, returns orig. status or p_busy_new */
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags_cmd_out
op_amp
(paren
id|f_bit1
op_or
id|f_wait_if_busy
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|st_check
)paren
(brace
r_if
c_cond
(paren
(paren
id|flags_cmd_out
op_amp
id|f_bit1
)paren
op_logical_and
(paren
id|i
op_amp
id|p_success
)paren
)paren
r_goto
id|LOC_232
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
id|flags_cmd_out
op_amp
id|f_wait_if_busy
)paren
)paren
op_logical_or
(paren
op_logical_neg
id|st_busy
)paren
)paren
r_goto
id|LOC_228
suffix:semicolon
)brace
)brace
)brace
id|LOC_232
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|flags_cmd_out
op_amp
id|f_obey_p_check
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|st_check
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|in_SpinUp
)paren
id|msg
c_func
(paren
id|DBG_SPI
comma
l_string|&quot;in_SpinUp: to cc_ReadError.&bslash;n&quot;
)paren
suffix:semicolon
id|i
op_assign
id|cc_ReadError
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|in_SpinUp
)paren
id|msg
c_func
(paren
id|DBG_SPI
comma
l_string|&quot;in_SpinUp: to cmd_out OK.&bslash;n&quot;
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_000
comma
l_string|&quot;cmd_out: cc_ReadError=%d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|cc_Seek
r_static
r_int
id|cc_Seek
c_func
(paren
id|u_int
id|pos
comma
r_char
id|f_blk_msf
)paren
(brace
r_int
id|i
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|f_blk_msf
OG
l_int|1
)paren
r_return
(paren
op_minus
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fam0V_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD0_SEEK
suffix:semicolon
r_if
c_cond
(paren
id|f_blk_msf
op_eq
l_int|1
)paren
id|pos
op_assign
id|msf2blk
c_func
(paren
id|pos
)paren
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
(paren
id|pos
op_rshift
l_int|16
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
(paren
id|pos
op_rshift
l_int|8
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
id|pos
op_amp
l_int|0x00FF
suffix:semicolon
r_if
c_cond
(paren
id|fam0_drive
)paren
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_lopsta
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
op_or
id|f_bit1
suffix:semicolon
r_else
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam1L_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD1_SEEK
suffix:semicolon
multiline_comment|/* same as CMD1_ and CMDL_ */
r_if
c_cond
(paren
id|f_blk_msf
op_eq
l_int|0
)paren
id|pos
op_assign
id|blk2msf
c_func
(paren
id|pos
)paren
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
(paren
id|pos
op_rshift
l_int|16
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
(paren
id|pos
op_rshift
l_int|8
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
id|pos
op_amp
l_int|0x00FF
suffix:semicolon
r_if
c_cond
(paren
id|famL_drive
)paren
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_lopsta
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
op_or
id|f_bit1
suffix:semicolon
r_else
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam2_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD2_SEEK
suffix:semicolon
r_if
c_cond
(paren
id|f_blk_msf
op_eq
l_int|0
)paren
id|pos
op_assign
id|blk2msf
c_func
(paren
id|pos
)paren
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
(paren
id|pos
op_rshift
l_int|24
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
(paren
id|pos
op_rshift
l_int|16
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
(paren
id|pos
op_rshift
l_int|8
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|drvcmd
(braket
l_int|5
)braket
op_assign
id|pos
op_amp
l_int|0x00FF
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMDT_SEEK
suffix:semicolon
r_if
c_cond
(paren
id|f_blk_msf
op_eq
l_int|1
)paren
id|pos
op_assign
id|msf2blk
c_func
(paren
id|pos
)paren
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
(paren
id|pos
op_rshift
l_int|24
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
(paren
id|pos
op_rshift
l_int|16
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
(paren
id|pos
op_rshift
l_int|8
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|drvcmd
(braket
l_int|5
)braket
op_assign
id|pos
op_amp
l_int|0x00FF
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|n_bytes
op_assign
l_int|1
suffix:semicolon
)brace
id|response_count
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|cc_SpinUp
r_static
r_int
id|cc_SpinUp
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|msg
c_func
(paren
id|DBG_SPI
comma
l_string|&quot;SpinUp.&bslash;n&quot;
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|in_SpinUp
op_assign
l_int|1
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fam0LV_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD0_SPINUP
suffix:semicolon
r_if
c_cond
(paren
id|fam0L_drive
)paren
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_lopsta
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
op_or
id|f_bit1
suffix:semicolon
r_else
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam1_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD1_SPINUP
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam2_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD2_TRAY_CTL
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* &quot;spinup&quot; */
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMDT_TRAY_CTL
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
l_int|0x03
suffix:semicolon
multiline_comment|/* &quot;insert&quot;, it hopefully spins the drive up */
)brace
id|response_count
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|in_SpinUp
op_assign
l_int|0
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|cc_SpinDown
r_static
r_int
id|cc_SpinDown
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|fam0_drive
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
id|response_count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|fam1_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD1_SPINDOWN
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam2_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD2_TRAY_CTL
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
l_int|0x02
suffix:semicolon
multiline_comment|/* &quot;eject&quot; */
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famL_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMDL_SPINDOWN
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_lopsta
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
op_or
id|f_bit1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famV_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMDV_SPINDOWN
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMDT_TRAY_CTL
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
l_int|0x02
suffix:semicolon
multiline_comment|/* &quot;eject&quot; */
)brace
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|cc_get_mode_T
r_static
r_int
id|cc_get_mode_T
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
id|response_count
op_assign
l_int|10
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMDT_GETMODE
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
id|response_count
suffix:semicolon
id|i
op_assign
id|cmd_out_T
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|cc_set_mode_T
r_static
r_int
id|cc_set_mode_T
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
id|response_count
op_assign
l_int|1
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMDT_SETMODE
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
id|D_S
(braket
id|d
)braket
dot
id|speed_byte
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
id|D_S
(braket
id|d
)braket
dot
id|frmsiz
op_rshift
l_int|8
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
id|D_S
(braket
id|d
)braket
dot
id|frmsiz
op_amp
l_int|0x0FF
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
id|D_S
(braket
id|d
)braket
dot
id|f_XA
suffix:semicolon
multiline_comment|/* 1: XA */
id|drvcmd
(braket
l_int|5
)braket
op_assign
id|D_S
(braket
id|d
)braket
dot
id|type_byte
suffix:semicolon
multiline_comment|/* 0, 1, 3 */
id|drvcmd
(braket
l_int|6
)braket
op_assign
id|D_S
(braket
id|d
)braket
dot
id|mode_xb_6
suffix:semicolon
id|drvcmd
(braket
l_int|7
)braket
op_assign
id|D_S
(braket
id|d
)braket
dot
id|mode_yb_7
op_or
id|D_S
(braket
id|d
)braket
dot
id|volume_control
suffix:semicolon
id|drvcmd
(braket
l_int|8
)braket
op_assign
id|D_S
(braket
id|d
)braket
dot
id|mode_xb_8
suffix:semicolon
id|drvcmd
(braket
l_int|9
)braket
op_assign
id|D_S
(braket
id|d
)braket
dot
id|delay
suffix:semicolon
id|i
op_assign
id|cmd_out_T
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|cc_prep_mode_T
r_static
r_int
id|cc_prep_mode_T
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
id|i
op_assign
id|cc_get_mode_T
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
id|sprintf
c_func
(paren
op_amp
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
comma
l_string|&quot; %02X&quot;
comma
id|infobuf
(braket
id|i
)braket
)paren
suffix:semicolon
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;CMDT_GETMODE:%s&bslash;n&quot;
comma
id|msgbuf
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|speed_byte
op_assign
l_int|0x02
suffix:semicolon
multiline_comment|/* 0x02: auto quad, 0x82: quad, 0x81: double, 0x80: single */
id|D_S
(braket
id|d
)braket
dot
id|frmsiz
op_assign
id|make16
c_func
(paren
id|infobuf
(braket
l_int|2
)braket
comma
id|infobuf
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|f_XA
op_assign
id|infobuf
(braket
l_int|4
)braket
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|f_XA
op_eq
l_int|0
)paren
id|D_S
(braket
id|d
)braket
dot
id|type_byte
op_assign
l_int|0
suffix:semicolon
r_else
id|D_S
(braket
id|d
)braket
dot
id|type_byte
op_assign
l_int|1
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|mode_xb_6
op_assign
id|infobuf
(braket
l_int|6
)braket
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|mode_yb_7
op_assign
l_int|1
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|mode_xb_8
op_assign
id|infobuf
(braket
l_int|8
)braket
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|delay
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 0, 1, 2, 3 */
id|j
op_assign
id|cc_set_mode_T
c_func
(paren
)paren
suffix:semicolon
id|i
op_assign
id|cc_get_mode_T
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
id|sprintf
c_func
(paren
op_amp
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
comma
l_string|&quot; %02X&quot;
comma
id|infobuf
(braket
id|i
)braket
)paren
suffix:semicolon
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;CMDT_GETMODE:%s&bslash;n&quot;
comma
id|msgbuf
)paren
suffix:semicolon
r_return
(paren
id|j
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|cc_SetSpeed
r_static
r_int
id|cc_SetSpeed
c_func
(paren
id|u_char
id|speed
comma
id|u_char
id|x1
comma
id|u_char
id|x2
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|fam0LV_drive
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
id|response_count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|fam1_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD1_SETMODE
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x03
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
id|speed
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
id|x1
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
id|x2
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam2_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD2_SETSPEED
suffix:semicolon
r_if
c_cond
(paren
id|speed
op_amp
id|speed_auto
)paren
(brace
id|drvcmd
(braket
l_int|2
)braket
op_assign
l_int|0xFF
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
l_int|0xFF
suffix:semicolon
)brace
r_else
(brace
id|drvcmd
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
l_int|150
suffix:semicolon
)brace
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|cc_SetVolume
r_static
r_int
id|cc_SetVolume
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|u_char
id|channel0
comma
id|channel1
comma
id|volume0
comma
id|volume1
suffix:semicolon
id|u_char
id|control0
comma
id|value0
comma
id|control1
comma
id|value1
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|diskstate_flags
op_and_assign
op_complement
id|volume_bit
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
id|channel0
op_assign
id|D_S
(braket
id|d
)braket
dot
id|vol_chan0
suffix:semicolon
id|volume0
op_assign
id|D_S
(braket
id|d
)braket
dot
id|vol_ctrl0
suffix:semicolon
id|channel1
op_assign
id|control1
op_assign
id|D_S
(braket
id|d
)braket
dot
id|vol_chan1
suffix:semicolon
id|volume1
op_assign
id|value1
op_assign
id|D_S
(braket
id|d
)braket
dot
id|vol_ctrl1
suffix:semicolon
id|control0
op_assign
id|value0
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|famV_drive
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|D_S
(braket
id|d
)braket
dot
id|drv_options
op_amp
id|audio_mono
)paren
op_ne
l_int|0
)paren
op_logical_and
(paren
id|D_S
(braket
id|d
)braket
dot
id|drv_type
op_ge
id|drv_211
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|volume0
op_ne
l_int|0
)paren
op_logical_and
(paren
id|volume1
op_eq
l_int|0
)paren
)paren
(brace
id|volume1
op_assign
id|volume0
suffix:semicolon
id|channel1
op_assign
id|channel0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|volume0
op_eq
l_int|0
)paren
op_logical_and
(paren
id|volume1
op_ne
l_int|0
)paren
)paren
(brace
id|volume0
op_assign
id|volume1
suffix:semicolon
id|channel0
op_assign
id|channel1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|channel0
OG
l_int|1
)paren
(brace
id|channel0
op_assign
l_int|0
suffix:semicolon
id|volume0
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|channel1
OG
l_int|1
)paren
(brace
id|channel1
op_assign
l_int|1
suffix:semicolon
id|volume1
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fam1_drive
)paren
(brace
id|control0
op_assign
id|channel0
op_plus
l_int|1
suffix:semicolon
id|control1
op_assign
id|channel1
op_plus
l_int|1
suffix:semicolon
id|value0
op_assign
(paren
id|volume0
OG
id|volume1
)paren
ques
c_cond
id|volume0
suffix:colon
id|volume1
suffix:semicolon
id|value1
op_assign
id|value0
suffix:semicolon
r_if
c_cond
(paren
id|volume0
op_eq
l_int|0
)paren
id|control0
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|volume1
op_eq
l_int|0
)paren
id|control1
op_assign
l_int|0
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD1_SETMODE
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x05
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
id|control0
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
id|value0
suffix:semicolon
id|drvcmd
(braket
l_int|5
)braket
op_assign
id|control1
suffix:semicolon
id|drvcmd
(braket
l_int|6
)braket
op_assign
id|value1
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam2_drive
)paren
(brace
id|control0
op_assign
id|channel0
op_plus
l_int|1
suffix:semicolon
id|control1
op_assign
id|channel1
op_plus
l_int|1
suffix:semicolon
id|value0
op_assign
(paren
id|volume0
OG
id|volume1
)paren
ques
c_cond
id|volume0
suffix:colon
id|volume1
suffix:semicolon
id|value1
op_assign
id|value0
suffix:semicolon
r_if
c_cond
(paren
id|volume0
op_eq
l_int|0
)paren
id|control0
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|volume1
op_eq
l_int|0
)paren
id|control1
op_assign
l_int|0
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD2_SETMODE
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x0E
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
id|control0
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
id|value0
suffix:semicolon
id|drvcmd
(braket
l_int|5
)braket
op_assign
id|control1
suffix:semicolon
id|drvcmd
(braket
l_int|6
)braket
op_assign
id|value1
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famL_drive
)paren
(brace
r_if
c_cond
(paren
(paren
id|volume0
op_eq
l_int|0
)paren
op_logical_or
(paren
id|channel0
op_ne
l_int|0
)paren
)paren
id|control0
op_or_assign
l_int|0x80
suffix:semicolon
r_if
c_cond
(paren
(paren
id|volume1
op_eq
l_int|0
)paren
op_logical_or
(paren
id|channel1
op_ne
l_int|1
)paren
)paren
id|control0
op_or_assign
l_int|0x40
suffix:semicolon
r_if
c_cond
(paren
id|volume0
op_or
id|volume1
)paren
id|value0
op_assign
l_int|0x80
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMDL_SETMODE
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x03
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
id|control0
suffix:semicolon
id|drvcmd
(braket
l_int|5
)braket
op_assign
id|value0
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_lopsta
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
op_or
id|f_bit1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam0_drive
)paren
multiline_comment|/* different firmware levels */
(brace
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|drv_type
op_ge
id|drv_300
)paren
(brace
id|control0
op_assign
id|volume0
op_amp
l_int|0xFC
suffix:semicolon
id|value0
op_assign
id|volume1
op_amp
l_int|0xFC
suffix:semicolon
r_if
c_cond
(paren
(paren
id|volume0
op_ne
l_int|0
)paren
op_logical_and
(paren
id|volume0
OL
l_int|4
)paren
)paren
id|control0
op_or_assign
l_int|0x04
suffix:semicolon
r_if
c_cond
(paren
(paren
id|volume1
op_ne
l_int|0
)paren
op_logical_and
(paren
id|volume1
OL
l_int|4
)paren
)paren
id|value0
op_or_assign
l_int|0x04
suffix:semicolon
r_if
c_cond
(paren
id|channel0
op_ne
l_int|0
)paren
id|control0
op_or_assign
l_int|0x01
suffix:semicolon
r_if
c_cond
(paren
id|channel1
op_eq
l_int|1
)paren
id|value0
op_or_assign
l_int|0x01
suffix:semicolon
)brace
r_else
(brace
id|value0
op_assign
(paren
id|volume0
OG
id|volume1
)paren
ques
c_cond
id|volume0
suffix:colon
id|volume1
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|drv_type
OL
id|drv_211
)paren
(brace
r_if
c_cond
(paren
id|channel0
op_ne
l_int|0
)paren
(brace
id|i
op_assign
id|channel1
suffix:semicolon
id|channel1
op_assign
id|channel0
suffix:semicolon
id|channel0
op_assign
id|i
suffix:semicolon
id|i
op_assign
id|volume1
suffix:semicolon
id|volume1
op_assign
id|volume0
suffix:semicolon
id|volume0
op_assign
id|i
suffix:semicolon
)brace
r_if
c_cond
(paren
id|channel0
op_eq
id|channel1
)paren
(brace
r_if
c_cond
(paren
id|channel0
op_eq
l_int|0
)paren
(brace
id|channel1
op_assign
l_int|1
suffix:semicolon
id|volume1
op_assign
l_int|0
suffix:semicolon
id|volume0
op_assign
id|value0
suffix:semicolon
)brace
r_else
(brace
id|channel0
op_assign
l_int|0
suffix:semicolon
id|volume0
op_assign
l_int|0
suffix:semicolon
id|volume1
op_assign
id|value0
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
(paren
id|volume0
op_ne
l_int|0
)paren
op_logical_and
(paren
id|volume1
op_ne
l_int|0
)paren
)paren
(brace
r_if
c_cond
(paren
id|volume0
op_eq
l_int|0xFF
)paren
id|volume1
op_assign
l_int|0xFF
suffix:semicolon
r_else
r_if
c_cond
(paren
id|volume1
op_eq
l_int|0xFF
)paren
id|volume0
op_assign
l_int|0xFF
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|drv_type
OL
id|drv_201
)paren
id|volume0
op_assign
id|volume1
op_assign
id|value0
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|drv_type
op_ge
id|drv_201
)paren
(brace
r_if
c_cond
(paren
id|volume0
op_eq
l_int|0
)paren
id|control0
op_or_assign
l_int|0x80
suffix:semicolon
r_if
c_cond
(paren
id|volume1
op_eq
l_int|0
)paren
id|control0
op_or_assign
l_int|0x40
suffix:semicolon
)brace
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|drv_type
op_ge
id|drv_211
)paren
(brace
r_if
c_cond
(paren
id|channel0
op_ne
l_int|0
)paren
id|control0
op_or_assign
l_int|0x20
suffix:semicolon
r_if
c_cond
(paren
id|channel1
op_ne
l_int|1
)paren
id|control0
op_or_assign
l_int|0x10
suffix:semicolon
)brace
)brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD0_SETMODE
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x83
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
id|control0
suffix:semicolon
id|drvcmd
(braket
l_int|5
)braket
op_assign
id|value0
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|volume_control
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|volume0
)paren
id|D_S
(braket
id|d
)braket
dot
id|volume_control
op_or_assign
l_int|0x10
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|volume1
)paren
id|D_S
(braket
id|d
)braket
dot
id|volume_control
op_or_assign
l_int|0x20
suffix:semicolon
id|i
op_assign
id|cc_prep_mode_T
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|famT_drive
)paren
(brace
id|response_count
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
id|D_S
(braket
id|d
)braket
dot
id|diskstate_flags
op_or_assign
id|volume_bit
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|GetStatus
r_static
r_int
id|GetStatus
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|famT_drive
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
id|response_count
op_assign
l_int|0
suffix:semicolon
id|cmd_type
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|cc_DriveReset
r_static
r_int
id|cc_DriveReset
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|msg
c_func
(paren
id|DBG_RES
comma
l_string|&quot;cc_DriveReset called.&bslash;n&quot;
)paren
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
id|response_count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|fam0LV_drive
)paren
id|OUT
c_func
(paren
id|CDo_reset
comma
l_int|0x00
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|fam1_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD1_RESET
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam2_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD2_RESET
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
id|OUT
c_func
(paren
id|CDo_reset
comma
l_int|0x00
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
id|OUT
c_func
(paren
id|CDo_sel_i_d
comma
l_int|0
)paren
suffix:semicolon
id|OUT
c_func
(paren
id|CDo_enable
comma
id|D_S
(braket
id|d
)braket
dot
id|drv_sel
)paren
suffix:semicolon
id|OUT
c_func
(paren
id|CDo_command
comma
id|CMDT_RESET
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
id|OUT
c_func
(paren
id|CDo_command
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fam0LV_drive
)paren
id|sbp_sleep
c_func
(paren
l_int|5
op_star
id|HZ
)paren
suffix:semicolon
multiline_comment|/* wait 5 seconds */
r_else
id|sbp_sleep
c_func
(paren
l_int|1
op_star
id|HZ
)paren
suffix:semicolon
multiline_comment|/* wait a second */
macro_line|#if 1
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;================CMDT_RESET given=================.&bslash;n&quot;
)paren
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|3
op_star
id|HZ
)paren
suffix:semicolon
)brace
macro_line|#endif 1
id|flush_status
c_func
(paren
)paren
suffix:semicolon
id|i
op_assign
id|GetStatus
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|famT_drive
)paren
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|error_byte
op_ne
id|aud_12
)paren
r_return
op_minus
l_int|501
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|SetSpeed
r_static
r_int
id|SetSpeed
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|speed
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|D_S
(braket
id|d
)braket
dot
id|drv_options
op_amp
(paren
id|speed_auto
op_or
id|speed_300
op_or
id|speed_150
)paren
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|speed
op_assign
id|speed_auto
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|D_S
(braket
id|d
)braket
dot
id|drv_options
op_amp
id|speed_auto
)paren
)paren
(brace
id|speed
op_or_assign
id|speed_300
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|D_S
(braket
id|d
)braket
dot
id|drv_options
op_amp
id|speed_300
)paren
)paren
id|speed
op_assign
l_int|0
suffix:semicolon
)brace
id|i
op_assign
id|cc_SetSpeed
c_func
(paren
id|speed
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
r_static
r_void
id|switch_drive
c_func
(paren
r_int
id|i
)paren
suffix:semicolon
DECL|function|sbpcd_select_speed
r_static
r_int
id|sbpcd_select_speed
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
comma
r_int
id|speed
)paren
(brace
r_int
id|i
op_assign
id|MINOR
c_func
(paren
id|cdi-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
id|d
)paren
id|switch_drive
c_func
(paren
id|i
)paren
suffix:semicolon
r_return
id|cc_SetSpeed
c_func
(paren
id|speed
op_eq
l_int|2
ques
c_cond
id|speed_300
suffix:colon
id|speed_150
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|DriveReset
r_static
r_int
id|DriveReset
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|i
op_assign
id|cc_DriveReset
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
op_minus
l_int|22
)paren
suffix:semicolon
r_do
(brace
id|i
op_assign
id|GetStatus
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
OL
l_int|0
)paren
op_logical_and
(paren
id|i
op_ne
op_minus
id|ERR_DISKCHANGE
)paren
)paren
(brace
r_return
(paren
op_minus
l_int|2
)paren
suffix:semicolon
multiline_comment|/* from sta2err */
)brace
r_if
c_cond
(paren
op_logical_neg
id|st_caddy_in
)paren
r_break
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|st_diskok
)paren
suffix:semicolon
macro_line|#if 000
id|D_S
(braket
id|d
)braket
dot
id|CD_changed
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|st_door_closed
)paren
op_logical_and
(paren
id|st_caddy_in
)paren
)paren
(brace
id|i
op_assign
id|DiskInfo
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
op_minus
l_int|23
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|sbpcd_reset
r_static
r_int
id|sbpcd_reset
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
)paren
(brace
r_int
id|i
op_assign
id|MINOR
c_func
(paren
id|cdi-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
id|d
)paren
id|switch_drive
c_func
(paren
id|i
)paren
suffix:semicolon
r_return
id|DriveReset
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|cc_PlayAudio
r_static
r_int
id|cc_PlayAudio
c_func
(paren
r_int
id|pos_audio_start
comma
r_int
id|pos_audio_end
)paren
(brace
r_int
id|i
comma
id|j
comma
id|n
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|audio_state
op_eq
id|audio_playing
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
id|response_count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|famLV_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMDL_PLAY
suffix:semicolon
id|i
op_assign
id|msf2blk
c_func
(paren
id|pos_audio_start
)paren
suffix:semicolon
id|n
op_assign
id|msf2blk
c_func
(paren
id|pos_audio_end
)paren
op_plus
l_int|1
op_minus
id|i
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
(paren
id|i
op_rshift
l_int|16
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
(paren
id|i
op_rshift
l_int|8
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
id|i
op_amp
l_int|0x00FF
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
(paren
id|n
op_rshift
l_int|16
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|drvcmd
(braket
l_int|5
)braket
op_assign
(paren
id|n
op_rshift
l_int|8
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|drvcmd
(braket
l_int|6
)braket
op_assign
id|n
op_amp
l_int|0x00FF
suffix:semicolon
r_if
c_cond
(paren
id|famL_drive
)paren
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_lopsta
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
op_or
id|f_wait_if_busy
suffix:semicolon
r_else
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
)brace
r_else
(brace
id|j
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|fam1_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD1_PLAY_MSF
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
op_or
id|f_wait_if_busy
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam2_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD2_PLAY_MSF
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMDT_PLAY_MSF
suffix:semicolon
id|j
op_assign
l_int|3
suffix:semicolon
id|response_count
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam0_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD0_PLAY_MSF
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_lopsta
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
op_or
id|f_wait_if_busy
suffix:semicolon
)brace
id|drvcmd
(braket
id|j
)braket
op_assign
(paren
id|pos_audio_start
op_rshift
l_int|16
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|drvcmd
(braket
id|j
op_plus
l_int|1
)braket
op_assign
(paren
id|pos_audio_start
op_rshift
l_int|8
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|drvcmd
(braket
id|j
op_plus
l_int|2
)braket
op_assign
id|pos_audio_start
op_amp
l_int|0x00FF
suffix:semicolon
id|drvcmd
(braket
id|j
op_plus
l_int|3
)braket
op_assign
(paren
id|pos_audio_end
op_rshift
l_int|16
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|drvcmd
(braket
id|j
op_plus
l_int|4
)braket
op_assign
(paren
id|pos_audio_end
op_rshift
l_int|8
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|drvcmd
(braket
id|j
op_plus
l_int|5
)braket
op_assign
id|pos_audio_end
op_amp
l_int|0x00FF
suffix:semicolon
)brace
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|cc_Pause_Resume
r_static
r_int
id|cc_Pause_Resume
c_func
(paren
r_int
id|pau_res
)paren
(brace
r_int
id|i
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
id|response_count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|fam1_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD1_PAU_RES
suffix:semicolon
r_if
c_cond
(paren
id|pau_res
op_ne
l_int|1
)paren
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x80
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam2_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD2_PAU_RES
suffix:semicolon
r_if
c_cond
(paren
id|pau_res
op_ne
l_int|1
)paren
id|drvcmd
(braket
l_int|2
)braket
op_assign
l_int|0x01
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam0LV_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD0_PAU_RES
suffix:semicolon
r_if
c_cond
(paren
id|pau_res
op_ne
l_int|1
)paren
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x80
suffix:semicolon
r_if
c_cond
(paren
id|famL_drive
)paren
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_lopsta
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
op_or
id|f_bit1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|famV_drive
)paren
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
r_else
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_lopsta
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
r_if
c_cond
(paren
id|pau_res
op_eq
l_int|3
)paren
r_return
(paren
id|cc_PlayAudio
c_func
(paren
id|D_S
(braket
id|d
)braket
dot
id|pos_audio_start
comma
id|D_S
(braket
id|d
)braket
dot
id|pos_audio_end
)paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pau_res
op_eq
l_int|1
)paren
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMDT_PAUSE
suffix:semicolon
r_else
r_return
(paren
op_minus
l_int|56
)paren
suffix:semicolon
)brace
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|cc_LockDoor
r_static
r_int
id|cc_LockDoor
c_func
(paren
r_char
id|lock
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|fam0_drive
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_LCK
comma
l_string|&quot;cc_LockDoor: %d (drive %d)&bslash;n&quot;
comma
id|lock
comma
id|d
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_LCS
comma
l_string|&quot;p_door_locked bit %d before&bslash;n&quot;
comma
id|st_door_locked
)paren
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
id|response_count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|fam1_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD1_LOCK_CTL
suffix:semicolon
r_if
c_cond
(paren
id|lock
op_eq
l_int|1
)paren
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x01
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam2_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD2_LOCK_CTL
suffix:semicolon
r_if
c_cond
(paren
id|lock
op_eq
l_int|1
)paren
id|drvcmd
(braket
l_int|4
)braket
op_assign
l_int|0x01
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famLV_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMDL_LOCK_CTL
suffix:semicolon
r_if
c_cond
(paren
id|lock
op_eq
l_int|1
)paren
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x01
suffix:semicolon
r_if
c_cond
(paren
id|famL_drive
)paren
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_lopsta
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
op_or
id|f_bit1
suffix:semicolon
r_else
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMDT_LOCK_CTL
suffix:semicolon
r_if
c_cond
(paren
id|lock
op_eq
l_int|1
)paren
id|drvcmd
(braket
l_int|4
)braket
op_assign
l_int|0x01
suffix:semicolon
)brace
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_LCS
comma
l_string|&quot;p_door_locked bit %d after&bslash;n&quot;
comma
id|st_door_locked
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*==========================================================================*/
DECL|function|UnLockDoor
r_static
r_int
id|UnLockDoor
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
id|j
op_assign
l_int|20
suffix:semicolon
r_do
(brace
id|i
op_assign
id|cc_LockDoor
c_func
(paren
l_int|0
)paren
suffix:semicolon
op_decrement
id|j
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|i
OL
l_int|0
)paren
op_logical_and
(paren
id|j
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|cc_DriveReset
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
l_int|84
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|LockDoor
r_static
r_int
id|LockDoor
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
id|j
op_assign
l_int|20
suffix:semicolon
r_do
(brace
id|i
op_assign
id|cc_LockDoor
c_func
(paren
l_int|1
)paren
suffix:semicolon
op_decrement
id|j
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|i
OL
l_int|0
)paren
op_logical_and
(paren
id|j
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|j
op_eq
l_int|0
)paren
(brace
id|cc_DriveReset
c_func
(paren
)paren
suffix:semicolon
id|j
op_assign
l_int|20
suffix:semicolon
r_do
(brace
id|i
op_assign
id|cc_LockDoor
c_func
(paren
l_int|1
)paren
suffix:semicolon
op_decrement
id|j
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|i
OL
l_int|0
)paren
op_logical_and
(paren
id|j
)paren
)paren
suffix:semicolon
)brace
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
DECL|function|sbpcd_lock_door
r_static
r_int
id|sbpcd_lock_door
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
comma
r_int
id|lock
)paren
(brace
r_return
id|lock
ques
c_cond
id|LockDoor
c_func
(paren
)paren
suffix:colon
id|UnLockDoor
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|cc_CloseTray
r_static
r_int
id|cc_CloseTray
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|fam0_drive
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_LCK
comma
l_string|&quot;cc_CloseTray (drive %d)&bslash;n&quot;
comma
id|d
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_LCS
comma
l_string|&quot;p_door_closed bit %d before&bslash;n&quot;
comma
id|st_door_closed
)paren
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
id|response_count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|fam1_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD1_TRAY_CTL
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam2_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD2_TRAY_CTL
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x01
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
l_int|0x03
suffix:semicolon
multiline_comment|/* &quot;insert&quot; */
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famLV_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMDL_TRAY_CTL
suffix:semicolon
r_if
c_cond
(paren
id|famLV_drive
)paren
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_lopsta
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
op_or
id|f_bit1
suffix:semicolon
r_else
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMDT_TRAY_CTL
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
l_int|0x03
suffix:semicolon
multiline_comment|/* &quot;insert&quot; */
)brace
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_LCS
comma
l_string|&quot;p_door_closed bit %d after&bslash;n&quot;
comma
id|st_door_closed
)paren
suffix:semicolon
id|i
op_assign
id|cc_ReadError
c_func
(paren
)paren
suffix:semicolon
id|flags_cmd_out
op_or_assign
id|f_respo2
suffix:semicolon
id|cc_ReadStatus
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* command: give 1-byte status */
id|i
op_assign
id|ResponseStatus
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|famT_drive
op_logical_and
(paren
id|i
OL
l_int|0
)paren
)paren
(brace
id|cc_DriveReset
c_func
(paren
)paren
suffix:semicolon
id|i
op_assign
id|ResponseStatus
c_func
(paren
)paren
suffix:semicolon
macro_line|#if 0
id|sbp_sleep
c_func
(paren
id|HZ
)paren
suffix:semicolon
macro_line|#endif 0
id|i
op_assign
id|ResponseStatus
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;sbpcd cc_CloseTray: ResponseStatus timed out (%d).&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|famT_drive
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|st_spinning
)paren
(brace
id|cc_SpinUp
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st_check
)paren
id|i
op_assign
id|cc_ReadError
c_func
(paren
)paren
suffix:semicolon
id|flags_cmd_out
op_or_assign
id|f_respo2
suffix:semicolon
id|cc_ReadStatus
c_func
(paren
)paren
suffix:semicolon
id|i
op_assign
id|ResponseStatus
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
)brace
)brace
id|i
op_assign
id|DiskInfo
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
DECL|function|sbpcd_tray_move
r_static
r_int
id|sbpcd_tray_move
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
comma
r_int
id|position
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|MINOR
c_func
(paren
id|cdi-&gt;dev
)paren
suffix:semicolon
id|switch_drive
c_func
(paren
id|i
)paren
suffix:semicolon
multiline_comment|/* DUH! --AJK */
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|CD_changed
op_ne
l_int|0xFF
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|CD_changed
op_assign
l_int|0xFF
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|diskstate_flags
op_and_assign
op_complement
id|cd_size_bit
suffix:semicolon
)brace
r_if
c_cond
(paren
id|position
op_eq
l_int|1
)paren
(brace
id|cc_SpinDown
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|retval
op_assign
id|cc_CloseTray
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|cc_ReadSubQ
r_static
r_int
id|cc_ReadSubQ
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|diskstate_flags
op_and_assign
op_complement
id|subq_bit
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|255
suffix:semicolon
id|j
OG
l_int|0
suffix:semicolon
id|j
op_decrement
)paren
(brace
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fam1_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD1_READSUBQ
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
id|response_count
op_assign
l_int|11
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam2_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD2_READSUBQ
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x02
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
l_int|0x01
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
id|response_count
op_assign
l_int|10
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam0LV_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD0_READSUBQ
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x02
suffix:semicolon
r_if
c_cond
(paren
id|famLV_drive
)paren
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
r_else
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
id|response_count
op_assign
l_int|13
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
id|response_count
op_assign
l_int|12
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMDT_READSUBQ
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x02
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
l_int|0x40
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
l_int|0x01
suffix:semicolon
id|drvcmd
(braket
l_int|8
)braket
op_assign
id|response_count
suffix:semicolon
)brace
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|response_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sprintf
c_func
(paren
op_amp
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
comma
l_string|&quot; %02X&quot;
comma
id|infobuf
(braket
id|i
)braket
)paren
suffix:semicolon
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
c_func
(paren
id|DBG_SQ1
comma
l_string|&quot;cc_ReadSubQ:%s&bslash;n&quot;
comma
id|msgbuf
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|famT_drive
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|infobuf
(braket
l_int|0
)braket
op_ne
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|st_spinning
)paren
op_logical_or
(paren
id|j
op_eq
l_int|1
)paren
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|SubQ_ctl_adr
op_assign
id|D_S
(braket
id|d
)braket
dot
id|SubQ_trk
op_assign
id|D_S
(braket
id|d
)braket
dot
id|SubQ_pnt_idx
op_assign
id|D_S
(braket
id|d
)braket
dot
id|SubQ_whatisthis
op_assign
l_int|0
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|SubQ_run_tot
op_assign
id|D_S
(braket
id|d
)braket
dot
id|SubQ_run_trk
op_assign
l_int|0
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|famT_drive
)paren
id|D_S
(braket
id|d
)braket
dot
id|SubQ_ctl_adr
op_assign
id|infobuf
(braket
l_int|1
)braket
suffix:semicolon
r_else
id|D_S
(braket
id|d
)braket
dot
id|SubQ_ctl_adr
op_assign
id|swap_nibbles
c_func
(paren
id|infobuf
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|SubQ_trk
op_assign
id|byt2bcd
c_func
(paren
id|infobuf
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|SubQ_pnt_idx
op_assign
id|byt2bcd
c_func
(paren
id|infobuf
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fam0LV_drive
)paren
id|i
op_assign
l_int|5
suffix:semicolon
r_else
r_if
c_cond
(paren
id|fam12_drive
)paren
id|i
op_assign
l_int|4
suffix:semicolon
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
id|i
op_assign
l_int|8
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|SubQ_run_tot
op_assign
id|make32
c_func
(paren
id|make16
c_func
(paren
l_int|0
comma
id|infobuf
(braket
id|i
)braket
)paren
comma
id|make16
c_func
(paren
id|infobuf
(braket
id|i
op_plus
l_int|1
)braket
comma
id|infobuf
(braket
id|i
op_plus
l_int|2
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/* msf-bin */
id|i
op_assign
l_int|7
suffix:semicolon
r_if
c_cond
(paren
id|fam0LV_drive
)paren
id|i
op_assign
l_int|9
suffix:semicolon
r_else
r_if
c_cond
(paren
id|fam12_drive
)paren
id|i
op_assign
l_int|7
suffix:semicolon
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
id|i
op_assign
l_int|4
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|SubQ_run_trk
op_assign
id|make32
c_func
(paren
id|make16
c_func
(paren
l_int|0
comma
id|infobuf
(braket
id|i
)braket
)paren
comma
id|make16
c_func
(paren
id|infobuf
(braket
id|i
op_plus
l_int|1
)braket
comma
id|infobuf
(braket
id|i
op_plus
l_int|2
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/* msf-bin */
id|D_S
(braket
id|d
)braket
dot
id|SubQ_whatisthis
op_assign
id|infobuf
(braket
id|i
op_plus
l_int|3
)braket
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|diskstate_flags
op_or_assign
id|subq_bit
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|cc_ModeSense
r_static
r_int
id|cc_ModeSense
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|fam2_drive
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|famV_drive
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|diskstate_flags
op_and_assign
op_complement
id|frame_size_bit
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fam1_drive
)paren
(brace
id|response_count
op_assign
l_int|5
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD1_GETMODE
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam0L_drive
)paren
(brace
id|response_count
op_assign
l_int|2
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD0_GETMODE
suffix:semicolon
r_if
c_cond
(paren
id|famL_drive
)paren
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
r_else
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
id|response_count
op_assign
l_int|10
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMDT_GETMODE
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
id|response_count
suffix:semicolon
)brace
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|sense_byte
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|fam1_drive
)paren
id|D_S
(braket
id|d
)braket
dot
id|sense_byte
op_assign
id|infobuf
(braket
id|i
op_increment
)braket
suffix:semicolon
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
r_if
c_cond
(paren
id|infobuf
(braket
l_int|4
)braket
op_eq
l_int|0x01
)paren
id|D_S
(braket
id|d
)braket
dot
id|xa_byte
op_assign
l_int|0x20
suffix:semicolon
r_else
id|D_S
(braket
id|d
)braket
dot
id|xa_byte
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
l_int|2
suffix:semicolon
)brace
id|D_S
(braket
id|d
)braket
dot
id|frame_size
op_assign
id|make16
c_func
(paren
id|infobuf
(braket
id|i
)braket
comma
id|infobuf
(braket
id|i
op_plus
l_int|1
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|response_count
suffix:semicolon
id|i
op_increment
)paren
id|sprintf
c_func
(paren
op_amp
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
comma
l_string|&quot; %02X&quot;
comma
id|infobuf
(braket
id|i
)braket
)paren
suffix:semicolon
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
c_func
(paren
id|DBG_XA1
comma
l_string|&quot;cc_ModeSense:%s&bslash;n&quot;
comma
id|msgbuf
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|diskstate_flags
op_or_assign
id|frame_size_bit
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*==========================================================================*/
DECL|function|cc_ModeSelect
r_static
r_int
id|cc_ModeSelect
c_func
(paren
r_int
id|framesize
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|fam2_drive
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|famV_drive
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|diskstate_flags
op_and_assign
op_complement
id|frame_size_bit
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|frame_size
op_assign
id|framesize
suffix:semicolon
r_if
c_cond
(paren
id|framesize
op_eq
id|CD_FRAMESIZE_RAW
)paren
id|D_S
(braket
id|d
)braket
dot
id|sense_byte
op_assign
l_int|0x82
suffix:semicolon
r_else
id|D_S
(braket
id|d
)braket
dot
id|sense_byte
op_assign
l_int|0x00
suffix:semicolon
id|msg
c_func
(paren
id|DBG_XA1
comma
l_string|&quot;cc_ModeSelect: %02X %04X&bslash;n&quot;
comma
id|D_S
(braket
id|d
)braket
dot
id|sense_byte
comma
id|D_S
(braket
id|d
)braket
dot
id|frame_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fam1_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD1_SETMODE
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
id|D_S
(braket
id|d
)braket
dot
id|sense_byte
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
(paren
id|D_S
(braket
id|d
)braket
dot
id|frame_size
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
id|D_S
(braket
id|d
)braket
dot
id|frame_size
op_amp
l_int|0xFF
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam0L_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD0_SETMODE
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
(paren
id|D_S
(braket
id|d
)braket
dot
id|frame_size
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
id|D_S
(braket
id|d
)braket
dot
id|frame_size
op_amp
l_int|0xFF
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
l_int|0x00
suffix:semicolon
r_if
c_cond
(paren
id|famL_drive
)paren
(brace
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_lopsta
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|response_count
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|diskstate_flags
op_or_assign
id|frame_size_bit
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|cc_GetVolume
r_static
r_int
id|cc_GetVolume
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|u_char
id|switches
suffix:semicolon
id|u_char
id|chan0
op_assign
l_int|0
suffix:semicolon
id|u_char
id|vol0
op_assign
l_int|0
suffix:semicolon
id|u_char
id|chan1
op_assign
l_int|1
suffix:semicolon
id|u_char
id|vol1
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|famV_drive
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|diskstate_flags
op_and_assign
op_complement
id|volume_bit
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fam1_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD1_GETMODE
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x05
suffix:semicolon
id|response_count
op_assign
l_int|5
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam2_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD2_GETMODE
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x0E
suffix:semicolon
id|response_count
op_assign
l_int|5
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam0L_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD0_GETMODE
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x03
suffix:semicolon
id|response_count
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|famL_drive
)paren
(brace
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
)brace
r_else
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
id|i
op_assign
id|cc_get_mode_T
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|famT_drive
)paren
(brace
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fam1_drive
)paren
(brace
id|chan0
op_assign
id|infobuf
(braket
l_int|1
)braket
op_amp
l_int|0x0F
suffix:semicolon
id|vol0
op_assign
id|infobuf
(braket
l_int|2
)braket
suffix:semicolon
id|chan1
op_assign
id|infobuf
(braket
l_int|3
)braket
op_amp
l_int|0x0F
suffix:semicolon
id|vol1
op_assign
id|infobuf
(braket
l_int|4
)braket
suffix:semicolon
r_if
c_cond
(paren
id|chan0
op_eq
l_int|0
)paren
(brace
id|chan0
op_assign
l_int|1
suffix:semicolon
id|vol0
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chan1
op_eq
l_int|0
)paren
(brace
id|chan1
op_assign
l_int|2
suffix:semicolon
id|vol1
op_assign
l_int|0
suffix:semicolon
)brace
id|chan0
op_rshift_assign
l_int|1
suffix:semicolon
id|chan1
op_rshift_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam2_drive
)paren
(brace
id|chan0
op_assign
id|infobuf
(braket
l_int|1
)braket
suffix:semicolon
id|vol0
op_assign
id|infobuf
(braket
l_int|2
)braket
suffix:semicolon
id|chan1
op_assign
id|infobuf
(braket
l_int|3
)braket
suffix:semicolon
id|vol1
op_assign
id|infobuf
(braket
l_int|4
)braket
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famL_drive
)paren
(brace
id|chan0
op_assign
l_int|0
suffix:semicolon
id|chan1
op_assign
l_int|1
suffix:semicolon
id|vol0
op_assign
id|vol1
op_assign
id|infobuf
(braket
l_int|1
)braket
suffix:semicolon
id|switches
op_assign
id|infobuf
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|switches
op_amp
l_int|0x80
)paren
op_ne
l_int|0
)paren
id|chan0
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|switches
op_amp
l_int|0x40
)paren
op_ne
l_int|0
)paren
id|chan1
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam0_drive
)paren
multiline_comment|/* different firmware levels */
(brace
id|chan0
op_assign
l_int|0
suffix:semicolon
id|chan1
op_assign
l_int|1
suffix:semicolon
id|vol0
op_assign
id|vol1
op_assign
id|infobuf
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|drv_type
op_ge
id|drv_201
)paren
(brace
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|drv_type
OL
id|drv_300
)paren
(brace
id|switches
op_assign
id|infobuf
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|switches
op_amp
l_int|0x80
)paren
op_ne
l_int|0
)paren
id|vol0
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|switches
op_amp
l_int|0x40
)paren
op_ne
l_int|0
)paren
id|vol1
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|drv_type
op_ge
id|drv_211
)paren
(brace
r_if
c_cond
(paren
(paren
id|switches
op_amp
l_int|0x20
)paren
op_ne
l_int|0
)paren
id|chan0
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|switches
op_amp
l_int|0x10
)paren
op_ne
l_int|0
)paren
id|chan1
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
id|vol0
op_assign
id|infobuf
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|vol0
op_amp
l_int|0x01
)paren
op_ne
l_int|0
)paren
id|chan0
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|vol1
op_amp
l_int|0x01
)paren
op_eq
l_int|0
)paren
id|chan1
op_assign
l_int|0
suffix:semicolon
id|vol0
op_and_assign
l_int|0xFC
suffix:semicolon
id|vol1
op_and_assign
l_int|0xFC
suffix:semicolon
r_if
c_cond
(paren
id|vol0
op_ne
l_int|0
)paren
id|vol0
op_add_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|vol1
op_ne
l_int|0
)paren
id|vol1
op_add_assign
l_int|3
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|volume_control
op_assign
id|infobuf
(braket
l_int|7
)braket
suffix:semicolon
id|chan0
op_assign
l_int|0
suffix:semicolon
id|chan1
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|volume_control
op_amp
l_int|0x10
)paren
id|vol0
op_assign
l_int|0
suffix:semicolon
r_else
id|vol0
op_assign
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|volume_control
op_amp
l_int|0x20
)paren
id|vol1
op_assign
l_int|0
suffix:semicolon
r_else
id|vol1
op_assign
l_int|0xff
suffix:semicolon
)brace
id|D_S
(braket
id|d
)braket
dot
id|vol_chan0
op_assign
id|chan0
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|vol_ctrl0
op_assign
id|vol0
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|vol_chan1
op_assign
id|chan1
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|vol_ctrl1
op_assign
id|vol1
suffix:semicolon
macro_line|#if 000
id|D_S
(braket
id|d
)braket
dot
id|vol_chan2
op_assign
l_int|2
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|vol_ctrl2
op_assign
l_int|0xFF
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|vol_chan3
op_assign
l_int|3
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|vol_ctrl3
op_assign
l_int|0xFF
suffix:semicolon
macro_line|#endif 000
id|D_S
(braket
id|d
)braket
dot
id|diskstate_flags
op_or_assign
id|volume_bit
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|cc_ReadCapacity
r_static
r_int
id|cc_ReadCapacity
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_if
c_cond
(paren
id|fam2_drive
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* some firmware lacks this command */
r_if
c_cond
(paren
id|famLV_drive
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* some firmware lacks this command */
r_if
c_cond
(paren
id|famT_drive
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* done with cc_ReadTocDescr() */
id|D_S
(braket
id|d
)braket
dot
id|diskstate_flags
op_and_assign
op_complement
id|cd_size_bit
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|3
suffix:semicolon
id|j
OG
l_int|0
suffix:semicolon
id|j
op_decrement
)paren
(brace
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fam1_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD1_CAPACITY
suffix:semicolon
id|response_count
op_assign
l_int|5
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
macro_line|#if 00
r_else
r_if
c_cond
(paren
id|fam2_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD2_CAPACITY
suffix:semicolon
id|response_count
op_assign
l_int|8
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
)brace
macro_line|#endif
r_else
r_if
c_cond
(paren
id|fam0_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD0_CAPACITY
suffix:semicolon
id|response_count
op_assign
l_int|5
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
l_int|0
)paren
r_break
suffix:semicolon
id|msg
c_func
(paren
id|DBG_000
comma
l_string|&quot;cc_ReadCapacity: cmd_out: err %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|cc_ReadError
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|j
op_eq
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fam1_drive
)paren
id|D_S
(braket
id|d
)braket
dot
id|CDsize_frm
op_assign
id|msf2blk
c_func
(paren
id|make32
c_func
(paren
id|make16
c_func
(paren
l_int|0
comma
id|infobuf
(braket
l_int|0
)braket
)paren
comma
id|make16
c_func
(paren
id|infobuf
(braket
l_int|1
)braket
comma
id|infobuf
(braket
l_int|2
)braket
)paren
)paren
)paren
op_plus
id|CD_MSF_OFFSET
suffix:semicolon
r_else
r_if
c_cond
(paren
id|fam0_drive
)paren
id|D_S
(braket
id|d
)braket
dot
id|CDsize_frm
op_assign
id|make32
c_func
(paren
id|make16
c_func
(paren
l_int|0
comma
id|infobuf
(braket
l_int|0
)braket
)paren
comma
id|make16
c_func
(paren
id|infobuf
(braket
l_int|1
)braket
comma
id|infobuf
(braket
l_int|2
)braket
)paren
)paren
suffix:semicolon
macro_line|#if 00
r_else
r_if
c_cond
(paren
id|fam2_drive
)paren
id|D_S
(braket
id|d
)braket
dot
id|CDsize_frm
op_assign
id|make32
c_func
(paren
id|make16
c_func
(paren
id|infobuf
(braket
l_int|0
)braket
comma
id|infobuf
(braket
l_int|1
)braket
)paren
comma
id|make16
c_func
(paren
id|infobuf
(braket
l_int|2
)braket
comma
id|infobuf
(braket
l_int|3
)braket
)paren
)paren
suffix:semicolon
macro_line|#endif
id|D_S
(braket
id|d
)braket
dot
id|diskstate_flags
op_or_assign
id|cd_size_bit
suffix:semicolon
id|msg
c_func
(paren
id|DBG_000
comma
l_string|&quot;cc_ReadCapacity: %d frames.&bslash;n&quot;
comma
id|D_S
(braket
id|d
)braket
dot
id|CDsize_frm
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|cc_ReadTocDescr
r_static
r_int
id|cc_ReadTocDescr
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|diskstate_flags
op_and_assign
op_complement
id|toc_bit
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fam1_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD1_DISKINFO
suffix:semicolon
id|response_count
op_assign
l_int|6
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam0LV_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD0_DISKINFO
suffix:semicolon
id|response_count
op_assign
l_int|6
suffix:semicolon
r_if
c_cond
(paren
id|famLV_drive
)paren
(brace
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
)brace
r_else
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam2_drive
)paren
(brace
multiline_comment|/* possibly longer timeout periods necessary */
id|D_S
(braket
id|d
)braket
dot
id|f_multisession
op_assign
l_int|0
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD2_DISKINFO
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x02
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
l_int|0xAB
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
l_int|0xFF
suffix:semicolon
multiline_comment|/* session */
id|response_count
op_assign
l_int|8
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|f_multisession
op_assign
l_int|0
suffix:semicolon
id|response_count
op_assign
l_int|12
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMDT_DISKINFO
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x02
suffix:semicolon
id|drvcmd
(braket
l_int|6
)braket
op_assign
id|CDROM_LEADOUT
suffix:semicolon
id|drvcmd
(braket
l_int|8
)braket
op_assign
id|response_count
suffix:semicolon
id|drvcmd
(braket
l_int|9
)braket
op_assign
l_int|0x00
suffix:semicolon
)brace
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|famT_drive
)paren
op_logical_and
(paren
id|i
OL
id|response_count
)paren
)paren
r_return
(paren
op_minus
l_int|100
op_minus
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|fam1_drive
)paren
op_logical_or
(paren
id|fam2_drive
)paren
op_logical_or
(paren
id|fam0LV_drive
)paren
)paren
id|D_S
(braket
id|d
)braket
dot
id|xa_byte
op_assign
id|infobuf
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|fam2_drive
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|first_session
op_assign
id|infobuf
(braket
l_int|1
)braket
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|last_session
op_assign
id|infobuf
(braket
l_int|2
)braket
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|n_first_track
op_assign
id|infobuf
(braket
l_int|3
)braket
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|n_last_track
op_assign
id|infobuf
(braket
l_int|4
)braket
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|first_session
op_ne
id|D_S
(braket
id|d
)braket
dot
id|last_session
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|f_multisession
op_assign
l_int|1
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|lba_multi
op_assign
id|msf2blk
c_func
(paren
id|make32
c_func
(paren
id|make16
c_func
(paren
l_int|0
comma
id|infobuf
(braket
l_int|5
)braket
)paren
comma
id|make16
c_func
(paren
id|infobuf
(braket
l_int|6
)braket
comma
id|infobuf
(braket
l_int|7
)braket
)paren
)paren
)paren
suffix:semicolon
)brace
macro_line|#if 0
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|first_session
op_ne
id|D_S
(braket
id|d
)braket
dot
id|last_session
)paren
(brace
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|last_session
op_le
l_int|20
)paren
id|zwanzig
op_assign
id|D_S
(braket
id|d
)braket
dot
id|last_session
op_plus
l_int|1
suffix:semicolon
r_else
id|zwanzig
op_assign
l_int|20
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
id|D_S
(braket
id|d
)braket
dot
id|first_session
suffix:semicolon
id|count
OL
id|zwanzig
suffix:semicolon
id|count
op_increment
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD2_DISKINFO
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x02
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
l_int|0xAB
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
id|count
suffix:semicolon
id|response_count
op_assign
l_int|8
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|msf_multi_n
(braket
id|count
)braket
op_assign
id|make32
c_func
(paren
id|make16
c_func
(paren
l_int|0
comma
id|infobuf
(braket
l_int|5
)braket
)paren
comma
id|make16
c_func
(paren
id|infobuf
(braket
l_int|6
)braket
comma
id|infobuf
(braket
l_int|7
)braket
)paren
)paren
suffix:semicolon
)brace
id|D_S
(braket
id|d
)braket
dot
id|diskstate_flags
op_or_assign
id|multisession_bit
suffix:semicolon
)brace
macro_line|#endif
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD2_DISKINFO
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x02
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
l_int|0xAA
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
l_int|0xFF
suffix:semicolon
id|response_count
op_assign
l_int|5
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|size_msf
op_assign
id|make32
c_func
(paren
id|make16
c_func
(paren
l_int|0
comma
id|infobuf
(braket
l_int|2
)braket
)paren
comma
id|make16
c_func
(paren
id|infobuf
(braket
l_int|3
)braket
comma
id|infobuf
(braket
l_int|4
)braket
)paren
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|size_blk
op_assign
id|msf2blk
c_func
(paren
id|D_S
(braket
id|d
)braket
dot
id|size_msf
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|CDsize_frm
op_assign
id|D_S
(braket
id|d
)braket
dot
id|size_blk
op_plus
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|size_msf
op_assign
id|make32
c_func
(paren
id|make16
c_func
(paren
id|infobuf
(braket
l_int|8
)braket
comma
id|infobuf
(braket
l_int|9
)braket
)paren
comma
id|make16
c_func
(paren
id|infobuf
(braket
l_int|10
)braket
comma
id|infobuf
(braket
l_int|11
)braket
)paren
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|size_blk
op_assign
id|msf2blk
c_func
(paren
id|D_S
(braket
id|d
)braket
dot
id|size_msf
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|CDsize_frm
op_assign
id|D_S
(braket
id|d
)braket
dot
id|size_blk
op_plus
l_int|1
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|n_first_track
op_assign
id|infobuf
(braket
l_int|2
)braket
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|n_last_track
op_assign
id|infobuf
(braket
l_int|3
)braket
suffix:semicolon
)brace
r_else
(brace
id|D_S
(braket
id|d
)braket
dot
id|n_first_track
op_assign
id|infobuf
(braket
l_int|1
)braket
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|n_last_track
op_assign
id|infobuf
(braket
l_int|2
)braket
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|size_msf
op_assign
id|make32
c_func
(paren
id|make16
c_func
(paren
l_int|0
comma
id|infobuf
(braket
l_int|3
)braket
)paren
comma
id|make16
c_func
(paren
id|infobuf
(braket
l_int|4
)braket
comma
id|infobuf
(braket
l_int|5
)braket
)paren
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|size_blk
op_assign
id|msf2blk
c_func
(paren
id|D_S
(braket
id|d
)braket
dot
id|size_msf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|famLV_drive
)paren
id|D_S
(braket
id|d
)braket
dot
id|CDsize_frm
op_assign
id|D_S
(braket
id|d
)braket
dot
id|size_blk
op_plus
l_int|1
suffix:semicolon
)brace
id|D_S
(braket
id|d
)braket
dot
id|diskstate_flags
op_or_assign
id|toc_bit
suffix:semicolon
id|msg
c_func
(paren
id|DBG_TOC
comma
l_string|&quot;TocDesc: xa %02X firstt %02X lastt %02X size %08X firstses %02X lastsess %02X&bslash;n&quot;
comma
id|D_S
(braket
id|d
)braket
dot
id|xa_byte
comma
id|D_S
(braket
id|d
)braket
dot
id|n_first_track
comma
id|D_S
(braket
id|d
)braket
dot
id|n_last_track
comma
id|D_S
(braket
id|d
)braket
dot
id|size_msf
comma
id|D_S
(braket
id|d
)braket
dot
id|first_session
comma
id|D_S
(braket
id|d
)braket
dot
id|last_session
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|cc_ReadTocEntry
r_static
r_int
id|cc_ReadTocEntry
c_func
(paren
r_int
id|num
)paren
(brace
r_int
id|i
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fam1_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD1_READTOC
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
id|num
suffix:semicolon
id|response_count
op_assign
l_int|8
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam2_drive
)paren
(brace
multiline_comment|/* possibly longer timeout periods necessary */
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD2_DISKINFO
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x02
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
id|num
suffix:semicolon
id|response_count
op_assign
l_int|5
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam0LV_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD0_READTOC
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x02
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
id|num
suffix:semicolon
id|response_count
op_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|famLV_drive
)paren
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
r_else
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
id|response_count
op_assign
l_int|12
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMDT_DISKINFO
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x02
suffix:semicolon
id|drvcmd
(braket
l_int|6
)braket
op_assign
id|num
suffix:semicolon
id|drvcmd
(braket
l_int|8
)braket
op_assign
id|response_count
suffix:semicolon
id|drvcmd
(braket
l_int|9
)braket
op_assign
l_int|0x00
suffix:semicolon
)brace
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|famT_drive
)paren
op_logical_and
(paren
id|i
OL
id|response_count
)paren
)paren
r_return
(paren
op_minus
l_int|100
op_minus
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|fam1_drive
)paren
op_logical_or
(paren
id|fam0LV_drive
)paren
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|TocEnt_nixbyte
op_assign
id|infobuf
(braket
l_int|0
)braket
suffix:semicolon
id|i
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam2_drive
)paren
id|i
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
id|i
op_assign
l_int|5
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|TocEnt_ctl_adr
op_assign
id|swap_nibbles
c_func
(paren
id|infobuf
(braket
id|i
op_increment
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|fam1_drive
)paren
op_logical_or
(paren
id|fam0L_drive
)paren
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|TocEnt_number
op_assign
id|infobuf
(braket
id|i
op_increment
)braket
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|TocEnt_format
op_assign
id|infobuf
(braket
id|i
)braket
suffix:semicolon
)brace
r_else
(brace
id|D_S
(braket
id|d
)braket
dot
id|TocEnt_number
op_assign
id|num
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|TocEnt_format
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fam1_drive
)paren
id|i
op_assign
l_int|4
suffix:semicolon
r_else
r_if
c_cond
(paren
id|fam0LV_drive
)paren
id|i
op_assign
l_int|5
suffix:semicolon
r_else
r_if
c_cond
(paren
id|fam2_drive
)paren
id|i
op_assign
l_int|2
suffix:semicolon
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
id|i
op_assign
l_int|9
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|TocEnt_address
op_assign
id|make32
c_func
(paren
id|make16
c_func
(paren
l_int|0
comma
id|infobuf
(braket
id|i
)braket
)paren
comma
id|make16
c_func
(paren
id|infobuf
(braket
id|i
op_plus
l_int|1
)braket
comma
id|infobuf
(braket
id|i
op_plus
l_int|2
)braket
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|response_count
suffix:semicolon
id|i
op_increment
)paren
id|sprintf
c_func
(paren
op_amp
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
comma
l_string|&quot; %02X&quot;
comma
id|infobuf
(braket
id|i
)braket
)paren
suffix:semicolon
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
c_func
(paren
id|DBG_ECS
comma
l_string|&quot;TocEntry:%s&bslash;n&quot;
comma
id|msgbuf
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_TOC
comma
l_string|&quot;TocEntry: %02X %02X %02X %02X %08X&bslash;n&quot;
comma
id|D_S
(braket
id|d
)braket
dot
id|TocEnt_nixbyte
comma
id|D_S
(braket
id|d
)braket
dot
id|TocEnt_ctl_adr
comma
id|D_S
(braket
id|d
)braket
dot
id|TocEnt_number
comma
id|D_S
(braket
id|d
)braket
dot
id|TocEnt_format
comma
id|D_S
(braket
id|d
)braket
dot
id|TocEnt_address
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|cc_ReadPacket
r_static
r_int
id|cc_ReadPacket
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD0_PACKET
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
id|response_count
suffix:semicolon
r_if
c_cond
(paren
id|famL_drive
)paren
(brace
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam01_drive
)paren
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
r_else
r_if
c_cond
(paren
id|fam2_drive
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* not implemented yet */
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|convert_UPC
r_static
r_int
id|convert_UPC
c_func
(paren
id|u_char
op_star
id|p
)paren
(brace
r_int
id|i
suffix:semicolon
id|p
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|fam0L_drive
)paren
id|p
(braket
l_int|13
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|fam1_drive
)paren
id|D_S
(braket
id|d
)braket
dot
id|UPC_buf
(braket
id|i
)braket
op_assign
id|swap_nibbles
c_func
(paren
op_star
id|p
op_increment
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|fam0L_drive
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|UPC_buf
(braket
id|i
)braket
op_assign
(paren
(paren
op_star
id|p
op_increment
)paren
op_lshift
l_int|4
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|UPC_buf
(braket
id|i
)braket
op_or_assign
op_star
id|p
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* CD200 */
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
)brace
id|D_S
(braket
id|d
)braket
dot
id|UPC_buf
(braket
l_int|6
)braket
op_and_assign
l_int|0xF0
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|cc_ReadUPC
r_static
r_int
id|cc_ReadUPC
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
macro_line|#if TEST_UPC
r_int
id|block
comma
id|checksum
suffix:semicolon
macro_line|#endif TEST_UPC
r_if
c_cond
(paren
id|fam2_drive
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* not implemented yet */
r_if
c_cond
(paren
id|famT_drive
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* not implemented yet */
r_if
c_cond
(paren
id|famV_drive
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* not implemented yet */
macro_line|#if 1
r_if
c_cond
(paren
id|fam0_drive
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* but it should work */
macro_line|#endif 1
id|D_S
(braket
id|d
)braket
dot
id|diskstate_flags
op_and_assign
op_complement
id|upc_bit
suffix:semicolon
macro_line|#if TEST_UPC
r_for
c_loop
(paren
id|block
op_assign
id|CD_MSF_OFFSET
op_plus
l_int|1
suffix:semicolon
id|block
OL
id|CD_MSF_OFFSET
op_plus
l_int|200
suffix:semicolon
id|block
op_increment
)paren
(brace
macro_line|#endif TEST_UPC
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fam1_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD1_READ_UPC
suffix:semicolon
macro_line|#if TEST_UPC
id|drvcmd
(braket
l_int|1
)braket
op_assign
(paren
id|block
op_rshift
l_int|16
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
(paren
id|block
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
id|block
op_amp
l_int|0xFF
suffix:semicolon
macro_line|#endif TEST_UPC
id|response_count
op_assign
l_int|8
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam0L_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD0_READ_UPC
suffix:semicolon
macro_line|#if TEST_UPC
id|drvcmd
(braket
l_int|2
)braket
op_assign
(paren
id|block
op_rshift
l_int|16
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
(paren
id|block
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
id|block
op_amp
l_int|0xFF
suffix:semicolon
macro_line|#endif TEST_UPC
id|response_count
op_assign
l_int|0
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_lopsta
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
op_or
id|f_bit1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam2_drive
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|msg
c_func
(paren
id|DBG_000
comma
l_string|&quot;cc_ReadUPC cmd_out: err %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fam0L_drive
)paren
(brace
id|response_count
op_assign
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|famL_drive
)paren
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
id|i
op_assign
id|cc_ReadPacket
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|msg
c_func
(paren
id|DBG_000
comma
l_string|&quot;cc_ReadUPC ReadPacket: err %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
)brace
macro_line|#if TEST_UPC
id|checksum
op_assign
l_int|0
suffix:semicolon
macro_line|#endif TEST_UPC
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|fam1_drive
ques
c_cond
l_int|8
suffix:colon
l_int|16
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
macro_line|#if TEST_UPC
id|checksum
op_or_assign
id|infobuf
(braket
id|i
)braket
suffix:semicolon
macro_line|#endif TEST_UPC
id|sprintf
c_func
(paren
op_amp
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
comma
l_string|&quot; %02X&quot;
comma
id|infobuf
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
c_func
(paren
id|DBG_UPC
comma
l_string|&quot;UPC info:%s&bslash;n&quot;
comma
id|msgbuf
)paren
suffix:semicolon
macro_line|#if TEST_UPC
r_if
c_cond
(paren
(paren
id|checksum
op_amp
l_int|0x7F
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
)brace
macro_line|#endif TEST_UPC
id|D_S
(braket
id|d
)braket
dot
id|UPC_ctl_adr
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|fam1_drive
)paren
id|i
op_assign
l_int|0
suffix:semicolon
r_else
id|i
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
(paren
id|infobuf
(braket
id|i
)braket
op_amp
l_int|0x80
)paren
op_ne
l_int|0
)paren
(brace
id|convert_UPC
c_func
(paren
op_amp
id|infobuf
(braket
id|i
)braket
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|UPC_ctl_adr
op_assign
(paren
id|D_S
(braket
id|d
)braket
dot
id|TocEnt_ctl_adr
op_amp
l_int|0xF0
)paren
op_or
l_int|0x02
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
)paren
id|sprintf
c_func
(paren
op_amp
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
comma
l_string|&quot; %02X&quot;
comma
id|D_S
(braket
id|d
)braket
dot
id|UPC_buf
(braket
id|i
)braket
)paren
suffix:semicolon
id|sprintf
c_func
(paren
op_amp
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
comma
l_string|&quot; (%02X)&quot;
comma
id|D_S
(braket
id|d
)braket
dot
id|UPC_ctl_adr
)paren
suffix:semicolon
id|msgbuf
(braket
id|i
op_star
l_int|3
op_plus
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
c_func
(paren
id|DBG_UPC
comma
l_string|&quot;UPC code:%s&bslash;n&quot;
comma
id|msgbuf
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|diskstate_flags
op_or_assign
id|upc_bit
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|sbpcd_get_mcn
r_static
r_int
id|sbpcd_get_mcn
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
comma
r_struct
id|cdrom_mcn
op_star
id|mcn
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_char
op_star
id|mcnp
op_assign
id|mcn-&gt;medium_catalog_number
suffix:semicolon
r_int
r_char
op_star
id|resp
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|diskstate_flags
op_and_assign
op_complement
id|upc_bit
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fam1_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD1_READ_UPC
suffix:semicolon
id|response_count
op_assign
l_int|8
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam0L_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD0_READ_UPC
suffix:semicolon
id|response_count
op_assign
l_int|0
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_lopsta
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
op_or
id|f_bit1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam2_drive
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|msg
c_func
(paren
id|DBG_000
comma
l_string|&quot;cc_ReadUPC cmd_out: err %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fam0L_drive
)paren
(brace
id|response_count
op_assign
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|famL_drive
)paren
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
id|i
op_assign
id|cc_ReadPacket
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|msg
c_func
(paren
id|DBG_000
comma
l_string|&quot;cc_ReadUPC ReadPacket: err %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
)brace
id|D_S
(braket
id|d
)braket
dot
id|UPC_ctl_adr
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|fam1_drive
)paren
id|i
op_assign
l_int|0
suffix:semicolon
r_else
id|i
op_assign
l_int|2
suffix:semicolon
id|resp
op_assign
id|infobuf
op_plus
id|i
suffix:semicolon
r_if
c_cond
(paren
op_star
id|resp
op_increment
op_eq
l_int|0x80
)paren
(brace
multiline_comment|/* packed bcd to single ASCII digits */
op_star
id|mcnp
op_increment
op_assign
(paren
op_star
id|resp
op_rshift
l_int|4
)paren
op_plus
l_char|&squot;0&squot;
suffix:semicolon
op_star
id|mcnp
op_increment
op_assign
(paren
op_star
id|resp
op_increment
op_amp
l_int|0x0f
)paren
op_plus
l_char|&squot;0&squot;
suffix:semicolon
op_star
id|mcnp
op_increment
op_assign
(paren
op_star
id|resp
op_rshift
l_int|4
)paren
op_plus
l_char|&squot;0&squot;
suffix:semicolon
op_star
id|mcnp
op_increment
op_assign
(paren
op_star
id|resp
op_increment
op_amp
l_int|0x0f
)paren
op_plus
l_char|&squot;0&squot;
suffix:semicolon
op_star
id|mcnp
op_increment
op_assign
(paren
op_star
id|resp
op_rshift
l_int|4
)paren
op_plus
l_char|&squot;0&squot;
suffix:semicolon
op_star
id|mcnp
op_increment
op_assign
(paren
op_star
id|resp
op_increment
op_amp
l_int|0x0f
)paren
op_plus
l_char|&squot;0&squot;
suffix:semicolon
op_star
id|mcnp
op_increment
op_assign
(paren
op_star
id|resp
op_rshift
l_int|4
)paren
op_plus
l_char|&squot;0&squot;
suffix:semicolon
op_star
id|mcnp
op_increment
op_assign
(paren
op_star
id|resp
op_increment
op_amp
l_int|0x0f
)paren
op_plus
l_char|&squot;0&squot;
suffix:semicolon
op_star
id|mcnp
op_increment
op_assign
(paren
op_star
id|resp
op_rshift
l_int|4
)paren
op_plus
l_char|&squot;0&squot;
suffix:semicolon
op_star
id|mcnp
op_increment
op_assign
(paren
op_star
id|resp
op_increment
op_amp
l_int|0x0f
)paren
op_plus
l_char|&squot;0&squot;
suffix:semicolon
op_star
id|mcnp
op_increment
op_assign
(paren
op_star
id|resp
op_rshift
l_int|4
)paren
op_plus
l_char|&squot;0&squot;
suffix:semicolon
op_star
id|mcnp
op_increment
op_assign
(paren
op_star
id|resp
op_increment
op_amp
l_int|0x0f
)paren
op_plus
l_char|&squot;0&squot;
suffix:semicolon
op_star
id|mcnp
op_increment
op_assign
(paren
op_star
id|resp
op_rshift
l_int|4
)paren
op_plus
l_char|&squot;0&squot;
suffix:semicolon
)brace
op_star
id|mcnp
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|diskstate_flags
op_or_assign
id|upc_bit
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|cc_CheckMultiSession
r_static
r_int
id|cc_CheckMultiSession
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|fam2_drive
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|f_multisession
op_assign
l_int|0
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|lba_multi
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|fam0_drive
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fam1_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD1_MULTISESS
suffix:semicolon
id|response_count
op_assign
l_int|6
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|infobuf
(braket
l_int|0
)braket
op_amp
l_int|0x80
)paren
op_ne
l_int|0
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|f_multisession
op_assign
l_int|1
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|lba_multi
op_assign
id|msf2blk
c_func
(paren
id|make32
c_func
(paren
id|make16
c_func
(paren
l_int|0
comma
id|infobuf
(braket
l_int|1
)braket
)paren
comma
id|make16
c_func
(paren
id|infobuf
(braket
l_int|2
)braket
comma
id|infobuf
(braket
l_int|3
)braket
)paren
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|famLV_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMDL_MULTISESS
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|3
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
l_int|1
suffix:semicolon
id|response_count
op_assign
l_int|8
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|lba_multi
op_assign
id|msf2blk
c_func
(paren
id|make32
c_func
(paren
id|make16
c_func
(paren
l_int|0
comma
id|infobuf
(braket
l_int|5
)braket
)paren
comma
id|make16
c_func
(paren
id|infobuf
(braket
l_int|6
)braket
comma
id|infobuf
(braket
l_int|7
)braket
)paren
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
id|response_count
op_assign
l_int|12
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMDT_DISKINFO
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x02
suffix:semicolon
id|drvcmd
(braket
l_int|6
)braket
op_assign
l_int|0
suffix:semicolon
id|drvcmd
(braket
l_int|8
)braket
op_assign
id|response_count
suffix:semicolon
id|drvcmd
(braket
l_int|9
)braket
op_assign
l_int|0x40
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
id|response_count
)paren
r_return
(paren
op_minus
l_int|100
op_minus
id|i
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|first_session
op_assign
id|infobuf
(braket
l_int|2
)braket
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|last_session
op_assign
id|infobuf
(braket
l_int|3
)braket
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|track_of_last_session
op_assign
id|infobuf
(braket
l_int|6
)braket
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|first_session
op_ne
id|D_S
(braket
id|d
)braket
dot
id|last_session
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|f_multisession
op_assign
l_int|1
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|lba_multi
op_assign
id|msf2blk
c_func
(paren
id|make32
c_func
(paren
id|make16
c_func
(paren
l_int|0
comma
id|infobuf
(braket
l_int|9
)braket
)paren
comma
id|make16
c_func
(paren
id|infobuf
(braket
l_int|10
)braket
comma
id|infobuf
(braket
l_int|11
)braket
)paren
)paren
)paren
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|response_count
suffix:semicolon
id|i
op_increment
)paren
id|sprintf
c_func
(paren
op_amp
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
comma
l_string|&quot; %02X&quot;
comma
id|infobuf
(braket
id|i
)braket
)paren
suffix:semicolon
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
c_func
(paren
id|DBG_MUL
comma
l_string|&quot;MultiSession Info:%s (%d)&bslash;n&quot;
comma
id|msgbuf
comma
id|D_S
(braket
id|d
)braket
dot
id|lba_multi
)paren
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|lba_multi
OG
l_int|200
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|f_multisession
op_assign
l_int|1
suffix:semicolon
id|msg
c_func
(paren
id|DBG_MUL
comma
l_string|&quot;MultiSession base: %06X&bslash;n&quot;
comma
id|D_S
(braket
id|d
)braket
dot
id|lba_multi
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
macro_line|#if FUTURE
DECL|function|cc_SubChanInfo
r_static
r_int
id|cc_SubChanInfo
c_func
(paren
r_int
id|frame
comma
r_int
id|count
comma
id|u_char
op_star
id|buffer
)paren
multiline_comment|/* &quot;frame&quot; is a RED BOOK (msf-bin) address */
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|fam0LV_drive
)paren
r_return
(paren
op_minus
id|ENOSYS
)paren
suffix:semicolon
multiline_comment|/* drive firmware lacks it */
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#if 0
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|audio_state
op_ne
id|audio_playing
)paren
r_return
(paren
op_minus
id|ENODATA
)paren
suffix:semicolon
macro_line|#endif
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD1_SUBCHANINF
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
(paren
id|frame
op_rshift
l_int|16
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
(paren
id|frame
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
id|frame
op_amp
l_int|0xFF
suffix:semicolon
id|drvcmd
(braket
l_int|5
)braket
op_assign
(paren
id|count
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|drvcmd
(braket
l_int|6
)braket
op_assign
id|count
op_amp
l_int|0xFF
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
id|cmd_type
op_assign
id|READ_SC
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|frame_size
op_assign
id|CD_FRAMESIZE_SUB
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* which buffer to use? */
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
macro_line|#endif FUTURE
multiline_comment|/*==========================================================================*/
DECL|function|check_datarate
r_static
r_void
id|__init
id|check_datarate
c_func
(paren
r_void
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|msg
c_func
(paren
id|DBG_IOX
comma
l_string|&quot;check_datarate entered.&bslash;n&quot;
)paren
suffix:semicolon
id|datarate
op_assign
l_int|0
suffix:semicolon
macro_line|#if TEST_STI
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
l_int|1000
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;.&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* set a timer to make (timed_out_delay!=0) after 1.1 seconds */
macro_line|#if 1
id|del_timer
c_func
(paren
op_amp
id|delay_timer
)paren
suffix:semicolon
macro_line|#endif
id|delay_timer.expires
op_assign
id|jiffies
op_plus
l_int|11
op_star
id|HZ
op_div
l_int|10
suffix:semicolon
id|timed_out_delay
op_assign
l_int|0
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|delay_timer
)paren
suffix:semicolon
macro_line|#if 0
id|msg
c_func
(paren
id|DBG_TIM
comma
l_string|&quot;delay timer started (11*HZ/10).&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_do
(brace
id|i
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
id|datarate
op_increment
suffix:semicolon
macro_line|#if 1
r_if
c_cond
(paren
id|datarate
OG
l_int|0x6FFFFFFF
)paren
r_break
suffix:semicolon
macro_line|#endif 00000
)brace
r_while
c_loop
(paren
op_logical_neg
id|timed_out_delay
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|delay_timer
)paren
suffix:semicolon
macro_line|#if 0
id|msg
c_func
(paren
id|DBG_TIM
comma
l_string|&quot;datarate: %04X&bslash;n&quot;
comma
id|datarate
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|datarate
OL
l_int|65536
)paren
id|datarate
op_assign
l_int|65536
suffix:semicolon
id|maxtim16
op_assign
id|datarate
op_star
l_int|16
suffix:semicolon
id|maxtim04
op_assign
id|datarate
op_star
l_int|4
suffix:semicolon
id|maxtim02
op_assign
id|datarate
op_star
l_int|2
suffix:semicolon
id|maxtim_8
op_assign
id|datarate
op_div
l_int|32
suffix:semicolon
macro_line|#if LONG_TIMING
id|maxtim_data
op_assign
id|datarate
op_div
l_int|100
suffix:semicolon
macro_line|#else
id|maxtim_data
op_assign
id|datarate
op_div
l_int|300
suffix:semicolon
macro_line|#endif LONG_TIMING
macro_line|#if 0
id|msg
c_func
(paren
id|DBG_TIM
comma
l_string|&quot;maxtim_8 %d, maxtim_data %d.&bslash;n&quot;
comma
id|maxtim_8
comma
id|maxtim_data
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*==========================================================================*/
macro_line|#if 0
r_static
r_int
id|c2_ReadError
c_func
(paren
r_int
id|fam
)paren
(brace
r_int
id|i
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
id|response_count
op_assign
l_int|9
suffix:semicolon
id|clr_respo_buf
c_func
(paren
l_int|9
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fam
op_eq
l_int|1
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD0_READ_ERR
suffix:semicolon
multiline_comment|/* same as CMD1_ and CMDL_ */
id|i
op_assign
id|do_cmd
c_func
(paren
id|f_putcmd
op_or
id|f_lopsta
op_or
id|f_getsta
op_or
id|f_ResponseStatus
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam
op_eq
l_int|2
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD2_READ_ERR
suffix:semicolon
id|i
op_assign
id|do_cmd
c_func
(paren
id|f_putcmd
)paren
suffix:semicolon
)brace
r_else
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*==========================================================================*/
DECL|function|ask_mail
r_static
r_void
id|__init
id|ask_mail
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;please mail the following lines to emoenke@gwdg.de&bslash;n&quot;
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;(don&squot;t mail if you are not using the actual kernel):&bslash;n&quot;
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|VERSION
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;address %03X, type %s, drive %s (ID %d)&bslash;n&quot;
comma
id|CDo_command
comma
id|type
comma
id|D_S
(braket
id|d
)braket
dot
id|drive_model
comma
id|D_S
(braket
id|d
)braket
dot
id|drv_id
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|12
suffix:semicolon
id|i
op_increment
)paren
id|sprintf
c_func
(paren
op_amp
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
comma
l_string|&quot; %02X&quot;
comma
id|infobuf
(braket
id|i
)braket
)paren
suffix:semicolon
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;infobuf =%s&bslash;n&quot;
comma
id|msgbuf
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|12
suffix:semicolon
id|i
op_increment
)paren
id|sprintf
c_func
(paren
op_amp
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
comma
l_string|&quot; %c &quot;
comma
id|infobuf
(braket
id|i
)braket
)paren
suffix:semicolon
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;infobuf =%s&bslash;n&quot;
comma
id|msgbuf
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|check_version
r_static
r_int
id|__init
id|check_version
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
comma
id|l
suffix:semicolon
r_int
id|teac_possible
op_assign
l_int|0
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INI
comma
l_string|&quot;check_version: id=%d, d=%d.&bslash;n&quot;
comma
id|D_S
(braket
id|d
)braket
dot
id|drv_id
comma
id|d
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drv_type
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* check for CR-52x, CR-56x, LCS-7260 and ECS-AT */
multiline_comment|/* clear any pending error state */
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD0_READ_ERR
suffix:semicolon
multiline_comment|/* same as CMD1_ and CMDL_ */
id|response_count
op_assign
l_int|9
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
id|msg
c_func
(paren
id|DBG_INI
comma
l_string|&quot;CMD0_READ_ERR returns %d (ok anyway).&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
multiline_comment|/* read drive version */
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|12
suffix:semicolon
id|i
op_increment
)paren
id|infobuf
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD0_READ_VER
suffix:semicolon
multiline_comment|/* same as CMD1_ and CMDL_ */
id|response_count
op_assign
l_int|12
suffix:semicolon
multiline_comment|/* fam1: only 11 */
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
op_minus
l_int|1
)paren
id|msg
c_func
(paren
id|DBG_INI
comma
l_string|&quot;CMD0_READ_VER returns %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
op_minus
l_int|11
)paren
id|teac_possible
op_increment
suffix:semicolon
id|j
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|12
suffix:semicolon
id|i
op_increment
)paren
id|j
op_add_assign
id|infobuf
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|j
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|12
suffix:semicolon
id|i
op_increment
)paren
id|sprintf
c_func
(paren
op_amp
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
comma
l_string|&quot; %02X&quot;
comma
id|infobuf
(braket
id|i
)braket
)paren
suffix:semicolon
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
c_func
(paren
id|DBG_ECS
comma
l_string|&quot;infobuf =%s&bslash;n&quot;
comma
id|msgbuf
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|12
suffix:semicolon
id|i
op_increment
)paren
id|sprintf
c_func
(paren
op_amp
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
comma
l_string|&quot; %c &quot;
comma
id|infobuf
(braket
id|i
)braket
)paren
suffix:semicolon
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
c_func
(paren
id|DBG_ECS
comma
l_string|&quot;infobuf =%s&bslash;n&quot;
comma
id|msgbuf
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|infobuf
(braket
id|i
)braket
op_ne
id|family1
(braket
id|i
)braket
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|4
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|0
)braket
op_assign
l_char|&squot;C&squot;
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|1
)braket
op_assign
l_char|&squot;R&squot;
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|2
)braket
op_assign
l_char|&squot;-&squot;
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|3
)braket
op_assign
l_char|&squot;5&squot;
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|4
)braket
op_assign
id|infobuf
(braket
id|i
op_increment
)braket
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|5
)braket
op_assign
id|infobuf
(braket
id|i
op_increment
)braket
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|6
)braket
op_assign
l_int|0
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drv_type
op_assign
id|drv_fam1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|D_S
(braket
id|d
)braket
dot
id|drv_type
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|infobuf
(braket
id|i
)braket
op_ne
id|family0
(braket
id|i
)braket
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|8
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|0
)braket
op_assign
l_char|&squot;C&squot;
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|1
)braket
op_assign
l_char|&squot;R&squot;
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|2
)braket
op_assign
l_char|&squot;-&squot;
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|3
)braket
op_assign
l_char|&squot;5&squot;
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|4
)braket
op_assign
l_char|&squot;2&squot;
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|5
)braket
op_assign
l_char|&squot;x&squot;
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|6
)braket
op_assign
l_int|0
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drv_type
op_assign
id|drv_fam0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|D_S
(braket
id|d
)braket
dot
id|drv_type
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|infobuf
(braket
id|i
)braket
op_ne
id|familyL
(braket
id|i
)braket
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|8
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
id|j
)braket
op_assign
id|infobuf
(braket
id|j
)braket
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|8
)braket
op_assign
l_int|0
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drv_type
op_assign
id|drv_famL
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|D_S
(braket
id|d
)braket
dot
id|drv_type
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|infobuf
(braket
id|i
)braket
op_ne
id|familyV
(braket
id|i
)braket
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|6
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|6
suffix:semicolon
id|j
op_increment
)paren
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
id|j
)braket
op_assign
id|infobuf
(braket
id|j
)braket
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|6
)braket
op_assign
l_int|0
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drv_type
op_assign
id|drv_famV
suffix:semicolon
id|i
op_add_assign
l_int|2
suffix:semicolon
multiline_comment|/* 2 blanks before version */
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|D_S
(braket
id|d
)braket
dot
id|drv_type
)paren
(brace
multiline_comment|/* check for CD200 */
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD2_READ_ERR
suffix:semicolon
id|response_count
op_assign
l_int|9
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
id|msg
c_func
(paren
id|DBG_INI
comma
l_string|&quot;CMD2_READERR returns %d (ok anyway).&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
id|msg
c_func
(paren
id|DBG_000
comma
l_string|&quot;CMD2_READERR returns %d (ok anyway).&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
multiline_comment|/* read drive version */
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|12
suffix:semicolon
id|i
op_increment
)paren
id|infobuf
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sbpro_type
op_eq
l_int|1
)paren
id|OUT
c_func
(paren
id|CDo_sel_i_d
comma
l_int|0
)paren
suffix:semicolon
macro_line|#if 0
id|OUT
c_func
(paren
id|CDo_reset
comma
l_int|0
)paren
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|6
op_star
id|HZ
)paren
suffix:semicolon
id|OUT
c_func
(paren
id|CDo_enable
comma
id|D_S
(braket
id|d
)braket
dot
id|drv_sel
)paren
suffix:semicolon
macro_line|#endif 0
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD2_READ_VER
suffix:semicolon
id|response_count
op_assign
l_int|12
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
id|msg
c_func
(paren
id|DBG_INI
comma
l_string|&quot;CMD2_READ_VER returns %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
op_minus
l_int|7
)paren
id|teac_possible
op_increment
suffix:semicolon
id|j
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|12
suffix:semicolon
id|i
op_increment
)paren
id|j
op_add_assign
id|infobuf
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|j
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|12
suffix:semicolon
id|i
op_increment
)paren
id|sprintf
c_func
(paren
op_amp
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
comma
l_string|&quot; %02X&quot;
comma
id|infobuf
(braket
id|i
)braket
)paren
suffix:semicolon
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
c_func
(paren
id|DBG_IDX
comma
l_string|&quot;infobuf =%s&bslash;n&quot;
comma
id|msgbuf
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|12
suffix:semicolon
id|i
op_increment
)paren
id|sprintf
c_func
(paren
op_amp
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
comma
l_string|&quot; %c &quot;
comma
id|infobuf
(braket
id|i
)braket
)paren
suffix:semicolon
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
c_func
(paren
id|DBG_IDX
comma
l_string|&quot;infobuf =%s&bslash;n&quot;
comma
id|msgbuf
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ge
l_int|0
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|infobuf
(braket
id|i
)braket
op_ne
id|family2
(braket
id|i
)braket
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|5
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|0
)braket
op_assign
l_char|&squot;C&squot;
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|1
)braket
op_assign
l_char|&squot;D&squot;
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|2
)braket
op_assign
l_char|&squot;2&squot;
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|3
)braket
op_assign
l_char|&squot;0&squot;
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|4
)braket
op_assign
l_char|&squot;0&squot;
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|5
)braket
op_assign
id|infobuf
(braket
id|i
op_increment
)braket
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|6
)braket
op_assign
id|infobuf
(braket
id|i
op_increment
)braket
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|7
)braket
op_assign
l_int|0
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drv_type
op_assign
id|drv_fam2
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|D_S
(braket
id|d
)braket
dot
id|drv_type
)paren
(brace
multiline_comment|/* check for TEAC CD-55A */
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;teac_possible: %d&bslash;n&quot;
comma
id|teac_possible
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|1
suffix:semicolon
id|j
op_le
(paren
(paren
id|D_S
(braket
id|d
)braket
dot
id|drv_id
op_eq
l_int|0
)paren
ques
c_cond
l_int|3
suffix:colon
l_int|1
)paren
suffix:semicolon
id|j
op_increment
)paren
(brace
r_for
c_loop
(paren
id|l
op_assign
l_int|1
suffix:semicolon
id|l
op_le
(paren
(paren
id|D_S
(braket
id|d
)braket
dot
id|drv_id
op_eq
l_int|0
)paren
ques
c_cond
l_int|10
suffix:colon
l_int|1
)paren
suffix:semicolon
id|l
op_increment
)paren
(brace
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;TEAC reset #%d-%d.&bslash;n&quot;
comma
id|j
comma
id|l
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbpro_type
op_eq
l_int|1
)paren
id|OUT
c_func
(paren
id|CDo_reset
comma
l_int|0
)paren
suffix:semicolon
r_else
(brace
id|OUT
c_func
(paren
id|CDo_enable
comma
id|D_S
(braket
id|d
)braket
dot
id|drv_sel
)paren
suffix:semicolon
id|OUT
c_func
(paren
id|CDo_sel_i_d
comma
l_int|0
)paren
suffix:semicolon
id|OUT
c_func
(paren
id|CDo_command
comma
id|CMDT_RESET
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|9
suffix:semicolon
id|i
op_increment
)paren
id|OUT
c_func
(paren
id|CDo_command
comma
l_int|0
)paren
suffix:semicolon
)brace
id|sbp_sleep
c_func
(paren
l_int|5
op_star
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
id|OUT
c_func
(paren
id|CDo_enable
comma
id|D_S
(braket
id|d
)braket
dot
id|drv_sel
)paren
suffix:semicolon
id|OUT
c_func
(paren
id|CDo_sel_i_d
comma
l_int|0
)paren
suffix:semicolon
id|i
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;TEAC CDi_status: %02X.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|i
op_amp
id|s_not_result_ready
)paren
r_continue
suffix:semicolon
multiline_comment|/* drive not present or ready */
macro_line|#endif
id|i
op_assign
id|inb
c_func
(paren
id|CDi_info
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;TEAC CDi_info: %02X.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|0x55
)paren
r_break
suffix:semicolon
multiline_comment|/* drive found */
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|0x55
)paren
r_break
suffix:semicolon
multiline_comment|/* drive found */
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|0x55
)paren
multiline_comment|/* drive found */
(brace
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;TEAC drive found.&bslash;n&quot;
)paren
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
id|response_count
op_assign
l_int|12
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMDT_READ_VER
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
id|response_count
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|12
suffix:semicolon
id|i
op_increment
)paren
id|infobuf
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|cmd_out_T
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
l_int|0
)paren
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;cmd_out_T(CMDT_READ_VER) returns %d.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|infobuf
(braket
id|i
)braket
op_ne
id|familyT
(braket
id|i
op_minus
l_int|1
)braket
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|6
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|0
)braket
op_assign
l_char|&squot;C&squot;
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|1
)braket
op_assign
l_char|&squot;D&squot;
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|2
)braket
op_assign
l_char|&squot;-&squot;
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|3
)braket
op_assign
l_char|&squot;5&squot;
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|4
)braket
op_assign
l_char|&squot;5&squot;
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|drv_type
op_assign
id|drv_famT
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|D_S
(braket
id|d
)braket
dot
id|drv_type
)paren
(brace
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;no drive found at address %03X under ID %d.&bslash;n&quot;
comma
id|CDo_command
comma
id|D_S
(braket
id|d
)braket
dot
id|drv_id
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|522
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|4
suffix:semicolon
id|j
op_increment
)paren
id|D_S
(braket
id|d
)braket
dot
id|firmware_version
(braket
id|j
)braket
op_assign
id|infobuf
(braket
id|i
op_plus
id|j
)braket
suffix:semicolon
r_if
c_cond
(paren
id|famL_drive
)paren
(brace
id|u_char
id|lcs_firm_e1
(braket
)braket
op_assign
l_string|&quot;A E1&quot;
suffix:semicolon
id|u_char
id|lcs_firm_f4
(braket
)braket
op_assign
l_string|&quot;A4F4&quot;
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|4
suffix:semicolon
id|j
op_increment
)paren
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|firmware_version
(braket
id|j
)braket
op_ne
id|lcs_firm_e1
(braket
id|j
)braket
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|j
op_eq
l_int|4
)paren
id|D_S
(braket
id|d
)braket
dot
id|drv_type
op_assign
id|drv_e1
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|4
suffix:semicolon
id|j
op_increment
)paren
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|firmware_version
(braket
id|j
)braket
op_ne
id|lcs_firm_f4
(braket
id|j
)braket
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|j
op_eq
l_int|4
)paren
id|D_S
(braket
id|d
)braket
dot
id|drv_type
op_assign
id|drv_f4
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|drv_type
op_eq
id|drv_famL
)paren
id|ask_mail
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
id|j
op_assign
id|infobuf
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* one-byte version??? - here: 0x15 */
r_if
c_cond
(paren
id|j
op_eq
l_char|&squot;5&squot;
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|firmware_version
(braket
l_int|0
)braket
op_assign
id|infobuf
(braket
l_int|7
)braket
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|firmware_version
(braket
l_int|1
)braket
op_assign
id|infobuf
(braket
l_int|8
)braket
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|firmware_version
(braket
l_int|2
)braket
op_assign
id|infobuf
(braket
l_int|10
)braket
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|firmware_version
(braket
l_int|3
)braket
op_assign
id|infobuf
(braket
l_int|11
)braket
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|j
op_ne
l_int|0x15
)paren
id|ask_mail
c_func
(paren
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|firmware_version
(braket
l_int|0
)braket
op_assign
l_char|&squot;0&squot;
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|firmware_version
(braket
l_int|1
)braket
op_assign
l_char|&squot;.&squot;
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|firmware_version
(braket
l_int|2
)braket
op_assign
l_char|&squot;0&squot;
op_plus
(paren
id|j
op_rshift
l_int|4
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|firmware_version
(braket
l_int|3
)braket
op_assign
l_char|&squot;0&squot;
op_plus
(paren
id|j
op_amp
l_int|0x0f
)paren
suffix:semicolon
)brace
)brace
r_else
multiline_comment|/* CR-52x, CR-56x, CD200, ECS-AT */
(brace
id|j
op_assign
(paren
id|D_S
(braket
id|d
)braket
dot
id|firmware_version
(braket
l_int|0
)braket
op_amp
l_int|0x0F
)paren
op_star
l_int|100
op_plus
(paren
id|D_S
(braket
id|d
)braket
dot
id|firmware_version
(braket
l_int|2
)braket
op_amp
l_int|0x0F
)paren
op_star
l_int|10
op_plus
(paren
id|D_S
(braket
id|d
)braket
dot
id|firmware_version
(braket
l_int|3
)braket
op_amp
l_int|0x0F
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fam0_drive
)paren
(brace
r_if
c_cond
(paren
id|j
OL
l_int|200
)paren
id|D_S
(braket
id|d
)braket
dot
id|drv_type
op_assign
id|drv_199
suffix:semicolon
r_else
r_if
c_cond
(paren
id|j
OL
l_int|201
)paren
id|D_S
(braket
id|d
)braket
dot
id|drv_type
op_assign
id|drv_200
suffix:semicolon
r_else
r_if
c_cond
(paren
id|j
OL
l_int|210
)paren
id|D_S
(braket
id|d
)braket
dot
id|drv_type
op_assign
id|drv_201
suffix:semicolon
r_else
r_if
c_cond
(paren
id|j
OL
l_int|211
)paren
id|D_S
(braket
id|d
)braket
dot
id|drv_type
op_assign
id|drv_210
suffix:semicolon
r_else
r_if
c_cond
(paren
id|j
OL
l_int|300
)paren
id|D_S
(braket
id|d
)braket
dot
id|drv_type
op_assign
id|drv_211
suffix:semicolon
r_else
r_if
c_cond
(paren
id|j
op_ge
l_int|300
)paren
id|D_S
(braket
id|d
)braket
dot
id|drv_type
op_assign
id|drv_300
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam1_drive
)paren
(brace
r_if
c_cond
(paren
id|j
OL
l_int|100
)paren
id|D_S
(braket
id|d
)braket
dot
id|drv_type
op_assign
id|drv_099
suffix:semicolon
r_else
(brace
id|D_S
(braket
id|d
)braket
dot
id|drv_type
op_assign
id|drv_100
suffix:semicolon
r_if
c_cond
(paren
(paren
id|j
op_ne
l_int|500
)paren
op_logical_and
(paren
id|j
op_ne
l_int|102
)paren
)paren
id|ask_mail
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|fam2_drive
)paren
(brace
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|5
)braket
op_eq
l_char|&squot;F&squot;
)paren
(brace
r_if
c_cond
(paren
(paren
id|j
op_ne
l_int|1
)paren
op_logical_and
(paren
id|j
op_ne
l_int|35
)paren
op_logical_and
(paren
id|j
op_ne
l_int|200
)paren
op_logical_and
(paren
id|j
op_ne
l_int|210
)paren
)paren
id|ask_mail
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* unknown version at time */
)brace
r_else
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;this CD200 drive is not fully supported yet - only audio will work.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|j
op_ne
l_int|101
)paren
op_logical_and
(paren
id|j
op_ne
l_int|35
)paren
)paren
id|ask_mail
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* unknown version at time */
)brace
)brace
r_else
r_if
c_cond
(paren
id|famV_drive
)paren
(brace
r_if
c_cond
(paren
(paren
id|j
op_eq
l_int|100
)paren
op_logical_or
(paren
id|j
op_eq
l_int|150
)paren
)paren
id|D_S
(braket
id|d
)braket
dot
id|drv_type
op_assign
id|drv_at
suffix:semicolon
id|ask_mail
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* hopefully we get some feedback by this */
)brace
)brace
id|msg
c_func
(paren
id|DBG_LCS
comma
l_string|&quot;drive type %02X&bslash;n&quot;
comma
id|D_S
(braket
id|d
)braket
dot
id|drv_type
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INI
comma
l_string|&quot;check_version done.&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|switch_drive
r_static
r_void
id|switch_drive
c_func
(paren
r_int
id|i
)paren
(brace
id|d
op_assign
id|i
suffix:semicolon
id|OUT
c_func
(paren
id|CDo_enable
comma
id|D_S
(braket
id|d
)braket
dot
id|drv_sel
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_DID
comma
l_string|&quot;drive %d (ID=%d) activated.&bslash;n&quot;
comma
id|i
comma
id|D_S
(braket
id|d
)braket
dot
id|drv_id
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
macro_line|#ifdef PATH_CHECK
multiline_comment|/*&n; * probe for the presence of an interface card&n; */
DECL|function|check_card
r_static
r_int
id|__init
id|check_card
c_func
(paren
r_int
id|port
)paren
(brace
DECL|macro|N_RESPO
macro_line|#undef N_RESPO
DECL|macro|N_RESPO
mdefine_line|#define N_RESPO 20
r_int
id|i
comma
id|j
comma
id|k
suffix:semicolon
id|u_char
id|response
(braket
id|N_RESPO
)braket
suffix:semicolon
id|u_char
id|save_port0
suffix:semicolon
id|u_char
id|save_port3
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INI
comma
l_string|&quot;check_card entered.&bslash;n&quot;
)paren
suffix:semicolon
id|save_port0
op_assign
id|inb
c_func
(paren
id|port
op_plus
l_int|0
)paren
suffix:semicolon
id|save_port3
op_assign
id|inb
c_func
(paren
id|port
op_plus
l_int|3
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|NR_SBPCD
suffix:semicolon
id|j
op_increment
)paren
(brace
id|OUT
c_func
(paren
id|port
op_plus
l_int|3
comma
id|j
)paren
suffix:semicolon
multiline_comment|/* enable drive #j */
id|OUT
c_func
(paren
id|port
op_plus
l_int|0
comma
id|CMD0_PATH_CHECK
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|10
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
id|OUT
c_func
(paren
id|port
op_plus
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|N_RESPO
suffix:semicolon
id|k
op_increment
)paren
id|response
(braket
id|k
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|N_RESPO
suffix:semicolon
id|k
op_increment
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|10000
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|inb
c_func
(paren
id|port
op_plus
l_int|1
)paren
op_amp
id|s_not_result_ready
)paren
r_continue
suffix:semicolon
id|response
(braket
id|k
)braket
op_assign
id|inb
c_func
(paren
id|port
op_plus
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|N_RESPO
suffix:semicolon
id|i
op_increment
)paren
id|sprintf
c_func
(paren
op_amp
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
comma
l_string|&quot; %02X&quot;
comma
id|response
(braket
id|i
)braket
)paren
suffix:semicolon
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;path check 00 (%d): %s&bslash;n&quot;
comma
id|j
comma
id|msgbuf
)paren
suffix:semicolon
id|OUT
c_func
(paren
id|port
op_plus
l_int|0
comma
id|CMD0_PATH_CHECK
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|10
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
id|OUT
c_func
(paren
id|port
op_plus
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|N_RESPO
suffix:semicolon
id|k
op_increment
)paren
id|response
(braket
id|k
)braket
op_assign
l_int|0xFF
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|N_RESPO
suffix:semicolon
id|k
op_increment
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|10000
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|inb
c_func
(paren
id|port
op_plus
l_int|1
)paren
op_amp
id|s_not_result_ready
)paren
r_continue
suffix:semicolon
id|response
(braket
id|k
)braket
op_assign
id|inb
c_func
(paren
id|port
op_plus
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|N_RESPO
suffix:semicolon
id|i
op_increment
)paren
id|sprintf
c_func
(paren
op_amp
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
comma
l_string|&quot; %02X&quot;
comma
id|response
(braket
id|i
)braket
)paren
suffix:semicolon
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;path check 00 (%d): %s&bslash;n&quot;
comma
id|j
comma
id|msgbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|response
(braket
l_int|0
)braket
op_eq
l_int|0xAA
)paren
r_if
c_cond
(paren
id|response
(braket
l_int|1
)braket
op_eq
l_int|0x55
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|NR_SBPCD
suffix:semicolon
id|j
op_increment
)paren
(brace
id|OUT
c_func
(paren
id|port
op_plus
l_int|3
comma
id|j
)paren
suffix:semicolon
multiline_comment|/* enable drive #j */
id|OUT
c_func
(paren
id|port
op_plus
l_int|0
comma
id|CMD2_READ_VER
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|10
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
id|OUT
c_func
(paren
id|port
op_plus
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|N_RESPO
suffix:semicolon
id|k
op_increment
)paren
id|response
(braket
id|k
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|N_RESPO
suffix:semicolon
id|k
op_increment
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|1000000
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|inb
c_func
(paren
id|port
op_plus
l_int|1
)paren
op_amp
id|s_not_result_ready
)paren
r_continue
suffix:semicolon
id|response
(braket
id|k
)braket
op_assign
id|inb
c_func
(paren
id|port
op_plus
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|N_RESPO
suffix:semicolon
id|i
op_increment
)paren
id|sprintf
c_func
(paren
op_amp
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
comma
l_string|&quot; %02X&quot;
comma
id|response
(braket
id|i
)braket
)paren
suffix:semicolon
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;path check 12 (%d): %s&bslash;n&quot;
comma
id|j
comma
id|msgbuf
)paren
suffix:semicolon
id|OUT
c_func
(paren
id|port
op_plus
l_int|0
comma
id|CMD2_READ_VER
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|10
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
id|OUT
c_func
(paren
id|port
op_plus
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|N_RESPO
suffix:semicolon
id|k
op_increment
)paren
id|response
(braket
id|k
)braket
op_assign
l_int|0xFF
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|N_RESPO
suffix:semicolon
id|k
op_increment
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|1000000
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|inb
c_func
(paren
id|port
op_plus
l_int|1
)paren
op_amp
id|s_not_result_ready
)paren
r_continue
suffix:semicolon
id|response
(braket
id|k
)braket
op_assign
id|inb
c_func
(paren
id|port
op_plus
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|N_RESPO
suffix:semicolon
id|i
op_increment
)paren
id|sprintf
c_func
(paren
op_amp
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
comma
l_string|&quot; %02X&quot;
comma
id|response
(braket
id|i
)braket
)paren
suffix:semicolon
id|msgbuf
(braket
id|i
op_star
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;path check 12 (%d): %s&bslash;n&quot;
comma
id|j
comma
id|msgbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|response
(braket
l_int|0
)braket
op_eq
l_int|0xAA
)paren
r_if
c_cond
(paren
id|response
(braket
l_int|1
)braket
op_eq
l_int|0x55
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|OUT
c_func
(paren
id|port
op_plus
l_int|0
comma
id|save_port0
)paren
suffix:semicolon
id|OUT
c_func
(paren
id|port
op_plus
l_int|3
comma
id|save_port3
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* in any case - no real &quot;function&quot; at time */
)brace
macro_line|#endif PATH_CHECK
multiline_comment|/*==========================================================================*/
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; * probe for the presence of drives on the selected controller&n; */
DECL|function|check_drives
r_static
r_int
id|__init
id|check_drives
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INI
comma
l_string|&quot;check_drives entered.&bslash;n&quot;
)paren
suffix:semicolon
id|ndrives
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|MAX_DRIVES
suffix:semicolon
id|j
op_increment
)paren
(brace
id|D_S
(braket
id|ndrives
)braket
dot
id|drv_id
op_assign
id|j
suffix:semicolon
r_if
c_cond
(paren
id|sbpro_type
op_eq
l_int|1
)paren
id|D_S
(braket
id|ndrives
)braket
dot
id|drv_sel
op_assign
(paren
id|j
op_amp
l_int|0x01
)paren
op_lshift
l_int|1
op_or
(paren
id|j
op_amp
l_int|0x02
)paren
op_rshift
l_int|1
suffix:semicolon
r_else
id|D_S
(braket
id|ndrives
)braket
dot
id|drv_sel
op_assign
id|j
suffix:semicolon
id|switch_drive
c_func
(paren
id|ndrives
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INI
comma
l_string|&quot;check_drives: drive %d (ID=%d) activated.&bslash;n&quot;
comma
id|ndrives
comma
id|j
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_000
comma
l_string|&quot;check_drives: drive %d (ID=%d) activated.&bslash;n&quot;
comma
id|ndrives
comma
id|j
)paren
suffix:semicolon
id|i
op_assign
id|check_version
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
id|msg
c_func
(paren
id|DBG_INI
comma
l_string|&quot;check_version returns %d.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_else
(brace
id|D_S
(braket
id|d
)braket
dot
id|drv_options
op_assign
id|drv_pattern
(braket
id|j
)braket
suffix:semicolon
r_if
c_cond
(paren
id|fam0L_drive
)paren
id|D_S
(braket
id|d
)braket
dot
id|drv_options
op_and_assign
op_complement
(paren
id|speed_auto
op_or
id|speed_300
op_or
id|speed_150
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;Drive %d (ID=%d): %.9s (%.4s) at 0x%03X (type %d)&bslash;n&quot;
comma
id|d
comma
id|D_S
(braket
id|d
)braket
dot
id|drv_id
comma
id|D_S
(braket
id|d
)braket
dot
id|drive_model
comma
id|D_S
(braket
id|d
)braket
dot
id|firmware_version
comma
id|CDo_command
comma
id|sbpro_type
)paren
suffix:semicolon
id|ndrives
op_increment
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|j
op_assign
id|ndrives
suffix:semicolon
id|j
OL
id|NR_SBPCD
suffix:semicolon
id|j
op_increment
)paren
id|D_S
(braket
id|j
)braket
dot
id|drv_id
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ndrives
op_eq
l_int|0
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
macro_line|#if FUTURE
multiline_comment|/*&n; *  obtain if requested service disturbs current audio state&n; */
DECL|function|obey_audio_state
r_static
r_int
id|obey_audio_state
c_func
(paren
id|u_char
id|audio_state
comma
id|u_char
id|func
comma
id|u_char
id|subfunc
)paren
(brace
r_switch
c_cond
(paren
id|audio_state
)paren
multiline_comment|/* audio status from controller  */
(brace
r_case
id|aud_11
suffix:colon
multiline_comment|/* &quot;audio play in progress&quot; */
r_case
id|audx11
suffix:colon
r_switch
c_cond
(paren
id|func
)paren
multiline_comment|/* DOS command code */
(brace
r_case
id|cmd_07
suffix:colon
multiline_comment|/* input flush  */
r_case
id|cmd_0d
suffix:colon
multiline_comment|/* open device  */
r_case
id|cmd_0e
suffix:colon
multiline_comment|/* close device */
r_case
id|cmd_0c
suffix:colon
multiline_comment|/* ioctl output */
r_return
(paren
l_int|1
)paren
suffix:semicolon
r_case
id|cmd_03
suffix:colon
multiline_comment|/* ioctl input  */
r_switch
c_cond
(paren
id|subfunc
)paren
multiline_comment|/* DOS ioctl input subfunction */
(brace
r_case
id|cxi_00
suffix:colon
r_case
id|cxi_06
suffix:colon
r_case
id|cxi_09
suffix:colon
r_return
(paren
l_int|1
)paren
suffix:semicolon
r_default
suffix:colon
r_return
(paren
id|ERROR15
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
r_default
suffix:colon
r_return
(paren
id|ERROR15
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
r_case
id|aud_12
suffix:colon
multiline_comment|/* &quot;audio play paused&quot;      */
r_case
id|audx12
suffix:colon
r_return
(paren
l_int|1
)paren
suffix:semicolon
r_default
suffix:colon
r_return
(paren
l_int|2
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/* allowed is only&n; * ioctl_o, flush_input, open_device, close_device, &n; * tell_address, tell_volume, tell_capabiliti,&n; * tell_framesize, tell_CD_changed, tell_audio_posi&n; */
DECL|function|check_allowed1
r_static
r_int
id|check_allowed1
c_func
(paren
id|u_char
id|func1
comma
id|u_char
id|func2
)paren
(brace
macro_line|#if 000
r_if
c_cond
(paren
id|func1
op_eq
id|ioctl_o
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_eq
id|read_long
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_eq
id|read_long_prefetch
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_eq
id|seek
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_eq
id|audio_play
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_eq
id|audio_pause
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_eq
id|audio_resume
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_ne
id|ioctl_i
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func2
op_eq
id|tell_SubQ_run_tot
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func2
op_eq
id|tell_cdsize
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func2
op_eq
id|tell_TocDescrip
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func2
op_eq
id|tell_TocEntry
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func2
op_eq
id|tell_subQ_info
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fam1_drive
)paren
r_if
c_cond
(paren
id|func2
op_eq
id|tell_SubChanInfo
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func2
op_eq
id|tell_UPC
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
macro_line|#else
r_return
(paren
l_int|0
)paren
suffix:semicolon
macro_line|#endif 000
)brace
multiline_comment|/*==========================================================================*/
DECL|function|check_allowed2
r_static
r_int
id|check_allowed2
c_func
(paren
id|u_char
id|func1
comma
id|u_char
id|func2
)paren
(brace
macro_line|#if 000
r_if
c_cond
(paren
id|func1
op_eq
id|read_long
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_eq
id|read_long_prefetch
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_eq
id|seek
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_eq
id|audio_play
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_ne
id|ioctl_o
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fam1_drive
)paren
(brace
r_if
c_cond
(paren
id|func2
op_eq
id|EjectDisk
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func2
op_eq
id|CloseTray
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#else
r_return
(paren
l_int|0
)paren
suffix:semicolon
macro_line|#endif 000
)brace
multiline_comment|/*==========================================================================*/
DECL|function|check_allowed3
r_static
r_int
id|check_allowed3
c_func
(paren
id|u_char
id|func1
comma
id|u_char
id|func2
)paren
(brace
macro_line|#if 000
r_if
c_cond
(paren
id|func1
op_eq
id|ioctl_i
)paren
(brace
r_if
c_cond
(paren
id|func2
op_eq
id|tell_address
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func2
op_eq
id|tell_capabiliti
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func2
op_eq
id|tell_CD_changed
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fam0L_drive
)paren
r_if
c_cond
(paren
id|func2
op_eq
id|tell_SubChanInfo
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|func1
op_eq
id|ioctl_o
)paren
(brace
r_if
c_cond
(paren
id|func2
op_eq
id|DriveReset
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fam0L_drive
)paren
(brace
r_if
c_cond
(paren
id|func2
op_eq
id|EjectDisk
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func2
op_eq
id|LockDoor
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func2
op_eq
id|CloseTray
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|func1
op_eq
id|flush_input
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_eq
id|read_long
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_eq
id|read_long_prefetch
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_eq
id|seek
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_eq
id|audio_play
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_eq
id|audio_pause
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_eq
id|audio_resume
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
macro_line|#else
r_return
(paren
l_int|0
)paren
suffix:semicolon
macro_line|#endif 000
)brace
multiline_comment|/*==========================================================================*/
DECL|function|seek_pos_audio_end
r_static
r_int
id|seek_pos_audio_end
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|i
op_assign
id|msf2blk
c_func
(paren
id|D_S
(braket
id|d
)braket
dot
id|pos_audio_end
)paren
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|i
op_assign
id|cc_Seek
c_func
(paren
id|i
comma
l_int|0
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
macro_line|#endif FUTURE
multiline_comment|/*==========================================================================*/
DECL|function|ReadToC
r_static
r_int
id|ReadToC
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|diskstate_flags
op_and_assign
op_complement
id|toc_bit
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|ored_ctl_adr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* special handling of CD-I HE */
r_if
c_cond
(paren
(paren
id|D_S
(braket
id|d
)braket
dot
id|n_first_track
op_eq
l_int|2
op_logical_and
id|D_S
(braket
id|d
)braket
dot
id|n_last_track
op_eq
l_int|2
)paren
op_logical_or
id|D_S
(braket
id|d
)braket
dot
id|xa_byte
op_eq
l_int|0x10
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|TocBuffer
(braket
l_int|1
)braket
dot
id|nixbyte
op_assign
l_int|0
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|TocBuffer
(braket
l_int|1
)braket
dot
id|ctl_adr
op_assign
l_int|0x40
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|TocBuffer
(braket
l_int|1
)braket
dot
id|number
op_assign
l_int|1
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|TocBuffer
(braket
l_int|1
)braket
dot
id|format
op_assign
l_int|0
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|TocBuffer
(braket
l_int|1
)braket
dot
id|address
op_assign
id|blk2msf
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|ored_ctl_adr
op_or_assign
l_int|0x40
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|n_first_track
op_assign
l_int|1
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|n_last_track
op_assign
l_int|1
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|xa_byte
op_assign
l_int|0x10
suffix:semicolon
id|j
op_assign
l_int|2
suffix:semicolon
)brace
r_else
r_for
c_loop
(paren
id|j
op_assign
id|D_S
(braket
id|d
)braket
dot
id|n_first_track
suffix:semicolon
id|j
op_le
id|D_S
(braket
id|d
)braket
dot
id|n_last_track
suffix:semicolon
id|j
op_increment
)paren
(brace
id|i
op_assign
id|cc_ReadTocEntry
c_func
(paren
id|j
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;cc_ReadTocEntry(%d) returns %d.&bslash;n&quot;
comma
id|j
comma
id|i
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
id|D_S
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|j
)braket
dot
id|nixbyte
op_assign
id|D_S
(braket
id|d
)braket
dot
id|TocEnt_nixbyte
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|j
)braket
dot
id|ctl_adr
op_assign
id|D_S
(braket
id|d
)braket
dot
id|TocEnt_ctl_adr
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|j
)braket
dot
id|number
op_assign
id|D_S
(braket
id|d
)braket
dot
id|TocEnt_number
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|j
)braket
dot
id|format
op_assign
id|D_S
(braket
id|d
)braket
dot
id|TocEnt_format
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|j
)braket
dot
id|address
op_assign
id|D_S
(braket
id|d
)braket
dot
id|TocEnt_address
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|ored_ctl_adr
op_or_assign
id|D_S
(braket
id|d
)braket
dot
id|TocEnt_ctl_adr
suffix:semicolon
)brace
multiline_comment|/* fake entry for LeadOut Track */
id|D_S
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|j
)braket
dot
id|nixbyte
op_assign
l_int|0
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|j
)braket
dot
id|ctl_adr
op_assign
l_int|0
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|j
)braket
dot
id|number
op_assign
id|CDROM_LEADOUT
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|j
)braket
dot
id|format
op_assign
l_int|0
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|j
)braket
dot
id|address
op_assign
id|D_S
(braket
id|d
)braket
dot
id|size_msf
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|diskstate_flags
op_or_assign
id|toc_bit
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|DiskInfo
r_static
r_int
id|DiskInfo
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|mode
op_assign
id|READ_M1
suffix:semicolon
DECL|macro|LOOP_COUNT
macro_line|#undef LOOP_COUNT
DECL|macro|LOOP_COUNT
mdefine_line|#define LOOP_COUNT 10 /* needed for some &quot;old&quot; drives */
id|msg
c_func
(paren
id|DBG_000
comma
l_string|&quot;DiskInfo entered.&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|1
suffix:semicolon
id|j
OL
id|LOOP_COUNT
suffix:semicolon
id|j
op_increment
)paren
(brace
macro_line|#if 0
id|i
op_assign
id|SetSpeed
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;DiskInfo: SetSpeed returns %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|i
op_assign
id|cc_ModeSense
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;DiskInfo: cc_ModeSense returns %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
macro_line|#endif
id|i
op_assign
id|cc_ReadCapacity
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
l_int|0
)paren
r_break
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;DiskInfo: ReadCapacity #%d returns %d&bslash;n&quot;
comma
id|j
comma
id|i
)paren
suffix:semicolon
macro_line|#if 0
id|i
op_assign
id|cc_DriveReset
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|fam0_drive
op_logical_and
id|j
op_eq
l_int|2
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|j
op_eq
id|LOOP_COUNT
)paren
r_return
(paren
op_minus
l_int|33
)paren
suffix:semicolon
multiline_comment|/* give up */
id|i
op_assign
id|cc_ReadTocDescr
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;DiskInfo: ReadTocDescr returns %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
id|i
op_assign
id|ReadToC
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;DiskInfo: ReadToC returns %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
id|i
op_assign
id|cc_CheckMultiSession
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;DiskInfo: cc_CheckMultiSession returns %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|f_multisession
)paren
id|D_S
(braket
id|d
)braket
dot
id|sbp_bufsiz
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* possibly a weird PhotoCD */
r_else
id|D_S
(braket
id|d
)braket
dot
id|sbp_bufsiz
op_assign
id|buffers
suffix:semicolon
id|i
op_assign
id|cc_ReadTocEntry
c_func
(paren
id|D_S
(braket
id|d
)braket
dot
id|n_first_track
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;DiskInfo: cc_ReadTocEntry(1) returns %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
id|i
op_assign
id|cc_ReadUPC
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;DiskInfo: cc_ReadUPC returns %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|fam0L_drive
)paren
op_logical_and
(paren
id|D_S
(braket
id|d
)braket
dot
id|xa_byte
op_eq
l_int|0x20
op_logical_or
id|D_S
(braket
id|d
)braket
dot
id|xa_byte
op_eq
l_int|0x10
)paren
)paren
(brace
multiline_comment|/* XA disk with old drive */
id|cc_ModeSelect
c_func
(paren
id|CD_FRAMESIZE_RAW1
)paren
suffix:semicolon
id|cc_ModeSense
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|famT_drive
)paren
id|cc_prep_mode_T
c_func
(paren
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_000
comma
l_string|&quot;DiskInfo done.&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|sbpcd_drive_status
r_static
r_int
id|sbpcd_drive_status
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
comma
r_int
id|slot_nr
)paren
(brace
r_int
id|st
suffix:semicolon
r_if
c_cond
(paren
id|CDSL_CURRENT
op_ne
id|slot_nr
)paren
(brace
multiline_comment|/* we have no changer support */
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|cc_ReadStatus
c_func
(paren
)paren
suffix:semicolon
id|st
op_assign
id|ResponseStatus
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st
OL
l_int|0
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;sbpcd_drive_status: timeout.&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|msg
c_func
(paren
id|DBG_000
comma
l_string|&quot;Drive Status: door_locked =%d.&bslash;n&quot;
comma
id|st_door_locked
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_000
comma
l_string|&quot;Drive Status: door_closed =%d.&bslash;n&quot;
comma
id|st_door_closed
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_000
comma
l_string|&quot;Drive Status: caddy_in =%d.&bslash;n&quot;
comma
id|st_caddy_in
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_000
comma
l_string|&quot;Drive Status: disk_ok =%d.&bslash;n&quot;
comma
id|st_diskok
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_000
comma
l_string|&quot;Drive Status: spinning =%d.&bslash;n&quot;
comma
id|st_spinning
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_000
comma
l_string|&quot;Drive Status: busy =%d.&bslash;n&quot;
comma
id|st_busy
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
op_logical_neg
(paren
id|D_S
(braket
id|MINOR
c_func
(paren
id|cdi-&gt;dev
)paren
)braket
dot
id|status_bits
op_amp
id|p_door_closed
)paren
)paren
r_return
id|CDS_TRAY_OPEN
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|MINOR
c_func
(paren
id|cdi-&gt;dev
)paren
)braket
dot
id|status_bits
op_amp
id|p_disk_ok
)paren
r_return
id|CDS_DISC_OK
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|MINOR
c_func
(paren
id|cdi-&gt;dev
)paren
)braket
dot
id|status_bits
op_amp
id|p_disk_in
)paren
r_return
id|CDS_DRIVE_NOT_READY
suffix:semicolon
r_return
id|CDS_NO_DISC
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|D_S
(braket
id|MINOR
c_func
(paren
id|cdi-&gt;dev
)paren
)braket
dot
id|status_bits
op_amp
id|p_spinning
)paren
r_return
id|CDS_DISC_OK
suffix:semicolon
multiline_comment|/*  return CDS_TRAY_OPEN; */
r_return
id|CDS_NO_DISC
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*==========================================================================*/
macro_line|#if FUTURE
multiline_comment|/*&n; *  called always if driver gets entered&n; *  returns 0 or ERROR2 or ERROR15&n; */
DECL|function|prepare
r_static
r_int
id|prepare
c_func
(paren
id|u_char
id|func
comma
id|u_char
id|subfunc
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|fam0L_drive
)paren
(brace
id|i
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_amp
id|s_attention
)paren
id|GetStatus
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam1_drive
)paren
id|GetStatus
c_func
(paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|fam2_drive
)paren
id|GetStatus
c_func
(paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
id|GetStatus
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|CD_changed
op_eq
l_int|0xFF
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|diskstate_flags
op_assign
l_int|0
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|audio_state
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|st_diskok
)paren
(brace
id|i
op_assign
id|check_allowed1
c_func
(paren
id|func
comma
id|subfunc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
op_minus
l_int|2
)paren
suffix:semicolon
)brace
r_else
(brace
id|i
op_assign
id|check_allowed3
c_func
(paren
id|func
comma
id|subfunc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|CD_changed
op_assign
l_int|1
suffix:semicolon
r_return
(paren
op_minus
l_int|15
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|st_diskok
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|diskstate_flags
op_assign
l_int|0
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|audio_state
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|check_allowed1
c_func
(paren
id|func
comma
id|subfunc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
op_minus
l_int|2
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|st_busy
)paren
(brace
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|audio_state
op_ne
id|audio_pausing
)paren
(brace
id|i
op_assign
id|check_allowed2
c_func
(paren
id|func
comma
id|subfunc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
op_minus
l_int|2
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|audio_state
op_eq
id|audio_playing
)paren
id|seek_pos_audio_end
c_func
(paren
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|audio_state
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|frame_size_valid
)paren
(brace
id|i
op_assign
id|DiskInfo
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|diskstate_flags
op_assign
l_int|0
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|audio_state
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|check_allowed1
c_func
(paren
id|func
comma
id|subfunc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
op_minus
l_int|2
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif FUTURE
multiline_comment|/*==========================================================================*/
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; * Check the results of the &quot;get status&quot; command.&n; */
DECL|function|sbp_status
r_static
r_int
id|sbp_status
c_func
(paren
r_void
)paren
(brace
r_int
id|st
suffix:semicolon
id|st
op_assign
id|ResponseStatus
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st
OL
l_int|0
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;sbp_status: timeout.&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|st_spinning
)paren
id|msg
c_func
(paren
id|DBG_SPI
comma
l_string|&quot;motor got off - ignoring.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st_check
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;st_check detected - retrying.&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|st_door_closed
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;door is open - retrying.&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|st_caddy_in
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;disk removed - retrying.&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|st_diskok
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;!st_diskok detected - retrying.&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|st_busy
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;st_busy detected - retrying.&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|sbpcd_get_last_session
r_static
r_int
id|sbpcd_get_last_session
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
comma
r_struct
id|cdrom_multisession
op_star
id|ms_infp
)paren
(brace
id|ms_infp-&gt;addr_format
op_assign
id|CDROM_LBA
suffix:semicolon
id|ms_infp-&gt;addr.lba
op_assign
id|D_S
(braket
id|MINOR
c_func
(paren
id|cdi-&gt;dev
)paren
)braket
dot
id|lba_multi
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|MINOR
c_func
(paren
id|cdi-&gt;dev
)paren
)braket
dot
id|f_multisession
)paren
id|ms_infp-&gt;xa_flag
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* valid redirection address */
r_else
id|ms_infp-&gt;xa_flag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* invalid redirection address */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; * ioctl support&n; */
DECL|function|sbpcd_dev_ioctl
r_static
r_int
id|sbpcd_dev_ioctl
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
comma
id|u_int
id|cmd
comma
id|u_long
id|arg
)paren
(brace
r_int
id|i
suffix:semicolon
id|msg
c_func
(paren
id|DBG_IO2
comma
l_string|&quot;ioctl(%d, 0x%08lX, 0x%08lX)&bslash;n&quot;
comma
id|MINOR
c_func
(paren
id|cdi-&gt;dev
)paren
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
id|i
op_assign
id|MINOR
c_func
(paren
id|cdi-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
OL
l_int|0
)paren
op_logical_or
(paren
id|i
op_ge
id|NR_SBPCD
)paren
op_logical_or
(paren
id|D_S
(braket
id|i
)braket
dot
id|drv_id
op_eq
op_minus
l_int|1
)paren
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;ioctl: bad device: %04X&bslash;n&quot;
comma
id|cdi-&gt;dev
)paren
suffix:semicolon
r_return
(paren
op_minus
id|ENXIO
)paren
suffix:semicolon
multiline_comment|/* no such drive */
)brace
id|down
c_func
(paren
op_amp
id|ioctl_read_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d
op_ne
id|i
)paren
id|switch_drive
c_func
(paren
id|i
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_IO2
comma
l_string|&quot;ioctl: device %d, request %04X&bslash;n&quot;
comma
id|i
comma
id|cmd
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
multiline_comment|/* Sun-compatible */
(brace
r_case
id|DDIOCSDBG
suffix:colon
multiline_comment|/* DDI Debug */
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
id|RETURN_UP
c_func
(paren
op_minus
id|EPERM
)paren
suffix:semicolon
id|i
op_assign
id|sbpcd_dbg_ioctl
c_func
(paren
id|arg
comma
l_int|1
)paren
suffix:semicolon
id|RETURN_UP
c_func
(paren
id|i
)paren
suffix:semicolon
r_case
id|CDROMRESET
suffix:colon
multiline_comment|/* hard reset the drive */
id|msg
c_func
(paren
id|DBG_IOC
comma
l_string|&quot;ioctl: CDROMRESET entered.&bslash;n&quot;
)paren
suffix:semicolon
id|i
op_assign
id|DriveReset
c_func
(paren
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|audio_state
op_assign
l_int|0
suffix:semicolon
id|RETURN_UP
c_func
(paren
id|i
)paren
suffix:semicolon
r_case
id|CDROMREADMODE1
suffix:colon
id|msg
c_func
(paren
id|DBG_IOC
comma
l_string|&quot;ioctl: CDROMREADMODE1 requested.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if SAFE_MIXED
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|has_data
OG
l_int|1
)paren
id|RETURN_UP
c_func
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
macro_line|#endif SAFE_MIXED
id|cc_ModeSelect
c_func
(paren
id|CD_FRAMESIZE
)paren
suffix:semicolon
id|cc_ModeSense
c_func
(paren
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|mode
op_assign
id|READ_M1
suffix:semicolon
id|RETURN_UP
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|CDROMREADMODE2
suffix:colon
multiline_comment|/* not usable at the moment */
id|msg
c_func
(paren
id|DBG_IOC
comma
l_string|&quot;ioctl: CDROMREADMODE2 requested.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if SAFE_MIXED
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|has_data
OG
l_int|1
)paren
id|RETURN_UP
c_func
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
macro_line|#endif SAFE_MIXED
id|cc_ModeSelect
c_func
(paren
id|CD_FRAMESIZE_RAW1
)paren
suffix:semicolon
id|cc_ModeSense
c_func
(paren
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|mode
op_assign
id|READ_M2
suffix:semicolon
id|RETURN_UP
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|CDROMAUDIOBUFSIZ
suffix:colon
multiline_comment|/* configure the audio buffer size */
id|msg
c_func
(paren
id|DBG_IOC
comma
l_string|&quot;ioctl: CDROMAUDIOBUFSIZ entered.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|sbp_audsiz
OG
l_int|0
)paren
id|vfree
c_func
(paren
id|D_S
(braket
id|d
)braket
dot
id|aud_buf
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|aud_buf
op_assign
l_int|NULL
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|sbp_audsiz
op_assign
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|sbp_audsiz
OG
l_int|0
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|aud_buf
op_assign
(paren
id|u_char
op_star
)paren
id|vmalloc
c_func
(paren
id|D_S
(braket
id|d
)braket
dot
id|sbp_audsiz
op_star
id|CD_FRAMESIZE_RAW
)paren
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|aud_buf
op_eq
l_int|NULL
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;audio buffer (%d frames) not available.&bslash;n&quot;
comma
id|D_S
(braket
id|d
)braket
dot
id|sbp_audsiz
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|sbp_audsiz
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;audio buffer size: %d frames.&bslash;n&quot;
comma
id|D_S
(braket
id|d
)braket
dot
id|sbp_audsiz
)paren
suffix:semicolon
)brace
id|RETURN_UP
c_func
(paren
id|D_S
(braket
id|d
)braket
dot
id|sbp_audsiz
)paren
suffix:semicolon
r_case
id|CDROMREADAUDIO
suffix:colon
(brace
multiline_comment|/* start of CDROMREADAUDIO */
r_int
id|i
op_assign
l_int|0
comma
id|j
op_assign
l_int|0
comma
id|frame
comma
id|block
op_assign
l_int|0
suffix:semicolon
id|u_int
r_try
op_assign
l_int|0
suffix:semicolon
id|u_long
id|timeout
suffix:semicolon
id|u_char
op_star
id|p
suffix:semicolon
id|u_int
id|data_tries
op_assign
l_int|0
suffix:semicolon
id|u_int
id|data_waits
op_assign
l_int|0
suffix:semicolon
id|u_int
id|data_retrying
op_assign
l_int|0
suffix:semicolon
r_int
id|status_tries
suffix:semicolon
r_int
id|error_flag
suffix:semicolon
id|msg
c_func
(paren
id|DBG_IOC
comma
l_string|&quot;ioctl: CDROMREADAUDIO entered.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fam0_drive
)paren
id|RETURN_UP
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|famL_drive
)paren
id|RETURN_UP
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|famV_drive
)paren
id|RETURN_UP
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|famT_drive
)paren
id|RETURN_UP
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
macro_line|#if SAFE_MIXED
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|has_data
OG
l_int|1
)paren
id|RETURN_UP
c_func
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
macro_line|#endif SAFE_MIXED
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|aud_buf
op_eq
l_int|NULL
)paren
id|RETURN_UP
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|cdrom_read_audio
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
id|RETURN_UP
c_func
(paren
id|i
)paren
suffix:semicolon
id|copy_from_user
c_func
(paren
op_amp
id|read_audio
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|cdrom_read_audio
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read_audio.nframes
OG
id|D_S
(braket
id|d
)braket
dot
id|sbp_audsiz
)paren
id|RETURN_UP
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|read_audio.buf
comma
id|read_audio.nframes
op_star
id|CD_FRAMESIZE_RAW
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
id|RETURN_UP
c_func
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read_audio.addr_format
op_eq
id|CDROM_MSF
)paren
multiline_comment|/* MSF-bin specification of where to start */
id|block
op_assign
id|msf2lba
c_func
(paren
op_amp
id|read_audio.addr.msf.minute
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|read_audio.addr_format
op_eq
id|CDROM_LBA
)paren
multiline_comment|/* lba specification of where to start */
id|block
op_assign
id|read_audio.addr.lba
suffix:semicolon
r_else
id|RETURN_UP
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
macro_line|#if 000
id|i
op_assign
id|cc_SetSpeed
c_func
(paren
id|speed_150
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
id|msg
c_func
(paren
id|DBG_AUD
comma
l_string|&quot;read_audio: SetSpeed error %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
macro_line|#endif
id|msg
c_func
(paren
id|DBG_AUD
comma
l_string|&quot;read_audio: lba: %d, msf: %06X&bslash;n&quot;
comma
id|block
comma
id|blk2msf
c_func
(paren
id|block
)paren
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_AUD
comma
l_string|&quot;read_audio: before cc_ReadStatus.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if OLD_BUSY
r_while
c_loop
(paren
id|busy_data
)paren
id|sbp_sleep
c_func
(paren
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
multiline_comment|/* wait a bit */
id|busy_audio
op_assign
l_int|1
suffix:semicolon
macro_line|#endif OLD_BUSY
id|error_flag
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|data_tries
op_assign
l_int|5
suffix:semicolon
id|data_tries
OG
l_int|0
suffix:semicolon
id|data_tries
op_decrement
)paren
(brace
id|msg
c_func
(paren
id|DBG_AUD
comma
l_string|&quot;data_tries=%d ...&bslash;n&quot;
comma
id|data_tries
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|mode
op_assign
id|READ_AU
suffix:semicolon
id|cc_ModeSelect
c_func
(paren
id|CD_FRAMESIZE_RAW
)paren
suffix:semicolon
id|cc_ModeSense
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|status_tries
op_assign
l_int|3
suffix:semicolon
id|status_tries
OG
l_int|0
suffix:semicolon
id|status_tries
op_decrement
)paren
(brace
id|flags_cmd_out
op_or_assign
id|f_respo3
suffix:semicolon
id|cc_ReadStatus
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbp_status
c_func
(paren
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|st_check
)paren
id|cc_ReadError
c_func
(paren
)paren
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* wait a bit, try again */
)brace
r_if
c_cond
(paren
id|status_tries
op_eq
l_int|0
)paren
(brace
id|msg
c_func
(paren
id|DBG_AUD
comma
l_string|&quot;read_audio: sbp_status: failed after 3 tries in line %d.&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|msg
c_func
(paren
id|DBG_AUD
comma
l_string|&quot;read_audio: sbp_status: ok.&bslash;n&quot;
)paren
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
r_if
c_cond
(paren
id|fam0L_drive
)paren
(brace
id|flags_cmd_out
op_or_assign
id|f_lopsta
op_or
id|f_getsta
op_or
id|f_bit1
suffix:semicolon
id|cmd_type
op_assign
id|READ_M2
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD0_READ_XA
suffix:semicolon
multiline_comment|/* &quot;read XA frames&quot;, old drives */
id|drvcmd
(braket
l_int|1
)braket
op_assign
(paren
id|block
op_rshift
l_int|16
)paren
op_amp
l_int|0x000000ff
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
(paren
id|block
op_rshift
l_int|8
)paren
op_amp
l_int|0x000000ff
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
id|block
op_amp
l_int|0x000000ff
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|drvcmd
(braket
l_int|5
)braket
op_assign
id|read_audio.nframes
suffix:semicolon
multiline_comment|/* # of frames */
id|drvcmd
(braket
l_int|6
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam1_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD1_READ
suffix:semicolon
multiline_comment|/* &quot;read frames&quot;, new drives */
id|lba2msf
c_func
(paren
id|block
comma
op_amp
id|drvcmd
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/* msf-bin format required */
id|drvcmd
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|drvcmd
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
id|drvcmd
(braket
l_int|6
)braket
op_assign
id|read_audio.nframes
suffix:semicolon
multiline_comment|/* # of frames */
)brace
r_else
r_if
c_cond
(paren
id|fam2_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD2_READ_XA2
suffix:semicolon
id|lba2msf
c_func
(paren
id|block
comma
op_amp
id|drvcmd
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/* msf-bin format required */
id|drvcmd
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|drvcmd
(braket
l_int|5
)braket
op_assign
id|read_audio.nframes
suffix:semicolon
multiline_comment|/* # of frames */
id|drvcmd
(braket
l_int|6
)braket
op_assign
l_int|0x11
suffix:semicolon
multiline_comment|/* raw mode */
)brace
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
multiline_comment|/* CD-55A: not tested yet */
(brace
)brace
id|msg
c_func
(paren
id|DBG_AUD
comma
l_string|&quot;read_audio: before giving &bslash;&quot;read&bslash;&quot; command.&bslash;n&quot;
)paren
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
id|response_count
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;error giving READ AUDIO command: %0d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_AUD
comma
l_string|&quot;read_audio: after giving &bslash;&quot;read&bslash;&quot; command.&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|frame
op_assign
l_int|1
suffix:semicolon
id|frame
OL
l_int|2
op_logical_and
op_logical_neg
id|error_flag
suffix:semicolon
id|frame
op_increment
)paren
(brace
r_try
op_assign
id|maxtim_data
suffix:semicolon
r_for
c_loop
(paren
id|timeout
op_assign
id|jiffies
op_plus
l_int|9
op_star
id|HZ
suffix:semicolon
suffix:semicolon
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
r_try
op_ne
l_int|0
suffix:semicolon
r_try
op_decrement
)paren
(brace
id|j
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|j
op_amp
id|s_not_data_ready
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|j
op_amp
id|s_not_result_ready
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|fam0L_drive
)paren
r_if
c_cond
(paren
id|j
op_amp
id|s_attention
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
r_try
op_ne
l_int|0
op_logical_or
id|time_after_eq
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|data_retrying
op_eq
l_int|0
)paren
id|data_waits
op_increment
suffix:semicolon
id|data_retrying
op_assign
l_int|1
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_try
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
r_try
op_eq
l_int|0
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;read_audio: sbp_data: CDi_status timeout.&bslash;n&quot;
)paren
suffix:semicolon
id|error_flag
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
id|msg
c_func
(paren
id|DBG_AUD
comma
l_string|&quot;read_audio: sbp_data: CDi_status ok.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|j
op_amp
id|s_not_data_ready
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;read_audio: sbp_data: DATA_READY timeout.&bslash;n&quot;
)paren
suffix:semicolon
id|error_flag
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
id|msg
c_func
(paren
id|DBG_AUD
comma
l_string|&quot;read_audio: before reading data.&bslash;n&quot;
)paren
suffix:semicolon
id|error_flag
op_assign
l_int|0
suffix:semicolon
id|p
op_assign
id|D_S
(braket
id|d
)braket
dot
id|aud_buf
suffix:semicolon
r_if
c_cond
(paren
id|sbpro_type
op_eq
l_int|1
)paren
id|OUT
c_func
(paren
id|CDo_sel_i_d
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|do_16bit
)paren
(brace
id|u_short
op_star
id|p2
op_assign
(paren
id|u_short
op_star
)paren
id|p
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
(paren
id|u_char
op_star
)paren
id|p2
OL
id|D_S
(braket
id|d
)braket
dot
id|aud_buf
op_plus
id|read_audio.nframes
op_star
id|CD_FRAMESIZE_RAW
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
(paren
id|inb_p
c_func
(paren
id|CDi_status
)paren
op_amp
id|s_not_data_ready
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* get one sample */
op_star
id|p2
op_increment
op_assign
id|inw_p
c_func
(paren
id|CDi_data
)paren
suffix:semicolon
op_star
id|p2
op_increment
op_assign
id|inw_p
c_func
(paren
id|CDi_data
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_for
c_loop
(paren
suffix:semicolon
id|p
OL
id|D_S
(braket
id|d
)braket
dot
id|aud_buf
op_plus
id|read_audio.nframes
op_star
id|CD_FRAMESIZE_RAW
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
(paren
id|inb_p
c_func
(paren
id|CDi_status
)paren
op_amp
id|s_not_data_ready
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* get one sample */
op_star
id|p
op_increment
op_assign
id|inb_p
c_func
(paren
id|CDi_data
)paren
suffix:semicolon
op_star
id|p
op_increment
op_assign
id|inb_p
c_func
(paren
id|CDi_data
)paren
suffix:semicolon
op_star
id|p
op_increment
op_assign
id|inb_p
c_func
(paren
id|CDi_data
)paren
suffix:semicolon
op_star
id|p
op_increment
op_assign
id|inb_p
c_func
(paren
id|CDi_data
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|sbpro_type
op_eq
l_int|1
)paren
id|OUT
c_func
(paren
id|CDo_sel_i_d
comma
l_int|0
)paren
suffix:semicolon
id|data_retrying
op_assign
l_int|0
suffix:semicolon
)brace
id|msg
c_func
(paren
id|DBG_AUD
comma
l_string|&quot;read_audio: after reading data.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error_flag
)paren
multiline_comment|/* must have been spurious D_RDY or (ATTN&amp;&amp;!D_RDY) */
(brace
id|msg
c_func
(paren
id|DBG_AUD
comma
l_string|&quot;read_audio: read aborted by drive&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if 0000
id|i
op_assign
id|cc_DriveReset
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* ugly fix to prevent a hang */
macro_line|#else
id|i
op_assign
id|cc_ReadError
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif 0000
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fam0L_drive
)paren
(brace
id|i
op_assign
id|maxtim_data
suffix:semicolon
r_for
c_loop
(paren
id|timeout
op_assign
id|jiffies
op_plus
l_int|9
op_star
id|HZ
suffix:semicolon
id|time_before
c_func
(paren
id|jiffies
comma
id|timeout
)paren
suffix:semicolon
id|timeout
op_decrement
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
id|i
op_ne
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|j
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|j
op_amp
id|s_not_data_ready
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|j
op_amp
id|s_not_result_ready
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|j
op_amp
id|s_attention
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ne
l_int|0
op_logical_or
id|time_after_eq
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
r_break
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|i
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
id|msg
c_func
(paren
id|DBG_AUD
comma
l_string|&quot;read_audio: STATUS TIMEOUT AFTER READ&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|j
op_amp
id|s_attention
)paren
)paren
(brace
id|msg
c_func
(paren
id|DBG_AUD
comma
l_string|&quot;read_audio: sbp_data: timeout waiting DRV_ATTN - retrying&bslash;n&quot;
)paren
suffix:semicolon
id|i
op_assign
id|cc_DriveReset
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* ugly fix to prevent a hang */
r_continue
suffix:semicolon
)brace
)brace
r_do
(brace
r_if
c_cond
(paren
id|fam0L_drive
)paren
id|cc_ReadStatus
c_func
(paren
)paren
suffix:semicolon
id|i
op_assign
id|ResponseStatus
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* builds status_bits, returns orig. status (old) or faked p_success (new) */
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|msg
c_func
(paren
id|DBG_AUD
comma
l_string|&quot;read_audio: cc_ReadStatus error after read: %02X&bslash;n&quot;
comma
id|D_S
(braket
id|d
)braket
dot
id|status_bits
)paren
suffix:semicolon
r_continue
suffix:semicolon
multiline_comment|/* FIXME */
)brace
)brace
r_while
c_loop
(paren
(paren
id|fam0L_drive
)paren
op_logical_and
(paren
op_logical_neg
id|st_check
)paren
op_logical_and
(paren
op_logical_neg
(paren
id|i
op_amp
id|p_success
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st_check
)paren
(brace
id|i
op_assign
id|cc_ReadError
c_func
(paren
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_AUD
comma
l_string|&quot;read_audio: cc_ReadError was necessary after read: %02X&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|copy_to_user
c_func
(paren
(paren
id|u_char
op_star
)paren
id|read_audio.buf
comma
(paren
id|u_char
op_star
)paren
id|D_S
(braket
id|d
)braket
dot
id|aud_buf
comma
id|read_audio.nframes
op_star
id|CD_FRAMESIZE_RAW
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_AUD
comma
l_string|&quot;read_audio: copy_to_user done.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|cc_ModeSelect
c_func
(paren
id|CD_FRAMESIZE
)paren
suffix:semicolon
id|cc_ModeSense
c_func
(paren
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|mode
op_assign
id|READ_M1
suffix:semicolon
macro_line|#if OLD_BUSY
id|busy_audio
op_assign
l_int|0
suffix:semicolon
macro_line|#endif OLD_BUSY
r_if
c_cond
(paren
id|data_tries
op_eq
l_int|0
)paren
(brace
id|msg
c_func
(paren
id|DBG_AUD
comma
l_string|&quot;read_audio: failed after 5 tries in line %d.&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
id|RETURN_UP
c_func
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|msg
c_func
(paren
id|DBG_AUD
comma
l_string|&quot;read_audio: successful return.&bslash;n&quot;
)paren
suffix:semicolon
id|RETURN_UP
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* end of CDROMREADAUDIO */
r_case
id|BLKRASET
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
(brace
id|RETURN_UP
c_func
(paren
op_minus
id|EACCES
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|cdi-&gt;dev
)paren
)paren
(brace
id|RETURN_UP
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|arg
OG
l_int|0xff
)paren
(brace
id|RETURN_UP
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
id|read_ahead
(braket
id|MAJOR
c_func
(paren
id|cdi-&gt;dev
)paren
)braket
op_assign
id|arg
suffix:semicolon
id|RETURN_UP
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_default
suffix:colon
id|msg
c_func
(paren
id|DBG_IOC
comma
l_string|&quot;ioctl: unknown function request %04X&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
id|RETURN_UP
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
multiline_comment|/* end switch(cmd) */
)brace
DECL|function|sbpcd_audio_ioctl
r_static
r_int
id|sbpcd_audio_ioctl
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
comma
id|u_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_int
id|i
comma
id|st
comma
id|j
suffix:semicolon
id|msg
c_func
(paren
id|DBG_IO2
comma
l_string|&quot;ioctl(%d, 0x%08lX, 0x%08p)&bslash;n&quot;
comma
id|MINOR
c_func
(paren
id|cdi-&gt;dev
)paren
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
id|i
op_assign
id|MINOR
c_func
(paren
id|cdi-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
OL
l_int|0
)paren
op_logical_or
(paren
id|i
op_ge
id|NR_SBPCD
)paren
op_logical_or
(paren
id|D_S
(braket
id|i
)braket
dot
id|drv_id
op_eq
op_minus
l_int|1
)paren
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;ioctl: bad device: %04X&bslash;n&quot;
comma
id|cdi-&gt;dev
)paren
suffix:semicolon
r_return
(paren
op_minus
id|ENXIO
)paren
suffix:semicolon
multiline_comment|/* no such drive */
)brace
id|down
c_func
(paren
op_amp
id|ioctl_read_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d
op_ne
id|i
)paren
id|switch_drive
c_func
(paren
id|i
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_IO2
comma
l_string|&quot;ioctl: device %d, request %04X&bslash;n&quot;
comma
id|i
comma
id|cmd
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
multiline_comment|/* Sun-compatible */
(brace
r_case
id|CDROMPAUSE
suffix:colon
multiline_comment|/* Pause the drive */
id|msg
c_func
(paren
id|DBG_IOC
comma
l_string|&quot;ioctl: CDROMPAUSE entered.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* pause the drive unit when it is currently in PLAY mode,         */
multiline_comment|/* or reset the starting and ending locations when in PAUSED mode. */
multiline_comment|/* If applicable, at the next stopping point it reaches            */
multiline_comment|/* the drive will discontinue playing.                             */
r_switch
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|audio_state
)paren
(brace
r_case
id|audio_playing
suffix:colon
r_if
c_cond
(paren
id|famL_drive
)paren
id|i
op_assign
id|cc_ReadSubQ
c_func
(paren
)paren
suffix:semicolon
r_else
id|i
op_assign
id|cc_Pause_Resume
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
id|RETURN_UP
c_func
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|famL_drive
)paren
id|i
op_assign
id|cc_Pause_Resume
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_else
id|i
op_assign
id|cc_ReadSubQ
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
id|RETURN_UP
c_func
(paren
op_minus
id|EIO
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|pos_audio_start
op_assign
id|D_S
(braket
id|d
)braket
dot
id|SubQ_run_tot
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|audio_state
op_assign
id|audio_pausing
suffix:semicolon
id|RETURN_UP
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|audio_pausing
suffix:colon
id|i
op_assign
id|cc_Seek
c_func
(paren
id|D_S
(braket
id|d
)braket
dot
id|pos_audio_start
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
id|RETURN_UP
c_func
(paren
op_minus
id|EIO
)paren
suffix:semicolon
id|RETURN_UP
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_default
suffix:colon
id|RETURN_UP
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
r_case
id|CDROMRESUME
suffix:colon
multiline_comment|/* resume paused audio play */
id|msg
c_func
(paren
id|DBG_IOC
comma
l_string|&quot;ioctl: CDROMRESUME entered.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* resume playing audio tracks when a previous PLAY AUDIO call has  */
multiline_comment|/* been paused with a PAUSE command.                                */
multiline_comment|/* It will resume playing from the location saved in SubQ_run_tot.  */
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|audio_state
op_ne
id|audio_pausing
)paren
id|RETURN_UP
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|famL_drive
)paren
id|i
op_assign
id|cc_PlayAudio
c_func
(paren
id|D_S
(braket
id|d
)braket
dot
id|pos_audio_start
comma
id|D_S
(braket
id|d
)braket
dot
id|pos_audio_end
)paren
suffix:semicolon
r_else
id|i
op_assign
id|cc_Pause_Resume
c_func
(paren
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
id|RETURN_UP
c_func
(paren
op_minus
id|EIO
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|audio_state
op_assign
id|audio_playing
suffix:semicolon
id|RETURN_UP
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|CDROMPLAYMSF
suffix:colon
id|msg
c_func
(paren
id|DBG_IOC
comma
l_string|&quot;ioctl: CDROMPLAYMSF entered.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if SAFE_MIXED
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|has_data
OG
l_int|1
)paren
id|RETURN_UP
c_func
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
macro_line|#endif SAFE_MIXED
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|audio_state
op_eq
id|audio_playing
)paren
(brace
id|i
op_assign
id|cc_Pause_Resume
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
id|RETURN_UP
c_func
(paren
op_minus
id|EIO
)paren
suffix:semicolon
id|i
op_assign
id|cc_ReadSubQ
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
id|RETURN_UP
c_func
(paren
op_minus
id|EIO
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|pos_audio_start
op_assign
id|D_S
(braket
id|d
)braket
dot
id|SubQ_run_tot
suffix:semicolon
id|i
op_assign
id|cc_Seek
c_func
(paren
id|D_S
(braket
id|d
)braket
dot
id|pos_audio_start
comma
l_int|1
)paren
suffix:semicolon
)brace
id|memcpy
c_func
(paren
op_amp
id|msf
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|cdrom_msf
)paren
)paren
suffix:semicolon
multiline_comment|/* values come as msf-bin */
id|D_S
(braket
id|d
)braket
dot
id|pos_audio_start
op_assign
(paren
id|msf.cdmsf_min0
op_lshift
l_int|16
)paren
op_or
(paren
id|msf.cdmsf_sec0
op_lshift
l_int|8
)paren
op_or
id|msf.cdmsf_frame0
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|pos_audio_end
op_assign
(paren
id|msf.cdmsf_min1
op_lshift
l_int|16
)paren
op_or
(paren
id|msf.cdmsf_sec1
op_lshift
l_int|8
)paren
op_or
id|msf.cdmsf_frame1
suffix:semicolon
id|msg
c_func
(paren
id|DBG_IOX
comma
l_string|&quot;ioctl: CDROMPLAYMSF %08X %08X&bslash;n&quot;
comma
id|D_S
(braket
id|d
)braket
dot
id|pos_audio_start
comma
id|D_S
(braket
id|d
)braket
dot
id|pos_audio_end
)paren
suffix:semicolon
id|i
op_assign
id|cc_PlayAudio
c_func
(paren
id|D_S
(braket
id|d
)braket
dot
id|pos_audio_start
comma
id|D_S
(braket
id|d
)braket
dot
id|pos_audio_end
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;ioctl: cc_PlayAudio returns %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|DriveReset
c_func
(paren
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|audio_state
op_assign
l_int|0
suffix:semicolon
id|RETURN_UP
c_func
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|D_S
(braket
id|d
)braket
dot
id|audio_state
op_assign
id|audio_playing
suffix:semicolon
id|RETURN_UP
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|CDROMPLAYTRKIND
suffix:colon
multiline_comment|/* Play a track.  This currently ignores index. */
id|msg
c_func
(paren
id|DBG_IOC
comma
l_string|&quot;ioctl: CDROMPLAYTRKIND entered.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if SAFE_MIXED
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|has_data
OG
l_int|1
)paren
id|RETURN_UP
c_func
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
macro_line|#endif SAFE_MIXED
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|audio_state
op_eq
id|audio_playing
)paren
(brace
id|msg
c_func
(paren
id|DBG_IOX
comma
l_string|&quot;CDROMPLAYTRKIND: already audio_playing.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if 1
id|RETURN_UP
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* just let us play on */
macro_line|#else
id|RETURN_UP
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
multiline_comment|/* play on, but say &quot;error&quot; */
macro_line|#endif
)brace
id|memcpy
c_func
(paren
op_amp
id|ti
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|cdrom_ti
)paren
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_IOX
comma
l_string|&quot;ioctl: trk0: %d, ind0: %d, trk1:%d, ind1:%d&bslash;n&quot;
comma
id|ti.cdti_trk0
comma
id|ti.cdti_ind0
comma
id|ti.cdti_trk1
comma
id|ti.cdti_ind1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti.cdti_trk0
OL
id|D_S
(braket
id|d
)braket
dot
id|n_first_track
)paren
id|RETURN_UP
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti.cdti_trk0
OG
id|D_S
(braket
id|d
)braket
dot
id|n_last_track
)paren
id|RETURN_UP
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti.cdti_trk1
OL
id|ti.cdti_trk0
)paren
id|ti.cdti_trk1
op_assign
id|ti.cdti_trk0
suffix:semicolon
r_if
c_cond
(paren
id|ti.cdti_trk1
OG
id|D_S
(braket
id|d
)braket
dot
id|n_last_track
)paren
id|ti.cdti_trk1
op_assign
id|D_S
(braket
id|d
)braket
dot
id|n_last_track
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|pos_audio_start
op_assign
id|D_S
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|ti.cdti_trk0
)braket
dot
id|address
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|pos_audio_end
op_assign
id|D_S
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|ti.cdti_trk1
op_plus
l_int|1
)braket
dot
id|address
suffix:semicolon
id|i
op_assign
id|cc_PlayAudio
c_func
(paren
id|D_S
(braket
id|d
)braket
dot
id|pos_audio_start
comma
id|D_S
(braket
id|d
)braket
dot
id|pos_audio_end
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;ioctl: cc_PlayAudio returns %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|DriveReset
c_func
(paren
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|audio_state
op_assign
l_int|0
suffix:semicolon
id|RETURN_UP
c_func
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|D_S
(braket
id|d
)braket
dot
id|audio_state
op_assign
id|audio_playing
suffix:semicolon
id|RETURN_UP
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|CDROMREADTOCHDR
suffix:colon
multiline_comment|/* Read the table of contents header */
id|msg
c_func
(paren
id|DBG_IOC
comma
l_string|&quot;ioctl: CDROMREADTOCHDR entered.&bslash;n&quot;
)paren
suffix:semicolon
id|tochdr.cdth_trk0
op_assign
id|D_S
(braket
id|d
)braket
dot
id|n_first_track
suffix:semicolon
id|tochdr.cdth_trk1
op_assign
id|D_S
(braket
id|d
)braket
dot
id|n_last_track
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|tochdr
comma
r_sizeof
(paren
r_struct
id|cdrom_tochdr
)paren
)paren
suffix:semicolon
id|RETURN_UP
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|CDROMREADTOCENTRY
suffix:colon
multiline_comment|/* Read an entry in the table of contents */
id|msg
c_func
(paren
id|DBG_IOC
comma
l_string|&quot;ioctl: CDROMREADTOCENTRY entered.&bslash;n&quot;
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|tocentry
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|cdrom_tocentry
)paren
)paren
suffix:semicolon
id|i
op_assign
id|tocentry.cdte_track
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|CDROM_LEADOUT
)paren
id|i
op_assign
id|D_S
(braket
id|d
)braket
dot
id|n_last_track
op_plus
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|i
id|D_S
(braket
id|d
)braket
dot
id|n_last_track
)paren
id|RETURN_UP
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|tocentry.cdte_adr
op_assign
id|D_S
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|i
)braket
dot
id|ctl_adr
op_amp
l_int|0x0F
suffix:semicolon
id|tocentry.cdte_ctrl
op_assign
(paren
id|D_S
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|i
)braket
dot
id|ctl_adr
op_rshift
l_int|4
)paren
op_amp
l_int|0x0F
suffix:semicolon
id|tocentry.cdte_datamode
op_assign
id|D_S
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|i
)braket
dot
id|format
suffix:semicolon
r_if
c_cond
(paren
id|tocentry.cdte_format
op_eq
id|CDROM_MSF
)paren
multiline_comment|/* MSF-bin required */
(brace
id|tocentry.cdte_addr.msf.minute
op_assign
(paren
id|D_S
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|i
)braket
dot
id|address
op_rshift
l_int|16
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|tocentry.cdte_addr.msf.second
op_assign
(paren
id|D_S
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|i
)braket
dot
id|address
op_rshift
l_int|8
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|tocentry.cdte_addr.msf.frame
op_assign
id|D_S
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|i
)braket
dot
id|address
op_amp
l_int|0x00FF
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tocentry.cdte_format
op_eq
id|CDROM_LBA
)paren
multiline_comment|/* blk required */
id|tocentry.cdte_addr.lba
op_assign
id|msf2blk
c_func
(paren
id|D_S
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|i
)braket
dot
id|address
)paren
suffix:semicolon
r_else
id|RETURN_UP
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|tocentry
comma
r_sizeof
(paren
r_struct
id|cdrom_tocentry
)paren
)paren
suffix:semicolon
id|RETURN_UP
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|CDROMSTOP
suffix:colon
multiline_comment|/* Spin down the drive */
id|msg
c_func
(paren
id|DBG_IOC
comma
l_string|&quot;ioctl: CDROMSTOP entered.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if SAFE_MIXED
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|has_data
OG
l_int|1
)paren
id|RETURN_UP
c_func
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
macro_line|#endif SAFE_MIXED
id|i
op_assign
id|cc_Pause_Resume
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|audio_state
op_assign
l_int|0
suffix:semicolon
macro_line|#if 0
id|cc_DriveReset
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|RETURN_UP
c_func
(paren
id|i
)paren
suffix:semicolon
r_case
id|CDROMSTART
suffix:colon
multiline_comment|/* Spin up the drive */
id|msg
c_func
(paren
id|DBG_IOC
comma
l_string|&quot;ioctl: CDROMSTART entered.&bslash;n&quot;
)paren
suffix:semicolon
id|cc_SpinUp
c_func
(paren
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|audio_state
op_assign
l_int|0
suffix:semicolon
id|RETURN_UP
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|CDROMVOLCTRL
suffix:colon
multiline_comment|/* Volume control */
id|msg
c_func
(paren
id|DBG_IOC
comma
l_string|&quot;ioctl: CDROMVOLCTRL entered.&bslash;n&quot;
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|volctrl
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|volctrl
)paren
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|vol_chan0
op_assign
l_int|0
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|vol_ctrl0
op_assign
id|volctrl.channel0
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|vol_chan1
op_assign
l_int|1
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|vol_ctrl1
op_assign
id|volctrl.channel1
suffix:semicolon
id|i
op_assign
id|cc_SetVolume
c_func
(paren
)paren
suffix:semicolon
id|RETURN_UP
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|CDROMVOLREAD
suffix:colon
multiline_comment|/* read Volume settings from drive */
id|msg
c_func
(paren
id|DBG_IOC
comma
l_string|&quot;ioctl: CDROMVOLREAD entered.&bslash;n&quot;
)paren
suffix:semicolon
id|st
op_assign
id|cc_GetVolume
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st
OL
l_int|0
)paren
id|RETURN_UP
c_func
(paren
id|st
)paren
suffix:semicolon
id|volctrl.channel0
op_assign
id|D_S
(braket
id|d
)braket
dot
id|vol_ctrl0
suffix:semicolon
id|volctrl.channel1
op_assign
id|D_S
(braket
id|d
)braket
dot
id|vol_ctrl1
suffix:semicolon
id|volctrl.channel2
op_assign
l_int|0
suffix:semicolon
id|volctrl.channel2
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|volctrl
comma
r_sizeof
(paren
id|volctrl
)paren
)paren
suffix:semicolon
id|RETURN_UP
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|CDROMSUBCHNL
suffix:colon
multiline_comment|/* Get subchannel info */
id|msg
c_func
(paren
id|DBG_IOS
comma
l_string|&quot;ioctl: CDROMSUBCHNL entered.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Bogus, I can do better than this! --AJK&n;&t;&t;if ((st_spinning)||(!subq_valid)) {&n;&t;&t;&t;i=cc_ReadSubQ();&n;&t;&t;&t;if (i&lt;0) RETURN_UP(-EIO);&n;&t;&t;}&n;&t;&t;*/
id|i
op_assign
id|cc_ReadSubQ
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|j
op_assign
id|cc_ReadError
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* clear out error status from drive */
id|D_S
(braket
id|d
)braket
dot
id|audio_state
op_assign
id|CDROM_AUDIO_NO_STATUS
suffix:semicolon
multiline_comment|/* get and set the disk state here, &n;&t;&t;&t;probably not the right place, but who cares!&n;&t;&t;&t;It makes it work properly! --AJK */
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|CD_changed
op_eq
l_int|0xFF
)paren
(brace
id|msg
c_func
(paren
id|DBG_000
comma
l_string|&quot;Disk changed detect&bslash;n&quot;
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|diskstate_flags
op_and_assign
op_complement
id|cd_size_bit
suffix:semicolon
)brace
id|RETURN_UP
c_func
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|CD_changed
op_eq
l_int|0xFF
)paren
(brace
multiline_comment|/* reread the TOC because the disk has changed! --AJK */
id|msg
c_func
(paren
id|DBG_000
comma
l_string|&quot;Disk changed STILL detected, rereading TOC!&bslash;n&quot;
)paren
suffix:semicolon
id|i
op_assign
id|DiskInfo
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|CD_changed
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* cd has changed, procede, */
id|RETURN_UP
c_func
(paren
op_minus
id|EIO
)paren
suffix:semicolon
multiline_comment|/* and get TOC, etc on next try! --AJK */
)brace
r_else
(brace
id|RETURN_UP
c_func
(paren
op_minus
id|EIO
)paren
suffix:semicolon
multiline_comment|/* we weren&squot;t ready yet! --AJK */
)brace
)brace
id|memcpy
c_func
(paren
op_amp
id|SC
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|cdrom_subchnl
)paren
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t;&t;This virtual crap is very bogus! &n;&t;&t;&t;It doesn&squot;t detect when the cd is done playing audio!&n;&t;&t;&t;Lets do this right with proper hardware register reading!&n;&t;&t;*/
id|cc_ReadStatus
c_func
(paren
)paren
suffix:semicolon
id|i
op_assign
id|ResponseStatus
c_func
(paren
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_000
comma
l_string|&quot;Drive Status: door_locked =%d.&bslash;n&quot;
comma
id|st_door_locked
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_000
comma
l_string|&quot;Drive Status: door_closed =%d.&bslash;n&quot;
comma
id|st_door_closed
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_000
comma
l_string|&quot;Drive Status: caddy_in =%d.&bslash;n&quot;
comma
id|st_caddy_in
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_000
comma
l_string|&quot;Drive Status: disk_ok =%d.&bslash;n&quot;
comma
id|st_diskok
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_000
comma
l_string|&quot;Drive Status: spinning =%d.&bslash;n&quot;
comma
id|st_spinning
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_000
comma
l_string|&quot;Drive Status: busy =%d.&bslash;n&quot;
comma
id|st_busy
)paren
suffix:semicolon
multiline_comment|/* st_busy indicates if it&squot;s _ACTUALLY_ playing audio */
r_switch
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|audio_state
)paren
(brace
r_case
id|audio_playing
suffix:colon
r_if
c_cond
(paren
id|st_busy
op_eq
l_int|0
)paren
(brace
multiline_comment|/* CD has stopped playing audio --AJK */
id|D_S
(braket
id|d
)braket
dot
id|audio_state
op_assign
id|audio_completed
suffix:semicolon
id|SC.cdsc_audiostatus
op_assign
id|CDROM_AUDIO_COMPLETED
suffix:semicolon
)brace
r_else
(brace
id|SC.cdsc_audiostatus
op_assign
id|CDROM_AUDIO_PLAY
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|audio_pausing
suffix:colon
id|SC.cdsc_audiostatus
op_assign
id|CDROM_AUDIO_PAUSED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|audio_completed
suffix:colon
id|SC.cdsc_audiostatus
op_assign
id|CDROM_AUDIO_COMPLETED
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|SC.cdsc_audiostatus
op_assign
id|CDROM_AUDIO_NO_STATUS
suffix:semicolon
r_break
suffix:semicolon
)brace
id|SC.cdsc_adr
op_assign
id|D_S
(braket
id|d
)braket
dot
id|SubQ_ctl_adr
suffix:semicolon
id|SC.cdsc_ctrl
op_assign
id|D_S
(braket
id|d
)braket
dot
id|SubQ_ctl_adr
op_rshift
l_int|4
suffix:semicolon
id|SC.cdsc_trk
op_assign
id|bcd2bin
c_func
(paren
id|D_S
(braket
id|d
)braket
dot
id|SubQ_trk
)paren
suffix:semicolon
id|SC.cdsc_ind
op_assign
id|bcd2bin
c_func
(paren
id|D_S
(braket
id|d
)braket
dot
id|SubQ_pnt_idx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SC.cdsc_format
op_eq
id|CDROM_LBA
)paren
(brace
id|SC.cdsc_absaddr.lba
op_assign
id|msf2blk
c_func
(paren
id|D_S
(braket
id|d
)braket
dot
id|SubQ_run_tot
)paren
suffix:semicolon
id|SC.cdsc_reladdr.lba
op_assign
id|msf2blk
c_func
(paren
id|D_S
(braket
id|d
)braket
dot
id|SubQ_run_trk
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* not only if (SC.cdsc_format==CDROM_MSF) */
(brace
id|SC.cdsc_absaddr.msf.minute
op_assign
(paren
id|D_S
(braket
id|d
)braket
dot
id|SubQ_run_tot
op_rshift
l_int|16
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|SC.cdsc_absaddr.msf.second
op_assign
(paren
id|D_S
(braket
id|d
)braket
dot
id|SubQ_run_tot
op_rshift
l_int|8
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|SC.cdsc_absaddr.msf.frame
op_assign
id|D_S
(braket
id|d
)braket
dot
id|SubQ_run_tot
op_amp
l_int|0x00FF
suffix:semicolon
id|SC.cdsc_reladdr.msf.minute
op_assign
(paren
id|D_S
(braket
id|d
)braket
dot
id|SubQ_run_trk
op_rshift
l_int|16
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|SC.cdsc_reladdr.msf.second
op_assign
(paren
id|D_S
(braket
id|d
)braket
dot
id|SubQ_run_trk
op_rshift
l_int|8
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|SC.cdsc_reladdr.msf.frame
op_assign
id|D_S
(braket
id|d
)braket
dot
id|SubQ_run_trk
op_amp
l_int|0x00FF
suffix:semicolon
)brace
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|SC
comma
r_sizeof
(paren
r_struct
id|cdrom_subchnl
)paren
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_IOS
comma
l_string|&quot;CDROMSUBCHNL: %1X %02X %08X %08X %02X %02X %06X %06X&bslash;n&quot;
comma
id|SC.cdsc_format
comma
id|SC.cdsc_audiostatus
comma
id|SC.cdsc_adr
comma
id|SC.cdsc_ctrl
comma
id|SC.cdsc_trk
comma
id|SC.cdsc_ind
comma
id|SC.cdsc_absaddr
comma
id|SC.cdsc_reladdr
)paren
suffix:semicolon
id|RETURN_UP
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_default
suffix:colon
id|msg
c_func
(paren
id|DBG_IOC
comma
l_string|&quot;ioctl: unknown function request %04X&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
id|RETURN_UP
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
multiline_comment|/* end switch(cmd) */
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; *  Take care of the different block sizes between cdrom and Linux.&n; */
DECL|function|sbp_transfer
r_static
r_void
id|sbp_transfer
c_func
(paren
r_struct
id|request
op_star
id|req
)paren
(brace
r_int
id|offs
suffix:semicolon
r_while
c_loop
(paren
(paren
id|req-&gt;nr_sectors
OG
l_int|0
)paren
op_logical_and
(paren
id|req-&gt;sector
op_div
l_int|4
op_ge
id|D_S
(braket
id|d
)braket
dot
id|sbp_first_frame
)paren
op_logical_and
(paren
id|req-&gt;sector
op_div
l_int|4
op_le
id|D_S
(braket
id|d
)braket
dot
id|sbp_last_frame
)paren
)paren
(brace
id|offs
op_assign
(paren
id|req-&gt;sector
op_minus
id|D_S
(braket
id|d
)braket
dot
id|sbp_first_frame
op_star
l_int|4
)paren
op_star
l_int|512
suffix:semicolon
id|memcpy
c_func
(paren
id|req-&gt;buffer
comma
id|D_S
(braket
id|d
)braket
dot
id|sbp_buf
op_plus
id|offs
comma
l_int|512
)paren
suffix:semicolon
id|req-&gt;nr_sectors
op_decrement
suffix:semicolon
id|req-&gt;sector
op_increment
suffix:semicolon
id|req-&gt;buffer
op_add_assign
l_int|512
suffix:semicolon
)brace
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; *  special end_request for sbpcd to solve CURRENT==NULL bug. (GTL)&n; *  GTL = Gonzalo Tornaria &lt;tornaria@cmat.edu.uy&gt;&n; *&n; *  This is a kludge so we don&squot;t need to modify end_request.&n; *  We put the req we take out after INIT_REQUEST in the requests list,&n; *  so that end_request will discard it. &n; *&n; *  The bug could be present in other block devices, perhaps we&n; *  should modify INIT_REQUEST and end_request instead, and&n; *  change every block device.. &n; *&n; *  Could be a race here?? Could e.g. a timer interrupt schedule() us?&n; *  If so, we should copy end_request here, and do it right.. (or&n; *  modify end_request and the block devices).&n; *&n; *  In any case, the race here would be much small than it was, and&n; *  I couldn&squot;t reproduce..&n; *&n; *  The race could be: suppose CURRENT==NULL. We put our req in the list,&n; *  and we are scheduled. Other process takes over, and gets into&n; *  do_sbpcd_request. It sees CURRENT!=NULL (it is == to our req), so&n; *  proceeds. It ends, so CURRENT is now NULL.. Now we awake somewhere in&n; *  end_request, but now CURRENT==NULL... oops!&n; *&n; */
DECL|macro|DEBUG_GTL
macro_line|#undef DEBUG_GTL
DECL|function|sbpcd_end_request
r_static
r_inline
r_void
id|sbpcd_end_request
c_func
(paren
r_struct
id|request
op_star
id|req
comma
r_int
id|uptodate
)paren
(brace
id|list_add
c_func
(paren
op_amp
id|req-&gt;queue
comma
op_amp
id|req-&gt;q-&gt;queue_head
)paren
suffix:semicolon
id|end_request
c_func
(paren
id|uptodate
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; *  I/O request routine, called from Linux kernel.&n; */
DECL|function|DO_SBPCD_REQUEST
r_static
r_void
id|DO_SBPCD_REQUEST
c_func
(paren
id|request_queue_t
op_star
id|q
)paren
(brace
id|u_int
id|block
suffix:semicolon
id|u_int
id|nsect
suffix:semicolon
r_int
id|i
comma
id|status_tries
comma
id|data_tries
suffix:semicolon
r_struct
id|request
op_star
id|req
suffix:semicolon
macro_line|#ifdef DEBUG_GTL
r_static
r_int
id|xx_nr
op_assign
l_int|0
suffix:semicolon
r_int
id|xnr
suffix:semicolon
macro_line|#endif
id|request_loop
suffix:colon
macro_line|#ifdef DEBUG_GTL
id|xnr
op_assign
op_increment
id|xx_nr
suffix:semicolon
r_if
c_cond
(paren
id|QUEUE_EMPTY
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;do_sbpcd_request[%di](NULL), Pid:%d, Time:%li&bslash;n&quot;
comma
id|xnr
comma
id|current-&gt;pid
comma
id|jiffies
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;do_sbpcd_request[%do](NULL) end 0 (null), Time:%li&bslash;n&quot;
comma
id|xnr
comma
id|jiffies
)paren
suffix:semicolon
id|CLEAR_INTR
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot; do_sbpcd_request[%di](%p:%ld+%ld), Pid:%d, Time:%li&bslash;n&quot;
comma
id|xnr
comma
id|CURRENT
comma
id|CURRENT-&gt;sector
comma
id|CURRENT-&gt;nr_sectors
comma
id|current-&gt;pid
comma
id|jiffies
)paren
suffix:semicolon
macro_line|#endif
id|INIT_REQUEST
suffix:semicolon
id|req
op_assign
id|CURRENT
suffix:semicolon
multiline_comment|/* take out our request so no other */
id|blkdev_dequeue_request
c_func
(paren
id|req
)paren
suffix:semicolon
multiline_comment|/* task can fuck it up         GTL  */
r_if
c_cond
(paren
id|req-&gt;rq_status
op_eq
id|RQ_INACTIVE
)paren
id|sbpcd_end_request
c_func
(paren
id|req
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req
op_member_access_from_pointer
id|sector
op_eq
op_minus
l_int|1
)paren
id|sbpcd_end_request
c_func
(paren
id|req
comma
l_int|0
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|io_request_lock
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|ioctl_read_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;cmd
op_ne
id|READ
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;bad cmd %d&bslash;n&quot;
comma
id|req-&gt;cmd
)paren
suffix:semicolon
r_goto
id|err_done
suffix:semicolon
)brace
id|i
op_assign
id|MINOR
c_func
(paren
id|req-&gt;rq_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
OL
l_int|0
)paren
op_logical_or
(paren
id|i
op_ge
id|NR_SBPCD
)paren
op_logical_or
(paren
id|D_S
(braket
id|i
)braket
dot
id|drv_id
op_eq
op_minus
l_int|1
)paren
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;do_request: bad device: %s&bslash;n&quot;
comma
id|kdevname
c_func
(paren
id|req-&gt;rq_dev
)paren
)paren
suffix:semicolon
r_goto
id|err_done
suffix:semicolon
)brace
macro_line|#if OLD_BUSY
r_while
c_loop
(paren
id|busy_audio
)paren
id|sbp_sleep
c_func
(paren
id|HZ
)paren
suffix:semicolon
multiline_comment|/* wait a bit */
id|busy_data
op_assign
l_int|1
suffix:semicolon
macro_line|#endif OLD_BUSY
r_if
c_cond
(paren
id|D_S
(braket
id|i
)braket
dot
id|audio_state
op_eq
id|audio_playing
)paren
r_goto
id|err_done
suffix:semicolon
r_if
c_cond
(paren
id|d
op_ne
id|i
)paren
id|switch_drive
c_func
(paren
id|i
)paren
suffix:semicolon
id|block
op_assign
id|req-&gt;sector
suffix:semicolon
multiline_comment|/* always numbered as 512-byte-pieces */
id|nsect
op_assign
id|req-&gt;nr_sectors
suffix:semicolon
multiline_comment|/* always counted as 512-byte-pieces */
id|msg
c_func
(paren
id|DBG_BSZ
comma
l_string|&quot;read sector %d (%d sectors)&bslash;n&quot;
comma
id|block
comma
id|nsect
)paren
suffix:semicolon
macro_line|#if 0
id|msg
c_func
(paren
id|DBG_MUL
comma
l_string|&quot;read LBA %d&bslash;n&quot;
comma
id|block
op_div
l_int|4
)paren
suffix:semicolon
macro_line|#endif
id|sbp_transfer
c_func
(paren
id|req
)paren
suffix:semicolon
multiline_comment|/* if we satisfied the request from the buffer, we&squot;re done. */
r_if
c_cond
(paren
id|req-&gt;nr_sectors
op_eq
l_int|0
)paren
(brace
macro_line|#ifdef DEBUG_GTL
id|printk
c_func
(paren
l_string|&quot; do_sbpcd_request[%do](%p:%ld+%ld) end 2, Time:%li&bslash;n&quot;
comma
id|xnr
comma
id|req
comma
id|req-&gt;sector
comma
id|req-&gt;nr_sectors
comma
id|jiffies
)paren
suffix:semicolon
macro_line|#endif
id|up
c_func
(paren
op_amp
id|ioctl_read_sem
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|io_request_lock
)paren
suffix:semicolon
id|sbpcd_end_request
c_func
(paren
id|req
comma
l_int|1
)paren
suffix:semicolon
r_goto
id|request_loop
suffix:semicolon
)brace
macro_line|#if FUTURE
id|i
op_assign
id|prepare
c_func
(paren
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* at moment not really a hassle check, but ... */
r_if
c_cond
(paren
id|i
op_ne
l_int|0
)paren
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;&bslash;&quot;prepare&bslash;&quot; tells error %d -- ignored&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
macro_line|#endif FUTURE
r_if
c_cond
(paren
op_logical_neg
id|st_spinning
)paren
id|cc_SpinUp
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|data_tries
op_assign
id|n_retries
suffix:semicolon
id|data_tries
OG
l_int|0
suffix:semicolon
id|data_tries
op_decrement
)paren
(brace
r_for
c_loop
(paren
id|status_tries
op_assign
l_int|3
suffix:semicolon
id|status_tries
OG
l_int|0
suffix:semicolon
id|status_tries
op_decrement
)paren
(brace
id|flags_cmd_out
op_or_assign
id|f_respo3
suffix:semicolon
id|cc_ReadStatus
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbp_status
c_func
(paren
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|st_check
)paren
id|cc_ReadError
c_func
(paren
)paren
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* wait a bit, try again */
)brace
r_if
c_cond
(paren
id|status_tries
op_eq
l_int|0
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;sbp_status: failed after 3 tries in line %d&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|sbp_read_cmd
c_func
(paren
id|req
)paren
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbp_data
c_func
(paren
id|req
)paren
op_ne
l_int|0
)paren
(brace
macro_line|#if SAFE_MIXED
id|D_S
(braket
id|d
)braket
dot
id|has_data
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* is really a data disk */
macro_line|#endif SAFE_MIXED
macro_line|#ifdef DEBUG_GTL
id|printk
c_func
(paren
l_string|&quot; do_sbpcd_request[%do](%p:%ld+%ld) end 3, Time:%li&bslash;n&quot;
comma
id|xnr
comma
id|req
comma
id|req-&gt;sector
comma
id|req-&gt;nr_sectors
comma
id|jiffies
)paren
suffix:semicolon
macro_line|#endif
id|up
c_func
(paren
op_amp
id|ioctl_read_sem
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|io_request_lock
)paren
suffix:semicolon
id|sbpcd_end_request
c_func
(paren
id|req
comma
l_int|1
)paren
suffix:semicolon
r_goto
id|request_loop
suffix:semicolon
)brace
)brace
id|err_done
suffix:colon
macro_line|#if OLD_BUSY
id|busy_data
op_assign
l_int|0
suffix:semicolon
macro_line|#endif OLD_BUSY
macro_line|#ifdef DEBUG_GTL
id|printk
c_func
(paren
l_string|&quot; do_sbpcd_request[%do](%p:%ld+%ld) end 4 (error), Time:%li&bslash;n&quot;
comma
id|xnr
comma
id|req
comma
id|req-&gt;sector
comma
id|req-&gt;nr_sectors
comma
id|jiffies
)paren
suffix:semicolon
macro_line|#endif
id|up
c_func
(paren
op_amp
id|ioctl_read_sem
)paren
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* wait a bit, try again */
id|spin_lock_irq
c_func
(paren
op_amp
id|io_request_lock
)paren
suffix:semicolon
id|sbpcd_end_request
c_func
(paren
id|req
comma
l_int|0
)paren
suffix:semicolon
r_goto
id|request_loop
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; *  build and send the READ command.&n; */
DECL|function|sbp_read_cmd
r_static
r_void
id|sbp_read_cmd
c_func
(paren
r_struct
id|request
op_star
id|req
)paren
(brace
DECL|macro|OLD
macro_line|#undef OLD
r_int
id|i
suffix:semicolon
r_int
id|block
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|sbp_first_frame
op_assign
id|D_S
(braket
id|d
)braket
dot
id|sbp_last_frame
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* purge buffer */
id|D_S
(braket
id|d
)braket
dot
id|sbp_current
op_assign
l_int|0
suffix:semicolon
id|block
op_assign
id|req-&gt;sector
op_div
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|block
op_plus
id|D_S
(braket
id|d
)braket
dot
id|sbp_bufsiz
op_le
id|D_S
(braket
id|d
)braket
dot
id|CDsize_frm
)paren
id|D_S
(braket
id|d
)braket
dot
id|sbp_read_frames
op_assign
id|D_S
(braket
id|d
)braket
dot
id|sbp_bufsiz
suffix:semicolon
r_else
(brace
id|D_S
(braket
id|d
)braket
dot
id|sbp_read_frames
op_assign
id|D_S
(braket
id|d
)braket
dot
id|CDsize_frm
op_minus
id|block
suffix:semicolon
multiline_comment|/* avoid reading past end of data */
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|sbp_read_frames
OL
l_int|1
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;requested frame %d, CD size %d ???&bslash;n&quot;
comma
id|block
comma
id|D_S
(braket
id|d
)braket
dot
id|CDsize_frm
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|sbp_read_frames
op_assign
l_int|1
suffix:semicolon
)brace
)brace
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|famV_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMDV_READ
suffix:semicolon
id|lba2msf
c_func
(paren
id|block
comma
op_amp
id|drvcmd
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/* msf-bcd format required */
id|bin2bcdx
c_func
(paren
op_amp
id|drvcmd
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|bin2bcdx
c_func
(paren
op_amp
id|drvcmd
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|bin2bcdx
c_func
(paren
op_amp
id|drvcmd
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
id|D_S
(braket
id|d
)braket
dot
id|sbp_read_frames
op_rshift
l_int|8
suffix:semicolon
id|drvcmd
(braket
l_int|5
)braket
op_assign
id|D_S
(braket
id|d
)braket
dot
id|sbp_read_frames
op_amp
l_int|0xff
suffix:semicolon
id|drvcmd
(braket
l_int|6
)braket
op_assign
l_int|0x02
suffix:semicolon
multiline_comment|/* flag &quot;msf-bcd&quot; */
)brace
r_else
r_if
c_cond
(paren
id|fam0L_drive
)paren
(brace
id|flags_cmd_out
op_or_assign
id|f_lopsta
op_or
id|f_getsta
op_or
id|f_bit1
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|xa_byte
op_eq
l_int|0x20
)paren
(brace
id|cmd_type
op_assign
id|READ_M2
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD0_READ_XA
suffix:semicolon
multiline_comment|/* &quot;read XA frames&quot;, old drives */
id|drvcmd
(braket
l_int|1
)braket
op_assign
(paren
id|block
op_rshift
l_int|16
)paren
op_amp
l_int|0x0ff
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
(paren
id|block
op_rshift
l_int|8
)paren
op_amp
l_int|0x0ff
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
id|block
op_amp
l_int|0x0ff
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
(paren
id|D_S
(braket
id|d
)braket
dot
id|sbp_read_frames
op_rshift
l_int|8
)paren
op_amp
l_int|0x0ff
suffix:semicolon
id|drvcmd
(braket
l_int|5
)braket
op_assign
id|D_S
(braket
id|d
)braket
dot
id|sbp_read_frames
op_amp
l_int|0x0ff
suffix:semicolon
)brace
r_else
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD0_READ
suffix:semicolon
multiline_comment|/* &quot;read frames&quot;, old drives */
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|drv_type
op_ge
id|drv_201
)paren
(brace
id|lba2msf
c_func
(paren
id|block
comma
op_amp
id|drvcmd
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/* msf-bcd format required */
id|bin2bcdx
c_func
(paren
op_amp
id|drvcmd
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|bin2bcdx
c_func
(paren
op_amp
id|drvcmd
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|bin2bcdx
c_func
(paren
op_amp
id|drvcmd
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|drvcmd
(braket
l_int|1
)braket
op_assign
(paren
id|block
op_rshift
l_int|16
)paren
op_amp
l_int|0x0ff
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
(paren
id|block
op_rshift
l_int|8
)paren
op_amp
l_int|0x0ff
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
id|block
op_amp
l_int|0x0ff
suffix:semicolon
)brace
id|drvcmd
(braket
l_int|4
)braket
op_assign
(paren
id|D_S
(braket
id|d
)braket
dot
id|sbp_read_frames
op_rshift
l_int|8
)paren
op_amp
l_int|0x0ff
suffix:semicolon
id|drvcmd
(braket
l_int|5
)braket
op_assign
id|D_S
(braket
id|d
)braket
dot
id|sbp_read_frames
op_amp
l_int|0x0ff
suffix:semicolon
id|drvcmd
(braket
l_int|6
)braket
op_assign
(paren
id|D_S
(braket
id|d
)braket
dot
id|drv_type
OL
id|drv_201
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|2
suffix:semicolon
multiline_comment|/* flag &quot;lba or msf-bcd format&quot; */
)brace
)brace
r_else
r_if
c_cond
(paren
id|fam1_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD1_READ
suffix:semicolon
id|lba2msf
c_func
(paren
id|block
comma
op_amp
id|drvcmd
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/* msf-bin format required */
id|drvcmd
(braket
l_int|5
)braket
op_assign
(paren
id|D_S
(braket
id|d
)braket
dot
id|sbp_read_frames
op_rshift
l_int|8
)paren
op_amp
l_int|0x0ff
suffix:semicolon
id|drvcmd
(braket
l_int|6
)braket
op_assign
id|D_S
(braket
id|d
)braket
dot
id|sbp_read_frames
op_amp
l_int|0x0ff
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fam2_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMD2_READ
suffix:semicolon
id|lba2msf
c_func
(paren
id|block
comma
op_amp
id|drvcmd
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/* msf-bin format required */
id|drvcmd
(braket
l_int|4
)braket
op_assign
(paren
id|D_S
(braket
id|d
)braket
dot
id|sbp_read_frames
op_rshift
l_int|8
)paren
op_amp
l_int|0x0ff
suffix:semicolon
id|drvcmd
(braket
l_int|5
)braket
op_assign
id|D_S
(braket
id|d
)braket
dot
id|sbp_read_frames
op_amp
l_int|0x0ff
suffix:semicolon
id|drvcmd
(braket
l_int|6
)braket
op_assign
l_int|0x02
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMDT_READ
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
(paren
id|block
op_rshift
l_int|24
)paren
op_amp
l_int|0x0ff
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
(paren
id|block
op_rshift
l_int|16
)paren
op_amp
l_int|0x0ff
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
(paren
id|block
op_rshift
l_int|8
)paren
op_amp
l_int|0x0ff
suffix:semicolon
id|drvcmd
(braket
l_int|5
)braket
op_assign
id|block
op_amp
l_int|0x0ff
suffix:semicolon
id|drvcmd
(braket
l_int|7
)braket
op_assign
(paren
id|D_S
(braket
id|d
)braket
dot
id|sbp_read_frames
op_rshift
l_int|8
)paren
op_amp
l_int|0x0ff
suffix:semicolon
id|drvcmd
(braket
l_int|8
)braket
op_assign
id|D_S
(braket
id|d
)braket
dot
id|sbp_read_frames
op_amp
l_int|0x0ff
suffix:semicolon
)brace
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
id|response_count
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;error giving READ command: %0d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; *  Check the completion of the read-data command.  On success, read&n; *  the D_S[d].sbp_bufsiz * 2048 bytes of data from the disk into buffer.&n; */
DECL|function|sbp_data
r_static
r_int
id|sbp_data
c_func
(paren
r_struct
id|request
op_star
id|req
)paren
(brace
r_int
id|i
op_assign
l_int|0
comma
id|j
op_assign
l_int|0
comma
id|l
comma
id|frame
suffix:semicolon
id|u_int
r_try
op_assign
l_int|0
suffix:semicolon
id|u_long
id|timeout
suffix:semicolon
id|u_char
op_star
id|p
suffix:semicolon
id|u_int
id|data_tries
op_assign
l_int|0
suffix:semicolon
id|u_int
id|data_waits
op_assign
l_int|0
suffix:semicolon
id|u_int
id|data_retrying
op_assign
l_int|0
suffix:semicolon
r_int
id|error_flag
suffix:semicolon
r_int
id|xa_count
suffix:semicolon
r_int
id|max_latency
suffix:semicolon
r_int
id|success
suffix:semicolon
r_int
id|wait
suffix:semicolon
r_int
id|duration
suffix:semicolon
id|error_flag
op_assign
l_int|0
suffix:semicolon
id|success
op_assign
l_int|0
suffix:semicolon
macro_line|#if LONG_TIMING
id|max_latency
op_assign
l_int|9
op_star
id|HZ
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|f_multisession
)paren
id|max_latency
op_assign
l_int|15
op_star
id|HZ
suffix:semicolon
r_else
id|max_latency
op_assign
l_int|5
op_star
id|HZ
suffix:semicolon
macro_line|#endif
id|duration
op_assign
id|jiffies
suffix:semicolon
r_for
c_loop
(paren
id|frame
op_assign
l_int|0
suffix:semicolon
id|frame
OL
id|D_S
(braket
id|d
)braket
dot
id|sbp_read_frames
op_logical_and
op_logical_neg
id|error_flag
suffix:semicolon
id|frame
op_increment
)paren
(brace
id|SBPCD_CLI
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|data_timer
)paren
suffix:semicolon
id|data_timer.expires
op_assign
id|jiffies
op_plus
id|max_latency
suffix:semicolon
id|timed_out_data
op_assign
l_int|0
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|data_timer
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|timed_out_data
)paren
(brace
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|f_multisession
)paren
r_try
op_assign
id|maxtim_data
op_star
l_int|4
suffix:semicolon
r_else
r_try
op_assign
id|maxtim_data
suffix:semicolon
id|msg
c_func
(paren
id|DBG_000
comma
l_string|&quot;sbp_data: CDi_status loop: try=%d.&bslash;n&quot;
comma
r_try
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
r_try
op_ne
l_int|0
suffix:semicolon
r_try
op_decrement
)paren
(brace
id|j
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|j
op_amp
id|s_not_data_ready
)paren
)paren
r_break
suffix:semicolon
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|j
op_amp
id|s_not_result_ready
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|fam0LV_drive
)paren
r_if
c_cond
(paren
id|j
op_amp
id|s_attention
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|j
op_amp
id|s_not_data_ready
)paren
)paren
r_goto
id|data_ready
suffix:semicolon
r_if
c_cond
(paren
r_try
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|data_retrying
op_eq
l_int|0
)paren
id|data_waits
op_increment
suffix:semicolon
id|data_retrying
op_assign
l_int|1
suffix:semicolon
id|msg
c_func
(paren
id|DBG_000
comma
l_string|&quot;sbp_data: CDi_status loop: sleeping.&bslash;n&quot;
)paren
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_try
op_assign
l_int|1
suffix:semicolon
)brace
)brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;sbp_data: CDi_status loop expired.&bslash;n&quot;
)paren
suffix:semicolon
id|data_ready
suffix:colon
id|del_timer
c_func
(paren
op_amp
id|data_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timed_out_data
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;sbp_data: CDi_status timeout (timed_out_data) (%02X).&bslash;n&quot;
comma
id|j
)paren
suffix:semicolon
id|error_flag
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
r_try
op_eq
l_int|0
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;sbp_data: CDi_status timeout (try=0) (%02X).&bslash;n&quot;
comma
id|j
)paren
suffix:semicolon
id|error_flag
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|j
op_amp
id|s_not_result_ready
)paren
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;sbp_data: RESULT_READY where DATA_READY awaited (%02X).&bslash;n&quot;
comma
id|j
)paren
suffix:semicolon
id|response_count
op_assign
l_int|20
suffix:semicolon
id|j
op_assign
id|ResponseInfo
c_func
(paren
)paren
suffix:semicolon
id|j
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|j
op_amp
id|s_not_data_ready
)paren
(brace
r_if
c_cond
(paren
(paren
id|D_S
(braket
id|d
)braket
dot
id|ored_ctl_adr
op_amp
l_int|0x40
)paren
op_eq
l_int|0
)paren
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;CD contains no data tracks.&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;sbp_data: DATA_READY timeout (%02X).&bslash;n&quot;
comma
id|j
)paren
suffix:semicolon
id|error_flag
op_increment
suffix:semicolon
)brace
id|SBPCD_STI
suffix:semicolon
r_if
c_cond
(paren
id|error_flag
)paren
r_break
suffix:semicolon
id|msg
c_func
(paren
id|DBG_000
comma
l_string|&quot;sbp_data: beginning to read.&bslash;n&quot;
)paren
suffix:semicolon
id|p
op_assign
id|D_S
(braket
id|d
)braket
dot
id|sbp_buf
op_plus
id|frame
op_star
id|CD_FRAMESIZE
suffix:semicolon
r_if
c_cond
(paren
id|sbpro_type
op_eq
l_int|1
)paren
id|OUT
c_func
(paren
id|CDo_sel_i_d
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd_type
op_eq
id|READ_M2
)paren
(brace
r_if
c_cond
(paren
id|do_16bit
)paren
id|insw
c_func
(paren
id|CDi_data
comma
id|xa_head_buf
comma
id|CD_XA_HEAD
op_rshift
l_int|1
)paren
suffix:semicolon
r_else
id|insb
c_func
(paren
id|CDi_data
comma
id|xa_head_buf
comma
id|CD_XA_HEAD
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|do_16bit
)paren
id|insw
c_func
(paren
id|CDi_data
comma
id|p
comma
id|CD_FRAMESIZE
op_rshift
l_int|1
)paren
suffix:semicolon
r_else
id|insb
c_func
(paren
id|CDi_data
comma
id|p
comma
id|CD_FRAMESIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd_type
op_eq
id|READ_M2
)paren
(brace
r_if
c_cond
(paren
id|do_16bit
)paren
id|insw
c_func
(paren
id|CDi_data
comma
id|xa_tail_buf
comma
id|CD_XA_TAIL
op_rshift
l_int|1
)paren
suffix:semicolon
r_else
id|insb
c_func
(paren
id|CDi_data
comma
id|xa_tail_buf
comma
id|CD_XA_TAIL
)paren
suffix:semicolon
)brace
id|D_S
(braket
id|d
)braket
dot
id|sbp_current
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|sbpro_type
op_eq
l_int|1
)paren
id|OUT
c_func
(paren
id|CDo_sel_i_d
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd_type
op_eq
id|READ_M2
)paren
(brace
r_for
c_loop
(paren
id|xa_count
op_assign
l_int|0
suffix:semicolon
id|xa_count
OL
id|CD_XA_HEAD
suffix:semicolon
id|xa_count
op_increment
)paren
id|sprintf
c_func
(paren
op_amp
id|msgbuf
(braket
id|xa_count
op_star
l_int|3
)braket
comma
l_string|&quot; %02X&quot;
comma
id|xa_head_buf
(braket
id|xa_count
)braket
)paren
suffix:semicolon
id|msgbuf
(braket
id|xa_count
op_star
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
c_func
(paren
id|DBG_XA1
comma
l_string|&quot;xa head:%s&bslash;n&quot;
comma
id|msgbuf
)paren
suffix:semicolon
)brace
id|data_retrying
op_assign
l_int|0
suffix:semicolon
id|data_tries
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|data_tries
op_ge
l_int|1000
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;sbp_data() statistics: %d waits in %d frames.&bslash;n&quot;
comma
id|data_waits
comma
id|data_tries
)paren
suffix:semicolon
id|data_waits
op_assign
id|data_tries
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|duration
op_assign
id|jiffies
op_minus
id|duration
suffix:semicolon
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;time to read %d frames: %d jiffies .&bslash;n&quot;
comma
id|frame
comma
id|duration
)paren
suffix:semicolon
r_if
c_cond
(paren
id|famT_drive
)paren
(brace
id|wait
op_assign
l_int|8
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|teac
op_eq
l_int|2
)paren
(brace
r_if
c_cond
(paren
(paren
id|i
op_assign
id|CDi_stat_loop_T
c_func
(paren
)paren
)paren
op_eq
op_minus
l_int|1
)paren
r_break
suffix:semicolon
)brace
r_else
(brace
id|sbp_sleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|OUT
c_func
(paren
id|CDo_sel_i_d
comma
l_int|0
)paren
suffix:semicolon
id|i
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|i
op_amp
id|s_not_data_ready
)paren
)paren
(brace
id|OUT
c_func
(paren
id|CDo_sel_i_d
comma
l_int|1
)paren
suffix:semicolon
id|j
op_assign
l_int|0
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|do_16bit
)paren
id|i
op_assign
id|inw
c_func
(paren
id|CDi_data
)paren
suffix:semicolon
r_else
id|i
op_assign
id|inb
c_func
(paren
id|CDi_data
)paren
suffix:semicolon
id|j
op_increment
suffix:semicolon
id|i
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|i
op_amp
id|s_not_data_ready
)paren
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;==========too much data (%d bytes/words)==============.&bslash;n&quot;
comma
id|j
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|i
op_amp
id|s_not_result_ready
)paren
)paren
(brace
id|OUT
c_func
(paren
id|CDo_sel_i_d
comma
l_int|0
)paren
suffix:semicolon
id|l
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|infobuf
(braket
id|l
op_increment
)braket
op_assign
id|inb
c_func
(paren
id|CDi_info
)paren
suffix:semicolon
id|i
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|i
op_amp
id|s_not_result_ready
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|infobuf
(braket
l_int|0
)braket
op_eq
l_int|0x00
)paren
id|success
op_assign
l_int|1
suffix:semicolon
macro_line|#if 1
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|l
suffix:semicolon
id|j
op_increment
)paren
id|sprintf
c_func
(paren
op_amp
id|msgbuf
(braket
id|j
op_star
l_int|3
)braket
comma
l_string|&quot; %02X&quot;
comma
id|infobuf
(braket
id|j
)braket
)paren
suffix:semicolon
id|msgbuf
(braket
id|j
op_star
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;sbp_data info response:%s&bslash;n&quot;
comma
id|msgbuf
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|infobuf
(braket
l_int|0
)braket
op_eq
l_int|0x02
)paren
(brace
id|error_flag
op_increment
suffix:semicolon
r_do
(brace
op_increment
id|recursion
suffix:semicolon
r_if
c_cond
(paren
id|recursion
OG
l_int|1
)paren
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;cmd_out_T READ_ERR recursion (sbp_data): %d !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&bslash;n&quot;
comma
id|recursion
)paren
suffix:semicolon
r_else
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;sbp_data: CMDT_READ_ERR necessary.&bslash;n&quot;
)paren
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
id|CMDT_READ_ERR
suffix:semicolon
id|j
op_assign
id|cmd_out_T
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* !!! recursive here !!! */
op_decrement
id|recursion
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|j
OL
l_int|0
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|error_state
op_assign
id|infobuf
(braket
l_int|2
)braket
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|b3
op_assign
id|infobuf
(braket
l_int|3
)braket
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|b4
op_assign
id|infobuf
(braket
l_int|4
)braket
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_else
(brace
macro_line|#if 0
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;============= waiting for result=================.&bslash;n&quot;
)paren
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
r_while
c_loop
(paren
id|wait
op_decrement
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|error_flag
)paren
multiline_comment|/* must have been spurious D_RDY or (ATTN&amp;&amp;!D_RDY) */
(brace
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;================error flag: %d=================.&bslash;n&quot;
comma
id|error_flag
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;sbp_data: read aborted by drive.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if 1
id|i
op_assign
id|cc_DriveReset
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* ugly fix to prevent a hang */
macro_line|#else
id|i
op_assign
id|cc_ReadError
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fam0LV_drive
)paren
(brace
id|SBPCD_CLI
suffix:semicolon
id|i
op_assign
id|maxtim_data
suffix:semicolon
r_for
c_loop
(paren
id|timeout
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
id|time_before
c_func
(paren
id|jiffies
comma
id|timeout
)paren
suffix:semicolon
id|timeout
op_decrement
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
id|i
op_ne
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|j
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|j
op_amp
id|s_not_data_ready
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|j
op_amp
id|s_not_result_ready
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|j
op_amp
id|s_attention
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ne
l_int|0
op_logical_or
id|time_after_eq
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
r_break
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|i
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;status timeout after READ.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|j
op_amp
id|s_attention
)paren
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;sbp_data: timeout waiting DRV_ATTN - retrying.&bslash;n&quot;
)paren
suffix:semicolon
id|i
op_assign
id|cc_DriveReset
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* ugly fix to prevent a hang */
id|SBPCD_STI
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|SBPCD_STI
suffix:semicolon
)brace
macro_line|#if 0
r_if
c_cond
(paren
op_logical_neg
id|success
)paren
macro_line|#endif 0
r_do
(brace
r_if
c_cond
(paren
id|fam0LV_drive
)paren
id|cc_ReadStatus
c_func
(paren
)paren
suffix:semicolon
macro_line|#if 1
r_if
c_cond
(paren
id|famT_drive
)paren
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;================before ResponseStatus=================.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
macro_line|#endif 1
id|i
op_assign
id|ResponseStatus
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* builds status_bits, returns orig. status (old) or faked p_success (new) */
macro_line|#if 1
r_if
c_cond
(paren
id|famT_drive
)paren
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;================ResponseStatus: %d=================.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
macro_line|#endif 1
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;bad cc_ReadStatus after read: %02X&bslash;n&quot;
comma
id|D_S
(braket
id|d
)braket
dot
id|status_bits
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
(paren
id|fam0LV_drive
)paren
op_logical_and
(paren
op_logical_neg
id|st_check
)paren
op_logical_and
(paren
op_logical_neg
(paren
id|i
op_amp
id|p_success
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st_check
)paren
(brace
id|i
op_assign
id|cc_ReadError
c_func
(paren
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;cc_ReadError was necessary after read: %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fatal_err
)paren
(brace
id|fatal_err
op_assign
l_int|0
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|sbp_first_frame
op_assign
id|D_S
(braket
id|d
)braket
dot
id|sbp_last_frame
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* purge buffer */
id|D_S
(braket
id|d
)braket
dot
id|sbp_current
op_assign
l_int|0
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;sbp_data: fatal_err - retrying.&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|D_S
(braket
id|d
)braket
dot
id|sbp_first_frame
op_assign
id|req
op_member_access_from_pointer
id|sector
op_div
l_int|4
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|sbp_last_frame
op_assign
id|D_S
(braket
id|d
)braket
dot
id|sbp_first_frame
op_plus
id|D_S
(braket
id|d
)braket
dot
id|sbp_read_frames
op_minus
l_int|1
suffix:semicolon
id|sbp_transfer
c_func
(paren
id|req
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; *  Open the device special file.  Check that a disk is in. Read TOC.&n; */
DECL|function|sbpcd_open
r_static
r_int
id|sbpcd_open
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
comma
r_int
id|purpose
)paren
(brace
r_int
id|i
suffix:semicolon
id|i
op_assign
id|MINOR
c_func
(paren
id|cdi-&gt;dev
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|down
c_func
(paren
op_amp
id|ioctl_read_sem
)paren
suffix:semicolon
id|switch_drive
c_func
(paren
id|i
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * try to keep an &quot;open&quot; counter here and lock the door if 0-&gt;1.&n;&t; */
id|msg
c_func
(paren
id|DBG_LCK
comma
l_string|&quot;open_count: %d -&gt; %d&bslash;n&quot;
comma
id|D_S
(braket
id|d
)braket
dot
id|open_count
comma
id|D_S
(braket
id|d
)braket
dot
id|open_count
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|D_S
(braket
id|d
)braket
dot
id|open_count
op_le
l_int|1
)paren
(brace
id|i
op_assign
id|LockDoor
c_func
(paren
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|open_count
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|famT_drive
)paren
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;sbpcd_open: before i=DiskInfo();.&bslash;n&quot;
)paren
suffix:semicolon
id|i
op_assign
id|DiskInfo
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|famT_drive
)paren
id|msg
c_func
(paren
id|DBG_TEA
comma
l_string|&quot;sbpcd_open: after i=DiskInfo();.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|D_S
(braket
id|d
)braket
dot
id|ored_ctl_adr
op_amp
l_int|0x40
)paren
op_eq
l_int|0
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;CD contains no data tracks.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if SAFE_MIXED
id|D_S
(braket
id|d
)braket
dot
id|has_data
op_assign
l_int|0
suffix:semicolon
macro_line|#endif SAFE_MIXED
)brace
macro_line|#if SAFE_MIXED
r_else
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|has_data
OL
l_int|1
)paren
id|D_S
(braket
id|d
)braket
dot
id|has_data
op_assign
l_int|1
suffix:semicolon
macro_line|#endif SAFE_MIXED
)brace
r_if
c_cond
(paren
op_logical_neg
id|st_spinning
)paren
id|cc_SpinUp
c_func
(paren
)paren
suffix:semicolon
id|RETURN_UP
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; *  On close, we flush all sbp blocks from the buffer cache.&n; */
DECL|function|sbpcd_release
r_static
r_void
id|sbpcd_release
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
)paren
(brace
r_int
id|i
suffix:semicolon
id|i
op_assign
id|MINOR
c_func
(paren
id|cdi-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
OL
l_int|0
)paren
op_logical_or
(paren
id|i
op_ge
id|NR_SBPCD
)paren
op_logical_or
(paren
id|D_S
(braket
id|i
)braket
dot
id|drv_id
op_eq
op_minus
l_int|1
)paren
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;release: bad device: %04X&bslash;n&quot;
comma
id|cdi-&gt;dev
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|ioctl_read_sem
)paren
suffix:semicolon
id|switch_drive
c_func
(paren
id|i
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * try to keep an &quot;open&quot; counter here and unlock the door if 1-&gt;0.&n;&t; */
id|msg
c_func
(paren
id|DBG_LCK
comma
l_string|&quot;open_count: %d -&gt; %d&bslash;n&quot;
comma
id|D_S
(braket
id|d
)braket
dot
id|open_count
comma
id|D_S
(braket
id|d
)braket
dot
id|open_count
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|open_count
OG
op_minus
l_int|2
)paren
multiline_comment|/* CDROMEJECT may have been done */
(brace
r_if
c_cond
(paren
op_decrement
id|D_S
(braket
id|d
)braket
dot
id|open_count
op_le
l_int|0
)paren
(brace
id|D_S
(braket
id|d
)braket
dot
id|sbp_first_frame
op_assign
id|D_S
(braket
id|d
)braket
dot
id|sbp_last_frame
op_assign
op_minus
l_int|1
suffix:semicolon
id|invalidate_buffers
c_func
(paren
id|cdi-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|audio_state
op_ne
id|audio_playing
)paren
r_if
c_cond
(paren
id|D_S
(braket
id|d
)braket
dot
id|f_eject
)paren
id|cc_SpinDown
c_func
(paren
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|diskstate_flags
op_and_assign
op_complement
id|cd_size_bit
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|open_count
op_assign
l_int|0
suffix:semicolon
macro_line|#if SAFE_MIXED
id|D_S
(braket
id|d
)braket
dot
id|has_data
op_assign
l_int|0
suffix:semicolon
macro_line|#endif SAFE_MIXED
)brace
)brace
id|up
c_func
(paren
op_amp
id|ioctl_read_sem
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; *&n; */
r_static
r_int
id|sbpcd_media_changed
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
comma
r_int
id|disc_nr
)paren
suffix:semicolon
DECL|variable|sbpcd_dops
r_static
r_struct
id|cdrom_device_ops
id|sbpcd_dops
op_assign
(brace
id|open
suffix:colon
id|sbpcd_open
comma
id|release
suffix:colon
id|sbpcd_release
comma
id|drive_status
suffix:colon
id|sbpcd_drive_status
comma
id|media_changed
suffix:colon
id|sbpcd_media_changed
comma
id|tray_move
suffix:colon
id|sbpcd_tray_move
comma
id|lock_door
suffix:colon
id|sbpcd_lock_door
comma
id|select_speed
suffix:colon
id|sbpcd_select_speed
comma
id|get_last_session
suffix:colon
id|sbpcd_get_last_session
comma
id|get_mcn
suffix:colon
id|sbpcd_get_mcn
comma
id|reset
suffix:colon
id|sbpcd_reset
comma
id|audio_ioctl
suffix:colon
id|sbpcd_audio_ioctl
comma
id|dev_ioctl
suffix:colon
id|sbpcd_dev_ioctl
comma
id|capability
suffix:colon
id|CDC_CLOSE_TRAY
op_or
id|CDC_OPEN_TRAY
op_or
id|CDC_LOCK
op_or
id|CDC_MULTI_SESSION
op_or
id|CDC_MEDIA_CHANGED
op_or
id|CDC_MCN
op_or
id|CDC_PLAY_AUDIO
op_or
id|CDC_IOCTLS
comma
id|n_minors
suffix:colon
l_int|1
comma
)brace
suffix:semicolon
DECL|variable|sbpcd_info
r_static
r_struct
id|cdrom_device_info
id|sbpcd_info
op_assign
(brace
id|ops
suffix:colon
op_amp
id|sbpcd_dops
comma
id|speed
suffix:colon
l_int|2
comma
id|capacity
suffix:colon
l_int|1
comma
id|name
suffix:colon
l_string|&quot;sbpcd&quot;
comma
)brace
suffix:semicolon
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; * accept &quot;kernel command line&quot; parameters &n; * (suggested by Peter MacDonald with SLS 1.03)&n; *&n; * This is only implemented for the first controller. Should be enough to&n; * allow installing with a &quot;strange&quot; distribution kernel.&n; *&n; * use: tell LILO:&n; *                 sbpcd=0x230,SoundBlaster&n; *             or&n; *                 sbpcd=0x300,LaserMate&n; *             or&n; *                 sbpcd=0x338,SoundScape&n; *             or&n; *                 sbpcd=0x2C0,Teac16bit&n; *&n; * (upper/lower case sensitive here - but all-lowercase is ok!!!).&n; *&n; * the address value has to be the CDROM PORT ADDRESS -&n; * not the soundcard base address.&n; * For the SPEA/SoundScape setup, DO NOT specify the &quot;configuration port&quot;&n; * address, but the address which is really used for the CDROM (usually 8&n; * bytes above).&n; *&n; */
macro_line|#if (SBPCD_ISSUE-1)
DECL|function|sbpcd_setup
r_static
r_int
id|sbpcd_setup
c_func
(paren
r_char
op_star
id|s
)paren
macro_line|#else
r_int
id|sbpcd_setup
c_func
(paren
r_char
op_star
id|s
)paren
macro_line|#endif
(brace
r_int
id|p
(braket
l_int|4
)braket
suffix:semicolon
(paren
r_void
)paren
id|get_options
c_func
(paren
id|s
comma
id|ARRAY_SIZE
c_func
(paren
id|p
)paren
comma
id|p
)paren
suffix:semicolon
id|setup_done
op_increment
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INI
comma
l_string|&quot;sbpcd_setup called with %04X,%s&bslash;n&quot;
comma
id|p
(braket
l_int|1
)braket
comma
id|s
)paren
suffix:semicolon
id|sbpro_type
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* default: &quot;LaserMate&quot; */
r_if
c_cond
(paren
id|p
(braket
l_int|0
)braket
OG
l_int|1
)paren
id|sbpro_type
op_assign
id|p
(braket
l_int|2
)braket
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|s
comma
id|str_sb
)paren
)paren
id|sbpro_type
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|s
comma
id|str_sb_l
)paren
)paren
id|sbpro_type
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|s
comma
id|str_sp
)paren
)paren
id|sbpro_type
op_assign
l_int|2
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|s
comma
id|str_sp_l
)paren
)paren
id|sbpro_type
op_assign
l_int|2
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|s
comma
id|str_ss
)paren
)paren
id|sbpro_type
op_assign
l_int|2
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|s
comma
id|str_ss_l
)paren
)paren
id|sbpro_type
op_assign
l_int|2
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|s
comma
id|str_t16
)paren
)paren
id|sbpro_type
op_assign
l_int|3
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|s
comma
id|str_t16_l
)paren
)paren
id|sbpro_type
op_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|p
(braket
l_int|0
)braket
OG
l_int|0
)paren
id|sbpcd_ioaddr
op_assign
id|p
(braket
l_int|1
)braket
suffix:semicolon
id|CDo_command
op_assign
id|sbpcd_ioaddr
suffix:semicolon
id|CDi_info
op_assign
id|sbpcd_ioaddr
suffix:semicolon
id|CDi_status
op_assign
id|sbpcd_ioaddr
op_plus
l_int|1
suffix:semicolon
id|CDo_sel_i_d
op_assign
id|sbpcd_ioaddr
op_plus
l_int|1
suffix:semicolon
id|CDo_reset
op_assign
id|sbpcd_ioaddr
op_plus
l_int|2
suffix:semicolon
id|CDo_enable
op_assign
id|sbpcd_ioaddr
op_plus
l_int|3
suffix:semicolon
id|f_16bit
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sbpro_type
op_eq
l_int|1
)paren
op_logical_or
(paren
id|sbpro_type
op_eq
l_int|3
)paren
)paren
(brace
id|CDi_data
op_assign
id|sbpcd_ioaddr
suffix:semicolon
r_if
c_cond
(paren
id|sbpro_type
op_eq
l_int|3
)paren
(brace
id|f_16bit
op_assign
l_int|1
suffix:semicolon
id|sbpro_type
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_else
id|CDi_data
op_assign
id|sbpcd_ioaddr
op_plus
l_int|2
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;sbpcd=&quot;
comma
id|sbpcd_setup
)paren
suffix:semicolon
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; * Sequoia S-1000 CD-ROM Interface Configuration&n; * as used within SPEA Media FX, Ensonic SoundScape and some Reveal cards&n; * The soundcard has to get jumpered for the interface type &quot;Panasonic&quot;&n; * (not Sony or Mitsumi) and to get soft-configured for&n; *     -&gt; configuration port address&n; *     -&gt; CDROM port offset (num_ports): has to be 8 here. Possibly this&n; *        offset value determines the interface type (none, Panasonic,&n; *        Mitsumi, Sony).&n; *        The interface uses a configuration port (0x320, 0x330, 0x340, 0x350)&n; *        some bytes below the real CDROM address.&n; *         &n; *        For the Panasonic style (LaserMate) interface and the configuration&n; *        port 0x330, we have to use an offset of 8; so, the real CDROM port&n; *        address is 0x338.&n; */
DECL|function|config_spea
r_static
r_int
id|__init
id|config_spea
c_func
(paren
r_void
)paren
(brace
multiline_comment|/*&n;         * base address offset between configuration port and CDROM port,&n;&t; * this probably defines the interface type&n;         *   2 (type=??): 0x00&n;         *   8 (type=LaserMate):0x10&n;         *  16 (type=??):0x20&n;         *  32 (type=??):0x30&n;         */
r_int
id|n_ports
op_assign
l_int|0x10
suffix:semicolon
r_int
id|irq_number
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* off:0x00, 2/9:0x01, 7:0x03, 12:0x05, 15:0x07 */
r_int
id|dma_channel
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* off: 0x00, 0:0x08, 1:0x18, 3:0x38, 5:0x58, 6:0x68 */
r_int
id|dack_polarity
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* L:0x00, H:0x80 */
r_int
id|drq_polarity
op_assign
l_int|0x40
suffix:semicolon
multiline_comment|/* L:0x00, H:0x40 */
r_int
id|i
suffix:semicolon
DECL|macro|SPEA_REG_1
mdefine_line|#define SPEA_REG_1 sbpcd_ioaddr-0x08+4
DECL|macro|SPEA_REG_2
mdefine_line|#define SPEA_REG_2 sbpcd_ioaddr-0x08+5
id|OUT
c_func
(paren
id|SPEA_REG_1
comma
l_int|0xFF
)paren
suffix:semicolon
id|i
op_assign
id|inb
c_func
(paren
id|SPEA_REG_1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
l_int|0x0F
)paren
(brace
id|msg
c_func
(paren
id|DBG_SEQ
comma
l_string|&quot;no SPEA interface at %04X present.&bslash;n&quot;
comma
id|sbpcd_ioaddr
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* no interface found */
)brace
id|OUT
c_func
(paren
id|SPEA_REG_1
comma
l_int|0x04
)paren
suffix:semicolon
id|OUT
c_func
(paren
id|SPEA_REG_2
comma
l_int|0xC0
)paren
suffix:semicolon
id|OUT
c_func
(paren
id|SPEA_REG_1
comma
l_int|0x05
)paren
suffix:semicolon
id|OUT
c_func
(paren
id|SPEA_REG_2
comma
l_int|0x10
op_or
id|drq_polarity
op_or
id|dack_polarity
)paren
suffix:semicolon
macro_line|#if 1
DECL|macro|SPEA_PATTERN
mdefine_line|#define SPEA_PATTERN 0x80
macro_line|#else
mdefine_line|#define SPEA_PATTERN 0x00
macro_line|#endif
id|OUT
c_func
(paren
id|SPEA_REG_1
comma
l_int|0x06
)paren
suffix:semicolon
id|OUT
c_func
(paren
id|SPEA_REG_2
comma
id|dma_channel
op_or
id|irq_number
op_or
id|SPEA_PATTERN
)paren
suffix:semicolon
id|OUT
c_func
(paren
id|SPEA_REG_2
comma
id|dma_channel
op_or
id|irq_number
op_or
id|SPEA_PATTERN
)paren
suffix:semicolon
id|OUT
c_func
(paren
id|SPEA_REG_1
comma
l_int|0x09
)paren
suffix:semicolon
id|i
op_assign
(paren
id|inb
c_func
(paren
id|SPEA_REG_2
)paren
op_amp
l_int|0xCF
)paren
op_or
id|n_ports
suffix:semicolon
id|OUT
c_func
(paren
id|SPEA_REG_2
comma
id|i
)paren
suffix:semicolon
id|sbpro_type
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* acts like a LaserMate interface now */
id|msg
c_func
(paren
id|DBG_SEQ
comma
l_string|&quot;found SoundScape interface at %04X.&bslash;n&quot;
comma
id|sbpcd_ioaddr
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; *  Test for presence of drive and initialize it.&n; *  Called once at boot or load time.&n; */
DECL|variable|devfs_handle
r_static
id|devfs_handle_t
id|devfs_handle
suffix:semicolon
macro_line|#ifdef MODULE
DECL|function|__SBPCD_INIT
r_int
id|__init
id|__SBPCD_INIT
c_func
(paren
r_void
)paren
macro_line|#else
r_int
id|__init
id|SBPCD_INIT
c_func
(paren
r_void
)paren
macro_line|#endif MODULE
(brace
r_char
id|nbuff
(braket
l_int|16
)braket
suffix:semicolon
r_int
id|i
op_assign
l_int|0
comma
id|j
op_assign
l_int|0
suffix:semicolon
r_int
id|addr
(braket
l_int|2
)braket
op_assign
initialization_block
suffix:semicolon
r_int
id|port_index
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;sbpcd.c %s&bslash;n&quot;
comma
id|VERSION
)paren
suffix:semicolon
macro_line|#ifndef MODULE
macro_line|#if DISTRIBUTION
r_if
c_cond
(paren
op_logical_neg
id|setup_done
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;Looking for Matsushita/Panasonic, CreativeLabs, Longshine, TEAC CD-ROM drives&bslash;n&quot;
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;= = = = = = = = = = W A R N I N G = = = = = = = = = =&bslash;n&quot;
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;Auto-Probing can cause a hang (f.e. touching an NE2000 card).&bslash;n&quot;
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;If that happens, you have to reboot and use the&bslash;n&quot;
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;LILO (kernel) command line feature like:&bslash;n&quot;
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;   LILO boot: ... sbpcd=0x230,SoundBlaster&bslash;n&quot;
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;or like:&bslash;n&quot;
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;   LILO boot: ... sbpcd=0x300,LaserMate&bslash;n&quot;
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;or like:&bslash;n&quot;
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;   LILO boot: ... sbpcd=0x338,SoundScape&bslash;n&quot;
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;with your REAL address.&bslash;n&quot;
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;= = = = = = = = = = END of WARNING = = = = = == = = =&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif DISTRIBUTION
id|sbpcd
(braket
l_int|0
)braket
op_assign
id|sbpcd_ioaddr
suffix:semicolon
multiline_comment|/* possibly changed by kernel command line */
id|sbpcd
(braket
l_int|1
)braket
op_assign
id|sbpro_type
suffix:semicolon
multiline_comment|/* possibly changed by kernel command line */
macro_line|#endif MODULE
r_for
c_loop
(paren
id|port_index
op_assign
l_int|0
suffix:semicolon
id|port_index
OL
id|NUM_PROBE
suffix:semicolon
id|port_index
op_add_assign
l_int|2
)paren
(brace
id|addr
(braket
l_int|1
)braket
op_assign
id|sbpcd
(braket
id|port_index
)braket
suffix:semicolon
r_if
c_cond
(paren
id|addr
(braket
l_int|1
)braket
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|addr
(braket
l_int|1
)braket
comma
l_int|4
)paren
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;check_region: %03X is not free.&bslash;n&quot;
comma
id|addr
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sbpcd
(braket
id|port_index
op_plus
l_int|1
)braket
op_eq
l_int|2
)paren
id|type
op_assign
id|str_sp
suffix:semicolon
r_else
r_if
c_cond
(paren
id|sbpcd
(braket
id|port_index
op_plus
l_int|1
)braket
op_eq
l_int|1
)paren
id|type
op_assign
id|str_sb
suffix:semicolon
r_else
r_if
c_cond
(paren
id|sbpcd
(braket
id|port_index
op_plus
l_int|1
)braket
op_eq
l_int|3
)paren
id|type
op_assign
id|str_t16
suffix:semicolon
r_else
id|type
op_assign
id|str_lm
suffix:semicolon
id|sbpcd_setup
c_func
(paren
(paren
r_char
op_star
)paren
id|type
)paren
suffix:semicolon
macro_line|#if DISTRIBUTION
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;Scanning 0x%X (%s)...&bslash;n&quot;
comma
id|CDo_command
comma
id|type
)paren
suffix:semicolon
macro_line|#endif DISTRIBUTION
r_if
c_cond
(paren
id|sbpcd
(braket
id|port_index
op_plus
l_int|1
)braket
op_eq
l_int|2
)paren
(brace
id|i
op_assign
id|config_spea
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_continue
suffix:semicolon
)brace
macro_line|#ifdef PATH_CHECK
r_if
c_cond
(paren
id|check_card
c_func
(paren
id|addr
(braket
l_int|1
)braket
)paren
)paren
r_continue
suffix:semicolon
macro_line|#endif PATH_CHECK
id|i
op_assign
id|check_drives
c_func
(paren
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INI
comma
l_string|&quot;check_drives done.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
l_int|0
)paren
r_break
suffix:semicolon
multiline_comment|/* drive found */
)brace
multiline_comment|/* end of cycling through the set of possible I/O port addresses */
r_if
c_cond
(paren
id|ndrives
op_eq
l_int|0
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;No drive found.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef MODULE
r_return
op_minus
id|EIO
suffix:semicolon
macro_line|#else
r_goto
id|init_done
suffix:semicolon
macro_line|#endif MODULE
)brace
r_if
c_cond
(paren
id|port_index
OG
l_int|0
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;You should read linux/Documentation/cdrom/sbpcd&bslash;n&quot;
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;and then configure sbpcd.h for your hardware.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|check_datarate
c_func
(paren
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INI
comma
l_string|&quot;check_datarate done.&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|NR_SBPCD
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|D_S
(braket
id|j
)braket
dot
id|drv_id
op_eq
op_minus
l_int|1
)paren
r_continue
suffix:semicolon
id|switch_drive
c_func
(paren
id|j
)paren
suffix:semicolon
macro_line|#if 1
r_if
c_cond
(paren
op_logical_neg
id|famL_drive
)paren
id|cc_DriveReset
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif 0
r_if
c_cond
(paren
op_logical_neg
id|st_spinning
)paren
id|cc_SpinUp
c_func
(paren
)paren
suffix:semicolon
id|D_S
(braket
id|j
)braket
dot
id|sbp_first_frame
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* First frame in buffer */
id|D_S
(braket
id|j
)braket
dot
id|sbp_last_frame
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Last frame in buffer  */
id|D_S
(braket
id|j
)braket
dot
id|sbp_read_frames
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Number of frames being read to buffer */
id|D_S
(braket
id|j
)braket
dot
id|sbp_current
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Frame being currently read */
id|D_S
(braket
id|j
)braket
dot
id|CD_changed
op_assign
l_int|1
suffix:semicolon
id|D_S
(braket
id|j
)braket
dot
id|frame_size
op_assign
id|CD_FRAMESIZE
suffix:semicolon
id|D_S
(braket
id|j
)braket
dot
id|f_eject
op_assign
l_int|0
suffix:semicolon
macro_line|#if EJECT
r_if
c_cond
(paren
op_logical_neg
id|fam0_drive
)paren
id|D_S
(braket
id|j
)braket
dot
id|f_eject
op_assign
l_int|1
suffix:semicolon
macro_line|#endif EJECT
id|cc_ReadStatus
c_func
(paren
)paren
suffix:semicolon
id|i
op_assign
id|ResponseStatus
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* returns orig. status or p_busy_new */
r_if
c_cond
(paren
id|famT_drive
)paren
id|i
op_assign
id|ResponseStatus
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* returns orig. status or p_busy_new */
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|i
op_ne
op_minus
l_int|402
)paren
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;init: ResponseStatus returns %d.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|st_check
)paren
(brace
id|i
op_assign
id|cc_ReadError
c_func
(paren
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INI
comma
l_string|&quot;init: cc_ReadError returns %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
)brace
id|msg
c_func
(paren
id|DBG_INI
comma
l_string|&quot;init: first GetStatus: %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_LCS
comma
l_string|&quot;init: first GetStatus: error_byte=%d&bslash;n&quot;
comma
id|D_S
(braket
id|j
)braket
dot
id|error_byte
)paren
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|j
)braket
dot
id|error_byte
op_eq
id|aud_12
)paren
(brace
id|timeout
op_assign
id|jiffies
op_plus
l_int|2
op_star
id|HZ
suffix:semicolon
r_do
(brace
id|i
op_assign
id|GetStatus
c_func
(paren
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_INI
comma
l_string|&quot;init: second GetStatus: %02X&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|msg
c_func
(paren
id|DBG_LCS
comma
l_string|&quot;init: second GetStatus: error_byte=%d&bslash;n&quot;
comma
id|D_S
(braket
id|j
)braket
dot
id|error_byte
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|st_caddy_in
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
op_logical_neg
id|st_diskok
)paren
op_logical_or
id|time_after
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
suffix:semicolon
)brace
id|i
op_assign
id|SetSpeed
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
l_int|0
)paren
id|D_S
(braket
id|j
)braket
dot
id|CD_changed
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Turn on the CD audio channels.&n;&t; * The addresses are obtained from SOUND_BASE (see sbpcd.h).&n;&t; */
macro_line|#if SOUND_BASE
id|OUT
c_func
(paren
id|MIXER_addr
comma
id|MIXER_CD_Volume
)paren
suffix:semicolon
multiline_comment|/* select SB Pro mixer register */
id|OUT
c_func
(paren
id|MIXER_data
comma
l_int|0xCC
)paren
suffix:semicolon
multiline_comment|/* one nibble per channel, max. value: 0xFF */
macro_line|#endif SOUND_BASE
r_if
c_cond
(paren
id|devfs_register_blkdev
c_func
(paren
id|MAJOR_NR
comma
id|major_name
comma
op_amp
id|cdrom_fops
)paren
op_ne
l_int|0
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;Can&squot;t get MAJOR %d for Matsushita CDROM&bslash;n&quot;
comma
id|MAJOR_NR
)paren
suffix:semicolon
macro_line|#ifdef MODULE
r_return
op_minus
id|EIO
suffix:semicolon
macro_line|#else
r_goto
id|init_done
suffix:semicolon
macro_line|#endif MODULE
)brace
id|blk_init_queue
c_func
(paren
id|BLK_DEFAULT_QUEUE
c_func
(paren
id|MAJOR_NR
)paren
comma
id|DEVICE_REQUEST
)paren
suffix:semicolon
id|blk_queue_headactive
c_func
(paren
id|BLK_DEFAULT_QUEUE
c_func
(paren
id|MAJOR_NR
)paren
comma
l_int|0
)paren
suffix:semicolon
id|read_ahead
(braket
id|MAJOR_NR
)braket
op_assign
id|buffers
op_star
(paren
id|CD_FRAMESIZE
op_div
l_int|512
)paren
suffix:semicolon
id|request_region
c_func
(paren
id|CDo_command
comma
l_int|4
comma
id|major_name
)paren
suffix:semicolon
id|devfs_handle
op_assign
id|devfs_mk_dir
(paren
l_int|NULL
comma
l_string|&quot;sbp&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|NR_SBPCD
suffix:semicolon
id|j
op_increment
)paren
(brace
r_struct
id|cdrom_device_info
op_star
id|sbpcd_infop
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|j
)braket
dot
id|drv_id
op_eq
op_minus
l_int|1
)paren
r_continue
suffix:semicolon
id|switch_drive
c_func
(paren
id|j
)paren
suffix:semicolon
macro_line|#if SAFE_MIXED
id|D_S
(braket
id|j
)braket
dot
id|has_data
op_assign
l_int|0
suffix:semicolon
macro_line|#endif SAFE_MIXED
multiline_comment|/*&n;&t;&t; * allocate memory for the frame buffers&n;&t;&t; */
id|D_S
(braket
id|j
)braket
dot
id|aud_buf
op_assign
l_int|NULL
suffix:semicolon
id|D_S
(braket
id|j
)braket
dot
id|sbp_audsiz
op_assign
l_int|0
suffix:semicolon
id|D_S
(braket
id|j
)braket
dot
id|sbp_bufsiz
op_assign
id|buffers
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|j
)braket
dot
id|drv_type
op_amp
id|drv_fam1
)paren
r_if
c_cond
(paren
id|READ_AUDIO
OG
l_int|0
)paren
id|D_S
(braket
id|j
)braket
dot
id|sbp_audsiz
op_assign
id|READ_AUDIO
suffix:semicolon
id|D_S
(braket
id|j
)braket
dot
id|sbp_buf
op_assign
(paren
id|u_char
op_star
)paren
id|vmalloc
c_func
(paren
id|D_S
(braket
id|j
)braket
dot
id|sbp_bufsiz
op_star
id|CD_FRAMESIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|j
)braket
dot
id|sbp_buf
op_eq
l_int|NULL
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;data buffer (%d frames) not available.&bslash;n&quot;
comma
id|D_S
(braket
id|j
)braket
dot
id|sbp_bufsiz
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|devfs_unregister_blkdev
c_func
(paren
id|MAJOR_NR
comma
id|major_name
)paren
op_eq
op_minus
id|EINVAL
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Can&squot;t unregister %s&bslash;n&quot;
comma
id|major_name
)paren
suffix:semicolon
)brace
id|release_region
c_func
(paren
id|CDo_command
comma
l_int|4
)paren
suffix:semicolon
id|blk_cleanup_queue
c_func
(paren
id|BLK_DEFAULT_QUEUE
c_func
(paren
id|MAJOR_NR
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;data buffer size: %d frames.&bslash;n&quot;
comma
id|buffers
)paren
suffix:semicolon
macro_line|#endif MODULE
r_if
c_cond
(paren
id|D_S
(braket
id|j
)braket
dot
id|sbp_audsiz
OG
l_int|0
)paren
(brace
id|D_S
(braket
id|j
)braket
dot
id|aud_buf
op_assign
(paren
id|u_char
op_star
)paren
id|vmalloc
c_func
(paren
id|D_S
(braket
id|j
)braket
dot
id|sbp_audsiz
op_star
id|CD_FRAMESIZE_RAW
)paren
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|j
)braket
dot
id|aud_buf
op_eq
l_int|NULL
)paren
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;audio buffer (%d frames) not available.&bslash;n&quot;
comma
id|D_S
(braket
id|j
)braket
dot
id|sbp_audsiz
)paren
suffix:semicolon
r_else
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;audio buffer size: %d frames.&bslash;n&quot;
comma
id|D_S
(braket
id|j
)braket
dot
id|sbp_audsiz
)paren
suffix:semicolon
)brace
id|sbpcd_infop
op_assign
id|vmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|cdrom_device_info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbpcd_infop
op_eq
l_int|NULL
)paren
(brace
id|release_region
c_func
(paren
id|CDo_command
comma
l_int|4
)paren
suffix:semicolon
id|blk_cleanup_queue
c_func
(paren
id|BLK_DEFAULT_QUEUE
c_func
(paren
id|MAJOR_NR
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|D_S
(braket
id|j
)braket
dot
id|sbpcd_infop
op_assign
id|sbpcd_infop
suffix:semicolon
id|memcpy
(paren
id|sbpcd_infop
comma
op_amp
id|sbpcd_info
comma
r_sizeof
(paren
r_struct
id|cdrom_device_info
)paren
)paren
suffix:semicolon
id|sbpcd_infop-&gt;dev
op_assign
id|MKDEV
c_func
(paren
id|MAJOR_NR
comma
id|j
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|sbpcd_infop-&gt;name
comma
id|major_name
comma
r_sizeof
(paren
id|sbpcd_infop-&gt;name
)paren
)paren
suffix:semicolon
id|sprintf
(paren
id|nbuff
comma
l_string|&quot;c%dt%d/cd&quot;
comma
id|SBPCD_ISSUE
op_minus
l_int|1
comma
id|D_S
(braket
id|j
)braket
dot
id|drv_id
)paren
suffix:semicolon
id|sbpcd_infop-&gt;de
op_assign
id|devfs_register
(paren
id|devfs_handle
comma
id|nbuff
comma
id|DEVFS_FL_DEFAULT
comma
id|MAJOR_NR
comma
id|j
comma
id|S_IFBLK
op_or
id|S_IRUGO
op_or
id|S_IWUGO
comma
op_amp
id|cdrom_fops
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|register_cdrom
c_func
(paren
id|sbpcd_infop
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; sbpcd: Unable to register with Uniform CD-ROm driver&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * set the block size&n;&t;&t; */
id|sbpcd_blocksizes
(braket
id|j
)braket
op_assign
id|CD_FRAMESIZE
suffix:semicolon
)brace
id|blksize_size
(braket
id|MAJOR_NR
)braket
op_assign
id|sbpcd_blocksizes
suffix:semicolon
macro_line|#ifndef MODULE
id|init_done
suffix:colon
macro_line|#if !(SBPCD_ISSUE-1)
macro_line|#ifdef CONFIG_SBPCD2
id|sbpcd2_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif CONFIG_SBPCD2
macro_line|#ifdef CONFIG_SBPCD3
id|sbpcd3_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif CONFIG_SBPCD3
macro_line|#ifdef CONFIG_SBPCD4
id|sbpcd4_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif CONFIG_SBPCD4
macro_line|#endif !(SBPCD_ISSUE-1)
macro_line|#endif MODULE
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
macro_line|#ifdef MODULE
DECL|function|sbpcd_exit
r_void
id|sbpcd_exit
c_func
(paren
r_void
)paren
(brace
r_int
id|j
suffix:semicolon
r_if
c_cond
(paren
(paren
id|devfs_unregister_blkdev
c_func
(paren
id|MAJOR_NR
comma
id|major_name
)paren
op_eq
op_minus
id|EINVAL
)paren
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;What&squot;s that: can&squot;t unregister %s.&bslash;n&quot;
comma
id|major_name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|release_region
c_func
(paren
id|CDo_command
comma
l_int|4
)paren
suffix:semicolon
id|blk_cleanup_queue
c_func
(paren
id|BLK_DEFAULT_QUEUE
c_func
(paren
id|MAJOR_NR
)paren
)paren
suffix:semicolon
id|devfs_unregister
(paren
id|devfs_handle
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|NR_SBPCD
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|D_S
(braket
id|j
)braket
dot
id|drv_id
op_eq
op_minus
l_int|1
)paren
r_continue
suffix:semicolon
id|vfree
c_func
(paren
id|D_S
(braket
id|j
)braket
dot
id|sbp_buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|j
)braket
dot
id|sbp_audsiz
OG
l_int|0
)paren
id|vfree
c_func
(paren
id|D_S
(braket
id|j
)braket
dot
id|aud_buf
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|unregister_cdrom
c_func
(paren
id|D_S
(braket
id|j
)braket
dot
id|sbpcd_infop
)paren
op_eq
op_minus
id|EINVAL
)paren
)paren
(brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;What&squot;s that: can&squot;t unregister info %s.&bslash;n&quot;
comma
id|major_name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|vfree
c_func
(paren
id|D_S
(braket
id|j
)braket
dot
id|sbpcd_infop
)paren
suffix:semicolon
)brace
id|msg
c_func
(paren
id|DBG_INF
comma
l_string|&quot;%s module released.&bslash;n&quot;
comma
id|major_name
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|variable|__SBPCD_INIT
id|module_init
c_func
(paren
id|__SBPCD_INIT
)paren
multiline_comment|/*HACK!*/
suffix:semicolon
macro_line|#endif
DECL|variable|sbpcd_exit
id|module_exit
c_func
(paren
id|sbpcd_exit
)paren
suffix:semicolon
macro_line|#endif MODULE
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; * Check if the media has changed in the CD-ROM drive.&n; * used externally (isofs/inode.c, fs/buffer.c)&n; */
DECL|function|sbpcd_chk_disk_change
r_static
r_int
id|sbpcd_chk_disk_change
c_func
(paren
id|kdev_t
id|full_dev
)paren
(brace
r_int
id|i
suffix:semicolon
id|msg
c_func
(paren
id|DBG_CHK
comma
l_string|&quot;media_check (%d) called&bslash;n&quot;
comma
id|MINOR
c_func
(paren
id|full_dev
)paren
)paren
suffix:semicolon
id|i
op_assign
id|MINOR
c_func
(paren
id|full_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|D_S
(braket
id|i
)braket
dot
id|CD_changed
op_eq
l_int|0xFF
)paren
(brace
id|D_S
(braket
id|i
)braket
dot
id|CD_changed
op_assign
l_int|0
suffix:semicolon
id|msg
c_func
(paren
id|DBG_CHK
comma
l_string|&quot;medium changed (drive %d)&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
multiline_comment|/* BUG! Should invalidate buffers! --AJK */
id|invalidate_buffers
c_func
(paren
id|full_dev
)paren
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|diskstate_flags
op_and_assign
op_complement
id|toc_bit
suffix:semicolon
id|D_S
(braket
id|d
)braket
dot
id|diskstate_flags
op_and_assign
op_complement
id|cd_size_bit
suffix:semicolon
macro_line|#if SAFE_MIXED
id|D_S
(braket
id|d
)braket
dot
id|has_data
op_assign
l_int|0
suffix:semicolon
macro_line|#endif SAFE_MIXED
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_else
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|sbpcd_media_changed
r_static
r_int
id|sbpcd_media_changed
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
comma
r_int
id|disc_nr
)paren
(brace
r_return
id|sbpcd_chk_disk_change
c_func
(paren
id|cdi-&gt;dev
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; * Overrides for Emacs so that we follow Linus&squot;s tabbing style.&n; * Emacs will notice this stuff at the end of the file and automatically&n; * adjust the settings for this buffer only.  This must remain at the end&n; * of the file. &n; * ---------------------------------------------------------------------------&n; * Local variables:&n; * c-indent-level: 8&n; * c-brace-imaginary-offset: 0&n; * c-brace-offset: -8&n; * c-argdecl-indent: 8&n; * c-label-offset: -8&n; * c-continued-statement-offset: 8&n; * c-continued-brace-offset: 0&n; * End:&n; */
eof
