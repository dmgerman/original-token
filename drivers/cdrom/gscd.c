DECL|macro|GSCD_VERSION
mdefine_line|#define GSCD_VERSION &quot;0.4a Oliver Raupach &lt;raupach@nwfs1.rz.fh-hannover.de&gt;&quot;
multiline_comment|/*&n;&t;linux/drivers/block/gscd.c - GoldStar R420 CDROM driver&n;&n;        Copyright (C) 1995  Oliver Raupach &lt;raupach@nwfs1.rz.fh-hannover.de&gt;&n;        based upon pre-works by   Eberhard Moenkeberg &lt;emoenke@gwdg.de&gt;&n;        &n;&n;        For all kind of other information about the GoldStar CDROM&n;        and this Linux device driver I installed a WWW-URL:&n;        http://linux.rz.fh-hannover.de/~raupach        &n;&n;&n;             If you are the editor of a Linux CD, you should&n;             enable gscd.c within your boot floppy kernel and&n;             send me one of your CDs for free.&n;&n;&n;        --------------------------------------------------------------------&n;&t;This program is free software; you can redistribute it and/or modify&n;&t;it under the terms of the GNU General Public License as published by&n;&t;the Free Software Foundation; either version 2, or (at your option)&n;&t;any later version.&n;&n;&t;This program is distributed in the hope that it will be useful,&n;&t;but WITHOUT ANY WARRANTY; without even the implied warranty of&n;&t;MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;&t;GNU General Public License for more details.&n;&n;&t;You should have received a copy of the GNU General Public License&n;&t;along with this program; if not, write to the Free Software&n;&t;Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n;&t;&n;&t;--------------------------------------------------------------------&n;&t;&n;&t;9 November 1999 -- Make kernel-parameter implementation work with 2.3.x &n;&t;                   Removed init_module &amp; cleanup_module in favor of &n;&t;&t;   &t;   module_init &amp; module_exit.&n;&t;&t;&t;   Torben Mathiasen &lt;tmm@image.dk&gt;&n;&n;*/
multiline_comment|/* These settings are for various debug-level. Leave they untouched ... */
DECL|macro|NO_GSCD_DEBUG
mdefine_line|#define  NO_GSCD_DEBUG 
DECL|macro|NO_IOCTL_DEBUG
mdefine_line|#define  NO_IOCTL_DEBUG
DECL|macro|NO_MODULE_DEBUG
mdefine_line|#define  NO_MODULE_DEBUG
DECL|macro|NO_FUTURE_WORK
mdefine_line|#define  NO_FUTURE_WORK
multiline_comment|/*------------------------*/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/cdrom.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/devfs_fs_kernel.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
DECL|macro|MAJOR_NR
mdefine_line|#define MAJOR_NR GOLDSTAR_CDROM_MAJOR
macro_line|#include &lt;linux/blk.h&gt;
DECL|macro|gscd_port
mdefine_line|#define gscd_port gscd /* for compatible parameter passing with &quot;insmod&quot; */
macro_line|#include &quot;gscd.h&quot;
DECL|variable|gscd_blocksizes
r_static
r_int
id|gscd_blocksizes
(braket
l_int|1
)braket
op_assign
(brace
l_int|512
)brace
suffix:semicolon
DECL|variable|gscdPresent
r_static
r_int
id|gscdPresent
op_assign
l_int|0
suffix:semicolon
DECL|variable|gscd_buf
r_static
r_int
r_char
id|gscd_buf
(braket
l_int|2048
)braket
suffix:semicolon
multiline_comment|/* buffer for block size conversion */
DECL|variable|gscd_bn
r_static
r_int
id|gscd_bn
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|gscd_port
r_static
r_int
id|gscd_port
op_assign
id|GSCD_BASE_ADDR
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|gscd
comma
l_string|&quot;h&quot;
)paren
suffix:semicolon
multiline_comment|/* Kommt spaeter vielleicht noch mal dran ...&n; *    static DECLARE_WAIT_QUEUE_HEAD(gscd_waitq);&n; */
r_static
r_void
id|gscd_transfer
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|gscd_read_cmd
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|gscd_hsg2msf
(paren
r_int
id|hsg
comma
r_struct
id|msf
op_star
id|msf
)paren
suffix:semicolon
r_static
r_void
id|gscd_bin2bcd
(paren
r_int
r_char
op_star
id|p
)paren
suffix:semicolon
multiline_comment|/* Schnittstellen zum Kern/FS */
r_static
r_void
id|do_gscd_request
(paren
id|request_queue_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|__do_gscd_request
(paren
r_int
r_int
id|dummy
)paren
suffix:semicolon
r_static
r_int
id|gscd_ioctl
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
comma
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
r_static
r_int
id|gscd_open
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
)paren
suffix:semicolon
r_static
r_int
id|gscd_release
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
)paren
suffix:semicolon
r_static
r_int
id|check_gscd_med_chg
(paren
id|kdev_t
)paren
suffix:semicolon
multiline_comment|/*      GoldStar Funktionen    */
r_static
r_void
id|cc_Reset
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|wait_drv_ready
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|find_drives
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|cmd_out
(paren
r_int
comma
r_char
op_star
comma
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|cmd_status
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|cc_Ident
(paren
r_char
op_star
)paren
suffix:semicolon
r_static
r_void
id|cc_SetSpeed
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|init_cd_drive
(paren
r_int
)paren
suffix:semicolon
r_static
r_int
id|get_status
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|clear_Audio
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|cc_invalidate
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/* some things for the next version */
macro_line|#ifdef FUTURE_WORK
r_static
r_void
id|update_state
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|gscd_msf2hsg
(paren
r_struct
id|msf
op_star
id|mp
)paren
suffix:semicolon
r_static
r_int
id|gscd_bcd2bin
(paren
r_int
r_char
id|bcd
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*    common GoldStar Initialization    */
r_static
r_int
id|my_gscd_init
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/*      lo-level cmd-Funktionen    */
r_static
r_void
id|cmd_info_in
(paren
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|cmd_end
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|cmd_read_b
(paren
r_char
op_star
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|cmd_read_w
(paren
r_char
op_star
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|cmd_unit_alive
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|cmd_write_cmd
(paren
r_char
op_star
)paren
suffix:semicolon
multiline_comment|/*      GoldStar Variablen     */
DECL|variable|curr_drv_state
r_static
r_int
id|curr_drv_state
suffix:semicolon
DECL|variable|drv_states
r_static
r_int
id|drv_states
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|drv_mode
r_static
r_int
id|drv_mode
suffix:semicolon
DECL|variable|disk_state
r_static
r_int
id|disk_state
suffix:semicolon
DECL|variable|speed
r_static
r_int
id|speed
suffix:semicolon
DECL|variable|ndrives
r_static
r_int
id|ndrives
suffix:semicolon
DECL|variable|drv_num_read
r_static
r_int
r_char
id|drv_num_read
suffix:semicolon
DECL|variable|f_dsk_valid
r_static
r_int
r_char
id|f_dsk_valid
suffix:semicolon
DECL|variable|current_drive
r_static
r_int
r_char
id|current_drive
suffix:semicolon
DECL|variable|f_drv_ok
r_static
r_int
r_char
id|f_drv_ok
suffix:semicolon
DECL|variable|f_AudioPlay
r_static
r_char
id|f_AudioPlay
suffix:semicolon
DECL|variable|f_AudioPause
r_static
r_char
id|f_AudioPause
suffix:semicolon
DECL|variable|AudioStart_m
r_static
r_int
id|AudioStart_m
suffix:semicolon
DECL|variable|AudioStart_f
r_static
r_int
id|AudioStart_f
suffix:semicolon
DECL|variable|AudioEnd_m
r_static
r_int
id|AudioEnd_m
suffix:semicolon
DECL|variable|AudioEnd_f
r_static
r_int
id|AudioEnd_f
suffix:semicolon
DECL|variable|gscd_timer
r_static
r_struct
id|timer_list
id|gscd_timer
suffix:semicolon
DECL|variable|gscd_fops
r_static
r_struct
id|block_device_operations
id|gscd_fops
op_assign
(brace
id|open
suffix:colon
id|gscd_open
comma
id|release
suffix:colon
id|gscd_release
comma
id|ioctl
suffix:colon
id|gscd_ioctl
comma
id|check_media_change
suffix:colon
id|check_gscd_med_chg
comma
)brace
suffix:semicolon
multiline_comment|/* &n; * Checking if the media has been changed&n; * (not yet implemented)&n; */
DECL|function|check_gscd_med_chg
r_static
r_int
id|check_gscd_med_chg
(paren
id|kdev_t
id|full_dev
)paren
(brace
r_int
id|target
suffix:semicolon
id|target
op_assign
id|MINOR
c_func
(paren
id|full_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|target
OG
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;GSCD: GoldStar CD-ROM request error: invalid device.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef GSCD_DEBUG
id|printk
(paren
l_string|&quot;gscd: check_med_change&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifndef MODULE
multiline_comment|/* Using new interface for kernel-parameters */
DECL|function|gscd_setup
r_static
r_int
id|__init
id|gscd_setup
(paren
r_char
op_star
id|str
)paren
(brace
r_int
id|ints
(braket
l_int|2
)braket
suffix:semicolon
(paren
r_void
)paren
id|get_options
c_func
(paren
id|str
comma
id|ARRAY_SIZE
c_func
(paren
id|ints
)paren
comma
id|ints
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
OG
l_int|0
)paren
(brace
id|gscd_port
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;gscd=&quot;
comma
id|gscd_setup
)paren
suffix:semicolon
macro_line|#endif
DECL|function|gscd_ioctl
r_static
r_int
id|gscd_ioctl
(paren
r_struct
id|inode
op_star
id|ip
comma
r_struct
id|file
op_star
id|fp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
r_char
id|to_do
(braket
l_int|10
)braket
suffix:semicolon
r_int
r_char
id|dummy
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|CDROMSTART
suffix:colon
multiline_comment|/* Spin up the drive */
multiline_comment|/* Don&squot;t think we can do this.  Even if we could,&n; &t;&t; * I think the drive times out and stops after a while&n;&t;&t; * anyway.  For now, ignore it.&n;&t;&t; */
r_return
l_int|0
suffix:semicolon
r_case
id|CDROMRESUME
suffix:colon
multiline_comment|/* keine Ahnung was das ist */
r_return
l_int|0
suffix:semicolon
r_case
id|CDROMEJECT
suffix:colon
id|cmd_status
(paren
)paren
suffix:semicolon
id|to_do
(braket
l_int|0
)braket
op_assign
id|CMD_TRAY_CTL
suffix:semicolon
id|cmd_out
(paren
id|TYPE_INFO
comma
(paren
r_char
op_star
)paren
op_amp
id|to_do
comma
(paren
r_char
op_star
)paren
op_amp
id|dummy
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Take care of the different block sizes between cdrom and Linux.&n; * When Linux gets variable block sizes this will probably go away.&n; */
DECL|function|gscd_transfer
r_static
r_void
id|gscd_transfer
(paren
r_void
)paren
(brace
r_int
id|offs
suffix:semicolon
r_while
c_loop
(paren
id|CURRENT
op_member_access_from_pointer
id|nr_sectors
OG
l_int|0
op_logical_and
id|gscd_bn
op_eq
id|CURRENT
op_member_access_from_pointer
id|sector
op_div
l_int|4
)paren
(brace
id|offs
op_assign
(paren
id|CURRENT
op_member_access_from_pointer
id|sector
op_amp
l_int|3
)paren
op_star
l_int|512
suffix:semicolon
id|memcpy
c_func
(paren
id|CURRENT
op_member_access_from_pointer
id|buffer
comma
id|gscd_buf
op_plus
id|offs
comma
l_int|512
)paren
suffix:semicolon
id|CURRENT
op_member_access_from_pointer
id|nr_sectors
op_decrement
suffix:semicolon
id|CURRENT
op_member_access_from_pointer
id|sector
op_increment
suffix:semicolon
id|CURRENT
op_member_access_from_pointer
id|buffer
op_add_assign
l_int|512
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * I/O request routine called from Linux kernel.&n; */
DECL|function|do_gscd_request
r_static
r_void
id|do_gscd_request
(paren
id|request_queue_t
op_star
id|q
)paren
(brace
id|__do_gscd_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|__do_gscd_request
r_static
r_void
id|__do_gscd_request
(paren
r_int
r_int
id|dummy
)paren
(brace
r_int
r_int
id|block
comma
id|dev
suffix:semicolon
r_int
r_int
id|nsect
suffix:semicolon
id|repeat
suffix:colon
r_if
c_cond
(paren
id|QUEUE_EMPTY
op_logical_or
id|CURRENT-&gt;rq_status
op_eq
id|RQ_INACTIVE
)paren
r_goto
id|out
suffix:semicolon
id|INIT_REQUEST
suffix:semicolon
id|dev
op_assign
id|MINOR
c_func
(paren
id|CURRENT-&gt;rq_dev
)paren
suffix:semicolon
id|block
op_assign
id|CURRENT-&gt;sector
suffix:semicolon
id|nsect
op_assign
id|CURRENT-&gt;nr_sectors
suffix:semicolon
r_if
c_cond
(paren
id|QUEUE_EMPTY
op_logical_or
id|CURRENT
op_member_access_from_pointer
id|sector
op_eq
op_minus
l_int|1
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|CURRENT
op_member_access_from_pointer
id|cmd
op_ne
id|READ
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;GSCD: bad cmd %d&bslash;n&quot;
comma
id|CURRENT
op_member_access_from_pointer
id|cmd
)paren
suffix:semicolon
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_goto
id|repeat
suffix:semicolon
)brace
r_if
c_cond
(paren
id|MINOR
c_func
(paren
id|CURRENT
op_member_access_from_pointer
id|rq_dev
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;GSCD: this version supports only one device&bslash;n&quot;
)paren
suffix:semicolon
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_goto
id|repeat
suffix:semicolon
)brace
id|gscd_transfer
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* if we satisfied the request from the buffer, we&squot;re done. */
r_if
c_cond
(paren
id|CURRENT
op_member_access_from_pointer
id|nr_sectors
op_eq
l_int|0
)paren
(brace
id|end_request
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_goto
id|repeat
suffix:semicolon
)brace
macro_line|#ifdef GSCD_DEBUG
id|printk
(paren
l_string|&quot;GSCD: dev %d, block %d, nsect %d&bslash;n&quot;
comma
id|dev
comma
id|block
comma
id|nsect
)paren
suffix:semicolon
macro_line|#endif
id|gscd_read_cmd
(paren
)paren
suffix:semicolon
id|out
suffix:colon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Check the result of the set-mode command.  On success, send the&n; * read-data command.&n; */
r_static
r_void
DECL|function|gscd_read_cmd
id|gscd_read_cmd
(paren
r_void
)paren
(brace
r_int
id|block
suffix:semicolon
r_struct
id|gscd_Play_msf
id|gscdcmd
suffix:semicolon
r_char
id|cmd
(braket
)braket
op_assign
(brace
id|CMD_READ
comma
l_int|0x80
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|1
)brace
suffix:semicolon
multiline_comment|/* cmd mode M-S-F secth sectl */
id|cmd_status
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|disk_state
op_amp
(paren
id|ST_NO_DISK
op_or
id|ST_DOOR_OPEN
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;GSCD: no disk or door open&bslash;n&quot;
)paren
suffix:semicolon
id|end_request
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|disk_state
op_amp
id|ST_INVALID
)paren
(brace
id|printk
(paren
l_string|&quot;GSCD: disk invalid&bslash;n&quot;
)paren
suffix:semicolon
id|end_request
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|gscd_bn
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* purge our buffer */
id|block
op_assign
id|CURRENT
op_member_access_from_pointer
id|sector
op_div
l_int|4
suffix:semicolon
id|gscd_hsg2msf
c_func
(paren
id|block
comma
op_amp
id|gscdcmd.start
)paren
suffix:semicolon
multiline_comment|/* cvt to msf format */
id|cmd
(braket
l_int|2
)braket
op_assign
id|gscdcmd.start.min
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
id|gscdcmd.start.sec
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|gscdcmd.start.frame
suffix:semicolon
macro_line|#ifdef GSCD_DEBUG
id|printk
(paren
l_string|&quot;GSCD: read msf %d:%d:%d&bslash;n&quot;
comma
id|cmd
(braket
l_int|2
)braket
comma
id|cmd
(braket
l_int|3
)braket
comma
id|cmd
(braket
l_int|4
)braket
)paren
suffix:semicolon
macro_line|#endif 
id|cmd_out
(paren
id|TYPE_DATA
comma
(paren
r_char
op_star
)paren
op_amp
id|cmd
comma
(paren
r_char
op_star
)paren
op_amp
id|gscd_buf
(braket
l_int|0
)braket
comma
l_int|1
)paren
suffix:semicolon
id|gscd_bn
op_assign
id|CURRENT
op_member_access_from_pointer
id|sector
op_div
l_int|4
suffix:semicolon
id|gscd_transfer
c_func
(paren
)paren
suffix:semicolon
id|end_request
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
)brace
id|SET_TIMER
c_func
(paren
id|__do_gscd_request
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Open the device special file.  Check that a disk is in.&n; */
DECL|function|gscd_open
r_static
r_int
id|gscd_open
(paren
r_struct
id|inode
op_star
id|ip
comma
r_struct
id|file
op_star
id|fp
)paren
(brace
r_int
id|st
suffix:semicolon
macro_line|#ifdef GSCD_DEBUG
id|printk
(paren
l_string|&quot;GSCD: open&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|gscdPresent
op_eq
l_int|0
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* no hardware */
id|MOD_INC_USE_COUNT
suffix:semicolon
id|get_status
(paren
)paren
suffix:semicolon
id|st
op_assign
id|disk_state
op_amp
(paren
id|ST_NO_DISK
op_or
id|ST_DOOR_OPEN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st
)paren
(brace
id|printk
(paren
l_string|&quot;GSCD: no disk or door open&bslash;n&quot;
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
multiline_comment|/*&t;if (updateToc() &lt; 0)&n;&t;&t;return -EIO;&n;*/
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * On close, we flush all gscd blocks from the buffer cache.&n; */
DECL|function|gscd_release
r_static
r_int
id|gscd_release
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
macro_line|#ifdef GSCD_DEBUG
id|printk
(paren
l_string|&quot;GSCD: release&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|gscd_bn
op_assign
op_minus
l_int|1
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|get_status
r_int
id|get_status
(paren
r_void
)paren
(brace
r_int
id|status
suffix:semicolon
id|cmd_status
(paren
)paren
suffix:semicolon
id|status
op_assign
id|disk_state
op_amp
(paren
id|ST_x08
op_or
id|ST_x04
op_or
id|ST_INVALID
op_or
id|ST_x01
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
(paren
id|ST_x08
op_or
id|ST_x04
op_or
id|ST_INVALID
op_or
id|ST_x01
)paren
)paren
(brace
id|cc_invalidate
(paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_return
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|cc_invalidate
r_void
id|cc_invalidate
(paren
r_void
)paren
(brace
id|drv_num_read
op_assign
l_int|0xFF
suffix:semicolon
id|f_dsk_valid
op_assign
l_int|0xFF
suffix:semicolon
id|current_drive
op_assign
l_int|0xFF
suffix:semicolon
id|f_drv_ok
op_assign
l_int|0xFF
suffix:semicolon
id|clear_Audio
(paren
)paren
suffix:semicolon
)brace
DECL|function|clear_Audio
r_void
id|clear_Audio
(paren
r_void
)paren
(brace
id|f_AudioPlay
op_assign
l_int|0
suffix:semicolon
id|f_AudioPause
op_assign
l_int|0
suffix:semicolon
id|AudioStart_m
op_assign
l_int|0
suffix:semicolon
id|AudioStart_f
op_assign
l_int|0
suffix:semicolon
id|AudioEnd_m
op_assign
l_int|0
suffix:semicolon
id|AudioEnd_f
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *   waiting ?  &n; */
DECL|function|wait_drv_ready
r_int
id|wait_drv_ready
(paren
r_void
)paren
(brace
r_int
id|found
comma
id|read
suffix:semicolon
r_do
(brace
id|found
op_assign
id|inb
(paren
id|GSCDPORT
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
id|found
op_and_assign
l_int|0x0f
suffix:semicolon
id|read
op_assign
id|inb
(paren
id|GSCDPORT
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
id|read
op_and_assign
l_int|0x0f
suffix:semicolon
)brace
r_while
c_loop
(paren
id|read
op_ne
id|found
)paren
suffix:semicolon
macro_line|#ifdef GSCD_DEBUG
id|printk
(paren
l_string|&quot;Wait for: %d&bslash;n&quot;
comma
id|read
)paren
suffix:semicolon
macro_line|#endif   
r_return
id|read
suffix:semicolon
)brace
DECL|function|cc_Ident
r_void
id|cc_Ident
(paren
r_char
op_star
id|respons
)paren
(brace
r_char
id|to_do
(braket
)braket
op_assign
(brace
id|CMD_IDENT
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|cmd_out
(paren
id|TYPE_INFO
comma
(paren
r_char
op_star
)paren
op_amp
id|to_do
comma
(paren
r_char
op_star
)paren
id|respons
comma
(paren
r_int
)paren
l_int|0x1E
)paren
suffix:semicolon
)brace
DECL|function|cc_SetSpeed
r_void
id|cc_SetSpeed
(paren
r_void
)paren
(brace
r_char
id|to_do
(braket
)braket
op_assign
(brace
id|CMD_SETSPEED
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
r_char
id|dummy
suffix:semicolon
r_if
c_cond
(paren
id|speed
OG
l_int|0
)paren
(brace
id|to_do
(braket
l_int|1
)braket
op_assign
id|speed
op_amp
l_int|0x0F
suffix:semicolon
id|cmd_out
(paren
id|TYPE_INFO
comma
(paren
r_char
op_star
)paren
op_amp
id|to_do
comma
(paren
r_char
op_star
)paren
op_amp
id|dummy
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
DECL|function|cc_Reset
r_void
id|cc_Reset
(paren
r_void
)paren
(brace
r_char
id|to_do
(braket
)braket
op_assign
(brace
id|CMD_RESET
comma
l_int|0
)brace
suffix:semicolon
r_char
id|dummy
suffix:semicolon
id|cmd_out
(paren
id|TYPE_INFO
comma
(paren
r_char
op_star
)paren
op_amp
id|to_do
comma
(paren
r_char
op_star
)paren
op_amp
id|dummy
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|cmd_status
r_void
id|cmd_status
(paren
r_void
)paren
(brace
r_char
id|to_do
(braket
)braket
op_assign
(brace
id|CMD_STATUS
comma
l_int|0
)brace
suffix:semicolon
r_char
id|dummy
suffix:semicolon
id|cmd_out
(paren
id|TYPE_INFO
comma
(paren
r_char
op_star
)paren
op_amp
id|to_do
comma
(paren
r_char
op_star
)paren
op_amp
id|dummy
comma
l_int|0
)paren
suffix:semicolon
macro_line|#ifdef GSCD_DEBUG
id|printk
(paren
l_string|&quot;GSCD: Status: %d&bslash;n&quot;
comma
id|disk_state
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|cmd_out
r_void
id|cmd_out
(paren
r_int
id|cmd_type
comma
r_char
op_star
id|cmd
comma
r_char
op_star
id|respo_buf
comma
r_int
id|respo_count
)paren
(brace
r_int
id|result
suffix:semicolon
id|result
op_assign
id|wait_drv_ready
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
id|drv_mode
)paren
(brace
r_int
r_int
id|test_loops
op_assign
l_int|0xFFFF
suffix:semicolon
r_int
id|i
comma
id|dummy
suffix:semicolon
id|outb
(paren
id|curr_drv_state
comma
id|GSCDPORT
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
multiline_comment|/* LOCLOOP_170 */
r_do
(brace
id|result
op_assign
id|wait_drv_ready
(paren
)paren
suffix:semicolon
id|test_loops
op_decrement
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|result
op_ne
id|drv_mode
)paren
op_logical_and
(paren
id|test_loops
OG
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
id|drv_mode
)paren
(brace
id|disk_state
op_assign
id|ST_x08
op_or
id|ST_x04
op_or
id|ST_INVALID
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* ...and waiting */
r_for
c_loop
(paren
id|i
op_assign
l_int|1
comma
id|dummy
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|0xFFFF
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dummy
op_mul_assign
id|i
suffix:semicolon
)brace
)brace
multiline_comment|/* LOC_172 */
multiline_comment|/* check the unit */
multiline_comment|/* and wake it up */
r_if
c_cond
(paren
id|cmd_unit_alive
(paren
)paren
op_ne
l_int|0x08
)paren
(brace
multiline_comment|/* LOC_174 */
multiline_comment|/* game over for this unit */
id|disk_state
op_assign
id|ST_x08
op_or
id|ST_x04
op_or
id|ST_INVALID
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* LOC_176 */
macro_line|#ifdef GSCD_DEBUG
id|printk
(paren
l_string|&quot;LOC_176 &quot;
)paren
suffix:semicolon
macro_line|#endif       
r_if
c_cond
(paren
id|drv_mode
op_eq
l_int|0x09
)paren
(brace
multiline_comment|/* magic... */
id|printk
(paren
l_string|&quot;GSCD: magic ...&bslash;n&quot;
)paren
suffix:semicolon
id|outb
(paren
id|result
comma
id|GSCDPORT
c_func
(paren
l_int|2
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* write the command to the drive */
id|cmd_write_cmd
(paren
id|cmd
)paren
suffix:semicolon
multiline_comment|/* LOC_178 */
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|result
op_assign
id|wait_drv_ready
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
id|drv_mode
)paren
(brace
multiline_comment|/* LOC_179 */
r_if
c_cond
(paren
id|result
op_eq
l_int|0x04
)paren
multiline_comment|/* Mode 4 */
(brace
multiline_comment|/* LOC_205 */
macro_line|#ifdef GSCD_DEBUG
id|printk
(paren
l_string|&quot;LOC_205 &quot;
)paren
suffix:semicolon
macro_line|#endif
id|disk_state
op_assign
id|inb
(paren
id|GSCDPORT
(paren
l_int|2
)paren
)paren
suffix:semicolon
r_do
(brace
id|result
op_assign
id|wait_drv_ready
(paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|result
op_ne
id|drv_mode
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|result
op_eq
l_int|0x06
)paren
multiline_comment|/* Mode 6 */
(brace
multiline_comment|/* LOC_181 */
macro_line|#ifdef GSCD_DEBUG
id|printk
(paren
l_string|&quot;LOC_181 &quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|cmd_type
op_eq
id|TYPE_DATA
)paren
(brace
multiline_comment|/* read data */
multiline_comment|/* LOC_184 */
r_if
c_cond
(paren
id|drv_mode
op_eq
l_int|9
)paren
(brace
multiline_comment|/* read the data to the buffer (word) */
multiline_comment|/* (*(cmd+1))?(CD_FRAMESIZE/2):(CD_FRAMESIZE_RAW/2) */
id|cmd_read_w
(paren
id|respo_buf
comma
id|respo_count
comma
id|CD_FRAMESIZE
op_div
l_int|2
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* read the data to the buffer (byte) */
multiline_comment|/* (*(cmd+1))?(CD_FRAMESIZE):(CD_FRAMESIZE_RAW)    */
id|cmd_read_b
(paren
id|respo_buf
comma
id|respo_count
comma
id|CD_FRAMESIZE
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* read the info to the buffer */
id|cmd_info_in
(paren
id|respo_buf
comma
id|respo_count
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|disk_state
op_assign
id|ST_x08
op_or
id|ST_x04
op_or
id|ST_INVALID
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* for (;;) */
macro_line|#ifdef GSCD_DEBUG
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif    
)brace
DECL|function|cmd_write_cmd
r_static
r_void
id|cmd_write_cmd
(paren
r_char
op_star
id|pstr
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
multiline_comment|/* LOC_177 */
macro_line|#ifdef GSCD_DEBUG
id|printk
(paren
l_string|&quot;LOC_177 &quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* calculate the number of parameter */
id|j
op_assign
op_star
id|pstr
op_amp
l_int|0x0F
suffix:semicolon
multiline_comment|/* shift it out */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|j
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outb
(paren
op_star
id|pstr
comma
id|GSCDPORT
c_func
(paren
l_int|2
)paren
)paren
suffix:semicolon
id|pstr
op_increment
suffix:semicolon
)brace
)brace
DECL|function|cmd_unit_alive
r_static
r_int
id|cmd_unit_alive
(paren
r_void
)paren
(brace
r_int
id|result
suffix:semicolon
r_int
r_int
id|max_test_loops
suffix:semicolon
multiline_comment|/* LOC_172 */
macro_line|#ifdef GSCD_DEBUG
id|printk
(paren
l_string|&quot;LOC_172 &quot;
)paren
suffix:semicolon
macro_line|#endif
id|outb
(paren
id|curr_drv_state
comma
id|GSCDPORT
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
id|max_test_loops
op_assign
l_int|0xFFFF
suffix:semicolon
r_do
(brace
id|result
op_assign
id|wait_drv_ready
(paren
)paren
suffix:semicolon
id|max_test_loops
op_decrement
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|result
op_ne
l_int|0x08
)paren
op_logical_and
(paren
id|max_test_loops
OG
l_int|0
)paren
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|cmd_info_in
r_static
r_void
id|cmd_info_in
(paren
r_char
op_star
id|pb
comma
r_int
id|count
)paren
(brace
r_int
id|result
suffix:semicolon
r_char
id|read
suffix:semicolon
multiline_comment|/* read info */
multiline_comment|/* LOC_182 */
macro_line|#ifdef GSCD_DEBUG
id|printk
(paren
l_string|&quot;LOC_182 &quot;
)paren
suffix:semicolon
macro_line|#endif
r_do
(brace
id|read
op_assign
id|inb
(paren
id|GSCDPORT
c_func
(paren
l_int|2
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
l_int|0
)paren
(brace
op_star
id|pb
op_assign
id|read
suffix:semicolon
id|pb
op_increment
suffix:semicolon
id|count
op_decrement
suffix:semicolon
)brace
multiline_comment|/* LOC_183 */
r_do
(brace
id|result
op_assign
id|wait_drv_ready
(paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|result
op_eq
l_int|0x0E
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|result
op_eq
l_int|6
)paren
suffix:semicolon
id|cmd_end
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|cmd_read_b
r_static
r_void
id|cmd_read_b
(paren
r_char
op_star
id|pb
comma
r_int
id|count
comma
r_int
id|size
)paren
(brace
r_int
id|result
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* LOC_188 */
multiline_comment|/* LOC_189 */
macro_line|#ifdef GSCD_DEBUG
id|printk
(paren
l_string|&quot;LOC_189 &quot;
)paren
suffix:semicolon
macro_line|#endif
r_do
(brace
r_do
(brace
id|result
op_assign
id|wait_drv_ready
(paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|result
op_ne
l_int|6
op_logical_or
id|result
op_eq
l_int|0x0E
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
l_int|6
)paren
(brace
id|cmd_end
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#ifdef GSCD_DEBUG
id|printk
(paren
l_string|&quot;LOC_191 &quot;
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|size
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|pb
op_assign
id|inb
(paren
id|GSCDPORT
c_func
(paren
l_int|2
)paren
)paren
suffix:semicolon
id|pb
op_increment
suffix:semicolon
)brace
id|count
op_decrement
suffix:semicolon
)brace
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
suffix:semicolon
id|cmd_end
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|cmd_end
r_static
r_void
id|cmd_end
(paren
r_void
)paren
(brace
r_int
id|result
suffix:semicolon
multiline_comment|/* LOC_204 */
macro_line|#ifdef GSCD_DEBUG
id|printk
(paren
l_string|&quot;LOC_204 &quot;
)paren
suffix:semicolon
macro_line|#endif
r_do
(brace
id|result
op_assign
id|wait_drv_ready
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
id|drv_mode
)paren
(brace
r_return
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|result
op_ne
l_int|4
)paren
suffix:semicolon
multiline_comment|/* LOC_205 */
macro_line|#ifdef GSCD_DEBUG
id|printk
(paren
l_string|&quot;LOC_205 &quot;
)paren
suffix:semicolon
macro_line|#endif
id|disk_state
op_assign
id|inb
(paren
id|GSCDPORT
(paren
l_int|2
)paren
)paren
suffix:semicolon
r_do
(brace
id|result
op_assign
id|wait_drv_ready
(paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|result
op_ne
id|drv_mode
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|cmd_read_w
r_static
r_void
id|cmd_read_w
(paren
r_char
op_star
id|pb
comma
r_int
id|count
comma
r_int
id|size
)paren
(brace
r_int
id|result
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#ifdef GSCD_DEBUG
id|printk
(paren
l_string|&quot;LOC_185 &quot;
)paren
suffix:semicolon
macro_line|#endif
r_do
(brace
multiline_comment|/* LOC_185 */
r_do
(brace
id|result
op_assign
id|wait_drv_ready
(paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|result
op_ne
l_int|6
op_logical_or
id|result
op_eq
l_int|0x0E
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
l_int|6
)paren
(brace
id|cmd_end
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|size
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* na, hier muss ich noch mal drueber nachdenken */
op_star
id|pb
op_assign
id|inw
c_func
(paren
id|GSCDPORT
c_func
(paren
l_int|2
)paren
)paren
suffix:semicolon
id|pb
op_increment
suffix:semicolon
)brace
id|count
op_decrement
suffix:semicolon
)brace
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
suffix:semicolon
id|cmd_end
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|find_drives
r_int
id|__init
id|find_drives
(paren
r_void
)paren
(brace
r_int
op_star
id|pdrv
suffix:semicolon
r_int
id|drvnum
suffix:semicolon
r_int
id|subdrv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|speed
op_assign
l_int|0
suffix:semicolon
id|pdrv
op_assign
(paren
r_int
op_star
)paren
op_amp
id|drv_states
suffix:semicolon
id|curr_drv_state
op_assign
l_int|0xFE
suffix:semicolon
id|subdrv
op_assign
l_int|0
suffix:semicolon
id|drvnum
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|subdrv
op_increment
suffix:semicolon
id|cmd_status
(paren
)paren
suffix:semicolon
id|disk_state
op_and_assign
id|ST_x08
op_or
id|ST_x04
op_or
id|ST_INVALID
op_or
id|ST_x01
suffix:semicolon
r_if
c_cond
(paren
id|disk_state
op_ne
(paren
id|ST_x08
op_or
id|ST_x04
op_or
id|ST_INVALID
)paren
)paren
(brace
multiline_comment|/* LOC_240 */
op_star
id|pdrv
op_assign
id|curr_drv_state
suffix:semicolon
id|init_cd_drive
(paren
id|drvnum
)paren
suffix:semicolon
id|pdrv
op_increment
suffix:semicolon
id|drvnum
op_increment
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|subdrv
OL
l_int|2
)paren
(brace
r_continue
suffix:semicolon
)brace
r_else
(brace
id|subdrv
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/*       curr_drv_state&lt;&lt;1;         &lt;-- das geht irgendwie nicht */
multiline_comment|/* muss heissen:    curr_drv_state &lt;&lt;= 1; (ist ja Wert-Zuweisung) */
id|curr_drv_state
op_mul_assign
l_int|2
suffix:semicolon
id|curr_drv_state
op_or_assign
l_int|1
suffix:semicolon
macro_line|#ifdef GSCD_DEBUG
id|printk
(paren
l_string|&quot;DriveState: %d&bslash;n&quot;
comma
id|curr_drv_state
)paren
suffix:semicolon
macro_line|#endif
)brace
id|ndrives
op_assign
id|drvnum
suffix:semicolon
r_return
id|drvnum
suffix:semicolon
)brace
DECL|function|init_cd_drive
r_void
id|__init
id|init_cd_drive
(paren
r_int
id|num
)paren
(brace
r_char
id|resp
(braket
l_int|50
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
id|printk
(paren
l_string|&quot;GSCD: init unit %d&bslash;n&quot;
comma
id|num
)paren
suffix:semicolon
id|cc_Ident
(paren
(paren
r_char
op_star
)paren
op_amp
id|resp
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;GSCD: identification: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x1E
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
(paren
l_string|&quot;%c&quot;
comma
id|resp
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|cc_SetSpeed
(paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef FUTURE_WORK
multiline_comment|/* return_done */
DECL|function|update_state
r_static
r_void
id|update_state
(paren
r_void
)paren
(brace
r_int
r_int
id|AX
suffix:semicolon
r_if
c_cond
(paren
(paren
id|disk_state
op_amp
(paren
id|ST_x08
op_or
id|ST_x04
op_or
id|ST_INVALID
op_or
id|ST_x01
)paren
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|disk_state
op_eq
(paren
id|ST_x08
op_or
id|ST_x04
op_or
id|ST_INVALID
)paren
)paren
(brace
id|AX
op_assign
id|ST_INVALID
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|disk_state
op_amp
(paren
id|ST_x08
op_or
id|ST_x04
op_or
id|ST_INVALID
op_or
id|ST_x01
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|invalidate
(paren
)paren
suffix:semicolon
id|f_drv_ok
op_assign
l_int|0
suffix:semicolon
)brace
id|AX
op_or_assign
l_int|0x8000
suffix:semicolon
)brace
r_if
c_cond
(paren
id|disk_state
op_amp
id|ST_PLAYING
)paren
(brace
id|AX
op_or_assign
l_int|0x200
suffix:semicolon
)brace
id|AX
op_or_assign
l_int|0x100
suffix:semicolon
multiline_comment|/* pkt_esbx = AX; */
id|disk_state
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Init for the Module-Version */
DECL|function|init_gscd
r_int
id|init_gscd
c_func
(paren
r_void
)paren
(brace
r_int
id|err
suffix:semicolon
multiline_comment|/* call the GoldStar-init */
id|err
op_assign
id|my_gscd_init
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
r_else
(brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;Happy GoldStar !&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|exit_gscd
r_void
id|__exit
id|exit_gscd
c_func
(paren
r_void
)paren
(brace
id|CLEAR_TIMER
suffix:semicolon
id|devfs_unregister
c_func
(paren
id|devfs_find_handle
c_func
(paren
l_int|NULL
comma
l_string|&quot;gscd&quot;
comma
l_int|0
comma
l_int|0
comma
id|DEVFS_SPECIAL_BLK
comma
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|devfs_unregister_blkdev
c_func
(paren
id|MAJOR_NR
comma
l_string|&quot;gscd&quot;
)paren
op_eq
op_minus
id|EINVAL
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;What&squot;s that: can&squot;t unregister GoldStar-module&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|blk_cleanup_queue
c_func
(paren
id|BLK_DEFAULT_QUEUE
c_func
(paren
id|MAJOR_NR
)paren
)paren
suffix:semicolon
id|release_region
(paren
id|gscd_port
comma
l_int|4
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;GoldStar-module released.&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|variable|init_gscd
id|module_init
c_func
(paren
id|init_gscd
)paren
suffix:semicolon
macro_line|#endif 
DECL|variable|exit_gscd
id|module_exit
c_func
(paren
id|exit_gscd
)paren
suffix:semicolon
multiline_comment|/* Test for presence of drive and initialize it.  Called only at boot time. */
DECL|function|gscd_init
r_int
id|__init
id|gscd_init
(paren
r_void
)paren
(brace
r_return
id|my_gscd_init
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* This is the common initialisation for the GoldStar drive. */
multiline_comment|/* It is called at boot time AND for module init.           */
DECL|function|my_gscd_init
r_int
id|__init
id|my_gscd_init
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|result
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;GSCD: version %s&bslash;n&quot;
comma
id|GSCD_VERSION
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;GSCD: Trying to detect a Goldstar R420 CD-ROM drive at 0x%X.&bslash;n&quot;
comma
id|gscd_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|gscd_port
comma
l_int|4
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;GSCD: Init failed, I/O port (%X) already in use.&bslash;n&quot;
comma
id|gscd_port
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* check for card */
id|result
op_assign
id|wait_drv_ready
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
l_int|0x09
)paren
(brace
id|printk
(paren
l_string|&quot;GSCD: DMA kann ich noch nicht!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|result
op_eq
l_int|0x0b
)paren
(brace
id|drv_mode
op_assign
id|result
suffix:semicolon
id|i
op_assign
id|find_drives
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
(brace
id|printk
(paren
l_string|&quot;GSCD: GoldStar CD-ROM Drive is not found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|result
op_ne
l_int|0x0b
)paren
op_logical_and
(paren
id|result
op_ne
l_int|0x09
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;GSCD: GoldStar Interface Adapter does not exist or H/W error&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* reset all drives */
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|drv_states
(braket
id|i
)braket
op_ne
l_int|0
)paren
(brace
id|curr_drv_state
op_assign
id|drv_states
(braket
id|i
)braket
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;GSCD: Reset unit %d ... &quot;
comma
id|i
)paren
suffix:semicolon
id|cc_Reset
(paren
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;done&bslash;n&quot;
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devfs_register_blkdev
c_func
(paren
id|MAJOR_NR
comma
l_string|&quot;gscd&quot;
comma
op_amp
id|gscd_fops
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;GSCD: Unable to get major %d for GoldStar CD-ROM&bslash;n&quot;
comma
id|MAJOR_NR
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|devfs_register
(paren
l_int|NULL
comma
l_string|&quot;gscd&quot;
comma
id|DEVFS_FL_DEFAULT
comma
id|MAJOR_NR
comma
l_int|0
comma
id|S_IFBLK
op_or
id|S_IRUGO
op_or
id|S_IWUGO
comma
op_amp
id|gscd_fops
comma
l_int|NULL
)paren
suffix:semicolon
id|blk_init_queue
c_func
(paren
id|BLK_DEFAULT_QUEUE
c_func
(paren
id|MAJOR_NR
)paren
comma
id|DEVICE_REQUEST
)paren
suffix:semicolon
id|blksize_size
(braket
id|MAJOR_NR
)braket
op_assign
id|gscd_blocksizes
suffix:semicolon
id|read_ahead
(braket
id|MAJOR_NR
)braket
op_assign
l_int|4
suffix:semicolon
id|disk_state
op_assign
l_int|0
suffix:semicolon
id|gscdPresent
op_assign
l_int|1
suffix:semicolon
id|request_region
c_func
(paren
id|gscd_port
comma
l_int|4
comma
l_string|&quot;gscd&quot;
)paren
suffix:semicolon
id|register_disk
c_func
(paren
l_int|NULL
comma
id|MKDEV
c_func
(paren
id|MAJOR_NR
comma
l_int|0
)paren
comma
l_int|1
comma
op_amp
id|gscd_fops
comma
l_int|0
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;GSCD: GoldStar CD-ROM Drive found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|gscd_hsg2msf
r_static
r_void
id|gscd_hsg2msf
(paren
r_int
id|hsg
comma
r_struct
id|msf
op_star
id|msf
)paren
(brace
id|hsg
op_add_assign
id|CD_MSF_OFFSET
suffix:semicolon
id|msf
op_member_access_from_pointer
id|min
op_assign
id|hsg
op_div
(paren
id|CD_FRAMES
op_star
id|CD_SECS
)paren
suffix:semicolon
id|hsg
op_mod_assign
id|CD_FRAMES
op_star
id|CD_SECS
suffix:semicolon
id|msf
op_member_access_from_pointer
id|sec
op_assign
id|hsg
op_div
id|CD_FRAMES
suffix:semicolon
id|msf
op_member_access_from_pointer
id|frame
op_assign
id|hsg
op_mod
id|CD_FRAMES
suffix:semicolon
id|gscd_bin2bcd
c_func
(paren
op_amp
id|msf
op_member_access_from_pointer
id|min
)paren
suffix:semicolon
multiline_comment|/* convert to BCD */
id|gscd_bin2bcd
c_func
(paren
op_amp
id|msf
op_member_access_from_pointer
id|sec
)paren
suffix:semicolon
id|gscd_bin2bcd
c_func
(paren
op_amp
id|msf
op_member_access_from_pointer
id|frame
)paren
suffix:semicolon
)brace
DECL|function|gscd_bin2bcd
r_static
r_void
id|gscd_bin2bcd
(paren
r_int
r_char
op_star
id|p
)paren
(brace
r_int
id|u
comma
id|t
suffix:semicolon
id|u
op_assign
op_star
id|p
op_mod
l_int|10
suffix:semicolon
id|t
op_assign
op_star
id|p
op_div
l_int|10
suffix:semicolon
op_star
id|p
op_assign
id|u
op_or
(paren
id|t
op_lshift
l_int|4
)paren
suffix:semicolon
)brace
macro_line|#ifdef FUTURE_WORK
DECL|function|gscd_msf2hsg
r_static
r_int
id|gscd_msf2hsg
(paren
r_struct
id|msf
op_star
id|mp
)paren
(brace
r_return
id|gscd_bcd2bin
c_func
(paren
id|mp
op_member_access_from_pointer
id|frame
)paren
op_plus
id|gscd_bcd2bin
c_func
(paren
id|mp
op_member_access_from_pointer
id|sec
)paren
op_star
id|CD_FRAMES
op_plus
id|gscd_bcd2bin
c_func
(paren
id|mp
op_member_access_from_pointer
id|min
)paren
op_star
id|CD_FRAMES
op_star
id|CD_SECS
op_minus
id|CD_MSF_OFFSET
suffix:semicolon
)brace
DECL|function|gscd_bcd2bin
r_static
r_int
id|gscd_bcd2bin
(paren
r_int
r_char
id|bcd
)paren
(brace
r_return
(paren
id|bcd
op_rshift
l_int|4
)paren
op_star
l_int|10
op_plus
(paren
id|bcd
op_amp
l_int|0xF
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
