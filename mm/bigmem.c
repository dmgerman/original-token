multiline_comment|/*&n; * BIGMEM common code and variables.&n; *&n; * (C) 1999 Andrea Arcangeli, SuSE GmbH, andrea@suse.de&n; *          Gerhard Wichert, Siemens AG, Gerhard.Wichert@pdb.siemens.de&n; */
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/pagemap.h&gt;
macro_line|#include &lt;linux/bigmem.h&gt;
DECL|variable|bigmem_mapnr
r_int
r_int
id|bigmem_mapnr
suffix:semicolon
DECL|variable|nr_free_bigpages
r_int
id|nr_free_bigpages
op_assign
l_int|0
suffix:semicolon
DECL|function|prepare_bigmem_swapout
r_struct
id|page
op_star
id|prepare_bigmem_swapout
c_func
(paren
r_struct
id|page
op_star
id|page
)paren
(brace
multiline_comment|/* if this is a bigmem page so it can&squot;t be swapped out directly&n;&t;   otherwise the b_data buffer addresses will break&n;&t;   the lowlevel device drivers. */
r_if
c_cond
(paren
id|PageBIGMEM
c_func
(paren
id|page
)paren
)paren
(brace
r_int
r_int
id|regular_page
suffix:semicolon
r_int
r_int
id|vaddr
suffix:semicolon
id|regular_page
op_assign
id|__get_free_page
c_func
(paren
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|regular_page
)paren
r_return
l_int|NULL
suffix:semicolon
id|vaddr
op_assign
id|kmap
c_func
(paren
id|page_address
c_func
(paren
id|page
)paren
comma
id|KM_READ
)paren
suffix:semicolon
id|copy_page
c_func
(paren
id|regular_page
comma
id|vaddr
)paren
suffix:semicolon
id|kunmap
c_func
(paren
id|vaddr
comma
id|KM_READ
)paren
suffix:semicolon
multiline_comment|/* ok, we can just forget about our bigmem page since &n;&t;&t;   we stored its data into the new regular_page. */
id|__free_page
c_func
(paren
id|page
)paren
suffix:semicolon
id|page
op_assign
id|MAP_NR
c_func
(paren
id|regular_page
)paren
op_plus
id|mem_map
suffix:semicolon
)brace
r_return
id|page
suffix:semicolon
)brace
DECL|function|replace_with_bigmem
r_struct
id|page
op_star
id|replace_with_bigmem
c_func
(paren
r_struct
id|page
op_star
id|page
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|PageBIGMEM
c_func
(paren
id|page
)paren
op_logical_and
id|nr_free_bigpages
)paren
(brace
r_int
r_int
id|kaddr
suffix:semicolon
id|kaddr
op_assign
id|__get_free_page
c_func
(paren
id|GFP_ATOMIC
op_or
id|GFP_BIGMEM
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kaddr
)paren
(brace
r_struct
id|page
op_star
id|bigmem_page
suffix:semicolon
id|bigmem_page
op_assign
id|MAP_NR
c_func
(paren
id|kaddr
)paren
op_plus
id|mem_map
suffix:semicolon
r_if
c_cond
(paren
id|PageBIGMEM
c_func
(paren
id|bigmem_page
)paren
)paren
(brace
r_int
r_int
id|vaddr
suffix:semicolon
id|vaddr
op_assign
id|kmap
c_func
(paren
id|kaddr
comma
id|KM_WRITE
)paren
suffix:semicolon
id|copy_page
c_func
(paren
id|vaddr
comma
id|page_address
c_func
(paren
id|page
)paren
)paren
suffix:semicolon
id|kunmap
c_func
(paren
id|vaddr
comma
id|KM_WRITE
)paren
suffix:semicolon
multiline_comment|/* Preserve the caching of the swap_entry. */
id|bigmem_page-&gt;offset
op_assign
id|page-&gt;offset
suffix:semicolon
multiline_comment|/* We can just forget the old page since &n;&t;&t;&t;&t;   we stored its data into the new&n;&t;&t;&t;&t;   bigmem_page. */
id|__free_page
c_func
(paren
id|page
)paren
suffix:semicolon
id|page
op_assign
id|bigmem_page
suffix:semicolon
)brace
)brace
)brace
r_return
id|page
suffix:semicolon
)brace
eof
