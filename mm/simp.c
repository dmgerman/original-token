DECL|macro|NULL
mdefine_line|#define NULL 0
multiline_comment|/*&n; * mm/simp.c  -- simple allocator for cached objects&n; *&n; * (C) 1997 Thomas Schoebel-Theuer&n; */
macro_line|#include &lt;linux/simp.h&gt;
macro_line|#include &lt;linux/tasks.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/spinlock.h&gt;
multiline_comment|/* The next two defines can be independently enabled for debugging */
multiline_comment|/*#define DEBUG*/
multiline_comment|/*#define DEAD_BEEF*/
macro_line|#ifdef DEAD_BEEF
DECL|macro|DEBUG_BEEF
mdefine_line|#define DEBUG_BEEF 1
macro_line|#else
DECL|macro|DEBUG_BEEF
mdefine_line|#define DEBUG_BEEF 0
macro_line|#endif
macro_line|#ifdef __SMP__
DECL|macro|NR_PROCESSORS
mdefine_line|#define NR_PROCESSORS  NR_CPUS
DECL|macro|GLOBAL_SIZE
mdefine_line|#define GLOBAL_SIZE CHUNK_SIZE
macro_line|#else
DECL|macro|NR_PROCESSORS
mdefine_line|#define NR_PROCESSORS  1
DECL|macro|GLOBAL_SIZE
mdefine_line|#define GLOBAL_SIZE PAGE_SIZE
macro_line|#endif
DECL|macro|POSTBUFFER_SIZE
mdefine_line|#define POSTBUFFER_SIZE 63
DECL|macro|ORDER
mdefine_line|#define ORDER 2
DECL|macro|CHUNK_SIZE
mdefine_line|#define CHUNK_SIZE (PAGE_SIZE*(1&lt;&lt;ORDER))
DECL|macro|CHUNK_BASE
mdefine_line|#define CHUNK_BASE(ptr) (struct header*)(((unsigned long)(ptr)) &amp; ~(CHUNK_SIZE-1))
DECL|macro|CHUNK_END
mdefine_line|#define CHUNK_END(hdr) (void**)((char*)(hdr) + CHUNK_SIZE)
DECL|macro|COLOR_INCREMENT
mdefine_line|#define COLOR_INCREMENT (8*sizeof(void*)) /* should be 1 cache line */
DECL|macro|ALIGN_CACHE
mdefine_line|#define ALIGN_CACHE(adr) ((((((unsigned long)adr) - 1) / COLOR_INCREMENT) + 1) * COLOR_INCREMENT)
DECL|macro|HEADER_SIZE
mdefine_line|#define HEADER_SIZE ALIGN_CACHE(sizeof(struct header))
DECL|macro|ELEM_SIZE
mdefine_line|#define ELEM_SIZE ALIGN_CACHE(sizeof(struct elem))
DECL|macro|FILL_TYPE
mdefine_line|#define FILL_TYPE(name,wrongsize) char name[ALIGN_CACHE(wrongsize)-(wrongsize)]
DECL|macro|MAX_SIMPS
mdefine_line|#define MAX_SIMPS ((GLOBAL_SIZE / sizeof(struct simp)) - 1)
DECL|struct|header
r_struct
id|header
(brace
multiline_comment|/* this is at the beginning of each memory region */
multiline_comment|/* 1st cache line */
DECL|member|index
r_void
op_star
op_star
id|index
suffix:semicolon
DECL|member|fresh
r_void
op_star
op_star
id|fresh
suffix:semicolon
DECL|member|father
r_struct
id|simp
op_star
id|father
suffix:semicolon
DECL|member|emptypos
r_void
op_star
op_star
id|emptypos
suffix:semicolon
DECL|member|next
r_struct
id|header
op_star
id|next
suffix:semicolon
DECL|member|again_ctor
id|structor
id|again_ctor
suffix:semicolon
DECL|member|first_ctor
id|structor
id|first_ctor
suffix:semicolon
DECL|member|fill
r_void
op_star
id|fill
(braket
l_int|1
)braket
suffix:semicolon
macro_line|#ifdef DEBUG
multiline_comment|/* 2nd cache line */
DECL|member|magic
r_char
id|magic
(braket
l_int|32
)braket
suffix:semicolon
macro_line|#endif
)brace
suffix:semicolon
DECL|struct|per_processor
r_struct
id|per_processor
(brace
DECL|member|buffer_pos
r_void
op_star
op_star
id|buffer_pos
suffix:semicolon
DECL|member|postbuffer
r_void
op_star
id|postbuffer
(braket
id|POSTBUFFER_SIZE
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|simp
r_struct
id|simp
(brace
multiline_comment|/* 1st cache lines */
DECL|member|private
r_struct
id|per_processor
r_private
(braket
id|NR_PROCESSORS
)braket
suffix:semicolon
multiline_comment|/* next cache line */
DECL|member|usable_list
r_struct
id|header
op_star
id|usable_list
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|fill
r_char
id|fill
(braket
r_sizeof
(paren
r_void
op_star
)paren
op_minus
r_sizeof
(paren
id|spinlock_t
)paren
)braket
suffix:semicolon
DECL|member|real_size
r_int
id|real_size
suffix:semicolon
DECL|member|max_elems
r_int
id|max_elems
suffix:semicolon
DECL|member|again_ctor
id|structor
id|again_ctor
suffix:semicolon
DECL|member|first_ctor
id|structor
id|first_ctor
suffix:semicolon
DECL|member|dtor
id|structor
id|dtor
suffix:semicolon
DECL|member|fill2
r_int
id|fill2
suffix:semicolon
multiline_comment|/* next cache line */
DECL|member|create_offset
r_int
id|create_offset
suffix:semicolon
DECL|member|color
r_int
id|color
suffix:semicolon
DECL|member|max_color
r_int
id|max_color
suffix:semicolon
DECL|member|size
r_int
id|size
suffix:semicolon
DECL|member|fill3
r_int
id|fill3
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* next cache line */
DECL|member|name
r_char
id|name
(braket
l_int|32
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|global_data
r_struct
id|global_data
(brace
multiline_comment|/* 1st cache line */
DECL|member|changed_flag
r_int
id|changed_flag
suffix:semicolon
DECL|member|nr_simps
r_int
id|nr_simps
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|fill
r_char
id|fill
(braket
(paren
l_int|6
op_plus
l_int|8
)paren
op_star
r_sizeof
(paren
r_void
op_star
)paren
op_plus
r_sizeof
(paren
r_void
op_star
)paren
op_minus
r_sizeof
(paren
id|spinlock_t
)paren
)braket
suffix:semicolon
multiline_comment|/* rest */
DECL|member|simps
r_struct
id|simp
id|simps
(braket
id|MAX_SIMPS
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|global
r_static
r_struct
id|global_data
op_star
id|global
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef DEBUG
DECL|variable|global_magic
r_static
r_char
id|global_magic
(braket
l_int|32
)braket
op_assign
l_string|&quot;SIMP header SdC581oi9rY20051962&bslash;n&quot;
suffix:semicolon
macro_line|#endif
DECL|function|simp_create
r_struct
id|simp
op_star
id|simp_create
c_func
(paren
r_char
op_star
id|name
comma
r_int
id|size
comma
id|structor
id|first_ctor
comma
id|structor
id|again_ctor
comma
id|structor
id|dtor
)paren
(brace
r_struct
id|simp
op_star
id|simp
suffix:semicolon
r_int
id|fraction
suffix:semicolon
r_int
id|real_size
suffix:semicolon
r_int
id|cpu
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|global
)paren
(brace
macro_line|#ifdef __SMP__
id|global
op_assign
(paren
r_struct
id|global_data
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
comma
id|ORDER
)paren
suffix:semicolon
id|memset
c_func
(paren
id|global
comma
l_int|0
comma
id|CHUNK_SIZE
)paren
suffix:semicolon
macro_line|#else
id|global
op_assign
(paren
r_struct
id|global_data
op_star
)paren
id|get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
macro_line|#endif
id|spin_lock_init
c_func
(paren
op_amp
id|global-&gt;lock
)paren
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|global-&gt;lock
)paren
suffix:semicolon
id|simp
op_assign
op_amp
id|global-&gt;simps
(braket
id|global-&gt;nr_simps
op_increment
)braket
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|global-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|global-&gt;nr_simps
op_ge
id|MAX_SIMPS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SIMP: too many simps allocated&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|simp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|simp
)paren
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|simp-&gt;lock
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|simp-&gt;name
comma
id|name
comma
l_int|15
)paren
suffix:semicolon
id|simp-&gt;size
op_assign
id|size
suffix:semicolon
id|simp-&gt;real_size
op_assign
id|real_size
op_assign
id|ALIGN_CACHE
c_func
(paren
id|size
)paren
suffix:semicolon
multiline_comment|/* allow aggregation of very small objects in 2-power fractions of&n;&t; * cachelines */
id|fraction
op_assign
id|COLOR_INCREMENT
op_div
l_int|2
suffix:semicolon
r_while
c_loop
(paren
id|size
op_le
id|fraction
op_logical_and
id|fraction
op_ge
r_sizeof
(paren
r_void
op_star
)paren
)paren
(brace
id|simp-&gt;real_size
op_assign
id|fraction
suffix:semicolon
id|fraction
op_rshift_assign
l_int|1
suffix:semicolon
)brace
id|simp-&gt;first_ctor
op_assign
id|first_ctor
suffix:semicolon
id|simp-&gt;again_ctor
op_assign
id|again_ctor
suffix:semicolon
id|simp-&gt;dtor
op_assign
id|dtor
suffix:semicolon
id|real_size
op_add_assign
r_sizeof
(paren
r_void
op_star
)paren
suffix:semicolon
id|simp-&gt;max_elems
op_assign
(paren
id|CHUNK_SIZE
op_minus
id|HEADER_SIZE
)paren
op_div
id|real_size
suffix:semicolon
id|simp-&gt;max_color
op_assign
(paren
id|CHUNK_SIZE
op_minus
id|HEADER_SIZE
)paren
op_mod
id|real_size
suffix:semicolon
r_for
c_loop
(paren
id|cpu
op_assign
l_int|0
suffix:semicolon
id|cpu
OL
id|NR_PROCESSORS
suffix:semicolon
id|cpu
op_increment
)paren
(brace
r_struct
id|per_processor
op_star
r_private
op_assign
op_amp
id|simp
op_member_access_from_pointer
r_private
(braket
id|cpu
)braket
suffix:semicolon
r_private
op_member_access_from_pointer
id|buffer_pos
op_assign
r_private
op_member_access_from_pointer
id|postbuffer
suffix:semicolon
)brace
r_return
id|simp
suffix:semicolon
)brace
multiline_comment|/* Do *not* inline this, it clobbers too many registers... */
DECL|function|alloc_header
r_static
r_void
id|alloc_header
c_func
(paren
r_struct
id|simp
op_star
id|simp
)paren
(brace
r_struct
id|header
op_star
id|hdr
suffix:semicolon
r_char
op_star
id|ptr
suffix:semicolon
r_void
op_star
op_star
id|index
suffix:semicolon
r_int
id|count
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|simp-&gt;lock
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|hdr
op_assign
(paren
r_struct
id|header
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
comma
id|ORDER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hdr
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|simp_garbage
c_func
(paren
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
)brace
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
id|CHUNK_BASE
c_func
(paren
id|hdr
)paren
op_ne
id|hdr
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;simp: bad kernel page alignment&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|memset
c_func
(paren
id|hdr
comma
l_int|0
comma
id|HEADER_SIZE
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|memcpy
c_func
(paren
id|hdr-&gt;magic
comma
id|global_magic
comma
r_sizeof
(paren
id|global_magic
)paren
)paren
suffix:semicolon
macro_line|#endif
id|hdr-&gt;father
op_assign
id|simp
suffix:semicolon
id|hdr-&gt;again_ctor
op_assign
id|simp-&gt;again_ctor
suffix:semicolon
id|hdr-&gt;first_ctor
op_assign
id|simp-&gt;first_ctor
suffix:semicolon
multiline_comment|/* note: races on simp-&gt;color don&squot;t produce any error :-) */
id|ptr
op_assign
(paren
(paren
r_char
op_star
)paren
id|hdr
)paren
op_plus
id|HEADER_SIZE
op_plus
id|simp-&gt;color
suffix:semicolon
id|index
op_assign
id|CHUNK_END
c_func
(paren
id|hdr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
id|simp-&gt;max_elems
suffix:semicolon
id|count
op_increment
)paren
(brace
op_star
op_decrement
id|index
op_assign
id|ptr
suffix:semicolon
id|ptr
op_add_assign
id|simp-&gt;real_size
suffix:semicolon
multiline_comment|/* note: constructors are not called here in bunch but&n;&t;&t; * instead at each single simp_alloc(), in order&n;&t;&t; * to maximize chances that the cache will be&n;&t;&t; * polluted after a simp_alloc() anyway,&n;&t;&t; * and not here. */
)brace
id|hdr-&gt;index
op_assign
id|hdr-&gt;fresh
op_assign
id|hdr-&gt;emptypos
op_assign
id|index
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|simp-&gt;lock
)paren
suffix:semicolon
id|simp-&gt;color
op_add_assign
id|COLOR_INCREMENT
suffix:semicolon
r_if
c_cond
(paren
id|simp-&gt;color
op_ge
id|simp-&gt;max_color
)paren
(brace
id|simp-&gt;color
op_assign
l_int|0
suffix:semicolon
)brace
id|hdr-&gt;next
op_assign
id|simp-&gt;usable_list
suffix:semicolon
id|simp-&gt;usable_list
op_assign
id|hdr
suffix:semicolon
)brace
multiline_comment|/* current x86 memcpy() is horribly moving around registers for nothing,&n; * is doing unnecessary work if the size is dividable by a power-of-two,&n; * and it clobbers way too many registers.&n; * This results in nearly any other register being transfered to stack.&n; * Fixing this would be a major win for the whole kernel!&n; */
DECL|function|bunch_alloc
r_static
r_void
op_star
op_star
id|bunch_alloc
c_func
(paren
r_struct
id|simp
op_star
id|simp
comma
r_void
op_star
op_star
id|buffer
)paren
(brace
r_struct
id|header
op_star
id|hdr
suffix:semicolon
r_void
op_star
op_star
id|index
suffix:semicolon
r_void
op_star
op_star
id|to
suffix:semicolon
r_void
op_star
op_star
id|end
suffix:semicolon
id|structor
id|todo
suffix:semicolon
r_int
id|length
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|simp-&gt;lock
)paren
suffix:semicolon
id|hdr
op_assign
id|simp-&gt;usable_list
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hdr
)paren
(brace
id|alloc_header
c_func
(paren
id|simp
)paren
suffix:semicolon
id|hdr
op_assign
id|simp-&gt;usable_list
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hdr
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|simp-&gt;lock
)paren
suffix:semicolon
op_star
id|buffer
op_assign
l_int|NULL
suffix:semicolon
r_return
id|buffer
op_plus
l_int|1
suffix:semicolon
)brace
)brace
id|index
op_assign
id|hdr-&gt;index
suffix:semicolon
id|end
op_assign
id|hdr-&gt;fresh
suffix:semicolon
id|todo
op_assign
id|hdr-&gt;again_ctor
suffix:semicolon
r_if
c_cond
(paren
id|index
op_eq
id|end
)paren
(brace
id|end
op_assign
id|CHUNK_END
c_func
(paren
id|hdr
)paren
suffix:semicolon
id|todo
op_assign
id|hdr-&gt;first_ctor
suffix:semicolon
)brace
id|to
op_assign
id|index
op_plus
id|POSTBUFFER_SIZE
op_div
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|to
op_ge
id|end
)paren
(brace
id|to
op_assign
id|end
suffix:semicolon
r_if
c_cond
(paren
id|to
op_eq
id|CHUNK_END
c_func
(paren
id|hdr
)paren
)paren
(brace
id|simp-&gt;usable_list
op_assign
id|hdr-&gt;next
suffix:semicolon
id|hdr-&gt;next
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|to
OG
id|hdr-&gt;fresh
)paren
(brace
id|hdr-&gt;fresh
op_assign
id|to
suffix:semicolon
)brace
id|hdr-&gt;index
op_assign
id|to
suffix:semicolon
id|length
op_assign
(paren
(paren
r_int
r_int
)paren
id|to
)paren
op_minus
(paren
r_int
r_int
)paren
id|index
suffix:semicolon
id|to
op_assign
id|buffer
op_plus
(paren
id|length
op_div
r_sizeof
(paren
r_void
op_star
op_star
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|buffer
comma
id|index
comma
id|length
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|simp-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|todo
)paren
(brace
r_do
(brace
id|todo
c_func
(paren
op_star
id|buffer
op_increment
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|buffer
OL
id|to
)paren
(brace
suffix:semicolon
)brace
)brace
r_return
id|to
suffix:semicolon
)brace
DECL|function|simp_alloc
r_void
op_star
id|simp_alloc
c_func
(paren
r_struct
id|simp
op_star
id|simp
)paren
(brace
macro_line|#ifdef __SMP__
r_const
r_int
id|cpu
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
r_struct
id|per_processor
op_star
id|priv
op_assign
op_amp
id|simp
op_member_access_from_pointer
r_private
(braket
id|cpu
)braket
suffix:semicolon
macro_line|#else
mdefine_line|#define priv (&amp;simp-&gt;private[0]) /*fool gcc to use no extra register*/
macro_line|#endif
r_void
op_star
op_star
id|buffer_pos
op_assign
id|priv-&gt;buffer_pos
suffix:semicolon
r_void
op_star
id|res
suffix:semicolon
r_if
c_cond
(paren
id|buffer_pos
op_eq
id|priv-&gt;postbuffer
)paren
(brace
id|buffer_pos
op_assign
id|bunch_alloc
c_func
(paren
id|simp
comma
id|buffer_pos
)paren
suffix:semicolon
)brace
id|buffer_pos
op_decrement
suffix:semicolon
id|res
op_assign
op_star
id|buffer_pos
suffix:semicolon
id|priv-&gt;buffer_pos
op_assign
id|buffer_pos
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
DECL|function|check_header
r_int
id|check_header
c_func
(paren
r_struct
id|header
op_star
id|hdr
comma
r_void
op_star
id|ptr
)paren
(brace
r_void
op_star
op_star
id|test
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hdr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SIMP: simp_free() with NULL pointer&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|hdr-&gt;magic
comma
id|global_magic
comma
l_int|32
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SIMP: simpe_free() with bad ptr %p, or header corruption&bslash;n&quot;
comma
id|ptr
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* This is brute force, but I don&squot;t want to pay for any&n;&t; * overhead if debugging is not enabled, in particular&n;&t; * no space overhead for keeping hashtables etc. */
id|test
op_assign
id|hdr-&gt;index
suffix:semicolon
r_while
c_loop
(paren
id|test
OL
id|CHUNK_END
c_func
(paren
id|hdr
)paren
)paren
(brace
r_if
c_cond
(paren
op_star
id|test
op_increment
op_eq
id|ptr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SIMP: trying to simp_free(%p) again&bslash;n&quot;
comma
id|ptr
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|function|bunch_free
r_static
r_void
op_star
op_star
id|bunch_free
c_func
(paren
r_struct
id|simp
op_star
id|simp
comma
r_void
op_star
op_star
id|buffer
)paren
(brace
r_void
op_star
op_star
id|stop
suffix:semicolon
id|stop
op_assign
id|buffer
op_minus
id|POSTBUFFER_SIZE
op_div
l_int|3
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|simp-&gt;lock
)paren
suffix:semicolon
r_while
c_loop
(paren
id|buffer
OG
id|stop
)paren
(brace
r_void
op_star
id|elem
op_assign
id|buffer
(braket
op_minus
l_int|1
)braket
suffix:semicolon
r_struct
id|header
op_star
id|hdr
op_assign
id|CHUNK_BASE
c_func
(paren
id|elem
)paren
suffix:semicolon
r_void
op_star
op_star
id|index
op_assign
id|hdr-&gt;index
suffix:semicolon
id|index
op_decrement
suffix:semicolon
id|hdr-&gt;index
op_assign
id|index
suffix:semicolon
op_star
id|index
op_assign
id|elem
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hdr-&gt;next
)paren
(brace
id|hdr-&gt;next
op_assign
id|simp-&gt;usable_list
suffix:semicolon
id|simp-&gt;usable_list
op_assign
id|hdr
suffix:semicolon
)brace
id|buffer
op_sub_assign
l_int|2
suffix:semicolon
id|elem
op_assign
op_star
id|buffer
suffix:semicolon
id|hdr
op_assign
id|CHUNK_BASE
c_func
(paren
id|elem
)paren
suffix:semicolon
id|index
op_assign
id|hdr-&gt;index
suffix:semicolon
id|index
op_decrement
suffix:semicolon
id|hdr-&gt;index
op_assign
id|index
suffix:semicolon
op_star
id|index
op_assign
id|elem
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hdr-&gt;next
)paren
(brace
id|hdr-&gt;next
op_assign
id|simp-&gt;usable_list
suffix:semicolon
id|simp-&gt;usable_list
op_assign
id|hdr
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|simp-&gt;lock
)paren
suffix:semicolon
id|global-&gt;changed_flag
op_assign
l_int|1
suffix:semicolon
r_return
id|buffer
suffix:semicolon
)brace
DECL|function|simp_free
r_void
id|simp_free
c_func
(paren
r_void
op_star
id|objp
)paren
(brace
r_struct
id|header
op_star
id|hdr
suffix:semicolon
r_void
op_star
op_star
id|buffer_pos
suffix:semicolon
r_struct
id|per_processor
op_star
r_private
suffix:semicolon
macro_line|#ifdef __SMP__
r_const
r_int
id|cpu
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
macro_line|#else
r_const
r_int
id|cpu
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|hdr
op_assign
id|CHUNK_BASE
c_func
(paren
id|objp
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
id|check_header
c_func
(paren
id|hdr
comma
id|objp
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
macro_line|#endif
r_private
op_assign
op_amp
id|hdr-&gt;father
op_member_access_from_pointer
r_private
(braket
id|cpu
)braket
suffix:semicolon
id|buffer_pos
op_assign
r_private
op_member_access_from_pointer
id|buffer_pos
suffix:semicolon
r_if
c_cond
(paren
id|buffer_pos
op_ge
r_private
op_member_access_from_pointer
id|postbuffer
op_plus
id|POSTBUFFER_SIZE
)paren
(brace
id|buffer_pos
op_assign
id|bunch_free
c_func
(paren
id|hdr-&gt;father
comma
id|buffer_pos
)paren
suffix:semicolon
)brace
op_star
id|buffer_pos
op_increment
op_assign
id|objp
suffix:semicolon
r_private
op_member_access_from_pointer
id|buffer_pos
op_assign
id|buffer_pos
suffix:semicolon
macro_line|#ifdef DEAD_BEEF
(brace
r_int
r_int
op_star
id|ptr
op_assign
(paren
r_int
r_int
op_star
)paren
id|objp
suffix:semicolon
r_int
id|count
op_assign
(paren
id|hdr-&gt;father-&gt;real_size
op_minus
id|ELEM_SIZE
)paren
op_div
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
op_decrement
)paren
(brace
op_star
id|ptr
op_increment
op_assign
l_int|0xdeadbeef
suffix:semicolon
)brace
)brace
macro_line|#endif
)brace
DECL|function|simp_garbage
r_int
id|simp_garbage
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|res
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|global-&gt;changed_flag
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* shortcut */
multiline_comment|/* Note: costs do not matter here. Any heavy thrashing of&n;&t; * simp chunks that could be caused by pools stealing each&n;&t; * other&squot;s memory has to be considered a BUG :-)&n;&t; * Simply avoid memory shortages by conservative allocating&n;&t; * policies.&n;&t; */
id|global-&gt;changed_flag
op_assign
l_int|0
suffix:semicolon
id|res
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|global-&gt;nr_simps
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|simp
op_star
id|simp
op_assign
op_amp
id|global-&gt;simps
(braket
id|i
)braket
suffix:semicolon
r_struct
id|header
op_star
op_star
id|base
op_assign
op_amp
id|simp-&gt;usable_list
suffix:semicolon
r_struct
id|header
op_star
id|del
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|simp-&gt;lock
)paren
suffix:semicolon
id|del
op_assign
op_star
id|base
suffix:semicolon
r_while
c_loop
(paren
id|del
)paren
(brace
r_if
c_cond
(paren
id|del-&gt;index
op_eq
id|del-&gt;emptypos
)paren
(brace
r_if
c_cond
(paren
id|simp-&gt;dtor
)paren
(brace
r_void
op_star
op_star
id|ptr
op_assign
id|del-&gt;index
suffix:semicolon
r_while
c_loop
(paren
id|ptr
OL
id|CHUNK_END
c_func
(paren
id|del
)paren
)paren
(brace
id|simp
op_member_access_from_pointer
id|dtor
c_func
(paren
op_star
id|ptr
op_increment
)paren
suffix:semicolon
)brace
)brace
op_star
id|base
op_assign
id|del-&gt;next
suffix:semicolon
macro_line|#ifdef DEBUG
id|memset
c_func
(paren
id|del
comma
l_int|0
comma
id|CHUNK_SIZE
)paren
suffix:semicolon
macro_line|#endif
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|del
comma
id|ORDER
)paren
suffix:semicolon
id|res
op_increment
suffix:semicolon
)brace
r_else
id|base
op_assign
op_amp
id|del-&gt;next
suffix:semicolon
id|del
op_assign
op_star
id|base
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|simp-&gt;lock
)paren
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
eof
