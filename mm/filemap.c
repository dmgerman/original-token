multiline_comment|/*&n; *&t;linux/mm/filemmap.c&n; *&n; * Copyright (C) 1994 Linus Torvalds&n; */
multiline_comment|/*&n; * This file handles the generic file mmap semantics used by&n; * most &quot;normal&quot; filesystems (but you don&squot;t /have/ to use this:&n; * the NFS filesystem does this differently, for example)&n; */
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/shm.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/mman.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
multiline_comment|/*&n; * Shared mappings implemented 30.11.1994. It&squot;s not fully working yet,&n; * though.&n; */
DECL|function|file_mmap_nopage
r_static
r_int
r_int
id|file_mmap_nopage
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|area
comma
r_int
r_int
id|address
comma
r_int
r_int
id|page
comma
r_int
id|no_share
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|area-&gt;vm_inode
suffix:semicolon
r_int
r_int
id|block
suffix:semicolon
r_int
id|nr
(braket
l_int|8
)braket
suffix:semicolon
r_int
id|i
comma
op_star
id|p
suffix:semicolon
id|address
op_and_assign
id|PAGE_MASK
suffix:semicolon
id|block
op_assign
id|address
op_minus
id|area-&gt;vm_start
op_plus
id|area-&gt;vm_offset
suffix:semicolon
id|block
op_rshift_assign
id|inode-&gt;i_sb-&gt;s_blocksize_bits
suffix:semicolon
id|i
op_assign
id|PAGE_SIZE
op_rshift
id|inode-&gt;i_sb-&gt;s_blocksize_bits
suffix:semicolon
id|p
op_assign
id|nr
suffix:semicolon
r_do
(brace
op_star
id|p
op_assign
id|bmap
c_func
(paren
id|inode
comma
id|block
)paren
suffix:semicolon
id|i
op_decrement
suffix:semicolon
id|block
op_increment
suffix:semicolon
id|p
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
OG
l_int|0
)paren
suffix:semicolon
r_return
id|bread_page
c_func
(paren
id|page
comma
id|inode-&gt;i_dev
comma
id|nr
comma
id|inode-&gt;i_sb-&gt;s_blocksize
comma
id|no_share
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * NOTE! mmap sync doesn&squot;t really work yet. This is mainly a stub for it,&n; * which only works if the buffers and the page were already sharing the&n; * same physical page (that&squot;s actually pretty common, especially if the&n; * file has been mmap&squot;ed before being read the normal way).&n; *&n; * Todo:&n; * - non-shared pages also need to be synced with the buffers.&n; * - the &quot;swapout()&quot; function needs to swap out the page to&n; *   the shared file instead of using the swap device.&n; */
DECL|function|file_mmap_sync_page
r_static
r_inline
r_void
id|file_mmap_sync_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|offset
comma
r_int
r_int
id|page
)paren
(brace
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
id|bh
op_assign
id|buffer_pages
(braket
id|MAP_NR
c_func
(paren
id|page
)paren
)braket
suffix:semicolon
r_if
c_cond
(paren
id|bh
)paren
(brace
multiline_comment|/* whee.. just mark the buffer heads dirty */
r_struct
id|buffer_head
op_star
id|tmp
op_assign
id|bh
suffix:semicolon
r_do
(brace
id|mark_buffer_dirty
c_func
(paren
id|tmp
comma
l_int|0
)paren
suffix:semicolon
id|tmp
op_assign
id|tmp-&gt;b_this_page
suffix:semicolon
)brace
r_while
c_loop
(paren
id|tmp
op_ne
id|bh
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* we&squot;ll need to go fetch the buffer heads etc.. RSN */
id|printk
c_func
(paren
l_string|&quot;msync: %ld: [%08lx]&bslash;n&quot;
comma
id|offset
comma
id|page
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Can&squot;t handle non-shared page yet&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|file_mmap_sync
r_static
r_void
id|file_mmap_sync
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|start
comma
r_int
id|size
comma
r_int
r_int
id|flags
)paren
(brace
id|pgd_t
op_star
id|dir
suffix:semicolon
r_int
r_int
id|poff
comma
id|pcnt
suffix:semicolon
id|size
op_assign
id|size
op_rshift
id|PAGE_SHIFT
suffix:semicolon
id|dir
op_assign
id|PAGE_DIR_OFFSET
c_func
(paren
id|current
comma
id|start
)paren
suffix:semicolon
id|poff
op_assign
(paren
id|start
op_rshift
id|PAGE_SHIFT
)paren
op_amp
(paren
id|PTRS_PER_PAGE
op_minus
l_int|1
)paren
suffix:semicolon
id|start
op_sub_assign
id|vma-&gt;vm_start
suffix:semicolon
id|pcnt
op_assign
id|PTRS_PER_PAGE
op_minus
id|poff
suffix:semicolon
r_if
c_cond
(paren
id|pcnt
OG
id|size
)paren
id|pcnt
op_assign
id|size
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|size
OG
l_int|0
suffix:semicolon
op_increment
id|dir
comma
id|size
op_sub_assign
id|pcnt
comma
id|pcnt
op_assign
(paren
id|size
OG
id|PTRS_PER_PAGE
ques
c_cond
id|PTRS_PER_PAGE
suffix:colon
id|size
)paren
)paren
(brace
id|pte_t
op_star
id|page_table
suffix:semicolon
r_int
r_int
id|pc
suffix:semicolon
r_if
c_cond
(paren
id|pgd_none
c_func
(paren
op_star
id|dir
)paren
)paren
(brace
id|poff
op_assign
l_int|0
suffix:semicolon
id|start
op_add_assign
id|pcnt
op_star
id|PAGE_SIZE
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pgd_bad
c_func
(paren
op_star
id|dir
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;file_mmap_sync: bad page directory entry %08lx.&bslash;n&quot;
comma
id|pgd_val
c_func
(paren
op_star
id|dir
)paren
)paren
suffix:semicolon
id|pgd_clear
c_func
(paren
id|dir
)paren
suffix:semicolon
id|poff
op_assign
l_int|0
suffix:semicolon
id|start
op_add_assign
id|pcnt
op_star
id|PAGE_SIZE
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|page_table
op_assign
id|poff
op_plus
(paren
id|pte_t
op_star
)paren
id|pgd_page
c_func
(paren
op_star
id|dir
)paren
suffix:semicolon
id|poff
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|pc
op_assign
id|pcnt
suffix:semicolon
id|pc
op_decrement
suffix:semicolon
id|page_table
op_increment
comma
id|start
op_add_assign
id|PAGE_SIZE
)paren
(brace
id|pte_t
id|pte
suffix:semicolon
id|pte
op_assign
op_star
id|page_table
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pte_present
c_func
(paren
id|pte
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pte_dirty
c_func
(paren
id|pte
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|MS_INVALIDATE
)paren
(brace
id|pte_clear
c_func
(paren
id|page_table
)paren
suffix:semicolon
)brace
r_else
(brace
id|mem_map
(braket
id|MAP_NR
c_func
(paren
id|pte_page
c_func
(paren
id|pte
)paren
)paren
)braket
op_increment
suffix:semicolon
op_star
id|page_table
op_assign
id|pte_mkclean
c_func
(paren
id|pte
)paren
suffix:semicolon
)brace
id|file_mmap_sync_page
c_func
(paren
id|vma
comma
id|start
comma
id|pte_page
c_func
(paren
id|pte
)paren
)paren
suffix:semicolon
id|free_page
c_func
(paren
id|pte_page
c_func
(paren
id|pte
)paren
)paren
suffix:semicolon
)brace
)brace
id|invalidate
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * This handles area unmaps..&n; */
DECL|function|file_mmap_unmap
r_static
r_void
id|file_mmap_unmap
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|start
comma
r_int
id|len
)paren
(brace
id|file_mmap_sync
c_func
(paren
id|vma
comma
id|start
comma
id|len
comma
id|MS_ASYNC
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This handles complete area closes..&n; */
DECL|function|file_mmap_close
r_static
r_void
id|file_mmap_close
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
id|file_mmap_sync
c_func
(paren
id|vma
comma
id|vma-&gt;vm_start
comma
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
comma
id|MS_ASYNC
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This isn&squot;t implemented yet: you&squot;ll get a warning and incorrect behaviour.&n; *&n; * Note that the page is free&squot;d by the higher-level after return,&n; * so we have to either write it out or just forget it. We currently&n; * forget it..&n; */
DECL|function|file_mmap_swapout
r_void
id|file_mmap_swapout
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|offset
comma
id|pte_t
op_star
id|page_table
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;swapout not implemented on shared files..&bslash;n&quot;
)paren
suffix:semicolon
id|pte_clear
c_func
(paren
id|page_table
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Shared mappings need to be able to do the right thing at&n; * close/unmap/sync. They will also use the private file as&n; * backing-store for swapping..&n; */
DECL|variable|file_shared_mmap
r_static
r_struct
id|vm_operations_struct
id|file_shared_mmap
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* open */
id|file_mmap_close
comma
multiline_comment|/* close */
id|file_mmap_unmap
comma
multiline_comment|/* unmap */
l_int|NULL
comma
multiline_comment|/* protect */
id|file_mmap_sync
comma
multiline_comment|/* sync */
l_int|NULL
comma
multiline_comment|/* advise */
id|file_mmap_nopage
comma
multiline_comment|/* nopage */
l_int|NULL
comma
multiline_comment|/* wppage */
id|file_mmap_swapout
comma
multiline_comment|/* swapout */
l_int|NULL
comma
multiline_comment|/* swapin */
)brace
suffix:semicolon
multiline_comment|/*&n; * Private mappings just need to be able to load in the map&n; *&n; * (this is actually used for shared mappings as well, if we&n; * know they can&squot;t ever get write permissions..)&n; */
DECL|variable|file_private_mmap
r_static
r_struct
id|vm_operations_struct
id|file_private_mmap
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* open */
l_int|NULL
comma
multiline_comment|/* close */
l_int|NULL
comma
multiline_comment|/* unmap */
l_int|NULL
comma
multiline_comment|/* protect */
l_int|NULL
comma
multiline_comment|/* sync */
l_int|NULL
comma
multiline_comment|/* advise */
id|file_mmap_nopage
comma
multiline_comment|/* nopage */
l_int|NULL
comma
multiline_comment|/* wppage */
l_int|NULL
comma
multiline_comment|/* swapout */
l_int|NULL
comma
multiline_comment|/* swapin */
)brace
suffix:semicolon
multiline_comment|/* This is used for a general mmap of a disk file */
DECL|function|generic_mmap
r_int
id|generic_mmap
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
r_struct
id|vm_operations_struct
op_star
id|ops
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_offset
op_amp
(paren
id|inode-&gt;i_sb-&gt;s_blocksize
op_minus
l_int|1
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode-&gt;i_sb
op_logical_or
op_logical_neg
id|S_ISREG
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode-&gt;i_op
op_logical_or
op_logical_neg
id|inode-&gt;i_op-&gt;bmap
)paren
r_return
op_minus
id|ENOEXEC
suffix:semicolon
id|ops
op_assign
op_amp
id|file_private_mmap
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_SHARED
)paren
(brace
r_if
c_cond
(paren
id|vma-&gt;vm_flags
op_amp
(paren
id|VM_WRITE
op_or
id|VM_MAYWRITE
)paren
)paren
(brace
r_static
r_int
id|nr
op_assign
l_int|0
suffix:semicolon
id|ops
op_assign
op_amp
id|file_shared_mmap
suffix:semicolon
r_if
c_cond
(paren
id|nr
op_increment
OL
l_int|5
)paren
id|printk
c_func
(paren
l_string|&quot;%s tried to do a shared writeable mapping&bslash;n&quot;
comma
id|current-&gt;comm
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|IS_RDONLY
c_func
(paren
id|inode
)paren
)paren
(brace
id|inode-&gt;i_atime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|inode-&gt;i_dirt
op_assign
l_int|1
suffix:semicolon
)brace
id|vma-&gt;vm_inode
op_assign
id|inode
suffix:semicolon
id|inode-&gt;i_count
op_increment
suffix:semicolon
id|vma-&gt;vm_ops
op_assign
id|ops
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
