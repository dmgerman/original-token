macro_line|#ifndef __ALPHA_JENSEN_H
DECL|macro|__ALPHA_JENSEN_H
mdefine_line|#define __ALPHA_JENSEN_H
macro_line|#include &lt;asm/compiler.h&gt;
multiline_comment|/*&n; * Defines for the AlphaPC EISA IO and memory address space.&n; */
multiline_comment|/* The Jensen is strange */
DECL|macro|AUX_IRQ
mdefine_line|#define AUX_IRQ (9)
multiline_comment|/*&n; * NOTE! The memory operations do not set any memory barriers, as it&squot;s&n; * not needed for cases like a frame buffer that is essentially memory-like.&n; * You need to do them by hand if the operations depend on ordering.&n; *&n; * Similarly, the port IO operations do a &quot;mb&quot; only after a write operation:&n; * if an mb is needed before (as in the case of doing memory mapped IO&n; * first, and then a port IO operation to the same device), it needs to be&n; * done by hand.&n; *&n; * After the above has bitten me 100 times, I&squot;ll give up and just do the&n; * mb all the time, but right now I&squot;m hoping this will work out.  Avoiding&n; * mb&squot;s may potentially be a noticeable speed improvement, but I can&squot;t&n; * honestly say I&squot;ve tested it.&n; *&n; * Handling interrupts that need to do mb&squot;s to synchronize to non-interrupts&n; * is another fun race area.  Don&squot;t do it (because if you do, I&squot;ll have to&n; * do *everything* with interrupts disabled, ugh).&n; */
multiline_comment|/*&n; * EISA Interrupt Acknowledge address&n; */
DECL|macro|EISA_INTA
mdefine_line|#define EISA_INTA&t;&t;(IDENT_ADDR + 0x100000000UL)
multiline_comment|/*&n; * FEPROM addresses&n; */
DECL|macro|EISA_FEPROM0
mdefine_line|#define EISA_FEPROM0&t;&t;(IDENT_ADDR + 0x180000000UL)
DECL|macro|EISA_FEPROM1
mdefine_line|#define EISA_FEPROM1&t;&t;(IDENT_ADDR + 0x1A0000000UL)
multiline_comment|/*&n; * VL82C106 base address&n; */
DECL|macro|EISA_VL82C106
mdefine_line|#define EISA_VL82C106&t;&t;(IDENT_ADDR + 0x1C0000000UL)
multiline_comment|/*&n; * EISA &quot;Host Address Extension&quot; address (bits 25-31 of the EISA address)&n; */
DECL|macro|EISA_HAE
mdefine_line|#define EISA_HAE&t;&t;(IDENT_ADDR + 0x1D0000000UL)
multiline_comment|/*&n; * &quot;SYSCTL&quot; register address&n; */
DECL|macro|EISA_SYSCTL
mdefine_line|#define EISA_SYSCTL&t;&t;(IDENT_ADDR + 0x1E0000000UL)
multiline_comment|/*&n; * &quot;spare&quot; register address&n; */
DECL|macro|EISA_SPARE
mdefine_line|#define EISA_SPARE&t;&t;(IDENT_ADDR + 0x1F0000000UL)
multiline_comment|/*&n; * EISA memory address offset&n; */
DECL|macro|EISA_MEM
mdefine_line|#define EISA_MEM&t;&t;(IDENT_ADDR + 0x200000000UL)
multiline_comment|/*&n; * EISA IO address offset&n; */
DECL|macro|EISA_IO
mdefine_line|#define EISA_IO&t;&t;&t;(IDENT_ADDR + 0x300000000UL)
macro_line|#ifdef __KERNEL__
macro_line|#ifndef __EXTERN_INLINE
DECL|macro|__EXTERN_INLINE
mdefine_line|#define __EXTERN_INLINE extern inline
DECL|macro|__IO_EXTERN_INLINE
mdefine_line|#define __IO_EXTERN_INLINE
macro_line|#endif
multiline_comment|/*&n; * Handle the &quot;host address register&quot;. This needs to be set&n; * to the high 7 bits of the EISA address.  This is also needed&n; * for EISA IO addresses, which are only 16 bits wide (the&n; * hae needs to be set to 0).&n; *&n; * HAE isn&squot;t needed for the local IO operations, though.&n; */
DECL|macro|JENSEN_HAE_ADDRESS
mdefine_line|#define JENSEN_HAE_ADDRESS&t;EISA_HAE
DECL|macro|JENSEN_HAE_MASK
mdefine_line|#define JENSEN_HAE_MASK&t;&t;0x1ffffff
DECL|function|jensen_set_hae
id|__EXTERN_INLINE
r_void
id|jensen_set_hae
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
multiline_comment|/* hae on the Jensen is bits 31:25 shifted right */
id|addr
op_rshift_assign
l_int|25
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_ne
id|alpha_mv.hae_cache
)paren
id|set_hae
c_func
(paren
id|addr
)paren
suffix:semicolon
)brace
DECL|macro|vuip
mdefine_line|#define vuip&t;volatile unsigned int *
multiline_comment|/*&n; * IO functions&n; *&n; * The &quot;local&quot; functions are those that don&squot;t go out to the EISA bus,&n; * but instead act on the VL82C106 chip directly.. This is mainly the&n; * keyboard, RTC,  printer and first two serial lines..&n; *&n; * The local stuff makes for some complications, but it seems to be&n; * gone in the PCI version. I hope I can get DEC suckered^H^H^H^H^H^H^H^H&n; * convinced that I need one of the newer machines.&n; */
DECL|function|jensen_local_inb
r_static
r_inline
r_int
r_int
id|jensen_local_inb
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_return
l_int|0xff
op_amp
op_star
(paren
id|vuip
)paren
(paren
(paren
id|addr
op_lshift
l_int|9
)paren
op_plus
id|EISA_VL82C106
)paren
suffix:semicolon
)brace
DECL|function|jensen_local_outb
r_static
r_inline
r_void
id|jensen_local_outb
c_func
(paren
r_int
r_char
id|b
comma
r_int
r_int
id|addr
)paren
(brace
op_star
(paren
id|vuip
)paren
(paren
(paren
id|addr
op_lshift
l_int|9
)paren
op_plus
id|EISA_VL82C106
)paren
op_assign
id|b
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|jensen_bus_inb
r_static
r_inline
r_int
r_int
id|jensen_bus_inb
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_int
id|result
suffix:semicolon
id|jensen_set_hae
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|result
op_assign
op_star
(paren
r_volatile
r_int
op_star
)paren
(paren
(paren
id|addr
op_lshift
l_int|7
)paren
op_plus
id|EISA_IO
op_plus
l_int|0x00
)paren
suffix:semicolon
r_return
id|__kernel_extbl
c_func
(paren
id|result
comma
id|addr
op_amp
l_int|3
)paren
suffix:semicolon
)brace
DECL|function|jensen_bus_outb
r_static
r_inline
r_void
id|jensen_bus_outb
c_func
(paren
r_int
r_char
id|b
comma
r_int
r_int
id|addr
)paren
(brace
id|jensen_set_hae
c_func
(paren
l_int|0
)paren
suffix:semicolon
op_star
(paren
id|vuip
)paren
(paren
(paren
id|addr
op_lshift
l_int|7
)paren
op_plus
id|EISA_IO
op_plus
l_int|0x00
)paren
op_assign
id|b
op_star
l_int|0x01010101
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * It seems gcc is not very good at optimizing away logical&n; * operations that result in operations across inline functions.&n; * Which is why this is a macro.&n; */
DECL|macro|jensen_is_local
mdefine_line|#define jensen_is_local(addr) ( &bslash;&n;/* keyboard */&t;(addr == 0x60 || addr == 0x64) || &bslash;&n;/* RTC */&t;(addr == 0x170 || addr == 0x171) || &bslash;&n;/* mb COM2 */&t;(addr &gt;= 0x2f8 &amp;&amp; addr &lt;= 0x2ff) || &bslash;&n;/* mb LPT1 */&t;(addr &gt;= 0x3bc &amp;&amp; addr &lt;= 0x3be) || &bslash;&n;/* mb COM2 */&t;(addr &gt;= 0x3f8 &amp;&amp; addr &lt;= 0x3ff))
DECL|function|jensen_inb
id|__EXTERN_INLINE
r_int
r_int
id|jensen_inb
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_if
c_cond
(paren
id|jensen_is_local
c_func
(paren
id|addr
)paren
)paren
r_return
id|jensen_local_inb
c_func
(paren
id|addr
)paren
suffix:semicolon
r_else
r_return
id|jensen_bus_inb
c_func
(paren
id|addr
)paren
suffix:semicolon
)brace
DECL|function|jensen_outb
id|__EXTERN_INLINE
r_void
id|jensen_outb
c_func
(paren
r_int
r_char
id|b
comma
r_int
r_int
id|addr
)paren
(brace
r_if
c_cond
(paren
id|jensen_is_local
c_func
(paren
id|addr
)paren
)paren
id|jensen_local_outb
c_func
(paren
id|b
comma
id|addr
)paren
suffix:semicolon
r_else
id|jensen_bus_outb
c_func
(paren
id|b
comma
id|addr
)paren
suffix:semicolon
)brace
DECL|function|jensen_inw
id|__EXTERN_INLINE
r_int
r_int
id|jensen_inw
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_int
id|result
suffix:semicolon
id|jensen_set_hae
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|result
op_assign
op_star
(paren
r_volatile
r_int
op_star
)paren
(paren
(paren
id|addr
op_lshift
l_int|7
)paren
op_plus
id|EISA_IO
op_plus
l_int|0x20
)paren
suffix:semicolon
id|result
op_rshift_assign
(paren
id|addr
op_amp
l_int|3
)paren
op_star
l_int|8
suffix:semicolon
r_return
l_int|0xffffUL
op_amp
id|result
suffix:semicolon
)brace
DECL|function|jensen_inl
id|__EXTERN_INLINE
r_int
r_int
id|jensen_inl
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
id|jensen_set_hae
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_return
op_star
(paren
id|vuip
)paren
(paren
(paren
id|addr
op_lshift
l_int|7
)paren
op_plus
id|EISA_IO
op_plus
l_int|0x60
)paren
suffix:semicolon
)brace
DECL|function|jensen_outw
id|__EXTERN_INLINE
r_void
id|jensen_outw
c_func
(paren
r_int
r_int
id|b
comma
r_int
r_int
id|addr
)paren
(brace
id|jensen_set_hae
c_func
(paren
l_int|0
)paren
suffix:semicolon
op_star
(paren
id|vuip
)paren
(paren
(paren
id|addr
op_lshift
l_int|7
)paren
op_plus
id|EISA_IO
op_plus
l_int|0x20
)paren
op_assign
id|b
op_star
l_int|0x00010001
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|jensen_outl
id|__EXTERN_INLINE
r_void
id|jensen_outl
c_func
(paren
r_int
r_int
id|b
comma
r_int
r_int
id|addr
)paren
(brace
id|jensen_set_hae
c_func
(paren
l_int|0
)paren
suffix:semicolon
op_star
(paren
id|vuip
)paren
(paren
(paren
id|addr
op_lshift
l_int|7
)paren
op_plus
id|EISA_IO
op_plus
l_int|0x60
)paren
op_assign
id|b
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Memory functions.&n; */
DECL|function|jensen_readb
id|__EXTERN_INLINE
r_int
r_int
id|jensen_readb
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_int
id|result
suffix:semicolon
id|jensen_set_hae
c_func
(paren
id|addr
)paren
suffix:semicolon
id|addr
op_and_assign
id|JENSEN_HAE_MASK
suffix:semicolon
id|result
op_assign
op_star
(paren
r_volatile
r_int
op_star
)paren
(paren
(paren
id|addr
op_lshift
l_int|7
)paren
op_plus
id|EISA_MEM
op_plus
l_int|0x00
)paren
suffix:semicolon
id|result
op_rshift_assign
(paren
id|addr
op_amp
l_int|3
)paren
op_star
l_int|8
suffix:semicolon
r_return
l_int|0xffUL
op_amp
id|result
suffix:semicolon
)brace
DECL|function|jensen_readw
id|__EXTERN_INLINE
r_int
r_int
id|jensen_readw
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_int
id|result
suffix:semicolon
id|jensen_set_hae
c_func
(paren
id|addr
)paren
suffix:semicolon
id|addr
op_and_assign
id|JENSEN_HAE_MASK
suffix:semicolon
id|result
op_assign
op_star
(paren
r_volatile
r_int
op_star
)paren
(paren
(paren
id|addr
op_lshift
l_int|7
)paren
op_plus
id|EISA_MEM
op_plus
l_int|0x20
)paren
suffix:semicolon
id|result
op_rshift_assign
(paren
id|addr
op_amp
l_int|3
)paren
op_star
l_int|8
suffix:semicolon
r_return
l_int|0xffffUL
op_amp
id|result
suffix:semicolon
)brace
DECL|function|jensen_readl
id|__EXTERN_INLINE
r_int
r_int
id|jensen_readl
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
id|jensen_set_hae
c_func
(paren
id|addr
)paren
suffix:semicolon
id|addr
op_and_assign
id|JENSEN_HAE_MASK
suffix:semicolon
r_return
op_star
(paren
id|vuip
)paren
(paren
(paren
id|addr
op_lshift
l_int|7
)paren
op_plus
id|EISA_MEM
op_plus
l_int|0x60
)paren
suffix:semicolon
)brace
DECL|function|jensen_readq
id|__EXTERN_INLINE
r_int
r_int
id|jensen_readq
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_int
r_int
id|r0
comma
id|r1
suffix:semicolon
id|jensen_set_hae
c_func
(paren
id|addr
)paren
suffix:semicolon
id|addr
op_and_assign
id|JENSEN_HAE_MASK
suffix:semicolon
id|addr
op_assign
(paren
id|addr
op_lshift
l_int|7
)paren
op_plus
id|EISA_MEM
op_plus
l_int|0x60
suffix:semicolon
id|r0
op_assign
op_star
(paren
id|vuip
)paren
(paren
id|addr
)paren
suffix:semicolon
id|r1
op_assign
op_star
(paren
id|vuip
)paren
(paren
id|addr
op_plus
(paren
l_int|4
op_lshift
l_int|7
)paren
)paren
suffix:semicolon
r_return
id|r1
op_lshift
l_int|32
op_or
id|r0
suffix:semicolon
)brace
DECL|function|jensen_writeb
id|__EXTERN_INLINE
r_void
id|jensen_writeb
c_func
(paren
r_int
r_char
id|b
comma
r_int
r_int
id|addr
)paren
(brace
id|jensen_set_hae
c_func
(paren
id|addr
)paren
suffix:semicolon
id|addr
op_and_assign
id|JENSEN_HAE_MASK
suffix:semicolon
op_star
(paren
id|vuip
)paren
(paren
(paren
id|addr
op_lshift
l_int|7
)paren
op_plus
id|EISA_MEM
op_plus
l_int|0x00
)paren
op_assign
id|b
op_star
l_int|0x01010101
suffix:semicolon
)brace
DECL|function|jensen_writew
id|__EXTERN_INLINE
r_void
id|jensen_writew
c_func
(paren
r_int
r_int
id|b
comma
r_int
r_int
id|addr
)paren
(brace
id|jensen_set_hae
c_func
(paren
id|addr
)paren
suffix:semicolon
id|addr
op_and_assign
id|JENSEN_HAE_MASK
suffix:semicolon
op_star
(paren
id|vuip
)paren
(paren
(paren
id|addr
op_lshift
l_int|7
)paren
op_plus
id|EISA_MEM
op_plus
l_int|0x20
)paren
op_assign
id|b
op_star
l_int|0x00010001
suffix:semicolon
)brace
DECL|function|jensen_writel
id|__EXTERN_INLINE
r_void
id|jensen_writel
c_func
(paren
r_int
r_int
id|b
comma
r_int
r_int
id|addr
)paren
(brace
id|jensen_set_hae
c_func
(paren
id|addr
)paren
suffix:semicolon
id|addr
op_and_assign
id|JENSEN_HAE_MASK
suffix:semicolon
op_star
(paren
id|vuip
)paren
(paren
(paren
id|addr
op_lshift
l_int|7
)paren
op_plus
id|EISA_MEM
op_plus
l_int|0x60
)paren
op_assign
id|b
suffix:semicolon
)brace
DECL|function|jensen_writeq
id|__EXTERN_INLINE
r_void
id|jensen_writeq
c_func
(paren
r_int
r_int
id|b
comma
r_int
r_int
id|addr
)paren
(brace
id|jensen_set_hae
c_func
(paren
id|addr
)paren
suffix:semicolon
id|addr
op_and_assign
id|JENSEN_HAE_MASK
suffix:semicolon
id|addr
op_assign
(paren
id|addr
op_lshift
l_int|7
)paren
op_plus
id|EISA_MEM
op_plus
l_int|0x60
suffix:semicolon
op_star
(paren
id|vuip
)paren
(paren
id|addr
)paren
op_assign
id|b
suffix:semicolon
op_star
(paren
id|vuip
)paren
(paren
id|addr
op_plus
(paren
l_int|4
op_lshift
l_int|7
)paren
)paren
op_assign
id|b
op_rshift
l_int|32
suffix:semicolon
)brace
DECL|function|jensen_ioremap
id|__EXTERN_INLINE
r_int
r_int
id|jensen_ioremap
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_return
id|addr
suffix:semicolon
)brace
DECL|function|jensen_is_ioaddr
id|__EXTERN_INLINE
r_int
id|jensen_is_ioaddr
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_return
(paren
r_int
)paren
id|addr
op_ge
l_int|0
suffix:semicolon
)brace
DECL|macro|vuip
macro_line|#undef vuip
macro_line|#ifdef __WANT_IO_DEF
DECL|macro|__inb
mdefine_line|#define __inb&t;&t;jensen_inb
DECL|macro|__inw
mdefine_line|#define __inw&t;&t;jensen_inw
DECL|macro|__inl
mdefine_line|#define __inl&t;&t;jensen_inl
DECL|macro|__outb
mdefine_line|#define __outb&t;&t;jensen_outb
DECL|macro|__outw
mdefine_line|#define __outw&t;&t;jensen_outw
DECL|macro|__outl
mdefine_line|#define __outl&t;&t;jensen_outl
DECL|macro|__readb
mdefine_line|#define __readb&t;&t;jensen_readb
DECL|macro|__readw
mdefine_line|#define __readw&t;&t;jensen_readw
DECL|macro|__writeb
mdefine_line|#define __writeb&t;jensen_writeb
DECL|macro|__writew
mdefine_line|#define __writew&t;jensen_writew
DECL|macro|__readl
mdefine_line|#define __readl&t;&t;jensen_readl
DECL|macro|__readq
mdefine_line|#define __readq&t;&t;jensen_readq
DECL|macro|__writel
mdefine_line|#define __writel&t;jensen_writel
DECL|macro|__writeq
mdefine_line|#define __writeq&t;jensen_writeq
DECL|macro|__ioremap
mdefine_line|#define __ioremap&t;jensen_ioremap
DECL|macro|__is_ioaddr
mdefine_line|#define __is_ioaddr&t;jensen_is_ioaddr
multiline_comment|/*&n; * The above have so much overhead that it probably doesn&squot;t make&n; * sense to have them inlined (better icache behaviour).&n; */
DECL|macro|inb
mdefine_line|#define inb(port) &bslash;&n;(__builtin_constant_p((port))?__inb(port):_inb(port))
DECL|macro|outb
mdefine_line|#define outb(x, port) &bslash;&n;(__builtin_constant_p((port))?__outb((x),(port)):_outb((x),(port)))
macro_line|#endif /* __WANT_IO_DEF */
macro_line|#ifdef __IO_EXTERN_INLINE
DECL|macro|__EXTERN_INLINE
macro_line|#undef __EXTERN_INLINE
DECL|macro|__IO_EXTERN_INLINE
macro_line|#undef __IO_EXTERN_INLINE
macro_line|#endif
macro_line|#endif /* __KERNEL__ */
macro_line|#endif /* __ALPHA_JENSEN_H */
eof
