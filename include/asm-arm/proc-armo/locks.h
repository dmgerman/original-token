multiline_comment|/*&n; * linux/include/asm-arm/proc-armo/locks.h&n; *&n; * Copyright (C) 2000 Russell King&n; * Fixes for 26 bit machines, (C) 2000 Dave Gilbert&n; *&n; * Interrupt safe locking assembler. &n; *&n; */
macro_line|#ifndef __ASM_PROC_LOCKS_H
DECL|macro|__ASM_PROC_LOCKS_H
mdefine_line|#define __ASM_PROC_LOCKS_H
multiline_comment|/* Decrements by 1, fails if value &lt; 0 */
DECL|macro|__down_op
mdefine_line|#define __down_op(ptr,fail)&t;&t;&t;&bslash;&n;&t;({&t;&t;&t;&t;&t;&bslash;&n;&t;__asm__ __volatile__ (&t;&t;&t;&bslash;&n;&t;&quot;@ atomic down operation&bslash;n&quot;&t;&t;&bslash;&n;&quot;&t;mov&t;r0, pc&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;orr&t;lr, r0, #0x08000000&bslash;n&quot;&t;&t;&bslash;&n;&quot;&t;teqp&t;lr, #0&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;ldr&t;lr, [%0]&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;and&t;r0, r0, #0x0c000003&bslash;n&quot;&t;&t;&bslash;&n;&quot;&t;subs&t;lr, lr, #1&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;str&t;lr, [%0]&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;orrmi&t;r0, r0, #0x80000000&t;@ set N&bslash;n&quot; &bslash;&n;&quot;&t;teqp&t;r0, #0&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;movmi&t;r0, %0&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;blmi&t;&quot; SYMBOL_NAME_STR(fail)&t;&t;&bslash;&n;&t;:&t;&t;&t;&t;&t;&bslash;&n;&t;: &quot;r&quot; (ptr)&t;&t;&t;&t;&bslash;&n;&t;: &quot;r0&quot;, &quot;lr&quot;, &quot;cc&quot;);&t;&t;&t;&bslash;&n;&t;})
DECL|macro|__down_op_ret
mdefine_line|#define __down_op_ret(ptr,fail)&t;&t;&t;&bslash;&n;&t;({&t;&t;&t;&t;&t;&bslash;&n;&t;&t;unsigned int result;&t;&t;&bslash;&n;&t;__asm__ __volatile__ (&t;&t;&t;&bslash;&n;&quot;&t;@ down_op_ret&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;mov&t;r0, pc&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;orr&t;lr, r0, #0x08000000&bslash;n&quot;&t;&t;&bslash;&n;&quot;&t;teqp&t;lr, #0&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;ldr&t;lr, [%1]&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;and&t;r0, r0, #0x0c000003&bslash;n&quot;&t;&t;&bslash;&n;&quot;&t;subs&t;lr, lr, #1&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;str&t;lr, [%1]&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;orrmi&t;r0, r0, #0x80000000&t;@ set N&bslash;n&quot; &bslash;&n;&quot;&t;teqp&t;r0, #0&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;movmi&t;r0, %1&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;movpl&t;r0, #0&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;blmi&t;&quot; SYMBOL_NAME_STR(fail) &quot;&bslash;n&quot;&t;&bslash;&n;&quot;&t;mov&t;%0, r0&quot;&t;&t;&t;&t;&bslash;&n;&t;: &quot;=&amp;r&quot; (result)&t;&t;&t;&bslash;&n;&t;: &quot;r&quot; (ptr)&t;&t;&t;&t;&bslash;&n;&t;: &quot;r0&quot;, &quot;lr&quot;, &quot;cc&quot;);&t;&t;&t;&bslash;&n;&t;result;&t;&t;&t;&t;&t;&bslash;&n;&t;})
DECL|macro|__up_op
mdefine_line|#define __up_op(ptr,wake)&t;&t;&t;&bslash;&n;&t;({&t;&t;&t;&t;&t;&bslash;&n;&t;__asm__ __volatile__ (&t;&t;&t;&bslash;&n;&t;&quot;@ up_op&bslash;n&quot;&t;&t;&t;&t;&bslash;&n;&quot;&t;mov&t;r0, pc&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;orr&t;lr, r0, #0x08000000&bslash;n&quot;&t;&t;&bslash;&n;&quot;&t;teqp&t;lr, #0&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;ldr&t;lr, [%0]&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;and&t;r0, r0, #0x0c000003&bslash;n&quot;&t;&t;&bslash;&n;&quot;&t;adds&t;lr, lr, #1&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;str&t;lr, [%0]&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;orrle&t;r0, r0, #0x80000000&t;@ set N - should this be mi ??? DAG ! &bslash;n&quot; &bslash;&n;&quot;&t;teqp&t;r0, #0&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;movmi&t;r0, %0&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;blmi&t;&quot; SYMBOL_NAME_STR(wake)&t;&t;&bslash;&n;&t;:&t;&t;&t;&t;&t;&bslash;&n;&t;: &quot;r&quot; (ptr)&t;&t;&t;&t;&bslash;&n;&t;: &quot;r0&quot;, &quot;lr&quot;, &quot;cc&quot;);&t;&t;&t;&bslash;&n;&t;})
multiline_comment|/*&n; * The value 0x01000000 supports up to 128 processors and&n; * lots of processes.  BIAS must be chosen such that sub&squot;ing&n; * BIAS once per CPU will result in the long remaining&n; * negative.&n; */
DECL|macro|RW_LOCK_BIAS
mdefine_line|#define RW_LOCK_BIAS      0x01000000
DECL|macro|RW_LOCK_BIAS_STR
mdefine_line|#define RW_LOCK_BIAS_STR &quot;0x01000000&quot;
multiline_comment|/* Decrements by RW_LOCK_BIAS rather than 1, fails if value != 0 */
DECL|macro|__down_op_write
mdefine_line|#define __down_op_write(ptr,fail)&t;&t;&bslash;&n;&t;({&t;&t;&t;&t;&t;&bslash;&n;&t;__asm__ __volatile__(&t;&t;&t;&bslash;&n;&t;&quot;@ down_op_write&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;mov&t;r0, pc&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;orr&t;lr, r0, #0x08000000&bslash;n&quot;&t;&t;&bslash;&n;&quot;&t;teqp&t;lr, #0&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;and&t;r0, r0, #0x0c000003&bslash;n&quot;&t;&t;&bslash;&n;&bslash;&n;&quot;&t;ldr&t;lr, [%0]&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;subs&t;lr, lr, %1&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;str&t;lr, [%0]&bslash;n&quot;&t;&t;&t;&bslash;&n;&bslash;&n;&quot; orreq r0, r0, #0x40000000 @ set Z &bslash;n&quot;&bslash;&n;&quot;&t;teqp&t;r0, #0&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;movne&t;r0, %0&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;blne&t;&quot; SYMBOL_NAME_STR(fail)&t;&t;&bslash;&n;&t;:&t;&t;&t;&t;&t;&bslash;&n;&t;: &quot;r&quot; (ptr), &quot;I&quot; (RW_LOCK_BIAS)&t;&t;&bslash;&n;&t;: &quot;r0&quot;, &quot;lr&quot;, &quot;cc&quot;);&t;&t;&t;&bslash;&n;&t;})
multiline_comment|/* Increments by RW_LOCK_BIAS, wakes if value &gt;= 0 */
DECL|macro|__up_op_write
mdefine_line|#define __up_op_write(ptr,wake)&t;&t;&t;&bslash;&n;&t;({&t;&t;&t;&t;&t;&bslash;&n;&t;__asm__ __volatile__(&t;&t;&t;&bslash;&n;&t;&quot;@ up_op_read&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;mov&t;r0, pc&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;orr&t;lr, r0, #0x08000000&bslash;n&quot;&t;&t;&bslash;&n;&quot;&t;teqp&t;lr, #0&bslash;n&quot;&t;&t;&t;&bslash;&n;&bslash;&n;&quot;&t;ldr&t;lr, [%0]&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;and&t;r0, r0, #0x0c000003&bslash;n&quot;&t;&t;&bslash;&n;&quot;&t;adds&t;lr, lr, %1&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;str&t;lr, [%0]&bslash;n&quot;&t;&t;&t;&bslash;&n;&bslash;&n;&quot; orrcs r0, r0, #0x20000000 @ set C&bslash;n&quot; &bslash;&n;&quot;&t;teqp&t;r0, #0&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;movcs&t;r0, %0&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;blcs&t;&quot; SYMBOL_NAME_STR(wake)&t;&t;&bslash;&n;&t;:&t;&t;&t;&t;&t;&bslash;&n;&t;: &quot;r&quot; (ptr), &quot;I&quot; (RW_LOCK_BIAS)&t;&t;&bslash;&n;&t;: &quot;r0&quot;, &quot;lr&quot;, &quot;cc&quot;);&t;&t;&t;&bslash;&n;&t;})
DECL|macro|__down_op_read
mdefine_line|#define __down_op_read(ptr,fail)&t;&t;&bslash;&n;&t;__down_op(ptr, fail)
DECL|macro|__up_op_read
mdefine_line|#define __up_op_read(ptr,wake)&t;&t;&t;&bslash;&n;&t;({&t;&t;&t;&t;&t;&bslash;&n;&t;__asm__ __volatile__(&t;&t;&t;&bslash;&n;&t;&quot;@ up_op_read&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;mov&t;r0, pc&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;orr&t;lr, r0, #0x08000000&bslash;n&quot;&t;&t;&bslash;&n;&quot;&t;teqp&t;lr, #0&bslash;n&quot;&t;&t;&t;&bslash;&n;&bslash;&n;&quot;&t;ldr&t;lr, [%0]&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;and&t;r0, r0, #0x0c000003&bslash;n&quot;&t;&t;&bslash;&n;&quot;&t;adds&t;lr, lr, %1&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;str&t;lr, [%0]&bslash;n&quot;&t;&t;&t;&bslash;&n;&bslash;&n;&quot; orreq r0, r0, #0x40000000 @ Set Z &bslash;n&quot; &bslash;&n;&quot;&t;teqp&t;r0, #0&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;moveq&t;r0, %0&bslash;n&quot;&t;&t;&t;&bslash;&n;&quot;&t;bleq&t;&quot; SYMBOL_NAME_STR(wake)&t;&t;&bslash;&n;&t;:&t;&t;&t;&t;&t;&bslash;&n;&t;: &quot;r&quot; (ptr), &quot;I&quot; (1)&t;&t;&t;&bslash;&n;&t;: &quot;r0&quot;, &quot;lr&quot;, &quot;cc&quot;);&t;&t;&t;&bslash;&n;&t;})
macro_line|#endif
eof
