multiline_comment|/*&n; *  linux/include/asm-arm/arch-rpc/acornfb.h&n; *&n; *  Copyright (C) 1999 Russell King&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; *&n; *  AcornFB architecture specific code&n; */
DECL|macro|acornfb_valid_pixrate
mdefine_line|#define acornfb_valid_pixrate(rate) (1)
multiline_comment|/*&n; * Try to find the best PLL parameters for the pixel clock.&n; * This algorithm seems to give best predictable results,&n; * and produces the same values as detailed in the VIDC20&n; * data sheet.&n; */
r_static
r_inline
id|u_int
DECL|function|acornfb_vidc20_find_pll
id|acornfb_vidc20_find_pll
c_func
(paren
id|u_int
id|pixclk
)paren
(brace
id|u_int
id|r
comma
id|best_r
op_assign
l_int|2
comma
id|best_v
op_assign
l_int|2
suffix:semicolon
r_int
id|best_d
op_assign
l_int|0x7fffffff
suffix:semicolon
r_for
c_loop
(paren
id|r
op_assign
l_int|2
suffix:semicolon
id|r
op_le
l_int|32
suffix:semicolon
id|r
op_increment
)paren
(brace
id|u_int
id|rr
comma
id|v
comma
id|p
suffix:semicolon
r_int
id|d
suffix:semicolon
id|rr
op_assign
l_int|41667
op_star
id|r
suffix:semicolon
id|v
op_assign
(paren
id|rr
op_plus
id|pixclk
op_div
l_int|2
)paren
op_div
id|pixclk
suffix:semicolon
r_if
c_cond
(paren
id|v
OG
l_int|32
op_logical_or
id|v
OL
l_int|2
)paren
r_continue
suffix:semicolon
id|p
op_assign
(paren
id|rr
op_plus
id|v
op_div
l_int|2
)paren
op_div
id|v
suffix:semicolon
id|d
op_assign
id|pixclk
op_minus
id|p
suffix:semicolon
r_if
c_cond
(paren
id|d
OL
l_int|0
)paren
id|d
op_assign
op_minus
id|d
suffix:semicolon
r_if
c_cond
(paren
id|d
OL
id|best_d
)paren
(brace
id|best_d
op_assign
id|d
suffix:semicolon
id|best_v
op_assign
id|v
op_minus
l_int|1
suffix:semicolon
id|best_r
op_assign
id|r
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|d
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_return
id|best_v
op_lshift
l_int|8
op_or
id|best_r
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|acornfb_vidc20_find_rates
id|acornfb_vidc20_find_rates
c_func
(paren
r_struct
id|vidc_timing
op_star
id|vidc
comma
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
(brace
id|u_int
id|div
comma
id|bandwidth
suffix:semicolon
multiline_comment|/* Select pixel-clock divisor to keep PLL in range */
id|div
op_assign
id|var-&gt;pixclock
op_div
l_int|9090
suffix:semicolon
multiline_comment|/*9921*/
multiline_comment|/* Limit divisor */
r_if
c_cond
(paren
id|div
op_eq
l_int|0
)paren
id|div
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|div
OG
l_int|8
)paren
id|div
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* Encode divisor to VIDC20 setting */
r_switch
c_cond
(paren
id|div
)paren
(brace
r_case
l_int|1
suffix:colon
id|vidc-&gt;control
op_or_assign
id|VIDC20_CTRL_PIX_CK
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|vidc-&gt;control
op_or_assign
id|VIDC20_CTRL_PIX_CK2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|vidc-&gt;control
op_or_assign
id|VIDC20_CTRL_PIX_CK3
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|vidc-&gt;control
op_or_assign
id|VIDC20_CTRL_PIX_CK4
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|vidc-&gt;control
op_or_assign
id|VIDC20_CTRL_PIX_CK5
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|vidc-&gt;control
op_or_assign
id|VIDC20_CTRL_PIX_CK6
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|vidc-&gt;control
op_or_assign
id|VIDC20_CTRL_PIX_CK7
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|vidc-&gt;control
op_or_assign
id|VIDC20_CTRL_PIX_CK8
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Calculate bandwidth */
id|bandwidth
op_assign
id|var-&gt;pixclock
op_star
l_int|8
op_div
id|var-&gt;bits_per_pixel
suffix:semicolon
multiline_comment|/* Encode bandwidth as VIDC20 setting */
r_if
c_cond
(paren
id|bandwidth
OG
l_int|33334
)paren
id|vidc-&gt;control
op_or_assign
id|VIDC20_CTRL_FIFO_16
suffix:semicolon
multiline_comment|/* &lt; 30.0MB/s */
r_else
r_if
c_cond
(paren
id|bandwidth
OG
l_int|26666
)paren
id|vidc-&gt;control
op_or_assign
id|VIDC20_CTRL_FIFO_20
suffix:semicolon
multiline_comment|/* &lt; 37.5MB/s */
r_else
r_if
c_cond
(paren
id|bandwidth
OG
l_int|22222
)paren
id|vidc-&gt;control
op_or_assign
id|VIDC20_CTRL_FIFO_24
suffix:semicolon
multiline_comment|/* &lt; 45.0MB/s */
r_else
id|vidc-&gt;control
op_or_assign
id|VIDC20_CTRL_FIFO_28
suffix:semicolon
multiline_comment|/* &gt; 45.0MB/s */
multiline_comment|/* Find the PLL values */
id|vidc-&gt;pll_ctl
op_assign
id|acornfb_vidc20_find_pll
c_func
(paren
id|var-&gt;pixclock
op_div
id|div
)paren
suffix:semicolon
)brace
DECL|macro|acornfb_default_control
mdefine_line|#define acornfb_default_control()&t;(VIDC20_CTRL_PIX_VCLK)
DECL|macro|acornfb_default_econtrol
mdefine_line|#define acornfb_default_econtrol()&t;(VIDC20_ECTL_DAC | VIDC20_ECTL_REG(3))
eof
