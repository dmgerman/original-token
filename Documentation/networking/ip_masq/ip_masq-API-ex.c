multiline_comment|/*&n;   There is only 1 optname (see setsockopt(2)), IP_FW_MASQ_CTL that&n;   must be used.&n;   Funcionality depends on your kernel CONFIG options, here is&n;   an example you can use to create an ``incoming&squot;&squot; tunnel:&n;&n;   See &quot;user.c&quot; module under ipmasqadm tree for a generic example&n; */
DECL|macro|__KERNEL__
macro_line|#undef __KERNEL__&t;/* Makefile lazyness ;) */
macro_line|#include &lt;stdio.h&gt;
macro_line|#include &lt;stdlib.h&gt;
macro_line|#include &lt;netinet/in.h&gt;
macro_line|#include &lt;sys/socket.h&gt;
macro_line|#include &lt;sys/types.h&gt;
macro_line|#include &lt;arpa/inet.h&gt;
macro_line|#include &lt;asm/types.h&gt;          /* For __uXX types */
macro_line|#include &lt;net/if.h&gt;
macro_line|#include &lt;netinet/ip_icmp.h&gt;
macro_line|#include &lt;netinet/udp.h&gt;
macro_line|#include &lt;netinet/tcp.h&gt;
macro_line|#include &lt;linux/ip_fw.h&gt;        /* For IP_FW_MASQ_CTL */
macro_line|#include &lt;linux/ip_masq.h&gt;      /* For specific masq defs */
DECL|function|create_listening_masq
r_int
id|create_listening_masq
c_func
(paren
r_struct
id|ip_masq_ctl
op_star
id|masq
comma
r_int
id|proto
comma
id|u_int32_t
id|src_addr
comma
id|u_int16_t
id|src_port
comma
id|u_int32_t
id|dst_addr
)paren
(brace
r_int
id|sockfd
suffix:semicolon
id|sockfd
op_assign
id|socket
c_func
(paren
id|AF_INET
comma
id|SOCK_RAW
comma
id|IPPROTO_RAW
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sockfd
OL
l_int|0
)paren
(brace
id|perror
c_func
(paren
l_string|&quot;socket(RAW)&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memset
(paren
id|masq
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|masq
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Want user tunnel control&n;&t; */
id|masq-&gt;m_target
op_assign
id|IP_MASQ_TARGET_USER
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Want to insert new&n;&t; */
id|masq-&gt;m_cmd
op_assign
id|IP_MASQ_CMD_INSERT
suffix:semicolon
id|masq-&gt;u.user.protocol
op_assign
id|proto
suffix:semicolon
id|masq-&gt;u.user.saddr
op_assign
id|src_addr
suffix:semicolon
id|masq-&gt;u.user.sport
op_assign
id|src_port
suffix:semicolon
id|masq-&gt;u.user.rt_daddr
op_assign
id|inet_addr
c_func
(paren
l_string|&quot;192.168.21.239&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|setsockopt
c_func
(paren
id|sockfd
comma
id|IPPROTO_IP
comma
id|IP_FW_MASQ_CTL
comma
(paren
r_char
op_star
)paren
id|masq
comma
r_sizeof
(paren
op_star
id|masq
)paren
)paren
)paren
(brace
id|perror
c_func
(paren
l_string|&quot;setsockopt()&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* masq struct now contains tunnel details */
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;PROTO=%d SRC=0x%X:%x - MASQ=0x%X:%x - DST=0x%X:%x&bslash;n&quot;
comma
id|masq-&gt;u.user.protocol
comma
id|ntohl
c_func
(paren
id|masq-&gt;u.user.saddr
)paren
comma
id|ntohs
c_func
(paren
id|masq-&gt;u.user.sport
)paren
comma
id|ntohl
c_func
(paren
id|masq-&gt;u.user.maddr
)paren
comma
id|ntohs
c_func
(paren
id|masq-&gt;u.user.mport
)paren
comma
id|ntohl
c_func
(paren
id|masq-&gt;u.user.daddr
)paren
comma
id|ntohs
c_func
(paren
id|masq-&gt;u.user.dport
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|main
r_int
id|main
c_func
(paren
r_void
)paren
(brace
r_struct
id|ip_masq_ctl
id|masq_buf
suffix:semicolon
r_return
id|create_listening_masq
c_func
(paren
op_amp
id|masq_buf
comma
id|IPPROTO_TCP
comma
id|inet_addr
c_func
(paren
l_string|&quot;192.168.1.4&quot;
)paren
comma
id|htons
c_func
(paren
l_int|23
)paren
comma
id|inet_addr
c_func
(paren
l_string|&quot;192.168.21.3&quot;
)paren
)paren
suffix:semicolon
)brace
eof
