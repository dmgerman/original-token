multiline_comment|/* $Id: ipc.c,v 1.5 1999/12/09 00:41:00 davem Exp $&n; * ipc.c: Solaris IPC emulation&n; *&n; * Copyright (C) 1997 Jakub Jelinek (jj@sunsite.mff.cuni.cz)&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/shm.h&gt;
macro_line|#include &lt;linux/sem.h&gt;
macro_line|#include &lt;linux/msg.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/string.h&gt;
macro_line|#include &lt;asm/ipc.h&gt;
macro_line|#include &quot;conv.h&quot;
DECL|struct|solaris_ipc_perm
r_struct
id|solaris_ipc_perm
(brace
DECL|member|uid
id|s32
id|uid
suffix:semicolon
DECL|member|gid
id|s32
id|gid
suffix:semicolon
DECL|member|cuid
id|s32
id|cuid
suffix:semicolon
DECL|member|cgid
id|s32
id|cgid
suffix:semicolon
DECL|member|mode
id|u32
id|mode
suffix:semicolon
DECL|member|seq
id|u32
id|seq
suffix:semicolon
DECL|member|key
r_int
id|key
suffix:semicolon
DECL|member|pad
id|s32
id|pad
(braket
l_int|4
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|solaris_shmid_ds
r_struct
id|solaris_shmid_ds
(brace
DECL|member|shm_perm
r_struct
id|solaris_ipc_perm
id|shm_perm
suffix:semicolon
DECL|member|shm_segsz
r_int
id|shm_segsz
suffix:semicolon
DECL|member|shm_amp
id|u32
id|shm_amp
suffix:semicolon
DECL|member|shm_lkcnt
r_int
r_int
id|shm_lkcnt
suffix:semicolon
DECL|member|__padxx
r_char
id|__padxx
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|shm_lpid
id|s32
id|shm_lpid
suffix:semicolon
DECL|member|shm_cpid
id|s32
id|shm_cpid
suffix:semicolon
DECL|member|shm_nattch
id|u32
id|shm_nattch
suffix:semicolon
DECL|member|shm_cnattch
id|u32
id|shm_cnattch
suffix:semicolon
DECL|member|shm_atime
id|s32
id|shm_atime
suffix:semicolon
DECL|member|shm_pad1
id|s32
id|shm_pad1
suffix:semicolon
DECL|member|shm_dtime
id|s32
id|shm_dtime
suffix:semicolon
DECL|member|shm_pad2
id|s32
id|shm_pad2
suffix:semicolon
DECL|member|shm_ctime
id|s32
id|shm_ctime
suffix:semicolon
DECL|member|shm_pad3
id|s32
id|shm_pad3
suffix:semicolon
DECL|member|shm_cv
r_int
r_int
id|shm_cv
suffix:semicolon
DECL|member|shm_pad4
r_char
id|shm_pad4
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|shm_sptas
id|u32
id|shm_sptas
suffix:semicolon
DECL|member|shm_pad5
id|s32
id|shm_pad5
(braket
l_int|2
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|function|solaris_shmsys
id|asmlinkage
r_int
id|solaris_shmsys
c_func
(paren
r_int
id|cmd
comma
id|u32
id|arg1
comma
id|u32
id|arg2
comma
id|u32
id|arg3
)paren
(brace
r_int
(paren
op_star
id|sys_ipc
)paren
(paren
r_int
comma
r_int
comma
r_int
comma
r_int
r_int
comma
r_void
op_star
comma
r_int
)paren
op_assign
(paren
r_int
(paren
op_star
)paren
(paren
r_int
comma
r_int
comma
r_int
comma
r_int
r_int
comma
r_void
op_star
comma
r_int
)paren
)paren
id|SYS
c_func
(paren
id|ipc
)paren
suffix:semicolon
id|mm_segment_t
id|old_fs
suffix:semicolon
r_int
r_int
id|raddr
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* shmat */
id|old_fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|KERNEL_DS
)paren
suffix:semicolon
id|ret
op_assign
id|sys_ipc
c_func
(paren
id|SHMAT
comma
id|arg1
comma
id|arg3
op_amp
op_complement
l_int|0x4000
comma
(paren
r_int
r_int
)paren
op_amp
id|raddr
comma
(paren
r_void
op_star
)paren
id|A
c_func
(paren
id|arg2
)paren
comma
l_int|0
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|old_fs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ge
l_int|0
)paren
r_return
(paren
id|u32
)paren
id|raddr
suffix:semicolon
r_else
r_return
id|ret
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* shmctl */
r_switch
c_cond
(paren
id|arg2
)paren
(brace
r_case
l_int|3
suffix:colon
multiline_comment|/* SHM_LOCK */
r_case
l_int|4
suffix:colon
multiline_comment|/* SHM_UNLOCK */
r_return
id|sys_ipc
c_func
(paren
id|SHMCTL
comma
id|arg1
comma
(paren
id|arg2
op_eq
l_int|3
)paren
ques
c_cond
id|SHM_LOCK
suffix:colon
id|SHM_UNLOCK
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_case
l_int|10
suffix:colon
multiline_comment|/* IPC_RMID */
r_return
id|sys_ipc
c_func
(paren
id|SHMCTL
comma
id|arg1
comma
id|IPC_RMID
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_case
l_int|11
suffix:colon
multiline_comment|/* IPC_SET */
(brace
r_struct
id|shmid_ds
id|s
suffix:semicolon
r_if
c_cond
(paren
id|get_user
(paren
id|s.shm_perm.uid
comma
op_amp
(paren
(paren
(paren
r_struct
id|solaris_shmid_ds
op_star
)paren
id|A
c_func
(paren
id|arg3
)paren
)paren
op_member_access_from_pointer
id|shm_perm.uid
)paren
)paren
op_logical_or
id|__get_user
(paren
id|s.shm_perm.gid
comma
op_amp
(paren
(paren
(paren
r_struct
id|solaris_shmid_ds
op_star
)paren
id|A
c_func
(paren
id|arg3
)paren
)paren
op_member_access_from_pointer
id|shm_perm.gid
)paren
)paren
op_logical_or
id|__get_user
(paren
id|s.shm_perm.mode
comma
op_amp
(paren
(paren
(paren
r_struct
id|solaris_shmid_ds
op_star
)paren
id|A
c_func
(paren
id|arg3
)paren
)paren
op_member_access_from_pointer
id|shm_perm.mode
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|old_fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|KERNEL_DS
)paren
suffix:semicolon
id|ret
op_assign
id|sys_ipc
c_func
(paren
id|SHMCTL
comma
id|arg1
comma
id|IPC_SET
comma
l_int|0
comma
op_amp
id|s
comma
l_int|0
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|old_fs
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_case
l_int|12
suffix:colon
multiline_comment|/* IPC_STAT */
(brace
r_struct
id|shmid_ds
id|s
suffix:semicolon
id|old_fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|KERNEL_DS
)paren
suffix:semicolon
id|ret
op_assign
id|sys_ipc
c_func
(paren
id|SHMCTL
comma
id|arg1
comma
id|IPC_SET
comma
l_int|0
comma
op_amp
id|s
comma
l_int|0
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|old_fs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|get_user
(paren
id|s.shm_perm.uid
comma
op_amp
(paren
(paren
(paren
r_struct
id|solaris_shmid_ds
op_star
)paren
id|A
c_func
(paren
id|arg3
)paren
)paren
op_member_access_from_pointer
id|shm_perm.uid
)paren
)paren
op_logical_or
id|__get_user
(paren
id|s.shm_perm.gid
comma
op_amp
(paren
(paren
(paren
r_struct
id|solaris_shmid_ds
op_star
)paren
id|A
c_func
(paren
id|arg3
)paren
)paren
op_member_access_from_pointer
id|shm_perm.gid
)paren
)paren
op_logical_or
id|__get_user
(paren
id|s.shm_perm.cuid
comma
op_amp
(paren
(paren
(paren
r_struct
id|solaris_shmid_ds
op_star
)paren
id|A
c_func
(paren
id|arg3
)paren
)paren
op_member_access_from_pointer
id|shm_perm.cuid
)paren
)paren
op_logical_or
id|__get_user
(paren
id|s.shm_perm.cgid
comma
op_amp
(paren
(paren
(paren
r_struct
id|solaris_shmid_ds
op_star
)paren
id|A
c_func
(paren
id|arg3
)paren
)paren
op_member_access_from_pointer
id|shm_perm.cgid
)paren
)paren
op_logical_or
id|__get_user
(paren
id|s.shm_perm.mode
comma
op_amp
(paren
(paren
(paren
r_struct
id|solaris_shmid_ds
op_star
)paren
id|A
c_func
(paren
id|arg3
)paren
)paren
op_member_access_from_pointer
id|shm_perm.mode
)paren
)paren
op_logical_or
id|__get_user
(paren
id|s.shm_perm.seq
comma
op_amp
(paren
(paren
(paren
r_struct
id|solaris_shmid_ds
op_star
)paren
id|A
c_func
(paren
id|arg3
)paren
)paren
op_member_access_from_pointer
id|shm_perm.seq
)paren
)paren
op_logical_or
id|__get_user
(paren
id|s.shm_perm.key
comma
op_amp
(paren
(paren
(paren
r_struct
id|solaris_shmid_ds
op_star
)paren
id|A
c_func
(paren
id|arg3
)paren
)paren
op_member_access_from_pointer
id|shm_perm.key
)paren
)paren
op_logical_or
id|__get_user
(paren
id|s.shm_segsz
comma
op_amp
(paren
(paren
(paren
r_struct
id|solaris_shmid_ds
op_star
)paren
id|A
c_func
(paren
id|arg3
)paren
)paren
op_member_access_from_pointer
id|shm_segsz
)paren
)paren
op_logical_or
id|__get_user
(paren
id|s.shm_lpid
comma
op_amp
(paren
(paren
(paren
r_struct
id|solaris_shmid_ds
op_star
)paren
id|A
c_func
(paren
id|arg3
)paren
)paren
op_member_access_from_pointer
id|shm_lpid
)paren
)paren
op_logical_or
id|__get_user
(paren
id|s.shm_cpid
comma
op_amp
(paren
(paren
(paren
r_struct
id|solaris_shmid_ds
op_star
)paren
id|A
c_func
(paren
id|arg3
)paren
)paren
op_member_access_from_pointer
id|shm_cpid
)paren
)paren
op_logical_or
id|__get_user
(paren
id|s.shm_nattch
comma
op_amp
(paren
(paren
(paren
r_struct
id|solaris_shmid_ds
op_star
)paren
id|A
c_func
(paren
id|arg3
)paren
)paren
op_member_access_from_pointer
id|shm_nattch
)paren
)paren
op_logical_or
id|__get_user
(paren
id|s.shm_atime
comma
op_amp
(paren
(paren
(paren
r_struct
id|solaris_shmid_ds
op_star
)paren
id|A
c_func
(paren
id|arg3
)paren
)paren
op_member_access_from_pointer
id|shm_atime
)paren
)paren
op_logical_or
id|__get_user
(paren
id|s.shm_dtime
comma
op_amp
(paren
(paren
(paren
r_struct
id|solaris_shmid_ds
op_star
)paren
id|A
c_func
(paren
id|arg3
)paren
)paren
op_member_access_from_pointer
id|shm_dtime
)paren
)paren
op_logical_or
id|__get_user
(paren
id|s.shm_ctime
comma
op_amp
(paren
(paren
(paren
r_struct
id|solaris_shmid_ds
op_star
)paren
id|A
c_func
(paren
id|arg3
)paren
)paren
op_member_access_from_pointer
id|shm_ctime
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_case
l_int|2
suffix:colon
multiline_comment|/* shmdt */
r_return
id|sys_ipc
c_func
(paren
id|SHMDT
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
(paren
r_void
op_star
)paren
id|A
c_func
(paren
id|arg1
)paren
comma
l_int|0
)paren
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* shmget */
r_return
id|sys_ipc
c_func
(paren
id|SHMGET
comma
id|arg1
comma
id|arg2
comma
id|arg3
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
eof
