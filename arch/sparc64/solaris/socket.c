multiline_comment|/* $Id: socket.c,v 1.4 2000/11/18 02:11:00 davem Exp $&n; * socket.c: Socket syscall emulation for Solaris 2.6+&n; *&n; * Copyright (C) 1998 Jakub Jelinek (jj@ultra.linux.cz)&n; *&n; * 1999-08-19 Fixed socketpair code &n; *            Jason Rappleye (rappleye@ccr.buffalo.edu)&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/file.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/string.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/idprom.h&gt;
macro_line|#include &quot;conv.h&quot;
DECL|macro|SOCK_SOL_STREAM
mdefine_line|#define SOCK_SOL_STREAM&t;&t;2
DECL|macro|SOCK_SOL_DGRAM
mdefine_line|#define SOCK_SOL_DGRAM&t;&t;1
DECL|macro|SOCK_SOL_RAW
mdefine_line|#define SOCK_SOL_RAW&t;&t;4
DECL|macro|SOCK_SOL_RDM
mdefine_line|#define SOCK_SOL_RDM&t;&t;5
DECL|macro|SOCK_SOL_SEQPACKET
mdefine_line|#define SOCK_SOL_SEQPACKET&t;6
DECL|macro|SOL_SO_SNDLOWAT
mdefine_line|#define SOL_SO_SNDLOWAT&t;&t;0x1003
DECL|macro|SOL_SO_RCVLOWAT
mdefine_line|#define SOL_SO_RCVLOWAT&t;&t;0x1004
DECL|macro|SOL_SO_SNDTIMEO
mdefine_line|#define SOL_SO_SNDTIMEO&t;&t;0x1005
DECL|macro|SOL_SO_RCVTIMEO
mdefine_line|#define SOL_SO_RCVTIMEO&t;&t;0x1006
DECL|macro|SOL_SO_STATE
mdefine_line|#define SOL_SO_STATE&t;&t;0x2000
DECL|macro|SOL_SS_NDELAY
mdefine_line|#define SOL_SS_NDELAY&t;&t;0x040
DECL|macro|SOL_SS_NONBLOCK
mdefine_line|#define SOL_SS_NONBLOCK&t;&t;0x080
DECL|macro|SOL_SS_ASYNC
mdefine_line|#define SOL_SS_ASYNC&t;&t;0x100
DECL|macro|SO_STATE
mdefine_line|#define SO_STATE&t;&t;0x000e
DECL|function|socket_check
r_static
r_int
id|socket_check
c_func
(paren
r_int
id|family
comma
r_int
id|type
)paren
(brace
r_if
c_cond
(paren
id|family
op_ne
id|PF_UNIX
op_logical_and
id|family
op_ne
id|PF_INET
)paren
r_return
op_minus
id|ESOCKTNOSUPPORT
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|SOCK_SOL_STREAM
suffix:colon
id|type
op_assign
id|SOCK_STREAM
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOCK_SOL_DGRAM
suffix:colon
id|type
op_assign
id|SOCK_DGRAM
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOCK_SOL_RAW
suffix:colon
id|type
op_assign
id|SOCK_RAW
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOCK_SOL_RDM
suffix:colon
id|type
op_assign
id|SOCK_RDM
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOCK_SOL_SEQPACKET
suffix:colon
id|type
op_assign
id|SOCK_SEQPACKET
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|type
suffix:semicolon
)brace
DECL|function|solaris_to_linux_sockopt
r_static
r_int
id|solaris_to_linux_sockopt
c_func
(paren
r_int
id|optname
)paren
(brace
r_switch
c_cond
(paren
id|optname
)paren
(brace
r_case
id|SOL_SO_SNDLOWAT
suffix:colon
id|optname
op_assign
id|SO_SNDLOWAT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOL_SO_RCVLOWAT
suffix:colon
id|optname
op_assign
id|SO_RCVLOWAT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOL_SO_SNDTIMEO
suffix:colon
id|optname
op_assign
id|SO_SNDTIMEO
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOL_SO_RCVTIMEO
suffix:colon
id|optname
op_assign
id|SO_RCVTIMEO
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOL_SO_STATE
suffix:colon
id|optname
op_assign
id|SO_STATE
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
r_return
id|optname
suffix:semicolon
)brace
DECL|function|solaris_socket
id|asmlinkage
r_int
id|solaris_socket
c_func
(paren
r_int
id|family
comma
r_int
id|type
comma
r_int
id|protocol
)paren
(brace
r_int
(paren
op_star
id|sys_socket
)paren
(paren
r_int
comma
r_int
comma
r_int
)paren
op_assign
(paren
r_int
(paren
op_star
)paren
(paren
r_int
comma
r_int
comma
r_int
)paren
)paren
id|SYS
c_func
(paren
id|socket
)paren
suffix:semicolon
id|type
op_assign
id|socket_check
(paren
id|family
comma
id|type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|type
OL
l_int|0
)paren
r_return
id|type
suffix:semicolon
r_return
id|sys_socket
c_func
(paren
id|family
comma
id|type
comma
id|protocol
)paren
suffix:semicolon
)brace
DECL|function|solaris_socketpair
id|asmlinkage
r_int
id|solaris_socketpair
c_func
(paren
r_int
op_star
id|usockvec
)paren
(brace
r_int
(paren
op_star
id|sys_socketpair
)paren
(paren
r_int
comma
r_int
comma
r_int
comma
r_int
op_star
)paren
op_assign
(paren
r_int
(paren
op_star
)paren
(paren
r_int
comma
r_int
comma
r_int
comma
r_int
op_star
)paren
)paren
id|SYS
c_func
(paren
id|socketpair
)paren
suffix:semicolon
multiline_comment|/* solaris socketpair really only takes one arg at the syscall&n;&t; * level, int * usockvec. The libs apparently take care of &n;&t; * making sure that family==AF_UNIX and type==SOCK_STREAM. The &n;&t; * pointer we really want ends up residing in the first (and&n;&t; * supposedly only) argument.&n;&t; */
r_return
id|sys_socketpair
c_func
(paren
id|AF_UNIX
comma
id|SOCK_STREAM
comma
l_int|0
comma
(paren
r_int
op_star
)paren
id|usockvec
)paren
suffix:semicolon
)brace
DECL|function|solaris_bind
id|asmlinkage
r_int
id|solaris_bind
c_func
(paren
r_int
id|fd
comma
r_struct
id|sockaddr
op_star
id|addr
comma
r_int
id|addrlen
)paren
(brace
r_int
(paren
op_star
id|sys_bind
)paren
(paren
r_int
comma
r_struct
id|sockaddr
op_star
comma
r_int
)paren
op_assign
(paren
r_int
(paren
op_star
)paren
(paren
r_int
comma
r_struct
id|sockaddr
op_star
comma
r_int
)paren
)paren
id|SUNOS
c_func
(paren
l_int|104
)paren
suffix:semicolon
r_return
id|sys_bind
c_func
(paren
id|fd
comma
id|addr
comma
id|addrlen
)paren
suffix:semicolon
)brace
DECL|function|solaris_setsockopt
id|asmlinkage
r_int
id|solaris_setsockopt
c_func
(paren
r_int
id|fd
comma
r_int
id|level
comma
r_int
id|optname
comma
id|u32
id|optval
comma
r_int
id|optlen
)paren
(brace
r_int
(paren
op_star
id|sunos_setsockopt
)paren
(paren
r_int
comma
r_int
comma
r_int
comma
id|u32
comma
r_int
)paren
op_assign
(paren
r_int
(paren
op_star
)paren
(paren
r_int
comma
r_int
comma
r_int
comma
id|u32
comma
r_int
)paren
)paren
id|SUNOS
c_func
(paren
l_int|105
)paren
suffix:semicolon
id|optname
op_assign
id|solaris_to_linux_sockopt
c_func
(paren
id|optname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|optname
OL
l_int|0
)paren
r_return
id|optname
suffix:semicolon
r_if
c_cond
(paren
id|optname
op_eq
id|SO_STATE
)paren
r_return
l_int|0
suffix:semicolon
r_return
id|sunos_setsockopt
c_func
(paren
id|fd
comma
id|level
comma
id|optname
comma
id|optval
comma
id|optlen
)paren
suffix:semicolon
)brace
DECL|function|solaris_getsockopt
id|asmlinkage
r_int
id|solaris_getsockopt
c_func
(paren
r_int
id|fd
comma
r_int
id|level
comma
r_int
id|optname
comma
id|u32
id|optval
comma
id|u32
id|optlen
)paren
(brace
r_int
(paren
op_star
id|sunos_getsockopt
)paren
(paren
r_int
comma
r_int
comma
r_int
comma
id|u32
comma
id|u32
)paren
op_assign
(paren
r_int
(paren
op_star
)paren
(paren
r_int
comma
r_int
comma
r_int
comma
id|u32
comma
id|u32
)paren
)paren
id|SUNOS
c_func
(paren
l_int|118
)paren
suffix:semicolon
id|optname
op_assign
id|solaris_to_linux_sockopt
c_func
(paren
id|optname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|optname
OL
l_int|0
)paren
r_return
id|optname
suffix:semicolon
r_if
c_cond
(paren
id|optname
op_eq
id|SO_STATE
)paren
id|optname
op_assign
id|SOL_SO_STATE
suffix:semicolon
r_return
id|sunos_getsockopt
c_func
(paren
id|fd
comma
id|level
comma
id|optname
comma
id|optval
comma
id|optlen
)paren
suffix:semicolon
)brace
DECL|function|solaris_connect
id|asmlinkage
r_int
id|solaris_connect
c_func
(paren
r_int
id|fd
comma
r_struct
id|sockaddr
op_star
id|addr
comma
r_int
id|addrlen
)paren
(brace
r_int
(paren
op_star
id|sys_connect
)paren
(paren
r_int
comma
r_struct
id|sockaddr
op_star
comma
r_int
)paren
op_assign
(paren
r_int
(paren
op_star
)paren
(paren
r_int
comma
r_struct
id|sockaddr
op_star
comma
r_int
)paren
)paren
id|SYS
c_func
(paren
id|connect
)paren
suffix:semicolon
r_return
id|sys_connect
c_func
(paren
id|fd
comma
id|addr
comma
id|addrlen
)paren
suffix:semicolon
)brace
DECL|function|solaris_accept
id|asmlinkage
r_int
id|solaris_accept
c_func
(paren
r_int
id|fd
comma
r_struct
id|sockaddr
op_star
id|addr
comma
r_int
op_star
id|addrlen
)paren
(brace
r_int
(paren
op_star
id|sys_accept
)paren
(paren
r_int
comma
r_struct
id|sockaddr
op_star
comma
r_int
op_star
)paren
op_assign
(paren
r_int
(paren
op_star
)paren
(paren
r_int
comma
r_struct
id|sockaddr
op_star
comma
r_int
op_star
)paren
)paren
id|SYS
c_func
(paren
id|accept
)paren
suffix:semicolon
r_return
id|sys_accept
c_func
(paren
id|fd
comma
id|addr
comma
id|addrlen
)paren
suffix:semicolon
)brace
DECL|function|solaris_listen
id|asmlinkage
r_int
id|solaris_listen
c_func
(paren
r_int
id|fd
comma
r_int
id|backlog
)paren
(brace
r_int
(paren
op_star
id|sys_listen
)paren
(paren
r_int
comma
r_int
)paren
op_assign
(paren
r_int
(paren
op_star
)paren
(paren
r_int
comma
r_int
)paren
)paren
id|SUNOS
c_func
(paren
l_int|106
)paren
suffix:semicolon
r_return
id|sys_listen
c_func
(paren
id|fd
comma
id|backlog
)paren
suffix:semicolon
)brace
DECL|function|solaris_shutdown
id|asmlinkage
r_int
id|solaris_shutdown
c_func
(paren
r_int
id|fd
comma
r_int
id|how
)paren
(brace
r_int
(paren
op_star
id|sys_shutdown
)paren
(paren
r_int
comma
r_int
)paren
op_assign
(paren
r_int
(paren
op_star
)paren
(paren
r_int
comma
r_int
)paren
)paren
id|SYS
c_func
(paren
id|shutdown
)paren
suffix:semicolon
r_return
id|sys_shutdown
c_func
(paren
id|fd
comma
id|how
)paren
suffix:semicolon
)brace
DECL|macro|MSG_SOL_OOB
mdefine_line|#define MSG_SOL_OOB&t;&t;0x1
DECL|macro|MSG_SOL_PEEK
mdefine_line|#define MSG_SOL_PEEK&t;&t;0x2
DECL|macro|MSG_SOL_DONTROUTE
mdefine_line|#define MSG_SOL_DONTROUTE&t;0x4
DECL|macro|MSG_SOL_EOR
mdefine_line|#define MSG_SOL_EOR&t;&t;0x8
DECL|macro|MSG_SOL_CTRUNC
mdefine_line|#define MSG_SOL_CTRUNC&t;&t;0x10
DECL|macro|MSG_SOL_TRUNC
mdefine_line|#define MSG_SOL_TRUNC&t;&t;0x20
DECL|macro|MSG_SOL_WAITALL
mdefine_line|#define MSG_SOL_WAITALL&t;&t;0x40
DECL|macro|MSG_SOL_DONTWAIT
mdefine_line|#define MSG_SOL_DONTWAIT&t;0x80
DECL|function|solaris_to_linux_msgflags
r_static
r_int
id|solaris_to_linux_msgflags
c_func
(paren
r_int
id|flags
)paren
(brace
r_int
id|fl
op_assign
id|flags
op_amp
(paren
id|MSG_OOB
op_or
id|MSG_PEEK
op_or
id|MSG_DONTROUTE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|MSG_SOL_EOR
)paren
id|fl
op_or_assign
id|MSG_EOR
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|MSG_SOL_CTRUNC
)paren
id|fl
op_or_assign
id|MSG_CTRUNC
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|MSG_SOL_TRUNC
)paren
id|fl
op_or_assign
id|MSG_TRUNC
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|MSG_SOL_WAITALL
)paren
id|fl
op_or_assign
id|MSG_WAITALL
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|MSG_SOL_DONTWAIT
)paren
id|fl
op_or_assign
id|MSG_DONTWAIT
suffix:semicolon
r_return
id|fl
suffix:semicolon
)brace
DECL|function|linux_to_solaris_msgflags
r_static
r_int
id|linux_to_solaris_msgflags
c_func
(paren
r_int
id|flags
)paren
(brace
r_int
id|fl
op_assign
id|flags
op_amp
(paren
id|MSG_OOB
op_or
id|MSG_PEEK
op_or
id|MSG_DONTROUTE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|MSG_EOR
)paren
id|fl
op_or_assign
id|MSG_SOL_EOR
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|MSG_CTRUNC
)paren
id|fl
op_or_assign
id|MSG_SOL_CTRUNC
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|MSG_TRUNC
)paren
id|fl
op_or_assign
id|MSG_SOL_TRUNC
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|MSG_WAITALL
)paren
id|fl
op_or_assign
id|MSG_SOL_WAITALL
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|MSG_DONTWAIT
)paren
id|fl
op_or_assign
id|MSG_SOL_DONTWAIT
suffix:semicolon
r_return
id|fl
suffix:semicolon
)brace
DECL|function|solaris_recvfrom
id|asmlinkage
r_int
id|solaris_recvfrom
c_func
(paren
r_int
id|s
comma
r_char
op_star
id|buf
comma
r_int
id|len
comma
r_int
id|flags
comma
id|u32
id|from
comma
id|u32
id|fromlen
)paren
(brace
r_int
(paren
op_star
id|sys_recvfrom
)paren
(paren
r_int
comma
r_void
op_star
comma
r_int
comma
r_int
comma
r_struct
id|sockaddr
op_star
comma
r_int
op_star
)paren
op_assign
(paren
r_int
(paren
op_star
)paren
(paren
r_int
comma
r_void
op_star
comma
r_int
comma
r_int
comma
r_struct
id|sockaddr
op_star
comma
r_int
op_star
)paren
)paren
id|SYS
c_func
(paren
id|recvfrom
)paren
suffix:semicolon
r_return
id|sys_recvfrom
c_func
(paren
id|s
comma
id|buf
comma
id|len
comma
id|solaris_to_linux_msgflags
c_func
(paren
id|flags
)paren
comma
(paren
r_struct
id|sockaddr
op_star
)paren
id|A
c_func
(paren
id|from
)paren
comma
(paren
r_int
op_star
)paren
id|A
c_func
(paren
id|fromlen
)paren
)paren
suffix:semicolon
)brace
DECL|function|solaris_recv
id|asmlinkage
r_int
id|solaris_recv
c_func
(paren
r_int
id|s
comma
r_char
op_star
id|buf
comma
r_int
id|len
comma
r_int
id|flags
)paren
(brace
r_int
(paren
op_star
id|sys_recvfrom
)paren
(paren
r_int
comma
r_void
op_star
comma
r_int
comma
r_int
comma
r_struct
id|sockaddr
op_star
comma
r_int
op_star
)paren
op_assign
(paren
r_int
(paren
op_star
)paren
(paren
r_int
comma
r_void
op_star
comma
r_int
comma
r_int
comma
r_struct
id|sockaddr
op_star
comma
r_int
op_star
)paren
)paren
id|SYS
c_func
(paren
id|recvfrom
)paren
suffix:semicolon
r_return
id|sys_recvfrom
c_func
(paren
id|s
comma
id|buf
comma
id|len
comma
id|solaris_to_linux_msgflags
c_func
(paren
id|flags
)paren
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|solaris_sendto
id|asmlinkage
r_int
id|solaris_sendto
c_func
(paren
r_int
id|s
comma
r_char
op_star
id|buf
comma
r_int
id|len
comma
r_int
id|flags
comma
id|u32
id|to
comma
id|u32
id|tolen
)paren
(brace
r_int
(paren
op_star
id|sys_sendto
)paren
(paren
r_int
comma
r_void
op_star
comma
r_int
comma
r_int
comma
r_struct
id|sockaddr
op_star
comma
r_int
op_star
)paren
op_assign
(paren
r_int
(paren
op_star
)paren
(paren
r_int
comma
r_void
op_star
comma
r_int
comma
r_int
comma
r_struct
id|sockaddr
op_star
comma
r_int
op_star
)paren
)paren
id|SYS
c_func
(paren
id|sendto
)paren
suffix:semicolon
r_return
id|sys_sendto
c_func
(paren
id|s
comma
id|buf
comma
id|len
comma
id|solaris_to_linux_msgflags
c_func
(paren
id|flags
)paren
comma
(paren
r_struct
id|sockaddr
op_star
)paren
id|A
c_func
(paren
id|to
)paren
comma
(paren
r_int
op_star
)paren
id|A
c_func
(paren
id|tolen
)paren
)paren
suffix:semicolon
)brace
DECL|function|solaris_send
id|asmlinkage
r_int
id|solaris_send
c_func
(paren
r_int
id|s
comma
r_char
op_star
id|buf
comma
r_int
id|len
comma
r_int
id|flags
)paren
(brace
r_int
(paren
op_star
id|sys_sendto
)paren
(paren
r_int
comma
r_void
op_star
comma
r_int
comma
r_int
comma
r_struct
id|sockaddr
op_star
comma
r_int
op_star
)paren
op_assign
(paren
r_int
(paren
op_star
)paren
(paren
r_int
comma
r_void
op_star
comma
r_int
comma
r_int
comma
r_struct
id|sockaddr
op_star
comma
r_int
op_star
)paren
)paren
id|SYS
c_func
(paren
id|sendto
)paren
suffix:semicolon
r_return
id|sys_sendto
c_func
(paren
id|s
comma
id|buf
comma
id|len
comma
id|solaris_to_linux_msgflags
c_func
(paren
id|flags
)paren
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|solaris_getpeername
id|asmlinkage
r_int
id|solaris_getpeername
c_func
(paren
r_int
id|fd
comma
r_struct
id|sockaddr
op_star
id|addr
comma
r_int
op_star
id|addrlen
)paren
(brace
r_int
(paren
op_star
id|sys_getpeername
)paren
(paren
r_int
comma
r_struct
id|sockaddr
op_star
comma
r_int
op_star
)paren
op_assign
(paren
r_int
(paren
op_star
)paren
(paren
r_int
comma
r_struct
id|sockaddr
op_star
comma
r_int
op_star
)paren
)paren
id|SYS
c_func
(paren
id|getpeername
)paren
suffix:semicolon
r_return
id|sys_getpeername
c_func
(paren
id|fd
comma
id|addr
comma
id|addrlen
)paren
suffix:semicolon
)brace
DECL|function|solaris_getsockname
id|asmlinkage
r_int
id|solaris_getsockname
c_func
(paren
r_int
id|fd
comma
r_struct
id|sockaddr
op_star
id|addr
comma
r_int
op_star
id|addrlen
)paren
(brace
r_int
(paren
op_star
id|sys_getsockname
)paren
(paren
r_int
comma
r_struct
id|sockaddr
op_star
comma
r_int
op_star
)paren
op_assign
(paren
r_int
(paren
op_star
)paren
(paren
r_int
comma
r_struct
id|sockaddr
op_star
comma
r_int
op_star
)paren
)paren
id|SYS
c_func
(paren
id|getsockname
)paren
suffix:semicolon
r_return
id|sys_getsockname
c_func
(paren
id|fd
comma
id|addr
comma
id|addrlen
)paren
suffix:semicolon
)brace
multiline_comment|/* XXX This really belongs in some header file... -DaveM */
DECL|macro|MAX_SOCK_ADDR
mdefine_line|#define MAX_SOCK_ADDR&t;128&t;&t;/* 108 for Unix domain - &n;&t;&t;&t;&t;&t;   16 for IP, 16 for IPX,&n;&t;&t;&t;&t;&t;   24 for IPv6,&n;&t;&t;&t;&t;&t;   about 80 for AX.25 */
multiline_comment|/* XXX These as well... */
DECL|function|socki_lookup
r_extern
id|__inline__
r_struct
id|socket
op_star
id|socki_lookup
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
r_return
op_amp
id|inode-&gt;u.socket_i
suffix:semicolon
)brace
DECL|function|sockfd_lookup
r_extern
id|__inline__
r_struct
id|socket
op_star
id|sockfd_lookup
c_func
(paren
r_int
id|fd
comma
r_int
op_star
id|err
)paren
(brace
r_struct
id|file
op_star
id|file
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file
op_assign
id|fget
c_func
(paren
id|fd
)paren
)paren
)paren
(brace
op_star
id|err
op_assign
op_minus
id|EBADF
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|inode
op_assign
id|file-&gt;f_dentry-&gt;d_inode
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode-&gt;i_sock
op_logical_or
op_logical_neg
id|socki_lookup
c_func
(paren
id|inode
)paren
)paren
(brace
op_star
id|err
op_assign
op_minus
id|ENOTSOCK
suffix:semicolon
id|fput
c_func
(paren
id|file
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
id|socki_lookup
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
DECL|function|sockfd_put
r_extern
id|__inline__
r_void
id|sockfd_put
c_func
(paren
r_struct
id|socket
op_star
id|sock
)paren
(brace
id|fput
c_func
(paren
id|sock-&gt;file
)paren
suffix:semicolon
)brace
DECL|struct|sol_nmsghdr
r_struct
id|sol_nmsghdr
(brace
DECL|member|msg_name
id|u32
id|msg_name
suffix:semicolon
DECL|member|msg_namelen
r_int
id|msg_namelen
suffix:semicolon
DECL|member|msg_iov
id|u32
id|msg_iov
suffix:semicolon
DECL|member|msg_iovlen
id|u32
id|msg_iovlen
suffix:semicolon
DECL|member|msg_control
id|u32
id|msg_control
suffix:semicolon
DECL|member|msg_controllen
id|u32
id|msg_controllen
suffix:semicolon
DECL|member|msg_flags
id|u32
id|msg_flags
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|sol_cmsghdr
r_struct
id|sol_cmsghdr
(brace
DECL|member|cmsg_len
id|u32
id|cmsg_len
suffix:semicolon
DECL|member|cmsg_level
r_int
id|cmsg_level
suffix:semicolon
DECL|member|cmsg_type
r_int
id|cmsg_type
suffix:semicolon
DECL|member|cmsg_data
r_int
r_char
id|cmsg_data
(braket
l_int|0
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|iovec32
r_struct
id|iovec32
(brace
DECL|member|iov_base
id|u32
id|iov_base
suffix:semicolon
DECL|member|iov_len
id|u32
id|iov_len
suffix:semicolon
)brace
suffix:semicolon
DECL|function|iov_from_user32_to_kern
r_static
r_inline
r_int
id|iov_from_user32_to_kern
c_func
(paren
r_struct
id|iovec
op_star
id|kiov
comma
r_struct
id|iovec32
op_star
id|uiov32
comma
r_int
id|niov
)paren
(brace
r_int
id|tot_len
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|niov
OG
l_int|0
)paren
(brace
id|u32
id|len
comma
id|buf
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|len
comma
op_amp
id|uiov32-&gt;iov_len
)paren
op_logical_or
id|get_user
c_func
(paren
id|buf
comma
op_amp
id|uiov32-&gt;iov_base
)paren
)paren
(brace
id|tot_len
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|tot_len
op_add_assign
id|len
suffix:semicolon
id|kiov-&gt;iov_base
op_assign
(paren
r_void
op_star
)paren
id|A
c_func
(paren
id|buf
)paren
suffix:semicolon
id|kiov-&gt;iov_len
op_assign
(paren
id|__kernel_size_t
)paren
id|len
suffix:semicolon
id|uiov32
op_increment
suffix:semicolon
id|kiov
op_increment
suffix:semicolon
id|niov
op_decrement
suffix:semicolon
)brace
r_return
id|tot_len
suffix:semicolon
)brace
DECL|function|msghdr_from_user32_to_kern
r_static
r_inline
r_int
id|msghdr_from_user32_to_kern
c_func
(paren
r_struct
id|msghdr
op_star
id|kmsg
comma
r_struct
id|sol_nmsghdr
op_star
id|umsg
)paren
(brace
id|u32
id|tmp1
comma
id|tmp2
comma
id|tmp3
suffix:semicolon
r_int
id|err
suffix:semicolon
id|err
op_assign
id|get_user
c_func
(paren
id|tmp1
comma
op_amp
id|umsg-&gt;msg_name
)paren
suffix:semicolon
id|err
op_or_assign
id|__get_user
c_func
(paren
id|tmp2
comma
op_amp
id|umsg-&gt;msg_iov
)paren
suffix:semicolon
id|err
op_or_assign
id|__get_user
c_func
(paren
id|tmp3
comma
op_amp
id|umsg-&gt;msg_control
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|kmsg-&gt;msg_name
op_assign
(paren
r_void
op_star
)paren
id|A
c_func
(paren
id|tmp1
)paren
suffix:semicolon
id|kmsg-&gt;msg_iov
op_assign
(paren
r_struct
id|iovec
op_star
)paren
id|A
c_func
(paren
id|tmp2
)paren
suffix:semicolon
id|kmsg-&gt;msg_control
op_assign
(paren
r_void
op_star
)paren
id|A
c_func
(paren
id|tmp3
)paren
suffix:semicolon
id|err
op_assign
id|get_user
c_func
(paren
id|kmsg-&gt;msg_namelen
comma
op_amp
id|umsg-&gt;msg_namelen
)paren
suffix:semicolon
id|err
op_or_assign
id|get_user
c_func
(paren
id|kmsg-&gt;msg_controllen
comma
op_amp
id|umsg-&gt;msg_controllen
)paren
suffix:semicolon
id|err
op_or_assign
id|get_user
c_func
(paren
id|kmsg-&gt;msg_flags
comma
op_amp
id|umsg-&gt;msg_flags
)paren
suffix:semicolon
id|kmsg-&gt;msg_flags
op_assign
id|solaris_to_linux_msgflags
c_func
(paren
id|kmsg-&gt;msg_flags
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* I&squot;ve named the args so it is easy to tell whose space the pointers are in. */
DECL|function|verify_iovec32
r_static
r_int
id|verify_iovec32
c_func
(paren
r_struct
id|msghdr
op_star
id|kern_msg
comma
r_struct
id|iovec
op_star
id|kern_iov
comma
r_char
op_star
id|kern_address
comma
r_int
id|mode
)paren
(brace
r_int
id|tot_len
suffix:semicolon
r_if
c_cond
(paren
id|kern_msg-&gt;msg_namelen
)paren
(brace
r_if
c_cond
(paren
id|mode
op_eq
id|VERIFY_READ
)paren
(brace
r_int
id|err
op_assign
id|move_addr_to_kernel
c_func
(paren
id|kern_msg-&gt;msg_name
comma
id|kern_msg-&gt;msg_namelen
comma
id|kern_address
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
)brace
id|kern_msg-&gt;msg_name
op_assign
id|kern_address
suffix:semicolon
)brace
r_else
id|kern_msg-&gt;msg_name
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|kern_msg-&gt;msg_iovlen
OG
id|UIO_FASTIOV
)paren
(brace
id|kern_iov
op_assign
id|kmalloc
c_func
(paren
id|kern_msg-&gt;msg_iovlen
op_star
r_sizeof
(paren
r_struct
id|iovec
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|kern_iov
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
id|tot_len
op_assign
id|iov_from_user32_to_kern
c_func
(paren
id|kern_iov
comma
(paren
r_struct
id|iovec32
op_star
)paren
id|kern_msg-&gt;msg_iov
comma
id|kern_msg-&gt;msg_iovlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tot_len
op_ge
l_int|0
)paren
(brace
id|kern_msg-&gt;msg_iov
op_assign
id|kern_iov
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|kern_msg-&gt;msg_iovlen
OG
id|UIO_FASTIOV
)paren
(brace
id|kfree
c_func
(paren
id|kern_iov
)paren
suffix:semicolon
)brace
r_return
id|tot_len
suffix:semicolon
)brace
DECL|function|solaris_sendmsg
id|asmlinkage
r_int
id|solaris_sendmsg
c_func
(paren
r_int
id|fd
comma
r_struct
id|sol_nmsghdr
op_star
id|user_msg
comma
r_int
id|user_flags
)paren
(brace
r_struct
id|socket
op_star
id|sock
suffix:semicolon
r_char
id|address
(braket
id|MAX_SOCK_ADDR
)braket
suffix:semicolon
r_struct
id|iovec
id|iov
(braket
id|UIO_FASTIOV
)braket
suffix:semicolon
r_int
r_char
id|ctl
(braket
r_sizeof
(paren
r_struct
id|cmsghdr
)paren
op_plus
l_int|20
)braket
suffix:semicolon
r_int
r_char
op_star
id|ctl_buf
op_assign
id|ctl
suffix:semicolon
r_struct
id|msghdr
id|kern_msg
suffix:semicolon
r_int
id|err
comma
id|total_len
suffix:semicolon
r_if
c_cond
(paren
id|msghdr_from_user32_to_kern
c_func
(paren
op_amp
id|kern_msg
comma
id|user_msg
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|kern_msg.msg_iovlen
OG
id|UIO_MAXIOV
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|err
op_assign
id|verify_iovec32
c_func
(paren
op_amp
id|kern_msg
comma
id|iov
comma
id|address
comma
id|VERIFY_READ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|total_len
op_assign
id|err
suffix:semicolon
r_if
c_cond
(paren
id|kern_msg.msg_controllen
)paren
(brace
r_struct
id|sol_cmsghdr
op_star
id|ucmsg
op_assign
(paren
r_struct
id|sol_cmsghdr
op_star
)paren
id|kern_msg.msg_control
suffix:semicolon
r_int
r_int
op_star
id|kcmsg
suffix:semicolon
id|__kernel_size_t32
id|cmlen
suffix:semicolon
r_if
c_cond
(paren
id|kern_msg.msg_controllen
OG
r_sizeof
(paren
id|ctl
)paren
op_logical_and
id|kern_msg.msg_controllen
op_le
l_int|256
)paren
(brace
id|err
op_assign
op_minus
id|ENOBUFS
suffix:semicolon
id|ctl_buf
op_assign
id|kmalloc
c_func
(paren
id|kern_msg.msg_controllen
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ctl_buf
)paren
(brace
r_goto
id|out_freeiov
suffix:semicolon
)brace
)brace
id|__get_user
c_func
(paren
id|cmlen
comma
op_amp
id|ucmsg-&gt;cmsg_len
)paren
suffix:semicolon
id|kcmsg
op_assign
(paren
r_int
r_int
op_star
)paren
id|ctl_buf
suffix:semicolon
op_star
id|kcmsg
op_increment
op_assign
(paren
r_int
r_int
)paren
id|cmlen
suffix:semicolon
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|kcmsg
comma
op_amp
id|ucmsg-&gt;cmsg_level
comma
id|kern_msg.msg_controllen
op_minus
r_sizeof
(paren
id|__kernel_size_t32
)paren
)paren
)paren
(brace
r_goto
id|out_freectl
suffix:semicolon
)brace
id|kern_msg.msg_control
op_assign
id|ctl_buf
suffix:semicolon
)brace
id|kern_msg.msg_flags
op_assign
id|solaris_to_linux_msgflags
c_func
(paren
id|user_flags
)paren
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|sock
op_assign
id|sockfd_lookup
c_func
(paren
id|fd
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sock
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|sock-&gt;file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
id|kern_msg.msg_flags
op_or_assign
id|MSG_DONTWAIT
suffix:semicolon
id|err
op_assign
id|sock_sendmsg
c_func
(paren
id|sock
comma
op_amp
id|kern_msg
comma
id|total_len
)paren
suffix:semicolon
id|sockfd_put
c_func
(paren
id|sock
)paren
suffix:semicolon
)brace
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
id|out_freectl
suffix:colon
multiline_comment|/* N.B. Use kfree here, as kern_msg.msg_controllen might change? */
r_if
c_cond
(paren
id|ctl_buf
op_ne
id|ctl
)paren
(brace
id|kfree
c_func
(paren
id|ctl_buf
)paren
suffix:semicolon
)brace
id|out_freeiov
suffix:colon
r_if
c_cond
(paren
id|kern_msg.msg_iov
op_ne
id|iov
)paren
(brace
id|kfree
c_func
(paren
id|kern_msg.msg_iov
)paren
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
DECL|function|solaris_recvmsg
id|asmlinkage
r_int
id|solaris_recvmsg
c_func
(paren
r_int
id|fd
comma
r_struct
id|sol_nmsghdr
op_star
id|user_msg
comma
r_int
r_int
id|user_flags
)paren
(brace
r_struct
id|iovec
id|iovstack
(braket
id|UIO_FASTIOV
)braket
suffix:semicolon
r_struct
id|msghdr
id|kern_msg
suffix:semicolon
r_char
id|addr
(braket
id|MAX_SOCK_ADDR
)braket
suffix:semicolon
r_struct
id|socket
op_star
id|sock
suffix:semicolon
r_struct
id|iovec
op_star
id|iov
op_assign
id|iovstack
suffix:semicolon
r_struct
id|sockaddr
op_star
id|uaddr
suffix:semicolon
r_int
op_star
id|uaddr_len
suffix:semicolon
r_int
r_int
id|cmsg_ptr
suffix:semicolon
r_int
id|err
comma
id|total_len
comma
id|len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|msghdr_from_user32_to_kern
c_func
(paren
op_amp
id|kern_msg
comma
id|user_msg
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|kern_msg.msg_iovlen
OG
id|UIO_MAXIOV
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|uaddr
op_assign
id|kern_msg.msg_name
suffix:semicolon
id|uaddr_len
op_assign
op_amp
id|user_msg-&gt;msg_namelen
suffix:semicolon
id|err
op_assign
id|verify_iovec32
c_func
(paren
op_amp
id|kern_msg
comma
id|iov
comma
id|addr
comma
id|VERIFY_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|total_len
op_assign
id|err
suffix:semicolon
id|cmsg_ptr
op_assign
(paren
r_int
r_int
)paren
id|kern_msg.msg_control
suffix:semicolon
id|kern_msg.msg_flags
op_assign
l_int|0
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|sock
op_assign
id|sockfd_lookup
c_func
(paren
id|fd
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sock
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|sock-&gt;file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
id|user_flags
op_or_assign
id|MSG_DONTWAIT
suffix:semicolon
id|err
op_assign
id|sock_recvmsg
c_func
(paren
id|sock
comma
op_amp
id|kern_msg
comma
id|total_len
comma
id|user_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ge
l_int|0
)paren
(brace
id|len
op_assign
id|err
suffix:semicolon
)brace
id|sockfd_put
c_func
(paren
id|sock
)paren
suffix:semicolon
)brace
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uaddr
op_ne
l_int|NULL
op_logical_and
id|err
op_ge
l_int|0
)paren
(brace
id|err
op_assign
id|move_addr_to_user
c_func
(paren
id|addr
comma
id|kern_msg.msg_namelen
comma
id|uaddr
comma
id|uaddr_len
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|err
op_ge
l_int|0
)paren
(brace
id|err
op_assign
id|__put_user
c_func
(paren
id|linux_to_solaris_msgflags
c_func
(paren
id|kern_msg.msg_flags
)paren
comma
op_amp
id|user_msg-&gt;msg_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
multiline_comment|/* XXX Convert cmsg back into userspace 32-bit format... */
id|err
op_assign
id|__put_user
c_func
(paren
(paren
r_int
r_int
)paren
id|kern_msg.msg_control
op_minus
id|cmsg_ptr
comma
op_amp
id|user_msg-&gt;msg_controllen
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|kern_msg.msg_iov
op_ne
id|iov
)paren
(brace
id|kfree
c_func
(paren
id|kern_msg.msg_iov
)paren
suffix:semicolon
)brace
id|out
suffix:colon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
eof
