multiline_comment|/* $Id: timod.c,v 1.10 2000/07/28 12:15:02 davem Exp $&n; * timod.c: timod emulation.&n; *&n; * Copyright (C) 1998 Patrik Rak (prak3264@ss1000.ms.mff.cuni.cz)&n; *&n; * Streams &amp; timod emulation based on code&n; * Copyright (C) 1995, 1996 Mike Jagdis (jaggy@purplet.demon.co.uk)&n; *&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/ioctl.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/file.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/termios.h&gt;
macro_line|#include &quot;conv.h&quot;
macro_line|#include &quot;socksys.h&quot;
r_extern
id|asmlinkage
r_int
id|sys_ioctl
c_func
(paren
r_int
r_int
id|fd
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_extern
id|asmlinkage
r_int
id|sys32_ioctl
c_func
(paren
r_int
r_int
id|fd
comma
r_int
r_int
id|cmd
comma
id|u32
id|arg
)paren
suffix:semicolon
id|asmlinkage
r_int
id|solaris_ioctl
c_func
(paren
r_int
r_int
id|fd
comma
r_int
r_int
id|cmd
comma
id|u32
id|arg
)paren
suffix:semicolon
DECL|variable|timod_pagelock
id|spinlock_t
id|timod_pagelock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|page
r_static
r_char
op_star
id|page
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifndef DEBUG_SOLARIS_KMALLOC
DECL|macro|mykmalloc
mdefine_line|#define mykmalloc kmalloc
DECL|macro|mykfree
mdefine_line|#define mykfree kfree
macro_line|#else
DECL|function|mykmalloc
r_void
op_star
id|mykmalloc
c_func
(paren
r_int
id|s
comma
r_int
id|gfp
)paren
(brace
r_static
r_char
op_star
id|page
suffix:semicolon
r_static
r_int
id|free
op_assign
l_int|0
suffix:semicolon
r_void
op_star
id|r
suffix:semicolon
id|s
op_assign
(paren
(paren
id|s
op_plus
l_int|63
)paren
op_amp
op_complement
l_int|63
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
OG
id|PAGE_SIZE
)paren
(brace
id|SOLD
c_func
(paren
l_string|&quot;too big size, calling real kmalloc&quot;
)paren
suffix:semicolon
r_return
id|kmalloc
c_func
(paren
id|s
comma
id|gfp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
OG
id|free
)paren
(brace
multiline_comment|/* we are wasting memory, but we don&squot;t care */
id|page
op_assign
(paren
r_char
op_star
)paren
id|__get_free_page
c_func
(paren
id|gfp
)paren
suffix:semicolon
id|free
op_assign
id|PAGE_SIZE
suffix:semicolon
)brace
id|r
op_assign
id|page
suffix:semicolon
id|page
op_add_assign
id|s
suffix:semicolon
id|free
op_sub_assign
id|s
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
DECL|function|mykfree
r_void
id|mykfree
c_func
(paren
r_void
op_star
id|p
)paren
(brace
)brace
macro_line|#endif
macro_line|#ifndef DEBUG_SOLARIS
DECL|macro|BUF_SIZE
mdefine_line|#define BUF_SIZE&t;PAGE_SIZE
DECL|macro|PUT_MAGIC
mdefine_line|#define PUT_MAGIC(a,m)
DECL|macro|SCHECK_MAGIC
mdefine_line|#define SCHECK_MAGIC(a,m)
DECL|macro|BUF_OFFSET
mdefine_line|#define BUF_OFFSET&t;0
DECL|macro|MKCTL_TRAILER
mdefine_line|#define MKCTL_TRAILER&t;0
macro_line|#else
DECL|macro|BUF_SIZE
mdefine_line|#define BUF_SIZE&t;(PAGE_SIZE-2*sizeof(u64))
DECL|macro|BUFPAGE_MAGIC
mdefine_line|#define BUFPAGE_MAGIC&t;0xBADC0DEDDEADBABEL
DECL|macro|MKCTL_MAGIC
mdefine_line|#define MKCTL_MAGIC&t;0xDEADBABEBADC0DEDL
DECL|macro|PUT_MAGIC
mdefine_line|#define PUT_MAGIC(a,m)&t;do{(*(u64*)(a))=(m);}while(0)
DECL|macro|SCHECK_MAGIC
mdefine_line|#define SCHECK_MAGIC(a,m)&t;do{if((*(u64*)(a))!=(m))printk(&quot;%s,%u,%s(): magic %08x at %p corrupted!&bslash;n&quot;,&bslash;&n;&t;&t;&t;&t;__FILE__,__LINE__,__FUNCTION__,(m),(a));}while(0)
DECL|macro|BUF_OFFSET
mdefine_line|#define BUF_OFFSET&t;sizeof(u64)
DECL|macro|MKCTL_TRAILER
mdefine_line|#define MKCTL_TRAILER&t;sizeof(u64)
macro_line|#endif
DECL|function|getpage
r_static
r_char
op_star
id|getpage
c_func
(paren
r_void
)paren
(brace
r_char
op_star
id|r
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;getting page&quot;
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|timod_pagelock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|page
)paren
(brace
id|r
op_assign
id|page
suffix:semicolon
id|page
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|timod_pagelock
)paren
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;got cached&quot;
)paren
suffix:semicolon
r_return
id|r
op_plus
id|BUF_OFFSET
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|timod_pagelock
)paren
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;getting new&quot;
)paren
suffix:semicolon
id|r
op_assign
(paren
r_char
op_star
)paren
id|__get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
id|PUT_MAGIC
c_func
(paren
id|r
comma
id|BUFPAGE_MAGIC
)paren
suffix:semicolon
id|PUT_MAGIC
c_func
(paren
id|r
op_plus
id|PAGE_SIZE
op_minus
r_sizeof
(paren
id|u64
)paren
comma
id|BUFPAGE_MAGIC
)paren
suffix:semicolon
r_return
id|r
op_plus
id|BUF_OFFSET
suffix:semicolon
)brace
DECL|function|putpage
r_static
r_void
id|putpage
c_func
(paren
r_char
op_star
id|p
)paren
(brace
id|SOLD
c_func
(paren
l_string|&quot;putting page&quot;
)paren
suffix:semicolon
id|p
op_assign
id|p
op_minus
id|BUF_OFFSET
suffix:semicolon
id|SCHECK_MAGIC
c_func
(paren
id|p
comma
id|BUFPAGE_MAGIC
)paren
suffix:semicolon
id|SCHECK_MAGIC
c_func
(paren
id|p
op_plus
id|PAGE_SIZE
op_minus
r_sizeof
(paren
id|u64
)paren
comma
id|BUFPAGE_MAGIC
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|timod_pagelock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|page
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|timod_pagelock
)paren
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|p
)paren
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;freed it&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|page
op_assign
id|p
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|timod_pagelock
)paren
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;cached it&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|function|timod_mkctl
r_static
r_struct
id|T_primsg
op_star
id|timod_mkctl
c_func
(paren
r_int
id|size
)paren
(brace
r_struct
id|T_primsg
op_star
id|it
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;creating primsg&quot;
)paren
suffix:semicolon
id|it
op_assign
(paren
r_struct
id|T_primsg
op_star
)paren
id|mykmalloc
c_func
(paren
id|size
op_plus
r_sizeof
(paren
op_star
id|it
)paren
op_minus
r_sizeof
(paren
id|s32
)paren
op_plus
l_int|2
op_star
id|MKCTL_TRAILER
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|it
)paren
(brace
id|SOLD
c_func
(paren
l_string|&quot;got it&quot;
)paren
suffix:semicolon
id|it-&gt;pri
op_assign
id|MSG_HIPRI
suffix:semicolon
id|it-&gt;length
op_assign
id|size
suffix:semicolon
id|PUT_MAGIC
c_func
(paren
(paren
r_char
op_star
)paren
(paren
(paren
id|u64
)paren
(paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|it-&gt;type
)paren
op_plus
id|size
op_plus
l_int|7
)paren
op_amp
op_complement
l_int|7
)paren
comma
id|MKCTL_MAGIC
)paren
suffix:semicolon
)brace
r_return
id|it
suffix:semicolon
)brace
DECL|function|timod_wake_socket
r_static
r_void
id|timod_wake_socket
c_func
(paren
r_int
r_int
id|fd
)paren
(brace
r_struct
id|socket
op_star
id|sock
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;wakeing socket&quot;
)paren
suffix:semicolon
id|sock
op_assign
op_amp
id|current-&gt;files-&gt;fd
(braket
id|fd
)braket
op_member_access_from_pointer
id|f_dentry-&gt;d_inode-&gt;u.socket_i
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|sock-&gt;wait
)paren
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|sock-&gt;sk-&gt;callback_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;fasync_list
op_logical_and
op_logical_neg
id|test_bit
c_func
(paren
id|SOCK_ASYNC_WAITDATA
comma
op_amp
id|sock-&gt;flags
)paren
)paren
id|__kill_fasync
c_func
(paren
id|sock-&gt;fasync_list
comma
id|SIGIO
comma
id|POLL_IN
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|sock-&gt;sk-&gt;callback_lock
)paren
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;done&quot;
)paren
suffix:semicolon
)brace
DECL|function|timod_queue
r_static
r_void
id|timod_queue
c_func
(paren
r_int
r_int
id|fd
comma
r_struct
id|T_primsg
op_star
id|it
)paren
(brace
r_struct
id|sol_socket_struct
op_star
id|sock
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;queuing primsg&quot;
)paren
suffix:semicolon
id|sock
op_assign
(paren
r_struct
id|sol_socket_struct
op_star
)paren
id|current-&gt;files-&gt;fd
(braket
id|fd
)braket
op_member_access_from_pointer
id|private_data
suffix:semicolon
id|it-&gt;next
op_assign
id|sock-&gt;pfirst
suffix:semicolon
id|sock-&gt;pfirst
op_assign
id|it
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sock-&gt;plast
)paren
id|sock-&gt;plast
op_assign
id|it
suffix:semicolon
id|timod_wake_socket
c_func
(paren
id|fd
)paren
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;done&quot;
)paren
suffix:semicolon
)brace
DECL|function|timod_queue_end
r_static
r_void
id|timod_queue_end
c_func
(paren
r_int
r_int
id|fd
comma
r_struct
id|T_primsg
op_star
id|it
)paren
(brace
r_struct
id|sol_socket_struct
op_star
id|sock
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;queuing primsg at end&quot;
)paren
suffix:semicolon
id|sock
op_assign
(paren
r_struct
id|sol_socket_struct
op_star
)paren
id|current-&gt;files-&gt;fd
(braket
id|fd
)braket
op_member_access_from_pointer
id|private_data
suffix:semicolon
id|it-&gt;next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;plast
)paren
id|sock-&gt;plast-&gt;next
op_assign
id|it
suffix:semicolon
r_else
id|sock-&gt;pfirst
op_assign
id|it
suffix:semicolon
id|sock-&gt;plast
op_assign
id|it
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;done&quot;
)paren
suffix:semicolon
)brace
DECL|function|timod_error
r_static
r_void
id|timod_error
c_func
(paren
r_int
r_int
id|fd
comma
r_int
id|prim
comma
r_int
id|terr
comma
r_int
id|uerr
)paren
(brace
r_struct
id|T_primsg
op_star
id|it
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;making error&quot;
)paren
suffix:semicolon
id|it
op_assign
id|timod_mkctl
c_func
(paren
r_sizeof
(paren
r_struct
id|T_error_ack
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|it
)paren
(brace
r_struct
id|T_error_ack
op_star
id|err
op_assign
(paren
r_struct
id|T_error_ack
op_star
)paren
op_amp
id|it-&gt;type
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;got it&quot;
)paren
suffix:semicolon
id|err-&gt;PRIM_type
op_assign
id|T_ERROR_ACK
suffix:semicolon
id|err-&gt;ERROR_prim
op_assign
id|prim
suffix:semicolon
id|err-&gt;TLI_error
op_assign
id|terr
suffix:semicolon
id|err-&gt;UNIX_error
op_assign
id|uerr
suffix:semicolon
multiline_comment|/* FIXME: convert this */
id|timod_queue
c_func
(paren
id|fd
comma
id|it
)paren
suffix:semicolon
)brace
id|SOLD
c_func
(paren
l_string|&quot;done&quot;
)paren
suffix:semicolon
)brace
DECL|function|timod_ok
r_static
r_void
id|timod_ok
c_func
(paren
r_int
r_int
id|fd
comma
r_int
id|prim
)paren
(brace
r_struct
id|T_primsg
op_star
id|it
suffix:semicolon
r_struct
id|T_ok_ack
op_star
id|ok
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;creating ok ack&quot;
)paren
suffix:semicolon
id|it
op_assign
id|timod_mkctl
c_func
(paren
r_sizeof
(paren
op_star
id|ok
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|it
)paren
(brace
id|SOLD
c_func
(paren
l_string|&quot;got it&quot;
)paren
suffix:semicolon
id|ok
op_assign
(paren
r_struct
id|T_ok_ack
op_star
)paren
op_amp
id|it-&gt;type
suffix:semicolon
id|ok-&gt;PRIM_type
op_assign
id|T_OK_ACK
suffix:semicolon
id|ok-&gt;CORRECT_prim
op_assign
id|prim
suffix:semicolon
id|timod_queue
c_func
(paren
id|fd
comma
id|it
)paren
suffix:semicolon
)brace
id|SOLD
c_func
(paren
l_string|&quot;done&quot;
)paren
suffix:semicolon
)brace
DECL|function|timod_optmgmt
r_static
r_int
id|timod_optmgmt
c_func
(paren
r_int
r_int
id|fd
comma
r_int
id|flag
comma
r_char
op_star
id|opt_buf
comma
r_int
id|opt_len
comma
r_int
id|do_ret
)paren
(brace
r_int
id|error
comma
id|failed
suffix:semicolon
r_int
id|ret_space
comma
id|ret_len
suffix:semicolon
r_int
id|args
(braket
l_int|5
)braket
suffix:semicolon
r_char
op_star
id|ret_pos
comma
op_star
id|ret_buf
suffix:semicolon
r_int
(paren
op_star
id|sys_socketcall
)paren
(paren
r_int
comma
r_int
r_int
op_star
)paren
op_assign
(paren
r_int
(paren
op_star
)paren
(paren
r_int
comma
r_int
r_int
op_star
)paren
)paren
id|SYS
c_func
(paren
id|socketcall
)paren
suffix:semicolon
id|mm_segment_t
id|old_fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;entry&quot;
)paren
suffix:semicolon
id|SOLDD
c_func
(paren
(paren
l_string|&quot;fd %u flg %u buf %p len %u doret %u&quot;
comma
id|fd
comma
id|flag
comma
id|opt_buf
comma
id|opt_len
comma
id|do_ret
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|do_ret
op_logical_and
(paren
op_logical_neg
id|opt_buf
op_logical_or
id|opt_len
op_le
l_int|0
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;getting page&quot;
)paren
suffix:semicolon
id|ret_pos
op_assign
id|ret_buf
op_assign
id|getpage
c_func
(paren
)paren
suffix:semicolon
id|ret_space
op_assign
id|BUF_SIZE
suffix:semicolon
id|ret_len
op_assign
l_int|0
suffix:semicolon
id|error
op_assign
id|failed
op_assign
l_int|0
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;looping&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|opt_len
op_ge
r_sizeof
(paren
r_struct
id|opthdr
)paren
)paren
(brace
r_struct
id|opthdr
op_star
id|opt
suffix:semicolon
r_int
id|orig_opt_len
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;loop start&quot;
)paren
suffix:semicolon
id|opt
op_assign
(paren
r_struct
id|opthdr
op_star
)paren
id|ret_pos
suffix:semicolon
r_if
c_cond
(paren
id|ret_space
OL
r_sizeof
(paren
r_struct
id|opthdr
)paren
)paren
(brace
id|failed
op_assign
id|TSYSERR
suffix:semicolon
r_break
suffix:semicolon
)brace
id|SOLD
c_func
(paren
l_string|&quot;getting opthdr&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|opt
comma
id|opt_buf
comma
r_sizeof
(paren
r_struct
id|opthdr
)paren
)paren
op_logical_or
id|opt-&gt;len
OG
id|opt_len
)paren
(brace
id|failed
op_assign
id|TBADOPT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|SOLD
c_func
(paren
l_string|&quot;got opthdr&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_eq
id|T_NEGOTIATE
)paren
(brace
r_char
op_star
id|buf
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;handling T_NEGOTIATE&quot;
)paren
suffix:semicolon
id|buf
op_assign
id|ret_pos
op_plus
r_sizeof
(paren
r_struct
id|opthdr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret_space
OL
id|opt-&gt;len
op_plus
r_sizeof
(paren
r_struct
id|opthdr
)paren
op_logical_or
id|copy_from_user
c_func
(paren
id|buf
comma
id|opt_buf
op_plus
r_sizeof
(paren
r_struct
id|opthdr
)paren
comma
id|opt-&gt;len
)paren
)paren
(brace
id|failed
op_assign
id|TSYSERR
suffix:semicolon
r_break
suffix:semicolon
)brace
id|SOLD
c_func
(paren
l_string|&quot;got optdata&quot;
)paren
suffix:semicolon
id|args
(braket
l_int|0
)braket
op_assign
id|fd
suffix:semicolon
id|args
(braket
l_int|1
)braket
op_assign
id|opt-&gt;level
suffix:semicolon
id|args
(braket
l_int|2
)braket
op_assign
id|opt-&gt;name
suffix:semicolon
id|args
(braket
l_int|3
)braket
op_assign
(paren
r_int
)paren
id|buf
suffix:semicolon
id|args
(braket
l_int|4
)braket
op_assign
id|opt-&gt;len
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;calling SETSOCKOPT&quot;
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|KERNEL_DS
)paren
suffix:semicolon
id|error
op_assign
id|sys_socketcall
c_func
(paren
id|SYS_SETSOCKOPT
comma
id|args
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|old_fs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|failed
op_assign
id|TBADOPT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|SOLD
c_func
(paren
l_string|&quot;SETSOCKOPT ok&quot;
)paren
suffix:semicolon
)brace
id|orig_opt_len
op_assign
id|opt-&gt;len
suffix:semicolon
id|opt-&gt;len
op_assign
id|ret_space
op_minus
r_sizeof
(paren
r_struct
id|opthdr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|opt-&gt;len
OL
l_int|0
)paren
(brace
id|failed
op_assign
id|TSYSERR
suffix:semicolon
r_break
suffix:semicolon
)brace
id|args
(braket
l_int|0
)braket
op_assign
id|fd
suffix:semicolon
id|args
(braket
l_int|1
)braket
op_assign
id|opt-&gt;level
suffix:semicolon
id|args
(braket
l_int|2
)braket
op_assign
id|opt-&gt;name
suffix:semicolon
id|args
(braket
l_int|3
)braket
op_assign
(paren
r_int
)paren
(paren
id|ret_pos
op_plus
r_sizeof
(paren
r_struct
id|opthdr
)paren
)paren
suffix:semicolon
id|args
(braket
l_int|4
)braket
op_assign
(paren
r_int
)paren
op_amp
id|opt-&gt;len
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;calling GETSOCKOPT&quot;
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|KERNEL_DS
)paren
suffix:semicolon
id|error
op_assign
id|sys_socketcall
c_func
(paren
id|SYS_GETSOCKOPT
comma
id|args
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|old_fs
)paren
suffix:semicolon
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|failed
op_assign
id|TBADOPT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|SOLD
c_func
(paren
l_string|&quot;GETSOCKOPT ok&quot;
)paren
suffix:semicolon
id|ret_space
op_sub_assign
r_sizeof
(paren
r_struct
id|opthdr
)paren
op_plus
id|opt-&gt;len
suffix:semicolon
id|ret_len
op_add_assign
r_sizeof
(paren
r_struct
id|opthdr
)paren
op_plus
id|opt-&gt;len
suffix:semicolon
id|ret_pos
op_add_assign
r_sizeof
(paren
r_struct
id|opthdr
)paren
op_plus
id|opt-&gt;len
suffix:semicolon
id|opt_len
op_sub_assign
r_sizeof
(paren
r_struct
id|opthdr
)paren
op_plus
id|orig_opt_len
suffix:semicolon
id|opt_buf
op_add_assign
r_sizeof
(paren
r_struct
id|opthdr
)paren
op_plus
id|orig_opt_len
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;loop end&quot;
)paren
suffix:semicolon
)brace
id|SOLD
c_func
(paren
l_string|&quot;loop done&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|do_ret
)paren
(brace
id|SOLD
c_func
(paren
l_string|&quot;generating ret msg&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|failed
)paren
id|timod_error
c_func
(paren
id|fd
comma
id|T_OPTMGMT_REQ
comma
id|failed
comma
op_minus
id|error
)paren
suffix:semicolon
r_else
(brace
r_struct
id|T_primsg
op_star
id|it
suffix:semicolon
id|it
op_assign
id|timod_mkctl
c_func
(paren
r_sizeof
(paren
r_struct
id|T_optmgmt_ack
)paren
op_plus
id|ret_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|it
)paren
(brace
r_struct
id|T_optmgmt_ack
op_star
id|ack
op_assign
(paren
r_struct
id|T_optmgmt_ack
op_star
)paren
op_amp
id|it-&gt;type
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;got primsg&quot;
)paren
suffix:semicolon
id|ack-&gt;PRIM_type
op_assign
id|T_OPTMGMT_ACK
suffix:semicolon
id|ack-&gt;OPT_length
op_assign
id|ret_len
suffix:semicolon
id|ack-&gt;OPT_offset
op_assign
r_sizeof
(paren
r_struct
id|T_optmgmt_ack
)paren
suffix:semicolon
id|ack-&gt;MGMT_flags
op_assign
(paren
id|failed
ques
c_cond
id|T_FAILURE
suffix:colon
id|flag
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
(paren
r_char
op_star
)paren
id|ack
)paren
op_plus
r_sizeof
(paren
r_struct
id|T_optmgmt_ack
)paren
comma
id|ret_buf
comma
id|ret_len
)paren
suffix:semicolon
id|timod_queue
c_func
(paren
id|fd
comma
id|it
)paren
suffix:semicolon
)brace
)brace
)brace
id|SOLDD
c_func
(paren
(paren
l_string|&quot;put_page %p&bslash;n&quot;
comma
id|ret_buf
)paren
)paren
suffix:semicolon
id|putpage
c_func
(paren
id|ret_buf
)paren
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;done&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|timod_putmsg
r_int
id|timod_putmsg
c_func
(paren
r_int
r_int
id|fd
comma
r_char
op_star
id|ctl_buf
comma
r_int
id|ctl_len
comma
r_char
op_star
id|data_buf
comma
r_int
id|data_len
comma
r_int
id|flags
)paren
(brace
r_int
id|ret
comma
id|error
comma
id|terror
suffix:semicolon
r_char
op_star
id|buf
suffix:semicolon
r_struct
id|file
op_star
id|filp
suffix:semicolon
r_struct
id|inode
op_star
id|ino
suffix:semicolon
r_struct
id|sol_socket_struct
op_star
id|sock
suffix:semicolon
id|mm_segment_t
id|old_fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
r_int
id|args
(braket
l_int|6
)braket
suffix:semicolon
r_int
(paren
op_star
id|sys_socketcall
)paren
(paren
r_int
comma
r_int
r_int
op_star
)paren
op_assign
(paren
r_int
(paren
op_star
)paren
(paren
r_int
comma
r_int
r_int
op_star
)paren
)paren
id|SYS
c_func
(paren
id|socketcall
)paren
suffix:semicolon
r_int
(paren
op_star
id|sys_sendto
)paren
(paren
r_int
comma
r_void
op_star
comma
r_int
comma
r_int
comma
r_struct
id|sockaddr
op_star
comma
r_int
)paren
op_assign
(paren
r_int
(paren
op_star
)paren
(paren
r_int
comma
r_void
op_star
comma
r_int
comma
r_int
comma
r_struct
id|sockaddr
op_star
comma
r_int
)paren
)paren
id|SYS
c_func
(paren
id|sendto
)paren
suffix:semicolon
id|filp
op_assign
id|current-&gt;files-&gt;fd
(braket
id|fd
)braket
suffix:semicolon
id|ino
op_assign
id|filp-&gt;f_dentry-&gt;d_inode
suffix:semicolon
id|sock
op_assign
(paren
r_struct
id|sol_socket_struct
op_star
)paren
id|filp-&gt;private_data
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;entry&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|ret
comma
(paren
r_int
op_star
)paren
id|A
c_func
(paren
id|ctl_buf
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|ret
)paren
(brace
r_case
id|T_BIND_REQ
suffix:colon
(brace
r_struct
id|T_bind_req
id|req
suffix:semicolon
id|SOLDD
c_func
(paren
(paren
l_string|&quot;bind %016lx(%016lx)&bslash;n&quot;
comma
id|sock
comma
id|filp
)paren
)paren
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;T_BIND_REQ&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;state
op_ne
id|TS_UNBND
)paren
(brace
id|timod_error
c_func
(paren
id|fd
comma
id|T_BIND_REQ
comma
id|TOUTSTATE
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|SOLD
c_func
(paren
l_string|&quot;state ok&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|req
comma
id|ctl_buf
comma
r_sizeof
(paren
id|req
)paren
)paren
)paren
(brace
id|timod_error
c_func
(paren
id|fd
comma
id|T_BIND_REQ
comma
id|TSYSERR
comma
id|EFAULT
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|SOLD
c_func
(paren
l_string|&quot;got ctl req&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req.ADDR_offset
op_logical_and
id|req.ADDR_length
)paren
(brace
r_if
c_cond
(paren
id|req.ADDR_length
OG
id|BUF_SIZE
)paren
(brace
id|timod_error
c_func
(paren
id|fd
comma
id|T_BIND_REQ
comma
id|TSYSERR
comma
id|EFAULT
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|SOLD
c_func
(paren
l_string|&quot;req size ok&quot;
)paren
suffix:semicolon
id|buf
op_assign
id|getpage
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|buf
comma
id|ctl_buf
op_plus
id|req.ADDR_offset
comma
id|req.ADDR_length
)paren
)paren
(brace
id|timod_error
c_func
(paren
id|fd
comma
id|T_BIND_REQ
comma
id|TSYSERR
comma
id|EFAULT
)paren
suffix:semicolon
id|putpage
c_func
(paren
id|buf
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|SOLD
c_func
(paren
l_string|&quot;got ctl data&quot;
)paren
suffix:semicolon
id|args
(braket
l_int|0
)braket
op_assign
id|fd
suffix:semicolon
id|args
(braket
l_int|1
)braket
op_assign
(paren
r_int
)paren
id|buf
suffix:semicolon
id|args
(braket
l_int|2
)braket
op_assign
id|req.ADDR_length
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;calling BIND&quot;
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|KERNEL_DS
)paren
suffix:semicolon
id|error
op_assign
id|sys_socketcall
c_func
(paren
id|SYS_BIND
comma
id|args
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|old_fs
)paren
suffix:semicolon
id|putpage
c_func
(paren
id|buf
)paren
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;BIND returned&quot;
)paren
suffix:semicolon
)brace
r_else
id|error
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
(brace
r_struct
id|T_primsg
op_star
id|it
suffix:semicolon
r_if
c_cond
(paren
id|req.CONIND_number
)paren
(brace
id|args
(braket
l_int|0
)braket
op_assign
id|fd
suffix:semicolon
id|args
(braket
l_int|1
)braket
op_assign
id|req.CONIND_number
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;calling LISTEN&quot;
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|KERNEL_DS
)paren
suffix:semicolon
id|error
op_assign
id|sys_socketcall
c_func
(paren
id|SYS_LISTEN
comma
id|args
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|old_fs
)paren
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;LISTEN done&quot;
)paren
suffix:semicolon
)brace
id|it
op_assign
id|timod_mkctl
c_func
(paren
r_sizeof
(paren
r_struct
id|T_bind_ack
)paren
op_plus
r_sizeof
(paren
r_struct
id|sockaddr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|it
)paren
(brace
r_struct
id|T_bind_ack
op_star
id|ack
suffix:semicolon
id|ack
op_assign
(paren
r_struct
id|T_bind_ack
op_star
)paren
op_amp
id|it-&gt;type
suffix:semicolon
id|ack-&gt;PRIM_type
op_assign
id|T_BIND_ACK
suffix:semicolon
id|ack-&gt;ADDR_offset
op_assign
r_sizeof
(paren
op_star
id|ack
)paren
suffix:semicolon
id|ack-&gt;ADDR_length
op_assign
r_sizeof
(paren
r_struct
id|sockaddr
)paren
suffix:semicolon
id|ack-&gt;CONIND_number
op_assign
id|req.CONIND_number
suffix:semicolon
id|args
(braket
l_int|0
)braket
op_assign
id|fd
suffix:semicolon
id|args
(braket
l_int|1
)braket
op_assign
(paren
r_int
)paren
(paren
id|ack
op_plus
r_sizeof
(paren
op_star
id|ack
)paren
)paren
suffix:semicolon
id|args
(braket
l_int|2
)braket
op_assign
(paren
r_int
)paren
op_amp
id|ack-&gt;ADDR_length
suffix:semicolon
id|set_fs
c_func
(paren
id|KERNEL_DS
)paren
suffix:semicolon
id|sys_socketcall
c_func
(paren
id|SYS_GETSOCKNAME
comma
id|args
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|old_fs
)paren
suffix:semicolon
id|sock-&gt;state
op_assign
id|TS_IDLE
suffix:semicolon
id|timod_ok
c_func
(paren
id|fd
comma
id|T_BIND_REQ
)paren
suffix:semicolon
id|timod_queue_end
c_func
(paren
id|fd
comma
id|it
)paren
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;BIND done&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|SOLD
c_func
(paren
l_string|&quot;some error&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|error
)paren
(brace
r_case
op_minus
id|EINVAL
suffix:colon
id|terror
op_assign
id|TOUTSTATE
suffix:semicolon
id|error
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|EACCES
suffix:colon
id|terror
op_assign
id|TACCES
suffix:semicolon
id|error
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|EADDRNOTAVAIL
suffix:colon
r_case
op_minus
id|EADDRINUSE
suffix:colon
id|terror
op_assign
id|TNOADDR
suffix:semicolon
id|error
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|terror
op_assign
id|TSYSERR
suffix:semicolon
r_break
suffix:semicolon
)brace
id|timod_error
c_func
(paren
id|fd
comma
id|T_BIND_REQ
comma
id|terror
comma
op_minus
id|error
)paren
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;BIND done&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|T_CONN_REQ
suffix:colon
(brace
r_struct
id|T_conn_req
id|req
suffix:semicolon
r_int
r_int
id|oldflags
suffix:semicolon
r_struct
id|T_primsg
op_star
id|it
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;T_CONN_REQ&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;state
op_ne
id|TS_UNBND
op_logical_and
id|sock-&gt;state
op_ne
id|TS_IDLE
)paren
(brace
id|timod_error
c_func
(paren
id|fd
comma
id|T_CONN_REQ
comma
id|TOUTSTATE
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|SOLD
c_func
(paren
l_string|&quot;state ok&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|req
comma
id|ctl_buf
comma
r_sizeof
(paren
id|req
)paren
)paren
)paren
(brace
id|timod_error
c_func
(paren
id|fd
comma
id|T_CONN_REQ
comma
id|TSYSERR
comma
id|EFAULT
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|SOLD
c_func
(paren
l_string|&quot;got ctl req&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ctl_len
OG
id|BUF_SIZE
)paren
(brace
id|timod_error
c_func
(paren
id|fd
comma
id|T_CONN_REQ
comma
id|TSYSERR
comma
id|EFAULT
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|SOLD
c_func
(paren
l_string|&quot;req size ok&quot;
)paren
suffix:semicolon
id|buf
op_assign
id|getpage
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|buf
comma
id|ctl_buf
comma
id|ctl_len
)paren
)paren
(brace
id|timod_error
c_func
(paren
id|fd
comma
id|T_CONN_REQ
comma
id|TSYSERR
comma
id|EFAULT
)paren
suffix:semicolon
id|putpage
c_func
(paren
id|buf
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef DEBUG_SOLARIS&t;&t;
(brace
r_char
op_star
id|ptr
op_assign
id|buf
suffix:semicolon
r_int
id|len
op_assign
id|ctl_len
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;returned data (%d bytes): &quot;
comma
id|len
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
op_decrement
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|len
op_amp
l_int|7
)paren
)paren
id|printk
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%02x&quot;
comma
(paren
r_int
r_char
)paren
op_star
id|ptr
op_increment
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|SOLD
c_func
(paren
l_string|&quot;got ctl data&quot;
)paren
suffix:semicolon
id|args
(braket
l_int|0
)braket
op_assign
id|fd
suffix:semicolon
id|args
(braket
l_int|1
)braket
op_assign
(paren
r_int
)paren
id|buf
op_plus
id|req.DEST_offset
suffix:semicolon
id|args
(braket
l_int|2
)braket
op_assign
id|req.DEST_length
suffix:semicolon
id|oldflags
op_assign
id|filp-&gt;f_flags
suffix:semicolon
id|filp-&gt;f_flags
op_and_assign
op_complement
id|O_NONBLOCK
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;calling CONNECT&quot;
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|KERNEL_DS
)paren
suffix:semicolon
id|error
op_assign
id|sys_socketcall
c_func
(paren
id|SYS_CONNECT
comma
id|args
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|old_fs
)paren
suffix:semicolon
id|filp-&gt;f_flags
op_assign
id|oldflags
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;CONNECT done&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
(brace
r_struct
id|T_conn_con
op_star
id|con
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;no error&quot;
)paren
suffix:semicolon
id|it
op_assign
id|timod_mkctl
c_func
(paren
id|ctl_len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|it
)paren
(brace
id|putpage
c_func
(paren
id|buf
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|con
op_assign
(paren
r_struct
id|T_conn_con
op_star
)paren
op_amp
id|it-&gt;type
suffix:semicolon
macro_line|#ifdef DEBUG_SOLARIS&t;&t;&t;
(brace
r_char
op_star
id|ptr
op_assign
id|buf
suffix:semicolon
r_int
id|len
op_assign
id|ctl_len
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;returned data (%d bytes): &quot;
comma
id|len
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
op_decrement
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|len
op_amp
l_int|7
)paren
)paren
id|printk
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%02x&quot;
comma
(paren
r_int
r_char
)paren
op_star
id|ptr
op_increment
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|memcpy
c_func
(paren
id|con
comma
id|buf
comma
id|ctl_len
)paren
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;copied ctl_buf&quot;
)paren
suffix:semicolon
id|con-&gt;PRIM_type
op_assign
id|T_CONN_CON
suffix:semicolon
id|sock-&gt;state
op_assign
id|TS_DATA_XFER
suffix:semicolon
)brace
r_else
(brace
r_struct
id|T_discon_ind
op_star
id|dis
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;some error&quot;
)paren
suffix:semicolon
id|it
op_assign
id|timod_mkctl
c_func
(paren
r_sizeof
(paren
op_star
id|dis
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|it
)paren
(brace
id|putpage
c_func
(paren
id|buf
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|SOLD
c_func
(paren
l_string|&quot;got primsg&quot;
)paren
suffix:semicolon
id|dis
op_assign
(paren
r_struct
id|T_discon_ind
op_star
)paren
op_amp
id|it-&gt;type
suffix:semicolon
id|dis-&gt;PRIM_type
op_assign
id|T_DISCON_IND
suffix:semicolon
id|dis-&gt;DISCON_reason
op_assign
op_minus
id|error
suffix:semicolon
multiline_comment|/* FIXME: convert this as in iABI_errors() */
id|dis-&gt;SEQ_number
op_assign
l_int|0
suffix:semicolon
)brace
id|putpage
c_func
(paren
id|buf
)paren
suffix:semicolon
id|timod_ok
c_func
(paren
id|fd
comma
id|T_CONN_REQ
)paren
suffix:semicolon
id|it-&gt;pri
op_assign
l_int|0
suffix:semicolon
id|timod_queue_end
c_func
(paren
id|fd
comma
id|it
)paren
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;CONNECT done&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|T_OPTMGMT_REQ
suffix:colon
(brace
r_struct
id|T_optmgmt_req
id|req
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;OPTMGMT_REQ&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|req
comma
id|ctl_buf
comma
r_sizeof
(paren
id|req
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;got req&quot;
)paren
suffix:semicolon
r_return
id|timod_optmgmt
c_func
(paren
id|fd
comma
id|req.MGMT_flags
comma
id|req.OPT_offset
OG
l_int|0
ques
c_cond
id|ctl_buf
op_plus
id|req.OPT_offset
suffix:colon
l_int|NULL
comma
id|req.OPT_length
comma
l_int|1
)paren
suffix:semicolon
)brace
r_case
id|T_UNITDATA_REQ
suffix:colon
(brace
r_struct
id|T_unitdata_req
id|req
suffix:semicolon
r_int
id|err
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;T_UNITDATA_REQ&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;state
op_ne
id|TS_IDLE
op_logical_and
id|sock-&gt;state
op_ne
id|TS_DATA_XFER
)paren
(brace
id|timod_error
c_func
(paren
id|fd
comma
id|T_CONN_REQ
comma
id|TOUTSTATE
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|SOLD
c_func
(paren
l_string|&quot;state ok&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|req
comma
id|ctl_buf
comma
r_sizeof
(paren
id|req
)paren
)paren
)paren
(brace
id|timod_error
c_func
(paren
id|fd
comma
id|T_CONN_REQ
comma
id|TSYSERR
comma
id|EFAULT
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|SOLD
c_func
(paren
l_string|&quot;got ctl req&quot;
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_SOLARIS&t;&t;
(brace
r_char
op_star
id|ptr
op_assign
id|ctl_buf
op_plus
id|req.DEST_offset
suffix:semicolon
r_int
id|len
op_assign
id|req.DEST_length
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;socket address (%d bytes): &quot;
comma
id|len
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
op_decrement
)paren
(brace
r_char
id|c
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|c
comma
id|ptr
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;??&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;%02x&quot;
comma
(paren
r_int
r_char
)paren
id|c
)paren
suffix:semicolon
id|ptr
op_increment
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;
id|err
op_assign
id|sys_sendto
c_func
(paren
id|fd
comma
id|data_buf
comma
id|data_len
comma
l_int|0
comma
id|req.DEST_length
OG
l_int|0
ques
c_cond
(paren
r_struct
id|sockaddr
op_star
)paren
(paren
id|ctl_buf
op_plus
id|req.DEST_offset
)paren
suffix:colon
l_int|NULL
comma
id|req.DEST_length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
id|data_len
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ge
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;timod: sendto failed to send all the data&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|timod_error
c_func
(paren
id|fd
comma
id|T_CONN_REQ
comma
id|TSYSERR
comma
op_minus
id|err
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;timod_putmsg: unsuported command %u.&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|timod_getmsg
r_int
id|timod_getmsg
c_func
(paren
r_int
r_int
id|fd
comma
r_char
op_star
id|ctl_buf
comma
r_int
id|ctl_maxlen
comma
id|s32
op_star
id|ctl_len
comma
r_char
op_star
id|data_buf
comma
r_int
id|data_maxlen
comma
id|s32
op_star
id|data_len
comma
r_int
op_star
id|flags_p
)paren
(brace
r_int
id|error
suffix:semicolon
r_int
id|oldflags
suffix:semicolon
r_struct
id|file
op_star
id|filp
suffix:semicolon
r_struct
id|inode
op_star
id|ino
suffix:semicolon
r_struct
id|sol_socket_struct
op_star
id|sock
suffix:semicolon
r_struct
id|T_unitdata_ind
id|udi
suffix:semicolon
id|mm_segment_t
id|old_fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
r_int
id|args
(braket
l_int|6
)braket
suffix:semicolon
r_char
op_star
id|tmpbuf
suffix:semicolon
r_int
id|tmplen
suffix:semicolon
r_int
(paren
op_star
id|sys_socketcall
)paren
(paren
r_int
comma
r_int
r_int
op_star
)paren
op_assign
(paren
r_int
(paren
op_star
)paren
(paren
r_int
comma
r_int
r_int
op_star
)paren
)paren
id|SYS
c_func
(paren
id|socketcall
)paren
suffix:semicolon
r_int
(paren
op_star
id|sys_recvfrom
)paren
(paren
r_int
comma
r_void
op_star
comma
r_int
comma
r_int
comma
r_struct
id|sockaddr
op_star
comma
r_int
op_star
)paren
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;entry&quot;
)paren
suffix:semicolon
id|SOLDD
c_func
(paren
(paren
l_string|&quot;%u %p %d %p %p %d %p %d&bslash;n&quot;
comma
id|fd
comma
id|ctl_buf
comma
id|ctl_maxlen
comma
id|ctl_len
comma
id|data_buf
comma
id|data_maxlen
comma
id|data_len
comma
op_star
id|flags_p
)paren
)paren
suffix:semicolon
id|filp
op_assign
id|current-&gt;files-&gt;fd
(braket
id|fd
)braket
suffix:semicolon
id|ino
op_assign
id|filp-&gt;f_dentry-&gt;d_inode
suffix:semicolon
id|sock
op_assign
(paren
r_struct
id|sol_socket_struct
op_star
)paren
id|filp-&gt;private_data
suffix:semicolon
id|SOLDD
c_func
(paren
(paren
l_string|&quot;%p %p&bslash;n&quot;
comma
id|sock-&gt;pfirst
comma
id|sock-&gt;pfirst
ques
c_cond
id|sock-&gt;pfirst-&gt;next
suffix:colon
l_int|NULL
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ctl_maxlen
OG
l_int|0
op_logical_and
op_logical_neg
id|sock-&gt;pfirst
op_logical_and
id|ino-&gt;u.socket_i.type
op_eq
id|SOCK_STREAM
op_logical_and
id|sock-&gt;state
op_eq
id|TS_IDLE
)paren
(brace
id|SOLD
c_func
(paren
l_string|&quot;calling LISTEN&quot;
)paren
suffix:semicolon
id|args
(braket
l_int|0
)braket
op_assign
id|fd
suffix:semicolon
id|args
(braket
l_int|1
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
id|set_fs
c_func
(paren
id|KERNEL_DS
)paren
suffix:semicolon
id|sys_socketcall
c_func
(paren
id|SYS_LISTEN
comma
id|args
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|old_fs
)paren
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;LISTEN done&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|filp-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
)paren
(brace
id|poll_table
id|wait_table
comma
op_star
id|wait
suffix:semicolon
id|poll_initwait
c_func
(paren
op_amp
id|wait_table
)paren
suffix:semicolon
id|wait
op_assign
op_amp
id|wait_table
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|SOLD
c_func
(paren
l_string|&quot;loop&quot;
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
multiline_comment|/* ! ( l&lt;0 || ( l&gt;=0 &amp;&amp; ( ! pfirst || (flags == HIPRI &amp;&amp; pri != HIPRI) ) ) ) */
multiline_comment|/* ( ! l&lt;0 &amp;&amp; ! ( l&gt;=0 &amp;&amp; ( ! pfirst || (flags == HIPRI &amp;&amp; pri != HIPRI) ) ) ) */
multiline_comment|/* ( l&gt;=0 &amp;&amp; ( ! l&gt;=0 || ! ( ! pfirst || (flags == HIPRI &amp;&amp; pri != HIPRI) ) ) ) */
multiline_comment|/* ( l&gt;=0 &amp;&amp; ( l&lt;0 || ( pfirst &amp;&amp; ! (flags == HIPRI &amp;&amp; pri != HIPRI) ) ) ) */
multiline_comment|/* ( l&gt;=0 &amp;&amp; ( l&lt;0 || ( pfirst &amp;&amp; (flags != HIPRI || pri == HIPRI) ) ) ) */
multiline_comment|/* ( l&gt;=0 &amp;&amp; ( pfirst &amp;&amp; (flags != HIPRI || pri == HIPRI) ) ) */
r_if
c_cond
(paren
id|ctl_maxlen
op_ge
l_int|0
op_logical_and
id|sock-&gt;pfirst
op_logical_and
(paren
op_star
id|flags_p
op_ne
id|MSG_HIPRI
op_logical_or
id|sock-&gt;pfirst-&gt;pri
op_eq
id|MSG_HIPRI
)paren
)paren
r_break
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;cond 1 passed&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
macro_line|#if 1
op_star
id|flags_p
op_ne
id|MSG_HIPRI
op_logical_and
macro_line|#endif
(paren
(paren
id|filp-&gt;f_op
op_member_access_from_pointer
id|poll
c_func
(paren
id|filp
comma
id|wait
)paren
op_amp
id|POLLIN
)paren
op_logical_or
(paren
id|filp-&gt;f_op
op_member_access_from_pointer
id|poll
c_func
(paren
id|filp
comma
l_int|NULL
)paren
op_amp
id|POLLIN
)paren
op_logical_or
id|signal_pending
c_func
(paren
id|current
)paren
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|flags_p
op_eq
id|MSG_HIPRI
)paren
(brace
id|SOLD
c_func
(paren
l_string|&quot;avoiding lockup&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|wait_table.error
)paren
(brace
id|SOLD
c_func
(paren
l_string|&quot;wait-table error&quot;
)paren
suffix:semicolon
id|poll_freewait
c_func
(paren
op_amp
id|wait_table
)paren
suffix:semicolon
r_return
id|wait_table.error
suffix:semicolon
)brace
id|SOLD
c_func
(paren
l_string|&quot;scheduling&quot;
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
id|SOLD
c_func
(paren
l_string|&quot;loop done&quot;
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|poll_freewait
c_func
(paren
op_amp
id|wait_table
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|SOLD
c_func
(paren
l_string|&quot;signal pending&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|ctl_maxlen
op_ge
l_int|0
op_logical_and
id|sock-&gt;pfirst
)paren
(brace
r_struct
id|T_primsg
op_star
id|it
op_assign
id|sock-&gt;pfirst
suffix:semicolon
macro_line|#ifndef min
DECL|macro|min
mdefine_line|#define min(a,b) ((a)&lt;(b)?(a):(b))
macro_line|#endif
r_int
id|l
op_assign
id|min
c_func
(paren
id|ctl_maxlen
comma
id|it-&gt;length
)paren
suffix:semicolon
id|SCHECK_MAGIC
c_func
(paren
(paren
r_char
op_star
)paren
(paren
(paren
id|u64
)paren
(paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|it-&gt;type
)paren
op_plus
id|sock-&gt;offset
op_plus
id|it-&gt;length
op_plus
l_int|7
)paren
op_amp
op_complement
l_int|7
)paren
comma
id|MKCTL_MAGIC
)paren
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;purting ctl data&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ctl_buf
comma
(paren
r_char
op_star
)paren
op_amp
id|it-&gt;type
op_plus
id|sock-&gt;offset
comma
id|l
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|SOLD
c_func
(paren
l_string|&quot;pur it&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|l
comma
id|ctl_len
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|SOLD
c_func
(paren
l_string|&quot;set ctl_len&quot;
)paren
suffix:semicolon
op_star
id|flags_p
op_assign
id|it-&gt;pri
suffix:semicolon
id|it-&gt;length
op_sub_assign
id|l
suffix:semicolon
r_if
c_cond
(paren
id|it-&gt;length
)paren
(brace
id|SOLD
c_func
(paren
l_string|&quot;more ctl&quot;
)paren
suffix:semicolon
id|sock-&gt;offset
op_add_assign
id|l
suffix:semicolon
r_return
id|MORECTL
suffix:semicolon
)brace
r_else
(brace
id|SOLD
c_func
(paren
l_string|&quot;removing message&quot;
)paren
suffix:semicolon
id|sock-&gt;pfirst
op_assign
id|it-&gt;next
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sock-&gt;pfirst
)paren
id|sock-&gt;plast
op_assign
l_int|NULL
suffix:semicolon
id|SOLDD
c_func
(paren
(paren
l_string|&quot;getmsg kfree %016lx-&gt;%016lx&bslash;n&quot;
comma
id|it
comma
id|sock-&gt;pfirst
)paren
)paren
suffix:semicolon
id|mykfree
c_func
(paren
id|it
)paren
suffix:semicolon
id|sock-&gt;offset
op_assign
l_int|0
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;ctl done&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
op_star
id|flags_p
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ctl_maxlen
op_ge
l_int|0
)paren
(brace
id|SOLD
c_func
(paren
l_string|&quot;ACCEPT perhaps?&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ino-&gt;u.socket_i.type
op_eq
id|SOCK_STREAM
op_logical_and
id|sock-&gt;state
op_eq
id|TS_IDLE
)paren
(brace
r_struct
id|T_conn_ind
id|ind
suffix:semicolon
r_char
op_star
id|buf
op_assign
id|getpage
c_func
(paren
)paren
suffix:semicolon
r_int
id|len
op_assign
id|BUF_SIZE
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;trying ACCEPT&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|ctl_maxlen
op_minus
r_sizeof
(paren
id|ind
)paren
comma
id|ctl_len
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|args
(braket
l_int|0
)braket
op_assign
id|fd
suffix:semicolon
id|args
(braket
l_int|1
)braket
op_assign
(paren
r_int
)paren
id|buf
suffix:semicolon
id|args
(braket
l_int|2
)braket
op_assign
(paren
r_int
)paren
op_amp
id|len
suffix:semicolon
id|oldflags
op_assign
id|filp-&gt;f_flags
suffix:semicolon
id|filp-&gt;f_flags
op_or_assign
id|O_NONBLOCK
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;calling ACCEPT&quot;
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|KERNEL_DS
)paren
suffix:semicolon
id|error
op_assign
id|sys_socketcall
c_func
(paren
id|SYS_ACCEPT
comma
id|args
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|old_fs
)paren
suffix:semicolon
id|filp-&gt;f_flags
op_assign
id|oldflags
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
(brace
id|SOLD
c_func
(paren
l_string|&quot;some error&quot;
)paren
suffix:semicolon
id|putpage
c_func
(paren
id|buf
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|error
)paren
(brace
id|SOLD
c_func
(paren
l_string|&quot;connect&quot;
)paren
suffix:semicolon
id|putpage
c_func
(paren
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
r_sizeof
(paren
id|ind
)paren
OG
id|ctl_maxlen
)paren
(brace
id|SOLD
c_func
(paren
l_string|&quot;generating CONN_IND&quot;
)paren
suffix:semicolon
id|ind.PRIM_type
op_assign
id|T_CONN_IND
suffix:semicolon
id|ind.SRC_length
op_assign
id|len
suffix:semicolon
id|ind.SRC_offset
op_assign
r_sizeof
(paren
id|ind
)paren
suffix:semicolon
id|ind.OPT_length
op_assign
id|ind.OPT_offset
op_assign
l_int|0
suffix:semicolon
id|ind.SEQ_number
op_assign
id|error
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ctl_buf
comma
op_amp
id|ind
comma
r_sizeof
(paren
id|ind
)paren
)paren
op_logical_or
id|put_user
c_func
(paren
r_sizeof
(paren
id|ind
)paren
op_plus
id|ind.SRC_length
comma
id|ctl_len
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|SOLD
c_func
(paren
l_string|&quot;CONN_IND created&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data_maxlen
op_ge
l_int|0
)paren
id|put_user
c_func
(paren
l_int|0
comma
id|data_len
)paren
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;CONN_IND done&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OG
id|ctl_maxlen
)paren
(brace
id|SOLD
c_func
(paren
l_string|&quot;data don&squot;t fit&quot;
)paren
suffix:semicolon
id|putpage
c_func
(paren
id|buf
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* XXX - is this ok ? */
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ctl_buf
comma
id|buf
comma
id|len
)paren
op_logical_or
id|put_user
c_func
(paren
id|len
comma
id|ctl_len
)paren
)paren
(brace
id|SOLD
c_func
(paren
l_string|&quot;can&squot;t copy data&quot;
)paren
suffix:semicolon
id|putpage
c_func
(paren
id|buf
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|SOLD
c_func
(paren
l_string|&quot;ACCEPT done&quot;
)paren
suffix:semicolon
id|putpage
c_func
(paren
id|buf
)paren
suffix:semicolon
)brace
)brace
id|SOLD
c_func
(paren
l_string|&quot;checking data req&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data_maxlen
op_le
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|data_maxlen
op_eq
l_int|0
)paren
id|put_user
c_func
(paren
l_int|0
comma
id|data_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ctl_maxlen
op_ge
l_int|0
)paren
id|put_user
c_func
(paren
l_int|0
comma
id|ctl_len
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|SOLD
c_func
(paren
l_string|&quot;wants data&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ctl_maxlen
OG
r_sizeof
(paren
id|udi
)paren
op_logical_and
id|sock-&gt;state
op_eq
id|TS_IDLE
)paren
(brace
id|SOLD
c_func
(paren
l_string|&quot;udi fits&quot;
)paren
suffix:semicolon
id|tmpbuf
op_assign
id|ctl_buf
op_plus
r_sizeof
(paren
id|udi
)paren
suffix:semicolon
id|tmplen
op_assign
id|ctl_maxlen
op_minus
r_sizeof
(paren
id|udi
)paren
suffix:semicolon
)brace
r_else
(brace
id|SOLD
c_func
(paren
l_string|&quot;udi does not fit&quot;
)paren
suffix:semicolon
id|tmpbuf
op_assign
l_int|NULL
suffix:semicolon
id|tmplen
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|tmplen
comma
id|ctl_len
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;set ctl_len&quot;
)paren
suffix:semicolon
id|oldflags
op_assign
id|filp-&gt;f_flags
suffix:semicolon
id|filp-&gt;f_flags
op_or_assign
id|O_NONBLOCK
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;calling recvfrom&quot;
)paren
suffix:semicolon
id|sys_recvfrom
op_assign
(paren
r_int
(paren
op_star
)paren
(paren
r_int
comma
r_void
op_star
comma
r_int
comma
r_int
comma
r_struct
id|sockaddr
op_star
comma
r_int
op_star
)paren
)paren
id|SYS
c_func
(paren
id|recvfrom
)paren
suffix:semicolon
id|error
op_assign
id|sys_recvfrom
c_func
(paren
id|fd
comma
id|data_buf
comma
id|min
c_func
(paren
l_int|0
comma
id|data_maxlen
)paren
comma
l_int|0
comma
(paren
r_struct
id|sockaddr
op_star
)paren
id|tmpbuf
comma
id|ctl_len
)paren
suffix:semicolon
id|filp-&gt;f_flags
op_assign
id|oldflags
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
r_return
id|error
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;error &gt;= 0&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_logical_and
id|ctl_maxlen
OG
r_sizeof
(paren
id|udi
)paren
op_logical_and
id|sock-&gt;state
op_eq
id|TS_IDLE
)paren
(brace
id|SOLD
c_func
(paren
l_string|&quot;generating udi&quot;
)paren
suffix:semicolon
id|udi.PRIM_type
op_assign
id|T_UNITDATA_IND
suffix:semicolon
id|get_user
c_func
(paren
id|udi.SRC_length
comma
id|ctl_len
)paren
suffix:semicolon
id|udi.SRC_offset
op_assign
r_sizeof
(paren
id|udi
)paren
suffix:semicolon
id|udi.OPT_length
op_assign
id|udi.OPT_offset
op_assign
l_int|0
suffix:semicolon
id|copy_to_user
c_func
(paren
id|ctl_buf
comma
op_amp
id|udi
comma
r_sizeof
(paren
id|udi
)paren
)paren
suffix:semicolon
id|put_user
c_func
(paren
r_sizeof
(paren
id|udi
)paren
op_plus
id|udi.SRC_length
comma
id|ctl_len
)paren
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;udi done&quot;
)paren
suffix:semicolon
)brace
r_else
id|put_user
c_func
(paren
l_int|0
comma
id|ctl_len
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|error
comma
id|data_len
)paren
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;done&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|solaris_getmsg
id|asmlinkage
r_int
id|solaris_getmsg
c_func
(paren
r_int
r_int
id|fd
comma
id|u32
id|arg1
comma
id|u32
id|arg2
comma
id|u32
id|arg3
)paren
(brace
r_struct
id|file
op_star
id|filp
suffix:semicolon
r_struct
id|inode
op_star
id|ino
suffix:semicolon
r_struct
id|strbuf
op_star
id|ctlptr
comma
op_star
id|datptr
suffix:semicolon
r_struct
id|strbuf
id|ctl
comma
id|dat
suffix:semicolon
r_int
op_star
id|flgptr
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_int
id|error
op_assign
op_minus
id|EBADF
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;entry&quot;
)paren
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fd
op_ge
id|NR_OPEN
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|filp
op_assign
id|current-&gt;files-&gt;fd
(braket
id|fd
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|filp
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|ino
op_assign
id|filp-&gt;f_dentry-&gt;d_inode
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ino
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ino-&gt;i_sock
)paren
r_goto
id|out
suffix:semicolon
id|ctlptr
op_assign
(paren
r_struct
id|strbuf
op_star
)paren
id|A
c_func
(paren
id|arg1
)paren
suffix:semicolon
id|datptr
op_assign
(paren
r_struct
id|strbuf
op_star
)paren
id|A
c_func
(paren
id|arg2
)paren
suffix:semicolon
id|flgptr
op_assign
(paren
r_int
op_star
)paren
id|A
c_func
(paren
id|arg3
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|ctlptr
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|ctl
comma
id|ctlptr
comma
r_sizeof
(paren
r_struct
id|strbuf
)paren
)paren
op_logical_or
id|put_user
c_func
(paren
op_minus
l_int|1
comma
op_amp
id|ctlptr-&gt;len
)paren
)paren
r_goto
id|out
suffix:semicolon
)brace
r_else
id|ctl.maxlen
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|datptr
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|dat
comma
id|datptr
comma
r_sizeof
(paren
r_struct
id|strbuf
)paren
)paren
op_logical_or
id|put_user
c_func
(paren
op_minus
l_int|1
comma
op_amp
id|datptr-&gt;len
)paren
)paren
r_goto
id|out
suffix:semicolon
)brace
r_else
id|dat.maxlen
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|flags
comma
id|flgptr
)paren
)paren
r_goto
id|out
suffix:semicolon
r_switch
c_cond
(paren
id|flags
)paren
(brace
r_case
l_int|0
suffix:colon
r_case
id|MSG_HIPRI
suffix:colon
r_case
id|MSG_ANY
suffix:colon
r_case
id|MSG_BAND
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|error
op_assign
id|timod_getmsg
c_func
(paren
id|fd
comma
(paren
r_char
op_star
)paren
id|A
c_func
(paren
id|ctl.buf
)paren
comma
id|ctl.maxlen
comma
op_amp
id|ctlptr-&gt;len
comma
(paren
r_char
op_star
)paren
id|A
c_func
(paren
id|dat.buf
)paren
comma
id|dat.maxlen
comma
op_amp
id|datptr-&gt;len
comma
op_amp
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
op_logical_and
id|put_user
c_func
(paren
id|flags
comma
id|flgptr
)paren
)paren
id|error
op_assign
op_minus
id|EFAULT
suffix:semicolon
id|out
suffix:colon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;done&quot;
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|solaris_putmsg
id|asmlinkage
r_int
id|solaris_putmsg
c_func
(paren
r_int
r_int
id|fd
comma
id|u32
id|arg1
comma
id|u32
id|arg2
comma
id|u32
id|arg3
)paren
(brace
r_struct
id|file
op_star
id|filp
suffix:semicolon
r_struct
id|inode
op_star
id|ino
suffix:semicolon
r_struct
id|strbuf
op_star
id|ctlptr
comma
op_star
id|datptr
suffix:semicolon
r_struct
id|strbuf
id|ctl
comma
id|dat
suffix:semicolon
r_int
id|flags
op_assign
(paren
r_int
)paren
id|arg3
suffix:semicolon
r_int
id|error
op_assign
op_minus
id|EBADF
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;entry&quot;
)paren
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fd
op_ge
id|NR_OPEN
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|filp
op_assign
id|current-&gt;files-&gt;fd
(braket
id|fd
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|filp
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|ino
op_assign
id|filp-&gt;f_dentry-&gt;d_inode
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ino
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ino-&gt;i_sock
op_logical_and
(paren
id|MAJOR
c_func
(paren
id|ino-&gt;i_rdev
)paren
op_ne
l_int|30
op_logical_or
id|MINOR
c_func
(paren
id|ino-&gt;i_rdev
)paren
op_ne
l_int|1
)paren
)paren
r_goto
id|out
suffix:semicolon
id|ctlptr
op_assign
(paren
r_struct
id|strbuf
op_star
)paren
id|A
c_func
(paren
id|arg1
)paren
suffix:semicolon
id|datptr
op_assign
(paren
r_struct
id|strbuf
op_star
)paren
id|A
c_func
(paren
id|arg2
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|ctlptr
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|ctl
comma
id|ctlptr
comma
r_sizeof
(paren
id|ctl
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|ctl.len
OL
l_int|0
op_logical_and
id|flags
)paren
(brace
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
r_else
(brace
id|ctl.len
op_assign
l_int|0
suffix:semicolon
id|ctl.buf
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|datptr
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|dat
comma
id|datptr
comma
r_sizeof
(paren
id|dat
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
)brace
r_else
(brace
id|dat.len
op_assign
l_int|0
suffix:semicolon
id|dat.buf
op_assign
l_int|0
suffix:semicolon
)brace
id|error
op_assign
id|timod_putmsg
c_func
(paren
id|fd
comma
(paren
r_char
op_star
)paren
id|A
c_func
(paren
id|ctl.buf
)paren
comma
id|ctl.len
comma
(paren
r_char
op_star
)paren
id|A
c_func
(paren
id|dat.buf
)paren
comma
id|dat.len
comma
id|flags
)paren
suffix:semicolon
id|out
suffix:colon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
id|SOLD
c_func
(paren
l_string|&quot;done&quot;
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
eof
