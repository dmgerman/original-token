multiline_comment|/* $Id: generic.c,v 1.14 2000/08/09 00:00:15 davem Exp $&n; * generic.c: Generic Sparc mm routines that are not dependent upon&n; *            MMU type but are Sparc specific.&n; *&n; * Copyright (C) 1996 David S. Miller (davem@caip.rutgers.edu)&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/swap.h&gt;
macro_line|#include &lt;asm/pgalloc.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/page.h&gt;
DECL|function|forget_pte
r_static
r_inline
r_void
id|forget_pte
c_func
(paren
id|pte_t
id|page
)paren
(brace
r_if
c_cond
(paren
id|pte_none
c_func
(paren
id|page
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|pte_present
c_func
(paren
id|page
)paren
)paren
(brace
r_struct
id|page
op_star
id|ptpage
op_assign
id|pte_page
c_func
(paren
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|VALID_PAGE
c_func
(paren
id|ptpage
)paren
)paren
op_logical_or
id|PageReserved
c_func
(paren
id|ptpage
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* &n;&t;&t; * free_page() used to be able to clear swap cache&n;&t;&t; * entries.  We may now have to do it manually.  &n;&t;&t; */
id|free_page_and_swap_cache
c_func
(paren
id|ptpage
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|swap_free
c_func
(paren
id|pte_to_swp_entry
c_func
(paren
id|page
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Remap IO memory, the same way as remap_page_range(), but use&n; * the obio memory space.&n; *&n; * They use a pgprot that sets PAGE_IO and does not check the&n; * mem_map table as this is independent of normal memory.&n; *&n; * As a special hack if the lowest bit of offset is set the&n; * side-effect bit will be turned off.  This is used as a&n; * performance improvement on FFB/AFB. -DaveM&n; */
DECL|function|io_remap_pte_range
r_static
r_inline
r_void
id|io_remap_pte_range
c_func
(paren
id|pte_t
op_star
id|pte
comma
r_int
r_int
id|address
comma
r_int
r_int
id|size
comma
r_int
r_int
id|offset
comma
id|pgprot_t
id|prot
comma
r_int
id|space
)paren
(brace
r_int
r_int
id|end
suffix:semicolon
id|address
op_and_assign
op_complement
id|PMD_MASK
suffix:semicolon
id|end
op_assign
id|address
op_plus
id|size
suffix:semicolon
r_if
c_cond
(paren
id|end
OG
id|PMD_SIZE
)paren
id|end
op_assign
id|PMD_SIZE
suffix:semicolon
r_do
(brace
id|pte_t
id|oldpage
suffix:semicolon
id|pte_t
id|entry
suffix:semicolon
r_int
r_int
id|curend
op_assign
id|address
op_plus
id|PAGE_SIZE
suffix:semicolon
id|entry
op_assign
id|mk_pte_io
c_func
(paren
(paren
id|offset
op_amp
op_complement
(paren
l_int|0x1UL
)paren
)paren
comma
id|prot
comma
id|space
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|address
op_amp
l_int|0xffff
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|address
op_amp
l_int|0x3fffff
)paren
op_logical_and
op_logical_neg
(paren
id|offset
op_amp
l_int|0x3ffffe
)paren
op_logical_and
id|end
op_ge
id|address
op_plus
l_int|0x400000
)paren
(brace
id|entry
op_assign
id|mk_pte_io
c_func
(paren
(paren
id|offset
op_amp
op_complement
(paren
l_int|0x1UL
)paren
)paren
comma
id|__pgprot
c_func
(paren
id|pgprot_val
(paren
id|prot
)paren
op_or
id|_PAGE_SZ4MB
)paren
comma
id|space
)paren
suffix:semicolon
id|curend
op_assign
id|address
op_plus
l_int|0x400000
suffix:semicolon
id|offset
op_add_assign
l_int|0x400000
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|address
op_amp
l_int|0x7ffff
)paren
op_logical_and
op_logical_neg
(paren
id|offset
op_amp
l_int|0x7fffe
)paren
op_logical_and
id|end
op_ge
id|address
op_plus
l_int|0x80000
)paren
(brace
id|entry
op_assign
id|mk_pte_io
c_func
(paren
(paren
id|offset
op_amp
op_complement
(paren
l_int|0x1UL
)paren
)paren
comma
id|__pgprot
c_func
(paren
id|pgprot_val
(paren
id|prot
)paren
op_or
id|_PAGE_SZ512K
)paren
comma
id|space
)paren
suffix:semicolon
id|curend
op_assign
id|address
op_plus
l_int|0x80000
suffix:semicolon
id|offset
op_add_assign
l_int|0x80000
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|offset
op_amp
l_int|0xfffe
)paren
op_logical_and
id|end
op_ge
id|address
op_plus
l_int|0x10000
)paren
(brace
id|entry
op_assign
id|mk_pte_io
c_func
(paren
(paren
id|offset
op_amp
op_complement
(paren
l_int|0x1UL
)paren
)paren
comma
id|__pgprot
c_func
(paren
id|pgprot_val
(paren
id|prot
)paren
op_or
id|_PAGE_SZ64K
)paren
comma
id|space
)paren
suffix:semicolon
id|curend
op_assign
id|address
op_plus
l_int|0x10000
suffix:semicolon
id|offset
op_add_assign
l_int|0x10000
suffix:semicolon
)brace
r_else
id|offset
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
r_else
id|offset
op_add_assign
id|PAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_amp
l_int|0x1UL
)paren
id|pte_val
c_func
(paren
id|entry
)paren
op_and_assign
op_complement
(paren
id|_PAGE_E
)paren
suffix:semicolon
r_do
(brace
id|oldpage
op_assign
op_star
id|pte
suffix:semicolon
id|pte_clear
c_func
(paren
id|pte
)paren
suffix:semicolon
id|set_pte
c_func
(paren
id|pte
comma
id|entry
)paren
suffix:semicolon
id|forget_pte
c_func
(paren
id|oldpage
)paren
suffix:semicolon
id|address
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|pte
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|address
OL
id|curend
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|address
OL
id|end
)paren
suffix:semicolon
)brace
DECL|function|io_remap_pmd_range
r_static
r_inline
r_int
id|io_remap_pmd_range
c_func
(paren
id|pmd_t
op_star
id|pmd
comma
r_int
r_int
id|address
comma
r_int
r_int
id|size
comma
r_int
r_int
id|offset
comma
id|pgprot_t
id|prot
comma
r_int
id|space
)paren
(brace
r_int
r_int
id|end
suffix:semicolon
id|address
op_and_assign
op_complement
id|PGDIR_MASK
suffix:semicolon
id|end
op_assign
id|address
op_plus
id|size
suffix:semicolon
r_if
c_cond
(paren
id|end
OG
id|PGDIR_SIZE
)paren
id|end
op_assign
id|PGDIR_SIZE
suffix:semicolon
id|offset
op_sub_assign
id|address
suffix:semicolon
r_do
(brace
id|pte_t
op_star
id|pte
op_assign
id|pte_alloc
c_func
(paren
id|pmd
comma
id|address
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pte
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|current-&gt;mm-&gt;page_table_lock
)paren
suffix:semicolon
id|io_remap_pte_range
c_func
(paren
id|pte
comma
id|address
comma
id|end
op_minus
id|address
comma
id|address
op_plus
id|offset
comma
id|prot
comma
id|space
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|current-&gt;mm-&gt;page_table_lock
)paren
suffix:semicolon
id|address
op_assign
(paren
id|address
op_plus
id|PMD_SIZE
)paren
op_amp
id|PMD_MASK
suffix:semicolon
id|pmd
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|address
OL
id|end
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|io_remap_page_range
r_int
id|io_remap_page_range
c_func
(paren
r_int
r_int
id|from
comma
r_int
r_int
id|offset
comma
r_int
r_int
id|size
comma
id|pgprot_t
id|prot
comma
r_int
id|space
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
id|pgd_t
op_star
id|dir
suffix:semicolon
r_int
r_int
id|beg
op_assign
id|from
suffix:semicolon
r_int
r_int
id|end
op_assign
id|from
op_plus
id|size
suffix:semicolon
id|prot
op_assign
id|__pgprot
c_func
(paren
id|pg_iobits
)paren
suffix:semicolon
id|offset
op_sub_assign
id|from
suffix:semicolon
id|dir
op_assign
id|pgd_offset
c_func
(paren
id|current-&gt;mm
comma
id|from
)paren
suffix:semicolon
id|flush_cache_range
c_func
(paren
id|current-&gt;mm
comma
id|beg
comma
id|end
)paren
suffix:semicolon
r_while
c_loop
(paren
id|from
OL
id|end
)paren
(brace
id|pmd_t
op_star
id|pmd
op_assign
id|pmd_alloc
c_func
(paren
id|dir
comma
id|from
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pmd
)paren
r_break
suffix:semicolon
id|error
op_assign
id|io_remap_pmd_range
c_func
(paren
id|pmd
comma
id|from
comma
id|end
op_minus
id|from
comma
id|offset
op_plus
id|from
comma
id|prot
comma
id|space
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_break
suffix:semicolon
id|from
op_assign
(paren
id|from
op_plus
id|PGDIR_SIZE
)paren
op_amp
id|PGDIR_MASK
suffix:semicolon
id|dir
op_increment
suffix:semicolon
)brace
id|flush_tlb_range
c_func
(paren
id|current-&gt;mm
comma
id|beg
comma
id|end
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
eof
