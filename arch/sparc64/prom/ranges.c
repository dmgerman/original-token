multiline_comment|/* $Id: ranges.c,v 1.12 1999/08/31 06:55:05 davem Exp $&n; * ranges.c: Handle ranges in newer proms for obio/sbus.&n; *&n; * Copyright (C) 1995 David S. Miller (davem@caip.rutgers.edu)&n; * Copyright (C) 1997 Jakub Jelinek (jj@sunsite.mff.cuni.cz)&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/openprom.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/sbus.h&gt;
macro_line|#include &lt;asm/fhc.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#ifdef CONFIG_PCI
macro_line|#include &lt;asm/pbm.h&gt;
macro_line|#include &lt;asm/ebus.h&gt;
macro_line|#endif
DECL|variable|promlib_obio_ranges
r_struct
id|linux_prom_ranges
id|promlib_obio_ranges
(braket
id|PROMREG_MAX
)braket
suffix:semicolon
DECL|variable|num_obio_ranges
r_int
id|num_obio_ranges
suffix:semicolon
multiline_comment|/* Adjust register values based upon the ranges parameters. */
r_inline
r_void
DECL|function|prom_adjust_regs
id|prom_adjust_regs
c_func
(paren
r_struct
id|linux_prom_registers
op_star
id|regp
comma
r_int
id|nregs
comma
r_struct
id|linux_prom_ranges
op_star
id|rangep
comma
r_int
id|nranges
)paren
(brace
r_int
id|regc
comma
id|rngc
suffix:semicolon
r_for
c_loop
(paren
id|regc
op_assign
l_int|0
suffix:semicolon
id|regc
OL
id|nregs
suffix:semicolon
id|regc
op_increment
)paren
(brace
r_for
c_loop
(paren
id|rngc
op_assign
l_int|0
suffix:semicolon
id|rngc
OL
id|nranges
suffix:semicolon
id|rngc
op_increment
)paren
r_if
c_cond
(paren
id|regp
(braket
id|regc
)braket
dot
id|which_io
op_eq
id|rangep
(braket
id|rngc
)braket
dot
id|ot_child_space
)paren
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/* Fount it */
r_if
c_cond
(paren
id|rngc
op_eq
id|nranges
)paren
(brace
multiline_comment|/* oops */
id|prom_printf
c_func
(paren
l_string|&quot;adjust_regs: Could not find range with matching bus type...&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|regp
(braket
id|regc
)braket
dot
id|which_io
op_assign
id|rangep
(braket
id|rngc
)braket
dot
id|ot_parent_space
suffix:semicolon
id|regp
(braket
id|regc
)braket
dot
id|phys_addr
op_add_assign
id|rangep
(braket
id|rngc
)braket
dot
id|ot_parent_base
suffix:semicolon
)brace
)brace
r_inline
r_void
DECL|function|prom_adjust_ranges
id|prom_adjust_ranges
c_func
(paren
r_struct
id|linux_prom_ranges
op_star
id|ranges1
comma
r_int
id|nranges1
comma
r_struct
id|linux_prom_ranges
op_star
id|ranges2
comma
r_int
id|nranges2
)paren
(brace
r_int
id|rng1c
comma
id|rng2c
suffix:semicolon
r_for
c_loop
(paren
id|rng1c
op_assign
l_int|0
suffix:semicolon
id|rng1c
OL
id|nranges1
suffix:semicolon
id|rng1c
op_increment
)paren
(brace
r_for
c_loop
(paren
id|rng2c
op_assign
l_int|0
suffix:semicolon
id|rng2c
OL
id|nranges2
suffix:semicolon
id|rng2c
op_increment
)paren
r_if
c_cond
(paren
id|ranges1
(braket
id|rng1c
)braket
dot
id|ot_child_space
op_eq
id|ranges2
(braket
id|rng2c
)braket
dot
id|ot_child_space
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rng2c
op_eq
id|nranges2
)paren
(brace
multiline_comment|/* oops */
id|prom_printf
c_func
(paren
l_string|&quot;adjust_ranges: Could not find matching bus type...&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|ranges1
(braket
id|rng1c
)braket
dot
id|ot_parent_space
op_assign
id|ranges2
(braket
id|rng2c
)braket
dot
id|ot_parent_space
suffix:semicolon
id|ranges1
(braket
id|rng1c
)braket
dot
id|ot_parent_base
op_add_assign
id|ranges2
(braket
id|rng2c
)braket
dot
id|ot_parent_base
suffix:semicolon
)brace
)brace
multiline_comment|/* Apply probed sbus ranges to registers passed, if no ranges return. */
DECL|function|prom_apply_sbus_ranges
r_void
id|prom_apply_sbus_ranges
c_func
(paren
r_struct
id|linux_sbus
op_star
id|sbus
comma
r_struct
id|linux_prom_registers
op_star
id|regs
comma
r_int
id|nregs
comma
r_struct
id|linux_sbus_device
op_star
id|sdev
)paren
(brace
r_if
c_cond
(paren
id|sbus-&gt;num_sbus_ranges
)paren
(brace
r_if
c_cond
(paren
id|sdev
op_logical_and
(paren
id|sdev-&gt;ranges_applied
op_eq
l_int|0
)paren
)paren
(brace
id|sdev-&gt;ranges_applied
op_assign
l_int|1
suffix:semicolon
id|prom_adjust_regs
c_func
(paren
id|regs
comma
id|nregs
comma
id|sbus-&gt;sbus_ranges
comma
id|sbus-&gt;num_sbus_ranges
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Apply probed fhc ranges to registers passed, if no ranges return. */
DECL|function|prom_apply_fhc_ranges
r_void
id|prom_apply_fhc_ranges
c_func
(paren
r_struct
id|linux_fhc
op_star
id|fhc
comma
r_struct
id|linux_prom_registers
op_star
id|regs
comma
r_int
id|nregs
)paren
(brace
r_if
c_cond
(paren
id|fhc-&gt;num_fhc_ranges
)paren
(brace
id|prom_adjust_regs
c_func
(paren
id|regs
comma
id|nregs
comma
id|fhc-&gt;fhc_ranges
comma
id|fhc-&gt;num_fhc_ranges
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Apply probed central ranges to registers passed, if no ranges return. */
DECL|function|prom_apply_central_ranges
r_void
id|prom_apply_central_ranges
c_func
(paren
r_struct
id|linux_central
op_star
id|central
comma
r_struct
id|linux_prom_registers
op_star
id|regs
comma
r_int
id|nregs
)paren
(brace
r_if
c_cond
(paren
id|central-&gt;num_central_ranges
)paren
(brace
id|prom_adjust_regs
c_func
(paren
id|regs
comma
id|nregs
comma
id|central-&gt;central_ranges
comma
id|central-&gt;num_central_ranges
)paren
suffix:semicolon
)brace
)brace
DECL|function|prom_ranges_init
r_void
id|__init
id|prom_ranges_init
c_func
(paren
r_void
)paren
(brace
)brace
DECL|function|prom_sbus_ranges_init
r_void
id|__init
id|prom_sbus_ranges_init
c_func
(paren
r_int
id|iommund
comma
r_struct
id|linux_sbus
op_star
id|sbus
)paren
(brace
r_int
id|success
suffix:semicolon
id|sbus-&gt;num_sbus_ranges
op_assign
l_int|0
suffix:semicolon
id|success
op_assign
id|prom_getproperty
c_func
(paren
id|sbus-&gt;prom_node
comma
l_string|&quot;ranges&quot;
comma
(paren
r_char
op_star
)paren
id|sbus-&gt;sbus_ranges
comma
r_sizeof
(paren
id|sbus-&gt;sbus_ranges
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|success
op_ne
op_minus
l_int|1
)paren
id|sbus-&gt;num_sbus_ranges
op_assign
(paren
id|success
op_div
r_sizeof
(paren
r_struct
id|linux_prom_ranges
)paren
)paren
suffix:semicolon
)brace
DECL|function|prom_central_ranges_init
r_void
id|__init
id|prom_central_ranges_init
c_func
(paren
r_int
id|cnode
comma
r_struct
id|linux_central
op_star
id|central
)paren
(brace
r_int
id|success
suffix:semicolon
id|central-&gt;num_central_ranges
op_assign
l_int|0
suffix:semicolon
id|success
op_assign
id|prom_getproperty
c_func
(paren
id|central-&gt;prom_node
comma
l_string|&quot;ranges&quot;
comma
(paren
r_char
op_star
)paren
id|central-&gt;central_ranges
comma
r_sizeof
(paren
id|central-&gt;central_ranges
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|success
op_ne
op_minus
l_int|1
)paren
id|central-&gt;num_central_ranges
op_assign
(paren
id|success
op_div
r_sizeof
(paren
r_struct
id|linux_prom_ranges
)paren
)paren
suffix:semicolon
)brace
DECL|function|prom_fhc_ranges_init
r_void
id|__init
id|prom_fhc_ranges_init
c_func
(paren
r_int
id|fnode
comma
r_struct
id|linux_fhc
op_star
id|fhc
)paren
(brace
r_int
id|success
suffix:semicolon
id|fhc-&gt;num_fhc_ranges
op_assign
l_int|0
suffix:semicolon
id|success
op_assign
id|prom_getproperty
c_func
(paren
id|fhc-&gt;prom_node
comma
l_string|&quot;ranges&quot;
comma
(paren
r_char
op_star
)paren
id|fhc-&gt;fhc_ranges
comma
r_sizeof
(paren
id|fhc-&gt;fhc_ranges
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|success
op_ne
op_minus
l_int|1
)paren
id|fhc-&gt;num_fhc_ranges
op_assign
(paren
id|success
op_div
r_sizeof
(paren
r_struct
id|linux_prom_ranges
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PCI
DECL|function|prom_ebus_ranges_init
r_void
id|__init
id|prom_ebus_ranges_init
c_func
(paren
r_struct
id|linux_ebus
op_star
id|ebus
)paren
(brace
r_int
id|success
suffix:semicolon
id|ebus-&gt;num_ebus_ranges
op_assign
l_int|0
suffix:semicolon
id|success
op_assign
id|prom_getproperty
c_func
(paren
id|ebus-&gt;prom_node
comma
l_string|&quot;ranges&quot;
comma
(paren
r_char
op_star
)paren
id|ebus-&gt;ebus_ranges
comma
r_sizeof
(paren
id|ebus-&gt;ebus_ranges
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|success
op_ne
op_minus
l_int|1
)paren
id|ebus-&gt;num_ebus_ranges
op_assign
(paren
id|success
op_div
r_sizeof
(paren
r_struct
id|linux_prom_ebus_ranges
)paren
)paren
suffix:semicolon
)brace
DECL|function|prom_ebus_intmap_init
r_void
id|__init
id|prom_ebus_intmap_init
c_func
(paren
r_struct
id|linux_ebus
op_star
id|ebus
)paren
(brace
r_int
id|success
suffix:semicolon
id|ebus-&gt;num_ebus_intmap
op_assign
l_int|0
suffix:semicolon
id|success
op_assign
id|prom_getproperty
c_func
(paren
id|ebus-&gt;prom_node
comma
l_string|&quot;interrupt-map&quot;
comma
(paren
r_char
op_star
)paren
id|ebus-&gt;ebus_intmap
comma
r_sizeof
(paren
id|ebus-&gt;ebus_intmap
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|success
op_eq
op_minus
l_int|1
)paren
r_return
suffix:semicolon
id|ebus-&gt;num_ebus_intmap
op_assign
(paren
id|success
op_div
r_sizeof
(paren
r_struct
id|linux_prom_ebus_intmap
)paren
)paren
suffix:semicolon
id|success
op_assign
id|prom_getproperty
c_func
(paren
id|ebus-&gt;prom_node
comma
l_string|&quot;interrupt-map-mask&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|ebus-&gt;ebus_intmask
comma
r_sizeof
(paren
id|ebus-&gt;ebus_intmask
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|success
op_eq
op_minus
l_int|1
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;%s: can&squot;t get interrupt-map-mask&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
r_void
DECL|function|prom_apply_generic_ranges
id|prom_apply_generic_ranges
(paren
r_int
id|node
comma
r_int
id|parent
comma
r_struct
id|linux_prom_registers
op_star
id|regs
comma
r_int
id|nregs
)paren
(brace
r_int
id|success
suffix:semicolon
r_int
id|num_ranges
suffix:semicolon
r_struct
id|linux_prom_ranges
id|ranges
(braket
id|PROMREG_MAX
)braket
suffix:semicolon
id|success
op_assign
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;ranges&quot;
comma
(paren
r_char
op_star
)paren
id|ranges
comma
r_sizeof
(paren
id|ranges
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|success
op_ne
op_minus
l_int|1
)paren
(brace
id|num_ranges
op_assign
(paren
id|success
op_div
r_sizeof
(paren
r_struct
id|linux_prom_ranges
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|parent
)paren
(brace
r_struct
id|linux_prom_ranges
id|parent_ranges
(braket
id|PROMREG_MAX
)braket
suffix:semicolon
r_int
id|num_parent_ranges
suffix:semicolon
id|success
op_assign
id|prom_getproperty
c_func
(paren
id|parent
comma
l_string|&quot;ranges&quot;
comma
(paren
r_char
op_star
)paren
id|parent_ranges
comma
r_sizeof
(paren
id|parent_ranges
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|success
op_ne
op_minus
l_int|1
)paren
(brace
id|num_parent_ranges
op_assign
(paren
id|success
op_div
r_sizeof
(paren
r_struct
id|linux_prom_ranges
)paren
)paren
suffix:semicolon
id|prom_adjust_ranges
(paren
id|ranges
comma
id|num_ranges
comma
id|parent_ranges
comma
id|num_parent_ranges
)paren
suffix:semicolon
)brace
)brace
id|prom_adjust_regs
c_func
(paren
id|regs
comma
id|nregs
comma
id|ranges
comma
id|num_ranges
)paren
suffix:semicolon
)brace
)brace
eof
