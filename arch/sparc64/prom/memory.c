multiline_comment|/* $Id: memory.c,v 1.5 1999/08/31 06:55:04 davem Exp $&n; * memory.c: Prom routine for acquiring various bits of information&n; *           about RAM on the machine, both virtual and physical.&n; *&n; * Copyright (C) 1995 David S. Miller (davem@caip.rutgers.edu)&n; * Copyright (C) 1997 Jakub Jelinek (jj@sunsite.mff.cuni.cz)&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/openprom.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
multiline_comment|/* This routine, for consistency, returns the ram parameters in the&n; * V0 prom memory descriptor format.  I choose this format because I&n; * think it was the easiest to work with.  I feel the religious&n; * arguments now... ;)  Also, I return the linked lists sorted to&n; * prevent paging_init() upset stomach as I have not yet written&n; * the pepto-bismol kernel module yet.&n; */
DECL|variable|prom_reg_memlist
r_struct
id|linux_prom64_registers
id|prom_reg_memlist
(braket
l_int|64
)braket
suffix:semicolon
DECL|variable|prom_reg_tmp
r_struct
id|linux_prom64_registers
id|prom_reg_tmp
(braket
l_int|64
)braket
suffix:semicolon
DECL|variable|prom_phys_total
r_struct
id|linux_mlist_p1275
id|prom_phys_total
(braket
l_int|64
)braket
suffix:semicolon
DECL|variable|prom_prom_taken
r_struct
id|linux_mlist_p1275
id|prom_prom_taken
(braket
l_int|64
)braket
suffix:semicolon
DECL|variable|prom_phys_avail
r_struct
id|linux_mlist_p1275
id|prom_phys_avail
(braket
l_int|64
)braket
suffix:semicolon
DECL|variable|prom_ptot_ptr
r_struct
id|linux_mlist_p1275
op_star
id|prom_ptot_ptr
op_assign
id|prom_phys_total
suffix:semicolon
DECL|variable|prom_ptak_ptr
r_struct
id|linux_mlist_p1275
op_star
id|prom_ptak_ptr
op_assign
id|prom_prom_taken
suffix:semicolon
DECL|variable|prom_pavl_ptr
r_struct
id|linux_mlist_p1275
op_star
id|prom_pavl_ptr
op_assign
id|prom_phys_avail
suffix:semicolon
DECL|variable|prom_memlist
r_struct
id|linux_mem_p1275
id|prom_memlist
suffix:semicolon
multiline_comment|/* Internal Prom library routine to sort a linux_mlist_p1275 memory&n; * list.  Used below in initialization.&n; */
r_static
r_void
id|__init
DECL|function|prom_sortmemlist
id|prom_sortmemlist
c_func
(paren
r_struct
id|linux_mlist_p1275
op_star
id|thislist
)paren
(brace
r_int
id|swapi
op_assign
l_int|0
suffix:semicolon
r_int
id|i
comma
id|mitr
suffix:semicolon
r_int
r_int
id|tmpaddr
comma
id|tmpsize
suffix:semicolon
r_int
r_int
id|lowest
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|thislist
(braket
id|i
)braket
dot
id|theres_more
op_ne
l_int|0
suffix:semicolon
id|i
op_increment
)paren
(brace
id|lowest
op_assign
id|thislist
(braket
id|i
)braket
dot
id|start_adr
suffix:semicolon
r_for
c_loop
(paren
id|mitr
op_assign
id|i
op_plus
l_int|1
suffix:semicolon
id|thislist
(braket
id|mitr
op_minus
l_int|1
)braket
dot
id|theres_more
op_ne
l_int|0
suffix:semicolon
id|mitr
op_increment
)paren
r_if
c_cond
(paren
id|thislist
(braket
id|mitr
)braket
dot
id|start_adr
OL
id|lowest
)paren
(brace
id|lowest
op_assign
id|thislist
(braket
id|mitr
)braket
dot
id|start_adr
suffix:semicolon
id|swapi
op_assign
id|mitr
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lowest
op_eq
id|thislist
(braket
id|i
)braket
dot
id|start_adr
)paren
(brace
r_continue
suffix:semicolon
)brace
id|tmpaddr
op_assign
id|thislist
(braket
id|swapi
)braket
dot
id|start_adr
suffix:semicolon
id|tmpsize
op_assign
id|thislist
(braket
id|swapi
)braket
dot
id|num_bytes
suffix:semicolon
r_for
c_loop
(paren
id|mitr
op_assign
id|swapi
suffix:semicolon
id|mitr
OG
id|i
suffix:semicolon
id|mitr
op_decrement
)paren
(brace
id|thislist
(braket
id|mitr
)braket
dot
id|start_adr
op_assign
id|thislist
(braket
id|mitr
op_minus
l_int|1
)braket
dot
id|start_adr
suffix:semicolon
id|thislist
(braket
id|mitr
)braket
dot
id|num_bytes
op_assign
id|thislist
(braket
id|mitr
op_minus
l_int|1
)braket
dot
id|num_bytes
suffix:semicolon
)brace
id|thislist
(braket
id|i
)braket
dot
id|start_adr
op_assign
id|tmpaddr
suffix:semicolon
id|thislist
(braket
id|i
)braket
dot
id|num_bytes
op_assign
id|tmpsize
suffix:semicolon
)brace
)brace
multiline_comment|/* Initialize the memory lists based upon the prom version. */
DECL|function|prom_meminit
r_void
id|__init
id|prom_meminit
c_func
(paren
r_void
)paren
(brace
r_int
id|node
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|iter
comma
id|num_regs
suffix:semicolon
id|node
op_assign
id|prom_finddevice
c_func
(paren
l_string|&quot;/memory&quot;
)paren
suffix:semicolon
id|num_regs
op_assign
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;available&quot;
comma
(paren
r_char
op_star
)paren
id|prom_reg_memlist
comma
r_sizeof
(paren
id|prom_reg_memlist
)paren
)paren
suffix:semicolon
id|num_regs
op_assign
(paren
id|num_regs
op_div
r_sizeof
(paren
r_struct
id|linux_prom64_registers
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|iter
op_assign
l_int|0
suffix:semicolon
id|iter
OL
id|num_regs
suffix:semicolon
id|iter
op_increment
)paren
(brace
id|prom_phys_avail
(braket
id|iter
)braket
dot
id|start_adr
op_assign
id|prom_reg_memlist
(braket
id|iter
)braket
dot
id|phys_addr
suffix:semicolon
id|prom_phys_avail
(braket
id|iter
)braket
dot
id|num_bytes
op_assign
id|prom_reg_memlist
(braket
id|iter
)braket
dot
id|reg_size
suffix:semicolon
id|prom_phys_avail
(braket
id|iter
)braket
dot
id|theres_more
op_assign
op_amp
id|prom_phys_avail
(braket
id|iter
op_plus
l_int|1
)braket
suffix:semicolon
)brace
id|prom_phys_avail
(braket
id|iter
op_minus
l_int|1
)braket
dot
id|theres_more
op_assign
l_int|0x0
suffix:semicolon
id|num_regs
op_assign
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;reg&quot;
comma
(paren
r_char
op_star
)paren
id|prom_reg_memlist
comma
r_sizeof
(paren
id|prom_reg_memlist
)paren
)paren
suffix:semicolon
id|num_regs
op_assign
(paren
id|num_regs
op_div
r_sizeof
(paren
r_struct
id|linux_prom64_registers
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|iter
op_assign
l_int|0
suffix:semicolon
id|iter
OL
id|num_regs
suffix:semicolon
id|iter
op_increment
)paren
(brace
id|prom_phys_total
(braket
id|iter
)braket
dot
id|start_adr
op_assign
id|prom_reg_memlist
(braket
id|iter
)braket
dot
id|phys_addr
suffix:semicolon
id|prom_phys_total
(braket
id|iter
)braket
dot
id|num_bytes
op_assign
id|prom_reg_memlist
(braket
id|iter
)braket
dot
id|reg_size
suffix:semicolon
id|prom_phys_total
(braket
id|iter
)braket
dot
id|theres_more
op_assign
op_amp
id|prom_phys_total
(braket
id|iter
op_plus
l_int|1
)braket
suffix:semicolon
)brace
id|prom_phys_total
(braket
id|iter
op_minus
l_int|1
)braket
dot
id|theres_more
op_assign
l_int|0x0
suffix:semicolon
id|node
op_assign
id|prom_finddevice
c_func
(paren
l_string|&quot;/virtual-memory&quot;
)paren
suffix:semicolon
id|num_regs
op_assign
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;available&quot;
comma
(paren
r_char
op_star
)paren
id|prom_reg_memlist
comma
r_sizeof
(paren
id|prom_reg_memlist
)paren
)paren
suffix:semicolon
id|num_regs
op_assign
(paren
id|num_regs
op_div
r_sizeof
(paren
r_struct
id|linux_prom64_registers
)paren
)paren
suffix:semicolon
multiline_comment|/* Convert available virtual areas to taken virtual&n;&t; * areas.  First sort, then convert.&n;&t; */
r_for
c_loop
(paren
id|iter
op_assign
l_int|0
suffix:semicolon
id|iter
OL
id|num_regs
suffix:semicolon
id|iter
op_increment
)paren
(brace
id|prom_prom_taken
(braket
id|iter
)braket
dot
id|start_adr
op_assign
id|prom_reg_memlist
(braket
id|iter
)braket
dot
id|phys_addr
suffix:semicolon
id|prom_prom_taken
(braket
id|iter
)braket
dot
id|num_bytes
op_assign
id|prom_reg_memlist
(braket
id|iter
)braket
dot
id|reg_size
suffix:semicolon
id|prom_prom_taken
(braket
id|iter
)braket
dot
id|theres_more
op_assign
op_amp
id|prom_phys_total
(braket
id|iter
op_plus
l_int|1
)braket
suffix:semicolon
)brace
id|prom_prom_taken
(braket
id|iter
op_minus
l_int|1
)braket
dot
id|theres_more
op_assign
l_int|0x0
suffix:semicolon
id|prom_sortmemlist
c_func
(paren
id|prom_prom_taken
)paren
suffix:semicolon
multiline_comment|/* Finally, convert. */
r_for
c_loop
(paren
id|iter
op_assign
l_int|0
suffix:semicolon
id|iter
OL
id|num_regs
suffix:semicolon
id|iter
op_increment
)paren
(brace
id|prom_prom_taken
(braket
id|iter
)braket
dot
id|start_adr
op_assign
id|prom_prom_taken
(braket
id|iter
)braket
dot
id|start_adr
op_plus
id|prom_prom_taken
(braket
id|iter
)braket
dot
id|num_bytes
suffix:semicolon
id|prom_prom_taken
(braket
id|iter
)braket
dot
id|num_bytes
op_assign
id|prom_prom_taken
(braket
id|iter
op_plus
l_int|1
)braket
dot
id|start_adr
op_minus
id|prom_prom_taken
(braket
id|iter
)braket
dot
id|start_adr
suffix:semicolon
)brace
id|prom_prom_taken
(braket
id|iter
op_minus
l_int|1
)braket
dot
id|num_bytes
op_assign
op_minus
l_int|1UL
op_minus
id|prom_prom_taken
(braket
id|iter
op_minus
l_int|1
)braket
dot
id|start_adr
suffix:semicolon
multiline_comment|/* Sort the other two lists. */
id|prom_sortmemlist
c_func
(paren
id|prom_phys_total
)paren
suffix:semicolon
id|prom_sortmemlist
c_func
(paren
id|prom_phys_avail
)paren
suffix:semicolon
multiline_comment|/* Link all the lists into the top-level descriptor. */
id|prom_memlist.p1275_totphys
op_assign
op_amp
id|prom_ptot_ptr
suffix:semicolon
id|prom_memlist.p1275_prommap
op_assign
op_amp
id|prom_ptak_ptr
suffix:semicolon
id|prom_memlist.p1275_available
op_assign
op_amp
id|prom_pavl_ptr
suffix:semicolon
)brace
multiline_comment|/* This returns a pointer to our libraries internal p1275 format&n; * memory descriptor.&n; */
r_struct
id|linux_mem_p1275
op_star
DECL|function|prom_meminfo
id|prom_meminfo
c_func
(paren
r_void
)paren
(brace
r_return
op_amp
id|prom_memlist
suffix:semicolon
)brace
eof
