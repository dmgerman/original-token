multiline_comment|/* $Id: misc.c,v 1.19 2000/06/30 10:18:38 davem Exp $&n; * misc.c:  Miscellaneous prom functions that don&squot;t belong&n; *          anywhere else.&n; *&n; * Copyright (C) 1995 David S. Miller (davem@caip.rutgers.edu)&n; * Copyright (C) 1996,1997 Jakub Jelinek (jj@sunsite.mff.cuni.cz)&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/openprom.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
multiline_comment|/* Reset and reboot the machine with the command &squot;bcommand&squot;. */
r_void
DECL|function|prom_reboot
id|prom_reboot
c_func
(paren
r_char
op_star
id|bcommand
)paren
(brace
id|p1275_cmd
(paren
l_string|&quot;boot&quot;
comma
id|P1275_ARG
c_func
(paren
l_int|0
comma
id|P1275_ARG_IN_STRING
)paren
op_or
id|P1275_INOUT
c_func
(paren
l_int|1
comma
l_int|0
)paren
comma
id|bcommand
)paren
suffix:semicolon
)brace
multiline_comment|/* Forth evaluate the expression contained in &squot;fstring&squot;. */
r_void
DECL|function|prom_feval
id|prom_feval
c_func
(paren
r_char
op_star
id|fstring
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|fstring
op_logical_or
id|fstring
(braket
l_int|0
)braket
op_eq
l_int|0
)paren
(brace
r_return
suffix:semicolon
)brace
id|p1275_cmd
(paren
l_string|&quot;interpret&quot;
comma
id|P1275_ARG
c_func
(paren
l_int|0
comma
id|P1275_ARG_IN_STRING
)paren
op_or
id|P1275_INOUT
c_func
(paren
l_int|1
comma
l_int|1
)paren
comma
id|fstring
)paren
suffix:semicolon
)brace
multiline_comment|/* We want to do this more nicely some day. */
macro_line|#ifdef CONFIG_SUN_CONSOLE
r_extern
r_void
(paren
op_star
id|prom_palette
)paren
(paren
r_int
)paren
suffix:semicolon
r_extern
r_int
id|serial_console
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_SMP
r_extern
r_void
id|smp_capture
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|smp_release
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Drop into the prom, with the chance to continue with the &squot;go&squot;&n; * prom command.&n; */
r_void
DECL|function|prom_cmdline
id|prom_cmdline
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|__save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SUN_CONSOLE
r_if
c_cond
(paren
op_logical_neg
id|serial_console
op_logical_and
id|prom_palette
)paren
(brace
id|prom_palette
(paren
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* We always arrive here via a serial interrupt.&n;&t; * So in order for everything to work reliably, even&n;&t; * on SMP, we need to drop the IRQ locks we hold.&n;&t; */
macro_line|#ifdef CONFIG_SMP
id|irq_exit
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
comma
l_int|0
)paren
suffix:semicolon
id|smp_capture
c_func
(paren
)paren
suffix:semicolon
macro_line|#else
id|local_irq_count
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
)paren
op_decrement
suffix:semicolon
macro_line|#endif
id|p1275_cmd
(paren
l_string|&quot;enter&quot;
comma
id|P1275_INOUT
c_func
(paren
l_int|0
comma
l_int|0
)paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
id|smp_release
c_func
(paren
)paren
suffix:semicolon
id|irq_enter
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
comma
l_int|0
)paren
suffix:semicolon
id|spin_unlock_wait
c_func
(paren
op_amp
id|__br_write_locks
(braket
id|BR_GLOBALIRQ_LOCK
)braket
dot
id|lock
)paren
suffix:semicolon
macro_line|#else
id|local_irq_count
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
)paren
op_increment
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_SUN_CONSOLE
r_if
c_cond
(paren
op_logical_neg
id|serial_console
op_logical_and
id|prom_palette
)paren
(brace
id|prom_palette
(paren
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif
id|__restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SMP
r_extern
r_void
id|smp_promstop_others
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Drop into the prom, but completely terminate the program.&n; * No chance of continuing.&n; */
r_void
DECL|function|prom_halt
id|prom_halt
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_SMP
id|smp_promstop_others
c_func
(paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|8000
)paren
suffix:semicolon
macro_line|#endif
id|again
suffix:colon
id|p1275_cmd
(paren
l_string|&quot;exit&quot;
comma
id|P1275_INOUT
c_func
(paren
l_int|0
comma
l_int|0
)paren
)paren
suffix:semicolon
r_goto
id|again
suffix:semicolon
multiline_comment|/* PROM is out to get me -DaveM */
)brace
multiline_comment|/* Set prom sync handler to call function &squot;funcp&squot;. */
r_void
DECL|function|prom_setcallback
id|prom_setcallback
c_func
(paren
id|callback_func_t
id|funcp
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|funcp
)paren
(brace
r_return
suffix:semicolon
)brace
id|p1275_cmd
(paren
l_string|&quot;set-callback&quot;
comma
id|P1275_ARG
c_func
(paren
l_int|0
comma
id|P1275_ARG_IN_FUNCTION
)paren
op_or
id|P1275_INOUT
c_func
(paren
l_int|1
comma
l_int|1
)paren
comma
id|funcp
)paren
suffix:semicolon
)brace
multiline_comment|/* Get the idprom and stuff it into buffer &squot;idbuf&squot;.  Returns the&n; * format type.  &squot;num_bytes&squot; is the number of bytes that your idbuf&n; * has space for.  Returns 0xff on error.&n; */
r_int
r_char
DECL|function|prom_get_idprom
id|prom_get_idprom
c_func
(paren
r_char
op_star
id|idbuf
comma
r_int
id|num_bytes
)paren
(brace
r_int
id|len
suffix:semicolon
id|len
op_assign
id|prom_getproplen
c_func
(paren
id|prom_root_node
comma
l_string|&quot;idprom&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
OG
id|num_bytes
)paren
op_logical_or
(paren
id|len
op_eq
op_minus
l_int|1
)paren
)paren
(brace
r_return
l_int|0xff
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|prom_getproperty
c_func
(paren
id|prom_root_node
comma
l_string|&quot;idprom&quot;
comma
id|idbuf
comma
id|num_bytes
)paren
)paren
(brace
r_return
id|idbuf
(braket
l_int|0
)braket
suffix:semicolon
)brace
r_return
l_int|0xff
suffix:semicolon
)brace
multiline_comment|/* Get the major prom version number. */
r_int
DECL|function|prom_version
id|prom_version
c_func
(paren
r_void
)paren
(brace
r_return
id|PROM_P1275
suffix:semicolon
)brace
multiline_comment|/* Get the prom plugin-revision. */
r_int
DECL|function|prom_getrev
id|prom_getrev
c_func
(paren
r_void
)paren
(brace
r_return
id|prom_rev
suffix:semicolon
)brace
multiline_comment|/* Get the prom firmware print revision. */
r_int
DECL|function|prom_getprev
id|prom_getprev
c_func
(paren
r_void
)paren
(brace
r_return
id|prom_prev
suffix:semicolon
)brace
multiline_comment|/* Install Linux trap table so PROM uses that instead of it&squot;s own. */
DECL|function|prom_set_trap_table
r_void
id|prom_set_trap_table
c_func
(paren
r_int
r_int
id|tba
)paren
(brace
id|p1275_cmd
c_func
(paren
l_string|&quot;SUNW,set-trap-table&quot;
comma
id|P1275_INOUT
c_func
(paren
l_int|1
comma
l_int|0
)paren
comma
id|tba
)paren
suffix:semicolon
)brace
DECL|variable|mmu_ihandle_cache
r_int
id|mmu_ihandle_cache
op_assign
l_int|0
suffix:semicolon
DECL|function|prom_get_mmu_ihandle
r_int
id|prom_get_mmu_ihandle
c_func
(paren
r_void
)paren
(brace
r_int
id|node
comma
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|mmu_ihandle_cache
op_ne
l_int|0
)paren
r_return
id|mmu_ihandle_cache
suffix:semicolon
id|node
op_assign
id|prom_finddevice
c_func
(paren
l_string|&quot;/chosen&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|prom_getint
c_func
(paren
id|node
comma
l_string|&quot;mmu&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
op_minus
l_int|1
op_logical_or
id|ret
op_eq
l_int|0
)paren
(brace
id|mmu_ihandle_cache
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_else
id|mmu_ihandle_cache
op_assign
id|ret
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|prom_get_memory_ihandle
r_static
r_int
id|prom_get_memory_ihandle
c_func
(paren
r_void
)paren
(brace
r_static
r_int
id|memory_ihandle_cache
op_assign
l_int|0
suffix:semicolon
r_int
id|node
comma
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|memory_ihandle_cache
op_ne
l_int|0
)paren
r_return
id|memory_ihandle_cache
suffix:semicolon
id|node
op_assign
id|prom_finddevice
c_func
(paren
l_string|&quot;/chosen&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|prom_getint
c_func
(paren
id|node
comma
l_string|&quot;memory&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
op_minus
l_int|1
op_logical_or
id|ret
op_eq
l_int|0
)paren
id|memory_ihandle_cache
op_assign
op_minus
l_int|1
suffix:semicolon
r_else
id|memory_ihandle_cache
op_assign
id|ret
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Load explicit I/D TLB entries. */
DECL|function|prom_itlb_load
r_int
id|prom_itlb_load
c_func
(paren
r_int
r_int
id|index
comma
r_int
r_int
id|tte_data
comma
r_int
r_int
id|vaddr
)paren
(brace
r_return
id|p1275_cmd
c_func
(paren
l_string|&quot;call-method&quot;
comma
(paren
id|P1275_ARG
c_func
(paren
l_int|0
comma
id|P1275_ARG_IN_STRING
)paren
op_or
id|P1275_ARG
c_func
(paren
l_int|2
comma
id|P1275_ARG_IN_64B
)paren
op_or
id|P1275_ARG
c_func
(paren
l_int|3
comma
id|P1275_ARG_IN_64B
)paren
op_or
id|P1275_INOUT
c_func
(paren
l_int|5
comma
l_int|1
)paren
)paren
comma
l_string|&quot;SUNW,itlb-load&quot;
comma
id|prom_get_mmu_ihandle
c_func
(paren
)paren
comma
multiline_comment|/* And then our actual args are pushed backwards. */
id|vaddr
comma
id|tte_data
comma
id|index
)paren
suffix:semicolon
)brace
DECL|function|prom_dtlb_load
r_int
id|prom_dtlb_load
c_func
(paren
r_int
r_int
id|index
comma
r_int
r_int
id|tte_data
comma
r_int
r_int
id|vaddr
)paren
(brace
r_return
id|p1275_cmd
c_func
(paren
l_string|&quot;call-method&quot;
comma
(paren
id|P1275_ARG
c_func
(paren
l_int|0
comma
id|P1275_ARG_IN_STRING
)paren
op_or
id|P1275_ARG
c_func
(paren
l_int|2
comma
id|P1275_ARG_IN_64B
)paren
op_or
id|P1275_ARG
c_func
(paren
l_int|3
comma
id|P1275_ARG_IN_64B
)paren
op_or
id|P1275_INOUT
c_func
(paren
l_int|5
comma
l_int|1
)paren
)paren
comma
l_string|&quot;SUNW,dtlb-load&quot;
comma
id|prom_get_mmu_ihandle
c_func
(paren
)paren
comma
multiline_comment|/* And then our actual args are pushed backwards. */
id|vaddr
comma
id|tte_data
comma
id|index
)paren
suffix:semicolon
)brace
DECL|function|prom_map
r_int
id|prom_map
c_func
(paren
r_int
id|mode
comma
r_int
r_int
id|size
comma
r_int
r_int
id|vaddr
comma
r_int
r_int
id|paddr
)paren
(brace
r_int
id|ret
op_assign
id|p1275_cmd
c_func
(paren
l_string|&quot;call-method&quot;
comma
(paren
id|P1275_ARG
c_func
(paren
l_int|0
comma
id|P1275_ARG_IN_STRING
)paren
op_or
id|P1275_ARG
c_func
(paren
l_int|3
comma
id|P1275_ARG_IN_64B
)paren
op_or
id|P1275_ARG
c_func
(paren
l_int|4
comma
id|P1275_ARG_IN_64B
)paren
op_or
id|P1275_ARG
c_func
(paren
l_int|6
comma
id|P1275_ARG_IN_64B
)paren
op_or
id|P1275_INOUT
c_func
(paren
l_int|7
comma
l_int|1
)paren
)paren
comma
l_string|&quot;map&quot;
comma
id|prom_get_mmu_ihandle
c_func
(paren
)paren
comma
id|mode
comma
id|size
comma
id|vaddr
comma
l_int|0
comma
id|paddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|prom_unmap
r_void
id|prom_unmap
c_func
(paren
r_int
r_int
id|size
comma
r_int
r_int
id|vaddr
)paren
(brace
id|p1275_cmd
c_func
(paren
l_string|&quot;call-method&quot;
comma
(paren
id|P1275_ARG
c_func
(paren
l_int|0
comma
id|P1275_ARG_IN_STRING
)paren
op_or
id|P1275_ARG
c_func
(paren
l_int|2
comma
id|P1275_ARG_IN_64B
)paren
op_or
id|P1275_ARG
c_func
(paren
l_int|3
comma
id|P1275_ARG_IN_64B
)paren
op_or
id|P1275_INOUT
c_func
(paren
l_int|4
comma
l_int|0
)paren
)paren
comma
l_string|&quot;unmap&quot;
comma
id|prom_get_mmu_ihandle
c_func
(paren
)paren
comma
id|size
comma
id|vaddr
)paren
suffix:semicolon
)brace
multiline_comment|/* Set aside physical memory which is not touched or modified&n; * across soft resets.&n; */
DECL|function|prom_retain
r_int
r_int
id|prom_retain
c_func
(paren
r_char
op_star
id|name
comma
r_int
r_int
id|pa_low
comma
r_int
r_int
id|pa_high
comma
r_int
id|size
comma
r_int
id|align
)paren
(brace
multiline_comment|/* XXX I don&squot;t think we return multiple values correctly.&n;&t; * XXX OBP supposedly returns pa_low/pa_high here, how does&n;&t; * XXX it work?&n;&t; */
multiline_comment|/* If align is zero, the pa_low/pa_high args are passed,&n;&t; * else they are not.&n;&t; */
r_if
c_cond
(paren
id|align
op_eq
l_int|0
)paren
(brace
r_return
id|p1275_cmd
c_func
(paren
l_string|&quot;SUNW,retain&quot;
comma
(paren
id|P1275_ARG
c_func
(paren
l_int|0
comma
id|P1275_ARG_IN_BUF
)paren
op_or
id|P1275_INOUT
c_func
(paren
l_int|5
comma
l_int|2
)paren
)paren
comma
id|name
comma
id|pa_low
comma
id|pa_high
comma
id|size
comma
id|align
)paren
suffix:semicolon
)brace
r_else
r_return
id|p1275_cmd
c_func
(paren
l_string|&quot;SUNW,retain&quot;
comma
(paren
id|P1275_ARG
c_func
(paren
l_int|0
comma
id|P1275_ARG_IN_BUF
)paren
op_or
id|P1275_INOUT
c_func
(paren
l_int|3
comma
l_int|2
)paren
)paren
comma
id|name
comma
id|size
comma
id|align
)paren
suffix:semicolon
)brace
multiline_comment|/* Get &quot;Unumber&quot; string for the SIMM at the given&n; * memory address.  Usually this will be of the form&n; * &quot;Uxxxx&quot; where xxxx is a decimal number which is&n; * etched into the motherboard next to the SIMM slot&n; * in question.&n; */
DECL|function|prom_getunumber
r_int
id|prom_getunumber
c_func
(paren
r_int
id|syndrome_code
comma
r_int
r_int
id|phys_addr
comma
r_char
op_star
id|buf
comma
r_int
id|buflen
)paren
(brace
r_return
id|p1275_cmd
c_func
(paren
l_string|&quot;call-method&quot;
comma
(paren
id|P1275_ARG
c_func
(paren
l_int|0
comma
id|P1275_ARG_IN_STRING
)paren
op_or
id|P1275_ARG
c_func
(paren
l_int|3
comma
id|P1275_ARG_OUT_BUF
)paren
op_or
id|P1275_ARG
c_func
(paren
l_int|6
comma
id|P1275_ARG_IN_64B
)paren
op_or
id|P1275_INOUT
c_func
(paren
l_int|8
comma
l_int|2
)paren
)paren
comma
l_string|&quot;SUNW,get-unumber&quot;
comma
id|prom_get_memory_ihandle
c_func
(paren
)paren
comma
id|buflen
comma
id|buf
comma
id|P1275_SIZE
c_func
(paren
id|buflen
)paren
comma
l_int|0
comma
id|phys_addr
comma
id|syndrome_code
)paren
suffix:semicolon
)brace
multiline_comment|/* Power management extensions. */
DECL|function|prom_sleepself
r_void
id|prom_sleepself
c_func
(paren
r_void
)paren
(brace
id|p1275_cmd
c_func
(paren
l_string|&quot;SUNW,sleep-self&quot;
comma
id|P1275_INOUT
c_func
(paren
l_int|0
comma
l_int|0
)paren
)paren
suffix:semicolon
)brace
DECL|function|prom_sleepsystem
r_int
id|prom_sleepsystem
c_func
(paren
r_void
)paren
(brace
r_return
id|p1275_cmd
c_func
(paren
l_string|&quot;SUNW,sleep-system&quot;
comma
id|P1275_INOUT
c_func
(paren
l_int|0
comma
l_int|1
)paren
)paren
suffix:semicolon
)brace
DECL|function|prom_wakeupsystem
r_int
id|prom_wakeupsystem
c_func
(paren
r_void
)paren
(brace
r_return
id|p1275_cmd
c_func
(paren
l_string|&quot;SUNW,wakeup-system&quot;
comma
id|P1275_INOUT
c_func
(paren
l_int|0
comma
l_int|1
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SMP
DECL|function|prom_startcpu
r_void
id|prom_startcpu
c_func
(paren
r_int
id|cpunode
comma
r_int
r_int
id|pc
comma
r_int
r_int
id|o0
)paren
(brace
id|p1275_cmd
c_func
(paren
l_string|&quot;SUNW,start-cpu&quot;
comma
id|P1275_INOUT
c_func
(paren
l_int|3
comma
l_int|0
)paren
comma
id|cpunode
comma
id|pc
comma
id|o0
)paren
suffix:semicolon
)brace
DECL|function|prom_stopself
r_void
id|prom_stopself
c_func
(paren
r_void
)paren
(brace
id|p1275_cmd
c_func
(paren
l_string|&quot;SUNW,stop-self&quot;
comma
id|P1275_INOUT
c_func
(paren
l_int|0
comma
l_int|0
)paren
)paren
suffix:semicolon
)brace
DECL|function|prom_idleself
r_void
id|prom_idleself
c_func
(paren
r_void
)paren
(brace
id|p1275_cmd
c_func
(paren
l_string|&quot;SUNW,idle-self&quot;
comma
id|P1275_INOUT
c_func
(paren
l_int|0
comma
l_int|0
)paren
)paren
suffix:semicolon
)brace
DECL|function|prom_resumecpu
r_void
id|prom_resumecpu
c_func
(paren
r_int
id|cpunode
)paren
(brace
id|p1275_cmd
c_func
(paren
l_string|&quot;SUNW,resume-cpu&quot;
comma
id|P1275_INOUT
c_func
(paren
l_int|1
comma
l_int|0
)paren
comma
id|cpunode
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
