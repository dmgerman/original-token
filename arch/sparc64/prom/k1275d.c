multiline_comment|/* $Id: k1275d.c,v 1.1 1996/12/27 08:49:12 jj Exp $&n; * k1275d.c: Sun IEEE 1275 PROM kernel daemon&n; *&n; * Copyright (C) 1996 Jakub Jelinek (jj@sunsite.mff.cuni.cz)&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/openprom.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
DECL|macro|p1275sect
mdefine_line|#define p1275sect __attribute__ ((__section__ (&quot;.p1275&quot;)))
r_static
r_void
id|prom_doit
(paren
r_void
)paren
id|p1275sect
suffix:semicolon
DECL|function|prom_doit
r_static
r_void
id|prom_doit
(paren
r_void
)paren
(brace
multiline_comment|/* FIXME: The PROM stack is grossly misaligned.&n;&t; * It needs some special way of handling spills/fills.&n;&t; * Either using %otherwin or doing flushw; wrpr somevalue, %wstate&n;&t; * should be done here to make difference between PROM stack&n;&t; * saving (32bit, misaligned stack) and kernel fill/spill).&n;&t; */
id|__asm__
id|__volatile__
(paren
"&quot;"
id|save
op_mod
op_mod
id|sp
comma
op_minus
l_int|0xc0
comma
op_mod
op_mod
id|sp
suffix:semicolon
id|mov
op_mod
op_mod
id|sp
comma
op_mod
op_mod
id|l1
suffix:semicolon
id|mov
op_mod
l_int|0
comma
op_mod
op_mod
id|sp
suffix:semicolon
id|call
op_mod
l_int|1
suffix:semicolon
id|mov
op_mod
l_int|0
comma
op_mod
op_mod
id|o0
suffix:semicolon
id|mov
op_mod
op_mod
id|l1
comma
op_mod
op_mod
id|sp
suffix:semicolon
id|restore
suffix:semicolon
l_string|&quot; : : &quot;
id|r
l_string|&quot; (prom_cif_stack), &quot;
id|r
"&quot;"
(paren
id|prom_cif_handler
)paren
)paren
suffix:semicolon
)brace
r_static
r_void
(paren
op_star
id|prom_cif_handler
)paren
(paren
r_int
op_star
)paren
id|p1275sect
suffix:semicolon
DECL|variable|prom_cif_stack
r_static
r_void
id|prom_cif_stack
suffix:semicolon
DECL|variable|prom_do_it
r_static
r_void
(paren
op_star
id|prom_do_it
)paren
(paren
r_void
)paren
suffix:semicolon
DECL|variable|p1275sect
r_static
r_int
id|prom_args
(braket
l_int|23
)braket
id|p1275sect
suffix:semicolon
DECL|variable|p1275sect
r_static
r_char
id|prom_buffer
(braket
l_int|4096
)braket
id|p1275sect
suffix:semicolon
DECL|function|prom_handle_command
r_int
id|prom_handle_command
c_func
(paren
r_char
op_star
id|service
comma
r_int
id|fmt
comma
dot
dot
dot
)paren
(brace
r_char
op_star
id|p
op_assign
id|prom_buffer
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|nargs
comma
id|nrets
comma
id|i
suffix:semicolon
id|va_list
id|list
suffix:semicolon
r_int
id|attrs
comma
id|x
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|prom_args
(braket
l_int|0
)braket
op_assign
id|p
suffix:semicolon
multiline_comment|/* service */
id|strcpy
(paren
id|p
comma
id|function
)paren
suffix:semicolon
id|p
op_assign
id|strchr
(paren
id|p
comma
l_int|0
)paren
op_plus
l_int|1
suffix:semicolon
id|prom_args
(braket
l_int|1
)braket
op_assign
id|nargs
op_assign
(paren
id|fmt
op_amp
l_int|0x0f
)paren
suffix:semicolon
multiline_comment|/* nargs */
id|prom_args
(braket
l_int|2
)braket
op_assign
id|nrets
op_assign
(paren
(paren
id|fmt
op_amp
l_int|0xf0
)paren
op_rshift
l_int|4
)paren
suffix:semicolon
multiline_comment|/* nrets */
id|attrs
op_assign
(paren
id|fmt
op_amp
(paren
op_complement
l_int|0xff
)paren
)paren
suffix:semicolon
id|va_start
c_func
(paren
id|list
comma
id|fmt
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nargs
suffix:semicolon
id|i
op_increment
comma
id|attrs
op_rshift_assign
l_int|3
)paren
(brace
r_switch
c_cond
(paren
id|attrs
op_amp
l_int|0x7
)paren
(brace
r_case
id|P1275_ARG_NUMBER
suffix:colon
id|prom_args
(braket
id|i
op_plus
l_int|3
)braket
op_assign
id|va_arg
c_func
(paren
id|list
comma
r_int
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P1275_ARG_IN_STRING
suffix:colon
id|strcpy
(paren
id|p
comma
id|va_arg
c_func
(paren
id|list
comma
r_char
op_star
)paren
)paren
suffix:semicolon
id|prom_args
(braket
id|i
op_plus
l_int|3
)braket
op_assign
id|p
suffix:semicolon
id|p
op_assign
id|strchr
(paren
id|p
comma
l_int|0
)paren
op_plus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P1275_ARG_OUT_BUF
suffix:colon
id|va_arg
c_func
(paren
id|list
comma
r_char
op_star
)paren
suffix:semicolon
id|prom_args
(braket
id|i
op_plus
l_int|3
)braket
op_assign
id|p
suffix:semicolon
id|x
op_assign
id|va_arg
c_func
(paren
id|list
comma
r_int
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
id|attrs
op_rshift_assign
l_int|3
suffix:semicolon
id|p
op_add_assign
(paren
r_int
)paren
id|x
suffix:semicolon
id|prom_args
(braket
id|i
op_plus
l_int|3
)braket
op_assign
id|x
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P1275_ARG_OUT_32B
suffix:colon
id|va_arg
c_func
(paren
id|list
comma
r_char
op_star
)paren
suffix:semicolon
id|prom_args
(braket
id|i
op_plus
l_int|3
)braket
op_assign
id|p
suffix:semicolon
id|p
op_add_assign
l_int|32
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P1275_ARG_IN_FUNCTION
suffix:colon
multiline_comment|/* FIXME: This should make a function in our &lt;4G&n;&t;&t;&t; * section, which will call the argument,&n;&t;&t;&t; * so that PROM can call it.&n;&t;&t;&t; */
id|prom_args
(braket
id|i
op_plus
l_int|3
)braket
op_assign
id|va_arg
c_func
(paren
id|list
comma
r_int
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|va_end
c_func
(paren
id|list
)paren
suffix:semicolon
(paren
op_star
id|prom_do_it
)paren
(paren
)paren
suffix:semicolon
id|attrs
op_assign
id|fmt
op_amp
(paren
op_complement
l_int|0xff
)paren
suffix:semicolon
id|va_start
c_func
(paren
id|list
comma
id|fmt
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nargs
suffix:semicolon
id|i
op_increment
comma
id|attrs
op_rshift_assign
l_int|3
)paren
(brace
r_switch
c_cond
(paren
id|attrs
op_amp
l_int|0x7
)paren
(brace
r_case
id|P1275_ARG_NUMBER
suffix:colon
r_case
id|P1275_ARG_IN_STRING
suffix:colon
r_case
id|P1275_ARG_IN_FUNCTION
suffix:colon
r_break
suffix:semicolon
r_case
id|P1275_ARG_OUT_BUF
suffix:colon
id|p
op_assign
id|va_arg
c_func
(paren
id|list
comma
r_char
op_star
)paren
suffix:semicolon
id|x
op_assign
id|va_arg
c_func
(paren
id|list
comma
r_int
)paren
suffix:semicolon
id|memcpy
(paren
id|p
comma
(paren
r_char
op_star
)paren
id|prom_args
(braket
id|i
op_plus
l_int|3
)braket
comma
(paren
r_int
)paren
id|x
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
id|attrs
op_rshift_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_case
id|P1275_ARG_OUT_32B
suffix:colon
id|p
op_assign
id|va_arg
c_func
(paren
id|list
comma
r_char
op_star
)paren
suffix:semicolon
id|memcpy
(paren
id|p
comma
(paren
r_char
op_star
)paren
id|prom_args
(braket
id|i
op_plus
l_int|3
)braket
comma
l_int|32
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|va_end
c_func
(paren
id|list
)paren
suffix:semicolon
id|x
op_assign
id|prom_args
(braket
id|nargs
op_plus
l_int|3
)braket
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|x
suffix:semicolon
)brace
DECL|function|prom_cif_init
r_void
id|prom_cif_init
c_func
(paren
r_void
op_star
id|cif_handler
comma
r_void
op_star
id|cif_stack
)paren
(brace
id|prom_cif_handler
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_int
op_star
)paren
)paren
id|cif_handler
suffix:semicolon
id|prom_cif_stack
op_assign
id|cif_stack
suffix:semicolon
id|prom_command
op_assign
id|prom_handle_command
suffix:semicolon
id|prom_do_it
op_assign
id|prom_doit
suffix:semicolon
)brace
eof
