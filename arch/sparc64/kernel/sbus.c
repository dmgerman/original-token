multiline_comment|/* $Id: sbus.c,v 1.12 2000/09/21 06:25:14 anton Exp $&n; * sbus.c: UltraSparc SBUS controller support.&n; *&n; * Copyright (C) 1999 David S. Miller (davem@redhat.com)&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/sbus.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/upa.h&gt;
macro_line|#include &lt;asm/cache.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/starfire.h&gt;
macro_line|#include &quot;iommu_common.h&quot;
multiline_comment|/* These should be allocated on an SMP_CACHE_BYTES&n; * aligned boundry for optimal performance.&n; *&n; * On SYSIO, using an 8K page size we have 1GB of SBUS&n; * DMA space mapped.  We divide this space into equally&n; * sized clusters.  Currently we allow clusters up to a&n; * size of 1MB.  If anything begins to generate DMA&n; * mapping requests larger than this we will need to&n; * increase things a bit.&n; */
DECL|macro|NCLUSTERS
mdefine_line|#define NCLUSTERS&t;8UL
DECL|macro|ONE_GIG
mdefine_line|#define ONE_GIG&t;&t;(1UL * 1024UL * 1024UL * 1024UL)
DECL|macro|CLUSTER_SIZE
mdefine_line|#define CLUSTER_SIZE&t;(ONE_GIG / NCLUSTERS)
DECL|macro|CLUSTER_MASK
mdefine_line|#define CLUSTER_MASK&t;(CLUSTER_SIZE - 1)
DECL|macro|CLUSTER_NPAGES
mdefine_line|#define CLUSTER_NPAGES&t;(CLUSTER_SIZE &gt;&gt; PAGE_SHIFT)
DECL|macro|MAP_BASE
mdefine_line|#define MAP_BASE&t;((u32)0xc0000000)
DECL|struct|sbus_iommu
r_struct
id|sbus_iommu
(brace
DECL|member|lock
multiline_comment|/*0x00*/
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|page_table
multiline_comment|/*0x08*/
id|iopte_t
op_star
id|page_table
suffix:semicolon
DECL|member|strbuf_regs
multiline_comment|/*0x10*/
r_int
r_int
id|strbuf_regs
suffix:semicolon
DECL|member|iommu_regs
multiline_comment|/*0x18*/
r_int
r_int
id|iommu_regs
suffix:semicolon
DECL|member|sbus_control_reg
multiline_comment|/*0x20*/
r_int
r_int
id|sbus_control_reg
suffix:semicolon
DECL|member|strbuf_flushflag
multiline_comment|/*0x28*/
r_volatile
r_int
r_int
id|strbuf_flushflag
suffix:semicolon
multiline_comment|/* If NCLUSTERS is ever decresed to 4 or lower,&n;&t; * you must increase the size of the type of&n;&t; * these counters.  You have been duly warned. -DaveM&n;&t; */
multiline_comment|/*0x30*/
r_struct
(brace
DECL|member|next
id|u16
id|next
suffix:semicolon
DECL|member|flush
id|u16
id|flush
suffix:semicolon
DECL|member|alloc_info
)brace
id|alloc_info
(braket
id|NCLUSTERS
)braket
suffix:semicolon
multiline_comment|/* The lowest used consistent mapping entry.  Since&n;&t; * we allocate consistent maps out of cluster 0 this&n;&t; * is relative to the beginning of closter 0.&n;&t; */
DECL|member|lowest_consistent_map
multiline_comment|/*0x50*/
id|u32
id|lowest_consistent_map
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Offsets from iommu_regs */
DECL|macro|SYSIO_IOMMUREG_BASE
mdefine_line|#define SYSIO_IOMMUREG_BASE&t;0x2400UL
DECL|macro|IOMMU_CONTROL
mdefine_line|#define IOMMU_CONTROL&t;(0x2400UL - 0x2400UL)&t;/* IOMMU control register */
DECL|macro|IOMMU_TSBBASE
mdefine_line|#define IOMMU_TSBBASE&t;(0x2408UL - 0x2400UL)&t;/* TSB base address register */
DECL|macro|IOMMU_FLUSH
mdefine_line|#define IOMMU_FLUSH&t;(0x2410UL - 0x2400UL)&t;/* IOMMU flush register */
DECL|macro|IOMMU_VADIAG
mdefine_line|#define IOMMU_VADIAG&t;(0x4400UL - 0x2400UL)&t;/* SBUS virtual address diagnostic */
DECL|macro|IOMMU_TAGCMP
mdefine_line|#define IOMMU_TAGCMP&t;(0x4408UL - 0x2400UL)&t;/* TLB tag compare diagnostics */
DECL|macro|IOMMU_LRUDIAG
mdefine_line|#define IOMMU_LRUDIAG&t;(0x4500UL - 0x2400UL)&t;/* IOMMU LRU queue diagnostics */
DECL|macro|IOMMU_TAGDIAG
mdefine_line|#define IOMMU_TAGDIAG&t;(0x4580UL - 0x2400UL)&t;/* TLB tag diagnostics */
DECL|macro|IOMMU_DRAMDIAG
mdefine_line|#define IOMMU_DRAMDIAG&t;(0x4600UL - 0x2400UL)&t;/* TLB data RAM diagnostics */
DECL|macro|IOMMU_DRAM_VALID
mdefine_line|#define IOMMU_DRAM_VALID&t;(1UL &lt;&lt; 30UL)
DECL|function|__iommu_flushall
r_static
r_void
id|__iommu_flushall
c_func
(paren
r_struct
id|sbus_iommu
op_star
id|iommu
)paren
(brace
r_int
r_int
id|tag
op_assign
id|iommu-&gt;iommu_regs
op_plus
id|IOMMU_TAGDIAG
suffix:semicolon
r_int
id|entry
suffix:semicolon
r_for
c_loop
(paren
id|entry
op_assign
l_int|0
suffix:semicolon
id|entry
OL
l_int|16
suffix:semicolon
id|entry
op_increment
)paren
(brace
id|upa_writeq
c_func
(paren
l_int|0
comma
id|tag
)paren
suffix:semicolon
id|tag
op_add_assign
l_int|8UL
suffix:semicolon
)brace
id|upa_readq
c_func
(paren
id|iommu-&gt;sbus_control_reg
)paren
suffix:semicolon
r_for
c_loop
(paren
id|entry
op_assign
l_int|0
suffix:semicolon
id|entry
OL
id|NCLUSTERS
suffix:semicolon
id|entry
op_increment
)paren
(brace
id|iommu-&gt;alloc_info
(braket
id|entry
)braket
dot
id|flush
op_assign
id|iommu-&gt;alloc_info
(braket
id|entry
)braket
dot
id|next
suffix:semicolon
)brace
)brace
DECL|function|iommu_flush
r_static
r_void
id|iommu_flush
c_func
(paren
r_struct
id|sbus_iommu
op_star
id|iommu
comma
id|u32
id|base
comma
r_int
r_int
id|npages
)paren
(brace
r_while
c_loop
(paren
id|npages
op_decrement
)paren
id|upa_writeq
c_func
(paren
id|base
op_plus
(paren
id|npages
op_lshift
id|PAGE_SHIFT
)paren
comma
id|iommu-&gt;iommu_regs
op_plus
id|IOMMU_FLUSH
)paren
suffix:semicolon
id|upa_readq
c_func
(paren
id|iommu-&gt;sbus_control_reg
)paren
suffix:semicolon
)brace
multiline_comment|/* Offsets from strbuf_regs */
DECL|macro|SYSIO_STRBUFREG_BASE
mdefine_line|#define SYSIO_STRBUFREG_BASE&t;0x2800UL
DECL|macro|STRBUF_CONTROL
mdefine_line|#define STRBUF_CONTROL&t;(0x2800UL - 0x2800UL)&t;/* Control */
DECL|macro|STRBUF_PFLUSH
mdefine_line|#define STRBUF_PFLUSH&t;(0x2808UL - 0x2800UL)&t;/* Page flush/invalidate */
DECL|macro|STRBUF_FSYNC
mdefine_line|#define STRBUF_FSYNC&t;(0x2810UL - 0x2800UL)&t;/* Flush synchronization */
DECL|macro|STRBUF_DRAMDIAG
mdefine_line|#define STRBUF_DRAMDIAG&t;(0x5000UL - 0x2800UL)&t;/* data RAM diagnostic */
DECL|macro|STRBUF_ERRDIAG
mdefine_line|#define STRBUF_ERRDIAG&t;(0x5400UL - 0x2800UL)&t;/* error status diagnostics */
DECL|macro|STRBUF_PTAGDIAG
mdefine_line|#define STRBUF_PTAGDIAG&t;(0x5800UL - 0x2800UL)&t;/* Page tag diagnostics */
DECL|macro|STRBUF_LTAGDIAG
mdefine_line|#define STRBUF_LTAGDIAG&t;(0x5900UL - 0x2800UL)&t;/* Line tag diagnostics */
DECL|macro|STRBUF_TAG_VALID
mdefine_line|#define STRBUF_TAG_VALID&t;0x02UL
DECL|function|strbuf_flush
r_static
r_void
id|strbuf_flush
c_func
(paren
r_struct
id|sbus_iommu
op_star
id|iommu
comma
id|u32
id|base
comma
r_int
r_int
id|npages
)paren
(brace
id|iommu-&gt;strbuf_flushflag
op_assign
l_int|0UL
suffix:semicolon
r_while
c_loop
(paren
id|npages
op_decrement
)paren
id|upa_writeq
c_func
(paren
id|base
op_plus
(paren
id|npages
op_lshift
id|PAGE_SHIFT
)paren
comma
id|iommu-&gt;strbuf_regs
op_plus
id|STRBUF_PFLUSH
)paren
suffix:semicolon
multiline_comment|/* Whoopee cushion! */
id|upa_writeq
c_func
(paren
id|__pa
c_func
(paren
op_amp
id|iommu-&gt;strbuf_flushflag
)paren
comma
id|iommu-&gt;strbuf_regs
op_plus
id|STRBUF_FSYNC
)paren
suffix:semicolon
id|upa_readq
c_func
(paren
id|iommu-&gt;sbus_control_reg
)paren
suffix:semicolon
r_while
c_loop
(paren
id|iommu-&gt;strbuf_flushflag
op_eq
l_int|0UL
)paren
id|membar
c_func
(paren
l_string|&quot;#LoadLoad&quot;
)paren
suffix:semicolon
)brace
DECL|function|alloc_streaming_cluster
r_static
id|iopte_t
op_star
id|alloc_streaming_cluster
c_func
(paren
r_struct
id|sbus_iommu
op_star
id|iommu
comma
r_int
r_int
id|npages
)paren
(brace
id|iopte_t
op_star
id|iopte
comma
op_star
id|limit
suffix:semicolon
r_int
r_int
id|cnum
comma
id|ent
comma
id|flush_point
suffix:semicolon
id|cnum
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
l_int|1UL
op_lshift
id|cnum
)paren
OL
id|npages
)paren
id|cnum
op_increment
suffix:semicolon
id|iopte
op_assign
id|iommu-&gt;page_table
op_plus
(paren
id|cnum
op_star
id|CLUSTER_NPAGES
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnum
op_eq
l_int|0
)paren
id|limit
op_assign
(paren
id|iommu-&gt;page_table
op_plus
id|iommu-&gt;lowest_consistent_map
)paren
suffix:semicolon
r_else
id|limit
op_assign
(paren
id|iopte
op_plus
id|CLUSTER_NPAGES
)paren
suffix:semicolon
id|iopte
op_add_assign
(paren
(paren
id|ent
op_assign
id|iommu-&gt;alloc_info
(braket
id|cnum
)braket
dot
id|next
)paren
op_lshift
id|cnum
)paren
suffix:semicolon
id|flush_point
op_assign
id|iommu-&gt;alloc_info
(braket
id|cnum
)braket
dot
id|flush
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|iopte_val
c_func
(paren
op_star
id|iopte
)paren
op_eq
l_int|0UL
)paren
(brace
r_if
c_cond
(paren
(paren
id|iopte
op_plus
(paren
l_int|1
op_lshift
id|cnum
)paren
)paren
op_ge
id|limit
)paren
id|ent
op_assign
l_int|0
suffix:semicolon
r_else
id|ent
op_assign
id|ent
op_plus
l_int|1
suffix:semicolon
id|iommu-&gt;alloc_info
(braket
id|cnum
)braket
dot
id|next
op_assign
id|ent
suffix:semicolon
r_if
c_cond
(paren
id|ent
op_eq
id|flush_point
)paren
id|__iommu_flushall
c_func
(paren
id|iommu
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|iopte
op_add_assign
(paren
l_int|1
op_lshift
id|cnum
)paren
suffix:semicolon
id|ent
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|iopte
op_ge
id|limit
)paren
(brace
id|iopte
op_assign
(paren
id|iommu-&gt;page_table
op_plus
(paren
id|cnum
op_star
id|CLUSTER_NPAGES
)paren
)paren
suffix:semicolon
id|ent
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ent
op_eq
id|flush_point
)paren
id|__iommu_flushall
c_func
(paren
id|iommu
)paren
suffix:semicolon
)brace
multiline_comment|/* I&squot;ve got your streaming cluster right here buddy boy... */
r_return
id|iopte
suffix:semicolon
)brace
DECL|function|free_streaming_cluster
r_static
r_void
id|free_streaming_cluster
c_func
(paren
r_struct
id|sbus_iommu
op_star
id|iommu
comma
id|u32
id|base
comma
r_int
r_int
id|npages
)paren
(brace
r_int
r_int
id|cnum
comma
id|ent
suffix:semicolon
id|iopte_t
op_star
id|iopte
suffix:semicolon
id|cnum
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
l_int|1UL
op_lshift
id|cnum
)paren
OL
id|npages
)paren
id|cnum
op_increment
suffix:semicolon
id|ent
op_assign
(paren
id|base
op_amp
id|CLUSTER_MASK
)paren
op_rshift
(paren
id|PAGE_SHIFT
op_plus
id|cnum
)paren
suffix:semicolon
id|iopte
op_assign
id|iommu-&gt;page_table
op_plus
(paren
(paren
id|base
op_minus
id|MAP_BASE
)paren
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|iopte_val
c_func
(paren
op_star
id|iopte
)paren
op_assign
l_int|0UL
suffix:semicolon
multiline_comment|/* If the global flush might not have caught this entry,&n;&t; * adjust the flush point such that we will flush before&n;&t; * ever trying to reuse it.&n;&t; */
DECL|macro|between
mdefine_line|#define between(X,Y,Z)&t;(((Z) - (Y)) &gt;= ((X) - (Y)))
r_if
c_cond
(paren
id|between
c_func
(paren
id|ent
comma
id|iommu-&gt;alloc_info
(braket
id|cnum
)braket
dot
id|next
comma
id|iommu-&gt;alloc_info
(braket
id|cnum
)braket
dot
id|flush
)paren
)paren
id|iommu-&gt;alloc_info
(braket
id|cnum
)braket
dot
id|flush
op_assign
id|ent
suffix:semicolon
DECL|macro|between
macro_line|#undef between
)brace
multiline_comment|/* We allocate consistent mappings from the end of cluster zero. */
DECL|function|alloc_consistent_cluster
r_static
id|iopte_t
op_star
id|alloc_consistent_cluster
c_func
(paren
r_struct
id|sbus_iommu
op_star
id|iommu
comma
r_int
r_int
id|npages
)paren
(brace
id|iopte_t
op_star
id|iopte
suffix:semicolon
id|iopte
op_assign
id|iommu-&gt;page_table
op_plus
(paren
l_int|1
op_star
id|CLUSTER_NPAGES
)paren
suffix:semicolon
r_while
c_loop
(paren
id|iopte
OG
id|iommu-&gt;page_table
)paren
(brace
id|iopte
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|iopte_val
c_func
(paren
op_star
id|iopte
)paren
op_amp
id|IOPTE_VALID
)paren
)paren
(brace
r_int
r_int
id|tmp
op_assign
id|npages
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|tmp
)paren
(brace
id|iopte
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|iopte_val
c_func
(paren
op_star
id|iopte
)paren
op_amp
id|IOPTE_VALID
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tmp
op_eq
l_int|0
)paren
(brace
id|u32
id|entry
op_assign
(paren
id|iopte
op_minus
id|iommu-&gt;page_table
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry
OL
id|iommu-&gt;lowest_consistent_map
)paren
id|iommu-&gt;lowest_consistent_map
op_assign
id|entry
suffix:semicolon
r_return
id|iopte
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|free_consistent_cluster
r_static
r_void
id|free_consistent_cluster
c_func
(paren
r_struct
id|sbus_iommu
op_star
id|iommu
comma
id|u32
id|base
comma
r_int
r_int
id|npages
)paren
(brace
id|iopte_t
op_star
id|iopte
op_assign
id|iommu-&gt;page_table
op_plus
(paren
(paren
id|base
op_minus
id|MAP_BASE
)paren
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|iopte
op_minus
id|iommu-&gt;page_table
)paren
op_eq
id|iommu-&gt;lowest_consistent_map
)paren
(brace
id|iopte_t
op_star
id|walk
op_assign
id|iopte
op_plus
id|npages
suffix:semicolon
id|iopte_t
op_star
id|limit
suffix:semicolon
id|limit
op_assign
id|iommu-&gt;page_table
op_plus
id|CLUSTER_NPAGES
suffix:semicolon
r_while
c_loop
(paren
id|walk
OL
id|limit
)paren
(brace
r_if
c_cond
(paren
id|iopte_val
c_func
(paren
op_star
id|walk
)paren
op_ne
l_int|0UL
)paren
r_break
suffix:semicolon
id|walk
op_increment
suffix:semicolon
)brace
id|iommu-&gt;lowest_consistent_map
op_assign
(paren
id|walk
op_minus
id|iommu-&gt;page_table
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|npages
op_decrement
)paren
op_star
id|iopte
op_increment
op_assign
id|__iopte
c_func
(paren
l_int|0UL
)paren
suffix:semicolon
)brace
DECL|function|sbus_alloc_consistent
r_void
op_star
id|sbus_alloc_consistent
c_func
(paren
r_struct
id|sbus_dev
op_star
id|sdev
comma
r_int
id|size
comma
id|dma_addr_t
op_star
id|dvma_addr
)paren
(brace
r_int
r_int
id|order
comma
id|first_page
comma
id|flags
suffix:semicolon
r_struct
id|sbus_iommu
op_star
id|iommu
suffix:semicolon
id|iopte_t
op_star
id|iopte
suffix:semicolon
r_void
op_star
id|ret
suffix:semicolon
r_int
id|npages
suffix:semicolon
r_if
c_cond
(paren
id|size
op_le
l_int|0
op_logical_or
id|sdev
op_eq
l_int|NULL
op_logical_or
id|dvma_addr
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|size
op_assign
id|PAGE_ALIGN
c_func
(paren
id|size
)paren
suffix:semicolon
id|order
op_assign
id|get_order
c_func
(paren
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|order
op_ge
l_int|10
)paren
r_return
l_int|NULL
suffix:semicolon
id|first_page
op_assign
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
comma
id|order
)paren
suffix:semicolon
r_if
c_cond
(paren
id|first_page
op_eq
l_int|0UL
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|first_page
comma
l_int|0
comma
id|PAGE_SIZE
op_lshift
id|order
)paren
suffix:semicolon
id|iommu
op_assign
id|sdev-&gt;bus-&gt;iommu
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|iopte
op_assign
id|alloc_consistent_cluster
c_func
(paren
id|iommu
comma
id|size
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iopte
op_eq
l_int|NULL
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|free_pages
c_func
(paren
id|first_page
comma
id|order
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Ok, we&squot;re committed at this point. */
op_star
id|dvma_addr
op_assign
id|MAP_BASE
op_plus
(paren
(paren
id|iopte
op_minus
id|iommu-&gt;page_table
)paren
op_lshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|ret
op_assign
(paren
r_void
op_star
)paren
id|first_page
suffix:semicolon
id|npages
op_assign
id|size
op_rshift
id|PAGE_SHIFT
suffix:semicolon
r_while
c_loop
(paren
id|npages
op_decrement
)paren
(brace
op_star
id|iopte
op_increment
op_assign
id|__iopte
c_func
(paren
id|IOPTE_VALID
op_or
id|IOPTE_CACHE
op_or
id|IOPTE_WRITE
op_or
(paren
id|__pa
c_func
(paren
id|first_page
)paren
op_amp
id|IOPTE_PAGE
)paren
)paren
suffix:semicolon
id|first_page
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
id|iommu_flush
c_func
(paren
id|iommu
comma
op_star
id|dvma_addr
comma
id|size
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sbus_free_consistent
r_void
id|sbus_free_consistent
c_func
(paren
r_struct
id|sbus_dev
op_star
id|sdev
comma
r_int
id|size
comma
r_void
op_star
id|cpu
comma
id|dma_addr_t
id|dvma
)paren
(brace
r_int
r_int
id|order
comma
id|npages
suffix:semicolon
r_struct
id|sbus_iommu
op_star
id|iommu
suffix:semicolon
r_if
c_cond
(paren
id|size
op_le
l_int|0
op_logical_or
id|sdev
op_eq
l_int|NULL
op_logical_or
id|cpu
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|npages
op_assign
id|PAGE_ALIGN
c_func
(paren
id|size
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
id|iommu
op_assign
id|sdev-&gt;bus-&gt;iommu
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|iommu-&gt;lock
)paren
suffix:semicolon
id|free_consistent_cluster
c_func
(paren
id|iommu
comma
id|dvma
comma
id|npages
)paren
suffix:semicolon
id|iommu_flush
c_func
(paren
id|iommu
comma
id|dvma
comma
id|npages
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|iommu-&gt;lock
)paren
suffix:semicolon
id|order
op_assign
id|get_order
c_func
(paren
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|order
OL
l_int|10
)paren
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|cpu
comma
id|order
)paren
suffix:semicolon
)brace
DECL|function|sbus_map_single
id|dma_addr_t
id|sbus_map_single
c_func
(paren
r_struct
id|sbus_dev
op_star
id|sdev
comma
r_void
op_star
id|ptr
comma
r_int
id|size
comma
r_int
id|dir
)paren
(brace
r_struct
id|sbus_iommu
op_star
id|iommu
op_assign
id|sdev-&gt;bus-&gt;iommu
suffix:semicolon
r_int
r_int
id|npages
comma
id|pbase
comma
id|flags
suffix:semicolon
id|iopte_t
op_star
id|iopte
suffix:semicolon
id|u32
id|dma_base
comma
id|offset
suffix:semicolon
r_int
r_int
id|iopte_bits
suffix:semicolon
r_if
c_cond
(paren
id|dir
op_eq
id|SBUS_DMA_NONE
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|pbase
op_assign
(paren
r_int
r_int
)paren
id|ptr
suffix:semicolon
id|offset
op_assign
(paren
id|u32
)paren
(paren
id|pbase
op_amp
op_complement
id|PAGE_MASK
)paren
suffix:semicolon
id|size
op_assign
(paren
id|PAGE_ALIGN
c_func
(paren
id|pbase
op_plus
id|size
)paren
op_minus
(paren
id|pbase
op_amp
id|PAGE_MASK
)paren
)paren
suffix:semicolon
id|pbase
op_assign
(paren
r_int
r_int
)paren
id|__pa
c_func
(paren
id|pbase
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|npages
op_assign
id|size
op_rshift
id|PAGE_SHIFT
suffix:semicolon
id|iopte
op_assign
id|alloc_streaming_cluster
c_func
(paren
id|iommu
comma
id|npages
)paren
suffix:semicolon
id|dma_base
op_assign
id|MAP_BASE
op_plus
(paren
(paren
id|iopte
op_minus
id|iommu-&gt;page_table
)paren
op_lshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|npages
op_assign
id|size
op_rshift
id|PAGE_SHIFT
suffix:semicolon
id|iopte_bits
op_assign
id|IOPTE_VALID
op_or
id|IOPTE_STBUF
op_or
id|IOPTE_CACHE
suffix:semicolon
r_if
c_cond
(paren
id|dir
op_ne
id|SBUS_DMA_TODEVICE
)paren
id|iopte_bits
op_or_assign
id|IOPTE_WRITE
suffix:semicolon
r_while
c_loop
(paren
id|npages
op_decrement
)paren
(brace
op_star
id|iopte
op_increment
op_assign
id|__iopte
c_func
(paren
id|iopte_bits
op_or
(paren
id|pbase
op_amp
id|IOPTE_PAGE
)paren
)paren
suffix:semicolon
id|pbase
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
id|npages
op_assign
id|size
op_rshift
id|PAGE_SHIFT
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
(paren
id|dma_base
op_or
id|offset
)paren
suffix:semicolon
)brace
DECL|function|sbus_unmap_single
r_void
id|sbus_unmap_single
c_func
(paren
r_struct
id|sbus_dev
op_star
id|sdev
comma
id|dma_addr_t
id|dma_addr
comma
r_int
id|size
comma
r_int
id|direction
)paren
(brace
r_struct
id|sbus_iommu
op_star
id|iommu
op_assign
id|sdev-&gt;bus-&gt;iommu
suffix:semicolon
id|u32
id|dma_base
op_assign
id|dma_addr
op_amp
id|PAGE_MASK
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|size
op_assign
(paren
id|PAGE_ALIGN
c_func
(paren
id|dma_addr
op_plus
id|size
)paren
op_minus
id|dma_base
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|free_streaming_cluster
c_func
(paren
id|iommu
comma
id|dma_base
comma
id|size
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|strbuf_flush
c_func
(paren
id|iommu
comma
id|dma_base
comma
id|size
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|fill_sg
r_static
r_inline
r_void
id|fill_sg
c_func
(paren
id|iopte_t
op_star
id|iopte
comma
r_struct
id|scatterlist
op_star
id|sg
comma
r_int
id|nused
comma
r_int
r_int
id|iopte_bits
)paren
(brace
r_struct
id|scatterlist
op_star
id|dma_sg
op_assign
id|sg
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nused
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|pteval
op_assign
op_complement
l_int|0UL
suffix:semicolon
id|u32
id|dma_npages
suffix:semicolon
id|dma_npages
op_assign
(paren
(paren
id|dma_sg-&gt;dvma_address
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1UL
)paren
)paren
op_plus
id|dma_sg-&gt;dvma_length
op_plus
(paren
(paren
id|u32
)paren
(paren
id|PAGE_SIZE
op_minus
l_int|1UL
)paren
)paren
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
r_do
(brace
r_int
r_int
id|offset
suffix:semicolon
r_int
r_int
id|len
suffix:semicolon
multiline_comment|/* If we are here, we know we have at least one&n;&t;&t;&t; * more page to map.  So walk forward until we&n;&t;&t;&t; * hit a page crossing, and begin creating new&n;&t;&t;&t; * mappings from that spot.&n;&t;&t;&t; */
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_int
r_int
id|tmp
suffix:semicolon
id|tmp
op_assign
(paren
r_int
r_int
)paren
id|__pa
c_func
(paren
id|sg-&gt;address
)paren
suffix:semicolon
id|len
op_assign
id|sg-&gt;length
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|tmp
op_xor
id|pteval
)paren
op_rshift
id|PAGE_SHIFT
)paren
op_ne
l_int|0UL
)paren
(brace
id|pteval
op_assign
id|tmp
op_amp
id|PAGE_MASK
suffix:semicolon
id|offset
op_assign
id|tmp
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1UL
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|tmp
op_xor
(paren
id|tmp
op_plus
id|len
op_minus
l_int|1UL
)paren
)paren
op_rshift
id|PAGE_SHIFT
)paren
op_ne
l_int|0UL
)paren
(brace
id|pteval
op_assign
(paren
id|tmp
op_plus
id|PAGE_SIZE
)paren
op_amp
id|PAGE_MASK
suffix:semicolon
id|offset
op_assign
l_int|0UL
suffix:semicolon
id|len
op_sub_assign
(paren
id|PAGE_SIZE
op_minus
(paren
id|tmp
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1UL
)paren
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|sg
op_increment
suffix:semicolon
)brace
id|pteval
op_assign
(paren
(paren
id|pteval
op_amp
id|IOPTE_PAGE
)paren
op_or
id|iopte_bits
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
OG
l_int|0
)paren
(brace
op_star
id|iopte
op_increment
op_assign
id|__iopte
c_func
(paren
id|pteval
)paren
suffix:semicolon
id|pteval
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|len
op_sub_assign
(paren
id|PAGE_SIZE
op_minus
id|offset
)paren
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
id|dma_npages
op_decrement
suffix:semicolon
)brace
id|pteval
op_assign
(paren
id|pteval
op_amp
id|IOPTE_PAGE
)paren
op_plus
id|len
suffix:semicolon
id|sg
op_increment
suffix:semicolon
multiline_comment|/* Skip over any tail mappings we&squot;ve fully mapped,&n;&t;&t;&t; * adjusting pteval along the way.  Stop when we&n;&t;&t;&t; * detect a page crossing event.&n;&t;&t;&t; */
r_while
c_loop
(paren
(paren
id|pteval
op_lshift
(paren
l_int|64
op_minus
id|PAGE_SHIFT
)paren
)paren
op_ne
l_int|0UL
op_logical_and
id|pteval
op_eq
id|__pa
c_func
(paren
id|sg-&gt;address
)paren
op_logical_and
(paren
(paren
id|pteval
op_xor
(paren
id|__pa
c_func
(paren
id|sg-&gt;address
)paren
op_plus
id|sg-&gt;length
op_minus
l_int|1UL
)paren
)paren
op_rshift
id|PAGE_SHIFT
)paren
op_eq
l_int|0UL
)paren
(brace
id|pteval
op_add_assign
id|sg-&gt;length
suffix:semicolon
id|sg
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pteval
op_lshift
(paren
l_int|64
op_minus
id|PAGE_SHIFT
)paren
)paren
op_eq
l_int|0UL
)paren
id|pteval
op_assign
op_complement
l_int|0UL
suffix:semicolon
)brace
r_while
c_loop
(paren
id|dma_npages
op_ne
l_int|0
)paren
suffix:semicolon
id|dma_sg
op_increment
suffix:semicolon
)brace
)brace
DECL|function|sbus_map_sg
r_int
id|sbus_map_sg
c_func
(paren
r_struct
id|sbus_dev
op_star
id|sdev
comma
r_struct
id|scatterlist
op_star
id|sg
comma
r_int
id|nents
comma
r_int
id|dir
)paren
(brace
r_struct
id|sbus_iommu
op_star
id|iommu
op_assign
id|sdev-&gt;bus-&gt;iommu
suffix:semicolon
r_int
r_int
id|flags
comma
id|npages
suffix:semicolon
id|iopte_t
op_star
id|iopte
suffix:semicolon
id|u32
id|dma_base
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sgtmp
suffix:semicolon
r_int
id|used
suffix:semicolon
r_int
r_int
id|iopte_bits
suffix:semicolon
r_if
c_cond
(paren
id|dir
op_eq
id|SBUS_DMA_NONE
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Fast path single entry scatterlists. */
r_if
c_cond
(paren
id|nents
op_eq
l_int|1
)paren
(brace
id|sg-&gt;dvma_address
op_assign
id|sbus_map_single
c_func
(paren
id|sdev
comma
id|sg-&gt;address
comma
id|sg-&gt;length
comma
id|dir
)paren
suffix:semicolon
id|sg-&gt;dvma_length
op_assign
id|sg-&gt;length
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|npages
op_assign
id|prepare_sg
c_func
(paren
id|sg
comma
id|nents
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|iopte
op_assign
id|alloc_streaming_cluster
c_func
(paren
id|iommu
comma
id|npages
)paren
suffix:semicolon
id|dma_base
op_assign
id|MAP_BASE
op_plus
(paren
(paren
id|iopte
op_minus
id|iommu-&gt;page_table
)paren
op_lshift
id|PAGE_SHIFT
)paren
suffix:semicolon
multiline_comment|/* Normalize DVMA addresses. */
id|sgtmp
op_assign
id|sg
suffix:semicolon
id|used
op_assign
id|nents
suffix:semicolon
r_while
c_loop
(paren
id|used
op_logical_and
id|sgtmp-&gt;dvma_length
)paren
(brace
id|sgtmp-&gt;dvma_address
op_add_assign
id|dma_base
suffix:semicolon
id|sgtmp
op_increment
suffix:semicolon
id|used
op_decrement
suffix:semicolon
)brace
id|used
op_assign
id|nents
op_minus
id|used
suffix:semicolon
id|iopte_bits
op_assign
id|IOPTE_VALID
op_or
id|IOPTE_STBUF
op_or
id|IOPTE_CACHE
suffix:semicolon
r_if
c_cond
(paren
id|dir
op_ne
id|SBUS_DMA_TODEVICE
)paren
id|iopte_bits
op_or_assign
id|IOPTE_WRITE
suffix:semicolon
id|fill_sg
c_func
(paren
id|iopte
comma
id|sg
comma
id|used
comma
id|iopte_bits
)paren
suffix:semicolon
macro_line|#ifdef VERIFY_SG
id|verify_sglist
c_func
(paren
id|sg
comma
id|nents
comma
id|iopte
comma
id|npages
)paren
suffix:semicolon
macro_line|#endif
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|used
suffix:semicolon
)brace
DECL|function|sbus_unmap_sg
r_void
id|sbus_unmap_sg
c_func
(paren
r_struct
id|sbus_dev
op_star
id|sdev
comma
r_struct
id|scatterlist
op_star
id|sg
comma
r_int
id|nents
comma
r_int
id|direction
)paren
(brace
r_int
r_int
id|size
comma
id|flags
suffix:semicolon
r_struct
id|sbus_iommu
op_star
id|iommu
suffix:semicolon
id|u32
id|dvma_base
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Fast path single entry scatterlists. */
r_if
c_cond
(paren
id|nents
op_eq
l_int|1
)paren
(brace
id|sbus_unmap_single
c_func
(paren
id|sdev
comma
id|sg-&gt;dvma_address
comma
id|sg-&gt;dvma_length
comma
id|direction
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dvma_base
op_assign
id|sg
(braket
l_int|0
)braket
dot
id|dvma_address
op_amp
id|PAGE_MASK
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nents
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|sg
(braket
id|i
)braket
dot
id|dvma_length
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
id|i
op_decrement
suffix:semicolon
id|size
op_assign
id|PAGE_ALIGN
c_func
(paren
id|sg
(braket
id|i
)braket
dot
id|dvma_address
op_plus
id|sg
(braket
id|i
)braket
dot
id|dvma_length
)paren
op_minus
id|dvma_base
suffix:semicolon
id|iommu
op_assign
id|sdev-&gt;bus-&gt;iommu
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|free_streaming_cluster
c_func
(paren
id|iommu
comma
id|dvma_base
comma
id|size
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|strbuf_flush
c_func
(paren
id|iommu
comma
id|dvma_base
comma
id|size
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|sbus_dma_sync_single
r_void
id|sbus_dma_sync_single
c_func
(paren
r_struct
id|sbus_dev
op_star
id|sdev
comma
id|dma_addr_t
id|base
comma
r_int
id|size
comma
r_int
id|direction
)paren
(brace
r_struct
id|sbus_iommu
op_star
id|iommu
op_assign
id|sdev-&gt;bus-&gt;iommu
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|size
op_assign
(paren
id|PAGE_ALIGN
c_func
(paren
id|base
op_plus
id|size
)paren
op_minus
(paren
id|base
op_amp
id|PAGE_MASK
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|strbuf_flush
c_func
(paren
id|iommu
comma
id|base
op_amp
id|PAGE_MASK
comma
id|size
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|sbus_dma_sync_sg
r_void
id|sbus_dma_sync_sg
c_func
(paren
r_struct
id|sbus_dev
op_star
id|sdev
comma
r_struct
id|scatterlist
op_star
id|sg
comma
r_int
id|nents
comma
r_int
id|direction
)paren
(brace
r_struct
id|sbus_iommu
op_star
id|iommu
op_assign
id|sdev-&gt;bus-&gt;iommu
suffix:semicolon
r_int
r_int
id|flags
comma
id|size
suffix:semicolon
id|u32
id|base
suffix:semicolon
r_int
id|i
suffix:semicolon
id|base
op_assign
id|sg
(braket
l_int|0
)braket
dot
id|dvma_address
op_amp
id|PAGE_MASK
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nents
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|sg
(braket
id|i
)braket
dot
id|dvma_length
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
id|i
op_decrement
suffix:semicolon
id|size
op_assign
id|PAGE_ALIGN
c_func
(paren
id|sg
(braket
id|i
)braket
dot
id|dvma_address
op_plus
id|sg
(braket
id|i
)braket
dot
id|dvma_length
)paren
op_minus
id|base
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|strbuf_flush
c_func
(paren
id|iommu
comma
id|base
comma
id|size
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Enable 64-bit DVMA mode for the given device. */
DECL|function|sbus_set_sbus64
r_void
id|sbus_set_sbus64
c_func
(paren
r_struct
id|sbus_dev
op_star
id|sdev
comma
r_int
id|bursts
)paren
(brace
r_struct
id|sbus_iommu
op_star
id|iommu
op_assign
id|sdev-&gt;bus-&gt;iommu
suffix:semicolon
r_int
id|slot
op_assign
id|sdev-&gt;slot
suffix:semicolon
r_int
r_int
id|cfg_reg
suffix:semicolon
id|u64
id|val
suffix:semicolon
id|cfg_reg
op_assign
id|iommu-&gt;sbus_control_reg
suffix:semicolon
r_switch
c_cond
(paren
id|slot
)paren
(brace
r_case
l_int|0
suffix:colon
id|cfg_reg
op_add_assign
l_int|0x20UL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|cfg_reg
op_add_assign
l_int|0x28UL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|cfg_reg
op_add_assign
l_int|0x30UL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|cfg_reg
op_add_assign
l_int|0x38UL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|13
suffix:colon
id|cfg_reg
op_add_assign
l_int|0x40UL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|14
suffix:colon
id|cfg_reg
op_add_assign
l_int|0x48UL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|15
suffix:colon
id|cfg_reg
op_add_assign
l_int|0x50UL
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
suffix:semicolon
)brace
suffix:semicolon
id|val
op_assign
id|upa_readq
c_func
(paren
id|cfg_reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
(paren
l_int|1UL
op_lshift
l_int|14UL
)paren
)paren
(brace
multiline_comment|/* Extended transfer mode already enabled. */
r_return
suffix:semicolon
)brace
id|val
op_or_assign
(paren
l_int|1UL
op_lshift
l_int|14UL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bursts
op_amp
id|DMA_BURST8
)paren
id|val
op_or_assign
(paren
l_int|1UL
op_lshift
l_int|1UL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bursts
op_amp
id|DMA_BURST16
)paren
id|val
op_or_assign
(paren
l_int|1UL
op_lshift
l_int|2UL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bursts
op_amp
id|DMA_BURST32
)paren
id|val
op_or_assign
(paren
l_int|1UL
op_lshift
l_int|3UL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bursts
op_amp
id|DMA_BURST64
)paren
id|val
op_or_assign
(paren
l_int|1UL
op_lshift
l_int|4UL
)paren
suffix:semicolon
id|upa_writeq
c_func
(paren
id|val
comma
id|cfg_reg
)paren
suffix:semicolon
)brace
multiline_comment|/* SBUS SYSIO INO number to Sparc PIL level. */
DECL|variable|sysio_ino_to_pil
r_static
r_int
r_char
id|sysio_ino_to_pil
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|1
comma
l_int|2
comma
l_int|7
comma
l_int|5
comma
l_int|7
comma
l_int|8
comma
l_int|9
comma
multiline_comment|/* SBUS slot 0 */
l_int|0
comma
l_int|1
comma
l_int|2
comma
l_int|7
comma
l_int|5
comma
l_int|7
comma
l_int|8
comma
l_int|9
comma
multiline_comment|/* SBUS slot 1 */
l_int|0
comma
l_int|1
comma
l_int|2
comma
l_int|7
comma
l_int|5
comma
l_int|7
comma
l_int|8
comma
l_int|9
comma
multiline_comment|/* SBUS slot 2 */
l_int|0
comma
l_int|1
comma
l_int|2
comma
l_int|7
comma
l_int|5
comma
l_int|7
comma
l_int|8
comma
l_int|9
comma
multiline_comment|/* SBUS slot 3 */
l_int|3
comma
multiline_comment|/* Onboard SCSI */
l_int|5
comma
multiline_comment|/* Onboard Ethernet */
multiline_comment|/*XXX*/
l_int|8
comma
multiline_comment|/* Onboard BPP */
l_int|0
comma
multiline_comment|/* Bogon */
l_int|13
comma
multiline_comment|/* Audio */
multiline_comment|/*XXX*/
l_int|15
comma
multiline_comment|/* PowerFail */
l_int|0
comma
multiline_comment|/* Bogon */
l_int|0
comma
multiline_comment|/* Bogon */
l_int|12
comma
multiline_comment|/* Zilog Serial Channels (incl. Keyboard/Mouse lines) */
l_int|11
comma
multiline_comment|/* Floppy */
l_int|0
comma
multiline_comment|/* Spare Hardware (bogon for now) */
l_int|0
comma
multiline_comment|/* Keyboard (bogon for now) */
l_int|0
comma
multiline_comment|/* Mouse (bogon for now) */
l_int|0
comma
multiline_comment|/* Serial (bogon for now) */
l_int|0
comma
l_int|0
comma
multiline_comment|/* Bogon, Bogon */
l_int|10
comma
multiline_comment|/* Timer 0 */
l_int|11
comma
multiline_comment|/* Timer 1 */
l_int|0
comma
l_int|0
comma
multiline_comment|/* Bogon, Bogon */
l_int|15
comma
multiline_comment|/* Uncorrectable SBUS Error */
l_int|15
comma
multiline_comment|/* Correctable SBUS Error */
l_int|15
comma
multiline_comment|/* SBUS Error */
multiline_comment|/*XXX*/
l_int|0
comma
multiline_comment|/* Power Management (bogon for now) */
)brace
suffix:semicolon
multiline_comment|/* INO number to IMAP register offset for SYSIO external IRQ&squot;s.&n; * This should conform to both Sunfire/Wildfire server and Fusion&n; * desktop designs.&n; */
DECL|macro|SYSIO_IMAP_SLOT0
mdefine_line|#define SYSIO_IMAP_SLOT0&t;0x2c04UL
DECL|macro|SYSIO_IMAP_SLOT1
mdefine_line|#define SYSIO_IMAP_SLOT1&t;0x2c0cUL
DECL|macro|SYSIO_IMAP_SLOT2
mdefine_line|#define SYSIO_IMAP_SLOT2&t;0x2c14UL
DECL|macro|SYSIO_IMAP_SLOT3
mdefine_line|#define SYSIO_IMAP_SLOT3&t;0x2c1cUL
DECL|macro|SYSIO_IMAP_SCSI
mdefine_line|#define SYSIO_IMAP_SCSI&t;&t;0x3004UL
DECL|macro|SYSIO_IMAP_ETH
mdefine_line|#define SYSIO_IMAP_ETH&t;&t;0x300cUL
DECL|macro|SYSIO_IMAP_BPP
mdefine_line|#define SYSIO_IMAP_BPP&t;&t;0x3014UL
DECL|macro|SYSIO_IMAP_AUDIO
mdefine_line|#define SYSIO_IMAP_AUDIO&t;0x301cUL
DECL|macro|SYSIO_IMAP_PFAIL
mdefine_line|#define SYSIO_IMAP_PFAIL&t;0x3024UL
DECL|macro|SYSIO_IMAP_KMS
mdefine_line|#define SYSIO_IMAP_KMS&t;&t;0x302cUL
DECL|macro|SYSIO_IMAP_FLPY
mdefine_line|#define SYSIO_IMAP_FLPY&t;&t;0x3034UL
DECL|macro|SYSIO_IMAP_SHW
mdefine_line|#define SYSIO_IMAP_SHW&t;&t;0x303cUL
DECL|macro|SYSIO_IMAP_KBD
mdefine_line|#define SYSIO_IMAP_KBD&t;&t;0x3044UL
DECL|macro|SYSIO_IMAP_MS
mdefine_line|#define SYSIO_IMAP_MS&t;&t;0x304cUL
DECL|macro|SYSIO_IMAP_SER
mdefine_line|#define SYSIO_IMAP_SER&t;&t;0x3054UL
DECL|macro|SYSIO_IMAP_TIM0
mdefine_line|#define SYSIO_IMAP_TIM0&t;&t;0x3064UL
DECL|macro|SYSIO_IMAP_TIM1
mdefine_line|#define SYSIO_IMAP_TIM1&t;&t;0x306cUL
DECL|macro|SYSIO_IMAP_UE
mdefine_line|#define SYSIO_IMAP_UE&t;&t;0x3074UL
DECL|macro|SYSIO_IMAP_CE
mdefine_line|#define SYSIO_IMAP_CE&t;&t;0x307cUL
DECL|macro|SYSIO_IMAP_SBERR
mdefine_line|#define SYSIO_IMAP_SBERR&t;0x3084UL
DECL|macro|SYSIO_IMAP_PMGMT
mdefine_line|#define SYSIO_IMAP_PMGMT&t;0x308cUL
DECL|macro|SYSIO_IMAP_GFX
mdefine_line|#define SYSIO_IMAP_GFX&t;&t;0x3094UL
DECL|macro|SYSIO_IMAP_EUPA
mdefine_line|#define SYSIO_IMAP_EUPA&t;&t;0x309cUL
DECL|macro|bogon
mdefine_line|#define bogon     ((unsigned long) -1)
DECL|variable|sysio_irq_offsets
r_static
r_int
r_int
id|sysio_irq_offsets
(braket
)braket
op_assign
(brace
multiline_comment|/* SBUS Slot 0 --&gt; 3, level 1 --&gt; 7 */
id|SYSIO_IMAP_SLOT0
comma
id|SYSIO_IMAP_SLOT0
comma
id|SYSIO_IMAP_SLOT0
comma
id|SYSIO_IMAP_SLOT0
comma
id|SYSIO_IMAP_SLOT0
comma
id|SYSIO_IMAP_SLOT0
comma
id|SYSIO_IMAP_SLOT0
comma
id|SYSIO_IMAP_SLOT0
comma
id|SYSIO_IMAP_SLOT1
comma
id|SYSIO_IMAP_SLOT1
comma
id|SYSIO_IMAP_SLOT1
comma
id|SYSIO_IMAP_SLOT1
comma
id|SYSIO_IMAP_SLOT1
comma
id|SYSIO_IMAP_SLOT1
comma
id|SYSIO_IMAP_SLOT1
comma
id|SYSIO_IMAP_SLOT1
comma
id|SYSIO_IMAP_SLOT2
comma
id|SYSIO_IMAP_SLOT2
comma
id|SYSIO_IMAP_SLOT2
comma
id|SYSIO_IMAP_SLOT2
comma
id|SYSIO_IMAP_SLOT2
comma
id|SYSIO_IMAP_SLOT2
comma
id|SYSIO_IMAP_SLOT2
comma
id|SYSIO_IMAP_SLOT2
comma
id|SYSIO_IMAP_SLOT3
comma
id|SYSIO_IMAP_SLOT3
comma
id|SYSIO_IMAP_SLOT3
comma
id|SYSIO_IMAP_SLOT3
comma
id|SYSIO_IMAP_SLOT3
comma
id|SYSIO_IMAP_SLOT3
comma
id|SYSIO_IMAP_SLOT3
comma
id|SYSIO_IMAP_SLOT3
comma
multiline_comment|/* Onboard devices (not relevant/used on SunFire). */
id|SYSIO_IMAP_SCSI
comma
id|SYSIO_IMAP_ETH
comma
id|SYSIO_IMAP_BPP
comma
id|bogon
comma
id|SYSIO_IMAP_AUDIO
comma
id|SYSIO_IMAP_PFAIL
comma
id|bogon
comma
id|bogon
comma
id|SYSIO_IMAP_KMS
comma
id|SYSIO_IMAP_FLPY
comma
id|SYSIO_IMAP_SHW
comma
id|SYSIO_IMAP_KBD
comma
id|SYSIO_IMAP_MS
comma
id|SYSIO_IMAP_SER
comma
id|bogon
comma
id|bogon
comma
id|SYSIO_IMAP_TIM0
comma
id|SYSIO_IMAP_TIM1
comma
id|bogon
comma
id|bogon
comma
id|SYSIO_IMAP_UE
comma
id|SYSIO_IMAP_CE
comma
id|SYSIO_IMAP_SBERR
comma
id|SYSIO_IMAP_PMGMT
comma
)brace
suffix:semicolon
DECL|macro|bogon
macro_line|#undef bogon
DECL|macro|NUM_SYSIO_OFFSETS
mdefine_line|#define NUM_SYSIO_OFFSETS (sizeof(sysio_irq_offsets) / sizeof(sysio_irq_offsets[0]))
multiline_comment|/* Convert Interrupt Mapping register pointer to assosciated&n; * Interrupt Clear register pointer, SYSIO specific version.&n; */
DECL|macro|SYSIO_ICLR_UNUSED0
mdefine_line|#define SYSIO_ICLR_UNUSED0&t;0x3400UL
DECL|macro|SYSIO_ICLR_SLOT0
mdefine_line|#define SYSIO_ICLR_SLOT0&t;0x340cUL
DECL|macro|SYSIO_ICLR_SLOT1
mdefine_line|#define SYSIO_ICLR_SLOT1&t;0x344cUL
DECL|macro|SYSIO_ICLR_SLOT2
mdefine_line|#define SYSIO_ICLR_SLOT2&t;0x348cUL
DECL|macro|SYSIO_ICLR_SLOT3
mdefine_line|#define SYSIO_ICLR_SLOT3&t;0x34ccUL
DECL|function|sysio_imap_to_iclr
r_static
r_int
r_int
id|sysio_imap_to_iclr
c_func
(paren
r_int
r_int
id|imap
)paren
(brace
r_int
r_int
id|diff
op_assign
id|SYSIO_ICLR_UNUSED0
op_minus
id|SYSIO_IMAP_SLOT0
suffix:semicolon
r_return
id|imap
op_plus
id|diff
suffix:semicolon
)brace
DECL|function|sbus_build_irq
r_int
r_int
id|sbus_build_irq
c_func
(paren
r_void
op_star
id|buscookie
comma
r_int
r_int
id|ino
)paren
(brace
r_struct
id|sbus_bus
op_star
id|sbus
op_assign
(paren
r_struct
id|sbus_bus
op_star
)paren
id|buscookie
suffix:semicolon
r_struct
id|sbus_iommu
op_star
id|iommu
op_assign
id|sbus-&gt;iommu
suffix:semicolon
r_int
r_int
id|reg_base
op_assign
id|iommu-&gt;sbus_control_reg
op_minus
l_int|0x2000UL
suffix:semicolon
r_int
r_int
id|imap
comma
id|iclr
suffix:semicolon
r_int
id|pil
comma
id|sbus_level
op_assign
l_int|0
suffix:semicolon
id|pil
op_assign
id|sysio_ino_to_pil
(braket
id|ino
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pil
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;sbus_irq_build: Bad SYSIO INO[%x]&bslash;n&quot;
comma
id|ino
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;Bad SYSIO IRQ translations...&quot;
)paren
suffix:semicolon
)brace
id|imap
op_assign
id|sysio_irq_offsets
(braket
id|ino
)braket
suffix:semicolon
r_if
c_cond
(paren
id|imap
op_eq
(paren
(paren
r_int
r_int
)paren
op_minus
l_int|1
)paren
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;get_irq_translations: Bad SYSIO INO[%x] cpu[%d]&bslash;n&quot;
comma
id|ino
comma
id|pil
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|imap
op_add_assign
id|reg_base
suffix:semicolon
multiline_comment|/* SYSIO inconsistancy.  For external SLOTS, we have to select&n;&t; * the right ICLR register based upon the lower SBUS irq level&n;&t; * bits.&n;&t; */
r_if
c_cond
(paren
id|ino
op_ge
l_int|0x20
)paren
(brace
id|iclr
op_assign
id|sysio_imap_to_iclr
c_func
(paren
id|imap
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
id|sbus_slot
op_assign
(paren
id|ino
op_amp
l_int|0x18
)paren
op_rshift
l_int|3
suffix:semicolon
id|sbus_level
op_assign
id|ino
op_amp
l_int|0x7
suffix:semicolon
r_switch
c_cond
(paren
id|sbus_slot
)paren
(brace
r_case
l_int|0
suffix:colon
id|iclr
op_assign
id|reg_base
op_plus
id|SYSIO_ICLR_SLOT0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|iclr
op_assign
id|reg_base
op_plus
id|SYSIO_ICLR_SLOT1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|iclr
op_assign
id|reg_base
op_plus
id|SYSIO_ICLR_SLOT2
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_case
l_int|3
suffix:colon
id|iclr
op_assign
id|reg_base
op_plus
id|SYSIO_ICLR_SLOT3
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
id|iclr
op_add_assign
(paren
(paren
r_int
r_int
)paren
id|sbus_level
op_minus
l_int|1UL
)paren
op_star
l_int|8UL
suffix:semicolon
)brace
r_return
id|build_irq
c_func
(paren
id|pil
comma
id|sbus_level
comma
id|iclr
comma
id|imap
)paren
suffix:semicolon
)brace
multiline_comment|/* Error interrupt handling. */
DECL|macro|SYSIO_UE_AFSR
mdefine_line|#define SYSIO_UE_AFSR&t;0x0030UL
DECL|macro|SYSIO_UE_AFAR
mdefine_line|#define SYSIO_UE_AFAR&t;0x0038UL
DECL|macro|SYSIO_UEAFSR_PPIO
mdefine_line|#define  SYSIO_UEAFSR_PPIO&t;0x8000000000000000 /* Primary PIO is cause         */
DECL|macro|SYSIO_UEAFSR_PDRD
mdefine_line|#define  SYSIO_UEAFSR_PDRD&t;0x4000000000000000 /* Primary DVMA read is cause   */
DECL|macro|SYSIO_UEAFSR_PDWR
mdefine_line|#define  SYSIO_UEAFSR_PDWR&t;0x2000000000000000 /* Primary DVMA write is cause  */
DECL|macro|SYSIO_UEAFSR_SPIO
mdefine_line|#define  SYSIO_UEAFSR_SPIO&t;0x1000000000000000 /* Secondary PIO is cause       */
DECL|macro|SYSIO_UEAFSR_SDRD
mdefine_line|#define  SYSIO_UEAFSR_SDRD&t;0x0800000000000000 /* Secondary DVMA read is cause */
DECL|macro|SYSIO_UEAFSR_SDWR
mdefine_line|#define  SYSIO_UEAFSR_SDWR&t;0x0400000000000000 /* Secondary DVMA write is cause*/
DECL|macro|SYSIO_UEAFSR_RESV1
mdefine_line|#define  SYSIO_UEAFSR_RESV1&t;0x03ff000000000000 /* Reserved                     */
DECL|macro|SYSIO_UEAFSR_DOFF
mdefine_line|#define  SYSIO_UEAFSR_DOFF&t;0x0000e00000000000 /* Doubleword Offset            */
DECL|macro|SYSIO_UEAFSR_SIZE
mdefine_line|#define  SYSIO_UEAFSR_SIZE&t;0x00001c0000000000 /* Bad transfer size is 2**SIZE */
DECL|macro|SYSIO_UEAFSR_MID
mdefine_line|#define  SYSIO_UEAFSR_MID&t;0x000003e000000000 /* UPA MID causing the fault    */
DECL|macro|SYSIO_UEAFSR_RESV2
mdefine_line|#define  SYSIO_UEAFSR_RESV2&t;0x0000001fffffffff /* Reserved                     */
DECL|function|sysio_ue_handler
r_static
r_void
id|sysio_ue_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|sbus_bus
op_star
id|sbus
op_assign
id|dev_id
suffix:semicolon
r_struct
id|sbus_iommu
op_star
id|iommu
op_assign
id|sbus-&gt;iommu
suffix:semicolon
r_int
r_int
id|reg_base
op_assign
id|iommu-&gt;sbus_control_reg
op_minus
l_int|0x2000UL
suffix:semicolon
r_int
r_int
id|afsr_reg
comma
id|afar_reg
suffix:semicolon
r_int
r_int
id|afsr
comma
id|afar
comma
id|error_bits
suffix:semicolon
r_int
id|reported
suffix:semicolon
id|afsr_reg
op_assign
id|reg_base
op_plus
id|SYSIO_UE_AFSR
suffix:semicolon
id|afar_reg
op_assign
id|reg_base
op_plus
id|SYSIO_UE_AFAR
suffix:semicolon
multiline_comment|/* Latch error status. */
id|afsr
op_assign
id|upa_readq
c_func
(paren
id|afsr_reg
)paren
suffix:semicolon
id|afar
op_assign
id|upa_readq
c_func
(paren
id|afar_reg
)paren
suffix:semicolon
multiline_comment|/* Clear primary/secondary error status bits. */
id|error_bits
op_assign
id|afsr
op_amp
(paren
id|SYSIO_UEAFSR_PPIO
op_or
id|SYSIO_UEAFSR_PDRD
op_or
id|SYSIO_UEAFSR_PDWR
op_or
id|SYSIO_UEAFSR_SPIO
op_or
id|SYSIO_UEAFSR_SDRD
op_or
id|SYSIO_UEAFSR_SDWR
)paren
suffix:semicolon
id|upa_writeq
c_func
(paren
id|error_bits
comma
id|afsr_reg
)paren
suffix:semicolon
multiline_comment|/* Log the error. */
id|printk
c_func
(paren
l_string|&quot;SYSIO[%x]: Uncorrectable ECC Error, primary error type[%s]&bslash;n&quot;
comma
id|sbus-&gt;portid
comma
(paren
(paren
(paren
id|error_bits
op_amp
id|SYSIO_UEAFSR_PPIO
)paren
ques
c_cond
l_string|&quot;PIO&quot;
suffix:colon
(paren
(paren
id|error_bits
op_amp
id|SYSIO_UEAFSR_PDRD
)paren
ques
c_cond
l_string|&quot;DVMA Read&quot;
suffix:colon
(paren
(paren
id|error_bits
op_amp
id|SYSIO_UEAFSR_PDWR
)paren
ques
c_cond
l_string|&quot;DVMA Write&quot;
suffix:colon
l_string|&quot;???&quot;
)paren
)paren
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SYSIO[%x]: DOFF[%lx] SIZE[%lx] MID[%lx]&bslash;n&quot;
comma
id|sbus-&gt;portid
comma
(paren
id|afsr
op_amp
id|SYSIO_UEAFSR_DOFF
)paren
op_rshift
l_int|45UL
comma
(paren
id|afsr
op_amp
id|SYSIO_UEAFSR_SIZE
)paren
op_rshift
l_int|42UL
comma
(paren
id|afsr
op_amp
id|SYSIO_UEAFSR_MID
)paren
op_rshift
l_int|37UL
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SYSIO[%x]: AFAR[%016lx]&bslash;n&quot;
comma
id|sbus-&gt;portid
comma
id|afar
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SYSIO[%x]: Secondary UE errors [&quot;
comma
id|sbus-&gt;portid
)paren
suffix:semicolon
id|reported
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|afsr
op_amp
id|SYSIO_UEAFSR_SPIO
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(PIO)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|afsr
op_amp
id|SYSIO_UEAFSR_SDRD
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(DVMA Read)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|afsr
op_amp
id|SYSIO_UEAFSR_SDWR
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(DVMA Write)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|reported
)paren
id|printk
c_func
(paren
l_string|&quot;(none)&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;]&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|macro|SYSIO_CE_AFSR
mdefine_line|#define SYSIO_CE_AFSR&t;0x0040UL
DECL|macro|SYSIO_CE_AFAR
mdefine_line|#define SYSIO_CE_AFAR&t;0x0048UL
DECL|macro|SYSIO_CEAFSR_PPIO
mdefine_line|#define  SYSIO_CEAFSR_PPIO&t;0x8000000000000000 /* Primary PIO is cause         */
DECL|macro|SYSIO_CEAFSR_PDRD
mdefine_line|#define  SYSIO_CEAFSR_PDRD&t;0x4000000000000000 /* Primary DVMA read is cause   */
DECL|macro|SYSIO_CEAFSR_PDWR
mdefine_line|#define  SYSIO_CEAFSR_PDWR&t;0x2000000000000000 /* Primary DVMA write is cause  */
DECL|macro|SYSIO_CEAFSR_SPIO
mdefine_line|#define  SYSIO_CEAFSR_SPIO&t;0x1000000000000000 /* Secondary PIO is cause       */
DECL|macro|SYSIO_CEAFSR_SDRD
mdefine_line|#define  SYSIO_CEAFSR_SDRD&t;0x0800000000000000 /* Secondary DVMA read is cause */
DECL|macro|SYSIO_CEAFSR_SDWR
mdefine_line|#define  SYSIO_CEAFSR_SDWR&t;0x0400000000000000 /* Secondary DVMA write is cause*/
DECL|macro|SYSIO_CEAFSR_RESV1
mdefine_line|#define  SYSIO_CEAFSR_RESV1&t;0x0300000000000000 /* Reserved                     */
DECL|macro|SYSIO_CEAFSR_ESYND
mdefine_line|#define  SYSIO_CEAFSR_ESYND&t;0x00ff000000000000 /* Syndrome Bits                */
DECL|macro|SYSIO_CEAFSR_DOFF
mdefine_line|#define  SYSIO_CEAFSR_DOFF&t;0x0000e00000000000 /* Double Offset                */
DECL|macro|SYSIO_CEAFSR_SIZE
mdefine_line|#define  SYSIO_CEAFSR_SIZE&t;0x00001c0000000000 /* Bad transfer size is 2**SIZE */
DECL|macro|SYSIO_CEAFSR_MID
mdefine_line|#define  SYSIO_CEAFSR_MID&t;0x000003e000000000 /* UPA MID causing the fault    */
DECL|macro|SYSIO_CEAFSR_RESV2
mdefine_line|#define  SYSIO_CEAFSR_RESV2&t;0x0000001fffffffff /* Reserved                     */
DECL|function|sysio_ce_handler
r_static
r_void
id|sysio_ce_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|sbus_bus
op_star
id|sbus
op_assign
id|dev_id
suffix:semicolon
r_struct
id|sbus_iommu
op_star
id|iommu
op_assign
id|sbus-&gt;iommu
suffix:semicolon
r_int
r_int
id|reg_base
op_assign
id|iommu-&gt;sbus_control_reg
op_minus
l_int|0x2000UL
suffix:semicolon
r_int
r_int
id|afsr_reg
comma
id|afar_reg
suffix:semicolon
r_int
r_int
id|afsr
comma
id|afar
comma
id|error_bits
suffix:semicolon
r_int
id|reported
suffix:semicolon
id|afsr_reg
op_assign
id|reg_base
op_plus
id|SYSIO_CE_AFSR
suffix:semicolon
id|afar_reg
op_assign
id|reg_base
op_plus
id|SYSIO_CE_AFAR
suffix:semicolon
multiline_comment|/* Latch error status. */
id|afsr
op_assign
id|upa_readq
c_func
(paren
id|afsr_reg
)paren
suffix:semicolon
id|afar
op_assign
id|upa_readq
c_func
(paren
id|afar_reg
)paren
suffix:semicolon
multiline_comment|/* Clear primary/secondary error status bits. */
id|error_bits
op_assign
id|afsr
op_amp
(paren
id|SYSIO_CEAFSR_PPIO
op_or
id|SYSIO_CEAFSR_PDRD
op_or
id|SYSIO_CEAFSR_PDWR
op_or
id|SYSIO_CEAFSR_SPIO
op_or
id|SYSIO_CEAFSR_SDRD
op_or
id|SYSIO_CEAFSR_SDWR
)paren
suffix:semicolon
id|upa_writeq
c_func
(paren
id|error_bits
comma
id|afsr_reg
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SYSIO[%x]: Correctable ECC Error, primary error type[%s]&bslash;n&quot;
comma
id|sbus-&gt;portid
comma
(paren
(paren
(paren
id|error_bits
op_amp
id|SYSIO_CEAFSR_PPIO
)paren
ques
c_cond
l_string|&quot;PIO&quot;
suffix:colon
(paren
(paren
id|error_bits
op_amp
id|SYSIO_CEAFSR_PDRD
)paren
ques
c_cond
l_string|&quot;DVMA Read&quot;
suffix:colon
(paren
(paren
id|error_bits
op_amp
id|SYSIO_CEAFSR_PDWR
)paren
ques
c_cond
l_string|&quot;DVMA Write&quot;
suffix:colon
l_string|&quot;???&quot;
)paren
)paren
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* XXX Use syndrome and afar to print out module string just like&n;&t; * XXX UDB CE trap handler does... -DaveM&n;&t; */
id|printk
c_func
(paren
l_string|&quot;SYSIO[%x]: DOFF[%lx] ECC Syndrome[%lx] Size[%lx] MID[%lx]&bslash;n&quot;
comma
id|sbus-&gt;portid
comma
(paren
id|afsr
op_amp
id|SYSIO_CEAFSR_DOFF
)paren
op_rshift
l_int|45UL
comma
(paren
id|afsr
op_amp
id|SYSIO_CEAFSR_ESYND
)paren
op_rshift
l_int|48UL
comma
(paren
id|afsr
op_amp
id|SYSIO_CEAFSR_SIZE
)paren
op_rshift
l_int|42UL
comma
(paren
id|afsr
op_amp
id|SYSIO_CEAFSR_MID
)paren
op_rshift
l_int|37UL
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SYSIO[%x]: AFAR[%016lx]&bslash;n&quot;
comma
id|sbus-&gt;portid
comma
id|afar
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SYSIO[%x]: Secondary CE errors [&quot;
comma
id|sbus-&gt;portid
)paren
suffix:semicolon
id|reported
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|afsr
op_amp
id|SYSIO_CEAFSR_SPIO
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(PIO)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|afsr
op_amp
id|SYSIO_CEAFSR_SDRD
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(DVMA Read)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|afsr
op_amp
id|SYSIO_CEAFSR_SDWR
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(DVMA Write)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|reported
)paren
id|printk
c_func
(paren
l_string|&quot;(none)&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;]&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|macro|SYSIO_SBUS_AFSR
mdefine_line|#define SYSIO_SBUS_AFSR&t;&t;0x2010UL
DECL|macro|SYSIO_SBUS_AFAR
mdefine_line|#define SYSIO_SBUS_AFAR&t;&t;0x2018UL
DECL|macro|SYSIO_SBAFSR_PLE
mdefine_line|#define  SYSIO_SBAFSR_PLE&t;0x8000000000000000 /* Primary Late PIO Error       */
DECL|macro|SYSIO_SBAFSR_PTO
mdefine_line|#define  SYSIO_SBAFSR_PTO&t;0x4000000000000000 /* Primary SBUS Timeout         */
DECL|macro|SYSIO_SBAFSR_PBERR
mdefine_line|#define  SYSIO_SBAFSR_PBERR&t;0x2000000000000000 /* Primary SBUS Error ACK       */
DECL|macro|SYSIO_SBAFSR_SLE
mdefine_line|#define  SYSIO_SBAFSR_SLE&t;0x1000000000000000 /* Secondary Late PIO Error     */
DECL|macro|SYSIO_SBAFSR_STO
mdefine_line|#define  SYSIO_SBAFSR_STO&t;0x0800000000000000 /* Secondary SBUS Timeout       */
DECL|macro|SYSIO_SBAFSR_SBERR
mdefine_line|#define  SYSIO_SBAFSR_SBERR&t;0x0400000000000000 /* Secondary SBUS Error ACK     */
DECL|macro|SYSIO_SBAFSR_RESV1
mdefine_line|#define  SYSIO_SBAFSR_RESV1&t;0x03ff000000000000 /* Reserved                     */
DECL|macro|SYSIO_SBAFSR_RD
mdefine_line|#define  SYSIO_SBAFSR_RD&t;0x0000800000000000 /* Primary was late PIO read    */
DECL|macro|SYSIO_SBAFSR_RESV2
mdefine_line|#define  SYSIO_SBAFSR_RESV2&t;0x0000600000000000 /* Reserved                     */
DECL|macro|SYSIO_SBAFSR_SIZE
mdefine_line|#define  SYSIO_SBAFSR_SIZE&t;0x00001c0000000000 /* Size of transfer             */
DECL|macro|SYSIO_SBAFSR_MID
mdefine_line|#define  SYSIO_SBAFSR_MID&t;0x000003e000000000 /* MID causing the error        */
DECL|macro|SYSIO_SBAFSR_RESV3
mdefine_line|#define  SYSIO_SBAFSR_RESV3&t;0x0000001fffffffff /* Reserved                     */
DECL|function|sysio_sbus_error_handler
r_static
r_void
id|sysio_sbus_error_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|sbus_bus
op_star
id|sbus
op_assign
id|dev_id
suffix:semicolon
r_struct
id|sbus_iommu
op_star
id|iommu
op_assign
id|sbus-&gt;iommu
suffix:semicolon
r_int
r_int
id|afsr_reg
comma
id|afar_reg
comma
id|reg_base
suffix:semicolon
r_int
r_int
id|afsr
comma
id|afar
comma
id|error_bits
suffix:semicolon
r_int
id|reported
suffix:semicolon
id|reg_base
op_assign
id|iommu-&gt;sbus_control_reg
op_minus
l_int|0x2000UL
suffix:semicolon
id|afsr_reg
op_assign
id|reg_base
op_plus
id|SYSIO_SBUS_AFSR
suffix:semicolon
id|afar_reg
op_assign
id|reg_base
op_plus
id|SYSIO_SBUS_AFAR
suffix:semicolon
id|afsr
op_assign
id|upa_readq
c_func
(paren
id|afsr_reg
)paren
suffix:semicolon
id|afar
op_assign
id|upa_readq
c_func
(paren
id|afar_reg
)paren
suffix:semicolon
multiline_comment|/* Clear primary/secondary error status bits. */
id|error_bits
op_assign
id|afsr
op_amp
(paren
id|SYSIO_SBAFSR_PLE
op_or
id|SYSIO_SBAFSR_PTO
op_or
id|SYSIO_SBAFSR_PBERR
op_or
id|SYSIO_SBAFSR_SLE
op_or
id|SYSIO_SBAFSR_STO
op_or
id|SYSIO_SBAFSR_SBERR
)paren
suffix:semicolon
id|upa_writeq
c_func
(paren
id|error_bits
comma
id|afsr_reg
)paren
suffix:semicolon
multiline_comment|/* Log the error. */
id|printk
c_func
(paren
l_string|&quot;SYSIO[%x]: SBUS Error, primary error type[%s] read(%d)&bslash;n&quot;
comma
id|sbus-&gt;portid
comma
(paren
(paren
(paren
id|error_bits
op_amp
id|SYSIO_SBAFSR_PLE
)paren
ques
c_cond
l_string|&quot;Late PIO Error&quot;
suffix:colon
(paren
(paren
id|error_bits
op_amp
id|SYSIO_SBAFSR_PTO
)paren
ques
c_cond
l_string|&quot;Time Out&quot;
suffix:colon
(paren
(paren
id|error_bits
op_amp
id|SYSIO_SBAFSR_PBERR
)paren
ques
c_cond
l_string|&quot;Error Ack&quot;
suffix:colon
l_string|&quot;???&quot;
)paren
)paren
)paren
)paren
comma
(paren
id|afsr
op_amp
id|SYSIO_SBAFSR_RD
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SYSIO[%x]: size[%lx] MID[%lx]&bslash;n&quot;
comma
id|sbus-&gt;portid
comma
(paren
id|afsr
op_amp
id|SYSIO_SBAFSR_SIZE
)paren
op_rshift
l_int|42UL
comma
(paren
id|afsr
op_amp
id|SYSIO_SBAFSR_MID
)paren
op_rshift
l_int|37UL
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SYSIO[%x]: AFAR[%016lx]&bslash;n&quot;
comma
id|sbus-&gt;portid
comma
id|afar
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SYSIO[%x]: Secondary SBUS errors [&quot;
comma
id|sbus-&gt;portid
)paren
suffix:semicolon
id|reported
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|afsr
op_amp
id|SYSIO_SBAFSR_SLE
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(Late PIO Error)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|afsr
op_amp
id|SYSIO_SBAFSR_STO
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(Time Out)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|afsr
op_amp
id|SYSIO_SBAFSR_SBERR
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(Error Ack)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|reported
)paren
id|printk
c_func
(paren
l_string|&quot;(none)&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;]&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* XXX check iommu/strbuf for further error status XXX */
)brace
DECL|macro|ECC_CONTROL
mdefine_line|#define ECC_CONTROL&t;0x0020UL
DECL|macro|SYSIO_ECNTRL_ECCEN
mdefine_line|#define  SYSIO_ECNTRL_ECCEN&t;0x8000000000000000 /* Enable ECC Checking          */
DECL|macro|SYSIO_ECNTRL_UEEN
mdefine_line|#define  SYSIO_ECNTRL_UEEN&t;0x4000000000000000 /* Enable UE Interrupts         */
DECL|macro|SYSIO_ECNTRL_CEEN
mdefine_line|#define  SYSIO_ECNTRL_CEEN&t;0x2000000000000000 /* Enable CE Interrupts         */
DECL|macro|SYSIO_UE_INO
mdefine_line|#define SYSIO_UE_INO&t;&t;0x34
DECL|macro|SYSIO_CE_INO
mdefine_line|#define SYSIO_CE_INO&t;&t;0x35
DECL|macro|SYSIO_SBUSERR_INO
mdefine_line|#define SYSIO_SBUSERR_INO&t;0x36
DECL|function|sysio_register_error_handlers
r_static
r_void
id|__init
id|sysio_register_error_handlers
c_func
(paren
r_struct
id|sbus_bus
op_star
id|sbus
)paren
(brace
r_struct
id|sbus_iommu
op_star
id|iommu
op_assign
id|sbus-&gt;iommu
suffix:semicolon
r_int
r_int
id|reg_base
op_assign
id|iommu-&gt;sbus_control_reg
op_minus
l_int|0x2000UL
suffix:semicolon
r_int
r_int
id|irq
suffix:semicolon
id|u64
id|control
suffix:semicolon
id|irq
op_assign
id|sbus_build_irq
c_func
(paren
id|sbus
comma
id|SYSIO_UE_INO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|sysio_ue_handler
comma
id|SA_SHIRQ
comma
l_string|&quot;SYSIO UE&quot;
comma
id|sbus
)paren
OL
l_int|0
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SYSIO[%x]: Cannot register UE interrupt.&bslash;n&quot;
comma
id|sbus-&gt;portid
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|irq
op_assign
id|sbus_build_irq
c_func
(paren
id|sbus
comma
id|SYSIO_CE_INO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|sysio_ce_handler
comma
id|SA_SHIRQ
comma
l_string|&quot;SYSIO CE&quot;
comma
id|sbus
)paren
OL
l_int|0
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SYSIO[%x]: Cannot register CE interrupt.&bslash;n&quot;
comma
id|sbus-&gt;portid
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|irq
op_assign
id|sbus_build_irq
c_func
(paren
id|sbus
comma
id|SYSIO_SBUSERR_INO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|sysio_sbus_error_handler
comma
id|SA_SHIRQ
comma
l_string|&quot;SYSIO SBUS Error&quot;
comma
id|sbus
)paren
OL
l_int|0
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SYSIO[%x]: Cannot register SBUS Error interrupt.&bslash;n&quot;
comma
id|sbus-&gt;portid
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Now turn the error interrupts on and also enable ECC checking. */
id|upa_writeq
c_func
(paren
(paren
id|SYSIO_ECNTRL_ECCEN
op_or
id|SYSIO_ECNTRL_UEEN
op_or
id|SYSIO_ECNTRL_CEEN
)paren
comma
id|reg_base
op_plus
id|ECC_CONTROL
)paren
suffix:semicolon
id|control
op_assign
id|upa_readq
c_func
(paren
id|iommu-&gt;sbus_control_reg
)paren
suffix:semicolon
id|control
op_or_assign
l_int|0x100UL
suffix:semicolon
multiline_comment|/* SBUS Error Interrupt Enable */
id|upa_writeq
c_func
(paren
id|control
comma
id|iommu-&gt;sbus_control_reg
)paren
suffix:semicolon
)brace
multiline_comment|/* Boot time initialization. */
DECL|function|sbus_iommu_init
r_void
id|__init
id|sbus_iommu_init
c_func
(paren
r_int
id|prom_node
comma
r_struct
id|sbus_bus
op_star
id|sbus
)paren
(brace
r_struct
id|linux_prom64_registers
id|rprop
suffix:semicolon
r_struct
id|sbus_iommu
op_star
id|iommu
suffix:semicolon
r_int
r_int
id|regs
comma
id|tsb_base
suffix:semicolon
id|u64
id|control
suffix:semicolon
r_int
id|err
comma
id|i
suffix:semicolon
id|sbus-&gt;portid
op_assign
id|prom_getintdefault
c_func
(paren
id|sbus-&gt;prom_node
comma
l_string|&quot;upa-portid&quot;
comma
op_minus
l_int|1
)paren
suffix:semicolon
id|err
op_assign
id|prom_getproperty
c_func
(paren
id|prom_node
comma
l_string|&quot;reg&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|rprop
comma
r_sizeof
(paren
id|rprop
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;sbus_iommu_init: Cannot map SYSIO control registers.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|regs
op_assign
id|rprop.phys_addr
suffix:semicolon
id|iommu
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|iommu
)paren
op_plus
id|SMP_CACHE_BYTES
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iommu
op_eq
l_int|NULL
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;sbus_iommu_init: Fatal error, kmalloc(iommu) failed&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Align on E$ line boundry. */
id|iommu
op_assign
(paren
r_struct
id|sbus_iommu
op_star
)paren
(paren
(paren
(paren
r_int
r_int
)paren
id|iommu
op_plus
(paren
id|SMP_CACHE_BYTES
op_minus
l_int|1UL
)paren
)paren
op_amp
op_complement
(paren
id|SMP_CACHE_BYTES
op_minus
l_int|1UL
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|iommu
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|iommu
)paren
)paren
suffix:semicolon
multiline_comment|/* We start with no consistent mappings. */
id|iommu-&gt;lowest_consistent_map
op_assign
id|CLUSTER_NPAGES
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NCLUSTERS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|iommu-&gt;alloc_info
(braket
id|i
)braket
dot
id|flush
op_assign
l_int|0
suffix:semicolon
id|iommu-&gt;alloc_info
(braket
id|i
)braket
dot
id|next
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Setup spinlock. */
id|spin_lock_init
c_func
(paren
op_amp
id|iommu-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* Init register offsets. */
id|iommu-&gt;iommu_regs
op_assign
id|regs
op_plus
id|SYSIO_IOMMUREG_BASE
suffix:semicolon
id|iommu-&gt;strbuf_regs
op_assign
id|regs
op_plus
id|SYSIO_STRBUFREG_BASE
suffix:semicolon
multiline_comment|/* The SYSIO SBUS control register is used for dummy reads&n;&t; * in order to ensure write completion.&n;&t; */
id|iommu-&gt;sbus_control_reg
op_assign
id|regs
op_plus
l_int|0x2000UL
suffix:semicolon
multiline_comment|/* Link into SYSIO software state. */
id|sbus-&gt;iommu
op_assign
id|iommu
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SYSIO: UPA portID %x, at %016lx&bslash;n&quot;
comma
id|sbus-&gt;portid
comma
id|regs
)paren
suffix:semicolon
multiline_comment|/* Setup for TSB_SIZE=7, TBW_SIZE=0, MMU_DE=1, MMU_EN=1 */
id|control
op_assign
id|upa_readq
c_func
(paren
id|iommu-&gt;iommu_regs
op_plus
id|IOMMU_CONTROL
)paren
suffix:semicolon
id|control
op_assign
(paren
(paren
l_int|7UL
op_lshift
l_int|16UL
)paren
op_or
(paren
l_int|0UL
op_lshift
l_int|2UL
)paren
op_or
(paren
l_int|1UL
op_lshift
l_int|1UL
)paren
op_or
(paren
l_int|1UL
op_lshift
l_int|0UL
)paren
)paren
suffix:semicolon
multiline_comment|/* Using the above configuration we need 1MB iommu page&n;&t; * table (128K ioptes * 8 bytes per iopte).  This is&n;&t; * page order 7 on UltraSparc.&n;&t; */
id|tsb_base
op_assign
id|__get_free_pages
c_func
(paren
id|GFP_ATOMIC
comma
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tsb_base
op_eq
l_int|0UL
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;sbus_iommu_init: Fatal error, cannot alloc TSB table.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|iommu-&gt;page_table
op_assign
(paren
id|iopte_t
op_star
)paren
id|tsb_base
suffix:semicolon
id|memset
c_func
(paren
id|iommu-&gt;page_table
comma
l_int|0
comma
(paren
id|PAGE_SIZE
op_lshift
l_int|7
)paren
)paren
suffix:semicolon
id|upa_writeq
c_func
(paren
id|control
comma
id|iommu-&gt;iommu_regs
op_plus
id|IOMMU_CONTROL
)paren
suffix:semicolon
multiline_comment|/* Clean out any cruft in the IOMMU using&n;&t; * diagnostic accesses.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|dram
op_assign
id|iommu-&gt;iommu_regs
op_plus
id|IOMMU_DRAMDIAG
suffix:semicolon
r_int
r_int
id|tag
op_assign
id|iommu-&gt;iommu_regs
op_plus
id|IOMMU_TAGDIAG
suffix:semicolon
id|dram
op_add_assign
(paren
r_int
r_int
)paren
id|i
op_star
l_int|8UL
suffix:semicolon
id|tag
op_add_assign
(paren
r_int
r_int
)paren
id|i
op_star
l_int|8UL
suffix:semicolon
id|upa_writeq
c_func
(paren
l_int|0
comma
id|dram
)paren
suffix:semicolon
id|upa_writeq
c_func
(paren
l_int|0
comma
id|tag
)paren
suffix:semicolon
)brace
id|upa_readq
c_func
(paren
id|iommu-&gt;sbus_control_reg
)paren
suffix:semicolon
multiline_comment|/* Give the TSB to SYSIO. */
id|upa_writeq
c_func
(paren
id|__pa
c_func
(paren
id|tsb_base
)paren
comma
id|iommu-&gt;iommu_regs
op_plus
id|IOMMU_TSBBASE
)paren
suffix:semicolon
multiline_comment|/* Setup streaming buffer, DE=1 SB_EN=1 */
id|control
op_assign
(paren
l_int|1UL
op_lshift
l_int|1UL
)paren
op_or
(paren
l_int|1UL
op_lshift
l_int|0UL
)paren
suffix:semicolon
id|upa_writeq
c_func
(paren
id|control
comma
id|iommu-&gt;strbuf_regs
op_plus
id|STRBUF_CONTROL
)paren
suffix:semicolon
multiline_comment|/* Clear out the tags using diagnostics. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|ptag
comma
id|ltag
suffix:semicolon
id|ptag
op_assign
id|iommu-&gt;strbuf_regs
op_plus
id|STRBUF_PTAGDIAG
suffix:semicolon
id|ltag
op_assign
id|iommu-&gt;strbuf_regs
op_plus
id|STRBUF_LTAGDIAG
suffix:semicolon
id|ptag
op_add_assign
(paren
r_int
r_int
)paren
id|i
op_star
l_int|8UL
suffix:semicolon
id|ltag
op_add_assign
(paren
r_int
r_int
)paren
id|i
op_star
l_int|8UL
suffix:semicolon
id|upa_writeq
c_func
(paren
l_int|0UL
comma
id|ptag
)paren
suffix:semicolon
id|upa_writeq
c_func
(paren
l_int|0UL
comma
id|ltag
)paren
suffix:semicolon
)brace
multiline_comment|/* Enable DVMA arbitration for all devices/slots. */
id|control
op_assign
id|upa_readq
c_func
(paren
id|iommu-&gt;sbus_control_reg
)paren
suffix:semicolon
id|control
op_or_assign
l_int|0x3fUL
suffix:semicolon
id|upa_writeq
c_func
(paren
id|control
comma
id|iommu-&gt;sbus_control_reg
)paren
suffix:semicolon
multiline_comment|/* Now some Xfire specific grot... */
r_if
c_cond
(paren
id|this_is_starfire
)paren
id|sbus-&gt;starfire_cookie
op_assign
id|starfire_hookup
c_func
(paren
id|sbus-&gt;portid
)paren
suffix:semicolon
r_else
id|sbus-&gt;starfire_cookie
op_assign
l_int|NULL
suffix:semicolon
id|sysio_register_error_handlers
c_func
(paren
id|sbus
)paren
suffix:semicolon
)brace
eof
