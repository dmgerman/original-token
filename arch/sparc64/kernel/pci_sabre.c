multiline_comment|/* $Id: pci_sabre.c,v 1.20 2000/06/26 19:40:27 davem Exp $&n; * pci_sabre.c: Sabre specific PCI controller support.&n; *&n; * Copyright (C) 1997, 1998, 1999 David S. Miller (davem@caipfs.rutgers.edu)&n; * Copyright (C) 1998, 1999 Eddie C. Dost   (ecd@skynet.be)&n; * Copyright (C) 1999 Jakub Jelinek   (jakub@redhat.com)&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;asm/apb.h&gt;
macro_line|#include &lt;asm/pbm.h&gt;
macro_line|#include &lt;asm/iommu.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &quot;pci_impl.h&quot;
multiline_comment|/* All SABRE registers are 64-bits.  The following accessor&n; * routines are how they are accessed.  The REG parameter&n; * is a physical address.&n; */
DECL|macro|sabre_read
mdefine_line|#define sabre_read(__reg) &bslash;&n;({&t;u64 __ret; &bslash;&n;&t;__asm__ __volatile__(&quot;ldxa [%1] %2, %0&quot; &bslash;&n;&t;&t;&t;     : &quot;=r&quot; (__ret) &bslash;&n;&t;&t;&t;     : &quot;r&quot; (__reg), &quot;i&quot; (ASI_PHYS_BYPASS_EC_E) &bslash;&n;&t;&t;&t;     : &quot;memory&quot;); &bslash;&n;&t;__ret; &bslash;&n;})
DECL|macro|sabre_write
mdefine_line|#define sabre_write(__reg, __val) &bslash;&n;&t;__asm__ __volatile__(&quot;stxa %0, [%1] %2&quot; &bslash;&n;&t;&t;&t;     : /* no outputs */ &bslash;&n;&t;&t;&t;     : &quot;r&quot; (__val), &quot;r&quot; (__reg), &bslash;&n;&t;&t;&t;       &quot;i&quot; (ASI_PHYS_BYPASS_EC_E))
multiline_comment|/* SABRE PCI controller register offsets and definitions. */
DECL|macro|SABRE_UE_AFSR
mdefine_line|#define SABRE_UE_AFSR&t;&t;0x0030UL
DECL|macro|SABRE_UEAFSR_PDRD
mdefine_line|#define  SABRE_UEAFSR_PDRD&t; 0x4000000000000000UL&t;/* Primary PCI DMA Read */
DECL|macro|SABRE_UEAFSR_PDWR
mdefine_line|#define  SABRE_UEAFSR_PDWR&t; 0x2000000000000000UL&t;/* Primary PCI DMA Write */
DECL|macro|SABRE_UEAFSR_SDRD
mdefine_line|#define  SABRE_UEAFSR_SDRD&t; 0x0800000000000000UL&t;/* Secondary PCI DMA Read */
DECL|macro|SABRE_UEAFSR_SDWR
mdefine_line|#define  SABRE_UEAFSR_SDWR&t; 0x0400000000000000UL&t;/* Secondary PCI DMA Write */
DECL|macro|SABRE_UEAFSR_SDTE
mdefine_line|#define  SABRE_UEAFSR_SDTE&t; 0x0200000000000000UL&t;/* Secondary DMA Translation Error */
DECL|macro|SABRE_UEAFSR_PDTE
mdefine_line|#define  SABRE_UEAFSR_PDTE&t; 0x0100000000000000UL&t;/* Primary DMA Translation Error */
DECL|macro|SABRE_UEAFSR_BMSK
mdefine_line|#define  SABRE_UEAFSR_BMSK&t; 0x0000ffff00000000UL&t;/* Bytemask */
DECL|macro|SABRE_UEAFSR_OFF
mdefine_line|#define  SABRE_UEAFSR_OFF&t; 0x00000000e0000000UL&t;/* Offset (AFAR bits [5:3] */
DECL|macro|SABRE_UEAFSR_BLK
mdefine_line|#define  SABRE_UEAFSR_BLK&t; 0x0000000000800000UL&t;/* Was block operation */
DECL|macro|SABRE_UECE_AFAR
mdefine_line|#define SABRE_UECE_AFAR&t;&t;0x0038UL
DECL|macro|SABRE_CE_AFSR
mdefine_line|#define SABRE_CE_AFSR&t;&t;0x0040UL
DECL|macro|SABRE_CEAFSR_PDRD
mdefine_line|#define  SABRE_CEAFSR_PDRD&t; 0x4000000000000000UL&t;/* Primary PCI DMA Read */
DECL|macro|SABRE_CEAFSR_PDWR
mdefine_line|#define  SABRE_CEAFSR_PDWR&t; 0x2000000000000000UL&t;/* Primary PCI DMA Write */
DECL|macro|SABRE_CEAFSR_SDRD
mdefine_line|#define  SABRE_CEAFSR_SDRD&t; 0x0800000000000000UL&t;/* Secondary PCI DMA Read */
DECL|macro|SABRE_CEAFSR_SDWR
mdefine_line|#define  SABRE_CEAFSR_SDWR&t; 0x0400000000000000UL&t;/* Secondary PCI DMA Write */
DECL|macro|SABRE_CEAFSR_ESYND
mdefine_line|#define  SABRE_CEAFSR_ESYND&t; 0x00ff000000000000UL&t;/* ECC Syndrome */
DECL|macro|SABRE_CEAFSR_BMSK
mdefine_line|#define  SABRE_CEAFSR_BMSK&t; 0x0000ffff00000000UL&t;/* Bytemask */
DECL|macro|SABRE_CEAFSR_OFF
mdefine_line|#define  SABRE_CEAFSR_OFF&t; 0x00000000e0000000UL&t;/* Offset */
DECL|macro|SABRE_CEAFSR_BLK
mdefine_line|#define  SABRE_CEAFSR_BLK&t; 0x0000000000800000UL&t;/* Was block operation */
DECL|macro|SABRE_UECE_AFAR_ALIAS
mdefine_line|#define SABRE_UECE_AFAR_ALIAS&t;0x0048UL&t;/* Aliases to 0x0038 */
DECL|macro|SABRE_IOMMU_CONTROL
mdefine_line|#define SABRE_IOMMU_CONTROL&t;0x0200UL
DECL|macro|SABRE_IOMMUCTRL_ERRSTS
mdefine_line|#define  SABRE_IOMMUCTRL_ERRSTS&t; 0x0000000006000000UL&t;/* Error status bits */
DECL|macro|SABRE_IOMMUCTRL_ERR
mdefine_line|#define  SABRE_IOMMUCTRL_ERR&t; 0x0000000001000000UL&t;/* Error present in IOTLB */
DECL|macro|SABRE_IOMMUCTRL_LCKEN
mdefine_line|#define  SABRE_IOMMUCTRL_LCKEN&t; 0x0000000000800000UL&t;/* IOTLB lock enable */
DECL|macro|SABRE_IOMMUCTRL_LCKPTR
mdefine_line|#define  SABRE_IOMMUCTRL_LCKPTR&t; 0x0000000000780000UL&t;/* IOTLB lock pointer */
DECL|macro|SABRE_IOMMUCTRL_TSBSZ
mdefine_line|#define  SABRE_IOMMUCTRL_TSBSZ&t; 0x0000000000070000UL&t;/* TSB Size */
DECL|macro|SABRE_IOMMU_TSBSZ_1K
mdefine_line|#define  SABRE_IOMMU_TSBSZ_1K   0x0000000000000000
DECL|macro|SABRE_IOMMU_TSBSZ_2K
mdefine_line|#define  SABRE_IOMMU_TSBSZ_2K   0x0000000000010000
DECL|macro|SABRE_IOMMU_TSBSZ_4K
mdefine_line|#define  SABRE_IOMMU_TSBSZ_4K   0x0000000000020000
DECL|macro|SABRE_IOMMU_TSBSZ_8K
mdefine_line|#define  SABRE_IOMMU_TSBSZ_8K   0x0000000000030000
DECL|macro|SABRE_IOMMU_TSBSZ_16K
mdefine_line|#define  SABRE_IOMMU_TSBSZ_16K  0x0000000000040000
DECL|macro|SABRE_IOMMU_TSBSZ_32K
mdefine_line|#define  SABRE_IOMMU_TSBSZ_32K  0x0000000000050000
DECL|macro|SABRE_IOMMU_TSBSZ_64K
mdefine_line|#define  SABRE_IOMMU_TSBSZ_64K  0x0000000000060000
DECL|macro|SABRE_IOMMU_TSBSZ_128K
mdefine_line|#define  SABRE_IOMMU_TSBSZ_128K 0x0000000000070000
DECL|macro|SABRE_IOMMUCTRL_TBWSZ
mdefine_line|#define  SABRE_IOMMUCTRL_TBWSZ&t; 0x0000000000000004UL&t;/* TSB assumed page size */
DECL|macro|SABRE_IOMMUCTRL_DENAB
mdefine_line|#define  SABRE_IOMMUCTRL_DENAB&t; 0x0000000000000002UL&t;/* Diagnostic Mode Enable */
DECL|macro|SABRE_IOMMUCTRL_ENAB
mdefine_line|#define  SABRE_IOMMUCTRL_ENAB&t; 0x0000000000000001UL&t;/* IOMMU Enable */
DECL|macro|SABRE_IOMMU_TSBBASE
mdefine_line|#define SABRE_IOMMU_TSBBASE&t;0x0208UL
DECL|macro|SABRE_IOMMU_FLUSH
mdefine_line|#define SABRE_IOMMU_FLUSH&t;0x0210UL
DECL|macro|SABRE_IMAP_A_SLOT0
mdefine_line|#define SABRE_IMAP_A_SLOT0&t;0x0c00UL
DECL|macro|SABRE_IMAP_B_SLOT0
mdefine_line|#define SABRE_IMAP_B_SLOT0&t;0x0c20UL
DECL|macro|SABRE_IMAP_SCSI
mdefine_line|#define SABRE_IMAP_SCSI&t;&t;0x1000UL
DECL|macro|SABRE_IMAP_ETH
mdefine_line|#define SABRE_IMAP_ETH&t;&t;0x1008UL
DECL|macro|SABRE_IMAP_BPP
mdefine_line|#define SABRE_IMAP_BPP&t;&t;0x1010UL
DECL|macro|SABRE_IMAP_AU_REC
mdefine_line|#define SABRE_IMAP_AU_REC&t;0x1018UL
DECL|macro|SABRE_IMAP_AU_PLAY
mdefine_line|#define SABRE_IMAP_AU_PLAY&t;0x1020UL
DECL|macro|SABRE_IMAP_PFAIL
mdefine_line|#define SABRE_IMAP_PFAIL&t;0x1028UL
DECL|macro|SABRE_IMAP_KMS
mdefine_line|#define SABRE_IMAP_KMS&t;&t;0x1030UL
DECL|macro|SABRE_IMAP_FLPY
mdefine_line|#define SABRE_IMAP_FLPY&t;&t;0x1038UL
DECL|macro|SABRE_IMAP_SHW
mdefine_line|#define SABRE_IMAP_SHW&t;&t;0x1040UL
DECL|macro|SABRE_IMAP_KBD
mdefine_line|#define SABRE_IMAP_KBD&t;&t;0x1048UL
DECL|macro|SABRE_IMAP_MS
mdefine_line|#define SABRE_IMAP_MS&t;&t;0x1050UL
DECL|macro|SABRE_IMAP_SER
mdefine_line|#define SABRE_IMAP_SER&t;&t;0x1058UL
DECL|macro|SABRE_IMAP_UE
mdefine_line|#define SABRE_IMAP_UE&t;&t;0x1070UL
DECL|macro|SABRE_IMAP_CE
mdefine_line|#define SABRE_IMAP_CE&t;&t;0x1078UL
DECL|macro|SABRE_IMAP_PCIERR
mdefine_line|#define SABRE_IMAP_PCIERR&t;0x1080UL
DECL|macro|SABRE_IMAP_GFX
mdefine_line|#define SABRE_IMAP_GFX&t;&t;0x1098UL
DECL|macro|SABRE_IMAP_EUPA
mdefine_line|#define SABRE_IMAP_EUPA&t;&t;0x10a0UL
DECL|macro|SABRE_ICLR_A_SLOT0
mdefine_line|#define SABRE_ICLR_A_SLOT0&t;0x1400UL
DECL|macro|SABRE_ICLR_B_SLOT0
mdefine_line|#define SABRE_ICLR_B_SLOT0&t;0x1480UL
DECL|macro|SABRE_ICLR_SCSI
mdefine_line|#define SABRE_ICLR_SCSI&t;&t;0x1800UL
DECL|macro|SABRE_ICLR_ETH
mdefine_line|#define SABRE_ICLR_ETH&t;&t;0x1808UL
DECL|macro|SABRE_ICLR_BPP
mdefine_line|#define SABRE_ICLR_BPP&t;&t;0x1810UL
DECL|macro|SABRE_ICLR_AU_REC
mdefine_line|#define SABRE_ICLR_AU_REC&t;0x1818UL
DECL|macro|SABRE_ICLR_AU_PLAY
mdefine_line|#define SABRE_ICLR_AU_PLAY&t;0x1820UL
DECL|macro|SABRE_ICLR_PFAIL
mdefine_line|#define SABRE_ICLR_PFAIL&t;0x1828UL
DECL|macro|SABRE_ICLR_KMS
mdefine_line|#define SABRE_ICLR_KMS&t;&t;0x1830UL
DECL|macro|SABRE_ICLR_FLPY
mdefine_line|#define SABRE_ICLR_FLPY&t;&t;0x1838UL
DECL|macro|SABRE_ICLR_SHW
mdefine_line|#define SABRE_ICLR_SHW&t;&t;0x1840UL
DECL|macro|SABRE_ICLR_KBD
mdefine_line|#define SABRE_ICLR_KBD&t;&t;0x1848UL
DECL|macro|SABRE_ICLR_MS
mdefine_line|#define SABRE_ICLR_MS&t;&t;0x1850UL
DECL|macro|SABRE_ICLR_SER
mdefine_line|#define SABRE_ICLR_SER&t;&t;0x1858UL
DECL|macro|SABRE_ICLR_UE
mdefine_line|#define SABRE_ICLR_UE&t;&t;0x1870UL
DECL|macro|SABRE_ICLR_CE
mdefine_line|#define SABRE_ICLR_CE&t;&t;0x1878UL
DECL|macro|SABRE_ICLR_PCIERR
mdefine_line|#define SABRE_ICLR_PCIERR&t;0x1880UL
DECL|macro|SABRE_WRSYNC
mdefine_line|#define SABRE_WRSYNC&t;&t;0x1c20UL
DECL|macro|SABRE_PCICTRL
mdefine_line|#define SABRE_PCICTRL&t;&t;0x2000UL
DECL|macro|SABRE_PCICTRL_MRLEN
mdefine_line|#define  SABRE_PCICTRL_MRLEN&t; 0x0000001000000000UL&t;/* Use MemoryReadLine for block loads/stores */
DECL|macro|SABRE_PCICTRL_SERR
mdefine_line|#define  SABRE_PCICTRL_SERR&t; 0x0000000400000000UL&t;/* Set when SERR asserted on PCI bus */
DECL|macro|SABRE_PCICTRL_ARBPARK
mdefine_line|#define  SABRE_PCICTRL_ARBPARK&t; 0x0000000000200000UL&t;/* Bus Parking 0=Ultra-IIi 1=prev-bus-owner */
DECL|macro|SABRE_PCICTRL_CPUPRIO
mdefine_line|#define  SABRE_PCICTRL_CPUPRIO&t; 0x0000000000100000UL&t;/* Ultra-IIi granted every other bus cycle */
DECL|macro|SABRE_PCICTRL_ARBPRIO
mdefine_line|#define  SABRE_PCICTRL_ARBPRIO&t; 0x00000000000f0000UL&t;/* Slot which is granted every other bus cycle */
DECL|macro|SABRE_PCICTRL_ERREN
mdefine_line|#define  SABRE_PCICTRL_ERREN&t; 0x0000000000000100UL&t;/* PCI Error Interrupt Enable */
DECL|macro|SABRE_PCICTRL_RTRYWE
mdefine_line|#define  SABRE_PCICTRL_RTRYWE&t; 0x0000000000000080UL&t;/* DMA Flow Control 0=wait-if-possible 1=retry */
DECL|macro|SABRE_PCICTRL_AEN
mdefine_line|#define  SABRE_PCICTRL_AEN&t; 0x000000000000000fUL&t;/* Slot PCI arbitration enables */
DECL|macro|SABRE_PIOAFSR
mdefine_line|#define SABRE_PIOAFSR&t;&t;0x2010UL
DECL|macro|SABRE_PIOAFSR_PMA
mdefine_line|#define  SABRE_PIOAFSR_PMA&t; 0x8000000000000000UL&t;/* Primary Master Abort */
DECL|macro|SABRE_PIOAFSR_PTA
mdefine_line|#define  SABRE_PIOAFSR_PTA&t; 0x4000000000000000UL&t;/* Primary Target Abort */
DECL|macro|SABRE_PIOAFSR_PRTRY
mdefine_line|#define  SABRE_PIOAFSR_PRTRY&t; 0x2000000000000000UL&t;/* Primary Excessive Retries */
DECL|macro|SABRE_PIOAFSR_PPERR
mdefine_line|#define  SABRE_PIOAFSR_PPERR&t; 0x1000000000000000UL&t;/* Primary Parity Error */
DECL|macro|SABRE_PIOAFSR_SMA
mdefine_line|#define  SABRE_PIOAFSR_SMA&t; 0x0800000000000000UL&t;/* Secondary Master Abort */
DECL|macro|SABRE_PIOAFSR_STA
mdefine_line|#define  SABRE_PIOAFSR_STA&t; 0x0400000000000000UL&t;/* Secondary Target Abort */
DECL|macro|SABRE_PIOAFSR_SRTRY
mdefine_line|#define  SABRE_PIOAFSR_SRTRY&t; 0x0200000000000000UL&t;/* Secondary Excessive Retries */
DECL|macro|SABRE_PIOAFSR_SPERR
mdefine_line|#define  SABRE_PIOAFSR_SPERR&t; 0x0100000000000000UL&t;/* Secondary Parity Error */
DECL|macro|SABRE_PIOAFSR_BMSK
mdefine_line|#define  SABRE_PIOAFSR_BMSK&t; 0x0000ffff00000000UL&t;/* Byte Mask */
DECL|macro|SABRE_PIOAFSR_BLK
mdefine_line|#define  SABRE_PIOAFSR_BLK&t; 0x0000000080000000UL&t;/* Was Block Operation */
DECL|macro|SABRE_PIOAFAR
mdefine_line|#define SABRE_PIOAFAR&t;&t;0x2018UL
DECL|macro|SABRE_PCIDIAG
mdefine_line|#define SABRE_PCIDIAG&t;&t;0x2020UL
DECL|macro|SABRE_PCIDIAG_DRTRY
mdefine_line|#define  SABRE_PCIDIAG_DRTRY&t; 0x0000000000000040UL&t;/* Disable PIO Retry Limit */
DECL|macro|SABRE_PCIDIAG_IPAPAR
mdefine_line|#define  SABRE_PCIDIAG_IPAPAR&t; 0x0000000000000008UL&t;/* Invert PIO Address Parity */
DECL|macro|SABRE_PCIDIAG_IPDPAR
mdefine_line|#define  SABRE_PCIDIAG_IPDPAR&t; 0x0000000000000004UL&t;/* Invert PIO Data Parity */
DECL|macro|SABRE_PCIDIAG_IDDPAR
mdefine_line|#define  SABRE_PCIDIAG_IDDPAR&t; 0x0000000000000002UL&t;/* Invert DMA Data Parity */
DECL|macro|SABRE_PCIDIAG_ELPBK
mdefine_line|#define  SABRE_PCIDIAG_ELPBK&t; 0x0000000000000001UL&t;/* Loopback Enable - not supported */
DECL|macro|SABRE_PCITASR
mdefine_line|#define SABRE_PCITASR&t;&t;0x2028UL
DECL|macro|SABRE_PCITASR_EF
mdefine_line|#define  SABRE_PCITASR_EF&t; 0x0000000000000080UL&t;/* Respond to 0xe0000000-0xffffffff */
DECL|macro|SABRE_PCITASR_CD
mdefine_line|#define  SABRE_PCITASR_CD&t; 0x0000000000000040UL&t;/* Respond to 0xc0000000-0xdfffffff */
DECL|macro|SABRE_PCITASR_AB
mdefine_line|#define  SABRE_PCITASR_AB&t; 0x0000000000000020UL&t;/* Respond to 0xa0000000-0xbfffffff */
DECL|macro|SABRE_PCITASR_89
mdefine_line|#define  SABRE_PCITASR_89&t; 0x0000000000000010UL&t;/* Respond to 0x80000000-0x9fffffff */
DECL|macro|SABRE_PCITASR_67
mdefine_line|#define  SABRE_PCITASR_67&t; 0x0000000000000008UL&t;/* Respond to 0x60000000-0x7fffffff */
DECL|macro|SABRE_PCITASR_45
mdefine_line|#define  SABRE_PCITASR_45&t; 0x0000000000000004UL&t;/* Respond to 0x40000000-0x5fffffff */
DECL|macro|SABRE_PCITASR_23
mdefine_line|#define  SABRE_PCITASR_23&t; 0x0000000000000002UL&t;/* Respond to 0x20000000-0x3fffffff */
DECL|macro|SABRE_PCITASR_01
mdefine_line|#define  SABRE_PCITASR_01&t; 0x0000000000000001UL&t;/* Respond to 0x00000000-0x1fffffff */
DECL|macro|SABRE_PIOBUF_DIAG
mdefine_line|#define SABRE_PIOBUF_DIAG&t;0x5000UL
DECL|macro|SABRE_DMABUF_DIAGLO
mdefine_line|#define SABRE_DMABUF_DIAGLO&t;0x5100UL
DECL|macro|SABRE_DMABUF_DIAGHI
mdefine_line|#define SABRE_DMABUF_DIAGHI&t;0x51c0UL
DECL|macro|SABRE_IMAP_GFX_ALIAS
mdefine_line|#define SABRE_IMAP_GFX_ALIAS&t;0x6000UL&t;/* Aliases to 0x1098 */
DECL|macro|SABRE_IMAP_EUPA_ALIAS
mdefine_line|#define SABRE_IMAP_EUPA_ALIAS&t;0x8000UL&t;/* Aliases to 0x10a0 */
DECL|macro|SABRE_IOMMU_VADIAG
mdefine_line|#define SABRE_IOMMU_VADIAG&t;0xa400UL
DECL|macro|SABRE_IOMMU_TCDIAG
mdefine_line|#define SABRE_IOMMU_TCDIAG&t;0xa408UL
DECL|macro|SABRE_IOMMU_TAG
mdefine_line|#define SABRE_IOMMU_TAG&t;&t;0xa580UL
DECL|macro|SABRE_IOMMUTAG_ERRSTS
mdefine_line|#define  SABRE_IOMMUTAG_ERRSTS&t; 0x0000000001800000UL&t;/* Error status bits */
DECL|macro|SABRE_IOMMUTAG_ERR
mdefine_line|#define  SABRE_IOMMUTAG_ERR&t; 0x0000000000400000UL&t;/* Error present */
DECL|macro|SABRE_IOMMUTAG_WRITE
mdefine_line|#define  SABRE_IOMMUTAG_WRITE&t; 0x0000000000200000UL&t;/* Page is writable */
DECL|macro|SABRE_IOMMUTAG_STREAM
mdefine_line|#define  SABRE_IOMMUTAG_STREAM&t; 0x0000000000100000UL&t;/* Streamable bit - unused */
DECL|macro|SABRE_IOMMUTAG_SIZE
mdefine_line|#define  SABRE_IOMMUTAG_SIZE&t; 0x0000000000080000UL&t;/* 0=8k 1=16k */
DECL|macro|SABRE_IOMMUTAG_VPN
mdefine_line|#define  SABRE_IOMMUTAG_VPN&t; 0x000000000007ffffUL&t;/* Virtual Page Number [31:13] */
DECL|macro|SABRE_IOMMU_DATA
mdefine_line|#define SABRE_IOMMU_DATA&t;0xa600UL
DECL|macro|SABRE_IOMMUDATA_VALID
mdefine_line|#define SABRE_IOMMUDATA_VALID&t; 0x0000000040000000UL&t;/* Valid */
DECL|macro|SABRE_IOMMUDATA_USED
mdefine_line|#define SABRE_IOMMUDATA_USED&t; 0x0000000020000000UL&t;/* Used (for LRU algorithm) */
DECL|macro|SABRE_IOMMUDATA_CACHE
mdefine_line|#define SABRE_IOMMUDATA_CACHE&t; 0x0000000010000000UL&t;/* Cacheable */
DECL|macro|SABRE_IOMMUDATA_PPN
mdefine_line|#define SABRE_IOMMUDATA_PPN&t; 0x00000000001fffffUL&t;/* Physical Page Number [33:13] */
DECL|macro|SABRE_PCI_IRQSTATE
mdefine_line|#define SABRE_PCI_IRQSTATE&t;0xa800UL
DECL|macro|SABRE_OBIO_IRQSTATE
mdefine_line|#define SABRE_OBIO_IRQSTATE&t;0xa808UL
DECL|macro|SABRE_FFBCFG
mdefine_line|#define SABRE_FFBCFG&t;&t;0xf000UL
DECL|macro|SABRE_FFBCFG_SPRQS
mdefine_line|#define  SABRE_FFBCFG_SPRQS&t; 0x000000000f000000&t;/* Slave P_RQST queue size */
DECL|macro|SABRE_FFBCFG_ONEREAD
mdefine_line|#define  SABRE_FFBCFG_ONEREAD&t; 0x0000000000004000&t;/* Slave supports one outstanding read */
DECL|macro|SABRE_MCCTRL0
mdefine_line|#define SABRE_MCCTRL0&t;&t;0xf010UL
DECL|macro|SABRE_MCCTRL0_RENAB
mdefine_line|#define  SABRE_MCCTRL0_RENAB&t; 0x0000000080000000&t;/* Refresh Enable */
DECL|macro|SABRE_MCCTRL0_EENAB
mdefine_line|#define  SABRE_MCCTRL0_EENAB&t; 0x0000000010000000&t;/* Enable all ECC functions */
DECL|macro|SABRE_MCCTRL0_11BIT
mdefine_line|#define  SABRE_MCCTRL0_11BIT&t; 0x0000000000001000&t;/* Enable 11-bit column addressing */
DECL|macro|SABRE_MCCTRL0_DPP
mdefine_line|#define  SABRE_MCCTRL0_DPP&t; 0x0000000000000f00&t;/* DIMM Pair Present Bits */
DECL|macro|SABRE_MCCTRL0_RINTVL
mdefine_line|#define  SABRE_MCCTRL0_RINTVL&t; 0x00000000000000ff&t;/* Refresh Interval */
DECL|macro|SABRE_MCCTRL1
mdefine_line|#define SABRE_MCCTRL1&t;&t;0xf018UL
DECL|macro|SABRE_MCCTRL1_AMDC
mdefine_line|#define  SABRE_MCCTRL1_AMDC&t; 0x0000000038000000&t;/* Advance Memdata Clock */
DECL|macro|SABRE_MCCTRL1_ARDC
mdefine_line|#define  SABRE_MCCTRL1_ARDC&t; 0x0000000007000000&t;/* Advance DRAM Read Data Clock */
DECL|macro|SABRE_MCCTRL1_CSR
mdefine_line|#define  SABRE_MCCTRL1_CSR&t; 0x0000000000e00000&t;/* CAS to RAS delay for CBR refresh */
DECL|macro|SABRE_MCCTRL1_CASRW
mdefine_line|#define  SABRE_MCCTRL1_CASRW&t; 0x00000000001c0000&t;/* CAS length for read/write */
DECL|macro|SABRE_MCCTRL1_RCD
mdefine_line|#define  SABRE_MCCTRL1_RCD&t; 0x0000000000038000&t;/* RAS to CAS delay */
DECL|macro|SABRE_MCCTRL1_CP
mdefine_line|#define  SABRE_MCCTRL1_CP&t; 0x0000000000007000&t;/* CAS Precharge */
DECL|macro|SABRE_MCCTRL1_RP
mdefine_line|#define  SABRE_MCCTRL1_RP&t; 0x0000000000000e00&t;/* RAS Precharge */
DECL|macro|SABRE_MCCTRL1_RAS
mdefine_line|#define  SABRE_MCCTRL1_RAS&t; 0x00000000000001c0&t;/* Length of RAS for refresh */
DECL|macro|SABRE_MCCTRL1_CASRW2
mdefine_line|#define  SABRE_MCCTRL1_CASRW2&t; 0x0000000000000038&t;/* Must be same as CASRW */
DECL|macro|SABRE_MCCTRL1_RSC
mdefine_line|#define  SABRE_MCCTRL1_RSC&t; 0x0000000000000007&t;/* RAS after CAS hold time */
DECL|macro|SABRE_RESETCTRL
mdefine_line|#define SABRE_RESETCTRL&t;&t;0xf020UL
DECL|macro|SABRE_CONFIGSPACE
mdefine_line|#define SABRE_CONFIGSPACE&t;0x001000000UL
DECL|macro|SABRE_IOSPACE
mdefine_line|#define SABRE_IOSPACE&t;&t;0x002000000UL
DECL|macro|SABRE_IOSPACE_SIZE
mdefine_line|#define SABRE_IOSPACE_SIZE&t;0x00000ffffUL
DECL|macro|SABRE_MEMSPACE
mdefine_line|#define SABRE_MEMSPACE&t;&t;0x100000000UL
DECL|macro|SABRE_MEMSPACE_SIZE
mdefine_line|#define SABRE_MEMSPACE_SIZE&t;0x07fffffffUL
multiline_comment|/* UltraSparc-IIi Programmer&squot;s Manual, page 325, PCI&n; * configuration space address format:&n; * &n; *  32             24 23 16 15    11 10       8 7   2  1 0&n; * ---------------------------------------------------------&n; * |0 0 0 0 0 0 0 0 1| bus | device | function | reg | 0 0 |&n; * ---------------------------------------------------------&n; */
DECL|macro|SABRE_CONFIG_BASE
mdefine_line|#define SABRE_CONFIG_BASE(PBM)&t;&bslash;&n;&t;((PBM)-&gt;parent-&gt;config_space | (1UL &lt;&lt; 24))
DECL|macro|SABRE_CONFIG_ENCODE
mdefine_line|#define SABRE_CONFIG_ENCODE(BUS, DEVFN, REG)&t;&bslash;&n;&t;(((unsigned long)(BUS)   &lt;&lt; 16) |&t;&bslash;&n;&t; ((unsigned long)(DEVFN) &lt;&lt; 8)  |&t;&bslash;&n;&t; ((unsigned long)(REG)))
DECL|function|sabre_pci_config_mkaddr
r_static
r_void
op_star
id|sabre_pci_config_mkaddr
c_func
(paren
r_struct
id|pci_pbm_info
op_star
id|pbm
comma
r_int
r_char
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pbm
)paren
r_return
l_int|NULL
suffix:semicolon
r_return
(paren
r_void
op_star
)paren
(paren
id|SABRE_CONFIG_BASE
c_func
(paren
id|pbm
)paren
op_or
id|SABRE_CONFIG_ENCODE
c_func
(paren
id|bus
comma
id|devfn
comma
id|where
)paren
)paren
suffix:semicolon
)brace
DECL|function|sabre_out_of_range
r_static
r_int
id|sabre_out_of_range
c_func
(paren
r_int
r_char
id|devfn
)paren
(brace
r_return
(paren
(paren
(paren
id|PCI_SLOT
c_func
(paren
id|devfn
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|PCI_FUNC
c_func
(paren
id|devfn
)paren
OG
l_int|0
)paren
)paren
op_logical_or
(paren
(paren
id|PCI_SLOT
c_func
(paren
id|devfn
)paren
op_eq
l_int|1
)paren
op_logical_and
(paren
id|PCI_FUNC
c_func
(paren
id|devfn
)paren
OG
l_int|1
)paren
)paren
op_logical_or
(paren
id|PCI_SLOT
c_func
(paren
id|devfn
)paren
OG
l_int|1
)paren
)paren
suffix:semicolon
)brace
DECL|function|__sabre_out_of_range
r_static
r_int
id|__sabre_out_of_range
c_func
(paren
r_struct
id|pci_pbm_info
op_star
id|pbm
comma
r_int
r_char
id|bus
comma
r_int
r_char
id|devfn
)paren
(brace
r_return
(paren
(paren
id|pbm-&gt;parent
op_eq
l_int|0
)paren
op_logical_or
(paren
(paren
id|pbm
op_eq
op_amp
id|pbm-&gt;parent-&gt;pbm_B
)paren
op_logical_and
(paren
id|bus
op_eq
id|pbm-&gt;pci_first_busno
)paren
op_logical_and
id|PCI_SLOT
c_func
(paren
id|devfn
)paren
OG
l_int|8
)paren
op_logical_or
(paren
(paren
id|pbm
op_eq
op_amp
id|pbm-&gt;parent-&gt;pbm_A
)paren
op_logical_and
(paren
id|bus
op_eq
id|pbm-&gt;pci_first_busno
)paren
op_logical_and
id|PCI_SLOT
c_func
(paren
id|devfn
)paren
OG
l_int|8
)paren
)paren
suffix:semicolon
)brace
DECL|function|__sabre_read_byte
r_static
r_int
id|__sabre_read_byte
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u8
op_star
id|value
)paren
(brace
r_struct
id|pci_pbm_info
op_star
id|pbm
op_assign
id|pci_bus2pbm
(braket
id|dev-&gt;bus-&gt;number
)braket
suffix:semicolon
r_int
r_char
id|bus
op_assign
id|dev-&gt;bus-&gt;number
suffix:semicolon
r_int
r_int
id|devfn
op_assign
id|dev-&gt;devfn
suffix:semicolon
id|u8
op_star
id|addr
suffix:semicolon
op_star
id|value
op_assign
l_int|0xff
suffix:semicolon
id|addr
op_assign
id|sabre_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
comma
id|where
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|__sabre_out_of_range
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
)paren
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
id|pci_config_read8
c_func
(paren
id|addr
comma
id|value
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|__sabre_read_word
r_static
r_int
id|__sabre_read_word
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u16
op_star
id|value
)paren
(brace
r_struct
id|pci_pbm_info
op_star
id|pbm
op_assign
id|pci_bus2pbm
(braket
id|dev-&gt;bus-&gt;number
)braket
suffix:semicolon
r_int
r_char
id|bus
op_assign
id|dev-&gt;bus-&gt;number
suffix:semicolon
r_int
r_int
id|devfn
op_assign
id|dev-&gt;devfn
suffix:semicolon
id|u16
op_star
id|addr
suffix:semicolon
op_star
id|value
op_assign
l_int|0xffff
suffix:semicolon
id|addr
op_assign
id|sabre_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
comma
id|where
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|__sabre_out_of_range
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
)paren
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|where
op_amp
l_int|0x01
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;pcibios_read_config_word: misaligned reg [%x]&bslash;n&quot;
comma
id|where
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
id|pci_config_read16
c_func
(paren
id|addr
comma
id|value
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|__sabre_read_dword
r_static
r_int
id|__sabre_read_dword
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u32
op_star
id|value
)paren
(brace
r_struct
id|pci_pbm_info
op_star
id|pbm
op_assign
id|pci_bus2pbm
(braket
id|dev-&gt;bus-&gt;number
)braket
suffix:semicolon
r_int
r_char
id|bus
op_assign
id|dev-&gt;bus-&gt;number
suffix:semicolon
r_int
r_int
id|devfn
op_assign
id|dev-&gt;devfn
suffix:semicolon
id|u32
op_star
id|addr
suffix:semicolon
op_star
id|value
op_assign
l_int|0xffffffff
suffix:semicolon
id|addr
op_assign
id|sabre_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
comma
id|where
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|__sabre_out_of_range
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
)paren
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|where
op_amp
l_int|0x03
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;pcibios_read_config_dword: misaligned reg [%x]&bslash;n&quot;
comma
id|where
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
id|pci_config_read32
c_func
(paren
id|addr
comma
id|value
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|sabre_read_byte
r_static
r_int
id|sabre_read_byte
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u8
op_star
id|value
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;bus-&gt;number
)paren
r_return
id|__sabre_read_byte
c_func
(paren
id|dev
comma
id|where
comma
id|value
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sabre_out_of_range
c_func
(paren
id|dev-&gt;devfn
)paren
)paren
(brace
op_star
id|value
op_assign
l_int|0xff
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|where
OL
l_int|8
)paren
(brace
id|u16
id|tmp
suffix:semicolon
id|__sabre_read_word
c_func
(paren
id|dev
comma
id|where
op_amp
op_complement
l_int|1
comma
op_amp
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|where
op_amp
l_int|1
)paren
op_star
id|value
op_assign
id|tmp
op_rshift
l_int|8
suffix:semicolon
r_else
op_star
id|value
op_assign
id|tmp
op_amp
l_int|0xff
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
r_else
r_return
id|__sabre_read_byte
c_func
(paren
id|dev
comma
id|where
comma
id|value
)paren
suffix:semicolon
)brace
DECL|function|sabre_read_word
r_static
r_int
id|sabre_read_word
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u16
op_star
id|value
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;bus-&gt;number
)paren
r_return
id|__sabre_read_word
c_func
(paren
id|dev
comma
id|where
comma
id|value
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sabre_out_of_range
c_func
(paren
id|dev-&gt;devfn
)paren
)paren
(brace
op_star
id|value
op_assign
l_int|0xffff
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|where
OL
l_int|8
)paren
r_return
id|__sabre_read_word
c_func
(paren
id|dev
comma
id|where
comma
id|value
)paren
suffix:semicolon
r_else
(brace
id|u8
id|tmp
suffix:semicolon
id|__sabre_read_byte
c_func
(paren
id|dev
comma
id|where
comma
op_amp
id|tmp
)paren
suffix:semicolon
op_star
id|value
op_assign
id|tmp
suffix:semicolon
id|__sabre_read_byte
c_func
(paren
id|dev
comma
id|where
op_plus
l_int|1
comma
op_amp
id|tmp
)paren
suffix:semicolon
op_star
id|value
op_or_assign
id|tmp
op_lshift
l_int|8
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
)brace
DECL|function|sabre_read_dword
r_static
r_int
id|sabre_read_dword
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u32
op_star
id|value
)paren
(brace
id|u16
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;bus-&gt;number
)paren
r_return
id|__sabre_read_dword
c_func
(paren
id|dev
comma
id|where
comma
id|value
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sabre_out_of_range
c_func
(paren
id|dev-&gt;devfn
)paren
)paren
(brace
op_star
id|value
op_assign
l_int|0xffffffff
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
id|sabre_read_word
c_func
(paren
id|dev
comma
id|where
comma
op_amp
id|tmp
)paren
suffix:semicolon
op_star
id|value
op_assign
id|tmp
suffix:semicolon
id|sabre_read_word
c_func
(paren
id|dev
comma
id|where
op_plus
l_int|2
comma
op_amp
id|tmp
)paren
suffix:semicolon
op_star
id|value
op_or_assign
id|tmp
op_lshift
l_int|16
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|__sabre_write_byte
r_static
r_int
id|__sabre_write_byte
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u8
id|value
)paren
(brace
r_struct
id|pci_pbm_info
op_star
id|pbm
op_assign
id|pci_bus2pbm
(braket
id|dev-&gt;bus-&gt;number
)braket
suffix:semicolon
r_int
r_char
id|bus
op_assign
id|dev-&gt;bus-&gt;number
suffix:semicolon
r_int
r_int
id|devfn
op_assign
id|dev-&gt;devfn
suffix:semicolon
id|u8
op_star
id|addr
suffix:semicolon
id|addr
op_assign
id|sabre_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
comma
id|where
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|__sabre_out_of_range
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
)paren
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
id|pci_config_write8
c_func
(paren
id|addr
comma
id|value
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|__sabre_write_word
r_static
r_int
id|__sabre_write_word
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u16
id|value
)paren
(brace
r_struct
id|pci_pbm_info
op_star
id|pbm
op_assign
id|pci_bus2pbm
(braket
id|dev-&gt;bus-&gt;number
)braket
suffix:semicolon
r_int
r_char
id|bus
op_assign
id|dev-&gt;bus-&gt;number
suffix:semicolon
r_int
r_int
id|devfn
op_assign
id|dev-&gt;devfn
suffix:semicolon
id|u16
op_star
id|addr
suffix:semicolon
id|addr
op_assign
id|sabre_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
comma
id|where
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|__sabre_out_of_range
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
)paren
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|where
op_amp
l_int|0x01
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;pcibios_write_config_word: misaligned reg [%x]&bslash;n&quot;
comma
id|where
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
id|pci_config_write16
c_func
(paren
id|addr
comma
id|value
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|__sabre_write_dword
r_static
r_int
id|__sabre_write_dword
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u32
id|value
)paren
(brace
r_struct
id|pci_pbm_info
op_star
id|pbm
op_assign
id|pci_bus2pbm
(braket
id|dev-&gt;bus-&gt;number
)braket
suffix:semicolon
r_int
r_char
id|bus
op_assign
id|dev-&gt;bus-&gt;number
suffix:semicolon
r_int
r_int
id|devfn
op_assign
id|dev-&gt;devfn
suffix:semicolon
id|u32
op_star
id|addr
suffix:semicolon
id|addr
op_assign
id|sabre_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
comma
id|where
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|__sabre_out_of_range
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
)paren
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|where
op_amp
l_int|0x03
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;pcibios_write_config_dword: misaligned reg [%x]&bslash;n&quot;
comma
id|where
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
id|pci_config_write32
c_func
(paren
id|addr
comma
id|value
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|sabre_write_byte
r_static
r_int
id|sabre_write_byte
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u8
id|value
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;bus-&gt;number
)paren
r_return
id|__sabre_write_byte
c_func
(paren
id|dev
comma
id|where
comma
id|value
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sabre_out_of_range
c_func
(paren
id|dev-&gt;devfn
)paren
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|where
OL
l_int|8
)paren
(brace
id|u16
id|tmp
suffix:semicolon
id|__sabre_read_word
c_func
(paren
id|dev
comma
id|where
op_amp
op_complement
l_int|1
comma
op_amp
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|where
op_amp
l_int|1
)paren
(brace
id|value
op_and_assign
l_int|0x00ff
suffix:semicolon
id|value
op_or_assign
id|tmp
op_lshift
l_int|8
suffix:semicolon
)brace
r_else
(brace
id|value
op_and_assign
l_int|0xff00
suffix:semicolon
id|value
op_or_assign
id|tmp
suffix:semicolon
)brace
r_return
id|__sabre_write_word
c_func
(paren
id|dev
comma
id|where
op_amp
op_complement
l_int|1
comma
id|tmp
)paren
suffix:semicolon
)brace
r_else
r_return
id|__sabre_write_byte
c_func
(paren
id|dev
comma
id|where
comma
id|value
)paren
suffix:semicolon
)brace
DECL|function|sabre_write_word
r_static
r_int
id|sabre_write_word
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u16
id|value
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;bus-&gt;number
)paren
r_return
id|__sabre_write_word
c_func
(paren
id|dev
comma
id|where
comma
id|value
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sabre_out_of_range
c_func
(paren
id|dev-&gt;devfn
)paren
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|where
OL
l_int|8
)paren
r_return
id|__sabre_write_word
c_func
(paren
id|dev
comma
id|where
comma
id|value
)paren
suffix:semicolon
r_else
(brace
id|__sabre_write_byte
c_func
(paren
id|dev
comma
id|where
comma
id|value
op_amp
l_int|0xff
)paren
suffix:semicolon
id|__sabre_write_byte
c_func
(paren
id|dev
comma
id|where
op_plus
l_int|1
comma
id|value
op_rshift
l_int|8
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
)brace
DECL|function|sabre_write_dword
r_static
r_int
id|sabre_write_dword
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u32
id|value
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;bus-&gt;number
)paren
r_return
id|__sabre_write_dword
c_func
(paren
id|dev
comma
id|where
comma
id|value
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sabre_out_of_range
c_func
(paren
id|dev-&gt;devfn
)paren
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
id|sabre_write_word
c_func
(paren
id|dev
comma
id|where
comma
id|value
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|sabre_write_word
c_func
(paren
id|dev
comma
id|where
op_plus
l_int|2
comma
id|value
op_rshift
l_int|16
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|variable|sabre_ops
r_static
r_struct
id|pci_ops
id|sabre_ops
op_assign
(brace
id|sabre_read_byte
comma
id|sabre_read_word
comma
id|sabre_read_dword
comma
id|sabre_write_byte
comma
id|sabre_write_word
comma
id|sabre_write_dword
)brace
suffix:semicolon
DECL|function|sabre_pcislot_imap_offset
r_static
r_int
r_int
id|sabre_pcislot_imap_offset
c_func
(paren
r_int
r_int
id|ino
)paren
(brace
r_int
r_int
id|bus
op_assign
(paren
id|ino
op_amp
l_int|0x10
)paren
op_rshift
l_int|4
suffix:semicolon
r_int
r_int
id|slot
op_assign
(paren
id|ino
op_amp
l_int|0x0c
)paren
op_rshift
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|bus
op_eq
l_int|0
)paren
r_return
id|SABRE_IMAP_A_SLOT0
op_plus
(paren
id|slot
op_star
l_int|8
)paren
suffix:semicolon
r_else
r_return
id|SABRE_IMAP_B_SLOT0
op_plus
(paren
id|slot
op_star
l_int|8
)paren
suffix:semicolon
)brace
DECL|variable|__onboard_imap_off
r_static
r_int
r_int
id|__onboard_imap_off
(braket
)braket
op_assign
(brace
multiline_comment|/*0x20*/
id|SABRE_IMAP_SCSI
comma
multiline_comment|/*0x21*/
id|SABRE_IMAP_ETH
comma
multiline_comment|/*0x22*/
id|SABRE_IMAP_BPP
comma
multiline_comment|/*0x23*/
id|SABRE_IMAP_AU_REC
comma
multiline_comment|/*0x24*/
id|SABRE_IMAP_AU_PLAY
comma
multiline_comment|/*0x25*/
id|SABRE_IMAP_PFAIL
comma
multiline_comment|/*0x26*/
id|SABRE_IMAP_KMS
comma
multiline_comment|/*0x27*/
id|SABRE_IMAP_FLPY
comma
multiline_comment|/*0x28*/
id|SABRE_IMAP_SHW
comma
multiline_comment|/*0x29*/
id|SABRE_IMAP_KBD
comma
multiline_comment|/*0x2a*/
id|SABRE_IMAP_MS
comma
multiline_comment|/*0x2b*/
id|SABRE_IMAP_SER
comma
multiline_comment|/*0x2c*/
l_int|0
multiline_comment|/* reserved */
comma
multiline_comment|/*0x2d*/
l_int|0
multiline_comment|/* reserved */
comma
multiline_comment|/*0x2e*/
id|SABRE_IMAP_UE
comma
multiline_comment|/*0x2f*/
id|SABRE_IMAP_CE
comma
multiline_comment|/*0x30*/
id|SABRE_IMAP_PCIERR
comma
)brace
suffix:semicolon
DECL|macro|SABRE_ONBOARD_IRQ_BASE
mdefine_line|#define SABRE_ONBOARD_IRQ_BASE&t;&t;0x20
DECL|macro|SABRE_ONBOARD_IRQ_LAST
mdefine_line|#define SABRE_ONBOARD_IRQ_LAST&t;&t;0x30
DECL|macro|sabre_onboard_imap_offset
mdefine_line|#define sabre_onboard_imap_offset(__ino) &bslash;&n;&t;__onboard_imap_off[(__ino) - SABRE_ONBOARD_IRQ_BASE]
DECL|macro|sabre_iclr_offset
mdefine_line|#define sabre_iclr_offset(ino)&t;&t;&t;&t;&t;      &bslash;&n;&t;((ino &amp; 0x20) ? (SABRE_ICLR_SCSI + (((ino) &amp; 0x1f) &lt;&lt; 3)) :  &bslash;&n;&t;&t;&t;(SABRE_ICLR_A_SLOT0 + (((ino) &amp; 0x1f)&lt;&lt;3)))
multiline_comment|/* PCI SABRE INO number to Sparc PIL level. */
DECL|variable|sabre_pil_table
r_static
r_int
r_char
id|sabre_pil_table
(braket
)braket
op_assign
(brace
multiline_comment|/*0x00*/
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* PCI A slot 0  Int A, B, C, D */
multiline_comment|/*0x04*/
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* PCI A slot 1  Int A, B, C, D */
multiline_comment|/*0x08*/
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* PCI A slot 2  Int A, B, C, D */
multiline_comment|/*0x0c*/
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* PCI A slot 3  Int A, B, C, D */
multiline_comment|/*0x10*/
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* PCI B slot 0  Int A, B, C, D */
multiline_comment|/*0x14*/
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* PCI B slot 1  Int A, B, C, D */
multiline_comment|/*0x18*/
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* PCI B slot 2  Int A, B, C, D */
multiline_comment|/*0x1c*/
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* PCI B slot 3  Int A, B, C, D */
multiline_comment|/*0x20*/
l_int|3
comma
multiline_comment|/* SCSI&t;&t;&t;&t;*/
multiline_comment|/*0x21*/
l_int|5
comma
multiline_comment|/* Ethernet&t;&t;&t;*/
multiline_comment|/*0x22*/
l_int|8
comma
multiline_comment|/* Parallel Port&t;&t;*/
multiline_comment|/*0x23*/
l_int|13
comma
multiline_comment|/* Audio Record&t;&t;&t;*/
multiline_comment|/*0x24*/
l_int|14
comma
multiline_comment|/* Audio Playback&t;&t;*/
multiline_comment|/*0x25*/
l_int|15
comma
multiline_comment|/* PowerFail&t;&t;&t;*/
multiline_comment|/*0x26*/
l_int|3
comma
multiline_comment|/* second SCSI&t;&t;&t;*/
multiline_comment|/*0x27*/
l_int|11
comma
multiline_comment|/* Floppy&t;&t;&t;*/
multiline_comment|/*0x28*/
l_int|2
comma
multiline_comment|/* Spare Hardware&t;&t;*/
multiline_comment|/*0x29*/
l_int|9
comma
multiline_comment|/* Keyboard&t;&t;&t;*/
multiline_comment|/*0x2a*/
l_int|4
comma
multiline_comment|/* Mouse&t;&t;&t;*/
multiline_comment|/*0x2b*/
l_int|12
comma
multiline_comment|/* Serial&t;&t;&t;*/
multiline_comment|/*0x2c*/
l_int|10
comma
multiline_comment|/* Timer 0&t;&t;&t;*/
multiline_comment|/*0x2d*/
l_int|11
comma
multiline_comment|/* Timer 1&t;&t;&t;*/
multiline_comment|/*0x2e*/
l_int|15
comma
multiline_comment|/* Uncorrectable ECC&t;&t;*/
multiline_comment|/*0x2f*/
l_int|15
comma
multiline_comment|/* Correctable ECC&t;&t;*/
multiline_comment|/*0x30*/
l_int|15
comma
multiline_comment|/* PCI Bus A Error&t;&t;*/
multiline_comment|/*0x31*/
l_int|15
comma
multiline_comment|/* PCI Bus B Error&t;&t;*/
multiline_comment|/*0x32*/
l_int|1
comma
multiline_comment|/* Power Management&t;&t;*/
)brace
suffix:semicolon
DECL|function|sabre_ino_to_pil
r_static
r_int
id|__init
id|sabre_ino_to_pil
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
r_int
id|ino
)paren
(brace
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|sabre_pil_table
(braket
id|ino
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
op_logical_and
id|pdev
op_eq
l_int|NULL
)paren
(brace
id|ret
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
(brace
r_switch
c_cond
(paren
(paren
id|pdev
op_member_access_from_pointer
r_class
op_rshift
l_int|16
)paren
op_amp
l_int|0x0f
)paren
(brace
r_case
id|PCI_BASE_CLASS_STORAGE
suffix:colon
id|ret
op_assign
l_int|4
suffix:semicolon
r_case
id|PCI_BASE_CLASS_NETWORK
suffix:colon
id|ret
op_assign
l_int|6
suffix:semicolon
r_case
id|PCI_BASE_CLASS_DISPLAY
suffix:colon
id|ret
op_assign
l_int|9
suffix:semicolon
r_case
id|PCI_BASE_CLASS_MULTIMEDIA
suffix:colon
r_case
id|PCI_BASE_CLASS_MEMORY
suffix:colon
r_case
id|PCI_BASE_CLASS_BRIDGE
suffix:colon
id|ret
op_assign
l_int|10
suffix:semicolon
r_default
suffix:colon
id|ret
op_assign
l_int|1
suffix:semicolon
)brace
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sabre_irq_build
r_static
r_int
r_int
id|__init
id|sabre_irq_build
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
comma
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
r_int
id|ino
)paren
(brace
r_struct
id|ino_bucket
op_star
id|bucket
suffix:semicolon
r_int
r_int
id|imap
comma
id|iclr
suffix:semicolon
r_int
r_int
id|imap_off
comma
id|iclr_off
suffix:semicolon
r_int
id|pil
comma
id|inofixup
op_assign
l_int|0
suffix:semicolon
id|ino
op_and_assign
id|PCI_IRQ_INO
suffix:semicolon
r_if
c_cond
(paren
id|ino
OL
id|SABRE_ONBOARD_IRQ_BASE
)paren
(brace
multiline_comment|/* PCI slot */
id|imap_off
op_assign
id|sabre_pcislot_imap_offset
c_func
(paren
id|ino
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* onboard device */
r_if
c_cond
(paren
id|ino
OG
id|SABRE_ONBOARD_IRQ_LAST
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;sabre_irq_build: Wacky INO [%x]&bslash;n&quot;
comma
id|ino
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|imap_off
op_assign
id|sabre_onboard_imap_offset
c_func
(paren
id|ino
)paren
suffix:semicolon
)brace
multiline_comment|/* Now build the IRQ bucket. */
id|pil
op_assign
id|sabre_ino_to_pil
c_func
(paren
id|pdev
comma
id|ino
)paren
suffix:semicolon
id|imap
op_assign
id|p-&gt;controller_regs
op_plus
id|imap_off
suffix:semicolon
id|imap
op_add_assign
l_int|4
suffix:semicolon
id|iclr_off
op_assign
id|sabre_iclr_offset
c_func
(paren
id|ino
)paren
suffix:semicolon
id|iclr
op_assign
id|p-&gt;controller_regs
op_plus
id|iclr_off
suffix:semicolon
id|iclr
op_add_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ino
op_amp
l_int|0x20
)paren
op_eq
l_int|0
)paren
id|inofixup
op_assign
id|ino
op_amp
l_int|0x03
suffix:semicolon
id|bucket
op_assign
id|__bucket
c_func
(paren
id|build_irq
c_func
(paren
id|pil
comma
id|inofixup
comma
id|iclr
comma
id|imap
)paren
)paren
suffix:semicolon
id|bucket-&gt;flags
op_or_assign
id|IBF_PCI
suffix:semicolon
r_if
c_cond
(paren
id|pdev
)paren
(brace
r_struct
id|pcidev_cookie
op_star
id|pcp
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
multiline_comment|/* When a device lives behind a bridge deeper in the&n;&t;&t; * PCI bus topology than APB, a special sequence must&n;&t;&t; * run to make sure all pending DMA transfers at the&n;&t;&t; * time of IRQ delivery are visible in the coherency&n;&t;&t; * domain by the cpu.  This sequence is to perform&n;&t;&t; * a read on the far side of the non-APB bridge, then&n;&t;&t; * perform a read of Sabre&squot;s DMA write-sync register.&n;&t;&t; *&n;&t;&t; * Currently, the PCI_CONFIG register for the device&n;&t;&t; * is used for this read from the far side of the bridge.&n;&t;&t; */
r_if
c_cond
(paren
id|pdev-&gt;bus-&gt;number
op_ne
id|pcp-&gt;pbm-&gt;pci_first_busno
)paren
(brace
id|bucket-&gt;flags
op_or_assign
id|IBF_DMA_SYNC
suffix:semicolon
id|bucket-&gt;synctab_ent
op_assign
id|dma_sync_reg_table_entry
op_increment
suffix:semicolon
id|dma_sync_reg_table
(braket
id|bucket-&gt;synctab_ent
)braket
op_assign
(paren
r_int
r_int
)paren
id|sabre_pci_config_mkaddr
c_func
(paren
id|pcp-&gt;pbm
comma
id|pdev-&gt;bus-&gt;number
comma
id|pdev-&gt;devfn
comma
id|PCI_COMMAND
)paren
suffix:semicolon
)brace
)brace
r_return
id|__irq
c_func
(paren
id|bucket
)paren
suffix:semicolon
)brace
multiline_comment|/* SABRE error handling support. */
DECL|function|sabre_check_iommu_error
r_static
r_void
id|sabre_check_iommu_error
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
comma
r_int
r_int
id|afsr
comma
r_int
r_int
id|afar
)paren
(brace
r_int
r_int
id|iommu_tag
(braket
l_int|16
)braket
suffix:semicolon
r_int
r_int
id|iommu_data
(braket
l_int|16
)braket
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u64
id|control
suffix:semicolon
r_int
id|i
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|p-&gt;iommu.lock
comma
id|flags
)paren
suffix:semicolon
id|control
op_assign
id|sabre_read
c_func
(paren
id|p-&gt;iommu.iommu_control
)paren
suffix:semicolon
r_if
c_cond
(paren
id|control
op_amp
id|SABRE_IOMMUCTRL_ERR
)paren
(brace
r_char
op_star
id|type_string
suffix:semicolon
multiline_comment|/* Clear the error encountered bit.&n;&t;&t; * NOTE: On Sabre this is write 1 to clear,&n;&t;&t; *       which is different from Psycho.&n;&t;&t; */
id|sabre_write
c_func
(paren
id|p-&gt;iommu.iommu_control
comma
id|control
)paren
suffix:semicolon
r_switch
c_cond
(paren
(paren
id|control
op_amp
id|SABRE_IOMMUCTRL_ERRSTS
)paren
op_rshift
l_int|25UL
)paren
(brace
r_case
l_int|1
suffix:colon
id|type_string
op_assign
l_string|&quot;Invalid Error&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|type_string
op_assign
l_string|&quot;ECC Error&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|type_string
op_assign
l_string|&quot;Unknown&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SABRE%d: IOMMU Error, type[%s]&bslash;n&quot;
comma
id|p-&gt;index
comma
id|type_string
)paren
suffix:semicolon
multiline_comment|/* Enter diagnostic mode and probe for error&squot;d&n;&t;&t; * entries in the IOTLB.&n;&t;&t; */
id|control
op_and_assign
op_complement
(paren
id|SABRE_IOMMUCTRL_ERRSTS
op_or
id|SABRE_IOMMUCTRL_ERR
)paren
suffix:semicolon
id|sabre_write
c_func
(paren
id|p-&gt;iommu.iommu_control
comma
(paren
id|control
op_or
id|SABRE_IOMMUCTRL_DENAB
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|base
op_assign
id|p-&gt;controller_regs
suffix:semicolon
id|iommu_tag
(braket
id|i
)braket
op_assign
id|sabre_read
c_func
(paren
id|base
op_plus
id|SABRE_IOMMU_TAG
op_plus
(paren
id|i
op_star
l_int|8UL
)paren
)paren
suffix:semicolon
id|iommu_data
(braket
id|i
)braket
op_assign
id|sabre_read
c_func
(paren
id|base
op_plus
id|SABRE_IOMMU_DATA
op_plus
(paren
id|i
op_star
l_int|8UL
)paren
)paren
suffix:semicolon
id|sabre_write
c_func
(paren
id|base
op_plus
id|SABRE_IOMMU_TAG
op_plus
(paren
id|i
op_star
l_int|8UL
)paren
comma
l_int|0
)paren
suffix:semicolon
id|sabre_write
c_func
(paren
id|base
op_plus
id|SABRE_IOMMU_DATA
op_plus
(paren
id|i
op_star
l_int|8UL
)paren
comma
l_int|0
)paren
suffix:semicolon
)brace
id|sabre_write
c_func
(paren
id|p-&gt;iommu.iommu_control
comma
id|control
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|tag
comma
id|data
suffix:semicolon
id|tag
op_assign
id|iommu_tag
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|tag
op_amp
id|SABRE_IOMMUTAG_ERR
)paren
)paren
r_continue
suffix:semicolon
id|data
op_assign
id|iommu_data
(braket
id|i
)braket
suffix:semicolon
r_switch
c_cond
(paren
(paren
id|tag
op_amp
id|SABRE_IOMMUTAG_ERRSTS
)paren
op_rshift
l_int|23UL
)paren
(brace
r_case
l_int|1
suffix:colon
id|type_string
op_assign
l_string|&quot;Invalid Error&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|type_string
op_assign
l_string|&quot;ECC Error&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|type_string
op_assign
l_string|&quot;Unknown&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SABRE%d: IOMMU TAG(%d)[RAW(%016lx)error(%s)wr(%d)sz(%dK)vpg(%08lx)]&bslash;n&quot;
comma
id|p-&gt;index
comma
id|i
comma
id|tag
comma
id|type_string
comma
(paren
(paren
id|tag
op_amp
id|SABRE_IOMMUTAG_WRITE
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
comma
(paren
(paren
id|tag
op_amp
id|SABRE_IOMMUTAG_SIZE
)paren
ques
c_cond
l_int|64
suffix:colon
l_int|8
)paren
comma
(paren
(paren
id|tag
op_amp
id|SABRE_IOMMUTAG_VPN
)paren
op_lshift
id|PAGE_SHIFT
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SABRE%d: IOMMU DATA(%d)[RAW(%016lx)valid(%d)used(%d)cache(%d)ppg(%016lx)&bslash;n&quot;
comma
id|p-&gt;index
comma
id|i
comma
id|data
comma
(paren
(paren
id|data
op_amp
id|SABRE_IOMMUDATA_VALID
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
comma
(paren
(paren
id|data
op_amp
id|SABRE_IOMMUDATA_USED
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
comma
(paren
(paren
id|data
op_amp
id|SABRE_IOMMUDATA_CACHE
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
comma
(paren
(paren
id|data
op_amp
id|SABRE_IOMMUDATA_PPN
)paren
op_lshift
id|PAGE_SHIFT
)paren
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|p-&gt;iommu.lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|sabre_ue_intr
r_static
r_void
id|sabre_ue_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|pci_controller_info
op_star
id|p
op_assign
id|dev_id
suffix:semicolon
r_int
r_int
id|afsr_reg
op_assign
id|p-&gt;controller_regs
op_plus
id|SABRE_UE_AFSR
suffix:semicolon
r_int
r_int
id|afar_reg
op_assign
id|p-&gt;controller_regs
op_plus
id|SABRE_UECE_AFAR
suffix:semicolon
r_int
r_int
id|afsr
comma
id|afar
comma
id|error_bits
suffix:semicolon
r_int
id|reported
suffix:semicolon
multiline_comment|/* Latch uncorrectable error status. */
id|afar
op_assign
id|sabre_read
c_func
(paren
id|afar_reg
)paren
suffix:semicolon
id|afsr
op_assign
id|sabre_read
c_func
(paren
id|afsr_reg
)paren
suffix:semicolon
multiline_comment|/* Clear the primary/secondary error status bits. */
id|error_bits
op_assign
id|afsr
op_amp
(paren
id|SABRE_UEAFSR_PDRD
op_or
id|SABRE_UEAFSR_PDWR
op_or
id|SABRE_UEAFSR_SDRD
op_or
id|SABRE_UEAFSR_SDWR
op_or
id|SABRE_UEAFSR_SDTE
op_or
id|SABRE_UEAFSR_PDTE
)paren
suffix:semicolon
id|sabre_write
c_func
(paren
id|afsr_reg
comma
id|error_bits
)paren
suffix:semicolon
multiline_comment|/* Log the error. */
id|printk
c_func
(paren
l_string|&quot;SABRE%d: Uncorrectable Error, primary error type[%s%s]&bslash;n&quot;
comma
id|p-&gt;index
comma
(paren
(paren
id|error_bits
op_amp
id|SABRE_UEAFSR_PDRD
)paren
ques
c_cond
l_string|&quot;DMA Read&quot;
suffix:colon
(paren
(paren
id|error_bits
op_amp
id|SABRE_UEAFSR_PDWR
)paren
ques
c_cond
l_string|&quot;DMA Write&quot;
suffix:colon
l_string|&quot;???&quot;
)paren
)paren
comma
(paren
(paren
id|error_bits
op_amp
id|SABRE_UEAFSR_PDTE
)paren
ques
c_cond
l_string|&quot;:Translation Error&quot;
suffix:colon
l_string|&quot;&quot;
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SABRE%d: bytemask[%04lx] dword_offset[%lx] was_block(%d)&bslash;n&quot;
comma
id|p-&gt;index
comma
(paren
id|afsr
op_amp
id|SABRE_UEAFSR_BMSK
)paren
op_rshift
l_int|32UL
comma
(paren
id|afsr
op_amp
id|SABRE_UEAFSR_OFF
)paren
op_rshift
l_int|29UL
comma
(paren
(paren
id|afsr
op_amp
id|SABRE_UEAFSR_BLK
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SABRE%d: UE AFAR [%016lx]&bslash;n&quot;
comma
id|p-&gt;index
comma
id|afar
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SABRE%d: UE Secondary errors [&quot;
comma
id|p-&gt;index
)paren
suffix:semicolon
id|reported
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|afsr
op_amp
id|SABRE_UEAFSR_SDRD
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(DMA Read)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|afsr
op_amp
id|SABRE_UEAFSR_SDWR
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(DMA Write)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|afsr
op_amp
id|SABRE_UEAFSR_SDTE
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(Translation Error)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|reported
)paren
id|printk
c_func
(paren
l_string|&quot;(none)&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;]&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Interrogate IOMMU for error status. */
id|sabre_check_iommu_error
c_func
(paren
id|p
comma
id|afsr
comma
id|afar
)paren
suffix:semicolon
)brace
DECL|function|sabre_ce_intr
r_static
r_void
id|sabre_ce_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|pci_controller_info
op_star
id|p
op_assign
id|dev_id
suffix:semicolon
r_int
r_int
id|afsr_reg
op_assign
id|p-&gt;controller_regs
op_plus
id|SABRE_CE_AFSR
suffix:semicolon
r_int
r_int
id|afar_reg
op_assign
id|p-&gt;controller_regs
op_plus
id|SABRE_UECE_AFAR
suffix:semicolon
r_int
r_int
id|afsr
comma
id|afar
comma
id|error_bits
suffix:semicolon
r_int
id|reported
suffix:semicolon
multiline_comment|/* Latch error status. */
id|afar
op_assign
id|sabre_read
c_func
(paren
id|afar_reg
)paren
suffix:semicolon
id|afsr
op_assign
id|sabre_read
c_func
(paren
id|afsr_reg
)paren
suffix:semicolon
multiline_comment|/* Clear primary/secondary error status bits. */
id|error_bits
op_assign
id|afsr
op_amp
(paren
id|SABRE_CEAFSR_PDRD
op_or
id|SABRE_CEAFSR_PDWR
op_or
id|SABRE_CEAFSR_SDRD
op_or
id|SABRE_CEAFSR_SDWR
)paren
suffix:semicolon
id|sabre_write
c_func
(paren
id|afsr_reg
comma
id|error_bits
)paren
suffix:semicolon
multiline_comment|/* Log the error. */
id|printk
c_func
(paren
l_string|&quot;SABRE%d: Correctable Error, primary error type[%s]&bslash;n&quot;
comma
id|p-&gt;index
comma
(paren
(paren
id|error_bits
op_amp
id|SABRE_CEAFSR_PDRD
)paren
ques
c_cond
l_string|&quot;DMA Read&quot;
suffix:colon
(paren
(paren
id|error_bits
op_amp
id|SABRE_CEAFSR_PDWR
)paren
ques
c_cond
l_string|&quot;DMA Write&quot;
suffix:colon
l_string|&quot;???&quot;
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* XXX Use syndrome and afar to print out module string just like&n;&t; * XXX UDB CE trap handler does... -DaveM&n;&t; */
id|printk
c_func
(paren
l_string|&quot;SABRE%d: syndrome[%02lx] bytemask[%04lx] dword_offset[%lx] &quot;
l_string|&quot;was_block(%d)&bslash;n&quot;
comma
id|p-&gt;index
comma
(paren
id|afsr
op_amp
id|SABRE_CEAFSR_ESYND
)paren
op_rshift
l_int|48UL
comma
(paren
id|afsr
op_amp
id|SABRE_CEAFSR_BMSK
)paren
op_rshift
l_int|32UL
comma
(paren
id|afsr
op_amp
id|SABRE_CEAFSR_OFF
)paren
op_rshift
l_int|29UL
comma
(paren
(paren
id|afsr
op_amp
id|SABRE_CEAFSR_BLK
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SABRE%d: CE AFAR [%016lx]&bslash;n&quot;
comma
id|p-&gt;index
comma
id|afar
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SABRE%d: CE Secondary errors [&quot;
comma
id|p-&gt;index
)paren
suffix:semicolon
id|reported
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|afsr
op_amp
id|SABRE_CEAFSR_SDRD
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(DMA Read)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|afsr
op_amp
id|SABRE_CEAFSR_SDWR
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(DMA Write)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|reported
)paren
id|printk
c_func
(paren
l_string|&quot;(none)&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;]&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|sabre_pcierr_intr
r_static
r_void
id|sabre_pcierr_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|pci_controller_info
op_star
id|p
op_assign
id|dev_id
suffix:semicolon
r_int
r_int
id|afsr_reg
comma
id|afar_reg
suffix:semicolon
r_int
r_int
id|afsr
comma
id|afar
comma
id|error_bits
suffix:semicolon
r_int
id|reported
suffix:semicolon
id|afsr_reg
op_assign
id|p-&gt;controller_regs
op_plus
id|SABRE_PIOAFSR
suffix:semicolon
id|afar_reg
op_assign
id|p-&gt;controller_regs
op_plus
id|SABRE_PIOAFAR
suffix:semicolon
multiline_comment|/* Latch error status. */
id|afar
op_assign
id|sabre_read
c_func
(paren
id|afar_reg
)paren
suffix:semicolon
id|afsr
op_assign
id|sabre_read
c_func
(paren
id|afsr_reg
)paren
suffix:semicolon
multiline_comment|/* Clear primary/secondary error status bits. */
id|error_bits
op_assign
id|afsr
op_amp
(paren
id|SABRE_PIOAFSR_PMA
op_or
id|SABRE_PIOAFSR_PTA
op_or
id|SABRE_PIOAFSR_PRTRY
op_or
id|SABRE_PIOAFSR_PPERR
op_or
id|SABRE_PIOAFSR_SMA
op_or
id|SABRE_PIOAFSR_STA
op_or
id|SABRE_PIOAFSR_SRTRY
op_or
id|SABRE_PIOAFSR_SPERR
)paren
suffix:semicolon
id|sabre_write
c_func
(paren
id|afsr_reg
comma
id|error_bits
)paren
suffix:semicolon
multiline_comment|/* Log the error. */
id|printk
c_func
(paren
l_string|&quot;SABRE%d: PCI Error, primary error type[%s]&bslash;n&quot;
comma
id|p-&gt;index
comma
(paren
(paren
(paren
id|error_bits
op_amp
id|SABRE_PIOAFSR_PMA
)paren
ques
c_cond
l_string|&quot;Master Abort&quot;
suffix:colon
(paren
(paren
id|error_bits
op_amp
id|SABRE_PIOAFSR_PTA
)paren
ques
c_cond
l_string|&quot;Target Abort&quot;
suffix:colon
(paren
(paren
id|error_bits
op_amp
id|SABRE_PIOAFSR_PRTRY
)paren
ques
c_cond
l_string|&quot;Excessive Retries&quot;
suffix:colon
(paren
(paren
id|error_bits
op_amp
id|SABRE_PIOAFSR_PPERR
)paren
ques
c_cond
l_string|&quot;Parity Error&quot;
suffix:colon
l_string|&quot;???&quot;
)paren
)paren
)paren
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SABRE%d: bytemask[%04lx] was_block(%d)&bslash;n&quot;
comma
id|p-&gt;index
comma
(paren
id|afsr
op_amp
id|SABRE_PIOAFSR_BMSK
)paren
op_rshift
l_int|32UL
comma
(paren
id|afsr
op_amp
id|SABRE_PIOAFSR_BLK
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SABRE%d: PCI AFAR [%016lx]&bslash;n&quot;
comma
id|p-&gt;index
comma
id|afar
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SABRE%d: PCI Secondary errors [&quot;
comma
id|p-&gt;index
)paren
suffix:semicolon
id|reported
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|afsr
op_amp
id|SABRE_PIOAFSR_SMA
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(Master Abort)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|afsr
op_amp
id|SABRE_PIOAFSR_STA
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(Target Abort)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|afsr
op_amp
id|SABRE_PIOAFSR_SRTRY
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(Excessive Retries)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|afsr
op_amp
id|SABRE_PIOAFSR_SPERR
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(Parity Error)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|reported
)paren
id|printk
c_func
(paren
l_string|&quot;(none)&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;]&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* For the error types shown, scan both PCI buses for devices&n;&t; * which have logged that error type.&n;&t; */
multiline_comment|/* If we see a Target Abort, this could be the result of an&n;&t; * IOMMU translation error of some sort.  It is extremely&n;&t; * useful to log this information as usually it indicates&n;&t; * a bug in the IOMMU support code or a PCI device driver.&n;&t; */
r_if
c_cond
(paren
id|error_bits
op_amp
(paren
id|SABRE_PIOAFSR_PTA
op_or
id|SABRE_PIOAFSR_STA
)paren
)paren
(brace
id|sabre_check_iommu_error
c_func
(paren
id|p
comma
id|afsr
comma
id|afar
)paren
suffix:semicolon
id|pci_scan_for_target_abort
c_func
(paren
id|p
comma
op_amp
id|p-&gt;pbm_A
comma
id|p-&gt;pbm_A.pci_bus
)paren
suffix:semicolon
id|pci_scan_for_target_abort
c_func
(paren
id|p
comma
op_amp
id|p-&gt;pbm_B
comma
id|p-&gt;pbm_B.pci_bus
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|error_bits
op_amp
(paren
id|SABRE_PIOAFSR_PMA
op_or
id|SABRE_PIOAFSR_SMA
)paren
)paren
(brace
id|pci_scan_for_master_abort
c_func
(paren
id|p
comma
op_amp
id|p-&gt;pbm_A
comma
id|p-&gt;pbm_A.pci_bus
)paren
suffix:semicolon
id|pci_scan_for_master_abort
c_func
(paren
id|p
comma
op_amp
id|p-&gt;pbm_B
comma
id|p-&gt;pbm_B.pci_bus
)paren
suffix:semicolon
)brace
multiline_comment|/* For excessive retries, SABRE/PBM will abort the device&n;&t; * and there is no way to specifically check for excessive&n;&t; * retries in the config space status registers.  So what&n;&t; * we hope is that we&squot;ll catch it via the master/target&n;&t; * abort events.&n;&t; */
r_if
c_cond
(paren
id|error_bits
op_amp
(paren
id|SABRE_PIOAFSR_PPERR
op_or
id|SABRE_PIOAFSR_SPERR
)paren
)paren
(brace
id|pci_scan_for_parity_error
c_func
(paren
id|p
comma
op_amp
id|p-&gt;pbm_A
comma
id|p-&gt;pbm_A.pci_bus
)paren
suffix:semicolon
id|pci_scan_for_parity_error
c_func
(paren
id|p
comma
op_amp
id|p-&gt;pbm_B
comma
id|p-&gt;pbm_B.pci_bus
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* XXX What about PowerFail/PowerManagement??? -DaveM */
DECL|macro|SABRE_UE_INO
mdefine_line|#define SABRE_UE_INO&t;&t;0x2e
DECL|macro|SABRE_CE_INO
mdefine_line|#define SABRE_CE_INO&t;&t;0x2f
DECL|macro|SABRE_PCIERR_INO
mdefine_line|#define SABRE_PCIERR_INO&t;0x30
DECL|function|sabre_register_error_handlers
r_static
r_void
id|__init
id|sabre_register_error_handlers
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
)paren
(brace
r_int
r_int
id|base
op_assign
id|p-&gt;controller_regs
suffix:semicolon
r_int
r_int
id|irq
comma
id|portid
op_assign
id|p-&gt;portid
suffix:semicolon
id|u64
id|tmp
suffix:semicolon
multiline_comment|/* We clear the error bits in the appropriate AFSR before&n;&t; * registering the handler so that we don&squot;t get spurious&n;&t; * interrupts.&n;&t; */
id|sabre_write
c_func
(paren
id|base
op_plus
id|SABRE_UE_AFSR
comma
(paren
id|SABRE_UEAFSR_PDRD
op_or
id|SABRE_UEAFSR_PDWR
op_or
id|SABRE_UEAFSR_SDRD
op_or
id|SABRE_UEAFSR_SDWR
op_or
id|SABRE_UEAFSR_SDTE
op_or
id|SABRE_UEAFSR_PDTE
)paren
)paren
suffix:semicolon
id|irq
op_assign
id|sabre_irq_build
c_func
(paren
id|p
comma
l_int|NULL
comma
(paren
id|portid
op_lshift
l_int|6
)paren
op_or
id|SABRE_UE_INO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|sabre_ue_intr
comma
id|SA_SHIRQ
comma
l_string|&quot;SABRE UE&quot;
comma
id|p
)paren
OL
l_int|0
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SABRE%d: Cannot register UE interrupt.&bslash;n&quot;
comma
id|p-&gt;index
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|sabre_write
c_func
(paren
id|base
op_plus
id|SABRE_CE_AFSR
comma
(paren
id|SABRE_CEAFSR_PDRD
op_or
id|SABRE_CEAFSR_PDWR
op_or
id|SABRE_CEAFSR_SDRD
op_or
id|SABRE_CEAFSR_SDWR
)paren
)paren
suffix:semicolon
id|irq
op_assign
id|sabre_irq_build
c_func
(paren
id|p
comma
l_int|NULL
comma
(paren
id|portid
op_lshift
l_int|6
)paren
op_or
id|SABRE_CE_INO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|sabre_ce_intr
comma
id|SA_SHIRQ
comma
l_string|&quot;SABRE CE&quot;
comma
id|p
)paren
OL
l_int|0
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SABRE%d: Cannot register CE interrupt.&bslash;n&quot;
comma
id|p-&gt;index
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|irq
op_assign
id|sabre_irq_build
c_func
(paren
id|p
comma
l_int|NULL
comma
(paren
id|portid
op_lshift
l_int|6
)paren
op_or
id|SABRE_PCIERR_INO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|sabre_pcierr_intr
comma
id|SA_SHIRQ
comma
l_string|&quot;SABRE PCIERR&quot;
comma
id|p
)paren
OL
l_int|0
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SABRE%d: Cannot register PciERR interrupt.&bslash;n&quot;
comma
id|p-&gt;index
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|tmp
op_assign
id|sabre_read
c_func
(paren
id|base
op_plus
id|SABRE_PCICTRL
)paren
suffix:semicolon
id|tmp
op_or_assign
id|SABRE_PCICTRL_ERREN
suffix:semicolon
id|sabre_write
c_func
(paren
id|base
op_plus
id|SABRE_PCICTRL
comma
id|tmp
)paren
suffix:semicolon
)brace
DECL|function|sabre_resource_adjust
r_static
r_void
id|__init
id|sabre_resource_adjust
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_struct
id|resource
op_star
id|res
comma
r_struct
id|resource
op_star
id|root
)paren
(brace
r_struct
id|pcidev_cookie
op_star
id|pcp
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
r_struct
id|pci_controller_info
op_star
id|p
op_assign
id|pcp-&gt;pbm-&gt;parent
suffix:semicolon
r_int
r_int
id|base
suffix:semicolon
r_if
c_cond
(paren
id|res-&gt;flags
op_amp
id|IORESOURCE_IO
)paren
id|base
op_assign
id|p-&gt;controller_regs
op_plus
id|SABRE_IOSPACE
suffix:semicolon
r_else
id|base
op_assign
id|p-&gt;controller_regs
op_plus
id|SABRE_MEMSPACE
suffix:semicolon
id|res-&gt;start
op_add_assign
id|base
suffix:semicolon
id|res-&gt;end
op_add_assign
id|base
suffix:semicolon
)brace
DECL|function|sabre_base_address_update
r_static
r_void
id|__init
id|sabre_base_address_update
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
id|resource
)paren
(brace
r_struct
id|pcidev_cookie
op_star
id|pcp
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
r_struct
id|pci_pbm_info
op_star
id|pbm
op_assign
id|pcp-&gt;pbm
suffix:semicolon
r_struct
id|pci_controller_info
op_star
id|p
op_assign
id|pbm-&gt;parent
suffix:semicolon
r_struct
id|resource
op_star
id|res
suffix:semicolon
r_int
r_int
id|base
suffix:semicolon
id|u32
id|reg
suffix:semicolon
r_int
id|where
comma
id|size
comma
id|is_64bit
suffix:semicolon
id|res
op_assign
op_amp
id|pdev-&gt;resource
(braket
id|resource
)braket
suffix:semicolon
id|where
op_assign
id|PCI_BASE_ADDRESS_0
op_plus
(paren
id|resource
op_star
l_int|4
)paren
suffix:semicolon
id|is_64bit
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|res-&gt;flags
op_amp
id|IORESOURCE_IO
)paren
id|base
op_assign
id|p-&gt;controller_regs
op_plus
id|SABRE_IOSPACE
suffix:semicolon
r_else
(brace
id|base
op_assign
id|p-&gt;controller_regs
op_plus
id|SABRE_MEMSPACE
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res-&gt;flags
op_amp
id|PCI_BASE_ADDRESS_MEM_TYPE_MASK
)paren
op_eq
id|PCI_BASE_ADDRESS_MEM_TYPE_64
)paren
id|is_64bit
op_assign
l_int|1
suffix:semicolon
)brace
id|size
op_assign
id|res-&gt;end
op_minus
id|res-&gt;start
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|pdev
comma
id|where
comma
op_amp
id|reg
)paren
suffix:semicolon
id|reg
op_assign
(paren
(paren
id|reg
op_amp
id|size
)paren
op_or
(paren
(paren
(paren
id|u32
)paren
(paren
id|res-&gt;start
op_minus
id|base
)paren
)paren
op_amp
op_complement
id|size
)paren
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|pdev
comma
id|where
comma
id|reg
)paren
suffix:semicolon
multiline_comment|/* This knows that the upper 32-bits of the address&n;&t; * must be zero.  Our PCI common layer enforces this.&n;&t; */
r_if
c_cond
(paren
id|is_64bit
)paren
id|pci_write_config_dword
c_func
(paren
id|pdev
comma
id|where
op_plus
l_int|4
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|apb_init
r_static
r_void
id|__init
id|apb_init
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
comma
r_struct
id|pci_bus
op_star
id|sabre_bus
)paren
(brace
r_struct
id|list_head
op_star
id|walk
op_assign
op_amp
id|sabre_bus-&gt;devices
suffix:semicolon
r_for
c_loop
(paren
id|walk
op_assign
id|walk-&gt;next
suffix:semicolon
id|walk
op_ne
op_amp
id|sabre_bus-&gt;devices
suffix:semicolon
id|walk
op_assign
id|walk-&gt;next
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|pci_dev_b
c_func
(paren
id|walk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_SUN
op_logical_and
id|pdev-&gt;device
op_eq
id|PCI_DEVICE_ID_SUN_SIMBA
)paren
(brace
id|u16
id|word
suffix:semicolon
id|sabre_read_word
c_func
(paren
id|pdev
comma
id|PCI_COMMAND
comma
op_amp
id|word
)paren
suffix:semicolon
id|word
op_or_assign
id|PCI_COMMAND_SERR
op_or
id|PCI_COMMAND_PARITY
op_or
id|PCI_COMMAND_MASTER
op_or
id|PCI_COMMAND_MEMORY
op_or
id|PCI_COMMAND_IO
suffix:semicolon
id|sabre_write_word
c_func
(paren
id|pdev
comma
id|PCI_COMMAND
comma
id|word
)paren
suffix:semicolon
multiline_comment|/* Status register bits are &quot;write 1 to clear&quot;. */
id|sabre_write_word
c_func
(paren
id|pdev
comma
id|PCI_STATUS
comma
l_int|0xffff
)paren
suffix:semicolon
id|sabre_write_word
c_func
(paren
id|pdev
comma
id|PCI_SEC_STATUS
comma
l_int|0xffff
)paren
suffix:semicolon
multiline_comment|/* Use a primary/seconday latency timer value&n;&t;&t;&t; * of 64.&n;&t;&t;&t; */
id|sabre_write_byte
c_func
(paren
id|pdev
comma
id|PCI_LATENCY_TIMER
comma
l_int|64
)paren
suffix:semicolon
id|sabre_write_byte
c_func
(paren
id|pdev
comma
id|PCI_SEC_LATENCY_TIMER
comma
l_int|64
)paren
suffix:semicolon
multiline_comment|/* Enable reporting/forwarding of master aborts,&n;&t;&t;&t; * parity, and SERR.&n;&t;&t;&t; */
id|sabre_write_byte
c_func
(paren
id|pdev
comma
id|PCI_BRIDGE_CONTROL
comma
(paren
id|PCI_BRIDGE_CTL_PARITY
op_or
id|PCI_BRIDGE_CTL_SERR
op_or
id|PCI_BRIDGE_CTL_MASTER_ABORT
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|sabre_scan_bus
r_static
r_void
id|__init
id|sabre_scan_bus
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
)paren
(brace
r_static
r_int
id|once
op_assign
l_int|0
suffix:semicolon
r_struct
id|pci_bus
op_star
id|sabre_bus
suffix:semicolon
r_struct
id|list_head
op_star
id|walk
suffix:semicolon
multiline_comment|/* The APB bridge speaks to the Sabre host PCI bridge&n;&t; * at 66Mhz, but the front side of APB runs at 33Mhz&n;&t; * for both segments.&n;&t; */
id|p-&gt;pbm_A.is_66mhz_capable
op_assign
l_int|0
suffix:semicolon
id|p-&gt;pbm_B.is_66mhz_capable
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Unlike for PSYCHO, we can only have one SABRE&n;&t; * in a system.  Having multiple SABREs is thus&n;&t; * and error, and as a consequence we do not need&n;&t; * to do any bus renumbering but we do have to have&n;&t; * the pci_bus2pbm array setup properly.&n;&t; *&n;&t; * Also note that the SABRE host bridge is hardwired&n;&t; * to live at bus 0.&n;&t; */
r_if
c_cond
(paren
id|once
op_ne
l_int|0
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SABRE: Multiple controllers unsupported.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|once
op_increment
suffix:semicolon
multiline_comment|/* The pci_bus2pbm table has already been setup in sabre_init. */
id|sabre_bus
op_assign
id|pci_scan_bus
c_func
(paren
id|p-&gt;pci_first_busno
comma
id|p-&gt;pci_ops
comma
op_amp
id|p-&gt;pbm_A
)paren
suffix:semicolon
id|apb_init
c_func
(paren
id|p
comma
id|sabre_bus
)paren
suffix:semicolon
id|walk
op_assign
op_amp
id|sabre_bus-&gt;children
suffix:semicolon
r_for
c_loop
(paren
id|walk
op_assign
id|walk-&gt;next
suffix:semicolon
id|walk
op_ne
op_amp
id|sabre_bus-&gt;children
suffix:semicolon
id|walk
op_assign
id|walk-&gt;next
)paren
(brace
r_struct
id|pci_bus
op_star
id|pbus
op_assign
id|pci_bus_b
c_func
(paren
id|walk
)paren
suffix:semicolon
r_struct
id|pci_pbm_info
op_star
id|pbm
suffix:semicolon
r_if
c_cond
(paren
id|pbus-&gt;number
op_eq
id|p-&gt;pbm_A.pci_first_busno
)paren
(brace
id|pbm
op_assign
op_amp
id|p-&gt;pbm_A
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pbus-&gt;number
op_eq
id|p-&gt;pbm_B.pci_first_busno
)paren
(brace
id|pbm
op_assign
op_amp
id|p-&gt;pbm_B
suffix:semicolon
)brace
r_else
r_continue
suffix:semicolon
id|pbus-&gt;sysdata
op_assign
id|pbm
suffix:semicolon
id|pbm-&gt;pci_bus
op_assign
id|pbus
suffix:semicolon
id|pci_fill_in_pbm_cookies
c_func
(paren
id|pbus
comma
id|pbm
comma
id|pbm-&gt;prom_node
)paren
suffix:semicolon
id|pci_record_assignments
c_func
(paren
id|pbm
comma
id|pbus
)paren
suffix:semicolon
id|pci_assign_unassigned
c_func
(paren
id|pbm
comma
id|pbus
)paren
suffix:semicolon
id|pci_fixup_irq
c_func
(paren
id|pbm
comma
id|pbus
)paren
suffix:semicolon
id|pci_determine_66mhz_disposition
c_func
(paren
id|pbm
comma
id|pbus
)paren
suffix:semicolon
id|pci_setup_busmastering
c_func
(paren
id|pbm
comma
id|pbus
)paren
suffix:semicolon
)brace
id|sabre_register_error_handlers
c_func
(paren
id|p
)paren
suffix:semicolon
)brace
DECL|function|sabre_iommu_init
r_static
r_void
id|__init
id|sabre_iommu_init
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
comma
r_int
id|tsbsize
comma
r_int
r_int
id|dvma_offset
comma
id|u32
id|dma_mask
)paren
(brace
r_int
r_int
id|tsbbase
comma
id|i
comma
id|order
suffix:semicolon
id|u64
id|control
suffix:semicolon
multiline_comment|/* Setup initial software IOMMU state. */
id|spin_lock_init
c_func
(paren
op_amp
id|p-&gt;iommu.lock
)paren
suffix:semicolon
id|p-&gt;iommu.iommu_cur_ctx
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Register addresses. */
id|p-&gt;iommu.iommu_control
op_assign
id|p-&gt;controller_regs
op_plus
id|SABRE_IOMMU_CONTROL
suffix:semicolon
id|p-&gt;iommu.iommu_tsbbase
op_assign
id|p-&gt;controller_regs
op_plus
id|SABRE_IOMMU_TSBBASE
suffix:semicolon
id|p-&gt;iommu.iommu_flush
op_assign
id|p-&gt;controller_regs
op_plus
id|SABRE_IOMMU_FLUSH
suffix:semicolon
id|p-&gt;iommu.write_complete_reg
op_assign
id|p-&gt;controller_regs
op_plus
id|SABRE_WRSYNC
suffix:semicolon
multiline_comment|/* Sabre&squot;s IOMMU lacks ctx flushing. */
id|p-&gt;iommu.iommu_ctxflush
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Invalidate TLB Entries. */
id|control
op_assign
id|sabre_read
c_func
(paren
id|p-&gt;controller_regs
op_plus
id|SABRE_IOMMU_CONTROL
)paren
suffix:semicolon
id|control
op_or_assign
id|SABRE_IOMMUCTRL_DENAB
suffix:semicolon
id|sabre_write
c_func
(paren
id|p-&gt;controller_regs
op_plus
id|SABRE_IOMMU_CONTROL
comma
id|control
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sabre_write
c_func
(paren
id|p-&gt;controller_regs
op_plus
id|SABRE_IOMMU_TAG
op_plus
(paren
id|i
op_star
l_int|8UL
)paren
comma
l_int|0
)paren
suffix:semicolon
id|sabre_write
c_func
(paren
id|p-&gt;controller_regs
op_plus
id|SABRE_IOMMU_DATA
op_plus
(paren
id|i
op_star
l_int|8UL
)paren
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Leave diag mode enabled for full-flushing done&n;&t; * in pci_iommu.c&n;&t; */
id|tsbbase
op_assign
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
comma
id|order
op_assign
id|get_order
c_func
(paren
id|tsbsize
op_star
l_int|1024
op_star
l_int|8
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tsbbase
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SABRE_IOMMU: Error, gfp(tsb) failed.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|p-&gt;iommu.page_table
op_assign
(paren
id|iopte_t
op_star
)paren
id|tsbbase
suffix:semicolon
id|p-&gt;iommu.page_table_map_base
op_assign
id|dvma_offset
suffix:semicolon
id|p-&gt;iommu.dma_addr_mask
op_assign
id|dma_mask
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|tsbbase
comma
l_int|0
comma
id|PAGE_SIZE
op_lshift
id|order
)paren
suffix:semicolon
id|sabre_write
c_func
(paren
id|p-&gt;controller_regs
op_plus
id|SABRE_IOMMU_TSBBASE
comma
id|__pa
c_func
(paren
id|tsbbase
)paren
)paren
suffix:semicolon
id|control
op_assign
id|sabre_read
c_func
(paren
id|p-&gt;controller_regs
op_plus
id|SABRE_IOMMU_CONTROL
)paren
suffix:semicolon
id|control
op_and_assign
op_complement
(paren
id|SABRE_IOMMUCTRL_TSBSZ
op_or
id|SABRE_IOMMUCTRL_TBWSZ
)paren
suffix:semicolon
id|control
op_or_assign
id|SABRE_IOMMUCTRL_ENAB
suffix:semicolon
r_switch
c_cond
(paren
id|tsbsize
)paren
(brace
r_case
l_int|64
suffix:colon
id|control
op_or_assign
id|SABRE_IOMMU_TSBSZ_64K
suffix:semicolon
id|p-&gt;iommu.page_table_sz_bits
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|128
suffix:colon
id|control
op_or_assign
id|SABRE_IOMMU_TSBSZ_128K
suffix:semicolon
id|p-&gt;iommu.page_table_sz_bits
op_assign
l_int|17
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|prom_printf
c_func
(paren
l_string|&quot;iommu_init: Illegal TSB size %d&bslash;n&quot;
comma
id|tsbsize
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|sabre_write
c_func
(paren
id|p-&gt;controller_regs
op_plus
id|SABRE_IOMMU_CONTROL
comma
id|control
)paren
suffix:semicolon
multiline_comment|/* We start with no consistent mappings. */
id|p-&gt;iommu.lowest_consistent_map
op_assign
l_int|1
op_lshift
(paren
id|p-&gt;iommu.page_table_sz_bits
op_minus
id|PBM_LOGCLUSTERS
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PBM_NCLUSTERS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p-&gt;iommu.alloc_info
(braket
id|i
)braket
dot
id|flush
op_assign
l_int|0
suffix:semicolon
id|p-&gt;iommu.alloc_info
(braket
id|i
)braket
dot
id|next
op_assign
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|pbm_register_toplevel_resources
r_static
r_void
id|__init
id|pbm_register_toplevel_resources
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
comma
r_struct
id|pci_pbm_info
op_star
id|pbm
)paren
(brace
r_char
op_star
id|name
op_assign
id|pbm-&gt;name
suffix:semicolon
r_int
r_int
id|ibase
op_assign
id|p-&gt;controller_regs
op_plus
id|SABRE_IOSPACE
suffix:semicolon
r_int
r_int
id|mbase
op_assign
id|p-&gt;controller_regs
op_plus
id|SABRE_MEMSPACE
suffix:semicolon
r_int
r_int
id|devfn
suffix:semicolon
r_int
r_int
id|first
comma
id|last
comma
id|i
suffix:semicolon
id|u8
op_star
id|addr
comma
id|map
suffix:semicolon
id|sprintf
c_func
(paren
id|name
comma
l_string|&quot;SABRE%d PBM%c&quot;
comma
id|p-&gt;index
comma
(paren
id|pbm
op_eq
op_amp
id|p-&gt;pbm_A
ques
c_cond
l_char|&squot;A&squot;
suffix:colon
l_char|&squot;B&squot;
)paren
)paren
suffix:semicolon
id|pbm-&gt;io_space.name
op_assign
id|pbm-&gt;mem_space.name
op_assign
id|name
suffix:semicolon
id|devfn
op_assign
id|PCI_DEVFN
c_func
(paren
l_int|1
comma
(paren
id|pbm
op_eq
op_amp
id|p-&gt;pbm_A
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
)paren
suffix:semicolon
id|addr
op_assign
id|sabre_pci_config_mkaddr
c_func
(paren
id|pbm
comma
l_int|0
comma
id|devfn
comma
id|APB_IO_ADDRESS_MAP
)paren
suffix:semicolon
id|map
op_assign
l_int|0
suffix:semicolon
id|pci_config_read8
c_func
(paren
id|addr
comma
op_amp
id|map
)paren
suffix:semicolon
id|first
op_assign
l_int|8
suffix:semicolon
id|last
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|map
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|first
OG
id|i
)paren
id|first
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|last
OL
id|i
)paren
id|last
op_assign
id|i
suffix:semicolon
)brace
)brace
id|pbm-&gt;io_space.start
op_assign
id|ibase
op_plus
(paren
id|first
op_lshift
l_int|21UL
)paren
suffix:semicolon
id|pbm-&gt;io_space.end
op_assign
id|ibase
op_plus
(paren
id|last
op_lshift
l_int|21UL
)paren
op_plus
(paren
(paren
l_int|1
op_lshift
l_int|21UL
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|pbm-&gt;io_space.flags
op_assign
id|IORESOURCE_IO
suffix:semicolon
id|addr
op_assign
id|sabre_pci_config_mkaddr
c_func
(paren
id|pbm
comma
l_int|0
comma
id|devfn
comma
id|APB_MEM_ADDRESS_MAP
)paren
suffix:semicolon
id|map
op_assign
l_int|0
suffix:semicolon
id|pci_config_read8
c_func
(paren
id|addr
comma
op_amp
id|map
)paren
suffix:semicolon
id|first
op_assign
l_int|8
suffix:semicolon
id|last
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|map
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|first
OG
id|i
)paren
id|first
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|last
OL
id|i
)paren
id|last
op_assign
id|i
suffix:semicolon
)brace
)brace
id|pbm-&gt;mem_space.start
op_assign
id|mbase
op_plus
(paren
id|first
op_lshift
l_int|29UL
)paren
suffix:semicolon
id|pbm-&gt;mem_space.end
op_assign
id|mbase
op_plus
(paren
id|last
op_lshift
l_int|29UL
)paren
op_plus
(paren
(paren
l_int|1
op_lshift
l_int|29UL
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|pbm-&gt;mem_space.flags
op_assign
id|IORESOURCE_MEM
suffix:semicolon
r_if
c_cond
(paren
id|request_resource
c_func
(paren
op_amp
id|ioport_resource
comma
op_amp
id|pbm-&gt;io_space
)paren
OL
l_int|0
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;Cannot register PBM-%c&squot;s IO space.&bslash;n&quot;
comma
(paren
id|pbm
op_eq
op_amp
id|p-&gt;pbm_A
ques
c_cond
l_char|&squot;A&squot;
suffix:colon
l_char|&squot;B&squot;
)paren
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_resource
c_func
(paren
op_amp
id|iomem_resource
comma
op_amp
id|pbm-&gt;mem_space
)paren
OL
l_int|0
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;Cannot register PBM-%c&squot;s MEM space.&bslash;n&quot;
comma
(paren
id|pbm
op_eq
op_amp
id|p-&gt;pbm_A
ques
c_cond
l_char|&squot;A&squot;
suffix:colon
l_char|&squot;B&squot;
)paren
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|sabre_pbm_init
r_static
r_void
id|__init
id|sabre_pbm_init
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
comma
r_int
id|sabre_node
)paren
(brace
r_char
id|namebuf
(braket
l_int|128
)braket
suffix:semicolon
id|u32
id|busrange
(braket
l_int|2
)braket
suffix:semicolon
r_int
id|node
suffix:semicolon
id|node
op_assign
id|prom_getchild
c_func
(paren
id|sabre_node
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|node
op_assign
id|prom_searchsiblings
c_func
(paren
id|node
comma
l_string|&quot;pci&quot;
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_struct
id|pci_pbm_info
op_star
id|pbm
suffix:semicolon
r_int
id|err
suffix:semicolon
id|err
op_assign
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;model&quot;
comma
id|namebuf
comma
r_sizeof
(paren
id|namebuf
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_le
l_int|0
)paren
op_logical_or
id|strncmp
c_func
(paren
id|namebuf
comma
l_string|&quot;SUNW,simba&quot;
comma
id|err
)paren
)paren
r_goto
id|next_pci
suffix:semicolon
id|err
op_assign
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;bus-range&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|busrange
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|busrange
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
l_int|0
op_logical_or
id|err
op_eq
op_minus
l_int|1
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;APB: Error, cannot get PCI bus-range.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|busrange
(braket
l_int|0
)braket
op_eq
l_int|1
)paren
id|pbm
op_assign
op_amp
id|p-&gt;pbm_B
suffix:semicolon
r_else
id|pbm
op_assign
op_amp
id|p-&gt;pbm_A
suffix:semicolon
id|pbm-&gt;parent
op_assign
id|p
suffix:semicolon
id|pbm-&gt;prom_node
op_assign
id|node
suffix:semicolon
id|pbm-&gt;pci_first_busno
op_assign
id|busrange
(braket
l_int|0
)braket
suffix:semicolon
id|pbm-&gt;pci_last_busno
op_assign
id|busrange
(braket
l_int|1
)braket
suffix:semicolon
r_for
c_loop
(paren
id|err
op_assign
id|pbm-&gt;pci_first_busno
suffix:semicolon
id|err
op_le
id|pbm-&gt;pci_last_busno
suffix:semicolon
id|err
op_increment
)paren
id|pci_bus2pbm
(braket
id|err
)braket
op_assign
id|pbm
suffix:semicolon
id|prom_getstring
c_func
(paren
id|node
comma
l_string|&quot;name&quot;
comma
id|pbm-&gt;prom_name
comma
r_sizeof
(paren
id|pbm-&gt;prom_name
)paren
)paren
suffix:semicolon
id|err
op_assign
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;ranges&quot;
comma
(paren
r_char
op_star
)paren
id|pbm-&gt;pbm_ranges
comma
r_sizeof
(paren
id|pbm-&gt;pbm_ranges
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
op_minus
l_int|1
)paren
id|pbm-&gt;num_pbm_ranges
op_assign
(paren
id|err
op_div
r_sizeof
(paren
r_struct
id|linux_prom_pci_ranges
)paren
)paren
suffix:semicolon
r_else
id|pbm-&gt;num_pbm_ranges
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;interrupt-map&quot;
comma
(paren
r_char
op_star
)paren
id|pbm-&gt;pbm_intmap
comma
r_sizeof
(paren
id|pbm-&gt;pbm_intmap
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
op_minus
l_int|1
)paren
(brace
id|pbm-&gt;num_pbm_intmap
op_assign
(paren
id|err
op_div
r_sizeof
(paren
r_struct
id|linux_prom_pci_intmap
)paren
)paren
suffix:semicolon
id|err
op_assign
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;interrupt-map-mask&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|pbm-&gt;pbm_intmask
comma
r_sizeof
(paren
id|pbm-&gt;pbm_intmask
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
op_minus
l_int|1
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;APB: Fatal error, no interrupt-map-mask.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|pbm-&gt;num_pbm_intmap
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|pbm-&gt;pbm_intmask
comma
l_int|0
comma
r_sizeof
(paren
id|pbm-&gt;pbm_intmask
)paren
)paren
suffix:semicolon
)brace
id|pbm_register_toplevel_resources
c_func
(paren
id|p
comma
id|pbm
)paren
suffix:semicolon
id|next_pci
suffix:colon
id|node
op_assign
id|prom_getsibling
c_func
(paren
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
r_break
suffix:semicolon
)brace
)brace
DECL|function|sabre_init
r_void
id|__init
id|sabre_init
c_func
(paren
r_int
id|pnode
)paren
(brace
r_struct
id|linux_prom64_registers
id|pr_regs
(braket
l_int|2
)braket
suffix:semicolon
r_struct
id|pci_controller_info
op_star
id|p
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|tsbsize
comma
id|err
suffix:semicolon
id|u32
id|busrange
(braket
l_int|2
)braket
suffix:semicolon
id|u32
id|vdma
(braket
l_int|2
)braket
suffix:semicolon
id|u32
id|upa_portid
comma
id|dma_mask
suffix:semicolon
r_int
id|bus
suffix:semicolon
id|p
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|p
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SABRE: Error, kmalloc(pci_controller_info) failed.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|upa_portid
op_assign
id|prom_getintdefault
c_func
(paren
id|pnode
comma
l_string|&quot;upa-portid&quot;
comma
l_int|0xff
)paren
suffix:semicolon
id|memset
c_func
(paren
id|p
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|p
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pci_controller_lock
comma
id|flags
)paren
suffix:semicolon
id|p-&gt;next
op_assign
id|pci_controller_root
suffix:semicolon
id|pci_controller_root
op_assign
id|p
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pci_controller_lock
comma
id|flags
)paren
suffix:semicolon
id|p-&gt;portid
op_assign
id|upa_portid
suffix:semicolon
id|p-&gt;index
op_assign
id|pci_num_controllers
op_increment
suffix:semicolon
id|p-&gt;scan_bus
op_assign
id|sabre_scan_bus
suffix:semicolon
id|p-&gt;irq_build
op_assign
id|sabre_irq_build
suffix:semicolon
id|p-&gt;base_address_update
op_assign
id|sabre_base_address_update
suffix:semicolon
id|p-&gt;resource_adjust
op_assign
id|sabre_resource_adjust
suffix:semicolon
id|p-&gt;pci_ops
op_assign
op_amp
id|sabre_ops
suffix:semicolon
multiline_comment|/*&n;&t; * Map in SABRE register set and report the presence of this SABRE.&n;&t; */
id|err
op_assign
id|prom_getproperty
c_func
(paren
id|pnode
comma
l_string|&quot;reg&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|pr_regs
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|pr_regs
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
l_int|0
op_logical_or
id|err
op_eq
op_minus
l_int|1
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SABRE: Error, cannot get U2P registers &quot;
l_string|&quot;from PROM.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * First REG in property is base of entire SABRE register space.&n;&t; */
id|p-&gt;controller_regs
op_assign
id|pr_regs
(braket
l_int|0
)braket
dot
id|phys_addr
suffix:semicolon
id|pci_dma_wsync
op_assign
id|p-&gt;controller_regs
op_plus
id|SABRE_WRSYNC
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI: Found SABRE, main regs at %016lx, wsync at %016lx&bslash;n&quot;
comma
id|p-&gt;controller_regs
comma
id|pci_dma_wsync
)paren
suffix:semicolon
multiline_comment|/* Error interrupts are enabled later after the bus scan. */
id|sabre_write
c_func
(paren
id|p-&gt;controller_regs
op_plus
id|SABRE_PCICTRL
comma
(paren
id|SABRE_PCICTRL_MRLEN
op_or
id|SABRE_PCICTRL_SERR
op_or
id|SABRE_PCICTRL_ARBPARK
op_or
id|SABRE_PCICTRL_AEN
)paren
)paren
suffix:semicolon
multiline_comment|/* Now map in PCI config space for entire SABRE. */
id|p-&gt;config_space
op_assign
id|p-&gt;controller_regs
op_plus
id|SABRE_CONFIGSPACE
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SABRE: PCI config space at %016lx&bslash;n&quot;
comma
id|p-&gt;config_space
)paren
suffix:semicolon
id|err
op_assign
id|prom_getproperty
c_func
(paren
id|pnode
comma
l_string|&quot;virtual-dma&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|vdma
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|vdma
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
l_int|0
op_logical_or
id|err
op_eq
op_minus
l_int|1
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SABRE: Error, cannot get virtual-dma property &quot;
l_string|&quot;from PROM.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|dma_mask
op_assign
id|vdma
(braket
l_int|0
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|vdma
(braket
l_int|1
)braket
)paren
(brace
r_case
l_int|0x20000000
suffix:colon
id|dma_mask
op_or_assign
l_int|0x1fffffff
suffix:semicolon
id|tsbsize
op_assign
l_int|64
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x40000000
suffix:colon
id|dma_mask
op_or_assign
l_int|0x3fffffff
suffix:semicolon
id|tsbsize
op_assign
l_int|128
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x80000000
suffix:colon
id|dma_mask
op_or_assign
l_int|0x7fffffff
suffix:semicolon
id|tsbsize
op_assign
l_int|128
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|prom_printf
c_func
(paren
l_string|&quot;SABRE: strange virtual-dma size.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|sabre_iommu_init
c_func
(paren
id|p
comma
id|tsbsize
comma
id|vdma
(braket
l_int|0
)braket
comma
id|dma_mask
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SABRE: DVMA at %08x [%08x]&bslash;n&quot;
comma
id|vdma
(braket
l_int|0
)braket
comma
id|vdma
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|err
op_assign
id|prom_getproperty
c_func
(paren
id|pnode
comma
l_string|&quot;bus-range&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|busrange
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|busrange
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
l_int|0
op_logical_or
id|err
op_eq
op_minus
l_int|1
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SABRE: Error, cannot get PCI bus-range &quot;
l_string|&quot; from PROM.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|p-&gt;pci_first_busno
op_assign
id|busrange
(braket
l_int|0
)braket
suffix:semicolon
id|p-&gt;pci_last_busno
op_assign
id|busrange
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/*&n;&t; * Handle config space reads through any Simba on APB.&n;&t; */
r_for
c_loop
(paren
id|bus
op_assign
id|p-&gt;pci_first_busno
suffix:semicolon
id|bus
op_le
id|p-&gt;pci_last_busno
suffix:semicolon
id|bus
op_increment
)paren
id|pci_bus2pbm
(braket
id|bus
)braket
op_assign
op_amp
id|p-&gt;pbm_A
suffix:semicolon
multiline_comment|/*&n;&t; * Look for APB underneath.&n;&t; */
id|sabre_pbm_init
c_func
(paren
id|p
comma
id|pnode
)paren
suffix:semicolon
)brace
eof
