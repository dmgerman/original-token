multiline_comment|/* $Id: starfire.c,v 1.8 2000/10/27 18:36:47 anton Exp $&n; * starfire.c: Starfire/E10000 support.&n; *&n; * Copyright (C) 1998 David S. Miller (davem@redhat.com)&n; * Copyright (C) 2000 Anton Blanchard (anton@linuxcare.com)&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/smp.h&gt;
macro_line|#include &lt;asm/upa.h&gt;
macro_line|#include &lt;asm/starfire.h&gt;
multiline_comment|/*&n; * A few places around the kernel check this to see if&n; * they need to call us to do things in a Starfire specific&n; * way.&n; */
DECL|variable|this_is_starfire
r_int
id|this_is_starfire
op_assign
l_int|0
suffix:semicolon
DECL|function|check_if_starfire
r_void
id|check_if_starfire
c_func
(paren
r_void
)paren
(brace
r_int
id|ssnode
op_assign
id|prom_finddevice
c_func
(paren
l_string|&quot;/ssp-serial&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ssnode
op_ne
l_int|0
op_logical_and
id|ssnode
op_ne
op_minus
l_int|1
)paren
(brace
id|this_is_starfire
op_assign
l_int|1
suffix:semicolon
)brace
)brace
DECL|function|starfire_cpu_setup
r_void
id|starfire_cpu_setup
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|this_is_starfire
)paren
(brace
multiline_comment|/*&n; * We do this in starfire_translate and xcall_deliver. When we fix our cpu&n; * arrays to support &gt; 64 processors we can use the real upaid instead&n; * of the logical cpuid in __cpu_number_map etc, then we can get rid of&n; * the translations everywhere. - Anton&n; */
macro_line|#if 0
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Now must fixup cpu MIDs.  OBP gave us a logical&n;&t;&t; * linear cpuid number, not the real upaid.&n;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|linux_num_cpus
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|mid
op_assign
id|linux_cpus
(braket
id|i
)braket
dot
id|mid
suffix:semicolon
id|mid
op_assign
(paren
(paren
(paren
id|mid
op_amp
l_int|0x3c
)paren
op_lshift
l_int|1
)paren
op_or
(paren
(paren
id|mid
op_amp
l_int|0x40
)paren
op_rshift
l_int|4
)paren
op_or
(paren
id|mid
op_amp
l_int|0x3
)paren
)paren
suffix:semicolon
id|linux_cpus
(braket
id|i
)braket
dot
id|mid
op_assign
id|mid
suffix:semicolon
)brace
macro_line|#endif
)brace
)brace
DECL|function|starfire_hard_smp_processor_id
r_int
id|starfire_hard_smp_processor_id
c_func
(paren
r_void
)paren
(brace
r_return
id|upa_readl
c_func
(paren
l_int|0x1fff40000d0UL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Each Starfire board has 32 registers which perform translation&n; * and delivery of traditional interrupt packets into the extended&n; * Starfire hardware format.  Essentially UPAID&squot;s now have 2 more&n; * bits than in all previous Sun5 systems.&n; */
DECL|struct|starfire_irqinfo
r_struct
id|starfire_irqinfo
(brace
DECL|member|imap_slots
r_int
r_int
id|imap_slots
(braket
l_int|32
)braket
suffix:semicolon
DECL|member|tregs
r_int
r_int
id|tregs
(braket
l_int|32
)braket
suffix:semicolon
DECL|member|next
r_struct
id|starfire_irqinfo
op_star
id|next
suffix:semicolon
DECL|member|upaid
DECL|member|hwmid
r_int
id|upaid
comma
id|hwmid
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|sflist
r_static
r_struct
id|starfire_irqinfo
op_star
id|sflist
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Beam me up Scott(McNeil)y... */
DECL|function|starfire_hookup
r_void
op_star
id|starfire_hookup
c_func
(paren
r_int
id|upaid
)paren
(brace
r_struct
id|starfire_irqinfo
op_star
id|p
suffix:semicolon
r_int
r_int
id|treg_base
comma
id|hwmid
comma
id|i
suffix:semicolon
id|p
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|p
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;starfire_hookup: No memory, this is insane.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|treg_base
op_assign
l_int|0x100fc000000UL
suffix:semicolon
id|hwmid
op_assign
(paren
(paren
id|upaid
op_amp
l_int|0x3c
)paren
op_lshift
l_int|1
)paren
op_or
(paren
(paren
id|upaid
op_amp
l_int|0x40
)paren
op_rshift
l_int|4
)paren
op_or
(paren
id|upaid
op_amp
l_int|0x3
)paren
suffix:semicolon
id|p-&gt;hwmid
op_assign
id|hwmid
suffix:semicolon
id|treg_base
op_add_assign
(paren
id|hwmid
op_lshift
l_int|33UL
)paren
suffix:semicolon
id|treg_base
op_add_assign
l_int|0x200UL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p-&gt;imap_slots
(braket
id|i
)braket
op_assign
l_int|0UL
suffix:semicolon
id|p-&gt;tregs
(braket
id|i
)braket
op_assign
id|treg_base
op_plus
(paren
id|i
op_star
l_int|0x10UL
)paren
suffix:semicolon
multiline_comment|/* Lets play it safe and not overwrite existing mappings */
r_if
c_cond
(paren
id|upa_readl
c_func
(paren
id|p-&gt;tregs
(braket
id|i
)braket
)paren
op_ne
l_int|0
)paren
id|p-&gt;imap_slots
(braket
id|i
)braket
op_assign
l_int|0xdeadbeaf
suffix:semicolon
)brace
id|p-&gt;upaid
op_assign
id|upaid
suffix:semicolon
id|p-&gt;next
op_assign
id|sflist
suffix:semicolon
id|sflist
op_assign
id|p
suffix:semicolon
r_return
(paren
r_void
op_star
)paren
id|p
suffix:semicolon
)brace
DECL|function|starfire_translate
r_int
r_int
id|starfire_translate
c_func
(paren
r_int
r_int
id|imap
comma
r_int
r_int
id|upaid
)paren
(brace
r_struct
id|starfire_irqinfo
op_star
id|p
suffix:semicolon
r_int
r_int
id|bus_hwmid
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
id|bus_hwmid
op_assign
(paren
(paren
(paren
r_int
r_int
)paren
id|imap
)paren
op_rshift
l_int|33
)paren
op_amp
l_int|0x7f
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|sflist
suffix:semicolon
id|p
op_ne
l_int|NULL
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
r_if
c_cond
(paren
id|p-&gt;hwmid
op_eq
id|bus_hwmid
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p
op_eq
l_int|NULL
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;XFIRE: Cannot find irqinfo for imap %016lx&bslash;n&quot;
comma
(paren
(paren
r_int
r_int
)paren
id|imap
)paren
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;imap_slots
(braket
id|i
)braket
op_eq
id|imap
op_logical_or
id|p-&gt;imap_slots
(braket
id|i
)braket
op_eq
l_int|0UL
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|32
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;starfire_translate: Are you kidding me?&bslash;n&quot;
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;Lucy in the sky....&quot;
)paren
suffix:semicolon
)brace
id|p-&gt;imap_slots
(braket
id|i
)braket
op_assign
id|imap
suffix:semicolon
multiline_comment|/* map to real upaid */
id|upaid
op_assign
(paren
(paren
(paren
id|upaid
op_amp
l_int|0x3c
)paren
op_lshift
l_int|1
)paren
op_or
(paren
(paren
id|upaid
op_amp
l_int|0x40
)paren
op_rshift
l_int|4
)paren
op_or
(paren
id|upaid
op_amp
l_int|0x3
)paren
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|upaid
comma
id|p-&gt;tregs
(braket
id|i
)braket
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
eof
