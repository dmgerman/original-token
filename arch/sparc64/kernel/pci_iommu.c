multiline_comment|/* $Id: pci_iommu.c,v 1.1 1999/08/30 10:00:47 davem Exp $&n; * pci_iommu.c: UltraSparc PCI controller IOM/STC support.&n; *&n; * Copyright (C) 1999 David S. Miller (davem@redhat.com)&n; */
macro_line|#include &lt;asm/pbm.h&gt;
macro_line|#include &lt;asm/iommu.h&gt;
macro_line|#include &lt;asm/scatterlist.h&gt;
DECL|macro|PCI_STC_CTXMATCH_ADDR
mdefine_line|#define PCI_STC_CTXMATCH_ADDR(STC, CTX)&t;&bslash;&n;&t;((STC)-&gt;strbuf_ctxmatch_base + ((CTX) &lt;&lt; 3))
multiline_comment|/* Accessing IOMMU and Streaming Buffer registers.&n; * REG parameter is a physical address.  All registers&n; * are 64-bits in size.&n; */
DECL|macro|pci_iommu_read
mdefine_line|#define pci_iommu_read(__reg) &bslash;&n;({&t;u64 __ret; &bslash;&n;&t;__asm__ __volatile__(&quot;ldxa [%1] %2, %0&quot; &bslash;&n;&t;&t;&t;     : &quot;=r&quot; (__ret) &bslash;&n;&t;&t;&t;     : &quot;r&quot; (__reg), &quot;i&quot; (ASI_PHYS_BYPASS_EC_E) &bslash;&n;&t;&t;&t;     : &quot;memory&quot;); &bslash;&n;&t;__ret; &bslash;&n;})
DECL|macro|pci_iommu_write
mdefine_line|#define pci_iommu_write(__reg, __val) &bslash;&n;&t;__asm__ __volatile__(&quot;stxa %0, [%1] %2&quot; &bslash;&n;&t;&t;&t;     : /* no outputs */ &bslash;&n;&t;&t;&t;     : &quot;r&quot; (__val), &quot;r&quot; (__reg), &bslash;&n;&t;&t;&t;       &quot;i&quot; (ASI_PHYS_BYPASS_EC_E))
multiline_comment|/* Find a range of iommu mappings of size NPAGES in page&n; * table PGT.  Return pointer to first iopte.&n; */
DECL|function|iommu_find_range
r_static
id|iopte_t
op_star
id|iommu_find_range
c_func
(paren
r_int
r_int
id|npages
comma
id|iopte_t
op_star
id|pgt
comma
r_int
id|pgt_size
)paren
(brace
r_int
id|i
suffix:semicolon
id|pgt_size
op_sub_assign
id|npages
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pgt_size
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|iopte_val
c_func
(paren
id|pgt
(braket
id|i
)braket
)paren
op_amp
id|IOPTE_VALID
)paren
(brace
r_int
id|scan
suffix:semicolon
r_for
c_loop
(paren
id|scan
op_assign
l_int|1
suffix:semicolon
id|scan
OL
id|npages
suffix:semicolon
id|scan
op_increment
)paren
(brace
r_if
c_cond
(paren
id|iopte_val
c_func
(paren
id|pgt
(braket
id|i
op_plus
id|scan
)braket
)paren
op_amp
id|IOPTE_VALID
)paren
(brace
id|i
op_add_assign
id|scan
suffix:semicolon
r_goto
id|do_next
suffix:semicolon
)brace
)brace
r_return
op_amp
id|pgt
(braket
id|i
)braket
suffix:semicolon
)brace
id|do_next
suffix:colon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|macro|IOPTE_CONSISTANT
mdefine_line|#define IOPTE_CONSISTANT(CTX, PADDR) &bslash;&n;&t;(IOPTE_VALID | IOPTE_CACHE | IOPTE_WRITE | &bslash;&n;&t; (((CTX) &lt;&lt; 47) &amp; IOPTE_CONTEXT) | &bslash;&n;&t; ((PADDR) &amp; IOPTE_PAGE))
DECL|macro|IOPTE_STREAMING
mdefine_line|#define IOPTE_STREAMING(CTX, PADDR) &bslash;&n;&t;(IOPTE_CONSISTANT(CTX, PADDR) | IOPTE_STBUF)
DECL|macro|IOPTE_INVALID
mdefine_line|#define IOPTE_INVALID&t;0UL
multiline_comment|/* Map kernel buffer at ADDR of size SZ using consistant mode&n; * DMA for PCI device PDEV.  Return 32-bit PCI DMA address.&n; */
DECL|function|pci_map_consistant
id|u32
id|pci_map_consistant
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_void
op_star
id|addr
comma
r_int
id|sz
)paren
(brace
r_struct
id|pcidev_cookie
op_star
id|pcp
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
r_struct
id|pci_iommu
op_star
id|iommu
op_assign
op_amp
id|pcp-&gt;pbm-&gt;parent-&gt;iommu
suffix:semicolon
id|iopte_t
op_star
id|base
suffix:semicolon
r_int
r_int
id|flags
comma
id|npages
comma
id|oaddr
suffix:semicolon
id|u32
id|ret
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|oaddr
op_assign
(paren
r_int
r_int
)paren
id|addr
suffix:semicolon
id|npages
op_assign
id|PAGE_ALIGN
c_func
(paren
id|oaddr
op_plus
id|sz
)paren
op_minus
(paren
id|oaddr
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
id|npages
op_rshift_assign
id|PAGE_SHIFT
suffix:semicolon
id|base
op_assign
id|iommu_find_range
c_func
(paren
id|npages
comma
id|iommu-&gt;page_table
comma
id|iommu-&gt;page_table_sz
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|base
op_ne
l_int|NULL
)paren
(brace
r_int
r_int
id|i
comma
id|base_paddr
comma
id|ctx
suffix:semicolon
id|ret
op_assign
(paren
id|iommu-&gt;page_table_map_base
op_plus
(paren
(paren
id|base
op_minus
id|iommu-&gt;page_table
)paren
op_lshift
id|PAGE_SHIFT
)paren
)paren
suffix:semicolon
id|ret
op_or_assign
(paren
id|oaddr
op_amp
op_complement
id|PAGE_MASK
)paren
suffix:semicolon
id|base_paddr
op_assign
id|__pa
c_func
(paren
id|oaddr
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
id|ctx
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|iommu-&gt;iommu_has_ctx_flush
)paren
id|ctx
op_assign
id|iommu-&gt;iommu_cur_ctx
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|npages
suffix:semicolon
id|i
op_increment
comma
id|base
op_increment
comma
id|base_paddr
op_add_assign
id|PAGE_SIZE
)paren
id|iopte_val
c_func
(paren
op_star
id|base
)paren
op_assign
id|IOPTE_CONSISTANT
c_func
(paren
id|ctx
comma
id|base_paddr
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Unmap a consistant DMA translation. */
DECL|function|pci_unmap_consistant
r_void
id|pci_unmap_consistant
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|u32
id|bus_addr
comma
r_int
id|sz
)paren
(brace
r_struct
id|pcidev_cookie
op_star
id|pcp
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
r_struct
id|pci_iommu
op_star
id|iommu
op_assign
op_amp
id|pcp-&gt;pbm-&gt;parent-&gt;iommu
suffix:semicolon
id|iopte_t
op_star
id|base
suffix:semicolon
r_int
r_int
id|flags
comma
id|npages
comma
id|i
comma
id|ctx
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|npages
op_assign
id|PAGE_ALIGN
c_func
(paren
id|bus_addr
op_plus
id|sz
)paren
op_minus
(paren
id|bus_addr
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
id|npages
op_rshift_assign
id|PAGE_SHIFT
suffix:semicolon
id|base
op_assign
id|iommu-&gt;page_table
op_plus
(paren
(paren
id|bus_addr
op_minus
id|iommu-&gt;page_table_map_base
)paren
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
multiline_comment|/* Data for consistant mappings cannot enter the streaming&n;&t; * buffers, so we only need to update the TSB and flush&n;&t; * those entries from the IOMMU&squot;s TLB.&n;&t; */
multiline_comment|/* Step 1: Clear out the TSB entries.  Save away&n;&t; *         the context if necessary.&n;&t; */
id|ctx
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|iommu-&gt;iommu_has_ctx_flush
)paren
id|ctx
op_assign
(paren
id|iopte_val
c_func
(paren
op_star
id|base
)paren
op_amp
id|IOPTE_CONTEXT
)paren
op_rshift
l_int|47UL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|npages
suffix:semicolon
id|i
op_increment
comma
id|base
op_increment
)paren
id|iopte_val
c_func
(paren
op_star
id|base
)paren
op_assign
id|IOPTE_INVALID
suffix:semicolon
multiline_comment|/* Step 2: Flush from IOMMU TLB. */
r_if
c_cond
(paren
id|iommu-&gt;iommu_has_ctx_flush
)paren
(brace
id|pci_iommu_write
c_func
(paren
id|iommu-&gt;iommu_ctxflush
comma
id|ctx
)paren
suffix:semicolon
)brace
r_else
(brace
id|bus_addr
op_and_assign
id|PAGE_MASK
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|npages
suffix:semicolon
id|i
op_increment
comma
id|bus_addr
op_add_assign
id|PAGE_SIZE
)paren
id|pci_iommu_write
c_func
(paren
id|iommu-&gt;iommu_flush
comma
id|bus_addr
)paren
suffix:semicolon
)brace
multiline_comment|/* Step 3: Ensure completion of previous PIO writes. */
(paren
r_void
)paren
id|pci_iommu_read
c_func
(paren
id|iommu-&gt;write_complete_reg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Map a single buffer at PTR of SZ bytes for PCI DMA&n; * in streaming mode.&n; */
DECL|function|pci_map_single
id|u32
id|pci_map_single
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_void
op_star
id|ptr
comma
r_int
id|sz
)paren
(brace
r_struct
id|pcidev_cookie
op_star
id|pcp
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
r_struct
id|pci_iommu
op_star
id|iommu
op_assign
op_amp
id|pcp-&gt;pbm-&gt;parent-&gt;iommu
suffix:semicolon
id|iopte_t
op_star
id|base
suffix:semicolon
r_int
r_int
id|flags
comma
id|npages
comma
id|oaddr
suffix:semicolon
id|u32
id|ret
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|oaddr
op_assign
(paren
r_int
r_int
)paren
id|ptr
suffix:semicolon
id|npages
op_assign
id|PAGE_ALIGN
c_func
(paren
id|oaddr
op_plus
id|sz
)paren
op_minus
(paren
id|oaddr
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
id|npages
op_rshift_assign
id|PAGE_SHIFT
suffix:semicolon
id|base
op_assign
id|iommu_find_range
c_func
(paren
id|npages
comma
id|iommu-&gt;page_table
comma
id|iommu-&gt;page_table_sz
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|base
op_ne
l_int|NULL
)paren
(brace
r_int
r_int
id|i
comma
id|base_paddr
comma
id|ctx
suffix:semicolon
id|ret
op_assign
(paren
id|iommu-&gt;page_table_map_base
op_plus
(paren
(paren
id|base
op_minus
id|iommu-&gt;page_table
)paren
op_lshift
id|PAGE_SHIFT
)paren
)paren
suffix:semicolon
id|ret
op_or_assign
(paren
id|oaddr
op_amp
op_complement
id|PAGE_MASK
)paren
suffix:semicolon
id|base_paddr
op_assign
id|__pa
c_func
(paren
id|oaddr
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
id|ctx
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|iommu-&gt;iommu_has_ctx_flush
)paren
id|ctx
op_assign
id|iommu-&gt;iommu_cur_ctx
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|npages
suffix:semicolon
id|i
op_increment
comma
id|base
op_increment
comma
id|base_paddr
op_add_assign
id|PAGE_SIZE
)paren
id|iopte_val
c_func
(paren
op_star
id|base
)paren
op_assign
id|IOPTE_STREAMING
c_func
(paren
id|ctx
comma
id|base_paddr
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Unmap a single streaming mode DMA translation. */
DECL|function|pci_unmap_single
r_void
id|pci_unmap_single
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|u32
id|bus_addr
comma
r_int
id|sz
)paren
(brace
r_struct
id|pcidev_cookie
op_star
id|pcp
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
r_struct
id|pci_iommu
op_star
id|iommu
op_assign
op_amp
id|pcp-&gt;pbm-&gt;parent-&gt;iommu
suffix:semicolon
r_struct
id|pci_strbuf
op_star
id|strbuf
op_assign
op_amp
id|pcp-&gt;pbm-&gt;stc
suffix:semicolon
id|iopte_t
op_star
id|base
suffix:semicolon
r_int
r_int
id|flags
comma
id|npages
comma
id|i
comma
id|ctx
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|npages
op_assign
id|PAGE_ALIGN
c_func
(paren
id|bus_addr
op_plus
id|sz
)paren
op_minus
(paren
id|bus_addr
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
id|npages
op_rshift_assign
id|PAGE_SHIFT
suffix:semicolon
id|base
op_assign
id|iommu-&gt;page_table
op_plus
(paren
(paren
id|bus_addr
op_minus
id|iommu-&gt;page_table_map_base
)paren
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|bus_addr
op_and_assign
id|PAGE_MASK
suffix:semicolon
multiline_comment|/* Step 1: Record the context, if any. */
id|ctx
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|iommu-&gt;iommu_has_ctx_flush
)paren
id|ctx
op_assign
(paren
id|iopte_val
c_func
(paren
op_star
id|base
)paren
op_amp
id|IOPTE_CONTEXT
)paren
op_rshift
l_int|47UL
suffix:semicolon
multiline_comment|/* Step 2: Kick data out of streaming buffers if necessary. */
r_if
c_cond
(paren
id|strbuf-&gt;strbuf_enabled
)paren
(brace
id|u32
id|vaddr
op_assign
id|bus_addr
suffix:semicolon
id|PCI_STC_FLUSHFLAG_INIT
c_func
(paren
id|strbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strbuf-&gt;strbuf_has_ctx_flush
op_logical_and
id|iommu-&gt;iommu_has_ctx_flush
)paren
(brace
r_int
r_int
id|matchreg
comma
id|flushreg
suffix:semicolon
id|flushreg
op_assign
id|strbuf-&gt;strbuf_ctxflush
suffix:semicolon
id|matchreg
op_assign
id|PCI_STC_CTXMATCH_ADDR
c_func
(paren
id|strbuf
comma
id|ctx
)paren
suffix:semicolon
r_do
(brace
id|pci_iommu_write
c_func
(paren
id|flushreg
comma
id|ctx
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
(paren
r_int
)paren
id|pci_iommu_read
c_func
(paren
id|matchreg
)paren
)paren
OL
l_int|0L
)paren
(brace
suffix:semicolon
)brace
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|npages
suffix:semicolon
id|i
op_increment
comma
id|vaddr
op_add_assign
id|PAGE_SIZE
)paren
id|pci_iommu_write
c_func
(paren
id|strbuf-&gt;strbuf_pflush
comma
id|vaddr
)paren
suffix:semicolon
)brace
id|pci_iommu_write
c_func
(paren
id|strbuf-&gt;strbuf_fsync
comma
id|strbuf-&gt;strbuf_flushflag_pa
)paren
suffix:semicolon
(paren
r_void
)paren
id|pci_iommu_read
c_func
(paren
id|iommu-&gt;write_complete_reg
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|PCI_STC_FLUSHFLAG_SET
c_func
(paren
id|strbuf
)paren
)paren
id|membar
c_func
(paren
l_string|&quot;#LoadLoad&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Step 3: Clear out TSB entries. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|npages
suffix:semicolon
id|i
op_increment
comma
id|base
op_increment
)paren
id|iopte_val
c_func
(paren
op_star
id|base
)paren
op_assign
id|IOPTE_INVALID
suffix:semicolon
multiline_comment|/* Step 4: Flush the IOMMU TLB. */
r_if
c_cond
(paren
id|iommu-&gt;iommu_has_ctx_flush
)paren
(brace
id|pci_iommu_write
c_func
(paren
id|iommu-&gt;iommu_ctxflush
comma
id|ctx
)paren
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|npages
suffix:semicolon
id|i
op_increment
comma
id|bus_addr
op_add_assign
id|PAGE_SIZE
)paren
id|pci_iommu_write
c_func
(paren
id|iommu-&gt;iommu_flush
comma
id|bus_addr
)paren
suffix:semicolon
)brace
multiline_comment|/* Step 5: Ensure completion of previous PIO writes. */
(paren
r_void
)paren
id|pci_iommu_read
c_func
(paren
id|iommu-&gt;write_complete_reg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Map a set of buffers described by SGLIST with NELEMS array&n; * elements in streaming mode for PCI DMA.&n; */
DECL|function|pci_map_sg
r_void
id|pci_map_sg
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_struct
id|scatterlist
op_star
id|sglist
comma
r_int
id|nelems
)paren
(brace
r_struct
id|pcidev_cookie
op_star
id|pcp
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
r_struct
id|pci_iommu
op_star
id|iommu
op_assign
op_amp
id|pcp-&gt;pbm-&gt;parent-&gt;iommu
suffix:semicolon
r_int
r_int
id|flags
comma
id|ctx
comma
id|i
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Step 1: Choose a context if necessary. */
id|ctx
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|iommu-&gt;iommu_has_ctx_flush
)paren
id|ctx
op_assign
id|iommu-&gt;iommu_cur_ctx
op_increment
suffix:semicolon
multiline_comment|/* Step 2: Create the mappings. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nelems
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|oaddr
comma
id|npages
suffix:semicolon
id|iopte_t
op_star
id|base
suffix:semicolon
id|oaddr
op_assign
(paren
r_int
r_int
)paren
id|sglist
(braket
id|i
)braket
dot
id|address
suffix:semicolon
id|npages
op_assign
id|PAGE_ALIGN
c_func
(paren
id|oaddr
op_plus
id|sglist
(braket
id|i
)braket
dot
id|length
)paren
op_minus
(paren
id|oaddr
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
id|npages
op_rshift_assign
id|PAGE_SHIFT
suffix:semicolon
id|base
op_assign
id|iommu_find_range
c_func
(paren
id|npages
comma
id|iommu-&gt;page_table
comma
id|iommu-&gt;page_table_sz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|base
op_ne
l_int|NULL
)paren
(brace
r_int
r_int
id|j
comma
id|base_paddr
suffix:semicolon
id|u32
id|dvma_addr
suffix:semicolon
id|dvma_addr
op_assign
(paren
id|iommu-&gt;page_table_map_base
op_plus
(paren
(paren
id|base
op_minus
id|iommu-&gt;page_table
)paren
op_lshift
id|PAGE_SHIFT
)paren
)paren
suffix:semicolon
id|dvma_addr
op_or_assign
(paren
id|oaddr
op_amp
op_complement
id|PAGE_MASK
)paren
suffix:semicolon
id|sglist
(braket
id|i
)braket
dot
id|dvma_address
op_assign
id|dvma_addr
suffix:semicolon
id|sglist
(braket
id|i
)braket
dot
id|dvma_length
op_assign
id|sglist
(braket
id|i
)braket
dot
id|length
suffix:semicolon
id|base_paddr
op_assign
id|__pa
c_func
(paren
id|oaddr
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|npages
suffix:semicolon
id|j
op_increment
comma
id|base
op_increment
comma
id|base_paddr
op_add_assign
id|PAGE_SIZE
)paren
id|iopte_val
c_func
(paren
op_star
id|base
)paren
op_assign
id|IOPTE_STREAMING
c_func
(paren
id|ctx
comma
id|base_paddr
)paren
suffix:semicolon
)brace
r_else
(brace
id|sglist
(braket
id|i
)braket
dot
id|dvma_address
op_assign
l_int|0
suffix:semicolon
id|sglist
(braket
id|i
)braket
dot
id|dvma_length
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Unmap a set of streaming mode DMA translations. */
DECL|function|pci_unmap_sg
r_void
id|pci_unmap_sg
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_struct
id|scatterlist
op_star
id|sglist
comma
r_int
id|nelems
)paren
(brace
r_struct
id|pcidev_cookie
op_star
id|pcp
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
r_struct
id|pci_iommu
op_star
id|iommu
op_assign
op_amp
id|pcp-&gt;pbm-&gt;parent-&gt;iommu
suffix:semicolon
r_struct
id|pci_strbuf
op_star
id|strbuf
op_assign
op_amp
id|pcp-&gt;pbm-&gt;stc
suffix:semicolon
r_int
r_int
id|flags
comma
id|ctx
comma
id|i
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Step 1: Record the context, if any. */
id|ctx
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|iommu-&gt;iommu_has_ctx_flush
)paren
(brace
id|iopte_t
op_star
id|iopte
suffix:semicolon
id|iopte
op_assign
id|iommu-&gt;page_table
op_plus
(paren
(paren
id|sglist
(braket
l_int|0
)braket
dot
id|dvma_address
op_minus
id|iommu-&gt;page_table_map_base
)paren
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|ctx
op_assign
(paren
id|iopte_val
c_func
(paren
op_star
id|iopte
)paren
op_amp
id|IOPTE_CONTEXT
)paren
op_rshift
l_int|47UL
suffix:semicolon
)brace
multiline_comment|/* Step 2: Kick data out of streaming buffers if necessary. */
r_if
c_cond
(paren
id|strbuf-&gt;strbuf_enabled
)paren
(brace
id|PCI_STC_FLUSHFLAG_INIT
c_func
(paren
id|strbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strbuf-&gt;strbuf_has_ctx_flush
op_logical_and
id|iommu-&gt;iommu_has_ctx_flush
)paren
(brace
r_int
r_int
id|matchreg
comma
id|flushreg
suffix:semicolon
id|flushreg
op_assign
id|strbuf-&gt;strbuf_ctxflush
suffix:semicolon
id|matchreg
op_assign
id|PCI_STC_CTXMATCH_ADDR
c_func
(paren
id|strbuf
comma
id|ctx
)paren
suffix:semicolon
r_do
(brace
id|pci_iommu_write
c_func
(paren
id|flushreg
comma
id|ctx
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
(paren
r_int
)paren
id|pci_iommu_read
c_func
(paren
id|matchreg
)paren
)paren
OL
l_int|0L
)paren
(brace
suffix:semicolon
)brace
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nelems
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|j
comma
id|npages
suffix:semicolon
id|u32
id|vaddr
suffix:semicolon
id|j
op_assign
id|sglist
(braket
id|i
)braket
dot
id|dvma_length
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|j
)paren
r_break
suffix:semicolon
id|vaddr
op_assign
id|sglist
(braket
id|i
)braket
dot
id|dvma_address
suffix:semicolon
id|npages
op_assign
id|PAGE_ALIGN
c_func
(paren
id|vaddr
op_plus
id|j
)paren
op_minus
(paren
id|vaddr
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
id|npages
op_rshift_assign
id|PAGE_SHIFT
suffix:semicolon
id|vaddr
op_and_assign
id|PAGE_MASK
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|npages
suffix:semicolon
id|j
op_increment
comma
id|vaddr
op_add_assign
id|PAGE_SIZE
)paren
id|pci_iommu_write
c_func
(paren
id|strbuf-&gt;strbuf_pflush
comma
id|vaddr
)paren
suffix:semicolon
)brace
id|pci_iommu_write
c_func
(paren
id|strbuf-&gt;strbuf_fsync
comma
id|strbuf-&gt;strbuf_flushflag_pa
)paren
suffix:semicolon
(paren
r_void
)paren
id|pci_iommu_read
c_func
(paren
id|iommu-&gt;write_complete_reg
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|PCI_STC_FLUSHFLAG_SET
c_func
(paren
id|strbuf
)paren
)paren
id|membar
c_func
(paren
l_string|&quot;#LoadLoad&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Step 3: Clear out TSB entries. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nelems
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|j
comma
id|npages
suffix:semicolon
id|iopte_t
op_star
id|base
suffix:semicolon
id|u32
id|vaddr
suffix:semicolon
id|j
op_assign
id|sglist
(braket
id|i
)braket
dot
id|dvma_length
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|j
)paren
r_break
suffix:semicolon
id|vaddr
op_assign
id|sglist
(braket
id|i
)braket
dot
id|dvma_address
suffix:semicolon
id|npages
op_assign
id|PAGE_ALIGN
c_func
(paren
id|vaddr
op_plus
id|j
)paren
op_minus
(paren
id|vaddr
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
id|npages
op_rshift_assign
id|PAGE_SHIFT
suffix:semicolon
id|base
op_assign
id|iommu-&gt;page_table
op_plus
(paren
(paren
id|vaddr
op_minus
id|iommu-&gt;page_table_map_base
)paren
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|npages
suffix:semicolon
id|j
op_increment
comma
id|base
op_increment
)paren
id|iopte_val
c_func
(paren
op_star
id|base
)paren
op_assign
id|IOPTE_INVALID
suffix:semicolon
)brace
multiline_comment|/* Step 4: Flush the IOMMU TLB. */
r_if
c_cond
(paren
id|iommu-&gt;iommu_has_ctx_flush
)paren
(brace
id|pci_iommu_write
c_func
(paren
id|iommu-&gt;iommu_ctxflush
comma
id|ctx
)paren
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nelems
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|j
comma
id|npages
suffix:semicolon
id|u32
id|vaddr
suffix:semicolon
id|j
op_assign
id|sglist
(braket
id|i
)braket
dot
id|dvma_length
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|j
)paren
r_break
suffix:semicolon
id|vaddr
op_assign
id|sglist
(braket
id|i
)braket
dot
id|dvma_address
suffix:semicolon
id|npages
op_assign
id|PAGE_ALIGN
c_func
(paren
id|vaddr
op_plus
id|j
)paren
op_minus
(paren
id|vaddr
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
id|npages
op_rshift_assign
id|PAGE_SHIFT
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|npages
suffix:semicolon
id|j
op_increment
comma
id|vaddr
op_add_assign
id|PAGE_SIZE
)paren
id|pci_iommu_write
c_func
(paren
id|iommu-&gt;iommu_flush
comma
id|vaddr
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Step 5: Ensure completion of previous PIO writes. */
(paren
r_void
)paren
id|pci_iommu_read
c_func
(paren
id|iommu-&gt;write_complete_reg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Make physical memory consistant for a single&n; * streaming mode DMA translation after a transfer.&n; */
DECL|function|pci_dma_sync_single
r_void
id|pci_dma_sync_single
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|u32
id|bus_addr
comma
r_int
id|sz
)paren
(brace
r_struct
id|pcidev_cookie
op_star
id|pcp
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
r_struct
id|pci_iommu
op_star
id|iommu
op_assign
op_amp
id|pcp-&gt;pbm-&gt;parent-&gt;iommu
suffix:semicolon
r_struct
id|pci_strbuf
op_star
id|strbuf
op_assign
op_amp
id|pcp-&gt;pbm-&gt;stc
suffix:semicolon
r_int
r_int
id|flags
comma
id|ctx
comma
id|npages
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strbuf-&gt;strbuf_enabled
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|npages
op_assign
id|PAGE_ALIGN
c_func
(paren
id|bus_addr
op_plus
id|sz
)paren
op_minus
(paren
id|bus_addr
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
id|npages
op_rshift_assign
id|PAGE_SHIFT
suffix:semicolon
id|bus_addr
op_and_assign
id|PAGE_MASK
suffix:semicolon
multiline_comment|/* Step 1: Record the context, if any. */
id|ctx
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|iommu-&gt;iommu_has_ctx_flush
op_logical_and
id|strbuf-&gt;strbuf_has_ctx_flush
)paren
(brace
id|iopte_t
op_star
id|iopte
suffix:semicolon
id|iopte
op_assign
id|iommu-&gt;page_table
op_plus
(paren
(paren
id|bus_addr
op_minus
id|iommu-&gt;page_table_map_base
)paren
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|ctx
op_assign
(paren
id|iopte_val
c_func
(paren
op_star
id|iopte
)paren
op_amp
id|IOPTE_CONTEXT
)paren
op_rshift
l_int|47UL
suffix:semicolon
)brace
multiline_comment|/* Step 2: Kick data out of streaming buffers. */
id|PCI_STC_FLUSHFLAG_INIT
c_func
(paren
id|strbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iommu-&gt;iommu_has_ctx_flush
op_logical_and
id|strbuf-&gt;strbuf_has_ctx_flush
)paren
(brace
r_int
r_int
id|matchreg
comma
id|flushreg
suffix:semicolon
id|flushreg
op_assign
id|strbuf-&gt;strbuf_ctxflush
suffix:semicolon
id|matchreg
op_assign
id|PCI_STC_CTXMATCH_ADDR
c_func
(paren
id|strbuf
comma
id|ctx
)paren
suffix:semicolon
r_do
(brace
id|pci_iommu_write
c_func
(paren
id|flushreg
comma
id|ctx
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
(paren
r_int
)paren
id|pci_iommu_read
c_func
(paren
id|matchreg
)paren
)paren
OL
l_int|0L
)paren
(brace
suffix:semicolon
)brace
)brace
r_else
(brace
r_int
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|npages
suffix:semicolon
id|i
op_increment
comma
id|bus_addr
op_add_assign
id|PAGE_SIZE
)paren
id|pci_iommu_write
c_func
(paren
id|strbuf-&gt;strbuf_pflush
comma
id|bus_addr
)paren
suffix:semicolon
)brace
multiline_comment|/* Step 3: Perform flush synchronization sequence. */
id|pci_iommu_write
c_func
(paren
id|strbuf-&gt;strbuf_fsync
comma
id|strbuf-&gt;strbuf_flushflag_pa
)paren
suffix:semicolon
(paren
r_void
)paren
id|pci_iommu_read
c_func
(paren
id|iommu-&gt;write_complete_reg
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|PCI_STC_FLUSHFLAG_SET
c_func
(paren
id|strbuf
)paren
)paren
id|membar
c_func
(paren
l_string|&quot;#LoadLoad&quot;
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Make physical memory consistant for a set of streaming&n; * mode DMA translations after a transfer.&n; */
DECL|function|pci_dma_sync_sg
r_void
id|pci_dma_sync_sg
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_struct
id|scatterlist
op_star
id|sglist
comma
r_int
id|nelems
)paren
(brace
r_struct
id|pcidev_cookie
op_star
id|pcp
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
r_struct
id|pci_iommu
op_star
id|iommu
op_assign
op_amp
id|pcp-&gt;pbm-&gt;parent-&gt;iommu
suffix:semicolon
r_struct
id|pci_strbuf
op_star
id|strbuf
op_assign
op_amp
id|pcp-&gt;pbm-&gt;stc
suffix:semicolon
r_int
r_int
id|flags
comma
id|ctx
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strbuf-&gt;strbuf_enabled
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Step 1: Record the context, if any. */
id|ctx
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|iommu-&gt;iommu_has_ctx_flush
op_logical_and
id|strbuf-&gt;strbuf_has_ctx_flush
)paren
(brace
id|iopte_t
op_star
id|iopte
suffix:semicolon
id|iopte
op_assign
id|iommu-&gt;page_table
op_plus
(paren
(paren
id|sglist
(braket
l_int|0
)braket
dot
id|dvma_address
op_minus
id|iommu-&gt;page_table_map_base
)paren
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|ctx
op_assign
(paren
id|iopte_val
c_func
(paren
op_star
id|iopte
)paren
op_amp
id|IOPTE_CONTEXT
)paren
op_rshift
l_int|47UL
suffix:semicolon
)brace
multiline_comment|/* Step 2: Kick data out of streaming buffers. */
id|PCI_STC_FLUSHFLAG_INIT
c_func
(paren
id|strbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iommu-&gt;iommu_has_ctx_flush
op_logical_and
id|strbuf-&gt;strbuf_has_ctx_flush
)paren
(brace
r_int
r_int
id|matchreg
comma
id|flushreg
suffix:semicolon
id|flushreg
op_assign
id|strbuf-&gt;strbuf_ctxflush
suffix:semicolon
id|matchreg
op_assign
id|PCI_STC_CTXMATCH_ADDR
c_func
(paren
id|strbuf
comma
id|ctx
)paren
suffix:semicolon
r_do
(brace
id|pci_iommu_write
c_func
(paren
id|flushreg
comma
id|ctx
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
(paren
r_int
)paren
id|pci_iommu_read
c_func
(paren
id|matchreg
)paren
)paren
OL
l_int|0L
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nelems
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|bus_addr
comma
id|npages
comma
id|j
suffix:semicolon
id|j
op_assign
id|sglist
(braket
id|i
)braket
dot
id|dvma_length
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|j
)paren
r_break
suffix:semicolon
id|bus_addr
op_assign
id|sglist
(braket
id|i
)braket
dot
id|dvma_address
suffix:semicolon
id|npages
op_assign
id|PAGE_ALIGN
c_func
(paren
id|bus_addr
op_plus
id|j
)paren
op_minus
(paren
id|bus_addr
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
id|npages
op_rshift_assign
id|PAGE_SHIFT
suffix:semicolon
id|bus_addr
op_and_assign
id|PAGE_MASK
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|npages
suffix:semicolon
id|i
op_increment
comma
id|bus_addr
op_add_assign
id|PAGE_SIZE
)paren
(brace
id|pci_iommu_write
c_func
(paren
id|strbuf-&gt;strbuf_pflush
comma
id|bus_addr
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Step 3: Perform flush synchronization sequence. */
id|pci_iommu_write
c_func
(paren
id|strbuf-&gt;strbuf_fsync
comma
id|strbuf-&gt;strbuf_flushflag_pa
)paren
suffix:semicolon
(paren
r_void
)paren
id|pci_iommu_read
c_func
(paren
id|iommu-&gt;write_complete_reg
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|PCI_STC_FLUSHFLAG_SET
c_func
(paren
id|strbuf
)paren
)paren
id|membar
c_func
(paren
l_string|&quot;#LoadLoad&quot;
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
eof
