multiline_comment|/* $Id: pci_iommu.c,v 1.11 2000/03/10 02:42:15 davem Exp $&n; * pci_iommu.c: UltraSparc PCI controller IOM/STC support.&n; *&n; * Copyright (C) 1999 David S. Miller (davem@redhat.com)&n; * Copyright (C) 1999, 2000 Jakub Jelinek (jakub@redhat.com)&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/pbm.h&gt;
macro_line|#include &quot;iommu_common.h&quot;
DECL|macro|PCI_STC_CTXMATCH_ADDR
mdefine_line|#define PCI_STC_CTXMATCH_ADDR(STC, CTX)&t;&bslash;&n;&t;((STC)-&gt;strbuf_ctxmatch_base + ((CTX) &lt;&lt; 3))
multiline_comment|/* Accessing IOMMU and Streaming Buffer registers.&n; * REG parameter is a physical address.  All registers&n; * are 64-bits in size.&n; */
DECL|macro|pci_iommu_read
mdefine_line|#define pci_iommu_read(__reg) &bslash;&n;({&t;u64 __ret; &bslash;&n;&t;__asm__ __volatile__(&quot;ldxa [%1] %2, %0&quot; &bslash;&n;&t;&t;&t;     : &quot;=r&quot; (__ret) &bslash;&n;&t;&t;&t;     : &quot;r&quot; (__reg), &quot;i&quot; (ASI_PHYS_BYPASS_EC_E) &bslash;&n;&t;&t;&t;     : &quot;memory&quot;); &bslash;&n;&t;__ret; &bslash;&n;})
DECL|macro|pci_iommu_write
mdefine_line|#define pci_iommu_write(__reg, __val) &bslash;&n;&t;__asm__ __volatile__(&quot;stxa %0, [%1] %2&quot; &bslash;&n;&t;&t;&t;     : /* no outputs */ &bslash;&n;&t;&t;&t;     : &quot;r&quot; (__val), &quot;r&quot; (__reg), &bslash;&n;&t;&t;&t;       &quot;i&quot; (ASI_PHYS_BYPASS_EC_E))
multiline_comment|/* Must be invoked under the IOMMU lock. */
DECL|function|__iommu_flushall
r_static
r_void
id|__iommu_flushall
c_func
(paren
r_struct
id|pci_iommu
op_star
id|iommu
)paren
(brace
r_int
r_int
id|tag
suffix:semicolon
r_int
id|entry
suffix:semicolon
id|tag
op_assign
id|iommu-&gt;iommu_flush
op_plus
(paren
l_int|0xa580UL
op_minus
l_int|0x0210UL
)paren
suffix:semicolon
r_for
c_loop
(paren
id|entry
op_assign
l_int|0
suffix:semicolon
id|entry
OL
l_int|16
suffix:semicolon
id|entry
op_increment
)paren
(brace
id|pci_iommu_write
c_func
(paren
id|tag
comma
l_int|0
)paren
suffix:semicolon
id|tag
op_add_assign
l_int|8
suffix:semicolon
)brace
multiline_comment|/* Ensure completion of previous PIO writes. */
(paren
r_void
)paren
id|pci_iommu_read
c_func
(paren
id|iommu-&gt;write_complete_reg
)paren
suffix:semicolon
multiline_comment|/* Now update everyone&squot;s flush point. */
r_for
c_loop
(paren
id|entry
op_assign
l_int|0
suffix:semicolon
id|entry
OL
id|PBM_NCLUSTERS
suffix:semicolon
id|entry
op_increment
)paren
(brace
id|iommu-&gt;alloc_info
(braket
id|entry
)braket
dot
id|flush
op_assign
id|iommu-&gt;alloc_info
(braket
id|entry
)braket
dot
id|next
suffix:semicolon
)brace
)brace
DECL|function|alloc_streaming_cluster
r_static
id|iopte_t
op_star
id|alloc_streaming_cluster
c_func
(paren
r_struct
id|pci_iommu
op_star
id|iommu
comma
r_int
r_int
id|npages
)paren
(brace
id|iopte_t
op_star
id|iopte
comma
op_star
id|limit
suffix:semicolon
r_int
r_int
id|cnum
comma
id|ent
comma
id|flush_point
suffix:semicolon
id|cnum
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
l_int|1UL
op_lshift
id|cnum
)paren
OL
id|npages
)paren
id|cnum
op_increment
suffix:semicolon
id|iopte
op_assign
(paren
id|iommu-&gt;page_table
op_plus
(paren
id|cnum
op_lshift
(paren
id|iommu-&gt;page_table_sz_bits
op_minus
id|PBM_LOGCLUSTERS
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnum
op_eq
l_int|0
)paren
id|limit
op_assign
(paren
id|iommu-&gt;page_table
op_plus
id|iommu-&gt;lowest_consistent_map
)paren
suffix:semicolon
r_else
id|limit
op_assign
(paren
id|iopte
op_plus
(paren
l_int|1
op_lshift
(paren
id|iommu-&gt;page_table_sz_bits
op_minus
id|PBM_LOGCLUSTERS
)paren
)paren
)paren
suffix:semicolon
id|iopte
op_add_assign
(paren
(paren
id|ent
op_assign
id|iommu-&gt;alloc_info
(braket
id|cnum
)braket
dot
id|next
)paren
op_lshift
id|cnum
)paren
suffix:semicolon
id|flush_point
op_assign
id|iommu-&gt;alloc_info
(braket
id|cnum
)braket
dot
id|flush
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|iopte_val
c_func
(paren
op_star
id|iopte
)paren
op_eq
l_int|0UL
)paren
(brace
r_if
c_cond
(paren
(paren
id|iopte
op_plus
(paren
l_int|1
op_lshift
id|cnum
)paren
)paren
op_ge
id|limit
)paren
id|ent
op_assign
l_int|0
suffix:semicolon
r_else
id|ent
op_assign
id|ent
op_plus
l_int|1
suffix:semicolon
id|iommu-&gt;alloc_info
(braket
id|cnum
)braket
dot
id|next
op_assign
id|ent
suffix:semicolon
r_if
c_cond
(paren
id|ent
op_eq
id|flush_point
)paren
id|__iommu_flushall
c_func
(paren
id|iommu
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|iopte
op_add_assign
(paren
l_int|1
op_lshift
id|cnum
)paren
suffix:semicolon
id|ent
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|iopte
op_ge
id|limit
)paren
(brace
id|iopte
op_assign
(paren
id|iommu-&gt;page_table
op_plus
(paren
id|cnum
op_lshift
(paren
id|iommu-&gt;page_table_sz_bits
op_minus
id|PBM_LOGCLUSTERS
)paren
)paren
)paren
suffix:semicolon
id|ent
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ent
op_eq
id|flush_point
)paren
id|__iommu_flushall
c_func
(paren
id|iommu
)paren
suffix:semicolon
)brace
multiline_comment|/* I&squot;ve got your streaming cluster right here buddy boy... */
r_return
id|iopte
suffix:semicolon
)brace
DECL|function|free_streaming_cluster
r_static
r_void
id|free_streaming_cluster
c_func
(paren
r_struct
id|pci_iommu
op_star
id|iommu
comma
id|dma_addr_t
id|base
comma
r_int
r_int
id|npages
comma
r_int
r_int
id|ctx
)paren
(brace
r_int
r_int
id|cnum
comma
id|ent
suffix:semicolon
id|cnum
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
l_int|1UL
op_lshift
id|cnum
)paren
OL
id|npages
)paren
id|cnum
op_increment
suffix:semicolon
id|ent
op_assign
(paren
id|base
op_lshift
(paren
l_int|32
op_minus
id|PAGE_SHIFT
op_plus
id|PBM_LOGCLUSTERS
op_minus
id|iommu-&gt;page_table_sz_bits
)paren
)paren
op_rshift
(paren
l_int|32
op_plus
id|PBM_LOGCLUSTERS
op_plus
id|cnum
op_minus
id|iommu-&gt;page_table_sz_bits
)paren
suffix:semicolon
multiline_comment|/* If the global flush might not have caught this entry,&n;&t; * adjust the flush point such that we will flush before&n;&t; * ever trying to reuse it.&n;&t; */
DECL|macro|between
mdefine_line|#define between(X,Y,Z)&t;(((Z) - (Y)) &gt;= ((X) - (Y)))
r_if
c_cond
(paren
id|between
c_func
(paren
id|ent
comma
id|iommu-&gt;alloc_info
(braket
id|cnum
)braket
dot
id|next
comma
id|iommu-&gt;alloc_info
(braket
id|cnum
)braket
dot
id|flush
)paren
)paren
id|iommu-&gt;alloc_info
(braket
id|cnum
)braket
dot
id|flush
op_assign
id|ent
suffix:semicolon
DECL|macro|between
macro_line|#undef between
)brace
multiline_comment|/* We allocate consistent mappings from the end of cluster zero. */
DECL|function|alloc_consistent_cluster
r_static
id|iopte_t
op_star
id|alloc_consistent_cluster
c_func
(paren
r_struct
id|pci_iommu
op_star
id|iommu
comma
r_int
r_int
id|npages
)paren
(brace
id|iopte_t
op_star
id|iopte
suffix:semicolon
id|iopte
op_assign
id|iommu-&gt;page_table
op_plus
(paren
l_int|1
op_lshift
(paren
id|iommu-&gt;page_table_sz_bits
op_minus
id|PBM_LOGCLUSTERS
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|iopte
OG
id|iommu-&gt;page_table
)paren
(brace
id|iopte
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|iopte_val
c_func
(paren
op_star
id|iopte
)paren
op_amp
id|IOPTE_VALID
)paren
)paren
(brace
r_int
r_int
id|tmp
op_assign
id|npages
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|tmp
)paren
(brace
id|iopte
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|iopte_val
c_func
(paren
op_star
id|iopte
)paren
op_amp
id|IOPTE_VALID
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tmp
op_eq
l_int|0
)paren
(brace
id|u32
id|entry
op_assign
(paren
id|iopte
op_minus
id|iommu-&gt;page_table
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry
OL
id|iommu-&gt;lowest_consistent_map
)paren
id|iommu-&gt;lowest_consistent_map
op_assign
id|entry
suffix:semicolon
r_return
id|iopte
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|macro|IOPTE_CONSISTENT
mdefine_line|#define IOPTE_CONSISTENT(CTX) &bslash;&n;&t;(IOPTE_VALID | IOPTE_CACHE | &bslash;&n;&t; (((CTX) &lt;&lt; 47) &amp; IOPTE_CONTEXT))
DECL|macro|IOPTE_STREAMING
mdefine_line|#define IOPTE_STREAMING(CTX) &bslash;&n;&t;(IOPTE_CONSISTENT(CTX) | IOPTE_STBUF)
DECL|macro|IOPTE_INVALID
mdefine_line|#define IOPTE_INVALID&t;0UL
multiline_comment|/* Allocate and map kernel buffer of size SIZE using consistent mode&n; * DMA for PCI device PDEV.  Return non-NULL cpu-side address if&n; * successful and set *DMA_ADDRP to the PCI side dma address.&n; */
DECL|function|pci_alloc_consistent
r_void
op_star
id|pci_alloc_consistent
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
id|size
comma
id|dma_addr_t
op_star
id|dma_addrp
)paren
(brace
r_struct
id|pcidev_cookie
op_star
id|pcp
suffix:semicolon
r_struct
id|pci_iommu
op_star
id|iommu
suffix:semicolon
id|iopte_t
op_star
id|iopte
suffix:semicolon
r_int
r_int
id|flags
comma
id|order
comma
id|first_page
comma
id|ctx
suffix:semicolon
r_void
op_star
id|ret
suffix:semicolon
r_int
id|npages
suffix:semicolon
id|size
op_assign
id|PAGE_ALIGN
c_func
(paren
id|size
)paren
suffix:semicolon
id|order
op_assign
id|get_order
c_func
(paren
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|order
op_ge
l_int|10
)paren
r_return
l_int|NULL
suffix:semicolon
id|first_page
op_assign
id|__get_free_pages
c_func
(paren
id|GFP_ATOMIC
comma
id|order
)paren
suffix:semicolon
r_if
c_cond
(paren
id|first_page
op_eq
l_int|0UL
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|first_page
comma
l_int|0
comma
id|PAGE_SIZE
op_lshift
id|order
)paren
suffix:semicolon
id|pcp
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
id|iommu
op_assign
op_amp
id|pcp-&gt;pbm-&gt;parent-&gt;iommu
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|iopte
op_assign
id|alloc_consistent_cluster
c_func
(paren
id|iommu
comma
id|size
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iopte
op_eq
l_int|NULL
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|free_pages
c_func
(paren
id|first_page
comma
id|order
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
op_star
id|dma_addrp
op_assign
(paren
id|iommu-&gt;page_table_map_base
op_plus
(paren
(paren
id|iopte
op_minus
id|iommu-&gt;page_table
)paren
op_lshift
id|PAGE_SHIFT
)paren
)paren
suffix:semicolon
id|ret
op_assign
(paren
r_void
op_star
)paren
id|first_page
suffix:semicolon
id|npages
op_assign
id|size
op_rshift
id|PAGE_SHIFT
suffix:semicolon
id|ctx
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|iommu-&gt;iommu_ctxflush
)paren
id|ctx
op_assign
id|iommu-&gt;iommu_cur_ctx
op_increment
suffix:semicolon
id|first_page
op_assign
id|__pa
c_func
(paren
id|first_page
)paren
suffix:semicolon
r_while
c_loop
(paren
id|npages
op_decrement
)paren
(brace
id|iopte_val
c_func
(paren
op_star
id|iopte
)paren
op_assign
(paren
id|IOPTE_CONSISTENT
c_func
(paren
id|ctx
)paren
op_or
id|IOPTE_WRITE
op_or
(paren
id|first_page
op_amp
id|IOPTE_PAGE
)paren
)paren
suffix:semicolon
id|iopte
op_increment
suffix:semicolon
id|first_page
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|iommu-&gt;iommu_ctxflush
)paren
(brace
id|pci_iommu_write
c_func
(paren
id|iommu-&gt;iommu_ctxflush
comma
id|ctx
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
id|i
suffix:semicolon
id|u32
id|daddr
op_assign
op_star
id|dma_addrp
suffix:semicolon
id|npages
op_assign
id|size
op_rshift
id|PAGE_SHIFT
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|npages
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pci_iommu_write
c_func
(paren
id|iommu-&gt;iommu_flush
comma
id|daddr
)paren
suffix:semicolon
id|daddr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Free and unmap a consistent DMA translation. */
DECL|function|pci_free_consistent
r_void
id|pci_free_consistent
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
id|size
comma
r_void
op_star
id|cpu
comma
id|dma_addr_t
id|dvma
)paren
(brace
r_struct
id|pcidev_cookie
op_star
id|pcp
suffix:semicolon
r_struct
id|pci_iommu
op_star
id|iommu
suffix:semicolon
id|iopte_t
op_star
id|iopte
suffix:semicolon
r_int
r_int
id|flags
comma
id|order
comma
id|npages
comma
id|i
comma
id|ctx
suffix:semicolon
id|npages
op_assign
id|PAGE_ALIGN
c_func
(paren
id|size
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
id|pcp
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
id|iommu
op_assign
op_amp
id|pcp-&gt;pbm-&gt;parent-&gt;iommu
suffix:semicolon
id|iopte
op_assign
id|iommu-&gt;page_table
op_plus
(paren
(paren
id|dvma
op_minus
id|iommu-&gt;page_table_map_base
)paren
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|iopte
op_minus
id|iommu-&gt;page_table
)paren
op_eq
id|iommu-&gt;lowest_consistent_map
)paren
(brace
id|iopte_t
op_star
id|walk
op_assign
id|iopte
op_plus
id|npages
suffix:semicolon
id|iopte_t
op_star
id|limit
suffix:semicolon
id|limit
op_assign
(paren
id|iommu-&gt;page_table
op_plus
(paren
l_int|1
op_lshift
(paren
id|iommu-&gt;page_table_sz_bits
op_minus
id|PBM_LOGCLUSTERS
)paren
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|walk
OL
id|limit
)paren
(brace
r_if
c_cond
(paren
id|iopte_val
c_func
(paren
op_star
id|walk
)paren
op_ne
id|IOPTE_INVALID
)paren
r_break
suffix:semicolon
id|walk
op_increment
suffix:semicolon
)brace
id|iommu-&gt;lowest_consistent_map
op_assign
(paren
id|walk
op_minus
id|iommu-&gt;page_table
)paren
suffix:semicolon
)brace
multiline_comment|/* Data for consistent mappings cannot enter the streaming&n;&t; * buffers, so we only need to update the TSB.  We flush&n;&t; * the IOMMU here as well to prevent conflicts with the&n;&t; * streaming mapping deferred tlb flush scheme.&n;&t; */
id|ctx
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|iommu-&gt;iommu_ctxflush
)paren
id|ctx
op_assign
(paren
id|iopte_val
c_func
(paren
op_star
id|iopte
)paren
op_amp
id|IOPTE_CONTEXT
)paren
op_rshift
l_int|47UL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|npages
suffix:semicolon
id|i
op_increment
comma
id|iopte
op_increment
)paren
id|iopte_val
c_func
(paren
op_star
id|iopte
)paren
op_assign
id|IOPTE_INVALID
suffix:semicolon
r_if
c_cond
(paren
id|iommu-&gt;iommu_ctxflush
)paren
(brace
id|pci_iommu_write
c_func
(paren
id|iommu-&gt;iommu_ctxflush
comma
id|ctx
)paren
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|npages
suffix:semicolon
id|i
op_increment
)paren
(brace
id|u32
id|daddr
op_assign
id|dvma
op_plus
(paren
id|i
op_lshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|pci_iommu_write
c_func
(paren
id|iommu-&gt;iommu_flush
comma
id|daddr
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|order
op_assign
id|get_order
c_func
(paren
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|order
OL
l_int|10
)paren
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|cpu
comma
id|order
)paren
suffix:semicolon
)brace
multiline_comment|/* Map a single buffer at PTR of SZ bytes for PCI DMA&n; * in streaming mode.&n; */
DECL|function|pci_map_single
id|dma_addr_t
id|pci_map_single
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_void
op_star
id|ptr
comma
r_int
id|sz
comma
r_int
id|direction
)paren
(brace
r_struct
id|pcidev_cookie
op_star
id|pcp
suffix:semicolon
r_struct
id|pci_iommu
op_star
id|iommu
suffix:semicolon
r_struct
id|pci_strbuf
op_star
id|strbuf
suffix:semicolon
id|iopte_t
op_star
id|base
suffix:semicolon
r_int
r_int
id|flags
comma
id|npages
comma
id|oaddr
suffix:semicolon
r_int
r_int
id|i
comma
id|base_paddr
comma
id|ctx
suffix:semicolon
id|u32
id|bus_addr
comma
id|ret
suffix:semicolon
r_int
r_int
id|iopte_protection
suffix:semicolon
id|pcp
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
id|iommu
op_assign
op_amp
id|pcp-&gt;pbm-&gt;parent-&gt;iommu
suffix:semicolon
id|strbuf
op_assign
op_amp
id|pcp-&gt;pbm-&gt;stc
suffix:semicolon
r_if
c_cond
(paren
id|direction
op_eq
id|PCI_DMA_NONE
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|oaddr
op_assign
(paren
r_int
r_int
)paren
id|ptr
suffix:semicolon
id|npages
op_assign
id|PAGE_ALIGN
c_func
(paren
id|oaddr
op_plus
id|sz
)paren
op_minus
(paren
id|oaddr
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
id|npages
op_rshift_assign
id|PAGE_SHIFT
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|base
op_assign
id|alloc_streaming_cluster
c_func
(paren
id|iommu
comma
id|npages
)paren
suffix:semicolon
id|bus_addr
op_assign
(paren
id|iommu-&gt;page_table_map_base
op_plus
(paren
(paren
id|base
op_minus
id|iommu-&gt;page_table
)paren
op_lshift
id|PAGE_SHIFT
)paren
)paren
suffix:semicolon
id|ret
op_assign
id|bus_addr
op_or
(paren
id|oaddr
op_amp
op_complement
id|PAGE_MASK
)paren
suffix:semicolon
id|base_paddr
op_assign
id|__pa
c_func
(paren
id|oaddr
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
id|ctx
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|iommu-&gt;iommu_ctxflush
)paren
id|ctx
op_assign
id|iommu-&gt;iommu_cur_ctx
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|strbuf-&gt;strbuf_enabled
)paren
id|iopte_protection
op_assign
id|IOPTE_STREAMING
c_func
(paren
id|ctx
)paren
suffix:semicolon
r_else
id|iopte_protection
op_assign
id|IOPTE_CONSISTENT
c_func
(paren
id|ctx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|direction
op_ne
id|PCI_DMA_TODEVICE
)paren
id|iopte_protection
op_or_assign
id|IOPTE_WRITE
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|npages
suffix:semicolon
id|i
op_increment
comma
id|base
op_increment
comma
id|base_paddr
op_add_assign
id|PAGE_SIZE
)paren
id|iopte_val
c_func
(paren
op_star
id|base
)paren
op_assign
id|iopte_protection
op_or
id|base_paddr
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Unmap a single streaming mode DMA translation. */
DECL|function|pci_unmap_single
r_void
id|pci_unmap_single
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|dma_addr_t
id|bus_addr
comma
r_int
id|sz
comma
r_int
id|direction
)paren
(brace
r_struct
id|pcidev_cookie
op_star
id|pcp
suffix:semicolon
r_struct
id|pci_iommu
op_star
id|iommu
suffix:semicolon
r_struct
id|pci_strbuf
op_star
id|strbuf
suffix:semicolon
id|iopte_t
op_star
id|base
suffix:semicolon
r_int
r_int
id|flags
comma
id|npages
comma
id|i
comma
id|ctx
suffix:semicolon
r_if
c_cond
(paren
id|direction
op_eq
id|PCI_DMA_NONE
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|pcp
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
id|iommu
op_assign
op_amp
id|pcp-&gt;pbm-&gt;parent-&gt;iommu
suffix:semicolon
id|strbuf
op_assign
op_amp
id|pcp-&gt;pbm-&gt;stc
suffix:semicolon
id|npages
op_assign
id|PAGE_ALIGN
c_func
(paren
id|bus_addr
op_plus
id|sz
)paren
op_minus
(paren
id|bus_addr
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
id|npages
op_rshift_assign
id|PAGE_SHIFT
suffix:semicolon
id|base
op_assign
id|iommu-&gt;page_table
op_plus
(paren
(paren
id|bus_addr
op_minus
id|iommu-&gt;page_table_map_base
)paren
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_PCI_IOMMU
r_if
c_cond
(paren
id|iopte_val
c_func
(paren
op_star
id|base
)paren
op_eq
id|IOPTE_INVALID
)paren
id|printk
c_func
(paren
l_string|&quot;pci_unmap_single called on non-mapped region %08x,%08x from %016lx&bslash;n&quot;
comma
id|bus_addr
comma
id|sz
comma
id|__builtin_return_address
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
macro_line|#endif
id|bus_addr
op_and_assign
id|PAGE_MASK
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Record the context, if any. */
id|ctx
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|iommu-&gt;iommu_ctxflush
)paren
id|ctx
op_assign
(paren
id|iopte_val
c_func
(paren
op_star
id|base
)paren
op_amp
id|IOPTE_CONTEXT
)paren
op_rshift
l_int|47UL
suffix:semicolon
multiline_comment|/* Step 1: Kick data out of streaming buffers if necessary. */
r_if
c_cond
(paren
id|strbuf-&gt;strbuf_enabled
)paren
(brace
id|u32
id|vaddr
op_assign
id|bus_addr
suffix:semicolon
id|PCI_STC_FLUSHFLAG_INIT
c_func
(paren
id|strbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strbuf-&gt;strbuf_ctxflush
op_logical_and
id|iommu-&gt;iommu_ctxflush
)paren
(brace
r_int
r_int
id|matchreg
comma
id|flushreg
suffix:semicolon
id|flushreg
op_assign
id|strbuf-&gt;strbuf_ctxflush
suffix:semicolon
id|matchreg
op_assign
id|PCI_STC_CTXMATCH_ADDR
c_func
(paren
id|strbuf
comma
id|ctx
)paren
suffix:semicolon
r_do
(brace
id|pci_iommu_write
c_func
(paren
id|flushreg
comma
id|ctx
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
(paren
r_int
)paren
id|pci_iommu_read
c_func
(paren
id|matchreg
)paren
)paren
OL
l_int|0L
)paren
(brace
suffix:semicolon
)brace
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|npages
suffix:semicolon
id|i
op_increment
comma
id|vaddr
op_add_assign
id|PAGE_SIZE
)paren
id|pci_iommu_write
c_func
(paren
id|strbuf-&gt;strbuf_pflush
comma
id|vaddr
)paren
suffix:semicolon
)brace
id|pci_iommu_write
c_func
(paren
id|strbuf-&gt;strbuf_fsync
comma
id|strbuf-&gt;strbuf_flushflag_pa
)paren
suffix:semicolon
(paren
r_void
)paren
id|pci_iommu_read
c_func
(paren
id|iommu-&gt;write_complete_reg
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|PCI_STC_FLUSHFLAG_SET
c_func
(paren
id|strbuf
)paren
)paren
id|membar
c_func
(paren
l_string|&quot;#LoadLoad&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Step 2: Clear out first TSB entry. */
id|iopte_val
c_func
(paren
op_star
id|base
)paren
op_assign
id|IOPTE_INVALID
suffix:semicolon
id|free_streaming_cluster
c_func
(paren
id|iommu
comma
id|bus_addr
op_minus
id|iommu-&gt;page_table_map_base
comma
id|npages
comma
id|ctx
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|fill_sg
r_static
r_inline
r_void
id|fill_sg
c_func
(paren
id|iopte_t
op_star
id|iopte
comma
r_struct
id|scatterlist
op_star
id|sg
comma
r_int
id|nused
comma
r_int
r_int
id|iopte_protection
)paren
(brace
r_struct
id|scatterlist
op_star
id|dma_sg
op_assign
id|sg
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nused
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|pteval
op_assign
op_complement
l_int|0UL
suffix:semicolon
id|u32
id|dma_npages
suffix:semicolon
id|dma_npages
op_assign
(paren
(paren
id|dma_sg-&gt;dvma_address
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1UL
)paren
)paren
op_plus
id|dma_sg-&gt;dvma_length
op_plus
(paren
(paren
id|u32
)paren
(paren
id|PAGE_SIZE
op_minus
l_int|1UL
)paren
)paren
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
r_do
(brace
r_int
r_int
id|offset
suffix:semicolon
r_int
r_int
id|len
suffix:semicolon
multiline_comment|/* If we are here, we know we have at least one&n;&t;&t;&t; * more page to map.  So walk forward until we&n;&t;&t;&t; * hit a page crossing, and begin creating new&n;&t;&t;&t; * mappings from that spot.&n;&t;&t;&t; */
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_int
r_int
id|tmp
suffix:semicolon
id|tmp
op_assign
(paren
r_int
r_int
)paren
id|__pa
c_func
(paren
id|sg-&gt;address
)paren
suffix:semicolon
id|len
op_assign
id|sg-&gt;length
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|tmp
op_xor
id|pteval
)paren
op_rshift
id|PAGE_SHIFT
)paren
op_ne
l_int|0UL
)paren
(brace
id|pteval
op_assign
id|tmp
op_amp
id|PAGE_MASK
suffix:semicolon
id|offset
op_assign
id|tmp
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1UL
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|tmp
op_xor
(paren
id|tmp
op_plus
id|len
op_minus
l_int|1UL
)paren
)paren
op_rshift
id|PAGE_SHIFT
)paren
op_ne
l_int|0UL
)paren
(brace
id|pteval
op_assign
(paren
id|tmp
op_plus
id|PAGE_SIZE
)paren
op_amp
id|PAGE_MASK
suffix:semicolon
id|offset
op_assign
l_int|0UL
suffix:semicolon
id|len
op_sub_assign
(paren
id|PAGE_SIZE
op_minus
(paren
id|tmp
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1UL
)paren
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|sg
op_increment
suffix:semicolon
)brace
id|pteval
op_assign
id|iopte_protection
op_or
(paren
id|pteval
op_amp
id|IOPTE_PAGE
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
OG
l_int|0
)paren
(brace
op_star
id|iopte
op_increment
op_assign
id|__iopte
c_func
(paren
id|pteval
)paren
suffix:semicolon
id|pteval
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|len
op_sub_assign
(paren
id|PAGE_SIZE
op_minus
id|offset
)paren
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
id|dma_npages
op_decrement
suffix:semicolon
)brace
id|pteval
op_assign
(paren
id|pteval
op_amp
id|IOPTE_PAGE
)paren
op_plus
id|len
suffix:semicolon
id|sg
op_increment
suffix:semicolon
multiline_comment|/* Skip over any tail mappings we&squot;ve fully mapped,&n;&t;&t;&t; * adjusting pteval along the way.  Stop when we&n;&t;&t;&t; * detect a page crossing event.&n;&t;&t;&t; */
r_while
c_loop
(paren
(paren
id|pteval
op_lshift
(paren
l_int|64
op_minus
id|PAGE_SHIFT
)paren
)paren
op_ne
l_int|0UL
op_logical_and
id|pteval
op_eq
id|__pa
c_func
(paren
id|sg-&gt;address
)paren
op_logical_and
(paren
(paren
id|pteval
op_xor
(paren
id|__pa
c_func
(paren
id|sg-&gt;address
)paren
op_plus
id|sg-&gt;length
op_minus
l_int|1UL
)paren
)paren
op_rshift
id|PAGE_SHIFT
)paren
op_eq
l_int|0UL
)paren
(brace
id|pteval
op_add_assign
id|sg-&gt;length
suffix:semicolon
id|sg
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pteval
op_lshift
(paren
l_int|64
op_minus
id|PAGE_SHIFT
)paren
)paren
op_eq
l_int|0UL
)paren
id|pteval
op_assign
op_complement
l_int|0UL
suffix:semicolon
)brace
r_while
c_loop
(paren
id|dma_npages
op_ne
l_int|0
)paren
suffix:semicolon
id|dma_sg
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* Map a set of buffers described by SGLIST with NELEMS array&n; * elements in streaming mode for PCI DMA.&n; * When making changes here, inspect the assembly output. I was having&n; * hard time to kepp this routine out of using stack slots for holding variables.&n; */
DECL|function|pci_map_sg
r_int
id|pci_map_sg
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_struct
id|scatterlist
op_star
id|sglist
comma
r_int
id|nelems
comma
r_int
id|direction
)paren
(brace
r_struct
id|pcidev_cookie
op_star
id|pcp
suffix:semicolon
r_struct
id|pci_iommu
op_star
id|iommu
suffix:semicolon
r_struct
id|pci_strbuf
op_star
id|strbuf
suffix:semicolon
r_int
r_int
id|flags
comma
id|ctx
comma
id|npages
comma
id|iopte_protection
suffix:semicolon
id|iopte_t
op_star
id|base
suffix:semicolon
id|u32
id|dma_base
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sgtmp
suffix:semicolon
r_int
id|used
suffix:semicolon
multiline_comment|/* Fast path single entry scatterlists. */
r_if
c_cond
(paren
id|nelems
op_eq
l_int|1
)paren
(brace
id|sglist-&gt;dvma_address
op_assign
id|pci_map_single
c_func
(paren
id|pdev
comma
id|sglist-&gt;address
comma
id|sglist-&gt;length
comma
id|direction
)paren
suffix:semicolon
id|sglist-&gt;dvma_length
op_assign
id|sglist-&gt;length
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|pcp
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
id|iommu
op_assign
op_amp
id|pcp-&gt;pbm-&gt;parent-&gt;iommu
suffix:semicolon
id|strbuf
op_assign
op_amp
id|pcp-&gt;pbm-&gt;stc
suffix:semicolon
r_if
c_cond
(paren
id|direction
op_eq
id|PCI_DMA_NONE
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Step 1: Prepare scatter list. */
id|npages
op_assign
id|prepare_sg
c_func
(paren
id|sglist
comma
id|nelems
)paren
suffix:semicolon
multiline_comment|/* Step 2: Allocate a cluster. */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|base
op_assign
id|alloc_streaming_cluster
c_func
(paren
id|iommu
comma
id|npages
)paren
suffix:semicolon
id|dma_base
op_assign
id|iommu-&gt;page_table_map_base
op_plus
(paren
(paren
id|base
op_minus
id|iommu-&gt;page_table
)paren
op_lshift
id|PAGE_SHIFT
)paren
suffix:semicolon
multiline_comment|/* Step 3: Normalize DMA addresses. */
id|used
op_assign
id|nelems
suffix:semicolon
id|sgtmp
op_assign
id|sglist
suffix:semicolon
r_while
c_loop
(paren
id|used
op_logical_and
id|sgtmp-&gt;dvma_length
)paren
(brace
id|sgtmp-&gt;dvma_address
op_add_assign
id|dma_base
suffix:semicolon
id|sgtmp
op_increment
suffix:semicolon
id|used
op_decrement
suffix:semicolon
)brace
id|used
op_assign
id|nelems
op_minus
id|used
suffix:semicolon
multiline_comment|/* Step 4: Choose a context if necessary. */
id|ctx
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|iommu-&gt;iommu_ctxflush
)paren
id|ctx
op_assign
id|iommu-&gt;iommu_cur_ctx
op_increment
suffix:semicolon
multiline_comment|/* Step 5: Create the mappings. */
r_if
c_cond
(paren
id|strbuf-&gt;strbuf_enabled
)paren
id|iopte_protection
op_assign
id|IOPTE_STREAMING
c_func
(paren
id|ctx
)paren
suffix:semicolon
r_else
id|iopte_protection
op_assign
id|IOPTE_CONSISTENT
c_func
(paren
id|ctx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|direction
op_ne
id|PCI_DMA_TODEVICE
)paren
id|iopte_protection
op_or_assign
id|IOPTE_WRITE
suffix:semicolon
id|fill_sg
(paren
id|base
comma
id|sglist
comma
id|used
comma
id|iopte_protection
)paren
suffix:semicolon
macro_line|#ifdef VERIFY_SG
id|verify_sglist
c_func
(paren
id|sglist
comma
id|nelems
comma
id|base
comma
id|npages
)paren
suffix:semicolon
macro_line|#endif
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|used
suffix:semicolon
)brace
multiline_comment|/* Unmap a set of streaming mode DMA translations. */
DECL|function|pci_unmap_sg
r_void
id|pci_unmap_sg
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_struct
id|scatterlist
op_star
id|sglist
comma
r_int
id|nelems
comma
r_int
id|direction
)paren
(brace
r_struct
id|pcidev_cookie
op_star
id|pcp
suffix:semicolon
r_struct
id|pci_iommu
op_star
id|iommu
suffix:semicolon
r_struct
id|pci_strbuf
op_star
id|strbuf
suffix:semicolon
id|iopte_t
op_star
id|base
suffix:semicolon
r_int
r_int
id|flags
comma
id|ctx
comma
id|i
comma
id|npages
suffix:semicolon
id|u32
id|bus_addr
suffix:semicolon
r_if
c_cond
(paren
id|direction
op_eq
id|PCI_DMA_NONE
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|pcp
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
id|iommu
op_assign
op_amp
id|pcp-&gt;pbm-&gt;parent-&gt;iommu
suffix:semicolon
id|strbuf
op_assign
op_amp
id|pcp-&gt;pbm-&gt;stc
suffix:semicolon
id|bus_addr
op_assign
id|sglist-&gt;dvma_address
op_amp
id|PAGE_MASK
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|nelems
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|sglist
(braket
id|i
)braket
dot
id|dvma_length
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|i
op_decrement
suffix:semicolon
id|npages
op_assign
(paren
id|PAGE_ALIGN
c_func
(paren
id|sglist
(braket
id|i
)braket
dot
id|dvma_address
op_plus
id|sglist
(braket
id|i
)braket
dot
id|dvma_length
)paren
op_minus
id|bus_addr
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
id|base
op_assign
id|iommu-&gt;page_table
op_plus
(paren
(paren
id|bus_addr
op_minus
id|iommu-&gt;page_table_map_base
)paren
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_PCI_IOMMU
r_if
c_cond
(paren
id|iopte_val
c_func
(paren
op_star
id|base
)paren
op_eq
id|IOPTE_INVALID
)paren
id|printk
c_func
(paren
l_string|&quot;pci_unmap_sg called on non-mapped region %08x,%d from %016lx&bslash;n&quot;
comma
id|sglist-&gt;dvma_address
comma
id|nelems
comma
id|__builtin_return_address
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
macro_line|#endif
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Record the context, if any. */
id|ctx
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|iommu-&gt;iommu_ctxflush
)paren
id|ctx
op_assign
(paren
id|iopte_val
c_func
(paren
op_star
id|base
)paren
op_amp
id|IOPTE_CONTEXT
)paren
op_rshift
l_int|47UL
suffix:semicolon
multiline_comment|/* Step 1: Kick data out of streaming buffers if necessary. */
r_if
c_cond
(paren
id|strbuf-&gt;strbuf_enabled
)paren
(brace
id|u32
id|vaddr
op_assign
id|bus_addr
suffix:semicolon
id|PCI_STC_FLUSHFLAG_INIT
c_func
(paren
id|strbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strbuf-&gt;strbuf_ctxflush
op_logical_and
id|iommu-&gt;iommu_ctxflush
)paren
(brace
r_int
r_int
id|matchreg
comma
id|flushreg
suffix:semicolon
id|flushreg
op_assign
id|strbuf-&gt;strbuf_ctxflush
suffix:semicolon
id|matchreg
op_assign
id|PCI_STC_CTXMATCH_ADDR
c_func
(paren
id|strbuf
comma
id|ctx
)paren
suffix:semicolon
r_do
(brace
id|pci_iommu_write
c_func
(paren
id|flushreg
comma
id|ctx
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
(paren
r_int
)paren
id|pci_iommu_read
c_func
(paren
id|matchreg
)paren
)paren
OL
l_int|0L
)paren
(brace
suffix:semicolon
)brace
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|npages
suffix:semicolon
id|i
op_increment
comma
id|vaddr
op_add_assign
id|PAGE_SIZE
)paren
id|pci_iommu_write
c_func
(paren
id|strbuf-&gt;strbuf_pflush
comma
id|vaddr
)paren
suffix:semicolon
)brace
id|pci_iommu_write
c_func
(paren
id|strbuf-&gt;strbuf_fsync
comma
id|strbuf-&gt;strbuf_flushflag_pa
)paren
suffix:semicolon
(paren
r_void
)paren
id|pci_iommu_read
c_func
(paren
id|iommu-&gt;write_complete_reg
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|PCI_STC_FLUSHFLAG_SET
c_func
(paren
id|strbuf
)paren
)paren
id|membar
c_func
(paren
l_string|&quot;#LoadLoad&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Step 2: Clear out first TSB entry. */
id|iopte_val
c_func
(paren
op_star
id|base
)paren
op_assign
id|IOPTE_INVALID
suffix:semicolon
id|free_streaming_cluster
c_func
(paren
id|iommu
comma
id|bus_addr
op_minus
id|iommu-&gt;page_table_map_base
comma
id|npages
comma
id|ctx
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Make physical memory consistent for a single&n; * streaming mode DMA translation after a transfer.&n; */
DECL|function|pci_dma_sync_single
r_void
id|pci_dma_sync_single
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|dma_addr_t
id|bus_addr
comma
r_int
id|sz
comma
r_int
id|direction
)paren
(brace
r_struct
id|pcidev_cookie
op_star
id|pcp
suffix:semicolon
r_struct
id|pci_iommu
op_star
id|iommu
suffix:semicolon
r_struct
id|pci_strbuf
op_star
id|strbuf
suffix:semicolon
r_int
r_int
id|flags
comma
id|ctx
comma
id|npages
suffix:semicolon
id|pcp
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
id|iommu
op_assign
op_amp
id|pcp-&gt;pbm-&gt;parent-&gt;iommu
suffix:semicolon
id|strbuf
op_assign
op_amp
id|pcp-&gt;pbm-&gt;stc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strbuf-&gt;strbuf_enabled
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|npages
op_assign
id|PAGE_ALIGN
c_func
(paren
id|bus_addr
op_plus
id|sz
)paren
op_minus
(paren
id|bus_addr
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
id|npages
op_rshift_assign
id|PAGE_SHIFT
suffix:semicolon
id|bus_addr
op_and_assign
id|PAGE_MASK
suffix:semicolon
multiline_comment|/* Step 1: Record the context, if any. */
id|ctx
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|iommu-&gt;iommu_ctxflush
op_logical_and
id|strbuf-&gt;strbuf_ctxflush
)paren
(brace
id|iopte_t
op_star
id|iopte
suffix:semicolon
id|iopte
op_assign
id|iommu-&gt;page_table
op_plus
(paren
(paren
id|bus_addr
op_minus
id|iommu-&gt;page_table_map_base
)paren
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|ctx
op_assign
(paren
id|iopte_val
c_func
(paren
op_star
id|iopte
)paren
op_amp
id|IOPTE_CONTEXT
)paren
op_rshift
l_int|47UL
suffix:semicolon
)brace
multiline_comment|/* Step 2: Kick data out of streaming buffers. */
id|PCI_STC_FLUSHFLAG_INIT
c_func
(paren
id|strbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iommu-&gt;iommu_ctxflush
op_logical_and
id|strbuf-&gt;strbuf_ctxflush
)paren
(brace
r_int
r_int
id|matchreg
comma
id|flushreg
suffix:semicolon
id|flushreg
op_assign
id|strbuf-&gt;strbuf_ctxflush
suffix:semicolon
id|matchreg
op_assign
id|PCI_STC_CTXMATCH_ADDR
c_func
(paren
id|strbuf
comma
id|ctx
)paren
suffix:semicolon
r_do
(brace
id|pci_iommu_write
c_func
(paren
id|flushreg
comma
id|ctx
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
(paren
r_int
)paren
id|pci_iommu_read
c_func
(paren
id|matchreg
)paren
)paren
OL
l_int|0L
)paren
(brace
suffix:semicolon
)brace
)brace
r_else
(brace
r_int
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|npages
suffix:semicolon
id|i
op_increment
comma
id|bus_addr
op_add_assign
id|PAGE_SIZE
)paren
id|pci_iommu_write
c_func
(paren
id|strbuf-&gt;strbuf_pflush
comma
id|bus_addr
)paren
suffix:semicolon
)brace
multiline_comment|/* Step 3: Perform flush synchronization sequence. */
id|pci_iommu_write
c_func
(paren
id|strbuf-&gt;strbuf_fsync
comma
id|strbuf-&gt;strbuf_flushflag_pa
)paren
suffix:semicolon
(paren
r_void
)paren
id|pci_iommu_read
c_func
(paren
id|iommu-&gt;write_complete_reg
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|PCI_STC_FLUSHFLAG_SET
c_func
(paren
id|strbuf
)paren
)paren
id|membar
c_func
(paren
l_string|&quot;#LoadLoad&quot;
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Make physical memory consistent for a set of streaming&n; * mode DMA translations after a transfer.&n; */
DECL|function|pci_dma_sync_sg
r_void
id|pci_dma_sync_sg
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_struct
id|scatterlist
op_star
id|sglist
comma
r_int
id|nelems
comma
r_int
id|direction
)paren
(brace
r_struct
id|pcidev_cookie
op_star
id|pcp
suffix:semicolon
r_struct
id|pci_iommu
op_star
id|iommu
suffix:semicolon
r_struct
id|pci_strbuf
op_star
id|strbuf
suffix:semicolon
r_int
r_int
id|flags
comma
id|ctx
suffix:semicolon
id|pcp
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
id|iommu
op_assign
op_amp
id|pcp-&gt;pbm-&gt;parent-&gt;iommu
suffix:semicolon
id|strbuf
op_assign
op_amp
id|pcp-&gt;pbm-&gt;stc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strbuf-&gt;strbuf_enabled
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Step 1: Record the context, if any. */
id|ctx
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|iommu-&gt;iommu_ctxflush
op_logical_and
id|strbuf-&gt;strbuf_ctxflush
)paren
(brace
id|iopte_t
op_star
id|iopte
suffix:semicolon
id|iopte
op_assign
id|iommu-&gt;page_table
op_plus
(paren
(paren
id|sglist
(braket
l_int|0
)braket
dot
id|dvma_address
op_minus
id|iommu-&gt;page_table_map_base
)paren
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|ctx
op_assign
(paren
id|iopte_val
c_func
(paren
op_star
id|iopte
)paren
op_amp
id|IOPTE_CONTEXT
)paren
op_rshift
l_int|47UL
suffix:semicolon
)brace
multiline_comment|/* Step 2: Kick data out of streaming buffers. */
id|PCI_STC_FLUSHFLAG_INIT
c_func
(paren
id|strbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iommu-&gt;iommu_ctxflush
op_logical_and
id|strbuf-&gt;strbuf_ctxflush
)paren
(brace
r_int
r_int
id|matchreg
comma
id|flushreg
suffix:semicolon
id|flushreg
op_assign
id|strbuf-&gt;strbuf_ctxflush
suffix:semicolon
id|matchreg
op_assign
id|PCI_STC_CTXMATCH_ADDR
c_func
(paren
id|strbuf
comma
id|ctx
)paren
suffix:semicolon
r_do
(brace
id|pci_iommu_write
c_func
(paren
id|flushreg
comma
id|ctx
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
(paren
r_int
)paren
id|pci_iommu_read
c_func
(paren
id|matchreg
)paren
)paren
OL
l_int|0L
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
r_int
id|i
comma
id|npages
suffix:semicolon
id|u32
id|bus_addr
suffix:semicolon
id|bus_addr
op_assign
id|sglist
(braket
l_int|0
)braket
dot
id|dvma_address
op_amp
id|PAGE_MASK
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|nelems
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|sglist
(braket
id|i
)braket
dot
id|dvma_length
)paren
r_break
suffix:semicolon
id|i
op_decrement
suffix:semicolon
id|npages
op_assign
(paren
id|PAGE_ALIGN
c_func
(paren
id|sglist
(braket
id|i
)braket
dot
id|dvma_address
op_plus
id|sglist
(braket
id|i
)braket
dot
id|dvma_length
)paren
op_minus
id|bus_addr
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|npages
suffix:semicolon
id|i
op_increment
comma
id|bus_addr
op_add_assign
id|PAGE_SIZE
)paren
id|pci_iommu_write
c_func
(paren
id|strbuf-&gt;strbuf_pflush
comma
id|bus_addr
)paren
suffix:semicolon
)brace
multiline_comment|/* Step 3: Perform flush synchronization sequence. */
id|pci_iommu_write
c_func
(paren
id|strbuf-&gt;strbuf_fsync
comma
id|strbuf-&gt;strbuf_flushflag_pa
)paren
suffix:semicolon
(paren
r_void
)paren
id|pci_iommu_read
c_func
(paren
id|iommu-&gt;write_complete_reg
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|PCI_STC_FLUSHFLAG_SET
c_func
(paren
id|strbuf
)paren
)paren
id|membar
c_func
(paren
l_string|&quot;#LoadLoad&quot;
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|pci_dma_supported
r_int
id|pci_dma_supported
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|dma_addr_t
id|device_mask
)paren
(brace
r_struct
id|pcidev_cookie
op_star
id|pcp
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
id|u32
id|dma_addr_mask
suffix:semicolon
r_if
c_cond
(paren
id|pdev
op_eq
l_int|NULL
)paren
(brace
id|dma_addr_mask
op_assign
l_int|0xffffffff
suffix:semicolon
)brace
r_else
(brace
r_struct
id|pci_iommu
op_star
id|iommu
op_assign
op_amp
id|pcp-&gt;pbm-&gt;parent-&gt;iommu
suffix:semicolon
id|dma_addr_mask
op_assign
id|iommu-&gt;dma_addr_mask
suffix:semicolon
)brace
r_return
(paren
id|device_mask
op_amp
id|dma_addr_mask
)paren
op_eq
id|dma_addr_mask
suffix:semicolon
)brace
eof
