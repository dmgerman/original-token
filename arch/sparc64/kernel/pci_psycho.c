multiline_comment|/* $Id: pci_psycho.c,v 1.17 2000/09/21 06:25:14 anton Exp $&n; * pci_psycho.c: PSYCHO/U2P specific PCI controller support.&n; *&n; * Copyright (C) 1997, 1998, 1999 David S. Miller (davem@caipfs.rutgers.edu)&n; * Copyright (C) 1998, 1999 Eddie C. Dost   (ecd@skynet.be)&n; * Copyright (C) 1999 Jakub Jelinek   (jakub@redhat.com)&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;asm/pbm.h&gt;
macro_line|#include &lt;asm/iommu.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/starfire.h&gt;
macro_line|#include &quot;pci_impl.h&quot;
multiline_comment|/* All PSYCHO registers are 64-bits.  The following accessor&n; * routines are how they are accessed.  The REG parameter&n; * is a physical address.&n; */
DECL|macro|psycho_read
mdefine_line|#define psycho_read(__reg) &bslash;&n;({&t;u64 __ret; &bslash;&n;&t;__asm__ __volatile__(&quot;ldxa [%1] %2, %0&quot; &bslash;&n;&t;&t;&t;     : &quot;=r&quot; (__ret) &bslash;&n;&t;&t;&t;     : &quot;r&quot; (__reg), &quot;i&quot; (ASI_PHYS_BYPASS_EC_E) &bslash;&n;&t;&t;&t;     : &quot;memory&quot;); &bslash;&n;&t;__ret; &bslash;&n;})
DECL|macro|psycho_write
mdefine_line|#define psycho_write(__reg, __val) &bslash;&n;&t;__asm__ __volatile__(&quot;stxa %0, [%1] %2&quot; &bslash;&n;&t;&t;&t;     : /* no outputs */ &bslash;&n;&t;&t;&t;     : &quot;r&quot; (__val), &quot;r&quot; (__reg), &bslash;&n;&t;&t;&t;       &quot;i&quot; (ASI_PHYS_BYPASS_EC_E))
multiline_comment|/* Misc. PSYCHO PCI controller register offsets and definitions. */
DECL|macro|PSYCHO_CONTROL
mdefine_line|#define PSYCHO_CONTROL&t;&t;0x0010UL
DECL|macro|PSYCHO_CONTROL_IMPL
mdefine_line|#define  PSYCHO_CONTROL_IMPL&t; 0xf000000000000000 /* Implementation of this PSYCHO*/
DECL|macro|PSYCHO_CONTROL_VER
mdefine_line|#define  PSYCHO_CONTROL_VER&t; 0x0f00000000000000 /* Version of this PSYCHO       */
DECL|macro|PSYCHO_CONTROL_MID
mdefine_line|#define  PSYCHO_CONTROL_MID&t; 0x00f8000000000000 /* UPA Module ID of PSYCHO      */
DECL|macro|PSYCHO_CONTROL_IGN
mdefine_line|#define  PSYCHO_CONTROL_IGN&t; 0x0007c00000000000 /* Interrupt Group Number       */
DECL|macro|PSYCHO_CONTROL_RESV
mdefine_line|#define  PSYCHO_CONTROL_RESV     0x00003ffffffffff0 /* Reserved                     */
DECL|macro|PSYCHO_CONTROL_APCKEN
mdefine_line|#define  PSYCHO_CONTROL_APCKEN&t; 0x0000000000000008 /* Address Parity Check Enable  */
DECL|macro|PSYCHO_CONTROL_APERR
mdefine_line|#define  PSYCHO_CONTROL_APERR&t; 0x0000000000000004 /* Incoming System Addr Parerr  */
DECL|macro|PSYCHO_CONTROL_IAP
mdefine_line|#define  PSYCHO_CONTROL_IAP&t; 0x0000000000000002 /* Invert UPA Parity            */
DECL|macro|PSYCHO_CONTROL_MODE
mdefine_line|#define  PSYCHO_CONTROL_MODE&t; 0x0000000000000001 /* PSYCHO clock mode            */
DECL|macro|PSYCHO_PCIA_CTRL
mdefine_line|#define PSYCHO_PCIA_CTRL&t;0x2000UL
DECL|macro|PSYCHO_PCIB_CTRL
mdefine_line|#define PSYCHO_PCIB_CTRL&t;0x4000UL
DECL|macro|PSYCHO_PCICTRL_RESV1
mdefine_line|#define  PSYCHO_PCICTRL_RESV1&t; 0xfffffff000000000 /* Reserved                     */
DECL|macro|PSYCHO_PCICTRL_SBH_ERR
mdefine_line|#define  PSYCHO_PCICTRL_SBH_ERR&t; 0x0000000800000000 /* Streaming byte hole error    */
DECL|macro|PSYCHO_PCICTRL_SERR
mdefine_line|#define  PSYCHO_PCICTRL_SERR&t; 0x0000000400000000 /* SERR signal asserted         */
DECL|macro|PSYCHO_PCICTRL_SPEED
mdefine_line|#define  PSYCHO_PCICTRL_SPEED&t; 0x0000000200000000 /* PCI speed (1 is U2P clock)   */
DECL|macro|PSYCHO_PCICTRL_RESV2
mdefine_line|#define  PSYCHO_PCICTRL_RESV2&t; 0x00000001ffc00000 /* Reserved                     */
DECL|macro|PSYCHO_PCICTRL_ARB_PARK
mdefine_line|#define  PSYCHO_PCICTRL_ARB_PARK 0x0000000000200000 /* PCI arbitration parking      */
DECL|macro|PSYCHO_PCICTRL_RESV3
mdefine_line|#define  PSYCHO_PCICTRL_RESV3&t; 0x00000000001ff800 /* Reserved                     */
DECL|macro|PSYCHO_PCICTRL_SBH_INT
mdefine_line|#define  PSYCHO_PCICTRL_SBH_INT&t; 0x0000000000000400 /* Streaming byte hole int enab */
DECL|macro|PSYCHO_PCICTRL_WEN
mdefine_line|#define  PSYCHO_PCICTRL_WEN&t; 0x0000000000000200 /* Power Mgmt Wake Enable       */
DECL|macro|PSYCHO_PCICTRL_EEN
mdefine_line|#define  PSYCHO_PCICTRL_EEN&t; 0x0000000000000100 /* PCI Error Interrupt Enable   */
DECL|macro|PSYCHO_PCICTRL_RESV4
mdefine_line|#define  PSYCHO_PCICTRL_RESV4&t; 0x00000000000000c0 /* Reserved                     */
DECL|macro|PSYCHO_PCICTRL_AEN
mdefine_line|#define  PSYCHO_PCICTRL_AEN&t; 0x000000000000003f /* PCI DVMA Arbitration Enable  */
multiline_comment|/* U2P Programmer&squot;s Manual, page 13-55, configuration space&n; * address format:&n; * &n; *  32             24 23 16 15    11 10       8 7   2  1 0&n; * ---------------------------------------------------------&n; * |0 0 0 0 0 0 0 0 1| bus | device | function | reg | 0 0 |&n; * ---------------------------------------------------------&n; */
DECL|macro|PSYCHO_CONFIG_BASE
mdefine_line|#define PSYCHO_CONFIG_BASE(PBM)&t;&bslash;&n;&t;((PBM)-&gt;parent-&gt;config_space | (1UL &lt;&lt; 24))
DECL|macro|PSYCHO_CONFIG_ENCODE
mdefine_line|#define PSYCHO_CONFIG_ENCODE(BUS, DEVFN, REG)&t;&bslash;&n;&t;(((unsigned long)(BUS)   &lt;&lt; 16) |&t;&bslash;&n;&t; ((unsigned long)(DEVFN) &lt;&lt; 8)  |&t;&bslash;&n;&t; ((unsigned long)(REG)))
DECL|function|psycho_pci_config_mkaddr
r_static
r_void
op_star
id|psycho_pci_config_mkaddr
c_func
(paren
r_struct
id|pci_pbm_info
op_star
id|pbm
comma
r_int
r_char
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pbm
)paren
r_return
l_int|NULL
suffix:semicolon
r_return
(paren
r_void
op_star
)paren
(paren
id|PSYCHO_CONFIG_BASE
c_func
(paren
id|pbm
)paren
op_or
id|PSYCHO_CONFIG_ENCODE
c_func
(paren
id|bus
comma
id|devfn
comma
id|where
)paren
)paren
suffix:semicolon
)brace
DECL|function|psycho_out_of_range
r_static
r_int
id|psycho_out_of_range
c_func
(paren
r_struct
id|pci_pbm_info
op_star
id|pbm
comma
r_int
r_char
id|bus
comma
r_int
r_char
id|devfn
)paren
(brace
r_return
(paren
(paren
id|pbm-&gt;parent
op_eq
l_int|0
)paren
op_logical_or
(paren
(paren
id|pbm
op_eq
op_amp
id|pbm-&gt;parent-&gt;pbm_B
)paren
op_logical_and
(paren
id|bus
op_eq
id|pbm-&gt;pci_first_busno
)paren
op_logical_and
id|PCI_SLOT
c_func
(paren
id|devfn
)paren
OG
l_int|8
)paren
op_logical_or
(paren
(paren
id|pbm
op_eq
op_amp
id|pbm-&gt;parent-&gt;pbm_A
)paren
op_logical_and
(paren
id|bus
op_eq
id|pbm-&gt;pci_first_busno
)paren
op_logical_and
id|PCI_SLOT
c_func
(paren
id|devfn
)paren
OG
l_int|8
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* PSYCHO PCI configuration space accessors. */
DECL|function|psycho_read_byte
r_static
r_int
id|psycho_read_byte
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u8
op_star
id|value
)paren
(brace
r_struct
id|pci_pbm_info
op_star
id|pbm
op_assign
id|pci_bus2pbm
(braket
id|dev-&gt;bus-&gt;number
)braket
suffix:semicolon
r_int
r_char
id|bus
op_assign
id|dev-&gt;bus-&gt;number
suffix:semicolon
r_int
r_int
id|devfn
op_assign
id|dev-&gt;devfn
suffix:semicolon
id|u8
op_star
id|addr
suffix:semicolon
op_star
id|value
op_assign
l_int|0xff
suffix:semicolon
id|addr
op_assign
id|psycho_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
comma
id|where
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|psycho_out_of_range
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
)paren
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
id|pci_config_read8
c_func
(paren
id|addr
comma
id|value
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|psycho_read_word
r_static
r_int
id|psycho_read_word
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u16
op_star
id|value
)paren
(brace
r_struct
id|pci_pbm_info
op_star
id|pbm
op_assign
id|pci_bus2pbm
(braket
id|dev-&gt;bus-&gt;number
)braket
suffix:semicolon
r_int
r_char
id|bus
op_assign
id|dev-&gt;bus-&gt;number
suffix:semicolon
r_int
r_int
id|devfn
op_assign
id|dev-&gt;devfn
suffix:semicolon
id|u16
op_star
id|addr
suffix:semicolon
op_star
id|value
op_assign
l_int|0xffff
suffix:semicolon
id|addr
op_assign
id|psycho_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
comma
id|where
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|psycho_out_of_range
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
)paren
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|where
op_amp
l_int|0x01
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;pcibios_read_config_word: misaligned reg [%x]&bslash;n&quot;
comma
id|where
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
id|pci_config_read16
c_func
(paren
id|addr
comma
id|value
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|psycho_read_dword
r_static
r_int
id|psycho_read_dword
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u32
op_star
id|value
)paren
(brace
r_struct
id|pci_pbm_info
op_star
id|pbm
op_assign
id|pci_bus2pbm
(braket
id|dev-&gt;bus-&gt;number
)braket
suffix:semicolon
r_int
r_char
id|bus
op_assign
id|dev-&gt;bus-&gt;number
suffix:semicolon
r_int
r_int
id|devfn
op_assign
id|dev-&gt;devfn
suffix:semicolon
id|u32
op_star
id|addr
suffix:semicolon
op_star
id|value
op_assign
l_int|0xffffffff
suffix:semicolon
id|addr
op_assign
id|psycho_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
comma
id|where
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|psycho_out_of_range
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
)paren
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|where
op_amp
l_int|0x03
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;pcibios_read_config_dword: misaligned reg [%x]&bslash;n&quot;
comma
id|where
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
id|pci_config_read32
c_func
(paren
id|addr
comma
id|value
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|psycho_write_byte
r_static
r_int
id|psycho_write_byte
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u8
id|value
)paren
(brace
r_struct
id|pci_pbm_info
op_star
id|pbm
op_assign
id|pci_bus2pbm
(braket
id|dev-&gt;bus-&gt;number
)braket
suffix:semicolon
r_int
r_char
id|bus
op_assign
id|dev-&gt;bus-&gt;number
suffix:semicolon
r_int
r_int
id|devfn
op_assign
id|dev-&gt;devfn
suffix:semicolon
id|u8
op_star
id|addr
suffix:semicolon
id|addr
op_assign
id|psycho_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
comma
id|where
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|psycho_out_of_range
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
)paren
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
id|pci_config_write8
c_func
(paren
id|addr
comma
id|value
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|psycho_write_word
r_static
r_int
id|psycho_write_word
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u16
id|value
)paren
(brace
r_struct
id|pci_pbm_info
op_star
id|pbm
op_assign
id|pci_bus2pbm
(braket
id|dev-&gt;bus-&gt;number
)braket
suffix:semicolon
r_int
r_char
id|bus
op_assign
id|dev-&gt;bus-&gt;number
suffix:semicolon
r_int
r_int
id|devfn
op_assign
id|dev-&gt;devfn
suffix:semicolon
id|u16
op_star
id|addr
suffix:semicolon
id|addr
op_assign
id|psycho_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
comma
id|where
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|psycho_out_of_range
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
)paren
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|where
op_amp
l_int|0x01
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;pcibios_write_config_word: misaligned reg [%x]&bslash;n&quot;
comma
id|where
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
id|pci_config_write16
c_func
(paren
id|addr
comma
id|value
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|psycho_write_dword
r_static
r_int
id|psycho_write_dword
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u32
id|value
)paren
(brace
r_struct
id|pci_pbm_info
op_star
id|pbm
op_assign
id|pci_bus2pbm
(braket
id|dev-&gt;bus-&gt;number
)braket
suffix:semicolon
r_int
r_char
id|bus
op_assign
id|dev-&gt;bus-&gt;number
suffix:semicolon
r_int
r_int
id|devfn
op_assign
id|dev-&gt;devfn
suffix:semicolon
id|u32
op_star
id|addr
suffix:semicolon
id|addr
op_assign
id|psycho_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
comma
id|where
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|psycho_out_of_range
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
)paren
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|where
op_amp
l_int|0x03
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;pcibios_write_config_dword: misaligned reg [%x]&bslash;n&quot;
comma
id|where
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
id|pci_config_write32
c_func
(paren
id|addr
comma
id|value
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|variable|psycho_ops
r_static
r_struct
id|pci_ops
id|psycho_ops
op_assign
(brace
id|psycho_read_byte
comma
id|psycho_read_word
comma
id|psycho_read_dword
comma
id|psycho_write_byte
comma
id|psycho_write_word
comma
id|psycho_write_dword
)brace
suffix:semicolon
multiline_comment|/* PSYCHO interrupt mapping support. */
DECL|macro|PSYCHO_IMAP_A_SLOT0
mdefine_line|#define PSYCHO_IMAP_A_SLOT0&t;0x0c00UL
DECL|macro|PSYCHO_IMAP_B_SLOT0
mdefine_line|#define PSYCHO_IMAP_B_SLOT0&t;0x0c20UL
DECL|function|psycho_pcislot_imap_offset
r_static
r_int
r_int
id|psycho_pcislot_imap_offset
c_func
(paren
r_int
r_int
id|ino
)paren
(brace
r_int
r_int
id|bus
op_assign
(paren
id|ino
op_amp
l_int|0x10
)paren
op_rshift
l_int|4
suffix:semicolon
r_int
r_int
id|slot
op_assign
(paren
id|ino
op_amp
l_int|0x0c
)paren
op_rshift
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|bus
op_eq
l_int|0
)paren
r_return
id|PSYCHO_IMAP_A_SLOT0
op_plus
(paren
id|slot
op_star
l_int|8
)paren
suffix:semicolon
r_else
r_return
id|PSYCHO_IMAP_B_SLOT0
op_plus
(paren
id|slot
op_star
l_int|8
)paren
suffix:semicolon
)brace
DECL|macro|PSYCHO_IMAP_SCSI
mdefine_line|#define PSYCHO_IMAP_SCSI&t;0x1000UL
DECL|macro|PSYCHO_IMAP_ETH
mdefine_line|#define PSYCHO_IMAP_ETH&t;&t;0x1008UL
DECL|macro|PSYCHO_IMAP_BPP
mdefine_line|#define PSYCHO_IMAP_BPP&t;&t;0x1010UL
DECL|macro|PSYCHO_IMAP_AU_REC
mdefine_line|#define PSYCHO_IMAP_AU_REC&t;0x1018UL
DECL|macro|PSYCHO_IMAP_AU_PLAY
mdefine_line|#define PSYCHO_IMAP_AU_PLAY&t;0x1020UL
DECL|macro|PSYCHO_IMAP_PFAIL
mdefine_line|#define PSYCHO_IMAP_PFAIL&t;0x1028UL
DECL|macro|PSYCHO_IMAP_KMS
mdefine_line|#define PSYCHO_IMAP_KMS&t;&t;0x1030UL
DECL|macro|PSYCHO_IMAP_FLPY
mdefine_line|#define PSYCHO_IMAP_FLPY&t;0x1038UL
DECL|macro|PSYCHO_IMAP_SHW
mdefine_line|#define PSYCHO_IMAP_SHW&t;&t;0x1040UL
DECL|macro|PSYCHO_IMAP_KBD
mdefine_line|#define PSYCHO_IMAP_KBD&t;&t;0x1048UL
DECL|macro|PSYCHO_IMAP_MS
mdefine_line|#define PSYCHO_IMAP_MS&t;&t;0x1050UL
DECL|macro|PSYCHO_IMAP_SER
mdefine_line|#define PSYCHO_IMAP_SER&t;&t;0x1058UL
DECL|macro|PSYCHO_IMAP_TIM0
mdefine_line|#define PSYCHO_IMAP_TIM0&t;0x1060UL
DECL|macro|PSYCHO_IMAP_TIM1
mdefine_line|#define PSYCHO_IMAP_TIM1&t;0x1068UL
DECL|macro|PSYCHO_IMAP_UE
mdefine_line|#define PSYCHO_IMAP_UE&t;&t;0x1070UL
DECL|macro|PSYCHO_IMAP_CE
mdefine_line|#define PSYCHO_IMAP_CE&t;&t;0x1078UL
DECL|macro|PSYCHO_IMAP_A_ERR
mdefine_line|#define PSYCHO_IMAP_A_ERR&t;0x1080UL
DECL|macro|PSYCHO_IMAP_B_ERR
mdefine_line|#define PSYCHO_IMAP_B_ERR&t;0x1088UL
DECL|macro|PSYCHO_IMAP_PMGMT
mdefine_line|#define PSYCHO_IMAP_PMGMT&t;0x1090UL
DECL|macro|PSYCHO_IMAP_GFX
mdefine_line|#define PSYCHO_IMAP_GFX&t;&t;0x1098UL
DECL|macro|PSYCHO_IMAP_EUPA
mdefine_line|#define PSYCHO_IMAP_EUPA&t;0x10a0UL
DECL|variable|__onboard_imap_off
r_static
r_int
r_int
id|__onboard_imap_off
(braket
)braket
op_assign
(brace
multiline_comment|/*0x20*/
id|PSYCHO_IMAP_SCSI
comma
multiline_comment|/*0x21*/
id|PSYCHO_IMAP_ETH
comma
multiline_comment|/*0x22*/
id|PSYCHO_IMAP_BPP
comma
multiline_comment|/*0x23*/
id|PSYCHO_IMAP_AU_REC
comma
multiline_comment|/*0x24*/
id|PSYCHO_IMAP_AU_PLAY
comma
multiline_comment|/*0x25*/
id|PSYCHO_IMAP_PFAIL
comma
multiline_comment|/*0x26*/
id|PSYCHO_IMAP_KMS
comma
multiline_comment|/*0x27*/
id|PSYCHO_IMAP_FLPY
comma
multiline_comment|/*0x28*/
id|PSYCHO_IMAP_SHW
comma
multiline_comment|/*0x29*/
id|PSYCHO_IMAP_KBD
comma
multiline_comment|/*0x2a*/
id|PSYCHO_IMAP_MS
comma
multiline_comment|/*0x2b*/
id|PSYCHO_IMAP_SER
comma
multiline_comment|/*0x2c*/
id|PSYCHO_IMAP_TIM0
comma
multiline_comment|/*0x2d*/
id|PSYCHO_IMAP_TIM1
comma
multiline_comment|/*0x2e*/
id|PSYCHO_IMAP_UE
comma
multiline_comment|/*0x2f*/
id|PSYCHO_IMAP_CE
comma
multiline_comment|/*0x30*/
id|PSYCHO_IMAP_A_ERR
comma
multiline_comment|/*0x31*/
id|PSYCHO_IMAP_B_ERR
comma
multiline_comment|/*0x32*/
id|PSYCHO_IMAP_PMGMT
)brace
suffix:semicolon
DECL|macro|PSYCHO_ONBOARD_IRQ_BASE
mdefine_line|#define PSYCHO_ONBOARD_IRQ_BASE&t;&t;0x20
DECL|macro|PSYCHO_ONBOARD_IRQ_LAST
mdefine_line|#define PSYCHO_ONBOARD_IRQ_LAST&t;&t;0x32
DECL|macro|psycho_onboard_imap_offset
mdefine_line|#define psycho_onboard_imap_offset(__ino) &bslash;&n;&t;__onboard_imap_off[(__ino) - PSYCHO_ONBOARD_IRQ_BASE]
DECL|macro|PSYCHO_ICLR_A_SLOT0
mdefine_line|#define PSYCHO_ICLR_A_SLOT0&t;0x1400UL
DECL|macro|PSYCHO_ICLR_SCSI
mdefine_line|#define PSYCHO_ICLR_SCSI&t;0x1800UL
DECL|macro|psycho_iclr_offset
mdefine_line|#define psycho_iclr_offset(ino)&t;&t;&t;&t;&t;      &bslash;&n;&t;((ino &amp; 0x20) ? (PSYCHO_ICLR_SCSI + (((ino) &amp; 0x1f) &lt;&lt; 3)) :  &bslash;&n;&t;&t;&t;(PSYCHO_ICLR_A_SLOT0 + (((ino) &amp; 0x1f)&lt;&lt;3)))
multiline_comment|/* PCI PSYCHO INO number to Sparc PIL level. */
DECL|variable|psycho_pil_table
r_static
r_int
r_char
id|psycho_pil_table
(braket
)braket
op_assign
(brace
multiline_comment|/*0x00*/
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* PCI A slot 0  Int A, B, C, D */
multiline_comment|/*0x04*/
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* PCI A slot 1  Int A, B, C, D */
multiline_comment|/*0x08*/
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* PCI A slot 2  Int A, B, C, D */
multiline_comment|/*0x0c*/
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* PCI A slot 3  Int A, B, C, D */
multiline_comment|/*0x10*/
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* PCI B slot 0  Int A, B, C, D */
multiline_comment|/*0x14*/
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* PCI B slot 1  Int A, B, C, D */
multiline_comment|/*0x18*/
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* PCI B slot 2  Int A, B, C, D */
multiline_comment|/*0x1c*/
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* PCI B slot 3  Int A, B, C, D */
multiline_comment|/*0x20*/
l_int|3
comma
multiline_comment|/* SCSI&t;&t;&t;&t;*/
multiline_comment|/*0x21*/
l_int|5
comma
multiline_comment|/* Ethernet&t;&t;&t;*/
multiline_comment|/*0x22*/
l_int|8
comma
multiline_comment|/* Parallel Port&t;&t;*/
multiline_comment|/*0x23*/
l_int|13
comma
multiline_comment|/* Audio Record&t;&t;&t;*/
multiline_comment|/*0x24*/
l_int|14
comma
multiline_comment|/* Audio Playback&t;&t;*/
multiline_comment|/*0x25*/
l_int|15
comma
multiline_comment|/* PowerFail&t;&t;&t;*/
multiline_comment|/*0x26*/
l_int|3
comma
multiline_comment|/* second SCSI&t;&t;&t;*/
multiline_comment|/*0x27*/
l_int|11
comma
multiline_comment|/* Floppy&t;&t;&t;*/
multiline_comment|/*0x28*/
l_int|2
comma
multiline_comment|/* Spare Hardware&t;&t;*/
multiline_comment|/*0x29*/
l_int|9
comma
multiline_comment|/* Keyboard&t;&t;&t;*/
multiline_comment|/*0x2a*/
l_int|4
comma
multiline_comment|/* Mouse&t;&t;&t;*/
multiline_comment|/*0x2b*/
l_int|12
comma
multiline_comment|/* Serial&t;&t;&t;*/
multiline_comment|/*0x2c*/
l_int|10
comma
multiline_comment|/* Timer 0&t;&t;&t;*/
multiline_comment|/*0x2d*/
l_int|11
comma
multiline_comment|/* Timer 1&t;&t;&t;*/
multiline_comment|/*0x2e*/
l_int|15
comma
multiline_comment|/* Uncorrectable ECC&t;&t;*/
multiline_comment|/*0x2f*/
l_int|15
comma
multiline_comment|/* Correctable ECC&t;&t;*/
multiline_comment|/*0x30*/
l_int|15
comma
multiline_comment|/* PCI Bus A Error&t;&t;*/
multiline_comment|/*0x31*/
l_int|15
comma
multiline_comment|/* PCI Bus B Error&t;&t;*/
multiline_comment|/*0x32*/
l_int|1
comma
multiline_comment|/* Power Management&t;&t;*/
)brace
suffix:semicolon
DECL|function|psycho_ino_to_pil
r_static
r_int
id|__init
id|psycho_ino_to_pil
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
r_int
id|ino
)paren
(brace
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|psycho_pil_table
(braket
id|ino
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
op_logical_and
id|pdev
op_eq
l_int|NULL
)paren
(brace
id|ret
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
(brace
r_switch
c_cond
(paren
(paren
id|pdev
op_member_access_from_pointer
r_class
op_rshift
l_int|16
)paren
op_amp
l_int|0x0f
)paren
(brace
r_case
id|PCI_BASE_CLASS_STORAGE
suffix:colon
id|ret
op_assign
l_int|4
suffix:semicolon
r_case
id|PCI_BASE_CLASS_NETWORK
suffix:colon
id|ret
op_assign
l_int|6
suffix:semicolon
r_case
id|PCI_BASE_CLASS_DISPLAY
suffix:colon
id|ret
op_assign
l_int|9
suffix:semicolon
r_case
id|PCI_BASE_CLASS_MULTIMEDIA
suffix:colon
r_case
id|PCI_BASE_CLASS_MEMORY
suffix:colon
r_case
id|PCI_BASE_CLASS_BRIDGE
suffix:colon
id|ret
op_assign
l_int|10
suffix:semicolon
r_default
suffix:colon
id|ret
op_assign
l_int|1
suffix:semicolon
)brace
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|psycho_irq_build
r_static
r_int
r_int
id|__init
id|psycho_irq_build
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
comma
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
r_int
id|ino
)paren
(brace
r_struct
id|ino_bucket
op_star
id|bucket
suffix:semicolon
r_int
r_int
id|imap
comma
id|iclr
suffix:semicolon
r_int
r_int
id|imap_off
comma
id|iclr_off
suffix:semicolon
r_int
id|pil
comma
id|inofixup
op_assign
l_int|0
suffix:semicolon
id|ino
op_and_assign
id|PCI_IRQ_INO
suffix:semicolon
r_if
c_cond
(paren
id|ino
OL
id|PSYCHO_ONBOARD_IRQ_BASE
)paren
(brace
multiline_comment|/* PCI slot */
id|imap_off
op_assign
id|psycho_pcislot_imap_offset
c_func
(paren
id|ino
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Onboard device */
r_if
c_cond
(paren
id|ino
OG
id|PSYCHO_ONBOARD_IRQ_LAST
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;psycho_irq_build: Wacky INO [%x]&bslash;n&quot;
comma
id|ino
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|imap_off
op_assign
id|psycho_onboard_imap_offset
c_func
(paren
id|ino
)paren
suffix:semicolon
)brace
multiline_comment|/* Now build the IRQ bucket. */
id|pil
op_assign
id|psycho_ino_to_pil
c_func
(paren
id|pdev
comma
id|ino
)paren
suffix:semicolon
id|imap
op_assign
id|p-&gt;controller_regs
op_plus
id|imap_off
suffix:semicolon
id|imap
op_add_assign
l_int|4
suffix:semicolon
id|iclr_off
op_assign
id|psycho_iclr_offset
c_func
(paren
id|ino
)paren
suffix:semicolon
id|iclr
op_assign
id|p-&gt;controller_regs
op_plus
id|iclr_off
suffix:semicolon
id|iclr
op_add_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ino
op_amp
l_int|0x20
)paren
op_eq
l_int|0
)paren
id|inofixup
op_assign
id|ino
op_amp
l_int|0x03
suffix:semicolon
id|bucket
op_assign
id|__bucket
c_func
(paren
id|build_irq
c_func
(paren
id|pil
comma
id|inofixup
comma
id|iclr
comma
id|imap
)paren
)paren
suffix:semicolon
id|bucket-&gt;flags
op_or_assign
id|IBF_PCI
suffix:semicolon
r_return
id|__irq
c_func
(paren
id|bucket
)paren
suffix:semicolon
)brace
multiline_comment|/* PSYCHO error handling support. */
DECL|enum|psycho_error_type
r_enum
id|psycho_error_type
(brace
DECL|enumerator|UE_ERR
DECL|enumerator|CE_ERR
DECL|enumerator|PCI_ERR
id|UE_ERR
comma
id|CE_ERR
comma
id|PCI_ERR
)brace
suffix:semicolon
multiline_comment|/* Helper function of IOMMU error checking, which checks out&n; * the state of the streaming buffers.  The IOMMU lock is&n; * held when this is called.&n; *&n; * For the PCI error case we know which PBM (and thus which&n; * streaming buffer) caused the error, but for the uncorrectable&n; * error case we do not.  So we always check both streaming caches.&n; */
DECL|macro|PSYCHO_STRBUF_CONTROL_A
mdefine_line|#define PSYCHO_STRBUF_CONTROL_A 0x2800UL
DECL|macro|PSYCHO_STRBUF_CONTROL_B
mdefine_line|#define PSYCHO_STRBUF_CONTROL_B 0x4800UL
DECL|macro|PSYCHO_STRBUF_CTRL_LPTR
mdefine_line|#define  PSYCHO_STRBUF_CTRL_LPTR    0x00000000000000f0 /* LRU Lock Pointer */
DECL|macro|PSYCHO_STRBUF_CTRL_LENAB
mdefine_line|#define  PSYCHO_STRBUF_CTRL_LENAB   0x0000000000000008 /* LRU Lock Enable */
DECL|macro|PSYCHO_STRBUF_CTRL_RRDIS
mdefine_line|#define  PSYCHO_STRBUF_CTRL_RRDIS   0x0000000000000004 /* Rerun Disable */
DECL|macro|PSYCHO_STRBUF_CTRL_DENAB
mdefine_line|#define  PSYCHO_STRBUF_CTRL_DENAB   0x0000000000000002 /* Diagnostic Mode Enable */
DECL|macro|PSYCHO_STRBUF_CTRL_ENAB
mdefine_line|#define  PSYCHO_STRBUF_CTRL_ENAB    0x0000000000000001 /* Streaming Buffer Enable */
DECL|macro|PSYCHO_STRBUF_FLUSH_A
mdefine_line|#define PSYCHO_STRBUF_FLUSH_A   0x2808UL
DECL|macro|PSYCHO_STRBUF_FLUSH_B
mdefine_line|#define PSYCHO_STRBUF_FLUSH_B   0x4808UL
DECL|macro|PSYCHO_STRBUF_FSYNC_A
mdefine_line|#define PSYCHO_STRBUF_FSYNC_A   0x2810UL
DECL|macro|PSYCHO_STRBUF_FSYNC_B
mdefine_line|#define PSYCHO_STRBUF_FSYNC_B   0x4810UL
DECL|macro|PSYCHO_STC_DATA_A
mdefine_line|#define PSYCHO_STC_DATA_A&t;0xb000UL
DECL|macro|PSYCHO_STC_DATA_B
mdefine_line|#define PSYCHO_STC_DATA_B&t;0xc000UL
DECL|macro|PSYCHO_STC_ERR_A
mdefine_line|#define PSYCHO_STC_ERR_A&t;0xb400UL
DECL|macro|PSYCHO_STC_ERR_B
mdefine_line|#define PSYCHO_STC_ERR_B&t;0xc400UL
DECL|macro|PSYCHO_STCERR_WRITE
mdefine_line|#define  PSYCHO_STCERR_WRITE&t; 0x0000000000000002&t;/* Write Error */
DECL|macro|PSYCHO_STCERR_READ
mdefine_line|#define  PSYCHO_STCERR_READ&t; 0x0000000000000001&t;/* Read Error */
DECL|macro|PSYCHO_STC_TAG_A
mdefine_line|#define PSYCHO_STC_TAG_A&t;0xb800UL
DECL|macro|PSYCHO_STC_TAG_B
mdefine_line|#define PSYCHO_STC_TAG_B&t;0xc800UL
DECL|macro|PSYCHO_STCTAG_PPN
mdefine_line|#define  PSYCHO_STCTAG_PPN&t; 0x0fffffff00000000&t;/* Physical Page Number */
DECL|macro|PSYCHO_STCTAG_VPN
mdefine_line|#define  PSYCHO_STCTAG_VPN&t; 0x00000000ffffe000&t;/* Virtual Page Number */
DECL|macro|PSYCHO_STCTAG_VALID
mdefine_line|#define  PSYCHO_STCTAG_VALID&t; 0x0000000000000002&t;/* Valid */
DECL|macro|PSYCHO_STCTAG_WRITE
mdefine_line|#define  PSYCHO_STCTAG_WRITE&t; 0x0000000000000001&t;/* Writable */
DECL|macro|PSYCHO_STC_LINE_A
mdefine_line|#define PSYCHO_STC_LINE_A&t;0xb900UL
DECL|macro|PSYCHO_STC_LINE_B
mdefine_line|#define PSYCHO_STC_LINE_B&t;0xc900UL
DECL|macro|PSYCHO_STCLINE_LINDX
mdefine_line|#define  PSYCHO_STCLINE_LINDX&t; 0x0000000001e00000&t;/* LRU Index */
DECL|macro|PSYCHO_STCLINE_SPTR
mdefine_line|#define  PSYCHO_STCLINE_SPTR&t; 0x00000000001f8000&t;/* Dirty Data Start Pointer */
DECL|macro|PSYCHO_STCLINE_LADDR
mdefine_line|#define  PSYCHO_STCLINE_LADDR&t; 0x0000000000007f00&t;/* Line Address */
DECL|macro|PSYCHO_STCLINE_EPTR
mdefine_line|#define  PSYCHO_STCLINE_EPTR&t; 0x00000000000000fc&t;/* Dirty Data End Pointer */
DECL|macro|PSYCHO_STCLINE_VALID
mdefine_line|#define  PSYCHO_STCLINE_VALID&t; 0x0000000000000002&t;/* Valid */
DECL|macro|PSYCHO_STCLINE_FOFN
mdefine_line|#define  PSYCHO_STCLINE_FOFN&t; 0x0000000000000001&t;/* Fetch Outstanding / Flush Necessary */
DECL|variable|stc_buf_lock
r_static
id|spinlock_t
id|stc_buf_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|stc_error_buf
r_static
r_int
r_int
id|stc_error_buf
(braket
l_int|128
)braket
suffix:semicolon
DECL|variable|stc_tag_buf
r_static
r_int
r_int
id|stc_tag_buf
(braket
l_int|16
)braket
suffix:semicolon
DECL|variable|stc_line_buf
r_static
r_int
r_int
id|stc_line_buf
(braket
l_int|16
)braket
suffix:semicolon
DECL|function|__psycho_check_one_stc
r_static
r_void
id|__psycho_check_one_stc
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
comma
r_struct
id|pci_pbm_info
op_star
id|pbm
comma
r_int
id|is_pbm_a
)paren
(brace
r_struct
id|pci_strbuf
op_star
id|strbuf
op_assign
op_amp
id|pbm-&gt;stc
suffix:semicolon
r_int
r_int
id|regbase
op_assign
id|p-&gt;controller_regs
suffix:semicolon
r_int
r_int
id|err_base
comma
id|tag_base
comma
id|line_base
suffix:semicolon
id|u64
id|control
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|is_pbm_a
)paren
(brace
id|err_base
op_assign
id|regbase
op_plus
id|PSYCHO_STC_ERR_A
suffix:semicolon
id|tag_base
op_assign
id|regbase
op_plus
id|PSYCHO_STC_TAG_A
suffix:semicolon
id|line_base
op_assign
id|regbase
op_plus
id|PSYCHO_STC_LINE_A
suffix:semicolon
)brace
r_else
(brace
id|err_base
op_assign
id|regbase
op_plus
id|PSYCHO_STC_ERR_A
suffix:semicolon
id|tag_base
op_assign
id|regbase
op_plus
id|PSYCHO_STC_TAG_A
suffix:semicolon
id|line_base
op_assign
id|regbase
op_plus
id|PSYCHO_STC_LINE_A
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|stc_buf_lock
)paren
suffix:semicolon
multiline_comment|/* This is __REALLY__ dangerous.  When we put the&n;&t; * streaming buffer into diagnostic mode to probe&n;&t; * it&squot;s tags and error status, we _must_ clear all&n;&t; * of the line tag valid bits before re-enabling&n;&t; * the streaming buffer.  If any dirty data lives&n;&t; * in the STC when we do this, we will end up&n;&t; * invalidating it before it has a chance to reach&n;&t; * main memory.&n;&t; */
id|control
op_assign
id|psycho_read
c_func
(paren
id|strbuf-&gt;strbuf_control
)paren
suffix:semicolon
id|psycho_write
c_func
(paren
id|strbuf-&gt;strbuf_control
comma
(paren
id|control
op_or
id|PSYCHO_STRBUF_CTRL_DENAB
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|128
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|val
suffix:semicolon
id|val
op_assign
id|psycho_read
c_func
(paren
id|err_base
op_plus
(paren
id|i
op_star
l_int|8UL
)paren
)paren
suffix:semicolon
id|psycho_write
c_func
(paren
id|err_base
op_plus
(paren
id|i
op_star
l_int|8UL
)paren
comma
l_int|0UL
)paren
suffix:semicolon
id|stc_error_buf
(braket
id|i
)braket
op_assign
id|val
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|stc_tag_buf
(braket
id|i
)braket
op_assign
id|psycho_read
c_func
(paren
id|tag_base
op_plus
(paren
id|i
op_star
l_int|8UL
)paren
)paren
suffix:semicolon
id|stc_line_buf
(braket
id|i
)braket
op_assign
id|psycho_read
c_func
(paren
id|line_base
op_plus
(paren
id|i
op_star
l_int|8UL
)paren
)paren
suffix:semicolon
id|psycho_write
c_func
(paren
id|tag_base
op_plus
(paren
id|i
op_star
l_int|8UL
)paren
comma
l_int|0UL
)paren
suffix:semicolon
id|psycho_write
c_func
(paren
id|line_base
op_plus
(paren
id|i
op_star
l_int|8UL
)paren
comma
l_int|0UL
)paren
suffix:semicolon
)brace
multiline_comment|/* OK, state is logged, exit diagnostic mode. */
id|psycho_write
c_func
(paren
id|strbuf-&gt;strbuf_control
comma
id|control
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|j
comma
id|saw_error
comma
id|first
comma
id|last
suffix:semicolon
id|saw_error
op_assign
l_int|0
suffix:semicolon
id|first
op_assign
id|i
op_star
l_int|8
suffix:semicolon
id|last
op_assign
id|first
op_plus
l_int|8
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
id|first
suffix:semicolon
id|j
OL
id|last
suffix:semicolon
id|j
op_increment
)paren
(brace
r_int
r_int
id|errval
op_assign
id|stc_error_buf
(braket
id|j
)braket
suffix:semicolon
r_if
c_cond
(paren
id|errval
op_ne
l_int|0
)paren
(brace
id|saw_error
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PSYCHO%d(PBM%c): STC_ERR(%d)[wr(%d)rd(%d)]&bslash;n&quot;
comma
id|p-&gt;index
comma
(paren
id|is_pbm_a
ques
c_cond
l_char|&squot;A&squot;
suffix:colon
l_char|&squot;B&squot;
)paren
comma
id|j
comma
(paren
id|errval
op_amp
id|PSYCHO_STCERR_WRITE
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
(paren
id|errval
op_amp
id|PSYCHO_STCERR_READ
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|saw_error
op_ne
l_int|0
)paren
(brace
r_int
r_int
id|tagval
op_assign
id|stc_tag_buf
(braket
id|i
)braket
suffix:semicolon
r_int
r_int
id|lineval
op_assign
id|stc_line_buf
(braket
id|i
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PSYCHO%d(PBM%c): STC_TAG(%d)[PA(%016lx)VA(%08lx)V(%d)W(%d)]&bslash;n&quot;
comma
id|p-&gt;index
comma
(paren
id|is_pbm_a
ques
c_cond
l_char|&squot;A&squot;
suffix:colon
l_char|&squot;B&squot;
)paren
comma
id|i
comma
(paren
(paren
id|tagval
op_amp
id|PSYCHO_STCTAG_PPN
)paren
op_rshift
l_int|19UL
)paren
comma
(paren
id|tagval
op_amp
id|PSYCHO_STCTAG_VPN
)paren
comma
(paren
(paren
id|tagval
op_amp
id|PSYCHO_STCTAG_VALID
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
comma
(paren
(paren
id|tagval
op_amp
id|PSYCHO_STCTAG_WRITE
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PSYCHO%d(PBM%c): STC_LINE(%d)[LIDX(%lx)SP(%lx)LADDR(%lx)EP(%lx)&quot;
l_string|&quot;V(%d)FOFN(%d)]&bslash;n&quot;
comma
id|p-&gt;index
comma
(paren
id|is_pbm_a
ques
c_cond
l_char|&squot;A&squot;
suffix:colon
l_char|&squot;B&squot;
)paren
comma
id|i
comma
(paren
(paren
id|lineval
op_amp
id|PSYCHO_STCLINE_LINDX
)paren
op_rshift
l_int|21UL
)paren
comma
(paren
(paren
id|lineval
op_amp
id|PSYCHO_STCLINE_SPTR
)paren
op_rshift
l_int|15UL
)paren
comma
(paren
(paren
id|lineval
op_amp
id|PSYCHO_STCLINE_LADDR
)paren
op_rshift
l_int|8UL
)paren
comma
(paren
(paren
id|lineval
op_amp
id|PSYCHO_STCLINE_EPTR
)paren
op_rshift
l_int|2UL
)paren
comma
(paren
(paren
id|lineval
op_amp
id|PSYCHO_STCLINE_VALID
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
comma
(paren
(paren
id|lineval
op_amp
id|PSYCHO_STCLINE_FOFN
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|stc_buf_lock
)paren
suffix:semicolon
)brace
DECL|function|__psycho_check_stc_error
r_static
r_void
id|__psycho_check_stc_error
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
comma
r_int
r_int
id|afsr
comma
r_int
r_int
id|afar
comma
r_enum
id|psycho_error_type
id|type
)paren
(brace
r_struct
id|pci_pbm_info
op_star
id|pbm
suffix:semicolon
id|pbm
op_assign
op_amp
id|p-&gt;pbm_A
suffix:semicolon
r_if
c_cond
(paren
id|pbm-&gt;stc.strbuf_enabled
)paren
id|__psycho_check_one_stc
c_func
(paren
id|p
comma
id|pbm
comma
l_int|1
)paren
suffix:semicolon
id|pbm
op_assign
op_amp
id|p-&gt;pbm_B
suffix:semicolon
r_if
c_cond
(paren
id|pbm-&gt;stc.strbuf_enabled
)paren
id|__psycho_check_one_stc
c_func
(paren
id|p
comma
id|pbm
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* When an Uncorrectable Error or a PCI Error happens, we&n; * interrogate the IOMMU state to see if it is the cause.&n; */
DECL|macro|PSYCHO_IOMMU_CONTROL
mdefine_line|#define PSYCHO_IOMMU_CONTROL&t;0x0200UL
DECL|macro|PSYCHO_IOMMU_CTRL_RESV
mdefine_line|#define  PSYCHO_IOMMU_CTRL_RESV     0xfffffffff9000000 /* Reserved                      */
DECL|macro|PSYCHO_IOMMU_CTRL_XLTESTAT
mdefine_line|#define  PSYCHO_IOMMU_CTRL_XLTESTAT 0x0000000006000000 /* Translation Error Status      */
DECL|macro|PSYCHO_IOMMU_CTRL_XLTEERR
mdefine_line|#define  PSYCHO_IOMMU_CTRL_XLTEERR  0x0000000001000000 /* Translation Error encountered */
DECL|macro|PSYCHO_IOMMU_CTRL_LCKEN
mdefine_line|#define  PSYCHO_IOMMU_CTRL_LCKEN    0x0000000000800000 /* Enable translation locking    */
DECL|macro|PSYCHO_IOMMU_CTRL_LCKPTR
mdefine_line|#define  PSYCHO_IOMMU_CTRL_LCKPTR   0x0000000000780000 /* Translation lock pointer      */
DECL|macro|PSYCHO_IOMMU_CTRL_TSBSZ
mdefine_line|#define  PSYCHO_IOMMU_CTRL_TSBSZ    0x0000000000070000 /* TSB Size                      */
DECL|macro|PSYCHO_IOMMU_TSBSZ_1K
mdefine_line|#define  PSYCHO_IOMMU_TSBSZ_1K      0x0000000000000000 /* TSB Table 1024 8-byte entries */
DECL|macro|PSYCHO_IOMMU_TSBSZ_2K
mdefine_line|#define  PSYCHO_IOMMU_TSBSZ_2K      0x0000000000010000 /* TSB Table 2048 8-byte entries */
DECL|macro|PSYCHO_IOMMU_TSBSZ_4K
mdefine_line|#define  PSYCHO_IOMMU_TSBSZ_4K      0x0000000000020000 /* TSB Table 4096 8-byte entries */
DECL|macro|PSYCHO_IOMMU_TSBSZ_8K
mdefine_line|#define  PSYCHO_IOMMU_TSBSZ_8K      0x0000000000030000 /* TSB Table 8192 8-byte entries */
DECL|macro|PSYCHO_IOMMU_TSBSZ_16K
mdefine_line|#define  PSYCHO_IOMMU_TSBSZ_16K     0x0000000000040000 /* TSB Table 16k 8-byte entries  */
DECL|macro|PSYCHO_IOMMU_TSBSZ_32K
mdefine_line|#define  PSYCHO_IOMMU_TSBSZ_32K     0x0000000000050000 /* TSB Table 32k 8-byte entries  */
DECL|macro|PSYCHO_IOMMU_TSBSZ_64K
mdefine_line|#define  PSYCHO_IOMMU_TSBSZ_64K     0x0000000000060000 /* TSB Table 64k 8-byte entries  */
DECL|macro|PSYCHO_IOMMU_TSBSZ_128K
mdefine_line|#define  PSYCHO_IOMMU_TSBSZ_128K    0x0000000000070000 /* TSB Table 128k 8-byte entries */
DECL|macro|PSYCHO_IOMMU_CTRL_RESV2
mdefine_line|#define  PSYCHO_IOMMU_CTRL_RESV2    0x000000000000fff8 /* Reserved                      */
DECL|macro|PSYCHO_IOMMU_CTRL_TBWSZ
mdefine_line|#define  PSYCHO_IOMMU_CTRL_TBWSZ    0x0000000000000004 /* Assumed page size, 0=8k 1=64k */
DECL|macro|PSYCHO_IOMMU_CTRL_DENAB
mdefine_line|#define  PSYCHO_IOMMU_CTRL_DENAB    0x0000000000000002 /* Diagnostic mode enable        */
DECL|macro|PSYCHO_IOMMU_CTRL_ENAB
mdefine_line|#define  PSYCHO_IOMMU_CTRL_ENAB     0x0000000000000001 /* IOMMU Enable                  */
DECL|macro|PSYCHO_IOMMU_TSBBASE
mdefine_line|#define PSYCHO_IOMMU_TSBBASE&t;0x0208UL
DECL|macro|PSYCHO_IOMMU_FLUSH
mdefine_line|#define PSYCHO_IOMMU_FLUSH&t;0x0210UL
DECL|macro|PSYCHO_IOMMU_TAG
mdefine_line|#define PSYCHO_IOMMU_TAG&t;0xa580UL
DECL|macro|PSYCHO_IOMMU_TAG_ERRSTS
mdefine_line|#define  PSYCHO_IOMMU_TAG_ERRSTS (0x3UL &lt;&lt; 23UL)
DECL|macro|PSYCHO_IOMMU_TAG_ERR
mdefine_line|#define  PSYCHO_IOMMU_TAG_ERR&t; (0x1UL &lt;&lt; 22UL)
DECL|macro|PSYCHO_IOMMU_TAG_WRITE
mdefine_line|#define  PSYCHO_IOMMU_TAG_WRITE&t; (0x1UL &lt;&lt; 21UL)
DECL|macro|PSYCHO_IOMMU_TAG_STREAM
mdefine_line|#define  PSYCHO_IOMMU_TAG_STREAM (0x1UL &lt;&lt; 20UL)
DECL|macro|PSYCHO_IOMMU_TAG_SIZE
mdefine_line|#define  PSYCHO_IOMMU_TAG_SIZE&t; (0x1UL &lt;&lt; 19UL)
DECL|macro|PSYCHO_IOMMU_TAG_VPAGE
mdefine_line|#define  PSYCHO_IOMMU_TAG_VPAGE&t; 0x7ffffUL
DECL|macro|PSYCHO_IOMMU_DATA
mdefine_line|#define PSYCHO_IOMMU_DATA&t;0xa600UL
DECL|macro|PSYCHO_IOMMU_DATA_VALID
mdefine_line|#define  PSYCHO_IOMMU_DATA_VALID (1UL &lt;&lt; 30UL)
DECL|macro|PSYCHO_IOMMU_DATA_CACHE
mdefine_line|#define  PSYCHO_IOMMU_DATA_CACHE (1UL &lt;&lt; 28UL)
DECL|macro|PSYCHO_IOMMU_DATA_PPAGE
mdefine_line|#define  PSYCHO_IOMMU_DATA_PPAGE 0xfffffffUL
DECL|function|psycho_check_iommu_error
r_static
r_void
id|psycho_check_iommu_error
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
comma
r_int
r_int
id|afsr
comma
r_int
r_int
id|afar
comma
r_enum
id|psycho_error_type
id|type
)paren
(brace
r_int
r_int
id|iommu_tag
(braket
l_int|16
)braket
suffix:semicolon
r_int
r_int
id|iommu_data
(braket
l_int|16
)braket
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u64
id|control
suffix:semicolon
r_int
id|i
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|p-&gt;iommu.lock
comma
id|flags
)paren
suffix:semicolon
id|control
op_assign
id|psycho_read
c_func
(paren
id|p-&gt;iommu.iommu_control
)paren
suffix:semicolon
r_if
c_cond
(paren
id|control
op_amp
id|PSYCHO_IOMMU_CTRL_XLTEERR
)paren
(brace
r_char
op_star
id|type_string
suffix:semicolon
multiline_comment|/* Clear the error encountered bit. */
id|control
op_and_assign
op_complement
id|PSYCHO_IOMMU_CTRL_XLTEERR
suffix:semicolon
id|psycho_write
c_func
(paren
id|p-&gt;iommu.iommu_control
comma
id|control
)paren
suffix:semicolon
r_switch
c_cond
(paren
(paren
id|control
op_amp
id|PSYCHO_IOMMU_CTRL_XLTESTAT
)paren
op_rshift
l_int|25UL
)paren
(brace
r_case
l_int|0
suffix:colon
id|type_string
op_assign
l_string|&quot;Protection Error&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|type_string
op_assign
l_string|&quot;Invalid Error&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|type_string
op_assign
l_string|&quot;TimeOut Error&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
r_default
suffix:colon
id|type_string
op_assign
l_string|&quot;ECC Error&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PSYCHO%d: IOMMU Error, type[%s]&bslash;n&quot;
comma
id|p-&gt;index
comma
id|type_string
)paren
suffix:semicolon
multiline_comment|/* Put the IOMMU into diagnostic mode and probe&n;&t;&t; * it&squot;s TLB for entries with error status.&n;&t;&t; *&n;&t;&t; * It is very possible for another DVMA to occur&n;&t;&t; * while we do this probe, and corrupt the system&n;&t;&t; * further.  But we are so screwed at this point&n;&t;&t; * that we are likely to crash hard anyways, so&n;&t;&t; * get as much diagnostic information to the&n;&t;&t; * console as we can.&n;&t;&t; */
id|psycho_write
c_func
(paren
id|p-&gt;iommu.iommu_control
comma
id|control
op_or
id|PSYCHO_IOMMU_CTRL_DENAB
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|base
op_assign
id|p-&gt;controller_regs
suffix:semicolon
id|iommu_tag
(braket
id|i
)braket
op_assign
id|psycho_read
c_func
(paren
id|base
op_plus
id|PSYCHO_IOMMU_TAG
op_plus
(paren
id|i
op_star
l_int|8UL
)paren
)paren
suffix:semicolon
id|iommu_data
(braket
id|i
)braket
op_assign
id|psycho_read
c_func
(paren
id|base
op_plus
id|PSYCHO_IOMMU_DATA
op_plus
(paren
id|i
op_star
l_int|8UL
)paren
)paren
suffix:semicolon
multiline_comment|/* Now clear out the entry. */
id|psycho_write
c_func
(paren
id|base
op_plus
id|PSYCHO_IOMMU_TAG
op_plus
(paren
id|i
op_star
l_int|8UL
)paren
comma
l_int|0
)paren
suffix:semicolon
id|psycho_write
c_func
(paren
id|base
op_plus
id|PSYCHO_IOMMU_DATA
op_plus
(paren
id|i
op_star
l_int|8UL
)paren
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Leave diagnostic mode. */
id|psycho_write
c_func
(paren
id|p-&gt;iommu.iommu_control
comma
id|control
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|tag
comma
id|data
suffix:semicolon
id|tag
op_assign
id|iommu_tag
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|tag
op_amp
id|PSYCHO_IOMMU_TAG_ERR
)paren
)paren
r_continue
suffix:semicolon
id|data
op_assign
id|iommu_data
(braket
id|i
)braket
suffix:semicolon
r_switch
c_cond
(paren
(paren
id|tag
op_amp
id|PSYCHO_IOMMU_TAG_ERRSTS
)paren
op_rshift
l_int|23UL
)paren
(brace
r_case
l_int|0
suffix:colon
id|type_string
op_assign
l_string|&quot;Protection Error&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|type_string
op_assign
l_string|&quot;Invalid Error&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|type_string
op_assign
l_string|&quot;TimeOut Error&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
r_default
suffix:colon
id|type_string
op_assign
l_string|&quot;ECC Error&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PSYCHO%d: IOMMU TAG(%d)[error(%s) wr(%d) str(%d) sz(%dK) vpg(%08lx)]&bslash;n&quot;
comma
id|p-&gt;index
comma
id|i
comma
id|type_string
comma
(paren
(paren
id|tag
op_amp
id|PSYCHO_IOMMU_TAG_WRITE
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
comma
(paren
(paren
id|tag
op_amp
id|PSYCHO_IOMMU_TAG_STREAM
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
comma
(paren
(paren
id|tag
op_amp
id|PSYCHO_IOMMU_TAG_SIZE
)paren
ques
c_cond
l_int|64
suffix:colon
l_int|8
)paren
comma
(paren
id|tag
op_amp
id|PSYCHO_IOMMU_TAG_VPAGE
)paren
op_lshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PSYCHO%d: IOMMU DATA(%d)[valid(%d) cache(%d) ppg(%016lx)]&bslash;n&quot;
comma
id|p-&gt;index
comma
id|i
comma
(paren
(paren
id|data
op_amp
id|PSYCHO_IOMMU_DATA_VALID
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
comma
(paren
(paren
id|data
op_amp
id|PSYCHO_IOMMU_DATA_CACHE
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
comma
(paren
id|data
op_amp
id|PSYCHO_IOMMU_DATA_PPAGE
)paren
op_lshift
id|PAGE_SHIFT
)paren
suffix:semicolon
)brace
)brace
id|__psycho_check_stc_error
c_func
(paren
id|p
comma
id|afsr
comma
id|afar
comma
id|type
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|p-&gt;iommu.lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Uncorrectable Errors.  Cause of the error and the address are&n; * recorded in the UE_AFSR and UE_AFAR of PSYCHO.  They are errors&n; * relating to UPA interface transactions.&n; */
DECL|macro|PSYCHO_UE_AFSR
mdefine_line|#define PSYCHO_UE_AFSR&t;0x0030UL
DECL|macro|PSYCHO_UEAFSR_PPIO
mdefine_line|#define  PSYCHO_UEAFSR_PPIO&t;0x8000000000000000 /* Primary PIO is cause         */
DECL|macro|PSYCHO_UEAFSR_PDRD
mdefine_line|#define  PSYCHO_UEAFSR_PDRD&t;0x4000000000000000 /* Primary DVMA read is cause   */
DECL|macro|PSYCHO_UEAFSR_PDWR
mdefine_line|#define  PSYCHO_UEAFSR_PDWR&t;0x2000000000000000 /* Primary DVMA write is cause  */
DECL|macro|PSYCHO_UEAFSR_SPIO
mdefine_line|#define  PSYCHO_UEAFSR_SPIO&t;0x1000000000000000 /* Secondary PIO is cause       */
DECL|macro|PSYCHO_UEAFSR_SDRD
mdefine_line|#define  PSYCHO_UEAFSR_SDRD&t;0x0800000000000000 /* Secondary DVMA read is cause */
DECL|macro|PSYCHO_UEAFSR_SDWR
mdefine_line|#define  PSYCHO_UEAFSR_SDWR&t;0x0400000000000000 /* Secondary DVMA write is cause*/
DECL|macro|PSYCHO_UEAFSR_RESV1
mdefine_line|#define  PSYCHO_UEAFSR_RESV1&t;0x03ff000000000000 /* Reserved                     */
DECL|macro|PSYCHO_UEAFSR_BMSK
mdefine_line|#define  PSYCHO_UEAFSR_BMSK&t;0x0000ffff00000000 /* Bytemask of failed transfer  */
DECL|macro|PSYCHO_UEAFSR_DOFF
mdefine_line|#define  PSYCHO_UEAFSR_DOFF&t;0x00000000e0000000 /* Doubleword Offset            */
DECL|macro|PSYCHO_UEAFSR_MID
mdefine_line|#define  PSYCHO_UEAFSR_MID&t;0x000000001f000000 /* UPA MID causing the fault    */
DECL|macro|PSYCHO_UEAFSR_BLK
mdefine_line|#define  PSYCHO_UEAFSR_BLK&t;0x0000000000800000 /* Trans was block operation    */
DECL|macro|PSYCHO_UEAFSR_RESV2
mdefine_line|#define  PSYCHO_UEAFSR_RESV2&t;0x00000000007fffff /* Reserved                     */
DECL|macro|PSYCHO_UE_AFAR
mdefine_line|#define PSYCHO_UE_AFAR&t;0x0038UL
DECL|function|psycho_ue_intr
r_static
r_void
id|psycho_ue_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|pci_controller_info
op_star
id|p
op_assign
id|dev_id
suffix:semicolon
r_int
r_int
id|afsr_reg
op_assign
id|p-&gt;controller_regs
op_plus
id|PSYCHO_UE_AFSR
suffix:semicolon
r_int
r_int
id|afar_reg
op_assign
id|p-&gt;controller_regs
op_plus
id|PSYCHO_UE_AFAR
suffix:semicolon
r_int
r_int
id|afsr
comma
id|afar
comma
id|error_bits
suffix:semicolon
r_int
id|reported
suffix:semicolon
multiline_comment|/* Latch uncorrectable error status. */
id|afar
op_assign
id|psycho_read
c_func
(paren
id|afar_reg
)paren
suffix:semicolon
id|afsr
op_assign
id|psycho_read
c_func
(paren
id|afsr_reg
)paren
suffix:semicolon
multiline_comment|/* Clear the primary/secondary error status bits. */
id|error_bits
op_assign
id|afsr
op_amp
(paren
id|PSYCHO_UEAFSR_PPIO
op_or
id|PSYCHO_UEAFSR_PDRD
op_or
id|PSYCHO_UEAFSR_PDWR
op_or
id|PSYCHO_UEAFSR_SPIO
op_or
id|PSYCHO_UEAFSR_SDRD
op_or
id|PSYCHO_UEAFSR_SDWR
)paren
suffix:semicolon
id|psycho_write
c_func
(paren
id|afsr_reg
comma
id|error_bits
)paren
suffix:semicolon
multiline_comment|/* Log the error. */
id|printk
c_func
(paren
l_string|&quot;PSYCHO%d: Uncorrectable Error, primary error type[%s]&bslash;n&quot;
comma
id|p-&gt;index
comma
(paren
(paren
(paren
id|error_bits
op_amp
id|PSYCHO_UEAFSR_PPIO
)paren
ques
c_cond
l_string|&quot;PIO&quot;
suffix:colon
(paren
(paren
id|error_bits
op_amp
id|PSYCHO_UEAFSR_PDRD
)paren
ques
c_cond
l_string|&quot;DMA Read&quot;
suffix:colon
(paren
(paren
id|error_bits
op_amp
id|PSYCHO_UEAFSR_PDWR
)paren
ques
c_cond
l_string|&quot;DMA Write&quot;
suffix:colon
l_string|&quot;???&quot;
)paren
)paren
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PSYCHO%d: bytemask[%04lx] dword_offset[%lx] UPA_MID[%02lx] was_block(%d)&bslash;n&quot;
comma
id|p-&gt;index
comma
(paren
id|afsr
op_amp
id|PSYCHO_UEAFSR_BMSK
)paren
op_rshift
l_int|32UL
comma
(paren
id|afsr
op_amp
id|PSYCHO_UEAFSR_DOFF
)paren
op_rshift
l_int|29UL
comma
(paren
id|afsr
op_amp
id|PSYCHO_UEAFSR_MID
)paren
op_rshift
l_int|24UL
comma
(paren
(paren
id|afsr
op_amp
id|PSYCHO_UEAFSR_BLK
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PSYCHO%d: UE AFAR [%016lx]&bslash;n&quot;
comma
id|p-&gt;index
comma
id|afar
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PSYCHO%d: UE Secondary errors [&quot;
comma
id|p-&gt;index
)paren
suffix:semicolon
id|reported
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|afsr
op_amp
id|PSYCHO_UEAFSR_SPIO
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(PIO)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|afsr
op_amp
id|PSYCHO_UEAFSR_SDRD
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(DMA Read)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|afsr
op_amp
id|PSYCHO_UEAFSR_SDWR
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(DMA Write)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|reported
)paren
id|printk
c_func
(paren
l_string|&quot;(none)&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;]&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Interrogate IOMMU for error status. */
id|psycho_check_iommu_error
c_func
(paren
id|p
comma
id|afsr
comma
id|afar
comma
id|UE_ERR
)paren
suffix:semicolon
)brace
multiline_comment|/* Correctable Errors. */
DECL|macro|PSYCHO_CE_AFSR
mdefine_line|#define PSYCHO_CE_AFSR&t;0x0040UL
DECL|macro|PSYCHO_CEAFSR_PPIO
mdefine_line|#define  PSYCHO_CEAFSR_PPIO&t;0x8000000000000000 /* Primary PIO is cause         */
DECL|macro|PSYCHO_CEAFSR_PDRD
mdefine_line|#define  PSYCHO_CEAFSR_PDRD&t;0x4000000000000000 /* Primary DVMA read is cause   */
DECL|macro|PSYCHO_CEAFSR_PDWR
mdefine_line|#define  PSYCHO_CEAFSR_PDWR&t;0x2000000000000000 /* Primary DVMA write is cause  */
DECL|macro|PSYCHO_CEAFSR_SPIO
mdefine_line|#define  PSYCHO_CEAFSR_SPIO&t;0x1000000000000000 /* Secondary PIO is cause       */
DECL|macro|PSYCHO_CEAFSR_SDRD
mdefine_line|#define  PSYCHO_CEAFSR_SDRD&t;0x0800000000000000 /* Secondary DVMA read is cause */
DECL|macro|PSYCHO_CEAFSR_SDWR
mdefine_line|#define  PSYCHO_CEAFSR_SDWR&t;0x0400000000000000 /* Secondary DVMA write is cause*/
DECL|macro|PSYCHO_CEAFSR_RESV1
mdefine_line|#define  PSYCHO_CEAFSR_RESV1&t;0x0300000000000000 /* Reserved                     */
DECL|macro|PSYCHO_CEAFSR_ESYND
mdefine_line|#define  PSYCHO_CEAFSR_ESYND&t;0x00ff000000000000 /* Syndrome Bits                */
DECL|macro|PSYCHO_CEAFSR_BMSK
mdefine_line|#define  PSYCHO_CEAFSR_BMSK&t;0x0000ffff00000000 /* Bytemask of failed transfer  */
DECL|macro|PSYCHO_CEAFSR_DOFF
mdefine_line|#define  PSYCHO_CEAFSR_DOFF&t;0x00000000e0000000 /* Double Offset                */
DECL|macro|PSYCHO_CEAFSR_MID
mdefine_line|#define  PSYCHO_CEAFSR_MID&t;0x000000001f000000 /* UPA MID causing the fault    */
DECL|macro|PSYCHO_CEAFSR_BLK
mdefine_line|#define  PSYCHO_CEAFSR_BLK&t;0x0000000000800000 /* Trans was block operation    */
DECL|macro|PSYCHO_CEAFSR_RESV2
mdefine_line|#define  PSYCHO_CEAFSR_RESV2&t;0x00000000007fffff /* Reserved                     */
DECL|macro|PSYCHO_CE_AFAR
mdefine_line|#define PSYCHO_CE_AFAR&t;0x0040UL
DECL|function|psycho_ce_intr
r_static
r_void
id|psycho_ce_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|pci_controller_info
op_star
id|p
op_assign
id|dev_id
suffix:semicolon
r_int
r_int
id|afsr_reg
op_assign
id|p-&gt;controller_regs
op_plus
id|PSYCHO_CE_AFSR
suffix:semicolon
r_int
r_int
id|afar_reg
op_assign
id|p-&gt;controller_regs
op_plus
id|PSYCHO_CE_AFAR
suffix:semicolon
r_int
r_int
id|afsr
comma
id|afar
comma
id|error_bits
suffix:semicolon
r_int
id|reported
suffix:semicolon
multiline_comment|/* Latch error status. */
id|afar
op_assign
id|psycho_read
c_func
(paren
id|afar_reg
)paren
suffix:semicolon
id|afsr
op_assign
id|psycho_read
c_func
(paren
id|afsr_reg
)paren
suffix:semicolon
multiline_comment|/* Clear primary/secondary error status bits. */
id|error_bits
op_assign
id|afsr
op_amp
(paren
id|PSYCHO_CEAFSR_PPIO
op_or
id|PSYCHO_CEAFSR_PDRD
op_or
id|PSYCHO_CEAFSR_PDWR
op_or
id|PSYCHO_CEAFSR_SPIO
op_or
id|PSYCHO_CEAFSR_SDRD
op_or
id|PSYCHO_CEAFSR_SDWR
)paren
suffix:semicolon
id|psycho_write
c_func
(paren
id|afsr_reg
comma
id|error_bits
)paren
suffix:semicolon
multiline_comment|/* Log the error. */
id|printk
c_func
(paren
l_string|&quot;PSYCHO%d: Correctable Error, primary error type[%s]&bslash;n&quot;
comma
id|p-&gt;index
comma
(paren
(paren
(paren
id|error_bits
op_amp
id|PSYCHO_CEAFSR_PPIO
)paren
ques
c_cond
l_string|&quot;PIO&quot;
suffix:colon
(paren
(paren
id|error_bits
op_amp
id|PSYCHO_CEAFSR_PDRD
)paren
ques
c_cond
l_string|&quot;DMA Read&quot;
suffix:colon
(paren
(paren
id|error_bits
op_amp
id|PSYCHO_CEAFSR_PDWR
)paren
ques
c_cond
l_string|&quot;DMA Write&quot;
suffix:colon
l_string|&quot;???&quot;
)paren
)paren
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* XXX Use syndrome and afar to print out module string just like&n;&t; * XXX UDB CE trap handler does... -DaveM&n;&t; */
id|printk
c_func
(paren
l_string|&quot;PSYCHO%d: syndrome[%02lx] bytemask[%04lx] dword_offset[%lx] &quot;
l_string|&quot;UPA_MID[%02lx] was_block(%d)&bslash;n&quot;
comma
id|p-&gt;index
comma
(paren
id|afsr
op_amp
id|PSYCHO_CEAFSR_ESYND
)paren
op_rshift
l_int|48UL
comma
(paren
id|afsr
op_amp
id|PSYCHO_CEAFSR_BMSK
)paren
op_rshift
l_int|32UL
comma
(paren
id|afsr
op_amp
id|PSYCHO_CEAFSR_DOFF
)paren
op_rshift
l_int|29UL
comma
(paren
id|afsr
op_amp
id|PSYCHO_CEAFSR_MID
)paren
op_rshift
l_int|24UL
comma
(paren
(paren
id|afsr
op_amp
id|PSYCHO_CEAFSR_BLK
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PSYCHO%d: CE AFAR [%016lx]&bslash;n&quot;
comma
id|p-&gt;index
comma
id|afar
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PSYCHO%d: CE Secondary errors [&quot;
comma
id|p-&gt;index
)paren
suffix:semicolon
id|reported
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|afsr
op_amp
id|PSYCHO_CEAFSR_SPIO
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(PIO)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|afsr
op_amp
id|PSYCHO_CEAFSR_SDRD
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(DMA Read)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|afsr
op_amp
id|PSYCHO_CEAFSR_SDWR
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(DMA Write)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|reported
)paren
id|printk
c_func
(paren
l_string|&quot;(none)&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;]&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* PCI Errors.  They are signalled by the PCI bus module since they&n; * are assosciated with a specific bus segment.&n; */
DECL|macro|PSYCHO_PCI_AFSR_A
mdefine_line|#define PSYCHO_PCI_AFSR_A&t;0x2010UL
DECL|macro|PSYCHO_PCI_AFSR_B
mdefine_line|#define PSYCHO_PCI_AFSR_B&t;0x4010UL
DECL|macro|PSYCHO_PCIAFSR_PMA
mdefine_line|#define  PSYCHO_PCIAFSR_PMA&t;0x8000000000000000 /* Primary Master Abort Error   */
DECL|macro|PSYCHO_PCIAFSR_PTA
mdefine_line|#define  PSYCHO_PCIAFSR_PTA&t;0x4000000000000000 /* Primary Target Abort Error   */
DECL|macro|PSYCHO_PCIAFSR_PRTRY
mdefine_line|#define  PSYCHO_PCIAFSR_PRTRY&t;0x2000000000000000 /* Primary Excessive Retries    */
DECL|macro|PSYCHO_PCIAFSR_PPERR
mdefine_line|#define  PSYCHO_PCIAFSR_PPERR&t;0x1000000000000000 /* Primary Parity Error         */
DECL|macro|PSYCHO_PCIAFSR_SMA
mdefine_line|#define  PSYCHO_PCIAFSR_SMA&t;0x0800000000000000 /* Secondary Master Abort Error */
DECL|macro|PSYCHO_PCIAFSR_STA
mdefine_line|#define  PSYCHO_PCIAFSR_STA&t;0x0400000000000000 /* Secondary Target Abort Error */
DECL|macro|PSYCHO_PCIAFSR_SRTRY
mdefine_line|#define  PSYCHO_PCIAFSR_SRTRY&t;0x0200000000000000 /* Secondary Excessive Retries  */
DECL|macro|PSYCHO_PCIAFSR_SPERR
mdefine_line|#define  PSYCHO_PCIAFSR_SPERR&t;0x0100000000000000 /* Secondary Parity Error       */
DECL|macro|PSYCHO_PCIAFSR_RESV1
mdefine_line|#define  PSYCHO_PCIAFSR_RESV1&t;0x00ff000000000000 /* Reserved                     */
DECL|macro|PSYCHO_PCIAFSR_BMSK
mdefine_line|#define  PSYCHO_PCIAFSR_BMSK&t;0x0000ffff00000000 /* Bytemask of failed transfer  */
DECL|macro|PSYCHO_PCIAFSR_BLK
mdefine_line|#define  PSYCHO_PCIAFSR_BLK&t;0x0000000080000000 /* Trans was block operation    */
DECL|macro|PSYCHO_PCIAFSR_RESV2
mdefine_line|#define  PSYCHO_PCIAFSR_RESV2&t;0x0000000040000000 /* Reserved                     */
DECL|macro|PSYCHO_PCIAFSR_MID
mdefine_line|#define  PSYCHO_PCIAFSR_MID&t;0x000000003e000000 /* MID causing the error        */
DECL|macro|PSYCHO_PCIAFSR_RESV3
mdefine_line|#define  PSYCHO_PCIAFSR_RESV3&t;0x0000000001ffffff /* Reserved                     */
DECL|macro|PSYCHO_PCI_AFAR_A
mdefine_line|#define PSYCHO_PCI_AFAR_A&t;0x2018UL
DECL|macro|PSYCHO_PCI_AFAR_B
mdefine_line|#define PSYCHO_PCI_AFAR_B&t;0x4018UL
DECL|function|psycho_pcierr_intr
r_static
r_void
id|psycho_pcierr_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|pci_pbm_info
op_star
id|pbm
op_assign
id|dev_id
suffix:semicolon
r_struct
id|pci_controller_info
op_star
id|p
op_assign
id|pbm-&gt;parent
suffix:semicolon
r_int
r_int
id|afsr_reg
comma
id|afar_reg
suffix:semicolon
r_int
r_int
id|afsr
comma
id|afar
comma
id|error_bits
suffix:semicolon
r_int
id|is_pbm_a
comma
id|reported
suffix:semicolon
id|is_pbm_a
op_assign
(paren
id|pbm
op_eq
op_amp
id|pbm-&gt;parent-&gt;pbm_A
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_pbm_a
)paren
(brace
id|afsr_reg
op_assign
id|p-&gt;controller_regs
op_plus
id|PSYCHO_PCI_AFSR_A
suffix:semicolon
id|afar_reg
op_assign
id|p-&gt;controller_regs
op_plus
id|PSYCHO_PCI_AFAR_A
suffix:semicolon
)brace
r_else
(brace
id|afsr_reg
op_assign
id|p-&gt;controller_regs
op_plus
id|PSYCHO_PCI_AFSR_B
suffix:semicolon
id|afar_reg
op_assign
id|p-&gt;controller_regs
op_plus
id|PSYCHO_PCI_AFAR_B
suffix:semicolon
)brace
multiline_comment|/* Latch error status. */
id|afar
op_assign
id|psycho_read
c_func
(paren
id|afar_reg
)paren
suffix:semicolon
id|afsr
op_assign
id|psycho_read
c_func
(paren
id|afsr_reg
)paren
suffix:semicolon
multiline_comment|/* Clear primary/secondary error status bits. */
id|error_bits
op_assign
id|afsr
op_amp
(paren
id|PSYCHO_PCIAFSR_PMA
op_or
id|PSYCHO_PCIAFSR_PTA
op_or
id|PSYCHO_PCIAFSR_PRTRY
op_or
id|PSYCHO_PCIAFSR_PPERR
op_or
id|PSYCHO_PCIAFSR_SMA
op_or
id|PSYCHO_PCIAFSR_STA
op_or
id|PSYCHO_PCIAFSR_SRTRY
op_or
id|PSYCHO_PCIAFSR_SPERR
)paren
suffix:semicolon
id|psycho_write
c_func
(paren
id|afsr_reg
comma
id|error_bits
)paren
suffix:semicolon
multiline_comment|/* Log the error. */
id|printk
c_func
(paren
l_string|&quot;PSYCHO%d(PBM%c): PCI Error, primary error type[%s]&bslash;n&quot;
comma
id|p-&gt;index
comma
(paren
id|is_pbm_a
ques
c_cond
l_char|&squot;A&squot;
suffix:colon
l_char|&squot;B&squot;
)paren
comma
(paren
(paren
(paren
id|error_bits
op_amp
id|PSYCHO_PCIAFSR_PMA
)paren
ques
c_cond
l_string|&quot;Master Abort&quot;
suffix:colon
(paren
(paren
id|error_bits
op_amp
id|PSYCHO_PCIAFSR_PTA
)paren
ques
c_cond
l_string|&quot;Target Abort&quot;
suffix:colon
(paren
(paren
id|error_bits
op_amp
id|PSYCHO_PCIAFSR_PRTRY
)paren
ques
c_cond
l_string|&quot;Excessive Retries&quot;
suffix:colon
(paren
(paren
id|error_bits
op_amp
id|PSYCHO_PCIAFSR_PPERR
)paren
ques
c_cond
l_string|&quot;Parity Error&quot;
suffix:colon
l_string|&quot;???&quot;
)paren
)paren
)paren
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PSYCHO%d(PBM%c): bytemask[%04lx] UPA_MID[%02lx] was_block(%d)&bslash;n&quot;
comma
id|p-&gt;index
comma
(paren
id|is_pbm_a
ques
c_cond
l_char|&squot;A&squot;
suffix:colon
l_char|&squot;B&squot;
)paren
comma
(paren
id|afsr
op_amp
id|PSYCHO_PCIAFSR_BMSK
)paren
op_rshift
l_int|32UL
comma
(paren
id|afsr
op_amp
id|PSYCHO_PCIAFSR_MID
)paren
op_rshift
l_int|25UL
comma
(paren
id|afsr
op_amp
id|PSYCHO_PCIAFSR_BLK
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PSYCHO%d(PBM%c): PCI AFAR [%016lx]&bslash;n&quot;
comma
id|p-&gt;index
comma
(paren
id|is_pbm_a
ques
c_cond
l_char|&squot;A&squot;
suffix:colon
l_char|&squot;B&squot;
)paren
comma
id|afar
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PSYCHO%d(PBM%c): PCI Secondary errors [&quot;
comma
id|p-&gt;index
comma
(paren
id|is_pbm_a
ques
c_cond
l_char|&squot;A&squot;
suffix:colon
l_char|&squot;B&squot;
)paren
)paren
suffix:semicolon
id|reported
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|afsr
op_amp
id|PSYCHO_PCIAFSR_SMA
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(Master Abort)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|afsr
op_amp
id|PSYCHO_PCIAFSR_STA
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(Target Abort)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|afsr
op_amp
id|PSYCHO_PCIAFSR_SRTRY
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(Excessive Retries)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|afsr
op_amp
id|PSYCHO_PCIAFSR_SPERR
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(Parity Error)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|reported
)paren
id|printk
c_func
(paren
l_string|&quot;(none)&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;]&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* For the error types shown, scan PBM&squot;s PCI bus for devices&n;&t; * which have logged that error type.&n;&t; */
multiline_comment|/* If we see a Target Abort, this could be the result of an&n;&t; * IOMMU translation error of some sort.  It is extremely&n;&t; * useful to log this information as usually it indicates&n;&t; * a bug in the IOMMU support code or a PCI device driver.&n;&t; */
r_if
c_cond
(paren
id|error_bits
op_amp
(paren
id|PSYCHO_PCIAFSR_PTA
op_or
id|PSYCHO_PCIAFSR_STA
)paren
)paren
(brace
id|psycho_check_iommu_error
c_func
(paren
id|p
comma
id|afsr
comma
id|afar
comma
id|PCI_ERR
)paren
suffix:semicolon
id|pci_scan_for_target_abort
c_func
(paren
id|p
comma
id|pbm
comma
id|pbm-&gt;pci_bus
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|error_bits
op_amp
(paren
id|PSYCHO_PCIAFSR_PMA
op_or
id|PSYCHO_PCIAFSR_SMA
)paren
)paren
id|pci_scan_for_master_abort
c_func
(paren
id|p
comma
id|pbm
comma
id|pbm-&gt;pci_bus
)paren
suffix:semicolon
multiline_comment|/* For excessive retries, PSYCHO/PBM will abort the device&n;&t; * and there is no way to specifically check for excessive&n;&t; * retries in the config space status registers.  So what&n;&t; * we hope is that we&squot;ll catch it via the master/target&n;&t; * abort events.&n;&t; */
r_if
c_cond
(paren
id|error_bits
op_amp
(paren
id|PSYCHO_PCIAFSR_PPERR
op_or
id|PSYCHO_PCIAFSR_SPERR
)paren
)paren
id|pci_scan_for_parity_error
c_func
(paren
id|p
comma
id|pbm
comma
id|pbm-&gt;pci_bus
)paren
suffix:semicolon
)brace
multiline_comment|/* XXX What about PowerFail/PowerManagement??? -DaveM */
DECL|macro|PSYCHO_ECC_CTRL
mdefine_line|#define PSYCHO_ECC_CTRL&t;&t;0x0020
DECL|macro|PSYCHO_ECCCTRL_EE
mdefine_line|#define  PSYCHO_ECCCTRL_EE&t; 0x8000000000000000 /* Enable ECC Checking */
DECL|macro|PSYCHO_ECCCTRL_UE
mdefine_line|#define  PSYCHO_ECCCTRL_UE&t; 0x4000000000000000 /* Enable UE Interrupts */
DECL|macro|PSYCHO_ECCCTRL_CE
mdefine_line|#define  PSYCHO_ECCCTRL_CE&t; 0x2000000000000000 /* Enable CE INterrupts */
DECL|macro|PSYCHO_UE_INO
mdefine_line|#define PSYCHO_UE_INO&t;&t;0x2e
DECL|macro|PSYCHO_CE_INO
mdefine_line|#define PSYCHO_CE_INO&t;&t;0x2f
DECL|macro|PSYCHO_PCIERR_A_INO
mdefine_line|#define PSYCHO_PCIERR_A_INO&t;0x30
DECL|macro|PSYCHO_PCIERR_B_INO
mdefine_line|#define PSYCHO_PCIERR_B_INO&t;0x31
DECL|function|psycho_register_error_handlers
r_static
r_void
id|__init
id|psycho_register_error_handlers
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
)paren
(brace
r_int
r_int
id|base
op_assign
id|p-&gt;controller_regs
suffix:semicolon
r_int
r_int
id|irq
comma
id|portid
op_assign
id|p-&gt;portid
suffix:semicolon
id|u64
id|tmp
suffix:semicolon
multiline_comment|/* Build IRQs and register handlers. */
id|irq
op_assign
id|psycho_irq_build
c_func
(paren
id|p
comma
l_int|NULL
comma
(paren
id|portid
op_lshift
l_int|6
)paren
op_or
id|PSYCHO_UE_INO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|psycho_ue_intr
comma
id|SA_SHIRQ
comma
l_string|&quot;PSYCHO UE&quot;
comma
id|p
)paren
OL
l_int|0
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;PSYCHO%d: Cannot register UE interrupt.&bslash;n&quot;
comma
id|p-&gt;index
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|irq
op_assign
id|psycho_irq_build
c_func
(paren
id|p
comma
l_int|NULL
comma
(paren
id|portid
op_lshift
l_int|6
)paren
op_or
id|PSYCHO_CE_INO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|psycho_ce_intr
comma
id|SA_SHIRQ
comma
l_string|&quot;PSYCHO CE&quot;
comma
id|p
)paren
OL
l_int|0
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;PSYCHO%d: Cannot register CE interrupt.&bslash;n&quot;
comma
id|p-&gt;index
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|irq
op_assign
id|psycho_irq_build
c_func
(paren
id|p
comma
l_int|NULL
comma
(paren
id|portid
op_lshift
l_int|6
)paren
op_or
id|PSYCHO_PCIERR_A_INO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|psycho_pcierr_intr
comma
id|SA_SHIRQ
comma
l_string|&quot;PSYCHO PCIERR&quot;
comma
op_amp
id|p-&gt;pbm_A
)paren
OL
l_int|0
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;PSYCHO%d(PBMA): Cannot register PciERR interrupt.&bslash;n&quot;
comma
id|p-&gt;index
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|irq
op_assign
id|psycho_irq_build
c_func
(paren
id|p
comma
l_int|NULL
comma
(paren
id|portid
op_lshift
l_int|6
)paren
op_or
id|PSYCHO_PCIERR_B_INO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|psycho_pcierr_intr
comma
id|SA_SHIRQ
comma
l_string|&quot;PSYCHO PCIERR&quot;
comma
op_amp
id|p-&gt;pbm_B
)paren
OL
l_int|0
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;PSYCHO%d(PBMB): Cannot register PciERR interrupt.&bslash;n&quot;
comma
id|p-&gt;index
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Enable UE and CE interrupts for controller. */
id|psycho_write
c_func
(paren
id|base
op_plus
id|PSYCHO_ECC_CTRL
comma
(paren
id|PSYCHO_ECCCTRL_EE
op_or
id|PSYCHO_ECCCTRL_UE
op_or
id|PSYCHO_ECCCTRL_CE
)paren
)paren
suffix:semicolon
multiline_comment|/* Enable PCI Error interrupts and clear error&n;&t; * bits for each PBM.&n;&t; */
id|tmp
op_assign
id|psycho_read
c_func
(paren
id|base
op_plus
id|PSYCHO_PCIA_CTRL
)paren
suffix:semicolon
id|tmp
op_or_assign
(paren
id|PSYCHO_PCICTRL_SBH_ERR
op_or
id|PSYCHO_PCICTRL_SERR
op_or
id|PSYCHO_PCICTRL_SBH_INT
op_or
id|PSYCHO_PCICTRL_EEN
)paren
suffix:semicolon
id|psycho_write
c_func
(paren
id|base
op_plus
id|PSYCHO_PCIA_CTRL
comma
id|tmp
)paren
suffix:semicolon
id|tmp
op_assign
id|psycho_read
c_func
(paren
id|base
op_plus
id|PSYCHO_PCIB_CTRL
)paren
suffix:semicolon
id|tmp
op_or_assign
(paren
id|PSYCHO_PCICTRL_SBH_ERR
op_or
id|PSYCHO_PCICTRL_SERR
op_or
id|PSYCHO_PCICTRL_SBH_INT
op_or
id|PSYCHO_PCICTRL_EEN
)paren
suffix:semicolon
id|psycho_write
c_func
(paren
id|base
op_plus
id|PSYCHO_PCIB_CTRL
comma
id|tmp
)paren
suffix:semicolon
)brace
multiline_comment|/* PSYCHO boot time probing and initialization. */
DECL|function|psycho_resource_adjust
r_static
r_void
id|__init
id|psycho_resource_adjust
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_struct
id|resource
op_star
id|res
comma
r_struct
id|resource
op_star
id|root
)paren
(brace
id|res-&gt;start
op_add_assign
id|root-&gt;start
suffix:semicolon
id|res-&gt;end
op_add_assign
id|root-&gt;start
suffix:semicolon
)brace
DECL|function|psycho_base_address_update
r_static
r_void
id|__init
id|psycho_base_address_update
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
id|resource
)paren
(brace
r_struct
id|pcidev_cookie
op_star
id|pcp
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
r_struct
id|pci_pbm_info
op_star
id|pbm
op_assign
id|pcp-&gt;pbm
suffix:semicolon
r_struct
id|resource
op_star
id|res
comma
op_star
id|root
suffix:semicolon
id|u32
id|reg
suffix:semicolon
r_int
id|where
comma
id|size
comma
id|is_64bit
suffix:semicolon
id|res
op_assign
op_amp
id|pdev-&gt;resource
(braket
id|resource
)braket
suffix:semicolon
id|where
op_assign
id|PCI_BASE_ADDRESS_0
op_plus
(paren
id|resource
op_star
l_int|4
)paren
suffix:semicolon
id|is_64bit
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|res-&gt;flags
op_amp
id|IORESOURCE_IO
)paren
id|root
op_assign
op_amp
id|pbm-&gt;io_space
suffix:semicolon
r_else
(brace
id|root
op_assign
op_amp
id|pbm-&gt;mem_space
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res-&gt;flags
op_amp
id|PCI_BASE_ADDRESS_MEM_TYPE_MASK
)paren
op_eq
id|PCI_BASE_ADDRESS_MEM_TYPE_64
)paren
id|is_64bit
op_assign
l_int|1
suffix:semicolon
)brace
id|size
op_assign
id|res-&gt;end
op_minus
id|res-&gt;start
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|pdev
comma
id|where
comma
op_amp
id|reg
)paren
suffix:semicolon
id|reg
op_assign
(paren
(paren
id|reg
op_amp
id|size
)paren
op_or
(paren
(paren
(paren
id|u32
)paren
(paren
id|res-&gt;start
op_minus
id|root-&gt;start
)paren
)paren
op_amp
op_complement
id|size
)paren
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|pdev
comma
id|where
comma
id|reg
)paren
suffix:semicolon
multiline_comment|/* This knows that the upper 32-bits of the address&n;&t; * must be zero.  Our PCI common layer enforces this.&n;&t; */
r_if
c_cond
(paren
id|is_64bit
)paren
id|pci_write_config_dword
c_func
(paren
id|pdev
comma
id|where
op_plus
l_int|4
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* We have to do the config space accesses by hand, thus... */
DECL|macro|PBM_BRIDGE_BUS
mdefine_line|#define PBM_BRIDGE_BUS&t;&t;0x40
DECL|macro|PBM_BRIDGE_SUBORDINATE
mdefine_line|#define PBM_BRIDGE_SUBORDINATE&t;0x41
DECL|function|pbm_renumber
r_static
r_void
id|__init
id|pbm_renumber
c_func
(paren
r_struct
id|pci_pbm_info
op_star
id|pbm
comma
id|u8
id|orig_busno
)paren
(brace
id|u8
op_star
id|addr
comma
id|busno
suffix:semicolon
r_int
id|nbus
suffix:semicolon
id|busno
op_assign
id|pci_highest_busnum
suffix:semicolon
id|nbus
op_assign
id|pbm-&gt;pci_last_busno
op_minus
id|pbm-&gt;pci_first_busno
suffix:semicolon
id|addr
op_assign
id|psycho_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|orig_busno
comma
l_int|0
comma
id|PBM_BRIDGE_BUS
)paren
suffix:semicolon
id|pci_config_write8
c_func
(paren
id|addr
comma
id|busno
)paren
suffix:semicolon
id|addr
op_assign
id|psycho_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|busno
comma
l_int|0
comma
id|PBM_BRIDGE_SUBORDINATE
)paren
suffix:semicolon
id|pci_config_write8
c_func
(paren
id|addr
comma
id|busno
op_plus
id|nbus
)paren
suffix:semicolon
id|pbm-&gt;pci_first_busno
op_assign
id|busno
suffix:semicolon
id|pbm-&gt;pci_last_busno
op_assign
id|busno
op_plus
id|nbus
suffix:semicolon
id|pci_highest_busnum
op_assign
id|busno
op_plus
id|nbus
op_plus
l_int|1
suffix:semicolon
r_do
(brace
id|pci_bus2pbm
(braket
id|busno
op_increment
)braket
op_assign
id|pbm
suffix:semicolon
)brace
r_while
c_loop
(paren
id|nbus
op_decrement
)paren
suffix:semicolon
)brace
multiline_comment|/* We have to do the config space accesses by hand here since&n; * the pci_bus2pbm array is not ready yet.&n; */
DECL|function|pbm_pci_bridge_renumber
r_static
r_void
id|__init
id|pbm_pci_bridge_renumber
c_func
(paren
r_struct
id|pci_pbm_info
op_star
id|pbm
comma
id|u8
id|busno
)paren
(brace
id|u32
id|devfn
comma
id|l
comma
r_class
suffix:semicolon
id|u8
id|hdr_type
suffix:semicolon
r_int
id|is_multi
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|devfn
op_assign
l_int|0
suffix:semicolon
id|devfn
OL
l_int|0xff
suffix:semicolon
op_increment
id|devfn
)paren
(brace
id|u32
op_star
id|dwaddr
suffix:semicolon
id|u8
op_star
id|baddr
suffix:semicolon
r_if
c_cond
(paren
id|PCI_FUNC
c_func
(paren
id|devfn
)paren
op_ne
l_int|0
op_logical_and
id|is_multi
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
multiline_comment|/* Anything there? */
id|dwaddr
op_assign
id|psycho_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|busno
comma
id|devfn
comma
id|PCI_VENDOR_ID
)paren
suffix:semicolon
id|l
op_assign
l_int|0xffffffff
suffix:semicolon
id|pci_config_read32
c_func
(paren
id|dwaddr
comma
op_amp
id|l
)paren
suffix:semicolon
r_if
c_cond
(paren
id|l
op_eq
l_int|0xffffffff
op_logical_or
id|l
op_eq
l_int|0x00000000
op_logical_or
id|l
op_eq
l_int|0x0000ffff
op_logical_or
id|l
op_eq
l_int|0xffff0000
)paren
(brace
id|is_multi
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|baddr
op_assign
id|psycho_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|busno
comma
id|devfn
comma
id|PCI_HEADER_TYPE
)paren
suffix:semicolon
id|pci_config_read8
c_func
(paren
id|baddr
comma
op_amp
id|hdr_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|PCI_FUNC
c_func
(paren
id|devfn
)paren
op_eq
l_int|0
)paren
id|is_multi
op_assign
id|hdr_type
op_amp
l_int|0x80
suffix:semicolon
id|dwaddr
op_assign
id|psycho_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|busno
comma
id|devfn
comma
id|PCI_CLASS_REVISION
)paren
suffix:semicolon
r_class
op_assign
l_int|0xffffffff
suffix:semicolon
id|pci_config_read32
c_func
(paren
id|dwaddr
comma
op_amp
r_class
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_class
op_rshift
l_int|16
)paren
op_eq
id|PCI_CLASS_BRIDGE_PCI
)paren
(brace
id|u32
id|buses
op_assign
l_int|0xffffffff
suffix:semicolon
id|dwaddr
op_assign
id|psycho_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|busno
comma
id|devfn
comma
id|PCI_PRIMARY_BUS
)paren
suffix:semicolon
id|pci_config_read32
c_func
(paren
id|dwaddr
comma
op_amp
id|buses
)paren
suffix:semicolon
id|pbm_pci_bridge_renumber
c_func
(paren
id|pbm
comma
(paren
id|buses
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|buses
op_and_assign
l_int|0xff000000
suffix:semicolon
id|pci_config_write32
c_func
(paren
id|dwaddr
comma
id|buses
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|pbm_bridge_reconfigure
r_static
r_void
id|__init
id|pbm_bridge_reconfigure
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
)paren
(brace
r_struct
id|pci_pbm_info
op_star
id|pbm
suffix:semicolon
id|u8
op_star
id|addr
suffix:semicolon
multiline_comment|/* Clear out primary/secondary/subordinate bus numbers on&n;&t; * all PCI-to-PCI bridges under each PBM.  The generic bus&n;&t; * probing will fix them up.&n;&t; */
id|pbm_pci_bridge_renumber
c_func
(paren
op_amp
id|p-&gt;pbm_B
comma
id|p-&gt;pbm_B.pci_first_busno
)paren
suffix:semicolon
id|pbm_pci_bridge_renumber
c_func
(paren
op_amp
id|p-&gt;pbm_A
comma
id|p-&gt;pbm_A.pci_first_busno
)paren
suffix:semicolon
multiline_comment|/* Move PBM A out of the way. */
id|pbm
op_assign
op_amp
id|p-&gt;pbm_A
suffix:semicolon
id|addr
op_assign
id|psycho_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|pbm-&gt;pci_first_busno
comma
l_int|0
comma
id|PBM_BRIDGE_BUS
)paren
suffix:semicolon
id|pci_config_write8
c_func
(paren
id|addr
comma
l_int|0xff
)paren
suffix:semicolon
id|addr
op_assign
id|psycho_pci_config_mkaddr
c_func
(paren
id|pbm
comma
l_int|0xff
comma
l_int|0
comma
id|PBM_BRIDGE_SUBORDINATE
)paren
suffix:semicolon
id|pci_config_write8
c_func
(paren
id|addr
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Now we can safely renumber both PBMs. */
id|pbm_renumber
c_func
(paren
op_amp
id|p-&gt;pbm_B
comma
id|p-&gt;pbm_B.pci_first_busno
)paren
suffix:semicolon
id|pbm_renumber
c_func
(paren
op_amp
id|p-&gt;pbm_A
comma
l_int|0xff
)paren
suffix:semicolon
)brace
DECL|function|pbm_config_busmastering
r_static
r_void
id|__init
id|pbm_config_busmastering
c_func
(paren
r_struct
id|pci_pbm_info
op_star
id|pbm
)paren
(brace
id|u8
op_star
id|addr
suffix:semicolon
multiline_comment|/* Set cache-line size to 64 bytes, this is actually&n;&t; * a nop but I do it for completeness.&n;&t; */
id|addr
op_assign
id|psycho_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|pbm-&gt;pci_first_busno
comma
l_int|0
comma
id|PCI_CACHE_LINE_SIZE
)paren
suffix:semicolon
id|pci_config_write8
c_func
(paren
id|addr
comma
l_int|64
op_div
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
multiline_comment|/* Set PBM latency timer to 64 PCI clocks. */
id|addr
op_assign
id|psycho_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|pbm-&gt;pci_first_busno
comma
l_int|0
comma
id|PCI_LATENCY_TIMER
)paren
suffix:semicolon
id|pci_config_write8
c_func
(paren
id|addr
comma
l_int|64
)paren
suffix:semicolon
)brace
DECL|function|pbm_scan_bus
r_static
r_void
id|__init
id|pbm_scan_bus
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
comma
r_struct
id|pci_pbm_info
op_star
id|pbm
)paren
(brace
id|pbm-&gt;pci_bus
op_assign
id|pci_scan_bus
c_func
(paren
id|pbm-&gt;pci_first_busno
comma
id|p-&gt;pci_ops
comma
id|pbm
)paren
suffix:semicolon
id|pci_fill_in_pbm_cookies
c_func
(paren
id|pbm-&gt;pci_bus
comma
id|pbm
comma
id|pbm-&gt;prom_node
)paren
suffix:semicolon
id|pci_record_assignments
c_func
(paren
id|pbm
comma
id|pbm-&gt;pci_bus
)paren
suffix:semicolon
id|pci_assign_unassigned
c_func
(paren
id|pbm
comma
id|pbm-&gt;pci_bus
)paren
suffix:semicolon
id|pci_fixup_irq
c_func
(paren
id|pbm
comma
id|pbm-&gt;pci_bus
)paren
suffix:semicolon
id|pci_determine_66mhz_disposition
c_func
(paren
id|pbm
comma
id|pbm-&gt;pci_bus
)paren
suffix:semicolon
id|pci_setup_busmastering
c_func
(paren
id|pbm
comma
id|pbm-&gt;pci_bus
)paren
suffix:semicolon
)brace
DECL|function|psycho_scan_bus
r_static
r_void
id|__init
id|psycho_scan_bus
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
)paren
(brace
id|pbm_bridge_reconfigure
c_func
(paren
id|p
)paren
suffix:semicolon
id|pbm_config_busmastering
c_func
(paren
op_amp
id|p-&gt;pbm_B
)paren
suffix:semicolon
id|p-&gt;pbm_B.is_66mhz_capable
op_assign
l_int|0
suffix:semicolon
id|pbm_config_busmastering
c_func
(paren
op_amp
id|p-&gt;pbm_A
)paren
suffix:semicolon
id|p-&gt;pbm_A.is_66mhz_capable
op_assign
l_int|1
suffix:semicolon
id|pbm_scan_bus
c_func
(paren
id|p
comma
op_amp
id|p-&gt;pbm_B
)paren
suffix:semicolon
id|pbm_scan_bus
c_func
(paren
id|p
comma
op_amp
id|p-&gt;pbm_A
)paren
suffix:semicolon
multiline_comment|/* After the PCI bus scan is complete, we can register&n;&t; * the error interrupt handlers.&n;&t; */
id|psycho_register_error_handlers
c_func
(paren
id|p
)paren
suffix:semicolon
)brace
DECL|function|psycho_iommu_init
r_static
r_void
id|__init
id|psycho_iommu_init
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
)paren
(brace
r_int
r_int
id|tsbbase
comma
id|i
suffix:semicolon
id|u64
id|control
suffix:semicolon
multiline_comment|/* Setup initial software IOMMU state. */
id|spin_lock_init
c_func
(paren
op_amp
id|p-&gt;iommu.lock
)paren
suffix:semicolon
id|p-&gt;iommu.iommu_cur_ctx
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Register addresses. */
id|p-&gt;iommu.iommu_control
op_assign
id|p-&gt;controller_regs
op_plus
id|PSYCHO_IOMMU_CONTROL
suffix:semicolon
id|p-&gt;iommu.iommu_tsbbase
op_assign
id|p-&gt;controller_regs
op_plus
id|PSYCHO_IOMMU_TSBBASE
suffix:semicolon
id|p-&gt;iommu.iommu_flush
op_assign
id|p-&gt;controller_regs
op_plus
id|PSYCHO_IOMMU_FLUSH
suffix:semicolon
multiline_comment|/* PSYCHO&squot;s IOMMU lacks ctx flushing. */
id|p-&gt;iommu.iommu_ctxflush
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* We use the main control register of PSYCHO as the write&n;&t; * completion register.&n;&t; */
id|p-&gt;iommu.write_complete_reg
op_assign
id|p-&gt;controller_regs
op_plus
id|PSYCHO_CONTROL
suffix:semicolon
multiline_comment|/*&n;&t; * Invalidate TLB Entries.&n;&t; */
id|control
op_assign
id|psycho_read
c_func
(paren
id|p-&gt;controller_regs
op_plus
id|PSYCHO_IOMMU_CONTROL
)paren
suffix:semicolon
id|control
op_or_assign
id|PSYCHO_IOMMU_CTRL_DENAB
suffix:semicolon
id|psycho_write
c_func
(paren
id|p-&gt;controller_regs
op_plus
id|PSYCHO_IOMMU_CONTROL
comma
id|control
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|psycho_write
c_func
(paren
id|p-&gt;controller_regs
op_plus
id|PSYCHO_IOMMU_TAG
op_plus
(paren
id|i
op_star
l_int|8UL
)paren
comma
l_int|0
)paren
suffix:semicolon
id|psycho_write
c_func
(paren
id|p-&gt;controller_regs
op_plus
id|PSYCHO_IOMMU_DATA
op_plus
(paren
id|i
op_star
l_int|8UL
)paren
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Leave diag mode enabled for full-flushing done&n;&t; * in pci_iommu.c&n;&t; */
multiline_comment|/* Using assumed page size 8K with 128K entries we need 1MB iommu page&n;&t; * table (128K ioptes * 8 bytes per iopte).  This is&n;&t; * page order 7 on UltraSparc.&n;&t; */
id|tsbbase
op_assign
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
comma
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tsbbase
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;PSYCHO_IOMMU: Error, gfp(tsb) failed.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|p-&gt;iommu.page_table
op_assign
(paren
id|iopte_t
op_star
)paren
id|tsbbase
suffix:semicolon
id|p-&gt;iommu.page_table_sz_bits
op_assign
l_int|17
suffix:semicolon
id|p-&gt;iommu.page_table_map_base
op_assign
l_int|0xc0000000
suffix:semicolon
id|p-&gt;iommu.dma_addr_mask
op_assign
l_int|0xffffffff
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|tsbbase
comma
l_int|0
comma
id|PAGE_SIZE
op_lshift
l_int|7
)paren
suffix:semicolon
multiline_comment|/* We start with no consistent mappings. */
id|p-&gt;iommu.lowest_consistent_map
op_assign
l_int|1
op_lshift
(paren
id|p-&gt;iommu.page_table_sz_bits
op_minus
id|PBM_LOGCLUSTERS
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PBM_NCLUSTERS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p-&gt;iommu.alloc_info
(braket
id|i
)braket
dot
id|flush
op_assign
l_int|0
suffix:semicolon
id|p-&gt;iommu.alloc_info
(braket
id|i
)braket
dot
id|next
op_assign
l_int|0
suffix:semicolon
)brace
id|psycho_write
c_func
(paren
id|p-&gt;controller_regs
op_plus
id|PSYCHO_IOMMU_TSBBASE
comma
id|__pa
c_func
(paren
id|tsbbase
)paren
)paren
suffix:semicolon
id|control
op_assign
id|psycho_read
c_func
(paren
id|p-&gt;controller_regs
op_plus
id|PSYCHO_IOMMU_CONTROL
)paren
suffix:semicolon
id|control
op_and_assign
op_complement
(paren
id|PSYCHO_IOMMU_CTRL_TSBSZ
op_or
id|PSYCHO_IOMMU_CTRL_TBWSZ
)paren
suffix:semicolon
id|control
op_or_assign
(paren
id|PSYCHO_IOMMU_TSBSZ_128K
op_or
id|PSYCHO_IOMMU_CTRL_ENAB
)paren
suffix:semicolon
id|psycho_write
c_func
(paren
id|p-&gt;controller_regs
op_plus
id|PSYCHO_IOMMU_CONTROL
comma
id|control
)paren
suffix:semicolon
multiline_comment|/* If necessary, hook us up for starfire IRQ translations. */
r_if
c_cond
(paren
id|this_is_starfire
)paren
(brace
id|p-&gt;starfire_cookie
op_assign
id|starfire_hookup
c_func
(paren
id|p-&gt;portid
)paren
suffix:semicolon
)brace
r_else
id|p-&gt;starfire_cookie
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|macro|PSYCHO_IRQ_RETRY
mdefine_line|#define PSYCHO_IRQ_RETRY&t;0x1a00UL
DECL|macro|PSYCHO_PCIA_DIAG
mdefine_line|#define PSYCHO_PCIA_DIAG&t;0x2020UL
DECL|macro|PSYCHO_PCIB_DIAG
mdefine_line|#define PSYCHO_PCIB_DIAG&t;0x4020UL
DECL|macro|PSYCHO_PCIDIAG_RESV
mdefine_line|#define  PSYCHO_PCIDIAG_RESV&t; 0xffffffffffffff80 /* Reserved                     */
DECL|macro|PSYCHO_PCIDIAG_DRETRY
mdefine_line|#define  PSYCHO_PCIDIAG_DRETRY&t; 0x0000000000000040 /* Disable retry limit          */
DECL|macro|PSYCHO_PCIDIAG_DISYNC
mdefine_line|#define  PSYCHO_PCIDIAG_DISYNC&t; 0x0000000000000020 /* Disable DMA wr / irq sync    */
DECL|macro|PSYCHO_PCIDIAG_DDWSYNC
mdefine_line|#define  PSYCHO_PCIDIAG_DDWSYNC&t; 0x0000000000000010 /* Disable DMA wr / PIO rd sync */
DECL|macro|PSYCHO_PCIDIAG_IDDPAR
mdefine_line|#define  PSYCHO_PCIDIAG_IDDPAR&t; 0x0000000000000008 /* Invert DMA data parity       */
DECL|macro|PSYCHO_PCIDIAG_IPDPAR
mdefine_line|#define  PSYCHO_PCIDIAG_IPDPAR&t; 0x0000000000000004 /* Invert PIO data parity       */
DECL|macro|PSYCHO_PCIDIAG_IPAPAR
mdefine_line|#define  PSYCHO_PCIDIAG_IPAPAR&t; 0x0000000000000002 /* Invert PIO address parity    */
DECL|macro|PSYCHO_PCIDIAG_LPBACK
mdefine_line|#define  PSYCHO_PCIDIAG_LPBACK&t; 0x0000000000000001 /* Enable loopback mode         */
DECL|function|psycho_controller_hwinit
r_static
r_void
id|psycho_controller_hwinit
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
)paren
(brace
id|u64
id|tmp
suffix:semicolon
multiline_comment|/* PROM sets the IRQ retry value too low, increase it. */
id|psycho_write
c_func
(paren
id|p-&gt;controller_regs
op_plus
id|PSYCHO_IRQ_RETRY
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Enable arbiter for all PCI slots. */
id|tmp
op_assign
id|psycho_read
c_func
(paren
id|p-&gt;controller_regs
op_plus
id|PSYCHO_PCIA_CTRL
)paren
suffix:semicolon
id|tmp
op_or_assign
id|PSYCHO_PCICTRL_AEN
suffix:semicolon
id|psycho_write
c_func
(paren
id|p-&gt;controller_regs
op_plus
id|PSYCHO_PCIA_CTRL
comma
id|tmp
)paren
suffix:semicolon
id|tmp
op_assign
id|psycho_read
c_func
(paren
id|p-&gt;controller_regs
op_plus
id|PSYCHO_PCIB_CTRL
)paren
suffix:semicolon
id|tmp
op_or_assign
id|PSYCHO_PCICTRL_AEN
suffix:semicolon
id|psycho_write
c_func
(paren
id|p-&gt;controller_regs
op_plus
id|PSYCHO_PCIB_CTRL
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* Disable DMA write / PIO read synchronization on&n;&t; * both PCI bus segments.&n;&t; * [ U2P Erratum 1243770, STP2223BGA data sheet ]&n;&t; */
id|tmp
op_assign
id|psycho_read
c_func
(paren
id|p-&gt;controller_regs
op_plus
id|PSYCHO_PCIA_DIAG
)paren
suffix:semicolon
id|tmp
op_or_assign
id|PSYCHO_PCIDIAG_DDWSYNC
suffix:semicolon
id|psycho_write
c_func
(paren
id|p-&gt;controller_regs
op_plus
id|PSYCHO_PCIA_DIAG
comma
id|tmp
)paren
suffix:semicolon
id|tmp
op_assign
id|psycho_read
c_func
(paren
id|p-&gt;controller_regs
op_plus
id|PSYCHO_PCIB_DIAG
)paren
suffix:semicolon
id|tmp
op_or_assign
id|PSYCHO_PCIDIAG_DDWSYNC
suffix:semicolon
id|psycho_write
c_func
(paren
id|p-&gt;controller_regs
op_plus
id|PSYCHO_PCIB_DIAG
comma
id|tmp
)paren
suffix:semicolon
)brace
DECL|function|pbm_register_toplevel_resources
r_static
r_void
id|__init
id|pbm_register_toplevel_resources
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
comma
r_struct
id|pci_pbm_info
op_star
id|pbm
)paren
(brace
r_char
op_star
id|name
op_assign
id|pbm-&gt;name
suffix:semicolon
id|sprintf
c_func
(paren
id|name
comma
l_string|&quot;PSYCHO%d PBM%c&quot;
comma
id|p-&gt;index
comma
(paren
id|pbm
op_eq
op_amp
id|p-&gt;pbm_A
ques
c_cond
l_char|&squot;A&squot;
suffix:colon
l_char|&squot;B&squot;
)paren
)paren
suffix:semicolon
id|pbm-&gt;io_space.name
op_assign
id|pbm-&gt;mem_space.name
op_assign
id|name
suffix:semicolon
id|request_resource
c_func
(paren
op_amp
id|ioport_resource
comma
op_amp
id|pbm-&gt;io_space
)paren
suffix:semicolon
id|request_resource
c_func
(paren
op_amp
id|iomem_resource
comma
op_amp
id|pbm-&gt;mem_space
)paren
suffix:semicolon
)brace
DECL|function|psycho_pbm_strbuf_init
r_static
r_void
id|psycho_pbm_strbuf_init
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
comma
r_struct
id|pci_pbm_info
op_star
id|pbm
comma
r_int
id|is_pbm_a
)paren
(brace
r_int
r_int
id|base
op_assign
id|p-&gt;controller_regs
suffix:semicolon
id|u64
id|control
suffix:semicolon
r_if
c_cond
(paren
id|is_pbm_a
)paren
(brace
id|pbm-&gt;stc.strbuf_control
op_assign
id|base
op_plus
id|PSYCHO_STRBUF_CONTROL_A
suffix:semicolon
id|pbm-&gt;stc.strbuf_pflush
op_assign
id|base
op_plus
id|PSYCHO_STRBUF_FLUSH_A
suffix:semicolon
id|pbm-&gt;stc.strbuf_fsync
op_assign
id|base
op_plus
id|PSYCHO_STRBUF_FSYNC_A
suffix:semicolon
)brace
r_else
(brace
id|pbm-&gt;stc.strbuf_control
op_assign
id|base
op_plus
id|PSYCHO_STRBUF_CONTROL_B
suffix:semicolon
id|pbm-&gt;stc.strbuf_pflush
op_assign
id|base
op_plus
id|PSYCHO_STRBUF_FLUSH_B
suffix:semicolon
id|pbm-&gt;stc.strbuf_fsync
op_assign
id|base
op_plus
id|PSYCHO_STRBUF_FSYNC_B
suffix:semicolon
)brace
multiline_comment|/* PSYCHO&squot;s streaming buffer lacks ctx flushing. */
id|pbm-&gt;stc.strbuf_ctxflush
op_assign
l_int|0
suffix:semicolon
id|pbm-&gt;stc.strbuf_ctxmatch_base
op_assign
l_int|0
suffix:semicolon
id|pbm-&gt;stc.strbuf_flushflag
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
(paren
(paren
(paren
(paren
r_int
r_int
)paren
op_amp
id|pbm-&gt;stc.__flushflag_buf
(braket
l_int|0
)braket
)paren
op_plus
l_int|63UL
)paren
op_amp
op_complement
l_int|63UL
)paren
suffix:semicolon
id|pbm-&gt;stc.strbuf_flushflag_pa
op_assign
(paren
r_int
r_int
)paren
id|__pa
c_func
(paren
id|pbm-&gt;stc.strbuf_flushflag
)paren
suffix:semicolon
multiline_comment|/* Enable the streaming buffer.  We have to be careful&n;&t; * just in case OBP left it with LRU locking enabled.&n;&t; *&n;&t; * It is possible to control if PBM will be rerun on&n;&t; * line misses.  Currently I just retain whatever setting&n;&t; * OBP left us with.  All checks so far show it having&n;&t; * a value of zero.&n;&t; */
DECL|macro|PSYCHO_STRBUF_RERUN_ENABLE
macro_line|#undef PSYCHO_STRBUF_RERUN_ENABLE
DECL|macro|PSYCHO_STRBUF_RERUN_DISABLE
macro_line|#undef PSYCHO_STRBUF_RERUN_DISABLE
id|control
op_assign
id|psycho_read
c_func
(paren
id|pbm-&gt;stc.strbuf_control
)paren
suffix:semicolon
id|control
op_or_assign
id|PSYCHO_STRBUF_CTRL_ENAB
suffix:semicolon
id|control
op_and_assign
op_complement
(paren
id|PSYCHO_STRBUF_CTRL_LENAB
op_or
id|PSYCHO_STRBUF_CTRL_LPTR
)paren
suffix:semicolon
macro_line|#ifdef PSYCHO_STRBUF_RERUN_ENABLE
id|control
op_and_assign
op_complement
(paren
id|PSYCHO_STRBUF_CTRL_RRDIS
)paren
suffix:semicolon
macro_line|#else
macro_line|#ifdef PSYCHO_STRBUF_RERUN_DISABLE
id|control
op_or_assign
id|PSYCHO_STRBUF_CTRL_RRDIS
suffix:semicolon
macro_line|#endif
macro_line|#endif
id|psycho_write
c_func
(paren
id|pbm-&gt;stc.strbuf_control
comma
id|control
)paren
suffix:semicolon
id|pbm-&gt;stc.strbuf_enabled
op_assign
l_int|1
suffix:semicolon
)brace
DECL|macro|PSYCHO_IOSPACE_A
mdefine_line|#define PSYCHO_IOSPACE_A&t;0x002000000UL
DECL|macro|PSYCHO_IOSPACE_B
mdefine_line|#define PSYCHO_IOSPACE_B&t;0x002010000UL
DECL|macro|PSYCHO_IOSPACE_SIZE
mdefine_line|#define PSYCHO_IOSPACE_SIZE&t;0x00000ffffUL
DECL|macro|PSYCHO_MEMSPACE_A
mdefine_line|#define PSYCHO_MEMSPACE_A&t;0x100000000UL
DECL|macro|PSYCHO_MEMSPACE_B
mdefine_line|#define PSYCHO_MEMSPACE_B&t;0x180000000UL
DECL|macro|PSYCHO_MEMSPACE_SIZE
mdefine_line|#define PSYCHO_MEMSPACE_SIZE&t;0x07fffffffUL
DECL|function|psycho_pbm_init
r_static
r_void
id|psycho_pbm_init
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
comma
r_int
id|prom_node
comma
r_int
id|is_pbm_a
)paren
(brace
r_int
r_int
id|busrange
(braket
l_int|2
)braket
suffix:semicolon
r_struct
id|pci_pbm_info
op_star
id|pbm
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|is_pbm_a
)paren
(brace
id|pbm
op_assign
op_amp
id|p-&gt;pbm_A
suffix:semicolon
id|pbm-&gt;io_space.start
op_assign
id|p-&gt;controller_regs
op_plus
id|PSYCHO_IOSPACE_A
suffix:semicolon
id|pbm-&gt;mem_space.start
op_assign
id|p-&gt;controller_regs
op_plus
id|PSYCHO_MEMSPACE_A
suffix:semicolon
)brace
r_else
(brace
id|pbm
op_assign
op_amp
id|p-&gt;pbm_B
suffix:semicolon
id|pbm-&gt;io_space.start
op_assign
id|p-&gt;controller_regs
op_plus
id|PSYCHO_IOSPACE_B
suffix:semicolon
id|pbm-&gt;mem_space.start
op_assign
id|p-&gt;controller_regs
op_plus
id|PSYCHO_MEMSPACE_B
suffix:semicolon
)brace
id|pbm-&gt;io_space.end
op_assign
id|pbm-&gt;io_space.start
op_plus
id|PSYCHO_IOSPACE_SIZE
suffix:semicolon
id|pbm-&gt;io_space.flags
op_assign
id|IORESOURCE_IO
suffix:semicolon
id|pbm-&gt;mem_space.end
op_assign
id|pbm-&gt;mem_space.start
op_plus
id|PSYCHO_MEMSPACE_SIZE
suffix:semicolon
id|pbm-&gt;mem_space.flags
op_assign
id|IORESOURCE_MEM
suffix:semicolon
id|pbm_register_toplevel_resources
c_func
(paren
id|p
comma
id|pbm
)paren
suffix:semicolon
id|pbm-&gt;parent
op_assign
id|p
suffix:semicolon
id|pbm-&gt;prom_node
op_assign
id|prom_node
suffix:semicolon
id|prom_getstring
c_func
(paren
id|prom_node
comma
l_string|&quot;name&quot;
comma
id|pbm-&gt;prom_name
comma
r_sizeof
(paren
id|pbm-&gt;prom_name
)paren
)paren
suffix:semicolon
id|err
op_assign
id|prom_getproperty
c_func
(paren
id|prom_node
comma
l_string|&quot;ranges&quot;
comma
(paren
r_char
op_star
)paren
id|pbm-&gt;pbm_ranges
comma
r_sizeof
(paren
id|pbm-&gt;pbm_ranges
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
op_minus
l_int|1
)paren
id|pbm-&gt;num_pbm_ranges
op_assign
(paren
id|err
op_div
r_sizeof
(paren
r_struct
id|linux_prom_pci_ranges
)paren
)paren
suffix:semicolon
r_else
id|pbm-&gt;num_pbm_ranges
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|prom_getproperty
c_func
(paren
id|prom_node
comma
l_string|&quot;interrupt-map&quot;
comma
(paren
r_char
op_star
)paren
id|pbm-&gt;pbm_intmap
comma
r_sizeof
(paren
id|pbm-&gt;pbm_intmap
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
op_minus
l_int|1
)paren
(brace
id|pbm-&gt;num_pbm_intmap
op_assign
(paren
id|err
op_div
r_sizeof
(paren
r_struct
id|linux_prom_pci_intmap
)paren
)paren
suffix:semicolon
id|err
op_assign
id|prom_getproperty
c_func
(paren
id|prom_node
comma
l_string|&quot;interrupt-map-mask&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|pbm-&gt;pbm_intmask
comma
r_sizeof
(paren
id|pbm-&gt;pbm_intmask
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
op_minus
l_int|1
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;PSYCHO-PBM: Fatal error, no &quot;
l_string|&quot;interrupt-map-mask.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|pbm-&gt;num_pbm_intmap
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|pbm-&gt;pbm_intmask
comma
l_int|0
comma
r_sizeof
(paren
id|pbm-&gt;pbm_intmask
)paren
)paren
suffix:semicolon
)brace
id|err
op_assign
id|prom_getproperty
c_func
(paren
id|prom_node
comma
l_string|&quot;bus-range&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|busrange
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|busrange
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
l_int|0
op_logical_or
id|err
op_eq
op_minus
l_int|1
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;PSYCHO-PBM: Fatal error, no bus-range.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|pbm-&gt;pci_first_busno
op_assign
id|busrange
(braket
l_int|0
)braket
suffix:semicolon
id|pbm-&gt;pci_last_busno
op_assign
id|busrange
(braket
l_int|1
)braket
suffix:semicolon
id|psycho_pbm_strbuf_init
c_func
(paren
id|p
comma
id|pbm
comma
id|is_pbm_a
)paren
suffix:semicolon
)brace
DECL|macro|PSYCHO_CONFIGSPACE
mdefine_line|#define PSYCHO_CONFIGSPACE&t;0x001000000UL
DECL|function|psycho_init
r_void
id|__init
id|psycho_init
c_func
(paren
r_int
id|node
)paren
(brace
r_struct
id|linux_prom64_registers
id|pr_regs
(braket
l_int|3
)braket
suffix:semicolon
r_struct
id|pci_controller_info
op_star
id|p
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|upa_portid
suffix:semicolon
r_int
id|is_pbm_a
comma
id|err
suffix:semicolon
id|upa_portid
op_assign
id|prom_getintdefault
c_func
(paren
id|node
comma
l_string|&quot;upa-portid&quot;
comma
l_int|0xff
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pci_controller_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|pci_controller_root
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;portid
op_eq
id|upa_portid
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pci_controller_lock
comma
id|flags
)paren
suffix:semicolon
id|is_pbm_a
op_assign
(paren
id|p-&gt;pbm_A.prom_node
op_eq
l_int|0
)paren
suffix:semicolon
id|psycho_pbm_init
c_func
(paren
id|p
comma
id|node
comma
id|is_pbm_a
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pci_controller_lock
comma
id|flags
)paren
suffix:semicolon
id|p
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pci_controller_info
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;PSYCHO: Fatal memory allocation error.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|p
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|p
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pci_controller_lock
comma
id|flags
)paren
suffix:semicolon
id|p-&gt;next
op_assign
id|pci_controller_root
suffix:semicolon
id|pci_controller_root
op_assign
id|p
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pci_controller_lock
comma
id|flags
)paren
suffix:semicolon
id|p-&gt;portid
op_assign
id|upa_portid
suffix:semicolon
id|p-&gt;index
op_assign
id|pci_num_controllers
op_increment
suffix:semicolon
id|p-&gt;scan_bus
op_assign
id|psycho_scan_bus
suffix:semicolon
id|p-&gt;irq_build
op_assign
id|psycho_irq_build
suffix:semicolon
id|p-&gt;base_address_update
op_assign
id|psycho_base_address_update
suffix:semicolon
id|p-&gt;resource_adjust
op_assign
id|psycho_resource_adjust
suffix:semicolon
id|p-&gt;pci_ops
op_assign
op_amp
id|psycho_ops
suffix:semicolon
id|err
op_assign
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;reg&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|pr_regs
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|pr_regs
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
l_int|0
op_logical_or
id|err
op_eq
op_minus
l_int|1
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;PSYCHO: Fatal error, no reg property.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|p-&gt;controller_regs
op_assign
id|pr_regs
(braket
l_int|2
)braket
dot
id|phys_addr
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI: Found PSYCHO, control regs at %016lx&bslash;n&quot;
comma
id|p-&gt;controller_regs
)paren
suffix:semicolon
id|p-&gt;config_space
op_assign
id|pr_regs
(braket
l_int|2
)braket
dot
id|phys_addr
op_plus
id|PSYCHO_CONFIGSPACE
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PSYCHO: PCI config space at %016lx&bslash;n&quot;
comma
id|p-&gt;config_space
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Psycho&squot;s PCI MEM space is mapped to a 2GB aligned area, so&n;&t; * we need to adjust our MEM space mask.&n;&t; */
id|pci_memspace_mask
op_assign
l_int|0x7fffffffUL
suffix:semicolon
id|psycho_controller_hwinit
c_func
(paren
id|p
)paren
suffix:semicolon
id|psycho_iommu_init
c_func
(paren
id|p
)paren
suffix:semicolon
id|is_pbm_a
op_assign
(paren
(paren
id|pr_regs
(braket
l_int|0
)braket
dot
id|phys_addr
op_amp
l_int|0x6000
)paren
op_eq
l_int|0x2000
)paren
suffix:semicolon
id|psycho_pbm_init
c_func
(paren
id|p
comma
id|node
comma
id|is_pbm_a
)paren
suffix:semicolon
)brace
eof
