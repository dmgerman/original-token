multiline_comment|/* $Id: ebus.c,v 1.53 2000/11/08 05:08:23 davem Exp $&n; * ebus.c: PCI to EBus bridge device.&n; *&n; * Copyright (C) 1997  Eddie C. Dost  (ecd@skynet.be)&n; * Copyright (C) 1999  David S. Miller (davem@redhat.com)&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pbm.h&gt;
macro_line|#include &lt;asm/ebus.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/bpp.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
DECL|variable|ebus_chain
r_struct
id|linux_ebus
op_star
id|ebus_chain
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_SUN_AUXIO
r_extern
r_void
id|auxio_probe
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
DECL|function|ebus_alloc
r_static
r_inline
r_void
op_star
id|ebus_alloc
c_func
(paren
r_int
id|size
)paren
(brace
r_void
op_star
id|mem
suffix:semicolon
id|mem
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem
)paren
id|panic
c_func
(paren
id|__FUNCTION__
l_string|&quot;: out of memory&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|mem
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
r_return
id|mem
suffix:semicolon
)brace
DECL|function|ebus_ranges_init
r_static
r_void
id|__init
id|ebus_ranges_init
c_func
(paren
r_struct
id|linux_ebus
op_star
id|ebus
)paren
(brace
r_int
id|success
suffix:semicolon
id|ebus-&gt;num_ebus_ranges
op_assign
l_int|0
suffix:semicolon
id|success
op_assign
id|prom_getproperty
c_func
(paren
id|ebus-&gt;prom_node
comma
l_string|&quot;ranges&quot;
comma
(paren
r_char
op_star
)paren
id|ebus-&gt;ebus_ranges
comma
r_sizeof
(paren
id|ebus-&gt;ebus_ranges
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|success
op_ne
op_minus
l_int|1
)paren
id|ebus-&gt;num_ebus_ranges
op_assign
(paren
id|success
op_div
r_sizeof
(paren
r_struct
id|linux_prom_ebus_ranges
)paren
)paren
suffix:semicolon
)brace
DECL|function|ebus_intmap_init
r_static
r_void
id|__init
id|ebus_intmap_init
c_func
(paren
r_struct
id|linux_ebus
op_star
id|ebus
)paren
(brace
r_int
id|success
suffix:semicolon
id|ebus-&gt;num_ebus_intmap
op_assign
l_int|0
suffix:semicolon
id|success
op_assign
id|prom_getproperty
c_func
(paren
id|ebus-&gt;prom_node
comma
l_string|&quot;interrupt-map&quot;
comma
(paren
r_char
op_star
)paren
id|ebus-&gt;ebus_intmap
comma
r_sizeof
(paren
id|ebus-&gt;ebus_intmap
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|success
op_eq
op_minus
l_int|1
)paren
r_return
suffix:semicolon
id|ebus-&gt;num_ebus_intmap
op_assign
(paren
id|success
op_div
r_sizeof
(paren
r_struct
id|linux_prom_ebus_intmap
)paren
)paren
suffix:semicolon
id|success
op_assign
id|prom_getproperty
c_func
(paren
id|ebus-&gt;prom_node
comma
l_string|&quot;interrupt-map-mask&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|ebus-&gt;ebus_intmask
comma
r_sizeof
(paren
id|ebus-&gt;ebus_intmask
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|success
op_eq
op_minus
l_int|1
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;%s: can&squot;t get interrupt-map-mask&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|ebus_intmap_match
r_int
id|__init
id|ebus_intmap_match
c_func
(paren
r_struct
id|linux_ebus
op_star
id|ebus
comma
r_struct
id|linux_prom_registers
op_star
id|reg
comma
r_int
op_star
id|interrupt
)paren
(brace
r_int
r_int
id|hi
comma
id|lo
comma
id|irq
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ebus-&gt;num_ebus_intmap
)paren
r_return
l_int|0
suffix:semicolon
id|hi
op_assign
id|reg-&gt;which_io
op_amp
id|ebus-&gt;ebus_intmask.phys_hi
suffix:semicolon
id|lo
op_assign
id|reg-&gt;phys_addr
op_amp
id|ebus-&gt;ebus_intmask.phys_lo
suffix:semicolon
id|irq
op_assign
op_star
id|interrupt
op_amp
id|ebus-&gt;ebus_intmask.interrupt
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ebus-&gt;num_ebus_intmap
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|ebus-&gt;ebus_intmap
(braket
id|i
)braket
dot
id|phys_hi
op_eq
id|hi
)paren
op_logical_and
(paren
id|ebus-&gt;ebus_intmap
(braket
id|i
)braket
dot
id|phys_lo
op_eq
id|lo
)paren
op_logical_and
(paren
id|ebus-&gt;ebus_intmap
(braket
id|i
)braket
dot
id|interrupt
op_eq
id|irq
)paren
)paren
(brace
op_star
id|interrupt
op_assign
id|ebus-&gt;ebus_intmap
(braket
id|i
)braket
dot
id|cinterrupt
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|fill_ebus_child
r_void
id|__init
id|fill_ebus_child
c_func
(paren
r_int
id|node
comma
r_struct
id|linux_prom_registers
op_star
id|preg
comma
r_struct
id|linux_ebus_child
op_star
id|dev
comma
r_int
id|non_standard_regs
)paren
(brace
r_int
id|regs
(braket
id|PROMREG_MAX
)braket
suffix:semicolon
r_int
id|irqs
(braket
id|PROMREG_MAX
)braket
suffix:semicolon
r_int
id|i
comma
id|len
suffix:semicolon
id|dev-&gt;prom_node
op_assign
id|node
suffix:semicolon
id|prom_getstring
c_func
(paren
id|node
comma
l_string|&quot;name&quot;
comma
id|dev-&gt;prom_name
comma
r_sizeof
(paren
id|dev-&gt;prom_name
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; (%s)&quot;
comma
id|dev-&gt;prom_name
)paren
suffix:semicolon
id|len
op_assign
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;reg&quot;
comma
(paren
r_void
op_star
)paren
id|regs
comma
r_sizeof
(paren
id|regs
)paren
)paren
suffix:semicolon
id|dev-&gt;num_addrs
op_assign
id|len
op_div
r_sizeof
(paren
id|regs
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|non_standard_regs
)paren
(brace
multiline_comment|/* This is to handle reg properties which are not&n;&t;&t; * in the parent relative format.  One example are&n;&t;&t; * children of the i2c device on CompactPCI systems.&n;&t;&t; *&n;&t;&t; * So, for such devices we just record the property&n;&t;&t; * raw in the child resources.&n;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;num_addrs
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
op_assign
id|regs
(braket
id|i
)braket
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;num_addrs
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|rnum
op_assign
id|regs
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|rnum
op_ge
id|dev-&gt;parent-&gt;num_addrs
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;UGH: property for %s was %d, need &lt; %d&bslash;n&quot;
comma
id|dev-&gt;prom_name
comma
id|len
comma
id|dev-&gt;parent-&gt;num_addrs
)paren
suffix:semicolon
id|panic
c_func
(paren
id|__FUNCTION__
)paren
suffix:semicolon
)brace
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
op_assign
id|dev-&gt;parent-&gt;resource
(braket
id|i
)braket
dot
id|start
suffix:semicolon
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|end
op_assign
id|dev-&gt;parent-&gt;resource
(braket
id|i
)braket
dot
id|end
suffix:semicolon
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|flags
op_assign
id|IORESOURCE_MEM
suffix:semicolon
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|name
op_assign
id|dev-&gt;prom_name
suffix:semicolon
)brace
)brace
id|len
op_assign
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;interrupts&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|irqs
comma
r_sizeof
(paren
id|irqs
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
op_eq
op_minus
l_int|1
)paren
op_logical_or
(paren
id|len
op_eq
l_int|0
)paren
)paren
(brace
id|dev-&gt;num_irqs
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Oh, well, some PROMs don&squot;t export interrupts&n;&t;&t; * property to children of EBus devices...&n;&t;&t; *&n;&t;&t; * Be smart about PS/2 keyboard and mouse.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|dev-&gt;parent-&gt;prom_name
comma
l_string|&quot;8042&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|dev-&gt;prom_name
comma
l_string|&quot;kb_ps2&quot;
)paren
)paren
(brace
id|dev-&gt;num_irqs
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;irqs
(braket
l_int|0
)braket
op_assign
id|dev-&gt;parent-&gt;irqs
(braket
l_int|0
)braket
suffix:semicolon
)brace
r_else
(brace
id|dev-&gt;num_irqs
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;irqs
(braket
l_int|0
)braket
op_assign
id|dev-&gt;parent-&gt;irqs
(braket
l_int|1
)braket
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|dev-&gt;num_irqs
op_assign
id|len
op_div
r_sizeof
(paren
id|irqs
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;num_irqs
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|pci_pbm_info
op_star
id|pbm
op_assign
id|dev-&gt;bus-&gt;parent
suffix:semicolon
r_struct
id|pci_controller_info
op_star
id|p
op_assign
id|pbm-&gt;parent
suffix:semicolon
r_if
c_cond
(paren
id|ebus_intmap_match
c_func
(paren
id|dev-&gt;bus
comma
id|preg
comma
op_amp
id|irqs
(braket
id|i
)braket
)paren
op_ne
op_minus
l_int|1
)paren
(brace
id|dev-&gt;irqs
(braket
id|i
)braket
op_assign
id|p
op_member_access_from_pointer
id|irq_build
c_func
(paren
id|p
comma
id|dev-&gt;bus-&gt;self
comma
id|irqs
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* If we get a bogus interrupt property, just&n;&t;&t;&t;&t; * record the raw value instead of punting.&n;&t;&t;&t;&t; */
id|dev-&gt;irqs
(braket
id|i
)braket
op_assign
id|irqs
(braket
id|i
)braket
suffix:semicolon
)brace
)brace
)brace
)brace
DECL|function|child_regs_nonstandard
r_static
r_int
id|__init
id|child_regs_nonstandard
c_func
(paren
r_struct
id|linux_ebus_device
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|dev-&gt;prom_name
comma
l_string|&quot;i2c&quot;
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|fill_ebus_device
r_void
id|__init
id|fill_ebus_device
c_func
(paren
r_int
id|node
comma
r_struct
id|linux_ebus_device
op_star
id|dev
)paren
(brace
r_struct
id|linux_prom_registers
id|regs
(braket
id|PROMREG_MAX
)braket
suffix:semicolon
r_struct
id|linux_ebus_child
op_star
id|child
suffix:semicolon
r_int
id|irqs
(braket
id|PROMINTR_MAX
)braket
suffix:semicolon
r_int
id|i
comma
id|n
comma
id|len
suffix:semicolon
id|dev-&gt;prom_node
op_assign
id|node
suffix:semicolon
id|prom_getstring
c_func
(paren
id|node
comma
l_string|&quot;name&quot;
comma
id|dev-&gt;prom_name
comma
r_sizeof
(paren
id|dev-&gt;prom_name
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; [%s&quot;
comma
id|dev-&gt;prom_name
)paren
suffix:semicolon
id|len
op_assign
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;reg&quot;
comma
(paren
r_void
op_star
)paren
id|regs
comma
r_sizeof
(paren
id|regs
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_mod
r_sizeof
(paren
r_struct
id|linux_prom_registers
)paren
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;UGH: proplen for %s was %d, need multiple of %d&bslash;n&quot;
comma
id|dev-&gt;prom_name
comma
id|len
comma
(paren
r_int
)paren
r_sizeof
(paren
r_struct
id|linux_prom_registers
)paren
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|dev-&gt;num_addrs
op_assign
id|len
op_div
r_sizeof
(paren
r_struct
id|linux_prom_registers
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;num_addrs
suffix:semicolon
id|i
op_increment
)paren
(brace
id|n
op_assign
(paren
id|regs
(braket
id|i
)braket
dot
id|which_io
op_minus
l_int|0x10
)paren
op_rshift
l_int|2
suffix:semicolon
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
op_assign
id|dev-&gt;bus-&gt;self-&gt;resource
(braket
id|n
)braket
dot
id|start
suffix:semicolon
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
op_add_assign
(paren
r_int
r_int
)paren
id|regs
(braket
id|i
)braket
dot
id|phys_addr
suffix:semicolon
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|end
op_assign
(paren
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
op_plus
(paren
r_int
r_int
)paren
id|regs
(braket
id|i
)braket
dot
id|reg_size
op_minus
l_int|1UL
)paren
suffix:semicolon
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|flags
op_assign
id|IORESOURCE_MEM
suffix:semicolon
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|name
op_assign
id|dev-&gt;prom_name
suffix:semicolon
id|request_resource
c_func
(paren
op_amp
id|dev-&gt;bus-&gt;self-&gt;resource
(braket
id|n
)braket
comma
op_amp
id|dev-&gt;resource
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|len
op_assign
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;interrupts&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|irqs
comma
r_sizeof
(paren
id|irqs
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
op_eq
op_minus
l_int|1
)paren
op_logical_or
(paren
id|len
op_eq
l_int|0
)paren
)paren
(brace
id|dev-&gt;num_irqs
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|dev-&gt;num_irqs
op_assign
id|len
op_div
r_sizeof
(paren
id|irqs
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;num_irqs
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|pci_pbm_info
op_star
id|pbm
op_assign
id|dev-&gt;bus-&gt;parent
suffix:semicolon
r_struct
id|pci_controller_info
op_star
id|p
op_assign
id|pbm-&gt;parent
suffix:semicolon
r_if
c_cond
(paren
id|ebus_intmap_match
c_func
(paren
id|dev-&gt;bus
comma
op_amp
id|regs
(braket
l_int|0
)braket
comma
op_amp
id|irqs
(braket
id|i
)braket
)paren
op_ne
op_minus
l_int|1
)paren
(brace
id|dev-&gt;irqs
(braket
id|i
)braket
op_assign
id|p
op_member_access_from_pointer
id|irq_build
c_func
(paren
id|p
comma
id|dev-&gt;bus-&gt;self
comma
id|irqs
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* If we get a bogus interrupt property, just&n;&t;&t;&t;&t; * record the raw value instead of punting.&n;&t;&t;&t;&t; */
id|dev-&gt;irqs
(braket
id|i
)braket
op_assign
id|irqs
(braket
id|i
)braket
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
(paren
id|node
op_assign
id|prom_getchild
c_func
(paren
id|node
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; -&gt;&quot;
)paren
suffix:semicolon
id|dev-&gt;children
op_assign
id|ebus_alloc
c_func
(paren
r_sizeof
(paren
r_struct
id|linux_ebus_child
)paren
)paren
suffix:semicolon
id|child
op_assign
id|dev-&gt;children
suffix:semicolon
id|child-&gt;next
op_assign
l_int|0
suffix:semicolon
id|child-&gt;parent
op_assign
id|dev
suffix:semicolon
id|child-&gt;bus
op_assign
id|dev-&gt;bus
suffix:semicolon
id|fill_ebus_child
c_func
(paren
id|node
comma
op_amp
id|regs
(braket
l_int|0
)braket
comma
id|child
comma
id|child_regs_nonstandard
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|node
op_assign
id|prom_getsibling
c_func
(paren
id|node
)paren
)paren
)paren
(brace
id|child-&gt;next
op_assign
id|ebus_alloc
c_func
(paren
r_sizeof
(paren
r_struct
id|linux_ebus_child
)paren
)paren
suffix:semicolon
id|child
op_assign
id|child-&gt;next
suffix:semicolon
id|child-&gt;next
op_assign
l_int|0
suffix:semicolon
id|child-&gt;parent
op_assign
id|dev
suffix:semicolon
id|child-&gt;bus
op_assign
id|dev-&gt;bus
suffix:semicolon
id|fill_ebus_child
c_func
(paren
id|node
comma
op_amp
id|regs
(braket
l_int|0
)braket
comma
id|child
comma
id|child_regs_nonstandard
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;]&quot;
)paren
suffix:semicolon
)brace
r_extern
r_void
id|clock_probe
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|power_init
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|function|ebus_init
r_void
id|__init
id|ebus_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|pci_pbm_info
op_star
id|pbm
suffix:semicolon
r_struct
id|linux_ebus_device
op_star
id|dev
suffix:semicolon
r_struct
id|linux_ebus
op_star
id|ebus
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
r_struct
id|pcidev_cookie
op_star
id|cookie
suffix:semicolon
r_int
id|nd
comma
id|ebusnd
suffix:semicolon
r_int
id|num_ebus
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_present
c_func
(paren
)paren
)paren
r_return
suffix:semicolon
id|pdev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_SUN
comma
id|PCI_DEVICE_ID_SUN_EBUS
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pdev
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ebus: No EBus&squot;s found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|cookie
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
id|ebusnd
op_assign
id|cookie-&gt;prom_node
suffix:semicolon
id|ebus_chain
op_assign
id|ebus
op_assign
id|ebus_alloc
c_func
(paren
r_sizeof
(paren
r_struct
id|linux_ebus
)paren
)paren
suffix:semicolon
id|ebus-&gt;next
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|ebusnd
)paren
(brace
multiline_comment|/* SUNW,pci-qfe uses four empty ebuses on it.&n;&t;&t;   I think we should not consider them here,&n;&t;&t;   as they have half of the properties this&n;&t;&t;   code expects and once we do PCI hot-plug,&n;&t;&t;   we&squot;d have to tweak with the ebus_chain&n;&t;&t;   in the runtime after initialization. -jj */
r_if
c_cond
(paren
op_logical_neg
id|prom_getchild
(paren
id|ebusnd
)paren
)paren
(brace
id|pdev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_SUN
comma
id|PCI_DEVICE_ID_SUN_EBUS
comma
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pdev
)paren
(brace
r_if
c_cond
(paren
id|ebus
op_eq
id|ebus_chain
)paren
(brace
id|ebus_chain
op_assign
l_int|NULL
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ebus: No EBus&squot;s found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|cookie
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
id|ebusnd
op_assign
id|cookie-&gt;prom_node
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;ebus%d:&quot;
comma
id|num_ebus
)paren
suffix:semicolon
id|prom_getstring
c_func
(paren
id|ebusnd
comma
l_string|&quot;name&quot;
comma
id|ebus-&gt;prom_name
comma
r_sizeof
(paren
id|ebus-&gt;prom_name
)paren
)paren
suffix:semicolon
id|ebus-&gt;index
op_assign
id|num_ebus
suffix:semicolon
id|ebus-&gt;prom_node
op_assign
id|ebusnd
suffix:semicolon
id|ebus-&gt;self
op_assign
id|pdev
suffix:semicolon
id|ebus-&gt;parent
op_assign
id|pbm
op_assign
id|cookie-&gt;pbm
suffix:semicolon
id|ebus_ranges_init
c_func
(paren
id|ebus
)paren
suffix:semicolon
id|ebus_intmap_init
c_func
(paren
id|ebus
)paren
suffix:semicolon
id|nd
op_assign
id|prom_getchild
c_func
(paren
id|ebusnd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nd
)paren
r_goto
id|next_ebus
suffix:semicolon
id|ebus-&gt;devices
op_assign
id|ebus_alloc
c_func
(paren
r_sizeof
(paren
r_struct
id|linux_ebus_device
)paren
)paren
suffix:semicolon
id|dev
op_assign
id|ebus-&gt;devices
suffix:semicolon
id|dev-&gt;next
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;children
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;bus
op_assign
id|ebus
suffix:semicolon
id|fill_ebus_device
c_func
(paren
id|nd
comma
id|dev
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|nd
op_assign
id|prom_getsibling
c_func
(paren
id|nd
)paren
)paren
)paren
(brace
id|dev-&gt;next
op_assign
id|ebus_alloc
c_func
(paren
r_sizeof
(paren
r_struct
id|linux_ebus_device
)paren
)paren
suffix:semicolon
id|dev
op_assign
id|dev-&gt;next
suffix:semicolon
id|dev-&gt;next
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;children
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;bus
op_assign
id|ebus
suffix:semicolon
id|fill_ebus_device
c_func
(paren
id|nd
comma
id|dev
)paren
suffix:semicolon
)brace
id|next_ebus
suffix:colon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|pdev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_SUN
comma
id|PCI_DEVICE_ID_SUN_EBUS
comma
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pdev
)paren
r_break
suffix:semicolon
id|cookie
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
id|ebusnd
op_assign
id|cookie-&gt;prom_node
suffix:semicolon
id|ebus-&gt;next
op_assign
id|ebus_alloc
c_func
(paren
r_sizeof
(paren
r_struct
id|linux_ebus
)paren
)paren
suffix:semicolon
id|ebus
op_assign
id|ebus-&gt;next
suffix:semicolon
id|ebus-&gt;next
op_assign
l_int|0
suffix:semicolon
op_increment
id|num_ebus
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SUN_AUXIO
id|auxio_probe
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|clock_probe
c_func
(paren
)paren
suffix:semicolon
id|power_init
c_func
(paren
)paren
suffix:semicolon
)brace
eof
