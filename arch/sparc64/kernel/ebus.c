multiline_comment|/* $Id: ebus.c,v 1.7 1997/08/28 02:23:17 ecd Exp $&n; * ebus.c: PCI to EBus bridge device.&n; *&n; * Copyright (C) 1997  Eddie C. Dost  (ecd@skynet.be)&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pbm.h&gt;
macro_line|#include &lt;asm/ebus.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/bpp.h&gt;
DECL|macro|DEBUG_FILL_EBUS_DEV
macro_line|#undef DEBUG_FILL_EBUS_DEV
DECL|variable|ebus_chain
r_struct
id|linux_ebus
op_star
id|ebus_chain
op_assign
l_int|0
suffix:semicolon
r_extern
r_void
id|prom_ebus_ranges_init
c_func
(paren
r_struct
id|linux_ebus
op_star
)paren
suffix:semicolon
r_extern
r_int
r_int
id|pci_console_init
c_func
(paren
r_int
r_int
id|memory_start
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SUN_OPENPROMIO
r_extern
r_int
id|openprom_init
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_SUN_MOSTEK_RTC
r_extern
r_int
id|rtc_init
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_SPARCAUDIO
r_extern
r_int
id|sparcaudio_init
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_SUN_AUXIO
r_extern
r_void
id|auxio_probe
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
r_extern
r_int
r_int
id|psycho_irq_build
c_func
(paren
r_int
r_int
id|full_ino
)paren
suffix:semicolon
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|fill_ebus_device
c_func
(paren
r_int
id|node
comma
r_struct
id|linux_ebus_device
op_star
id|dev
)paren
)paren
(brace
r_struct
id|linux_prom_registers
id|regs
(braket
id|PROMREG_MAX
)braket
suffix:semicolon
r_int
id|irqs
(braket
id|PROMINTR_MAX
)braket
suffix:semicolon
r_char
id|lbuf
(braket
l_int|128
)braket
suffix:semicolon
r_int
id|i
comma
id|n
comma
id|len
suffix:semicolon
macro_line|#ifndef CONFIG_PCI
r_return
suffix:semicolon
macro_line|#endif
id|dev-&gt;prom_node
op_assign
id|node
suffix:semicolon
id|prom_getstring
c_func
(paren
id|node
comma
l_string|&quot;name&quot;
comma
id|lbuf
comma
r_sizeof
(paren
id|lbuf
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|dev-&gt;prom_name
comma
id|lbuf
)paren
suffix:semicolon
id|len
op_assign
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;reg&quot;
comma
(paren
r_void
op_star
)paren
id|regs
comma
r_sizeof
(paren
id|regs
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_mod
r_sizeof
(paren
r_struct
id|linux_prom_registers
)paren
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;UGH: proplen for %s was %d, need multiple of %d&bslash;n&quot;
comma
id|dev-&gt;prom_name
comma
id|len
comma
(paren
r_int
)paren
r_sizeof
(paren
r_struct
id|linux_prom_registers
)paren
)paren
suffix:semicolon
id|panic
c_func
(paren
id|__FUNCTION__
)paren
suffix:semicolon
)brace
id|dev-&gt;num_addrs
op_assign
id|len
op_div
r_sizeof
(paren
r_struct
id|linux_prom_registers
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;num_addrs
suffix:semicolon
id|i
op_increment
)paren
(brace
id|n
op_assign
(paren
id|regs
(braket
id|i
)braket
dot
id|which_io
op_minus
l_int|0x10
)paren
op_rshift
l_int|2
suffix:semicolon
id|dev-&gt;base_address
(braket
id|i
)braket
op_assign
id|dev-&gt;parent-&gt;self-&gt;base_address
(braket
id|n
)braket
suffix:semicolon
id|dev-&gt;base_address
(braket
id|i
)braket
op_add_assign
(paren
r_int
r_int
)paren
id|regs
(braket
id|i
)braket
dot
id|phys_addr
suffix:semicolon
)brace
id|len
op_assign
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;interrupts&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|irqs
comma
r_sizeof
(paren
id|irqs
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
op_eq
op_minus
l_int|1
)paren
op_logical_or
(paren
id|len
op_eq
l_int|0
)paren
)paren
(brace
id|dev-&gt;num_irqs
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|dev-&gt;num_irqs
op_assign
id|len
op_div
r_sizeof
(paren
id|irqs
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;num_irqs
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;irqs
(braket
id|i
)braket
op_assign
id|psycho_irq_build
c_func
(paren
id|irqs
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
macro_line|#ifdef DEBUG_FILL_EBUS_DEV
id|printk
c_func
(paren
l_string|&quot;&squot;%s&squot;: address%s&bslash;n&quot;
comma
id|dev-&gt;prom_name
comma
id|dev-&gt;num_addrs
OG
l_int|1
ques
c_cond
l_string|&quot;es&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;num_addrs
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;  %016lx&bslash;n&quot;
comma
id|dev-&gt;base_address
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;num_irqs
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;  IRQ%s&quot;
comma
id|dev-&gt;num_irqs
OG
l_int|1
ques
c_cond
l_string|&quot;s&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;num_irqs
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %08x&quot;
comma
id|dev-&gt;irqs
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
r_int
id|ebus_init
c_func
(paren
r_int
r_int
id|memory_start
comma
r_int
r_int
id|memory_end
)paren
)paren
(brace
r_struct
id|linux_prom_pci_registers
id|regs
(braket
id|PROMREG_MAX
)braket
suffix:semicolon
r_struct
id|linux_pbm_info
op_star
id|pbm
suffix:semicolon
r_struct
id|linux_ebus_device
op_star
id|dev
suffix:semicolon
r_struct
id|linux_ebus
op_star
id|ebus
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
r_char
id|lbuf
(braket
l_int|128
)braket
suffix:semicolon
r_int
r_int
id|addr
comma
op_star
id|base
suffix:semicolon
r_int
id|nd
comma
id|len
comma
id|ebusnd
comma
id|topnd
suffix:semicolon
r_int
id|reg
comma
id|rng
comma
id|nreg
suffix:semicolon
r_int
id|devfn
suffix:semicolon
r_int
id|num_ebus
op_assign
l_int|0
suffix:semicolon
macro_line|#ifndef CONFIG_PCI
r_return
id|memory_start
suffix:semicolon
macro_line|#endif
id|memory_start
op_assign
(paren
(paren
id|memory_start
op_plus
l_int|7
)paren
op_amp
(paren
op_complement
l_int|7
)paren
)paren
suffix:semicolon
id|topnd
op_assign
id|psycho_root-&gt;pbm_B.prom_node
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|topnd
)paren
r_return
id|memory_start
suffix:semicolon
id|ebusnd
op_assign
id|prom_searchsiblings
c_func
(paren
id|prom_getchild
c_func
(paren
id|topnd
)paren
comma
l_string|&quot;ebus&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ebusnd
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;EBUS: No EBUS&squot;s found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|memory_start
suffix:semicolon
)brace
id|ebus_chain
op_assign
id|ebus
op_assign
(paren
r_struct
id|linux_ebus
op_star
)paren
id|memory_start
suffix:semicolon
id|memory_start
op_add_assign
r_sizeof
(paren
r_struct
id|linux_ebus
)paren
suffix:semicolon
id|ebus-&gt;next
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|ebusnd
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ebus%d:&bslash;n&quot;
comma
id|num_ebus
)paren
suffix:semicolon
id|prom_getstring
c_func
(paren
id|ebusnd
comma
l_string|&quot;name&quot;
comma
id|lbuf
comma
r_sizeof
(paren
id|lbuf
)paren
)paren
suffix:semicolon
id|ebus-&gt;prom_node
op_assign
id|ebusnd
suffix:semicolon
id|strcpy
c_func
(paren
id|ebus-&gt;prom_name
comma
id|lbuf
)paren
suffix:semicolon
id|ebus-&gt;parent
op_assign
id|pbm
op_assign
op_amp
id|psycho_root-&gt;pbm_B
suffix:semicolon
id|len
op_assign
id|prom_getproperty
c_func
(paren
id|ebusnd
comma
l_string|&quot;reg&quot;
comma
(paren
r_void
op_star
)paren
id|regs
comma
r_sizeof
(paren
id|regs
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_eq
l_int|0
op_logical_or
id|len
op_eq
op_minus
l_int|1
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;%s: can&squot;t find reg property&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|nreg
op_assign
id|len
op_div
r_sizeof
(paren
r_struct
id|linux_prom_pci_registers
)paren
suffix:semicolon
id|devfn
op_assign
(paren
id|regs
(braket
l_int|0
)braket
dot
id|phys_hi
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
r_for
c_loop
(paren
id|pdev
op_assign
id|pbm-&gt;pci_bus.devices
suffix:semicolon
id|pdev
suffix:semicolon
id|pdev
op_assign
id|pdev-&gt;sibling
)paren
r_if
c_cond
(paren
id|pdev-&gt;devfn
op_eq
id|devfn
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pdev
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;%s: can&squot;t find PCI device&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|ebus-&gt;self
op_assign
id|pdev
suffix:semicolon
id|base
op_assign
op_amp
id|ebus-&gt;self-&gt;base_address
(braket
l_int|0
)braket
suffix:semicolon
r_for
c_loop
(paren
id|reg
op_assign
l_int|0
suffix:semicolon
id|reg
OL
id|nreg
suffix:semicolon
id|reg
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|regs
(braket
id|reg
)braket
dot
id|phys_hi
op_amp
l_int|0x03000000
)paren
)paren
r_continue
suffix:semicolon
r_for
c_loop
(paren
id|rng
op_assign
l_int|0
suffix:semicolon
id|rng
OL
id|pbm-&gt;num_pbm_ranges
suffix:semicolon
id|rng
op_increment
)paren
(brace
r_struct
id|linux_prom_pci_ranges
op_star
id|rp
op_assign
op_amp
id|pbm-&gt;pbm_ranges
(braket
id|rng
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rp-&gt;child_phys_hi
op_xor
id|regs
(braket
id|reg
)braket
dot
id|phys_hi
)paren
op_amp
l_int|0x03000000
)paren
r_continue
suffix:semicolon
id|addr
op_assign
(paren
id|u64
)paren
id|regs
(braket
id|reg
)braket
dot
id|phys_lo
suffix:semicolon
id|addr
op_add_assign
(paren
id|u64
)paren
id|regs
(braket
id|reg
)braket
dot
id|phys_mid
op_lshift
l_int|32UL
suffix:semicolon
id|addr
op_add_assign
(paren
id|u64
)paren
id|rp-&gt;parent_phys_lo
suffix:semicolon
id|addr
op_add_assign
(paren
id|u64
)paren
id|rp-&gt;parent_phys_hi
op_lshift
l_int|32UL
suffix:semicolon
op_star
id|base
op_increment
op_assign
(paren
r_int
r_int
)paren
id|__va
c_func
(paren
id|addr
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|prom_ebus_ranges_init
c_func
(paren
id|ebus
)paren
suffix:semicolon
id|nd
op_assign
id|prom_getchild
c_func
(paren
id|ebusnd
)paren
suffix:semicolon
id|ebus-&gt;devices
op_assign
(paren
r_struct
id|linux_ebus_device
op_star
)paren
id|memory_start
suffix:semicolon
id|memory_start
op_add_assign
r_sizeof
(paren
r_struct
id|linux_ebus_device
)paren
suffix:semicolon
id|dev
op_assign
id|ebus-&gt;devices
suffix:semicolon
id|dev-&gt;next
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;parent
op_assign
id|ebus
suffix:semicolon
id|fill_ebus_device
c_func
(paren
id|nd
comma
id|dev
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|nd
op_assign
id|prom_getsibling
c_func
(paren
id|nd
)paren
)paren
)paren
(brace
id|dev-&gt;next
op_assign
(paren
r_struct
id|linux_ebus_device
op_star
)paren
id|memory_start
suffix:semicolon
id|memory_start
op_add_assign
r_sizeof
(paren
r_struct
id|linux_ebus_device
)paren
suffix:semicolon
id|dev
op_assign
id|dev-&gt;next
suffix:semicolon
id|dev-&gt;next
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;parent
op_assign
id|ebus
suffix:semicolon
id|fill_ebus_device
c_func
(paren
id|nd
comma
id|dev
)paren
suffix:semicolon
)brace
id|ebusnd
op_assign
id|prom_searchsiblings
c_func
(paren
id|prom_getsibling
c_func
(paren
id|ebusnd
)paren
comma
l_string|&quot;ebus&quot;
)paren
suffix:semicolon
op_increment
id|num_ebus
suffix:semicolon
)brace
id|memory_start
op_assign
id|pci_console_init
c_func
(paren
id|memory_start
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SUN_OPENPROMIO
id|openprom_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_SUN_MOSTEK_RTC
id|rtc_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_SPARCAUDIO
id|sparcaudio_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_SUN_BPP
id|bpp_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_SUN_AUXIO
r_if
c_cond
(paren
id|sparc_cpu_model
op_eq
id|sun4u
)paren
id|auxio_probe
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef __sparc_v9__
r_if
c_cond
(paren
id|sparc_cpu_model
op_eq
id|sun4u
)paren
(brace
r_extern
r_void
id|sun4u_start_timers
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|clock_probe
c_func
(paren
r_void
)paren
suffix:semicolon
id|sun4u_start_timers
c_func
(paren
)paren
suffix:semicolon
id|clock_probe
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
id|memory_start
suffix:semicolon
)brace
eof
