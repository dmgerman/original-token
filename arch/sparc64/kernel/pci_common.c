multiline_comment|/* $Id: pci_common.c,v 1.12 2000/05/01 06:32:49 davem Exp $&n; * pci_common.c: PCI controller common support.&n; *&n; * Copyright (C) 1999 David S. Miller (davem@redhat.com)&n; */
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/pbm.h&gt;
multiline_comment|/* Find the OBP PROM device tree node for a PCI device.&n; * Return zero if not found.&n; */
DECL|function|find_device_prom_node
r_static
r_int
id|__init
id|find_device_prom_node
c_func
(paren
r_struct
id|pci_pbm_info
op_star
id|pbm
comma
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
id|bus_prom_node
comma
r_struct
id|linux_prom_pci_registers
op_star
id|pregs
comma
r_int
op_star
id|nregs
)paren
(brace
r_int
id|node
suffix:semicolon
multiline_comment|/*&n;&t; * Return the PBM&squot;s PROM node in case we are it&squot;s PCI device,&n;&t; * as the PBM&squot;s reg property is different to standard PCI reg&n;&t; * properties. We would delete this device entry otherwise,&n;&t; * which confuses XFree86&squot;s device probing...&n;&t; */
r_if
c_cond
(paren
(paren
id|pdev-&gt;bus-&gt;number
op_eq
id|pbm-&gt;pci_bus-&gt;number
)paren
op_logical_and
(paren
id|pdev-&gt;devfn
op_eq
l_int|0
)paren
op_logical_and
(paren
id|pdev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_SUN
)paren
op_logical_and
(paren
id|pdev-&gt;device
op_eq
id|PCI_DEVICE_ID_SUN_PBM
)paren
)paren
(brace
op_star
id|nregs
op_assign
l_int|0
suffix:semicolon
r_return
id|bus_prom_node
suffix:semicolon
)brace
id|node
op_assign
id|prom_getchild
c_func
(paren
id|bus_prom_node
)paren
suffix:semicolon
r_while
c_loop
(paren
id|node
op_ne
l_int|0
)paren
(brace
r_int
id|err
op_assign
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;reg&quot;
comma
(paren
r_char
op_star
)paren
id|pregs
comma
r_sizeof
(paren
op_star
id|pregs
)paren
op_star
id|PROMREG_MAX
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
l_int|0
op_logical_or
id|err
op_eq
op_minus
l_int|1
)paren
r_goto
id|do_next_sibling
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|pregs
(braket
l_int|0
)braket
dot
id|phys_hi
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
op_eq
id|pdev-&gt;devfn
)paren
(brace
op_star
id|nregs
op_assign
id|err
op_div
r_sizeof
(paren
op_star
id|pregs
)paren
suffix:semicolon
r_return
id|node
suffix:semicolon
)brace
id|do_next_sibling
suffix:colon
id|node
op_assign
id|prom_getsibling
c_func
(paren
id|node
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Remove a PCI device from the device trees, then&n; * free it up.  Note that this must run before&n; * the device&squot;s resources are registered because we&n; * do not handle unregistering them here.&n; */
DECL|function|pci_device_delete
r_static
r_void
id|pci_device_delete
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|pdev-&gt;global_list
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|pdev-&gt;bus_list
)paren
suffix:semicolon
multiline_comment|/* Ok, all references are gone, free it up. */
id|kfree
c_func
(paren
id|pdev
)paren
suffix:semicolon
)brace
multiline_comment|/* Older versions of OBP on PCI systems encode 64-bit MEM&n; * space assignments incorrectly, this fixes them up.&n; */
DECL|function|fixup_obp_assignments
r_static
r_void
id|__init
id|fixup_obp_assignments
c_func
(paren
r_struct
id|pcidev_cookie
op_star
id|pcp
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pcp-&gt;num_prom_assignments
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|linux_prom_pci_registers
op_star
id|ap
suffix:semicolon
r_int
id|space
suffix:semicolon
id|ap
op_assign
op_amp
id|pcp-&gt;prom_assignments
(braket
id|i
)braket
suffix:semicolon
id|space
op_assign
id|ap-&gt;phys_hi
op_rshift
l_int|24
suffix:semicolon
r_if
c_cond
(paren
(paren
id|space
op_amp
l_int|0x3
)paren
op_eq
l_int|2
op_logical_and
(paren
id|space
op_amp
l_int|0x4
)paren
op_ne
l_int|0
)paren
(brace
id|ap-&gt;phys_hi
op_and_assign
op_complement
(paren
l_int|0x7
op_lshift
l_int|24
)paren
suffix:semicolon
id|ap-&gt;phys_hi
op_or_assign
l_int|0x3
op_lshift
l_int|24
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Fill in the PCI device cookie sysdata for the given&n; * PCI device.  This cookie is the means by which one&n; * can get to OBP and PCI controller specific information&n; * for a PCI device.&n; */
DECL|function|pdev_cookie_fillin
r_static
r_void
id|__init
id|pdev_cookie_fillin
c_func
(paren
r_struct
id|pci_pbm_info
op_star
id|pbm
comma
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
id|bus_prom_node
)paren
(brace
r_struct
id|linux_prom_pci_registers
id|pregs
(braket
id|PROMREG_MAX
)braket
suffix:semicolon
r_struct
id|pcidev_cookie
op_star
id|pcp
suffix:semicolon
r_int
id|device_prom_node
comma
id|nregs
comma
id|err
suffix:semicolon
id|device_prom_node
op_assign
id|find_device_prom_node
c_func
(paren
id|pbm
comma
id|pdev
comma
id|bus_prom_node
comma
id|pregs
comma
op_amp
id|nregs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device_prom_node
op_eq
l_int|0
)paren
(brace
multiline_comment|/* If it is not in the OBP device tree then&n;&t;&t; * there must be a damn good reason for it.&n;&t;&t; *&n;&t;&t; * So what we do is delete the device from the&n;&t;&t; * PCI device tree completely.  This scenerio&n;&t;&t; * is seen, for example, on CP1500 for the&n;&t;&t; * second EBUS/HappyMeal pair if the external&n;&t;&t; * connector for it is not present.&n;&t;&t; */
id|pci_device_delete
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|pcp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|pcp
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcp
op_eq
l_int|NULL
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;PCI_COOKIE: Fatal malloc error, aborting...&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|pcp-&gt;pbm
op_assign
id|pbm
suffix:semicolon
id|pcp-&gt;prom_node
op_assign
id|device_prom_node
suffix:semicolon
id|memcpy
c_func
(paren
id|pcp-&gt;prom_regs
comma
id|pregs
comma
r_sizeof
(paren
id|pcp-&gt;prom_regs
)paren
)paren
suffix:semicolon
id|pcp-&gt;num_prom_regs
op_assign
id|nregs
suffix:semicolon
id|err
op_assign
id|prom_getproperty
c_func
(paren
id|device_prom_node
comma
l_string|&quot;name&quot;
comma
id|pcp-&gt;prom_name
comma
r_sizeof
(paren
id|pcp-&gt;prom_name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OG
l_int|0
)paren
id|pcp-&gt;prom_name
(braket
id|err
)braket
op_assign
l_int|0
suffix:semicolon
r_else
id|pcp-&gt;prom_name
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|pcp-&gt;prom_name
comma
l_string|&quot;ebus&quot;
)paren
op_eq
l_int|0
)paren
(brace
r_struct
id|linux_prom_ebus_ranges
id|erng
(braket
id|PROM_PCIRNG_MAX
)braket
suffix:semicolon
r_int
id|iter
suffix:semicolon
multiline_comment|/* EBUS is special... */
id|err
op_assign
id|prom_getproperty
c_func
(paren
id|device_prom_node
comma
l_string|&quot;ranges&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|erng
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|erng
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
l_int|0
op_logical_or
id|err
op_eq
op_minus
l_int|1
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;EBUS: Fatal error, no range property&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|err
op_assign
(paren
id|err
op_div
r_sizeof
(paren
id|erng
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|iter
op_assign
l_int|0
suffix:semicolon
id|iter
OL
id|err
suffix:semicolon
id|iter
op_increment
)paren
(brace
r_struct
id|linux_prom_ebus_ranges
op_star
id|ep
op_assign
op_amp
id|erng
(braket
id|iter
)braket
suffix:semicolon
r_struct
id|linux_prom_pci_registers
op_star
id|ap
suffix:semicolon
id|ap
op_assign
op_amp
id|pcp-&gt;prom_assignments
(braket
id|iter
)braket
suffix:semicolon
id|ap-&gt;phys_hi
op_assign
id|ep-&gt;parent_phys_hi
suffix:semicolon
id|ap-&gt;phys_mid
op_assign
id|ep-&gt;parent_phys_mid
suffix:semicolon
id|ap-&gt;phys_lo
op_assign
id|ep-&gt;parent_phys_lo
suffix:semicolon
id|ap-&gt;size_hi
op_assign
l_int|0
suffix:semicolon
id|ap-&gt;size_lo
op_assign
id|ep-&gt;size
suffix:semicolon
)brace
id|pcp-&gt;num_prom_assignments
op_assign
id|err
suffix:semicolon
)brace
r_else
(brace
id|err
op_assign
id|prom_getproperty
c_func
(paren
id|device_prom_node
comma
l_string|&quot;assigned-addresses&quot;
comma
(paren
r_char
op_star
)paren
id|pcp-&gt;prom_assignments
comma
r_sizeof
(paren
id|pcp-&gt;prom_assignments
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
l_int|0
op_logical_or
id|err
op_eq
op_minus
l_int|1
)paren
id|pcp-&gt;num_prom_assignments
op_assign
l_int|0
suffix:semicolon
r_else
id|pcp-&gt;num_prom_assignments
op_assign
(paren
id|err
op_div
r_sizeof
(paren
id|pcp-&gt;prom_assignments
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
)brace
id|fixup_obp_assignments
c_func
(paren
id|pcp
)paren
suffix:semicolon
id|pdev-&gt;sysdata
op_assign
id|pcp
suffix:semicolon
)brace
DECL|function|pci_fill_in_pbm_cookies
r_void
id|__init
id|pci_fill_in_pbm_cookies
c_func
(paren
r_struct
id|pci_bus
op_star
id|pbus
comma
r_struct
id|pci_pbm_info
op_star
id|pbm
comma
r_int
id|prom_node
)paren
(brace
r_struct
id|list_head
op_star
id|walk
op_assign
op_amp
id|pbus-&gt;devices
suffix:semicolon
multiline_comment|/* This loop is coded like this because the cookie&n;&t; * fillin routine can delete devices from the tree.&n;&t; */
id|walk
op_assign
id|walk-&gt;next
suffix:semicolon
r_while
c_loop
(paren
id|walk
op_ne
op_amp
id|pbus-&gt;devices
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|pci_dev_b
c_func
(paren
id|walk
)paren
suffix:semicolon
r_struct
id|list_head
op_star
id|walk_next
op_assign
id|walk-&gt;next
suffix:semicolon
id|pdev_cookie_fillin
c_func
(paren
id|pbm
comma
id|pdev
comma
id|prom_node
)paren
suffix:semicolon
id|walk
op_assign
id|walk_next
suffix:semicolon
)brace
id|walk
op_assign
op_amp
id|pbus-&gt;children
suffix:semicolon
id|walk
op_assign
id|walk-&gt;next
suffix:semicolon
r_while
c_loop
(paren
id|walk
op_ne
op_amp
id|pbus-&gt;children
)paren
(brace
r_struct
id|pci_bus
op_star
id|this_pbus
op_assign
id|pci_bus_b
c_func
(paren
id|walk
)paren
suffix:semicolon
r_struct
id|pcidev_cookie
op_star
id|pcp
op_assign
id|this_pbus-&gt;self-&gt;sysdata
suffix:semicolon
r_struct
id|list_head
op_star
id|walk_next
op_assign
id|walk-&gt;next
suffix:semicolon
id|pci_fill_in_pbm_cookies
c_func
(paren
id|this_pbus
comma
id|pbm
comma
id|pcp-&gt;prom_node
)paren
suffix:semicolon
id|walk
op_assign
id|walk_next
suffix:semicolon
)brace
)brace
DECL|function|bad_assignment
r_static
r_void
id|__init
id|bad_assignment
c_func
(paren
r_struct
id|linux_prom_pci_registers
op_star
id|ap
comma
r_struct
id|resource
op_star
id|res
comma
r_int
id|do_prom_halt
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;PCI: Bogus PROM assignment.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ap
)paren
id|prom_printf
c_func
(paren
l_string|&quot;PCI: phys[%08x:%08x:%08x] size[%08x:%08x]&bslash;n&quot;
comma
id|ap-&gt;phys_hi
comma
id|ap-&gt;phys_mid
comma
id|ap-&gt;phys_lo
comma
id|ap-&gt;size_hi
comma
id|ap-&gt;size_lo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
id|prom_printf
c_func
(paren
l_string|&quot;PCI: RES[%016lx--&gt;%016lx:(%lx)]&bslash;n&quot;
comma
id|res-&gt;start
comma
id|res-&gt;end
comma
id|res-&gt;flags
)paren
suffix:semicolon
id|prom_printf
c_func
(paren
l_string|&quot;Please email this information to davem@redhat.com&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|do_prom_halt
)paren
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
r_static
r_struct
id|resource
op_star
DECL|function|get_root_resource
id|__init
id|get_root_resource
c_func
(paren
r_struct
id|linux_prom_pci_registers
op_star
id|ap
comma
r_struct
id|pci_pbm_info
op_star
id|pbm
)paren
(brace
r_int
id|space
op_assign
(paren
id|ap-&gt;phys_hi
op_rshift
l_int|24
)paren
op_amp
l_int|3
suffix:semicolon
r_switch
c_cond
(paren
id|space
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* Configuration space, silently ignore it. */
r_return
l_int|NULL
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* 16-bit IO space */
r_return
op_amp
id|pbm-&gt;io_space
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* 32-bit MEM space */
r_return
op_amp
id|pbm-&gt;mem_space
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* 64-bit MEM space, these are allocated out of&n;&t;&t; * the 32-bit mem_space range for the PBM, ie.&n;&t;&t; * we just zero out the upper 32-bits.&n;&t;&t; */
r_return
op_amp
id|pbm-&gt;mem_space
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;PCI: What is resource space %x? &quot;
l_string|&quot;Tell davem@redhat.com about it!&bslash;n&quot;
comma
id|space
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
suffix:semicolon
)brace
r_static
r_struct
id|resource
op_star
DECL|function|get_device_resource
id|__init
id|get_device_resource
c_func
(paren
r_struct
id|linux_prom_pci_registers
op_star
id|ap
comma
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|resource
op_star
id|res
suffix:semicolon
r_int
id|breg
op_assign
(paren
id|ap-&gt;phys_hi
op_amp
l_int|0xff
)paren
suffix:semicolon
r_int
id|space
op_assign
(paren
id|ap-&gt;phys_hi
op_rshift
l_int|24
)paren
op_amp
l_int|3
suffix:semicolon
r_switch
c_cond
(paren
id|breg
)paren
(brace
r_case
id|PCI_ROM_ADDRESS
suffix:colon
multiline_comment|/* It had better be MEM space. */
r_if
c_cond
(paren
id|space
op_ne
l_int|2
)paren
id|bad_assignment
c_func
(paren
id|ap
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|res
op_assign
op_amp
id|pdev-&gt;resource
(braket
id|PCI_ROM_RESOURCE
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_BASE_ADDRESS_0
suffix:colon
r_case
id|PCI_BASE_ADDRESS_1
suffix:colon
r_case
id|PCI_BASE_ADDRESS_2
suffix:colon
r_case
id|PCI_BASE_ADDRESS_3
suffix:colon
r_case
id|PCI_BASE_ADDRESS_4
suffix:colon
r_case
id|PCI_BASE_ADDRESS_5
suffix:colon
id|res
op_assign
op_amp
id|pdev-&gt;resource
(braket
(paren
id|breg
op_minus
id|PCI_BASE_ADDRESS_0
)paren
op_div
l_int|4
)braket
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|bad_assignment
c_func
(paren
id|ap
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|res
op_assign
l_int|NULL
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
DECL|function|pdev_record_assignments
r_static
r_void
id|__init
id|pdev_record_assignments
c_func
(paren
r_struct
id|pci_pbm_info
op_star
id|pbm
comma
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|pcidev_cookie
op_star
id|pcp
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pcp-&gt;num_prom_assignments
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|linux_prom_pci_registers
op_star
id|ap
suffix:semicolon
r_struct
id|resource
op_star
id|root
comma
op_star
id|res
suffix:semicolon
multiline_comment|/* The format of this property is specified in&n;&t;&t; * the PCI Bus Binding to IEEE1275-1994.&n;&t;&t; */
id|ap
op_assign
op_amp
id|pcp-&gt;prom_assignments
(braket
id|i
)braket
suffix:semicolon
id|root
op_assign
id|get_root_resource
c_func
(paren
id|ap
comma
id|pbm
)paren
suffix:semicolon
id|res
op_assign
id|get_device_resource
c_func
(paren
id|ap
comma
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|root
op_eq
l_int|NULL
op_logical_or
id|res
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
multiline_comment|/* Ok we know which resource this PROM assignment is&n;&t;&t; * for, sanity check it.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|res-&gt;start
op_amp
l_int|0xffffffffUL
)paren
op_ne
id|ap-&gt;phys_lo
)paren
id|bad_assignment
c_func
(paren
id|ap
comma
id|res
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* If it is a 64-bit MEM space assignment, verify that&n;&t;&t; * the resource is too and that the upper 32-bits match.&n;&t;&t; */
r_if
c_cond
(paren
(paren
(paren
id|ap-&gt;phys_hi
op_rshift
l_int|24
)paren
op_amp
l_int|3
)paren
op_eq
l_int|3
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|res-&gt;flags
op_amp
id|IORESOURCE_MEM
)paren
op_eq
l_int|0
)paren
op_logical_or
(paren
(paren
id|res-&gt;flags
op_amp
id|PCI_BASE_ADDRESS_MEM_TYPE_MASK
)paren
op_ne
id|PCI_BASE_ADDRESS_MEM_TYPE_64
)paren
)paren
id|bad_assignment
c_func
(paren
id|ap
comma
id|res
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res-&gt;start
op_rshift
l_int|32
)paren
op_ne
id|ap-&gt;phys_mid
)paren
id|bad_assignment
c_func
(paren
id|ap
comma
id|res
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* PBM cannot generate cpu initiated PIOs&n;&t;&t;&t; * to the full 64-bit space.  Therefore the&n;&t;&t;&t; * upper 32-bits better be zero.  If it is&n;&t;&t;&t; * not, just skip it and we will assign it&n;&t;&t;&t; * properly ourselves.&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|res-&gt;start
op_rshift
l_int|32
)paren
op_ne
l_int|0UL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PCI: OBP assigns out of range MEM address &quot;
l_string|&quot;%016lx for region %ld on device %s&bslash;n&quot;
comma
id|res-&gt;start
comma
(paren
id|res
op_minus
op_amp
id|pdev-&gt;resource
(braket
l_int|0
)braket
)paren
comma
id|pdev-&gt;name
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
multiline_comment|/* Adjust the resource into the physical address space&n;&t;&t; * of this PBM.&n;&t;&t; */
id|pbm-&gt;parent
op_member_access_from_pointer
id|resource_adjust
c_func
(paren
id|pdev
comma
id|res
comma
id|root
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_resource
c_func
(paren
id|root
comma
id|res
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* OK, there is some conflict.  But this is fine&n;&t;&t;&t; * since we&squot;ll reassign it in the fixup pass.&n;&t;&t;&t; * Nevertheless notify the user that OBP made&n;&t;&t;&t; * an error.&n;&t;&t;&t; */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PCI: Address space collision on region %ld &quot;
l_string|&quot;of device %s&bslash;n&quot;
comma
(paren
id|res
op_minus
op_amp
id|pdev-&gt;resource
(braket
l_int|0
)braket
)paren
comma
id|pdev-&gt;name
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|pci_record_assignments
r_void
id|__init
id|pci_record_assignments
c_func
(paren
r_struct
id|pci_pbm_info
op_star
id|pbm
comma
r_struct
id|pci_bus
op_star
id|pbus
)paren
(brace
r_struct
id|list_head
op_star
id|walk
op_assign
op_amp
id|pbus-&gt;devices
suffix:semicolon
r_for
c_loop
(paren
id|walk
op_assign
id|walk-&gt;next
suffix:semicolon
id|walk
op_ne
op_amp
id|pbus-&gt;devices
suffix:semicolon
id|walk
op_assign
id|walk-&gt;next
)paren
id|pdev_record_assignments
c_func
(paren
id|pbm
comma
id|pci_dev_b
c_func
(paren
id|walk
)paren
)paren
suffix:semicolon
id|walk
op_assign
op_amp
id|pbus-&gt;children
suffix:semicolon
r_for
c_loop
(paren
id|walk
op_assign
id|walk-&gt;next
suffix:semicolon
id|walk
op_ne
op_amp
id|pbus-&gt;children
suffix:semicolon
id|walk
op_assign
id|walk-&gt;next
)paren
id|pci_record_assignments
c_func
(paren
id|pbm
comma
id|pci_bus_b
c_func
(paren
id|walk
)paren
)paren
suffix:semicolon
)brace
DECL|function|pdev_assign_unassigned
r_static
r_void
id|__init
id|pdev_assign_unassigned
c_func
(paren
r_struct
id|pci_pbm_info
op_star
id|pbm
comma
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|u32
id|reg
suffix:semicolon
id|u16
id|cmd
suffix:semicolon
r_int
id|i
comma
id|io_seen
comma
id|mem_seen
suffix:semicolon
id|io_seen
op_assign
id|mem_seen
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PCI_NUM_RESOURCES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|resource
op_star
id|root
comma
op_star
id|res
suffix:semicolon
r_int
r_int
id|size
comma
id|min
comma
id|max
comma
id|align
suffix:semicolon
id|res
op_assign
op_amp
id|pdev-&gt;resource
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|res-&gt;flags
op_amp
id|IORESOURCE_IO
)paren
id|io_seen
op_increment
suffix:semicolon
r_else
r_if
c_cond
(paren
id|res-&gt;flags
op_amp
id|IORESOURCE_MEM
)paren
id|mem_seen
op_increment
suffix:semicolon
multiline_comment|/* If it is already assigned or the resource does&n;&t;&t; * not exist, there is nothing to do.&n;&t;&t; */
r_if
c_cond
(paren
id|res-&gt;parent
op_ne
l_int|NULL
op_logical_or
id|res-&gt;flags
op_eq
l_int|0UL
)paren
r_continue
suffix:semicolon
multiline_comment|/* Determine the root we allocate from. */
r_if
c_cond
(paren
id|res-&gt;flags
op_amp
id|IORESOURCE_IO
)paren
(brace
id|root
op_assign
op_amp
id|pbm-&gt;io_space
suffix:semicolon
id|min
op_assign
id|root-&gt;start
op_plus
l_int|0x400UL
suffix:semicolon
id|max
op_assign
id|root-&gt;end
suffix:semicolon
)brace
r_else
(brace
id|root
op_assign
op_amp
id|pbm-&gt;mem_space
suffix:semicolon
id|min
op_assign
id|root-&gt;start
suffix:semicolon
id|max
op_assign
id|min
op_plus
l_int|0x80000000UL
suffix:semicolon
)brace
id|size
op_assign
id|res-&gt;end
op_minus
id|res-&gt;start
suffix:semicolon
id|align
op_assign
id|size
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|allocate_resource
c_func
(paren
id|root
comma
id|res
comma
id|size
op_plus
l_int|1
comma
id|min
comma
id|max
comma
id|align
comma
l_int|NULL
comma
l_int|NULL
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* uh oh */
id|prom_printf
c_func
(paren
l_string|&quot;PCI: Failed to allocate resource %d for %s&bslash;n&quot;
comma
id|i
comma
id|pdev-&gt;name
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Update PCI config space. */
id|pbm-&gt;parent
op_member_access_from_pointer
id|base_address_update
c_func
(paren
id|pdev
comma
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/* Special case, disable the ROM.  Several devices&n;&t; * act funny (ie. do not respond to memory space writes)&n;&t; * when it is left enabled.  A good example are Qlogic,ISP&n;&t; * adapters.&n;&t; */
id|pci_read_config_dword
c_func
(paren
id|pdev
comma
id|PCI_ROM_ADDRESS
comma
op_amp
id|reg
)paren
suffix:semicolon
id|reg
op_and_assign
op_complement
id|PCI_ROM_ADDRESS_ENABLE
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|pdev
comma
id|PCI_ROM_ADDRESS
comma
id|reg
)paren
suffix:semicolon
multiline_comment|/* If we saw I/O or MEM resources, enable appropriate&n;&t; * bits in PCI command register.&n;&t; */
r_if
c_cond
(paren
id|io_seen
op_logical_or
id|mem_seen
)paren
(brace
id|pci_read_config_word
c_func
(paren
id|pdev
comma
id|PCI_COMMAND
comma
op_amp
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|io_seen
)paren
id|cmd
op_or_assign
id|PCI_COMMAND_IO
suffix:semicolon
r_if
c_cond
(paren
id|mem_seen
)paren
id|cmd
op_or_assign
id|PCI_COMMAND_MEMORY
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|pdev
comma
id|PCI_COMMAND
comma
id|cmd
)paren
suffix:semicolon
)brace
multiline_comment|/* If this is a PCI bridge or an IDE controller,&n;&t; * enable bus mastering.  In the former case also&n;&t; * set the cache line size correctly.&n;&t; */
r_if
c_cond
(paren
(paren
(paren
id|pdev
op_member_access_from_pointer
r_class
op_rshift
l_int|8
)paren
op_eq
id|PCI_CLASS_BRIDGE_PCI
)paren
op_logical_or
(paren
(paren
(paren
id|pdev
op_member_access_from_pointer
r_class
op_rshift
l_int|8
)paren
op_eq
id|PCI_CLASS_STORAGE_IDE
)paren
op_logical_and
(paren
(paren
id|pdev
op_member_access_from_pointer
r_class
op_amp
l_int|0x80
)paren
op_ne
l_int|0
)paren
)paren
)paren
(brace
id|pci_read_config_word
c_func
(paren
id|pdev
comma
id|PCI_COMMAND
comma
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd
op_or_assign
id|PCI_COMMAND_MASTER
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|pdev
comma
id|PCI_COMMAND
comma
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pdev
op_member_access_from_pointer
r_class
op_rshift
l_int|8
)paren
op_eq
id|PCI_CLASS_BRIDGE_PCI
)paren
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
id|PCI_CACHE_LINE_SIZE
comma
(paren
l_int|64
op_div
r_sizeof
(paren
id|u32
)paren
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|pci_assign_unassigned
r_void
id|__init
id|pci_assign_unassigned
c_func
(paren
r_struct
id|pci_pbm_info
op_star
id|pbm
comma
r_struct
id|pci_bus
op_star
id|pbus
)paren
(brace
r_struct
id|list_head
op_star
id|walk
op_assign
op_amp
id|pbus-&gt;devices
suffix:semicolon
r_for
c_loop
(paren
id|walk
op_assign
id|walk-&gt;next
suffix:semicolon
id|walk
op_ne
op_amp
id|pbus-&gt;devices
suffix:semicolon
id|walk
op_assign
id|walk-&gt;next
)paren
id|pdev_assign_unassigned
c_func
(paren
id|pbm
comma
id|pci_dev_b
c_func
(paren
id|walk
)paren
)paren
suffix:semicolon
id|walk
op_assign
op_amp
id|pbus-&gt;children
suffix:semicolon
r_for
c_loop
(paren
id|walk
op_assign
id|walk-&gt;next
suffix:semicolon
id|walk
op_ne
op_amp
id|pbus-&gt;children
suffix:semicolon
id|walk
op_assign
id|walk-&gt;next
)paren
id|pci_assign_unassigned
c_func
(paren
id|pbm
comma
id|pci_bus_b
c_func
(paren
id|walk
)paren
)paren
suffix:semicolon
)brace
DECL|function|pci_intmap_match
r_static
r_int
id|__init
id|pci_intmap_match
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
r_int
op_star
id|interrupt
)paren
(brace
r_struct
id|pcidev_cookie
op_star
id|dev_pcp
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
r_struct
id|pci_pbm_info
op_star
id|pbm
op_assign
id|dev_pcp-&gt;pbm
suffix:semicolon
r_struct
id|linux_prom_pci_registers
op_star
id|pregs
op_assign
id|dev_pcp-&gt;prom_regs
suffix:semicolon
r_int
r_int
id|hi
comma
id|mid
comma
id|lo
comma
id|irq
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|pbm-&gt;num_pbm_intmap
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* If we are underneath a PCI bridge, use PROM register&n;&t; * property of the parent bridge which is closest to&n;&t; * the PBM.&n;&t; */
r_if
c_cond
(paren
id|pdev-&gt;bus-&gt;number
op_ne
id|pbm-&gt;pci_first_busno
)paren
(brace
r_struct
id|pcidev_cookie
op_star
id|bus_pcp
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pwalk
suffix:semicolon
r_int
id|offset
suffix:semicolon
id|pwalk
op_assign
id|pdev-&gt;bus-&gt;self
suffix:semicolon
r_while
c_loop
(paren
id|pwalk-&gt;bus
op_logical_and
id|pwalk-&gt;bus-&gt;number
op_ne
id|pbm-&gt;pci_first_busno
)paren
id|pwalk
op_assign
id|pwalk-&gt;bus-&gt;self
suffix:semicolon
id|bus_pcp
op_assign
id|pwalk-&gt;sysdata
suffix:semicolon
id|pregs
op_assign
id|bus_pcp-&gt;prom_regs
suffix:semicolon
id|offset
op_assign
id|prom_getint
c_func
(paren
id|dev_pcp-&gt;prom_node
comma
l_string|&quot;fcode-rom-offset&quot;
)paren
suffix:semicolon
multiline_comment|/* Did PROM know better and assign an interrupt other&n;&t;&t; * than #INTA to the device? - We test here for presence of&n;&t;&t; * FCODE on the card, in this case we assume PROM has set&n;&t;&t; * correct &squot;interrupts&squot; property, unless it is quadhme.&n;&t;&t; */
r_if
c_cond
(paren
id|offset
op_eq
op_minus
l_int|1
op_logical_or
op_logical_neg
id|strcmp
c_func
(paren
id|dev_pcp-&gt;prom_name
comma
l_string|&quot;SUNW,qfe&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
c_func
(paren
id|dev_pcp-&gt;prom_name
comma
l_string|&quot;qfe&quot;
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * No, use low slot number bits of child as IRQ line.&n;&t;&t;&t; */
op_star
id|interrupt
op_assign
(paren
(paren
op_star
id|interrupt
op_minus
l_int|1
op_plus
id|PCI_SLOT
c_func
(paren
id|pdev-&gt;devfn
)paren
)paren
op_amp
l_int|3
)paren
op_plus
l_int|1
suffix:semicolon
)brace
)brace
id|hi
op_assign
id|pregs-&gt;phys_hi
op_amp
id|pbm-&gt;pbm_intmask.phys_hi
suffix:semicolon
id|mid
op_assign
id|pregs-&gt;phys_mid
op_amp
id|pbm-&gt;pbm_intmask.phys_mid
suffix:semicolon
id|lo
op_assign
id|pregs-&gt;phys_lo
op_amp
id|pbm-&gt;pbm_intmask.phys_lo
suffix:semicolon
id|irq
op_assign
op_star
id|interrupt
op_amp
id|pbm-&gt;pbm_intmask.interrupt
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pbm-&gt;num_pbm_intmap
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pbm-&gt;pbm_intmap
(braket
id|i
)braket
dot
id|phys_hi
op_eq
id|hi
op_logical_and
id|pbm-&gt;pbm_intmap
(braket
id|i
)braket
dot
id|phys_mid
op_eq
id|mid
op_logical_and
id|pbm-&gt;pbm_intmap
(braket
id|i
)braket
dot
id|phys_lo
op_eq
id|lo
op_logical_and
id|pbm-&gt;pbm_intmap
(braket
id|i
)braket
dot
id|interrupt
op_eq
id|irq
)paren
(brace
op_star
id|interrupt
op_assign
id|pbm-&gt;pbm_intmap
(braket
id|i
)braket
dot
id|cinterrupt
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
id|prom_printf
c_func
(paren
l_string|&quot;pbm_intmap_match: bus %02x, devfn %02x: &quot;
comma
id|pdev-&gt;bus-&gt;number
comma
id|pdev-&gt;devfn
)paren
suffix:semicolon
id|prom_printf
c_func
(paren
l_string|&quot;IRQ [%08x.%08x.%08x.%08x] not found in interrupt-map&bslash;n&quot;
comma
id|pregs-&gt;phys_hi
comma
id|pregs-&gt;phys_mid
comma
id|pregs-&gt;phys_lo
comma
op_star
id|interrupt
)paren
suffix:semicolon
id|prom_printf
c_func
(paren
l_string|&quot;Please email this information to davem@redhat.com&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|pdev_fixup_irq
r_static
r_void
id|__init
id|pdev_fixup_irq
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|pcidev_cookie
op_star
id|pcp
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
r_struct
id|pci_pbm_info
op_star
id|pbm
op_assign
id|pcp-&gt;pbm
suffix:semicolon
r_struct
id|pci_controller_info
op_star
id|p
op_assign
id|pbm-&gt;parent
suffix:semicolon
r_int
r_int
id|portid
op_assign
id|p-&gt;portid
suffix:semicolon
r_int
r_int
id|prom_irq
suffix:semicolon
r_int
id|prom_node
op_assign
id|pcp-&gt;prom_node
suffix:semicolon
r_int
id|err
suffix:semicolon
id|err
op_assign
id|prom_getproperty
c_func
(paren
id|prom_node
comma
l_string|&quot;interrupts&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|prom_irq
comma
r_sizeof
(paren
id|prom_irq
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
l_int|0
op_logical_or
id|err
op_eq
op_minus
l_int|1
)paren
(brace
id|pdev-&gt;irq
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Fully specified already? */
r_if
c_cond
(paren
(paren
(paren
id|prom_irq
op_amp
id|PCI_IRQ_IGN
)paren
op_rshift
l_int|6
)paren
op_eq
id|portid
)paren
(brace
id|pdev-&gt;irq
op_assign
id|p
op_member_access_from_pointer
id|irq_build
c_func
(paren
id|p
comma
id|pdev
comma
id|prom_irq
)paren
suffix:semicolon
r_goto
id|have_irq
suffix:semicolon
)brace
multiline_comment|/* An onboard device? (bit 5 set) */
r_if
c_cond
(paren
(paren
id|prom_irq
op_amp
id|PCI_IRQ_INO
)paren
op_amp
l_int|0x20
)paren
(brace
id|pdev-&gt;irq
op_assign
id|p
op_member_access_from_pointer
id|irq_build
c_func
(paren
id|p
comma
id|pdev
comma
(paren
id|portid
op_lshift
l_int|6
op_or
id|prom_irq
)paren
)paren
suffix:semicolon
r_goto
id|have_irq
suffix:semicolon
)brace
multiline_comment|/* Can we find a matching entry in the interrupt-map? */
r_if
c_cond
(paren
id|pci_intmap_match
c_func
(paren
id|pdev
comma
op_amp
id|prom_irq
)paren
)paren
(brace
id|pdev-&gt;irq
op_assign
id|p
op_member_access_from_pointer
id|irq_build
c_func
(paren
id|p
comma
id|pdev
comma
(paren
id|portid
op_lshift
l_int|6
)paren
op_or
id|prom_irq
)paren
suffix:semicolon
r_goto
id|have_irq
suffix:semicolon
)brace
multiline_comment|/* Ok, we have to do it the hard way. */
(brace
r_int
r_int
id|bus
comma
id|slot
comma
id|line
suffix:semicolon
id|bus
op_assign
(paren
id|pbm
op_eq
op_amp
id|pbm-&gt;parent-&gt;pbm_B
)paren
ques
c_cond
(paren
l_int|1
op_lshift
l_int|4
)paren
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/* If we have a legal interrupt property, use it as&n;&t;&t; * the IRQ line.&n;&t;&t; */
r_if
c_cond
(paren
id|prom_irq
OG
l_int|0
op_logical_and
id|prom_irq
OL
l_int|5
)paren
(brace
id|line
op_assign
(paren
(paren
id|prom_irq
op_minus
l_int|1
)paren
op_amp
l_int|3
)paren
suffix:semicolon
)brace
r_else
(brace
id|u8
id|pci_irq_line
suffix:semicolon
multiline_comment|/* Else just directly consult PCI config space. */
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
id|PCI_INTERRUPT_PIN
comma
op_amp
id|pci_irq_line
)paren
suffix:semicolon
id|line
op_assign
(paren
(paren
id|pci_irq_line
op_minus
l_int|1
)paren
op_amp
l_int|3
)paren
suffix:semicolon
)brace
multiline_comment|/* Now figure out the slot. */
r_if
c_cond
(paren
id|pdev-&gt;bus-&gt;number
op_eq
id|pbm-&gt;pci_first_busno
)paren
(brace
r_if
c_cond
(paren
id|pbm
op_eq
op_amp
id|pbm-&gt;parent-&gt;pbm_A
)paren
id|slot
op_assign
(paren
id|pdev-&gt;devfn
op_rshift
l_int|3
)paren
op_minus
l_int|1
suffix:semicolon
r_else
id|slot
op_assign
(paren
id|pdev-&gt;devfn
op_rshift
l_int|3
)paren
op_minus
l_int|2
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|pbm
op_eq
op_amp
id|pbm-&gt;parent-&gt;pbm_A
)paren
id|slot
op_assign
(paren
id|pdev-&gt;bus-&gt;self-&gt;devfn
op_rshift
l_int|3
)paren
op_minus
l_int|1
suffix:semicolon
r_else
id|slot
op_assign
(paren
id|pdev-&gt;bus-&gt;self-&gt;devfn
op_rshift
l_int|3
)paren
op_minus
l_int|2
suffix:semicolon
)brace
id|slot
op_assign
id|slot
op_lshift
l_int|2
suffix:semicolon
id|pdev-&gt;irq
op_assign
id|p
op_member_access_from_pointer
id|irq_build
c_func
(paren
id|p
comma
id|pdev
comma
(paren
(paren
id|portid
op_lshift
l_int|6
)paren
op_amp
id|PCI_IRQ_IGN
)paren
op_or
(paren
id|bus
op_or
id|slot
op_or
id|line
)paren
)paren
suffix:semicolon
)brace
id|have_irq
suffix:colon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
id|PCI_INTERRUPT_LINE
comma
id|pdev-&gt;irq
op_amp
id|PCI_IRQ_INO
)paren
suffix:semicolon
)brace
DECL|function|pci_fixup_irq
r_void
id|__init
id|pci_fixup_irq
c_func
(paren
r_struct
id|pci_pbm_info
op_star
id|pbm
comma
r_struct
id|pci_bus
op_star
id|pbus
)paren
(brace
r_struct
id|list_head
op_star
id|walk
op_assign
op_amp
id|pbus-&gt;devices
suffix:semicolon
r_for
c_loop
(paren
id|walk
op_assign
id|walk-&gt;next
suffix:semicolon
id|walk
op_ne
op_amp
id|pbus-&gt;devices
suffix:semicolon
id|walk
op_assign
id|walk-&gt;next
)paren
id|pdev_fixup_irq
c_func
(paren
id|pci_dev_b
c_func
(paren
id|walk
)paren
)paren
suffix:semicolon
id|walk
op_assign
op_amp
id|pbus-&gt;children
suffix:semicolon
r_for
c_loop
(paren
id|walk
op_assign
id|walk-&gt;next
suffix:semicolon
id|walk
op_ne
op_amp
id|pbus-&gt;children
suffix:semicolon
id|walk
op_assign
id|walk-&gt;next
)paren
id|pci_fixup_irq
c_func
(paren
id|pbm
comma
id|pci_bus_b
c_func
(paren
id|walk
)paren
)paren
suffix:semicolon
)brace
DECL|macro|DEBUG_BUSMASTERING
macro_line|#undef DEBUG_BUSMASTERING
DECL|function|pdev_setup_busmastering
r_static
r_void
id|pdev_setup_busmastering
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
id|is_66mhz
)paren
(brace
id|u16
id|cmd
suffix:semicolon
id|u8
id|hdr_type
comma
id|min_gnt
comma
id|ltimer
suffix:semicolon
macro_line|#ifdef DEBUG_BUSMASTERING
id|printk
c_func
(paren
l_string|&quot;PCI: Checking DEV(%s), &quot;
comma
id|pdev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
id|pci_read_config_word
c_func
(paren
id|pdev
comma
id|PCI_COMMAND
comma
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd
op_or_assign
id|PCI_COMMAND_MASTER
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|pdev
comma
id|PCI_COMMAND
comma
id|cmd
)paren
suffix:semicolon
multiline_comment|/* Read it back, if the mastering bit did not&n;&t; * get set, the device does not support bus&n;&t; * mastering so we have nothing to do here.&n;&t; */
id|pci_read_config_word
c_func
(paren
id|pdev
comma
id|PCI_COMMAND
comma
op_amp
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cmd
op_amp
id|PCI_COMMAND_MASTER
)paren
op_eq
l_int|0
)paren
(brace
macro_line|#ifdef DEBUG_BUSMASTERING
id|printk
c_func
(paren
l_string|&quot;no bus mastering...&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
multiline_comment|/* Set correct cache line size, 64-byte on all&n;&t; * Sparc64 PCI systems.  Note that the value is&n;&t; * measured in 32-bit words.&n;&t; */
macro_line|#ifdef DEBUG_BUSMASTERING
id|printk
c_func
(paren
l_string|&quot;set cachelinesize, &quot;
)paren
suffix:semicolon
macro_line|#endif
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
id|PCI_CACHE_LINE_SIZE
comma
l_int|64
op_div
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
id|PCI_HEADER_TYPE
comma
op_amp
id|hdr_type
)paren
suffix:semicolon
id|hdr_type
op_and_assign
op_complement
l_int|0x80
suffix:semicolon
r_if
c_cond
(paren
id|hdr_type
op_ne
id|PCI_HEADER_TYPE_NORMAL
)paren
(brace
macro_line|#ifdef DEBUG_BUSMASTERING
id|printk
c_func
(paren
l_string|&quot;hdr_type=%x, exit&bslash;n&quot;
comma
id|hdr_type
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
multiline_comment|/* If the latency timer is already programmed with a non-zero&n;&t; * value, assume whoever set it (OBP or whoever) knows what&n;&t; * they are doing.&n;&t; */
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
id|PCI_LATENCY_TIMER
comma
op_amp
id|ltimer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ltimer
op_ne
l_int|0
)paren
(brace
macro_line|#ifdef DEBUG_BUSMASTERING
id|printk
c_func
(paren
l_string|&quot;ltimer was %x, exit&bslash;n&quot;
comma
id|ltimer
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
multiline_comment|/* XXX Since I&squot;m tipping off the min grant value to&n;&t; * XXX choose a suitable latency timer value, I also&n;&t; * XXX considered making use of the max latency value&n;&t; * XXX as well.  Unfortunately I&squot;ve seen too many bogusly&n;&t; * XXX low settings for it to the point where it lacks&n;&t; * XXX any usefulness.  In one case, an ethernet card&n;&t; * XXX claimed a min grant of 10 and a max latency of 5.&n;&t; * XXX Now, if I had two such cards on the same bus I&n;&t; * XXX could not set the desired burst period (calculated&n;&t; * XXX from min grant) without violating the max latency&n;&t; * XXX bound.  Duh...&n;&t; * XXX&n;&t; * XXX I blame dumb PC bios implementors for stuff like&n;&t; * XXX this, most of them don&squot;t even try to do something&n;&t; * XXX sensible with latency timer values and just set some&n;&t; * XXX default value (usually 32) into every device.&n;&t; */
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
id|PCI_MIN_GNT
comma
op_amp
id|min_gnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|min_gnt
op_eq
l_int|0
)paren
(brace
multiline_comment|/* If no min_gnt setting then use a default&n;&t;&t; * value.&n;&t;&t; */
r_if
c_cond
(paren
id|is_66mhz
)paren
id|ltimer
op_assign
l_int|16
suffix:semicolon
r_else
id|ltimer
op_assign
l_int|32
suffix:semicolon
)brace
r_else
(brace
r_int
id|shift_factor
suffix:semicolon
r_if
c_cond
(paren
id|is_66mhz
)paren
id|shift_factor
op_assign
l_int|2
suffix:semicolon
r_else
id|shift_factor
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* Use a default value when the min_gnt value&n;&t;&t; * is erroneously high.&n;&t;&t; */
r_if
c_cond
(paren
(paren
(paren
r_int
r_int
)paren
id|min_gnt
op_lshift
id|shift_factor
)paren
OG
l_int|512
op_logical_or
(paren
(paren
id|min_gnt
op_lshift
id|shift_factor
)paren
op_amp
l_int|0xff
)paren
op_eq
l_int|0
)paren
(brace
id|ltimer
op_assign
l_int|8
op_lshift
id|shift_factor
suffix:semicolon
)brace
r_else
(brace
id|ltimer
op_assign
id|min_gnt
op_lshift
id|shift_factor
suffix:semicolon
)brace
)brace
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
id|PCI_LATENCY_TIMER
comma
id|ltimer
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_BUSMASTERING
id|printk
c_func
(paren
l_string|&quot;set ltimer to %x&bslash;n&quot;
comma
id|ltimer
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|pci_determine_66mhz_disposition
r_void
id|pci_determine_66mhz_disposition
c_func
(paren
r_struct
id|pci_pbm_info
op_star
id|pbm
comma
r_struct
id|pci_bus
op_star
id|pbus
)paren
(brace
r_struct
id|list_head
op_star
id|walk
suffix:semicolon
r_int
id|all_are_66mhz
suffix:semicolon
id|u16
id|status
suffix:semicolon
r_if
c_cond
(paren
id|pbm-&gt;is_66mhz_capable
op_eq
l_int|0
)paren
(brace
id|all_are_66mhz
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|walk
op_assign
op_amp
id|pbus-&gt;devices
suffix:semicolon
id|all_are_66mhz
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|walk
op_assign
id|walk-&gt;next
suffix:semicolon
id|walk
op_ne
op_amp
id|pbus-&gt;devices
suffix:semicolon
id|walk
op_assign
id|walk-&gt;next
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|pci_dev_b
c_func
(paren
id|walk
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|pdev
comma
id|PCI_STATUS
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|PCI_STATUS_66MHZ
)paren
)paren
(brace
id|all_are_66mhz
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|out
suffix:colon
id|pbm-&gt;all_devs_66mhz
op_assign
id|all_are_66mhz
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI%d(PBM%c): Bus running at %dMHz&bslash;n&quot;
comma
id|pbm-&gt;parent-&gt;index
comma
(paren
id|pbm
op_eq
op_amp
id|pbm-&gt;parent-&gt;pbm_A
)paren
ques
c_cond
l_char|&squot;A&squot;
suffix:colon
l_char|&squot;B&squot;
comma
(paren
id|all_are_66mhz
ques
c_cond
l_int|66
suffix:colon
l_int|33
)paren
)paren
suffix:semicolon
)brace
DECL|function|pci_setup_busmastering
r_void
id|pci_setup_busmastering
c_func
(paren
r_struct
id|pci_pbm_info
op_star
id|pbm
comma
r_struct
id|pci_bus
op_star
id|pbus
)paren
(brace
r_struct
id|list_head
op_star
id|walk
op_assign
op_amp
id|pbus-&gt;devices
suffix:semicolon
r_int
id|is_66mhz
suffix:semicolon
id|is_66mhz
op_assign
id|pbm-&gt;is_66mhz_capable
op_logical_and
id|pbm-&gt;all_devs_66mhz
suffix:semicolon
r_for
c_loop
(paren
id|walk
op_assign
id|walk-&gt;next
suffix:semicolon
id|walk
op_ne
op_amp
id|pbus-&gt;devices
suffix:semicolon
id|walk
op_assign
id|walk-&gt;next
)paren
id|pdev_setup_busmastering
c_func
(paren
id|pci_dev_b
c_func
(paren
id|walk
)paren
comma
id|is_66mhz
)paren
suffix:semicolon
id|walk
op_assign
op_amp
id|pbus-&gt;children
suffix:semicolon
r_for
c_loop
(paren
id|walk
op_assign
id|walk-&gt;next
suffix:semicolon
id|walk
op_ne
op_amp
id|pbus-&gt;children
suffix:semicolon
id|walk
op_assign
id|walk-&gt;next
)paren
id|pci_setup_busmastering
c_func
(paren
id|pbm
comma
id|pci_bus_b
c_func
(paren
id|walk
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Generic helper routines for PCI error reporting. */
DECL|function|pci_scan_for_target_abort
r_void
id|pci_scan_for_target_abort
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
comma
r_struct
id|pci_pbm_info
op_star
id|pbm
comma
r_struct
id|pci_bus
op_star
id|pbus
)paren
(brace
r_struct
id|list_head
op_star
id|walk
op_assign
op_amp
id|pbus-&gt;devices
suffix:semicolon
r_for
c_loop
(paren
id|walk
op_assign
id|walk-&gt;next
suffix:semicolon
id|walk
op_ne
op_amp
id|pbus-&gt;devices
suffix:semicolon
id|walk
op_assign
id|walk-&gt;next
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|pci_dev_b
c_func
(paren
id|walk
)paren
suffix:semicolon
id|u16
id|status
comma
id|error_bits
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|pdev
comma
id|PCI_STATUS
comma
op_amp
id|status
)paren
suffix:semicolon
id|error_bits
op_assign
(paren
id|status
op_amp
(paren
id|PCI_STATUS_SIG_TARGET_ABORT
op_or
id|PCI_STATUS_REC_TARGET_ABORT
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error_bits
)paren
(brace
id|pci_write_config_word
c_func
(paren
id|pdev
comma
id|PCI_STATUS
comma
id|error_bits
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI%d(PBM%c): Device [%s] saw Target Abort [%016x]&bslash;n&quot;
comma
id|p-&gt;index
comma
(paren
(paren
id|pbm
op_eq
op_amp
id|p-&gt;pbm_A
)paren
ques
c_cond
l_char|&squot;A&squot;
suffix:colon
l_char|&squot;B&squot;
)paren
comma
id|pdev-&gt;name
comma
id|status
)paren
suffix:semicolon
)brace
)brace
id|walk
op_assign
op_amp
id|pbus-&gt;children
suffix:semicolon
r_for
c_loop
(paren
id|walk
op_assign
id|walk-&gt;next
suffix:semicolon
id|walk
op_ne
op_amp
id|pbus-&gt;children
suffix:semicolon
id|walk
op_assign
id|walk-&gt;next
)paren
id|pci_scan_for_target_abort
c_func
(paren
id|p
comma
id|pbm
comma
id|pci_bus_b
c_func
(paren
id|walk
)paren
)paren
suffix:semicolon
)brace
DECL|function|pci_scan_for_master_abort
r_void
id|pci_scan_for_master_abort
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
comma
r_struct
id|pci_pbm_info
op_star
id|pbm
comma
r_struct
id|pci_bus
op_star
id|pbus
)paren
(brace
r_struct
id|list_head
op_star
id|walk
op_assign
op_amp
id|pbus-&gt;devices
suffix:semicolon
r_for
c_loop
(paren
id|walk
op_assign
id|walk-&gt;next
suffix:semicolon
id|walk
op_ne
op_amp
id|pbus-&gt;devices
suffix:semicolon
id|walk
op_assign
id|walk-&gt;next
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|pci_dev_b
c_func
(paren
id|walk
)paren
suffix:semicolon
id|u16
id|status
comma
id|error_bits
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|pdev
comma
id|PCI_STATUS
comma
op_amp
id|status
)paren
suffix:semicolon
id|error_bits
op_assign
(paren
id|status
op_amp
(paren
id|PCI_STATUS_REC_MASTER_ABORT
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error_bits
)paren
(brace
id|pci_write_config_word
c_func
(paren
id|pdev
comma
id|PCI_STATUS
comma
id|error_bits
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI%d(PBM%c): Device [%s] received Master Abort [%016x]&bslash;n&quot;
comma
id|p-&gt;index
comma
(paren
(paren
id|pbm
op_eq
op_amp
id|p-&gt;pbm_A
)paren
ques
c_cond
l_char|&squot;A&squot;
suffix:colon
l_char|&squot;B&squot;
)paren
comma
id|pdev-&gt;name
comma
id|status
)paren
suffix:semicolon
)brace
)brace
id|walk
op_assign
op_amp
id|pbus-&gt;children
suffix:semicolon
r_for
c_loop
(paren
id|walk
op_assign
id|walk-&gt;next
suffix:semicolon
id|walk
op_ne
op_amp
id|pbus-&gt;children
suffix:semicolon
id|walk
op_assign
id|walk-&gt;next
)paren
id|pci_scan_for_master_abort
c_func
(paren
id|p
comma
id|pbm
comma
id|pci_bus_b
c_func
(paren
id|walk
)paren
)paren
suffix:semicolon
)brace
DECL|function|pci_scan_for_parity_error
r_void
id|pci_scan_for_parity_error
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
comma
r_struct
id|pci_pbm_info
op_star
id|pbm
comma
r_struct
id|pci_bus
op_star
id|pbus
)paren
(brace
r_struct
id|list_head
op_star
id|walk
op_assign
op_amp
id|pbus-&gt;devices
suffix:semicolon
r_for
c_loop
(paren
id|walk
op_assign
id|walk-&gt;next
suffix:semicolon
id|walk
op_ne
op_amp
id|pbus-&gt;devices
suffix:semicolon
id|walk
op_assign
id|walk-&gt;next
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|pci_dev_b
c_func
(paren
id|walk
)paren
suffix:semicolon
id|u16
id|status
comma
id|error_bits
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|pdev
comma
id|PCI_STATUS
comma
op_amp
id|status
)paren
suffix:semicolon
id|error_bits
op_assign
(paren
id|status
op_amp
(paren
id|PCI_STATUS_PARITY
op_or
id|PCI_STATUS_DETECTED_PARITY
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error_bits
)paren
(brace
id|pci_write_config_word
c_func
(paren
id|pdev
comma
id|PCI_STATUS
comma
id|error_bits
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI%d(PBM%c): Device [%s] saw Parity Error [%016x]&bslash;n&quot;
comma
id|p-&gt;index
comma
(paren
(paren
id|pbm
op_eq
op_amp
id|p-&gt;pbm_A
)paren
ques
c_cond
l_char|&squot;A&squot;
suffix:colon
l_char|&squot;B&squot;
)paren
comma
id|pdev-&gt;name
comma
id|status
)paren
suffix:semicolon
)brace
)brace
id|walk
op_assign
op_amp
id|pbus-&gt;children
suffix:semicolon
r_for
c_loop
(paren
id|walk
op_assign
id|walk-&gt;next
suffix:semicolon
id|walk
op_ne
op_amp
id|pbus-&gt;children
suffix:semicolon
id|walk
op_assign
id|walk-&gt;next
)paren
id|pci_scan_for_parity_error
c_func
(paren
id|p
comma
id|pbm
comma
id|pci_bus_b
c_func
(paren
id|walk
)paren
)paren
suffix:semicolon
)brace
eof
