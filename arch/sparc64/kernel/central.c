multiline_comment|/* $Id: central.c,v 1.14 2000/09/21 06:25:14 anton Exp $&n; * central.c: Central FHC driver for Sunfire/Starfire/Wildfire.&n; *&n; * Copyright (C) 1997, 1999 David S. Miller (davem@redhat.com)&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/fhc.h&gt;
macro_line|#include &lt;asm/starfire.h&gt;
DECL|variable|central_bus
r_struct
id|linux_central
op_star
id|central_bus
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|fhc_list
r_struct
id|linux_fhc
op_star
id|fhc_list
op_assign
l_int|NULL
suffix:semicolon
DECL|macro|IS_CENTRAL_FHC
mdefine_line|#define IS_CENTRAL_FHC(__fhc)&t;((__fhc) == central_bus-&gt;child)
DECL|function|long_align
r_static
r_inline
r_int
r_int
id|long_align
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_return
(paren
(paren
id|addr
op_plus
(paren
r_sizeof
(paren
r_int
r_int
)paren
op_minus
l_int|1
)paren
)paren
op_amp
op_complement
(paren
r_sizeof
(paren
r_int
r_int
)paren
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
DECL|function|central_ranges_init
r_static
r_void
id|central_ranges_init
c_func
(paren
r_int
id|cnode
comma
r_struct
id|linux_central
op_star
id|central
)paren
(brace
r_int
id|success
suffix:semicolon
id|central-&gt;num_central_ranges
op_assign
l_int|0
suffix:semicolon
id|success
op_assign
id|prom_getproperty
c_func
(paren
id|central-&gt;prom_node
comma
l_string|&quot;ranges&quot;
comma
(paren
r_char
op_star
)paren
id|central-&gt;central_ranges
comma
r_sizeof
(paren
id|central-&gt;central_ranges
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|success
op_ne
op_minus
l_int|1
)paren
id|central-&gt;num_central_ranges
op_assign
(paren
id|success
op_div
r_sizeof
(paren
r_struct
id|linux_prom_ranges
)paren
)paren
suffix:semicolon
)brace
DECL|function|fhc_ranges_init
r_static
r_void
id|fhc_ranges_init
c_func
(paren
r_int
id|fnode
comma
r_struct
id|linux_fhc
op_star
id|fhc
)paren
(brace
r_int
id|success
suffix:semicolon
id|fhc-&gt;num_fhc_ranges
op_assign
l_int|0
suffix:semicolon
id|success
op_assign
id|prom_getproperty
c_func
(paren
id|fhc-&gt;prom_node
comma
l_string|&quot;ranges&quot;
comma
(paren
r_char
op_star
)paren
id|fhc-&gt;fhc_ranges
comma
r_sizeof
(paren
id|fhc-&gt;fhc_ranges
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|success
op_ne
op_minus
l_int|1
)paren
id|fhc-&gt;num_fhc_ranges
op_assign
(paren
id|success
op_div
r_sizeof
(paren
r_struct
id|linux_prom_ranges
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Range application routines are exported to various drivers,&n; * so do not __init this.&n; */
DECL|function|adjust_regs
r_static
r_void
id|adjust_regs
c_func
(paren
r_struct
id|linux_prom_registers
op_star
id|regp
comma
r_int
id|nregs
comma
r_struct
id|linux_prom_ranges
op_star
id|rangep
comma
r_int
id|nranges
)paren
(brace
r_int
id|regc
comma
id|rngc
suffix:semicolon
r_for
c_loop
(paren
id|regc
op_assign
l_int|0
suffix:semicolon
id|regc
OL
id|nregs
suffix:semicolon
id|regc
op_increment
)paren
(brace
r_for
c_loop
(paren
id|rngc
op_assign
l_int|0
suffix:semicolon
id|rngc
OL
id|nranges
suffix:semicolon
id|rngc
op_increment
)paren
r_if
c_cond
(paren
id|regp
(braket
id|regc
)braket
dot
id|which_io
op_eq
id|rangep
(braket
id|rngc
)braket
dot
id|ot_child_space
)paren
r_break
suffix:semicolon
multiline_comment|/* Fount it */
r_if
c_cond
(paren
id|rngc
op_eq
id|nranges
)paren
multiline_comment|/* oops */
id|prom_printf
c_func
(paren
l_string|&quot;adjust_regs: Could not find range with matching bus type...&bslash;n&quot;
)paren
suffix:semicolon
id|regp
(braket
id|regc
)braket
dot
id|which_io
op_assign
id|rangep
(braket
id|rngc
)braket
dot
id|ot_parent_space
suffix:semicolon
id|regp
(braket
id|regc
)braket
dot
id|phys_addr
op_add_assign
id|rangep
(braket
id|rngc
)braket
dot
id|ot_parent_base
suffix:semicolon
)brace
)brace
multiline_comment|/* Apply probed fhc ranges to registers passed, if no ranges return. */
DECL|function|apply_fhc_ranges
r_void
id|apply_fhc_ranges
c_func
(paren
r_struct
id|linux_fhc
op_star
id|fhc
comma
r_struct
id|linux_prom_registers
op_star
id|regs
comma
r_int
id|nregs
)paren
(brace
r_if
c_cond
(paren
id|fhc-&gt;num_fhc_ranges
)paren
(brace
id|adjust_regs
c_func
(paren
id|regs
comma
id|nregs
comma
id|fhc-&gt;fhc_ranges
comma
id|fhc-&gt;num_fhc_ranges
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Apply probed central ranges to registers passed, if no ranges return. */
DECL|function|apply_central_ranges
r_void
id|apply_central_ranges
c_func
(paren
r_struct
id|linux_central
op_star
id|central
comma
r_struct
id|linux_prom_registers
op_star
id|regs
comma
r_int
id|nregs
)paren
(brace
r_if
c_cond
(paren
id|central-&gt;num_central_ranges
)paren
(brace
id|adjust_regs
c_func
(paren
id|regs
comma
id|nregs
comma
id|central-&gt;central_ranges
comma
id|central-&gt;num_central_ranges
)paren
suffix:semicolon
)brace
)brace
DECL|function|central_alloc_bootmem
r_void
op_star
id|__init
id|central_alloc_bootmem
c_func
(paren
r_int
r_int
id|size
)paren
(brace
r_void
op_star
id|ret
suffix:semicolon
id|ret
op_assign
id|__alloc_bootmem
c_func
(paren
id|size
comma
id|SMP_CACHE_BYTES
comma
l_int|0UL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|NULL
)paren
id|memset
c_func
(paren
id|ret
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|probe_other_fhcs
r_static
r_void
id|probe_other_fhcs
c_func
(paren
r_void
)paren
(brace
r_struct
id|linux_prom64_registers
id|fpregs
(braket
l_int|6
)braket
suffix:semicolon
r_char
id|namebuf
(braket
l_int|128
)braket
suffix:semicolon
r_int
id|node
suffix:semicolon
id|node
op_assign
id|prom_getchild
c_func
(paren
id|prom_root_node
)paren
suffix:semicolon
id|node
op_assign
id|prom_searchsiblings
c_func
(paren
id|node
comma
l_string|&quot;fhc&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|node
op_eq
l_int|0
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;FHC: Cannot find any toplevel firehose controllers.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|node
)paren
(brace
r_struct
id|linux_fhc
op_star
id|fhc
suffix:semicolon
r_int
id|board
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
id|fhc
op_assign
(paren
r_struct
id|linux_fhc
op_star
)paren
id|central_alloc_bootmem
c_func
(paren
r_sizeof
(paren
r_struct
id|linux_fhc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fhc
op_eq
l_int|NULL
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;probe_other_fhcs: Cannot alloc fhc.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Link it into the FHC chain. */
id|fhc-&gt;next
op_assign
id|fhc_list
suffix:semicolon
id|fhc_list
op_assign
id|fhc
suffix:semicolon
multiline_comment|/* Toplevel FHCs have no parent. */
id|fhc-&gt;parent
op_assign
l_int|NULL
suffix:semicolon
id|fhc-&gt;prom_node
op_assign
id|node
suffix:semicolon
id|prom_getstring
c_func
(paren
id|node
comma
l_string|&quot;name&quot;
comma
id|namebuf
comma
r_sizeof
(paren
id|namebuf
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|fhc-&gt;prom_name
comma
id|namebuf
)paren
suffix:semicolon
id|fhc_ranges_init
c_func
(paren
id|node
comma
id|fhc
)paren
suffix:semicolon
multiline_comment|/* Non-central FHC&squot;s have 64-bit OBP format registers. */
r_if
c_cond
(paren
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;reg&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|fpregs
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|fpregs
)paren
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;FHC: Fatal error, cannot get fhc regs.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Only central FHC needs special ranges applied. */
id|fhc-&gt;fhc_regs.pregs
op_assign
id|fpregs
(braket
l_int|0
)braket
dot
id|phys_addr
suffix:semicolon
id|fhc-&gt;fhc_regs.ireg
op_assign
id|fpregs
(braket
l_int|1
)braket
dot
id|phys_addr
suffix:semicolon
id|fhc-&gt;fhc_regs.ffregs
op_assign
id|fpregs
(braket
l_int|2
)braket
dot
id|phys_addr
suffix:semicolon
id|fhc-&gt;fhc_regs.sregs
op_assign
id|fpregs
(braket
l_int|3
)braket
dot
id|phys_addr
suffix:semicolon
id|fhc-&gt;fhc_regs.uregs
op_assign
id|fpregs
(braket
l_int|4
)braket
dot
id|phys_addr
suffix:semicolon
id|fhc-&gt;fhc_regs.tregs
op_assign
id|fpregs
(braket
l_int|5
)braket
dot
id|phys_addr
suffix:semicolon
id|board
op_assign
id|prom_getintdefault
c_func
(paren
id|node
comma
l_string|&quot;board#&quot;
comma
op_minus
l_int|1
)paren
suffix:semicolon
id|fhc-&gt;board
op_assign
id|board
suffix:semicolon
id|tmp
op_assign
id|upa_readl
c_func
(paren
id|fhc-&gt;fhc_regs.pregs
op_plus
id|FHC_PREGS_JCTRL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_amp
id|FHC_JTAG_CTRL_MENAB
)paren
op_ne
l_int|0
)paren
(brace
id|fhc-&gt;jtag_master
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|fhc-&gt;jtag_master
op_assign
l_int|0
suffix:semicolon
id|tmp
op_assign
id|upa_readl
c_func
(paren
id|fhc-&gt;fhc_regs.pregs
op_plus
id|FHC_PREGS_ID
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;FHC(board %d): Version[%x] PartID[%x] Manuf[%x] %s&bslash;n&quot;
comma
id|board
comma
(paren
id|tmp
op_amp
id|FHC_ID_VERS
)paren
op_rshift
l_int|28
comma
(paren
id|tmp
op_amp
id|FHC_ID_PARTID
)paren
op_rshift
l_int|12
comma
(paren
id|tmp
op_amp
id|FHC_ID_MANUF
)paren
op_rshift
l_int|1
comma
(paren
id|fhc-&gt;jtag_master
ques
c_cond
l_string|&quot;(JTAG Master)&quot;
suffix:colon
l_string|&quot;&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* This bit must be set in all non-central FHC&squot;s in&n;&t;&t; * the system.  When it is clear, this identifies&n;&t;&t; * the central board.&n;&t;&t; */
id|tmp
op_assign
id|upa_readl
c_func
(paren
id|fhc-&gt;fhc_regs.pregs
op_plus
id|FHC_PREGS_CTRL
)paren
suffix:semicolon
id|tmp
op_or_assign
id|FHC_CONTROL_IXIST
suffix:semicolon
id|upa_writel
c_func
(paren
id|tmp
comma
id|fhc-&gt;fhc_regs.pregs
op_plus
id|FHC_PREGS_CTRL
)paren
suffix:semicolon
multiline_comment|/* Look for the next FHC. */
id|node
op_assign
id|prom_getsibling
c_func
(paren
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|node
op_eq
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
id|node
op_assign
id|prom_searchsiblings
c_func
(paren
id|node
comma
l_string|&quot;fhc&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|node
op_eq
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
)brace
DECL|function|probe_clock_board
r_static
r_void
id|probe_clock_board
c_func
(paren
r_struct
id|linux_central
op_star
id|central
comma
r_struct
id|linux_fhc
op_star
id|fhc
comma
r_int
id|cnode
comma
r_int
id|fnode
)paren
(brace
r_struct
id|linux_prom_registers
id|cregs
(braket
l_int|3
)braket
suffix:semicolon
r_int
id|clknode
comma
id|nslots
comma
id|tmp
comma
id|nregs
suffix:semicolon
id|clknode
op_assign
id|prom_searchsiblings
c_func
(paren
id|prom_getchild
c_func
(paren
id|fnode
)paren
comma
l_string|&quot;clock-board&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|clknode
op_eq
l_int|0
op_logical_or
id|clknode
op_eq
op_minus
l_int|1
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;Critical error, central lacks clock-board.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|nregs
op_assign
id|prom_getproperty
c_func
(paren
id|clknode
comma
l_string|&quot;reg&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|cregs
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|cregs
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nregs
op_eq
op_minus
l_int|1
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;CENTRAL: Fatal error, cannot map clock-board regs.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|nregs
op_div_assign
r_sizeof
(paren
r_struct
id|linux_prom_registers
)paren
suffix:semicolon
id|apply_fhc_ranges
c_func
(paren
id|fhc
comma
op_amp
id|cregs
(braket
l_int|0
)braket
comma
id|nregs
)paren
suffix:semicolon
id|apply_central_ranges
c_func
(paren
id|central
comma
op_amp
id|cregs
(braket
l_int|0
)braket
comma
id|nregs
)paren
suffix:semicolon
id|central-&gt;cfreg
op_assign
(paren
(paren
(paren
(paren
r_int
r_int
)paren
id|cregs
(braket
l_int|0
)braket
dot
id|which_io
)paren
op_lshift
l_int|32UL
)paren
op_or
(paren
(paren
r_int
r_int
)paren
id|cregs
(braket
l_int|0
)braket
dot
id|phys_addr
)paren
)paren
suffix:semicolon
id|central-&gt;clkregs
op_assign
(paren
(paren
(paren
(paren
r_int
r_int
)paren
id|cregs
(braket
l_int|1
)braket
dot
id|which_io
)paren
op_lshift
l_int|32UL
)paren
op_or
(paren
(paren
r_int
r_int
)paren
id|cregs
(braket
l_int|1
)braket
dot
id|phys_addr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nregs
op_eq
l_int|2
)paren
(brace
id|central-&gt;clkver
op_assign
l_int|0UL
suffix:semicolon
)brace
r_else
id|central-&gt;clkver
op_assign
(paren
(paren
(paren
(paren
r_int
r_int
)paren
id|cregs
(braket
l_int|2
)braket
dot
id|which_io
)paren
op_lshift
l_int|32UL
)paren
op_or
(paren
(paren
r_int
r_int
)paren
id|cregs
(braket
l_int|2
)braket
dot
id|phys_addr
)paren
)paren
suffix:semicolon
id|tmp
op_assign
id|upa_readb
c_func
(paren
id|central-&gt;clkregs
op_plus
id|CLOCK_STAT1
)paren
suffix:semicolon
id|tmp
op_and_assign
l_int|0xc0
suffix:semicolon
r_switch
c_cond
(paren
id|tmp
)paren
(brace
r_case
l_int|0x40
suffix:colon
id|nslots
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xc0
suffix:colon
id|nslots
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x80
suffix:colon
r_if
c_cond
(paren
id|central-&gt;clkver
op_ne
l_int|0UL
op_logical_and
id|upa_readb
c_func
(paren
id|central-&gt;clkver
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|upa_readb
c_func
(paren
id|central-&gt;clkver
)paren
op_amp
l_int|0x80
)paren
op_ne
l_int|0
)paren
(brace
id|nslots
op_assign
l_int|4
suffix:semicolon
)brace
r_else
id|nslots
op_assign
l_int|5
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
id|nslots
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
id|central-&gt;slots
op_assign
id|nslots
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;CENTRAL: Detected %d slot Enterprise system. cfreg[%02x] cver[%02x]&bslash;n&quot;
comma
id|central-&gt;slots
comma
id|upa_readb
c_func
(paren
id|central-&gt;cfreg
)paren
comma
(paren
id|central-&gt;clkver
ques
c_cond
id|upa_readb
c_func
(paren
id|central-&gt;clkver
)paren
suffix:colon
l_int|0x00
)paren
)paren
suffix:semicolon
)brace
DECL|function|central_probe
r_void
id|central_probe
c_func
(paren
r_void
)paren
(brace
r_struct
id|linux_prom_registers
id|fpregs
(braket
l_int|6
)braket
suffix:semicolon
r_struct
id|linux_fhc
op_star
id|fhc
suffix:semicolon
r_char
id|namebuf
(braket
l_int|128
)braket
suffix:semicolon
r_int
id|cnode
comma
id|fnode
comma
id|err
suffix:semicolon
id|cnode
op_assign
id|prom_finddevice
c_func
(paren
l_string|&quot;/central&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnode
op_eq
l_int|0
op_logical_or
id|cnode
op_eq
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|this_is_starfire
)paren
id|starfire_cpu_setup
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Ok we got one, grab some memory for software state. */
id|central_bus
op_assign
(paren
r_struct
id|linux_central
op_star
)paren
id|central_alloc_bootmem
c_func
(paren
r_sizeof
(paren
r_struct
id|linux_central
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|central_bus
op_eq
l_int|NULL
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;central_probe: Cannot alloc central_bus.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|fhc
op_assign
(paren
r_struct
id|linux_fhc
op_star
)paren
id|central_alloc_bootmem
c_func
(paren
r_sizeof
(paren
r_struct
id|linux_fhc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fhc
op_eq
l_int|NULL
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;central_probe: Cannot alloc central fhc.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* First init central. */
id|central_bus-&gt;child
op_assign
id|fhc
suffix:semicolon
id|central_bus-&gt;prom_node
op_assign
id|cnode
suffix:semicolon
id|prom_getstring
c_func
(paren
id|cnode
comma
l_string|&quot;name&quot;
comma
id|namebuf
comma
r_sizeof
(paren
id|namebuf
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|central_bus-&gt;prom_name
comma
id|namebuf
)paren
suffix:semicolon
id|central_ranges_init
c_func
(paren
id|cnode
comma
id|central_bus
)paren
suffix:semicolon
multiline_comment|/* And then central&squot;s FHC. */
id|fhc-&gt;next
op_assign
id|fhc_list
suffix:semicolon
id|fhc_list
op_assign
id|fhc
suffix:semicolon
id|fhc-&gt;parent
op_assign
id|central_bus
suffix:semicolon
id|fnode
op_assign
id|prom_searchsiblings
c_func
(paren
id|prom_getchild
c_func
(paren
id|cnode
)paren
comma
l_string|&quot;fhc&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fnode
op_eq
l_int|0
op_logical_or
id|fnode
op_eq
op_minus
l_int|1
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;Critical error, central board lacks fhc.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|fhc-&gt;prom_node
op_assign
id|fnode
suffix:semicolon
id|prom_getstring
c_func
(paren
id|fnode
comma
l_string|&quot;name&quot;
comma
id|namebuf
comma
r_sizeof
(paren
id|namebuf
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|fhc-&gt;prom_name
comma
id|namebuf
)paren
suffix:semicolon
id|fhc_ranges_init
c_func
(paren
id|fnode
comma
id|fhc
)paren
suffix:semicolon
multiline_comment|/* Now, map in FHC register set. */
r_if
c_cond
(paren
id|prom_getproperty
c_func
(paren
id|fnode
comma
l_string|&quot;reg&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|fpregs
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|fpregs
)paren
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;CENTRAL: Fatal error, cannot get fhc regs.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|apply_central_ranges
c_func
(paren
id|central_bus
comma
op_amp
id|fpregs
(braket
l_int|0
)braket
comma
l_int|6
)paren
suffix:semicolon
id|fhc-&gt;fhc_regs.pregs
op_assign
(paren
(paren
(paren
(paren
r_int
r_int
)paren
id|fpregs
(braket
l_int|0
)braket
dot
id|which_io
)paren
op_lshift
l_int|32UL
)paren
op_or
(paren
(paren
r_int
r_int
)paren
id|fpregs
(braket
l_int|0
)braket
dot
id|phys_addr
)paren
)paren
suffix:semicolon
id|fhc-&gt;fhc_regs.ireg
op_assign
(paren
(paren
(paren
(paren
r_int
r_int
)paren
id|fpregs
(braket
l_int|1
)braket
dot
id|which_io
)paren
op_lshift
l_int|32UL
)paren
op_or
(paren
(paren
r_int
r_int
)paren
id|fpregs
(braket
l_int|1
)braket
dot
id|phys_addr
)paren
)paren
suffix:semicolon
id|fhc-&gt;fhc_regs.ffregs
op_assign
(paren
(paren
(paren
(paren
r_int
r_int
)paren
id|fpregs
(braket
l_int|2
)braket
dot
id|which_io
)paren
op_lshift
l_int|32UL
)paren
op_or
(paren
(paren
r_int
r_int
)paren
id|fpregs
(braket
l_int|2
)braket
dot
id|phys_addr
)paren
)paren
suffix:semicolon
id|fhc-&gt;fhc_regs.sregs
op_assign
(paren
(paren
(paren
(paren
r_int
r_int
)paren
id|fpregs
(braket
l_int|3
)braket
dot
id|which_io
)paren
op_lshift
l_int|32UL
)paren
op_or
(paren
(paren
r_int
r_int
)paren
id|fpregs
(braket
l_int|3
)braket
dot
id|phys_addr
)paren
)paren
suffix:semicolon
id|fhc-&gt;fhc_regs.uregs
op_assign
(paren
(paren
(paren
(paren
r_int
r_int
)paren
id|fpregs
(braket
l_int|4
)braket
dot
id|which_io
)paren
op_lshift
l_int|32UL
)paren
op_or
(paren
(paren
r_int
r_int
)paren
id|fpregs
(braket
l_int|4
)braket
dot
id|phys_addr
)paren
)paren
suffix:semicolon
id|fhc-&gt;fhc_regs.tregs
op_assign
(paren
(paren
(paren
(paren
r_int
r_int
)paren
id|fpregs
(braket
l_int|5
)braket
dot
id|which_io
)paren
op_lshift
l_int|32UL
)paren
op_or
(paren
(paren
r_int
r_int
)paren
id|fpregs
(braket
l_int|5
)braket
dot
id|phys_addr
)paren
)paren
suffix:semicolon
multiline_comment|/* Obtain board number from board status register, Central&squot;s&n;&t; * FHC lacks &quot;board#&quot; property.&n;&t; */
id|err
op_assign
id|upa_readl
c_func
(paren
id|fhc-&gt;fhc_regs.pregs
op_plus
id|FHC_PREGS_BSR
)paren
suffix:semicolon
id|fhc-&gt;board
op_assign
(paren
(paren
(paren
id|err
op_rshift
l_int|16
)paren
op_amp
l_int|0x01
)paren
op_or
(paren
(paren
id|err
op_rshift
l_int|12
)paren
op_amp
l_int|0x0e
)paren
)paren
suffix:semicolon
id|fhc-&gt;jtag_master
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Attach the clock board registers for CENTRAL. */
id|probe_clock_board
c_func
(paren
id|central_bus
comma
id|fhc
comma
id|cnode
comma
id|fnode
)paren
suffix:semicolon
id|err
op_assign
id|upa_readl
c_func
(paren
id|fhc-&gt;fhc_regs.pregs
op_plus
id|FHC_PREGS_ID
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;FHC(board %d): Version[%x] PartID[%x] Manuf[%x] (CENTRAL)&bslash;n&quot;
comma
id|fhc-&gt;board
comma
(paren
(paren
id|err
op_amp
id|FHC_ID_VERS
)paren
op_rshift
l_int|28
)paren
comma
(paren
(paren
id|err
op_amp
id|FHC_ID_PARTID
)paren
op_rshift
l_int|12
)paren
comma
(paren
(paren
id|err
op_amp
id|FHC_ID_MANUF
)paren
op_rshift
l_int|1
)paren
)paren
suffix:semicolon
id|probe_other_fhcs
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|fhc_ledblink
r_static
id|__inline__
r_void
id|fhc_ledblink
c_func
(paren
r_struct
id|linux_fhc
op_star
id|fhc
comma
r_int
id|on
)paren
(brace
id|u32
id|tmp
suffix:semicolon
id|tmp
op_assign
id|upa_readl
c_func
(paren
id|fhc-&gt;fhc_regs.pregs
op_plus
id|FHC_PREGS_CTRL
)paren
suffix:semicolon
multiline_comment|/* NOTE: reverse logic on this bit */
r_if
c_cond
(paren
id|on
)paren
id|tmp
op_and_assign
op_complement
(paren
id|FHC_CONTROL_RLED
)paren
suffix:semicolon
r_else
id|tmp
op_or_assign
id|FHC_CONTROL_RLED
suffix:semicolon
id|tmp
op_and_assign
op_complement
(paren
id|FHC_CONTROL_AOFF
op_or
id|FHC_CONTROL_BOFF
op_or
id|FHC_CONTROL_SLINE
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|tmp
comma
id|fhc-&gt;fhc_regs.pregs
op_plus
id|FHC_PREGS_CTRL
)paren
suffix:semicolon
id|upa_readl
c_func
(paren
id|fhc-&gt;fhc_regs.pregs
op_plus
id|FHC_PREGS_CTRL
)paren
suffix:semicolon
)brace
DECL|function|central_ledblink
r_static
id|__inline__
r_void
id|central_ledblink
c_func
(paren
r_struct
id|linux_central
op_star
id|central
comma
r_int
id|on
)paren
(brace
id|u8
id|tmp
suffix:semicolon
id|tmp
op_assign
id|upa_readb
c_func
(paren
id|central-&gt;clkregs
op_plus
id|CLOCK_CTRL
)paren
suffix:semicolon
multiline_comment|/* NOTE: reverse logic on this bit */
r_if
c_cond
(paren
id|on
)paren
(brace
id|tmp
op_and_assign
op_complement
(paren
id|CLOCK_CTRL_RLED
)paren
suffix:semicolon
)brace
r_else
id|tmp
op_or_assign
id|CLOCK_CTRL_RLED
suffix:semicolon
id|upa_writeb
c_func
(paren
id|tmp
comma
id|central-&gt;clkregs
op_plus
id|CLOCK_CTRL
)paren
suffix:semicolon
id|upa_readb
c_func
(paren
id|central-&gt;clkregs
op_plus
id|CLOCK_CTRL
)paren
suffix:semicolon
)brace
DECL|variable|sftimer
r_static
r_struct
id|timer_list
id|sftimer
suffix:semicolon
DECL|variable|led_state
r_static
r_int
id|led_state
suffix:semicolon
DECL|function|sunfire_timer
r_static
r_void
id|sunfire_timer
c_func
(paren
r_int
r_int
id|__ignored
)paren
(brace
r_struct
id|linux_fhc
op_star
id|fhc
suffix:semicolon
id|central_ledblink
c_func
(paren
id|central_bus
comma
id|led_state
)paren
suffix:semicolon
r_for
c_loop
(paren
id|fhc
op_assign
id|fhc_list
suffix:semicolon
id|fhc
op_ne
l_int|NULL
suffix:semicolon
id|fhc
op_assign
id|fhc-&gt;next
)paren
r_if
c_cond
(paren
op_logical_neg
id|IS_CENTRAL_FHC
c_func
(paren
id|fhc
)paren
)paren
(brace
id|fhc_ledblink
c_func
(paren
id|fhc
comma
id|led_state
)paren
suffix:semicolon
)brace
id|led_state
op_assign
op_logical_neg
id|led_state
suffix:semicolon
id|sftimer.expires
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_rshift
l_int|1
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|sftimer
)paren
suffix:semicolon
)brace
multiline_comment|/* After PCI/SBUS busses have been probed, this is called to perform&n; * final initialization of all FireHose Controllers in the system.&n; */
DECL|function|firetruck_init
r_void
id|firetruck_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|linux_central
op_star
id|central
op_assign
id|central_bus
suffix:semicolon
r_struct
id|linux_fhc
op_star
id|fhc
suffix:semicolon
id|u8
id|ctrl
suffix:semicolon
multiline_comment|/* No central bus, nothing to do. */
r_if
c_cond
(paren
id|central
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|fhc
op_assign
id|fhc_list
suffix:semicolon
id|fhc
op_ne
l_int|NULL
suffix:semicolon
id|fhc
op_assign
id|fhc-&gt;next
)paren
(brace
id|u32
id|tmp
suffix:semicolon
multiline_comment|/* Clear all of the interrupt mapping registers&n;&t;&t; * just in case OBP left them in a foul state.&n;&t;&t; */
DECL|macro|ZAP
mdefine_line|#define ZAP(ICLR, IMAP) &bslash;&n;do {&t;u32 imap_tmp; &bslash;&n;&t;upa_writel(0, (ICLR)); &bslash;&n;&t;upa_readl(ICLR); &bslash;&n;&t;imap_tmp = upa_readl(IMAP); &bslash;&n;&t;imap_tmp &amp;= ~(0x80000000); &bslash;&n;&t;upa_writel(imap_tmp, (IMAP)); &bslash;&n;&t;upa_readl(IMAP); &bslash;&n;} while (0)
id|ZAP
c_func
(paren
id|fhc-&gt;fhc_regs.ffregs
op_plus
id|FHC_FFREGS_ICLR
comma
id|fhc-&gt;fhc_regs.ffregs
op_plus
id|FHC_FFREGS_IMAP
)paren
suffix:semicolon
id|ZAP
c_func
(paren
id|fhc-&gt;fhc_regs.sregs
op_plus
id|FHC_SREGS_ICLR
comma
id|fhc-&gt;fhc_regs.sregs
op_plus
id|FHC_SREGS_IMAP
)paren
suffix:semicolon
id|ZAP
c_func
(paren
id|fhc-&gt;fhc_regs.uregs
op_plus
id|FHC_UREGS_ICLR
comma
id|fhc-&gt;fhc_regs.uregs
op_plus
id|FHC_UREGS_IMAP
)paren
suffix:semicolon
id|ZAP
c_func
(paren
id|fhc-&gt;fhc_regs.tregs
op_plus
id|FHC_TREGS_ICLR
comma
id|fhc-&gt;fhc_regs.tregs
op_plus
id|FHC_TREGS_IMAP
)paren
suffix:semicolon
DECL|macro|ZAP
macro_line|#undef ZAP
multiline_comment|/* Setup FHC control register. */
id|tmp
op_assign
id|upa_readl
c_func
(paren
id|fhc-&gt;fhc_regs.pregs
op_plus
id|FHC_PREGS_CTRL
)paren
suffix:semicolon
multiline_comment|/* All non-central boards have this bit set. */
r_if
c_cond
(paren
op_logical_neg
id|IS_CENTRAL_FHC
c_func
(paren
id|fhc
)paren
)paren
(brace
id|tmp
op_or_assign
id|FHC_CONTROL_IXIST
suffix:semicolon
)brace
multiline_comment|/* For all FHCs, clear the firmware synchronization&n;&t;&t; * line and both low power mode enables.&n;&t;&t; */
id|tmp
op_and_assign
op_complement
(paren
id|FHC_CONTROL_AOFF
op_or
id|FHC_CONTROL_BOFF
op_or
id|FHC_CONTROL_SLINE
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|tmp
comma
id|fhc-&gt;fhc_regs.pregs
op_plus
id|FHC_PREGS_CTRL
)paren
suffix:semicolon
id|upa_readl
c_func
(paren
id|fhc-&gt;fhc_regs.pregs
op_plus
id|FHC_PREGS_CTRL
)paren
suffix:semicolon
)brace
multiline_comment|/* OBP leaves it on, turn it off so clock board timer LED&n;&t; * is in sync with FHC ones.&n;&t; */
id|ctrl
op_assign
id|upa_readb
c_func
(paren
id|central-&gt;clkregs
op_plus
id|CLOCK_CTRL
)paren
suffix:semicolon
id|ctrl
op_and_assign
op_complement
(paren
id|CLOCK_CTRL_RLED
)paren
suffix:semicolon
id|upa_writeb
c_func
(paren
id|ctrl
comma
id|central-&gt;clkregs
op_plus
id|CLOCK_CTRL
)paren
suffix:semicolon
id|led_state
op_assign
l_int|0
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|sftimer
)paren
suffix:semicolon
id|sftimer.data
op_assign
l_int|0
suffix:semicolon
id|sftimer.function
op_assign
op_amp
id|sunfire_timer
suffix:semicolon
id|sftimer.expires
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_rshift
l_int|1
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|sftimer
)paren
suffix:semicolon
)brace
eof
