multiline_comment|/* $Id: central.c,v 1.6 1998/05/14 13:35:45 jj Exp $&n; * central.c: Central FHC driver for Sunfire/Starfire/Wildfire.&n; *&n; * Copyright (C) 1997 David S. Miller (davem@caip.rutgers.edu)&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/fhc.h&gt;
DECL|variable|central_bus
r_struct
id|linux_central
op_star
id|central_bus
op_assign
l_int|NULL
suffix:semicolon
DECL|function|long_align
r_static
r_inline
r_int
r_int
id|long_align
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_return
(paren
(paren
id|addr
op_plus
(paren
r_sizeof
(paren
r_int
r_int
)paren
op_minus
l_int|1
)paren
)paren
op_amp
op_complement
(paren
r_sizeof
(paren
r_int
r_int
)paren
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
r_extern
r_void
id|prom_central_ranges_init
c_func
(paren
r_int
id|cnode
comma
r_struct
id|linux_central
op_star
id|central
)paren
suffix:semicolon
r_extern
r_void
id|prom_fhc_ranges_init
c_func
(paren
r_int
id|fnode
comma
r_struct
id|linux_fhc
op_star
id|fhc
)paren
suffix:semicolon
DECL|function|central_probe
r_int
r_int
id|central_probe
c_func
(paren
r_int
r_int
id|memory_start
)paren
(brace
r_struct
id|linux_prom_registers
id|fpregs
(braket
l_int|6
)braket
suffix:semicolon
r_struct
id|linux_fhc
op_star
id|fhc
suffix:semicolon
r_char
id|namebuf
(braket
l_int|128
)braket
suffix:semicolon
r_int
id|cnode
comma
id|fnode
comma
id|err
suffix:semicolon
id|cnode
op_assign
id|prom_finddevice
c_func
(paren
l_string|&quot;/central&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnode
op_eq
l_int|0
op_logical_or
id|cnode
op_eq
op_minus
l_int|1
)paren
(brace
r_return
id|memory_start
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;CENTRAL: found central PROM node %08x.&bslash;n&quot;
comma
id|cnode
)paren
suffix:semicolon
multiline_comment|/* Ok we got one, grab some memory for software state. */
id|memory_start
op_assign
id|long_align
c_func
(paren
id|memory_start
)paren
suffix:semicolon
id|central_bus
op_assign
(paren
r_struct
id|linux_central
op_star
)paren
(paren
id|memory_start
)paren
suffix:semicolon
id|memory_start
op_add_assign
r_sizeof
(paren
r_struct
id|linux_central
)paren
suffix:semicolon
id|memory_start
op_assign
id|long_align
c_func
(paren
id|memory_start
)paren
suffix:semicolon
id|fhc
op_assign
(paren
r_struct
id|linux_fhc
op_star
)paren
(paren
id|memory_start
)paren
suffix:semicolon
id|memory_start
op_add_assign
r_sizeof
(paren
r_struct
id|linux_fhc
)paren
suffix:semicolon
id|memory_start
op_assign
id|long_align
c_func
(paren
id|memory_start
)paren
suffix:semicolon
multiline_comment|/* First init central. */
id|central_bus-&gt;child
op_assign
id|fhc
suffix:semicolon
id|central_bus-&gt;prom_node
op_assign
id|cnode
suffix:semicolon
id|prom_getstring
c_func
(paren
id|cnode
comma
l_string|&quot;name&quot;
comma
id|namebuf
comma
r_sizeof
(paren
id|namebuf
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|central_bus-&gt;prom_name
comma
id|namebuf
)paren
suffix:semicolon
id|prom_central_ranges_init
c_func
(paren
id|cnode
comma
id|central_bus
)paren
suffix:semicolon
multiline_comment|/* And then central&squot;s FHC. */
id|fhc-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|fhc-&gt;parent
op_assign
id|central_bus
suffix:semicolon
id|fnode
op_assign
id|prom_searchsiblings
c_func
(paren
id|prom_getchild
c_func
(paren
id|cnode
)paren
comma
l_string|&quot;fhc&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fnode
op_eq
l_int|0
op_logical_or
id|fnode
op_eq
op_minus
l_int|1
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;Critical error, central board lacks fhc.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|fhc-&gt;prom_node
op_assign
id|fnode
suffix:semicolon
id|prom_getstring
c_func
(paren
id|fnode
comma
l_string|&quot;name&quot;
comma
id|namebuf
comma
r_sizeof
(paren
id|namebuf
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|fhc-&gt;prom_name
comma
id|namebuf
)paren
suffix:semicolon
id|prom_fhc_ranges_init
c_func
(paren
id|fnode
comma
id|fhc
)paren
suffix:semicolon
multiline_comment|/* Finally, map in FHC register set. */
r_if
c_cond
(paren
id|prom_getproperty
c_func
(paren
id|fnode
comma
l_string|&quot;reg&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|fpregs
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|fpregs
)paren
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;CENTRAL: fatal error, cannot get fhc regs.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|prom_apply_central_ranges
c_func
(paren
id|central_bus
comma
op_amp
id|fpregs
(braket
l_int|0
)braket
comma
l_int|6
)paren
suffix:semicolon
id|fhc-&gt;fhc_regs.pregs
op_assign
(paren
r_struct
id|fhc_internal_regs
op_star
)paren
id|__va
c_func
(paren
(paren
(paren
(paren
r_int
r_int
)paren
id|fpregs
(braket
l_int|0
)braket
dot
id|which_io
)paren
op_lshift
l_int|32
)paren
op_or
(paren
(paren
(paren
r_int
r_int
)paren
id|fpregs
(braket
l_int|0
)braket
dot
id|phys_addr
)paren
)paren
)paren
suffix:semicolon
id|fhc-&gt;fhc_regs.ireg
op_assign
(paren
r_struct
id|fhc_ign_reg
op_star
)paren
id|__va
c_func
(paren
(paren
(paren
(paren
r_int
r_int
)paren
id|fpregs
(braket
l_int|1
)braket
dot
id|which_io
)paren
op_lshift
l_int|32
)paren
op_or
(paren
(paren
(paren
r_int
r_int
)paren
id|fpregs
(braket
l_int|1
)braket
dot
id|phys_addr
)paren
)paren
)paren
suffix:semicolon
id|fhc-&gt;fhc_regs.ffregs
op_assign
(paren
r_struct
id|fhc_fanfail_regs
op_star
)paren
id|__va
c_func
(paren
(paren
(paren
(paren
r_int
r_int
)paren
id|fpregs
(braket
l_int|2
)braket
dot
id|which_io
)paren
op_lshift
l_int|32
)paren
op_or
(paren
(paren
(paren
r_int
r_int
)paren
id|fpregs
(braket
l_int|2
)braket
dot
id|phys_addr
)paren
)paren
)paren
suffix:semicolon
id|fhc-&gt;fhc_regs.sregs
op_assign
(paren
r_struct
id|fhc_system_regs
op_star
)paren
id|__va
c_func
(paren
(paren
(paren
(paren
r_int
r_int
)paren
id|fpregs
(braket
l_int|3
)braket
dot
id|which_io
)paren
op_lshift
l_int|32
)paren
op_or
(paren
(paren
(paren
r_int
r_int
)paren
id|fpregs
(braket
l_int|3
)braket
dot
id|phys_addr
)paren
)paren
)paren
suffix:semicolon
id|fhc-&gt;fhc_regs.uregs
op_assign
(paren
r_struct
id|fhc_uart_regs
op_star
)paren
id|__va
c_func
(paren
(paren
(paren
(paren
r_int
r_int
)paren
id|fpregs
(braket
l_int|4
)braket
dot
id|which_io
)paren
op_lshift
l_int|32
)paren
op_or
(paren
(paren
(paren
r_int
r_int
)paren
id|fpregs
(braket
l_int|4
)braket
dot
id|phys_addr
)paren
)paren
)paren
suffix:semicolon
id|fhc-&gt;fhc_regs.tregs
op_assign
(paren
r_struct
id|fhc_tod_regs
op_star
)paren
id|__va
c_func
(paren
(paren
(paren
(paren
r_int
r_int
)paren
id|fpregs
(braket
l_int|5
)braket
dot
id|which_io
)paren
op_lshift
l_int|32
)paren
op_or
(paren
(paren
(paren
r_int
r_int
)paren
id|fpregs
(braket
l_int|5
)braket
dot
id|phys_addr
)paren
)paren
)paren
suffix:semicolon
id|err
op_assign
id|fhc-&gt;fhc_regs.pregs-&gt;fhc_id
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;FHC Version[%x] PartID[%x] Manufacturer[%x]&bslash;n&quot;
comma
(paren
(paren
id|err
op_amp
id|FHC_ID_VERS
)paren
op_rshift
l_int|28
)paren
comma
(paren
(paren
id|err
op_amp
id|FHC_ID_PARTID
)paren
op_rshift
l_int|12
)paren
comma
(paren
(paren
id|err
op_amp
id|FHC_ID_MANUF
)paren
op_rshift
l_int|1
)paren
)paren
suffix:semicolon
r_return
id|memory_start
suffix:semicolon
)brace
eof
