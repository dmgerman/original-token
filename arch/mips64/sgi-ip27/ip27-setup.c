multiline_comment|/* $Id: ip27-setup.c,v 1.6 2000/02/05 02:12:32 kanoj Exp $&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; * SGI IP27 specific setup.&n; *&n; * Copyright (C) 1999 Ralf Baechle (ralf@gnu.org)&n; * Copyright (C) 1999 Silcon Graphics, Inc.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;asm/sn/types.h&gt;
macro_line|#include &lt;asm/sn/sn0/addrs.h&gt;
macro_line|#include &lt;asm/sn/sn0/hubni.h&gt;
macro_line|#include &lt;asm/sn/sn0/hubio.h&gt;
macro_line|#include &lt;asm/sn/klconfig.h&gt;
macro_line|#include &lt;asm/ioc3.h&gt;
macro_line|#include &lt;asm/mipsregs.h&gt;
macro_line|#include &lt;asm/sn/klconfig.h&gt;
multiline_comment|/* Check against user dumbness.  */
macro_line|#ifdef CONFIG_VT
macro_line|#error CONFIG_VT not allowed for IP27.
macro_line|#endif
multiline_comment|/*&n; * get_nasid() returns the physical node id number of the caller.&n; */
id|nasid_t
DECL|function|get_nasid
id|get_nasid
c_func
(paren
r_void
)paren
(brace
r_return
(paren
id|nasid_t
)paren
(paren
(paren
id|LOCAL_HUB_L
c_func
(paren
id|NI_STATUS_REV_ID
)paren
op_amp
id|NSRI_NODEID_MASK
)paren
op_rshift
id|NSRI_NODEID_SHFT
)paren
suffix:semicolon
)brace
multiline_comment|/* Extracted from the IOC3 meta driver.  FIXME.  */
DECL|function|ioc3_sio_init
r_static
r_inline
r_void
id|ioc3_sio_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|ioc3
op_star
id|ioc3
suffix:semicolon
id|nasid_t
id|nid
suffix:semicolon
r_int
id|loops
suffix:semicolon
id|nid
op_assign
id|get_nasid
c_func
(paren
)paren
suffix:semicolon
id|ioc3
op_assign
(paren
r_struct
id|ioc3
op_star
)paren
id|KL_CONFIG_CH_CONS_INFO
c_func
(paren
id|nid
)paren
op_member_access_from_pointer
id|memory_base
suffix:semicolon
id|ioc3-&gt;sscr_a
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* PIO mode for uarta.  */
id|ioc3-&gt;sscr_b
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* PIO mode for uartb.  */
id|ioc3-&gt;sio_iec
op_assign
op_complement
l_int|0
suffix:semicolon
id|ioc3-&gt;sio_ies
op_assign
(paren
id|SIO_IR_SA_INT
op_or
id|SIO_IR_SB_INT
)paren
suffix:semicolon
id|loops
op_assign
l_int|1000000
suffix:semicolon
r_while
c_loop
(paren
id|loops
op_decrement
)paren
(brace
suffix:semicolon
)brace
id|ioc3-&gt;sregs.uarta.iu_fcr
op_assign
l_int|0
suffix:semicolon
id|ioc3-&gt;sregs.uartb.iu_fcr
op_assign
l_int|0
suffix:semicolon
id|loops
op_assign
l_int|1000000
suffix:semicolon
r_while
c_loop
(paren
id|loops
op_decrement
)paren
(brace
suffix:semicolon
)brace
)brace
DECL|function|ioc3_eth_init
r_static
r_inline
r_void
id|ioc3_eth_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|ioc3
op_star
id|ioc3
suffix:semicolon
id|nasid_t
id|nid
suffix:semicolon
id|nid
op_assign
id|get_nasid
c_func
(paren
)paren
suffix:semicolon
id|ioc3
op_assign
(paren
r_struct
id|ioc3
op_star
)paren
id|KL_CONFIG_CH_CONS_INFO
c_func
(paren
id|nid
)paren
op_member_access_from_pointer
id|memory_base
suffix:semicolon
id|ioc3-&gt;eier
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Try to catch kernel missconfigurations and give user an indication what&n;   option to select.  */
DECL|function|verify_mode
r_static
r_void
id|__init
id|verify_mode
c_func
(paren
r_void
)paren
(brace
r_int
id|n_mode
suffix:semicolon
id|n_mode
op_assign
id|LOCAL_HUB_L
c_func
(paren
id|NI_STATUS_REV_ID
)paren
op_amp
id|NSRI_MORENODES_MASK
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Machine is in %c mode.&bslash;n&quot;
comma
id|n_mode
ques
c_cond
l_char|&squot;N&squot;
suffix:colon
l_char|&squot;M&squot;
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SGI_SN0_N_MODE
r_if
c_cond
(paren
op_logical_neg
id|n_mode
)paren
id|panic
c_func
(paren
l_string|&quot;Kernel compiled for M mode.&quot;
)paren
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|n_mode
)paren
id|panic
c_func
(paren
l_string|&quot;Kernel compiled for N mode.&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|ip27_setup
r_void
id|__init
id|ip27_setup
c_func
(paren
r_void
)paren
(brace
id|nasid_t
id|nid
suffix:semicolon
id|hubreg_t
id|p
comma
id|e
suffix:semicolon
id|set_cp0_status
c_func
(paren
id|ST0_IM
comma
l_int|0
)paren
suffix:semicolon
id|nid
op_assign
id|get_nasid
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;IP27: Running on node %d.&bslash;n&quot;
comma
id|nid
)paren
suffix:semicolon
id|p
op_assign
id|LOCAL_HUB_L
c_func
(paren
id|PI_CPU_PRESENT_A
)paren
op_amp
l_int|1
suffix:semicolon
id|e
op_assign
id|LOCAL_HUB_L
c_func
(paren
id|PI_CPU_ENABLE_A
)paren
op_amp
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Node %d has %s primary CPU%s.&bslash;n&quot;
comma
id|nid
comma
id|p
ques
c_cond
l_string|&quot;a&quot;
suffix:colon
l_string|&quot;no&quot;
comma
id|e
ques
c_cond
l_string|&quot;, CPU is running&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|p
op_assign
id|LOCAL_HUB_L
c_func
(paren
id|PI_CPU_PRESENT_B
)paren
op_amp
l_int|1
suffix:semicolon
id|e
op_assign
id|LOCAL_HUB_L
c_func
(paren
id|PI_CPU_ENABLE_B
)paren
op_amp
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Node %d has %s secondary CPU%s.&bslash;n&quot;
comma
id|nid
comma
id|p
ques
c_cond
l_string|&quot;a&quot;
suffix:colon
l_string|&quot;no&quot;
comma
id|e
ques
c_cond
l_string|&quot;, CPU is running&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|verify_mode
c_func
(paren
)paren
suffix:semicolon
id|ioc3_sio_init
c_func
(paren
)paren
suffix:semicolon
id|ioc3_eth_init
c_func
(paren
)paren
suffix:semicolon
)brace
eof
