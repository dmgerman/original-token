macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mmzone.h&gt;&t;/* for numnodes */
macro_line|#include &lt;asm/sn/types.h&gt;
macro_line|#include &lt;asm/sn/sn0/addrs.h&gt;
macro_line|#include &lt;asm/sn/sn0/hubni.h&gt;
macro_line|#include &lt;asm/sn/sn0/hubio.h&gt;
macro_line|#include &lt;asm/sn/klconfig.h&gt;
macro_line|#include &lt;asm/ioc3.h&gt;
macro_line|#include &lt;asm/mipsregs.h&gt;
macro_line|#include &lt;asm/sn/gda.h&gt;
DECL|typedef|cpumask_t
r_typedef
r_int
r_int
id|cpumask_t
suffix:semicolon
multiline_comment|/* into asm/sn/types.h */
DECL|typedef|cpuid_t
r_typedef
r_int
r_int
id|cpuid_t
suffix:semicolon
DECL|macro|CPUMASK_CLRALL
mdefine_line|#define&t;CPUMASK_CLRALL(p)&t;(p) = 0
DECL|macro|CPUMASK_SETB
mdefine_line|#define CPUMASK_SETB(p, bit)&t;(p) |= 1 &lt;&lt; (bit)
DECL|variable|boot_cpumask
id|cpumask_t
id|boot_cpumask
suffix:semicolon
DECL|variable|region_mask
id|hubreg_t
id|region_mask
op_assign
l_int|0
suffix:semicolon
DECL|variable|fine_mode
r_static
r_int
id|fine_mode
op_assign
l_int|0
suffix:semicolon
DECL|variable|nasid_to_compact_node
id|cnodeid_t
id|nasid_to_compact_node
(braket
id|MAX_NASIDS
)braket
suffix:semicolon
DECL|variable|compact_to_nasid_node
id|nasid_t
id|compact_to_nasid_node
(braket
id|MAX_COMPACT_NODES
)braket
suffix:semicolon
DECL|variable|cpuid_to_compact_node
id|cnodeid_t
id|cpuid_to_compact_node
(braket
id|MAXCPUS
)braket
suffix:semicolon
DECL|function|get_region
id|hubreg_t
id|get_region
c_func
(paren
id|cnodeid_t
id|cnode
)paren
(brace
r_if
c_cond
(paren
id|fine_mode
)paren
r_return
id|COMPACT_TO_NASID_NODEID
c_func
(paren
id|cnode
)paren
op_rshift
id|NASID_TO_FINEREG_SHFT
suffix:semicolon
r_else
r_return
id|COMPACT_TO_NASID_NODEID
c_func
(paren
id|cnode
)paren
op_rshift
id|NASID_TO_COARSEREG_SHFT
suffix:semicolon
)brace
DECL|function|gen_region_mask
r_static
r_void
id|gen_region_mask
c_func
(paren
id|hubreg_t
op_star
id|region_mask
comma
r_int
id|maxnodes
)paren
(brace
id|cnodeid_t
id|cnode
suffix:semicolon
(paren
op_star
id|region_mask
)paren
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|cnode
op_assign
l_int|0
suffix:semicolon
id|cnode
OL
id|maxnodes
suffix:semicolon
id|cnode
op_increment
)paren
(brace
(paren
op_star
id|region_mask
)paren
op_or_assign
l_int|1ULL
op_lshift
id|get_region
c_func
(paren
id|cnode
)paren
suffix:semicolon
)brace
)brace
DECL|function|is_fine_dirmode
r_int
id|is_fine_dirmode
c_func
(paren
r_void
)paren
(brace
r_return
(paren
(paren
(paren
id|LOCAL_HUB_L
c_func
(paren
id|NI_STATUS_REV_ID
)paren
op_amp
id|NSRI_REGIONSIZE_MASK
)paren
op_rshift
id|NSRI_REGIONSIZE_SHFT
)paren
op_amp
id|REGIONSIZE_FINE
)paren
suffix:semicolon
)brace
DECL|function|find_lboard_real
id|lboard_t
op_star
id|find_lboard_real
c_func
(paren
id|lboard_t
op_star
id|start
comma
r_int
r_char
id|brd_type
)paren
(brace
multiline_comment|/* Search all boards stored on this node. */
r_while
c_loop
(paren
id|start
)paren
(brace
r_if
c_cond
(paren
id|start-&gt;brd_type
op_eq
id|brd_type
)paren
r_return
id|start
suffix:semicolon
id|start
op_assign
id|KLCF_NEXT
c_func
(paren
id|start
)paren
suffix:semicolon
)brace
multiline_comment|/* Didn&squot;t find it. */
r_return
(paren
id|lboard_t
op_star
)paren
l_int|NULL
suffix:semicolon
)brace
DECL|function|find_component
id|klinfo_t
op_star
id|find_component
c_func
(paren
id|lboard_t
op_star
id|brd
comma
id|klinfo_t
op_star
id|kli
comma
r_int
r_char
id|struct_type
)paren
(brace
r_int
id|index
comma
id|j
suffix:semicolon
r_if
c_cond
(paren
id|kli
op_eq
(paren
id|klinfo_t
op_star
)paren
l_int|NULL
)paren
(brace
id|index
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|KLCF_NUM_COMPS
c_func
(paren
id|brd
)paren
suffix:semicolon
id|j
op_increment
)paren
r_if
c_cond
(paren
id|kli
op_eq
id|KLCF_COMP
c_func
(paren
id|brd
comma
id|j
)paren
)paren
r_break
suffix:semicolon
id|index
op_assign
id|j
suffix:semicolon
r_if
c_cond
(paren
id|index
op_eq
id|KLCF_NUM_COMPS
c_func
(paren
id|brd
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;find_component: Bad pointer: 0x%p&bslash;n&quot;
comma
id|kli
)paren
suffix:semicolon
r_return
(paren
id|klinfo_t
op_star
)paren
l_int|NULL
suffix:semicolon
)brace
id|index
op_increment
suffix:semicolon
multiline_comment|/* next component */
)brace
r_for
c_loop
(paren
suffix:semicolon
id|index
OL
id|KLCF_NUM_COMPS
c_func
(paren
id|brd
)paren
suffix:semicolon
id|index
op_increment
)paren
(brace
id|kli
op_assign
id|KLCF_COMP
c_func
(paren
id|brd
comma
id|index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|KLCF_COMP_TYPE
c_func
(paren
id|kli
)paren
op_eq
id|struct_type
)paren
r_return
id|kli
suffix:semicolon
)brace
multiline_comment|/* Didn&squot;t find it. */
r_return
(paren
id|klinfo_t
op_star
)paren
l_int|NULL
suffix:semicolon
)brace
DECL|function|find_first_component
id|klinfo_t
op_star
id|find_first_component
c_func
(paren
id|lboard_t
op_star
id|brd
comma
r_int
r_char
id|struct_type
)paren
(brace
r_return
id|find_component
c_func
(paren
id|brd
comma
(paren
id|klinfo_t
op_star
)paren
l_int|NULL
comma
id|struct_type
)paren
suffix:semicolon
)brace
DECL|function|get_actual_nasid
id|nasid_t
id|get_actual_nasid
c_func
(paren
id|lboard_t
op_star
id|brd
)paren
(brace
id|klhub_t
op_star
id|hub
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|brd
)paren
r_return
id|INVALID_NASID
suffix:semicolon
multiline_comment|/* find out if we are a completely disabled brd. */
id|hub
op_assign
(paren
id|klhub_t
op_star
)paren
id|find_first_component
c_func
(paren
id|brd
comma
id|KLSTRUCT_HUB
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hub
)paren
r_return
id|INVALID_NASID
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|hub-&gt;hub_info.flags
op_amp
id|KLINFO_ENABLE
)paren
)paren
multiline_comment|/* disabled node brd */
r_return
id|hub-&gt;hub_info.physid
suffix:semicolon
r_else
r_return
id|brd-&gt;brd_nasid
suffix:semicolon
)brace
DECL|function|do_cpumask
r_int
id|do_cpumask
c_func
(paren
id|cnodeid_t
id|cnode
comma
id|nasid_t
id|nasid
comma
id|cpumask_t
op_star
id|boot_cpumask
comma
r_int
op_star
id|highest
)paren
(brace
id|lboard_t
op_star
id|brd
suffix:semicolon
id|klcpu_t
op_star
id|acpu
suffix:semicolon
r_int
id|cpus_found
op_assign
l_int|0
suffix:semicolon
id|cpuid_t
id|cpuid
suffix:semicolon
id|brd
op_assign
id|find_lboard_real
c_func
(paren
(paren
id|lboard_t
op_star
)paren
id|KL_CONFIG_INFO
c_func
(paren
id|nasid
)paren
comma
id|KLTYPE_IP27
)paren
suffix:semicolon
r_do
(brace
id|acpu
op_assign
(paren
id|klcpu_t
op_star
)paren
id|find_first_component
c_func
(paren
id|brd
comma
id|KLSTRUCT_CPU
)paren
suffix:semicolon
r_while
c_loop
(paren
id|acpu
)paren
(brace
id|cpuid
op_assign
id|acpu-&gt;cpu_info.virtid
suffix:semicolon
multiline_comment|/* cnode is not valid for completely disabled brds */
r_if
c_cond
(paren
id|get_actual_nasid
c_func
(paren
id|brd
)paren
op_eq
id|brd-&gt;brd_nasid
)paren
id|cpuid_to_compact_node
(braket
id|cpuid
)braket
op_assign
id|cnode
suffix:semicolon
r_if
c_cond
(paren
id|cpuid
OG
op_star
id|highest
)paren
op_star
id|highest
op_assign
id|cpuid
suffix:semicolon
multiline_comment|/* Only let it join in if it&squot;s marked enabled */
r_if
c_cond
(paren
id|acpu-&gt;cpu_info.flags
op_amp
id|KLINFO_ENABLE
)paren
(brace
id|CPUMASK_SETB
c_func
(paren
op_star
id|boot_cpumask
comma
id|cpuid
)paren
suffix:semicolon
id|cpus_found
op_increment
suffix:semicolon
)brace
id|acpu
op_assign
(paren
id|klcpu_t
op_star
)paren
id|find_component
c_func
(paren
id|brd
comma
(paren
id|klinfo_t
op_star
)paren
id|acpu
comma
id|KLSTRUCT_CPU
)paren
suffix:semicolon
)brace
id|brd
op_assign
id|KLCF_NEXT
c_func
(paren
id|brd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|brd
)paren
id|brd
op_assign
id|find_lboard_real
c_func
(paren
id|brd
comma
id|KLTYPE_IP27
)paren
suffix:semicolon
r_else
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|brd
)paren
suffix:semicolon
r_return
id|cpus_found
suffix:semicolon
)brace
DECL|function|cpu_node_probe
id|cpuid_t
id|cpu_node_probe
c_func
(paren
id|cpumask_t
op_star
id|boot_cpumask
comma
r_int
op_star
id|numnodes
)paren
(brace
r_int
id|i
comma
id|cpus
op_assign
l_int|0
comma
id|highest
op_assign
l_int|0
suffix:semicolon
id|gda_t
op_star
id|gdap
op_assign
id|GDA
suffix:semicolon
id|nasid_t
id|nasid
suffix:semicolon
multiline_comment|/*&n;&t; * Initialize the arrays to invalid nodeid (-1)&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_COMPACT_NODES
suffix:semicolon
id|i
op_increment
)paren
id|compact_to_nasid_node
(braket
id|i
)braket
op_assign
id|INVALID_NASID
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_NASIDS
suffix:semicolon
id|i
op_increment
)paren
id|nasid_to_compact_node
(braket
id|i
)braket
op_assign
id|INVALID_CNODEID
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAXCPUS
suffix:semicolon
id|i
op_increment
)paren
id|cpuid_to_compact_node
(braket
id|i
)braket
op_assign
id|INVALID_CNODEID
suffix:semicolon
op_star
id|numnodes
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_COMPACT_NODES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|nasid
op_assign
id|gdap-&gt;g_nasidtable
(braket
id|i
)braket
)paren
op_eq
id|INVALID_NASID
)paren
(brace
r_break
suffix:semicolon
)brace
r_else
(brace
id|compact_to_nasid_node
(braket
id|i
)braket
op_assign
id|nasid
suffix:semicolon
id|nasid_to_compact_node
(braket
id|nasid
)braket
op_assign
id|i
suffix:semicolon
(paren
op_star
id|numnodes
)paren
op_increment
suffix:semicolon
id|cpus
op_add_assign
id|do_cpumask
c_func
(paren
id|i
comma
id|nasid
comma
id|boot_cpumask
comma
op_amp
id|highest
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Cpus are numbered in order of cnodes. Currently, disabled&n;&t; * cpus are not numbered.&n;&t; */
r_return
id|highest
op_plus
l_int|1
suffix:semicolon
)brace
DECL|function|mlreset
r_void
id|mlreset
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|maxcpus
suffix:semicolon
id|fine_mode
op_assign
id|is_fine_dirmode
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Probe for all CPUs - this creates the cpumask and&n;&t; * sets up the mapping tables.&n;&t; */
id|CPUMASK_CLRALL
c_func
(paren
id|boot_cpumask
)paren
suffix:semicolon
id|maxcpus
op_assign
id|cpu_node_probe
c_func
(paren
op_amp
id|boot_cpumask
comma
op_amp
id|numnodes
)paren
suffix:semicolon
id|gen_region_mask
c_func
(paren
op_amp
id|region_mask
comma
id|numnodes
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set all nodes&squot; calias sizes to 8k&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|numnodes
suffix:semicolon
id|i
op_increment
)paren
(brace
id|nasid_t
id|nasid
suffix:semicolon
id|nasid
op_assign
id|COMPACT_TO_NASID_NODEID
c_func
(paren
id|i
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Always have node 0 in the region mask, otherwise&n;&t;&t; * CALIAS accesses get exceptions since the hub&n;&t;&t; * thinks it is a node 0 address.&n;&t;&t; */
id|REMOTE_HUB_S
c_func
(paren
id|nasid
comma
id|PI_REGION_PRESENT
comma
(paren
id|region_mask
op_or
l_int|1
)paren
)paren
suffix:semicolon
id|REMOTE_HUB_S
c_func
(paren
id|nasid
comma
id|PI_CALIAS_SIZE
comma
id|PI_CALIAS_SIZE_0
)paren
suffix:semicolon
macro_line|#ifdef LATER
multiline_comment|/*&n;&t;&t; * Set up all hubs to have a big window pointing at&n;&t;&t; * widget 0. Memory mode, widget 0, offset 0&n;&t;&t; */
id|REMOTE_HUB_S
c_func
(paren
id|nasid
comma
id|IIO_ITTE
c_func
(paren
id|SWIN0_BIGWIN
)paren
comma
(paren
(paren
id|HUB_PIO_MAP_TO_MEM
op_lshift
id|IIO_ITTE_IOSP_SHIFT
)paren
op_or
(paren
l_int|0
op_lshift
id|IIO_ITTE_WIDGET_SHIFT
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
eof
