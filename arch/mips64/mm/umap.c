multiline_comment|/* $Id: umap.c,v 1.4 2000/01/29 01:41:59 ralf Exp $&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; * Copyright (C) 1994 Linus Torvalds&n; * Copyright (C) 1997 Miguel de Icaza&n; */
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/shm.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/mman.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/swap.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/pgalloc.h&gt;
macro_line|#include &lt;asm/page.h&gt;
r_static
r_inline
r_void
DECL|function|remove_mapping_pte_range
id|remove_mapping_pte_range
(paren
id|pmd_t
op_star
id|pmd
comma
r_int
r_int
id|address
comma
r_int
r_int
id|size
)paren
(brace
id|pte_t
op_star
id|pte
suffix:semicolon
r_int
r_int
id|end
suffix:semicolon
r_if
c_cond
(paren
id|pmd_none
(paren
op_star
id|pmd
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|pmd_bad
(paren
op_star
id|pmd
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;remove_graphics_pte_range: bad pmd (%08lx)&bslash;n&quot;
comma
id|pmd_val
(paren
op_star
id|pmd
)paren
)paren
suffix:semicolon
id|pmd_clear
(paren
id|pmd
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|pte
op_assign
id|pte_offset
(paren
id|pmd
comma
id|address
)paren
suffix:semicolon
id|address
op_and_assign
op_complement
id|PMD_MASK
suffix:semicolon
id|end
op_assign
id|address
op_plus
id|size
suffix:semicolon
r_if
c_cond
(paren
id|end
OG
id|PMD_SIZE
)paren
id|end
op_assign
id|PMD_SIZE
suffix:semicolon
r_do
(brace
id|pte_t
id|entry
op_assign
op_star
id|pte
suffix:semicolon
r_if
c_cond
(paren
id|pte_present
(paren
id|entry
)paren
)paren
id|set_pte
(paren
id|pte
comma
id|pte_modify
(paren
id|entry
comma
id|PAGE_NONE
)paren
)paren
suffix:semicolon
id|address
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|pte
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|address
OL
id|end
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|remove_mapping_pmd_range
id|remove_mapping_pmd_range
(paren
id|pgd_t
op_star
id|pgd
comma
r_int
r_int
id|address
comma
r_int
r_int
id|size
)paren
(brace
id|pmd_t
op_star
id|pmd
suffix:semicolon
r_int
r_int
id|end
suffix:semicolon
r_if
c_cond
(paren
id|pgd_none
(paren
op_star
id|pgd
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|pgd_bad
(paren
op_star
id|pgd
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;remove_graphics_pmd_range: bad pgd (%08lx)&bslash;n&quot;
comma
id|pgd_val
(paren
op_star
id|pgd
)paren
)paren
suffix:semicolon
id|pgd_clear
(paren
id|pgd
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|pmd
op_assign
id|pmd_offset
(paren
id|pgd
comma
id|address
)paren
suffix:semicolon
id|address
op_and_assign
op_complement
id|PGDIR_MASK
suffix:semicolon
id|end
op_assign
id|address
op_plus
id|size
suffix:semicolon
r_if
c_cond
(paren
id|end
OG
id|PGDIR_SIZE
)paren
id|end
op_assign
id|PGDIR_SIZE
suffix:semicolon
r_do
(brace
id|remove_mapping_pte_range
(paren
id|pmd
comma
id|address
comma
id|end
op_minus
id|address
)paren
suffix:semicolon
id|address
op_assign
(paren
id|address
op_plus
id|PMD_SIZE
)paren
op_amp
id|PMD_MASK
suffix:semicolon
id|pmd
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|address
OL
id|end
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This routine is called from the page fault handler to remove a&n; * range of active mappings at this point&n; */
r_void
DECL|function|remove_mapping
id|remove_mapping
(paren
r_struct
id|task_struct
op_star
id|task
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
r_int
r_int
id|beg
op_assign
id|start
suffix:semicolon
id|pgd_t
op_star
id|dir
suffix:semicolon
id|down
(paren
op_amp
id|task-&gt;mm-&gt;mmap_sem
)paren
suffix:semicolon
id|dir
op_assign
id|pgd_offset
(paren
id|task-&gt;mm
comma
id|start
)paren
suffix:semicolon
id|flush_cache_range
(paren
id|task-&gt;mm
comma
id|beg
comma
id|end
)paren
suffix:semicolon
r_while
c_loop
(paren
id|start
OL
id|end
)paren
(brace
id|remove_mapping_pmd_range
(paren
id|dir
comma
id|start
comma
id|end
op_minus
id|start
)paren
suffix:semicolon
id|start
op_assign
(paren
id|start
op_plus
id|PGDIR_SIZE
)paren
op_amp
id|PGDIR_MASK
suffix:semicolon
id|dir
op_increment
suffix:semicolon
)brace
id|flush_tlb_range
(paren
id|task-&gt;mm
comma
id|beg
comma
id|end
)paren
suffix:semicolon
id|up
(paren
op_amp
id|task-&gt;mm-&gt;mmap_sem
)paren
suffix:semicolon
)brace
DECL|function|vmalloc_uncached
r_void
op_star
id|vmalloc_uncached
(paren
r_int
r_int
id|size
)paren
(brace
r_return
id|vmalloc_prot
(paren
id|size
comma
id|PAGE_KERNEL_UNCACHED
)paren
suffix:semicolon
)brace
DECL|function|free_pte
r_static
r_inline
r_void
id|free_pte
c_func
(paren
id|pte_t
id|page
)paren
(brace
r_if
c_cond
(paren
id|pte_present
c_func
(paren
id|page
)paren
)paren
(brace
r_struct
id|page
op_star
id|ptpage
op_assign
id|pte_page
c_func
(paren
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|VALID_PAGE
c_func
(paren
id|ptpage
)paren
)paren
op_logical_or
id|PageReserved
c_func
(paren
id|ptpage
)paren
)paren
r_return
suffix:semicolon
id|__free_page
c_func
(paren
id|ptpage
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;mm-&gt;rss
op_le
l_int|0
)paren
r_return
suffix:semicolon
id|current-&gt;mm-&gt;rss
op_decrement
suffix:semicolon
r_return
suffix:semicolon
)brace
id|swap_free
c_func
(paren
id|pte_to_swp_entry
c_func
(paren
id|page
)paren
)paren
suffix:semicolon
)brace
DECL|function|forget_pte
r_static
r_inline
r_void
id|forget_pte
c_func
(paren
id|pte_t
id|page
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pte_none
c_func
(paren
id|page
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;forget_pte: old mapping existed!&bslash;n&quot;
)paren
suffix:semicolon
id|free_pte
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * maps a range of vmalloc()ed memory into the requested pages. the old&n; * mappings are removed. &n; */
r_static
r_inline
r_void
DECL|function|vmap_pte_range
id|vmap_pte_range
(paren
id|pte_t
op_star
id|pte
comma
r_int
r_int
id|address
comma
r_int
r_int
id|size
comma
r_int
r_int
id|vaddr
)paren
(brace
r_int
r_int
id|end
suffix:semicolon
id|pgd_t
op_star
id|vdir
suffix:semicolon
id|pmd_t
op_star
id|vpmd
suffix:semicolon
id|pte_t
op_star
id|vpte
suffix:semicolon
id|address
op_and_assign
op_complement
id|PMD_MASK
suffix:semicolon
id|end
op_assign
id|address
op_plus
id|size
suffix:semicolon
r_if
c_cond
(paren
id|end
OG
id|PMD_SIZE
)paren
id|end
op_assign
id|PMD_SIZE
suffix:semicolon
r_do
(brace
id|pte_t
id|oldpage
op_assign
op_star
id|pte
suffix:semicolon
r_struct
id|page
op_star
id|page
suffix:semicolon
id|pte_clear
c_func
(paren
id|pte
)paren
suffix:semicolon
id|vdir
op_assign
id|pgd_offset_k
(paren
id|vaddr
)paren
suffix:semicolon
id|vpmd
op_assign
id|pmd_offset
(paren
id|vdir
comma
id|vaddr
)paren
suffix:semicolon
id|vpte
op_assign
id|pte_offset
(paren
id|vpmd
comma
id|vaddr
)paren
suffix:semicolon
id|page
op_assign
id|pte_page
(paren
op_star
id|vpte
)paren
suffix:semicolon
id|set_pte
c_func
(paren
id|pte
comma
id|mk_pte
c_func
(paren
id|page
comma
id|PAGE_USERIO
)paren
)paren
suffix:semicolon
id|forget_pte
c_func
(paren
id|oldpage
)paren
suffix:semicolon
id|address
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|vaddr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|pte
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|address
OL
id|end
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|vmap_pmd_range
id|vmap_pmd_range
(paren
id|pmd_t
op_star
id|pmd
comma
r_int
r_int
id|address
comma
r_int
r_int
id|size
comma
r_int
r_int
id|vaddr
)paren
(brace
r_int
r_int
id|end
suffix:semicolon
id|address
op_and_assign
op_complement
id|PGDIR_MASK
suffix:semicolon
id|end
op_assign
id|address
op_plus
id|size
suffix:semicolon
r_if
c_cond
(paren
id|end
OG
id|PGDIR_SIZE
)paren
id|end
op_assign
id|PGDIR_SIZE
suffix:semicolon
id|vaddr
op_sub_assign
id|address
suffix:semicolon
r_do
(brace
id|pte_t
op_star
id|pte
op_assign
id|pte_alloc
c_func
(paren
id|pmd
comma
id|address
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pte
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|vmap_pte_range
c_func
(paren
id|pte
comma
id|address
comma
id|end
op_minus
id|address
comma
id|address
op_plus
id|vaddr
)paren
suffix:semicolon
id|address
op_assign
(paren
id|address
op_plus
id|PMD_SIZE
)paren
op_amp
id|PMD_MASK
suffix:semicolon
id|pmd
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|address
OL
id|end
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|vmap_page_range
id|vmap_page_range
(paren
r_int
r_int
id|from
comma
r_int
r_int
id|size
comma
r_int
r_int
id|vaddr
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
id|pgd_t
op_star
id|dir
suffix:semicolon
r_int
r_int
id|beg
op_assign
id|from
suffix:semicolon
r_int
r_int
id|end
op_assign
id|from
op_plus
id|size
suffix:semicolon
id|vaddr
op_sub_assign
id|from
suffix:semicolon
id|dir
op_assign
id|pgd_offset
c_func
(paren
id|current-&gt;mm
comma
id|from
)paren
suffix:semicolon
id|flush_cache_range
c_func
(paren
id|current-&gt;mm
comma
id|beg
comma
id|end
)paren
suffix:semicolon
r_while
c_loop
(paren
id|from
OL
id|end
)paren
(brace
id|pmd_t
op_star
id|pmd
op_assign
id|pmd_alloc
c_func
(paren
id|dir
comma
id|from
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pmd
)paren
r_break
suffix:semicolon
id|error
op_assign
id|vmap_pmd_range
c_func
(paren
id|pmd
comma
id|from
comma
id|end
op_minus
id|from
comma
id|vaddr
op_plus
id|from
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_break
suffix:semicolon
id|from
op_assign
(paren
id|from
op_plus
id|PGDIR_SIZE
)paren
op_amp
id|PGDIR_MASK
suffix:semicolon
id|dir
op_increment
suffix:semicolon
)brace
id|flush_tlb_range
c_func
(paren
id|current-&gt;mm
comma
id|beg
comma
id|end
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
eof
