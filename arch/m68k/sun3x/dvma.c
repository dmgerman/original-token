multiline_comment|/*&n; * Virtual DMA allocation&n; *&n; * (C) 1999 Thomas Bogendoerfer (tsbogend@alpha.franken.de) &n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/sun3x.h&gt;
macro_line|#include &lt;asm/dvma.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/page.h&gt;
multiline_comment|/* IOMMU support */
DECL|macro|IOMMU_ENTRIES
mdefine_line|#define IOMMU_ENTRIES&t;&t;   2048
DECL|macro|IOMMU_ADDR_MASK
mdefine_line|#define IOMMU_ADDR_MASK            0x03ffe000
DECL|macro|IOMMU_CACHE_INHIBIT
mdefine_line|#define IOMMU_CACHE_INHIBIT        0x00000040
DECL|macro|IOMMU_FULL_BLOCK
mdefine_line|#define IOMMU_FULL_BLOCK           0x00000020
DECL|macro|IOMMU_MODIFIED
mdefine_line|#define IOMMU_MODIFIED             0x00000010
DECL|macro|IOMMU_USED
mdefine_line|#define IOMMU_USED                 0x00000008
DECL|macro|IOMMU_WRITE_PROTECT
mdefine_line|#define IOMMU_WRITE_PROTECT        0x00000004
DECL|macro|IOMMU_DT_MASK
mdefine_line|#define IOMMU_DT_MASK              0x00000003
DECL|macro|IOMMU_DT_INVALID
mdefine_line|#define IOMMU_DT_INVALID           0x00000000
DECL|macro|IOMMU_DT_VALID
mdefine_line|#define IOMMU_DT_VALID             0x00000001
DECL|macro|IOMMU_DT_BAD
mdefine_line|#define IOMMU_DT_BAD               0x00000002
DECL|macro|DVMA_PAGE_SHIFT
mdefine_line|#define DVMA_PAGE_SHIFT&t;13
DECL|macro|DVMA_PAGE_SIZE
mdefine_line|#define DVMA_PAGE_SIZE&t;(1UL &lt;&lt; DVMA_PAGE_SHIFT)
DECL|macro|DVMA_PAGE_MASK
mdefine_line|#define DVMA_PAGE_MASK&t;(~(DVMA_PAGE_SIZE-1))
DECL|variable|iommu_pte
r_static
r_volatile
r_int
r_int
op_star
id|iommu_pte
op_assign
(paren
r_int
r_int
op_star
)paren
id|SUN3X_IOMMU
suffix:semicolon
DECL|variable|iommu_use
r_static
r_int
r_int
id|iommu_use
(braket
id|IOMMU_ENTRIES
)braket
suffix:semicolon
DECL|variable|iommu_bitmap
r_static
r_int
r_int
id|iommu_bitmap
(braket
id|IOMMU_ENTRIES
op_div
l_int|32
)braket
suffix:semicolon
DECL|macro|dvma_entry_paddr
mdefine_line|#define dvma_entry_paddr(index) &t;(iommu_pte[index] &amp; IOMMU_ADDR_MASK)
DECL|macro|dvma_entry_vaddr
mdefine_line|#define dvma_entry_vaddr(index,paddr) &t;((index &lt;&lt; DVMA_PAGE_SHIFT) |  &bslash;&n;&t;&t;&t;&t;&t; (paddr &amp; (DVMA_PAGE_SIZE-1)))
DECL|macro|dvma_entry_set
mdefine_line|#define dvma_entry_set(index,addr)&t;(iommu_pte[index] =            &bslash;&n;&t;&t;&t;&t;&t;    (addr &amp; IOMMU_ADDR_MASK) | &bslash;&n;&t;&t;&t;&t;             IOMMU_DT_VALID)
DECL|macro|dvma_entry_clr
mdefine_line|#define dvma_entry_clr(index)&t;&t;(iommu_pte[index] = IOMMU_DT_INVALID)
DECL|macro|dvma_entry_use
mdefine_line|#define dvma_entry_use(index)&t;&t;(iommu_use[index])
DECL|macro|dvma_entry_inc
mdefine_line|#define dvma_entry_inc(index)&t;&t;(iommu_use[index]++)
DECL|macro|dvma_entry_dec
mdefine_line|#define dvma_entry_dec(index)&t;&t;(iommu_use[index]--)
DECL|macro|dvma_entry_hash
mdefine_line|#define dvma_entry_hash(addr)&t;&t;((addr &gt;&gt; DVMA_PAGE_SHIFT) ^ &bslash;&n;&t;&t;&t;&t;&t; ((addr &amp; 0x03c00000) &gt;&gt;     &bslash;&n;&t;&t;&t;&t;&t;&t;(DVMA_PAGE_SHIFT+4)))
DECL|macro|dvma_map
mdefine_line|#define dvma_map&t;&t;&t;iommu_bitmap
DECL|macro|dvma_map_size
mdefine_line|#define dvma_map_size&t;&t;&t;(IOMMU_ENTRIES/2)
DECL|macro|dvma_slow_offset
mdefine_line|#define dvma_slow_offset&t;&t;(IOMMU_ENTRIES/2)
DECL|macro|dvma_is_slow
mdefine_line|#define dvma_is_slow(addr)&t;&t;((addr) &amp; &t;&t;      &bslash;&n;&t;&t;&t;&t;&t; (dvma_slow_offset &lt;&lt; DVMA_PAGE_SHIFT))
DECL|variable|fixed_dvma
r_static
r_int
id|fixed_dvma
suffix:semicolon
DECL|function|dvma_init
r_void
id|__init
id|dvma_init
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|tmp
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|high_memory
OL
(paren
id|IOMMU_ENTRIES
op_lshift
id|DVMA_PAGE_SHIFT
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;Sun3x fixed DVMA mapping&bslash;n&quot;
)paren
suffix:semicolon
id|fixed_dvma
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|tmp
op_assign
l_int|0
suffix:semicolon
id|tmp
OL
(paren
r_int
r_int
)paren
id|high_memory
suffix:semicolon
id|tmp
op_add_assign
id|DVMA_PAGE_SIZE
)paren
id|dvma_entry_set
(paren
id|tmp
op_rshift
id|DVMA_PAGE_SHIFT
comma
id|virt_to_phys
c_func
(paren
(paren
r_void
op_star
)paren
id|tmp
)paren
)paren
suffix:semicolon
id|fixed_dvma
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|printk
(paren
l_string|&quot;Sun3x variable DVMA mapping&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|tmp
op_assign
l_int|0
suffix:semicolon
id|tmp
OL
id|IOMMU_ENTRIES
suffix:semicolon
id|tmp
op_increment
)paren
id|dvma_entry_clr
(paren
id|tmp
)paren
suffix:semicolon
id|fixed_dvma
op_assign
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|dvma_slow_alloc
r_int
r_int
id|dvma_slow_alloc
(paren
r_int
r_int
id|paddr
comma
r_int
id|npages
)paren
(brace
r_int
id|scan
comma
id|base
suffix:semicolon
id|scan
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|scan
op_assign
id|find_next_zero_bit
c_func
(paren
id|dvma_map
comma
id|dvma_map_size
comma
id|scan
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|base
op_assign
id|scan
)paren
op_plus
id|npages
OG
id|dvma_map_size
)paren
(brace
id|printk
(paren
l_string|&quot;dvma_slow_alloc failed for %d pages&bslash;n&quot;
comma
id|npages
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|scan
op_ge
id|base
op_plus
id|npages
)paren
r_goto
id|found
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|scan
comma
id|dvma_map
)paren
)paren
r_break
suffix:semicolon
id|scan
op_increment
suffix:semicolon
)brace
)brace
id|found
suffix:colon
r_for
c_loop
(paren
id|scan
op_assign
id|base
suffix:semicolon
id|scan
OL
id|base
op_plus
id|npages
suffix:semicolon
id|scan
op_increment
)paren
(brace
id|dvma_entry_set
c_func
(paren
id|scan
op_plus
id|dvma_slow_offset
comma
id|paddr
)paren
suffix:semicolon
id|paddr
op_add_assign
id|DVMA_PAGE_SIZE
suffix:semicolon
id|set_bit
c_func
(paren
id|scan
comma
id|dvma_map
)paren
suffix:semicolon
)brace
r_return
(paren
id|dvma_entry_vaddr
c_func
(paren
(paren
id|base
op_plus
id|dvma_slow_offset
)paren
comma
id|paddr
)paren
)paren
suffix:semicolon
)brace
DECL|function|dvma_alloc
r_int
r_int
id|dvma_alloc
(paren
r_int
r_int
id|paddr
comma
r_int
r_int
id|size
)paren
(brace
r_int
id|index
suffix:semicolon
r_int
id|pages
op_assign
(paren
(paren
id|paddr
op_amp
op_complement
id|DVMA_PAGE_MASK
)paren
op_plus
id|size
op_plus
(paren
id|DVMA_PAGE_SIZE
op_minus
l_int|1
)paren
)paren
op_rshift
id|DVMA_PAGE_SHIFT
suffix:semicolon
r_if
c_cond
(paren
id|fixed_dvma
)paren
r_return
(paren
(paren
r_int
r_int
)paren
id|phys_to_virt
(paren
id|paddr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pages
OG
l_int|1
)paren
multiline_comment|/* multi page, allocate from slow pool */
r_return
id|dvma_slow_alloc
(paren
id|paddr
comma
id|pages
)paren
suffix:semicolon
id|index
op_assign
id|dvma_entry_hash
(paren
id|paddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dvma_entry_use
c_func
(paren
id|index
)paren
)paren
(brace
r_if
c_cond
(paren
id|dvma_entry_paddr
c_func
(paren
id|index
)paren
op_eq
(paren
id|paddr
op_amp
id|DVMA_PAGE_MASK
)paren
)paren
(brace
id|dvma_entry_inc
c_func
(paren
id|index
)paren
suffix:semicolon
r_return
id|dvma_entry_vaddr
c_func
(paren
id|index
comma
id|paddr
)paren
suffix:semicolon
)brace
multiline_comment|/* collision, allocate from slow pool */
r_return
id|dvma_slow_alloc
(paren
id|paddr
comma
id|pages
)paren
suffix:semicolon
)brace
id|dvma_entry_set
c_func
(paren
id|index
comma
id|paddr
)paren
suffix:semicolon
id|dvma_entry_inc
c_func
(paren
id|index
)paren
suffix:semicolon
r_return
id|dvma_entry_vaddr
c_func
(paren
id|index
comma
id|paddr
)paren
suffix:semicolon
)brace
DECL|function|dvma_free
r_void
id|dvma_free
(paren
r_int
r_int
id|dvma_addr
comma
r_int
r_int
id|size
)paren
(brace
r_int
id|npages
suffix:semicolon
r_int
id|index
suffix:semicolon
r_if
c_cond
(paren
id|fixed_dvma
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dvma_is_slow
c_func
(paren
id|dvma_addr
)paren
)paren
(brace
id|index
op_assign
(paren
id|dvma_addr
op_rshift
id|DVMA_PAGE_SHIFT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dvma_entry_use
c_func
(paren
id|index
)paren
op_eq
l_int|0
)paren
(brace
id|printk
(paren
l_string|&quot;dvma_free: %lx entry already free&bslash;n&quot;
comma
id|dvma_addr
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dvma_entry_dec
c_func
(paren
id|index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dvma_entry_use
c_func
(paren
id|index
)paren
op_eq
l_int|0
)paren
id|dvma_entry_clr
c_func
(paren
id|index
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* free in slow pool */
id|npages
op_assign
(paren
(paren
id|dvma_addr
op_amp
op_complement
id|DVMA_PAGE_MASK
)paren
op_plus
id|size
op_plus
(paren
id|DVMA_PAGE_SIZE
op_minus
l_int|1
)paren
)paren
op_rshift
id|DVMA_PAGE_SHIFT
suffix:semicolon
r_for
c_loop
(paren
id|index
op_assign
(paren
id|dvma_addr
op_rshift
id|DVMA_PAGE_SHIFT
)paren
suffix:semicolon
id|npages
op_decrement
suffix:semicolon
id|index
op_increment
)paren
(brace
id|dvma_entry_clr
c_func
(paren
id|index
)paren
suffix:semicolon
id|clear_bit
(paren
id|index
comma
id|dvma_map
)paren
suffix:semicolon
)brace
)brace
eof
