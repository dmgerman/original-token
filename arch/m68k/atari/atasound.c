multiline_comment|/*&n;linux/arch/m68k/atari/atasound.c&n;&n;++Geert: Moved almost all stuff to linux/drivers/sound/&n;&n;The author of atari_nosound, atari_mksound and atari_microwire_cmd is&n;unknown.&n;(++roman: That&squot;s me... :-)&n;&n;This file is subject to the terms and conditions of the GNU General Public&n;License.  See the file README.legal in the main directory of this archive&n;for more details.&n;&n;*/
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/atarihw.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/atariints.h&gt;
macro_line|#include &lt;asm/bootinfo.h&gt;
multiline_comment|/*&n; * stuff from the old atasound.c&n; */
DECL|function|atari_nosound
r_static
r_void
id|atari_nosound
(paren
r_int
r_int
id|ignored
)paren
(brace
r_int
r_char
id|tmp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* turn off generator A in mixer control */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|sound_ym.rd_data_reg_sel
op_assign
l_int|7
suffix:semicolon
id|tmp
op_assign
id|sound_ym.rd_data_reg_sel
suffix:semicolon
id|sound_ym.wd_data
op_assign
id|tmp
op_or
l_int|0x39
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|atari_microwire_cmd
r_void
id|atari_microwire_cmd
(paren
r_int
id|cmd
)paren
(brace
id|tt_microwire.mask
op_assign
l_int|0x7ff
suffix:semicolon
id|tt_microwire.data
op_assign
id|MW_LM1992_ADDR
op_or
id|cmd
suffix:semicolon
multiline_comment|/* Busy wait for data being completely sent :-( */
r_while
c_loop
(paren
id|tt_microwire.mask
op_ne
l_int|0x7ff
)paren
(brace
suffix:semicolon
)brace
)brace
DECL|macro|PC_FREQ
mdefine_line|#define&t;PC_FREQ&t;&t;1192180
DECL|macro|PSG_FREQ
mdefine_line|#define&t;PSG_FREQ&t;125000
DECL|function|atari_mksound
r_void
id|atari_mksound
(paren
r_int
r_int
id|count
comma
r_int
r_int
id|ticks
)paren
(brace
r_static
r_struct
id|timer_list
id|sound_timer
op_assign
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|0
comma
l_int|0
comma
id|atari_nosound
)brace
suffix:semicolon
multiline_comment|/*&n;&t; * Generates sound of some count for some number of clock ticks&n;&t; * [count = 1193180 / frequency]&n;&t; */
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|tmp
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|750
op_logical_and
id|ticks
op_eq
id|HZ
op_div
l_int|8
)paren
(brace
multiline_comment|/* Special case: These values are used by console.c to&n;&t;&t; * generate the console bell. They are catched here and the&n;&t;&t; * sound actually generated is somehow special: it uses the&n;&t;&t; * generator B and an envelope. No timer is needed therefore&n;&t;&t; * and the bell doesn&squot;t disturb an other ongoing sound.&n;&t;&t; */
multiline_comment|/* set envelope duration to 492 ms */
id|sound_ym.rd_data_reg_sel
op_assign
l_int|11
suffix:semicolon
id|sound_ym.wd_data
op_assign
l_int|0
suffix:semicolon
id|sound_ym.rd_data_reg_sel
op_assign
l_int|12
suffix:semicolon
id|sound_ym.wd_data
op_assign
l_int|15
suffix:semicolon
multiline_comment|/* envelope form: max -&gt; min single */
id|sound_ym.rd_data_reg_sel
op_assign
l_int|13
suffix:semicolon
id|sound_ym.wd_data
op_assign
l_int|9
suffix:semicolon
multiline_comment|/* set generator B frequency to 2400 Hz */
id|sound_ym.rd_data_reg_sel
op_assign
l_int|2
suffix:semicolon
id|sound_ym.wd_data
op_assign
l_int|52
suffix:semicolon
id|sound_ym.rd_data_reg_sel
op_assign
l_int|3
suffix:semicolon
id|sound_ym.wd_data
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* set volume of generator B to envelope control */
id|sound_ym.rd_data_reg_sel
op_assign
l_int|9
suffix:semicolon
id|sound_ym.wd_data
op_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* enable generator B in the mixer control */
id|sound_ym.rd_data_reg_sel
op_assign
l_int|7
suffix:semicolon
id|tmp
op_assign
id|sound_ym.rd_data_reg_sel
suffix:semicolon
id|sound_ym.wd_data
op_assign
(paren
id|tmp
op_amp
op_complement
l_int|0x02
)paren
op_or
l_int|0x38
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|del_timer
c_func
(paren
op_amp
id|sound_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|count
)paren
(brace
id|atari_nosound
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* convert from PC counter value (base frequency 1.193 MHz)&n;&t;&t; * to PSG period value (base frequency 125 kHz).&n;&t;&t; */
r_int
id|period
op_assign
(paren
id|PSG_FREQ
op_star
id|count
op_plus
id|PC_FREQ
op_div
l_int|2
)paren
op_div
id|PC_FREQ
suffix:semicolon
r_if
c_cond
(paren
id|period
OG
l_int|0xfff
)paren
id|period
op_assign
l_int|0xfff
suffix:semicolon
multiline_comment|/* set generator A frequency to 0 */
id|sound_ym.rd_data_reg_sel
op_assign
l_int|0
suffix:semicolon
id|sound_ym.wd_data
op_assign
id|period
op_amp
l_int|0xff
suffix:semicolon
id|sound_ym.rd_data_reg_sel
op_assign
l_int|1
suffix:semicolon
id|sound_ym.wd_data
op_assign
(paren
id|period
op_rshift
l_int|8
)paren
op_amp
l_int|0xf
suffix:semicolon
multiline_comment|/* turn on generator A in mixer control (but not noise&n;&t;&t; * generator!) */
id|sound_ym.rd_data_reg_sel
op_assign
l_int|7
suffix:semicolon
id|tmp
op_assign
id|sound_ym.rd_data_reg_sel
suffix:semicolon
id|sound_ym.wd_data
op_assign
(paren
id|tmp
op_amp
op_complement
l_int|0x01
)paren
op_or
l_int|0x38
suffix:semicolon
multiline_comment|/* set generator A level to maximum, no envelope */
id|sound_ym.rd_data_reg_sel
op_assign
l_int|8
suffix:semicolon
id|sound_ym.wd_data
op_assign
l_int|15
suffix:semicolon
r_if
c_cond
(paren
id|ticks
)paren
(brace
id|sound_timer.expires
op_assign
id|jiffies
op_plus
id|ticks
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|sound_timer
)paren
suffix:semicolon
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
eof
