multiline_comment|/*&n; *  linux/arch/m68k/atari/config.c&n; *&n; *  Copyright (C) 1994 Bjoern Brauel&n; *&n; *  5/2/94 Roman Hodek:&n; *    Added setting of time_adj to get a better clock.&n; *&n; *  5/14/94 Roman Hodek:&n; *    gettod() for TT &n; *&n; *  5/15/94 Roman Hodek:&n; *    hard_reset_now() for Atari (and others?)&n; *&n; *  94/12/30 Andreas Schwab:&n; *    atari_sched_init fixed to get precise clock.&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file COPYING in the main directory of this archive&n; * for more details.&n; */
multiline_comment|/*&n; * Miscellaneous atari stuff&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;asm/bootinfo.h&gt;
macro_line|#include &lt;asm/setup.h&gt;
macro_line|#include &lt;asm/atarihw.h&gt;
macro_line|#include &lt;asm/atariints.h&gt;
macro_line|#include &lt;asm/atari_stram.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/hwtest.h&gt;
macro_line|#include &lt;asm/io.h&gt;
DECL|variable|atari_mch_cookie
id|u_long
id|atari_mch_cookie
suffix:semicolon
DECL|variable|atari_mch_type
id|u_long
id|atari_mch_type
op_assign
l_int|0
suffix:semicolon
DECL|variable|atari_hw_present
r_struct
id|atari_hw_present
id|atari_hw_present
suffix:semicolon
DECL|variable|atari_switches
id|u_long
id|atari_switches
op_assign
l_int|0
suffix:semicolon
DECL|variable|atari_dont_touch_floppy_select
r_int
id|atari_dont_touch_floppy_select
op_assign
l_int|0
suffix:semicolon
DECL|variable|atari_rtc_year_offset
r_int
id|atari_rtc_year_offset
suffix:semicolon
multiline_comment|/* local function prototypes */
r_static
r_void
id|atari_reset
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ATARI_FLOPPY
r_extern
r_void
id|atari_floppy_setup
c_func
(paren
r_char
op_star
comma
r_int
op_star
)paren
suffix:semicolon
macro_line|#endif
r_static
r_void
id|atari_get_model
c_func
(paren
r_char
op_star
id|model
)paren
suffix:semicolon
r_static
r_int
id|atari_get_hardware_list
c_func
(paren
r_char
op_star
id|buffer
)paren
suffix:semicolon
multiline_comment|/* atari specific keyboard functions */
r_extern
r_int
id|atari_keyb_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_int
id|atari_kbdrate
(paren
r_struct
id|kbd_repeat
op_star
)paren
suffix:semicolon
r_extern
r_int
id|atari_kbd_translate
c_func
(paren
r_int
r_char
id|keycode
comma
r_int
r_char
op_star
id|keycodep
comma
r_char
id|raw_mode
)paren
suffix:semicolon
r_extern
r_void
id|atari_kbd_leds
(paren
r_int
r_int
)paren
suffix:semicolon
multiline_comment|/* atari specific irq functions */
r_extern
r_void
id|atari_init_IRQ
(paren
r_void
)paren
suffix:semicolon
r_extern
r_int
id|atari_request_irq
(paren
r_int
r_int
id|irq
comma
r_void
(paren
op_star
id|handler
)paren
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
comma
r_int
r_int
id|flags
comma
r_const
r_char
op_star
id|devname
comma
r_void
op_star
id|dev_id
)paren
suffix:semicolon
r_extern
r_void
id|atari_free_irq
(paren
r_int
r_int
id|irq
comma
r_void
op_star
id|dev_id
)paren
suffix:semicolon
r_extern
r_void
id|atari_enable_irq
(paren
r_int
r_int
)paren
suffix:semicolon
r_extern
r_void
id|atari_disable_irq
(paren
r_int
r_int
)paren
suffix:semicolon
r_extern
r_int
id|atari_get_irq_list
(paren
r_char
op_star
id|buf
)paren
suffix:semicolon
r_extern
r_void
id|atari_mksound
c_func
(paren
r_int
r_int
id|count
comma
r_int
r_int
id|ticks
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_HEARTBEAT
r_static
r_void
id|atari_heartbeat
c_func
(paren
r_int
id|on
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* atari specific timer functions (in time.c) */
r_extern
r_void
id|atari_sched_init
c_func
(paren
r_void
(paren
op_star
)paren
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
)paren
suffix:semicolon
r_extern
r_int
r_int
id|atari_gettimeoffset
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|atari_mste_gettod
(paren
r_int
op_star
comma
r_int
op_star
comma
r_int
op_star
comma
r_int
op_star
comma
r_int
op_star
comma
r_int
op_star
)paren
suffix:semicolon
r_extern
r_void
id|atari_tt_gettod
(paren
r_int
op_star
comma
r_int
op_star
comma
r_int
op_star
comma
r_int
op_star
comma
r_int
op_star
comma
r_int
op_star
)paren
suffix:semicolon
r_extern
r_int
id|atari_mste_hwclk
(paren
r_int
comma
r_struct
id|hwclk_time
op_star
)paren
suffix:semicolon
r_extern
r_int
id|atari_tt_hwclk
(paren
r_int
comma
r_struct
id|hwclk_time
op_star
)paren
suffix:semicolon
r_extern
r_int
id|atari_mste_set_clock_mmss
(paren
r_int
r_int
)paren
suffix:semicolon
r_extern
r_int
id|atari_tt_set_clock_mmss
(paren
r_int
r_int
)paren
suffix:semicolon
multiline_comment|/* atari specific debug functions (in debug.c) */
r_extern
r_void
id|atari_debug_init
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_MAGIC_SYSRQ
DECL|variable|atari_sysrq_xlate
r_static
r_char
id|atari_sysrq_xlate
(braket
l_int|128
)braket
op_assign
l_string|&quot;&bslash;000&bslash;0331234567890-=&bslash;177&bslash;t&quot;
multiline_comment|/* 0x00 - 0x0f */
l_string|&quot;qwertyuiop[]&bslash;r&bslash;000as&quot;
multiline_comment|/* 0x10 - 0x1f */
l_string|&quot;dfghjkl;&squot;`&bslash;000&bslash;&bslash;zxcv&quot;
multiline_comment|/* 0x20 - 0x2f */
l_string|&quot;bnm,./&bslash;000&bslash;000&bslash;000 &bslash;000&bslash;201&bslash;202&bslash;203&bslash;204&bslash;205&quot;
multiline_comment|/* 0x30 - 0x3f */
l_string|&quot;&bslash;206&bslash;207&bslash;210&bslash;211&bslash;212&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000-&bslash;000&bslash;000&bslash;000+&bslash;000&quot;
multiline_comment|/* 0x40 - 0x4f */
l_string|&quot;&bslash;000&bslash;000&bslash;000&bslash;177&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000&quot;
multiline_comment|/* 0x50 - 0x5f */
l_string|&quot;&bslash;000&bslash;000&bslash;000()/*789456123&quot;
multiline_comment|/* 0x60 - 0x6f */
l_string|&quot;0.&bslash;r&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000&quot;
suffix:semicolon
multiline_comment|/* 0x70 - 0x7f */
macro_line|#endif
r_extern
r_void
(paren
op_star
id|kd_mksound
)paren
(paren
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
multiline_comment|/* I&squot;ve moved hwreg_present() and hwreg_present_bywrite() out into&n; * mm/hwtest.c, to avoid having multiple copies of the same routine&n; * in the kernel [I wanted them in hp300 and they were already used&n; * in the nubus code. NB: I don&squot;t have an Atari so this might (just&n; * conceivably) break something.&n; * I&squot;ve preserved the #if 0 version of hwreg_present_bywrite() here&n; * for posterity.&n; *   -- Peter Maydell &lt;pmaydell@chiark.greenend.org.uk&gt;, 05/1998&n; */
macro_line|#if 0
r_static
r_int
id|__init
id|hwreg_present_bywrite
c_func
(paren
r_volatile
r_void
op_star
id|regp
comma
r_int
r_char
id|val
)paren
(brace
r_int
id|ret
suffix:semicolon
r_int
id|save_sp
comma
id|save_vbr
suffix:semicolon
r_static
r_int
id|tmp_vectors
(braket
l_int|3
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
(paren
r_int
)paren
op_logical_and
id|after_test
)brace
suffix:semicolon
id|__asm__
id|__volatile__
(paren
l_string|&quot;movec&t;%/vbr,%2&bslash;n&bslash;t&quot;
multiline_comment|/* save vbr value            */
l_string|&quot;movec&t;%4,%/vbr&bslash;n&bslash;t&quot;
multiline_comment|/* set up temporary vectors  */
l_string|&quot;movel&t;%/sp,%1&bslash;n&bslash;t&quot;
multiline_comment|/* save sp                   */
l_string|&quot;moveq&t;#0,%0&bslash;n&bslash;t&quot;
multiline_comment|/* assume not present        */
l_string|&quot;moveb&t;%5,%3@&bslash;n&bslash;t&quot;
multiline_comment|/* write the hardware reg    */
l_string|&quot;cmpb&t;%3@,%5&bslash;n&bslash;t&quot;
multiline_comment|/* compare it                */
l_string|&quot;seq&t;%0&quot;
multiline_comment|/* comes here only if reg    */
multiline_comment|/* is present                */
suffix:colon
l_string|&quot;=d&amp;&quot;
(paren
id|ret
)paren
comma
l_string|&quot;=r&amp;&quot;
(paren
id|save_sp
)paren
comma
l_string|&quot;=r&amp;&quot;
(paren
id|save_vbr
)paren
suffix:colon
l_string|&quot;a&quot;
(paren
id|regp
)paren
comma
l_string|&quot;r&quot;
(paren
id|tmp_vectors
)paren
comma
l_string|&quot;d&quot;
(paren
id|val
)paren
)paren
suffix:semicolon
id|after_test
suffix:colon
id|__asm__
id|__volatile__
(paren
l_string|&quot;movel&t;%0,%/sp&bslash;n&bslash;t&quot;
multiline_comment|/* restore sp                */
l_string|&quot;movec&t;%1,%/vbr&quot;
multiline_comment|/* restore vbr               */
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|save_sp
)paren
comma
l_string|&quot;r&quot;
(paren
id|save_vbr
)paren
suffix:colon
l_string|&quot;sp&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* ++roman: This is a more elaborate test for an SCC chip, since the plain&n; * Medusa board generates DTACK at the SCC&squot;s standard addresses, but a SCC&n; * board in the Medusa is possible. Also, the addresses where the ST_ESCC&n; * resides generate DTACK without the chip, too.&n; * The method is to write values into the interrupt vector register, that&n; * should be readable without trouble (from channel A!).&n; */
DECL|function|scc_test
r_static
r_int
id|__init
id|scc_test
c_func
(paren
r_volatile
r_char
op_star
id|ctla
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|hwreg_present
c_func
(paren
id|ctla
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|MFPDELAY
c_func
(paren
)paren
suffix:semicolon
op_star
id|ctla
op_assign
l_int|2
suffix:semicolon
id|MFPDELAY
c_func
(paren
)paren
suffix:semicolon
op_star
id|ctla
op_assign
l_int|0x40
suffix:semicolon
id|MFPDELAY
c_func
(paren
)paren
suffix:semicolon
op_star
id|ctla
op_assign
l_int|2
suffix:semicolon
id|MFPDELAY
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|ctla
op_ne
l_int|0x40
)paren
r_return
l_int|0
suffix:semicolon
id|MFPDELAY
c_func
(paren
)paren
suffix:semicolon
op_star
id|ctla
op_assign
l_int|2
suffix:semicolon
id|MFPDELAY
c_func
(paren
)paren
suffix:semicolon
op_star
id|ctla
op_assign
l_int|0x60
suffix:semicolon
id|MFPDELAY
c_func
(paren
)paren
suffix:semicolon
op_star
id|ctla
op_assign
l_int|2
suffix:semicolon
id|MFPDELAY
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|ctla
op_ne
l_int|0x60
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Parse an Atari-specific record in the bootinfo&n;     */
DECL|function|atari_parse_bootinfo
r_int
id|__init
id|atari_parse_bootinfo
c_func
(paren
r_const
r_struct
id|bi_record
op_star
id|record
)paren
(brace
r_int
id|unknown
op_assign
l_int|0
suffix:semicolon
r_const
id|u_long
op_star
id|data
op_assign
id|record-&gt;data
suffix:semicolon
r_switch
c_cond
(paren
id|record-&gt;tag
)paren
(brace
r_case
id|BI_ATARI_MCH_COOKIE
suffix:colon
id|atari_mch_cookie
op_assign
op_star
id|data
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BI_ATARI_MCH_TYPE
suffix:colon
id|atari_mch_type
op_assign
op_star
id|data
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|unknown
op_assign
l_int|1
suffix:semicolon
)brace
r_return
id|unknown
suffix:semicolon
)brace
multiline_comment|/* Parse the Atari-specific switches= option. */
DECL|function|atari_switches_setup
r_void
id|__init
id|atari_switches_setup
c_func
(paren
r_const
r_char
op_star
id|str
comma
r_int
id|len
)paren
(brace
r_char
id|switches
(braket
id|len
op_plus
l_int|1
)braket
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_int
id|ovsc_shift
suffix:semicolon
multiline_comment|/* copy string to local array, strtok works destructively... */
id|strncpy
c_func
(paren
id|switches
comma
id|str
comma
id|len
)paren
suffix:semicolon
id|switches
(braket
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|atari_switches
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* parse the options */
r_for
c_loop
(paren
id|p
op_assign
id|strtok
c_func
(paren
id|switches
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|strtok
c_func
(paren
l_int|NULL
comma
l_string|&quot;,&quot;
)paren
)paren
(brace
id|ovsc_shift
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|p
comma
l_string|&quot;ov_&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
(brace
id|p
op_add_assign
l_int|3
suffix:semicolon
id|ovsc_shift
op_assign
id|ATARI_SWITCH_OVSC_SHIFT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|p
comma
l_string|&quot;ikbd&quot;
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* RTS line of IKBD ACIA */
id|atari_switches
op_or_assign
id|ATARI_SWITCH_IKBD
op_lshift
id|ovsc_shift
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|p
comma
l_string|&quot;midi&quot;
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* RTS line of MIDI ACIA */
id|atari_switches
op_or_assign
id|ATARI_SWITCH_MIDI
op_lshift
id|ovsc_shift
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|p
comma
l_string|&quot;snd6&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|atari_switches
op_or_assign
id|ATARI_SWITCH_SND6
op_lshift
id|ovsc_shift
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|p
comma
l_string|&quot;snd7&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|atari_switches
op_or_assign
id|ATARI_SWITCH_SND7
op_lshift
id|ovsc_shift
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n;     *  Setup the Atari configuration info&n;     */
DECL|function|config_atari
r_void
id|__init
id|config_atari
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|tos_version
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|atari_hw_present
comma
l_int|0
comma
r_sizeof
(paren
id|atari_hw_present
)paren
)paren
suffix:semicolon
id|atari_debug_init
c_func
(paren
)paren
suffix:semicolon
id|ioport_resource.end
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
multiline_comment|/* Change size of I/O space from 64KB&n;                                           to 4GB. */
id|mach_sched_init
op_assign
id|atari_sched_init
suffix:semicolon
id|mach_keyb_init
op_assign
id|atari_keyb_init
suffix:semicolon
id|mach_kbdrate
op_assign
id|atari_kbdrate
suffix:semicolon
id|mach_kbd_translate
op_assign
id|atari_kbd_translate
suffix:semicolon
id|SYSRQ_KEY
op_assign
l_int|0xff
suffix:semicolon
id|mach_kbd_leds
op_assign
id|atari_kbd_leds
suffix:semicolon
id|mach_init_IRQ
op_assign
id|atari_init_IRQ
suffix:semicolon
id|mach_request_irq
op_assign
id|atari_request_irq
suffix:semicolon
id|mach_free_irq
op_assign
id|atari_free_irq
suffix:semicolon
id|enable_irq
op_assign
id|atari_enable_irq
suffix:semicolon
id|disable_irq
op_assign
id|atari_disable_irq
suffix:semicolon
id|mach_get_model
op_assign
id|atari_get_model
suffix:semicolon
id|mach_get_hardware_list
op_assign
id|atari_get_hardware_list
suffix:semicolon
id|mach_get_irq_list
op_assign
id|atari_get_irq_list
suffix:semicolon
id|mach_gettimeoffset
op_assign
id|atari_gettimeoffset
suffix:semicolon
id|mach_reset
op_assign
id|atari_reset
suffix:semicolon
macro_line|#ifdef CONFIG_ATARI_FLOPPY
id|mach_floppy_setup
op_assign
id|atari_floppy_setup
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_DUMMY_CONSOLE
id|conswitchp
op_assign
op_amp
id|dummy_con
suffix:semicolon
macro_line|#endif
id|mach_max_dma_address
op_assign
l_int|0xffffff
suffix:semicolon
id|kd_mksound
op_assign
id|atari_mksound
suffix:semicolon
macro_line|#ifdef CONFIG_MAGIC_SYSRQ
id|mach_sysrq_key
op_assign
l_int|98
suffix:semicolon
multiline_comment|/* HELP */
id|mach_sysrq_shift_state
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* Alt */
id|mach_sysrq_shift_mask
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* all modifiers except CapsLock */
id|mach_sysrq_xlate
op_assign
id|atari_sysrq_xlate
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_HEARTBEAT
id|mach_heartbeat
op_assign
id|atari_heartbeat
suffix:semicolon
macro_line|#endif
multiline_comment|/* Set switches as requested by the user */
r_if
c_cond
(paren
id|atari_switches
op_amp
id|ATARI_SWITCH_IKBD
)paren
id|acia.key_ctrl
op_assign
id|ACIA_DIV64
op_or
id|ACIA_D8N1S
op_or
id|ACIA_RHTID
suffix:semicolon
r_if
c_cond
(paren
id|atari_switches
op_amp
id|ATARI_SWITCH_MIDI
)paren
id|acia.mid_ctrl
op_assign
id|ACIA_DIV16
op_or
id|ACIA_D8N1S
op_or
id|ACIA_RHTID
suffix:semicolon
r_if
c_cond
(paren
id|atari_switches
op_amp
(paren
id|ATARI_SWITCH_SND6
op_or
id|ATARI_SWITCH_SND7
)paren
)paren
(brace
id|sound_ym.rd_data_reg_sel
op_assign
l_int|14
suffix:semicolon
id|sound_ym.wd_data
op_assign
id|sound_ym.rd_data_reg_sel
op_or
(paren
(paren
id|atari_switches
op_amp
id|ATARI_SWITCH_SND6
)paren
ques
c_cond
l_int|0x40
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|atari_switches
op_amp
id|ATARI_SWITCH_SND7
)paren
ques
c_cond
l_int|0x80
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* ++bjoern: &n;     * Determine hardware present&n;     */
id|printk
c_func
(paren
l_string|&quot;Atari hardware found: &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|MACH_IS_MEDUSA
op_logical_or
id|MACH_IS_HADES
)paren
(brace
multiline_comment|/* There&squot;s no Atari video hardware on the Medusa, but all the&n;         * addresses below generate a DTACK so no bus error occurs! */
)brace
r_else
r_if
c_cond
(paren
id|hwreg_present
c_func
(paren
id|f030_xreg
)paren
)paren
(brace
id|ATARIHW_SET
c_func
(paren
id|VIDEL_SHIFTER
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;VIDEL &quot;
)paren
suffix:semicolon
multiline_comment|/* This is a temporary hack: If there is Falcon video&n;         * hardware, we assume that the ST-DMA serves SCSI instead of&n;         * ACSI. In the future, there should be a better method for&n;         * this...&n;         */
id|ATARIHW_SET
c_func
(paren
id|ST_SCSI
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;STDMA-SCSI &quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|hwreg_present
c_func
(paren
id|tt_palette
)paren
)paren
(brace
id|ATARIHW_SET
c_func
(paren
id|TT_SHIFTER
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TT_SHIFTER &quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|hwreg_present
c_func
(paren
op_amp
id|shifter.bas_hi
)paren
)paren
(brace
r_if
c_cond
(paren
id|hwreg_present
c_func
(paren
op_amp
id|shifter.bas_lo
)paren
op_logical_and
(paren
id|shifter.bas_lo
op_assign
l_int|0x0aau
comma
id|shifter.bas_lo
op_eq
l_int|0x0aau
)paren
)paren
(brace
id|ATARIHW_SET
c_func
(paren
id|EXTD_SHIFTER
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;EXTD_SHIFTER &quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|ATARIHW_SET
c_func
(paren
id|STND_SHIFTER
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;STND_SHIFTER &quot;
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|hwreg_present
c_func
(paren
op_amp
id|mfp.par_dt_reg
)paren
)paren
(brace
id|ATARIHW_SET
c_func
(paren
id|ST_MFP
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ST_MFP &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hwreg_present
c_func
(paren
op_amp
id|tt_mfp.par_dt_reg
)paren
)paren
(brace
id|ATARIHW_SET
c_func
(paren
id|TT_MFP
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TT_MFP &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hwreg_present
c_func
(paren
op_amp
id|tt_scsi_dma.dma_addr_hi
)paren
)paren
(brace
id|ATARIHW_SET
c_func
(paren
id|SCSI_DMA
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TT_SCSI_DMA &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|MACH_IS_HADES
op_logical_and
id|hwreg_present
c_func
(paren
op_amp
id|st_dma.dma_hi
)paren
)paren
(brace
id|ATARIHW_SET
c_func
(paren
id|STND_DMA
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;STND_DMA &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|MACH_IS_MEDUSA
op_logical_or
multiline_comment|/* The ST-DMA address registers aren&squot;t readable&n;&t;&t;&t;   * on all Medusas, so the test below may fail */
(paren
id|hwreg_present
c_func
(paren
op_amp
id|st_dma.dma_vhi
)paren
op_logical_and
(paren
id|st_dma.dma_vhi
op_assign
l_int|0x55
)paren
op_logical_and
(paren
id|st_dma.dma_hi
op_assign
l_int|0xaa
)paren
op_logical_and
id|st_dma.dma_vhi
op_eq
l_int|0x55
op_logical_and
id|st_dma.dma_hi
op_eq
l_int|0xaa
op_logical_and
(paren
id|st_dma.dma_vhi
op_assign
l_int|0xaa
)paren
op_logical_and
(paren
id|st_dma.dma_hi
op_assign
l_int|0x55
)paren
op_logical_and
id|st_dma.dma_vhi
op_eq
l_int|0xaa
op_logical_and
id|st_dma.dma_hi
op_eq
l_int|0x55
)paren
)paren
(brace
id|ATARIHW_SET
c_func
(paren
id|EXTD_DMA
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;EXTD_DMA &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hwreg_present
c_func
(paren
op_amp
id|tt_scsi.scsi_data
)paren
)paren
(brace
id|ATARIHW_SET
c_func
(paren
id|TT_SCSI
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TT_SCSI &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hwreg_present
c_func
(paren
op_amp
id|sound_ym.rd_data_reg_sel
)paren
)paren
(brace
id|ATARIHW_SET
c_func
(paren
id|YM_2149
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;YM2149 &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|MACH_IS_MEDUSA
op_logical_and
op_logical_neg
id|MACH_IS_HADES
op_logical_and
id|hwreg_present
c_func
(paren
op_amp
id|tt_dmasnd.ctrl
)paren
)paren
(brace
id|ATARIHW_SET
c_func
(paren
id|PCM_8BIT
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCM &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|MACH_IS_HADES
op_logical_and
id|hwreg_present
c_func
(paren
op_amp
id|codec.unused5
)paren
)paren
(brace
id|ATARIHW_SET
c_func
(paren
id|CODEC
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;CODEC &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hwreg_present
c_func
(paren
op_amp
id|dsp56k_host_interface.icr
)paren
)paren
(brace
id|ATARIHW_SET
c_func
(paren
id|DSP56K
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;DSP56K &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hwreg_present
c_func
(paren
op_amp
id|tt_scc_dma.dma_ctrl
)paren
op_logical_and
macro_line|#if 0
multiline_comment|/* This test sucks! Who knows some better? */
(paren
id|tt_scc_dma.dma_ctrl
op_assign
l_int|0x01
comma
(paren
id|tt_scc_dma.dma_ctrl
op_amp
l_int|1
)paren
op_eq
l_int|1
)paren
op_logical_and
(paren
id|tt_scc_dma.dma_ctrl
op_assign
l_int|0x00
comma
(paren
id|tt_scc_dma.dma_ctrl
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
macro_line|#else
op_logical_neg
id|MACH_IS_MEDUSA
op_logical_and
op_logical_neg
id|MACH_IS_HADES
macro_line|#endif
)paren
(brace
id|ATARIHW_SET
c_func
(paren
id|SCC_DMA
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCC_DMA &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scc_test
c_func
(paren
op_amp
id|scc.cha_a_ctrl
)paren
)paren
(brace
id|ATARIHW_SET
c_func
(paren
id|SCC
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCC &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scc_test
c_func
(paren
op_amp
id|st_escc.cha_b_ctrl
)paren
)paren
(brace
id|ATARIHW_SET
c_func
(paren
id|ST_ESCC
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ST_ESCC &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|MACH_IS_HADES
)paren
(brace
id|ATARIHW_SET
c_func
(paren
id|VME
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;VME &quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|hwreg_present
c_func
(paren
op_amp
id|tt_scu.sys_mask
)paren
)paren
(brace
id|ATARIHW_SET
c_func
(paren
id|SCU
)paren
suffix:semicolon
multiline_comment|/* Assume a VME bus if there&squot;s a SCU */
id|ATARIHW_SET
c_func
(paren
id|VME
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;VME SCU &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hwreg_present
c_func
(paren
(paren
r_void
op_star
)paren
(paren
l_int|0xffff9210
)paren
)paren
)paren
(brace
id|ATARIHW_SET
c_func
(paren
id|ANALOG_JOY
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ANALOG_JOY &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|MACH_IS_HADES
op_logical_and
id|hwreg_present
c_func
(paren
id|blitter.halftone
)paren
)paren
(brace
id|ATARIHW_SET
c_func
(paren
id|BLITTER
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;BLITTER &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hwreg_present
c_func
(paren
(paren
r_void
op_star
)paren
l_int|0xfff00039
)paren
)paren
(brace
id|ATARIHW_SET
c_func
(paren
id|IDE
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;IDE &quot;
)paren
suffix:semicolon
)brace
macro_line|#if 1 /* This maybe wrong */
r_if
c_cond
(paren
op_logical_neg
id|MACH_IS_MEDUSA
op_logical_and
op_logical_neg
id|MACH_IS_HADES
op_logical_and
id|hwreg_present
c_func
(paren
op_amp
id|tt_microwire.data
)paren
op_logical_and
id|hwreg_present
c_func
(paren
op_amp
id|tt_microwire.mask
)paren
op_logical_and
(paren
id|tt_microwire.mask
op_assign
l_int|0x7ff
comma
id|udelay
c_func
(paren
l_int|1
)paren
comma
id|tt_microwire.data
op_assign
id|MW_LM1992_PSG_HIGH
op_or
id|MW_LM1992_ADDR
comma
id|udelay
c_func
(paren
l_int|1
)paren
comma
id|tt_microwire.data
op_ne
l_int|0
)paren
)paren
(brace
id|ATARIHW_SET
c_func
(paren
id|MICROWIRE
)paren
suffix:semicolon
r_while
c_loop
(paren
id|tt_microwire.mask
op_ne
l_int|0x7ff
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;MICROWIRE &quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|hwreg_present
c_func
(paren
op_amp
id|tt_rtc.regsel
)paren
)paren
(brace
id|ATARIHW_SET
c_func
(paren
id|TT_CLK
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TT_CLK &quot;
)paren
suffix:semicolon
id|mach_gettod
op_assign
id|atari_tt_gettod
suffix:semicolon
id|mach_hwclk
op_assign
id|atari_tt_hwclk
suffix:semicolon
id|mach_set_clock_mmss
op_assign
id|atari_tt_set_clock_mmss
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|MACH_IS_HADES
op_logical_and
id|hwreg_present
c_func
(paren
op_amp
id|mste_rtc.sec_ones
)paren
)paren
(brace
id|ATARIHW_SET
c_func
(paren
id|MSTE_CLK
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;MSTE_CLK &quot;
)paren
suffix:semicolon
id|mach_gettod
op_assign
id|atari_mste_gettod
suffix:semicolon
id|mach_hwclk
op_assign
id|atari_mste_hwclk
suffix:semicolon
id|mach_set_clock_mmss
op_assign
id|atari_mste_set_clock_mmss
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|MACH_IS_MEDUSA
op_logical_and
op_logical_neg
id|MACH_IS_HADES
op_logical_and
id|hwreg_present
c_func
(paren
op_amp
id|dma_wd.fdc_speed
)paren
op_logical_and
id|hwreg_write
c_func
(paren
op_amp
id|dma_wd.fdc_speed
comma
l_int|0
)paren
)paren
(brace
id|ATARIHW_SET
c_func
(paren
id|FDCSPEED
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;FDC_SPEED &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|MACH_IS_HADES
op_logical_and
op_logical_neg
id|ATARIHW_PRESENT
c_func
(paren
id|ST_SCSI
)paren
)paren
(brace
id|ATARIHW_SET
c_func
(paren
id|ACSI
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ACSI &quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CPU_IS_040_OR_060
)paren
multiline_comment|/* Now it seems to be safe to turn of the tt0 transparent&n;         * translation (the one that must not be turned off in&n;         * head.S...)&n;         */
id|__asm__
r_volatile
(paren
l_string|&quot;moveq #0,%/d0&bslash;n&bslash;t&quot;
l_string|&quot;.chip 68040&bslash;n&bslash;t&quot;
l_string|&quot;movec %%d0,%%itt0&bslash;n&bslash;t&quot;
l_string|&quot;movec %%d0,%%dtt0&bslash;n&bslash;t&quot;
l_string|&quot;.chip 68k&quot;
suffix:colon
multiline_comment|/* no outputs */
suffix:colon
multiline_comment|/* no inputs */
suffix:colon
l_string|&quot;d0&quot;
)paren
suffix:semicolon
multiline_comment|/* allocator for memory that must reside in st-ram */
id|atari_stram_init
(paren
)paren
suffix:semicolon
multiline_comment|/* Set up a mapping for the VMEbus address region:&n;     *&n;     * VME is either at phys. 0xfexxxxxx (TT) or 0xa00000..0xdfffff&n;     * (MegaSTE) In both cases, the whole 16 MB chunk is mapped at&n;     * 0xfe000000 virt., because this can be done with a single&n;     * transparent translation. On the 68040, lots of often unused&n;     * page tables would be needed otherwise. On a MegaSTE or similar,&n;     * the highest byte is stripped off by hardware due to the 24 bit&n;     * design of the bus.&n;     */
r_if
c_cond
(paren
id|CPU_IS_020_OR_030
)paren
(brace
r_int
r_int
id|tt1_val
suffix:semicolon
id|tt1_val
op_assign
l_int|0xfe008543
suffix:semicolon
multiline_comment|/* Translate 0xfexxxxxx, enable, cache&n;                                 * inhibit, read and write, FDC mask = 3,&n;                                 * FDC val = 4 -&gt; Supervisor only */
id|__asm__
id|__volatile__
(paren
l_string|&quot;.chip 68030&bslash;n&bslash;t&quot;
l_string|&quot;pmove&t;%0@,%/tt1&bslash;n&bslash;t&quot;
l_string|&quot;.chip 68k&quot;
suffix:colon
suffix:colon
l_string|&quot;a&quot;
(paren
op_amp
id|tt1_val
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|__asm__
id|__volatile__
(paren
l_string|&quot;movel %0,%/d0&bslash;n&bslash;t&quot;
l_string|&quot;.chip 68040&bslash;n&bslash;t&quot;
l_string|&quot;movec %%d0,%%itt1&bslash;n&bslash;t&quot;
l_string|&quot;movec %%d0,%%dtt1&bslash;n&bslash;t&quot;
l_string|&quot;.chip 68k&quot;
suffix:colon
suffix:colon
l_string|&quot;g&quot;
(paren
l_int|0xfe00a040
)paren
multiline_comment|/* Translate 0xfexxxxxx, enable,&n;                                         * supervisor only, non-cacheable/&n;                                         * serialized, writable */
suffix:colon
l_string|&quot;d0&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Fetch tos version at Physical 2 */
multiline_comment|/* We my not be able to access this address if the kernel is&n;       loaded to st ram, since the first page is unmapped.  On the&n;       Medusa this is always the case and there is nothing we can do&n;       about this, so we just assume the smaller offset.  For the TT&n;       we use the fact that in head.S we have set up a mapping&n;       0xFFxxxxxx -&gt; 0x00xxxxxx, so that the first 16MB is accessible&n;       in the last 16MB of the address space. */
id|tos_version
op_assign
(paren
id|MACH_IS_MEDUSA
op_logical_or
id|MACH_IS_HADES
)paren
ques
c_cond
l_int|0xfff
suffix:colon
op_star
(paren
r_int
r_int
op_star
)paren
l_int|0xff000002
suffix:semicolon
id|atari_rtc_year_offset
op_assign
(paren
id|tos_version
OL
l_int|0x306
)paren
ques
c_cond
l_int|70
suffix:colon
l_int|68
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_HEARTBEAT
DECL|function|atari_heartbeat
r_static
r_void
id|atari_heartbeat
c_func
(paren
r_int
id|on
)paren
(brace
r_int
r_char
id|tmp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|atari_dont_touch_floppy_select
)paren
r_return
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|sound_ym.rd_data_reg_sel
op_assign
l_int|14
suffix:semicolon
multiline_comment|/* Select PSG Port A */
id|tmp
op_assign
id|sound_ym.rd_data_reg_sel
suffix:semicolon
id|sound_ym.wd_data
op_assign
id|on
ques
c_cond
(paren
id|tmp
op_amp
op_complement
l_int|0x02
)paren
suffix:colon
(paren
id|tmp
op_or
l_int|0x02
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* ++roman:&n; *&n; * This function does a reset on machines that lack the ability to&n; * assert the processor&squot;s _RESET signal somehow via hardware. It is&n; * based on the fact that you can find the initial SP and PC values&n; * after a reset at physical addresses 0 and 4. This works pretty well&n; * for Atari machines, since the lowest 8 bytes of physical memory are&n; * really ROM (mapped by hardware). For other 680x0 machines: don&squot;t&n; * know if it works...&n; *&n; * To get the values at addresses 0 and 4, the MMU better is turned&n; * off first. After that, we have to jump into physical address space&n; * (the PC before the pmove statement points to the virtual address of&n; * the code). Getting that physical address is not hard, but the code&n; * becomes a bit complex since I&squot;ve tried to ensure that the jump&n; * statement after the pmove is in the cache already (otherwise the&n; * processor can&squot;t fetch it!). For that, the code first jumps to the&n; * jump statement with the (virtual) address of the pmove section in&n; * an address register . The jump statement is surely in the cache&n; * now. After that, that physical address of the reset code is loaded&n; * into the same address register, pmove is done and the same jump&n; * statements goes to the reset code. Since there are not many&n; * statements between the two jumps, I hope it stays in the cache.&n; *&n; * The C code makes heavy use of the GCC features that you can get the&n; * address of a C label. No hope to compile this with another compiler&n; * than GCC!&n; */
multiline_comment|/* ++andreas: no need for complicated code, just depend on prefetch */
DECL|function|atari_reset
r_static
r_void
id|atari_reset
(paren
r_void
)paren
(brace
r_int
id|tc_val
op_assign
l_int|0
suffix:semicolon
r_int
id|reset_addr
suffix:semicolon
multiline_comment|/* On the Medusa, phys. 0x4 may contain garbage because it&squot;s no&n;       ROM.  See above for explanation why we cannot use PTOV(4). */
id|reset_addr
op_assign
id|MACH_IS_HADES
ques
c_cond
l_int|0x7fe00030
suffix:colon
id|MACH_IS_MEDUSA
op_logical_or
id|MACH_IS_AB40
ques
c_cond
l_int|0xe00030
suffix:colon
op_star
(paren
r_int
r_int
op_star
)paren
l_int|0xff000004
suffix:semicolon
multiline_comment|/* reset ACIA for switch off OverScan, if it&squot;s active */
r_if
c_cond
(paren
id|atari_switches
op_amp
id|ATARI_SWITCH_OVSC_IKBD
)paren
id|acia.key_ctrl
op_assign
id|ACIA_RESET
suffix:semicolon
r_if
c_cond
(paren
id|atari_switches
op_amp
id|ATARI_SWITCH_OVSC_MIDI
)paren
id|acia.mid_ctrl
op_assign
id|ACIA_RESET
suffix:semicolon
multiline_comment|/* processor independent: turn off interrupts and reset the VBR;&n;     * the caches must be left enabled, else prefetching the final jump&n;     * instruction doesn&squot;t work. */
id|cli
c_func
(paren
)paren
suffix:semicolon
id|__asm__
id|__volatile__
(paren
l_string|&quot;moveq&t;#0,%/d0&bslash;n&bslash;t&quot;
l_string|&quot;movec&t;%/d0,%/vbr&quot;
suffix:colon
suffix:colon
suffix:colon
l_string|&quot;d0&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CPU_IS_040_OR_060
)paren
(brace
r_int
r_int
id|jmp_addr040
op_assign
id|virt_to_phys
c_func
(paren
op_logical_and
id|jmp_addr_label040
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CPU_IS_060
)paren
(brace
multiline_comment|/* 68060: clear PCR to turn off superscalar operation */
id|__asm__
id|__volatile__
(paren
l_string|&quot;moveq&t;#0,%/d0&bslash;n&bslash;t&quot;
l_string|&quot;.chip 68060&bslash;n&bslash;t&quot;
l_string|&quot;movec %%d0,%%pcr&bslash;n&bslash;t&quot;
l_string|&quot;.chip 68k&quot;
suffix:colon
suffix:colon
suffix:colon
l_string|&quot;d0&quot;
)paren
suffix:semicolon
)brace
id|__asm__
id|__volatile__
(paren
l_string|&quot;movel    %0,%/d0&bslash;n&bslash;t&quot;
l_string|&quot;andl     #0xff000000,%/d0&bslash;n&bslash;t&quot;
l_string|&quot;orw      #0xe020,%/d0&bslash;n&bslash;t&quot;
multiline_comment|/* map 16 MB, enable, cacheable */
l_string|&quot;.chip 68040&bslash;n&bslash;t&quot;
l_string|&quot;movec    %%d0,%%itt0&bslash;n&bslash;t&quot;
l_string|&quot;movec    %%d0,%%dtt0&bslash;n&bslash;t&quot;
l_string|&quot;.chip 68k&bslash;n&bslash;t&quot;
l_string|&quot;jmp   %0@&bslash;n&bslash;t&quot;
suffix:colon
multiline_comment|/* no outputs */
suffix:colon
l_string|&quot;a&quot;
(paren
id|jmp_addr040
)paren
suffix:colon
l_string|&quot;d0&quot;
)paren
suffix:semicolon
id|jmp_addr_label040
suffix:colon
id|__asm__
id|__volatile__
(paren
l_string|&quot;moveq #0,%/d0&bslash;n&bslash;t&quot;
l_string|&quot;nop&bslash;n&bslash;t&quot;
l_string|&quot;.chip 68040&bslash;n&bslash;t&quot;
l_string|&quot;cinva %%bc&bslash;n&bslash;t&quot;
l_string|&quot;nop&bslash;n&bslash;t&quot;
l_string|&quot;pflusha&bslash;n&bslash;t&quot;
l_string|&quot;nop&bslash;n&bslash;t&quot;
l_string|&quot;movec %%d0,%%tc&bslash;n&bslash;t&quot;
l_string|&quot;nop&bslash;n&bslash;t&quot;
multiline_comment|/* the following setup of transparent translations is needed on the&n;&t;    * Afterburner040 to successfully reboot. Other machines shouldn&squot;t&n;&t;    * care about a different tt regs setup, they also didn&squot;t care in&n;&t;    * the past that the regs weren&squot;t turned off. */
l_string|&quot;movel #0xffc000,%%d0&bslash;n&bslash;t&quot;
multiline_comment|/* whole insn space cacheable */
l_string|&quot;movec %%d0,%%itt0&bslash;n&bslash;t&quot;
l_string|&quot;movec %%d0,%%itt1&bslash;n&bslash;t&quot;
l_string|&quot;orw   #0x40,%/d0&bslash;n&bslash;t&quot;
multiline_comment|/* whole data space non-cacheable/ser. */
l_string|&quot;movec %%d0,%%dtt0&bslash;n&bslash;t&quot;
l_string|&quot;movec %%d0,%%dtt1&bslash;n&bslash;t&quot;
l_string|&quot;.chip 68k&bslash;n&bslash;t&quot;
l_string|&quot;jmp %0@&quot;
suffix:colon
multiline_comment|/* no outputs */
suffix:colon
l_string|&quot;a&quot;
(paren
id|reset_addr
)paren
suffix:colon
l_string|&quot;d0&quot;
)paren
suffix:semicolon
)brace
r_else
id|__asm__
id|__volatile__
(paren
l_string|&quot;pmove %0@,%/tc&bslash;n&bslash;t&quot;
l_string|&quot;jmp %1@&quot;
suffix:colon
multiline_comment|/* no outputs */
suffix:colon
l_string|&quot;a&quot;
(paren
op_amp
id|tc_val
)paren
comma
l_string|&quot;a&quot;
(paren
id|reset_addr
)paren
)paren
suffix:semicolon
)brace
DECL|function|atari_get_model
r_static
r_void
id|atari_get_model
c_func
(paren
r_char
op_star
id|model
)paren
(brace
id|strcpy
c_func
(paren
id|model
comma
l_string|&quot;Atari &quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|atari_mch_cookie
op_rshift
l_int|16
)paren
(brace
r_case
id|ATARI_MCH_ST
suffix:colon
r_if
c_cond
(paren
id|ATARIHW_PRESENT
c_func
(paren
id|MSTE_CLK
)paren
)paren
id|strcat
(paren
id|model
comma
l_string|&quot;Mega ST&quot;
)paren
suffix:semicolon
r_else
id|strcat
(paren
id|model
comma
l_string|&quot;ST&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ATARI_MCH_STE
suffix:colon
r_if
c_cond
(paren
id|MACH_IS_MSTE
)paren
id|strcat
(paren
id|model
comma
l_string|&quot;Mega STE&quot;
)paren
suffix:semicolon
r_else
id|strcat
(paren
id|model
comma
l_string|&quot;STE&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ATARI_MCH_TT
suffix:colon
r_if
c_cond
(paren
id|MACH_IS_MEDUSA
)paren
multiline_comment|/* Medusa has TT _MCH cookie */
id|strcat
(paren
id|model
comma
l_string|&quot;Medusa&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|MACH_IS_HADES
)paren
id|strcat
c_func
(paren
id|model
comma
l_string|&quot;Hades&quot;
)paren
suffix:semicolon
r_else
id|strcat
(paren
id|model
comma
l_string|&quot;TT&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ATARI_MCH_FALCON
suffix:colon
id|strcat
(paren
id|model
comma
l_string|&quot;Falcon&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|MACH_IS_AB40
)paren
id|strcat
(paren
id|model
comma
l_string|&quot; (with Afterburner040)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|sprintf
(paren
id|model
op_plus
id|strlen
(paren
id|model
)paren
comma
l_string|&quot;(unknown mach cookie 0x%lx)&quot;
comma
id|atari_mch_cookie
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|atari_get_hardware_list
r_static
r_int
id|atari_get_hardware_list
c_func
(paren
r_char
op_star
id|buffer
)paren
(brace
r_int
id|len
op_assign
l_int|0
comma
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|m68k_num_memory
suffix:semicolon
id|i
op_increment
)paren
id|len
op_add_assign
id|sprintf
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;&bslash;t%3ld MB at 0x%08lx (%s)&bslash;n&quot;
comma
id|m68k_memory
(braket
id|i
)braket
dot
id|size
op_rshift
l_int|20
comma
id|m68k_memory
(braket
id|i
)braket
dot
id|addr
comma
(paren
id|m68k_memory
(braket
id|i
)braket
dot
id|addr
op_amp
l_int|0xff000000
ques
c_cond
l_string|&quot;alternate RAM&quot;
suffix:colon
l_string|&quot;ST-RAM&quot;
)paren
)paren
suffix:semicolon
DECL|macro|ATARIHW_ANNOUNCE
mdefine_line|#define ATARIHW_ANNOUNCE(name,str)&t;&t;&t;&t;&bslash;&n;    if (ATARIHW_PRESENT(name))&t;&t;&t;&bslash;&n;&t;len += sprintf (buffer + len, &quot;&bslash;t%s&bslash;n&quot;, str)
id|len
op_add_assign
id|sprintf
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;Detected hardware:&bslash;n&quot;
)paren
suffix:semicolon
id|ATARIHW_ANNOUNCE
c_func
(paren
id|STND_SHIFTER
comma
l_string|&quot;ST Shifter&quot;
)paren
suffix:semicolon
id|ATARIHW_ANNOUNCE
c_func
(paren
id|EXTD_SHIFTER
comma
l_string|&quot;STe Shifter&quot;
)paren
suffix:semicolon
id|ATARIHW_ANNOUNCE
c_func
(paren
id|TT_SHIFTER
comma
l_string|&quot;TT Shifter&quot;
)paren
suffix:semicolon
id|ATARIHW_ANNOUNCE
c_func
(paren
id|VIDEL_SHIFTER
comma
l_string|&quot;Falcon Shifter&quot;
)paren
suffix:semicolon
id|ATARIHW_ANNOUNCE
c_func
(paren
id|YM_2149
comma
l_string|&quot;Programmable Sound Generator&quot;
)paren
suffix:semicolon
id|ATARIHW_ANNOUNCE
c_func
(paren
id|PCM_8BIT
comma
l_string|&quot;PCM 8 Bit Sound&quot;
)paren
suffix:semicolon
id|ATARIHW_ANNOUNCE
c_func
(paren
id|CODEC
comma
l_string|&quot;CODEC Sound&quot;
)paren
suffix:semicolon
id|ATARIHW_ANNOUNCE
c_func
(paren
id|TT_SCSI
comma
l_string|&quot;SCSI Controller NCR5380 (TT style)&quot;
)paren
suffix:semicolon
id|ATARIHW_ANNOUNCE
c_func
(paren
id|ST_SCSI
comma
l_string|&quot;SCSI Controller NCR5380 (Falcon style)&quot;
)paren
suffix:semicolon
id|ATARIHW_ANNOUNCE
c_func
(paren
id|ACSI
comma
l_string|&quot;ACSI Interface&quot;
)paren
suffix:semicolon
id|ATARIHW_ANNOUNCE
c_func
(paren
id|IDE
comma
l_string|&quot;IDE Interface&quot;
)paren
suffix:semicolon
id|ATARIHW_ANNOUNCE
c_func
(paren
id|FDCSPEED
comma
l_string|&quot;8/16 Mhz Switch for FDC&quot;
)paren
suffix:semicolon
id|ATARIHW_ANNOUNCE
c_func
(paren
id|ST_MFP
comma
l_string|&quot;Multi Function Peripheral MFP 68901&quot;
)paren
suffix:semicolon
id|ATARIHW_ANNOUNCE
c_func
(paren
id|TT_MFP
comma
l_string|&quot;Second Multi Function Peripheral MFP 68901&quot;
)paren
suffix:semicolon
id|ATARIHW_ANNOUNCE
c_func
(paren
id|SCC
comma
l_string|&quot;Serial Communications Controller SCC 8530&quot;
)paren
suffix:semicolon
id|ATARIHW_ANNOUNCE
c_func
(paren
id|ST_ESCC
comma
l_string|&quot;Extended Serial Communications Controller SCC 85230&quot;
)paren
suffix:semicolon
id|ATARIHW_ANNOUNCE
c_func
(paren
id|ANALOG_JOY
comma
l_string|&quot;Paddle Interface&quot;
)paren
suffix:semicolon
id|ATARIHW_ANNOUNCE
c_func
(paren
id|MICROWIRE
comma
l_string|&quot;MICROWIRE(tm) Interface&quot;
)paren
suffix:semicolon
id|ATARIHW_ANNOUNCE
c_func
(paren
id|STND_DMA
comma
l_string|&quot;DMA Controller (24 bit)&quot;
)paren
suffix:semicolon
id|ATARIHW_ANNOUNCE
c_func
(paren
id|EXTD_DMA
comma
l_string|&quot;DMA Controller (32 bit)&quot;
)paren
suffix:semicolon
id|ATARIHW_ANNOUNCE
c_func
(paren
id|SCSI_DMA
comma
l_string|&quot;DMA Controller for NCR5380&quot;
)paren
suffix:semicolon
id|ATARIHW_ANNOUNCE
c_func
(paren
id|SCC_DMA
comma
l_string|&quot;DMA Controller for SCC&quot;
)paren
suffix:semicolon
id|ATARIHW_ANNOUNCE
c_func
(paren
id|TT_CLK
comma
l_string|&quot;Clock Chip MC146818A&quot;
)paren
suffix:semicolon
id|ATARIHW_ANNOUNCE
c_func
(paren
id|MSTE_CLK
comma
l_string|&quot;Clock Chip RP5C15&quot;
)paren
suffix:semicolon
id|ATARIHW_ANNOUNCE
c_func
(paren
id|SCU
comma
l_string|&quot;System Control Unit&quot;
)paren
suffix:semicolon
id|ATARIHW_ANNOUNCE
c_func
(paren
id|BLITTER
comma
l_string|&quot;Blitter&quot;
)paren
suffix:semicolon
id|ATARIHW_ANNOUNCE
c_func
(paren
id|VME
comma
l_string|&quot;VME Bus&quot;
)paren
suffix:semicolon
id|ATARIHW_ANNOUNCE
c_func
(paren
id|DSP56K
comma
l_string|&quot;DSP56001 processor&quot;
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; * Local variables:&n; *  c-indent-level: 4&n; *  tab-width: 8&n; * End:&n; */
eof
