multiline_comment|/*&n; * linux/atari/atapart.c&n; *&n; * Atari partition checking driver for 680x0 Linux&n; * Written by Andreas Schwab (schwab@ls5.informatik.uni-dortmund.de)&n; *&n; * 5/3/94 Roman Hodek:&n; *   Added some sanity checks&n; *   Linux device names start from 1 not 0, so I changed the initial value&n; *   for i to 1.&n; *&n; * 10/09/94 Guenther Kelleter:&n; *   Added support for ICD/Supra partition info.&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file README.legal in the main directory of this archive&n; * for more details.&n; */
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/genhd.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;asm/atari_rootsec.h&gt;
multiline_comment|/* ++guenther: this should be settable by the user (&quot;make config&quot;)?.&n; */
DECL|macro|ICD_PARTS
mdefine_line|#define ICD_PARTS
r_extern
r_int
id|current_minor
suffix:semicolon
r_void
DECL|function|atari_check_partition
id|atari_check_partition
(paren
r_struct
id|gendisk
op_star
id|hd
comma
r_int
r_int
id|dev
)paren
(brace
r_int
id|i
comma
id|minor
op_assign
id|current_minor
comma
id|m_lim
op_assign
id|current_minor
op_plus
id|hd-&gt;max_p
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_struct
id|rootsector
op_star
id|rs
suffix:semicolon
r_struct
id|partition_info
op_star
id|pi
suffix:semicolon
id|ulong
id|extensect
suffix:semicolon
macro_line|#ifdef ICD_PARTS
r_int
id|part_fmt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 0:unknown, 1:AHDI, 2:ICD/Supra */
macro_line|#endif
id|bh
op_assign
id|bread
(paren
id|dev
comma
l_int|0
comma
l_int|1024
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bh
)paren
(brace
id|printk
(paren
l_string|&quot; unable to read block 0&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|rs
op_assign
(paren
r_struct
id|rootsector
op_star
)paren
id|bh-&gt;b_data
suffix:semicolon
id|printk
(paren
l_string|&quot;  %s%c:&quot;
comma
id|hd-&gt;major_name
comma
l_char|&squot;a&squot;
op_plus
(paren
id|minor
op_rshift
id|hd-&gt;minor_shift
)paren
)paren
suffix:semicolon
id|pi
op_assign
op_amp
id|rs-&gt;part
(braket
l_int|0
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|pi
OL
op_amp
id|rs-&gt;part
(braket
l_int|4
)braket
op_logical_and
id|minor
OL
id|m_lim
suffix:semicolon
id|i
op_increment
comma
id|minor
op_increment
comma
id|pi
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pi-&gt;flg
op_amp
l_int|1
)paren
multiline_comment|/* active partition */
(brace
r_if
c_cond
(paren
id|memcmp
(paren
id|pi-&gt;id
comma
l_string|&quot;XGM&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
multiline_comment|/* extension partition */
(brace
r_struct
id|rootsector
op_star
id|xrs
suffix:semicolon
r_struct
id|buffer_head
op_star
id|xbh
suffix:semicolon
id|ulong
id|partsect
suffix:semicolon
macro_line|#ifdef ICD_PARTS
id|part_fmt
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|partsect
op_assign
id|extensect
op_assign
id|pi-&gt;st
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|xbh
op_assign
id|bread
(paren
id|dev
comma
id|partsect
op_div
l_int|2
comma
l_int|1024
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|xbh
)paren
(brace
id|printk
(paren
l_string|&quot; block %ld read failed&bslash;n&quot;
comma
id|partsect
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|partsect
op_amp
l_int|1
)paren
id|xrs
op_assign
(paren
r_struct
id|rootsector
op_star
)paren
op_amp
id|xbh-&gt;b_data
(braket
l_int|512
)braket
suffix:semicolon
r_else
id|xrs
op_assign
(paren
r_struct
id|rootsector
op_star
)paren
op_amp
id|xbh-&gt;b_data
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* ++roman: sanity check: bit 0 of flg field must be set */
r_if
c_cond
(paren
op_logical_neg
(paren
id|xrs-&gt;part
(braket
l_int|0
)braket
dot
id|flg
op_amp
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;nFirst sub-partition in extended partition is not valid!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|hd-&gt;part
(braket
id|minor
)braket
dot
id|start_sect
op_assign
id|partsect
op_plus
id|xrs-&gt;part
(braket
l_int|0
)braket
dot
id|st
suffix:semicolon
id|hd-&gt;part
(braket
id|minor
)braket
dot
id|nr_sects
op_assign
id|xrs-&gt;part
(braket
l_int|0
)braket
dot
id|siz
suffix:semicolon
id|printk
(paren
l_string|&quot; %s%c%d&quot;
comma
id|hd-&gt;major_name
comma
l_char|&squot;a&squot;
op_plus
(paren
id|minor
op_rshift
id|hd-&gt;minor_shift
)paren
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|xrs-&gt;part
(braket
l_int|1
)braket
dot
id|flg
op_amp
l_int|1
)paren
)paren
(brace
multiline_comment|/* end of linked partition list */
id|brelse
c_func
(paren
id|xbh
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|xrs-&gt;part
(braket
l_int|1
)braket
dot
id|id
comma
l_string|&quot;XGM&quot;
comma
l_int|3
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;nID of extended partition is not XGM!&bslash;n&quot;
)paren
suffix:semicolon
id|brelse
c_func
(paren
id|xbh
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|partsect
op_assign
id|xrs-&gt;part
(braket
l_int|1
)braket
dot
id|st
op_plus
id|extensect
suffix:semicolon
id|brelse
(paren
id|xbh
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
id|minor
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|minor
op_ge
id|m_lim
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;nMaximum number of partitions reached!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* we don&squot;t care about other id&squot;s */
id|hd-&gt;part
(braket
id|minor
)braket
dot
id|start_sect
op_assign
id|pi-&gt;st
suffix:semicolon
id|hd-&gt;part
(braket
id|minor
)braket
dot
id|nr_sects
op_assign
id|pi-&gt;siz
suffix:semicolon
id|printk
(paren
l_string|&quot; %s%c%d&quot;
comma
id|hd-&gt;major_name
comma
l_char|&squot;a&squot;
op_plus
(paren
id|minor
op_rshift
id|hd-&gt;minor_shift
)paren
comma
id|i
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#ifdef ICD_PARTS
r_if
c_cond
(paren
id|part_fmt
op_ne
l_int|1
)paren
multiline_comment|/* no extended partitions -&gt; test ICD-format */
(brace
id|pi
op_assign
op_amp
id|rs-&gt;icdpart
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* sanity check: no ICD format if first partition invalid */
r_if
c_cond
(paren
id|memcmp
(paren
id|pi-&gt;id
comma
l_string|&quot;GEM&quot;
comma
l_int|3
)paren
op_eq
l_int|0
op_logical_or
id|memcmp
(paren
id|pi-&gt;id
comma
l_string|&quot;BGM&quot;
comma
l_int|3
)paren
op_eq
l_int|0
op_logical_or
id|memcmp
(paren
id|pi-&gt;id
comma
l_string|&quot;RAW&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|pi
OL
op_amp
id|rs-&gt;icdpart
(braket
l_int|8
)braket
op_logical_and
id|minor
OL
id|m_lim
suffix:semicolon
id|i
op_increment
comma
id|minor
op_increment
comma
id|pi
op_increment
)paren
(brace
multiline_comment|/* accept only GEM,BGM,RAW partitions */
r_if
c_cond
(paren
id|pi-&gt;flg
op_amp
l_int|1
op_logical_and
(paren
id|memcmp
(paren
id|pi-&gt;id
comma
l_string|&quot;GEM&quot;
comma
l_int|3
)paren
op_eq
l_int|0
op_logical_or
id|memcmp
(paren
id|pi-&gt;id
comma
l_string|&quot;BGM&quot;
comma
l_int|3
)paren
op_eq
l_int|0
op_logical_or
id|memcmp
(paren
id|pi-&gt;id
comma
l_string|&quot;RAW&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
)paren
(brace
id|part_fmt
op_assign
l_int|2
suffix:semicolon
id|hd-&gt;part
(braket
id|minor
)braket
dot
id|start_sect
op_assign
id|pi-&gt;st
suffix:semicolon
id|hd-&gt;part
(braket
id|minor
)braket
dot
id|nr_sects
op_assign
id|pi-&gt;siz
suffix:semicolon
id|printk
(paren
l_string|&quot; %s%c%d&quot;
comma
id|hd-&gt;major_name
comma
l_char|&squot;a&squot;
op_plus
(paren
id|minor
op_rshift
id|hd-&gt;minor_shift
)paren
comma
id|i
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
macro_line|#endif
id|brelse
(paren
id|bh
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
eof
