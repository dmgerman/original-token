multiline_comment|/*&n; * linux/arch/m68k/atari/time.c&n; *&n; * Atari time and real time clock stuff&n; *&n; * Assembled of parts of former atari/config.c 97-12-18 by Roman Hodek&n; *  &n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file COPYING in the main directory of this archive&n; * for more details.&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/mc146818rtc.h&gt;
macro_line|#include &lt;linux/kd.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/init.h&gt;
r_void
id|__init
DECL|function|atari_sched_init
id|atari_sched_init
c_func
(paren
r_void
(paren
op_star
id|timer_routine
)paren
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
)paren
(brace
multiline_comment|/* set Timer C data Register */
id|mfp.tim_dt_c
op_assign
id|INT_TICKS
suffix:semicolon
multiline_comment|/* start timer C, div = 1:100 */
id|mfp.tim_ct_cd
op_assign
(paren
id|mfp.tim_ct_cd
op_amp
l_int|15
)paren
op_or
l_int|0x60
suffix:semicolon
multiline_comment|/* install interrupt service routine for MFP Timer C */
id|request_irq
c_func
(paren
id|IRQ_MFP_TIMC
comma
id|timer_routine
comma
id|IRQ_TYPE_SLOW
comma
l_string|&quot;timer&quot;
comma
id|timer_routine
)paren
suffix:semicolon
)brace
multiline_comment|/* ++andreas: gettimeoffset fixed to check for pending interrupt */
DECL|macro|TICK_SIZE
mdefine_line|#define TICK_SIZE 10000
multiline_comment|/* This is always executed with interrupts disabled.  */
DECL|function|atari_gettimeoffset
r_int
r_int
id|atari_gettimeoffset
(paren
r_void
)paren
(brace
r_int
r_int
id|ticks
comma
id|offset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* read MFP timer C current value */
id|ticks
op_assign
id|mfp.tim_dt_c
suffix:semicolon
multiline_comment|/* The probability of underflow is less than 2% */
r_if
c_cond
(paren
id|ticks
OG
id|INT_TICKS
op_minus
id|INT_TICKS
op_div
l_int|50
)paren
multiline_comment|/* Check for pending timer interrupt */
r_if
c_cond
(paren
id|mfp.int_pn_b
op_amp
(paren
l_int|1
op_lshift
l_int|5
)paren
)paren
id|offset
op_assign
id|TICK_SIZE
suffix:semicolon
id|ticks
op_assign
id|INT_TICKS
op_minus
id|ticks
suffix:semicolon
id|ticks
op_assign
id|ticks
op_star
l_int|10000L
op_div
id|INT_TICKS
suffix:semicolon
r_return
id|ticks
op_plus
id|offset
suffix:semicolon
)brace
DECL|function|mste_read
r_static
r_void
id|mste_read
c_func
(paren
r_struct
id|MSTE_RTC
op_star
id|val
)paren
(brace
DECL|macro|COPY
mdefine_line|#define COPY(v) val-&gt;v=(mste_rtc.v &amp; 0xf)
r_do
(brace
id|COPY
c_func
(paren
id|sec_ones
)paren
suffix:semicolon
id|COPY
c_func
(paren
id|sec_tens
)paren
suffix:semicolon
id|COPY
c_func
(paren
id|min_ones
)paren
suffix:semicolon
id|COPY
c_func
(paren
id|min_tens
)paren
suffix:semicolon
id|COPY
c_func
(paren
id|hr_ones
)paren
suffix:semicolon
id|COPY
c_func
(paren
id|hr_tens
)paren
suffix:semicolon
id|COPY
c_func
(paren
id|weekday
)paren
suffix:semicolon
id|COPY
c_func
(paren
id|day_ones
)paren
suffix:semicolon
id|COPY
c_func
(paren
id|day_tens
)paren
suffix:semicolon
id|COPY
c_func
(paren
id|mon_ones
)paren
suffix:semicolon
id|COPY
c_func
(paren
id|mon_tens
)paren
suffix:semicolon
id|COPY
c_func
(paren
id|year_ones
)paren
suffix:semicolon
id|COPY
c_func
(paren
id|year_tens
)paren
suffix:semicolon
multiline_comment|/* prevent from reading the clock while it changed */
)brace
r_while
c_loop
(paren
id|val-&gt;sec_ones
op_ne
(paren
id|mste_rtc.sec_ones
op_amp
l_int|0xf
)paren
)paren
suffix:semicolon
DECL|macro|COPY
macro_line|#undef COPY
)brace
DECL|function|mste_write
r_static
r_void
id|mste_write
c_func
(paren
r_struct
id|MSTE_RTC
op_star
id|val
)paren
(brace
DECL|macro|COPY
mdefine_line|#define COPY(v) mste_rtc.v=val-&gt;v
r_do
(brace
id|COPY
c_func
(paren
id|sec_ones
)paren
suffix:semicolon
id|COPY
c_func
(paren
id|sec_tens
)paren
suffix:semicolon
id|COPY
c_func
(paren
id|min_ones
)paren
suffix:semicolon
id|COPY
c_func
(paren
id|min_tens
)paren
suffix:semicolon
id|COPY
c_func
(paren
id|hr_ones
)paren
suffix:semicolon
id|COPY
c_func
(paren
id|hr_tens
)paren
suffix:semicolon
id|COPY
c_func
(paren
id|weekday
)paren
suffix:semicolon
id|COPY
c_func
(paren
id|day_ones
)paren
suffix:semicolon
id|COPY
c_func
(paren
id|day_tens
)paren
suffix:semicolon
id|COPY
c_func
(paren
id|mon_ones
)paren
suffix:semicolon
id|COPY
c_func
(paren
id|mon_tens
)paren
suffix:semicolon
id|COPY
c_func
(paren
id|year_ones
)paren
suffix:semicolon
id|COPY
c_func
(paren
id|year_tens
)paren
suffix:semicolon
multiline_comment|/* prevent from writing the clock while it changed */
)brace
r_while
c_loop
(paren
id|val-&gt;sec_ones
op_ne
(paren
id|mste_rtc.sec_ones
op_amp
l_int|0xf
)paren
)paren
suffix:semicolon
DECL|macro|COPY
macro_line|#undef COPY
)brace
DECL|macro|RTC_READ
mdefine_line|#define&t;RTC_READ(reg)&t;&t;&t;&t;&bslash;&n;    ({&t;unsigned char&t;__val;&t;&t;&t;&bslash;&n;&t;&t;(void) writeb(reg,&amp;tt_rtc.regsel);&t;&bslash;&n;&t;&t;__val = tt_rtc.data;&t;&t;&bslash;&n;&t;&t;__val;&t;&t;&t;&t;&bslash;&n;&t;})
DECL|macro|RTC_WRITE
mdefine_line|#define&t;RTC_WRITE(reg,val)&t;&t;&t;&bslash;&n;    do {&t;&t;&t;&t;&t;&bslash;&n;&t;&t;writeb(reg,&amp;tt_rtc.regsel);&t;&bslash;&n;&t;&t;tt_rtc.data = (val);&t;&t;&bslash;&n;&t;} while(0)
DECL|function|atari_mste_gettod
r_void
id|atari_mste_gettod
(paren
r_int
op_star
id|yearp
comma
r_int
op_star
id|monp
comma
r_int
op_star
id|dayp
comma
r_int
op_star
id|hourp
comma
r_int
op_star
id|minp
comma
r_int
op_star
id|secp
)paren
(brace
r_int
id|hr24
op_assign
l_int|0
comma
id|hour
suffix:semicolon
r_struct
id|MSTE_RTC
id|val
suffix:semicolon
id|mste_rtc.mode
op_assign
(paren
id|mste_rtc.mode
op_or
l_int|1
)paren
suffix:semicolon
id|hr24
op_assign
id|mste_rtc.mon_tens
op_amp
l_int|1
suffix:semicolon
id|mste_rtc.mode
op_assign
(paren
id|mste_rtc.mode
op_amp
op_complement
l_int|1
)paren
suffix:semicolon
id|mste_read
c_func
(paren
op_amp
id|val
)paren
suffix:semicolon
op_star
id|secp
op_assign
id|val.sec_ones
op_plus
id|val.sec_tens
op_star
l_int|10
suffix:semicolon
op_star
id|minp
op_assign
id|val.min_ones
op_plus
id|val.min_tens
op_star
l_int|10
suffix:semicolon
id|hour
op_assign
id|val.hr_ones
op_plus
id|val.hr_tens
op_star
l_int|10
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hr24
)paren
(brace
r_if
c_cond
(paren
id|hour
op_eq
l_int|12
op_logical_or
id|hour
op_eq
l_int|12
op_plus
l_int|20
)paren
id|hour
op_sub_assign
l_int|12
suffix:semicolon
r_if
c_cond
(paren
id|hour
op_ge
l_int|20
)paren
id|hour
op_add_assign
l_int|12
op_minus
l_int|20
suffix:semicolon
)brace
op_star
id|hourp
op_assign
id|hour
suffix:semicolon
op_star
id|dayp
op_assign
id|val.day_ones
op_plus
id|val.day_tens
op_star
l_int|10
suffix:semicolon
op_star
id|monp
op_assign
id|val.mon_ones
op_plus
id|val.mon_tens
op_star
l_int|10
suffix:semicolon
op_star
id|yearp
op_assign
id|val.year_ones
op_plus
id|val.year_tens
op_star
l_int|10
op_plus
l_int|80
suffix:semicolon
)brace
DECL|function|atari_tt_gettod
r_void
id|atari_tt_gettod
(paren
r_int
op_star
id|yearp
comma
r_int
op_star
id|monp
comma
r_int
op_star
id|dayp
comma
r_int
op_star
id|hourp
comma
r_int
op_star
id|minp
comma
r_int
op_star
id|secp
)paren
(brace
r_int
r_char
id|ctrl
suffix:semicolon
r_int
id|hour
comma
id|pm
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|RTC_READ
c_func
(paren
id|RTC_FREQ_SELECT
)paren
op_amp
id|RTC_UIP
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|RTC_READ
c_func
(paren
id|RTC_FREQ_SELECT
)paren
op_amp
id|RTC_UIP
)paren
suffix:semicolon
op_star
id|secp
op_assign
id|RTC_READ
c_func
(paren
id|RTC_SECONDS
)paren
suffix:semicolon
op_star
id|minp
op_assign
id|RTC_READ
c_func
(paren
id|RTC_MINUTES
)paren
suffix:semicolon
id|hour
op_assign
id|RTC_READ
c_func
(paren
id|RTC_HOURS
)paren
suffix:semicolon
op_star
id|dayp
op_assign
id|RTC_READ
c_func
(paren
id|RTC_DAY_OF_MONTH
)paren
suffix:semicolon
op_star
id|monp
op_assign
id|RTC_READ
c_func
(paren
id|RTC_MONTH
)paren
suffix:semicolon
op_star
id|yearp
op_assign
id|RTC_READ
c_func
(paren
id|RTC_YEAR
)paren
suffix:semicolon
id|pm
op_assign
id|hour
op_amp
l_int|0x80
suffix:semicolon
id|hour
op_and_assign
op_complement
l_int|0x80
suffix:semicolon
id|ctrl
op_assign
id|RTC_READ
c_func
(paren
id|RTC_CONTROL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ctrl
op_amp
id|RTC_DM_BINARY
)paren
)paren
(brace
id|BCD_TO_BIN
c_func
(paren
op_star
id|secp
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
op_star
id|minp
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|hour
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
op_star
id|dayp
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
op_star
id|monp
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
op_star
id|yearp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|ctrl
op_amp
id|RTC_24H
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pm
op_logical_and
id|hour
op_eq
l_int|12
)paren
id|hour
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pm
op_logical_and
id|hour
op_ne
l_int|12
)paren
id|hour
op_add_assign
l_int|12
suffix:semicolon
)brace
op_star
id|hourp
op_assign
id|hour
suffix:semicolon
multiline_comment|/* Adjust values (let the setup valid) */
op_star
id|yearp
op_add_assign
id|atari_rtc_year_offset
suffix:semicolon
)brace
DECL|macro|HWCLK_POLL_INTERVAL
mdefine_line|#define HWCLK_POLL_INTERVAL&t;5
DECL|function|atari_mste_hwclk
r_int
id|atari_mste_hwclk
c_func
(paren
r_int
id|op
comma
r_struct
id|hwclk_time
op_star
id|t
)paren
(brace
r_int
id|hour
comma
id|year
suffix:semicolon
r_int
id|hr24
op_assign
l_int|0
suffix:semicolon
r_struct
id|MSTE_RTC
id|val
suffix:semicolon
id|mste_rtc.mode
op_assign
(paren
id|mste_rtc.mode
op_or
l_int|1
)paren
suffix:semicolon
id|hr24
op_assign
id|mste_rtc.mon_tens
op_amp
l_int|1
suffix:semicolon
id|mste_rtc.mode
op_assign
(paren
id|mste_rtc.mode
op_amp
op_complement
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|op
)paren
(brace
multiline_comment|/* write: prepare values */
id|val.sec_ones
op_assign
id|t-&gt;sec
op_mod
l_int|10
suffix:semicolon
id|val.sec_tens
op_assign
id|t-&gt;sec
op_div
l_int|10
suffix:semicolon
id|val.min_ones
op_assign
id|t-&gt;min
op_mod
l_int|10
suffix:semicolon
id|val.min_tens
op_assign
id|t-&gt;min
op_div
l_int|10
suffix:semicolon
id|hour
op_assign
id|t-&gt;hour
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hr24
)paren
(brace
r_if
c_cond
(paren
id|hour
OG
l_int|11
)paren
id|hour
op_add_assign
l_int|20
op_minus
l_int|12
suffix:semicolon
r_if
c_cond
(paren
id|hour
op_eq
l_int|0
op_logical_or
id|hour
op_eq
l_int|20
)paren
id|hour
op_add_assign
l_int|12
suffix:semicolon
)brace
id|val.hr_ones
op_assign
id|hour
op_mod
l_int|10
suffix:semicolon
id|val.hr_tens
op_assign
id|hour
op_div
l_int|10
suffix:semicolon
id|val.day_ones
op_assign
id|t-&gt;day
op_mod
l_int|10
suffix:semicolon
id|val.day_tens
op_assign
id|t-&gt;day
op_div
l_int|10
suffix:semicolon
id|val.mon_ones
op_assign
(paren
id|t-&gt;mon
op_plus
l_int|1
)paren
op_mod
l_int|10
suffix:semicolon
id|val.mon_tens
op_assign
(paren
id|t-&gt;mon
op_plus
l_int|1
)paren
op_div
l_int|10
suffix:semicolon
id|year
op_assign
id|t-&gt;year
op_minus
l_int|80
suffix:semicolon
id|val.year_ones
op_assign
id|year
op_mod
l_int|10
suffix:semicolon
id|val.year_tens
op_assign
id|year
op_div
l_int|10
suffix:semicolon
id|val.weekday
op_assign
id|t-&gt;wday
suffix:semicolon
id|mste_write
c_func
(paren
op_amp
id|val
)paren
suffix:semicolon
id|mste_rtc.mode
op_assign
(paren
id|mste_rtc.mode
op_or
l_int|1
)paren
suffix:semicolon
id|val.year_ones
op_assign
(paren
id|year
op_mod
l_int|4
)paren
suffix:semicolon
multiline_comment|/* leap year register */
id|mste_rtc.mode
op_assign
(paren
id|mste_rtc.mode
op_amp
op_complement
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|mste_read
c_func
(paren
op_amp
id|val
)paren
suffix:semicolon
id|t-&gt;sec
op_assign
id|val.sec_ones
op_plus
id|val.sec_tens
op_star
l_int|10
suffix:semicolon
id|t-&gt;min
op_assign
id|val.min_ones
op_plus
id|val.min_tens
op_star
l_int|10
suffix:semicolon
id|hour
op_assign
id|val.hr_ones
op_plus
id|val.hr_tens
op_star
l_int|10
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hr24
)paren
(brace
r_if
c_cond
(paren
id|hour
op_eq
l_int|12
op_logical_or
id|hour
op_eq
l_int|12
op_plus
l_int|20
)paren
id|hour
op_sub_assign
l_int|12
suffix:semicolon
r_if
c_cond
(paren
id|hour
op_ge
l_int|20
)paren
id|hour
op_add_assign
l_int|12
op_minus
l_int|20
suffix:semicolon
)brace
id|t-&gt;hour
op_assign
id|hour
suffix:semicolon
id|t-&gt;day
op_assign
id|val.day_ones
op_plus
id|val.day_tens
op_star
l_int|10
suffix:semicolon
id|t-&gt;mon
op_assign
id|val.mon_ones
op_plus
id|val.mon_tens
op_star
l_int|10
op_minus
l_int|1
suffix:semicolon
id|t-&gt;year
op_assign
id|val.year_ones
op_plus
id|val.year_tens
op_star
l_int|10
op_plus
l_int|80
suffix:semicolon
id|t-&gt;wday
op_assign
id|val.weekday
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|atari_tt_hwclk
r_int
id|atari_tt_hwclk
c_func
(paren
r_int
id|op
comma
r_struct
id|hwclk_time
op_star
id|t
)paren
(brace
r_int
id|sec
op_assign
l_int|0
comma
id|min
op_assign
l_int|0
comma
id|hour
op_assign
l_int|0
comma
id|day
op_assign
l_int|0
comma
id|mon
op_assign
l_int|0
comma
id|year
op_assign
l_int|0
comma
id|wday
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|ctrl
suffix:semicolon
r_int
id|pm
op_assign
l_int|0
suffix:semicolon
id|ctrl
op_assign
id|RTC_READ
c_func
(paren
id|RTC_CONTROL
)paren
suffix:semicolon
multiline_comment|/* control registers are&n;                                   * independent from the UIP */
r_if
c_cond
(paren
id|op
)paren
(brace
multiline_comment|/* write: prepare values */
id|sec
op_assign
id|t-&gt;sec
suffix:semicolon
id|min
op_assign
id|t-&gt;min
suffix:semicolon
id|hour
op_assign
id|t-&gt;hour
suffix:semicolon
id|day
op_assign
id|t-&gt;day
suffix:semicolon
id|mon
op_assign
id|t-&gt;mon
op_plus
l_int|1
suffix:semicolon
id|year
op_assign
id|t-&gt;year
op_minus
id|atari_rtc_year_offset
suffix:semicolon
id|wday
op_assign
id|t-&gt;wday
op_plus
(paren
id|t-&gt;wday
op_ge
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ctrl
op_amp
id|RTC_24H
)paren
)paren
(brace
r_if
c_cond
(paren
id|hour
OG
l_int|11
)paren
(brace
id|pm
op_assign
l_int|0x80
suffix:semicolon
r_if
c_cond
(paren
id|hour
op_ne
l_int|12
)paren
id|hour
op_sub_assign
l_int|12
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|hour
op_eq
l_int|0
)paren
id|hour
op_assign
l_int|12
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|ctrl
op_amp
id|RTC_DM_BINARY
)paren
)paren
(brace
id|BIN_TO_BCD
c_func
(paren
id|sec
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|min
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|hour
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|day
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|mon
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|year
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wday
op_ge
l_int|0
)paren
id|BIN_TO_BCD
c_func
(paren
id|wday
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Reading/writing the clock registers is a bit critical due to&n;     * the regular update cycle of the RTC. While an update is in&n;     * progress, registers 0..9 shouldn&squot;t be touched.&n;     * The problem is solved like that: If an update is currently in&n;     * progress (the UIP bit is set), the process sleeps for a while&n;     * (50ms). This really should be enough, since the update cycle&n;     * normally needs 2 ms.&n;     * If the UIP bit reads as 0, we have at least 244 usecs until the&n;     * update starts. This should be enough... But to be sure,&n;     * additionally the RTC_SET bit is set to prevent an update cycle.&n;     */
r_while
c_loop
(paren
id|RTC_READ
c_func
(paren
id|RTC_FREQ_SELECT
)paren
op_amp
id|RTC_UIP
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HWCLK_POLL_INTERVAL
)paren
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|RTC_WRITE
c_func
(paren
id|RTC_CONTROL
comma
id|ctrl
op_or
id|RTC_SET
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|op
)paren
(brace
id|sec
op_assign
id|RTC_READ
c_func
(paren
id|RTC_SECONDS
)paren
suffix:semicolon
id|min
op_assign
id|RTC_READ
c_func
(paren
id|RTC_MINUTES
)paren
suffix:semicolon
id|hour
op_assign
id|RTC_READ
c_func
(paren
id|RTC_HOURS
)paren
suffix:semicolon
id|day
op_assign
id|RTC_READ
c_func
(paren
id|RTC_DAY_OF_MONTH
)paren
suffix:semicolon
id|mon
op_assign
id|RTC_READ
c_func
(paren
id|RTC_MONTH
)paren
suffix:semicolon
id|year
op_assign
id|RTC_READ
c_func
(paren
id|RTC_YEAR
)paren
suffix:semicolon
id|wday
op_assign
id|RTC_READ
c_func
(paren
id|RTC_DAY_OF_WEEK
)paren
suffix:semicolon
)brace
r_else
(brace
id|RTC_WRITE
c_func
(paren
id|RTC_SECONDS
comma
id|sec
)paren
suffix:semicolon
id|RTC_WRITE
c_func
(paren
id|RTC_MINUTES
comma
id|min
)paren
suffix:semicolon
id|RTC_WRITE
c_func
(paren
id|RTC_HOURS
comma
id|hour
op_plus
id|pm
)paren
suffix:semicolon
id|RTC_WRITE
c_func
(paren
id|RTC_DAY_OF_MONTH
comma
id|day
)paren
suffix:semicolon
id|RTC_WRITE
c_func
(paren
id|RTC_MONTH
comma
id|mon
)paren
suffix:semicolon
id|RTC_WRITE
c_func
(paren
id|RTC_YEAR
comma
id|year
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wday
op_ge
l_int|0
)paren
id|RTC_WRITE
c_func
(paren
id|RTC_DAY_OF_WEEK
comma
id|wday
)paren
suffix:semicolon
)brace
id|RTC_WRITE
c_func
(paren
id|RTC_CONTROL
comma
id|ctrl
op_amp
op_complement
id|RTC_SET
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|op
)paren
(brace
multiline_comment|/* read: adjust values */
r_if
c_cond
(paren
id|hour
op_amp
l_int|0x80
)paren
(brace
id|hour
op_and_assign
op_complement
l_int|0x80
suffix:semicolon
id|pm
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|ctrl
op_amp
id|RTC_DM_BINARY
)paren
)paren
(brace
id|BCD_TO_BIN
c_func
(paren
id|sec
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|min
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|hour
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|day
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|mon
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|year
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|wday
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|ctrl
op_amp
id|RTC_24H
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pm
op_logical_and
id|hour
op_eq
l_int|12
)paren
id|hour
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pm
op_logical_and
id|hour
op_ne
l_int|12
)paren
id|hour
op_add_assign
l_int|12
suffix:semicolon
)brace
id|t-&gt;sec
op_assign
id|sec
suffix:semicolon
id|t-&gt;min
op_assign
id|min
suffix:semicolon
id|t-&gt;hour
op_assign
id|hour
suffix:semicolon
id|t-&gt;day
op_assign
id|day
suffix:semicolon
id|t-&gt;mon
op_assign
id|mon
op_minus
l_int|1
suffix:semicolon
id|t-&gt;year
op_assign
id|year
op_plus
id|atari_rtc_year_offset
suffix:semicolon
id|t-&gt;wday
op_assign
id|wday
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|atari_mste_set_clock_mmss
r_int
id|atari_mste_set_clock_mmss
(paren
r_int
r_int
id|nowtime
)paren
(brace
r_int
id|real_seconds
op_assign
id|nowtime
op_mod
l_int|60
comma
id|real_minutes
op_assign
(paren
id|nowtime
op_div
l_int|60
)paren
op_mod
l_int|60
suffix:semicolon
r_struct
id|MSTE_RTC
id|val
suffix:semicolon
r_int
r_char
id|rtc_minutes
suffix:semicolon
id|mste_read
c_func
(paren
op_amp
id|val
)paren
suffix:semicolon
id|rtc_minutes
op_assign
id|val.min_ones
op_plus
id|val.min_tens
op_star
l_int|10
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rtc_minutes
OL
id|real_minutes
ques
c_cond
id|real_minutes
op_minus
id|rtc_minutes
suffix:colon
id|rtc_minutes
op_minus
id|real_minutes
)paren
OL
l_int|30
)paren
(brace
id|val.sec_ones
op_assign
id|real_seconds
op_mod
l_int|10
suffix:semicolon
id|val.sec_tens
op_assign
id|real_seconds
op_div
l_int|10
suffix:semicolon
id|val.min_ones
op_assign
id|real_minutes
op_mod
l_int|10
suffix:semicolon
id|val.min_tens
op_assign
id|real_minutes
op_div
l_int|10
suffix:semicolon
id|mste_write
c_func
(paren
op_amp
id|val
)paren
suffix:semicolon
)brace
r_else
r_return
op_minus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|atari_tt_set_clock_mmss
r_int
id|atari_tt_set_clock_mmss
(paren
r_int
r_int
id|nowtime
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|real_seconds
op_assign
id|nowtime
op_mod
l_int|60
comma
id|real_minutes
op_assign
(paren
id|nowtime
op_div
l_int|60
)paren
op_mod
l_int|60
suffix:semicolon
r_int
r_char
id|save_control
comma
id|save_freq_select
comma
id|rtc_minutes
suffix:semicolon
id|save_control
op_assign
id|RTC_READ
(paren
id|RTC_CONTROL
)paren
suffix:semicolon
multiline_comment|/* tell the clock it&squot;s being set */
id|RTC_WRITE
(paren
id|RTC_CONTROL
comma
id|save_control
op_or
id|RTC_SET
)paren
suffix:semicolon
id|save_freq_select
op_assign
id|RTC_READ
(paren
id|RTC_FREQ_SELECT
)paren
suffix:semicolon
multiline_comment|/* stop and reset prescaler */
id|RTC_WRITE
(paren
id|RTC_FREQ_SELECT
comma
id|save_freq_select
op_or
id|RTC_DIV_RESET2
)paren
suffix:semicolon
id|rtc_minutes
op_assign
id|RTC_READ
(paren
id|RTC_MINUTES
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|save_control
op_amp
id|RTC_DM_BINARY
)paren
)paren
id|BCD_TO_BIN
(paren
id|rtc_minutes
)paren
suffix:semicolon
multiline_comment|/* Since we&squot;re only adjusting minutes and seconds, don&squot;t interfere&n;       with hour overflow.  This avoids messing with unknown time zones&n;       but requires your RTC not to be off by more than 30 minutes.  */
r_if
c_cond
(paren
(paren
id|rtc_minutes
OL
id|real_minutes
ques
c_cond
id|real_minutes
op_minus
id|rtc_minutes
suffix:colon
id|rtc_minutes
op_minus
id|real_minutes
)paren
OL
l_int|30
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|save_control
op_amp
id|RTC_DM_BINARY
)paren
)paren
(brace
id|BIN_TO_BCD
(paren
id|real_seconds
)paren
suffix:semicolon
id|BIN_TO_BCD
(paren
id|real_minutes
)paren
suffix:semicolon
)brace
id|RTC_WRITE
(paren
id|RTC_SECONDS
comma
id|real_seconds
)paren
suffix:semicolon
id|RTC_WRITE
(paren
id|RTC_MINUTES
comma
id|real_minutes
)paren
suffix:semicolon
)brace
r_else
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
id|RTC_WRITE
(paren
id|RTC_FREQ_SELECT
comma
id|save_freq_select
)paren
suffix:semicolon
id|RTC_WRITE
(paren
id|RTC_CONTROL
comma
id|save_control
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * Local variables:&n; *  c-indent-level: 4&n; *  tab-width: 8&n; * End:&n; */
eof
