multiline_comment|/*&n; *  arch/m68k/bvme6000/config.c&n; *&n; *  Copyright (C) 1997 Richard Hirst [richard@sleepie.demon.co.uk]&n; *&n; * Based on:&n; *&n; *  linux/amiga/config.c&n; *&n; *  Copyright (C) 1993 Hamish Macdonald&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file README.legal in the main directory of this archive&n; * for more details.&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/kd.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;linux/linkage.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;asm/bootinfo.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/setup.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/traps.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/bvme6000hw.h&gt;
r_extern
r_void
id|bvme6000_process_int
(paren
r_int
id|level
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_extern
r_void
id|bvme6000_init_IRQ
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|bvme6000_free_irq
(paren
r_int
r_int
comma
r_void
op_star
)paren
suffix:semicolon
r_extern
r_int
id|bvme6000_get_irq_list
(paren
r_char
op_star
)paren
suffix:semicolon
r_extern
r_void
id|bvme6000_enable_irq
(paren
r_int
r_int
)paren
suffix:semicolon
r_extern
r_void
id|bvme6000_disable_irq
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_void
id|bvme6000_get_model
c_func
(paren
r_char
op_star
id|model
)paren
suffix:semicolon
r_static
r_int
id|bvme6000_get_hardware_list
c_func
(paren
r_char
op_star
id|buffer
)paren
suffix:semicolon
r_extern
r_int
id|bvme6000_request_irq
c_func
(paren
r_int
r_int
id|irq
comma
r_void
(paren
op_star
id|handler
)paren
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
comma
r_int
r_int
id|flags
comma
r_const
r_char
op_star
id|devname
comma
r_void
op_star
id|dev_id
)paren
suffix:semicolon
r_extern
r_void
id|bvme6000_sched_init
c_func
(paren
r_void
(paren
op_star
id|handler
)paren
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
)paren
suffix:semicolon
r_extern
r_int
id|bvme6000_keyb_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_int
id|bvme6000_kbdrate
(paren
r_struct
id|kbd_repeat
op_star
)paren
suffix:semicolon
r_extern
r_int
r_int
id|bvme6000_gettimeoffset
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|bvme6000_gettod
(paren
r_int
op_star
id|year
comma
r_int
op_star
id|mon
comma
r_int
op_star
id|day
comma
r_int
op_star
id|hour
comma
r_int
op_star
id|min
comma
r_int
op_star
id|sec
)paren
suffix:semicolon
r_extern
r_int
id|bvme6000_hwclk
(paren
r_int
comma
r_struct
id|hwclk_time
op_star
)paren
suffix:semicolon
r_extern
r_int
id|bvme6000_set_clock_mmss
(paren
r_int
r_int
)paren
suffix:semicolon
r_extern
r_void
id|bvme6000_check_partition
(paren
r_struct
id|gendisk
op_star
id|hd
comma
r_int
r_int
id|dev
)paren
suffix:semicolon
r_extern
r_void
id|bvme6000_mksound
c_func
(paren
r_int
r_int
id|count
comma
r_int
r_int
id|ticks
)paren
suffix:semicolon
r_extern
r_void
id|bvme6000_reset
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|bvme6000_waitbut
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|bvme6000_set_vectors
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
r_char
id|bcd2bin
(paren
r_int
r_char
id|b
)paren
suffix:semicolon
r_static
r_int
r_char
id|bin2bcd
(paren
r_int
r_char
id|b
)paren
suffix:semicolon
multiline_comment|/* Save tick handler routine pointer, will point to do_timer() in&n; * kernel/sched.c, called via bvme6000_process_int() */
DECL|variable|tick_handler
r_static
r_void
(paren
op_star
id|tick_handler
)paren
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
DECL|function|bvme6000_parse_bootinfo
r_int
id|bvme6000_parse_bootinfo
c_func
(paren
r_const
r_struct
id|bi_record
op_star
id|bi
)paren
(brace
r_if
c_cond
(paren
id|bi-&gt;tag
op_eq
id|BI_VME_TYPE
)paren
r_return
l_int|0
suffix:semicolon
r_else
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|bvme6000_kbdrate
r_int
id|bvme6000_kbdrate
(paren
r_struct
id|kbd_repeat
op_star
id|k
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bvme6000_mksound
r_void
id|bvme6000_mksound
c_func
(paren
r_int
r_int
id|count
comma
r_int
r_int
id|ticks
)paren
(brace
)brace
DECL|function|bvme6000_reset
r_void
id|bvme6000_reset
c_func
(paren
)paren
(brace
r_volatile
id|PitRegsPtr
id|pit
op_assign
(paren
id|PitRegsPtr
)paren
id|BVME_PIT_BASE
suffix:semicolon
id|printk
(paren
l_string|&quot;&bslash;r&bslash;n&bslash;nCalled bvme6000_reset&bslash;r&bslash;n&quot;
l_string|&quot;&bslash;r&bslash;r&bslash;r&bslash;r&bslash;r&bslash;r&bslash;r&bslash;r&bslash;r&bslash;r&bslash;r&bslash;r&bslash;r&bslash;r&bslash;r&bslash;r&bslash;r&bslash;r&quot;
)paren
suffix:semicolon
multiline_comment|/* The string of returns is to delay the reset until the whole&n;&t; * message is output. */
multiline_comment|/* Enable the watchdog, via PIT port C bit 4 */
id|pit-&gt;pcddr
op_or_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* WDOG enable */
r_while
c_loop
(paren
l_int|1
)paren
(brace
suffix:semicolon
)brace
)brace
DECL|function|bvme6000_get_model
r_static
r_void
id|bvme6000_get_model
c_func
(paren
r_char
op_star
id|model
)paren
(brace
id|sprintf
c_func
(paren
id|model
comma
l_string|&quot;BVME%d000&quot;
comma
id|m68k_cputype
op_eq
id|CPU_68060
ques
c_cond
l_int|6
suffix:colon
l_int|4
)paren
suffix:semicolon
)brace
multiline_comment|/* No hardware options on BVME6000? */
DECL|function|bvme6000_get_hardware_list
r_static
r_int
id|bvme6000_get_hardware_list
c_func
(paren
r_char
op_star
id|buffer
)paren
(brace
op_star
id|buffer
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|config_bvme6000
r_void
id|__init
id|config_bvme6000
c_func
(paren
r_void
)paren
(brace
r_volatile
id|PitRegsPtr
id|pit
op_assign
(paren
id|PitRegsPtr
)paren
id|BVME_PIT_BASE
suffix:semicolon
multiline_comment|/* Board type is only set by newer versions of vmelilo/tftplilo */
r_if
c_cond
(paren
op_logical_neg
id|vme_brdtype
)paren
(brace
r_if
c_cond
(paren
id|m68k_cputype
op_eq
id|CPU_68060
)paren
id|vme_brdtype
op_assign
id|VME_TYPE_BVME6000
suffix:semicolon
r_else
id|vme_brdtype
op_assign
id|VME_TYPE_BVME4000
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/* Call bvme6000_set_vectors() so ABORT will work, along with BVMBug&n;     * debugger.  Note trap_init() will splat the abort vector, but&n;     * bvme6000_init_IRQ() will put it back again.  Hopefully. */
id|bvme6000_set_vectors
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|mach_max_dma_address
op_assign
l_int|0xffffffff
suffix:semicolon
id|mach_sched_init
op_assign
id|bvme6000_sched_init
suffix:semicolon
id|mach_keyb_init
op_assign
id|bvme6000_keyb_init
suffix:semicolon
id|mach_kbdrate
op_assign
id|bvme6000_kbdrate
suffix:semicolon
id|mach_init_IRQ
op_assign
id|bvme6000_init_IRQ
suffix:semicolon
id|mach_gettimeoffset
op_assign
id|bvme6000_gettimeoffset
suffix:semicolon
id|mach_gettod
op_assign
id|bvme6000_gettod
suffix:semicolon
id|mach_hwclk
op_assign
id|bvme6000_hwclk
suffix:semicolon
id|mach_set_clock_mmss
op_assign
id|bvme6000_set_clock_mmss
suffix:semicolon
multiline_comment|/*  mach_mksound         = bvme6000_mksound; */
id|mach_reset
op_assign
id|bvme6000_reset
suffix:semicolon
id|mach_free_irq
op_assign
id|bvme6000_free_irq
suffix:semicolon
id|mach_process_int
op_assign
id|bvme6000_process_int
suffix:semicolon
id|mach_get_irq_list
op_assign
id|bvme6000_get_irq_list
suffix:semicolon
id|mach_request_irq
op_assign
id|bvme6000_request_irq
suffix:semicolon
id|enable_irq
op_assign
id|bvme6000_enable_irq
suffix:semicolon
id|disable_irq
op_assign
id|bvme6000_disable_irq
suffix:semicolon
id|mach_get_model
op_assign
id|bvme6000_get_model
suffix:semicolon
id|mach_get_hardware_list
op_assign
id|bvme6000_get_hardware_list
suffix:semicolon
id|printk
(paren
l_string|&quot;Board is %sconfigured as a System Controller&bslash;n&quot;
comma
op_star
id|config_reg_ptr
op_amp
id|BVME_CONFIG_SW1
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;not &quot;
)paren
suffix:semicolon
multiline_comment|/* Now do the PIT configuration */
id|pit-&gt;pgcr
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Unidirectional 8 bit, no handshake for now */
id|pit-&gt;psrr
op_assign
l_int|0x18
suffix:semicolon
multiline_comment|/* PIACK and PIRQ fucntions enabled */
id|pit-&gt;pacr
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Sub Mode 00, H2 i/p, no DMA */
id|pit-&gt;padr
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Just to be tidy! */
id|pit-&gt;paddr
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* All inputs for now (safest) */
id|pit-&gt;pbcr
op_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* Sub Mode 1x, H4 i/p, no DMA */
id|pit-&gt;pbdr
op_assign
l_int|0xbc
op_or
(paren
op_star
id|config_reg_ptr
op_amp
id|BVME_CONFIG_SW1
ques
c_cond
l_int|0
suffix:colon
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* PRI, SYSCON?, Level3, SCC clks from xtal */
id|pit-&gt;pbddr
op_assign
l_int|0xf3
suffix:semicolon
multiline_comment|/* Mostly outputs */
id|pit-&gt;pcdr
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* PA transceiver disabled */
id|pit-&gt;pcddr
op_assign
l_int|0x03
suffix:semicolon
multiline_comment|/* WDOG disable */
multiline_comment|/* Disable snooping for Ethernet and VME accesses */
id|bvme_acr_addrctl
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|bvme6000_abort_int
r_void
id|bvme6000_abort_int
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|fp
)paren
(brace
r_int
r_int
op_star
r_new
op_assign
(paren
r_int
r_int
op_star
)paren
id|vectors
suffix:semicolon
r_int
r_int
op_star
id|old
op_assign
(paren
r_int
r_int
op_star
)paren
l_int|0xf8000000
suffix:semicolon
multiline_comment|/* Wait for button release */
r_while
c_loop
(paren
op_star
id|config_reg_ptr
op_amp
id|BVME_ABORT_STATUS
)paren
suffix:semicolon
op_star
(paren
r_new
op_plus
l_int|4
)paren
op_assign
op_star
(paren
id|old
op_plus
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Illegal instruction */
op_star
(paren
r_new
op_plus
l_int|9
)paren
op_assign
op_star
(paren
id|old
op_plus
l_int|9
)paren
suffix:semicolon
multiline_comment|/* Trace */
op_star
(paren
r_new
op_plus
l_int|47
)paren
op_assign
op_star
(paren
id|old
op_plus
l_int|47
)paren
suffix:semicolon
multiline_comment|/* Trap #15 */
op_star
(paren
r_new
op_plus
l_int|0x1f
)paren
op_assign
op_star
(paren
id|old
op_plus
l_int|0x1f
)paren
suffix:semicolon
multiline_comment|/* ABORT switch */
)brace
DECL|function|bvme6000_timer_int
r_static
r_void
id|bvme6000_timer_int
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|fp
)paren
(brace
r_volatile
id|RtcPtr_t
id|rtc
op_assign
(paren
id|RtcPtr_t
)paren
id|BVME_RTC_BASE
suffix:semicolon
r_int
r_char
id|msr
op_assign
id|rtc-&gt;msr
op_amp
l_int|0xc0
suffix:semicolon
id|rtc-&gt;msr
op_assign
id|msr
op_or
l_int|0x20
suffix:semicolon
multiline_comment|/* Ack the interrupt */
id|tick_handler
c_func
(paren
id|irq
comma
id|dev_id
comma
id|fp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Set up the RTC timer 1 to mode 2, so T1 output toggles every 5ms&n; * (40000 x 125ns).  It will interrupt every 10ms, when T1 goes low.&n; * So, when reading the elapsed time, you should read timer1,&n; * subtract it from 39999, and then add 40000 if T1 is high.&n; * That gives you the number of 125ns ticks in to the 10ms period,&n; * so divide by 8 to get the microsecond result.&n; */
DECL|function|bvme6000_sched_init
r_void
id|bvme6000_sched_init
(paren
r_void
(paren
op_star
id|timer_routine
)paren
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
)paren
(brace
r_volatile
id|RtcPtr_t
id|rtc
op_assign
(paren
id|RtcPtr_t
)paren
id|BVME_RTC_BASE
suffix:semicolon
r_int
r_char
id|msr
op_assign
id|rtc-&gt;msr
op_amp
l_int|0xc0
suffix:semicolon
id|rtc-&gt;msr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Ensure timer registers accessible */
id|tick_handler
op_assign
id|timer_routine
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|BVME_IRQ_RTC
comma
id|bvme6000_timer_int
comma
l_int|0
comma
l_string|&quot;timer&quot;
comma
id|bvme6000_timer_int
)paren
)paren
id|panic
(paren
l_string|&quot;Couldn&squot;t register timer int&quot;
)paren
suffix:semicolon
id|rtc-&gt;t1cr_omr
op_assign
l_int|0x04
suffix:semicolon
multiline_comment|/* Mode 2, ext clk */
id|rtc-&gt;t1msb
op_assign
l_int|39999
op_rshift
l_int|8
suffix:semicolon
id|rtc-&gt;t1lsb
op_assign
l_int|39999
op_amp
l_int|0xff
suffix:semicolon
id|rtc-&gt;irr_icr1
op_and_assign
l_int|0xef
suffix:semicolon
multiline_comment|/* Route timer 1 to INTR pin */
id|rtc-&gt;msr
op_assign
l_int|0x40
suffix:semicolon
multiline_comment|/* Access int.cntrl, etc */
id|rtc-&gt;pfr_icr0
op_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* Just timer 1 ints enabled */
id|rtc-&gt;irr_icr1
op_assign
l_int|0
suffix:semicolon
id|rtc-&gt;t1cr_omr
op_assign
l_int|0x0a
suffix:semicolon
multiline_comment|/* INTR+T1 active lo, push-pull */
id|rtc-&gt;t0cr_rtmr
op_and_assign
l_int|0xdf
suffix:semicolon
multiline_comment|/* Stop timers in standby */
id|rtc-&gt;msr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Access timer 1 control */
id|rtc-&gt;t1cr_omr
op_assign
l_int|0x05
suffix:semicolon
multiline_comment|/* Mode 2, ext clk, GO */
id|rtc-&gt;msr
op_assign
id|msr
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|BVME_IRQ_ABORT
comma
id|bvme6000_abort_int
comma
l_int|0
comma
l_string|&quot;abort&quot;
comma
id|bvme6000_abort_int
)paren
)paren
id|panic
(paren
l_string|&quot;Couldn&squot;t register abort int&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* This is always executed with interrupts disabled.  */
multiline_comment|/*&n; * NOTE:  Don&squot;t accept any readings within 5us of rollover, as&n; * the T1INT bit may be a little slow getting set.  There is also&n; * a fault in the chip, meaning that reads may produce invalid&n; * results...&n; */
DECL|function|bvme6000_gettimeoffset
r_int
r_int
id|bvme6000_gettimeoffset
(paren
r_void
)paren
(brace
r_volatile
id|RtcPtr_t
id|rtc
op_assign
(paren
id|RtcPtr_t
)paren
id|BVME_RTC_BASE
suffix:semicolon
r_volatile
id|PitRegsPtr
id|pit
op_assign
(paren
id|PitRegsPtr
)paren
id|BVME_PIT_BASE
suffix:semicolon
r_int
r_char
id|msr
op_assign
id|rtc-&gt;msr
op_amp
l_int|0xc0
suffix:semicolon
r_int
r_char
id|t1int
comma
id|t1op
suffix:semicolon
r_int
r_int
id|v
op_assign
l_int|800000
comma
id|ov
suffix:semicolon
id|rtc-&gt;msr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Ensure timer registers accessible */
r_do
(brace
id|ov
op_assign
id|v
suffix:semicolon
id|t1int
op_assign
id|rtc-&gt;msr
op_amp
l_int|0x20
suffix:semicolon
id|t1op
op_assign
id|pit-&gt;pcdr
op_amp
l_int|0x04
suffix:semicolon
id|rtc-&gt;t1cr_omr
op_or_assign
l_int|0x40
suffix:semicolon
multiline_comment|/* Latch timer1 */
id|v
op_assign
id|rtc-&gt;t1msb
op_lshift
l_int|8
suffix:semicolon
multiline_comment|/* Read timer1 */
id|v
op_or_assign
id|rtc-&gt;t1lsb
suffix:semicolon
multiline_comment|/* Read timer1 */
)brace
r_while
c_loop
(paren
id|t1int
op_ne
(paren
id|rtc-&gt;msr
op_amp
l_int|0x20
)paren
op_logical_or
id|t1op
op_ne
(paren
id|pit-&gt;pcdr
op_amp
l_int|0x04
)paren
op_logical_or
id|abs
c_func
(paren
id|ov
op_minus
id|v
)paren
OG
l_int|80
op_logical_or
id|v
OG
l_int|39960
)paren
suffix:semicolon
id|v
op_assign
l_int|39999
op_minus
id|v
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|t1op
)paren
multiline_comment|/* If in second half cycle.. */
id|v
op_add_assign
l_int|40000
suffix:semicolon
id|v
op_div_assign
l_int|8
suffix:semicolon
multiline_comment|/* Convert ticks to microseconds */
r_if
c_cond
(paren
id|t1int
)paren
id|v
op_add_assign
l_int|10000
suffix:semicolon
multiline_comment|/* Int pending, + 10ms */
id|rtc-&gt;msr
op_assign
id|msr
suffix:semicolon
r_return
id|v
suffix:semicolon
)brace
DECL|function|bvme6000_gettod
r_extern
r_void
id|bvme6000_gettod
(paren
r_int
op_star
id|year
comma
r_int
op_star
id|mon
comma
r_int
op_star
id|day
comma
r_int
op_star
id|hour
comma
r_int
op_star
id|min
comma
r_int
op_star
id|sec
)paren
(brace
r_volatile
id|RtcPtr_t
id|rtc
op_assign
(paren
id|RtcPtr_t
)paren
id|BVME_RTC_BASE
suffix:semicolon
r_int
r_char
id|msr
op_assign
id|rtc-&gt;msr
op_amp
l_int|0xc0
suffix:semicolon
id|rtc-&gt;msr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Ensure clock accessible */
r_do
(brace
multiline_comment|/* Loop until we get a reading with a stable seconds field */
op_star
id|sec
op_assign
id|bcd2bin
(paren
id|rtc-&gt;bcd_sec
)paren
suffix:semicolon
op_star
id|min
op_assign
id|bcd2bin
(paren
id|rtc-&gt;bcd_min
)paren
suffix:semicolon
op_star
id|hour
op_assign
id|bcd2bin
(paren
id|rtc-&gt;bcd_hr
)paren
suffix:semicolon
op_star
id|day
op_assign
id|bcd2bin
(paren
id|rtc-&gt;bcd_dom
)paren
suffix:semicolon
op_star
id|mon
op_assign
id|bcd2bin
(paren
id|rtc-&gt;bcd_mth
)paren
suffix:semicolon
op_star
id|year
op_assign
id|bcd2bin
(paren
id|rtc-&gt;bcd_year
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|bcd2bin
(paren
id|rtc-&gt;bcd_sec
)paren
op_ne
op_star
id|sec
)paren
suffix:semicolon
id|rtc-&gt;msr
op_assign
id|msr
suffix:semicolon
)brace
DECL|function|bcd2bin
r_static
r_int
r_char
id|bcd2bin
(paren
r_int
r_char
id|b
)paren
(brace
r_return
(paren
(paren
id|b
op_rshift
l_int|4
)paren
op_star
l_int|10
op_plus
(paren
id|b
op_amp
l_int|15
)paren
)paren
suffix:semicolon
)brace
DECL|function|bin2bcd
r_static
r_int
r_char
id|bin2bcd
(paren
r_int
r_char
id|b
)paren
(brace
r_return
(paren
(paren
(paren
id|b
op_div
l_int|10
)paren
op_star
l_int|16
)paren
op_plus
(paren
id|b
op_mod
l_int|10
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Looks like op is non-zero for setting the clock, and zero for&n; * reading the clock.&n; *&n; *  struct hwclk_time {&n; *         unsigned        sec;       0..59&n; *         unsigned        min;       0..59&n; *         unsigned        hour;      0..23&n; *         unsigned        day;       1..31&n; *         unsigned        mon;       0..11&n; *         unsigned        year;      00...&n; *         int             wday;      0..6, 0 is Sunday, -1 means unknown/don&squot;t set&n; * };&n; */
DECL|function|bvme6000_hwclk
r_int
id|bvme6000_hwclk
c_func
(paren
r_int
id|op
comma
r_struct
id|hwclk_time
op_star
id|t
)paren
(brace
r_volatile
id|RtcPtr_t
id|rtc
op_assign
(paren
id|RtcPtr_t
)paren
id|BVME_RTC_BASE
suffix:semicolon
r_int
r_char
id|msr
op_assign
id|rtc-&gt;msr
op_amp
l_int|0xc0
suffix:semicolon
id|rtc-&gt;msr
op_assign
l_int|0x40
suffix:semicolon
multiline_comment|/* Ensure clock and real-time-mode-register&n;&t;&t;&t;&t; * are accessible */
r_if
c_cond
(paren
id|op
)paren
(brace
multiline_comment|/* Write.... */
id|rtc-&gt;t0cr_rtmr
op_assign
id|t-&gt;year
op_mod
l_int|4
suffix:semicolon
id|rtc-&gt;bcd_tenms
op_assign
l_int|0
suffix:semicolon
id|rtc-&gt;bcd_sec
op_assign
id|bin2bcd
c_func
(paren
id|t-&gt;sec
)paren
suffix:semicolon
id|rtc-&gt;bcd_min
op_assign
id|bin2bcd
c_func
(paren
id|t-&gt;min
)paren
suffix:semicolon
id|rtc-&gt;bcd_hr
op_assign
id|bin2bcd
c_func
(paren
id|t-&gt;hour
)paren
suffix:semicolon
id|rtc-&gt;bcd_dom
op_assign
id|bin2bcd
c_func
(paren
id|t-&gt;day
)paren
suffix:semicolon
id|rtc-&gt;bcd_mth
op_assign
id|bin2bcd
c_func
(paren
id|t-&gt;mon
op_plus
l_int|1
)paren
suffix:semicolon
id|rtc-&gt;bcd_year
op_assign
id|bin2bcd
c_func
(paren
id|t-&gt;year
op_mod
l_int|100
)paren
suffix:semicolon
r_if
c_cond
(paren
id|t-&gt;wday
op_ge
l_int|0
)paren
id|rtc-&gt;bcd_dow
op_assign
id|bin2bcd
c_func
(paren
id|t-&gt;wday
op_plus
l_int|1
)paren
suffix:semicolon
id|rtc-&gt;t0cr_rtmr
op_assign
id|t-&gt;year
op_mod
l_int|4
op_or
l_int|0x08
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Read....  */
r_do
(brace
id|t-&gt;sec
op_assign
id|bcd2bin
c_func
(paren
id|rtc-&gt;bcd_sec
)paren
suffix:semicolon
id|t-&gt;min
op_assign
id|bcd2bin
c_func
(paren
id|rtc-&gt;bcd_min
)paren
suffix:semicolon
id|t-&gt;hour
op_assign
id|bcd2bin
c_func
(paren
id|rtc-&gt;bcd_hr
)paren
suffix:semicolon
id|t-&gt;day
op_assign
id|bcd2bin
c_func
(paren
id|rtc-&gt;bcd_dom
)paren
suffix:semicolon
id|t-&gt;mon
op_assign
id|bcd2bin
c_func
(paren
id|rtc-&gt;bcd_mth
)paren
op_minus
l_int|1
suffix:semicolon
id|t-&gt;year
op_assign
id|bcd2bin
c_func
(paren
id|rtc-&gt;bcd_year
)paren
suffix:semicolon
r_if
c_cond
(paren
id|t-&gt;year
OL
l_int|70
)paren
id|t-&gt;year
op_add_assign
l_int|100
suffix:semicolon
id|t-&gt;wday
op_assign
id|bcd2bin
c_func
(paren
id|rtc-&gt;bcd_dow
)paren
op_minus
l_int|1
suffix:semicolon
)brace
r_while
c_loop
(paren
id|t-&gt;sec
op_ne
id|bcd2bin
c_func
(paren
id|rtc-&gt;bcd_sec
)paren
)paren
suffix:semicolon
)brace
id|rtc-&gt;msr
op_assign
id|msr
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Set the minutes and seconds from seconds value &squot;nowtime&squot;.  Fail if&n; * clock is out by &gt; 30 minutes.  Logic lifted from atari code.&n; * Algorithm is to wait for the 10ms register to change, and then to&n; * wait a short while, and then set it.&n; */
DECL|function|bvme6000_set_clock_mmss
r_int
id|bvme6000_set_clock_mmss
(paren
r_int
r_int
id|nowtime
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|real_seconds
op_assign
id|nowtime
op_mod
l_int|60
comma
id|real_minutes
op_assign
(paren
id|nowtime
op_div
l_int|60
)paren
op_mod
l_int|60
suffix:semicolon
r_int
r_char
id|rtc_minutes
comma
id|rtc_tenms
suffix:semicolon
r_volatile
id|RtcPtr_t
id|rtc
op_assign
(paren
id|RtcPtr_t
)paren
id|BVME_RTC_BASE
suffix:semicolon
r_int
r_char
id|msr
op_assign
id|rtc-&gt;msr
op_amp
l_int|0xc0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_volatile
r_int
id|i
suffix:semicolon
id|rtc-&gt;msr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Ensure clock accessible */
id|rtc_minutes
op_assign
id|bcd2bin
(paren
id|rtc-&gt;bcd_min
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rtc_minutes
OL
id|real_minutes
ques
c_cond
id|real_minutes
op_minus
id|rtc_minutes
suffix:colon
id|rtc_minutes
op_minus
id|real_minutes
)paren
OL
l_int|30
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|rtc_tenms
op_assign
id|rtc-&gt;bcd_tenms
suffix:semicolon
r_while
c_loop
(paren
id|rtc_tenms
op_eq
id|rtc-&gt;bcd_tenms
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
suffix:semicolon
id|i
op_increment
)paren
suffix:semicolon
id|rtc-&gt;bcd_min
op_assign
id|bin2bcd
c_func
(paren
id|real_minutes
)paren
suffix:semicolon
id|rtc-&gt;bcd_sec
op_assign
id|bin2bcd
c_func
(paren
id|real_seconds
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_else
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
id|rtc-&gt;msr
op_assign
id|msr
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|bvme6000_keyb_init
r_int
id|bvme6000_keyb_init
(paren
r_void
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------  Serial console stuff ------------------------*/
r_static
r_void
id|bvme_scc_write
c_func
(paren
r_struct
id|console
op_star
id|co
comma
r_const
r_char
op_star
id|str
comma
r_int
id|cnt
)paren
suffix:semicolon
DECL|function|bvme6000_init_console_port
r_void
id|bvme6000_init_console_port
(paren
r_struct
id|console
op_star
id|co
comma
r_int
id|cflag
)paren
(brace
id|co-&gt;write
op_assign
id|bvme_scc_write
suffix:semicolon
)brace
DECL|function|scc_delay
r_static
r_void
id|scc_delay
(paren
r_void
)paren
(brace
r_int
id|n
suffix:semicolon
r_volatile
r_int
id|trash
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
l_int|20
suffix:semicolon
id|n
op_increment
)paren
id|trash
op_assign
id|n
suffix:semicolon
)brace
DECL|function|scc_write
r_static
r_void
id|scc_write
(paren
r_char
id|ch
)paren
(brace
r_volatile
r_char
op_star
id|p
op_assign
(paren
r_volatile
r_char
op_star
)paren
id|BVME_SCC_A_ADDR
suffix:semicolon
r_do
(brace
id|scc_delay
c_func
(paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
op_star
id|p
op_amp
l_int|4
)paren
)paren
suffix:semicolon
id|scc_delay
c_func
(paren
)paren
suffix:semicolon
op_star
id|p
op_assign
l_int|8
suffix:semicolon
id|scc_delay
c_func
(paren
)paren
suffix:semicolon
op_star
id|p
op_assign
id|ch
suffix:semicolon
)brace
DECL|function|bvme_scc_write
r_static
r_void
id|bvme_scc_write
(paren
r_struct
id|console
op_star
id|co
comma
r_const
r_char
op_star
id|str
comma
r_int
id|count
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
op_decrement
)paren
(brace
r_if
c_cond
(paren
op_star
id|str
op_eq
l_char|&squot;&bslash;n&squot;
)paren
id|scc_write
(paren
l_char|&squot;&bslash;r&squot;
)paren
suffix:semicolon
id|scc_write
(paren
op_star
id|str
op_increment
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
eof
