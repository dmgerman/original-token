multiline_comment|/*&n; *  linux/arch/m68k/kernel/traps.c&n; *&n; *  Copyright (C) 1993, 1994 by Hamish Macdonald&n; *&n; *  68040 fixes by Michael Rausch&n; *  68040 fixes by Martin Apel&n; *  68040 fixes and writeback by Richard Zidlicky&n; *  68060 fixes by Roman Hodek&n; *  68060 fixes by Jesper Skov&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file COPYING in the main directory of this archive&n; * for more details.&n; */
multiline_comment|/*&n; * Sets up all exception vectors&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/a.out.h&gt;
macro_line|#include &lt;linux/user.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/linkage.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/setup.h&gt;
macro_line|#include &lt;asm/fpu.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/traps.h&gt;
macro_line|#include &lt;asm/pgalloc.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/siginfo.h&gt;
multiline_comment|/* assembler routines */
id|asmlinkage
r_void
id|system_call
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|buserr
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|trap
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|inthandler
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|nmihandler
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_M68KFPU_EMU
id|asmlinkage
r_void
id|fpu_emu
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
DECL|variable|vectors
id|e_vector
id|vectors
(braket
l_int|256
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
id|buserr
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|inthandler
comma
id|inthandler
comma
id|inthandler
comma
id|inthandler
comma
id|inthandler
comma
id|inthandler
comma
id|inthandler
comma
id|inthandler
comma
multiline_comment|/* TRAP #0-15 */
id|system_call
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
)brace
suffix:semicolon
multiline_comment|/* nmi handler for the Amiga */
id|asm
c_func
(paren
l_string|&quot;.text&bslash;n&quot;
id|__ALIGN_STR
l_string|&quot;&bslash;n&quot;
id|SYMBOL_NAME_STR
c_func
(paren
id|nmihandler
)paren
l_string|&quot;: rte&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * this must be called very early as the kernel might&n; * use some instruction that are emulated on the 060&n; */
DECL|function|base_trap_init
r_void
id|__init
id|base_trap_init
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* setup the exception vector table */
id|__asm__
r_volatile
(paren
l_string|&quot;movec %0,%%vbr&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
(paren
r_void
op_star
)paren
id|vectors
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CPU_IS_060
)paren
(brace
multiline_comment|/* set up ISP entry points */
id|asmlinkage
r_void
id|unimp_vec
c_func
(paren
r_void
)paren
id|asm
(paren
l_string|&quot;_060_isp_unimp&quot;
)paren
suffix:semicolon
id|vectors
(braket
id|VEC_UNIMPII
)braket
op_assign
id|unimp_vec
suffix:semicolon
)brace
)brace
DECL|function|trap_init
r_void
id|__init
id|trap_init
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|48
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|vectors
(braket
id|i
)braket
)paren
id|vectors
(braket
id|i
)braket
op_assign
id|trap
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|64
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_increment
)paren
id|vectors
(braket
id|i
)braket
op_assign
id|inthandler
suffix:semicolon
macro_line|#ifdef CONFIG_M68KFPU_EMU
r_if
c_cond
(paren
id|FPU_IS_EMU
)paren
id|vectors
(braket
id|VEC_LINE11
)braket
op_assign
id|fpu_emu
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|CPU_IS_040
op_logical_and
op_logical_neg
id|FPU_IS_EMU
)paren
(brace
multiline_comment|/* set up FPSP entry points */
id|asmlinkage
r_void
id|dz_vec
c_func
(paren
r_void
)paren
id|asm
(paren
l_string|&quot;dz&quot;
)paren
suffix:semicolon
id|asmlinkage
r_void
id|inex_vec
c_func
(paren
r_void
)paren
id|asm
(paren
l_string|&quot;inex&quot;
)paren
suffix:semicolon
id|asmlinkage
r_void
id|ovfl_vec
c_func
(paren
r_void
)paren
id|asm
(paren
l_string|&quot;ovfl&quot;
)paren
suffix:semicolon
id|asmlinkage
r_void
id|unfl_vec
c_func
(paren
r_void
)paren
id|asm
(paren
l_string|&quot;unfl&quot;
)paren
suffix:semicolon
id|asmlinkage
r_void
id|snan_vec
c_func
(paren
r_void
)paren
id|asm
(paren
l_string|&quot;snan&quot;
)paren
suffix:semicolon
id|asmlinkage
r_void
id|operr_vec
c_func
(paren
r_void
)paren
id|asm
(paren
l_string|&quot;operr&quot;
)paren
suffix:semicolon
id|asmlinkage
r_void
id|bsun_vec
c_func
(paren
r_void
)paren
id|asm
(paren
l_string|&quot;bsun&quot;
)paren
suffix:semicolon
id|asmlinkage
r_void
id|fline_vec
c_func
(paren
r_void
)paren
id|asm
(paren
l_string|&quot;fline&quot;
)paren
suffix:semicolon
id|asmlinkage
r_void
id|unsupp_vec
c_func
(paren
r_void
)paren
id|asm
(paren
l_string|&quot;unsupp&quot;
)paren
suffix:semicolon
id|vectors
(braket
id|VEC_FPDIVZ
)braket
op_assign
id|dz_vec
suffix:semicolon
id|vectors
(braket
id|VEC_FPIR
)braket
op_assign
id|inex_vec
suffix:semicolon
id|vectors
(braket
id|VEC_FPOVER
)braket
op_assign
id|ovfl_vec
suffix:semicolon
id|vectors
(braket
id|VEC_FPUNDER
)braket
op_assign
id|unfl_vec
suffix:semicolon
id|vectors
(braket
id|VEC_FPNAN
)braket
op_assign
id|snan_vec
suffix:semicolon
id|vectors
(braket
id|VEC_FPOE
)braket
op_assign
id|operr_vec
suffix:semicolon
id|vectors
(braket
id|VEC_FPBRUC
)braket
op_assign
id|bsun_vec
suffix:semicolon
id|vectors
(braket
id|VEC_LINE11
)braket
op_assign
id|fline_vec
suffix:semicolon
id|vectors
(braket
id|VEC_FPUNSUP
)braket
op_assign
id|unsupp_vec
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CPU_IS_060
op_logical_and
op_logical_neg
id|FPU_IS_EMU
)paren
(brace
multiline_comment|/* set up IFPSP entry points */
id|asmlinkage
r_void
id|snan_vec
c_func
(paren
r_void
)paren
id|asm
(paren
l_string|&quot;_060_fpsp_snan&quot;
)paren
suffix:semicolon
id|asmlinkage
r_void
id|operr_vec
c_func
(paren
r_void
)paren
id|asm
(paren
l_string|&quot;_060_fpsp_operr&quot;
)paren
suffix:semicolon
id|asmlinkage
r_void
id|ovfl_vec
c_func
(paren
r_void
)paren
id|asm
(paren
l_string|&quot;_060_fpsp_ovfl&quot;
)paren
suffix:semicolon
id|asmlinkage
r_void
id|unfl_vec
c_func
(paren
r_void
)paren
id|asm
(paren
l_string|&quot;_060_fpsp_unfl&quot;
)paren
suffix:semicolon
id|asmlinkage
r_void
id|dz_vec
c_func
(paren
r_void
)paren
id|asm
(paren
l_string|&quot;_060_fpsp_dz&quot;
)paren
suffix:semicolon
id|asmlinkage
r_void
id|inex_vec
c_func
(paren
r_void
)paren
id|asm
(paren
l_string|&quot;_060_fpsp_inex&quot;
)paren
suffix:semicolon
id|asmlinkage
r_void
id|fline_vec
c_func
(paren
r_void
)paren
id|asm
(paren
l_string|&quot;_060_fpsp_fline&quot;
)paren
suffix:semicolon
id|asmlinkage
r_void
id|unsupp_vec
c_func
(paren
r_void
)paren
id|asm
(paren
l_string|&quot;_060_fpsp_unsupp&quot;
)paren
suffix:semicolon
id|asmlinkage
r_void
id|effadd_vec
c_func
(paren
r_void
)paren
id|asm
(paren
l_string|&quot;_060_fpsp_effadd&quot;
)paren
suffix:semicolon
id|vectors
(braket
id|VEC_FPNAN
)braket
op_assign
id|snan_vec
suffix:semicolon
id|vectors
(braket
id|VEC_FPOE
)braket
op_assign
id|operr_vec
suffix:semicolon
id|vectors
(braket
id|VEC_FPOVER
)braket
op_assign
id|ovfl_vec
suffix:semicolon
id|vectors
(braket
id|VEC_FPUNDER
)braket
op_assign
id|unfl_vec
suffix:semicolon
id|vectors
(braket
id|VEC_FPDIVZ
)braket
op_assign
id|dz_vec
suffix:semicolon
id|vectors
(braket
id|VEC_FPIR
)braket
op_assign
id|inex_vec
suffix:semicolon
id|vectors
(braket
id|VEC_LINE11
)braket
op_assign
id|fline_vec
suffix:semicolon
id|vectors
(braket
id|VEC_FPUNSUP
)braket
op_assign
id|unsupp_vec
suffix:semicolon
id|vectors
(braket
id|VEC_UNIMPEA
)braket
op_assign
id|effadd_vec
suffix:semicolon
)brace
multiline_comment|/* if running on an amiga, make the NMI interrupt do nothing */
r_if
c_cond
(paren
id|MACH_IS_AMIGA
)paren
(brace
id|vectors
(braket
id|VEC_INT7
)braket
op_assign
id|nmihandler
suffix:semicolon
)brace
)brace
DECL|variable|vec_names
r_static
r_char
op_star
id|vec_names
(braket
)braket
op_assign
(brace
l_string|&quot;RESET SP&quot;
comma
l_string|&quot;RESET PC&quot;
comma
l_string|&quot;BUS ERROR&quot;
comma
l_string|&quot;ADDRESS ERROR&quot;
comma
l_string|&quot;ILLEGAL INSTRUCTION&quot;
comma
l_string|&quot;ZERO DIVIDE&quot;
comma
l_string|&quot;CHK&quot;
comma
l_string|&quot;TRAPcc&quot;
comma
l_string|&quot;PRIVILEGE VIOLATION&quot;
comma
l_string|&quot;TRACE&quot;
comma
l_string|&quot;LINE 1010&quot;
comma
l_string|&quot;LINE 1111&quot;
comma
l_string|&quot;UNASSIGNED RESERVED 12&quot;
comma
l_string|&quot;COPROCESSOR PROTOCOL VIOLATION&quot;
comma
l_string|&quot;FORMAT ERROR&quot;
comma
l_string|&quot;UNINITIALIZED INTERRUPT&quot;
comma
l_string|&quot;UNASSIGNED RESERVED 16&quot;
comma
l_string|&quot;UNASSIGNED RESERVED 17&quot;
comma
l_string|&quot;UNASSIGNED RESERVED 18&quot;
comma
l_string|&quot;UNASSIGNED RESERVED 19&quot;
comma
l_string|&quot;UNASSIGNED RESERVED 20&quot;
comma
l_string|&quot;UNASSIGNED RESERVED 21&quot;
comma
l_string|&quot;UNASSIGNED RESERVED 22&quot;
comma
l_string|&quot;UNASSIGNED RESERVED 23&quot;
comma
l_string|&quot;SPURIOUS INTERRUPT&quot;
comma
l_string|&quot;LEVEL 1 INT&quot;
comma
l_string|&quot;LEVEL 2 INT&quot;
comma
l_string|&quot;LEVEL 3 INT&quot;
comma
l_string|&quot;LEVEL 4 INT&quot;
comma
l_string|&quot;LEVEL 5 INT&quot;
comma
l_string|&quot;LEVEL 6 INT&quot;
comma
l_string|&quot;LEVEL 7 INT&quot;
comma
l_string|&quot;SYSCALL&quot;
comma
l_string|&quot;TRAP #1&quot;
comma
l_string|&quot;TRAP #2&quot;
comma
l_string|&quot;TRAP #3&quot;
comma
l_string|&quot;TRAP #4&quot;
comma
l_string|&quot;TRAP #5&quot;
comma
l_string|&quot;TRAP #6&quot;
comma
l_string|&quot;TRAP #7&quot;
comma
l_string|&quot;TRAP #8&quot;
comma
l_string|&quot;TRAP #9&quot;
comma
l_string|&quot;TRAP #10&quot;
comma
l_string|&quot;TRAP #11&quot;
comma
l_string|&quot;TRAP #12&quot;
comma
l_string|&quot;TRAP #13&quot;
comma
l_string|&quot;TRAP #14&quot;
comma
l_string|&quot;TRAP #15&quot;
comma
l_string|&quot;FPCP BSUN&quot;
comma
l_string|&quot;FPCP INEXACT&quot;
comma
l_string|&quot;FPCP DIV BY 0&quot;
comma
l_string|&quot;FPCP UNDERFLOW&quot;
comma
l_string|&quot;FPCP OPERAND ERROR&quot;
comma
l_string|&quot;FPCP OVERFLOW&quot;
comma
l_string|&quot;FPCP SNAN&quot;
comma
l_string|&quot;FPCP UNSUPPORTED OPERATION&quot;
comma
l_string|&quot;MMU CONFIGURATION ERROR&quot;
)brace
suffix:semicolon
macro_line|#ifndef CONFIG_SUN3
DECL|variable|space_names
r_static
r_char
op_star
id|space_names
(braket
)braket
op_assign
(brace
l_string|&quot;Space 0&quot;
comma
l_string|&quot;User Data&quot;
comma
l_string|&quot;User Program&quot;
comma
l_string|&quot;Space 3&quot;
comma
l_string|&quot;Space 4&quot;
comma
l_string|&quot;Super Data&quot;
comma
l_string|&quot;Super Program&quot;
comma
l_string|&quot;CPU&quot;
)brace
suffix:semicolon
macro_line|#else
DECL|variable|space_names
r_static
r_char
op_star
id|space_names
(braket
)braket
op_assign
(brace
l_string|&quot;Space 0&quot;
comma
l_string|&quot;User Data&quot;
comma
l_string|&quot;User Program&quot;
comma
l_string|&quot;Control&quot;
comma
l_string|&quot;Space 4&quot;
comma
l_string|&quot;Super Data&quot;
comma
l_string|&quot;Super Program&quot;
comma
l_string|&quot;CPU&quot;
)brace
suffix:semicolon
macro_line|#endif
r_void
id|die_if_kernel
c_func
(paren
r_char
op_star
comma
r_struct
id|pt_regs
op_star
comma
r_int
)paren
suffix:semicolon
id|asmlinkage
r_int
id|do_page_fault
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|address
comma
r_int
r_int
id|error_code
)paren
suffix:semicolon
r_int
id|send_fault_sig
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
id|asmlinkage
r_void
id|trap_c
c_func
(paren
r_struct
id|frame
op_star
id|fp
)paren
suffix:semicolon
macro_line|#if defined (CONFIG_M68060)
DECL|function|access_error060
r_static
r_inline
r_void
id|access_error060
(paren
r_struct
id|frame
op_star
id|fp
)paren
(brace
r_int
r_int
id|fslw
op_assign
id|fp-&gt;un.fmt4.pc
suffix:semicolon
multiline_comment|/* is really FSLW for access error */
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;fslw=%#lx, fa=%#lx&bslash;n&quot;
comma
id|fslw
comma
id|fp-&gt;un.fmt4.effaddr
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|fslw
op_amp
id|MMU060_BPE
)paren
(brace
multiline_comment|/* branch prediction error -&gt; clear branch cache */
id|__asm__
id|__volatile__
(paren
l_string|&quot;movec %/cacr,%/d0&bslash;n&bslash;t&quot;
l_string|&quot;orl   #0x00400000,%/d0&bslash;n&bslash;t&quot;
l_string|&quot;movec %/d0,%/cacr&quot;
suffix:colon
suffix:colon
suffix:colon
l_string|&quot;d0&quot;
)paren
suffix:semicolon
multiline_comment|/* return if there&squot;s no other error */
r_if
c_cond
(paren
op_logical_neg
(paren
id|fslw
op_amp
id|MMU060_ERR_BITS
)paren
op_logical_and
op_logical_neg
(paren
id|fslw
op_amp
id|MMU060_SEE
)paren
)paren
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fslw
op_amp
(paren
id|MMU060_DESC_ERR
op_or
id|MMU060_WP
op_or
id|MMU060_SP
)paren
)paren
(brace
r_int
r_int
id|errorcode
suffix:semicolon
r_int
r_int
id|addr
op_assign
id|fp-&gt;un.fmt4.effaddr
suffix:semicolon
r_if
c_cond
(paren
id|fslw
op_amp
id|MMU060_MA
)paren
id|addr
op_assign
(paren
id|addr
op_plus
l_int|7
)paren
op_amp
op_minus
l_int|8
suffix:semicolon
id|errorcode
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|fslw
op_amp
id|MMU060_DESC_ERR
)paren
(brace
id|__flush_tlb040_one
c_func
(paren
id|addr
)paren
suffix:semicolon
id|errorcode
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fslw
op_amp
id|MMU060_W
)paren
id|errorcode
op_or_assign
l_int|2
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;errorcode = %d&bslash;n&quot;
comma
id|errorcode
)paren
suffix:semicolon
macro_line|#endif
id|do_page_fault
c_func
(paren
op_amp
id|fp-&gt;ptregs
comma
id|addr
comma
id|errorcode
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fslw
op_amp
(paren
id|MMU060_SEE
)paren
)paren
(brace
multiline_comment|/* Software Emulation Error.&n;&t;&t; * fault during mem_read/mem_write in ifpsp060/os.S&n;&t;&t; */
id|send_fault_sig
c_func
(paren
op_amp
id|fp-&gt;ptregs
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;pc=%#lx, fa=%#lx&bslash;n&quot;
comma
id|fp-&gt;ptregs.pc
comma
id|fp-&gt;un.fmt4.effaddr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;68060 access error, fslw=%lx&bslash;n&quot;
comma
id|fslw
)paren
suffix:semicolon
id|trap_c
c_func
(paren
id|fp
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif /* CONFIG_M68060 */
macro_line|#if defined (CONFIG_M68040)
DECL|function|probe040
r_static
r_inline
r_int
r_int
id|probe040
c_func
(paren
r_int
id|iswrite
comma
r_int
r_int
id|addr
)paren
(brace
r_int
r_int
id|mmusr
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;.chip 68040&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iswrite
)paren
id|asm
r_volatile
(paren
l_string|&quot;ptestw (%0)&quot;
suffix:colon
suffix:colon
l_string|&quot;a&quot;
(paren
id|addr
)paren
)paren
suffix:semicolon
r_else
id|asm
r_volatile
(paren
l_string|&quot;ptestr (%0)&quot;
suffix:colon
suffix:colon
l_string|&quot;a&quot;
(paren
id|addr
)paren
)paren
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;movec %%mmusr,%0&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|mmusr
)paren
)paren
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;.chip 68k&quot;
)paren
suffix:semicolon
r_return
id|mmusr
suffix:semicolon
)brace
DECL|function|do_040writeback1
r_static
r_inline
r_int
id|do_040writeback1
c_func
(paren
r_int
r_int
id|wbs
comma
r_int
r_int
id|wba
comma
r_int
r_int
id|wbd
)paren
(brace
r_int
id|res
op_assign
l_int|0
suffix:semicolon
id|set_fs
c_func
(paren
id|MAKE_MM_SEG
c_func
(paren
id|wbs
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|wbs
op_amp
id|WBSIZ_040
)paren
(brace
r_case
id|BA_SIZE_BYTE
suffix:colon
id|res
op_assign
id|put_user
c_func
(paren
id|wbd
op_amp
l_int|0xff
comma
(paren
r_char
op_star
)paren
id|wba
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BA_SIZE_WORD
suffix:colon
id|res
op_assign
id|put_user
c_func
(paren
id|wbd
op_amp
l_int|0xffff
comma
(paren
r_int
op_star
)paren
id|wba
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BA_SIZE_LONG
suffix:colon
id|res
op_assign
id|put_user
c_func
(paren
id|wbd
comma
(paren
r_int
op_star
)paren
id|wba
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;do_040writeback1, res=%d&bslash;n&quot;
comma
id|res
)paren
suffix:semicolon
macro_line|#endif
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/* after an exception in a writeback the stack frame coresponding&n; * to that exception is discarded, set a few bits in the old frame &n; * to simulate what it should look like&n; */
DECL|function|fix_xframe040
r_static
r_inline
r_void
id|fix_xframe040
c_func
(paren
r_struct
id|frame
op_star
id|fp
comma
r_int
r_int
id|wbs
)paren
(brace
id|fp-&gt;un.fmt7.faddr
op_assign
id|current-&gt;thread.faddr
suffix:semicolon
id|fp-&gt;un.fmt7.ssw
op_assign
id|wbs
op_amp
l_int|0xff
suffix:semicolon
)brace
DECL|function|do_040writebacks
r_static
r_inline
r_void
id|do_040writebacks
c_func
(paren
r_struct
id|frame
op_star
id|fp
)paren
(brace
r_int
id|res
op_assign
l_int|0
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|fp-&gt;un.fmt7.wb1s
op_amp
id|WBV_040
)paren
id|printk
c_func
(paren
l_string|&quot;access_error040: cannot handle 1st writeback. oops.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|fp-&gt;un.fmt7.wb2s
op_amp
id|WBV_040
)paren
op_logical_and
op_logical_neg
(paren
id|fp-&gt;un.fmt7.wb2s
op_amp
id|WBTT_040
)paren
)paren
(brace
id|res
op_assign
id|do_040writeback1
c_func
(paren
id|fp-&gt;un.fmt7.wb2s
comma
id|fp-&gt;un.fmt7.wb2a
comma
id|fp-&gt;un.fmt7.wb2d
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
id|fix_xframe040
c_func
(paren
id|fp
comma
id|fp-&gt;un.fmt7.wb2s
)paren
suffix:semicolon
r_else
id|fp-&gt;un.fmt7.wb2s
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* do the 2nd wb only if the first one was succesful (except for a kernel wb) */
r_if
c_cond
(paren
id|fp-&gt;un.fmt7.wb3s
op_amp
id|WBV_040
op_logical_and
(paren
op_logical_neg
id|res
op_logical_or
id|fp-&gt;un.fmt7.wb3s
op_amp
l_int|4
)paren
)paren
(brace
id|res
op_assign
id|do_040writeback1
c_func
(paren
id|fp-&gt;un.fmt7.wb3s
comma
id|fp-&gt;un.fmt7.wb3a
comma
id|fp-&gt;un.fmt7.wb3d
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
id|fix_xframe040
c_func
(paren
id|fp
comma
id|fp-&gt;un.fmt7.wb3s
)paren
suffix:semicolon
r_else
id|fp-&gt;un.fmt7.wb3s
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|res
)paren
id|send_fault_sig
c_func
(paren
op_amp
id|fp-&gt;ptregs
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * called from sigreturn(), must ensure userspace code didn&squot;t&n; * manipulate exception frame to circumvent protection, then complete&n; * pending writebacks&n; * we just clear TM2 to turn it into an userspace access&n; */
DECL|function|berr_040cleanup
id|asmlinkage
r_void
id|berr_040cleanup
c_func
(paren
r_struct
id|frame
op_star
id|fp
)paren
(brace
id|mm_segment_t
id|old_fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|fp-&gt;un.fmt7.wb2s
op_and_assign
op_complement
l_int|4
suffix:semicolon
id|fp-&gt;un.fmt7.wb3s
op_and_assign
op_complement
l_int|4
suffix:semicolon
id|do_040writebacks
c_func
(paren
id|fp
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|old_fs
)paren
suffix:semicolon
)brace
DECL|function|access_error040
r_static
r_inline
r_void
id|access_error040
c_func
(paren
r_struct
id|frame
op_star
id|fp
)paren
(brace
r_int
r_int
id|ssw
op_assign
id|fp-&gt;un.fmt7.ssw
suffix:semicolon
id|mm_segment_t
id|old_fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
r_int
r_int
id|mmusr
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;ssw=%#x, fa=%#lx&bslash;n&quot;
comma
id|ssw
comma
id|fp-&gt;un.fmt7.faddr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;wb1s=%#x, wb2s=%#x, wb3s=%#x&bslash;n&quot;
comma
id|fp-&gt;un.fmt7.wb1s
comma
id|fp-&gt;un.fmt7.wb2s
comma
id|fp-&gt;un.fmt7.wb3s
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;wb2a=%lx, wb3a=%lx, wb2d=%lx, wb3d=%lx&bslash;n&quot;
comma
id|fp-&gt;un.fmt7.wb2a
comma
id|fp-&gt;un.fmt7.wb3a
comma
id|fp-&gt;un.fmt7.wb2d
comma
id|fp-&gt;un.fmt7.wb3d
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ssw
op_amp
id|ATC_040
)paren
(brace
r_int
r_int
id|addr
op_assign
id|fp-&gt;un.fmt7.faddr
suffix:semicolon
r_int
r_int
id|errorcode
suffix:semicolon
multiline_comment|/*&n;&t;&t; * The MMU status has to be determined AFTER the address&n;&t;&t; * has been corrected if there was a misaligned access (MA).&n;&t;&t; */
r_if
c_cond
(paren
id|ssw
op_amp
id|MA_040
)paren
id|addr
op_assign
(paren
id|addr
op_plus
l_int|7
)paren
op_amp
op_minus
l_int|8
suffix:semicolon
id|set_fs
c_func
(paren
id|MAKE_MM_SEG
c_func
(paren
id|ssw
)paren
)paren
suffix:semicolon
multiline_comment|/* MMU error, get the MMUSR info for this access */
id|mmusr
op_assign
id|probe040
c_func
(paren
op_logical_neg
(paren
id|ssw
op_amp
id|RW_040
)paren
comma
id|addr
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;mmusr = %lx&bslash;n&quot;
comma
id|mmusr
)paren
suffix:semicolon
macro_line|#endif
id|errorcode
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mmusr
op_amp
id|MMU_R_040
)paren
)paren
(brace
multiline_comment|/* clear the invalid atc entry */
id|__flush_tlb040_one
c_func
(paren
id|addr
)paren
suffix:semicolon
id|errorcode
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|ssw
op_amp
id|RW_040
)paren
)paren
id|errorcode
op_or_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|do_page_fault
c_func
(paren
op_amp
id|fp-&gt;ptregs
comma
id|addr
comma
id|errorcode
)paren
)paren
(brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;do_page_fault() !=0 &bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|user_mode
c_func
(paren
op_amp
id|fp-&gt;ptregs
)paren
)paren
(brace
multiline_comment|/* delay writebacks after signal delivery */
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;.. was usermode - return&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
multiline_comment|/* disable writeback into user space from kernel&n;&t;&t;&t; * (if do_page_fault didn&squot;t fix the mapping,&n;                         * the writeback won&squot;t do good)&n;&t;&t;&t; */
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;.. disabling wb2&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|fp-&gt;un.fmt7.wb2a
op_eq
id|fp-&gt;un.fmt7.faddr
)paren
id|fp-&gt;un.fmt7.wb2s
op_and_assign
op_complement
id|WBV_040
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;68040 access error, ssw=%x&bslash;n&quot;
comma
id|ssw
)paren
suffix:semicolon
id|trap_c
c_func
(paren
id|fp
)paren
suffix:semicolon
)brace
id|do_040writebacks
c_func
(paren
id|fp
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|old_fs
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_M68040 */
macro_line|#if defined(CONFIG_SUN3)
macro_line|#include &lt;asm/sun3mmu.h&gt;
r_extern
r_int
id|mmu_emu_handle_fault
(paren
r_int
r_int
comma
r_int
comma
r_int
)paren
suffix:semicolon
multiline_comment|/* sun3 version of bus_error030 */
DECL|function|bus_error030
r_extern
r_inline
r_void
id|bus_error030
(paren
r_struct
id|frame
op_star
id|fp
)paren
(brace
r_int
r_char
id|buserr_type
op_assign
id|sun3_get_buserr
(paren
)paren
suffix:semicolon
r_int
r_int
id|addr
comma
id|errorcode
suffix:semicolon
r_int
r_int
id|ssw
op_assign
id|fp-&gt;un.fmtb.ssw
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|ssw
op_amp
(paren
id|FC
op_or
id|FB
)paren
)paren
id|printk
(paren
l_string|&quot;Instruction fault at %#010lx&bslash;n&quot;
comma
id|ssw
op_amp
id|FC
ques
c_cond
id|fp-&gt;ptregs.format
op_eq
l_int|0xa
ques
c_cond
id|fp-&gt;ptregs.pc
op_plus
l_int|2
suffix:colon
id|fp-&gt;un.fmtb.baddr
op_minus
l_int|2
suffix:colon
id|fp-&gt;ptregs.format
op_eq
l_int|0xa
ques
c_cond
id|fp-&gt;ptregs.pc
op_plus
l_int|4
suffix:colon
id|fp-&gt;un.fmtb.baddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ssw
op_amp
id|DF
)paren
id|printk
(paren
l_string|&quot;Data %s fault at %#010lx in %s (pc=%#lx)&bslash;n&quot;
comma
id|ssw
op_amp
id|RW
ques
c_cond
l_string|&quot;read&quot;
suffix:colon
l_string|&quot;write&quot;
comma
id|fp-&gt;un.fmtb.daddr
comma
id|space_names
(braket
id|ssw
op_amp
id|DFC
)braket
comma
id|fp-&gt;ptregs.pc
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * Check if this page should be demand-mapped. This needs to go before&n;&t; * the testing for a bad kernel-space access (demand-mapping applies&n;&t; * to kernel accesses too).&n;&t; */
r_if
c_cond
(paren
(paren
id|ssw
op_amp
id|DF
)paren
op_logical_and
(paren
id|buserr_type
op_amp
(paren
id|SUN3_BUSERR_PROTERR
op_or
id|SUN3_BUSERR_INVALID
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|mmu_emu_handle_fault
(paren
id|fp-&gt;un.fmtb.daddr
comma
id|ssw
op_amp
id|RW
comma
l_int|0
)paren
)paren
r_return
suffix:semicolon
)brace
multiline_comment|/* Check for kernel-space pagefault (BAD). */
r_if
c_cond
(paren
id|fp-&gt;ptregs.sr
op_amp
id|PS_S
)paren
(brace
multiline_comment|/* kernel fault must be a data fault to user space */
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|ssw
op_amp
id|DF
)paren
op_logical_and
(paren
(paren
id|ssw
op_amp
id|DFC
)paren
op_eq
id|USER_DATA
)paren
)paren
)paren
(brace
singleline_comment|// try checking the kernel mappings before surrender
r_if
c_cond
(paren
id|mmu_emu_handle_fault
(paren
id|fp-&gt;un.fmtb.daddr
comma
id|ssw
op_amp
id|RW
comma
l_int|1
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* instruction fault or kernel data fault! */
r_if
c_cond
(paren
id|ssw
op_amp
(paren
id|FC
op_or
id|FB
)paren
)paren
id|printk
(paren
l_string|&quot;Instruction fault at %#010lx&bslash;n&quot;
comma
id|fp-&gt;ptregs.pc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ssw
op_amp
id|DF
)paren
(brace
id|printk
(paren
l_string|&quot;Data %s fault at %#010lx in %s (pc=%#lx)&bslash;n&quot;
comma
id|ssw
op_amp
id|RW
ques
c_cond
l_string|&quot;read&quot;
suffix:colon
l_string|&quot;write&quot;
comma
id|fp-&gt;un.fmtb.daddr
comma
id|space_names
(braket
id|ssw
op_amp
id|DFC
)braket
comma
id|fp-&gt;ptregs.pc
)paren
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot;BAD KERNEL BUSERR&bslash;n&quot;
)paren
suffix:semicolon
id|die_if_kernel
c_func
(paren
l_string|&quot;Oops&quot;
comma
op_amp
id|fp-&gt;ptregs
comma
l_int|0
)paren
suffix:semicolon
id|force_sig
c_func
(paren
id|SIGKILL
comma
id|current
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* user fault */
r_if
c_cond
(paren
op_logical_neg
(paren
id|ssw
op_amp
(paren
id|FC
op_or
id|FB
)paren
)paren
op_logical_and
op_logical_neg
(paren
id|ssw
op_amp
id|DF
)paren
)paren
multiline_comment|/* not an instruction fault or data fault! BAD */
id|panic
(paren
l_string|&quot;USER BUSERR w/o instruction or data fault&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* First handle the data fault, if any.  */
r_if
c_cond
(paren
id|ssw
op_amp
id|DF
)paren
(brace
id|addr
op_assign
id|fp-&gt;un.fmtb.daddr
suffix:semicolon
singleline_comment|// errorcode bit 0:&t;0 -&gt; no page&t;&t;1 -&gt; protection fault
singleline_comment|// errorcode bit 1:&t;0 -&gt; read fault&t;&t;1 -&gt; write fault
singleline_comment|// (buserr_type &amp; SUN3_BUSERR_PROTERR)&t;-&gt; protection fault
singleline_comment|// (buserr_type &amp; SUN3_BUSERR_INVALID)&t;-&gt; invalid page fault
r_if
c_cond
(paren
id|buserr_type
op_amp
id|SUN3_BUSERR_PROTERR
)paren
id|errorcode
op_assign
l_int|0x01
suffix:semicolon
r_else
r_if
c_cond
(paren
id|buserr_type
op_amp
id|SUN3_BUSERR_INVALID
)paren
id|errorcode
op_assign
l_int|0x00
suffix:semicolon
r_else
(brace
macro_line|#ifdef DEBUG
id|printk
(paren
l_string|&quot;*** unexpected busfault type=%#04x&bslash;n&quot;
comma
id|buserr_type
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;invalid %s access at %#lx from pc %#lx&bslash;n&quot;
comma
op_logical_neg
(paren
id|ssw
op_amp
id|RW
)paren
ques
c_cond
l_string|&quot;write&quot;
suffix:colon
l_string|&quot;read&quot;
comma
id|addr
comma
id|fp-&gt;ptregs.pc
)paren
suffix:semicolon
macro_line|#endif
id|die_if_kernel
(paren
l_string|&quot;Oops&quot;
comma
op_amp
id|fp-&gt;ptregs
comma
id|buserr_type
)paren
suffix:semicolon
id|force_sig
(paren
id|SIGBUS
comma
id|current
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
singleline_comment|//todo: wtf is RM bit? --m
r_if
c_cond
(paren
op_logical_neg
(paren
id|ssw
op_amp
id|RW
)paren
op_logical_or
id|ssw
op_amp
id|RM
)paren
id|errorcode
op_or_assign
l_int|0x02
suffix:semicolon
multiline_comment|/* Handle page fault. */
id|do_page_fault
(paren
op_amp
id|fp-&gt;ptregs
comma
id|addr
comma
id|errorcode
)paren
suffix:semicolon
multiline_comment|/* Retry the data fault now. */
r_return
suffix:semicolon
)brace
multiline_comment|/* Now handle the instruction fault. */
multiline_comment|/* Get the fault address. */
r_if
c_cond
(paren
id|fp-&gt;ptregs.format
op_eq
l_int|0xA
)paren
id|addr
op_assign
id|fp-&gt;ptregs.pc
op_plus
l_int|4
suffix:semicolon
r_else
id|addr
op_assign
id|fp-&gt;un.fmtb.baddr
suffix:semicolon
r_if
c_cond
(paren
id|ssw
op_amp
id|FC
)paren
id|addr
op_sub_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|buserr_type
op_amp
id|SUN3_BUSERR_INVALID
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|mmu_emu_handle_fault
(paren
id|fp-&gt;un.fmtb.daddr
comma
l_int|1
comma
l_int|0
)paren
)paren
id|do_page_fault
(paren
op_amp
id|fp-&gt;ptregs
comma
id|addr
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
macro_line|#ifdef DEBUG
id|printk
(paren
l_string|&quot;protection fault on insn access (segv).&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|force_sig
(paren
id|SIGSEGV
comma
id|current
)paren
suffix:semicolon
)brace
)brace
macro_line|#else
macro_line|#if defined(CPU_M68020_OR_M68030)
DECL|function|bus_error030
r_static
r_inline
r_void
id|bus_error030
(paren
r_struct
id|frame
op_star
id|fp
)paren
(brace
r_volatile
r_int
r_int
id|temp
suffix:semicolon
r_int
r_int
id|mmusr
suffix:semicolon
r_int
r_int
id|addr
comma
id|errorcode
suffix:semicolon
r_int
r_int
id|ssw
op_assign
id|fp-&gt;un.fmtb.ssw
suffix:semicolon
r_int
id|user_space_fault
op_assign
l_int|1
suffix:semicolon
macro_line|#if DEBUG
r_int
r_int
id|desc
suffix:semicolon
macro_line|#endif
macro_line|#if DEBUG
id|printk
(paren
l_string|&quot;pid = %x  &quot;
comma
id|current-&gt;pid
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;SSW=%#06x  &quot;
comma
id|ssw
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ssw
op_amp
(paren
id|FC
op_or
id|FB
)paren
)paren
id|printk
(paren
l_string|&quot;Instruction fault at %#010lx&bslash;n&quot;
comma
id|ssw
op_amp
id|FC
ques
c_cond
id|fp-&gt;ptregs.format
op_eq
l_int|0xa
ques
c_cond
id|fp-&gt;ptregs.pc
op_plus
l_int|2
suffix:colon
id|fp-&gt;un.fmtb.baddr
op_minus
l_int|2
suffix:colon
id|fp-&gt;ptregs.format
op_eq
l_int|0xa
ques
c_cond
id|fp-&gt;ptregs.pc
op_plus
l_int|4
suffix:colon
id|fp-&gt;un.fmtb.baddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ssw
op_amp
id|DF
)paren
id|printk
(paren
l_string|&quot;Data %s fault at %#010lx in %s (pc=%#lx)&bslash;n&quot;
comma
id|ssw
op_amp
id|RW
ques
c_cond
l_string|&quot;read&quot;
suffix:colon
l_string|&quot;write&quot;
comma
id|fp-&gt;un.fmtb.daddr
comma
id|space_names
(braket
id|ssw
op_amp
id|DFC
)braket
comma
id|fp-&gt;ptregs.pc
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|fp-&gt;ptregs.sr
op_amp
id|PS_S
)paren
(brace
multiline_comment|/* kernel fault must be a data fault to user space */
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|ssw
op_amp
id|DF
)paren
op_logical_and
(paren
(paren
id|ssw
op_amp
id|DFC
)paren
op_eq
id|USER_DATA
)paren
)paren
)paren
(brace
multiline_comment|/* instruction fault or kernel data fault! */
r_if
c_cond
(paren
id|ssw
op_amp
(paren
id|FC
op_or
id|FB
)paren
)paren
id|printk
(paren
l_string|&quot;Instruction fault at %#010lx&bslash;n&quot;
comma
id|fp-&gt;ptregs.pc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ssw
op_amp
id|DF
)paren
(brace
id|printk
(paren
l_string|&quot;Data %s fault at %#010lx in %s (pc=%#lx)&bslash;n&quot;
comma
id|ssw
op_amp
id|RW
ques
c_cond
l_string|&quot;read&quot;
suffix:colon
l_string|&quot;write&quot;
comma
id|fp-&gt;un.fmtb.daddr
comma
id|space_names
(braket
id|ssw
op_amp
id|DFC
)braket
comma
id|fp-&gt;ptregs.pc
)paren
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot;BAD KERNEL BUSERR&bslash;n&quot;
)paren
suffix:semicolon
id|die_if_kernel
c_func
(paren
l_string|&quot;Oops&quot;
comma
op_amp
id|fp-&gt;ptregs
comma
l_int|0
)paren
suffix:semicolon
id|force_sig
c_func
(paren
id|SIGKILL
comma
id|current
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* user fault */
r_if
c_cond
(paren
op_logical_neg
(paren
id|ssw
op_amp
(paren
id|FC
op_or
id|FB
)paren
)paren
op_logical_and
op_logical_neg
(paren
id|ssw
op_amp
id|DF
)paren
)paren
multiline_comment|/* not an instruction fault or data fault! BAD */
id|panic
(paren
l_string|&quot;USER BUSERR w/o instruction or data fault&quot;
)paren
suffix:semicolon
id|user_space_fault
op_assign
l_int|1
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;User space bus-error&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* ++andreas: If a data fault and an instruction fault happen&n;&t;   at the same time map in both pages.  */
multiline_comment|/* First handle the data fault, if any.  */
r_if
c_cond
(paren
id|ssw
op_amp
id|DF
)paren
(brace
id|addr
op_assign
id|fp-&gt;un.fmtb.daddr
suffix:semicolon
id|mmusr
op_assign
id|MMU_I
suffix:semicolon
r_if
c_cond
(paren
id|user_space_fault
)paren
(brace
macro_line|#if DEBUG
id|asm
r_volatile
(paren
l_string|&quot;ptestr #1,%2@,#7,%0&bslash;n&bslash;t&quot;
l_string|&quot;pmove %/psr,%1@&quot;
suffix:colon
l_string|&quot;=a&amp;&quot;
(paren
id|desc
)paren
suffix:colon
l_string|&quot;a&quot;
(paren
op_amp
id|temp
)paren
comma
l_string|&quot;a&quot;
(paren
id|addr
)paren
)paren
suffix:semicolon
macro_line|#else
id|asm
r_volatile
(paren
l_string|&quot;ptestr #1,%1@,#7&bslash;n&bslash;t&quot;
l_string|&quot;pmove %/psr,%0@&quot;
suffix:colon
suffix:colon
l_string|&quot;a&quot;
(paren
op_amp
id|temp
)paren
comma
l_string|&quot;a&quot;
(paren
id|addr
)paren
)paren
suffix:semicolon
macro_line|#endif
id|mmusr
op_assign
id|temp
suffix:semicolon
)brace
macro_line|#if DEBUG
id|printk
(paren
l_string|&quot;mmusr is %#x for addr %#lx in task %p&bslash;n&quot;
comma
id|mmusr
comma
id|addr
comma
id|current
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;descriptor address is %#lx, contents %#lx&bslash;n&quot;
comma
id|__va
c_func
(paren
id|desc
)paren
comma
op_star
(paren
r_int
r_int
op_star
)paren
id|__va
c_func
(paren
id|desc
)paren
)paren
suffix:semicolon
macro_line|#endif
id|errorcode
op_assign
(paren
id|mmusr
op_amp
id|MMU_I
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ssw
op_amp
id|RW
)paren
op_logical_or
(paren
id|ssw
op_amp
id|RM
)paren
)paren
id|errorcode
op_or_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|mmusr
op_amp
(paren
id|MMU_I
op_or
id|MMU_WP
)paren
)paren
(brace
multiline_comment|/* Don&squot;t try to do anything further if an exception was&n;&t;&t;   handled. */
r_if
c_cond
(paren
id|do_page_fault
(paren
op_amp
id|fp-&gt;ptregs
comma
id|addr
comma
id|errorcode
)paren
OL
l_int|0
)paren
r_return
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mmusr
op_amp
(paren
id|MMU_B
op_or
id|MMU_L
op_or
id|MMU_S
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;invalid %s access at %#lx from pc %#lx&bslash;n&quot;
comma
op_logical_neg
(paren
id|ssw
op_amp
id|RW
)paren
ques
c_cond
l_string|&quot;write&quot;
suffix:colon
l_string|&quot;read&quot;
comma
id|addr
comma
id|fp-&gt;ptregs.pc
)paren
suffix:semicolon
id|die_if_kernel
c_func
(paren
l_string|&quot;Oops&quot;
comma
op_amp
id|fp-&gt;ptregs
comma
id|mmusr
)paren
suffix:semicolon
id|force_sig
c_func
(paren
id|SIGSEGV
comma
id|current
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
(brace
macro_line|#if 0
r_static
r_volatile
r_int
id|tlong
suffix:semicolon
macro_line|#endif
id|printk
(paren
l_string|&quot;weird %s access at %#lx from pc %#lx (ssw is %#x)&bslash;n&quot;
comma
op_logical_neg
(paren
id|ssw
op_amp
id|RW
)paren
ques
c_cond
l_string|&quot;write&quot;
suffix:colon
l_string|&quot;read&quot;
comma
id|addr
comma
id|fp-&gt;ptregs.pc
comma
id|ssw
)paren
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;ptestr #1,%1@,#0&bslash;n&bslash;t&quot;
l_string|&quot;pmove %/psr,%0@&quot;
suffix:colon
multiline_comment|/* no outputs */
suffix:colon
l_string|&quot;a&quot;
(paren
op_amp
id|temp
)paren
comma
l_string|&quot;a&quot;
(paren
id|addr
)paren
)paren
suffix:semicolon
id|mmusr
op_assign
id|temp
suffix:semicolon
id|printk
(paren
l_string|&quot;level 0 mmusr is %#x&bslash;n&quot;
comma
id|mmusr
)paren
suffix:semicolon
macro_line|#if 0
id|asm
r_volatile
(paren
l_string|&quot;pmove %/tt0,%0@&quot;
suffix:colon
multiline_comment|/* no outputs */
suffix:colon
l_string|&quot;a&quot;
(paren
op_amp
id|tlong
)paren
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;tt0 is %#lx, &quot;
comma
id|tlong
)paren
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;pmove %/tt1,%0@&quot;
suffix:colon
multiline_comment|/* no outputs */
suffix:colon
l_string|&quot;a&quot;
(paren
op_amp
id|tlong
)paren
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;tt1 is %#lx&bslash;n&quot;
comma
id|tlong
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;Unknown SIGSEGV - 1&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|die_if_kernel
c_func
(paren
l_string|&quot;Oops&quot;
comma
op_amp
id|fp-&gt;ptregs
comma
id|mmusr
)paren
suffix:semicolon
id|force_sig
c_func
(paren
id|SIGSEGV
comma
id|current
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* setup an ATC entry for the access about to be retried */
r_if
c_cond
(paren
op_logical_neg
(paren
id|ssw
op_amp
id|RW
)paren
)paren
id|asm
r_volatile
(paren
l_string|&quot;ploadw %1,%0@&quot;
suffix:colon
multiline_comment|/* no outputs */
suffix:colon
l_string|&quot;a&quot;
(paren
id|addr
)paren
comma
l_string|&quot;d&quot;
(paren
id|ssw
)paren
)paren
suffix:semicolon
r_else
id|asm
r_volatile
(paren
l_string|&quot;ploadr %1,%0@&quot;
suffix:colon
multiline_comment|/* no outputs */
suffix:colon
l_string|&quot;a&quot;
(paren
id|addr
)paren
comma
l_string|&quot;d&quot;
(paren
id|ssw
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Now handle the instruction fault. */
r_if
c_cond
(paren
op_logical_neg
(paren
id|ssw
op_amp
(paren
id|FC
op_or
id|FB
)paren
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* get the fault address */
r_if
c_cond
(paren
id|fp-&gt;ptregs.format
op_eq
l_int|10
)paren
id|addr
op_assign
id|fp-&gt;ptregs.pc
op_plus
l_int|4
suffix:semicolon
r_else
id|addr
op_assign
id|fp-&gt;un.fmtb.baddr
suffix:semicolon
r_if
c_cond
(paren
id|ssw
op_amp
id|FC
)paren
id|addr
op_sub_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ssw
op_amp
id|DF
)paren
op_logical_and
(paren
(paren
id|addr
op_xor
id|fp-&gt;un.fmtb.daddr
)paren
op_amp
id|PAGE_MASK
)paren
op_eq
l_int|0
)paren
multiline_comment|/* Insn fault on same page as data fault.  But we&n;&t;&t;   should still create the ATC entry.  */
r_goto
id|create_atc_entry
suffix:semicolon
id|mmusr
op_assign
id|MMU_I
suffix:semicolon
r_if
c_cond
(paren
id|user_space_fault
)paren
(brace
macro_line|#if DEBUG
id|asm
r_volatile
(paren
l_string|&quot;ptestr #1,%2@,#7,%0&bslash;n&bslash;t&quot;
l_string|&quot;pmove %/psr,%1@&quot;
suffix:colon
l_string|&quot;=a&amp;&quot;
(paren
id|desc
)paren
suffix:colon
l_string|&quot;a&quot;
(paren
op_amp
id|temp
)paren
comma
l_string|&quot;a&quot;
(paren
id|addr
)paren
)paren
suffix:semicolon
macro_line|#else
id|asm
r_volatile
(paren
l_string|&quot;ptestr #1,%1@,#7&bslash;n&bslash;t&quot;
l_string|&quot;pmove %/psr,%0@&quot;
suffix:colon
suffix:colon
l_string|&quot;a&quot;
(paren
op_amp
id|temp
)paren
comma
l_string|&quot;a&quot;
(paren
id|addr
)paren
)paren
suffix:semicolon
macro_line|#endif
id|mmusr
op_assign
id|temp
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
id|printk
(paren
l_string|&quot;mmusr is %#x for addr %#lx in task %p&bslash;n&quot;
comma
id|mmusr
comma
id|addr
comma
id|current
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;descriptor address is %#lx, contents %#lx&bslash;n&quot;
comma
id|__va
c_func
(paren
id|desc
)paren
comma
op_star
(paren
r_int
r_int
op_star
)paren
id|__va
c_func
(paren
id|desc
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|mmusr
op_amp
id|MMU_I
)paren
id|do_page_fault
(paren
op_amp
id|fp-&gt;ptregs
comma
id|addr
comma
l_int|0
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|mmusr
op_amp
(paren
id|MMU_B
op_or
id|MMU_L
op_or
id|MMU_S
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;invalid insn access at %#lx from pc %#lx&bslash;n&quot;
comma
id|addr
comma
id|fp-&gt;ptregs.pc
)paren
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;Unknown SIGSEGV - 2&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|die_if_kernel
c_func
(paren
l_string|&quot;Oops&quot;
comma
op_amp
id|fp-&gt;ptregs
comma
id|mmusr
)paren
suffix:semicolon
id|force_sig
c_func
(paren
id|SIGSEGV
comma
id|current
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|create_atc_entry
suffix:colon
multiline_comment|/* setup an ATC entry for the access about to be retried */
id|asm
r_volatile
(paren
l_string|&quot;ploadr #2,%0@&quot;
suffix:colon
multiline_comment|/* no outputs */
suffix:colon
l_string|&quot;a&quot;
(paren
id|addr
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif /* CPU_M68020_OR_M68030 */
macro_line|#endif /* !CONFIG_SUN3 */
DECL|function|buserr_c
id|asmlinkage
r_void
id|buserr_c
c_func
(paren
r_struct
id|frame
op_star
id|fp
)paren
(brace
multiline_comment|/* Only set esp0 if coming from user mode */
r_if
c_cond
(paren
id|user_mode
c_func
(paren
op_amp
id|fp-&gt;ptregs
)paren
)paren
id|current-&gt;thread.esp0
op_assign
(paren
r_int
r_int
)paren
id|fp
suffix:semicolon
macro_line|#if DEBUG
id|printk
(paren
l_string|&quot;*** Bus Error *** Format is %x&bslash;n&quot;
comma
id|fp-&gt;ptregs.format
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|fp-&gt;ptregs.format
)paren
(brace
macro_line|#if defined (CONFIG_M68060)
r_case
l_int|4
suffix:colon
multiline_comment|/* 68060 access error */
id|access_error060
(paren
id|fp
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#if defined (CONFIG_M68040)
r_case
l_int|0x7
suffix:colon
multiline_comment|/* 68040 access error */
id|access_error040
(paren
id|fp
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#if defined (CPU_M68020_OR_M68030)
r_case
l_int|0xa
suffix:colon
r_case
l_int|0xb
suffix:colon
id|bus_error030
(paren
id|fp
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|die_if_kernel
c_func
(paren
l_string|&quot;bad frame format&quot;
comma
op_amp
id|fp-&gt;ptregs
comma
l_int|0
)paren
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;Unknown SIGSEGV - 4&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|force_sig
c_func
(paren
id|SIGSEGV
comma
id|current
)paren
suffix:semicolon
)brace
)brace
DECL|variable|kstack_depth_to_print
r_int
id|kstack_depth_to_print
op_assign
l_int|48
suffix:semicolon
multiline_comment|/* MODULE_RANGE is a guess of how much space is likely to be&n;   vmalloced.  */
DECL|macro|MODULE_RANGE
mdefine_line|#define MODULE_RANGE (8*1024*1024)
DECL|function|dump_stack
r_static
r_void
id|dump_stack
c_func
(paren
r_struct
id|frame
op_star
id|fp
)paren
(brace
r_int
r_int
op_star
id|stack
comma
op_star
id|endstack
comma
id|addr
comma
id|module_start
comma
id|module_end
suffix:semicolon
r_extern
r_char
id|_start
comma
id|_etext
suffix:semicolon
r_int
id|i
suffix:semicolon
id|addr
op_assign
(paren
r_int
r_int
)paren
op_amp
id|fp-&gt;un
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Frame format=%X &quot;
comma
id|fp-&gt;ptregs.format
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|fp-&gt;ptregs.format
)paren
(brace
r_case
l_int|0x2
suffix:colon
id|printk
c_func
(paren
l_string|&quot;instr addr=%08lx&bslash;n&quot;
comma
id|fp-&gt;un.fmt2.iaddr
)paren
suffix:semicolon
id|addr
op_add_assign
r_sizeof
(paren
id|fp-&gt;un.fmt2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x3
suffix:colon
id|printk
c_func
(paren
l_string|&quot;eff addr=%08lx&bslash;n&quot;
comma
id|fp-&gt;un.fmt3.effaddr
)paren
suffix:semicolon
id|addr
op_add_assign
r_sizeof
(paren
id|fp-&gt;un.fmt3
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x4
suffix:colon
id|printk
c_func
(paren
(paren
id|CPU_IS_060
ques
c_cond
l_string|&quot;fault addr=%08lx fslw=%08lx&bslash;n&quot;
suffix:colon
l_string|&quot;eff addr=%08lx pc=%08lx&bslash;n&quot;
)paren
comma
id|fp-&gt;un.fmt4.effaddr
comma
id|fp-&gt;un.fmt4.pc
)paren
suffix:semicolon
id|addr
op_add_assign
r_sizeof
(paren
id|fp-&gt;un.fmt4
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x7
suffix:colon
id|printk
c_func
(paren
l_string|&quot;eff addr=%08lx ssw=%04x faddr=%08lx&bslash;n&quot;
comma
id|fp-&gt;un.fmt7.effaddr
comma
id|fp-&gt;un.fmt7.ssw
comma
id|fp-&gt;un.fmt7.faddr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;wb 1 stat/addr/data: %04x %08lx %08lx&bslash;n&quot;
comma
id|fp-&gt;un.fmt7.wb1s
comma
id|fp-&gt;un.fmt7.wb1a
comma
id|fp-&gt;un.fmt7.wb1dpd0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;wb 2 stat/addr/data: %04x %08lx %08lx&bslash;n&quot;
comma
id|fp-&gt;un.fmt7.wb2s
comma
id|fp-&gt;un.fmt7.wb2a
comma
id|fp-&gt;un.fmt7.wb2d
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;wb 3 stat/addr/data: %04x %08lx %08lx&bslash;n&quot;
comma
id|fp-&gt;un.fmt7.wb3s
comma
id|fp-&gt;un.fmt7.wb3a
comma
id|fp-&gt;un.fmt7.wb3d
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;push data: %08lx %08lx %08lx %08lx&bslash;n&quot;
comma
id|fp-&gt;un.fmt7.wb1dpd0
comma
id|fp-&gt;un.fmt7.pd1
comma
id|fp-&gt;un.fmt7.pd2
comma
id|fp-&gt;un.fmt7.pd3
)paren
suffix:semicolon
id|addr
op_add_assign
r_sizeof
(paren
id|fp-&gt;un.fmt7
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x9
suffix:colon
id|printk
c_func
(paren
l_string|&quot;instr addr=%08lx&bslash;n&quot;
comma
id|fp-&gt;un.fmt9.iaddr
)paren
suffix:semicolon
id|addr
op_add_assign
r_sizeof
(paren
id|fp-&gt;un.fmt9
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xa
suffix:colon
id|printk
c_func
(paren
l_string|&quot;ssw=%04x isc=%04x isb=%04x daddr=%08lx dobuf=%08lx&bslash;n&quot;
comma
id|fp-&gt;un.fmta.ssw
comma
id|fp-&gt;un.fmta.isc
comma
id|fp-&gt;un.fmta.isb
comma
id|fp-&gt;un.fmta.daddr
comma
id|fp-&gt;un.fmta.dobuf
)paren
suffix:semicolon
id|addr
op_add_assign
r_sizeof
(paren
id|fp-&gt;un.fmta
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xb
suffix:colon
id|printk
c_func
(paren
l_string|&quot;ssw=%04x isc=%04x isb=%04x daddr=%08lx dobuf=%08lx&bslash;n&quot;
comma
id|fp-&gt;un.fmtb.ssw
comma
id|fp-&gt;un.fmtb.isc
comma
id|fp-&gt;un.fmtb.isb
comma
id|fp-&gt;un.fmtb.daddr
comma
id|fp-&gt;un.fmtb.dobuf
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;baddr=%08lx dibuf=%08lx ver=%x&bslash;n&quot;
comma
id|fp-&gt;un.fmtb.baddr
comma
id|fp-&gt;un.fmtb.dibuf
comma
id|fp-&gt;un.fmtb.ver
)paren
suffix:semicolon
id|addr
op_add_assign
r_sizeof
(paren
id|fp-&gt;un.fmtb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|stack
op_assign
(paren
r_int
r_int
op_star
)paren
id|addr
suffix:semicolon
id|endstack
op_assign
(paren
r_int
r_int
op_star
)paren
id|PAGE_ALIGN
c_func
(paren
id|addr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Stack from %08lx:&quot;
comma
(paren
r_int
r_int
)paren
id|stack
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|kstack_depth_to_print
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|stack
op_plus
l_int|1
OG
id|endstack
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_mod
l_int|8
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n       &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; %08lx&quot;
comma
op_star
id|stack
op_increment
)paren
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot;&bslash;nCall Trace:&quot;
)paren
suffix:semicolon
id|stack
op_assign
(paren
r_int
r_int
op_star
)paren
id|addr
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
id|module_start
op_assign
id|VMALLOC_START
suffix:semicolon
id|module_end
op_assign
id|module_start
op_plus
id|MODULE_RANGE
suffix:semicolon
r_while
c_loop
(paren
id|stack
op_plus
l_int|1
op_le
id|endstack
)paren
(brace
id|addr
op_assign
op_star
id|stack
op_increment
suffix:semicolon
multiline_comment|/*&n;&t;&t; * If the address is either in the text segment of the&n;&t;&t; * kernel, or in the region which contains vmalloc&squot;ed&n;&t;&t; * memory, it *may* be the address of a calling&n;&t;&t; * routine; if so, print it so that someone tracing&n;&t;&t; * down the cause of the crash will be able to figure&n;&t;&t; * out the call path that was taken.&n;&t;&t; */
r_if
c_cond
(paren
(paren
(paren
id|addr
op_ge
(paren
r_int
r_int
)paren
op_amp
id|_start
)paren
op_logical_and
(paren
id|addr
op_le
(paren
r_int
r_int
)paren
op_amp
id|_etext
)paren
)paren
op_logical_or
(paren
(paren
id|addr
op_ge
id|module_start
)paren
op_logical_and
(paren
id|addr
op_le
id|module_end
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|i
op_mod
l_int|4
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n       &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; [&lt;%08lx&gt;]&quot;
comma
id|addr
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;nCode: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%04x &quot;
comma
l_int|0xffff
op_amp
(paren
(paren
r_int
op_star
)paren
id|fp-&gt;ptregs.pc
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|bad_super_trap
r_void
id|bad_super_trap
(paren
r_struct
id|frame
op_star
id|fp
)paren
(brace
id|console_verbose
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fp-&gt;ptregs.vector
OL
l_int|4
op_star
r_sizeof
(paren
id|vec_names
)paren
op_div
r_sizeof
(paren
id|vec_names
(braket
l_int|0
)braket
)paren
)paren
id|printk
(paren
l_string|&quot;*** %s ***   FORMAT=%X&bslash;n&quot;
comma
id|vec_names
(braket
(paren
id|fp-&gt;ptregs.vector
)paren
op_rshift
l_int|2
)braket
comma
id|fp-&gt;ptregs.format
)paren
suffix:semicolon
r_else
id|printk
(paren
l_string|&quot;*** Exception %d ***   FORMAT=%X&bslash;n&quot;
comma
(paren
id|fp-&gt;ptregs.vector
)paren
op_rshift
l_int|2
comma
id|fp-&gt;ptregs.format
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fp-&gt;ptregs.vector
op_rshift
l_int|2
op_eq
id|VEC_ADDRERR
op_logical_and
id|CPU_IS_020_OR_030
)paren
(brace
r_int
r_int
id|ssw
op_assign
id|fp-&gt;un.fmtb.ssw
suffix:semicolon
id|printk
(paren
l_string|&quot;SSW=%#06x  &quot;
comma
id|ssw
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ssw
op_amp
id|RC
)paren
id|printk
(paren
l_string|&quot;Pipe stage C instruction fault at %#010lx&bslash;n&quot;
comma
(paren
id|fp-&gt;ptregs.format
)paren
op_eq
l_int|0xA
ques
c_cond
id|fp-&gt;ptregs.pc
op_plus
l_int|2
suffix:colon
id|fp-&gt;un.fmtb.baddr
op_minus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ssw
op_amp
id|RB
)paren
id|printk
(paren
l_string|&quot;Pipe stage B instruction fault at %#010lx&bslash;n&quot;
comma
(paren
id|fp-&gt;ptregs.format
)paren
op_eq
l_int|0xA
ques
c_cond
id|fp-&gt;ptregs.pc
op_plus
l_int|4
suffix:colon
id|fp-&gt;un.fmtb.baddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ssw
op_amp
id|DF
)paren
id|printk
(paren
l_string|&quot;Data %s fault at %#010lx in %s (pc=%#lx)&bslash;n&quot;
comma
id|ssw
op_amp
id|RW
ques
c_cond
l_string|&quot;read&quot;
suffix:colon
l_string|&quot;write&quot;
comma
id|fp-&gt;un.fmtb.daddr
comma
id|space_names
(braket
id|ssw
op_amp
id|DFC
)braket
comma
id|fp-&gt;ptregs.pc
)paren
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot;Current process id is %d&bslash;n&quot;
comma
id|current-&gt;pid
)paren
suffix:semicolon
id|die_if_kernel
c_func
(paren
l_string|&quot;BAD KERNEL TRAP&quot;
comma
op_amp
id|fp-&gt;ptregs
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|trap_c
id|asmlinkage
r_void
id|trap_c
c_func
(paren
r_struct
id|frame
op_star
id|fp
)paren
(brace
r_int
id|sig
suffix:semicolon
id|siginfo_t
id|info
suffix:semicolon
r_if
c_cond
(paren
id|fp-&gt;ptregs.sr
op_amp
id|PS_S
)paren
(brace
r_if
c_cond
(paren
(paren
id|fp-&gt;ptregs.vector
op_rshift
l_int|2
)paren
op_eq
id|VEC_TRACE
)paren
(brace
multiline_comment|/* traced a trapping instruction */
id|current-&gt;ptrace
op_or_assign
id|PT_DTRACE
suffix:semicolon
)brace
r_else
id|bad_super_trap
c_func
(paren
id|fp
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* send the appropriate signal to the user program */
r_switch
c_cond
(paren
(paren
id|fp-&gt;ptregs.vector
)paren
op_rshift
l_int|2
)paren
(brace
r_case
id|VEC_ADDRERR
suffix:colon
id|info.si_code
op_assign
id|BUS_ADRALN
suffix:semicolon
id|sig
op_assign
id|SIGBUS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VEC_ILLEGAL
suffix:colon
r_case
id|VEC_LINE10
suffix:colon
r_case
id|VEC_LINE11
suffix:colon
id|info.si_code
op_assign
id|ILL_ILLOPC
suffix:semicolon
id|sig
op_assign
id|SIGILL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VEC_PRIV
suffix:colon
id|info.si_code
op_assign
id|ILL_PRVOPC
suffix:semicolon
id|sig
op_assign
id|SIGILL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VEC_COPROC
suffix:colon
id|info.si_code
op_assign
id|ILL_COPROC
suffix:semicolon
id|sig
op_assign
id|SIGILL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VEC_TRAP1
suffix:colon
r_case
id|VEC_TRAP2
suffix:colon
r_case
id|VEC_TRAP3
suffix:colon
r_case
id|VEC_TRAP4
suffix:colon
r_case
id|VEC_TRAP5
suffix:colon
r_case
id|VEC_TRAP6
suffix:colon
r_case
id|VEC_TRAP7
suffix:colon
r_case
id|VEC_TRAP8
suffix:colon
r_case
id|VEC_TRAP9
suffix:colon
r_case
id|VEC_TRAP10
suffix:colon
r_case
id|VEC_TRAP11
suffix:colon
r_case
id|VEC_TRAP12
suffix:colon
r_case
id|VEC_TRAP13
suffix:colon
r_case
id|VEC_TRAP14
suffix:colon
id|info.si_code
op_assign
id|ILL_ILLTRP
suffix:semicolon
id|sig
op_assign
id|SIGILL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VEC_FPBRUC
suffix:colon
r_case
id|VEC_FPOE
suffix:colon
r_case
id|VEC_FPNAN
suffix:colon
id|info.si_code
op_assign
id|FPE_FLTINV
suffix:semicolon
id|sig
op_assign
id|SIGFPE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VEC_FPIR
suffix:colon
id|info.si_code
op_assign
id|FPE_FLTRES
suffix:semicolon
id|sig
op_assign
id|SIGFPE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VEC_FPDIVZ
suffix:colon
id|info.si_code
op_assign
id|FPE_FLTDIV
suffix:semicolon
id|sig
op_assign
id|SIGFPE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VEC_FPUNDER
suffix:colon
id|info.si_code
op_assign
id|FPE_FLTUND
suffix:semicolon
id|sig
op_assign
id|SIGFPE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VEC_FPOVER
suffix:colon
id|info.si_code
op_assign
id|FPE_FLTOVF
suffix:semicolon
id|sig
op_assign
id|SIGFPE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VEC_ZERODIV
suffix:colon
id|info.si_code
op_assign
id|FPE_INTDIV
suffix:semicolon
id|sig
op_assign
id|SIGFPE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VEC_CHK
suffix:colon
r_case
id|VEC_TRAP
suffix:colon
id|info.si_code
op_assign
id|FPE_INTOVF
suffix:semicolon
id|sig
op_assign
id|SIGFPE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VEC_TRACE
suffix:colon
multiline_comment|/* ptrace single step */
id|info.si_code
op_assign
id|TRAP_TRACE
suffix:semicolon
id|sig
op_assign
id|SIGTRAP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VEC_TRAP15
suffix:colon
multiline_comment|/* breakpoint */
id|info.si_code
op_assign
id|TRAP_BRKPT
suffix:semicolon
id|sig
op_assign
id|SIGTRAP
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|info.si_code
op_assign
id|ILL_ILLOPC
suffix:semicolon
id|sig
op_assign
id|SIGILL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|info.si_signo
op_assign
id|sig
suffix:semicolon
id|info.si_errno
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|fp-&gt;ptregs.format
)paren
(brace
r_default
suffix:colon
id|info.si_addr
op_assign
(paren
r_void
op_star
)paren
id|fp-&gt;ptregs.pc
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|info.si_addr
op_assign
(paren
r_void
op_star
)paren
id|fp-&gt;un.fmt2.iaddr
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|info.si_addr
op_assign
(paren
r_void
op_star
)paren
id|fp-&gt;un.fmt7.effaddr
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|9
suffix:colon
id|info.si_addr
op_assign
(paren
r_void
op_star
)paren
id|fp-&gt;un.fmt9.iaddr
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|10
suffix:colon
id|info.si_addr
op_assign
(paren
r_void
op_star
)paren
id|fp-&gt;un.fmta.daddr
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|11
suffix:colon
id|info.si_addr
op_assign
(paren
r_void
op_star
)paren
id|fp-&gt;un.fmtb.daddr
suffix:semicolon
r_break
suffix:semicolon
)brace
id|force_sig_info
(paren
id|sig
comma
op_amp
id|info
comma
id|current
)paren
suffix:semicolon
)brace
DECL|function|die_if_kernel
r_void
id|die_if_kernel
(paren
r_char
op_star
id|str
comma
r_struct
id|pt_regs
op_star
id|fp
comma
r_int
id|nr
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|fp-&gt;sr
op_amp
id|PS_S
)paren
)paren
r_return
suffix:semicolon
id|console_verbose
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: %08x&bslash;n&quot;
comma
id|str
comma
id|nr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PC: [&lt;%08lx&gt;]&bslash;nSR: %04x  SP: %p  a2: %08lx&bslash;n&quot;
comma
id|fp-&gt;pc
comma
id|fp-&gt;sr
comma
id|fp
comma
id|fp-&gt;a2
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;d0: %08lx    d1: %08lx    d2: %08lx    d3: %08lx&bslash;n&quot;
comma
id|fp-&gt;d0
comma
id|fp-&gt;d1
comma
id|fp-&gt;d2
comma
id|fp-&gt;d3
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;d4: %08lx    d5: %08lx    a0: %08lx    a1: %08lx&bslash;n&quot;
comma
id|fp-&gt;d4
comma
id|fp-&gt;d5
comma
id|fp-&gt;a0
comma
id|fp-&gt;a1
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Process %s (pid: %d, stackpage=%08lx)&bslash;n&quot;
comma
id|current-&gt;comm
comma
id|current-&gt;pid
comma
id|PAGE_SIZE
op_plus
(paren
r_int
r_int
)paren
id|current
)paren
suffix:semicolon
id|dump_stack
c_func
(paren
(paren
r_struct
id|frame
op_star
)paren
id|fp
)paren
suffix:semicolon
id|do_exit
c_func
(paren
id|SIGSEGV
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This function is called if an error occur while accessing&n; * user-space from the fpsp040 code.&n; */
DECL|function|fpsp040_die
id|asmlinkage
r_void
id|fpsp040_die
c_func
(paren
r_void
)paren
(brace
id|do_exit
c_func
(paren
id|SIGSEGV
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_M68KFPU_EMU
DECL|function|fpemu_signal
id|asmlinkage
r_void
id|fpemu_signal
c_func
(paren
r_int
id|signal
comma
r_int
id|code
comma
r_void
op_star
id|addr
)paren
(brace
id|siginfo_t
id|info
suffix:semicolon
id|info.si_signo
op_assign
id|signal
suffix:semicolon
id|info.si_errno
op_assign
l_int|0
suffix:semicolon
id|info.si_code
op_assign
id|code
suffix:semicolon
id|info.si_addr
op_assign
id|addr
suffix:semicolon
id|force_sig_info
c_func
(paren
id|signal
comma
op_amp
id|info
comma
id|current
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
