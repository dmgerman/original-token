multiline_comment|/*&n;**  linux/amiga/chipram.c&n;**&n;**      Modified 03-May-94 by Geert Uytterhoeven &lt;geert@linux-m68k.org&gt;&n;**          - 64-bit aligned allocations for full AGA compatibility&n;**&n;**&t;Rewritten 15/9/2000 by Geert to use resource management&n;*/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;asm/amigahw.h&gt;
DECL|variable|amiga_chip_size
r_int
r_int
id|amiga_chip_size
suffix:semicolon
DECL|variable|chipram_res
r_static
r_struct
id|resource
id|chipram_res
op_assign
(brace
l_string|&quot;Chip RAM&quot;
comma
id|CHIP_PHYSADDR
)brace
suffix:semicolon
DECL|variable|chipavail
r_static
r_int
r_int
id|chipavail
suffix:semicolon
DECL|function|amiga_chip_init
r_void
id|__init
id|amiga_chip_init
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|AMIGAHW_PRESENT
c_func
(paren
id|CHIP_RAM
)paren
)paren
r_return
suffix:semicolon
macro_line|#ifndef CONFIG_APUS_FAST_EXCEPT
multiline_comment|/*&n;     *  Remove the first 4 pages where PPC exception handlers will be located&n;     */
id|amiga_chip_size
op_sub_assign
l_int|0x4000
suffix:semicolon
macro_line|#endif
id|chipram_res.end
op_assign
id|amiga_chip_size
op_minus
l_int|1
suffix:semicolon
id|request_resource
c_func
(paren
op_amp
id|iomem_resource
comma
op_amp
id|chipram_res
)paren
suffix:semicolon
id|chipavail
op_assign
id|amiga_chip_size
suffix:semicolon
)brace
DECL|function|amiga_chip_alloc
r_void
op_star
id|amiga_chip_alloc
c_func
(paren
r_int
r_int
id|size
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_struct
id|resource
op_star
id|res
suffix:semicolon
multiline_comment|/* round up */
id|size
op_assign
id|PAGE_ALIGN
c_func
(paren
id|size
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;amiga_chip_alloc: allocate %ld bytes&bslash;n&quot;
comma
id|size
)paren
suffix:semicolon
macro_line|#endif
id|res
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|resource
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|res
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|res
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|resource
)paren
)paren
suffix:semicolon
id|res-&gt;name
op_assign
id|name
suffix:semicolon
r_if
c_cond
(paren
id|allocate_resource
c_func
(paren
op_amp
id|chipram_res
comma
id|res
comma
id|size
comma
l_int|0
comma
id|UINT_MAX
comma
id|PAGE_SIZE
comma
l_int|NULL
comma
l_int|NULL
)paren
OL
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|res
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|chipavail
op_sub_assign
id|size
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;amiga_chip_alloc: returning %lx&bslash;n&quot;
comma
id|res-&gt;start
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
r_void
op_star
)paren
id|ZTWO_VADDR
c_func
(paren
id|res-&gt;start
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Warning:&n;     *  amiga_chip_alloc_res is meant only for drivers that need to allocate&n;     *  Chip RAM before kmalloc() is functional. As a consequence, those&n;     *  drivers must not free that Chip RAM afterwards.&n;     */
DECL|function|amiga_chip_alloc_res
r_void
op_star
id|__init
id|amiga_chip_alloc_res
c_func
(paren
r_int
r_int
id|size
comma
r_struct
id|resource
op_star
id|res
)paren
(brace
r_int
r_int
id|start
suffix:semicolon
multiline_comment|/* round up */
id|size
op_assign
id|PAGE_ALIGN
c_func
(paren
id|size
)paren
suffix:semicolon
multiline_comment|/* dmesg into chipmem prefers memory at the safe end */
id|start
op_assign
id|CHIP_PHYSADDR
op_plus
id|chipavail
op_minus
id|size
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;amiga_chip_alloc_res: allocate %ld bytes&bslash;n&quot;
comma
id|size
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|allocate_resource
c_func
(paren
op_amp
id|chipram_res
comma
id|res
comma
id|size
comma
id|start
comma
id|UINT_MAX
comma
id|PAGE_SIZE
comma
l_int|NULL
comma
l_int|NULL
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;amiga_chip_alloc_res: first alloc failed!&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|allocate_resource
c_func
(paren
op_amp
id|chipram_res
comma
id|res
comma
id|size
comma
l_int|0
comma
id|UINT_MAX
comma
id|PAGE_SIZE
comma
l_int|NULL
comma
l_int|NULL
)paren
OL
l_int|0
)paren
r_return
l_int|NULL
suffix:semicolon
)brace
id|chipavail
op_sub_assign
id|size
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;amiga_chip_alloc_res: returning %lx&bslash;n&quot;
comma
id|res-&gt;start
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
r_void
op_star
)paren
id|ZTWO_VADDR
c_func
(paren
id|res-&gt;start
)paren
suffix:semicolon
)brace
DECL|function|amiga_chip_free
r_void
id|amiga_chip_free
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
r_int
r_int
id|start
op_assign
id|ZTWO_PADDR
c_func
(paren
id|ptr
)paren
suffix:semicolon
r_struct
id|resource
op_star
op_star
id|p
comma
op_star
id|res
suffix:semicolon
r_int
r_int
id|size
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
op_amp
id|chipram_res.child
suffix:semicolon
(paren
id|res
op_assign
op_star
id|p
)paren
suffix:semicolon
id|p
op_assign
op_amp
id|res-&gt;sibling
)paren
(brace
r_if
c_cond
(paren
id|res-&gt;start
op_ne
id|start
)paren
r_continue
suffix:semicolon
op_star
id|p
op_assign
id|res-&gt;sibling
suffix:semicolon
id|size
op_assign
id|res-&gt;end
op_minus
id|start
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;amiga_chip_free: free %ld bytes at %p&bslash;n&quot;
comma
id|size
comma
id|ptr
)paren
suffix:semicolon
macro_line|#endif
id|chipavail
op_add_assign
id|size
suffix:semicolon
id|kfree
c_func
(paren
id|res
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;amiga_chip_free: trying to free nonexistent region at %p&bslash;n&quot;
comma
id|ptr
)paren
suffix:semicolon
)brace
DECL|function|amiga_chip_avail
r_int
r_int
id|amiga_chip_avail
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;amiga_chip_avail : %ld bytes&bslash;n&quot;
comma
id|chipavail
)paren
suffix:semicolon
macro_line|#endif
r_return
id|chipavail
suffix:semicolon
)brace
eof
