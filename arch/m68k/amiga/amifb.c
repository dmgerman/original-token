multiline_comment|/*&n; * linux/arch/m68k/amiga/amifb.c -- Low level implementation of the Amiga frame&n; *                                  buffer device&n; *&n; *    Copyright (C) 1995 Geert Uytterhoeven&n; *&n; *&n; * This file is based on the Atari frame buffer device (atafb.c):&n; *&n; *    Copyright (C) 1994 Martin Schaller&n; *                       Roman Hodek&n; *&n; *          with work by Andreas Schwab&n; *                       Guenther Kelleter&n; *&n; * and on the original Amiga console driver (amicon.c):&n; *&n; *    Copyright (C) 1993 Hamish Macdonald&n; *                       Greg Harp&n; *    Copyright (C) 1994 David Carter [carter@compsci.bristol.ac.uk]&n; *&n; *          with work by William Rucklidge (wjr@cs.cornell.edu)&n; *                       Geert Uytterhoeven&n; *                       Jes Sorensen (jds@kom.auc.dk)&n; *&n; *&n; * History:&n; *&n; *   -  2 Dec 95: AGA version by Geert Uytterhoeven&n; *&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file README.legal in the main directory of this archive&n; * for more details.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/amigahw.h&gt;
macro_line|#include &lt;asm/amigaints.h&gt;
macro_line|#include &lt;asm/bootinfo.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
DECL|macro|CONFIG_AMIFB_OCS
macro_line|#undef  CONFIG_AMIFB_OCS
DECL|macro|CONFIG_AMIFB_ECS
macro_line|#undef  CONFIG_AMIFB_ECS
DECL|macro|CONFIG_AMIFB_AGA
mdefine_line|#define CONFIG_AMIFB_AGA   /* Only AGA support at the moment */
DECL|macro|USE_MONO_AMIFB_IF_NON_AGA
mdefine_line|#define USE_MONO_AMIFB_IF_NON_AGA
multiline_comment|/* -------------------- BEGIN: TODO ----------------------------------------- **&n;&n;&n;   - scan the sources for `TODO&squot;&n;&n;   - timings and monspecs can be set via the kernel command line (cfr. Atari)&n;&n;   - OCS and ECS&n;&n;   - hardware cursor&n;&n;   - Interlaced screen -&gt; Interlaced sprite/hardware cursor&n;&n;&n;** -------------------- END: TODO ------------------------------------------- */
multiline_comment|/*******************************************************************************&n;&n;&n;   Generic video timings&n;   ---------------------&n;&n;   Timings used by the frame buffer interface:&n;&n;   +----------+---------------------------------------------+----------+-------+&n;   |          |                ^                            |          |       |&n;   |          |                |upper_margin                |          |       |&n;   |          |                &#xfffd;                            |          |       |&n;   +----------###############################################----------+-------+&n;   |          #                ^                            #          |       |&n;   |          #                |                            #          |       |&n;   |          #                |                            #          |       |&n;   |          #                |                            #          |       |&n;   |   left   #                |                            #  right   | hsync |&n;   |  margin  #                |       xres                 #  margin  |  len  |&n;   |&lt;--------&gt;#&lt;---------------+---------------------------&gt;#&lt;--------&gt;|&lt;-----&gt;|&n;   |          #                |                            #          |       |&n;   |          #                |                            #          |       |&n;   |          #                |                            #          |       |&n;   |          #                |yres                        #          |       |&n;   |          #                |                            #          |       |&n;   |          #                |                            #          |       |&n;   |          #                |                            #          |       |&n;   |          #                |                            #          |       |&n;   |          #                |                            #          |       |&n;   |          #                |                            #          |       |&n;   |          #                |                            #          |       |&n;   |          #                |                            #          |       |&n;   |          #                &#xfffd;                            #          |       |&n;   +----------###############################################----------+-------+&n;   |          |                ^                            |          |       |&n;   |          |                |lower_margin                |          |       |&n;   |          |                &#xfffd;                            |          |       |&n;   +----------+---------------------------------------------+----------+-------+&n;   |          |                ^                            |          |       |&n;   |          |                |vsync_len                   |          |       |&n;   |          |                &#xfffd;                            |          |       |&n;   +----------+---------------------------------------------+----------+-------+&n;&n;&n;   Amiga video timings&n;   -------------------&n;&n;   The Amiga native chipsets uses another timing scheme:&n;&n;      - hsstrt:   Start of horizontal synchronization pulse&n;      - hsstop:   End of horizontal synchronization pulse&n;      - htotal:   Last value on the line (i.e. line length = htotal+1)&n;      - vsstrt:   Start of vertical synchronization pulse&n;      - vsstop:   Start of vertical synchronization pulse&n;      - vtotal:   Last line value (i.e. number of lines = vtotal+1)&n;      - hcenter:  Start of vertical retrace for interlace&n;&n;   You can specify the blanking timings independently. Currently I just set&n;   them equal to the respective synchronization values:&n;&n;      - hbstrt:   Start of horizontal blank&n;      - hbstop:   End of horizontal blank&n;      - vbstrt:   Start of vertical blank&n;      - vbstop:   Start of vertical blank&n;&n;   Horizontal values are in color clock cycles (280 ns), vertical values are in&n;   scanlines.&n;&n;   (0, 0) is somewhere in the upper-left corner :-)&n;&n;&n;   Amiga visible window definitions&n;   --------------------------------&n;&n;   Currently I only have values for AGA, SHRES (28 MHz dotclock). Feel free to&n;   make corrections and/or additions.&n;&n;   Within the above synchronization specifications, the visible window is&n;   defined by the following parameters (actual register resolutions may be&n;   different; all horizontal values are normalized with respect to the pixel&n;   clock):&n;&n;      - diwstrt_h:   Horizontal start of the visible window&n;      - diwstop_h:   Horizontal stop+1(*) of the visible window&n;      - diwstrt_v:   Vertical start of the visible window&n;      - diwstop_v:   Vertical stop of the visible window&n;      - ddfstrt:     Horizontal start of display DMA&n;      - ddfstop:     Horizontal stop of display DMA&n;      - hscroll:     Horizontal display output delay&n;&n;   Sprite positioning:&n;&n;      - sprstrt_h:   Horizontal start-4 of sprite&n;      - sprstrt_v:   Vertical start of sprite&n;&n;   (*) Even Commodore did it wrong in the AGA monitor drivers by not adding 1.&n;&n;   Horizontal values are in dotclock cycles (35 ns), vertical values are in&n;   scanlines.&n;&n;   (0, 0) is somewhere in the upper-left corner :-)&n;&n;&n;   Dependencies (AGA, SHRES (35 ns dotclock))&n;   -------------------------------------------&n;&n;   Since there are much more parameters for the Amiga display than for the&n;   frame buffer interface, there must be some dependencies among the Amiga display&n;   parameters. Here&squot;s what I found out:&n;&n;      - ddfstrt and ddfstop are best aligned to 64 pixels.&n;      - the chipset needs 64+4 horizontal pixels after the DMA start before the&n;        first pixel is output, so diwstrt_h = ddfstrt+64+4 if you want to&n;        display the first pixel on the line too. Increase diwstrt_h for virtual&n;        screen panning.&n;      - the display DMA always fetches 64 pixels at a time (*).&n;      - ddfstop is ddfstrt+#pixels-64.&n;      - diwstop_h = diwstrt_h+xres+1. Because of the additional 1 this can be 1&n;        more than htotal.&n;      - hscroll simply adds a delay to the display output. Smooth horizontal&n;        panning needs an extra 64 pixels on the left to prefetch the pixels that&n;        `fall off&squot; on the left.&n;      - if ddfstrt &lt; 192, the sprite DMA cycles are all stolen by the bitplane&n;        DMA, so it&squot;s best to make the DMA start as late as possible.&n;      - you really don&squot;t want to make ddfstrt &lt; 128, since this will steal DMA&n;        cycles from the other DMA channels (audio, floppy and Chip RAM refresh).&n;      - I make diwstop_h and diwstop_v as large as possible.&n;&n;   (*) This is for fmode = 3. Lower fmodes allow for more freedom w.r.t. the&n;       timings, but they limit the maximum display depth, and cause more stress&n;       on the custom chip bus.&n;&n;&n;   DMA priorities&n;   --------------&n;&n;   Since there are limits on the earliest start value for display DMA and the&n;   display of sprites, I use the following policy on horizontal panning and&n;   the hardware cursor:&n;&n;      - if you want to start display DMA too early, you loose the ability to&n;        do smooth horizontal panning (xpanstep 1 -&gt; 64).&n;      - if you want to go even further, you loose the hardware cursor too.&n;&n;   IMHO a hardware cursor is more important for X than horizontal scrolling,&n;   so that&squot;s my motivation.&n;&n;&n;   Implementation&n;   --------------&n;&n;   aga_decode_var() converts the frame buffer values to the Amiga values. It&squot;s&n;   just a `straightforward&squot; implementation of the above rules.&n;&n;&n;   Standard VGA timings&n;   --------------------&n;&n;               xres  yres    left  right  upper  lower    hsync    vsync&n;               ----  ----    ----  -----  -----  -----    -----    -----&n;      80x25     720   400      27     45     35     12      108        2&n;      80x30     720   480      27     45     30      9      108        2&n;&n;   These were taken from a XFree86 configuration file, recalculated for a 28 MHz&n;   dotclock (Amigas don&squot;t have a 25 MHz dotclock) and converted to frame buffer&n;   generic timings.&n;&n;   As a comparison, graphics/monitor.h suggests the following:&n;&n;               xres  yres    left  right  upper  lower    hsync    vsync&n;               ----  ----    ----  -----  -----  -----    -----    -----&n;&n;      VGA       640   480      52    112     24     19    112 -      2 +&n;      VGA70     640   400      52    112     27     21    112 -      2 -&n;&n;&n;   Sync polarities&n;   ---------------&n;&n;      VSYNC    HSYNC    Vertical size    Vertical total&n;      -----    -----    -------------    --------------&n;        +        +           Reserved          Reserved&n;        +        -                400               414&n;        -        +                350               362&n;        -        -                480               496&n;&n;   Source: CL-GD542X Technical Reference Manual, Cirrus Logic, Oct 1992&n;&n;&n;   Broadcast video timings&n;   -----------------------&n;&n;   Since broadcast video timings are `fixed&squot; and only depend on the video&n;   system (PAL/NTSC), hsync_len and vsync_len are not used and must be set to&n;   zero. All xres/yres and margin values are defined within the `visible&n;   rectangle&squot; of the display.&n;&n;   According to the CCIR and RETMA specifications, we have the following values:&n;&n;   CCIR -&gt; PAL&n;   -----------&n;&n;      - a scanline is 64 &#xfffd;s long, of which 52.48 &#xfffd;s are visible. This is about&n;        736 visible 70 ns pixels per line.&n;      - we have 625 scanlines, of which 575 are visible (interlaced); after&n;        rounding this becomes 576.&n;&n;   RETMA -&gt; NTSC&n;   -------------&n;&n;      - a scanline is 63.5 &#xfffd;s long, of which 53.5 &#xfffd;s are visible.  This is about&n;        736 visible 70 ns pixels per line.&n;      - we have 525 scanlines, of which 485 are visible (interlaced); after&n;        rounding this becomes 484.&n;&n;   Thus if you want a PAL compatible display, you have to do the following:&n;&n;      - set the FB_SYNC_BROADCAST flag to indicate that standard broadcast&n;        timings are to be used.&n;      - make sure upper_margin+yres+lower_margin = 576 for an interlaced, 288&n;        for a non-interlaced and 144 for a doublescanned display.&n;      - make sure (left_margin+xres+right_margin)*pixclock is a reasonable&n;        approximation to 52.48 &#xfffd;s.&n;&n;   The settings for a NTSC compatible display are straightforward.&n;&n;   Note that in a strict sense the PAL and NTSC standards only define the&n;   encoding of the color part (chrominance) of the video signal and don&squot;t say&n;   anything about horizontal/vertical synchronization nor refresh rates.&n;   But since Amigas have RGB output, this issue isn&squot;t of any importance here.&n;&n;&n;                                                            -- Geert --&n;&n;*******************************************************************************/
multiline_comment|/*&n;    *    Custom Chipset Definitions&n;    */
DECL|macro|CUSTOM_OFS
mdefine_line|#define CUSTOM_OFS(fld) ((long)&amp;((struct CUSTOM*)0)-&gt;fld)
multiline_comment|/*&n;    *    BPLCON0 -- Bitplane Control Register 0&n;    */
DECL|macro|BPC0_HIRES
mdefine_line|#define BPC0_HIRES      (0x8000)
DECL|macro|BPC0_BPU2
mdefine_line|#define BPC0_BPU2       (0x4000) /* Bit plane used count */
DECL|macro|BPC0_BPU1
mdefine_line|#define BPC0_BPU1       (0x2000)
DECL|macro|BPC0_BPU0
mdefine_line|#define BPC0_BPU0       (0x1000)
DECL|macro|BPC0_HAM
mdefine_line|#define BPC0_HAM        (0x0800) /* HAM mode */
DECL|macro|BPC0_DPF
mdefine_line|#define BPC0_DPF        (0x0400) /* Double playfield */
DECL|macro|BPC0_COLOR
mdefine_line|#define BPC0_COLOR      (0x0200) /* Enable colorburst */
DECL|macro|BPC0_GAUD
mdefine_line|#define BPC0_GAUD       (0x0100) /* Genlock audio enable */
DECL|macro|BPC0_UHRES
mdefine_line|#define BPC0_UHRES      (0x0080) /* Ultrahi res enable */
DECL|macro|BPC0_SHRES
mdefine_line|#define BPC0_SHRES      (0x0040) /* Super hi res mode */
DECL|macro|BPC0_BYPASS
mdefine_line|#define BPC0_BYPASS     (0x0020) /* Bypass LUT - AGA */
DECL|macro|BPC0_BPU3
mdefine_line|#define BPC0_BPU3       (0x0010) /* AGA */
DECL|macro|BPC0_LPEN
mdefine_line|#define BPC0_LPEN       (0x0008) /* Light pen enable */
DECL|macro|BPC0_LACE
mdefine_line|#define BPC0_LACE       (0x0004) /* Interlace */
DECL|macro|BPC0_ERSY
mdefine_line|#define BPC0_ERSY       (0x0002) /* External resync */
DECL|macro|BPC0_ECSENA
mdefine_line|#define BPC0_ECSENA     (0x0001) /* ECS emulation disable */
multiline_comment|/*&n;    *    BPLCON2 -- Bitplane Control Register 2&n;    */
DECL|macro|BPC2_ZDBPSEL2
mdefine_line|#define BPC2_ZDBPSEL2   (0x4000) /* Bitplane to be used for ZD - AGA */
DECL|macro|BPC2_ZDBPSEL1
mdefine_line|#define BPC2_ZDBPSEL1   (0x2000)
DECL|macro|BPC2_ZDBPSEL0
mdefine_line|#define BPC2_ZDBPSEL0   (0x1000)
DECL|macro|BPC2_ZDBPEN
mdefine_line|#define BPC2_ZDBPEN     (0x0800) /* Enable ZD with ZDBPSELx - AGA */
DECL|macro|BPC2_ZDCTEN
mdefine_line|#define BPC2_ZDCTEN     (0x0400) /* Enable ZD with palette bit #31 - AGA */
DECL|macro|BPC2_KILLEHB
mdefine_line|#define BPC2_KILLEHB    (0x0200) /* Kill EHB mode - AGA */
DECL|macro|BPC2_RDRAM
mdefine_line|#define BPC2_RDRAM      (0x0100) /* Color table accesses read, not write - AGA */
DECL|macro|BPC2_SOGEN
mdefine_line|#define BPC2_SOGEN      (0x0080) /* SOG output pin high - AGA */
DECL|macro|BPC2_PF2PRI
mdefine_line|#define BPC2_PF2PRI     (0x0040) /* PF2 priority over PF1 */
DECL|macro|BPC2_PF2P2
mdefine_line|#define BPC2_PF2P2      (0x0020) /* PF2 priority wrt sprites */
DECL|macro|BPC2_PF2P1
mdefine_line|#define BPC2_PF2P1      (0x0010)
DECL|macro|BPC2_PF2P0
mdefine_line|#define BPC2_PF2P0      (0x0008)
DECL|macro|BPC2_PF1P2
mdefine_line|#define BPC2_PF1P2      (0x0004) /* ditto PF1 */
DECL|macro|BPC2_PF1P1
mdefine_line|#define BPC2_PF1P1      (0x0002)
DECL|macro|BPC2_PF1P0
mdefine_line|#define BPC2_PF1P0      (0x0001)
multiline_comment|/*&n;    *    BPLCON3 -- Bitplane Control Register 3 (AGA)&n;    */
DECL|macro|BPC3_BANK2
mdefine_line|#define BPC3_BANK2      (0x8000) /* Bits to select color register bank */
DECL|macro|BPC3_BANK1
mdefine_line|#define BPC3_BANK1      (0x4000)
DECL|macro|BPC3_BANK0
mdefine_line|#define BPC3_BANK0      (0x2000)
DECL|macro|BPC3_PF2OF2
mdefine_line|#define BPC3_PF2OF2     (0x1000) /* Bits for color table offset when PF2 */
DECL|macro|BPC3_PF2OF1
mdefine_line|#define BPC3_PF2OF1     (0x0800)
DECL|macro|BPC3_PF2OF0
mdefine_line|#define BPC3_PF2OF0     (0x0400)
DECL|macro|BPC3_LOCT
mdefine_line|#define BPC3_LOCT       (0x0200) /* Color register writes go to low bits */
DECL|macro|BPC3_SPRES1
mdefine_line|#define BPC3_SPRES1     (0x0080) /* Sprite resolution bits */
DECL|macro|BPC3_SPRES0
mdefine_line|#define BPC3_SPRES0     (0x0040)
DECL|macro|BPC3_BRDRBLNK
mdefine_line|#define BPC3_BRDRBLNK   (0x0020) /* Border blanked? */
DECL|macro|BPC3_BRDRTRAN
mdefine_line|#define BPC3_BRDRTRAN   (0x0010) /* Border transparent? */
DECL|macro|BPC3_ZDCLKEN
mdefine_line|#define BPC3_ZDCLKEN    (0x0004) /* ZD pin is 14 MHz (HIRES) clock output */
DECL|macro|BPC3_BRDRSPRT
mdefine_line|#define BPC3_BRDRSPRT   (0x0002) /* Sprites in border? */
DECL|macro|BPC3_EXTBLKEN
mdefine_line|#define BPC3_EXTBLKEN   (0x0001) /* BLANK programmable */
multiline_comment|/*&n;    *    BPLCON4 -- Bitplane Control Register 4 (AGA)&n;    */
DECL|macro|BPC4_BPLAM7
mdefine_line|#define BPC4_BPLAM7     (0x8000) /* bitplane color XOR field */
DECL|macro|BPC4_BPLAM6
mdefine_line|#define BPC4_BPLAM6     (0x4000)
DECL|macro|BPC4_BPLAM5
mdefine_line|#define BPC4_BPLAM5     (0x2000)
DECL|macro|BPC4_BPLAM4
mdefine_line|#define BPC4_BPLAM4     (0x1000)
DECL|macro|BPC4_BPLAM3
mdefine_line|#define BPC4_BPLAM3     (0x0800)
DECL|macro|BPC4_BPLAM2
mdefine_line|#define BPC4_BPLAM2     (0x0400)
DECL|macro|BPC4_BPLAM1
mdefine_line|#define BPC4_BPLAM1     (0x0200)
DECL|macro|BPC4_BPLAM0
mdefine_line|#define BPC4_BPLAM0     (0x0100)
DECL|macro|BPC4_ESPRM7
mdefine_line|#define BPC4_ESPRM7     (0x0080) /* 4 high bits for even sprite colors */
DECL|macro|BPC4_ESPRM6
mdefine_line|#define BPC4_ESPRM6     (0x0040)
DECL|macro|BPC4_ESPRM5
mdefine_line|#define BPC4_ESPRM5     (0x0020)
DECL|macro|BPC4_ESPRM4
mdefine_line|#define BPC4_ESPRM4     (0x0010)
DECL|macro|BPC4_OSPRM7
mdefine_line|#define BPC4_OSPRM7     (0x0008) /* 4 high bits for odd sprite colors */
DECL|macro|BPC4_OSPRM6
mdefine_line|#define BPC4_OSPRM6     (0x0004)
DECL|macro|BPC4_OSPRM5
mdefine_line|#define BPC4_OSPRM5     (0x0002)
DECL|macro|BPC4_OSPRM4
mdefine_line|#define BPC4_OSPRM4     (0x0001)
multiline_comment|/*&n;    *    BEAMCON0 -- Beam Control Register&n;    */
DECL|macro|BMC0_HARDDIS
mdefine_line|#define BMC0_HARDDIS    (0x4000) /* Disable hardware limits */
DECL|macro|BMC0_LPENDIS
mdefine_line|#define BMC0_LPENDIS    (0x2000) /* Disable light pen latch */
DECL|macro|BMC0_VARVBEN
mdefine_line|#define BMC0_VARVBEN    (0x1000) /* Enable variable vertical blank */
DECL|macro|BMC0_LOLDIS
mdefine_line|#define BMC0_LOLDIS     (0x0800) /* Disable long/short line toggle */
DECL|macro|BMC0_CSCBEN
mdefine_line|#define BMC0_CSCBEN     (0x0400) /* Composite sync/blank */
DECL|macro|BMC0_VARVSYEN
mdefine_line|#define BMC0_VARVSYEN   (0x0200) /* Enable variable vertical sync */
DECL|macro|BMC0_VARHSYEN
mdefine_line|#define BMC0_VARHSYEN   (0x0100) /* Enable variable horizontal sync */
DECL|macro|BMC0_VARBEAMEN
mdefine_line|#define BMC0_VARBEAMEN  (0x0080) /* Enable variable beam counters */
DECL|macro|BMC0_DUAL
mdefine_line|#define BMC0_DUAL       (0x0080) /* Enable alternate horizontal beam counter */
DECL|macro|BMC0_PAL
mdefine_line|#define BMC0_PAL        (0x0020) /* Set decodes for PAL */
DECL|macro|BMC0_VARCSYEN
mdefine_line|#define BMC0_VARCSYEN   (0x0010) /* Enable variable composite sync */
DECL|macro|BMC0_BLANKEN
mdefine_line|#define BMC0_BLANKEN    (0x0008) /* Blank enable (no longer used on AGA) */
DECL|macro|BMC0_CSYTRUE
mdefine_line|#define BMC0_CSYTRUE    (0x0004) /* CSY polarity */
DECL|macro|BMC0_VSYTRUE
mdefine_line|#define BMC0_VSYTRUE    (0x0002) /* VSY polarity */
DECL|macro|BMC0_HSYTRUE
mdefine_line|#define BMC0_HSYTRUE    (0x0001) /* HSY polarity */
multiline_comment|/*&n;    *    FMODE -- Fetch Mode Control Register (AGA)&n;    */
DECL|macro|FMODE_SSCAN2
mdefine_line|#define FMODE_SSCAN2    (0x8000) /* Sprite scan-doubling */
DECL|macro|FMODE_BSCAN2
mdefine_line|#define FMODE_BSCAN2    (0x4000) /* Use PF2 modulus every other line */
DECL|macro|FMODE_SPAGEM
mdefine_line|#define FMODE_SPAGEM    (0x0008) /* Sprite page mode */
DECL|macro|FMODE_SPR32
mdefine_line|#define FMODE_SPR32     (0x0004) /* Sprite 32 bit fetch */
DECL|macro|FMODE_BPAGEM
mdefine_line|#define FMODE_BPAGEM    (0x0002) /* Bitplane page mode */
DECL|macro|FMODE_BPL32
mdefine_line|#define FMODE_BPL32     (0x0001) /* Bitplane 32 bit fetch */
multiline_comment|/*&n;    *    Tags used to indicate a specific Pixel Clock&n;    *&n;    *    clk_shift is the shift value to get the timings in 35 ns units&n;    */
DECL|macro|TAG_SHRES
mdefine_line|#define TAG_SHRES       (1)      /* SHRES, clk_shift = TAG_SHRES-1 */
DECL|macro|TAG_HIRES
mdefine_line|#define TAG_HIRES       (2)      /* HIRES, clk_shift = TAG_HIRES-1 */
DECL|macro|TAG_LORES
mdefine_line|#define TAG_LORES       (3)      /* LORES, clk_shift = TAG_LORES-1 */
multiline_comment|/*&n;    *    Clock Definitions, Maximum Display Depth&n;    *&n;    *    These depend on the E-Clock or the Chipset, so they are filled in&n;    *    dynamically&n;    */
DECL|variable|pixclock
r_static
id|u_long
id|pixclock
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* SHRES/HIRES/LORES: index = clk_shift */
DECL|variable|maxdepth
r_static
id|u_short
id|maxdepth
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* SHRES/HIRES/LORES: index = clk_shift */
multiline_comment|/*&n;    *    Broadcast Video Timings&n;    *&n;    *    Horizontal values are in 35 ns (SHRES) units&n;    *    Vertical values are in non-interlaced scanlines&n;    */
DECL|macro|PAL_WINDOW_H
mdefine_line|#define PAL_WINDOW_H    (1472)   /* PAL Window Limits */
DECL|macro|PAL_WINDOW_V
mdefine_line|#define PAL_WINDOW_V    (288)
DECL|macro|PAL_DIWSTRT_H
mdefine_line|#define PAL_DIWSTRT_H   (360)
DECL|macro|PAL_DIWSTRT_V
mdefine_line|#define PAL_DIWSTRT_V   (24)
DECL|macro|NTSC_WINDOW_H
mdefine_line|#define NTSC_WINDOW_H   (1472)   /* NTSC Window Limits */
DECL|macro|NTSC_WINDOW_V
mdefine_line|#define NTSC_WINDOW_V   (242)
DECL|macro|NTSC_DIWSTRT_H
mdefine_line|#define NTSC_DIWSTRT_H  (360)
DECL|macro|NTSC_DIWSTRT_V
mdefine_line|#define NTSC_DIWSTRT_V  (20)
DECL|macro|PAL_HTOTAL
mdefine_line|#define PAL_HTOTAL      (1816)   /* Total line length */
DECL|macro|NTSC_HTOTAL
mdefine_line|#define NTSC_HTOTAL     (1816)   /* Needed for YWRAP */
multiline_comment|/*&n;    *    Monitor Specifications&n;    *&n;    *    These are typical for a `generic&squot; Amiga monitor (e.g. A1960)&n;    */
DECL|variable|vfmin
DECL|variable|vfmax
DECL|variable|hfmin
DECL|variable|hfmax
r_static
r_int
id|vfmin
op_assign
l_int|50
comma
id|vfmax
op_assign
l_int|90
comma
id|hfmin
op_assign
l_int|15000
comma
id|hfmax
op_assign
l_int|38000
suffix:semicolon
DECL|variable|pwrsave
r_static
id|u_short
id|pwrsave
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* VESA suspend mode (not for PAL/NTSC) */
multiline_comment|/*&n;    *    Various macros&n;    */
DECL|macro|up8
mdefine_line|#define up8(x)          (((x)+7) &amp; ~7)
DECL|macro|down8
mdefine_line|#define down8(x)        ((x) &amp; ~7)
DECL|macro|div8
mdefine_line|#define div8(x)         ((x)&gt;&gt;3)
DECL|macro|mod8
mdefine_line|#define mod8(x)         ((x) &amp; 7)
DECL|macro|up16
mdefine_line|#define up16(x)         (((x)+15) &amp; ~15)
DECL|macro|down16
mdefine_line|#define down16(x)       ((x) &amp; ~15)
DECL|macro|div16
mdefine_line|#define div16(x)        ((x)&gt;&gt;4)
DECL|macro|mod16
mdefine_line|#define mod16(x)        ((x) &amp; 15)
DECL|macro|up32
mdefine_line|#define up32(x)         (((x)+31) &amp; ~31)
DECL|macro|down32
mdefine_line|#define down32(x)       ((x) &amp; ~31)
DECL|macro|div32
mdefine_line|#define div32(x)        ((x)&gt;&gt;5)
DECL|macro|mod32
mdefine_line|#define mod32(x)        ((x) &amp; 31)
DECL|macro|up64
mdefine_line|#define up64(x)         (((x)+63) &amp; ~63)
DECL|macro|down64
mdefine_line|#define down64(x)       ((x) &amp; ~63)
DECL|macro|div64
mdefine_line|#define div64(x)        ((x)&gt;&gt;6)
DECL|macro|mod64
mdefine_line|#define mod64(x)        ((x) &amp; 63)
DECL|macro|min
mdefine_line|#define min(a, b)       ((a) &lt; (b) ? (a) : (b))
DECL|macro|max
mdefine_line|#define max(a, b)       ((a) &gt; (b) ? (a) : (b))
DECL|macro|highw
mdefine_line|#define highw(x)        ((u_long)(x)&gt;&gt;16 &amp; 0xffff)
DECL|macro|loww
mdefine_line|#define loww(x)         ((u_long)(x) &amp; 0xffff)
DECL|macro|arraysize
mdefine_line|#define arraysize(x)    (sizeof(x)/sizeof(*(x)))
multiline_comment|/*&n;    *    Chip RAM we reserve for the Frame Buffer&n;    *&n;    *    This defines the Maximum Virtual Screen Size&n;    */
DECL|macro|VIDEOMEMSIZE_AGA_2M
mdefine_line|#define VIDEOMEMSIZE_AGA_2M   (1280*1024)    /* AGA (2MB) : max 1280*1024*256 */
DECL|macro|VIDEOMEMSIZE_AGA_1M
mdefine_line|#define VIDEOMEMSIZE_AGA_1M   (1024*768)     /* AGA (1MB) : max 1024*768*256 */
DECL|macro|VIDEOMEMSIZE_ECS_2M
mdefine_line|#define VIDEOMEMSIZE_ECS_2M   (1280*1024/2)  /* ECS (2MB) : max 1280*1024*16 */
DECL|macro|VIDEOMEMSIZE_ECS_1M
mdefine_line|#define VIDEOMEMSIZE_ECS_1M   (1024*768/2)   /* ECS (1MB) : max 1024*768*16 */
DECL|macro|VIDEOMEMSIZE_OCS
mdefine_line|#define VIDEOMEMSIZE_OCS      (800*600/2)    /* OCS      : max 800*600*16 */
DECL|variable|videomemory
r_static
id|u_long
id|videomemory
suffix:semicolon
DECL|variable|videomemorysize
r_static
id|u_long
id|videomemorysize
suffix:semicolon
DECL|macro|assignchunk
mdefine_line|#define assignchunk(name, type, ptr, size) &bslash;&n;{ &bslash;&n;   (name) = (type)(ptr); &bslash;&n;   ptr += size; &bslash;&n;}
multiline_comment|/*&n;    *    Copper Instructions&n;    */
DECL|macro|CMOVE
mdefine_line|#define CMOVE(val, reg)       (CUSTOM_OFS(reg)&lt;&lt;16 | (val))
DECL|macro|CMOVE2
mdefine_line|#define CMOVE2(val, reg)      ((CUSTOM_OFS(reg)+2)&lt;&lt;16 | (val))
DECL|macro|CWAIT
mdefine_line|#define CWAIT(x, y)           (((y) &amp; 0xff)&lt;&lt;24 | ((x) &amp; 0xfe)&lt;&lt;16 | 0x0001fffe)
DECL|macro|CEND
mdefine_line|#define CEND                  (0xfffffffe)
r_typedef
r_union
(brace
DECL|member|l
id|u_long
id|l
suffix:semicolon
DECL|member|w
id|u_short
id|w
(braket
l_int|2
)braket
suffix:semicolon
DECL|typedef|copins
)brace
id|copins
suffix:semicolon
multiline_comment|/*&n;    *    Frame Header Copper List&n;    */
DECL|struct|clist_hdr
r_struct
id|clist_hdr
(brace
DECL|member|bplcon0
id|copins
id|bplcon0
suffix:semicolon
DECL|member|diwstrt
id|copins
id|diwstrt
suffix:semicolon
DECL|member|diwstop
id|copins
id|diwstop
suffix:semicolon
DECL|member|diwhigh
id|copins
id|diwhigh
suffix:semicolon
DECL|member|sprfix
id|copins
id|sprfix
(braket
l_int|8
)braket
suffix:semicolon
DECL|member|sprstrtup
id|copins
id|sprstrtup
(braket
l_int|16
)braket
suffix:semicolon
DECL|member|wait
id|copins
id|wait
suffix:semicolon
DECL|member|jump
id|copins
id|jump
suffix:semicolon
DECL|member|wait_forever
id|copins
id|wait_forever
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n;    *    Long Frame/Short Frame Copper List&n;    */
DECL|struct|clist_dyn
r_struct
id|clist_dyn
(brace
DECL|member|diwstrt
id|copins
id|diwstrt
suffix:semicolon
DECL|member|diwstop
id|copins
id|diwstop
suffix:semicolon
DECL|member|diwhigh
id|copins
id|diwhigh
suffix:semicolon
DECL|member|bplcon0
id|copins
id|bplcon0
suffix:semicolon
DECL|member|sprpt
id|copins
id|sprpt
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* Sprite 0 */
DECL|member|rest
id|copins
id|rest
(braket
l_int|64
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|clist_hdr
r_static
r_struct
id|clist_hdr
op_star
id|clist_hdr
suffix:semicolon
DECL|variable|clist_lof
r_static
r_struct
id|clist_dyn
op_star
id|clist_lof
suffix:semicolon
DECL|variable|clist_shf
r_static
r_struct
id|clist_dyn
op_star
id|clist_shf
suffix:semicolon
multiline_comment|/* Only used for Interlace */
multiline_comment|/*&n;    *    Hardware Cursor&n;    */
DECL|macro|CRSR_RATE
mdefine_line|#define CRSR_RATE       (20)     /* Number of frames/flash toggle */
DECL|variable|lofsprite
DECL|variable|shfsprite
DECL|variable|dummysprite
r_static
id|u_long
op_star
id|lofsprite
comma
op_star
id|shfsprite
comma
op_star
id|dummysprite
suffix:semicolon
DECL|variable|cursormode
r_static
id|u_short
id|cursormode
op_assign
id|FB_CURSOR_FLASH
suffix:semicolon
multiline_comment|/*&n;    *    Current Video Mode&n;    */
DECL|struct|amiga_fb_par
r_struct
id|amiga_fb_par
(brace
multiline_comment|/* General Values */
DECL|member|xres
r_int
id|xres
suffix:semicolon
multiline_comment|/* vmode */
DECL|member|yres
r_int
id|yres
suffix:semicolon
multiline_comment|/* vmode */
DECL|member|vxres
r_int
id|vxres
suffix:semicolon
multiline_comment|/* vmode */
DECL|member|vyres
r_int
id|vyres
suffix:semicolon
multiline_comment|/* vmode */
DECL|member|xoffset
r_int
id|xoffset
suffix:semicolon
multiline_comment|/* vmode */
DECL|member|yoffset
r_int
id|yoffset
suffix:semicolon
multiline_comment|/* vmode */
DECL|member|bpp
id|u_short
id|bpp
suffix:semicolon
multiline_comment|/* vmode */
DECL|member|clk_shift
id|u_short
id|clk_shift
suffix:semicolon
multiline_comment|/* vmode */
DECL|member|vmode
r_int
id|vmode
suffix:semicolon
multiline_comment|/* vmode */
DECL|member|diwstrt_h
id|u_short
id|diwstrt_h
suffix:semicolon
multiline_comment|/* vmode */
DECL|member|diwstrt_v
id|u_short
id|diwstrt_v
suffix:semicolon
multiline_comment|/* vmode */
DECL|member|next_line
id|u_long
id|next_line
suffix:semicolon
multiline_comment|/* modulo for next line */
DECL|member|next_plane
id|u_long
id|next_plane
suffix:semicolon
multiline_comment|/* modulo for next plane */
DECL|member|crsr_x
r_int
id|crsr_x
suffix:semicolon
multiline_comment|/* movecursor */
DECL|member|crsr_y
r_int
id|crsr_y
suffix:semicolon
multiline_comment|/* movecursor */
multiline_comment|/* OCS Hardware Registers */
DECL|member|bplpt0
id|u_long
id|bplpt0
suffix:semicolon
multiline_comment|/* vmode, pan (Note: physical address) */
DECL|member|bplcon0
id|u_short
id|bplcon0
suffix:semicolon
multiline_comment|/* vmode */
DECL|member|bplcon1
id|u_short
id|bplcon1
suffix:semicolon
multiline_comment|/* vmode, pan */
DECL|member|bpl1mod
id|u_short
id|bpl1mod
suffix:semicolon
multiline_comment|/* vmode, pan */
DECL|member|bpl2mod
id|u_short
id|bpl2mod
suffix:semicolon
multiline_comment|/* vmode, pan */
DECL|member|diwstrt
id|u_short
id|diwstrt
suffix:semicolon
multiline_comment|/* vmode */
DECL|member|diwstop
id|u_short
id|diwstop
suffix:semicolon
multiline_comment|/* vmode */
DECL|member|ddfstrt
id|u_short
id|ddfstrt
suffix:semicolon
multiline_comment|/* vmode, pan */
DECL|member|ddfstop
id|u_short
id|ddfstop
suffix:semicolon
multiline_comment|/* vmode, pan */
macro_line|#if defined(CONFIG_AMIFB_ECS) || defined(CONFIG_AMIFB_AGA)
multiline_comment|/* Additional ECS Hardware Registers */
DECL|member|diwhigh
id|u_short
id|diwhigh
suffix:semicolon
multiline_comment|/* vmode */
DECL|member|bplcon3
id|u_short
id|bplcon3
suffix:semicolon
multiline_comment|/* vmode */
DECL|member|beamcon0
id|u_short
id|beamcon0
suffix:semicolon
multiline_comment|/* vmode */
DECL|member|htotal
id|u_short
id|htotal
suffix:semicolon
multiline_comment|/* vmode */
DECL|member|hsstrt
id|u_short
id|hsstrt
suffix:semicolon
multiline_comment|/* vmode */
DECL|member|hsstop
id|u_short
id|hsstop
suffix:semicolon
multiline_comment|/* vmode */
DECL|member|vtotal
id|u_short
id|vtotal
suffix:semicolon
multiline_comment|/* vmode */
DECL|member|vsstrt
id|u_short
id|vsstrt
suffix:semicolon
multiline_comment|/* vmode */
DECL|member|vsstop
id|u_short
id|vsstop
suffix:semicolon
multiline_comment|/* vmode */
DECL|member|hcenter
id|u_short
id|hcenter
suffix:semicolon
multiline_comment|/* vmode */
macro_line|#endif /* defined(CONFIG_AMIFB_ECS) || defined(CONFIG_AMIFB_AGA) */
macro_line|#if defined(CONFIG_AMIFB_AGA)
multiline_comment|/* Additional AGA Hardware Registers */
DECL|member|fmode
id|u_short
id|fmode
suffix:semicolon
multiline_comment|/* vmode */
macro_line|#endif /* defined(CONFIG_AMIFB_AGA) */
)brace
suffix:semicolon
DECL|variable|current_par
r_static
r_struct
id|amiga_fb_par
id|current_par
suffix:semicolon
DECL|variable|current_par_valid
r_static
r_int
id|current_par_valid
op_assign
l_int|0
suffix:semicolon
DECL|variable|currcon
r_static
r_int
id|currcon
op_assign
l_int|0
suffix:semicolon
DECL|variable|disp
r_static
r_struct
id|display
id|disp
(braket
id|MAX_NR_CONSOLES
)braket
suffix:semicolon
DECL|variable|fb_info
r_static
r_struct
id|fb_info
id|fb_info
suffix:semicolon
DECL|variable|node
r_static
r_int
id|node
suffix:semicolon
multiline_comment|/* node of the /dev/fb?current file */
multiline_comment|/*&n;    *    The minimum period for audio depends on htotal (for OCS/ECS/AGA)&n;    */
DECL|variable|amiga_audio_min_period
r_volatile
id|u_short
id|amiga_audio_min_period
op_assign
l_int|124
suffix:semicolon
multiline_comment|/* Default for pre-OCS */
multiline_comment|/*&n;    *    Since we can&squot;t read the palette on OCS/ECS, and since reading one&n;    *    single color palette entry requires 5 expensive custom chip bus&n;    *    accesses on AGA, we keep a copy of the current palette.&n;    */
macro_line|#ifdef CONFIG_AMIFB_AGA
DECL|member|red
DECL|member|green
DECL|member|blue
DECL|member|pad
DECL|variable|palette
r_static
r_struct
(brace
id|u_char
id|red
comma
id|green
comma
id|blue
comma
id|pad
suffix:semicolon
)brace
id|palette
(braket
l_int|256
)braket
suffix:semicolon
macro_line|#else /* CONFIG_AMIFB_AGA */
DECL|member|red
DECL|member|green
DECL|member|blue
DECL|member|pad
DECL|variable|palette
r_static
r_struct
(brace
id|u_char
id|red
comma
id|green
comma
id|blue
comma
id|pad
suffix:semicolon
)brace
id|palette
(braket
l_int|32
)braket
suffix:semicolon
macro_line|#endif /* CONFIG_AMIFB_AGA */
multiline_comment|/*&n;    *    Latches and Flags for display changes during VBlank&n;    */
DECL|variable|do_vmode
r_static
r_volatile
id|u_short
id|do_vmode
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Change the Video Mode */
DECL|variable|do_blank
r_static
r_volatile
r_int
id|do_blank
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* (Un)Blank the Screen (&#xfffd;1) */
DECL|variable|do_movecursor
r_static
r_volatile
id|u_short
id|do_movecursor
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Move the Cursor */
DECL|variable|full_vmode_change
r_static
r_volatile
id|u_short
id|full_vmode_change
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Full Change or Only Pan */
DECL|variable|is_blanked
r_static
r_volatile
id|u_short
id|is_blanked
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Screen is Blanked */
multiline_comment|/*&n;    *    Switch for Chipset Independency&n;    */
DECL|struct|fb_hwswitch
r_static
r_struct
id|fb_hwswitch
(brace
multiline_comment|/* Initialization */
DECL|member|init
r_int
(paren
op_star
id|init
)paren
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/* Display Control */
DECL|member|encode_fix
r_int
(paren
op_star
id|encode_fix
)paren
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_struct
id|amiga_fb_par
op_star
id|par
)paren
suffix:semicolon
DECL|member|decode_var
r_int
(paren
op_star
id|decode_var
)paren
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|amiga_fb_par
op_star
id|par
)paren
suffix:semicolon
DECL|member|encode_var
r_int
(paren
op_star
id|encode_var
)paren
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|amiga_fb_par
op_star
id|par
)paren
suffix:semicolon
DECL|member|getcolreg
r_int
(paren
op_star
id|getcolreg
)paren
(paren
id|u_int
id|regno
comma
id|u_int
op_star
id|red
comma
id|u_int
op_star
id|green
comma
id|u_int
op_star
id|blue
comma
id|u_int
op_star
id|transp
)paren
suffix:semicolon
DECL|member|setcolreg
r_int
(paren
op_star
id|setcolreg
)paren
(paren
id|u_int
id|regno
comma
id|u_int
id|red
comma
id|u_int
id|green
comma
id|u_int
id|blue
comma
id|u_int
id|transp
)paren
suffix:semicolon
DECL|member|pan_display
r_int
(paren
op_star
id|pan_display
)paren
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|amiga_fb_par
op_star
id|par
)paren
suffix:semicolon
multiline_comment|/* Routines Called by VBlank Interrupt to minimize flicker */
DECL|member|do_vmode
r_void
(paren
op_star
id|do_vmode
)paren
(paren
r_void
)paren
suffix:semicolon
DECL|member|do_blank
r_void
(paren
op_star
id|do_blank
)paren
(paren
r_int
id|blank
)paren
suffix:semicolon
DECL|member|do_movecursor
r_void
(paren
op_star
id|do_movecursor
)paren
(paren
r_void
)paren
suffix:semicolon
DECL|member|do_flashcursor
r_void
(paren
op_star
id|do_flashcursor
)paren
(paren
r_void
)paren
suffix:semicolon
DECL|variable|fbhw
)brace
op_star
id|fbhw
suffix:semicolon
multiline_comment|/*&n;    *    Frame Buffer Name&n;    *&n;    *    The rest of the name is filled in by amiga_fb_init&n;    */
DECL|variable|amiga_fb_name
r_static
r_char
id|amiga_fb_name
(braket
l_int|16
)braket
op_assign
l_string|&quot;Amiga &quot;
suffix:semicolon
multiline_comment|/*&n;    *    Predefined Video Mode Names&n;    *&n;    *    The a2024-?? modes don&squot;t work yet because there&squot;s no A2024 driver.&n;    */
DECL|variable|amiga_fb_modenames
r_static
r_char
op_star
id|amiga_fb_modenames
(braket
)braket
op_assign
(brace
multiline_comment|/*&n;    *    Autodetect (Default) Video Mode&n;    */
l_string|&quot;default&quot;
comma
multiline_comment|/*&n;    *    AmigaOS Video Modes&n;    */
l_string|&quot;ntsc&quot;
comma
multiline_comment|/* 640x200, 15 kHz, 60 Hz (NTSC) */
l_string|&quot;ntsc-lace&quot;
comma
multiline_comment|/* 640x400, 15 kHz, 60 Hz interlaced (NTSC) */
l_string|&quot;pal&quot;
comma
multiline_comment|/* 640x256, 15 kHz, 50 Hz (PAL) */
l_string|&quot;pal-lace&quot;
comma
multiline_comment|/* 640x512, 15 kHz, 50 Hz interlaced (PAL) */
l_string|&quot;multiscan&quot;
comma
multiline_comment|/* 640x480, 29 kHz, 57 Hz */
l_string|&quot;multiscan-lace&quot;
comma
multiline_comment|/* 640x960, 29 kHz, 57 Hz interlaced */
l_string|&quot;a2024-10&quot;
comma
multiline_comment|/* 1024x800, 10 Hz (Not yet supported) */
l_string|&quot;a2024-15&quot;
comma
multiline_comment|/* 1024x800, 15 Hz (Not yet supported) */
l_string|&quot;euro36&quot;
comma
multiline_comment|/* 640x200, 15 kHz, 72 Hz */
l_string|&quot;euro36-lace&quot;
comma
multiline_comment|/* 640x400, 15 kHz, 72 Hz interlaced */
l_string|&quot;euro72&quot;
comma
multiline_comment|/* 640x400, 29 kHz, 68 Hz */
l_string|&quot;euro72-lace&quot;
comma
multiline_comment|/* 640x800, 29 kHz, 68 Hz interlaced */
l_string|&quot;super72&quot;
comma
multiline_comment|/* 800x300, 23 kHz, 70 Hz */
l_string|&quot;super72-lace&quot;
comma
multiline_comment|/* 800x600, 23 kHz, 70 Hz interlaced */
l_string|&quot;dblntsc&quot;
comma
multiline_comment|/* 640x200, 27 kHz, 57 Hz doublescan */
l_string|&quot;dblntsc-ff&quot;
comma
multiline_comment|/* 640x400, 27 kHz, 57 Hz */
l_string|&quot;dblntsc-lace&quot;
comma
multiline_comment|/* 640x800, 27 kHz, 57 Hz interlaced */
l_string|&quot;dblpal&quot;
comma
multiline_comment|/* 640x256, 27 kHz, 47 Hz doublescan */
l_string|&quot;dblpal-ff&quot;
comma
multiline_comment|/* 640x512, 27 kHz, 47 Hz */
l_string|&quot;dblpal-lace&quot;
comma
multiline_comment|/* 640x1024, 27 kHz, 47 Hz interlaced */
multiline_comment|/*&n;    *    VGA Video Modes&n;    */
l_string|&quot;vga&quot;
comma
multiline_comment|/* 640x480, 31 kHz, 60 Hz (VGA) */
l_string|&quot;vga70&quot;
comma
multiline_comment|/* 640x400, 31 kHz, 70 Hz (VGA) */
multiline_comment|/*&n;    *    User Defined Video Modes: to be set after boot up using e.g. fbset&n;    */
l_string|&quot;user0&quot;
comma
l_string|&quot;user1&quot;
comma
l_string|&quot;user2&quot;
comma
l_string|&quot;user3&quot;
comma
l_string|&quot;user4&quot;
comma
l_string|&quot;user5&quot;
comma
l_string|&quot;user6&quot;
comma
l_string|&quot;user7&quot;
)brace
suffix:semicolon
multiline_comment|/*&n;    *    Predefined Video Mode Definitions&n;    *&n;    *    Since the actual pixclock values depend on the E-Clock, we use the&n;    *    TAG_* values and fill in the real values during initialization.&n;    *    Thus we assume no one has pixel clocks of 333, 500 or 1000 GHz :-)&n;    */
DECL|variable|amiga_fb_predefined
r_static
r_struct
id|fb_var_screeninfo
id|amiga_fb_predefined
(braket
)braket
op_assign
(brace
multiline_comment|/*&n;    *    Autodetect (Default) Video Mode&n;    */
(brace
l_int|0
comma
)brace
comma
multiline_comment|/*&n;    *    AmigaOS Video Modes&n;    */
(brace
multiline_comment|/* ntsc */
l_int|640
comma
l_int|200
comma
l_int|640
comma
l_int|200
comma
l_int|0
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|FB_ACCEL_NONE
comma
id|TAG_HIRES
comma
l_int|78
comma
l_int|18
comma
l_int|24
comma
l_int|18
comma
l_int|0
comma
l_int|0
comma
id|FB_SYNC_BROADCAST
comma
id|FB_VMODE_NONINTERLACED
)brace
comma
(brace
multiline_comment|/* ntsc-lace */
l_int|640
comma
l_int|400
comma
l_int|640
comma
l_int|400
comma
l_int|0
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|FB_ACCEL_NONE
comma
id|TAG_HIRES
comma
l_int|78
comma
l_int|18
comma
l_int|48
comma
l_int|36
comma
l_int|0
comma
l_int|0
comma
id|FB_SYNC_BROADCAST
comma
id|FB_VMODE_INTERLACED
)brace
comma
(brace
multiline_comment|/* pal */
l_int|640
comma
l_int|256
comma
l_int|640
comma
l_int|256
comma
l_int|0
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|FB_ACCEL_NONE
comma
id|TAG_HIRES
comma
l_int|78
comma
l_int|18
comma
l_int|20
comma
l_int|12
comma
l_int|0
comma
l_int|0
comma
id|FB_SYNC_BROADCAST
comma
id|FB_VMODE_NONINTERLACED
)brace
comma
(brace
multiline_comment|/* pal-lace */
l_int|640
comma
l_int|512
comma
l_int|640
comma
l_int|512
comma
l_int|0
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|FB_ACCEL_NONE
comma
id|TAG_HIRES
comma
l_int|78
comma
l_int|18
comma
l_int|40
comma
l_int|24
comma
l_int|0
comma
l_int|0
comma
id|FB_SYNC_BROADCAST
comma
id|FB_VMODE_INTERLACED
)brace
comma
(brace
multiline_comment|/* multiscan */
l_int|640
comma
l_int|480
comma
l_int|640
comma
l_int|480
comma
l_int|0
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|FB_ACCEL_NONE
comma
id|TAG_SHRES
comma
l_int|164
comma
l_int|92
comma
l_int|9
comma
l_int|9
comma
l_int|80
comma
l_int|8
comma
l_int|0
comma
id|FB_VMODE_NONINTERLACED
)brace
comma
(brace
multiline_comment|/* multiscan-lace */
l_int|640
comma
l_int|960
comma
l_int|640
comma
l_int|960
comma
l_int|0
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|FB_ACCEL_NONE
comma
id|TAG_SHRES
comma
l_int|164
comma
l_int|92
comma
l_int|18
comma
l_int|18
comma
l_int|80
comma
l_int|16
comma
l_int|0
comma
id|FB_VMODE_INTERLACED
)brace
comma
(brace
multiline_comment|/* a2024-10 (Not yet supported) */
l_int|1024
comma
l_int|800
comma
l_int|1024
comma
l_int|800
comma
l_int|0
comma
l_int|0
comma
l_int|2
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|2
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|2
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|2
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|FB_ACCEL_NONE
comma
id|TAG_HIRES
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|FB_VMODE_NONINTERLACED
)brace
comma
(brace
multiline_comment|/* a2024-15 (Not yet supported) */
l_int|1024
comma
l_int|800
comma
l_int|1024
comma
l_int|800
comma
l_int|0
comma
l_int|0
comma
l_int|2
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|2
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|2
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|2
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|FB_ACCEL_NONE
comma
id|TAG_HIRES
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|FB_VMODE_NONINTERLACED
)brace
comma
(brace
multiline_comment|/* euro36 */
l_int|640
comma
l_int|200
comma
l_int|640
comma
l_int|200
comma
l_int|0
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|FB_ACCEL_NONE
comma
id|TAG_HIRES
comma
l_int|92
comma
l_int|124
comma
l_int|6
comma
l_int|6
comma
l_int|52
comma
l_int|5
comma
l_int|0
comma
id|FB_VMODE_NONINTERLACED
)brace
comma
(brace
multiline_comment|/* euro36-lace */
l_int|640
comma
l_int|400
comma
l_int|640
comma
l_int|400
comma
l_int|0
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|FB_ACCEL_NONE
comma
id|TAG_HIRES
comma
l_int|92
comma
l_int|124
comma
l_int|12
comma
l_int|12
comma
l_int|52
comma
l_int|10
comma
l_int|0
comma
id|FB_VMODE_INTERLACED
)brace
comma
(brace
multiline_comment|/* euro72 */
l_int|640
comma
l_int|400
comma
l_int|640
comma
l_int|400
comma
l_int|0
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|FB_ACCEL_NONE
comma
id|TAG_SHRES
comma
l_int|164
comma
l_int|92
comma
l_int|9
comma
l_int|9
comma
l_int|80
comma
l_int|8
comma
l_int|0
comma
id|FB_VMODE_NONINTERLACED
)brace
comma
(brace
multiline_comment|/* euro72-lace */
l_int|640
comma
l_int|800
comma
l_int|640
comma
l_int|800
comma
l_int|0
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|FB_ACCEL_NONE
comma
id|TAG_SHRES
comma
l_int|164
comma
l_int|92
comma
l_int|18
comma
l_int|18
comma
l_int|80
comma
l_int|16
comma
l_int|0
comma
id|FB_VMODE_INTERLACED
)brace
comma
(brace
multiline_comment|/* super72 */
l_int|800
comma
l_int|300
comma
l_int|800
comma
l_int|300
comma
l_int|0
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|FB_ACCEL_NONE
comma
id|TAG_SHRES
comma
l_int|212
comma
l_int|140
comma
l_int|10
comma
l_int|11
comma
l_int|80
comma
l_int|7
comma
l_int|0
comma
id|FB_VMODE_NONINTERLACED
)brace
comma
(brace
multiline_comment|/* super72-lace */
l_int|800
comma
l_int|600
comma
l_int|800
comma
l_int|600
comma
l_int|0
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|FB_ACCEL_NONE
comma
id|TAG_SHRES
comma
l_int|212
comma
l_int|140
comma
l_int|20
comma
l_int|22
comma
l_int|80
comma
l_int|14
comma
l_int|0
comma
id|FB_VMODE_INTERLACED
)brace
comma
(brace
multiline_comment|/* dblntsc */
l_int|640
comma
l_int|200
comma
l_int|640
comma
l_int|200
comma
l_int|0
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|FB_ACCEL_NONE
comma
id|TAG_SHRES
comma
l_int|196
comma
l_int|124
comma
l_int|18
comma
l_int|17
comma
l_int|80
comma
l_int|4
comma
l_int|0
comma
id|FB_VMODE_DOUBLE
)brace
comma
(brace
multiline_comment|/* dblntsc-ff */
l_int|640
comma
l_int|400
comma
l_int|640
comma
l_int|400
comma
l_int|0
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|FB_ACCEL_NONE
comma
id|TAG_SHRES
comma
l_int|196
comma
l_int|124
comma
l_int|36
comma
l_int|35
comma
l_int|80
comma
l_int|7
comma
l_int|0
comma
id|FB_VMODE_NONINTERLACED
)brace
comma
(brace
multiline_comment|/* dblntsc-lace */
l_int|640
comma
l_int|800
comma
l_int|640
comma
l_int|800
comma
l_int|0
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|FB_ACCEL_NONE
comma
id|TAG_SHRES
comma
l_int|196
comma
l_int|124
comma
l_int|72
comma
l_int|70
comma
l_int|80
comma
l_int|14
comma
l_int|0
comma
id|FB_VMODE_INTERLACED
)brace
comma
(brace
multiline_comment|/* dblpal */
l_int|640
comma
l_int|256
comma
l_int|640
comma
l_int|256
comma
l_int|0
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|FB_ACCEL_NONE
comma
id|TAG_SHRES
comma
l_int|196
comma
l_int|124
comma
l_int|14
comma
l_int|13
comma
l_int|80
comma
l_int|4
comma
l_int|0
comma
id|FB_VMODE_DOUBLE
)brace
comma
(brace
multiline_comment|/* dblpal-ff */
l_int|640
comma
l_int|512
comma
l_int|640
comma
l_int|512
comma
l_int|0
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|FB_ACCEL_NONE
comma
id|TAG_SHRES
comma
l_int|196
comma
l_int|124
comma
l_int|28
comma
l_int|27
comma
l_int|80
comma
l_int|7
comma
l_int|0
comma
id|FB_VMODE_NONINTERLACED
)brace
comma
(brace
multiline_comment|/* dblpal-lace */
l_int|640
comma
l_int|1024
comma
l_int|640
comma
l_int|1024
comma
l_int|0
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|FB_ACCEL_NONE
comma
id|TAG_SHRES
comma
l_int|196
comma
l_int|124
comma
l_int|56
comma
l_int|54
comma
l_int|80
comma
l_int|14
comma
l_int|0
comma
id|FB_VMODE_INTERLACED
)brace
comma
multiline_comment|/*&n;    *    VGA Video Modes&n;    */
(brace
multiline_comment|/* vga */
l_int|640
comma
l_int|480
comma
l_int|640
comma
l_int|480
comma
l_int|0
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|FB_ACCEL_NONE
comma
id|TAG_SHRES
comma
l_int|64
comma
l_int|96
comma
l_int|30
comma
l_int|9
comma
l_int|112
comma
l_int|2
comma
l_int|0
comma
id|FB_VMODE_NONINTERLACED
)brace
comma
(brace
multiline_comment|/* vga70 */
l_int|640
comma
l_int|400
comma
l_int|640
comma
l_int|400
comma
l_int|0
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|FB_ACCEL_NONE
comma
id|TAG_SHRES
comma
l_int|64
comma
l_int|96
comma
l_int|35
comma
l_int|12
comma
l_int|112
comma
l_int|2
comma
id|FB_SYNC_VERT_HIGH_ACT
op_or
id|FB_SYNC_COMP_HIGH_ACT
comma
id|FB_VMODE_NONINTERLACED
)brace
comma
multiline_comment|/*&n;    *    User Defined Video Modes&n;    */
(brace
l_int|0
comma
)brace
comma
(brace
l_int|0
comma
)brace
comma
(brace
l_int|0
comma
)brace
comma
(brace
l_int|0
comma
)brace
comma
(brace
l_int|0
comma
)brace
comma
(brace
l_int|0
comma
)brace
comma
(brace
l_int|0
comma
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
DECL|macro|NUM_USER_MODES
mdefine_line|#define NUM_USER_MODES     (8)
DECL|macro|NUM_TOTAL_MODES
mdefine_line|#define NUM_TOTAL_MODES    arraysize(amiga_fb_predefined)
DECL|macro|NUM_PREDEF_MODES
mdefine_line|#define NUM_PREDEF_MODES   (NUM_TOTAL_MODES-NUM_USER_MODES)
DECL|variable|amifb_ilbm
r_static
r_int
id|amifb_ilbm
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* interleaved or normal bitplanes */
DECL|variable|amifb_inverse
r_static
r_int
id|amifb_inverse
op_assign
l_int|0
suffix:semicolon
DECL|variable|amifb_mode
r_static
r_int
id|amifb_mode
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;    *    Support for Graphics Boards&n;    */
macro_line|#ifdef CONFIG_FB_CYBER        /* Cybervision */
r_extern
r_int
id|Cyber_probe
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|Cyber_video_setup
c_func
(paren
r_char
op_star
id|options
comma
r_int
op_star
id|ints
)paren
suffix:semicolon
r_extern
r_struct
id|fb_info
op_star
id|Cyber_fb_init
c_func
(paren
r_int
op_star
id|mem_start
)paren
suffix:semicolon
DECL|variable|amifb_Cyber
r_static
r_int
id|amifb_Cyber
op_assign
l_int|0
suffix:semicolon
macro_line|#endif /* CONFIG_FB_CYBER */
multiline_comment|/*&n;    *    Some default modes&n;    */
DECL|macro|DEFMODE_PAL
mdefine_line|#define DEFMODE_PAL        &quot;pal&quot;       /* for PAL OCS/ECS */
DECL|macro|DEFMODE_NTSC
mdefine_line|#define DEFMODE_NTSC       &quot;ntsc&quot;      /* for NTSC OCS/ECS */
DECL|macro|DEFMODE_AMBER_PAL
mdefine_line|#define DEFMODE_AMBER_PAL  &quot;pal-lace&quot;  /* for flicker fixed PAL (A3000) */
DECL|macro|DEFMODE_AMBER_NTSC
mdefine_line|#define DEFMODE_AMBER_NTSC &quot;ntsc-lace&quot; /* for flicker fixed NTSC (A3000) */
DECL|macro|DEFMODE_AGA
mdefine_line|#define DEFMODE_AGA        &quot;vga70&quot;     /* for AGA */
multiline_comment|/*&n;    *    Interface used by the world&n;    */
r_void
id|amiga_video_setup
c_func
(paren
r_char
op_star
id|options
comma
r_int
op_star
id|ints
)paren
suffix:semicolon
r_static
r_int
id|amiga_fb_get_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_int
id|con
)paren
suffix:semicolon
r_static
r_int
id|amiga_fb_get_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
)paren
suffix:semicolon
r_static
r_int
id|amiga_fb_set_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
)paren
suffix:semicolon
r_static
r_int
id|amiga_fb_get_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
)paren
suffix:semicolon
r_static
r_int
id|amiga_fb_set_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
)paren
suffix:semicolon
r_static
r_int
id|amiga_fb_pan_display
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
)paren
suffix:semicolon
r_static
r_int
id|amiga_fb_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
id|u_int
id|cmd
comma
id|u_long
id|arg
comma
r_int
id|con
)paren
suffix:semicolon
r_static
r_int
id|amiga_fb_get_fix_cursorinfo
c_func
(paren
r_struct
id|fb_fix_cursorinfo
op_star
id|fix
comma
r_int
id|con
)paren
suffix:semicolon
r_static
r_int
id|amiga_fb_get_var_cursorinfo
c_func
(paren
r_struct
id|fb_var_cursorinfo
op_star
id|var
comma
r_int
id|con
)paren
suffix:semicolon
r_static
r_int
id|amiga_fb_set_var_cursorinfo
c_func
(paren
r_struct
id|fb_var_cursorinfo
op_star
id|var
comma
r_int
id|con
)paren
suffix:semicolon
r_static
r_int
id|amiga_fb_get_cursorstate
c_func
(paren
r_struct
id|fb_cursorstate
op_star
id|state
comma
r_int
id|con
)paren
suffix:semicolon
r_static
r_int
id|amiga_fb_set_cursorstate
c_func
(paren
r_struct
id|fb_cursorstate
op_star
id|state
comma
r_int
id|con
)paren
suffix:semicolon
multiline_comment|/*&n;    *    Interface to the low level console driver&n;    */
r_struct
id|fb_info
op_star
id|amiga_fb_init
c_func
(paren
r_int
op_star
id|mem_start
)paren
suffix:semicolon
r_static
r_int
id|amifb_switch
c_func
(paren
r_int
id|con
)paren
suffix:semicolon
r_static
r_int
id|amifb_updatevar
c_func
(paren
r_int
id|con
)paren
suffix:semicolon
r_static
r_void
id|amifb_blank
c_func
(paren
r_int
id|blank
)paren
suffix:semicolon
multiline_comment|/*&n;    *    Support for OCS&n;    */
macro_line|#ifdef CONFIG_AMIFB_OCS
macro_line|#error &quot;OCS support: not yet implemented&quot;
macro_line|#endif /* CONFIG_AMIFB_OCS */
multiline_comment|/*&n;    *    Support for ECS&n;    */
macro_line|#ifdef CONFIG_AMIFB_ECS
macro_line|#error &quot;ECS support: not yet implemented&quot;
macro_line|#endif /* CONFIG_AMIFB_ECS */
multiline_comment|/*&n;    *    Support for AGA&n;    */
macro_line|#ifdef CONFIG_AMIFB_AGA
r_static
r_int
id|aga_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|aga_encode_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_struct
id|amiga_fb_par
op_star
id|par
)paren
suffix:semicolon
r_static
r_int
id|aga_decode_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|amiga_fb_par
op_star
id|par
)paren
suffix:semicolon
r_static
r_int
id|aga_encode_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|amiga_fb_par
op_star
id|par
)paren
suffix:semicolon
r_static
r_int
id|aga_getcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
op_star
id|red
comma
id|u_int
op_star
id|green
comma
id|u_int
op_star
id|blue
comma
id|u_int
op_star
id|transp
)paren
suffix:semicolon
r_static
r_int
id|aga_setcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
id|red
comma
id|u_int
id|green
comma
id|u_int
id|blue
comma
id|u_int
id|transp
)paren
suffix:semicolon
r_static
r_int
id|aga_pan_display
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|amiga_fb_par
op_star
id|par
)paren
suffix:semicolon
r_static
r_void
id|aga_do_vmode
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|aga_do_blank
c_func
(paren
r_int
id|blank
)paren
suffix:semicolon
r_static
r_void
id|aga_do_movecursor
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|aga_do_flashcursor
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|aga_get_fix_cursorinfo
c_func
(paren
r_struct
id|fb_fix_cursorinfo
op_star
id|fix
comma
r_int
id|con
)paren
suffix:semicolon
r_static
r_int
id|aga_get_var_cursorinfo
c_func
(paren
r_struct
id|fb_var_cursorinfo
op_star
id|var
comma
r_int
id|con
)paren
suffix:semicolon
r_static
r_int
id|aga_set_var_cursorinfo
c_func
(paren
r_struct
id|fb_var_cursorinfo
op_star
id|var
comma
r_int
id|con
)paren
suffix:semicolon
r_static
r_int
id|aga_get_cursorstate
c_func
(paren
r_struct
id|fb_cursorstate
op_star
id|state
comma
r_int
id|con
)paren
suffix:semicolon
r_static
r_int
id|aga_set_cursorstate
c_func
(paren
r_struct
id|fb_cursorstate
op_star
id|state
comma
r_int
id|con
)paren
suffix:semicolon
r_static
id|__inline__
r_void
id|aga_build_clist_hdr
c_func
(paren
r_struct
id|clist_hdr
op_star
id|cop
)paren
suffix:semicolon
r_static
id|__inline__
r_void
id|aga_update_clist_hdr
c_func
(paren
r_struct
id|clist_hdr
op_star
id|cop
comma
r_struct
id|amiga_fb_par
op_star
id|par
)paren
suffix:semicolon
r_static
r_void
id|aga_build_clist_dyn
c_func
(paren
r_struct
id|clist_dyn
op_star
id|cop
comma
r_struct
id|clist_dyn
op_star
id|othercop
comma
id|u_short
id|shf
comma
r_struct
id|amiga_fb_par
op_star
id|par
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_AMIFB_AGA */
multiline_comment|/*&n;    *    Internal routines&n;    */
r_static
id|u_long
id|chipalloc
c_func
(paren
id|u_long
id|size
)paren
suffix:semicolon
r_static
r_void
id|amiga_fb_get_par
c_func
(paren
r_struct
id|amiga_fb_par
op_star
id|par
)paren
suffix:semicolon
r_static
r_void
id|amiga_fb_set_par
c_func
(paren
r_struct
id|amiga_fb_par
op_star
id|par
)paren
suffix:semicolon
r_static
r_int
id|do_fb_set_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|isactive
)paren
suffix:semicolon
r_static
r_struct
id|fb_cmap
op_star
id|get_default_colormap
c_func
(paren
r_int
id|bpp
)paren
suffix:semicolon
r_static
r_int
id|do_fb_get_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|kspc
)paren
suffix:semicolon
r_static
r_int
id|do_fb_set_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|kspc
)paren
suffix:semicolon
r_static
r_void
id|do_install_cmap
c_func
(paren
r_int
id|con
)paren
suffix:semicolon
r_static
r_void
id|memcpy_fs
c_func
(paren
r_int
id|fsfromto
comma
r_void
op_star
id|to
comma
r_void
op_star
id|from
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_void
id|copy_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|from
comma
r_struct
id|fb_cmap
op_star
id|to
comma
r_int
id|fsfromto
)paren
suffix:semicolon
r_static
r_int
id|alloc_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|len
comma
r_int
id|transp
)paren
suffix:semicolon
r_static
r_void
id|amiga_fb_set_disp
c_func
(paren
r_int
id|con
)paren
suffix:semicolon
r_static
r_void
id|amifb_interrupt
c_func
(paren
r_int
id|irq
comma
r_struct
id|pt_regs
op_star
id|fp
comma
r_void
op_star
id|dummy
)paren
suffix:semicolon
r_static
r_char
op_star
id|strtoke
c_func
(paren
r_char
op_star
id|s
comma
r_const
r_char
op_star
id|ct
)paren
suffix:semicolon
r_static
r_int
id|get_video_mode
c_func
(paren
r_const
r_char
op_star
id|name
)paren
suffix:semicolon
r_static
r_void
id|check_default_mode
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#ifdef USE_MONO_AMIFB_IF_NON_AGA
multiline_comment|/******************************************************************************&n;*&n;* This is the old monochrome frame buffer device. It&squot;s invoked if we&squot;re running&n;* on a non-AGA machine, until the color support for OCS/ECS is finished.&n;*&n;******************************************************************************/
multiline_comment|/*&n; * atari/atafb.c -- Low level implementation of Atari frame buffer device&n; * amiga/amifb.c -- Low level implementation of Amiga frame buffer device&n; *&n; *  Copyright (C) 1994 Martin Schaller &amp; Roman Hodek &amp; Geert Uytterhoeven&n; *  &n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file README.legal in the main directory of this archive&n; * for more details.&n; *&n; * History:&n; *   - 03 Jan 95: Original version my Martin Schaller: The TT driver and&n; *                all the device independent stuff&n; *   - 09 Jan 95: Roman: I&squot;ve added the hardware abstraction (hw_switch)&n; *                and wrote the Falcon, ST(E), and External drivers&n; *                based on the original TT driver.&n; *   - 26 Jan 95: Geert: Amiga version&n; *   - 19 Feb 95: Hamish: added Jes Sorensen&squot;s ECS patches to the Amiga&n; *&t;&t;  frame buffer device.  This provides ECS support and the&n; *&t;&t;  following screen-modes: multiscan, multiscan-lace,&n; * &t;&t;  super72, super72-lace, dblntsc, dblpal &amp; euro72.&n; *&t;&t;  He suggests that we remove the old AGA screenmodes,&n; *&t;&t;  as they are non-standard, and some of them doesn&squot;t work&n; *&t;&t;  under ECS.&n; */
DECL|struct|mono_mono_amiga_fb_par
r_static
r_struct
id|mono_mono_amiga_fb_par
(brace
DECL|member|smem_start
id|u_long
id|smem_start
suffix:semicolon
DECL|member|smem_len
id|u_long
id|smem_len
suffix:semicolon
DECL|member|geometry
r_struct
id|geometry
op_star
id|geometry
suffix:semicolon
DECL|member|scr_max_height
id|ushort
id|scr_max_height
suffix:semicolon
multiline_comment|/* screen dimensions */
DECL|member|scr_max_width
id|ushort
id|scr_max_width
suffix:semicolon
DECL|member|scr_height
id|ushort
id|scr_height
suffix:semicolon
DECL|member|scr_width
id|ushort
id|scr_width
suffix:semicolon
DECL|member|scr_depth
id|ushort
id|scr_depth
suffix:semicolon
DECL|member|bytes_per_row
r_int
id|bytes_per_row
suffix:semicolon
multiline_comment|/* offset to one line below */
DECL|member|fgcol
id|ulong
id|fgcol
suffix:semicolon
DECL|member|bgcol
id|ulong
id|bgcol
suffix:semicolon
DECL|member|crsrcol
id|ulong
id|crsrcol
suffix:semicolon
DECL|member|scroll_latch
id|ushort
id|scroll_latch
suffix:semicolon
multiline_comment|/* Vblank support for hardware scroll */
DECL|member|y_wrap
id|ushort
id|y_wrap
suffix:semicolon
DECL|member|cursor_latch
id|ushort
id|cursor_latch
suffix:semicolon
multiline_comment|/* Hardware cursor */
DECL|member|cursor
DECL|member|dummy
id|ushort
op_star
id|cursor
comma
op_star
id|dummy
suffix:semicolon
DECL|member|cursor_flash
id|ushort
id|cursor_flash
suffix:semicolon
DECL|member|cursor_visible
id|ushort
id|cursor_visible
suffix:semicolon
DECL|member|diwstrt_v
DECL|member|diwstrt_h
id|ushort
id|diwstrt_v
comma
id|diwstrt_h
suffix:semicolon
multiline_comment|/* display window control */
DECL|member|diwstop_v
DECL|member|diwstop_h
id|ushort
id|diwstop_v
comma
id|diwstop_h
suffix:semicolon
DECL|member|bplcon0
id|ushort
id|bplcon0
suffix:semicolon
multiline_comment|/* display mode */
DECL|member|htotal
id|ushort
id|htotal
suffix:semicolon
DECL|member|bitplane
id|u_char
op_star
id|bitplane
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/* pointers to display bitplanes */
DECL|member|plane_size
id|ulong
id|plane_size
suffix:semicolon
DECL|member|coplist1hdr
id|ushort
op_star
id|coplist1hdr
suffix:semicolon
multiline_comment|/* List 1 static  component */
DECL|member|coplist1dyn
id|ushort
op_star
id|coplist1dyn
suffix:semicolon
multiline_comment|/* List 1 dynamic component */
DECL|member|coplist2hdr
id|ushort
op_star
id|coplist2hdr
suffix:semicolon
multiline_comment|/* List 2 static  component */
DECL|member|coplist2dyn
id|ushort
op_star
id|coplist2dyn
suffix:semicolon
multiline_comment|/* List 2 dynamic component */
DECL|variable|mono_current_par
)brace
id|mono_current_par
suffix:semicolon
DECL|variable|mono_cursor_data
r_static
id|ushort
id|mono_cursor_data
(braket
)braket
op_assign
(brace
l_int|0x2c81
comma
l_int|0x2d00
comma
l_int|0xf000
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
)brace
suffix:semicolon
multiline_comment|/*&n; *  Color definitions&n; */
DECL|macro|FG_COLOR
mdefine_line|#define FG_COLOR&t;&t;(0x000000)&t;/* black */
DECL|macro|BG_COLOR
mdefine_line|#define BG_COLOR&t;&t;(0xaaaaaa)&t;/* lt. grey */
DECL|macro|CRSR_COLOR
mdefine_line|#define CRSR_COLOR&t;&t;(0xff0000)&t;/* bright red */
DECL|macro|FG_COLOR_INV
mdefine_line|#define FG_COLOR_INV&t;&t;BG_COLOR
DECL|macro|BG_COLOR_INV
mdefine_line|#define BG_COLOR_INV&t;&t;FG_COLOR
DECL|macro|CRSR_COLOR_INV
mdefine_line|#define CRSR_COLOR_INV&t;&t;(0x6677aa)&t;/* a blue-ish color */
multiline_comment|/*&n; *  Split 24-bit RGB colors in 12-bit MSB (for OCS/ECS/AGA) and LSB (for AGA)&n; */
DECL|macro|COLOR_MSB
mdefine_line|#define COLOR_MSB(rgb)&t;(((rgb&gt;&gt;12)&amp;0xf00)|((rgb&gt;&gt;8)&amp;0x0f0)|((rgb&gt;&gt;4)&amp;0x00f))
DECL|macro|COLOR_LSB
mdefine_line|#define COLOR_LSB(rgb)&t;(((rgb&gt;&gt;8) &amp;0xf00)|((rgb&gt;&gt;4)&amp;0x0f0)|((rgb)   &amp;0x00f))
multiline_comment|/* Cursor definitions */
DECL|macro|CRSR_FLASH
mdefine_line|#define CRSR_FLASH&t;&t;1&t;/* Cursor flashing on(1)/off(0) */
DECL|macro|CRSR_BLOCK
mdefine_line|#define CRSR_BLOCK&t;&t;1&t;/* Block(1) or line(0) cursor */
multiline_comment|/* controlling screen blanking (read in VBL handler) */
DECL|variable|mono_do_blank
r_static
r_int
id|mono_do_blank
suffix:semicolon
DECL|variable|mono_do_unblank
r_static
r_int
id|mono_do_unblank
suffix:semicolon
DECL|variable|mono_save_bplcon3
r_static
r_int
r_int
id|mono_save_bplcon3
suffix:semicolon
multiline_comment|/*&n; * mono_ecs_color_zero is used to keep custom.color[0] for the special ECS color-&n; * table, as custom.color[0] is cleared at vblank interrupts.&n; * -Jes (jds@kom.auc.dk)&n; */
DECL|variable|mono_ecs_color_zero
r_static
id|ushort
id|mono_ecs_color_zero
suffix:semicolon
r_static
r_struct
(brace
DECL|member|right_count
r_int
id|right_count
suffix:semicolon
DECL|member|done
r_int
id|done
suffix:semicolon
DECL|variable|mono_vblank
)brace
id|mono_vblank
suffix:semicolon
DECL|function|mono_init_vblank
r_static
id|__inline__
r_void
id|mono_init_vblank
c_func
(paren
r_void
)paren
(brace
id|mono_vblank.right_count
op_assign
l_int|0
suffix:semicolon
id|mono_vblank.done
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Geometry structure contains all useful information about given mode.&n; *&n; * Strictly speaking `scr_max_height&squot; and `scr_max_width&squot; is redundant&n; * information with DIWSTRT value provided. Might be useful if modes&n; * can be hotwired by user in future. It fits for the moment.&n; *&n; * At the moment, the code only distinguishes between OCS and AGA. ECS&n; * lies somewhere in between - someone more familiar with it could make&n; * appropriate modifications so that some advanced display modes are&n; * available, without confusing the poor chipset. OCS modes use only the&n; * bplcon0, diwstrt, diwstop, ddfstrt, ddfstop registers (a few others could&n; * be used as well). -wjr&n; *&n; * The code now supports ECS as well, except for FMODE all control registers&n; * are the same under ECS. A special color-table has to be generated though.&n; * -Jes&n; */
DECL|struct|geometry
r_struct
id|geometry
(brace
DECL|member|modename
r_char
op_star
id|modename
suffix:semicolon
multiline_comment|/* Name this thing */
DECL|member|isOCS
r_char
id|isOCS
suffix:semicolon
multiline_comment|/* Is it OCS or ECS/AGA */
DECL|member|bplcon0
id|ushort
id|bplcon0
suffix:semicolon
multiline_comment|/* Values for bit plane control register 0 */
DECL|member|scr_width
id|ushort
id|scr_width
suffix:semicolon
DECL|member|scr_height
id|ushort
id|scr_height
suffix:semicolon
DECL|member|scr_depth
id|ushort
id|scr_depth
suffix:semicolon
DECL|member|scr_max_width
id|ushort
id|scr_max_width
suffix:semicolon
multiline_comment|/* Historical, might be useful still */
DECL|member|scr_max_height
id|ushort
id|scr_max_height
suffix:semicolon
DECL|member|diwstrt_h
id|ushort
id|diwstrt_h
suffix:semicolon
multiline_comment|/* Where the display window starts */
DECL|member|diwstrt_v
id|ushort
id|diwstrt_v
suffix:semicolon
DECL|member|alignment
id|ushort
id|alignment
suffix:semicolon
multiline_comment|/* Pixels per scanline must be a multiple of this */
multiline_comment|/* OCS doesn&squot;t need anything past here */
DECL|member|bplcon2
id|ushort
id|bplcon2
suffix:semicolon
DECL|member|bplcon3
id|ushort
id|bplcon3
suffix:semicolon
multiline_comment|/* The rest of these control variable sync */
DECL|member|htotal
id|ushort
id|htotal
suffix:semicolon
multiline_comment|/* Total hclocks */
DECL|member|hsstrt
id|ushort
id|hsstrt
suffix:semicolon
multiline_comment|/* HSYNC start and stop */
DECL|member|hsstop
id|ushort
id|hsstop
suffix:semicolon
DECL|member|hbstrt
id|ushort
id|hbstrt
suffix:semicolon
multiline_comment|/* HBLANK start and stop */
DECL|member|hbstop
id|ushort
id|hbstop
suffix:semicolon
DECL|member|vtotal
id|ushort
id|vtotal
suffix:semicolon
multiline_comment|/* Total vlines */
DECL|member|vsstrt
id|ushort
id|vsstrt
suffix:semicolon
multiline_comment|/* VSYNC, VBLANK ditto */
DECL|member|vsstop
id|ushort
id|vsstop
suffix:semicolon
DECL|member|vbstrt
id|ushort
id|vbstrt
suffix:semicolon
DECL|member|vbstop
id|ushort
id|vbstop
suffix:semicolon
DECL|member|hcenter
id|ushort
id|hcenter
suffix:semicolon
multiline_comment|/* Center of line, for interlaced modes */
DECL|member|beamcon0
id|ushort
id|beamcon0
suffix:semicolon
multiline_comment|/* Beam control */
DECL|member|fmode
id|ushort
id|fmode
suffix:semicolon
multiline_comment|/* Memory fetch mode */
)brace
suffix:semicolon
DECL|macro|MAX_COP_LIST_ENTS
mdefine_line|#define MAX_COP_LIST_ENTS 64
DECL|macro|COP_MEM_REQ
mdefine_line|#define COP_MEM_REQ       (MAX_COP_LIST_ENTS*4*2)
DECL|macro|SPR_MEM_REQ
mdefine_line|#define SPR_MEM_REQ       (24)
DECL|variable|mono_modes
r_static
r_struct
id|geometry
id|mono_modes
(braket
)braket
op_assign
(brace
multiline_comment|/* NTSC modes: !!! can&squot;t guarantee anything about overscan modes !!! */
(brace
l_string|&quot;ntsc-lace&quot;
comma
l_int|1
comma
id|BPC0_HIRES
op_or
id|BPC0_LACE
comma
l_int|640
comma
l_int|400
comma
l_int|1
comma
l_int|704
comma
l_int|480
comma
l_int|0x71
comma
l_int|0x18
comma
multiline_comment|/* diwstrt h,v */
l_int|16
multiline_comment|/* WORD aligned */
)brace
comma
(brace
l_string|&quot;ntsc&quot;
comma
l_int|1
comma
id|BPC0_HIRES
comma
l_int|640
comma
l_int|200
comma
l_int|1
comma
l_int|704
comma
l_int|240
comma
l_int|0x71
comma
l_int|0x18
comma
l_int|16
multiline_comment|/* WORD aligned */
)brace
comma
(brace
l_string|&quot;ntsc-lace-over&quot;
comma
l_int|1
comma
id|BPC0_HIRES
op_or
id|BPC0_LACE
comma
l_int|704
comma
l_int|480
comma
l_int|1
comma
l_int|704
comma
l_int|480
comma
l_int|0x71
comma
l_int|0x18
comma
l_int|16
multiline_comment|/* WORD aligned */
)brace
comma
(brace
l_string|&quot;ntsc-over&quot;
comma
l_int|1
comma
id|BPC0_HIRES
comma
l_int|704
comma
l_int|240
comma
l_int|1
comma
l_int|704
comma
l_int|240
comma
l_int|0x71
comma
l_int|0x18
comma
l_int|16
multiline_comment|/* WORD aligned */
)brace
comma
multiline_comment|/* PAL modes. Warning:&n;&t; * &n;&t; * PAL overscan causes problems on my machine because maximum diwstop_h&n;&t; * value seems to be ~0x1c2, rather than 0x1e0+ inferred by RKM 1.1&n;&t; * and 0x1d5 inferred by original `amicon.c&squot; source. Is this a hardware&n;&t; * limitation of OCS/pal or 1084?. Or am I doing something stupid here?&n;&t; *&n;&t; * Included a couple of overscan modes that DO work on my machine,&n;&t; * although not particularly useful.&n;&t; */
(brace
l_string|&quot;pal-lace&quot;
comma
l_int|1
comma
id|BPC0_HIRES
op_or
id|BPC0_LACE
comma
l_int|640
comma
l_int|512
comma
l_int|1
comma
l_int|704
comma
l_int|592
comma
l_int|0x71
comma
l_int|0x18
comma
l_int|16
multiline_comment|/* WORD aligned */
)brace
comma
(brace
l_string|&quot;pal&quot;
comma
l_int|1
comma
id|BPC0_HIRES
comma
l_int|640
comma
l_int|256
comma
l_int|1
comma
l_int|704
comma
l_int|296
comma
l_int|0x71
comma
l_int|0x18
comma
l_int|16
multiline_comment|/* WORD aligned */
)brace
comma
(brace
l_string|&quot;pal-lace-over&quot;
comma
l_int|1
comma
id|BPC0_HIRES
op_or
id|BPC0_LACE
comma
l_int|704
comma
l_int|592
comma
l_int|1
comma
l_int|704
comma
l_int|582
comma
l_int|0x5b
comma
l_int|0x18
comma
l_int|16
multiline_comment|/* WORD aligned */
)brace
comma
(brace
l_string|&quot;pal-over&quot;
comma
l_int|1
comma
id|BPC0_HIRES
comma
l_int|704
comma
l_int|296
comma
l_int|1
comma
l_int|704
comma
l_int|296
comma
l_int|0x5b
comma
l_int|0x18
comma
l_int|16
multiline_comment|/* WORD aligned */
)brace
comma
multiline_comment|/* ECS modes, these are real ECS modes */
(brace
l_string|&quot;multiscan&quot;
comma
l_int|0
comma
id|BPC0_SHRES
op_or
id|BPC0_ECSENA
comma
multiline_comment|/* bplcon0 */
l_int|640
comma
l_int|480
comma
l_int|1
comma
l_int|640
comma
l_int|480
comma
l_int|0x0041
comma
l_int|0x002c
comma
multiline_comment|/* diwstrt h,v */
l_int|64
comma
multiline_comment|/* 64-bit aligned */
id|BPC2_KILLEHB
comma
multiline_comment|/* bplcon2 */
id|BPC3_PF2OF1
op_or
id|BPC3_PF2OF0
op_or
id|BPC3_SPRES1
op_or
id|BPC3_SPRES0
op_or
id|BPC3_BRDRBLNK
op_or
id|BPC3_EXTBLKEN
comma
multiline_comment|/* bplcon3 */
l_int|0x0072
comma
multiline_comment|/* htotal */
l_int|0x000a
comma
multiline_comment|/* hsstrt */
l_int|0x0013
comma
multiline_comment|/* hsstop */
l_int|0x0002
comma
multiline_comment|/* hbstrt */
l_int|0x001c
comma
multiline_comment|/* hbstop */
l_int|0x020c
comma
multiline_comment|/* vtotal */
l_int|0x0008
comma
multiline_comment|/* vsstrt */
l_int|0x0011
comma
multiline_comment|/* vsstop */
l_int|0x0000
comma
multiline_comment|/* vbstrt */
l_int|0x001c
comma
multiline_comment|/* vbstop */
l_int|0x0043
comma
multiline_comment|/* hcenter */
id|BMC0_VARVBEN
op_or
id|BMC0_LOLDIS
op_or
id|BMC0_VARVSYEN
op_or
id|BMC0_VARHSYEN
op_or
id|BMC0_VARBEAMEN
op_or
id|BMC0_BLANKEN
comma
multiline_comment|/* beamcon0 */
id|FMODE_BPAGEM
op_or
id|FMODE_BPL32
multiline_comment|/* fmode */
)brace
comma
(brace
l_string|&quot;multiscan-lace&quot;
comma
l_int|0
comma
id|BPC0_SHRES
op_or
id|BPC0_LACE
op_or
id|BPC0_ECSENA
comma
multiline_comment|/* bplcon0 */
l_int|640
comma
l_int|960
comma
l_int|1
comma
l_int|640
comma
l_int|960
comma
l_int|0x0041
comma
l_int|0x002c
comma
multiline_comment|/* diwstrt h,v */
l_int|64
comma
multiline_comment|/* 64-bit aligned */
id|BPC2_KILLEHB
comma
multiline_comment|/* bplcon2 */
id|BPC3_PF2OF1
op_or
id|BPC3_PF2OF0
op_or
id|BPC3_SPRES1
op_or
id|BPC3_SPRES0
op_or
id|BPC3_BRDRBLNK
op_or
id|BPC3_EXTBLKEN
comma
multiline_comment|/* bplcon3 */
l_int|0x0072
comma
multiline_comment|/* htotal */
l_int|0x000a
comma
multiline_comment|/* hsstrt */
l_int|0x0013
comma
multiline_comment|/* hsstop */
l_int|0x0002
comma
multiline_comment|/* hbstrt */
l_int|0x001c
comma
multiline_comment|/* hbstop */
l_int|0x020c
comma
multiline_comment|/* vtotal */
l_int|0x0008
comma
multiline_comment|/* vsstrt */
l_int|0x0011
comma
multiline_comment|/* vsstop */
l_int|0x0000
comma
multiline_comment|/* vbstrt */
l_int|0x001c
comma
multiline_comment|/* vbstop */
l_int|0x0043
comma
multiline_comment|/* hcenter */
id|BMC0_VARVBEN
op_or
id|BMC0_LOLDIS
op_or
id|BMC0_VARVSYEN
op_or
id|BMC0_VARHSYEN
op_or
id|BMC0_VARBEAMEN
op_or
id|BMC0_BLANKEN
comma
multiline_comment|/* beamcon0 */
id|FMODE_BPAGEM
op_or
id|FMODE_BPL32
multiline_comment|/* fmode */
)brace
comma
multiline_comment|/* Super 72 - 800x300 72Hz noninterlaced mode. */
(brace
l_string|&quot;super72&quot;
comma
l_int|0
comma
id|BPC0_SHRES
op_or
id|BPC0_ECSENA
comma
multiline_comment|/* bplcon0 */
l_int|800
comma
l_int|304
comma
l_int|1
comma
multiline_comment|/* need rows%8 == 0 */
l_int|800
comma
l_int|304
comma
multiline_comment|/* (cols too) */
l_int|0x0051
comma
l_int|0x0021
comma
multiline_comment|/* diwstrt h,v */
l_int|64
comma
multiline_comment|/* 64-bit aligned */
id|BPC2_KILLEHB
comma
multiline_comment|/* bplcon2 */
id|BPC3_PF2OF1
op_or
id|BPC3_PF2OF0
op_or
id|BPC3_SPRES1
op_or
id|BPC3_SPRES0
op_or
id|BPC3_BRDRBLNK
op_or
id|BPC3_EXTBLKEN
comma
multiline_comment|/* bplcon3 */
l_int|0x0091
comma
multiline_comment|/* htotal */
l_int|0x000a
comma
multiline_comment|/* hsstrt */
l_int|0x0013
comma
multiline_comment|/* hsstop */
l_int|0x0001
comma
multiline_comment|/* hbstrt */
l_int|0x001e
comma
multiline_comment|/* hbstop */
l_int|0x0156
comma
multiline_comment|/* vtotal */
l_int|0x0009
comma
multiline_comment|/* vsstrt */
l_int|0x0012
comma
multiline_comment|/* vsstop */
l_int|0x0000
comma
multiline_comment|/* vbstrt */
l_int|0x001c
comma
multiline_comment|/* vbstop */
l_int|0x0052
comma
multiline_comment|/* hcenter */
id|BMC0_VARVBEN
op_or
id|BMC0_LOLDIS
op_or
id|BMC0_VARVSYEN
op_or
id|BMC0_VARHSYEN
op_or
id|BMC0_VARBEAMEN
op_or
id|BMC0_BLANKEN
comma
multiline_comment|/* beamcon0 */
id|FMODE_BPAGEM
op_or
id|FMODE_BPL32
multiline_comment|/* fmode */
)brace
comma
multiline_comment|/* Super 72 lace - 800x600 72Hz interlaced mode. */
(brace
l_string|&quot;super72-lace&quot;
comma
l_int|0
comma
id|BPC0_SHRES
op_or
id|BPC0_LACE
op_or
id|BPC0_ECSENA
comma
multiline_comment|/* bplcon0 */
l_int|800
comma
l_int|600
comma
l_int|1
comma
multiline_comment|/* need rows%8 == 0 */
l_int|800
comma
l_int|600
comma
multiline_comment|/* (cols too) */
l_int|0x0051
comma
l_int|0x0021
comma
multiline_comment|/* diwstrt h,v */
l_int|64
comma
multiline_comment|/* 64-bit aligned */
id|BPC2_KILLEHB
comma
multiline_comment|/* bplcon2 */
id|BPC3_PF2OF1
op_or
id|BPC3_PF2OF0
op_or
id|BPC3_SPRES1
op_or
id|BPC3_SPRES0
op_or
id|BPC3_BRDRBLNK
op_or
id|BPC3_EXTBLKEN
comma
multiline_comment|/* bplcon3 */
l_int|0x0091
comma
multiline_comment|/* htotal */
l_int|0x000a
comma
multiline_comment|/* hsstrt */
l_int|0x0013
comma
multiline_comment|/* hsstop */
l_int|0x0001
comma
multiline_comment|/* hbstrt */
l_int|0x001e
comma
multiline_comment|/* hbstop */
l_int|0x0150
comma
multiline_comment|/* vtotal */
l_int|0x0009
comma
multiline_comment|/* vsstrt */
l_int|0x0012
comma
multiline_comment|/* vsstop */
l_int|0x0000
comma
multiline_comment|/* vbstrt */
l_int|0x001c
comma
multiline_comment|/* vbstop */
l_int|0x0052
comma
multiline_comment|/* hcenter */
id|BMC0_VARVBEN
op_or
id|BMC0_LOLDIS
op_or
id|BMC0_VARVSYEN
op_or
id|BMC0_VARHSYEN
op_or
id|BMC0_VARBEAMEN
op_or
id|BMC0_BLANKEN
comma
multiline_comment|/* beamcon0 */
id|FMODE_BPAGEM
op_or
id|FMODE_BPL32
multiline_comment|/* fmode */
)brace
comma
multiline_comment|/* DblNtsc - 640x400 59Hz noninterlaced mode. */
(brace
l_string|&quot;dblntsc&quot;
comma
l_int|0
comma
id|BPC0_SHRES
op_or
id|BPC0_ECSENA
comma
multiline_comment|/* bplcon0 */
l_int|640
comma
l_int|400
comma
l_int|1
comma
multiline_comment|/* need rows%8 == 0 */
l_int|640
comma
l_int|400
comma
multiline_comment|/* (cols too) */
l_int|0x0049
comma
l_int|0x0021
comma
multiline_comment|/* diwstrt h,v */
l_int|64
comma
multiline_comment|/* 64-bit aligned */
id|BPC2_KILLEHB
comma
multiline_comment|/* bplcon2 */
id|BPC3_PF2OF1
op_or
id|BPC3_PF2OF0
op_or
id|BPC3_SPRES1
op_or
id|BPC3_SPRES0
op_or
id|BPC3_BRDRBLNK
op_or
id|BPC3_EXTBLKEN
comma
multiline_comment|/* bplcon3 */
l_int|0x0079
comma
multiline_comment|/* htotal */
l_int|0x0007
comma
multiline_comment|/* hsstrt */
l_int|0x0013
comma
multiline_comment|/* hsstop */
l_int|0x0001
comma
multiline_comment|/* hbstrt */
l_int|0x001e
comma
multiline_comment|/* hbstop */
l_int|0x01ec
comma
multiline_comment|/* vtotal */
l_int|0x0008
comma
multiline_comment|/* vsstrt */
l_int|0x0010
comma
multiline_comment|/* vsstop */
l_int|0x0000
comma
multiline_comment|/* vbstrt */
l_int|0x0019
comma
multiline_comment|/* vbstop */
l_int|0x0046
comma
multiline_comment|/* hcenter */
id|BMC0_VARVBEN
op_or
id|BMC0_LOLDIS
op_or
id|BMC0_VARVSYEN
op_or
id|BMC0_VARHSYEN
op_or
id|BMC0_VARBEAMEN
op_or
id|BMC0_BLANKEN
comma
multiline_comment|/* beamcon0 */
id|FMODE_BPAGEM
op_or
id|FMODE_BPL32
multiline_comment|/* fmode */
)brace
comma
multiline_comment|/* DblPal - 640x512 52Hz noninterlaced mode. */
(brace
l_string|&quot;dblpal&quot;
comma
l_int|0
comma
id|BPC0_SHRES
op_or
id|BPC0_ECSENA
comma
multiline_comment|/* bplcon0 */
l_int|640
comma
l_int|512
comma
l_int|1
comma
multiline_comment|/* need rows%8 == 0 */
l_int|640
comma
l_int|512
comma
multiline_comment|/* (cols too) */
l_int|0x0049
comma
l_int|0x0021
comma
multiline_comment|/* diwstrt h,v */
l_int|64
comma
multiline_comment|/* 64-bit aligned */
id|BPC2_KILLEHB
comma
multiline_comment|/* bplcon2 */
id|BPC3_PF2OF1
op_or
id|BPC3_PF2OF0
op_or
id|BPC3_SPRES1
op_or
id|BPC3_SPRES0
op_or
id|BPC3_BRDRBLNK
op_or
id|BPC3_EXTBLKEN
comma
multiline_comment|/* bplcon3 */
l_int|0x0079
comma
multiline_comment|/* htotal */
l_int|0x0007
comma
multiline_comment|/* hsstrt */
l_int|0x0013
comma
multiline_comment|/* hsstop */
l_int|0x0001
comma
multiline_comment|/* hbstrt */
l_int|0x001e
comma
multiline_comment|/* hbstop */
l_int|0x0234
comma
multiline_comment|/* vtotal */
l_int|0x0008
comma
multiline_comment|/* vsstrt */
l_int|0x0010
comma
multiline_comment|/* vsstop */
l_int|0x0000
comma
multiline_comment|/* vbstrt */
l_int|0x0019
comma
multiline_comment|/* vbstop */
l_int|0x0046
comma
multiline_comment|/* hcenter */
id|BMC0_VARVBEN
op_or
id|BMC0_LOLDIS
op_or
id|BMC0_VARVSYEN
op_or
id|BMC0_VARHSYEN
op_or
id|BMC0_VARBEAMEN
op_or
id|BMC0_BLANKEN
comma
multiline_comment|/* beamcon0 */
id|FMODE_BPAGEM
op_or
id|FMODE_BPL32
multiline_comment|/* fmode */
)brace
comma
multiline_comment|/* Euro72 - productivity - 640x400 71Hz noninterlaced mode. */
(brace
l_string|&quot;euro72&quot;
comma
l_int|0
comma
id|BPC0_SHRES
op_or
id|BPC0_ECSENA
comma
multiline_comment|/* bplcon0 */
l_int|640
comma
l_int|400
comma
l_int|1
comma
multiline_comment|/* need rows%8 == 0 */
l_int|640
comma
l_int|400
comma
multiline_comment|/* (cols too) */
l_int|0x0041
comma
l_int|0x0021
comma
multiline_comment|/* diwstrt h,v */
l_int|64
comma
multiline_comment|/* 64-bit aligned */
id|BPC2_KILLEHB
comma
multiline_comment|/* bplcon2 */
id|BPC3_PF2OF1
op_or
id|BPC3_PF2OF0
op_or
id|BPC3_SPRES1
op_or
id|BPC3_SPRES0
op_or
id|BPC3_BRDRBLNK
op_or
id|BPC3_EXTBLKEN
comma
multiline_comment|/* bplcon3 */
l_int|0x0071
comma
multiline_comment|/* htotal */
l_int|0x0009
comma
multiline_comment|/* hsstrt */
l_int|0x0013
comma
multiline_comment|/* hsstop */
l_int|0x0001
comma
multiline_comment|/* hbstrt */
l_int|0x001e
comma
multiline_comment|/* hbstop */
l_int|0x01be
comma
multiline_comment|/* vtotal */
l_int|0x0008
comma
multiline_comment|/* vsstrt */
l_int|0x0016
comma
multiline_comment|/* vsstop */
l_int|0x0000
comma
multiline_comment|/* vbstrt */
l_int|0x001f
comma
multiline_comment|/* vbstop */
l_int|0x0041
comma
multiline_comment|/* hcenter */
id|BMC0_VARVBEN
op_or
id|BMC0_LOLDIS
op_or
id|BMC0_VARVSYEN
op_or
id|BMC0_VARHSYEN
op_or
id|BMC0_VARBEAMEN
op_or
id|BMC0_BLANKEN
comma
multiline_comment|/* beamcon0 */
id|FMODE_BPAGEM
op_or
id|FMODE_BPL32
multiline_comment|/* fmode */
)brace
comma
multiline_comment|/* AGA modes */
(brace
multiline_comment|/*&n;&t; * A 640x480, 60Hz noninterlaced AGA mode. It would be nice to be&n;&t; * able to have some of these values computed dynamically, but that&n;&t; * requires more knowledge of AGA than I have. At the moment,&n;&t; * the values make it centered on my 1960 monitor. -wjr&n;&t; *&n;&t; * For random reasons to do with the way arguments are parsed,&n;&t; * these names can&squot;t start with a digit.&n;&t; *&n;&t; * Don&squot;t count on being able to reduce scr_width and scr_height&n;&t; * and ending up with a smaller but well-formed screen - this&n;&t; * doesn&squot;t seem to work well at the moment.&n;&t; */
l_string|&quot;aga640x480&quot;
comma
l_int|0
comma
id|BPC0_SHRES
op_or
id|BPC0_ECSENA
comma
multiline_comment|/* bplcon0 */
l_int|640
comma
l_int|480
comma
l_int|1
comma
l_int|640
comma
l_int|480
comma
l_int|0x0041
comma
l_int|0x002b
comma
multiline_comment|/* diwstrt h,v */
l_int|64
comma
multiline_comment|/* 64-bit aligned */
id|BPC2_KILLEHB
comma
multiline_comment|/* bplcon2 */
id|BPC3_PF2OF1
op_or
id|BPC3_PF2OF0
op_or
id|BPC3_SPRES1
op_or
id|BPC3_SPRES0
op_or
id|BPC3_BRDRBLNK
op_or
id|BPC3_EXTBLKEN
comma
multiline_comment|/* bplcon3 */
l_int|0x0071
comma
multiline_comment|/* htotal */
l_int|0x000c
comma
multiline_comment|/* hsstrt */
l_int|0x001c
comma
multiline_comment|/* hsstop */
l_int|0x0008
comma
multiline_comment|/* hbstrt */
l_int|0x001e
comma
multiline_comment|/* hbstop */
l_int|0x020c
comma
multiline_comment|/* vtotal */
l_int|0x0001
comma
multiline_comment|/* vsstrt */
l_int|0x0003
comma
multiline_comment|/* vsstop */
l_int|0x0000
comma
multiline_comment|/* vbstrt */
l_int|0x000f
comma
multiline_comment|/* vbstop */
l_int|0x0046
comma
multiline_comment|/* hcenter */
id|BMC0_HARDDIS
op_or
id|BMC0_VARVBEN
op_or
id|BMC0_LOLDIS
op_or
id|BMC0_VARVSYEN
op_or
id|BMC0_VARHSYEN
op_or
id|BMC0_VARBEAMEN
op_or
id|BMC0_BLANKEN
comma
multiline_comment|/* beamcon0 */
id|FMODE_BPAGEM
op_or
id|FMODE_BPL32
multiline_comment|/* fmode */
)brace
comma
(brace
multiline_comment|/* An 800x600 72Hz interlaced mode. */
l_string|&quot;aga800x600&quot;
comma
l_int|0
comma
id|BPC0_SHRES
op_or
id|BPC0_LACE
op_or
id|BPC0_ECSENA
comma
multiline_comment|/* bplcon0 */
l_int|896
comma
l_int|624
comma
l_int|1
comma
multiline_comment|/* need rows%8 == 0 */
l_int|896
comma
l_int|624
comma
multiline_comment|/* (cols too) */
l_int|0x0041
comma
l_int|0x001e
comma
multiline_comment|/* diwstrt h,v */
l_int|64
comma
multiline_comment|/* 64-bit aligned */
id|BPC2_KILLEHB
comma
multiline_comment|/* bplcon2 */
id|BPC3_PF2OF1
op_or
id|BPC3_PF2OF0
op_or
id|BPC3_SPRES1
op_or
id|BPC3_SPRES0
op_or
id|BPC3_BRDRBLNK
op_or
id|BPC3_EXTBLKEN
comma
multiline_comment|/* bplcon3 */
l_int|0x0091
comma
multiline_comment|/* htotal */
l_int|0x000e
comma
multiline_comment|/* hsstrt */
l_int|0x001d
comma
multiline_comment|/* hsstop */
l_int|0x000a
comma
multiline_comment|/* hbstrt */
l_int|0x001e
comma
multiline_comment|/* hbstop */
l_int|0x0156
comma
multiline_comment|/* vtotal */
l_int|0x0001
comma
multiline_comment|/* vsstrt */
l_int|0x0003
comma
multiline_comment|/* vsstop */
l_int|0x0000
comma
multiline_comment|/* vbstrt */
l_int|0x000f
comma
multiline_comment|/* vbstop */
l_int|0x0050
comma
multiline_comment|/* hcenter */
id|BMC0_HARDDIS
op_or
id|BMC0_VARVBEN
op_or
id|BMC0_LOLDIS
op_or
id|BMC0_VARVSYEN
op_or
id|BMC0_VARHSYEN
op_or
id|BMC0_VARBEAMEN
op_or
id|BMC0_BLANKEN
comma
multiline_comment|/* beamcon0 */
id|FMODE_BPAGEM
op_or
id|FMODE_BPL32
multiline_comment|/* fmode */
)brace
comma
multiline_comment|/*&n;&t; * Additional AGA modes by Geert Uytterhoeven&n;&t; */
(brace
multiline_comment|/*&n;&t;&t; * A 720x400, 70 Hz noninterlaced AGA mode (29.27 kHz)&n;&t;&t; */
l_string|&quot;aga720x400&quot;
comma
l_int|0
comma
id|BPC0_SHRES
op_or
id|BPC0_ECSENA
comma
multiline_comment|/* bplcon0 */
l_int|720
comma
l_int|400
comma
l_int|1
comma
l_int|720
comma
l_int|400
comma
l_int|0x0041
comma
l_int|0x0013
comma
multiline_comment|/* diwstrt h,v */
l_int|64
comma
multiline_comment|/* 64-bit aligned */
id|BPC2_KILLEHB
comma
multiline_comment|/* bplcon2 */
id|BPC3_PF2OF1
op_or
id|BPC3_PF2OF0
op_or
id|BPC3_SPRES1
op_or
id|BPC3_SPRES0
op_or
id|BPC3_BRDRBLNK
op_or
id|BPC3_EXTBLKEN
comma
multiline_comment|/* bplcon3 */
l_int|0x0079
comma
multiline_comment|/* htotal */
l_int|0x000e
comma
multiline_comment|/* hsstrt */
l_int|0x0018
comma
multiline_comment|/* hsstop */
l_int|0x0001
comma
multiline_comment|/* hbstrt */
l_int|0x0021
comma
multiline_comment|/* hbstop */
l_int|0x01a2
comma
multiline_comment|/* vtotal */
l_int|0x0003
comma
multiline_comment|/* vsstrt */
l_int|0x0005
comma
multiline_comment|/* vsstop */
l_int|0x0000
comma
multiline_comment|/* vbstrt */
l_int|0x0012
comma
multiline_comment|/* vbstop */
l_int|0x0046
comma
multiline_comment|/* hcenter */
id|BMC0_VARVBEN
op_or
id|BMC0_LOLDIS
op_or
id|BMC0_VARVSYEN
op_or
id|BMC0_VARHSYEN
op_or
id|BMC0_VARBEAMEN
op_or
id|BMC0_PAL
op_or
id|BMC0_VARCSYEN
op_or
id|BMC0_CSYTRUE
op_or
id|BMC0_VSYTRUE
comma
multiline_comment|/* beamcon0 */
id|FMODE_BPAGEM
op_or
id|FMODE_BPL32
multiline_comment|/* fmode */
)brace
comma
(brace
multiline_comment|/*&n;&t;&t; * A 640x400, 76 Hz noninterlaced AGA mode (31.89 kHz)&n;&t;&t; */
l_string|&quot;aga640x400&quot;
comma
l_int|0
comma
id|BPC0_SHRES
op_or
id|BPC0_ECSENA
comma
multiline_comment|/* bplcon0 */
l_int|640
comma
l_int|400
comma
l_int|1
comma
l_int|640
comma
l_int|400
comma
l_int|0x0041
comma
l_int|0x0015
comma
multiline_comment|/* diwstrt h,v */
l_int|64
comma
multiline_comment|/* 64-bit aligned */
id|BPC2_KILLEHB
comma
multiline_comment|/* bplcon2 */
id|BPC3_PF2OF1
op_or
id|BPC3_PF2OF0
op_or
id|BPC3_SPRES1
op_or
id|BPC3_SPRES0
op_or
id|BPC3_BRDRBLNK
op_or
id|BPC3_EXTBLKEN
comma
multiline_comment|/* bplcon3 */
l_int|0x006f
comma
multiline_comment|/* htotal */
l_int|0x000d
comma
multiline_comment|/* hsstrt */
l_int|0x0018
comma
multiline_comment|/* hsstop */
l_int|0x0001
comma
multiline_comment|/* hbstrt */
l_int|0x0021
comma
multiline_comment|/* hbstop */
l_int|0x01a4
comma
multiline_comment|/* vtotal */
l_int|0x0003
comma
multiline_comment|/* vsstrt */
l_int|0x0005
comma
multiline_comment|/* vsstop */
l_int|0x0000
comma
multiline_comment|/* vbstrt */
l_int|0x0014
comma
multiline_comment|/* vbstop */
l_int|0x0046
comma
multiline_comment|/* hcenter */
id|BMC0_VARVBEN
op_or
id|BMC0_LOLDIS
op_or
id|BMC0_VARVSYEN
op_or
id|BMC0_VARHSYEN
op_or
id|BMC0_VARBEAMEN
op_or
id|BMC0_PAL
op_or
id|BMC0_VARCSYEN
op_or
id|BMC0_CSYTRUE
op_or
id|BMC0_VSYTRUE
comma
multiline_comment|/* beamcon0 */
id|FMODE_BPAGEM
op_or
id|FMODE_BPL32
multiline_comment|/* fmode */
)brace
comma
(brace
multiline_comment|/*&n;&t;&t; * A 640x480, 64 Hz noninterlaced AGA mode (31.89 kHz)&n;&t;&t; */
l_string|&quot;aga640x480a&quot;
comma
l_int|0
comma
id|BPC0_SHRES
op_or
id|BPC0_ECSENA
comma
multiline_comment|/* bplcon0 */
l_int|640
comma
l_int|480
comma
l_int|1
comma
l_int|640
comma
l_int|480
comma
l_int|0x0041
comma
l_int|0x0015
comma
multiline_comment|/* diwstrt h,v */
l_int|64
comma
multiline_comment|/* 64-bit aligned */
id|BPC2_KILLEHB
comma
multiline_comment|/* bplcon2 */
id|BPC3_PF2OF1
op_or
id|BPC3_PF2OF0
op_or
id|BPC3_SPRES1
op_or
id|BPC3_SPRES0
op_or
id|BPC3_BRDRBLNK
op_or
id|BPC3_EXTBLKEN
comma
multiline_comment|/* bplcon3 */
l_int|0x006f
comma
multiline_comment|/* htotal */
l_int|0x000e
comma
multiline_comment|/* hsstrt */
l_int|0x0018
comma
multiline_comment|/* hsstop */
l_int|0x0001
comma
multiline_comment|/* hbstrt */
l_int|0x0021
comma
multiline_comment|/* hbstop */
l_int|0x01f4
comma
multiline_comment|/* vtotal */
l_int|0x0003
comma
multiline_comment|/* vsstrt */
l_int|0x0005
comma
multiline_comment|/* vsstop */
l_int|0x0000
comma
multiline_comment|/* vbstrt */
l_int|0x0014
comma
multiline_comment|/* vbstop */
l_int|0x0046
comma
multiline_comment|/* hcenter */
id|BMC0_VARVBEN
op_or
id|BMC0_LOLDIS
op_or
id|BMC0_VARVSYEN
op_or
id|BMC0_VARHSYEN
op_or
id|BMC0_VARBEAMEN
op_or
id|BMC0_PAL
op_or
id|BMC0_VARCSYEN
op_or
id|BMC0_CSYTRUE
op_or
id|BMC0_VSYTRUE
comma
multiline_comment|/* beamcon0 */
id|FMODE_BPAGEM
op_or
id|FMODE_BPL32
multiline_comment|/* fmode */
)brace
)brace
suffix:semicolon
DECL|macro|NMODES
mdefine_line|#define&t;NMODES&t;(sizeof(mono_modes) / sizeof(struct geometry))
DECL|variable|mono_mono_amiga_fb_predefined
r_static
r_struct
id|fb_var_screeninfo
id|mono_mono_amiga_fb_predefined
(braket
)braket
op_assign
(brace
(brace
multiline_comment|/* autodetect */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* xres-grayscale */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* red green blue tran*/
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|mono_num_mono_amiga_fb_predefined
r_static
r_int
id|mono_num_mono_amiga_fb_predefined
op_assign
r_sizeof
(paren
id|mono_mono_amiga_fb_predefined
)paren
op_div
r_sizeof
(paren
r_struct
id|fb_var_screeninfo
)paren
suffix:semicolon
multiline_comment|/* Some default modes */
DECL|macro|OCS_PAL_LOWEND_DEFMODE
mdefine_line|#define OCS_PAL_LOWEND_DEFMODE&t;5&t;/* PAL non-laced for 500/2000 */
DECL|macro|OCS_PAL_3000_DEFMODE
mdefine_line|#define OCS_PAL_3000_DEFMODE&t;&t;4&t;/* PAL laced for 3000 */
DECL|macro|OCS_NTSC_LOWEND_DEFMODE
mdefine_line|#define OCS_NTSC_LOWEND_DEFMODE&t;1&t;/* NTSC non-laced for 500/2000 */
DECL|macro|OCS_NTSC_3000_DEFMODE
mdefine_line|#define OCS_NTSC_3000_DEFMODE&t;&t;0&t;/* NTSC laced for 3000 */
DECL|macro|AGA_DEFMODE
mdefine_line|#define AGA_DEFMODE&t;&t;&t;&t;&t;8&t;/* 640x480 non-laced for AGA */
DECL|variable|mono_amifb_inverse
r_static
r_int
id|mono_amifb_inverse
op_assign
l_int|0
suffix:semicolon
DECL|variable|mono_amifb_mode
r_static
r_int
id|mono_amifb_mode
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|function|mono_video_setup
r_static
r_void
id|mono_video_setup
(paren
r_char
op_star
id|options
comma
r_int
op_star
id|ints
)paren
(brace
r_char
op_star
id|this_opt
suffix:semicolon
r_int
id|i
suffix:semicolon
id|fb_info.fontname
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
op_logical_or
op_logical_neg
op_star
id|options
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|this_opt
op_assign
id|strtok
c_func
(paren
id|options
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
id|this_opt
suffix:semicolon
id|this_opt
op_assign
id|strtok
c_func
(paren
l_int|NULL
comma
l_string|&quot;,&quot;
)paren
)paren
r_if
c_cond
(paren
op_logical_neg
id|strcmp
(paren
id|this_opt
comma
l_string|&quot;inverse&quot;
)paren
)paren
id|mono_amifb_inverse
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;font:&quot;
comma
l_int|5
)paren
)paren
id|strcpy
c_func
(paren
id|fb_info.fontname
comma
id|this_opt
op_plus
l_int|5
)paren
suffix:semicolon
r_else
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NMODES
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_opt
comma
id|mono_modes
(braket
id|i
)braket
dot
id|modename
)paren
)paren
(brace
id|mono_amifb_mode
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Notes about copper scrolling:&n; *&n; * 1. The VBLANK routine dynamically rewrites a LIVE copper list that is&n; *    currently being executed. Don&squot;t mess with it unless you know the&n; *    complications. Fairly sure that double buffered lists doesn&squot;t&n; *    make our life any easier.&n; *&n; * 2. The vblank code starts executing at logical line 0. Display must be&n; *    set up and ready to run by line DIWSTRT_V, typically 0x2c, minimum&n; *    value is 0x18 for maximum overscan.&n; *&n; *    Tests on my A500/030 for dynamically generating a 37 element copper&n; *    list during the VBLANK period under AmigaDos required between&n; *    0x10 and 0x14 scanlines. This should be pathological case, and&n; *    should do better under Linux/68k. It is however IMPERATIVE that I am&n; *    first in the VBLANK isr chain. Try to keep &squot;buildclist&squot; as fast as&n; *    possible. Don&squot;t think that it justifies assembler thou&squot;&n; *&n; * 3. PAL 640x256 display (no overscan) has copper-wait y positions in range&n; *    0x02c -&gt; 0x12c. NTSC overscan uses values &gt; 256 too. However counter&n; *    is 8 bit, will wrap. RKM 1.1 suggests use of a WAIT(0x00,0xff),&n; *    WAIT(x,y-0x100) pair to handle this case. This is WRONG - must use&n; *    WAIT(0xe2,0xff) to ensure that wrap occurred by next copper&n; *    instruction. Argghh!&n; *&n; * 4. RKM 1.1 suggests Copper-wait x positions are in range [0,0xe2].&n; *    Horizontal blanking occurs in range 0x0f -&gt; 0x35. Black screen&n; *    shown in range 0x04 -&gt; 0x47.&n; *&n; *    Experiments suggest that using WAIT(0x00,y), we can replace up to&n; *    7 bitplane pointers before display fetch start. Using a &n; *    WAIT(0xe0,y-1) instead, we can replace 8 pointers that should be&n; *    all that we need for a full AGA display. Should work because of&n; *    fetch latency with bitmapped display.&n; *&n; *    I think that this works. Someone please tell me if something breaks.&n; *&n; * Is diwstop_h the right value to use for &quot;close to the end of line&quot;?&n; * It seems to work for me, at least for the modes I&squot;ve defined. -wjr&n; *&n; * I changed the Wait(diwstop_h, 0xff) for 256-line chunk skipping to&n; * Wait(diwstop_h-2, 0xff) to make it work with the additional&n; * `get-all-you-can-get-out-of-it&squot; AGA modes. Maybe we should derive the&n; * wait position from the HTOTAL value? - G.U.&n; *&n; * The Wait(diwstop_h-2, 0xff) didn&squot;t work in Super72 under ECS, instead&n; * I changed it to Wait(htotal-4, 0xff). Dunno whether it works under AGA,&n; * and don&squot;t ask my why it works. I&squot;m trying to get some facts on this issue&n; * from Commodore.&n; * -Jes&n; */
DECL|function|mono_build_clist_hdr
r_static
id|__inline__
id|ushort
op_star
id|mono_build_clist_hdr
c_func
(paren
r_register
r_struct
id|display
op_star
id|p
comma
id|ushort
op_star
id|cop
comma
id|ushort
op_star
id|othercop
)paren
multiline_comment|/* Interlace: List for next frame */
(brace
r_int
id|i
suffix:semicolon
id|ushort
id|diwstrt_v
op_assign
id|mono_current_par.diwstrt_v
suffix:semicolon
id|ushort
id|diwstop_h
op_assign
id|mono_current_par.diwstop_h
suffix:semicolon
r_if
c_cond
(paren
id|othercop
)paren
(brace
op_star
id|cop
op_increment
op_assign
id|CUSTOM_OFS
c_func
(paren
id|cop1lc
)paren
suffix:semicolon
op_star
id|cop
op_increment
op_assign
(paren
r_int
)paren
id|othercop
op_rshift
l_int|16
suffix:semicolon
op_star
id|cop
op_increment
op_assign
id|CUSTOM_OFS
c_func
(paren
id|cop1lc
)paren
op_plus
l_int|2
suffix:semicolon
op_star
id|cop
op_increment
op_assign
(paren
r_int
)paren
id|othercop
suffix:semicolon
)brace
multiline_comment|/* Point Sprite 0 at cursor sprite: */
op_star
id|cop
op_increment
op_assign
id|CUSTOM_OFS
c_func
(paren
id|sprpt
(braket
l_int|0
)braket
)paren
suffix:semicolon
op_star
id|cop
op_increment
op_assign
(paren
id|ushort
)paren
(paren
(paren
r_int
)paren
id|mono_current_par.cursor
op_rshift
l_int|16
)paren
suffix:semicolon
op_star
id|cop
op_increment
op_assign
id|CUSTOM_OFS
c_func
(paren
id|sprpt
(braket
l_int|0
)braket
)paren
op_plus
l_int|2
suffix:semicolon
op_star
id|cop
op_increment
op_assign
(paren
id|ushort
)paren
(paren
(paren
r_int
)paren
id|mono_current_par.cursor
op_amp
l_int|0x0000ffff
)paren
suffix:semicolon
multiline_comment|/* Point Sprites 1-7 at dummy sprite: */
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|cop
op_increment
op_assign
id|CUSTOM_OFS
c_func
(paren
id|sprpt
(braket
id|i
)braket
)paren
suffix:semicolon
op_star
id|cop
op_increment
op_assign
(paren
id|ushort
)paren
(paren
(paren
r_int
)paren
id|mono_current_par.dummy
op_rshift
l_int|16
)paren
suffix:semicolon
op_star
id|cop
op_increment
op_assign
id|CUSTOM_OFS
c_func
(paren
id|sprpt
(braket
id|i
)braket
)paren
op_plus
l_int|2
suffix:semicolon
op_star
id|cop
op_increment
op_assign
(paren
id|ushort
)paren
(paren
(paren
r_int
)paren
id|mono_current_par.dummy
op_amp
l_int|0x0000ffff
)paren
suffix:semicolon
)brace
multiline_comment|/* Halt copper until we have rebuilt the display list */
op_star
id|cop
op_increment
op_assign
(paren
(paren
id|diwstrt_v
op_minus
l_int|2
)paren
op_lshift
l_int|8
)paren
op_or
(paren
id|diwstop_h
op_rshift
l_int|1
)paren
op_or
l_int|0x1
suffix:semicolon
op_star
id|cop
op_increment
op_assign
l_int|0xfffe
suffix:semicolon
r_return
id|cop
suffix:semicolon
)brace
DECL|function|mono_build_clist_dyn
r_static
id|__inline__
id|ushort
op_star
id|mono_build_clist_dyn
c_func
(paren
r_register
r_struct
id|display
op_star
id|p
comma
id|ushort
op_star
id|cop
comma
r_int
id|shf
)paren
multiline_comment|/* Interlace: Short frame */
(brace
id|ushort
id|diwstrt_v
op_assign
id|mono_current_par.diwstrt_v
suffix:semicolon
id|ushort
id|diwstop_h
op_assign
id|mono_current_par.diwstop_h
suffix:semicolon
id|ushort
id|y_wrap
op_assign
id|mono_current_par.y_wrap
suffix:semicolon
id|ulong
id|offset
op_assign
id|y_wrap
op_star
id|mono_current_par.bytes_per_row
suffix:semicolon
r_int
id|scrmem
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Set up initial bitplane ptrs */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|mono_current_par.scr_depth
suffix:semicolon
id|i
op_increment
)paren
(brace
id|scrmem
op_assign
(paren
(paren
r_int
)paren
id|mono_current_par.bitplane
(braket
id|i
)braket
)paren
op_plus
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|shf
)paren
id|scrmem
op_add_assign
id|mono_current_par.bytes_per_row
suffix:semicolon
op_star
id|cop
op_increment
op_assign
id|CUSTOM_OFS
c_func
(paren
id|bplpt
(braket
id|i
)braket
)paren
suffix:semicolon
op_star
id|cop
op_increment
op_assign
(paren
r_int
)paren
id|scrmem
op_rshift
l_int|16
suffix:semicolon
op_star
id|cop
op_increment
op_assign
id|CUSTOM_OFS
c_func
(paren
id|bplpt
(braket
id|i
)braket
)paren
op_plus
l_int|2
suffix:semicolon
op_star
id|cop
op_increment
op_assign
(paren
r_int
)paren
id|scrmem
suffix:semicolon
)brace
multiline_comment|/* If wrapped frame needed - wait for line then switch bitplXs */
r_if
c_cond
(paren
id|y_wrap
)paren
(brace
id|ushort
id|line
suffix:semicolon
r_if
c_cond
(paren
id|mono_current_par.bplcon0
op_amp
id|BPC0_LACE
)paren
id|line
op_assign
id|diwstrt_v
op_plus
(paren
id|mono_current_par.scr_height
op_minus
id|y_wrap
)paren
op_div
l_int|2
suffix:semicolon
r_else
id|line
op_assign
id|diwstrt_v
op_plus
id|mono_current_par.scr_height
op_minus
id|y_wrap
suffix:semicolon
multiline_comment|/* Handle skipping over 256-line chunks */
r_while
c_loop
(paren
id|line
OG
l_int|256
)paren
(brace
multiline_comment|/* Hardware limitation - 8 bit counter    */
multiline_comment|/* Wait(diwstop_h-2, 0xff) */
r_if
c_cond
(paren
id|mono_current_par.bplcon0
op_amp
id|BPC0_SHRES
)paren
multiline_comment|/*&n;&t;&t;&t;&t; * htotal-4 is used in SHRES-mode, as diwstop_h-2 doesn&squot;t work under ECS.&n;&t;&t;&t;&t; * Does this work under AGA?&n;&t;&t;&t;&t; * -Jes&n;&t;&t;&t;&t; */
op_star
id|cop
op_increment
op_assign
l_int|0xff00
op_or
(paren
(paren
id|mono_current_par.htotal
op_minus
l_int|4
)paren
op_or
l_int|1
)paren
suffix:semicolon
r_else
op_star
id|cop
op_increment
op_assign
l_int|0xff00
op_or
(paren
(paren
id|diwstop_h
op_minus
l_int|2
)paren
op_rshift
l_int|1
)paren
op_or
l_int|0x1
suffix:semicolon
op_star
id|cop
op_increment
op_assign
l_int|0xfffe
suffix:semicolon
multiline_comment|/* Wait(0, 0) - make sure we&squot;re in the new segment */
op_star
id|cop
op_increment
op_assign
l_int|0x0001
suffix:semicolon
op_star
id|cop
op_increment
op_assign
l_int|0xfffe
suffix:semicolon
id|line
op_sub_assign
l_int|256
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Under ECS we have to keep color[0], as it is part of a special color-table.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|boot_info.bi_amiga.chipset
op_eq
id|CS_ECS
op_logical_and
id|mono_current_par.bplcon0
op_amp
id|BPC0_ECSENA
)paren
(brace
op_star
id|cop
op_increment
op_assign
l_int|0x0180
suffix:semicolon
op_star
id|cop
op_increment
op_assign
id|mono_ecs_color_zero
suffix:semicolon
)brace
)brace
multiline_comment|/* Wait(diwstop_h, line - 1) */
op_star
id|cop
op_increment
op_assign
(paren
(paren
id|line
op_minus
l_int|1
)paren
op_lshift
l_int|8
)paren
op_or
(paren
id|diwstop_h
op_rshift
l_int|1
)paren
op_or
l_int|0x1
suffix:semicolon
op_star
id|cop
op_increment
op_assign
l_int|0xfffe
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|mono_current_par.scr_depth
suffix:semicolon
id|i
op_increment
)paren
(brace
id|scrmem
op_assign
(paren
r_int
)paren
id|mono_current_par.bitplane
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|shf
)paren
id|scrmem
op_add_assign
id|mono_current_par.bytes_per_row
suffix:semicolon
op_star
id|cop
op_increment
op_assign
id|CUSTOM_OFS
c_func
(paren
id|bplpt
(braket
id|i
)braket
)paren
suffix:semicolon
op_star
id|cop
op_increment
op_assign
(paren
r_int
)paren
id|scrmem
op_rshift
l_int|16
suffix:semicolon
op_star
id|cop
op_increment
op_assign
id|CUSTOM_OFS
c_func
(paren
id|bplpt
(braket
id|i
)braket
)paren
op_plus
l_int|2
suffix:semicolon
op_star
id|cop
op_increment
op_assign
(paren
r_int
)paren
id|scrmem
suffix:semicolon
)brace
)brace
multiline_comment|/* End of Copper list */
op_star
id|cop
op_increment
op_assign
l_int|0xffff
suffix:semicolon
op_star
id|cop
op_increment
op_assign
l_int|0xfffe
suffix:semicolon
r_return
id|cop
suffix:semicolon
)brace
DECL|function|mono_build_cursor
r_static
id|__inline__
r_void
id|mono_build_cursor
c_func
(paren
r_register
r_struct
id|display
op_star
id|p
)paren
(brace
r_int
id|vs
comma
id|hs
comma
id|ve
suffix:semicolon
id|ushort
id|diwstrt_v
op_assign
id|mono_current_par.diwstrt_v
suffix:semicolon
id|ushort
id|diwstrt_h
op_assign
id|mono_current_par.diwstrt_h
suffix:semicolon
r_if
c_cond
(paren
id|mono_current_par.bplcon0
op_amp
id|BPC0_LACE
)paren
(brace
id|vs
op_assign
id|diwstrt_v
op_plus
(paren
id|p-&gt;cursor_y
op_star
id|p-&gt;fontheight
)paren
op_div
l_int|2
suffix:semicolon
id|ve
op_assign
id|vs
op_plus
id|p-&gt;fontheight
op_div
l_int|2
suffix:semicolon
)brace
r_else
(brace
id|vs
op_assign
id|diwstrt_v
op_plus
(paren
id|p-&gt;cursor_y
op_star
id|p-&gt;fontheight
)paren
suffix:semicolon
id|ve
op_assign
id|vs
op_plus
id|p-&gt;fontheight
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mono_current_par.bplcon0
op_amp
id|BPC0_ECSENA
)paren
multiline_comment|/*&n;&t;&t; * It&squot;s an AGA mode. We&squot;ll assume that the sprite was set&n;&t;&t; * into 35ns resolution by the appropriate SPRES bits in bplcon3.&n;&t;&t; */
id|hs
op_assign
id|diwstrt_h
op_star
l_int|4
op_plus
(paren
id|p-&gt;cursor_x
op_star
id|p-&gt;fontwidth
)paren
op_minus
l_int|4
suffix:semicolon
r_else
id|hs
op_assign
id|diwstrt_h
op_plus
(paren
id|p-&gt;cursor_x
op_star
id|p-&gt;fontwidth
)paren
op_div
l_int|2
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|mono_current_par.bplcon0
op_amp
id|BPC0_ECSENA
)paren
(brace
multiline_comment|/* There are some high-order bits on the sprite position */
op_star
(paren
(paren
id|ulong
op_star
)paren
id|mono_current_par.cursor
)paren
op_assign
(paren
(paren
(paren
(paren
id|vs
op_amp
l_int|0xff
)paren
op_lshift
l_int|24
)paren
op_or
(paren
(paren
id|vs
op_amp
l_int|0x100
)paren
op_rshift
l_int|6
)paren
op_or
(paren
(paren
id|vs
op_amp
l_int|0x200
)paren
op_rshift
l_int|3
)paren
)paren
op_or
(paren
(paren
(paren
id|hs
op_amp
l_int|0x7f8
)paren
op_lshift
l_int|13
)paren
op_or
(paren
(paren
id|hs
op_amp
l_int|0x4
)paren
op_rshift
l_int|2
)paren
op_or
(paren
(paren
id|hs
op_amp
l_int|0x3
)paren
op_lshift
l_int|3
)paren
)paren
op_or
(paren
(paren
(paren
id|ve
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|ve
op_amp
l_int|0x100
)paren
op_rshift
l_int|7
)paren
op_or
(paren
(paren
id|ve
op_amp
l_int|0x200
)paren
op_rshift
l_int|4
)paren
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
op_star
(paren
(paren
id|ulong
op_star
)paren
id|mono_current_par.cursor
)paren
op_assign
(paren
(paren
id|vs
op_lshift
l_int|24
)paren
op_or
(paren
(paren
id|vs
op_amp
l_int|0x00000100
)paren
op_rshift
l_int|6
)paren
op_or
(paren
(paren
id|hs
op_amp
l_int|0x000001fe
)paren
op_lshift
l_int|15
)paren
op_or
(paren
id|hs
op_amp
l_int|0x00000001
)paren
op_or
(paren
(paren
id|ve
op_amp
l_int|0x000000ff
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|ve
op_amp
l_int|0x00000100
)paren
op_rshift
l_int|7
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|mono_build_ecs_colors
r_static
r_void
id|mono_build_ecs_colors
c_func
(paren
id|ushort
id|color1
comma
id|ushort
id|color2
comma
id|ushort
id|color3
comma
id|ushort
id|color4
comma
id|ushort
op_star
id|table
)paren
(brace
multiline_comment|/*&n; * This function calculates the special ECS color-tables needed when running&n; * new screen-modes available under ECS. See the hardware reference manual&n; * 3rd edition for details.&n; * -Jes&n; */
id|ushort
id|t
suffix:semicolon
id|t
op_assign
(paren
id|color1
op_amp
l_int|0x0ccc
)paren
suffix:semicolon
id|table
(braket
l_int|0
)braket
op_assign
id|t
suffix:semicolon
id|table
(braket
l_int|4
)braket
op_assign
id|t
suffix:semicolon
id|table
(braket
l_int|8
)braket
op_assign
id|t
suffix:semicolon
id|table
(braket
l_int|12
)braket
op_assign
id|t
suffix:semicolon
id|t
op_assign
id|t
op_rshift
l_int|2
suffix:semicolon
id|table
(braket
l_int|0
)braket
op_assign
(paren
id|table
(braket
l_int|0
)braket
op_or
id|t
)paren
suffix:semicolon
id|table
(braket
l_int|1
)braket
op_assign
id|t
suffix:semicolon
id|table
(braket
l_int|2
)braket
op_assign
id|t
suffix:semicolon
id|table
(braket
l_int|3
)braket
op_assign
id|t
suffix:semicolon
id|t
op_assign
(paren
id|color2
op_amp
l_int|0x0ccc
)paren
suffix:semicolon
id|table
(braket
l_int|1
)braket
op_assign
(paren
id|table
(braket
l_int|1
)braket
op_or
id|t
)paren
suffix:semicolon
id|table
(braket
l_int|5
)braket
op_assign
id|t
suffix:semicolon
id|table
(braket
l_int|9
)braket
op_assign
id|t
suffix:semicolon
id|table
(braket
l_int|13
)braket
op_assign
id|t
suffix:semicolon
id|t
op_assign
id|t
op_rshift
l_int|2
suffix:semicolon
id|table
(braket
l_int|4
)braket
op_assign
(paren
id|table
(braket
l_int|4
)braket
op_or
id|t
)paren
suffix:semicolon
id|table
(braket
l_int|5
)braket
op_assign
(paren
id|table
(braket
l_int|5
)braket
op_or
id|t
)paren
suffix:semicolon
id|table
(braket
l_int|6
)braket
op_assign
id|t
suffix:semicolon
id|table
(braket
l_int|7
)braket
op_assign
id|t
suffix:semicolon
id|t
op_assign
(paren
id|color3
op_amp
l_int|0x0ccc
)paren
suffix:semicolon
id|table
(braket
l_int|2
)braket
op_assign
(paren
id|table
(braket
l_int|2
)braket
op_or
id|t
)paren
suffix:semicolon
id|table
(braket
l_int|6
)braket
op_assign
(paren
id|table
(braket
l_int|6
)braket
op_or
id|t
)paren
suffix:semicolon
id|table
(braket
l_int|10
)braket
op_assign
id|t
suffix:semicolon
id|table
(braket
l_int|14
)braket
op_assign
id|t
suffix:semicolon
id|t
op_assign
id|t
op_rshift
l_int|2
suffix:semicolon
id|table
(braket
l_int|8
)braket
op_assign
(paren
id|table
(braket
l_int|8
)braket
op_or
id|t
)paren
suffix:semicolon
id|table
(braket
l_int|9
)braket
op_assign
(paren
id|table
(braket
l_int|9
)braket
op_or
id|t
)paren
suffix:semicolon
id|table
(braket
l_int|10
)braket
op_assign
(paren
id|table
(braket
l_int|10
)braket
op_or
id|t
)paren
suffix:semicolon
id|table
(braket
l_int|11
)braket
op_assign
id|t
suffix:semicolon
id|t
op_assign
(paren
id|color4
op_amp
l_int|0x0ccc
)paren
suffix:semicolon
id|table
(braket
l_int|3
)braket
op_assign
(paren
id|table
(braket
l_int|3
)braket
op_or
id|t
)paren
suffix:semicolon
id|table
(braket
l_int|7
)braket
op_assign
(paren
id|table
(braket
l_int|7
)braket
op_or
id|t
)paren
suffix:semicolon
id|table
(braket
l_int|11
)braket
op_assign
(paren
id|table
(braket
l_int|11
)braket
op_or
id|t
)paren
suffix:semicolon
id|table
(braket
l_int|15
)braket
op_assign
id|t
suffix:semicolon
id|t
op_assign
id|t
op_rshift
l_int|2
suffix:semicolon
id|table
(braket
l_int|12
)braket
op_assign
(paren
id|table
(braket
l_int|12
)braket
op_or
id|t
)paren
suffix:semicolon
id|table
(braket
l_int|13
)braket
op_assign
(paren
id|table
(braket
l_int|13
)braket
op_or
id|t
)paren
suffix:semicolon
id|table
(braket
l_int|14
)braket
op_assign
(paren
id|table
(braket
l_int|14
)braket
op_or
id|t
)paren
suffix:semicolon
id|table
(braket
l_int|15
)braket
op_assign
(paren
id|table
(braket
l_int|15
)braket
op_or
id|t
)paren
suffix:semicolon
)brace
multiline_comment|/* mono_display_init():&n; *&n; *    Fills out (struct display *) given a geometry structure&n; */
DECL|function|mono_display_init
r_static
r_void
id|mono_display_init
c_func
(paren
r_struct
id|display
op_star
id|p
comma
r_struct
id|geometry
op_star
id|geom
comma
id|ushort
id|inverse
)paren
(brace
id|ushort
id|ecs_table
(braket
l_int|16
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
r_char
op_star
id|chipptr
suffix:semicolon
id|ushort
id|diwstrt_v
comma
id|diwstop_v
suffix:semicolon
id|ushort
id|diwstrt_h
comma
id|diwstop_h
suffix:semicolon
id|ushort
id|diw_min_h
comma
id|diw_min_v
suffix:semicolon
id|ushort
id|bplmod
comma
id|diwstrt
comma
id|diwstop
comma
id|diwhigh
comma
id|ddfstrt
comma
id|ddfstop
suffix:semicolon
id|ushort
id|cursorheight
comma
id|cursormask
op_assign
l_int|0
suffix:semicolon
id|u_long
id|size
suffix:semicolon
multiline_comment|/* Decide colour scheme */
r_if
c_cond
(paren
id|inverse
)paren
(brace
id|mono_current_par.fgcol
op_assign
id|FG_COLOR_INV
suffix:semicolon
id|mono_current_par.bgcol
op_assign
id|BG_COLOR_INV
suffix:semicolon
id|mono_current_par.crsrcol
op_assign
id|CRSR_COLOR_INV
suffix:semicolon
)brace
r_else
(brace
id|mono_current_par.fgcol
op_assign
id|FG_COLOR
suffix:semicolon
id|mono_current_par.bgcol
op_assign
id|BG_COLOR
suffix:semicolon
id|mono_current_par.crsrcol
op_assign
id|CRSR_COLOR
suffix:semicolon
)brace
multiline_comment|/* Define screen geometry */
id|mono_current_par.scr_max_height
op_assign
id|geom-&gt;scr_max_height
suffix:semicolon
id|mono_current_par.scr_max_width
op_assign
id|geom-&gt;scr_max_width
suffix:semicolon
id|mono_current_par.scr_height
op_assign
id|geom-&gt;scr_height
suffix:semicolon
id|mono_current_par.scr_width
op_assign
id|geom-&gt;scr_width
suffix:semicolon
id|mono_current_par.scr_depth
op_assign
id|geom-&gt;scr_depth
suffix:semicolon
id|mono_current_par.bplcon0
op_assign
id|geom-&gt;bplcon0
op_or
id|BPC0_COLOR
suffix:semicolon
id|mono_current_par.htotal
op_assign
id|geom-&gt;htotal
suffix:semicolon
multiline_comment|/* htotal was added, as I use it to calc the pal-line. -Jes */
r_if
c_cond
(paren
id|mono_current_par.scr_depth
OL
l_int|8
)paren
id|mono_current_par.bplcon0
op_or_assign
(paren
id|mono_current_par.scr_depth
op_lshift
l_int|12
)paren
suffix:semicolon
r_else
(brace
multiline_comment|/* must be exactly 8 */
id|mono_current_par.bplcon0
op_or_assign
id|BPC0_BPU3
suffix:semicolon
)brace
id|diw_min_v
op_assign
id|geom-&gt;diwstrt_v
suffix:semicolon
id|diw_min_h
op_assign
id|geom-&gt;diwstrt_h
suffix:semicolon
multiline_comment|/* We can derive everything else from this, at least for OCS */
multiline_comment|/*&n;&t; * For AGA: we don&squot;t use the finer position control available for&n;&t; * diw* yet (could be set by 35ns increments).&n;&t; */
multiline_comment|/* Calculate line and plane size while respecting the alignment restrictions */
id|mono_current_par.bytes_per_row
op_assign
(paren
(paren
id|mono_current_par.scr_width
op_plus
id|geom-&gt;alignment
op_minus
l_int|1
)paren
op_amp
op_complement
(paren
id|geom-&gt;alignment
op_minus
l_int|1
)paren
)paren
op_rshift
l_int|3
suffix:semicolon
id|mono_current_par.plane_size
op_assign
id|mono_current_par.bytes_per_row
op_star
id|mono_current_par.scr_height
suffix:semicolon
multiline_comment|/*&n;&t; *&t;&t;Quick hack for frame buffer mmap():&n;&t; *&n;&t; *&t;&t;plane_size must be a multiple of the page size&n;&t; */
id|mono_current_par.plane_size
op_assign
id|PAGE_ALIGN
c_func
(paren
id|mono_current_par.plane_size
)paren
suffix:semicolon
id|mono_current_par.y_wrap
op_assign
l_int|0
suffix:semicolon
id|mono_current_par.scroll_latch
op_assign
l_int|1
suffix:semicolon
id|p-&gt;cursor_x
op_assign
l_int|0
suffix:semicolon
id|p-&gt;cursor_y
op_assign
l_int|0
suffix:semicolon
id|mono_current_par.cursor_latch
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|mono_current_par.bplcon0
op_amp
id|BPC0_LACE
)paren
(brace
id|bplmod
op_assign
id|mono_current_par.bytes_per_row
suffix:semicolon
id|diwstrt_v
op_assign
id|diw_min_v
op_plus
(paren
id|mono_current_par.scr_max_height
op_minus
id|mono_current_par.scr_height
)paren
op_div
l_int|4
suffix:semicolon
id|diwstop_v
op_assign
(paren
id|diwstrt_v
op_plus
id|mono_current_par.scr_height
op_div
l_int|2
)paren
suffix:semicolon
)brace
r_else
(brace
id|bplmod
op_assign
l_int|0
suffix:semicolon
id|diwstrt_v
op_assign
id|diw_min_v
op_plus
(paren
id|mono_current_par.scr_max_height
op_minus
id|mono_current_par.scr_height
)paren
op_div
l_int|2
suffix:semicolon
id|diwstop_v
op_assign
(paren
id|diwstrt_v
op_plus
id|mono_current_par.scr_height
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mono_current_par.bplcon0
op_amp
id|BPC0_HIRES
)paren
(brace
id|diwstrt_h
op_assign
id|diw_min_h
op_plus
(paren
id|mono_current_par.scr_max_width
op_minus
id|mono_current_par.scr_width
)paren
op_div
l_int|4
suffix:semicolon
id|diwstop_h
op_assign
(paren
id|diwstrt_h
op_plus
id|mono_current_par.scr_width
op_div
l_int|2
)paren
suffix:semicolon
multiline_comment|/* ??? Where did 0x1d5 come from in original code ??? */
)brace
r_else
r_if
c_cond
(paren
id|mono_current_par.bplcon0
op_amp
id|BPC0_SHRES
)paren
(brace
id|diwstrt_h
op_assign
id|diw_min_h
op_plus
(paren
id|mono_current_par.scr_max_width
op_minus
id|mono_current_par.scr_width
)paren
op_div
l_int|8
suffix:semicolon
id|diwstop_h
op_assign
(paren
id|diwstrt_h
op_plus
id|mono_current_par.scr_width
op_div
l_int|4
)paren
suffix:semicolon
)brace
r_else
(brace
id|diwstrt_h
op_assign
id|diw_min_h
op_plus
(paren
id|mono_current_par.scr_max_width
op_minus
id|mono_current_par.scr_width
)paren
op_div
l_int|2
suffix:semicolon
id|diwstop_h
op_assign
(paren
id|diwstrt_h
op_plus
id|mono_current_par.scr_width
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mono_current_par.bplcon0
op_amp
id|BPC0_HIRES
)paren
(brace
id|ddfstrt
op_assign
(paren
id|diwstrt_h
op_rshift
l_int|1
)paren
op_minus
l_int|4
suffix:semicolon
id|ddfstop
op_assign
id|ddfstrt
op_plus
(paren
l_int|4
op_star
(paren
id|mono_current_par.bytes_per_row
op_rshift
l_int|1
)paren
)paren
op_minus
l_int|8
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mono_current_par.bplcon0
op_amp
id|BPC0_SHRES
op_logical_and
id|boot_info.bi_amiga.chipset
op_eq
id|CS_AGA
)paren
(brace
multiline_comment|/* There may be some interaction with FMODE here... -8 is magic. */
multiline_comment|/*&n;&t;&t; * This should be fixed, so it supports all different&n;&t;&t; * FMODE&squot;s.  FMODE varies the speed with 1,2 &amp; 4 the&n;&t;&t; * standard ECS speed.  Someone else has to do it, as&n;&t;&t; * I don&squot;t have an AGA machine with MMU available&n;&t;&t; * here.&n;&t;&t; *&n;&t;&t; * This particular speed looks like FMODE = 3 to me.&n;&t;&t; * ddfstop should be changed so it depends on FMODE under AGA.&n;&t;&t; * -Jes&n;&t;&t; */
id|ddfstrt
op_assign
(paren
id|diwstrt_h
op_rshift
l_int|1
)paren
op_minus
l_int|8
suffix:semicolon
id|ddfstop
op_assign
id|ddfstrt
op_plus
(paren
l_int|2
op_star
(paren
id|mono_current_par.bytes_per_row
op_rshift
l_int|1
)paren
)paren
op_minus
l_int|8
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mono_current_par.bplcon0
op_amp
id|BPC0_SHRES
op_logical_and
id|boot_info.bi_amiga.chipset
op_eq
id|CS_ECS
)paren
(brace
multiline_comment|/* &n;&t;&t; * Normal speed for ECS, should be the same for FMODE = 0&n;&t;&t; * -Jes&n;&t;&t; */
id|ddfstrt
op_assign
(paren
id|diwstrt_h
op_rshift
l_int|1
)paren
op_minus
l_int|2
suffix:semicolon
id|ddfstop
op_assign
id|ddfstrt
op_plus
(paren
l_int|2
op_star
(paren
id|mono_current_par.bytes_per_row
op_rshift
l_int|1
)paren
)paren
op_minus
l_int|8
suffix:semicolon
)brace
r_else
(brace
id|ddfstrt
op_assign
(paren
id|diwstrt_h
op_rshift
l_int|1
)paren
op_minus
l_int|8
suffix:semicolon
id|ddfstop
op_assign
id|ddfstrt
op_plus
(paren
l_int|8
op_star
(paren
id|mono_current_par.bytes_per_row
op_rshift
l_int|1
)paren
)paren
op_minus
l_int|8
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mono_current_par.bplcon0
op_amp
id|BPC0_LACE
)paren
id|cursorheight
op_assign
id|p-&gt;fontheight
op_div
l_int|2
suffix:semicolon
r_else
id|cursorheight
op_assign
id|p-&gt;fontheight
suffix:semicolon
multiline_comment|/*&n;&t; *&t;&t;Quick hack for frame buffer mmap():&n;&t; *&n;&t; *&t;&t;chipptr must be at a page boundary&n;&t; */
id|size
op_assign
id|mono_current_par.scr_depth
op_star
id|mono_current_par.plane_size
op_plus
id|COP_MEM_REQ
op_plus
id|SPR_MEM_REQ
op_plus
l_int|4
op_star
(paren
id|cursorheight
op_minus
l_int|1
)paren
suffix:semicolon
id|size
op_add_assign
id|PAGE_SIZE
op_minus
l_int|1
suffix:semicolon
id|chipptr
op_assign
id|amiga_chip_alloc
c_func
(paren
id|size
)paren
suffix:semicolon
id|chipptr
op_assign
(paren
r_char
op_star
)paren
id|PAGE_ALIGN
c_func
(paren
(paren
id|u_long
)paren
id|chipptr
)paren
suffix:semicolon
multiline_comment|/* locate the bitplanes */
multiline_comment|/* These MUST be 64 bit aligned for full AGA compatibility!! */
id|mono_current_par.smem_start
op_assign
(paren
id|u_long
)paren
id|chipptr
suffix:semicolon
id|mono_current_par.smem_len
op_assign
id|mono_current_par.plane_size
op_star
id|mono_current_par.scr_depth
suffix:semicolon
id|mono_current_par.geometry
op_assign
id|geom
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|mono_current_par.scr_depth
suffix:semicolon
id|i
op_increment
comma
id|chipptr
op_add_assign
id|mono_current_par.plane_size
)paren
(brace
id|mono_current_par.bitplane
(braket
id|i
)braket
op_assign
(paren
id|u_char
op_star
)paren
id|chipptr
suffix:semicolon
id|memset
(paren
(paren
r_void
op_star
)paren
id|chipptr
comma
l_int|0
comma
id|mono_current_par.plane_size
)paren
suffix:semicolon
multiline_comment|/* and clear */
)brace
multiline_comment|/* locate the copper lists */
id|mono_current_par.coplist1hdr
op_assign
(paren
id|ushort
op_star
)paren
id|chipptr
suffix:semicolon
id|chipptr
op_add_assign
id|MAX_COP_LIST_ENTS
op_star
l_int|4
suffix:semicolon
id|mono_current_par.coplist2hdr
op_assign
(paren
id|ushort
op_star
)paren
id|chipptr
suffix:semicolon
id|chipptr
op_add_assign
id|MAX_COP_LIST_ENTS
op_star
l_int|4
suffix:semicolon
multiline_comment|/* locate the sprite data */
id|mono_current_par.cursor
op_assign
(paren
id|ushort
op_star
)paren
id|chipptr
suffix:semicolon
id|chipptr
op_add_assign
l_int|8
op_plus
l_int|4
op_star
id|cursorheight
suffix:semicolon
id|mono_current_par.dummy
op_assign
(paren
id|ushort
op_star
)paren
id|chipptr
suffix:semicolon
id|chipptr
op_add_assign
l_int|12
suffix:semicolon
multiline_comment|/* create the sprite data for the cursor image */
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|mono_current_par.cursor
comma
l_int|0
comma
l_int|8
op_plus
l_int|4
op_star
id|cursorheight
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Only AGA supplies hires sprites.&n;&t; */
r_if
c_cond
(paren
id|mono_current_par.bplcon0
op_amp
id|BPC0_ECSENA
op_logical_and
id|boot_info.bi_amiga.chipset
op_eq
id|CS_AGA
)paren
multiline_comment|/* AGA cursor is SHIRES, ECS sprites differ */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|p-&gt;fontwidth
)paren
op_logical_and
(paren
id|i
OL
l_int|16
)paren
suffix:semicolon
id|i
op_increment
)paren
id|cursormask
op_or_assign
l_int|1
op_lshift
(paren
l_int|15
op_minus
id|i
)paren
suffix:semicolon
r_else
multiline_comment|/* For OCS &amp; ECS sprites are pure LORES 8-&lt; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|p-&gt;fontwidth
op_div
l_int|2
)paren
op_logical_and
(paren
id|i
OL
l_int|8
)paren
suffix:semicolon
id|i
op_increment
)paren
id|cursormask
op_or_assign
l_int|1
op_lshift
(paren
l_int|15
op_minus
id|i
)paren
suffix:semicolon
id|mono_current_par.cursor
(braket
l_int|0
)braket
op_assign
id|mono_cursor_data
(braket
l_int|0
)braket
suffix:semicolon
id|mono_current_par.cursor
(braket
l_int|1
)braket
op_assign
id|mono_cursor_data
(braket
l_int|1
)braket
suffix:semicolon
macro_line|#if (CRSR_BLOCK == 1)
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cursorheight
suffix:semicolon
id|i
op_increment
)paren
macro_line|#else
r_for
c_loop
(paren
id|i
op_assign
id|cursorheight
op_minus
l_int|2
suffix:semicolon
id|i
OL
id|cursorheight
suffix:semicolon
id|i
op_increment
)paren
macro_line|#endif
id|mono_current_par.cursor
(braket
l_int|2
op_plus
l_int|2
op_star
id|i
)braket
op_assign
id|cursormask
suffix:semicolon
multiline_comment|/* set dummy sprite data to a blank sprite */
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|mono_current_par.dummy
comma
l_int|0
comma
l_int|12
)paren
suffix:semicolon
multiline_comment|/* set cursor flashing */
id|mono_current_par.cursor_flash
op_assign
id|CRSR_FLASH
suffix:semicolon
multiline_comment|/* Make the cursor invisible */
id|mono_current_par.cursor_visible
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Initialise the chipregs */
id|mono_current_par.diwstrt_v
op_assign
id|diwstrt_v
suffix:semicolon
id|mono_current_par.diwstrt_h
op_assign
id|diwstrt_h
suffix:semicolon
id|mono_current_par.diwstop_v
op_assign
id|diwstop_v
suffix:semicolon
id|mono_current_par.diwstop_h
op_assign
id|diwstop_h
suffix:semicolon
id|diwstrt
op_assign
(paren
(paren
id|diwstrt_v
op_lshift
l_int|8
)paren
op_or
id|diwstrt_h
)paren
suffix:semicolon
id|diwstop
op_assign
(paren
(paren
id|diwstop_v
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
op_or
(paren
id|diwstop_h
op_amp
l_int|0xff
)paren
suffix:semicolon
id|custom.bplcon0
op_assign
id|mono_current_par.bplcon0
suffix:semicolon
multiline_comment|/* set the display mode */
id|custom.bplcon1
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Needed for horizontal scrolling */
id|custom.bplcon2
op_assign
l_int|0
suffix:semicolon
id|custom.bpl1mod
op_assign
id|bplmod
suffix:semicolon
id|custom.bpl2mod
op_assign
id|bplmod
suffix:semicolon
id|custom.diwstrt
op_assign
id|diwstrt
suffix:semicolon
id|custom.diwstop
op_assign
id|diwstop
suffix:semicolon
id|custom.ddfstrt
op_assign
id|ddfstrt
suffix:semicolon
id|custom.ddfstop
op_assign
id|ddfstop
suffix:semicolon
id|custom.color
(braket
l_int|0
)braket
op_assign
id|COLOR_MSB
c_func
(paren
id|mono_current_par.bgcol
)paren
suffix:semicolon
id|custom.color
(braket
l_int|1
)braket
op_assign
id|COLOR_MSB
c_func
(paren
id|mono_current_par.fgcol
)paren
suffix:semicolon
id|custom.color
(braket
l_int|17
)braket
op_assign
id|COLOR_MSB
c_func
(paren
id|mono_current_par.crsrcol
)paren
suffix:semicolon
multiline_comment|/* Sprite 0 color */
r_if
c_cond
(paren
id|boot_info.bi_amiga.chipset
op_eq
id|CS_AGA
)paren
(brace
multiline_comment|/* Fill in the LSB of the 24 bit color palette */
multiline_comment|/* Must happen after MSB */
id|custom.bplcon3
op_assign
id|geom-&gt;bplcon3
op_or
id|BPC3_LOCT
suffix:semicolon
id|custom.color
(braket
l_int|0
)braket
op_assign
id|COLOR_LSB
c_func
(paren
id|mono_current_par.bgcol
)paren
suffix:semicolon
id|custom.color
(braket
l_int|1
)braket
op_assign
id|COLOR_LSB
c_func
(paren
id|mono_current_par.fgcol
)paren
suffix:semicolon
id|custom.color
(braket
l_int|17
)braket
op_assign
id|COLOR_LSB
c_func
(paren
id|mono_current_par.crsrcol
)paren
suffix:semicolon
id|custom.bplcon3
op_assign
id|geom-&gt;bplcon3
suffix:semicolon
)brace
r_if
c_cond
(paren
id|boot_info.bi_amiga.chipset
op_eq
id|CS_ECS
op_logical_and
id|mono_current_par.bplcon0
op_amp
id|BPC0_ECSENA
)paren
(brace
multiline_comment|/*&n;&t;&t; * Calculation of the special ECS color-tables for&n;&t;&t; * planes and sprites is done in the function&n;&t;&t; * build_ecs_table&n;&t;&t; */
multiline_comment|/*&n;&t;&t; * Calcs a special ECS colortable for the bitplane,&n;&t;&t; * and copies it to the custom registers&n;&t;&t; */
id|mono_build_ecs_colors
c_func
(paren
id|COLOR_MSB
c_func
(paren
id|mono_current_par.bgcol
)paren
comma
id|COLOR_MSB
c_func
(paren
id|mono_current_par.fgcol
)paren
comma
l_int|0
comma
l_int|0
comma
id|ecs_table
)paren
suffix:semicolon
macro_line|#if 0
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|custom.color
(braket
id|i
)braket
op_assign
id|ecs_table
(braket
id|i
op_star
l_int|2
)braket
suffix:semicolon
id|custom.color
(braket
id|i
op_plus
l_int|8
)braket
op_assign
id|ecs_table
(braket
id|i
op_star
l_int|2
op_plus
l_int|1
)braket
suffix:semicolon
)brace
macro_line|#else
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|custom.color
(braket
id|i
)braket
op_assign
id|ecs_table
(braket
id|i
)braket
suffix:semicolon
)brace
macro_line|#endif
id|mono_ecs_color_zero
op_assign
id|ecs_table
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Calcs a special ECS colortable for the cursor&n;&t;&t; * sprite, and copies it to the appropriate custom&n;&t;&t; * registers&n;&t;&t; */
id|mono_build_ecs_colors
c_func
(paren
l_int|0
comma
id|COLOR_MSB
c_func
(paren
id|mono_current_par.crsrcol
)paren
comma
l_int|0
comma
l_int|0
comma
id|ecs_table
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|custom.color
(braket
id|i
op_plus
l_int|16
)braket
op_assign
id|ecs_table
(braket
id|i
)braket
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|geom-&gt;isOCS
)paren
)paren
(brace
multiline_comment|/* Need to set up a bunch more regs */
multiline_comment|/* Assumes that diwstrt is in the (0,0) sector, but stop might not be */
id|diwhigh
op_assign
(paren
id|diwstop_v
op_amp
l_int|0x700
)paren
op_or
(paren
(paren
id|diwstop_h
op_amp
l_int|0x100
)paren
op_lshift
l_int|5
)paren
suffix:semicolon
id|custom.bplcon2
op_assign
id|geom-&gt;bplcon2
suffix:semicolon
id|custom.bplcon3
op_assign
id|geom-&gt;bplcon3
suffix:semicolon
multiline_comment|/* save bplcon3 for blanking */
id|mono_save_bplcon3
op_assign
id|geom-&gt;bplcon3
suffix:semicolon
id|custom.diwhigh
op_assign
id|diwhigh
suffix:semicolon
multiline_comment|/* must happen AFTER diwstrt, stop */
id|custom.htotal
op_assign
id|geom-&gt;htotal
suffix:semicolon
id|custom.hsstrt
op_assign
id|geom-&gt;hsstrt
suffix:semicolon
id|custom.hsstop
op_assign
id|geom-&gt;hsstop
suffix:semicolon
id|custom.hbstrt
op_assign
id|geom-&gt;hbstrt
suffix:semicolon
id|custom.hbstop
op_assign
id|geom-&gt;hbstop
suffix:semicolon
id|custom.vtotal
op_assign
id|geom-&gt;vtotal
suffix:semicolon
id|custom.vsstrt
op_assign
id|geom-&gt;vsstrt
suffix:semicolon
id|custom.vsstop
op_assign
id|geom-&gt;vsstop
suffix:semicolon
id|custom.vbstrt
op_assign
id|geom-&gt;vbstrt
suffix:semicolon
id|custom.vbstop
op_assign
id|geom-&gt;vbstop
suffix:semicolon
id|custom.hcenter
op_assign
id|geom-&gt;hcenter
suffix:semicolon
id|custom.beamcon0
op_assign
id|geom-&gt;beamcon0
suffix:semicolon
r_if
c_cond
(paren
id|boot_info.bi_amiga.chipset
op_eq
id|CS_AGA
)paren
(brace
id|custom.fmode
op_assign
id|geom-&gt;fmode
suffix:semicolon
)brace
multiline_comment|/* &n;&t;&t; * fmode does NOT! exist under ECS, weird things might happen&n;&t;&t; */
multiline_comment|/* We could load 8-bit colors here, if we wanted */
multiline_comment|/*&n;&t;&t; *    The minimum period for audio depends on htotal (for OCS/ECS/AGA)&n;&t;&t; */
r_if
c_cond
(paren
id|boot_info.bi_amiga.chipset
op_ne
id|CS_STONEAGE
)paren
id|amiga_audio_min_period
op_assign
(paren
id|geom-&gt;htotal
op_rshift
l_int|1
)paren
op_plus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Build initial copper lists. sprites must be set up, and mono_current_par.diwstrt. */
r_if
c_cond
(paren
id|mono_current_par.bplcon0
op_amp
id|BPC0_LACE
)paren
(brace
id|mono_current_par.coplist1dyn
op_assign
id|mono_build_clist_hdr
c_func
(paren
id|p
comma
id|mono_current_par.coplist1hdr
comma
id|mono_current_par.coplist2hdr
)paren
comma
id|mono_build_clist_dyn
c_func
(paren
id|p
comma
id|mono_current_par.coplist1dyn
comma
l_int|0
)paren
suffix:semicolon
id|mono_current_par.coplist2dyn
op_assign
id|mono_build_clist_hdr
c_func
(paren
id|p
comma
id|mono_current_par.coplist2hdr
comma
id|mono_current_par.coplist1hdr
)paren
comma
id|mono_build_clist_dyn
c_func
(paren
id|p
comma
id|mono_current_par.coplist2dyn
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|mono_current_par.coplist1dyn
op_assign
id|mono_build_clist_hdr
c_func
(paren
id|p
comma
id|mono_current_par.coplist1hdr
comma
l_int|NULL
)paren
comma
id|mono_build_clist_dyn
c_func
(paren
id|p
comma
id|mono_current_par.coplist1dyn
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Get ready to run first copper list */
id|custom.cop1lc
op_assign
id|mono_current_par.coplist1hdr
suffix:semicolon
id|custom.copjmp1
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* turn on DMA for bitplane and sprites */
id|custom.dmacon
op_assign
id|DMAF_SETCLR
op_or
id|DMAF_RASTER
op_or
id|DMAF_COPPER
op_or
id|DMAF_SPRITE
suffix:semicolon
r_if
c_cond
(paren
id|mono_current_par.bplcon0
op_amp
id|BPC0_LACE
)paren
(brace
multiline_comment|/* Make sure we get the fields in the right order */
multiline_comment|/* wait for LOF frame bit to go low */
r_while
c_loop
(paren
id|custom.vposr
op_amp
l_int|0x8000
)paren
suffix:semicolon
multiline_comment|/* wait for LOF frame bit to go high */
r_while
c_loop
(paren
op_logical_neg
(paren
id|custom.vposr
op_amp
l_int|0x8000
)paren
)paren
suffix:semicolon
multiline_comment|/* start again at the beginning of copper list 1 */
id|custom.cop1lc
op_assign
id|mono_current_par.coplist1hdr
suffix:semicolon
id|custom.copjmp1
op_assign
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|mono_amifb_interrupt
r_static
r_void
id|mono_amifb_interrupt
c_func
(paren
r_int
id|irq
comma
r_struct
id|pt_regs
op_star
id|fp
comma
r_void
op_star
id|data
)paren
(brace
r_register
r_struct
id|display
op_star
id|p
op_assign
id|disp
suffix:semicolon
r_static
id|ushort
id|cursorcount
op_assign
l_int|0
suffix:semicolon
r_static
id|ushort
id|cursorstate
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* I *think* that you should only change display lists on long frame.&n;&t; * At least it goes awfully peculiar on my A500 without the following&n;&t; * test. Not really in a position to test this hypothesis, so sorry&n;&t; * for the slow scrolling, all you flicker-fixed souls&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|mono_current_par.bplcon0
op_amp
id|BPC0_LACE
)paren
op_logical_or
(paren
id|custom.vposr
op_amp
l_int|0x8000
)paren
)paren
(brace
r_if
c_cond
(paren
id|mono_current_par.scroll_latch
op_logical_or
id|mono_current_par.cursor_latch
)paren
id|mono_build_cursor
c_func
(paren
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mono_current_par.scroll_latch
)paren
r_if
c_cond
(paren
id|mono_current_par.bplcon0
op_amp
id|BPC0_LACE
)paren
(brace
id|mono_build_clist_dyn
c_func
(paren
id|p
comma
id|mono_current_par.coplist1dyn
comma
l_int|0
)paren
suffix:semicolon
id|mono_build_clist_dyn
c_func
(paren
id|p
comma
id|mono_current_par.coplist2dyn
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
id|mono_build_clist_dyn
c_func
(paren
id|p
comma
id|mono_current_par.coplist1dyn
comma
l_int|0
)paren
suffix:semicolon
id|mono_current_par.scroll_latch
op_assign
l_int|0
suffix:semicolon
id|mono_current_par.cursor_latch
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|custom.potgor
op_amp
(paren
l_int|1
op_lshift
l_int|10
)paren
)paren
)paren
id|mono_vblank.right_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|mono_current_par.cursor_visible
)paren
(brace
r_if
c_cond
(paren
id|mono_current_par.cursor_flash
)paren
(brace
r_if
c_cond
(paren
id|cursorcount
)paren
id|cursorcount
op_decrement
suffix:semicolon
r_else
(brace
id|cursorcount
op_assign
id|CRSR_RATE
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cursorstate
op_assign
op_logical_neg
id|cursorstate
)paren
)paren
id|custom.dmacon
op_assign
id|DMAF_SETCLR
op_or
id|DMAF_SPRITE
suffix:semicolon
r_else
id|custom.dmacon
op_assign
id|DMAF_SPRITE
suffix:semicolon
)brace
)brace
)brace
r_else
id|custom.dmacon
op_assign
id|DMAF_SPRITE
suffix:semicolon
r_if
c_cond
(paren
id|mono_do_blank
)paren
(brace
id|custom.dmacon
op_assign
id|DMAF_RASTER
op_or
id|DMAF_SPRITE
suffix:semicolon
id|custom.color
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|boot_info.bi_amiga.chipset
op_eq
id|CS_AGA
)paren
(brace
multiline_comment|/* Fill in the LSB of the 24 bit color palette */
multiline_comment|/* Must happen after MSB */
id|custom.bplcon3
op_assign
id|mono_save_bplcon3
op_or
id|BPC3_LOCT
suffix:semicolon
id|custom.color
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|custom.bplcon3
op_assign
id|mono_save_bplcon3
suffix:semicolon
)brace
id|mono_do_blank
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mono_do_unblank
)paren
(brace
r_if
c_cond
(paren
id|mono_current_par.cursor_visible
)paren
id|custom.dmacon
op_assign
id|DMAF_SETCLR
op_or
id|DMAF_RASTER
op_or
id|DMAF_SPRITE
suffix:semicolon
r_else
id|custom.dmacon
op_assign
id|DMAF_SETCLR
op_or
id|DMAF_RASTER
suffix:semicolon
id|custom.color
(braket
l_int|0
)braket
op_assign
id|COLOR_MSB
c_func
(paren
id|mono_current_par.bgcol
)paren
suffix:semicolon
r_if
c_cond
(paren
id|boot_info.bi_amiga.chipset
op_eq
id|CS_AGA
)paren
(brace
multiline_comment|/* Fill in the LSB of the 24 bit color palette */
multiline_comment|/* Must happen after MSB */
id|custom.bplcon3
op_assign
id|mono_save_bplcon3
op_or
id|BPC3_LOCT
suffix:semicolon
id|custom.color
(braket
l_int|0
)braket
op_assign
id|COLOR_LSB
c_func
(paren
id|mono_current_par.bgcol
)paren
suffix:semicolon
id|custom.bplcon3
op_assign
id|mono_save_bplcon3
suffix:semicolon
)brace
multiline_comment|/* color[0] is set to mono_ecs_color_zero under ECS */
r_if
c_cond
(paren
id|boot_info.bi_amiga.chipset
op_eq
id|CS_ECS
op_logical_and
id|mono_current_par.bplcon0
op_amp
id|BPC0_ECSENA
)paren
(brace
id|custom.color
(braket
l_int|0
)braket
op_assign
id|mono_ecs_color_zero
suffix:semicolon
)brace
id|mono_do_unblank
op_assign
l_int|0
suffix:semicolon
)brace
id|mono_vblank.done
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|mono_amiga_fb_get_fix
r_static
r_int
id|mono_amiga_fb_get_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_int
id|con
)paren
(brace
r_int
id|i
suffix:semicolon
id|strcpy
c_func
(paren
id|fix-&gt;id
comma
id|mono_current_par.geometry-&gt;modename
)paren
suffix:semicolon
id|fix-&gt;smem_start
op_assign
id|mono_current_par.smem_start
suffix:semicolon
id|fix-&gt;smem_len
op_assign
id|mono_current_par.smem_len
suffix:semicolon
multiline_comment|/*&n;&t; *&t;&t;Only monochrome bitmap at the moment&n;&t; */
id|fix-&gt;type
op_assign
id|FB_TYPE_PACKED_PIXELS
suffix:semicolon
id|fix-&gt;type_aux
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mono_amifb_inverse
)paren
id|fix-&gt;visual
op_assign
id|FB_VISUAL_MONO10
suffix:semicolon
r_else
id|fix-&gt;visual
op_assign
id|FB_VISUAL_MONO01
suffix:semicolon
id|fix-&gt;xpanstep
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;ypanstep
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;ywrapstep
op_assign
l_int|1
suffix:semicolon
id|fix-&gt;line_length
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|arraysize
c_func
(paren
id|fix-&gt;reserved
)paren
suffix:semicolon
id|i
op_increment
)paren
id|fix-&gt;reserved
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mono_amiga_fb_get_var
r_static
r_int
id|mono_amiga_fb_get_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
)paren
(brace
r_int
id|i
suffix:semicolon
id|var-&gt;xres
op_assign
id|mono_current_par.geometry-&gt;scr_width
suffix:semicolon
id|var-&gt;yres
op_assign
id|mono_current_par.geometry-&gt;scr_height
suffix:semicolon
id|var-&gt;xres_virtual
op_assign
id|var-&gt;xres
suffix:semicolon
id|var-&gt;yres_virtual
op_assign
id|var-&gt;yres
suffix:semicolon
id|var-&gt;xoffset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;yoffset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;bits_per_pixel
op_assign
id|mono_current_par.geometry-&gt;scr_depth
suffix:semicolon
id|var-&gt;grayscale
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|boot_info.bi_amiga.chipset
op_eq
id|CS_AGA
)paren
(brace
id|var-&gt;red.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;red.msb_right
op_assign
l_int|0
suffix:semicolon
id|var-&gt;green
op_assign
id|var-&gt;red
suffix:semicolon
id|var-&gt;blue
op_assign
id|var-&gt;red
suffix:semicolon
)brace
r_else
(brace
id|var-&gt;red.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|4
suffix:semicolon
id|var-&gt;red.msb_right
op_assign
l_int|0
suffix:semicolon
id|var-&gt;green
op_assign
id|var-&gt;red
suffix:semicolon
id|var-&gt;blue
op_assign
id|var-&gt;red
suffix:semicolon
)brace
id|var-&gt;nonstd
op_assign
l_int|0
suffix:semicolon
id|var-&gt;activate
op_assign
l_int|0
suffix:semicolon
id|var-&gt;width
op_assign
op_minus
l_int|1
suffix:semicolon
id|var-&gt;height
op_assign
op_minus
l_int|1
suffix:semicolon
id|var-&gt;accel
op_assign
id|FB_ACCEL_NONE
suffix:semicolon
id|var-&gt;pixclock
op_assign
l_int|35242
suffix:semicolon
id|var-&gt;left_margin
op_assign
(paren
id|mono_current_par.geometry-&gt;hbstop
op_minus
id|mono_current_par.geometry-&gt;hsstrt
)paren
op_star
l_int|8
suffix:semicolon
id|var-&gt;right_margin
op_assign
(paren
id|mono_current_par.geometry-&gt;hsstrt
op_minus
id|mono_current_par.geometry-&gt;hbstrt
)paren
op_star
l_int|8
suffix:semicolon
id|var-&gt;upper_margin
op_assign
(paren
id|mono_current_par.geometry-&gt;vbstop
op_minus
id|mono_current_par.geometry-&gt;vsstrt
)paren
op_star
l_int|8
suffix:semicolon
id|var-&gt;lower_margin
op_assign
(paren
id|mono_current_par.geometry-&gt;vsstrt
op_minus
id|mono_current_par.geometry-&gt;vbstrt
)paren
op_star
l_int|8
suffix:semicolon
id|var-&gt;hsync_len
op_assign
(paren
id|mono_current_par.geometry-&gt;hsstop
op_minus
id|mono_current_par.geometry-&gt;hsstrt
)paren
op_star
l_int|8
suffix:semicolon
id|var-&gt;vsync_len
op_assign
(paren
id|mono_current_par.geometry-&gt;vsstop
op_minus
id|mono_current_par.geometry-&gt;vsstrt
)paren
op_star
l_int|8
suffix:semicolon
id|var-&gt;sync
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mono_current_par.geometry-&gt;bplcon0
op_amp
id|BPC0_LACE
)paren
id|var-&gt;vmode
op_assign
id|FB_VMODE_INTERLACED
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|boot_info.bi_amiga.chipset
op_eq
id|CS_AGA
)paren
op_logical_and
(paren
id|mono_current_par.geometry-&gt;fmode
op_amp
id|FMODE_BSCAN2
)paren
)paren
id|var-&gt;vmode
op_assign
id|FB_VMODE_DOUBLE
suffix:semicolon
r_else
id|var-&gt;vmode
op_assign
id|FB_VMODE_NONINTERLACED
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|arraysize
c_func
(paren
id|var-&gt;reserved
)paren
suffix:semicolon
id|i
op_increment
)paren
id|var-&gt;reserved
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mono_amiga_fb_set_disp
r_static
r_void
id|mono_amiga_fb_set_disp
c_func
(paren
r_int
id|con
)paren
(brace
r_struct
id|fb_fix_screeninfo
id|fix
suffix:semicolon
id|mono_amiga_fb_get_fix
c_func
(paren
op_amp
id|fix
comma
id|con
)paren
suffix:semicolon
r_if
c_cond
(paren
id|con
op_eq
op_minus
l_int|1
)paren
id|con
op_assign
l_int|0
suffix:semicolon
id|disp
(braket
id|con
)braket
dot
id|screen_base
op_assign
(paren
id|u_char
op_star
)paren
id|fix.smem_start
suffix:semicolon
id|disp
(braket
id|con
)braket
dot
id|visual
op_assign
id|fix.visual
suffix:semicolon
id|disp
(braket
id|con
)braket
dot
id|type
op_assign
id|fix.type
suffix:semicolon
id|disp
(braket
id|con
)braket
dot
id|type_aux
op_assign
id|fix.type_aux
suffix:semicolon
id|disp
(braket
id|con
)braket
dot
id|ypanstep
op_assign
id|fix.ypanstep
suffix:semicolon
id|disp
(braket
id|con
)braket
dot
id|ywrapstep
op_assign
id|fix.ywrapstep
suffix:semicolon
id|disp
(braket
id|con
)braket
dot
id|line_length
op_assign
id|fix.line_length
suffix:semicolon
id|disp
(braket
id|con
)braket
dot
id|can_soft_blank
op_assign
l_int|1
suffix:semicolon
id|disp
(braket
id|con
)braket
dot
id|inverse
op_assign
id|mono_amifb_inverse
suffix:semicolon
)brace
DECL|function|mono_amiga_fb_set_var
r_static
r_int
id|mono_amiga_fb_set_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
)paren
(brace
multiline_comment|/*&n;&t; *&t;&t;Not yet implemented&n;&t; */
r_return
l_int|0
suffix:semicolon
multiline_comment|/* The X server needs this */
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|variable|mono_red_normal
r_static
r_int
id|mono_red_normal
(braket
)braket
op_assign
(brace
(paren
(paren
id|BG_COLOR
op_amp
l_int|0xff0000
)paren
op_rshift
l_int|8
)paren
op_or
(paren
(paren
id|BG_COLOR
op_amp
l_int|0xff0000
)paren
op_rshift
l_int|16
)paren
comma
(paren
(paren
id|FG_COLOR
op_amp
l_int|0xff0000
)paren
op_rshift
l_int|8
)paren
op_or
(paren
(paren
id|FG_COLOR
op_amp
l_int|0xff0000
)paren
op_rshift
l_int|16
)paren
)brace
suffix:semicolon
DECL|variable|mono_green_normal
r_static
r_int
id|mono_green_normal
(braket
)braket
op_assign
(brace
(paren
(paren
id|BG_COLOR
op_amp
l_int|0x00ff00
)paren
)paren
op_or
(paren
(paren
id|BG_COLOR
op_amp
l_int|0x00ff00
)paren
op_rshift
l_int|8
)paren
comma
(paren
(paren
id|FG_COLOR
op_amp
l_int|0x00ff00
)paren
)paren
op_or
(paren
(paren
id|FG_COLOR
op_amp
l_int|0x00ff00
)paren
op_rshift
l_int|8
)paren
)brace
suffix:semicolon
DECL|variable|mono_blue_normal
r_static
r_int
id|mono_blue_normal
(braket
)braket
op_assign
(brace
(paren
(paren
id|BG_COLOR
op_amp
l_int|0x0000ff
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|BG_COLOR
op_amp
l_int|0x0000ff
)paren
)paren
comma
(paren
(paren
id|FG_COLOR
op_amp
l_int|0x0000ff
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|FG_COLOR
op_amp
l_int|0x0000ff
)paren
)paren
)brace
suffix:semicolon
DECL|variable|mono_red_inverse
r_static
r_int
id|mono_red_inverse
(braket
)braket
op_assign
(brace
(paren
(paren
id|BG_COLOR_INV
op_amp
l_int|0xff0000
)paren
op_rshift
l_int|8
)paren
op_or
(paren
(paren
id|BG_COLOR_INV
op_amp
l_int|0xff0000
)paren
op_rshift
l_int|16
)paren
comma
(paren
(paren
id|FG_COLOR_INV
op_amp
l_int|0xff0000
)paren
op_rshift
l_int|8
)paren
op_or
(paren
(paren
id|FG_COLOR_INV
op_amp
l_int|0xff0000
)paren
op_rshift
l_int|16
)paren
)brace
suffix:semicolon
DECL|variable|mono_green_inverse
r_static
r_int
id|mono_green_inverse
(braket
)braket
op_assign
(brace
(paren
(paren
id|BG_COLOR_INV
op_amp
l_int|0x00ff00
)paren
)paren
op_or
(paren
(paren
id|BG_COLOR_INV
op_amp
l_int|0x00ff00
)paren
op_rshift
l_int|8
)paren
comma
(paren
(paren
id|FG_COLOR_INV
op_amp
l_int|0x00ff00
)paren
)paren
op_or
(paren
(paren
id|FG_COLOR_INV
op_amp
l_int|0x00ff00
)paren
op_rshift
l_int|8
)paren
)brace
suffix:semicolon
DECL|variable|mono_blue_inverse
r_static
r_int
id|mono_blue_inverse
(braket
)braket
op_assign
(brace
(paren
(paren
id|BG_COLOR_INV
op_amp
l_int|0x0000ff
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|BG_COLOR_INV
op_amp
l_int|0x0000ff
)paren
)paren
comma
(paren
(paren
id|FG_COLOR_INV
op_amp
l_int|0x0000ff
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|FG_COLOR
op_amp
l_int|0x0000ff
)paren
)paren
)brace
suffix:semicolon
DECL|variable|mono_default_cmap_normal
r_static
r_struct
id|fb_cmap
id|mono_default_cmap_normal
op_assign
(brace
l_int|0
comma
l_int|2
comma
id|mono_red_normal
comma
id|mono_green_normal
comma
id|mono_blue_normal
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|mono_default_cmap_inverse
r_static
r_struct
id|fb_cmap
id|mono_default_cmap_inverse
op_assign
(brace
l_int|0
comma
l_int|2
comma
id|mono_red_inverse
comma
id|mono_green_inverse
comma
id|mono_blue_inverse
comma
l_int|NULL
)brace
suffix:semicolon
DECL|function|mono_amiga_fb_get_cmap
r_static
r_int
id|mono_amiga_fb_get_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
)paren
(brace
r_int
id|i
comma
id|start
suffix:semicolon
r_int
r_int
op_star
id|red
comma
op_star
id|green
comma
op_star
id|blue
comma
op_star
id|transp
suffix:semicolon
r_int
r_int
id|hred
comma
id|hgreen
comma
id|hblue
comma
id|htransp
suffix:semicolon
r_struct
id|fb_cmap
op_star
id|def_cmap
suffix:semicolon
id|red
op_assign
id|cmap-&gt;red
suffix:semicolon
id|green
op_assign
id|cmap-&gt;green
suffix:semicolon
id|blue
op_assign
id|cmap-&gt;blue
suffix:semicolon
id|transp
op_assign
id|cmap-&gt;transp
suffix:semicolon
id|start
op_assign
id|cmap-&gt;start
suffix:semicolon
r_if
c_cond
(paren
id|start
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|mono_amifb_inverse
)paren
id|def_cmap
op_assign
op_amp
id|mono_default_cmap_inverse
suffix:semicolon
r_else
id|def_cmap
op_assign
op_amp
id|mono_default_cmap_normal
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cmap-&gt;len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OL
id|def_cmap-&gt;len
)paren
(brace
id|hred
op_assign
id|def_cmap-&gt;red
(braket
id|i
)braket
suffix:semicolon
id|hgreen
op_assign
id|def_cmap-&gt;green
(braket
id|i
)braket
suffix:semicolon
id|hblue
op_assign
id|def_cmap-&gt;blue
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|def_cmap-&gt;transp
)paren
id|htransp
op_assign
id|def_cmap-&gt;transp
(braket
id|i
)braket
suffix:semicolon
r_else
id|htransp
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|hred
op_assign
id|hgreen
op_assign
id|hblue
op_assign
id|htransp
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|kspc
)paren
(brace
op_star
id|red
op_assign
id|hred
suffix:semicolon
op_star
id|green
op_assign
id|hgreen
suffix:semicolon
op_star
id|blue
op_assign
id|hblue
suffix:semicolon
r_if
c_cond
(paren
id|transp
)paren
op_star
id|transp
op_assign
id|htransp
suffix:semicolon
)brace
r_else
(brace
id|put_fs_word
c_func
(paren
id|hred
comma
id|red
)paren
suffix:semicolon
id|put_fs_word
c_func
(paren
id|hgreen
comma
id|green
)paren
suffix:semicolon
id|put_fs_word
c_func
(paren
id|hblue
comma
id|blue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|transp
)paren
id|put_fs_word
c_func
(paren
id|htransp
comma
id|transp
)paren
suffix:semicolon
)brace
id|red
op_increment
suffix:semicolon
id|green
op_increment
suffix:semicolon
id|blue
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|transp
)paren
id|transp
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mono_amiga_fb_set_cmap
r_static
r_int
id|mono_amiga_fb_set_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
)paren
(brace
multiline_comment|/*&n;&t; *&t;&t;Not yet implemented&n;&t; */
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|mono_amiga_fb_pan_display
r_static
r_int
id|mono_amiga_fb_pan_display
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
)paren
(brace
multiline_comment|/*&n;&t; *&t;&t;Not yet implemented&n;&t; */
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|mono_amiga_fb_ioctl
r_static
r_int
id|mono_amiga_fb_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
r_int
id|con
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|variable|mono_amiga_fb_ops
r_static
r_struct
id|fb_ops
id|mono_amiga_fb_ops
op_assign
(brace
id|mono_amiga_fb_get_fix
comma
id|mono_amiga_fb_get_var
comma
id|mono_amiga_fb_set_var
comma
id|mono_amiga_fb_get_cmap
comma
id|mono_amiga_fb_set_cmap
comma
id|mono_amiga_fb_pan_display
comma
id|mono_amiga_fb_ioctl
)brace
suffix:semicolon
DECL|function|mono_amifb_switch
r_static
r_int
id|mono_amifb_switch
(paren
r_int
id|con
)paren
(brace
id|mono_current_par.y_wrap
op_assign
id|disp
(braket
id|con
)braket
dot
id|var.yoffset
suffix:semicolon
id|mono_current_par.cursor_latch
op_assign
l_int|1
suffix:semicolon
id|mono_current_par.scroll_latch
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mono_amifb_updatevar
r_static
r_int
id|mono_amifb_updatevar
c_func
(paren
r_int
id|con
)paren
(brace
id|mono_current_par.y_wrap
op_assign
id|disp
(braket
id|con
)braket
dot
id|var.yoffset
suffix:semicolon
id|mono_current_par.cursor_latch
op_assign
l_int|1
suffix:semicolon
id|mono_current_par.scroll_latch
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mono_amifb_blank
r_static
r_void
id|mono_amifb_blank
c_func
(paren
r_int
id|blank
)paren
(brace
r_if
c_cond
(paren
id|blank
)paren
id|mono_do_blank
op_assign
l_int|1
suffix:semicolon
r_else
id|mono_do_unblank
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|mono_amiga_fb_init
r_static
r_struct
id|fb_info
op_star
id|mono_amiga_fb_init
c_func
(paren
r_int
op_star
id|mem_start
)paren
(brace
r_int
id|mode
op_assign
id|mono_amifb_mode
suffix:semicolon
id|ulong
id|model
suffix:semicolon
r_int
id|inverse_video
op_assign
id|mono_amifb_inverse
suffix:semicolon
r_int
id|err
suffix:semicolon
id|err
op_assign
id|register_framebuffer
c_func
(paren
l_string|&quot;Amiga Builtin&quot;
comma
op_amp
id|node
comma
op_amp
id|mono_amiga_fb_ops
comma
id|mono_num_mono_amiga_fb_predefined
comma
id|mono_mono_amiga_fb_predefined
)paren
suffix:semicolon
id|model
op_assign
id|boot_info.bi_un.bi_ami.model
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
op_minus
l_int|1
)paren
r_if
c_cond
(paren
id|boot_info.bi_amiga.chipset
op_eq
id|CS_AGA
)paren
id|mode
op_assign
id|AGA_DEFMODE
suffix:semicolon
r_else
r_if
c_cond
(paren
id|model
op_eq
id|AMI_3000
)paren
id|mode
op_assign
id|boot_info.bi_un.bi_ami.vblank
op_eq
l_int|50
ques
c_cond
id|OCS_PAL_3000_DEFMODE
suffix:colon
id|OCS_NTSC_3000_DEFMODE
suffix:semicolon
r_else
id|mode
op_assign
id|boot_info.bi_un.bi_ami.vblank
op_eq
l_int|50
ques
c_cond
id|OCS_PAL_LOWEND_DEFMODE
suffix:colon
id|OCS_NTSC_LOWEND_DEFMODE
suffix:semicolon
id|mono_init_vblank
c_func
(paren
)paren
suffix:semicolon
id|mono_display_init
c_func
(paren
id|disp
comma
op_amp
id|mono_modes
(braket
id|mode
)braket
comma
id|inverse_video
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|add_isr
c_func
(paren
id|IRQ_AMIGA_VERTB
comma
id|mono_amifb_interrupt
comma
l_int|0
comma
l_int|NULL
comma
l_string|&quot;frame buffer&quot;
)paren
)paren
id|panic
c_func
(paren
l_string|&quot;Couldn&squot;t add vblank interrupt&quot;
)paren
suffix:semicolon
id|mono_amiga_fb_get_var
c_func
(paren
op_amp
id|disp
(braket
l_int|0
)braket
dot
id|var
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mono_amifb_inverse
)paren
id|disp
(braket
l_int|0
)braket
dot
id|cmap
op_assign
id|mono_default_cmap_inverse
suffix:semicolon
r_else
id|disp
(braket
l_int|0
)braket
dot
id|cmap
op_assign
id|mono_default_cmap_normal
suffix:semicolon
id|mono_amiga_fb_set_disp
c_func
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|fb_info.modename
comma
l_string|&quot;Amiga Builtin &quot;
)paren
suffix:semicolon
id|fb_info.disp
op_assign
id|disp
suffix:semicolon
id|fb_info.switch_con
op_assign
op_amp
id|mono_amifb_switch
suffix:semicolon
id|fb_info.updatevar
op_assign
op_amp
id|mono_amifb_updatevar
suffix:semicolon
id|fb_info.blank
op_assign
op_amp
id|mono_amifb_blank
suffix:semicolon
id|strcat
c_func
(paren
id|fb_info.modename
comma
id|mono_modes
(braket
id|mode
)braket
dot
id|modename
)paren
suffix:semicolon
r_return
op_amp
id|fb_info
suffix:semicolon
)brace
macro_line|#endif /* USE_MONO_AMIFB_IF_NON_AGA */
multiline_comment|/* -------------------- OCS specific routines ------------------------------- */
macro_line|#ifdef CONFIG_AMIFB_OCS
multiline_comment|/*&n;    *    Initialization&n;    *&n;    *    Allocate the required chip memory.&n;    *    Set the default video mode for this chipset. If a video mode was&n;    *    specified on the command line, it will override the default mode.&n;    */
DECL|function|ocs_init
r_static
r_int
id|ocs_init
c_func
(paren
r_void
)paren
(brace
id|u_long
id|p
suffix:semicolon
multiline_comment|/*&n;    *    Disable Display DMA&n;    */
id|custom.dmacon
op_assign
id|DMAF_ALL
op_or
id|DMAF_MASTER
suffix:semicolon
multiline_comment|/*&n;    *    Set the Default Video Mode&n;    */
r_if
c_cond
(paren
op_logical_neg
id|amifb_mode
)paren
id|amifb_mode
op_assign
id|get_video_mode
c_func
(paren
id|boot_info.bi_un.bi_ami.vblank
op_eq
l_int|50
ques
c_cond
id|DEFMODE_PAL
suffix:colon
id|DEFMODE_NTSC
)paren
suffix:semicolon
multiline_comment|/*&n;    *    Allocate Chip RAM Structures&n;    */
id|videomemorysize
op_assign
id|VIDEOMEMSIZE_OCS
suffix:semicolon
dot
dot
dot
dot
dot
dot
dot
dot
dot
multiline_comment|/*&n;    *    Enable Display DMA&n;    */
id|custom.dmacon
op_assign
id|DMAF_SETCLR
op_or
id|DMAF_MASTER
op_or
id|DMAF_RASTER
op_or
id|DMAF_COPPER
op_or
id|DMAF_SPRITE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_AMIFB_OCS */
multiline_comment|/* -------------------- ECS specific routines ------------------------------- */
macro_line|#ifdef CONFIG_AMIFB_ECS
multiline_comment|/*&n;    *    Initialization&n;    *&n;    *    Allocate the required chip memory.&n;    *    Set the default video mode for this chipset. If a video mode was&n;    *    specified on the command line, it will override the default mode.&n;    */
DECL|function|ecs_init
r_static
r_int
id|ecs_init
c_func
(paren
r_void
)paren
(brace
id|u_long
id|p
suffix:semicolon
multiline_comment|/*&n;    *    Disable Display DMA&n;    */
id|custom.dmacon
op_assign
id|DMAF_ALL
op_or
id|DMAF_MASTER
suffix:semicolon
multiline_comment|/*&n;    *    Set the Default Video Mode&n;    */
r_if
c_cond
(paren
op_logical_neg
id|amifb_mode
)paren
r_if
c_cond
(paren
id|AMIGAHW_PRESENT
c_func
(paren
id|AMBER_FF
)paren
)paren
id|amifb_mode
op_assign
id|get_video_mode
c_func
(paren
id|boot_info.bi_un.bi_ami.vblank
op_eq
l_int|50
ques
c_cond
id|DEFMODE_AMBER_PAL
suffix:colon
id|DEFMODE_AMBER_NTSC
)paren
suffix:semicolon
r_else
id|amifb_mode
op_assign
id|get_video_mode
c_func
(paren
id|boot_info.bi_un.bi_ami.vblank
op_eq
l_int|50
ques
c_cond
id|DEFMODE_PAL
suffix:colon
id|DEFMODE_NTSC
)paren
suffix:semicolon
multiline_comment|/*&n;    *    Allocate Chip RAM Structures&n;    */
r_if
c_cond
(paren
id|boot_info.bi_amiga.chip_size
OG
l_int|1048576
)paren
id|videomemorysize
op_assign
id|VIDEOMEMSIZE_ECS_2M
suffix:semicolon
r_else
id|videomemorysize
op_assign
id|VIDEOMEMSIZE_ECS_1M
suffix:semicolon
dot
dot
dot
dot
dot
dot
dot
dot
dot
multiline_comment|/*&n;    *    Enable Display DMA&n;    */
id|custom.dmacon
op_assign
id|DMAF_SETCLR
op_or
id|DMAF_MASTER
op_or
id|DMAF_RASTER
op_or
id|DMAF_COPPER
op_or
id|DMAF_SPRITE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_AMIFB_ECS */
multiline_comment|/* -------------------- AGA specific routines ------------------------------- */
macro_line|#ifdef CONFIG_AMIFB_AGA
multiline_comment|/*&n;    *    Macros for the conversion from real world values to hardware register&n;    *    values (and vice versa).&n;    *&n;    *    This helps us to keep our attention on the real stuff...&n;    *&n;    *    Hardware limits:&n;    *&n;    *       parameter     min      max     step&n;    *       ---------     ---     ----     ----&n;    *       diwstrt_h       0     2047        1&n;    *       diwstrt_v       0     2047        1&n;    *       diwstop_h       0     2047        1&n;    *       diwstop_v       0     2047        1&n;    *&n;    *       ddfstrt         0     2032       16&n;    *       ddfstop         0     2032       16&n;    *&n;    *       htotal          8     2048        8&n;    *       hsstrt          0     2040        8&n;    *       hsstop          0     2040        8&n;    *       vtotal          1     2048        1&n;    *       vsstrt          0     2047        1&n;    *       vsstop          0     2047        1&n;    *       hcenter         0     2040        8&n;    *&n;    *       hbstrt          0     2047        1&n;    *       hbstop          0     2047        1&n;    *       vbstrt          0     2047        1&n;    *       vbstop          0     2047        1&n;    *&n;    *    Horizontal values are in 35 ns (SHRES) pixels&n;    *    Vertical values are in scanlines&n;    */
multiline_comment|/* bplcon1 (smooth scrolling) */
DECL|macro|hscroll2hw
mdefine_line|#define hscroll2hw(hscroll) &bslash;&n;   (((hscroll)&lt;&lt;12 &amp; 0x3000) | ((hscroll)&lt;&lt;8 &amp; 0xc300) | &bslash;&n;    ((hscroll)&lt;&lt;4 &amp; 0x0c00) | ((hscroll)&lt;&lt;2 &amp; 0x00f0) | ((hscroll)&gt;&gt;2 &amp; 0x000f))
DECL|macro|hw2hscroll
mdefine_line|#define hw2hscroll(hscroll) &bslash;&n;   (((hscroll)&gt;&gt;8 &amp; 0x00c3) | ((hscroll)&lt;&lt;2 &amp; 0x003c))
multiline_comment|/* diwstrt/diwstop/diwhigh (visible display window) */
DECL|macro|diwstrt2hw
mdefine_line|#define diwstrt2hw(diwstrt_h, diwstrt_v) &bslash;&n;   (((diwstrt_v)&lt;&lt;8 &amp; 0xff00) | ((diwstrt_h)&gt;&gt;2 &amp; 0x00ff))
DECL|macro|diwstop2hw
mdefine_line|#define diwstop2hw(distop_h, diwstop_v) &bslash;&n;   (((diwstop_v)&lt;&lt;8 &amp; 0xff00) | ((diwstop_h)&gt;&gt;2 &amp; 0x00ff))
DECL|macro|diw2hw_high
mdefine_line|#define diw2hw_high(diwstrt_h, diwstrt_v, distop_h, diwstop_v) &bslash;&n;   (((diwstop_h)&lt;&lt;3 &amp; 0x2000) | ((diwstop_h)&lt;&lt;11 &amp; 0x1800) | &bslash;&n;    ((diwstop_v) &amp; 0x0700) | ((diwstrt_h)&gt;&gt;5 &amp; 0x0020) | &bslash;&n;    ((diwstrt_h)&lt;&lt;3 &amp; 0x0018) | ((diwstrt_v)&gt;&gt;8 &amp; 0x0007))
DECL|macro|hw2diwstrt_h
mdefine_line|#define hw2diwstrt_h(diwstrt, diwhigh) &bslash;&n;   (((diwhigh)&lt;&lt;5 &amp; 0x0400) | ((diwstrt)&lt;&lt;2 &amp; 0x03fc) | ((diwhigh)&gt;&gt;3 &amp; 0x0003))
DECL|macro|hw2diwstrt_v
mdefine_line|#define hw2diwstrt_v(diwstrt, diwhigh) &bslash;&n;   (((diwhigh)&lt;&lt;8 &amp; 0x0700) | ((diwstrt)&gt;&gt;8 &amp; 0x00ff))
DECL|macro|hw2diwstop_h
mdefine_line|#define hw2diwstop_h(diwstop, diwhigh) &bslash;&n;   (((diwhigh)&gt;&gt;3 &amp; 0x0400) | ((diwstop)&lt;&lt;2 &amp; 0x03fc) | &bslash;&n;    ((diwhigh)&gt;&gt;11 &amp; 0x0003))
DECL|macro|hw2diwstop_v
mdefine_line|#define hw2diwstop_v(diwstop, diwhigh) &bslash;&n;   (((diwhigh) &amp; 0x0700) | ((diwstop)&gt;&gt;8 &amp; 0x00ff))
multiline_comment|/* ddfstrt/ddfstop (display DMA) */
DECL|macro|ddfstrt2hw
mdefine_line|#define ddfstrt2hw(ddfstrt)   (div8(ddfstrt) &amp; 0x00fe)
DECL|macro|ddfstop2hw
mdefine_line|#define ddfstop2hw(ddfstop)   (div8(ddfstop) &amp; 0x00fe)
DECL|macro|hw2ddfstrt
mdefine_line|#define hw2ddfstrt(ddfstrt)   ((ddfstrt)&lt;&lt;3)
DECL|macro|hw2ddfstop
mdefine_line|#define hw2ddfstop(ddfstop)   ((ddfstop)&lt;&lt;3)
multiline_comment|/* hsstrt/hsstop/htotal/vsstrt/vsstop/vtotal (sync timings) */
DECL|macro|hsstrt2hw
mdefine_line|#define hsstrt2hw(hsstrt)     (div8(hsstrt))
DECL|macro|hsstop2hw
mdefine_line|#define hsstop2hw(hsstop)     (div8(hsstop))
DECL|macro|htotal2hw
mdefine_line|#define htotal2hw(htotal)     (div8(htotal)-1)
DECL|macro|vsstrt2hw
mdefine_line|#define vsstrt2hw(vsstrt)     (vsstrt)
DECL|macro|vsstop2hw
mdefine_line|#define vsstop2hw(vsstop)     (vsstop)
DECL|macro|vtotal2hw
mdefine_line|#define vtotal2hw(vtotal)     ((vtotal)-1)
DECL|macro|hw2hsstrt
mdefine_line|#define hw2hsstrt(hsstrt)     ((hsstrt)&lt;&lt;3)
DECL|macro|hw2hsstop
mdefine_line|#define hw2hsstop(hsstop)     ((hsstop)&lt;&lt;3)
DECL|macro|hw2htotal
mdefine_line|#define hw2htotal(htotal)     (((htotal)+1)&lt;&lt;3)
DECL|macro|hw2vsstrt
mdefine_line|#define hw2vsstrt(vsstrt)     (vsstrt)
DECL|macro|hw2vsstop
mdefine_line|#define hw2vsstop(vsstop)     (vsstop)
DECL|macro|hw2vtotal
mdefine_line|#define hw2vtotal(vtotal)     ((vtotal)+1)
multiline_comment|/* hbstrt/hbstop/vbstrt/vbstop (blanking timings) */
DECL|macro|hbstrt2hw
mdefine_line|#define hbstrt2hw(hbstrt)     (((hbstrt)&lt;&lt;8 &amp; 0x0700) | ((hbstrt)&gt;&gt;3 &amp; 0x00ff))
DECL|macro|hbstop2hw
mdefine_line|#define hbstop2hw(hbstop)     (((hbstop)&lt;&lt;8 &amp; 0x0700) | ((hbstop)&gt;&gt;3 &amp; 0x00ff))
DECL|macro|vbstrt2hw
mdefine_line|#define vbstrt2hw(vbstrt)     (vbstrt)
DECL|macro|vbstop2hw
mdefine_line|#define vbstop2hw(vbstop)     (vbstop)
DECL|macro|hw2hbstrt
mdefine_line|#define hw2hbstrt(hbstrt)     (((hbstrt)&lt;&lt;3 &amp; 0x07f8) | ((hbstrt)&gt;&gt;8 &amp; 0x0007))
DECL|macro|hw2hbstop
mdefine_line|#define hw2hbstop(hbstop)     (((hbstop)&lt;&lt;3 &amp; 0x07f8) | ((hbstop)&gt;&gt;8 &amp; 0x0007))
DECL|macro|hw2vbstrt
mdefine_line|#define hw2vbstrt(vbstrt)     (vbstrt)
DECL|macro|hw2vbstop
mdefine_line|#define hw2vbstop(vbstop)     (vbstop)
multiline_comment|/* color */
DECL|macro|rgb2hw_high
mdefine_line|#define rgb2hw_high(red, green, blue) &bslash;&n;   (((red)&lt;&lt;4 &amp; 0xf00) | ((green) &amp; 0x0f0) | ((blue)&gt;&gt;4 &amp; 0x00f))
DECL|macro|rgb2hw_low
mdefine_line|#define rgb2hw_low(red, green, blue) &bslash;&n;   (((red)&lt;&lt;8 &amp; 0xf00) | ((green)&lt;&lt;4 &amp; 0x0f0) | ((blue) &amp; 0x00f))
DECL|macro|hw2red
mdefine_line|#define hw2red(high, low)     (((high)&gt;&gt;4 &amp; 0xf0) | ((low)&gt;&gt;8 &amp; 0x0f))
DECL|macro|hw2green
mdefine_line|#define hw2green(high, low)   (((high) &amp; 0xf0) | ((low)&gt;&gt;4 &amp; 0x0f))
DECL|macro|hw2blue
mdefine_line|#define hw2blue(high, low)    (((high)&lt;&lt;4 &amp; 0xf0) | ((low) &amp; 0x0f))
multiline_comment|/* sprpos/sprctl (sprite positioning) */
DECL|macro|spr2hw_pos
mdefine_line|#define spr2hw_pos(start_v, start_h) &bslash;&n;   (((start_v)&lt;&lt;8&amp;0xff00) | ((start_h)&gt;&gt;3&amp;0x00ff))
DECL|macro|spr2hw_ctl
mdefine_line|#define spr2hw_ctl(start_v, start_h, stop_v) &bslash;&n;   (((stop_v)&lt;&lt;8&amp;0xff00) | ((start_v)&gt;&gt;3&amp;0x0040) | ((stop_v)&gt;&gt;4&amp;0x0020) | &bslash;&n;    ((start_h)&lt;&lt;3&amp;0x0018) | ((start_v)&gt;&gt;6&amp;0x0004) | ((stop_v)&gt;&gt;7&amp;0x0002) | &bslash;&n;    ((start_h)&gt;&gt;2&amp;0x0001))
multiline_comment|/*&n;    *    Hardware Cursor&n;    */
DECL|struct|aga_cursorsprite
r_struct
id|aga_cursorsprite
(brace
DECL|member|sprpos
id|u_short
id|sprpos
suffix:semicolon
DECL|member|pad1
id|u_short
id|pad1
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|sprctl
id|u_short
id|sprctl
suffix:semicolon
DECL|member|pad2
id|u_short
id|pad2
(braket
l_int|3
)braket
suffix:semicolon
r_union
(brace
r_struct
(brace
DECL|member|data
id|u_long
id|data
(braket
l_int|64
op_star
l_int|4
)braket
suffix:semicolon
DECL|member|trailer
id|u_long
id|trailer
(braket
l_int|4
)braket
suffix:semicolon
DECL|member|nonlaced
)brace
id|nonlaced
suffix:semicolon
r_struct
(brace
DECL|member|data
id|u_long
id|data
(braket
l_int|32
op_star
l_int|4
)braket
suffix:semicolon
DECL|member|trailer
id|u_long
id|trailer
(braket
l_int|4
)braket
suffix:semicolon
DECL|member|laced
)brace
id|laced
suffix:semicolon
DECL|member|u
)brace
id|u
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|aga_dummysprite
r_struct
id|aga_dummysprite
(brace
DECL|member|sprpos
id|u_short
id|sprpos
suffix:semicolon
DECL|member|pad1
id|u_short
id|pad1
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|sprctl
id|u_short
id|sprctl
suffix:semicolon
DECL|member|pad2
id|u_short
id|pad2
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|data
id|u_long
id|data
(braket
l_int|4
)braket
suffix:semicolon
DECL|member|trailer
id|u_long
id|trailer
(braket
l_int|4
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n;    *    Pixel modes for Bitplanes and Sprites&n;    */
DECL|variable|bplpixmode
r_static
id|u_short
id|bplpixmode
(braket
l_int|3
)braket
op_assign
(brace
id|BPC0_SHRES
comma
multiline_comment|/*  35 ns / 28 MHz */
id|BPC0_HIRES
comma
multiline_comment|/*  70 ns / 14 MHz */
l_int|0
multiline_comment|/* 140 ns /  7 MHz */
)brace
suffix:semicolon
DECL|variable|sprpixmode
r_static
id|u_short
id|sprpixmode
(braket
l_int|3
)braket
op_assign
(brace
id|BPC3_SPRES1
op_or
id|BPC3_SPRES0
comma
multiline_comment|/*  35 ns / 28 MHz */
id|BPC3_SPRES1
comma
multiline_comment|/*  70 ns / 14 MHz */
id|BPC3_SPRES0
multiline_comment|/* 140 ns /  7 MHz */
)brace
suffix:semicolon
multiline_comment|/*&n;    *    Initialization&n;    *&n;    *    Allocate the required chip memory.&n;    *    Set the default video mode for this chipset. If a video mode was&n;    *    specified on the command line, it will override the default mode.&n;    */
DECL|function|aga_init
r_static
r_int
id|aga_init
c_func
(paren
r_void
)paren
(brace
id|u_long
id|p
suffix:semicolon
multiline_comment|/*&n;    *    Disable Display DMA&n;    */
id|custom.dmacon
op_assign
id|DMAF_ALL
op_or
id|DMAF_MASTER
suffix:semicolon
multiline_comment|/*&n;    *    Set the Default Video Mode&n;    */
r_if
c_cond
(paren
op_logical_neg
id|amifb_mode
)paren
id|amifb_mode
op_assign
id|get_video_mode
c_func
(paren
id|DEFMODE_AGA
)paren
suffix:semicolon
multiline_comment|/*&n;    *    Allocate Chip RAM Structures&n;    */
r_if
c_cond
(paren
id|boot_info.bi_amiga.chip_size
OG
l_int|1048576
)paren
id|videomemorysize
op_assign
id|VIDEOMEMSIZE_AGA_2M
suffix:semicolon
r_else
id|videomemorysize
op_assign
id|VIDEOMEMSIZE_AGA_1M
suffix:semicolon
id|p
op_assign
id|chipalloc
c_func
(paren
id|videomemorysize
op_plus
multiline_comment|/* Bitplanes */
r_sizeof
(paren
r_struct
id|clist_hdr
)paren
op_plus
multiline_comment|/* Copper Lists */
l_int|2
op_star
r_sizeof
(paren
r_struct
id|clist_dyn
)paren
op_plus
l_int|2
op_star
r_sizeof
(paren
r_struct
id|aga_cursorsprite
)paren
op_plus
multiline_comment|/* Sprites */
r_sizeof
(paren
r_struct
id|aga_dummysprite
)paren
)paren
suffix:semicolon
id|assignchunk
c_func
(paren
id|videomemory
comma
id|u_long
comma
id|p
comma
id|videomemorysize
)paren
suffix:semicolon
id|assignchunk
c_func
(paren
id|clist_hdr
comma
r_struct
id|clist_hdr
op_star
comma
id|p
comma
r_sizeof
(paren
r_struct
id|clist_hdr
)paren
)paren
suffix:semicolon
id|assignchunk
c_func
(paren
id|clist_lof
comma
r_struct
id|clist_dyn
op_star
comma
id|p
comma
r_sizeof
(paren
r_struct
id|clist_dyn
)paren
)paren
suffix:semicolon
id|assignchunk
c_func
(paren
id|clist_shf
comma
r_struct
id|clist_dyn
op_star
comma
id|p
comma
r_sizeof
(paren
r_struct
id|clist_dyn
)paren
)paren
suffix:semicolon
id|assignchunk
c_func
(paren
id|lofsprite
comma
id|u_long
op_star
comma
id|p
comma
r_sizeof
(paren
r_struct
id|aga_cursorsprite
)paren
)paren
suffix:semicolon
id|assignchunk
c_func
(paren
id|shfsprite
comma
id|u_long
op_star
comma
id|p
comma
r_sizeof
(paren
r_struct
id|aga_cursorsprite
)paren
)paren
suffix:semicolon
id|assignchunk
c_func
(paren
id|dummysprite
comma
id|u_long
op_star
comma
id|p
comma
r_sizeof
(paren
r_struct
id|aga_dummysprite
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;    *    Make sure the Copper has something to do&n;    */
id|aga_build_clist_hdr
c_func
(paren
id|clist_hdr
)paren
suffix:semicolon
id|custom.cop1lc
op_assign
(paren
id|u_short
op_star
)paren
id|ZTWO_PADDR
c_func
(paren
id|clist_hdr
)paren
suffix:semicolon
id|custom.cop2lc
op_assign
(paren
id|u_short
op_star
)paren
id|ZTWO_PADDR
c_func
(paren
op_amp
id|clist_hdr-&gt;wait_forever
)paren
suffix:semicolon
id|custom.copjmp1
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;    *    Enable Display DMA&n;    */
id|custom.dmacon
op_assign
id|DMAF_SETCLR
op_or
id|DMAF_MASTER
op_or
id|DMAF_RASTER
op_or
id|DMAF_COPPER
op_or
id|DMAF_SPRITE
suffix:semicolon
multiline_comment|/*&n;    *    These hardware register values will never be changed later&n;    */
id|custom.bplcon2
op_assign
id|BPC2_KILLEHB
op_or
id|BPC2_PF2P2
op_or
id|BPC2_PF1P2
suffix:semicolon
id|custom.bplcon4
op_assign
id|BPC4_ESPRM4
op_or
id|BPC4_OSPRM4
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;    *    This function should fill in the `fix&squot; structure based on the&n;    *    values in the `par&squot; structure.&n;    */
DECL|function|aga_encode_fix
r_static
r_int
id|aga_encode_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_struct
id|amiga_fb_par
op_star
id|par
)paren
(brace
r_int
id|i
suffix:semicolon
id|strcpy
c_func
(paren
id|fix-&gt;id
comma
id|amiga_fb_name
)paren
suffix:semicolon
id|fix-&gt;smem_start
op_assign
id|videomemory
suffix:semicolon
id|fix-&gt;smem_len
op_assign
id|videomemorysize
suffix:semicolon
r_if
c_cond
(paren
id|amifb_ilbm
)paren
(brace
id|fix-&gt;type
op_assign
id|FB_TYPE_INTERLEAVED_PLANES
suffix:semicolon
id|fix-&gt;type_aux
op_assign
id|par-&gt;next_line
suffix:semicolon
)brace
r_else
(brace
id|fix-&gt;type
op_assign
id|FB_TYPE_PLANES
suffix:semicolon
id|fix-&gt;type_aux
op_assign
l_int|0
suffix:semicolon
)brace
id|fix-&gt;visual
op_assign
id|FB_VISUAL_PSEUDOCOLOR
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;diwstrt_h
op_ge
l_int|323
)paren
id|fix-&gt;xpanstep
op_assign
l_int|1
suffix:semicolon
r_else
id|fix-&gt;xpanstep
op_assign
l_int|64
suffix:semicolon
id|fix-&gt;ypanstep
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|hw2ddfstrt
c_func
(paren
id|par-&gt;ddfstrt
)paren
op_ge
(paren
id|par-&gt;bpp
op_minus
l_int|1
)paren
op_star
l_int|64
)paren
id|fix-&gt;ywrapstep
op_assign
l_int|1
suffix:semicolon
r_else
id|fix-&gt;ywrapstep
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;line_length
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|arraysize
c_func
(paren
id|fix-&gt;reserved
)paren
suffix:semicolon
id|i
op_increment
)paren
id|fix-&gt;reserved
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;    *    Get the video params out of `var&squot;. If a value doesn&squot;t fit, round&n;    *    it up, if it&squot;s too big, return -EINVAL.&n;    */
DECL|function|aga_decode_var
r_static
r_int
id|aga_decode_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|amiga_fb_par
op_star
id|par
)paren
(brace
id|u_short
id|clk_shift
comma
id|line_shift_incd
suffix:semicolon
id|u_long
id|upper
comma
id|lower
comma
id|hslen
comma
id|vslen
suffix:semicolon
r_int
id|xres_n
comma
id|yres_n
comma
id|xoffset_n
suffix:semicolon
multiline_comment|/* normalized */
id|u_long
id|left_n
comma
id|right_n
comma
id|upper_n
comma
id|lower_n
comma
id|hslen_n
comma
id|vslen_n
suffix:semicolon
multiline_comment|/* normalized */
id|u_long
id|diwstrt_h
comma
id|diwstrt_v
comma
id|diwstop_h
comma
id|diwstop_v
suffix:semicolon
id|u_long
id|hsstrt
comma
id|vsstrt
comma
id|hsstop
comma
id|vsstop
comma
id|htotal
comma
id|vtotal
suffix:semicolon
id|u_long
id|ddfmin
comma
id|ddfmax
comma
id|ddfstrt
comma
id|ddfstop
comma
id|hscroll
suffix:semicolon
r_float
id|hrate
comma
id|vrate
suffix:semicolon
id|u_short
id|loopcnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;    *    Find a matching Pixel Clock&n;    */
r_for
c_loop
(paren
id|clk_shift
op_assign
l_int|0
suffix:semicolon
id|clk_shift
OL
l_int|3
suffix:semicolon
id|clk_shift
op_increment
)paren
r_if
c_cond
(paren
id|var-&gt;pixclock
op_le
id|pixclock
(braket
id|clk_shift
)braket
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|clk_shift
op_ge
l_int|3
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|par-&gt;clk_shift
op_assign
id|clk_shift
suffix:semicolon
multiline_comment|/*&n;    *    Round up the Geometry Values (if necessary)&n;    */
id|par-&gt;xres
op_assign
id|max
c_func
(paren
id|var-&gt;xres
comma
l_int|64
)paren
suffix:semicolon
id|par-&gt;yres
op_assign
id|max
c_func
(paren
id|var-&gt;yres
comma
l_int|64
)paren
suffix:semicolon
id|par-&gt;vxres
op_assign
id|up64
c_func
(paren
id|max
c_func
(paren
id|var-&gt;xres_virtual
comma
id|par-&gt;xres
)paren
)paren
suffix:semicolon
id|par-&gt;vyres
op_assign
id|max
c_func
(paren
id|var-&gt;yres_virtual
comma
id|par-&gt;yres
)paren
suffix:semicolon
id|par-&gt;bpp
op_assign
id|var-&gt;bits_per_pixel
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;bpp
OG
l_int|8
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|var-&gt;nonstd
)paren
(brace
r_if
c_cond
(paren
id|par-&gt;bpp
OL
l_int|1
)paren
id|par-&gt;bpp
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|var-&gt;nonstd
op_eq
id|FB_NONSTD_HAM
)paren
id|par-&gt;bpp
op_assign
id|par-&gt;bpp
op_le
l_int|6
ques
c_cond
l_int|6
suffix:colon
l_int|8
suffix:semicolon
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
id|upper
op_assign
id|var-&gt;upper_margin
suffix:semicolon
id|lower
op_assign
id|var-&gt;lower_margin
suffix:semicolon
id|hslen
op_assign
id|var-&gt;hsync_len
suffix:semicolon
id|vslen
op_assign
id|var-&gt;vsync_len
suffix:semicolon
id|par-&gt;vmode
op_assign
id|var-&gt;vmode
suffix:semicolon
r_switch
c_cond
(paren
id|par-&gt;vmode
op_amp
id|FB_VMODE_MASK
)paren
(brace
r_case
id|FB_VMODE_NONINTERLACED
suffix:colon
id|line_shift_incd
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_VMODE_INTERLACED
suffix:colon
id|line_shift_incd
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;yres
op_amp
l_int|1
)paren
id|par-&gt;yres
op_increment
suffix:semicolon
multiline_comment|/* even */
r_if
c_cond
(paren
id|upper
op_amp
l_int|1
)paren
id|upper
op_increment
suffix:semicolon
multiline_comment|/* even */
r_if
c_cond
(paren
op_logical_neg
(paren
id|lower
op_amp
l_int|1
)paren
)paren
id|lower
op_increment
suffix:semicolon
multiline_comment|/* odd */
r_if
c_cond
(paren
id|vslen
op_amp
l_int|1
)paren
id|vslen
op_increment
suffix:semicolon
multiline_comment|/* even */
r_break
suffix:semicolon
r_case
id|FB_VMODE_DOUBLE
suffix:colon
id|line_shift_incd
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|par-&gt;xoffset
op_assign
id|var-&gt;xoffset
suffix:semicolon
id|par-&gt;yoffset
op_assign
id|var-&gt;yoffset
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;vmode
op_amp
id|FB_VMODE_YWRAP
)paren
(brace
r_if
c_cond
(paren
id|par-&gt;xoffset
op_logical_or
id|par-&gt;yoffset
OL
l_int|0
op_logical_or
id|par-&gt;yoffset
op_ge
id|par-&gt;yres
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|par-&gt;xoffset
template_param
id|par-&gt;vxres
op_logical_or
id|par-&gt;yoffset
template_param
id|par-&gt;vyres
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|var-&gt;sync
op_amp
id|FB_SYNC_BROADCAST
)paren
(brace
r_if
c_cond
(paren
id|hslen
op_logical_or
id|vslen
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
id|hslen
op_assign
id|hslen
OL
l_int|1
ques
c_cond
l_int|1
suffix:colon
id|hslen
suffix:semicolon
id|vslen
op_assign
id|vslen
OL
l_int|1
ques
c_cond
l_int|1
suffix:colon
id|vslen
suffix:semicolon
)brace
multiline_comment|/*&n;    *    Check the Memory Requirements&n;    */
r_if
c_cond
(paren
id|par-&gt;vxres
op_star
id|par-&gt;vyres
op_star
id|par-&gt;bpp
OG
id|videomemorysize
op_lshift
l_int|3
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/*&n;    *    Normalize all values:&n;    *&n;    *      - horizontal: in 35 ns (SHRES) pixels&n;    *      - vertical: in non-interlaced scanlines&n;    */
id|xres_n
op_assign
id|par-&gt;xres
op_lshift
id|clk_shift
suffix:semicolon
id|xoffset_n
op_assign
id|par-&gt;xoffset
op_lshift
id|clk_shift
suffix:semicolon
id|yres_n
op_assign
id|par-&gt;yres
op_lshift
id|line_shift_incd
op_rshift
l_int|1
suffix:semicolon
id|left_n
op_assign
id|var-&gt;left_margin
op_lshift
id|clk_shift
suffix:semicolon
id|right_n
op_assign
id|var-&gt;right_margin
op_lshift
id|clk_shift
suffix:semicolon
id|hslen_n
op_assign
id|hslen
op_lshift
id|clk_shift
suffix:semicolon
id|upper_n
op_assign
id|upper
op_lshift
id|line_shift_incd
op_rshift
l_int|1
suffix:semicolon
id|lower_n
op_assign
id|lower
op_lshift
id|line_shift_incd
op_rshift
l_int|1
suffix:semicolon
id|vslen_n
op_assign
id|vslen
op_lshift
id|line_shift_incd
op_rshift
l_int|1
suffix:semicolon
multiline_comment|/*&n;    *    Vertical and Horizontal Timings&n;    */
id|par-&gt;bplcon3
op_assign
id|sprpixmode
(braket
id|clk_shift
)braket
suffix:semicolon
id|aga_calculate_timings
suffix:colon
r_if
c_cond
(paren
id|var-&gt;sync
op_amp
id|FB_SYNC_BROADCAST
)paren
(brace
r_if
c_cond
(paren
id|upper_n
op_plus
id|yres_n
op_plus
id|lower_n
op_eq
id|PAL_WINDOW_V
)paren
(brace
multiline_comment|/* PAL video mode */
id|diwstrt_v
op_assign
id|PAL_DIWSTRT_V
op_plus
id|upper_n
suffix:semicolon
id|diwstop_v
op_assign
id|diwstrt_v
op_plus
id|yres_n
suffix:semicolon
id|diwstrt_h
op_assign
id|PAL_DIWSTRT_H
op_plus
id|left_n
suffix:semicolon
id|diwstop_h
op_assign
id|diwstrt_h
op_plus
id|xres_n
op_plus
l_int|1
suffix:semicolon
id|par-&gt;htotal
op_assign
id|htotal2hw
c_func
(paren
id|PAL_HTOTAL
)paren
suffix:semicolon
id|hrate
op_assign
l_int|15625
suffix:semicolon
id|vrate
op_assign
l_int|50
suffix:semicolon
id|par-&gt;beamcon0
op_assign
id|BMC0_PAL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|upper_n
op_plus
id|yres_n
op_plus
id|lower_n
op_eq
id|NTSC_WINDOW_V
)paren
(brace
multiline_comment|/* NTSC video mode */
id|diwstrt_v
op_assign
id|NTSC_DIWSTRT_V
op_plus
id|upper_n
suffix:semicolon
id|diwstop_v
op_assign
id|diwstrt_v
op_plus
id|yres_n
suffix:semicolon
id|diwstrt_h
op_assign
id|NTSC_DIWSTRT_H
op_plus
id|left_n
suffix:semicolon
id|diwstop_h
op_assign
id|diwstrt_h
op_plus
id|xres_n
op_plus
l_int|1
suffix:semicolon
id|par-&gt;htotal
op_assign
id|htotal2hw
c_func
(paren
id|NTSC_HTOTAL
)paren
suffix:semicolon
id|hrate
op_assign
l_int|15750
suffix:semicolon
id|vrate
op_assign
l_int|60
suffix:semicolon
id|par-&gt;beamcon0
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Programmable video mode */
id|vsstrt
op_assign
id|lower_n
suffix:semicolon
id|vsstop
op_assign
id|vsstrt
op_plus
id|vslen_n
suffix:semicolon
id|diwstrt_v
op_assign
id|vsstop
op_plus
id|upper_n
suffix:semicolon
id|diwstop_v
op_assign
id|diwstrt_v
op_plus
id|yres_n
suffix:semicolon
id|vtotal
op_assign
id|diwstop_v
suffix:semicolon
id|hslen_n
op_assign
id|up8
c_func
(paren
id|hslen_n
)paren
suffix:semicolon
id|htotal
op_assign
id|up8
c_func
(paren
id|left_n
op_plus
id|xres_n
op_plus
id|right_n
op_plus
id|hslen_n
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vtotal
OG
l_int|2048
op_logical_or
id|htotal
OG
l_int|2048
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|right_n
op_assign
id|htotal
op_minus
id|left_n
op_minus
id|xres_n
op_minus
id|hslen_n
suffix:semicolon
id|hsstrt
op_assign
id|down8
c_func
(paren
id|right_n
op_plus
l_int|4
)paren
suffix:semicolon
id|hsstop
op_assign
id|hsstrt
op_plus
id|hslen_n
suffix:semicolon
id|diwstop_h
op_assign
id|htotal
op_plus
id|hsstrt
op_minus
id|right_n
op_plus
l_int|1
suffix:semicolon
id|diwstrt_h
op_assign
id|diwstop_h
op_minus
id|xres_n
op_minus
l_int|1
suffix:semicolon
id|hrate
op_assign
(paren
r_float
)paren
id|amiga_masterclock
op_div
id|htotal
suffix:semicolon
id|vrate
op_assign
id|hrate
op_div
id|vtotal
suffix:semicolon
id|par-&gt;bplcon3
op_or_assign
id|BPC3_BRDRBLNK
op_or
id|BPC3_EXTBLKEN
suffix:semicolon
id|par-&gt;beamcon0
op_assign
id|BMC0_HARDDIS
op_or
id|BMC0_VARVBEN
op_or
id|BMC0_LOLDIS
op_or
id|BMC0_VARVSYEN
op_or
id|BMC0_VARHSYEN
op_or
id|BMC0_VARBEAMEN
op_or
id|BMC0_PAL
op_or
id|BMC0_VARCSYEN
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;sync
op_amp
id|FB_SYNC_HOR_HIGH_ACT
)paren
id|par-&gt;beamcon0
op_or_assign
id|BMC0_HSYTRUE
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;sync
op_amp
id|FB_SYNC_VERT_HIGH_ACT
)paren
id|par-&gt;beamcon0
op_or_assign
id|BMC0_VSYTRUE
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;sync
op_amp
id|FB_SYNC_COMP_HIGH_ACT
)paren
id|par-&gt;beamcon0
op_or_assign
id|BMC0_CSYTRUE
suffix:semicolon
id|par-&gt;htotal
op_assign
id|htotal2hw
c_func
(paren
id|htotal
)paren
suffix:semicolon
id|par-&gt;hsstrt
op_assign
id|hsstrt2hw
c_func
(paren
id|hsstrt
)paren
suffix:semicolon
id|par-&gt;hsstop
op_assign
id|hsstop2hw
c_func
(paren
id|hsstop
)paren
suffix:semicolon
id|par-&gt;vtotal
op_assign
id|vtotal2hw
c_func
(paren
id|vtotal
)paren
suffix:semicolon
id|par-&gt;vsstrt
op_assign
id|vsstrt2hw
c_func
(paren
id|vsstrt
)paren
suffix:semicolon
id|par-&gt;vsstop
op_assign
id|vsstop2hw
c_func
(paren
id|vsstop
)paren
suffix:semicolon
id|par-&gt;hcenter
op_assign
id|par-&gt;hsstrt
op_plus
(paren
id|par-&gt;htotal
op_rshift
l_int|1
)paren
suffix:semicolon
)brace
id|par-&gt;diwstrt_v
op_assign
id|diwstrt_v
suffix:semicolon
id|par-&gt;diwstrt_h
op_assign
id|diwstrt_h
suffix:semicolon
id|par-&gt;crsr_x
op_assign
l_int|0
suffix:semicolon
id|par-&gt;crsr_y
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;    *    DMA Timings&n;    */
id|ddfmin
op_assign
id|down64
c_func
(paren
id|xoffset_n
)paren
suffix:semicolon
id|ddfmax
op_assign
id|up64
c_func
(paren
id|xoffset_n
op_plus
id|xres_n
)paren
suffix:semicolon
id|hscroll
op_assign
id|diwstrt_h
op_minus
l_int|68
op_minus
id|mod64
c_func
(paren
id|xoffset_n
)paren
suffix:semicolon
id|ddfstrt
op_assign
id|down64
c_func
(paren
id|hscroll
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ddfstrt
OL
l_int|128
)paren
(brace
id|right_n
op_add_assign
(paren
l_int|128
op_minus
id|hscroll
)paren
suffix:semicolon
multiline_comment|/* Prevent an infinite loop */
r_if
c_cond
(paren
id|loopcnt
op_increment
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|aga_calculate_timings
suffix:semicolon
)brace
id|hscroll
op_sub_assign
id|ddfstrt
suffix:semicolon
id|ddfstop
op_assign
id|ddfstrt
op_plus
id|ddfmax
op_minus
id|ddfmin
op_minus
(paren
l_int|64
op_lshift
id|clk_shift
)paren
suffix:semicolon
multiline_comment|/*&n;    *    Bitplane calculations&n;    */
r_if
c_cond
(paren
id|amifb_ilbm
)paren
(brace
id|par-&gt;next_plane
op_assign
id|div8
c_func
(paren
id|par-&gt;vxres
)paren
suffix:semicolon
id|par-&gt;next_line
op_assign
id|par-&gt;bpp
op_star
id|par-&gt;next_plane
suffix:semicolon
)brace
r_else
(brace
id|par-&gt;next_line
op_assign
id|div8
c_func
(paren
id|par-&gt;vxres
)paren
suffix:semicolon
id|par-&gt;next_plane
op_assign
id|par-&gt;vyres
op_star
id|par-&gt;next_line
suffix:semicolon
)brace
id|par-&gt;bplpt0
op_assign
id|ZTWO_PADDR
c_func
(paren
(paren
id|u_long
)paren
id|videomemory
op_plus
id|div8
c_func
(paren
id|ddfmin
op_rshift
id|clk_shift
)paren
op_plus
id|par-&gt;yoffset
op_star
id|par-&gt;next_line
)paren
suffix:semicolon
id|par-&gt;bpl1mod
op_assign
id|par-&gt;next_line
op_minus
id|div8
c_func
(paren
(paren
id|ddfmax
op_minus
id|ddfmin
)paren
op_rshift
id|clk_shift
)paren
suffix:semicolon
id|par-&gt;bpl2mod
op_assign
id|par-&gt;bpl1mod
suffix:semicolon
multiline_comment|/*&n;    *    Hardware Register Values&n;    */
id|par-&gt;bplcon0
op_assign
id|BPC0_COLOR
op_or
id|BPC0_ECSENA
op_or
id|bplpixmode
(braket
id|clk_shift
)braket
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;bpp
op_eq
l_int|8
)paren
id|par-&gt;bplcon0
op_or_assign
id|BPC0_BPU3
suffix:semicolon
r_else
id|par-&gt;bplcon0
op_or_assign
id|par-&gt;bpp
op_lshift
l_int|12
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;nonstd
op_eq
id|FB_NONSTD_HAM
)paren
id|par-&gt;bplcon0
op_or_assign
id|BPC0_HAM
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;sync
op_amp
id|FB_SYNC_EXT
)paren
id|par-&gt;bplcon0
op_or_assign
id|BPC0_ERSY
suffix:semicolon
id|par-&gt;bplcon1
op_assign
id|hscroll2hw
c_func
(paren
id|hscroll
)paren
suffix:semicolon
id|par-&gt;diwstrt
op_assign
id|diwstrt2hw
c_func
(paren
id|diwstrt_h
comma
id|diwstrt_v
)paren
suffix:semicolon
id|par-&gt;diwstop
op_assign
id|diwstop2hw
c_func
(paren
id|diwstop_h
comma
id|diwstop_v
)paren
suffix:semicolon
id|par-&gt;diwhigh
op_assign
id|diw2hw_high
c_func
(paren
id|diwstrt_h
comma
id|diwstrt_v
comma
id|distop_h
comma
id|diwstop_v
)paren
suffix:semicolon
id|par-&gt;ddfstrt
op_assign
id|ddfstrt2hw
c_func
(paren
id|ddfstrt
)paren
suffix:semicolon
id|par-&gt;ddfstop
op_assign
id|ddfstop2hw
c_func
(paren
id|ddfstop
)paren
suffix:semicolon
id|par-&gt;fmode
op_assign
id|FMODE_SPAGEM
op_or
id|FMODE_SPR32
op_or
id|FMODE_BPAGEM
op_or
id|FMODE_BPL32
suffix:semicolon
r_switch
c_cond
(paren
id|par-&gt;vmode
op_amp
id|FB_VMODE_MASK
)paren
(brace
r_case
id|FB_VMODE_INTERLACED
suffix:colon
id|par-&gt;bpl1mod
op_add_assign
id|par-&gt;next_line
suffix:semicolon
id|par-&gt;bpl2mod
op_add_assign
id|par-&gt;next_line
suffix:semicolon
id|par-&gt;bplcon0
op_or_assign
id|BPC0_LACE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_VMODE_DOUBLE
suffix:colon
id|par-&gt;bpl1mod
op_sub_assign
id|par-&gt;next_line
suffix:semicolon
id|par-&gt;fmode
op_or_assign
id|FMODE_SSCAN2
op_or
id|FMODE_BSCAN2
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hrate
template_param
id|hfmax
op_logical_or
id|vrate
template_param
id|vfmax
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;    *    Fill the `var&squot; structure based on the values in `par&squot; and maybe&n;    *    other values read out of the hardware.&n;    */
DECL|function|aga_encode_var
r_static
r_int
id|aga_encode_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|amiga_fb_par
op_star
id|par
)paren
(brace
id|u_short
id|clk_shift
comma
id|line_shift_incd
suffix:semicolon
id|u_long
id|left
comma
id|right
comma
id|upper
comma
id|lower
comma
id|hslen
comma
id|vslen
suffix:semicolon
id|u_short
id|diwstop_h
comma
id|diwstop_v
suffix:semicolon
id|u_short
id|hsstrt
comma
id|vsstrt
comma
id|hsstop
comma
id|vsstop
comma
id|htotal
suffix:semicolon
r_int
id|i
suffix:semicolon
id|var-&gt;xres
op_assign
id|par-&gt;xres
suffix:semicolon
id|var-&gt;yres
op_assign
id|par-&gt;yres
suffix:semicolon
id|var-&gt;xres_virtual
op_assign
id|par-&gt;vxres
suffix:semicolon
id|var-&gt;yres_virtual
op_assign
id|par-&gt;vyres
suffix:semicolon
id|var-&gt;xoffset
op_assign
id|par-&gt;xoffset
suffix:semicolon
id|var-&gt;yoffset
op_assign
id|par-&gt;yoffset
suffix:semicolon
id|var-&gt;bits_per_pixel
op_assign
id|par-&gt;bpp
suffix:semicolon
id|var-&gt;grayscale
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;red.msb_right
op_assign
l_int|0
suffix:semicolon
id|var-&gt;blue
op_assign
id|var-&gt;green
op_assign
id|var-&gt;red
suffix:semicolon
id|var-&gt;transp.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.msb_right
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;bplcon0
op_amp
id|BPC0_HAM
)paren
id|var-&gt;nonstd
op_assign
id|FB_NONSTD_HAM
suffix:semicolon
r_else
id|var-&gt;nonstd
op_assign
l_int|0
suffix:semicolon
id|var-&gt;activate
op_assign
l_int|0
suffix:semicolon
id|var-&gt;height
op_assign
op_minus
l_int|1
suffix:semicolon
id|var-&gt;width
op_assign
op_minus
l_int|1
suffix:semicolon
id|var-&gt;accel
op_assign
id|FB_ACCEL_NONE
suffix:semicolon
id|clk_shift
op_assign
id|par-&gt;clk_shift
suffix:semicolon
id|var-&gt;pixclock
op_assign
id|pixclock
(braket
id|clk_shift
)braket
suffix:semicolon
id|diwstop_h
op_assign
id|hw2diwstop_h
c_func
(paren
id|par-&gt;diwstop
comma
id|par-&gt;diwhigh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;beamcon0
op_amp
id|BMC0_VARBEAMEN
)paren
(brace
id|hsstrt
op_assign
id|hw2hsstrt
c_func
(paren
id|par-&gt;hsstrt
)paren
suffix:semicolon
id|vsstrt
op_assign
id|hw2vsstrt
c_func
(paren
id|par-&gt;vsstrt
)paren
suffix:semicolon
id|hsstop
op_assign
id|hw2hsstop
c_func
(paren
id|par-&gt;hsstop
)paren
suffix:semicolon
id|vsstop
op_assign
id|hw2vsstop
c_func
(paren
id|par-&gt;vsstop
)paren
suffix:semicolon
id|htotal
op_assign
id|hw2htotal
c_func
(paren
id|par-&gt;htotal
)paren
suffix:semicolon
id|left
op_assign
id|par-&gt;diwstrt_h
op_minus
id|hsstop
suffix:semicolon
id|right
op_assign
id|htotal
op_plus
id|hsstrt
op_minus
id|diwstop_h
op_plus
l_int|1
suffix:semicolon
id|hslen
op_assign
id|hsstop
op_minus
id|hsstrt
suffix:semicolon
id|upper
op_assign
id|par-&gt;diwstrt_v
op_minus
id|vsstop
suffix:semicolon
id|lower
op_assign
id|vsstrt
suffix:semicolon
id|vslen
op_assign
id|vsstop
op_minus
id|vsstrt
suffix:semicolon
id|var-&gt;sync
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|diwstop_v
op_assign
id|hw2diwstop_v
c_func
(paren
id|par-&gt;diwstop
comma
id|par-&gt;diwhigh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;beamcon0
op_amp
id|BMC0_PAL
)paren
(brace
id|left
op_assign
id|par-&gt;diwstrt_h
op_minus
id|PAL_DIWSTRT_H
suffix:semicolon
id|right
op_assign
id|PAL_DIWSTRT_H
op_plus
id|PAL_WINDOW_H
op_minus
id|diwstop_h
op_plus
l_int|1
suffix:semicolon
id|upper
op_assign
id|par-&gt;diwstrt_v
op_minus
id|PAL_DIWSTRT_V
suffix:semicolon
id|lower
op_assign
id|PAL_DIWSTRT_V
op_plus
id|PAL_WINDOW_V
op_minus
id|diwstop_v
suffix:semicolon
)brace
r_else
(brace
id|left
op_assign
id|par-&gt;diwstrt_h
op_minus
id|NTSC_DIWSTRT_H
suffix:semicolon
id|right
op_assign
id|NTSC_DIWSTRT_H
op_plus
id|NTSC_WINDOW_H
op_minus
id|diwstop_h
suffix:semicolon
id|upper
op_assign
id|par-&gt;diwstrt_v
op_minus
id|NTSC_DIWSTRT_V
suffix:semicolon
id|lower
op_assign
id|NTSC_DIWSTRT_V
op_plus
id|NTSC_WINDOW_V
op_minus
id|diwstop_v
suffix:semicolon
)brace
id|hslen
op_assign
l_int|0
suffix:semicolon
id|vslen
op_assign
l_int|0
suffix:semicolon
id|var-&gt;sync
op_assign
id|FB_SYNC_BROADCAST
suffix:semicolon
)brace
r_if
c_cond
(paren
id|par-&gt;bplcon0
op_amp
id|BPC0_ERSY
)paren
id|var-&gt;sync
op_or_assign
id|FB_SYNC_EXT
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;beamcon0
op_amp
id|BMC0_HSYTRUE
)paren
id|var-&gt;sync
op_or_assign
id|FB_SYNC_HOR_HIGH_ACT
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;beamcon0
op_amp
id|BMC0_VSYTRUE
)paren
id|var-&gt;sync
op_or_assign
id|FB_SYNC_VERT_HIGH_ACT
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;beamcon0
op_amp
id|BMC0_CSYTRUE
)paren
id|var-&gt;sync
op_or_assign
id|FB_SYNC_COMP_HIGH_ACT
suffix:semicolon
r_switch
c_cond
(paren
id|par-&gt;vmode
op_amp
id|FB_VMODE_MASK
)paren
(brace
r_case
id|FB_VMODE_NONINTERLACED
suffix:colon
id|line_shift_incd
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_VMODE_INTERLACED
suffix:colon
id|line_shift_incd
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_VMODE_DOUBLE
suffix:colon
id|line_shift_incd
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
)brace
id|var-&gt;left_margin
op_assign
id|left
op_rshift
id|clk_shift
suffix:semicolon
id|var-&gt;right_margin
op_assign
id|right
op_rshift
id|clk_shift
suffix:semicolon
id|var-&gt;upper_margin
op_assign
id|upper
op_lshift
l_int|1
op_rshift
id|line_shift_incd
suffix:semicolon
id|var-&gt;lower_margin
op_assign
id|lower
op_lshift
l_int|1
op_rshift
id|line_shift_incd
suffix:semicolon
id|var-&gt;hsync_len
op_assign
id|hslen
op_rshift
id|clk_shift
suffix:semicolon
id|var-&gt;vsync_len
op_assign
id|vslen
op_lshift
l_int|1
op_rshift
id|line_shift_incd
suffix:semicolon
id|var-&gt;vmode
op_assign
id|par-&gt;vmode
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|arraysize
c_func
(paren
id|var-&gt;reserved
)paren
suffix:semicolon
id|i
op_increment
)paren
id|var-&gt;reserved
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;    *    Read a single color register and split it into&n;    *    colors/transparent. Return != 0 for invalid regno.&n;    */
DECL|function|aga_getcolreg
r_static
r_int
id|aga_getcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
op_star
id|red
comma
id|u_int
op_star
id|green
comma
id|u_int
op_star
id|blue
comma
id|u_int
op_star
id|transp
)paren
(brace
r_if
c_cond
(paren
id|regno
OG
l_int|255
)paren
r_return
l_int|1
suffix:semicolon
op_star
id|red
op_assign
id|palette
(braket
id|regno
)braket
dot
id|red
suffix:semicolon
op_star
id|green
op_assign
id|palette
(braket
id|regno
)braket
dot
id|green
suffix:semicolon
op_star
id|blue
op_assign
id|palette
(braket
id|regno
)braket
dot
id|blue
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;    *    Set a single color register. The values supplied are already&n;    *    rounded down to the hardware&squot;s capabilities (according to the&n;    *    entries in the var structure). Return != 0 for invalid regno.&n;    */
DECL|function|aga_setcolreg
r_static
r_int
id|aga_setcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
id|red
comma
id|u_int
id|green
comma
id|u_int
id|blue
comma
id|u_int
id|transp
)paren
(brace
id|u_short
id|bplcon3
op_assign
id|current_par.bplcon3
suffix:semicolon
r_if
c_cond
(paren
id|regno
OG
l_int|255
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/*&n;    *    Update the corresponding Hardware Color Register, unless it&squot;s Color&n;    *    Register 0 and the screen is blanked.&n;    *&n;    *    The cli()/sti() pair is here to protect bplcon3 from being changed by&n;    *    the VBlank interrupt routine.&n;    */
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|regno
op_logical_or
op_logical_neg
id|is_blanked
)paren
(brace
id|custom.bplcon3
op_assign
id|bplcon3
op_or
(paren
id|regno
op_lshift
l_int|8
op_amp
l_int|0xe000
)paren
suffix:semicolon
id|custom.color
(braket
id|regno
op_amp
l_int|31
)braket
op_assign
id|rgb2hw_high
c_func
(paren
id|red
comma
id|green
comma
id|blue
)paren
suffix:semicolon
id|custom.bplcon3
op_assign
id|bplcon3
op_or
(paren
id|regno
op_lshift
l_int|8
op_amp
l_int|0xe000
)paren
op_or
id|BPC3_LOCT
suffix:semicolon
id|custom.color
(braket
id|regno
op_amp
l_int|31
)braket
op_assign
id|rgb2hw_low
c_func
(paren
id|red
comma
id|green
comma
id|blue
)paren
suffix:semicolon
id|custom.bplcon3
op_assign
id|bplcon3
suffix:semicolon
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
id|palette
(braket
id|regno
)braket
dot
id|red
op_assign
id|red
suffix:semicolon
id|palette
(braket
id|regno
)braket
dot
id|green
op_assign
id|green
suffix:semicolon
id|palette
(braket
id|regno
)braket
dot
id|blue
op_assign
id|blue
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;    *    Pan or Wrap the Display&n;    *&n;    *    This call looks only at xoffset, yoffset and the FB_VMODE_YWRAP flag&n;    *    in `var&squot;.&n;    */
DECL|function|aga_pan_display
r_static
r_int
id|aga_pan_display
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|amiga_fb_par
op_star
id|par
)paren
(brace
r_int
id|xoffset
comma
id|yoffset
comma
id|vmode
comma
id|xres_n
comma
id|xoffset_n
suffix:semicolon
id|u_short
id|clk_shift
comma
id|line_shift_incd
suffix:semicolon
id|u_long
id|ddfmin
comma
id|ddfmax
comma
id|ddfstrt
comma
id|ddfstop
comma
id|hscroll
suffix:semicolon
id|xoffset
op_assign
id|var-&gt;xoffset
suffix:semicolon
id|yoffset
op_assign
id|var-&gt;yoffset
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_YWRAP
)paren
(brace
r_if
c_cond
(paren
id|hw2ddfstrt
c_func
(paren
id|par-&gt;ddfstrt
)paren
OL
(paren
id|par-&gt;bpp
op_minus
l_int|1
)paren
op_star
l_int|64
op_logical_or
id|xoffset
op_logical_or
id|yoffset
OL
l_int|0
op_logical_or
id|yoffset
op_ge
id|par-&gt;yres
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|vmode
op_assign
id|par-&gt;vmode
op_or
id|FB_VMODE_YWRAP
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|par-&gt;diwstrt_h
OL
l_int|323
)paren
id|xoffset
op_assign
id|up64
c_func
(paren
id|xoffset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xoffset
template_param
id|par-&gt;vxres
op_logical_or
id|yoffset
template_param
id|par-&gt;vyres
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|vmode
op_assign
id|par-&gt;vmode
op_amp
op_complement
id|FB_VMODE_YWRAP
suffix:semicolon
)brace
id|clk_shift
op_assign
id|par-&gt;clk_shift
suffix:semicolon
r_switch
c_cond
(paren
id|vmode
op_amp
id|FB_VMODE_MASK
)paren
(brace
r_case
id|FB_VMODE_NONINTERLACED
suffix:colon
id|line_shift_incd
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_VMODE_INTERLACED
suffix:colon
id|line_shift_incd
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_VMODE_DOUBLE
suffix:colon
id|line_shift_incd
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
)brace
id|xres_n
op_assign
id|par-&gt;xres
op_lshift
id|clk_shift
suffix:semicolon
id|xoffset_n
op_assign
id|xoffset
op_lshift
id|clk_shift
suffix:semicolon
multiline_comment|/*&n;    *    DMA timings&n;    */
id|ddfmin
op_assign
id|down64
c_func
(paren
id|xoffset_n
)paren
suffix:semicolon
id|ddfmax
op_assign
id|up64
c_func
(paren
id|xoffset_n
op_plus
id|xres_n
)paren
suffix:semicolon
id|hscroll
op_assign
id|par-&gt;diwstrt_h
op_minus
l_int|68
op_minus
id|mod64
c_func
(paren
id|xoffset_n
)paren
suffix:semicolon
id|ddfstrt
op_assign
id|down64
c_func
(paren
id|hscroll
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ddfstrt
OL
l_int|128
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|hscroll
op_sub_assign
id|ddfstrt
suffix:semicolon
id|ddfstop
op_assign
id|ddfstrt
op_plus
id|ddfmax
op_minus
id|ddfmin
op_minus
(paren
l_int|64
op_lshift
id|clk_shift
)paren
suffix:semicolon
id|par-&gt;bplcon1
op_assign
id|hscroll2hw
c_func
(paren
id|hscroll
)paren
suffix:semicolon
id|par-&gt;ddfstrt
op_assign
id|ddfstrt2hw
c_func
(paren
id|ddfstrt
)paren
suffix:semicolon
id|par-&gt;ddfstop
op_assign
id|ddfstop2hw
c_func
(paren
id|ddfstop
)paren
suffix:semicolon
multiline_comment|/*&n;    *    Bitplane calculations&n;    */
id|par-&gt;bplpt0
op_assign
id|ZTWO_PADDR
c_func
(paren
(paren
id|u_long
)paren
id|videomemory
op_plus
id|div8
c_func
(paren
id|ddfmin
op_rshift
id|clk_shift
)paren
op_plus
id|yoffset
op_star
id|par-&gt;next_line
)paren
suffix:semicolon
id|par-&gt;bpl1mod
op_assign
id|par-&gt;next_line
op_minus
id|div8
c_func
(paren
(paren
id|ddfmax
op_minus
id|ddfmin
)paren
op_rshift
id|clk_shift
)paren
suffix:semicolon
id|par-&gt;bpl2mod
op_assign
id|par-&gt;bpl1mod
suffix:semicolon
r_switch
c_cond
(paren
id|vmode
op_amp
id|FB_VMODE_MASK
)paren
(brace
r_case
id|FB_VMODE_INTERLACED
suffix:colon
id|par-&gt;bpl1mod
op_add_assign
id|par-&gt;next_line
suffix:semicolon
id|par-&gt;bpl2mod
op_add_assign
id|par-&gt;next_line
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_VMODE_DOUBLE
suffix:colon
id|par-&gt;bpl1mod
op_sub_assign
id|par-&gt;next_line
suffix:semicolon
r_break
suffix:semicolon
)brace
id|par-&gt;xoffset
op_assign
id|var-&gt;xoffset
op_assign
id|xoffset
suffix:semicolon
id|par-&gt;yoffset
op_assign
id|var-&gt;yoffset
op_assign
id|yoffset
suffix:semicolon
id|par-&gt;vmode
op_assign
id|var-&gt;vmode
op_assign
id|vmode
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;    *    Change the video mode (called by VBlank interrupt)&n;    */
DECL|function|aga_do_vmode
r_void
id|aga_do_vmode
c_func
(paren
r_void
)paren
(brace
r_struct
id|amiga_fb_par
op_star
id|par
op_assign
op_amp
id|current_par
suffix:semicolon
multiline_comment|/*&n;    *    Rebuild the dynamic part of the Copper List and activate the right&n;    *    Copper List as soon as possible&n;    *&n;    *    Make sure we&squot;re in a Long Frame if the video mode is interlaced.&n;    *    This is always the case if we already were in an interlaced mode,&n;    *    since then the VBlank only calls us during a Long Frame.&n;    *    But this _is_ necessary if we&squot;re switching from a non-interlaced&n;    *    to an interlaced mode.&n;    */
r_if
c_cond
(paren
(paren
id|par-&gt;vmode
op_amp
id|FB_VMODE_MASK
)paren
op_eq
id|FB_VMODE_INTERLACED
)paren
(brace
id|custom.vposw
op_assign
l_int|0x8000
suffix:semicolon
id|aga_build_clist_dyn
c_func
(paren
id|clist_lof
comma
id|clist_shf
comma
l_int|0
comma
id|par
)paren
suffix:semicolon
id|custom.cop2lc
op_assign
(paren
id|u_short
op_star
)paren
id|ZTWO_PADDR
c_func
(paren
id|clist_lof
)paren
suffix:semicolon
id|aga_build_clist_dyn
c_func
(paren
id|clist_shf
comma
id|clist_lof
comma
l_int|1
comma
id|par
)paren
suffix:semicolon
)brace
r_else
(brace
id|aga_build_clist_dyn
c_func
(paren
id|clist_lof
comma
l_int|NULL
comma
l_int|0
comma
id|par
)paren
suffix:semicolon
id|custom.cop2lc
op_assign
(paren
id|u_short
op_star
)paren
id|ZTWO_PADDR
c_func
(paren
id|clist_lof
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;    *    Update the hardware registers&n;    */
r_if
c_cond
(paren
id|full_vmode_change
)paren
(brace
id|custom.fmode
op_assign
id|par-&gt;fmode
suffix:semicolon
id|custom.beamcon0
op_assign
id|par-&gt;beamcon0
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;beamcon0
op_amp
id|BMC0_VARBEAMEN
)paren
(brace
id|custom.htotal
op_assign
id|par-&gt;htotal
suffix:semicolon
id|custom.vtotal
op_assign
id|par-&gt;vtotal
suffix:semicolon
id|custom.hsstrt
op_assign
id|par-&gt;hsstrt
suffix:semicolon
id|custom.hsstop
op_assign
id|par-&gt;hsstop
suffix:semicolon
id|custom.hbstrt
op_assign
id|par-&gt;hsstrt
suffix:semicolon
id|custom.hbstop
op_assign
id|par-&gt;hsstop
suffix:semicolon
id|custom.vsstrt
op_assign
id|par-&gt;vsstrt
suffix:semicolon
id|custom.vsstop
op_assign
id|par-&gt;vsstop
suffix:semicolon
id|custom.vbstrt
op_assign
id|par-&gt;vsstrt
suffix:semicolon
id|custom.vbstop
op_assign
id|par-&gt;vsstop
suffix:semicolon
id|custom.hcenter
op_assign
id|par-&gt;hcenter
suffix:semicolon
)brace
id|custom.bplcon3
op_assign
id|par-&gt;bplcon3
suffix:semicolon
id|full_vmode_change
op_assign
l_int|0
suffix:semicolon
)brace
id|custom.ddfstrt
op_assign
id|par-&gt;ddfstrt
suffix:semicolon
id|custom.ddfstop
op_assign
id|par-&gt;ddfstop
suffix:semicolon
id|custom.bpl1mod
op_assign
id|par-&gt;bpl1mod
suffix:semicolon
id|custom.bpl2mod
op_assign
id|par-&gt;bpl2mod
suffix:semicolon
id|custom.bplcon1
op_assign
id|par-&gt;bplcon1
suffix:semicolon
multiline_comment|/*&n;    *    Update the Frame Header Copper List&n;    */
id|aga_update_clist_hdr
c_func
(paren
id|clist_hdr
comma
id|par
)paren
suffix:semicolon
multiline_comment|/*&n;    *    The minimum period for audio depends on htotal (for OCS/ECS/AGA)&n;    */
r_if
c_cond
(paren
(paren
id|boot_info.bi_amiga.chipset
op_ne
id|CS_STONEAGE
)paren
op_logical_and
id|full_vmode_change
)paren
id|amiga_audio_min_period
op_assign
(paren
id|par-&gt;htotal
op_rshift
l_int|1
)paren
op_plus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;    *    (Un)Blank the screen (called by VBlank interrupt)&n;    */
DECL|function|aga_do_blank
r_void
id|aga_do_blank
c_func
(paren
r_int
id|blank
)paren
(brace
r_struct
id|amiga_fb_par
op_star
id|par
op_assign
op_amp
id|current_par
suffix:semicolon
id|u_short
id|bplcon3
op_assign
id|par-&gt;bplcon3
suffix:semicolon
id|u_char
id|red
comma
id|green
comma
id|blue
suffix:semicolon
r_if
c_cond
(paren
id|blank
)paren
(brace
id|custom.dmacon
op_assign
id|DMAF_RASTER
op_or
id|DMAF_SPRITE
suffix:semicolon
id|red
op_assign
id|green
op_assign
id|blue
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pwrsave
op_logical_and
id|par-&gt;beamcon0
op_amp
id|BMC0_VARBEAMEN
)paren
(brace
multiline_comment|/* VESA suspend mode, switch off HSYNC */
id|custom.hsstrt
op_assign
id|par-&gt;htotal
op_plus
l_int|2
suffix:semicolon
id|custom.hsstop
op_assign
id|par-&gt;htotal
op_plus
l_int|2
suffix:semicolon
)brace
)brace
r_else
(brace
id|custom.dmacon
op_assign
id|DMAF_SETCLR
op_or
id|DMAF_RASTER
suffix:semicolon
id|red
op_assign
id|palette
(braket
l_int|0
)braket
dot
id|red
suffix:semicolon
id|green
op_assign
id|palette
(braket
l_int|0
)braket
dot
id|green
suffix:semicolon
id|blue
op_assign
id|palette
(braket
l_int|0
)braket
dot
id|blue
suffix:semicolon
r_if
c_cond
(paren
id|pwrsave
op_logical_and
id|par-&gt;beamcon0
op_amp
id|BMC0_VARBEAMEN
)paren
(brace
id|custom.hsstrt
op_assign
id|par-&gt;hsstrt
suffix:semicolon
id|custom.hsstop
op_assign
id|par-&gt;hsstop
suffix:semicolon
)brace
)brace
id|custom.bplcon3
op_assign
id|bplcon3
suffix:semicolon
id|custom.color
(braket
l_int|0
)braket
op_assign
id|rgb2hw_high
c_func
(paren
id|red
comma
id|green
comma
id|blue
)paren
suffix:semicolon
id|custom.bplcon3
op_assign
id|bplcon3
op_or
id|BPC3_LOCT
suffix:semicolon
id|custom.color
(braket
l_int|0
)braket
op_assign
id|rgb2hw_low
c_func
(paren
id|red
comma
id|green
comma
id|blue
)paren
suffix:semicolon
id|custom.bplcon3
op_assign
id|bplcon3
suffix:semicolon
id|is_blanked
op_assign
id|blank
suffix:semicolon
)brace
multiline_comment|/*&n;    *    Move the cursor (called by VBlank interrupt)&n;    */
DECL|function|aga_do_movecursor
r_void
id|aga_do_movecursor
c_func
(paren
r_void
)paren
(brace
r_struct
id|amiga_fb_par
op_star
id|par
op_assign
op_amp
id|current_par
suffix:semicolon
r_struct
id|aga_cursorsprite
op_star
id|sprite
op_assign
(paren
r_struct
id|aga_cursorsprite
op_star
)paren
id|lofsprite
suffix:semicolon
r_int
id|hs
comma
id|vs
comma
id|ve
suffix:semicolon
id|u_short
id|s1
comma
id|s2
comma
id|is_double
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;crsr_x
op_le
op_minus
l_int|64
op_logical_or
id|par-&gt;crsr_x
op_ge
id|par-&gt;xres
op_logical_or
id|par-&gt;crsr_y
op_le
op_minus
l_int|64
op_logical_or
id|par-&gt;crsr_y
op_ge
id|par-&gt;yres
)paren
id|hs
op_assign
id|vs
op_assign
id|ve
op_assign
l_int|0
suffix:semicolon
r_else
(brace
id|hs
op_assign
id|par-&gt;diwstrt_h
op_minus
l_int|4
op_plus
(paren
id|par-&gt;crsr_x
op_lshift
id|par-&gt;clk_shift
)paren
suffix:semicolon
id|vs
op_assign
id|par-&gt;crsr_y
suffix:semicolon
id|ve
op_assign
id|min
c_func
(paren
id|vs
op_plus
l_int|64
comma
id|par-&gt;yres
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|par-&gt;vmode
op_amp
id|FB_VMODE_MASK
)paren
(brace
r_case
id|FB_VMODE_INTERLACED
suffix:colon
id|vs
op_rshift_assign
l_int|1
suffix:semicolon
id|ve
op_rshift_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_VMODE_DOUBLE
suffix:colon
id|vs
op_lshift_assign
l_int|1
suffix:semicolon
id|ve
op_lshift_assign
l_int|1
suffix:semicolon
id|is_double
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|vs
op_add_assign
id|par-&gt;diwstrt_v
suffix:semicolon
id|ve
op_add_assign
id|par-&gt;diwstrt_v
suffix:semicolon
)brace
id|s1
op_assign
id|spr2hw_pos
c_func
(paren
id|vs
comma
id|hs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_double
)paren
id|s1
op_or_assign
l_int|0x80
suffix:semicolon
id|s2
op_assign
id|spr2hw_ctl
c_func
(paren
id|vs
comma
id|hs
comma
id|ve
)paren
suffix:semicolon
id|sprite-&gt;sprpos
op_assign
id|s1
suffix:semicolon
id|sprite-&gt;sprctl
op_assign
id|s2
suffix:semicolon
multiline_comment|/*&n;    *    TODO: Special cases:&n;    *    &n;    *      - Interlaced: fill position in in both lofsprite &amp; shfsprite&n;    *                    swap lofsprite &amp; shfsprite on odd lines&n;    *    &n;    *      - Doublescan: OK?&n;    *    &n;    *      - ve &lt;= bottom of display: OK?&n;    */
)brace
multiline_comment|/*&n;    *    Flash the cursor (called by VBlank interrupt)&n;    */
DECL|function|aga_do_flashcursor
r_void
id|aga_do_flashcursor
c_func
(paren
r_void
)paren
(brace
macro_line|#if 1
r_static
r_int
id|cursorcount
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|cursorstate
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|cursormode
)paren
(brace
r_case
id|FB_CURSOR_OFF
suffix:colon
id|custom.dmacon
op_assign
id|DMAF_SPRITE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_CURSOR_ON
suffix:colon
id|custom.dmacon
op_assign
id|DMAF_SETCLR
op_or
id|DMAF_SPRITE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_CURSOR_FLASH
suffix:colon
r_if
c_cond
(paren
id|cursorcount
)paren
id|cursorcount
op_decrement
suffix:semicolon
r_else
(brace
id|cursorcount
op_assign
id|CRSR_RATE
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cursorstate
op_assign
op_logical_neg
id|cursorstate
)paren
)paren
id|custom.dmacon
op_assign
id|DMAF_SETCLR
op_or
id|DMAF_SPRITE
suffix:semicolon
r_else
id|custom.dmacon
op_assign
id|DMAF_SPRITE
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
macro_line|#endif
)brace
macro_line|#if 1
DECL|function|aga_get_fix_cursorinfo
r_static
r_int
id|aga_get_fix_cursorinfo
c_func
(paren
r_struct
id|fb_fix_cursorinfo
op_star
id|fix
comma
r_int
id|con
)paren
(brace
macro_line|#if 0
r_if
c_cond
(paren
id|ddfstrt
op_ge
l_int|192
)paren
(brace
macro_line|#endif
id|fix-&gt;crsr_width
op_assign
l_int|64
suffix:semicolon
id|fix-&gt;crsr_height
op_assign
l_int|64
suffix:semicolon
id|fix-&gt;crsr_xsize
op_assign
l_int|64
suffix:semicolon
id|fix-&gt;crsr_ysize
op_assign
l_int|64
suffix:semicolon
id|fix-&gt;crsr_color1
op_assign
l_int|17
suffix:semicolon
id|fix-&gt;crsr_color2
op_assign
l_int|18
suffix:semicolon
macro_line|#if 0
)brace
r_else
(brace
id|fix-&gt;crsr_width
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;crsr_height
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;crsr_xsize
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;crsr_ysize
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;crsr_color1
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;crsr_color2
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|aga_get_var_cursorinfo
r_static
r_int
id|aga_get_var_cursorinfo
c_func
(paren
r_struct
id|fb_var_cursorinfo
op_star
id|var
comma
r_int
id|con
)paren
(brace
r_struct
id|aga_cursorsprite
op_star
id|sprite
op_assign
(paren
r_struct
id|aga_cursorsprite
op_star
)paren
id|lofsprite
suffix:semicolon
multiline_comment|/* TODO: interlaced sprites */
id|memcpy
c_func
(paren
id|var-&gt;data
comma
id|sprite-&gt;u.nonlaced.data
comma
r_sizeof
(paren
id|var-&gt;data
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|aga_set_var_cursorinfo
r_static
r_int
id|aga_set_var_cursorinfo
c_func
(paren
r_struct
id|fb_var_cursorinfo
op_star
id|var
comma
r_int
id|con
)paren
(brace
r_struct
id|aga_cursorsprite
op_star
id|sprite
op_assign
(paren
r_struct
id|aga_cursorsprite
op_star
)paren
id|lofsprite
suffix:semicolon
multiline_comment|/* TODO: interlaced sprites */
id|memcpy
c_func
(paren
id|sprite-&gt;u.nonlaced.data
comma
id|var-&gt;data
comma
r_sizeof
(paren
id|var-&gt;data
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|aga_get_cursorstate
r_static
r_int
id|aga_get_cursorstate
c_func
(paren
r_struct
id|fb_cursorstate
op_star
id|state
comma
r_int
id|con
)paren
(brace
id|state-&gt;xoffset
op_assign
id|current_par.crsr_x
suffix:semicolon
id|state-&gt;yoffset
op_assign
id|current_par.crsr_y
suffix:semicolon
id|state-&gt;mode
op_assign
id|cursormode
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|aga_set_cursorstate
r_static
r_int
id|aga_set_cursorstate
c_func
(paren
r_struct
id|fb_cursorstate
op_star
id|state
comma
r_int
id|con
)paren
(brace
id|current_par.crsr_x
op_assign
id|state-&gt;xoffset
suffix:semicolon
id|current_par.crsr_y
op_assign
id|state-&gt;yoffset
suffix:semicolon
id|cursormode
op_assign
id|state-&gt;mode
suffix:semicolon
id|do_movecursor
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;    *    Build the Frame Header Copper List&n;    */
DECL|function|aga_build_clist_hdr
r_static
id|__inline__
r_void
id|aga_build_clist_hdr
c_func
(paren
r_struct
id|clist_hdr
op_star
id|cop
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
id|u_long
id|p
suffix:semicolon
id|cop-&gt;bplcon0.l
op_assign
id|CMOVE
c_func
(paren
id|BPC0_COLOR
op_or
id|BPC0_SHRES
op_or
id|BPC0_ECSENA
comma
id|bplcon0
)paren
suffix:semicolon
id|cop-&gt;diwstrt.l
op_assign
id|CMOVE
c_func
(paren
l_int|0x0181
comma
id|diwstrt
)paren
suffix:semicolon
id|cop-&gt;diwstop.l
op_assign
id|CMOVE
c_func
(paren
l_int|0x0281
comma
id|diwstop
)paren
suffix:semicolon
id|cop-&gt;diwhigh.l
op_assign
id|CMOVE
c_func
(paren
l_int|0x0000
comma
id|diwhigh
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|cop-&gt;sprfix
(braket
id|i
)braket
dot
id|l
op_assign
id|CMOVE
c_func
(paren
l_int|0
comma
id|spr
(braket
id|i
)braket
dot
id|pos
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p
op_assign
id|ZTWO_PADDR
c_func
(paren
id|dummysprite
)paren
suffix:semicolon
id|cop-&gt;sprstrtup
(braket
id|j
op_increment
)braket
dot
id|l
op_assign
id|CMOVE
c_func
(paren
id|highw
c_func
(paren
id|p
)paren
comma
id|sprpt
(braket
id|i
)braket
)paren
suffix:semicolon
id|cop-&gt;sprstrtup
(braket
id|j
op_increment
)braket
dot
id|l
op_assign
id|CMOVE2
c_func
(paren
id|loww
c_func
(paren
id|p
)paren
comma
id|sprpt
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|cop-&gt;wait.l
op_assign
id|CWAIT
c_func
(paren
l_int|0
comma
l_int|12
)paren
suffix:semicolon
multiline_comment|/* Initial value */
id|cop-&gt;jump.l
op_assign
id|CMOVE
c_func
(paren
l_int|0
comma
id|copjmp2
)paren
suffix:semicolon
id|cop-&gt;wait_forever.l
op_assign
id|CEND
suffix:semicolon
)brace
multiline_comment|/*&n;    *    Update the Frame Header Copper List&n;    */
DECL|function|aga_update_clist_hdr
r_static
id|__inline__
r_void
id|aga_update_clist_hdr
c_func
(paren
r_struct
id|clist_hdr
op_star
id|cop
comma
r_struct
id|amiga_fb_par
op_star
id|par
)paren
(brace
id|cop-&gt;bplcon0.l
op_assign
id|CMOVE
c_func
(paren
op_complement
(paren
id|BPC0_BPU3
op_or
id|BPC0_BPU2
op_or
id|BPC0_BPU1
op_or
id|BPC0_BPU0
)paren
op_amp
id|par-&gt;bplcon0
comma
id|bplcon0
)paren
suffix:semicolon
id|cop-&gt;wait.l
op_assign
id|CWAIT
c_func
(paren
l_int|0
comma
id|par-&gt;diwstrt_v
op_minus
l_int|2
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;    *    Build the Long Frame/Short Frame Copper List&n;    */
DECL|function|aga_build_clist_dyn
r_static
r_void
id|aga_build_clist_dyn
c_func
(paren
r_struct
id|clist_dyn
op_star
id|cop
comma
r_struct
id|clist_dyn
op_star
id|othercop
comma
id|u_short
id|shf
comma
r_struct
id|amiga_fb_par
op_star
id|par
)paren
(brace
id|u_long
id|y_wrap
comma
id|bplpt0
comma
id|p
comma
id|line
suffix:semicolon
r_int
id|i
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|cop-&gt;diwstrt.l
op_assign
id|CMOVE
c_func
(paren
id|par-&gt;diwstrt
comma
id|diwstrt
)paren
suffix:semicolon
id|cop-&gt;diwstop.l
op_assign
id|CMOVE
c_func
(paren
id|par-&gt;diwstop
comma
id|diwstop
)paren
suffix:semicolon
id|cop-&gt;diwhigh.l
op_assign
id|CMOVE
c_func
(paren
id|par-&gt;diwhigh
comma
id|diwhigh
)paren
suffix:semicolon
id|cop-&gt;bplcon0.l
op_assign
id|CMOVE
c_func
(paren
id|par-&gt;bplcon0
comma
id|bplcon0
)paren
suffix:semicolon
multiline_comment|/* Point Sprite 0 at cursor sprite */
multiline_comment|/* TODO: This should depend on the vertical sprite position too */
r_if
c_cond
(paren
id|shf
)paren
(brace
id|p
op_assign
id|ZTWO_PADDR
c_func
(paren
id|shfsprite
)paren
suffix:semicolon
id|cop-&gt;sprpt
(braket
l_int|0
)braket
dot
id|l
op_assign
id|CMOVE
c_func
(paren
id|highw
c_func
(paren
id|p
)paren
comma
id|sprpt
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|cop-&gt;sprpt
(braket
l_int|1
)braket
dot
id|l
op_assign
id|CMOVE2
c_func
(paren
id|loww
c_func
(paren
id|p
)paren
comma
id|sprpt
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|p
op_assign
id|ZTWO_PADDR
c_func
(paren
id|lofsprite
)paren
suffix:semicolon
id|cop-&gt;sprpt
(braket
l_int|0
)braket
dot
id|l
op_assign
id|CMOVE
c_func
(paren
id|highw
c_func
(paren
id|p
)paren
comma
id|sprpt
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|cop-&gt;sprpt
(braket
l_int|1
)braket
dot
id|l
op_assign
id|CMOVE2
c_func
(paren
id|loww
c_func
(paren
id|p
)paren
comma
id|sprpt
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
id|bplpt0
op_assign
id|par-&gt;bplpt0
suffix:semicolon
r_if
c_cond
(paren
id|shf
)paren
id|bplpt0
op_add_assign
id|par-&gt;next_line
suffix:semicolon
id|y_wrap
op_assign
id|par-&gt;vmode
op_amp
id|FB_VMODE_YWRAP
ques
c_cond
id|par-&gt;yoffset
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/* Set up initial bitplane ptrs */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|p
op_assign
id|bplpt0
suffix:semicolon
id|i
OL
id|par-&gt;bpp
suffix:semicolon
id|i
op_increment
comma
id|p
op_add_assign
id|par-&gt;next_plane
)paren
(brace
id|cop-&gt;rest
(braket
id|j
op_increment
)braket
dot
id|l
op_assign
id|CMOVE
c_func
(paren
id|highw
c_func
(paren
id|p
)paren
comma
id|bplpt
(braket
id|i
)braket
)paren
suffix:semicolon
id|cop-&gt;rest
(braket
id|j
op_increment
)braket
dot
id|l
op_assign
id|CMOVE2
c_func
(paren
id|loww
c_func
(paren
id|p
)paren
comma
id|bplpt
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|y_wrap
)paren
(brace
id|bplpt0
op_sub_assign
id|y_wrap
op_star
id|par-&gt;next_line
suffix:semicolon
id|line
op_assign
id|par-&gt;yres
op_minus
id|y_wrap
suffix:semicolon
r_switch
c_cond
(paren
id|par-&gt;vmode
op_amp
id|FB_VMODE_MASK
)paren
(brace
r_case
id|FB_VMODE_INTERLACED
suffix:colon
id|line
op_rshift_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_VMODE_DOUBLE
suffix:colon
id|line
op_lshift_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|line
op_add_assign
id|par-&gt;diwstrt_v
suffix:semicolon
multiline_comment|/* Handle skipping over 256-line chunks */
r_while
c_loop
(paren
id|line
OG
l_int|256
)paren
(brace
multiline_comment|/* Hardware limitation - 8 bit counter */
id|cop-&gt;rest
(braket
id|j
op_increment
)braket
dot
id|l
op_assign
id|CWAIT
c_func
(paren
id|par-&gt;htotal
op_minus
l_int|4
comma
l_int|255
)paren
suffix:semicolon
multiline_comment|/* Wait(0, 0) - make sure we&squot;re in the new segment */
id|cop-&gt;rest
(braket
id|j
op_increment
)braket
dot
id|l
op_assign
id|CWAIT
c_func
(paren
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|line
op_sub_assign
l_int|256
suffix:semicolon
)brace
id|cop-&gt;rest
(braket
id|j
op_increment
)braket
dot
id|l
op_assign
id|CWAIT
c_func
(paren
id|par-&gt;htotal
op_minus
l_int|11
comma
id|line
op_minus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|p
op_assign
id|bplpt0
suffix:semicolon
id|i
OL
id|par-&gt;bpp
suffix:semicolon
id|i
op_increment
comma
id|p
op_add_assign
id|par-&gt;next_plane
)paren
(brace
id|cop-&gt;rest
(braket
id|j
op_increment
)braket
dot
id|l
op_assign
id|CMOVE
c_func
(paren
id|highw
c_func
(paren
id|p
)paren
comma
id|bplpt
(braket
id|i
)braket
)paren
suffix:semicolon
id|cop-&gt;rest
(braket
id|j
op_increment
)braket
dot
id|l
op_assign
id|CMOVE2
c_func
(paren
id|loww
c_func
(paren
id|p
)paren
comma
id|bplpt
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|othercop
)paren
(brace
id|p
op_assign
id|ZTWO_PADDR
c_func
(paren
id|othercop
)paren
suffix:semicolon
id|cop-&gt;rest
(braket
id|j
op_increment
)braket
dot
id|l
op_assign
id|CMOVE
c_func
(paren
id|highw
c_func
(paren
id|p
)paren
comma
id|cop2lc
)paren
suffix:semicolon
id|cop-&gt;rest
(braket
id|j
op_increment
)braket
dot
id|l
op_assign
id|CMOVE2
c_func
(paren
id|loww
c_func
(paren
id|p
)paren
comma
id|cop2lc
)paren
suffix:semicolon
)brace
multiline_comment|/* End of Copper list */
id|cop-&gt;rest
(braket
id|j
op_increment
)braket
dot
id|l
op_assign
id|CEND
suffix:semicolon
r_if
c_cond
(paren
id|j
OG
id|arraysize
c_func
(paren
id|cop-&gt;rest
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;aga_build_clist_dyn: copper list overflow (%d entries)&bslash;n&quot;
comma
id|j
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_AMIFB_AGA */
multiline_comment|/* -------------------- Interfaces to hardware functions -------------------- */
macro_line|#ifdef CONFIG_AMIFB_OCS
DECL|variable|ocs_switch
r_static
r_struct
id|fb_hwswitch
id|ocs_switch
op_assign
(brace
id|ocs_init
comma
id|ocs_encode_fix
comma
id|ocs_decode_var
comma
id|ocs_encode_var
comma
id|ocs_getcolreg
comma
id|ocs_setcolreg
comma
id|ocs_pan_display
comma
id|ocs_do_vmode
comma
id|ocs_do_blank
comma
id|ocs_do_movecursor
comma
id|ocs_do_flashcursor
)brace
suffix:semicolon
macro_line|#endif /* CONFIG_AMIFB_OCS */
macro_line|#ifdef CONFIG_AMIFB_ECS
DECL|variable|ecs_switch
r_static
r_struct
id|fb_hwswitch
id|ecs_switch
op_assign
(brace
id|ecs_init
comma
id|ecs_encode_fix
comma
id|ecs_decode_var
comma
id|ecs_encode_var
comma
id|ecs_getcolreg
comma
id|ecs_setcolreg
comma
id|ecs_pan_display
comma
id|ecs_do_vmode
comma
id|ecs_do_blank
comma
id|ecs_do_movecursor
comma
id|ecs_do_flashcursor
)brace
suffix:semicolon
macro_line|#endif /* CONFIG_AMIFB_ECS */
macro_line|#ifdef CONFIG_AMIFB_AGA
DECL|variable|aga_switch
r_static
r_struct
id|fb_hwswitch
id|aga_switch
op_assign
(brace
id|aga_init
comma
id|aga_encode_fix
comma
id|aga_decode_var
comma
id|aga_encode_var
comma
id|aga_getcolreg
comma
id|aga_setcolreg
comma
id|aga_pan_display
comma
id|aga_do_vmode
comma
id|aga_do_blank
comma
id|aga_do_movecursor
comma
id|aga_do_flashcursor
)brace
suffix:semicolon
macro_line|#endif /* CONFIG_AMIFB_AGA */
multiline_comment|/* -------------------- Generic routines ------------------------------------ */
multiline_comment|/*&n;    *    Allocate, Clear and Align a Block of Chip Memory&n;    */
DECL|function|chipalloc
r_static
id|u_long
id|chipalloc
c_func
(paren
id|u_long
id|size
)paren
(brace
id|u_long
id|ptr
suffix:semicolon
id|size
op_add_assign
id|PAGE_SIZE
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ptr
op_assign
(paren
id|u_long
)paren
id|amiga_chip_alloc
c_func
(paren
id|size
)paren
)paren
)paren
id|panic
c_func
(paren
l_string|&quot;No Chip RAM for frame buffer&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|ptr
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
id|ptr
op_assign
id|PAGE_ALIGN
c_func
(paren
id|ptr
)paren
suffix:semicolon
r_return
id|ptr
suffix:semicolon
)brace
multiline_comment|/*&n;    *    Fill the hardware&squot;s `par&squot; structure.&n;    */
DECL|function|amiga_fb_get_par
r_static
r_void
id|amiga_fb_get_par
c_func
(paren
r_struct
id|amiga_fb_par
op_star
id|par
)paren
(brace
r_if
c_cond
(paren
id|current_par_valid
)paren
op_star
id|par
op_assign
id|current_par
suffix:semicolon
r_else
id|fbhw
op_member_access_from_pointer
id|decode_var
c_func
(paren
op_amp
id|amiga_fb_predefined
(braket
id|amifb_mode
)braket
comma
id|par
)paren
suffix:semicolon
)brace
DECL|function|amiga_fb_set_par
r_static
r_void
id|amiga_fb_set_par
c_func
(paren
r_struct
id|amiga_fb_par
op_star
id|par
)paren
(brace
id|do_vmode
op_assign
l_int|0
suffix:semicolon
id|current_par
op_assign
op_star
id|par
suffix:semicolon
id|full_vmode_change
op_assign
l_int|1
suffix:semicolon
id|do_vmode
op_assign
l_int|1
suffix:semicolon
id|current_par_valid
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|do_fb_set_var
r_static
r_int
id|do_fb_set_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|isactive
)paren
(brace
r_int
id|err
comma
id|activate
suffix:semicolon
r_struct
id|amiga_fb_par
id|par
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|fbhw
op_member_access_from_pointer
id|decode_var
c_func
(paren
id|var
comma
op_amp
id|par
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
id|activate
op_assign
id|var-&gt;activate
suffix:semicolon
r_if
c_cond
(paren
(paren
id|var-&gt;activate
op_amp
id|FB_ACTIVATE_MASK
)paren
op_eq
id|FB_ACTIVATE_NOW
op_logical_and
id|isactive
)paren
id|amiga_fb_set_par
c_func
(paren
op_amp
id|par
)paren
suffix:semicolon
id|fbhw
op_member_access_from_pointer
id|encode_var
c_func
(paren
id|var
comma
op_amp
id|par
)paren
suffix:semicolon
id|var-&gt;activate
op_assign
id|activate
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;    *    Default Colormaps&n;    */
DECL|variable|red2
r_static
id|u_short
id|red2
(braket
)braket
op_assign
(brace
l_int|0x0000
comma
l_int|0xc000
)brace
suffix:semicolon
DECL|variable|green2
r_static
id|u_short
id|green2
(braket
)braket
op_assign
(brace
l_int|0x0000
comma
l_int|0xc000
)brace
suffix:semicolon
DECL|variable|blue2
r_static
id|u_short
id|blue2
(braket
)braket
op_assign
(brace
l_int|0x0000
comma
l_int|0xc000
)brace
suffix:semicolon
DECL|variable|red4
r_static
id|u_short
id|red4
(braket
)braket
op_assign
(brace
l_int|0x0000
comma
l_int|0xc000
comma
l_int|0x8000
comma
l_int|0xffff
)brace
suffix:semicolon
DECL|variable|green4
r_static
id|u_short
id|green4
(braket
)braket
op_assign
(brace
l_int|0x0000
comma
l_int|0xc000
comma
l_int|0x8000
comma
l_int|0xffff
)brace
suffix:semicolon
DECL|variable|blue4
r_static
id|u_short
id|blue4
(braket
)braket
op_assign
(brace
l_int|0x0000
comma
l_int|0xc000
comma
l_int|0x8000
comma
l_int|0xffff
)brace
suffix:semicolon
DECL|variable|red8
r_static
id|u_short
id|red8
(braket
)braket
op_assign
(brace
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0xc000
comma
l_int|0xc000
comma
l_int|0xc000
comma
l_int|0xc000
)brace
suffix:semicolon
DECL|variable|green8
r_static
id|u_short
id|green8
(braket
)braket
op_assign
(brace
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0xc000
comma
l_int|0xc000
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0xc000
comma
l_int|0xc000
)brace
suffix:semicolon
DECL|variable|blue8
r_static
id|u_short
id|blue8
(braket
)braket
op_assign
(brace
l_int|0x0000
comma
l_int|0xc000
comma
l_int|0x0000
comma
l_int|0xc000
comma
l_int|0x0000
comma
l_int|0xc000
comma
l_int|0x0000
comma
l_int|0xc000
)brace
suffix:semicolon
DECL|variable|red16
r_static
id|u_short
id|red16
(braket
)braket
op_assign
(brace
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0xc000
comma
l_int|0xc000
comma
l_int|0xc000
comma
l_int|0xc000
comma
l_int|0x8000
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0xffff
comma
l_int|0xffff
comma
l_int|0xffff
comma
l_int|0xffff
)brace
suffix:semicolon
DECL|variable|green16
r_static
id|u_short
id|green16
(braket
)braket
op_assign
(brace
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0xc000
comma
l_int|0xc000
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0xc000
comma
l_int|0xc000
comma
l_int|0x8000
comma
l_int|0x0000
comma
l_int|0xffff
comma
l_int|0xffff
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0xffff
comma
l_int|0xffff
)brace
suffix:semicolon
DECL|variable|blue16
r_static
id|u_short
id|blue16
(braket
)braket
op_assign
(brace
l_int|0x0000
comma
l_int|0xc000
comma
l_int|0x0000
comma
l_int|0xc000
comma
l_int|0x0000
comma
l_int|0xc000
comma
l_int|0x0000
comma
l_int|0xc000
comma
l_int|0x8000
comma
l_int|0xffff
comma
l_int|0x0000
comma
l_int|0xffff
comma
l_int|0x0000
comma
l_int|0xffff
comma
l_int|0x0000
comma
l_int|0xffff
)brace
suffix:semicolon
DECL|variable|default_2_colors
r_static
r_struct
id|fb_cmap
id|default_2_colors
op_assign
(brace
l_int|0
comma
l_int|2
comma
id|red2
comma
id|green2
comma
id|blue2
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|default_8_colors
r_static
r_struct
id|fb_cmap
id|default_8_colors
op_assign
(brace
l_int|0
comma
l_int|8
comma
id|red8
comma
id|green8
comma
id|blue8
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|default_4_colors
r_static
r_struct
id|fb_cmap
id|default_4_colors
op_assign
(brace
l_int|0
comma
l_int|4
comma
id|red4
comma
id|green4
comma
id|blue4
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|default_16_colors
r_static
r_struct
id|fb_cmap
id|default_16_colors
op_assign
(brace
l_int|0
comma
l_int|16
comma
id|red16
comma
id|green16
comma
id|blue16
comma
l_int|NULL
)brace
suffix:semicolon
DECL|function|get_default_colormap
r_static
r_struct
id|fb_cmap
op_star
id|get_default_colormap
c_func
(paren
r_int
id|bpp
)paren
(brace
r_switch
c_cond
(paren
id|bpp
)paren
(brace
r_case
l_int|1
suffix:colon
r_return
op_amp
id|default_2_colors
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
r_return
op_amp
id|default_4_colors
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
r_return
op_amp
id|default_8_colors
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_amp
id|default_16_colors
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|macro|CNVT_TOHW
mdefine_line|#define CNVT_TOHW(val,width)     ((((val)&lt;&lt;(width))+0x7fff-(val))&gt;&gt;16)
DECL|macro|CNVT_FROMHW
mdefine_line|#define CNVT_FROMHW(val,width)   (((width) ? ((((val)&lt;&lt;16)-(val)) / &bslash;&n;                                              ((1&lt;&lt;(width))-1)) : 0))
DECL|function|do_fb_get_cmap
r_static
r_int
id|do_fb_get_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|kspc
)paren
(brace
r_int
id|i
comma
id|start
suffix:semicolon
id|u_short
op_star
id|red
comma
op_star
id|green
comma
op_star
id|blue
comma
op_star
id|transp
suffix:semicolon
id|u_int
id|hred
comma
id|hgreen
comma
id|hblue
comma
id|htransp
suffix:semicolon
id|red
op_assign
id|cmap-&gt;red
suffix:semicolon
id|green
op_assign
id|cmap-&gt;green
suffix:semicolon
id|blue
op_assign
id|cmap-&gt;blue
suffix:semicolon
id|transp
op_assign
id|cmap-&gt;transp
suffix:semicolon
id|start
op_assign
id|cmap-&gt;start
suffix:semicolon
r_if
c_cond
(paren
id|start
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cmap-&gt;len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|fbhw
op_member_access_from_pointer
id|getcolreg
c_func
(paren
id|start
op_increment
comma
op_amp
id|hred
comma
op_amp
id|hgreen
comma
op_amp
id|hblue
comma
op_amp
id|htransp
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|hred
op_assign
id|CNVT_FROMHW
c_func
(paren
id|hred
comma
id|var-&gt;red.length
)paren
suffix:semicolon
id|hgreen
op_assign
id|CNVT_FROMHW
c_func
(paren
id|hgreen
comma
id|var-&gt;green.length
)paren
suffix:semicolon
id|hblue
op_assign
id|CNVT_FROMHW
c_func
(paren
id|hblue
comma
id|var-&gt;blue.length
)paren
suffix:semicolon
id|htransp
op_assign
id|CNVT_FROMHW
c_func
(paren
id|htransp
comma
id|var-&gt;transp.length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kspc
)paren
(brace
op_star
id|red
op_assign
id|hred
suffix:semicolon
op_star
id|green
op_assign
id|hgreen
suffix:semicolon
op_star
id|blue
op_assign
id|hblue
suffix:semicolon
r_if
c_cond
(paren
id|transp
)paren
op_star
id|transp
op_assign
id|htransp
suffix:semicolon
)brace
r_else
(brace
id|put_fs_word
c_func
(paren
id|hred
comma
id|red
)paren
suffix:semicolon
id|put_fs_word
c_func
(paren
id|hgreen
comma
id|green
)paren
suffix:semicolon
id|put_fs_word
c_func
(paren
id|hblue
comma
id|blue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|transp
)paren
id|put_fs_word
c_func
(paren
id|htransp
comma
id|transp
)paren
suffix:semicolon
)brace
id|red
op_increment
suffix:semicolon
id|green
op_increment
suffix:semicolon
id|blue
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|transp
)paren
id|transp
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|do_fb_set_cmap
r_static
r_int
id|do_fb_set_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|kspc
)paren
(brace
r_int
id|i
comma
id|start
suffix:semicolon
id|u_short
op_star
id|red
comma
op_star
id|green
comma
op_star
id|blue
comma
op_star
id|transp
suffix:semicolon
id|u_int
id|hred
comma
id|hgreen
comma
id|hblue
comma
id|htransp
suffix:semicolon
id|red
op_assign
id|cmap-&gt;red
suffix:semicolon
id|green
op_assign
id|cmap-&gt;green
suffix:semicolon
id|blue
op_assign
id|cmap-&gt;blue
suffix:semicolon
id|transp
op_assign
id|cmap-&gt;transp
suffix:semicolon
id|start
op_assign
id|cmap-&gt;start
suffix:semicolon
r_if
c_cond
(paren
id|start
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cmap-&gt;len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|kspc
)paren
(brace
id|hred
op_assign
op_star
id|red
suffix:semicolon
id|hgreen
op_assign
op_star
id|green
suffix:semicolon
id|hblue
op_assign
op_star
id|blue
suffix:semicolon
id|htransp
op_assign
id|transp
ques
c_cond
op_star
id|transp
suffix:colon
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|hred
op_assign
id|get_fs_word
c_func
(paren
id|red
)paren
suffix:semicolon
id|hgreen
op_assign
id|get_fs_word
c_func
(paren
id|green
)paren
suffix:semicolon
id|hblue
op_assign
id|get_fs_word
c_func
(paren
id|blue
)paren
suffix:semicolon
id|htransp
op_assign
id|transp
ques
c_cond
id|get_fs_word
c_func
(paren
id|transp
)paren
suffix:colon
l_int|0
suffix:semicolon
)brace
id|hred
op_assign
id|CNVT_TOHW
c_func
(paren
id|hred
comma
id|var-&gt;red.length
)paren
suffix:semicolon
id|hgreen
op_assign
id|CNVT_TOHW
c_func
(paren
id|hgreen
comma
id|var-&gt;green.length
)paren
suffix:semicolon
id|hblue
op_assign
id|CNVT_TOHW
c_func
(paren
id|hblue
comma
id|var-&gt;blue.length
)paren
suffix:semicolon
id|htransp
op_assign
id|CNVT_TOHW
c_func
(paren
id|htransp
comma
id|var-&gt;transp.length
)paren
suffix:semicolon
id|red
op_increment
suffix:semicolon
id|green
op_increment
suffix:semicolon
id|blue
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|transp
)paren
id|transp
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|fbhw
op_member_access_from_pointer
id|setcolreg
c_func
(paren
id|start
op_increment
comma
id|hred
comma
id|hgreen
comma
id|hblue
comma
id|htransp
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|do_install_cmap
r_static
r_void
id|do_install_cmap
c_func
(paren
r_int
id|con
)paren
(brace
r_if
c_cond
(paren
id|con
op_ne
id|currcon
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|disp
(braket
id|con
)braket
dot
id|cmap.len
)paren
id|do_fb_set_cmap
c_func
(paren
op_amp
id|disp
(braket
id|con
)braket
dot
id|cmap
comma
op_amp
id|disp
(braket
id|con
)braket
dot
id|var
comma
l_int|1
)paren
suffix:semicolon
r_else
id|do_fb_set_cmap
c_func
(paren
id|get_default_colormap
c_func
(paren
id|disp
(braket
id|con
)braket
dot
id|var.bits_per_pixel
)paren
comma
op_amp
id|disp
(braket
id|con
)braket
dot
id|var
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|memcpy_fs
r_static
r_void
id|memcpy_fs
c_func
(paren
r_int
id|fsfromto
comma
r_void
op_star
id|to
comma
r_void
op_star
id|from
comma
r_int
id|len
)paren
(brace
r_switch
c_cond
(paren
id|fsfromto
)paren
(brace
r_case
l_int|0
suffix:colon
id|memcpy
c_func
(paren
id|to
comma
id|from
comma
id|len
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|1
suffix:colon
id|memcpy_fromfs
c_func
(paren
id|to
comma
id|from
comma
id|len
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|2
suffix:colon
id|memcpy_tofs
c_func
(paren
id|to
comma
id|from
comma
id|len
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
DECL|function|copy_cmap
r_static
r_void
id|copy_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|from
comma
r_struct
id|fb_cmap
op_star
id|to
comma
r_int
id|fsfromto
)paren
(brace
r_int
id|size
suffix:semicolon
r_int
id|tooff
op_assign
l_int|0
comma
id|fromoff
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|to-&gt;start
OG
id|from-&gt;start
)paren
id|fromoff
op_assign
id|to-&gt;start
op_minus
id|from-&gt;start
suffix:semicolon
r_else
id|tooff
op_assign
id|from-&gt;start
op_minus
id|to-&gt;start
suffix:semicolon
id|size
op_assign
id|to-&gt;len
op_minus
id|tooff
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|from-&gt;len
op_minus
id|fromoff
)paren
id|size
op_assign
id|from-&gt;len
op_minus
id|fromoff
suffix:semicolon
r_if
c_cond
(paren
id|size
OL
l_int|0
)paren
r_return
suffix:semicolon
id|size
op_mul_assign
r_sizeof
(paren
id|u_short
)paren
suffix:semicolon
id|memcpy_fs
c_func
(paren
id|fsfromto
comma
id|to-&gt;red
op_plus
id|tooff
comma
id|from-&gt;red
op_plus
id|fromoff
comma
id|size
)paren
suffix:semicolon
id|memcpy_fs
c_func
(paren
id|fsfromto
comma
id|to-&gt;green
op_plus
id|tooff
comma
id|from-&gt;green
op_plus
id|fromoff
comma
id|size
)paren
suffix:semicolon
id|memcpy_fs
c_func
(paren
id|fsfromto
comma
id|to-&gt;blue
op_plus
id|tooff
comma
id|from-&gt;blue
op_plus
id|fromoff
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|from-&gt;transp
op_logical_and
id|to-&gt;transp
)paren
id|memcpy_fs
c_func
(paren
id|fsfromto
comma
id|to-&gt;transp
op_plus
id|tooff
comma
id|from-&gt;transp
op_plus
id|fromoff
comma
id|size
)paren
suffix:semicolon
)brace
DECL|function|alloc_cmap
r_static
r_int
id|alloc_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|len
comma
r_int
id|transp
)paren
(brace
r_int
id|size
op_assign
id|len
op_star
r_sizeof
(paren
id|u_short
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmap-&gt;len
op_ne
id|len
)paren
(brace
r_if
c_cond
(paren
id|cmap-&gt;red
)paren
id|kfree
c_func
(paren
id|cmap-&gt;red
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmap-&gt;green
)paren
id|kfree
c_func
(paren
id|cmap-&gt;green
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmap-&gt;blue
)paren
id|kfree
c_func
(paren
id|cmap-&gt;blue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmap-&gt;transp
)paren
id|kfree
c_func
(paren
id|cmap-&gt;transp
)paren
suffix:semicolon
id|cmap-&gt;red
op_assign
id|cmap-&gt;green
op_assign
id|cmap-&gt;blue
op_assign
id|cmap-&gt;transp
op_assign
l_int|NULL
suffix:semicolon
id|cmap-&gt;len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|cmap-&gt;red
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_ATOMIC
)paren
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|cmap-&gt;green
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_ATOMIC
)paren
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|cmap-&gt;blue
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_ATOMIC
)paren
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|transp
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|cmap-&gt;transp
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_ATOMIC
)paren
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_else
id|cmap-&gt;transp
op_assign
l_int|NULL
suffix:semicolon
)brace
id|cmap-&gt;start
op_assign
l_int|0
suffix:semicolon
id|cmap-&gt;len
op_assign
id|len
suffix:semicolon
id|copy_cmap
c_func
(paren
id|get_default_colormap
c_func
(paren
id|len
)paren
comma
id|cmap
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;    *    Get the Fixed Part of the Display&n;    */
DECL|function|amiga_fb_get_fix
r_static
r_int
id|amiga_fb_get_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_int
id|con
)paren
(brace
r_struct
id|amiga_fb_par
id|par
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|con
op_eq
op_minus
l_int|1
)paren
id|amiga_fb_get_par
c_func
(paren
op_amp
id|par
)paren
suffix:semicolon
r_else
id|error
op_assign
id|fbhw
op_member_access_from_pointer
id|decode_var
c_func
(paren
op_amp
id|disp
(braket
id|con
)braket
dot
id|var
comma
op_amp
id|par
)paren
suffix:semicolon
r_return
id|error
ques
c_cond
id|error
suffix:colon
id|fbhw
op_member_access_from_pointer
id|encode_fix
c_func
(paren
id|fix
comma
op_amp
id|par
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;    *    Get the User Defined Part of the Display&n;    */
DECL|function|amiga_fb_get_var
r_static
r_int
id|amiga_fb_get_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
)paren
(brace
r_struct
id|amiga_fb_par
id|par
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|con
op_eq
op_minus
l_int|1
)paren
(brace
id|amiga_fb_get_par
c_func
(paren
op_amp
id|par
)paren
suffix:semicolon
id|error
op_assign
id|fbhw
op_member_access_from_pointer
id|encode_var
c_func
(paren
id|var
comma
op_amp
id|par
)paren
suffix:semicolon
)brace
r_else
op_star
id|var
op_assign
id|disp
(braket
id|con
)braket
dot
id|var
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|amiga_fb_set_disp
r_static
r_void
id|amiga_fb_set_disp
c_func
(paren
r_int
id|con
)paren
(brace
r_struct
id|fb_fix_screeninfo
id|fix
suffix:semicolon
id|amiga_fb_get_fix
c_func
(paren
op_amp
id|fix
comma
id|con
)paren
suffix:semicolon
r_if
c_cond
(paren
id|con
op_eq
op_minus
l_int|1
)paren
id|con
op_assign
l_int|0
suffix:semicolon
id|disp
(braket
id|con
)braket
dot
id|screen_base
op_assign
(paren
id|u_char
op_star
)paren
id|fix.smem_start
suffix:semicolon
id|disp
(braket
id|con
)braket
dot
id|visual
op_assign
id|fix.visual
suffix:semicolon
id|disp
(braket
id|con
)braket
dot
id|type
op_assign
id|fix.type
suffix:semicolon
id|disp
(braket
id|con
)braket
dot
id|type_aux
op_assign
id|fix.type_aux
suffix:semicolon
id|disp
(braket
id|con
)braket
dot
id|ypanstep
op_assign
id|fix.ypanstep
suffix:semicolon
id|disp
(braket
id|con
)braket
dot
id|ywrapstep
op_assign
id|fix.ywrapstep
suffix:semicolon
id|disp
(braket
id|con
)braket
dot
id|line_length
op_assign
id|fix.line_length
suffix:semicolon
id|disp
(braket
id|con
)braket
dot
id|can_soft_blank
op_assign
l_int|1
suffix:semicolon
id|disp
(braket
id|con
)braket
dot
id|inverse
op_assign
id|amifb_inverse
suffix:semicolon
)brace
multiline_comment|/*&n;    *    Set the User Defined Part of the Display&n;    */
DECL|function|amiga_fb_set_var
r_static
r_int
id|amiga_fb_set_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
)paren
(brace
r_int
id|err
comma
id|oldxres
comma
id|oldyres
comma
id|oldvxres
comma
id|oldvyres
comma
id|oldbpp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|do_fb_set_var
c_func
(paren
id|var
comma
id|con
op_eq
id|currcon
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
(paren
id|var-&gt;activate
op_amp
id|FB_ACTIVATE_MASK
)paren
op_eq
id|FB_ACTIVATE_NOW
)paren
(brace
id|oldxres
op_assign
id|disp
(braket
id|con
)braket
dot
id|var.xres
suffix:semicolon
id|oldyres
op_assign
id|disp
(braket
id|con
)braket
dot
id|var.yres
suffix:semicolon
id|oldvxres
op_assign
id|disp
(braket
id|con
)braket
dot
id|var.xres_virtual
suffix:semicolon
id|oldvyres
op_assign
id|disp
(braket
id|con
)braket
dot
id|var.yres_virtual
suffix:semicolon
id|oldbpp
op_assign
id|disp
(braket
id|con
)braket
dot
id|var.bits_per_pixel
suffix:semicolon
id|disp
(braket
id|con
)braket
dot
id|var
op_assign
op_star
id|var
suffix:semicolon
r_if
c_cond
(paren
id|oldxres
op_ne
id|var-&gt;xres
op_logical_or
id|oldyres
op_ne
id|var-&gt;yres
op_logical_or
id|oldvxres
op_ne
id|var-&gt;xres_virtual
op_logical_or
id|oldvyres
op_ne
id|var-&gt;yres_virtual
op_logical_or
id|oldbpp
op_ne
id|var-&gt;bits_per_pixel
)paren
(brace
id|amiga_fb_set_disp
c_func
(paren
id|con
)paren
suffix:semicolon
(paren
op_star
id|fb_info.changevar
)paren
(paren
id|con
)paren
suffix:semicolon
id|alloc_cmap
c_func
(paren
op_amp
id|disp
(braket
id|con
)braket
dot
id|cmap
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|do_install_cmap
c_func
(paren
id|con
)paren
suffix:semicolon
)brace
)brace
id|var-&gt;activate
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;    *    Get the Colormap&n;    */
DECL|function|amiga_fb_get_cmap
r_static
r_int
id|amiga_fb_get_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
)paren
(brace
r_if
c_cond
(paren
id|con
op_eq
id|currcon
)paren
multiline_comment|/* current console? */
r_return
id|do_fb_get_cmap
c_func
(paren
id|cmap
comma
op_amp
id|disp
(braket
id|con
)braket
dot
id|var
comma
id|kspc
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|disp
(braket
id|con
)braket
dot
id|cmap.len
)paren
multiline_comment|/* non default colormap? */
id|copy_cmap
c_func
(paren
op_amp
id|disp
(braket
id|con
)braket
dot
id|cmap
comma
id|cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|2
)paren
suffix:semicolon
r_else
id|copy_cmap
c_func
(paren
id|get_default_colormap
c_func
(paren
id|disp
(braket
id|con
)braket
dot
id|var.bits_per_pixel
)paren
comma
id|cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|2
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;    *    Set the Colormap&n;    */
DECL|function|amiga_fb_set_cmap
r_static
r_int
id|amiga_fb_set_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|disp
(braket
id|con
)braket
dot
id|cmap.len
)paren
(brace
multiline_comment|/* no colormap allocated? */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|alloc_cmap
c_func
(paren
op_amp
id|disp
(braket
id|con
)braket
dot
id|cmap
comma
l_int|1
op_lshift
id|disp
(braket
id|con
)braket
dot
id|var.bits_per_pixel
comma
l_int|0
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|con
op_eq
id|currcon
)paren
multiline_comment|/* current console? */
r_return
id|do_fb_set_cmap
c_func
(paren
id|cmap
comma
op_amp
id|disp
(braket
id|con
)braket
dot
id|var
comma
id|kspc
)paren
suffix:semicolon
r_else
id|copy_cmap
c_func
(paren
id|cmap
comma
op_amp
id|disp
(braket
id|con
)braket
dot
id|cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;    *    Pan or Wrap the Display&n;    *&n;    *    This call looks only at xoffset, yoffset and the FB_VMODE_YWRAP flag&n;    */
DECL|function|amiga_fb_pan_display
r_static
r_int
id|amiga_fb_pan_display
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
)paren
(brace
r_int
id|err
suffix:semicolon
id|u_short
id|oldlatch
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_YWRAP
)paren
(brace
r_if
c_cond
(paren
id|var-&gt;xoffset
op_logical_or
id|var-&gt;yoffset
op_ge
id|disp
(braket
id|con
)braket
dot
id|var.yres
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|var-&gt;xoffset
op_plus
id|disp
(braket
id|con
)braket
dot
id|var.xres
OG
id|disp
(braket
id|con
)braket
dot
id|var.xres_virtual
op_logical_or
id|var-&gt;yoffset
op_plus
id|disp
(braket
id|con
)braket
dot
id|var.yres
OG
id|disp
(braket
id|con
)braket
dot
id|var.yres_virtual
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|con
op_eq
id|currcon
)paren
(brace
id|cli
c_func
(paren
)paren
suffix:semicolon
id|oldlatch
op_assign
id|do_vmode
suffix:semicolon
id|do_vmode
op_assign
l_int|0
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|fbhw
op_member_access_from_pointer
id|pan_display
c_func
(paren
id|var
comma
op_amp
id|current_par
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|oldlatch
)paren
id|do_vmode
op_assign
l_int|1
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|do_vmode
op_assign
l_int|1
suffix:semicolon
)brace
id|disp
(braket
id|con
)braket
dot
id|var.xoffset
op_assign
id|var-&gt;xoffset
suffix:semicolon
id|disp
(braket
id|con
)braket
dot
id|var.yoffset
op_assign
id|var-&gt;yoffset
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_YWRAP
)paren
id|disp
(braket
id|con
)braket
dot
id|var.vmode
op_or_assign
id|FB_VMODE_YWRAP
suffix:semicolon
r_else
id|disp
(braket
id|con
)braket
dot
id|var.vmode
op_and_assign
op_complement
id|FB_VMODE_YWRAP
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;    *    Amiga Frame Buffer Specific ioctls&n;    */
DECL|function|amiga_fb_ioctl
r_static
r_int
id|amiga_fb_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
id|u_int
id|cmd
comma
id|u_long
id|arg
comma
r_int
id|con
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|fb_fix_cursorinfo
id|crsrfix
suffix:semicolon
r_struct
id|fb_var_cursorinfo
id|crsrvar
suffix:semicolon
r_struct
id|fb_cursorstate
id|crsrstate
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
macro_line|#ifdef CONFIG_AMIFB_AGA
r_case
id|FBIOGET_FCURSORINFO
suffix:colon
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|crsrfix
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|i
op_assign
id|amiga_fb_get_fix_cursorinfo
c_func
(paren
op_amp
id|crsrfix
comma
id|con
)paren
suffix:semicolon
id|memcpy_tofs
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|crsrfix
comma
r_sizeof
(paren
id|crsrfix
)paren
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
r_case
id|FBIOGET_VCURSORINFO
suffix:colon
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|crsrvar
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|i
op_assign
id|amiga_fb_get_var_cursorinfo
c_func
(paren
op_amp
id|crsrvar
comma
id|con
)paren
suffix:semicolon
id|memcpy_tofs
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|crsrvar
comma
r_sizeof
(paren
id|crsrvar
)paren
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
r_case
id|FBIOPUT_VCURSORINFO
suffix:colon
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|crsrvar
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
op_amp
id|crsrvar
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|crsrvar
)paren
)paren
suffix:semicolon
id|i
op_assign
id|amiga_fb_set_var_cursorinfo
c_func
(paren
op_amp
id|crsrvar
comma
id|con
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
r_case
id|FBIOGET_CURSORSTATE
suffix:colon
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|crsrstate
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|i
op_assign
id|amiga_fb_get_cursorstate
c_func
(paren
op_amp
id|crsrstate
comma
id|con
)paren
suffix:semicolon
id|memcpy_tofs
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|crsrstate
comma
r_sizeof
(paren
id|crsrstate
)paren
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
r_case
id|FBIOPUT_CURSORSTATE
suffix:colon
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|crsrstate
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
op_amp
id|crsrstate
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|crsrstate
)paren
)paren
suffix:semicolon
id|i
op_assign
id|amiga_fb_set_cursorstate
c_func
(paren
op_amp
id|crsrstate
comma
id|con
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
macro_line|#endif /* CONFIG_AMIFB_AGA */
macro_line|#if 1
r_case
id|FBCMD_GET_CURRENTPAR
suffix:colon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|amiga_fb_par
)paren
)paren
)paren
)paren
r_return
id|i
suffix:semicolon
id|memcpy_tofs
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
op_amp
id|current_par
comma
r_sizeof
(paren
r_struct
id|amiga_fb_par
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FBCMD_SET_CURRENTPAR
suffix:colon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|amiga_fb_par
)paren
)paren
)paren
)paren
r_return
id|i
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|current_par
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|amiga_fb_par
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_AMIFB_AGA
multiline_comment|/*&n;    *    Hardware Cursor&n;    */
DECL|function|amiga_fb_get_fix_cursorinfo
r_static
r_int
id|amiga_fb_get_fix_cursorinfo
c_func
(paren
r_struct
id|fb_fix_cursorinfo
op_star
id|fix
comma
r_int
id|con
)paren
(brace
r_if
c_cond
(paren
id|boot_info.bi_amiga.chipset
op_eq
id|CS_AGA
)paren
r_return
id|aga_get_fix_cursorinfo
c_func
(paren
id|fix
comma
id|con
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|amiga_fb_get_var_cursorinfo
r_static
r_int
id|amiga_fb_get_var_cursorinfo
c_func
(paren
r_struct
id|fb_var_cursorinfo
op_star
id|var
comma
r_int
id|con
)paren
(brace
r_if
c_cond
(paren
id|boot_info.bi_amiga.chipset
op_eq
id|CS_AGA
)paren
r_return
id|aga_get_var_cursorinfo
c_func
(paren
id|var
comma
id|con
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|amiga_fb_set_var_cursorinfo
r_static
r_int
id|amiga_fb_set_var_cursorinfo
c_func
(paren
r_struct
id|fb_var_cursorinfo
op_star
id|var
comma
r_int
id|con
)paren
(brace
r_if
c_cond
(paren
id|boot_info.bi_amiga.chipset
op_eq
id|CS_AGA
)paren
r_return
id|aga_set_var_cursorinfo
c_func
(paren
id|var
comma
id|con
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|amiga_fb_get_cursorstate
r_static
r_int
id|amiga_fb_get_cursorstate
c_func
(paren
r_struct
id|fb_cursorstate
op_star
id|state
comma
r_int
id|con
)paren
(brace
r_if
c_cond
(paren
id|boot_info.bi_amiga.chipset
op_eq
id|CS_AGA
)paren
r_return
id|aga_get_cursorstate
c_func
(paren
id|state
comma
id|con
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|amiga_fb_set_cursorstate
r_static
r_int
id|amiga_fb_set_cursorstate
c_func
(paren
r_struct
id|fb_cursorstate
op_star
id|state
comma
r_int
id|con
)paren
(brace
r_if
c_cond
(paren
id|boot_info.bi_amiga.chipset
op_eq
id|CS_AGA
)paren
r_return
id|aga_set_cursorstate
c_func
(paren
id|state
comma
id|con
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_AMIFB_AGA */
DECL|variable|amiga_fb_ops
r_static
r_struct
id|fb_ops
id|amiga_fb_ops
op_assign
(brace
id|amiga_fb_get_fix
comma
id|amiga_fb_get_var
comma
id|amiga_fb_set_var
comma
id|amiga_fb_get_cmap
comma
id|amiga_fb_set_cmap
comma
id|amiga_fb_pan_display
comma
id|amiga_fb_ioctl
)brace
suffix:semicolon
DECL|function|amiga_video_setup
r_void
id|amiga_video_setup
c_func
(paren
r_char
op_star
id|options
comma
r_int
op_star
id|ints
)paren
(brace
r_char
op_star
id|this_opt
suffix:semicolon
r_int
id|i
suffix:semicolon
r_char
id|mcap_spec
(braket
l_int|80
)braket
suffix:semicolon
multiline_comment|/*&n;    *    Check for a Graphics Board&n;    */
macro_line|#ifdef CONFIG_FB_CYBER
r_if
c_cond
(paren
id|options
op_logical_and
op_star
id|options
)paren
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|options
comma
l_string|&quot;cyber&quot;
comma
l_int|5
)paren
op_logical_and
id|Cyber_probe
c_func
(paren
)paren
)paren
(brace
id|amifb_Cyber
op_assign
l_int|1
suffix:semicolon
id|Cyber_video_setup
c_func
(paren
id|options
comma
id|ints
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_FB_CYBER */
macro_line|#ifdef USE_MONO_AMIFB_IF_NON_AGA
r_if
c_cond
(paren
id|boot_info.bi_amiga.chipset
op_ne
id|CS_AGA
)paren
(brace
id|mono_video_setup
c_func
(paren
id|options
comma
id|ints
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif /* USE_MONO_AMIFB_IF_NON_AGA */
id|mcap_spec
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|fb_info.fontname
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
op_logical_or
op_logical_neg
op_star
id|options
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|this_opt
op_assign
id|strtok
c_func
(paren
id|options
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
id|this_opt
suffix:semicolon
id|this_opt
op_assign
id|strtok
c_func
(paren
l_int|NULL
comma
l_string|&quot;,&quot;
)paren
)paren
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_opt
comma
l_string|&quot;inverse&quot;
)paren
)paren
(brace
id|amifb_inverse
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|red16
(braket
id|i
)braket
op_assign
op_complement
id|red16
(braket
id|i
)braket
suffix:semicolon
id|green16
(braket
id|i
)braket
op_assign
op_complement
id|green16
(braket
id|i
)braket
suffix:semicolon
id|blue16
(braket
id|i
)braket
op_assign
op_complement
id|blue16
(braket
id|i
)braket
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|red8
(braket
id|i
)braket
op_assign
op_complement
id|red8
(braket
id|i
)braket
suffix:semicolon
id|green8
(braket
id|i
)braket
op_assign
op_complement
id|green8
(braket
id|i
)braket
suffix:semicolon
id|blue8
(braket
id|i
)braket
op_assign
op_complement
id|blue8
(braket
id|i
)braket
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|red4
(braket
id|i
)braket
op_assign
op_complement
id|red4
(braket
id|i
)braket
suffix:semicolon
id|green4
(braket
id|i
)braket
op_assign
op_complement
id|green4
(braket
id|i
)braket
suffix:semicolon
id|blue4
(braket
id|i
)braket
op_assign
op_complement
id|blue4
(braket
id|i
)braket
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|red2
(braket
id|i
)braket
op_assign
op_complement
id|red2
(braket
id|i
)braket
suffix:semicolon
id|green2
(braket
id|i
)braket
op_assign
op_complement
id|green2
(braket
id|i
)braket
suffix:semicolon
id|blue2
(braket
id|i
)braket
op_assign
op_complement
id|blue2
(braket
id|i
)braket
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_opt
comma
l_string|&quot;ilbm&quot;
)paren
)paren
id|amifb_ilbm
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_opt
comma
l_string|&quot;pwrsave&quot;
)paren
)paren
id|pwrsave
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;monitorcap:&quot;
comma
l_int|11
)paren
)paren
id|strcpy
c_func
(paren
id|mcap_spec
comma
id|this_opt
op_plus
l_int|11
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;font:&quot;
comma
l_int|5
)paren
)paren
id|strcpy
c_func
(paren
id|fb_info.fontname
comma
id|this_opt
op_plus
l_int|5
)paren
suffix:semicolon
r_else
id|amifb_mode
op_assign
id|get_video_mode
c_func
(paren
id|this_opt
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|mcap_spec
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
r_int
id|vmin
comma
id|vmax
comma
id|hmin
comma
id|hmax
suffix:semicolon
multiline_comment|/* Format for monitor capabilities is: &lt;Vmin&gt;;&lt;Vmax&gt;;&lt;Hmin&gt;;&lt;Hmax&gt;&n;       * &lt;V*&gt; vertical freq. in Hz&n;       * &lt;H*&gt; horizontal freq. in kHz&n;       */
r_if
c_cond
(paren
op_logical_neg
(paren
id|p
op_assign
id|strtoke
c_func
(paren
id|mcap_spec
comma
l_string|&quot;;&quot;
)paren
)paren
op_logical_or
op_logical_neg
op_star
id|p
)paren
r_goto
id|cap_invalid
suffix:semicolon
id|vmin
op_assign
id|simple_strtoul
c_func
(paren
id|p
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vmin
op_le
l_int|0
)paren
r_goto
id|cap_invalid
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|p
op_assign
id|strtoke
c_func
(paren
l_int|NULL
comma
l_string|&quot;;&quot;
)paren
)paren
op_logical_or
op_logical_neg
op_star
id|p
)paren
r_goto
id|cap_invalid
suffix:semicolon
id|vmax
op_assign
id|simple_strtoul
c_func
(paren
id|p
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vmax
op_le
l_int|0
op_logical_or
id|vmax
op_le
id|vmin
)paren
r_goto
id|cap_invalid
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|p
op_assign
id|strtoke
c_func
(paren
l_int|NULL
comma
l_string|&quot;;&quot;
)paren
)paren
op_logical_or
op_logical_neg
op_star
id|p
)paren
r_goto
id|cap_invalid
suffix:semicolon
id|hmin
op_assign
l_int|1000
op_star
id|simple_strtoul
c_func
(paren
id|p
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hmin
op_le
l_int|0
)paren
r_goto
id|cap_invalid
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|p
op_assign
id|strtoke
c_func
(paren
l_int|NULL
comma
l_string|&quot;&quot;
)paren
)paren
op_logical_or
op_logical_neg
op_star
id|p
)paren
r_goto
id|cap_invalid
suffix:semicolon
id|hmax
op_assign
l_int|1000
op_star
id|simple_strtoul
c_func
(paren
id|p
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hmax
op_le
l_int|0
op_logical_or
id|hmax
op_le
id|hmin
)paren
r_goto
id|cap_invalid
suffix:semicolon
id|vfmin
op_assign
id|vmin
suffix:semicolon
id|vfmax
op_assign
id|vmax
suffix:semicolon
id|hfmin
op_assign
id|hmin
suffix:semicolon
id|hfmax
op_assign
id|hmax
suffix:semicolon
id|cap_invalid
suffix:colon
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;    *    Initialization&n;    */
DECL|function|amiga_fb_init
r_struct
id|fb_info
op_star
id|amiga_fb_init
c_func
(paren
r_int
op_star
id|mem_start
)paren
(brace
r_int
id|err
comma
id|tag
comma
id|i
suffix:semicolon
r_struct
id|fb_var_screeninfo
op_star
id|var
suffix:semicolon
multiline_comment|/*&n;    *    Check for a Graphics Board&n;    */
macro_line|#ifdef CONFIG_FB_CYBER
r_if
c_cond
(paren
id|amifb_Cyber
)paren
r_return
id|Cyber_fb_init
c_func
(paren
id|mem_start
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_FB_CYBER */
multiline_comment|/*&n;    *    Use the Builtin Chipset&n;    */
r_if
c_cond
(paren
op_logical_neg
id|AMIGAHW_PRESENT
c_func
(paren
id|AMI_VIDEO
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
macro_line|#ifdef USE_MONO_AMIFB_IF_NON_AGA
r_if
c_cond
(paren
id|boot_info.bi_amiga.chipset
op_ne
id|CS_AGA
)paren
r_return
id|mono_amiga_fb_init
c_func
(paren
id|mem_start
)paren
suffix:semicolon
macro_line|#endif /* USE_MONO_AMIFB_IF_NON_AGA */
r_switch
c_cond
(paren
id|boot_info.bi_amiga.chipset
)paren
(brace
macro_line|#ifdef CONFIG_AMIFB_OCS
r_case
id|CS_OCS
suffix:colon
id|strcat
c_func
(paren
id|amiga_fb_name
comma
l_string|&quot;OCS&quot;
)paren
suffix:semicolon
id|default_chipset
suffix:colon
id|fbhw
op_assign
op_amp
id|ocs_switch
suffix:semicolon
id|maxdepth
(braket
id|TAG_SHRES
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* OCS means no SHRES */
id|maxdepth
(braket
id|TAG_HIRES
op_minus
l_int|1
)braket
op_assign
l_int|4
suffix:semicolon
id|maxdepth
(braket
id|TAG_LORES
op_minus
l_int|1
)braket
op_assign
l_int|6
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif /* CONFIG_AMIFB_OCS */
macro_line|#ifdef CONFIG_AMIFB_ECS
r_case
id|CS_ECS
suffix:colon
id|strcat
c_func
(paren
id|amiga_fb_name
comma
l_string|&quot;ECS&quot;
)paren
suffix:semicolon
id|fbhw
op_assign
op_amp
id|ecs_switch
suffix:semicolon
id|maxdepth
(braket
id|TAG_SHRES
op_minus
l_int|1
)braket
op_assign
l_int|2
suffix:semicolon
id|maxdepth
(braket
id|TAG_HIRES
op_minus
l_int|1
)braket
op_assign
l_int|4
suffix:semicolon
id|maxdepth
(braket
id|TAG_LORES
op_minus
l_int|1
)braket
op_assign
l_int|6
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif /* CONFIG_AMIFB_ECS */
macro_line|#ifdef CONFIG_AMIFB_AGA
r_case
id|CS_AGA
suffix:colon
id|strcat
c_func
(paren
id|amiga_fb_name
comma
l_string|&quot;AGA&quot;
)paren
suffix:semicolon
id|fbhw
op_assign
op_amp
id|aga_switch
suffix:semicolon
id|maxdepth
(braket
id|TAG_SHRES
op_minus
l_int|1
)braket
op_assign
l_int|8
suffix:semicolon
id|maxdepth
(braket
id|TAG_HIRES
op_minus
l_int|1
)braket
op_assign
l_int|8
suffix:semicolon
id|maxdepth
(braket
id|TAG_LORES
op_minus
l_int|1
)braket
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif /* CONFIG_AMIFB_AGA */
r_default
suffix:colon
macro_line|#ifdef CONFIG_AMIFB_OCS
id|printk
c_func
(paren
l_string|&quot;Unknown graphics chipset, defaulting to OCS&bslash;n&quot;
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|amiga_fb_name
comma
l_string|&quot;Unknown&quot;
)paren
suffix:semicolon
r_goto
id|default_chipset
suffix:semicolon
macro_line|#else /* CONFIG_AMIFB_OCS */
id|panic
c_func
(paren
l_string|&quot;Unknown graphics chipset, no default driver&quot;
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_AMIFB_OCS */
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;    *    Calculate the Pixel Clock Values for this Machine&n;    */
id|pixclock
(braket
id|TAG_SHRES
op_minus
l_int|1
)braket
op_assign
l_float|25E9
op_div
id|amiga_eclock
suffix:semicolon
multiline_comment|/* SHRES:  35 ns / 28 MHz */
id|pixclock
(braket
id|TAG_HIRES
op_minus
l_int|1
)braket
op_assign
l_float|50E9
op_div
id|amiga_eclock
suffix:semicolon
multiline_comment|/* HIRES:  70 ns / 14 MHz */
id|pixclock
(braket
id|TAG_LORES
op_minus
l_int|1
)braket
op_assign
l_float|100E9
op_div
id|amiga_eclock
suffix:semicolon
multiline_comment|/* LORES: 140 ns /  7 MHz */
multiline_comment|/*&n;    *    Replace the Tag Values with the Real Pixel Clock Values&n;    */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_PREDEF_MODES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tag
op_assign
id|amiga_fb_predefined
(braket
id|i
)braket
dot
id|pixclock
suffix:semicolon
r_if
c_cond
(paren
id|tag
op_eq
id|TAG_SHRES
op_logical_or
id|tag
op_eq
id|TAG_HIRES
op_logical_or
id|tag
op_eq
id|TAG_LORES
)paren
(brace
id|amiga_fb_predefined
(braket
id|i
)braket
dot
id|pixclock
op_assign
id|pixclock
(braket
id|tag
op_minus
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|amiga_fb_predefined
(braket
id|i
)braket
dot
id|bits_per_pixel
OG
id|maxdepth
(braket
id|tag
op_minus
l_int|1
)braket
)paren
id|amiga_fb_predefined
(braket
id|i
)braket
dot
id|bits_per_pixel
op_assign
id|maxdepth
(braket
id|tag
op_minus
l_int|1
)braket
suffix:semicolon
)brace
)brace
id|err
op_assign
id|register_framebuffer
c_func
(paren
id|amiga_fb_name
comma
op_amp
id|node
comma
op_amp
id|amiga_fb_ops
comma
id|NUM_TOTAL_MODES
comma
id|amiga_fb_predefined
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
id|panic
c_func
(paren
l_string|&quot;Cannot register frame buffer&quot;
)paren
suffix:semicolon
id|fbhw
op_member_access_from_pointer
id|init
c_func
(paren
)paren
suffix:semicolon
id|check_default_mode
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|add_isr
c_func
(paren
id|IRQ_AMIGA_VERTB
comma
id|amifb_interrupt
comma
l_int|0
comma
l_int|NULL
comma
l_string|&quot;frame buffer&quot;
)paren
)paren
id|panic
c_func
(paren
l_string|&quot;Couldn&squot;t add vblank interrupt&quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|fb_info.modename
comma
id|amiga_fb_name
)paren
suffix:semicolon
id|fb_info.disp
op_assign
id|disp
suffix:semicolon
id|fb_info.switch_con
op_assign
op_amp
id|amifb_switch
suffix:semicolon
id|fb_info.updatevar
op_assign
op_amp
id|amifb_updatevar
suffix:semicolon
id|fb_info.blank
op_assign
op_amp
id|amifb_blank
suffix:semicolon
id|var
op_assign
op_amp
id|amiga_fb_predefined
(braket
id|amifb_mode
)braket
suffix:semicolon
id|do_fb_set_var
c_func
(paren
id|var
comma
l_int|1
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|fb_info.modename
comma
l_string|&quot; &quot;
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|fb_info.modename
comma
id|amiga_fb_modenames
(braket
id|amifb_mode
)braket
)paren
suffix:semicolon
id|amiga_fb_get_var
c_func
(paren
op_amp
id|disp
(braket
l_int|0
)braket
dot
id|var
comma
op_minus
l_int|1
)paren
suffix:semicolon
id|amiga_fb_set_disp
c_func
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|do_install_cmap
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_return
op_amp
id|fb_info
suffix:semicolon
)brace
DECL|function|amifb_switch
r_static
r_int
id|amifb_switch
c_func
(paren
r_int
id|con
)paren
(brace
multiline_comment|/* Do we have to save the colormap? */
r_if
c_cond
(paren
id|disp
(braket
id|currcon
)braket
dot
id|cmap.len
)paren
id|do_fb_get_cmap
c_func
(paren
op_amp
id|disp
(braket
id|currcon
)braket
dot
id|cmap
comma
op_amp
id|disp
(braket
id|currcon
)braket
dot
id|var
comma
l_int|1
)paren
suffix:semicolon
id|do_fb_set_var
c_func
(paren
op_amp
id|disp
(braket
id|con
)braket
dot
id|var
comma
l_int|1
)paren
suffix:semicolon
id|currcon
op_assign
id|con
suffix:semicolon
multiline_comment|/* Install new colormap */
id|do_install_cmap
c_func
(paren
id|con
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;    *    Update the `var&squot; structure (called by fbcon.c)&n;    *&n;    *    This call looks only at yoffset and the FB_VMODE_YWRAP flag in `var&squot;.&n;    *    Since it&squot;s called by a kernel driver, no range checking is done.&n;    */
DECL|function|amifb_updatevar
r_static
r_int
id|amifb_updatevar
c_func
(paren
r_int
id|con
)paren
(brace
id|do_vmode
op_assign
l_int|0
suffix:semicolon
id|current_par.yoffset
op_assign
id|disp
(braket
id|con
)braket
dot
id|var.yoffset
suffix:semicolon
id|current_par.vmode
op_assign
id|disp
(braket
id|con
)braket
dot
id|var.vmode
suffix:semicolon
id|current_par.bplpt0
op_assign
id|ZTWO_PADDR
c_func
(paren
(paren
id|u_long
)paren
id|videomemory
op_plus
id|current_par.yoffset
op_star
id|current_par.next_line
)paren
suffix:semicolon
id|do_vmode
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;    *    Blank the display.&n;    */
DECL|function|amifb_blank
r_static
r_void
id|amifb_blank
c_func
(paren
r_int
id|blank
)paren
(brace
id|do_blank
op_assign
id|blank
ques
c_cond
l_int|1
suffix:colon
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;    *    VBlank Display Interrupt&n;    */
DECL|function|amifb_interrupt
r_static
r_void
id|amifb_interrupt
c_func
(paren
r_int
id|irq
comma
r_struct
id|pt_regs
op_star
id|fp
comma
r_void
op_star
id|dummy
)paren
(brace
r_static
r_int
id|is_laced
op_assign
l_int|0
suffix:semicolon
macro_line|#if 0
multiline_comment|/*&n;    *    This test should be here, in case current_par isn&squot;t initialized yet&n;    *&n;    *    Fortunately only do_flashcursor() will be called in that case, and&n;    *    currently that function doesn&squot;t use current_par. But this may change&n;    *    in future...&n;    */
r_if
c_cond
(paren
op_logical_neg
id|current_par_valid
)paren
r_return
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;    *    If interlaced, only change the display on a long frame&n;    */
r_if
c_cond
(paren
op_logical_neg
id|is_laced
op_logical_or
id|custom.vposr
op_amp
l_int|0x8000
)paren
(brace
r_if
c_cond
(paren
id|do_vmode
)paren
(brace
id|fbhw
op_member_access_from_pointer
id|do_vmode
c_func
(paren
)paren
suffix:semicolon
id|do_vmode
op_assign
l_int|0
suffix:semicolon
id|is_laced
op_assign
(paren
id|current_par.vmode
op_amp
id|FB_VMODE_MASK
)paren
op_eq
id|FB_VMODE_INTERLACED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|do_movecursor
)paren
(brace
id|fbhw
op_member_access_from_pointer
id|do_movecursor
c_func
(paren
)paren
suffix:semicolon
id|do_movecursor
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|do_blank
)paren
(brace
id|fbhw
op_member_access_from_pointer
id|do_blank
c_func
(paren
id|do_blank
OG
l_int|0
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|do_blank
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|is_blanked
)paren
id|fbhw
op_member_access_from_pointer
id|do_flashcursor
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;    *    A strtok which returns empty strings, too&n;    */
DECL|function|strtoke
r_static
r_char
op_star
id|strtoke
c_func
(paren
r_char
op_star
id|s
comma
r_const
r_char
op_star
id|ct
)paren
(brace
r_char
op_star
id|sbegin
comma
op_star
id|send
suffix:semicolon
r_static
r_char
op_star
id|ssave
op_assign
l_int|NULL
suffix:semicolon
id|sbegin
op_assign
id|s
ques
c_cond
id|s
suffix:colon
id|ssave
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sbegin
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_star
id|sbegin
op_eq
l_char|&squot;&bslash;0&squot;
)paren
(brace
id|ssave
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|send
op_assign
id|strpbrk
c_func
(paren
id|sbegin
comma
id|ct
)paren
suffix:semicolon
r_if
c_cond
(paren
id|send
op_logical_and
op_star
id|send
op_ne
l_char|&squot;&bslash;0&squot;
)paren
op_star
id|send
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|ssave
op_assign
id|send
suffix:semicolon
r_return
id|sbegin
suffix:semicolon
)brace
multiline_comment|/*&n;    *    Get a Video Modes&n;    */
DECL|function|get_video_mode
r_static
r_int
id|get_video_mode
c_func
(paren
r_const
r_char
op_star
id|name
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|NUM_PREDEF_MODES
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|name
comma
id|amiga_fb_modenames
(braket
id|i
)braket
)paren
)paren
r_return
id|i
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;    *    Check the Default Video Mode&n;    */
DECL|function|check_default_mode
r_static
r_void
id|check_default_mode
c_func
(paren
r_void
)paren
(brace
r_struct
id|fb_var_screeninfo
id|var
suffix:semicolon
multiline_comment|/* First check the user supplied or system default video mode */
r_if
c_cond
(paren
id|amifb_mode
)paren
(brace
id|var
op_assign
id|amiga_fb_predefined
(braket
id|amifb_mode
)braket
suffix:semicolon
id|var.activate
op_assign
id|FB_ACTIVATE_TEST
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|do_fb_set_var
c_func
(paren
op_amp
id|var
comma
l_int|1
)paren
)paren
r_goto
id|found_video_mode
suffix:semicolon
)brace
multiline_comment|/* Try some other modes... */
id|printk
c_func
(paren
l_string|&quot;Can&squot;t use default video mode. Probing video modes...&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|amifb_mode
op_assign
l_int|1
suffix:semicolon
id|amifb_mode
OL
id|NUM_PREDEF_MODES
suffix:semicolon
id|amifb_mode
op_increment
)paren
(brace
id|var
op_assign
id|amiga_fb_predefined
(braket
id|amifb_mode
)braket
suffix:semicolon
id|var.activate
op_assign
id|FB_ACTIVATE_TEST
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|do_fb_set_var
c_func
(paren
op_amp
id|var
comma
l_int|1
)paren
)paren
r_goto
id|found_video_mode
suffix:semicolon
)brace
id|panic
c_func
(paren
l_string|&quot;Can&squot;t find any usable video mode&quot;
)paren
suffix:semicolon
id|found_video_mode
suffix:colon
id|amiga_fb_predefined
(braket
l_int|0
)braket
op_assign
id|var
suffix:semicolon
)brace
eof
