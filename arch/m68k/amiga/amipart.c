multiline_comment|/*&n; * linux/amiga/amipart.c&n; *&n; * Amiga partition checking driver for 680x0 Linux&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file README.legal in the main directory of this archive&n; * for more details.&n; */
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/genhd.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;asm/amigardb.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
r_extern
r_int
id|current_minor
suffix:semicolon
DECL|function|checksum
r_static
id|ulong
id|checksum
(paren
id|ulong
op_star
id|ptr
comma
r_int
id|len
)paren
(brace
id|ulong
id|sum
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_for
c_loop
(paren
id|sum
op_assign
l_int|0
comma
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|len
suffix:semicolon
id|cnt
op_increment
)paren
id|sum
op_add_assign
id|ptr
(braket
id|cnt
)braket
suffix:semicolon
r_return
id|sum
suffix:semicolon
)brace
multiline_comment|/* XXX */
multiline_comment|/* int current_minor = 0; */
DECL|function|amiga_check_partition
r_void
id|amiga_check_partition
c_func
(paren
r_struct
id|gendisk
op_star
id|hd
comma
id|kdev_t
id|dev
)paren
(brace
r_int
id|i
comma
id|minor
op_assign
id|current_minor
comma
id|m_lim
op_assign
id|current_minor
op_plus
id|hd-&gt;max_p
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_struct
id|RigidDiskBlock
op_star
id|rdb
suffix:semicolon
r_struct
id|PartitionBlock
op_star
id|pb
suffix:semicolon
id|ulong
id|bnum
comma
id|partsect
suffix:semicolon
r_for
c_loop
(paren
id|bnum
op_assign
l_int|0
suffix:semicolon
id|bnum
OL
id|RDB_LOCATION_LIMIT
op_div
l_int|2
suffix:semicolon
id|bnum
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|bh
op_assign
id|bread
c_func
(paren
id|dev
comma
id|bnum
comma
l_int|1024
)paren
)paren
)paren
(brace
id|printk
(paren
l_string|&quot; unable to read block %ld&bslash;n&quot;
comma
id|bnum
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
id|printk
(paren
l_string|&quot;block read, press mousebutton to continue&bslash;n&quot;
)paren
suffix:semicolon
id|waitbut
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|rdb
op_assign
(paren
r_struct
id|RigidDiskBlock
op_star
)paren
id|bh-&gt;b_data
suffix:semicolon
r_if
c_cond
(paren
id|rdb-&gt;rdb_ID
op_eq
id|IDNAME_RIGIDDISK
)paren
r_break
suffix:semicolon
id|rdb
op_assign
(paren
r_struct
id|RigidDiskBlock
op_star
)paren
op_amp
id|bh-&gt;b_data
(braket
l_int|512
)braket
suffix:semicolon
r_if
c_cond
(paren
id|rdb-&gt;rdb_ID
op_eq
id|IDNAME_RIGIDDISK
)paren
r_break
suffix:semicolon
id|brelse
(paren
id|bh
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bnum
op_eq
id|RDB_LOCATION_LIMIT
op_div
l_int|2
)paren
(brace
multiline_comment|/* no RDB on the disk! */
id|printk
(paren
l_string|&quot; unable to find RigidDiskBlock&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* checksum the RigidDiskBlock */
r_if
c_cond
(paren
id|checksum
(paren
(paren
id|ulong
op_star
)paren
id|rdb
comma
id|rdb-&gt;rdb_SummedLongs
)paren
op_ne
l_int|0
)paren
(brace
id|printk
(paren
l_string|&quot; RDB checksum bad&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;  %s%c:&quot;
comma
id|hd-&gt;major_name
comma
l_char|&squot;a&squot;
op_plus
(paren
id|minor
op_rshift
id|hd-&gt;minor_shift
)paren
)paren
suffix:semicolon
id|partsect
op_assign
id|rdb-&gt;rdb_PartitionList
suffix:semicolon
id|brelse
(paren
id|bh
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|minor
OL
id|m_lim
op_logical_and
id|partsect
op_ne
l_int|0xffffffff
suffix:semicolon
id|minor
op_increment
comma
id|i
op_increment
)paren
(brace
id|ulong
op_star
id|env
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bh
op_assign
id|bread
c_func
(paren
id|dev
comma
id|partsect
op_div
l_int|2
comma
l_int|1024
)paren
)paren
)paren
(brace
id|printk
(paren
l_string|&quot; block %ld read failed&bslash;n&quot;
comma
id|partsect
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
id|printk
(paren
l_string|&quot;block read, press mousebutton to continue&bslash;n&quot;
)paren
suffix:semicolon
id|waitbut
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|pb
op_assign
(paren
r_struct
id|PartitionBlock
op_star
)paren
id|bh-&gt;b_data
suffix:semicolon
r_if
c_cond
(paren
id|partsect
op_amp
l_int|1
)paren
id|pb
op_assign
(paren
r_struct
id|PartitionBlock
op_star
)paren
op_amp
id|bh-&gt;b_data
(braket
l_int|512
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pb-&gt;pb_ID
op_ne
id|IDNAME_PARTITION
)paren
(brace
id|printk
(paren
l_string|&quot; block %ld Not a partition block (%#lx)&bslash;n&quot;
comma
id|partsect
comma
id|pb-&gt;pb_ID
)paren
suffix:semicolon
id|brelse
(paren
id|bh
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|checksum
(paren
(paren
id|ulong
op_star
)paren
id|pb
comma
id|pb-&gt;pb_SummedLongs
)paren
op_ne
l_int|0
)paren
(brace
id|printk
(paren
l_string|&quot; block %ld checksum bad&bslash;n&quot;
comma
id|partsect
)paren
suffix:semicolon
id|brelse
(paren
id|bh
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|env
op_assign
id|pb-&gt;pb_Environment
suffix:semicolon
id|hd-&gt;part
(braket
id|minor
)braket
dot
id|start_sect
op_assign
id|env
(braket
id|DE_LOWCYL
)braket
op_star
id|env
(braket
id|DE_NUMHEADS
)braket
op_star
id|env
(braket
id|DE_BLKSPERTRACK
)braket
suffix:semicolon
id|hd-&gt;part
(braket
id|minor
)braket
dot
id|nr_sects
op_assign
(paren
id|env
(braket
id|DE_UPPERCYL
)braket
op_minus
id|env
(braket
id|DE_LOWCYL
)braket
op_plus
l_int|1
)paren
op_star
id|env
(braket
id|DE_NUMHEADS
)braket
op_star
id|env
(braket
id|DE_BLKSPERTRACK
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; %s%c%d&quot;
comma
id|hd-&gt;major_name
comma
l_char|&squot;a&squot;
op_plus
(paren
id|minor
op_rshift
id|hd-&gt;minor_shift
)paren
comma
id|i
)paren
suffix:semicolon
id|partsect
op_assign
id|pb-&gt;pb_Next
suffix:semicolon
id|brelse
(paren
id|bh
)paren
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
eof
