multiline_comment|/* $Id: idprom.c,v 1.22 1996/11/13 05:09:25 davem Exp $&n; * idprom.c: Routines to load the idprom into kernel addresses and&n; *           interpret the data contained within.&n; *&n; * Copyright (C) 1995 David S. Miller (davem@caip.rutgers.edu)&n; * Sun3/3x models added by David Monro (davidm@psrg.cs.usyd.edu.au)&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/idprom.h&gt;
macro_line|#include &lt;asm/machines.h&gt;  /* Fun with Sun released architectures. */
DECL|variable|idprom
r_struct
id|idprom
op_star
id|idprom
suffix:semicolon
DECL|variable|idprom_buffer
r_static
r_struct
id|idprom
id|idprom_buffer
suffix:semicolon
multiline_comment|/* Here is the master table of Sun machines which use some implementation&n; * of the Sparc CPU and have a meaningful IDPROM machtype value that we&n; * know about.  See asm-sparc/machines.h for empirical constants.&n; */
DECL|variable|Sun_Machines
r_struct
id|Sun_Machine_Models
id|Sun_Machines
(braket
id|NUM_SUN_MACHINES
)braket
op_assign
(brace
multiline_comment|/* First, Sun3&squot;s */
(brace
l_string|&quot;Sun 3/160 Series&quot;
comma
(paren
id|SM_SUN3
op_or
id|SM_3_160
)paren
)brace
comma
(brace
l_string|&quot;Sun 3/50&quot;
comma
(paren
id|SM_SUN3
op_or
id|SM_3_50
)paren
)brace
comma
(brace
l_string|&quot;Sun 3/260 Series&quot;
comma
(paren
id|SM_SUN3
op_or
id|SM_3_260
)paren
)brace
comma
(brace
l_string|&quot;Sun 3/110 Series&quot;
comma
(paren
id|SM_SUN3
op_or
id|SM_3_110
)paren
)brace
comma
(brace
l_string|&quot;Sun 3/60&quot;
comma
(paren
id|SM_SUN3
op_or
id|SM_3_60
)paren
)brace
comma
(brace
l_string|&quot;Sun 3/E&quot;
comma
(paren
id|SM_SUN3
op_or
id|SM_3_E
)paren
)brace
comma
multiline_comment|/* Now, Sun3x&squot;s */
(brace
l_string|&quot;Sun 3/460 Series&quot;
comma
(paren
id|SM_SUN3
op_or
id|SM_3_460
)paren
)brace
comma
(brace
l_string|&quot;Sun 3/80&quot;
comma
(paren
id|SM_SUN3
op_or
id|SM_3_80
)paren
)brace
comma
multiline_comment|/* Then, Sun4&squot;s */
singleline_comment|//{ &quot;Sun 4/100 Series&quot;, (SM_SUN4 | SM_4_110) },
singleline_comment|//{ &quot;Sun 4/200 Series&quot;, (SM_SUN4 | SM_4_260) },
singleline_comment|//{ &quot;Sun 4/300 Series&quot;, (SM_SUN4 | SM_4_330) },
singleline_comment|//{ &quot;Sun 4/400 Series&quot;, (SM_SUN4 | SM_4_470) },
multiline_comment|/* And now, Sun4c&squot;s */
singleline_comment|//{ &quot;Sun4c SparcStation 1&quot;, (SM_SUN4C | SM_4C_SS1) },
singleline_comment|//{ &quot;Sun4c SparcStation IPC&quot;, (SM_SUN4C | SM_4C_IPC) },
singleline_comment|//{ &quot;Sun4c SparcStation 1+&quot;, (SM_SUN4C | SM_4C_SS1PLUS) },
singleline_comment|//{ &quot;Sun4c SparcStation SLC&quot;, (SM_SUN4C | SM_4C_SLC) },
singleline_comment|//{ &quot;Sun4c SparcStation 2&quot;, (SM_SUN4C | SM_4C_SS2) },
singleline_comment|//{ &quot;Sun4c SparcStation ELC&quot;, (SM_SUN4C | SM_4C_ELC) },
singleline_comment|//{ &quot;Sun4c SparcStation IPX&quot;, (SM_SUN4C | SM_4C_IPX) },
multiline_comment|/* Finally, early Sun4m&squot;s */
singleline_comment|//{ &quot;Sun4m SparcSystem600&quot;, (SM_SUN4M | SM_4M_SS60) },
singleline_comment|//{ &quot;Sun4m SparcStation10/20&quot;, (SM_SUN4M | SM_4M_SS50) },
singleline_comment|//{ &quot;Sun4m SparcStation5&quot;, (SM_SUN4M | SM_4M_SS40) },
multiline_comment|/* One entry for the OBP arch&squot;s which are sun4d, sun4e, and newer sun4m&squot;s */
singleline_comment|//{ &quot;Sun4M OBP based system&quot;, (SM_SUN4M_OBP | 0x0) }
)brace
suffix:semicolon
DECL|function|display_system_type
r_static
r_void
id|__init
id|display_system_type
c_func
(paren
r_int
r_char
id|machtype
)paren
(brace
r_register
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_SUN_MACHINES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|Sun_Machines
(braket
id|i
)braket
dot
id|id_machtype
op_eq
id|machtype
)paren
(brace
r_if
c_cond
(paren
id|machtype
op_ne
(paren
id|SM_SUN4M_OBP
op_or
l_int|0x00
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;TYPE: %s&bslash;n&quot;
comma
id|Sun_Machines
(braket
id|i
)braket
dot
id|name
)paren
suffix:semicolon
r_else
(brace
macro_line|#if 0
id|prom_getproperty
c_func
(paren
id|prom_root_node
comma
l_string|&quot;banner-name&quot;
comma
id|sysname
comma
r_sizeof
(paren
id|sysname
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TYPE: %s&bslash;n&quot;
comma
id|sysname
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;
)brace
r_return
suffix:semicolon
)brace
)brace
id|prom_printf
c_func
(paren
l_string|&quot;IDPROM: Bogus id_machtype value, 0x%x&bslash;n&quot;
comma
id|machtype
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|sun3_get_model
r_void
id|sun3_get_model
c_func
(paren
r_int
r_char
op_star
id|model
)paren
(brace
r_register
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_SUN_MACHINES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|Sun_Machines
(braket
id|i
)braket
dot
id|id_machtype
op_eq
id|idprom-&gt;id_machtype
)paren
(brace
id|strcpy
c_func
(paren
id|model
comma
id|Sun_Machines
(braket
id|i
)braket
dot
id|name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Calculate the IDPROM checksum (xor of the data bytes). */
DECL|function|calc_idprom_cksum
r_static
r_int
r_char
id|__init
id|calc_idprom_cksum
c_func
(paren
r_struct
id|idprom
op_star
id|idprom
)paren
(brace
r_int
r_char
id|cksum
comma
id|i
comma
op_star
id|ptr
op_assign
(paren
r_int
r_char
op_star
)paren
id|idprom
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|cksum
op_assign
l_int|0
suffix:semicolon
id|i
op_le
l_int|0x0E
suffix:semicolon
id|i
op_increment
)paren
id|cksum
op_xor_assign
op_star
id|ptr
op_increment
suffix:semicolon
r_return
id|cksum
suffix:semicolon
)brace
multiline_comment|/* Create a local IDPROM copy, verify integrity, and display information. */
DECL|function|idprom_init
r_void
id|__init
id|idprom_init
c_func
(paren
r_void
)paren
(brace
id|prom_get_idprom
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|idprom_buffer
comma
r_sizeof
(paren
id|idprom_buffer
)paren
)paren
suffix:semicolon
id|idprom
op_assign
op_amp
id|idprom_buffer
suffix:semicolon
r_if
c_cond
(paren
id|idprom-&gt;id_format
op_ne
l_int|0x01
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;IDPROM: Unknown format type!&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|idprom-&gt;id_cksum
op_ne
id|calc_idprom_cksum
c_func
(paren
id|idprom
)paren
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;IDPROM: Checksum failure (nvram=%x, calc=%x)!&bslash;n&quot;
comma
id|idprom-&gt;id_cksum
comma
id|calc_idprom_cksum
c_func
(paren
id|idprom
)paren
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|display_system_type
c_func
(paren
id|idprom-&gt;id_machtype
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Ethernet address: %x:%x:%x:%x:%x:%x&bslash;n&quot;
comma
id|idprom-&gt;id_ethaddr
(braket
l_int|0
)braket
comma
id|idprom-&gt;id_ethaddr
(braket
l_int|1
)braket
comma
id|idprom-&gt;id_ethaddr
(braket
l_int|2
)braket
comma
id|idprom-&gt;id_ethaddr
(braket
l_int|3
)braket
comma
id|idprom-&gt;id_ethaddr
(braket
l_int|4
)braket
comma
id|idprom-&gt;id_ethaddr
(braket
l_int|5
)braket
)paren
suffix:semicolon
)brace
eof
