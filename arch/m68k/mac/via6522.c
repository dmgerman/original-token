multiline_comment|/*&n; *&t;6522 Versatile Interface Adapter (VIA)&n; *&n; *&t;There are two of these on the Mac II. Some IRQ&squot;s are vectored&n; *&t;via them as are assorted bits and bobs - eg rtc, adb.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/macintosh.h&gt; 
macro_line|#include &lt;asm/macints.h&gt; 
macro_line|#include &quot;via6522.h&quot;
DECL|variable|via1
r_volatile
r_int
r_char
op_star
id|via1
op_assign
(paren
r_int
r_char
op_star
)paren
id|VIABASE
suffix:semicolon
DECL|variable|via2
r_volatile
r_int
r_char
op_star
id|via2
op_assign
(paren
r_int
r_char
op_star
)paren
id|VIABASE2
suffix:semicolon
DECL|variable|via1_clock
DECL|variable|via1_datab
r_int
r_char
id|via1_clock
comma
id|via1_datab
suffix:semicolon
DECL|variable|rbv
r_static
r_int
id|rbv
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; * Debugging the VBL ints&n; */
r_extern
r_int
id|console_loglevel
suffix:semicolon
multiline_comment|/*&n; *&t;VIA1 - hardwired vectors&n; */
macro_line|#if 0 /* gone to macints.[ch] */
r_extern
r_void
id|via_wtf
c_func
(paren
r_int
id|slot
comma
r_void
op_star
id|via
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|via_do_nubus
c_func
(paren
r_int
id|slot
comma
r_volatile
r_void
op_star
id|via
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_extern
r_void
id|adb_interrupt
c_func
(paren
r_int
id|slot
comma
r_void
op_star
id|via
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_struct
id|via_irq_tab
id|via1_func_tab
op_assign
(brace
(brace
id|via_wtf
comma
multiline_comment|/* One second interrupt */
id|via_wtf
comma
multiline_comment|/* Vblank */
id|via_wtf
comma
multiline_comment|/* ADB data ready */
id|via_wtf
comma
multiline_comment|/* ADB data */
id|via_wtf
comma
multiline_comment|/* ADB clock */
id|via_wtf
comma
id|via_wtf
comma
multiline_comment|/* Slot 6 is replaced by the timer */
id|via_wtf
)brace
)brace
suffix:semicolon
r_static
r_struct
id|via_irq_tab
id|via2_func_tab
op_assign
(brace
(brace
id|via_wtf
comma
id|via_do_nubus
comma
id|via_wtf
comma
id|via_wtf
comma
id|via_wtf
comma
id|via_wtf
comma
id|via_wtf
comma
id|via_wtf
)brace
)brace
suffix:semicolon
r_static
r_struct
id|via_irq_tab
id|nubus_func_tab
op_assign
(brace
(brace
id|via_wtf
comma
id|via_wtf
comma
id|via_wtf
comma
id|via_wtf
comma
id|via_wtf
comma
id|via_wtf
comma
id|via_wtf
comma
id|via_wtf
)brace
)brace
suffix:semicolon
macro_line|#endif
r_extern
r_void
id|adb_interrupt
c_func
(paren
r_int
id|slot
comma
r_void
op_star
id|via
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
DECL|macro|MAC_CLOCK_TICK
mdefine_line|#define MAC_CLOCK_TICK&t;&t;(783300/HZ)&t;/* ticks per HZ */
DECL|macro|MAC_CLOCK_LOW
mdefine_line|#define MAC_CLOCK_LOW&t;&t;(MAC_CLOCK_TICK&amp;0xFF)
DECL|macro|MAC_CLOCK_HIGH
mdefine_line|#define MAC_CLOCK_HIGH&t;&t;(MAC_CLOCK_TICK&gt;&gt;8)
DECL|function|via_init_clock
r_void
id|via_init_clock
c_func
(paren
r_void
(paren
op_star
id|func
)paren
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
)paren
(brace
r_int
r_char
id|c
suffix:semicolon
multiline_comment|/*&t;mac_debugging_penguin(6);*/
r_switch
c_cond
(paren
id|macintosh_config-&gt;via_type
)paren
(brace
multiline_comment|/*&n;&t;&t; *      CI, SI, VX, LC &n;&t;&t; */
r_case
id|MAC_VIA_IIci
suffix:colon
id|via1
op_assign
(paren
r_void
op_star
)paren
l_int|0x50F00000
suffix:semicolon
id|via2
op_assign
(paren
r_void
op_star
)paren
l_int|0x50F26000
suffix:semicolon
id|rbv
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t; *      Quadra and early MacIIs agree on the VIA locations&n;&t;&t; */
r_case
id|MAC_VIA_QUADRA
suffix:colon
r_case
id|MAC_VIA_II
suffix:colon
id|via1
op_assign
(paren
r_void
op_star
)paren
l_int|0x50F00000
suffix:semicolon
id|via2
op_assign
(paren
r_void
op_star
)paren
l_int|0x50F02000
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
)brace
id|via1_clock
op_assign
id|via_read
c_func
(paren
id|via1
comma
id|vACR
)paren
suffix:semicolon
id|via1_datab
op_assign
id|via_read
c_func
(paren
id|via1
comma
id|vBufB
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Tell what MacOS left us with&n;&t; */
id|printk
c_func
(paren
l_string|&quot;via_init: boot via1 acr=%X pcr=%X buf_a=%X dir_a=%X buf_b=%X dir_b=%X &bslash;n&quot;
comma
(paren
r_int
)paren
id|via1_clock
comma
(paren
r_int
)paren
id|via_read
c_func
(paren
id|via1
comma
id|vPCR
)paren
comma
(paren
r_int
)paren
id|via_read
c_func
(paren
id|via1
comma
id|vBufA
)paren
comma
(paren
r_int
)paren
id|via_read
c_func
(paren
id|via1
comma
id|vDirA
)paren
comma
(paren
r_int
)paren
id|via_read
c_func
(paren
id|via1
comma
id|vBufB
)paren
comma
(paren
r_int
)paren
id|via_read
c_func
(paren
id|via1
comma
id|vDirB
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rbv
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;via_init: boot via2 acr=%X pcr=%X buf_a=%X dir_a=%X buf_b=%X dir_b=%X &bslash;n&quot;
comma
(paren
r_int
)paren
id|via_read
c_func
(paren
id|via2
comma
id|vACR
)paren
comma
(paren
r_int
)paren
id|via_read
c_func
(paren
id|via2
comma
id|vPCR
)paren
comma
(paren
r_int
)paren
id|via_read
c_func
(paren
id|via2
comma
id|vBufA
)paren
comma
(paren
r_int
)paren
id|via_read
c_func
(paren
id|via2
comma
id|vDirA
)paren
comma
(paren
r_int
)paren
id|via_read
c_func
(paren
id|via2
comma
id|vBufB
)paren
comma
(paren
r_int
)paren
id|via_read
c_func
(paren
id|via2
comma
id|vDirB
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Shut it down&n;&t; */
id|via_write
c_func
(paren
id|via1
comma
id|vIER
comma
l_int|0x7F
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Kill the timers&n;&t; */
id|via_write
c_func
(paren
id|via1
comma
id|vT1LL
comma
l_int|0
)paren
suffix:semicolon
id|via_write
c_func
(paren
id|via1
comma
id|vT1LH
comma
l_int|0
)paren
suffix:semicolon
id|via_write
c_func
(paren
id|via1
comma
id|vT1CL
comma
l_int|0
)paren
suffix:semicolon
id|via_write
c_func
(paren
id|via1
comma
id|vT1CH
comma
l_int|0
)paren
suffix:semicolon
id|via_write
c_func
(paren
id|via1
comma
id|vT2CL
comma
l_int|0
)paren
suffix:semicolon
id|via_write
c_func
(paren
id|via1
comma
id|vT2CH
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Now do via2&n;&t; */
r_if
c_cond
(paren
id|rbv
op_eq
l_int|0
)paren
(brace
id|via_write
c_func
(paren
id|via2
comma
id|vT1LL
comma
l_int|0
)paren
suffix:semicolon
id|via_write
c_func
(paren
id|via2
comma
id|vT1LH
comma
l_int|0
)paren
suffix:semicolon
id|via_write
c_func
(paren
id|via2
comma
id|vT1CL
comma
l_int|0
)paren
suffix:semicolon
id|via_write
c_func
(paren
id|via2
comma
id|vT1CH
comma
l_int|0
)paren
suffix:semicolon
id|via_write
c_func
(paren
id|via2
comma
id|vT2CL
comma
l_int|0
)paren
suffix:semicolon
id|via_write
c_func
(paren
id|via2
comma
id|vT2CH
comma
l_int|0
)paren
suffix:semicolon
id|via_write
c_func
(paren
id|via2
comma
id|vIER
comma
l_int|0x7F
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; *&t;Init the RBV chip a bit&n;&t;&t; */
id|via_write
c_func
(paren
id|via2
comma
id|rIER
comma
l_int|0x7F
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Disable the timer latches&n;&t; */
id|c
op_assign
id|via_read
c_func
(paren
id|via1
comma
id|vACR
)paren
suffix:semicolon
id|via_write
c_func
(paren
id|via1
comma
id|vACR
comma
id|c
op_amp
l_int|0x3F
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rbv
op_eq
l_int|0
)paren
(brace
id|c
op_assign
id|via_read
c_func
(paren
id|via2
comma
id|vACR
)paren
suffix:semicolon
id|via_write
c_func
(paren
id|via2
comma
id|vACR
comma
id|c
op_amp
l_int|0x3F
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Now start the clock - we want 100Hz&n;&t; */
id|via_write
c_func
(paren
id|via1
comma
id|vACR
comma
id|via_read
c_func
(paren
id|via1
comma
id|vACR
)paren
op_or
l_int|0x40
)paren
suffix:semicolon
id|via_write
c_func
(paren
id|via1
comma
id|vT1LL
comma
id|MAC_CLOCK_LOW
)paren
suffix:semicolon
id|via_write
c_func
(paren
id|via1
comma
id|vT1LH
comma
id|MAC_CLOCK_HIGH
)paren
suffix:semicolon
id|via_write
c_func
(paren
id|via1
comma
id|vT1CL
comma
id|MAC_CLOCK_LOW
)paren
suffix:semicolon
id|via_write
c_func
(paren
id|via1
comma
id|vT1CH
comma
id|MAC_CLOCK_HIGH
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;And enable its interrupt&n;&t; */
id|request_irq
c_func
(paren
id|IRQ_MAC_TIMER_1
comma
id|func
comma
id|IRQ_FLG_LOCK
comma
l_string|&quot;timer&quot;
comma
id|func
)paren
suffix:semicolon
multiline_comment|/*&t;mac_debugging_penguin(7);*/
multiline_comment|/* &n;&t; * SE/30: disable video int. &n;&t; * XXX: testing for SE/30 VBL&n;&t; */
r_if
c_cond
(paren
id|macintosh_config-&gt;ident
op_eq
id|MAC_MODEL_SE30
op_logical_and
id|console_loglevel
op_ne
l_int|10
)paren
(brace
id|c
op_assign
id|via_read
c_func
(paren
id|via1
comma
id|vBufB
)paren
suffix:semicolon
id|via_write
c_func
(paren
id|via1
comma
id|vBufB
comma
id|c
op_or
(paren
l_int|0x40
)paren
)paren
suffix:semicolon
id|c
op_assign
id|via_read
c_func
(paren
id|via1
comma
id|vDirB
)paren
suffix:semicolon
id|via_write
c_func
(paren
id|via1
comma
id|vDirB
comma
id|c
op_or
(paren
l_int|0x40
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * XXX: use positive edge&n;&t; */
r_if
c_cond
(paren
id|console_loglevel
op_eq
l_int|10
)paren
(brace
id|c
op_assign
id|via_read
c_func
(paren
id|via1
comma
id|vPCR
)paren
suffix:semicolon
id|via_write
c_func
(paren
id|via1
comma
id|vPCR
comma
id|c
op_or
(paren
l_int|0x1
)paren
)paren
suffix:semicolon
)brace
macro_line|#if 0 /* gone to mac_init_IRQ */
multiline_comment|/*&n;&t; * Set vPCR for SCSI interrupts.&n;&t; *&n;&t; * That is: CA1 negative edge int., CA2 indep., positive edge int.;&n;&t; *&t;    CB1 negative edge int., CB2 indep., positive edge int..&n;&t; */
id|via_write
c_func
(paren
id|via2
comma
id|vPCR
comma
l_int|0x66
)paren
suffix:semicolon
macro_line|#endif                                                                  
)brace
macro_line|#if 0 /* moved to macints.c */
r_static
r_void
id|via_irq
c_func
(paren
r_volatile
r_int
r_char
op_star
id|via
comma
r_struct
id|via_irq_tab
op_star
id|irqtab
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_char
id|events
op_assign
(paren
id|via_read
c_func
(paren
id|via
comma
id|vIFR
)paren
op_amp
id|via_read
c_func
(paren
id|via
comma
id|vIER
)paren
)paren
op_amp
l_int|0x7F
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|ct
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Shouldnt happen&n;&t; */
r_if
c_cond
(paren
id|events
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;via_irq: nothing pending!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_do
(brace
multiline_comment|/*&n;&t;&t; *&t;Clear the pending flag&n;&t;&t; */
multiline_comment|/* HACK HACK - FIXME !!! - just testing some keyboard ideas */
multiline_comment|/* events&amp;=~(1&lt;&lt;4); */
id|via_write
c_func
(paren
id|via
comma
id|vIFR
comma
id|events
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Now see what bits are raised&n;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|events
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
(brace
(paren
id|irqtab-&gt;vector
(braket
id|i
)braket
)paren
(paren
id|i
comma
id|via
comma
id|regs
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;&t; *&t;And done..&n;&t;&t; */
id|events
op_assign
(paren
id|via_read
c_func
(paren
id|via
comma
id|vIFR
)paren
op_amp
id|via_read
c_func
(paren
id|via
comma
id|vIER
)paren
)paren
op_amp
l_int|0x7F
suffix:semicolon
id|ct
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|events
op_logical_and
id|ct
OG
l_int|8
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;via: stuck events %x&bslash;n&quot;
comma
id|events
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|events
)paren
(brace
suffix:semicolon
)brace
id|scsi_mac_polled
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&n; *&t;The RBV is different. RBV appears to stand for randomly broken&n; *&t;VIA.&n; */
r_static
r_void
id|rbv_irq
c_func
(paren
r_volatile
r_int
r_char
op_star
id|via
comma
r_struct
id|via_irq_tab
op_star
id|irqtab
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_char
id|events
op_assign
(paren
id|via_read
c_func
(paren
id|via
comma
id|rIFR
)paren
op_amp
id|via_read
c_func
(paren
id|via
comma
id|rIER
)paren
)paren
op_amp
l_int|0x7F
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|ct
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Shouldnt happen&n;&t; */
r_if
c_cond
(paren
id|events
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;rbv_irq: nothing pending!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_do
(brace
multiline_comment|/*&n;&t;&t; *&t;Clear the pending flag&n;&t;&t; */
multiline_comment|/* HACK HACK - FIXME !!! - just testing some keyboard ideas */
multiline_comment|/* events&amp;=~(1&lt;&lt;4); */
id|via_write
c_func
(paren
id|via
comma
id|rIFR
comma
id|events
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Now see what bits are raised&n;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|events
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
(brace
(paren
id|irqtab-&gt;vector
(braket
id|i
)braket
)paren
(paren
id|i
comma
id|via
comma
id|regs
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;&t; *&t;And done..&n;&t;&t; */
id|events
op_assign
(paren
id|via_read
c_func
(paren
id|via
comma
id|rIFR
)paren
op_amp
id|via_read
c_func
(paren
id|via
comma
id|rIER
)paren
)paren
op_amp
l_int|0x7F
suffix:semicolon
id|ct
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|events
op_logical_and
id|ct
OG
l_int|8
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;rbv: stuck events %x&bslash;n&quot;
comma
id|events
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|events
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;rbv - bashing source %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|via_write
c_func
(paren
id|via
comma
id|rIER
comma
id|i
)paren
suffix:semicolon
id|via_write
c_func
(paren
id|via
comma
id|rIFR
comma
id|i
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|events
)paren
(brace
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;System interrupts&n; */
r_void
id|via1_irq
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|via_irq
c_func
(paren
id|via1
comma
op_amp
id|via1_func_tab
comma
id|regs
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Nubus interrupts&n; */
r_void
id|via2_irq
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
multiline_comment|/*&t;printk(&quot;via2 interrupt&bslash;n&quot;);*/
r_if
c_cond
(paren
id|rbv
)paren
(brace
id|rbv_irq
c_func
(paren
id|via2
comma
op_amp
id|via2_func_tab
comma
id|regs
)paren
suffix:semicolon
)brace
r_else
id|via_irq
c_func
(paren
id|via2
comma
op_amp
id|via2_func_tab
comma
id|regs
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Unexpected via interrupt&n; */
r_void
id|via_wtf
c_func
(paren
r_int
id|slot
comma
r_volatile
r_void
op_star
id|via
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Unexpected event %d on via %p&bslash;n&quot;
comma
id|slot
comma
id|via
)paren
suffix:semicolon
)brace
r_void
id|nubus_wtf
c_func
(paren
r_int
id|slot
comma
r_volatile
r_void
op_star
id|via
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Unexpected interrupt on nubus slot %d&bslash;n&quot;
comma
id|slot
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; *&t;The power switch - yes its software!&n; */
DECL|function|mac_reset
r_void
id|mac_reset
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|rbv
)paren
(brace
id|via_write
c_func
(paren
id|via2
comma
id|rBufB
comma
id|via_read
c_func
(paren
id|via2
comma
id|rBufB
)paren
op_amp
op_complement
l_int|0x04
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Direction of vDirB is output */
id|via_write
c_func
(paren
id|via2
comma
id|vDirB
comma
id|via_read
c_func
(paren
id|via2
comma
id|vDirB
)paren
op_or
l_int|0x04
)paren
suffix:semicolon
multiline_comment|/* Send a value of 0 on that line */
id|via_write
c_func
(paren
id|via2
comma
id|vBufB
comma
id|via_read
c_func
(paren
id|via2
comma
id|vBufB
)paren
op_amp
op_complement
l_int|0x04
)paren
suffix:semicolon
)brace
multiline_comment|/* We never make it this far... */
multiline_comment|/* XXX - delay do we need to spin here ? */
r_while
c_loop
(paren
l_int|1
)paren
(brace
suffix:semicolon
)brace
multiline_comment|/* Just in case .. */
)brace
multiline_comment|/*&n; *&t;Set up the keyboard&n; */
DECL|function|via_setup_keyboard
r_void
id|via_setup_keyboard
c_func
(paren
r_void
)paren
(brace
macro_line|#if 0 /* moved to adb */
id|via1_func_tab.vector
(braket
l_int|2
)braket
op_assign
id|adb_interrupt
suffix:semicolon
macro_line|#else
id|request_irq
c_func
(paren
id|IRQ_MAC_ADB
comma
id|adb_interrupt
comma
id|IRQ_FLG_LOCK
comma
l_string|&quot;adb interrupt&quot;
comma
id|adb_interrupt
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; *&t;Floppy hook&n; */
DECL|function|via1_set_head
r_void
id|via1_set_head
c_func
(paren
r_int
id|head
)paren
(brace
r_if
c_cond
(paren
id|head
op_eq
l_int|0
)paren
(brace
id|via_write
c_func
(paren
id|via1
comma
id|vBufA
comma
id|via_read
c_func
(paren
id|via1
comma
id|vBufA
)paren
op_amp
op_complement
l_int|0x20
)paren
suffix:semicolon
)brace
r_else
id|via_write
c_func
(paren
id|via1
comma
id|vBufA
comma
id|via_read
c_func
(paren
id|via1
comma
id|vBufA
)paren
op_or
l_int|0x20
)paren
suffix:semicolon
)brace
macro_line|#if 0 /* moved to macints.c */
multiline_comment|/*&n; *    Set up the SCSI&n; */
r_void
id|via_scsi_disable
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|rbv
)paren
id|via_write
c_func
(paren
id|via2
comma
id|rIER
comma
(paren
l_int|1
op_lshift
l_int|3
)paren
op_or
(paren
l_int|1
op_lshift
l_int|0
)paren
)paren
suffix:semicolon
r_else
id|via_write
c_func
(paren
id|via2
comma
id|vIER
comma
(paren
l_int|1
op_lshift
l_int|3
)paren
op_or
(paren
l_int|1
op_lshift
l_int|0
)paren
)paren
suffix:semicolon
)brace
r_void
id|via_scsi_enable
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|rbv
)paren
id|via_write
c_func
(paren
id|via2
comma
id|rIER
comma
(paren
l_int|1
op_lshift
l_int|3
)paren
op_or
(paren
l_int|1
op_lshift
l_int|0
)paren
op_or
l_int|0x80
)paren
suffix:semicolon
r_else
id|via_write
c_func
(paren
id|via2
comma
id|vIER
comma
(paren
l_int|1
op_lshift
l_int|3
)paren
op_or
(paren
l_int|1
op_lshift
l_int|0
)paren
op_or
l_int|0x80
)paren
suffix:semicolon
)brace
r_void
id|via_scsi_clear
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|rbv
)paren
id|via_write
c_func
(paren
id|via2
comma
id|rIFR
comma
(paren
l_int|1
op_lshift
l_int|3
)paren
op_or
(paren
l_int|1
op_lshift
l_int|0
)paren
op_or
l_int|0x80
)paren
suffix:semicolon
r_volatile
r_int
r_char
id|deep_magic
op_assign
id|via_read
c_func
(paren
id|via2
comma
id|vBufB
)paren
suffix:semicolon
id|via_scsi_enable
c_func
(paren
)paren
suffix:semicolon
)brace
r_void
id|via_setup_scsi
c_func
(paren
r_void
(paren
op_star
id|handler
)paren
(paren
r_int
comma
r_volatile
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
)paren
(brace
id|via2_func_tab.vector
(braket
l_int|0
)braket
op_assign
id|handler
suffix:semicolon
multiline_comment|/* SCSI DRQ */
id|via2_func_tab.vector
(braket
l_int|3
)braket
op_assign
id|handler
suffix:semicolon
multiline_comment|/* SCSI IRQ */
id|via_write
c_func
(paren
id|via2
comma
id|vPCR
comma
l_int|0x66
)paren
suffix:semicolon
multiline_comment|/* Edge direction! */
id|via_scsi_enable
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Nubus handling&n; */
r_static
r_int
id|nubus_active
op_assign
l_int|0
suffix:semicolon
r_int
id|nubus_request_irq
c_func
(paren
r_int
id|slot
comma
r_void
(paren
op_star
id|handler
)paren
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
)paren
(brace
id|slot
op_sub_assign
l_int|9
suffix:semicolon
multiline_comment|/*&t;printk(&quot;Nubus request irq for slot %d&bslash;n&quot;,slot);*/
r_if
c_cond
(paren
id|nubus_func_tab.vector
(braket
id|slot
)braket
op_eq
id|nubus_wtf
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|nubus_func_tab.vector
(braket
id|slot
)braket
op_assign
id|handler
suffix:semicolon
id|nubus_active
op_or_assign
l_int|1
op_lshift
id|slot
suffix:semicolon
multiline_comment|/*&t;printk(&quot;program slot %d&bslash;n&quot;,slot);*/
multiline_comment|/*&t;printk(&quot;via2=%p&bslash;n&quot;,via2);*/
macro_line|#if 0
id|via_write
c_func
(paren
id|via2
comma
id|vDirA
comma
id|via_read
c_func
(paren
id|via2
comma
id|vDirA
)paren
op_or
(paren
l_int|1
op_lshift
id|slot
)paren
)paren
suffix:semicolon
id|via_write
c_func
(paren
id|via2
comma
id|vBufA
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif&t;&t;
r_if
c_cond
(paren
op_logical_neg
id|rbv
)paren
(brace
multiline_comment|/* Make sure the bit is an input */
id|via_write
c_func
(paren
id|via2
comma
id|vDirA
comma
id|via_read
c_func
(paren
id|via2
comma
id|vDirA
)paren
op_amp
op_complement
(paren
l_int|1
op_lshift
id|slot
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&t;printk(&quot;nubus irq on&bslash;n&quot;);*/
r_return
l_int|0
suffix:semicolon
)brace
r_int
id|nubus_free_irq
c_func
(paren
r_int
id|slot
)paren
(brace
id|slot
op_sub_assign
l_int|9
suffix:semicolon
id|nubus_active
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|slot
)paren
suffix:semicolon
id|nubus_func_tab.vector
(braket
id|slot
)braket
op_assign
id|nubus_wtf
suffix:semicolon
r_if
c_cond
(paren
id|rbv
)paren
(brace
id|via_write
c_func
(paren
id|via2
comma
id|rBufA
comma
l_int|1
op_lshift
id|slot
)paren
suffix:semicolon
)brace
r_else
(brace
id|via_write
c_func
(paren
id|via2
comma
id|vDirA
comma
id|via_read
c_func
(paren
id|via2
comma
id|vDirA
)paren
op_or
(paren
l_int|1
op_lshift
id|slot
)paren
)paren
suffix:semicolon
id|via_write
c_func
(paren
id|via2
comma
id|vBufA
comma
l_int|1
op_lshift
id|slot
)paren
suffix:semicolon
id|via_write
c_func
(paren
id|via2
comma
id|vDirA
comma
id|via_read
c_func
(paren
id|via2
comma
id|vDirA
)paren
op_amp
op_complement
(paren
l_int|1
op_lshift
id|slot
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
id|via_do_nubus
c_func
(paren
r_int
id|slot
comma
r_volatile
r_void
op_star
id|via
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_char
id|map
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|ct
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&t;printk(&quot;nubus interrupt&bslash;n&quot;);*/
r_if
c_cond
(paren
id|rbv
)paren
(brace
id|via_write
c_func
(paren
id|via2
comma
id|rIFR
comma
l_int|0x82
)paren
suffix:semicolon
multiline_comment|/* lock the nubus interrupt */
)brace
r_else
(brace
id|via_write
c_func
(paren
id|via2
comma
id|vIFR
comma
l_int|0x82
)paren
suffix:semicolon
multiline_comment|/* lock the nubus interrupt */
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|rbv
)paren
(brace
id|map
op_assign
op_complement
id|via_read
c_func
(paren
id|via2
comma
id|rBufA
)paren
suffix:semicolon
)brace
r_else
id|map
op_assign
op_complement
id|via_read
c_func
(paren
id|via2
comma
id|vBufA
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|map
op_assign
(paren
id|map
op_amp
id|nubus_active
)paren
)paren
op_eq
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ct
op_increment
OG
l_int|2
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nubus stuck events - %d/%d&bslash;n&quot;
comma
id|map
comma
id|nubus_active
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|map
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
(brace
(paren
id|nubus_func_tab.vector
(braket
id|i
)braket
)paren
(paren
id|i
op_plus
l_int|9
comma
id|via
comma
id|regs
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|rbv
)paren
id|via_write
c_func
(paren
id|via2
comma
id|rIFR
comma
l_int|0x02
)paren
suffix:semicolon
multiline_comment|/* clear it */
r_else
id|via_write
c_func
(paren
id|via2
comma
id|vIFR
comma
l_int|0x02
)paren
suffix:semicolon
multiline_comment|/* clear it */
)brace
multiline_comment|/* And done */
)brace
macro_line|#endif
DECL|function|nubus_init_via
r_void
id|nubus_init_via
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|rbv
)paren
(brace
id|via_write
c_func
(paren
id|via2
comma
id|rBufB
comma
id|via_read
c_func
(paren
id|via2
comma
id|rBufB
)paren
op_or
l_int|0x02
)paren
suffix:semicolon
id|via_write
c_func
(paren
id|via2
comma
id|rIER
comma
l_int|0x82
)paren
suffix:semicolon
multiline_comment|/* Interrupts on */
)brace
r_else
(brace
multiline_comment|/* Assert the nubus active */
id|via_write
c_func
(paren
id|via2
comma
id|vDirB
comma
id|via_read
c_func
(paren
id|via2
comma
id|vDirB
)paren
op_or
l_int|0x02
)paren
suffix:semicolon
id|via_write
c_func
(paren
id|via2
comma
id|vBufB
comma
id|via_read
c_func
(paren
id|via2
comma
id|vBufB
)paren
op_or
l_int|0x02
)paren
suffix:semicolon
multiline_comment|/* Make the nubus interrupt source register all output (disable) */
multiline_comment|/* via_write(via2, vDirA, 0xFF); */
id|via_write
c_func
(paren
id|via2
comma
id|vIER
comma
l_int|0x82
)paren
suffix:semicolon
multiline_comment|/* Interrupts on */
)brace
id|printk
c_func
(paren
l_string|&quot;BTW  boot via1 acr=%X datab=%X pcr=%X&bslash;n&quot;
comma
(paren
r_int
)paren
id|via1_clock
comma
(paren
r_int
)paren
id|via1_datab
comma
(paren
r_int
)paren
id|via_read
c_func
(paren
id|via1
comma
id|vPCR
)paren
)paren
suffix:semicolon
)brace
eof
