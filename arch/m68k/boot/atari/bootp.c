macro_line|#include &lt;stdio.h&gt;
macro_line|#include &lt;stdlib.h&gt;
macro_line|#include &lt;string.h&gt;
macro_line|#include &lt;unistd.h&gt;
macro_line|#include &quot;bootp.h&quot;
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&t;&t;&t;&t;&t;&t;  Protocol Header Structures&t;&t;&t;&t;&t; */
DECL|struct|etherhdr
r_struct
id|etherhdr
(brace
DECL|member|dst_addr
id|HWADDR
id|dst_addr
suffix:semicolon
DECL|member|src_addr
id|HWADDR
id|src_addr
suffix:semicolon
DECL|member|type
r_int
r_int
id|type
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|arphdr
r_struct
id|arphdr
(brace
DECL|member|hrd
r_int
r_int
id|hrd
suffix:semicolon
multiline_comment|/* format of hardware address&t;*/
DECL|member|pro
r_int
r_int
id|pro
suffix:semicolon
multiline_comment|/* format of protocol address&t;*/
DECL|member|hln
r_int
r_char
id|hln
suffix:semicolon
multiline_comment|/* length of hardware address&t;*/
DECL|member|pln
r_int
r_char
id|pln
suffix:semicolon
multiline_comment|/* length of protocol address&t;*/
DECL|member|op
r_int
r_int
id|op
suffix:semicolon
multiline_comment|/* ARP opcode (command)&t;&t;&t;*/
DECL|member|addr
r_int
r_char
id|addr
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* addresses (var len)&t;&t;&t;*/
)brace
suffix:semicolon
DECL|struct|iphdr
r_struct
id|iphdr
(brace
DECL|member|version
r_int
r_char
id|version
suffix:colon
l_int|4
suffix:semicolon
DECL|member|ihl
r_int
r_char
id|ihl
suffix:colon
l_int|4
suffix:semicolon
DECL|member|tos
r_int
r_char
id|tos
suffix:semicolon
DECL|member|tot_len
r_int
r_int
id|tot_len
suffix:semicolon
DECL|member|id
r_int
r_int
id|id
suffix:semicolon
DECL|member|frag_off
r_int
r_int
id|frag_off
suffix:semicolon
DECL|member|ttl
r_int
r_char
id|ttl
suffix:semicolon
DECL|member|protocol
r_int
r_char
id|protocol
suffix:semicolon
DECL|member|chksum
r_int
r_int
id|chksum
suffix:semicolon
DECL|member|src_addr
id|IPADDR
id|src_addr
suffix:semicolon
DECL|member|dst_addr
id|IPADDR
id|dst_addr
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|udphdr
r_struct
id|udphdr
(brace
DECL|member|src_port
r_int
r_int
id|src_port
suffix:semicolon
DECL|member|dst_port
r_int
r_int
id|dst_port
suffix:semicolon
DECL|member|len
r_int
r_int
id|len
suffix:semicolon
DECL|member|chksum
r_int
r_int
id|chksum
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|bootp
r_struct
id|bootp
(brace
DECL|member|op
r_int
r_char
id|op
suffix:semicolon
multiline_comment|/* packet opcode type */
DECL|member|htype
r_int
r_char
id|htype
suffix:semicolon
multiline_comment|/* hardware addr type */
DECL|member|hlen
r_int
r_char
id|hlen
suffix:semicolon
multiline_comment|/* hardware addr length */
DECL|member|hops
r_int
r_char
id|hops
suffix:semicolon
multiline_comment|/* gateway hops */
DECL|member|xid
r_int
r_int
id|xid
suffix:semicolon
multiline_comment|/* transaction ID */
DECL|member|secs
r_int
r_int
id|secs
suffix:semicolon
multiline_comment|/* seconds since boot began */
DECL|member|unused
r_int
r_int
id|unused
suffix:semicolon
DECL|member|ciaddr
id|IPADDR
id|ciaddr
suffix:semicolon
multiline_comment|/* client IP address */
DECL|member|yiaddr
id|IPADDR
id|yiaddr
suffix:semicolon
multiline_comment|/* &squot;your&squot; IP address */
DECL|member|siaddr
id|IPADDR
id|siaddr
suffix:semicolon
multiline_comment|/* server IP address */
DECL|member|giaddr
id|IPADDR
id|giaddr
suffix:semicolon
multiline_comment|/* gateway IP address */
DECL|member|chaddr
r_int
r_char
id|chaddr
(braket
l_int|16
)braket
suffix:semicolon
multiline_comment|/* client hardware address */
DECL|member|sname
r_int
r_char
id|sname
(braket
l_int|64
)braket
suffix:semicolon
multiline_comment|/* server host name */
DECL|member|file
r_int
r_char
id|file
(braket
l_int|128
)braket
suffix:semicolon
multiline_comment|/* boot file name */
DECL|member|vend
r_int
r_char
id|vend
(braket
l_int|64
)braket
suffix:semicolon
multiline_comment|/* vendor-specific area */
)brace
suffix:semicolon
DECL|struct|tftp_req
r_struct
id|tftp_req
(brace
DECL|member|opcode
r_int
r_int
id|opcode
suffix:semicolon
DECL|member|name
r_char
id|name
(braket
l_int|512
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|tftp_data
r_struct
id|tftp_data
(brace
DECL|member|opcode
r_int
r_int
id|opcode
suffix:semicolon
DECL|member|nr
r_int
r_int
id|nr
suffix:semicolon
DECL|member|data
r_int
r_char
id|data
(braket
l_int|512
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|tftp_ack
r_struct
id|tftp_ack
(brace
DECL|member|opcode
r_int
r_int
id|opcode
suffix:semicolon
DECL|member|nr
r_int
r_int
id|nr
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|tftp_error
r_struct
id|tftp_error
(brace
DECL|member|opcode
r_int
r_int
id|opcode
suffix:semicolon
DECL|member|errcode
r_int
r_int
id|errcode
suffix:semicolon
DECL|member|str
r_char
id|str
(braket
l_int|512
)braket
suffix:semicolon
)brace
suffix:semicolon
r_typedef
r_struct
(brace
DECL|member|ether
r_struct
id|etherhdr
id|ether
suffix:semicolon
DECL|member|arp
r_struct
id|arphdr
id|arp
suffix:semicolon
DECL|typedef|ARP
)brace
id|ARP
suffix:semicolon
r_typedef
r_struct
(brace
DECL|member|ether
r_struct
id|etherhdr
id|ether
suffix:semicolon
DECL|member|ip
r_struct
id|iphdr
id|ip
suffix:semicolon
DECL|member|udp
r_struct
id|udphdr
id|udp
suffix:semicolon
DECL|typedef|UDP
)brace
id|UDP
suffix:semicolon
DECL|macro|UDP_BOOTPS
mdefine_line|#define&t;UDP_BOOTPS&t;67
DECL|macro|UDP_BOOTPC
mdefine_line|#define&t;UDP_BOOTPC&t;68
DECL|macro|UDP_TFTP
mdefine_line|#define&t;UDP_TFTP&t;69
r_typedef
r_struct
(brace
DECL|member|ether
r_struct
id|etherhdr
id|ether
suffix:semicolon
DECL|member|ip
r_struct
id|iphdr
id|ip
suffix:semicolon
DECL|member|udp
r_struct
id|udphdr
id|udp
suffix:semicolon
DECL|member|bootp
r_struct
id|bootp
id|bootp
suffix:semicolon
DECL|typedef|BOOTP
)brace
id|BOOTP
suffix:semicolon
DECL|macro|BOOTREQUEST
mdefine_line|#define&t;BOOTREQUEST&t;&t;1
DECL|macro|BOOTREPLY
mdefine_line|#define&t;BOOTREPLY&t;&t;2
DECL|macro|BOOTP_RETRYS
mdefine_line|#define&t;BOOTP_RETRYS&t;5
r_typedef
r_struct
(brace
DECL|member|ether
r_struct
id|etherhdr
id|ether
suffix:semicolon
DECL|member|ip
r_struct
id|iphdr
id|ip
suffix:semicolon
DECL|member|udp
r_struct
id|udphdr
id|udp
suffix:semicolon
DECL|union|tftp
r_union
id|tftp
(brace
DECL|member|opcode
r_int
r_int
id|opcode
suffix:semicolon
DECL|member|req
r_struct
id|tftp_req
id|req
suffix:semicolon
DECL|member|data
r_struct
id|tftp_data
id|data
suffix:semicolon
DECL|member|ack
r_struct
id|tftp_ack
id|ack
suffix:semicolon
DECL|member|error
r_struct
id|tftp_error
id|error
suffix:semicolon
DECL|member|tftp
)brace
id|tftp
suffix:semicolon
DECL|typedef|TFTP
)brace
id|TFTP
suffix:semicolon
DECL|macro|TFTP_RRQ
mdefine_line|#define&t;TFTP_RRQ&t;1
DECL|macro|TFTP_WRQ
mdefine_line|#define&t;TFTP_WRQ&t;2
DECL|macro|TFTP_DATA
mdefine_line|#define&t;TFTP_DATA&t;3
DECL|macro|TFTP_ACK
mdefine_line|#define&t;TFTP_ACK&t;4
DECL|macro|TFTP_ERROR
mdefine_line|#define&t;TFTP_ERROR&t;5
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&t;&t;&t;&t;&t;&t;&t;&t;  Addresses&t;&t;&t;&t;&t;&t;&t;&t; */
DECL|variable|MyHwaddr
r_static
id|HWADDR
id|MyHwaddr
suffix:semicolon
DECL|variable|ServerHwaddr
r_static
id|HWADDR
id|ServerHwaddr
suffix:semicolon
DECL|variable|MyIPaddr
r_static
id|IPADDR
id|MyIPaddr
suffix:semicolon
DECL|variable|ServerIPaddr
r_static
id|IPADDR
id|ServerIPaddr
suffix:semicolon
DECL|variable|IP_Unknown_Addr
r_static
id|IPADDR
id|IP_Unknown_Addr
op_assign
l_int|0x00000000
suffix:semicolon
DECL|variable|IP_Broadcast_Addr
r_static
id|IPADDR
id|IP_Broadcast_Addr
op_assign
l_int|0xffffffff
suffix:semicolon
DECL|variable|Eth_Broadcast_Addr
r_static
id|HWADDR
id|Eth_Broadcast_Addr
op_assign
(brace
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
)brace
suffix:semicolon
DECL|macro|HZ
mdefine_line|#define&t;HZ&t;200
DECL|macro|_hz_200
mdefine_line|#define&t;_hz_200&t;(*(volatile unsigned long *)0x4ba)
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&t;&t;&t;&t;&t;&t;&t;&t;Error Strings&t;&t;&t;&t;&t;&t;&t; */
DECL|variable|ErrStr
r_static
r_char
op_star
id|ErrStr
(braket
)braket
op_assign
(brace
l_string|&quot;timeout&quot;
comma
l_string|&quot;general Ethernet transmit error&quot;
comma
l_string|&quot;general Ethernet receive error&quot;
comma
l_string|&quot;Ethernet framing error&quot;
comma
l_string|&quot;Ethernet overflow error&quot;
comma
l_string|&quot;Ethernet CRC error&quot;
)brace
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&t;&t;&t;&t;&t;&t; Kfile Emulation Definitions&t;&t;&t;&t;&t; */
DECL|macro|KFILE_CHUNK_BITS
mdefine_line|#define&t;KFILE_CHUNK_BITS&t;16  /* chunk is 64 KB */
DECL|macro|KFILE_CHUNK_SIZE
mdefine_line|#define&t;KFILE_CHUNK_SIZE&t;(1 &lt;&lt; KFILE_CHUNK_BITS)
DECL|macro|KFILE_CHUNK_MASK
mdefine_line|#define&t;KFILE_CHUNK_MASK&t;(KFILE_CHUNK_SIZE-1)
DECL|macro|KFILE_N_CHUNKS
mdefine_line|#define&t;KFILE_N_CHUNKS&t;&t;(2*1024*1024/KFILE_CHUNK_SIZE)
DECL|variable|KFile
r_char
op_star
id|KFile
(braket
id|KFILE_N_CHUNKS
)braket
suffix:semicolon
DECL|variable|KFileSize
r_int
id|KFileSize
op_assign
l_int|0
suffix:semicolon
DECL|variable|KFpos
r_int
id|KFpos
op_assign
l_int|0
suffix:semicolon
multiline_comment|/***************************** Prototypes *****************************/
r_static
r_void
id|free_kfile
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|bootp
c_func
(paren
r_char
op_star
id|image_name
)paren
suffix:semicolon
r_static
r_int
id|tftp
c_func
(paren
r_char
op_star
id|image_name
)paren
suffix:semicolon
r_static
r_int
id|udp_send
c_func
(paren
id|UDP
op_star
id|pkt
comma
r_int
id|len
comma
r_int
id|fromport
comma
r_int
id|toport
)paren
suffix:semicolon
r_static
r_int
r_int
id|ip_checksum
c_func
(paren
r_struct
id|iphdr
op_star
id|buf
)paren
suffix:semicolon
r_static
r_int
id|udp_rcv
c_func
(paren
id|UDP
op_star
id|pkt
comma
r_int
op_star
id|len
comma
r_int
id|fromport
comma
r_int
id|atport
)paren
suffix:semicolon
r_static
r_void
id|print_ip
c_func
(paren
id|IPADDR
id|addr
)paren
suffix:semicolon
r_static
r_void
id|print_hw
c_func
(paren
id|HWADDR
id|addr
)paren
suffix:semicolon
r_static
r_int
id|check_ethif
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|eth_send
c_func
(paren
id|Packet
op_star
id|pkt
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_int
id|eth_rcv
c_func
(paren
id|Packet
op_star
id|pkt
comma
r_int
op_star
id|len
)paren
suffix:semicolon
multiline_comment|/************************* End of Prototypes **************************/
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&t;&t;&t;&t;&t;&t;   Interface to bootstrap.c&t;&t;&t;&t;&t;&t; */
multiline_comment|/* get_remote_kernel():&n; * Perform all necessary steps to get the kernel image&n; * from the boot server. If successfull (retval == 0), subsequent calls to&n; * kread() can access the data. Fatal errors (i.e., retrying is useless)&n; * return -2, others -1.&n; */
DECL|function|get_remote_kernel
r_int
id|get_remote_kernel
c_func
(paren
r_const
r_char
op_star
id|kname
multiline_comment|/* optional */
)paren
(brace
r_char
id|image_name
(braket
l_int|256
)braket
suffix:semicolon
r_int
id|rv
suffix:semicolon
multiline_comment|/* Check if a Ethernet interface is present and determine the Ethernet&n;&t; * address */
r_if
c_cond
(paren
id|check_ethif
c_func
(paren
)paren
OL
l_int|0
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;No Ethernet interface found -- no remote boot possible.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|2
suffix:semicolon
)brace
multiline_comment|/* Do a BOOTP request to find out our IP address and the kernel image&squot;s&n;&t; * name; we also learn the IP and Ethernet address of our server */
r_if
c_cond
(paren
id|kname
)paren
id|strcpy
c_func
(paren
id|image_name
comma
id|kname
)paren
suffix:semicolon
r_else
op_star
id|image_name
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rv
op_assign
id|bootp
c_func
(paren
id|image_name
)paren
)paren
OL
l_int|0
)paren
r_return
id|rv
suffix:semicolon
multiline_comment|/* Now start a TFTP connection to receive the kernel image */
r_if
c_cond
(paren
(paren
id|rv
op_assign
id|tftp
c_func
(paren
id|image_name
)paren
)paren
OL
l_int|0
)paren
r_return
id|rv
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ll_read(), ll_lseek(), ll_close():&n; * Functions for accessing the received kernel image like with read(),&n; * lseek(), close().&n; */
DECL|function|ll_read
r_int
id|ll_read
c_func
(paren
r_int
id|fd
comma
r_void
op_star
id|buf
comma
r_int
id|cnt
)paren
(brace
r_int
id|done
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|KFileSize
)paren
r_return
id|read
c_func
(paren
id|fd
comma
id|buf
comma
id|cnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|KFpos
op_plus
id|cnt
OG
id|KFileSize
)paren
id|cnt
op_assign
id|KFileSize
op_minus
id|KFpos
suffix:semicolon
r_while
c_loop
(paren
id|cnt
OG
l_int|0
)paren
(brace
r_int
id|chunk
op_assign
id|KFpos
op_rshift
id|KFILE_CHUNK_BITS
suffix:semicolon
r_int
id|endchunk
op_assign
(paren
id|chunk
op_plus
l_int|1
)paren
op_lshift
id|KFILE_CHUNK_BITS
suffix:semicolon
r_int
id|n
op_assign
id|cnt
suffix:semicolon
r_if
c_cond
(paren
id|KFpos
op_plus
id|n
OG
id|endchunk
)paren
id|n
op_assign
id|endchunk
op_minus
id|KFpos
suffix:semicolon
id|memcpy
c_func
(paren
id|buf
comma
id|KFile
(braket
id|chunk
)braket
op_plus
(paren
id|KFpos
op_amp
id|KFILE_CHUNK_MASK
)paren
comma
id|n
)paren
suffix:semicolon
id|cnt
op_sub_assign
id|n
suffix:semicolon
id|buf
op_add_assign
id|n
suffix:semicolon
id|done
op_add_assign
id|n
suffix:semicolon
id|KFpos
op_add_assign
id|n
suffix:semicolon
r_if
c_cond
(paren
id|KFpos
op_eq
id|endchunk
)paren
(brace
id|free
c_func
(paren
id|KFile
(braket
id|chunk
)braket
)paren
suffix:semicolon
id|KFile
(braket
id|chunk
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_return
id|done
suffix:semicolon
)brace
DECL|function|ll_lseek
r_int
id|ll_lseek
c_func
(paren
r_int
id|fd
comma
r_int
id|where
comma
r_int
id|whence
)paren
(brace
r_int
id|oldpos
comma
id|oldchunk
comma
id|newchunk
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|KFileSize
)paren
r_return
id|lseek
c_func
(paren
id|fd
comma
id|where
comma
id|whence
)paren
suffix:semicolon
id|oldpos
op_assign
id|KFpos
suffix:semicolon
r_switch
c_cond
(paren
id|whence
)paren
(brace
r_case
id|SEEK_SET
suffix:colon
id|KFpos
op_assign
id|where
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEEK_CUR
suffix:colon
id|KFpos
op_add_assign
id|where
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEEK_END
suffix:colon
id|KFpos
op_assign
id|KFileSize
op_plus
id|where
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|KFpos
OL
l_int|0
)paren
(brace
id|KFpos
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|KFpos
OG
id|KFileSize
)paren
(brace
id|KFpos
op_assign
id|KFileSize
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* free memory of skipped-over data */
id|oldchunk
op_assign
id|oldpos
op_rshift
id|KFILE_CHUNK_BITS
suffix:semicolon
id|newchunk
op_assign
id|KFpos
op_rshift
id|KFILE_CHUNK_BITS
suffix:semicolon
r_while
c_loop
(paren
id|oldchunk
OL
id|newchunk
)paren
(brace
r_if
c_cond
(paren
id|KFile
(braket
id|oldchunk
)braket
)paren
(brace
id|free
c_func
(paren
id|KFile
(braket
id|oldchunk
)braket
)paren
suffix:semicolon
id|KFile
(braket
id|oldchunk
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
op_increment
id|oldchunk
suffix:semicolon
)brace
r_return
id|KFpos
suffix:semicolon
)brace
DECL|function|ll_close
r_int
id|ll_close
c_func
(paren
r_int
id|fd
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|KFileSize
)paren
r_return
id|close
c_func
(paren
id|fd
)paren
suffix:semicolon
id|free_kfile
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|free_kfile
r_static
r_void
id|free_kfile
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|KFILE_N_CHUNKS
suffix:semicolon
op_increment
id|i
)paren
r_if
c_cond
(paren
id|KFile
(braket
id|i
)braket
)paren
id|free
c_func
(paren
id|KFile
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&t;&t;&t;&t;&t;&t;&t;   BOOTP Procedure&t;&t;&t;&t;&t;&t;&t; */
DECL|function|bootp
r_static
r_int
id|bootp
c_func
(paren
r_char
op_star
id|image_name
)paren
(brace
id|BOOTP
id|req
suffix:semicolon
id|Packet
id|_reply
suffix:semicolon
id|BOOTP
op_star
id|reply
op_assign
(paren
id|BOOTP
op_star
)paren
id|_reply
suffix:semicolon
r_static
r_int
r_char
id|mincookie
(braket
)braket
op_assign
(brace
l_int|99
comma
l_int|130
comma
l_int|83
comma
l_int|99
comma
l_int|255
)brace
suffix:semicolon
r_int
r_int
id|starttime
comma
id|rancopy
suffix:semicolon
r_int
id|err
comma
id|len
comma
id|retry
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|req
comma
l_int|0
comma
r_sizeof
(paren
id|req
)paren
)paren
suffix:semicolon
multiline_comment|/* Now fill in the packet... */
id|req.bootp.op
op_assign
id|BOOTREQUEST
suffix:semicolon
id|req.bootp.htype
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* 10Mb/s Ethernet */
id|req.bootp.hlen
op_assign
l_int|6
suffix:semicolon
id|memcpy
c_func
(paren
id|req.bootp.chaddr
comma
op_amp
id|MyHwaddr
comma
id|ETHADDRLEN
)paren
suffix:semicolon
multiline_comment|/* Put in the minimal RFC1497 Magic cookie */
id|memcpy
c_func
(paren
id|req.bootp.vend
comma
id|mincookie
comma
r_sizeof
(paren
id|mincookie
)paren
)paren
suffix:semicolon
multiline_comment|/* Put the user precified bootfile name in place */
id|memcpy
c_func
(paren
id|req.bootp.file
comma
id|image_name
comma
id|strlen
c_func
(paren
id|image_name
)paren
op_plus
l_int|1
)paren
suffix:semicolon
id|starttime
op_assign
id|_hz_200
suffix:semicolon
r_for
c_loop
(paren
id|retry
op_assign
l_int|0
suffix:semicolon
id|retry
OL
id|BOOTP_RETRYS
suffix:semicolon
op_increment
id|retry
)paren
(brace
multiline_comment|/* Initialize server addresses and own IP to defaults */
id|ServerIPaddr
op_assign
id|IP_Broadcast_Addr
suffix:semicolon
multiline_comment|/* 255.255.255.255 */
id|MyIPaddr
op_assign
id|IP_Unknown_Addr
suffix:semicolon
multiline_comment|/* 0.0.0.0 */
id|memcpy
c_func
(paren
id|ServerHwaddr
comma
id|Eth_Broadcast_Addr
comma
id|ETHADDRLEN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retry
)paren
id|sleep
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|req.bootp.xid
op_assign
id|rancopy
op_assign
id|_hz_200
suffix:semicolon
id|req.bootp.secs
op_assign
(paren
id|_hz_200
op_minus
id|starttime
)paren
op_div
id|HZ
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|udp_send
c_func
(paren
(paren
id|UDP
op_star
)paren
op_amp
id|req
comma
r_sizeof
(paren
id|req.bootp
)paren
comma
id|UDP_BOOTPC
comma
id|UDP_BOOTPS
)paren
)paren
OL
l_int|0
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;bootp send: %s&bslash;n&quot;
comma
id|ErrStr
(braket
op_minus
id|err
op_minus
l_int|1
)braket
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|udp_rcv
c_func
(paren
(paren
id|UDP
op_star
)paren
id|reply
comma
op_amp
id|len
comma
id|UDP_BOOTPS
comma
id|UDP_BOOTPC
)paren
)paren
OL
l_int|0
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;bootp rcv: %s&bslash;n&quot;
comma
id|ErrStr
(braket
op_minus
id|err
op_minus
l_int|1
)braket
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OL
r_sizeof
(paren
r_struct
id|bootp
)paren
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;received short BOOTP packet (%d bytes)&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reply-&gt;bootp.xid
op_eq
id|rancopy
)paren
multiline_comment|/* Ok, got the answer */
r_break
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;bootp: xid mismatch&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|retry
op_ge
id|BOOTP_RETRYS
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;No response from a bootp server&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|2
suffix:semicolon
)brace
id|ServerIPaddr
op_assign
id|reply-&gt;bootp.siaddr
suffix:semicolon
id|memcpy
c_func
(paren
id|ServerHwaddr
comma
id|reply-&gt;ether.src_addr
comma
id|ETHADDRLEN
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;&bslash;nBoot server is &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|reply-&gt;bootp.sname
)paren
OG
l_int|0
)paren
id|printf
c_func
(paren
l_string|&quot;%s, IP &quot;
comma
id|reply-&gt;bootp.sname
)paren
suffix:semicolon
id|print_ip
c_func
(paren
id|ServerIPaddr
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;, HW address &quot;
)paren
suffix:semicolon
id|print_hw
c_func
(paren
id|ServerHwaddr
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|MyIPaddr
op_assign
id|reply-&gt;bootp.yiaddr
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;My IP address is &quot;
)paren
suffix:semicolon
id|print_ip
c_func
(paren
id|MyIPaddr
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|image_name
comma
id|reply-&gt;bootp.file
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&t;&t;&t;&t;&t;&t;&t;&t;TFTP Procedure&t;&t;&t;&t;&t;&t;&t; */
DECL|function|tftp
r_static
r_int
id|tftp
c_func
(paren
r_char
op_star
id|image_name
)paren
(brace
id|TFTP
id|spkt
suffix:semicolon
id|Packet
id|_rpkt
suffix:semicolon
id|TFTP
op_star
id|rpkt
op_assign
(paren
id|TFTP
op_star
)paren
op_amp
id|_rpkt
suffix:semicolon
r_int
r_int
id|mytid
comma
id|rtid
op_assign
l_int|0
suffix:semicolon
r_int
id|blk
comma
id|retries
comma
id|i
comma
id|wpos
comma
id|err
comma
id|len
comma
id|datalen
suffix:semicolon
r_static
r_char
id|rotchar
(braket
l_int|4
)braket
op_assign
(brace
l_char|&squot;|&squot;
comma
l_char|&squot;/&squot;
comma
l_char|&squot;-&squot;
comma
l_char|&squot;&bslash;&bslash;&squot;
)brace
suffix:semicolon
id|retries
op_assign
l_int|5
suffix:semicolon
multiline_comment|/* Construct and send a read request */
id|repeat_req
suffix:colon
id|spkt.tftp.req.opcode
op_assign
id|TFTP_RRQ
suffix:semicolon
id|strcpy
c_func
(paren
id|spkt.tftp.req.name
comma
id|image_name
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|spkt.tftp.req.name
op_plus
id|strlen
c_func
(paren
id|spkt.tftp.req.name
)paren
op_plus
l_int|1
comma
l_string|&quot;octet&quot;
)paren
suffix:semicolon
id|mytid
op_assign
id|_hz_200
op_amp
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|udp_send
c_func
(paren
(paren
id|UDP
op_star
)paren
op_amp
id|spkt
comma
r_sizeof
(paren
id|spkt.tftp.req.opcode
)paren
op_plus
id|strlen
c_func
(paren
id|image_name
)paren
op_plus
l_int|1
op_plus
id|strlen
c_func
(paren
l_string|&quot;octect&quot;
)paren
op_plus
l_int|1
comma
id|mytid
comma
id|UDP_TFTP
)paren
)paren
OL
l_int|0
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;TFTP RREQ: %s&bslash;n&quot;
comma
id|ErrStr
(braket
op_minus
id|err
op_minus
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|retries
OG
l_int|0
)paren
r_goto
id|repeat_req
suffix:semicolon
r_return
id|err
op_eq
id|ETIMEO
ques
c_cond
op_minus
l_int|2
suffix:colon
op_minus
l_int|1
suffix:semicolon
)brace
id|retries
op_assign
l_int|5
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|KFILE_N_CHUNKS
suffix:semicolon
op_increment
id|i
)paren
(brace
id|KFile
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|wpos
op_assign
l_int|0
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;Receiving kernel image %s:&bslash;n&quot;
comma
id|image_name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|blk
op_assign
l_int|1
suffix:semicolon
suffix:semicolon
op_increment
id|blk
)paren
(brace
id|repeat_data
suffix:colon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|udp_rcv
c_func
(paren
(paren
id|UDP
op_star
)paren
id|rpkt
comma
op_amp
id|len
comma
id|rtid
comma
id|mytid
)paren
)paren
OL
l_int|0
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;TFTP rcv: %s&bslash;n&quot;
comma
id|ErrStr
(braket
op_minus
id|err
op_minus
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|retries
OG
l_int|0
)paren
r_goto
id|repeat_data
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rtid
op_eq
l_int|0
)paren
multiline_comment|/* Store the remote port at the first packet received */
id|rtid
op_assign
id|rpkt-&gt;udp.src_port
suffix:semicolon
r_if
c_cond
(paren
id|rpkt-&gt;tftp.opcode
op_eq
id|TFTP_ERROR
)paren
(brace
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|rpkt-&gt;tftp.error.str
)paren
OG
l_int|0
)paren
id|printf
c_func
(paren
l_string|&quot;TFTP error: %s&bslash;n&quot;
comma
id|rpkt-&gt;tftp.error.str
)paren
suffix:semicolon
r_else
id|printf
c_func
(paren
l_string|&quot;TFTP error #%d (no description)&bslash;n&quot;
comma
id|rpkt-&gt;tftp.error.errcode
)paren
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rpkt-&gt;tftp.opcode
op_ne
id|TFTP_DATA
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;Bad TFTP packet type: %d&bslash;n&quot;
comma
id|rpkt-&gt;tftp.opcode
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|retries
OG
l_int|0
)paren
r_goto
id|repeat_data
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rpkt-&gt;tftp.data.nr
op_ne
id|blk
)paren
(brace
multiline_comment|/* doubled data packet; ignore it */
r_goto
id|repeat_data
suffix:semicolon
)brace
id|datalen
op_assign
id|len
op_minus
r_sizeof
(paren
id|rpkt-&gt;tftp.data.opcode
)paren
op_minus
r_sizeof
(paren
id|rpkt-&gt;tftp.data.nr
)paren
suffix:semicolon
multiline_comment|/* store data */
r_if
c_cond
(paren
id|datalen
OG
l_int|0
)paren
(brace
r_int
id|chunk
op_assign
id|wpos
op_rshift
id|KFILE_CHUNK_BITS
suffix:semicolon
r_if
c_cond
(paren
id|chunk
op_ge
id|KFILE_N_CHUNKS
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;TFTP: file too large! Aborting.&bslash;n&quot;
)paren
suffix:semicolon
id|out_of_mem
suffix:colon
id|spkt.tftp.error.opcode
op_assign
id|TFTP_ERROR
suffix:semicolon
id|spkt.tftp.error.errcode
op_assign
l_int|3
suffix:semicolon
id|strcpy
c_func
(paren
id|spkt.tftp.error.str
comma
l_string|&quot;Out of memory&quot;
)paren
suffix:semicolon
id|udp_send
c_func
(paren
(paren
id|UDP
op_star
)paren
op_amp
id|spkt
comma
r_sizeof
(paren
id|spkt.tftp.ack
)paren
comma
id|mytid
comma
id|rtid
)paren
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|KFile
(braket
id|chunk
)braket
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|KFile
(braket
id|chunk
)braket
op_assign
id|malloc
c_func
(paren
id|KFILE_CHUNK_SIZE
)paren
)paren
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;TFTP: Out of memory for kernel image&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_of_mem
suffix:semicolon
)brace
)brace
id|memcpy
c_func
(paren
id|KFile
(braket
id|chunk
)braket
op_plus
(paren
id|wpos
op_amp
id|KFILE_CHUNK_MASK
)paren
comma
id|rpkt-&gt;tftp.data.data
comma
id|datalen
)paren
suffix:semicolon
id|wpos
op_add_assign
id|datalen
suffix:semicolon
DECL|macro|DISPLAY_BITS
mdefine_line|#define&t;DISPLAY_BITS 13
r_if
c_cond
(paren
(paren
id|wpos
op_amp
(paren
(paren
l_int|1
op_lshift
id|DISPLAY_BITS
)paren
op_minus
l_int|1
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;&bslash;r %c %7d Bytes &quot;
comma
id|rotchar
(braket
(paren
id|wpos
op_rshift
id|DISPLAY_BITS
)paren
op_amp
l_int|3
)braket
comma
id|wpos
)paren
suffix:semicolon
id|fflush
c_func
(paren
id|stdout
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Send ACK packet */
id|repeat_ack
suffix:colon
id|spkt.tftp.ack.opcode
op_assign
id|TFTP_ACK
suffix:semicolon
id|spkt.tftp.ack.nr
op_assign
id|blk
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|udp_send
c_func
(paren
(paren
id|UDP
op_star
)paren
op_amp
id|spkt
comma
r_sizeof
(paren
id|spkt.tftp.ack
)paren
comma
id|mytid
comma
id|rtid
)paren
)paren
OL
l_int|0
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;TFTP ACK: %s&bslash;n&quot;
comma
id|ErrStr
(braket
op_minus
id|err
op_minus
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|retries
OG
l_int|0
)paren
r_goto
id|repeat_ack
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|datalen
OL
l_int|512
)paren
(brace
multiline_comment|/* This was the last packet */
id|printf
c_func
(paren
l_string|&quot;&bslash;r   %7d Bytes done&bslash;n&bslash;n&quot;
comma
id|wpos
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|retries
op_assign
l_int|5
suffix:semicolon
)brace
id|KFileSize
op_assign
id|wpos
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err
suffix:colon
id|free_kfile
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&t;&t;&t;&t;  UDP/IP Protocol Quick Hack Implementation&t;&t;&t;&t; */
DECL|function|udp_send
r_static
r_int
id|udp_send
c_func
(paren
id|UDP
op_star
id|pkt
comma
r_int
id|len
comma
r_int
id|fromport
comma
r_int
id|toport
)paren
(brace
multiline_comment|/* UDP layer */
id|pkt-&gt;udp.src_port
op_assign
id|fromport
suffix:semicolon
id|pkt-&gt;udp.dst_port
op_assign
id|toport
suffix:semicolon
id|pkt-&gt;udp.len
op_assign
(paren
id|len
op_add_assign
r_sizeof
(paren
r_struct
id|udphdr
)paren
)paren
suffix:semicolon
id|pkt-&gt;udp.chksum
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Too lazy to calculate :-) */
multiline_comment|/* IP layer */
id|pkt-&gt;ip.version
op_assign
l_int|4
suffix:semicolon
id|pkt-&gt;ip.ihl
op_assign
l_int|5
suffix:semicolon
id|pkt-&gt;ip.tos
op_assign
l_int|0
suffix:semicolon
id|pkt-&gt;ip.tot_len
op_assign
(paren
id|len
op_add_assign
r_sizeof
(paren
r_struct
id|iphdr
)paren
)paren
suffix:semicolon
id|pkt-&gt;ip.id
op_assign
l_int|0
suffix:semicolon
id|pkt-&gt;ip.frag_off
op_assign
l_int|0
suffix:semicolon
id|pkt-&gt;ip.ttl
op_assign
l_int|255
suffix:semicolon
id|pkt-&gt;ip.protocol
op_assign
l_int|17
suffix:semicolon
multiline_comment|/* UDP */
id|pkt-&gt;ip.src_addr
op_assign
id|MyIPaddr
suffix:semicolon
id|pkt-&gt;ip.dst_addr
op_assign
id|ServerIPaddr
suffix:semicolon
id|pkt-&gt;ip.chksum
op_assign
l_int|0
suffix:semicolon
id|pkt-&gt;ip.chksum
op_assign
id|ip_checksum
c_func
(paren
op_amp
id|pkt-&gt;ip
)paren
suffix:semicolon
multiline_comment|/* Ethernet layer */
id|memcpy
c_func
(paren
op_amp
id|pkt-&gt;ether.dst_addr
comma
id|ServerHwaddr
comma
id|ETHADDRLEN
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|pkt-&gt;ether.src_addr
comma
id|MyHwaddr
comma
id|ETHADDRLEN
)paren
suffix:semicolon
id|pkt-&gt;ether.type
op_assign
l_int|0x0800
suffix:semicolon
id|len
op_add_assign
r_sizeof
(paren
r_struct
id|etherhdr
)paren
suffix:semicolon
r_return
id|eth_send
c_func
(paren
(paren
id|Packet
op_star
)paren
id|pkt
comma
id|len
)paren
suffix:semicolon
)brace
DECL|function|ip_checksum
r_static
r_int
r_int
id|ip_checksum
c_func
(paren
r_struct
id|iphdr
op_star
id|buf
)paren
(brace
r_int
r_int
id|sum
op_assign
l_int|0
comma
id|wlen
op_assign
l_int|5
suffix:semicolon
id|__asm__
(paren
l_string|&quot;subqw #1,%2&bslash;n&quot;
l_string|&quot;1:&bslash;t&quot;
l_string|&quot;movel %1@+,%/d0&bslash;n&bslash;t&quot;
l_string|&quot;addxl %/d0,%0&bslash;n&bslash;t&quot;
l_string|&quot;dbra %2,1b&bslash;n&bslash;t&quot;
l_string|&quot;movel %0,%/d0&bslash;n&bslash;t&quot;
l_string|&quot;swap %/d0&bslash;n&bslash;t&quot;
l_string|&quot;addxw %/d0,%0&bslash;n&bslash;t&quot;
l_string|&quot;clrw %/d0&bslash;n&bslash;t&quot;
l_string|&quot;addxw %/d0,%0&quot;
suffix:colon
l_string|&quot;=d&quot;
(paren
id|sum
)paren
comma
l_string|&quot;=a&quot;
(paren
id|buf
)paren
comma
l_string|&quot;=d&quot;
(paren
id|wlen
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|sum
)paren
comma
l_string|&quot;1&quot;
(paren
id|buf
)paren
comma
l_string|&quot;2&quot;
(paren
id|wlen
)paren
suffix:colon
l_string|&quot;d0&quot;
)paren
suffix:semicolon
r_return
(paren
op_complement
id|sum
)paren
op_amp
l_int|0xffff
suffix:semicolon
)brace
DECL|function|udp_rcv
r_static
r_int
id|udp_rcv
c_func
(paren
id|UDP
op_star
id|pkt
comma
r_int
op_star
id|len
comma
r_int
id|fromport
comma
r_int
id|atport
)paren
(brace
r_int
id|err
suffix:semicolon
id|repeat
suffix:colon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|eth_rcv
c_func
(paren
(paren
id|Packet
op_star
)paren
id|pkt
comma
id|len
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/* Ethernet layer */
r_if
c_cond
(paren
id|pkt-&gt;ether.type
op_eq
l_int|0x0806
)paren
(brace
multiline_comment|/* ARP */
id|ARP
op_star
id|pk
op_assign
(paren
id|ARP
op_star
)paren
id|pkt
suffix:semicolon
r_int
r_char
op_star
id|shw
comma
op_star
id|sip
comma
op_star
id|thw
comma
op_star
id|tip
suffix:semicolon
r_if
c_cond
(paren
id|pk-&gt;arp.hrd
op_ne
l_int|1
op_logical_or
id|pk-&gt;arp.pro
op_ne
l_int|0x0800
op_logical_or
id|pk-&gt;arp.op
op_ne
l_int|1
op_logical_or
id|MyIPaddr
op_eq
id|IP_Unknown_Addr
)paren
multiline_comment|/* Wrong hardware type or protocol; or reply -&gt; ignore */
r_goto
id|repeat
suffix:semicolon
id|shw
op_assign
id|pk-&gt;arp.addr
suffix:semicolon
id|sip
op_assign
id|shw
op_plus
id|pk-&gt;arp.hln
suffix:semicolon
id|thw
op_assign
id|sip
op_plus
id|pk-&gt;arp.pln
suffix:semicolon
id|tip
op_assign
id|thw
op_plus
id|pk-&gt;arp.hln
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|tip
comma
op_amp
id|MyIPaddr
comma
id|pk-&gt;arp.pln
)paren
op_eq
l_int|0
)paren
(brace
id|memcpy
c_func
(paren
id|thw
comma
id|shw
comma
id|pk-&gt;arp.hln
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|tip
comma
id|sip
comma
id|pk-&gt;arp.pln
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|shw
comma
op_amp
id|MyHwaddr
comma
id|pk-&gt;arp.hln
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|sip
comma
op_amp
id|MyIPaddr
comma
id|pk-&gt;arp.pln
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|pk-&gt;ether.dst_addr
comma
id|thw
comma
id|ETHADDRLEN
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|pk-&gt;ether.src_addr
comma
op_amp
id|MyHwaddr
comma
id|ETHADDRLEN
)paren
suffix:semicolon
id|eth_send
c_func
(paren
(paren
id|Packet
op_star
)paren
id|pk
comma
op_star
id|len
)paren
suffix:semicolon
)brace
r_goto
id|repeat
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pkt-&gt;ether.type
op_ne
l_int|0x0800
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;Unknown Ethernet packet type %04x received&bslash;n&quot;
comma
id|pkt-&gt;ether.type
)paren
suffix:semicolon
r_goto
id|repeat
suffix:semicolon
)brace
multiline_comment|/* IP layer */
r_if
c_cond
(paren
id|MyIPaddr
op_ne
id|IP_Unknown_Addr
op_logical_and
id|pkt-&gt;ip.dst_addr
op_ne
id|MyIPaddr
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;Received packet for wrong IP address&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|repeat
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ServerIPaddr
op_ne
id|IP_Unknown_Addr
op_logical_and
id|ServerIPaddr
op_ne
id|IP_Broadcast_Addr
op_logical_and
id|pkt-&gt;ip.src_addr
op_ne
id|ServerIPaddr
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;Received packet from wrong server&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|repeat
suffix:semicolon
)brace
multiline_comment|/* If IP header is longer than 5 longs, delete the options */
r_if
c_cond
(paren
id|pkt-&gt;ip.ihl
OG
l_int|5
)paren
(brace
r_char
op_star
id|udpstart
op_assign
(paren
r_char
op_star
)paren
(paren
(paren
r_int
op_star
)paren
op_amp
id|pkt-&gt;ip
op_plus
id|pkt-&gt;ip.ihl
)paren
suffix:semicolon
id|memmove
c_func
(paren
op_amp
id|pkt-&gt;udp
comma
id|udpstart
comma
op_star
id|len
op_minus
(paren
id|udpstart
op_minus
(paren
r_char
op_star
)paren
id|pkt
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* UDP layer */
r_if
c_cond
(paren
id|fromport
op_ne
l_int|0
op_logical_and
id|pkt-&gt;udp.src_port
op_ne
id|fromport
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;Received packet from wrong port %d&bslash;n&quot;
comma
id|pkt-&gt;udp.src_port
)paren
suffix:semicolon
r_goto
id|repeat
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pkt-&gt;udp.dst_port
op_ne
id|atport
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;Received packet at wrong port %d&bslash;n&quot;
comma
id|pkt-&gt;udp.dst_port
)paren
suffix:semicolon
r_goto
id|repeat
suffix:semicolon
)brace
op_star
id|len
op_assign
id|pkt-&gt;udp.len
op_minus
r_sizeof
(paren
r_struct
id|udphdr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&t;&t;&t;&t;&t;&t;&t;   Address Printing&t;&t;&t;&t;&t;&t;&t; */
DECL|function|print_ip
r_static
r_void
id|print_ip
c_func
(paren
id|IPADDR
id|addr
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;%ld.%ld.%ld.%ld&quot;
comma
(paren
id|addr
op_rshift
l_int|24
)paren
op_amp
l_int|0xff
comma
(paren
id|addr
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
comma
(paren
id|addr
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
id|addr
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
DECL|function|print_hw
r_static
r_void
id|print_hw
c_func
(paren
id|HWADDR
id|addr
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;%02x:%02x:%02x:%02x:%02x:%02x&quot;
comma
id|addr
(braket
l_int|0
)braket
comma
id|addr
(braket
l_int|1
)braket
comma
id|addr
(braket
l_int|2
)braket
comma
id|addr
(braket
l_int|3
)braket
comma
id|addr
(braket
l_int|4
)braket
comma
id|addr
(braket
l_int|5
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&t;&t;&t;&t;&t; Ethernet Interface Abstraction Layer&t;&t;&t;&t; */
macro_line|#ifdef ETHLL_LANCE
macro_line|#include &quot;ethlance.h&quot;
macro_line|#endif
DECL|variable|PossibleInterfaces
r_static
id|ETHIF_SWITCH
op_star
id|PossibleInterfaces
(braket
)braket
op_assign
(brace
macro_line|#ifdef ETHLL_LANCE
op_amp
id|LanceSwitch
comma
macro_line|#endif
)brace
suffix:semicolon
DECL|macro|N_PossibleInterfaces
mdefine_line|#define&t;N_PossibleInterfaces (sizeof(PossibleInterfaces)/sizeof(*PossibleInterfaces))
multiline_comment|/* Detected interface */
DECL|variable|Ethif
r_static
id|ETHIF_SWITCH
op_star
id|Ethif
op_assign
l_int|NULL
suffix:semicolon
DECL|function|check_ethif
r_static
r_int
id|check_ethif
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* Check for configured interfaces */
id|Ethif
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|N_PossibleInterfaces
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|PossibleInterfaces
(braket
id|i
)braket
op_member_access_from_pointer
id|probe
c_func
(paren
)paren
op_ge
l_int|0
)paren
(brace
id|Ethif
op_assign
id|PossibleInterfaces
(braket
id|i
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|Ethif
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|Ethif
op_member_access_from_pointer
id|init
c_func
(paren
)paren
OL
l_int|0
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;Ethernet interface initialization failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|Ethif
op_member_access_from_pointer
id|get_hwaddr
c_func
(paren
op_amp
id|MyHwaddr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|eth_send
r_static
r_int
id|eth_send
c_func
(paren
id|Packet
op_star
id|pkt
comma
r_int
id|len
)paren
(brace
r_return
id|Ethif
op_member_access_from_pointer
id|snd
c_func
(paren
id|pkt
comma
id|len
)paren
suffix:semicolon
)brace
DECL|function|eth_rcv
r_static
r_int
id|eth_rcv
c_func
(paren
id|Packet
op_star
id|pkt
comma
r_int
op_star
id|len
)paren
(brace
r_return
id|Ethif
op_member_access_from_pointer
id|rcv
c_func
(paren
id|pkt
comma
id|len
)paren
suffix:semicolon
)brace
macro_line|#if 0
r_static
r_void
id|dump_packet
c_func
(paren
id|UDP
op_star
id|pkt
)paren
(brace
r_int
id|i
comma
id|l
suffix:semicolon
r_int
r_char
op_star
id|p
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;Packet dump:&bslash;n&quot;
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;Ethernet header:&bslash;n&quot;
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;  dst addr: &quot;
)paren
suffix:semicolon
id|print_hw
c_func
(paren
id|pkt-&gt;ether.dst_addr
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;  src addr: &quot;
)paren
suffix:semicolon
id|print_hw
c_func
(paren
id|pkt-&gt;ether.src_addr
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;  type: %04x&bslash;n&quot;
comma
id|pkt-&gt;ether.type
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;IP header:&bslash;n&quot;
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;  version: %d&bslash;n&quot;
comma
id|pkt-&gt;ip.version
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;  hdr len: %d&bslash;n&quot;
comma
id|pkt-&gt;ip.ihl
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;  tos: %d&bslash;n&quot;
comma
id|pkt-&gt;ip.tos
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;  tot_len: %d&bslash;n&quot;
comma
id|pkt-&gt;ip.tot_len
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;  id: %d&bslash;n&quot;
comma
id|pkt-&gt;ip.id
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;  frag_off: %d&bslash;n&quot;
comma
id|pkt-&gt;ip.frag_off
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;  ttl: %d&bslash;n&quot;
comma
id|pkt-&gt;ip.ttl
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;  prot: %d&bslash;n&quot;
comma
id|pkt-&gt;ip.protocol
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;  src addr: &quot;
)paren
suffix:semicolon
id|print_ip
c_func
(paren
id|pkt-&gt;ip.src_addr
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;  dst addr: &quot;
)paren
suffix:semicolon
id|print_ip
c_func
(paren
id|pkt-&gt;ip.dst_addr
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;UDP header:&bslash;n&quot;
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;  src port: %d&bslash;n&quot;
comma
id|pkt-&gt;udp.src_port
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;  dst port: %d&bslash;n&quot;
comma
id|pkt-&gt;udp.dst_port
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;  len: %d&bslash;n&quot;
comma
id|pkt-&gt;udp.len
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;Data:&quot;
)paren
suffix:semicolon
id|l
op_assign
id|pkt-&gt;udp.len
op_minus
r_sizeof
(paren
id|pkt-&gt;udp
)paren
suffix:semicolon
id|p
op_assign
(paren
r_int
r_char
op_star
)paren
op_amp
id|pkt-&gt;udp
op_plus
r_sizeof
(paren
id|pkt-&gt;udp
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|l
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
(paren
id|i
op_mod
l_int|32
)paren
op_eq
l_int|0
)paren
id|printf
c_func
(paren
l_string|&quot;&bslash;n  %04x &quot;
comma
id|i
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;%02x &quot;
comma
op_star
id|p
)paren
suffix:semicolon
)brace
id|printf
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
