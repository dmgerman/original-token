multiline_comment|/*&n;** linux/arch/m68k/boot/amiga/bootstrap.c -- This program loads the Linux/m68k&n;**&t;&t;&t;&t;&t;     kernel into an Amiga and launches&n;**&t;&t;&t;&t;&t;     it.&n;**&n;** Copyright 1993,1994 by Hamish Macdonald, Greg Harp&n;**&n;** Modified 11-May-94 by Geert Uytterhoeven&n;**&t;&t;&t;(Geert.Uytterhoeven@cs.kuleuven.ac.be)&n;**     - A3640 MapROM check&n;** Modified 31-May-94 by Geert Uytterhoeven&n;**     - Memory thrash problem solved&n;** Modified 07-March-95 by Geert Uytterhoeven&n;**     - Memory block sizes are rounded to a multiple of 256K instead of 1M&n;**&t; This _requires_ &gt;0.9pl5 to work!&n;**&t; (unless all block sizes are multiples of 1M :-)&n;** Modified 11-July-95 by Andreas Schwab&n;**     - Support for ELF kernel (untested!)&n;** Modified 10-Jan-96 by Geert Uytterhoeven&n;**     - The real Linux/m68k boot code moved to linuxboot.[ch]&n;** Modified 9-Sep-96 by Geert Uytterhoeven&n;**     - Rewritten option parsing&n;**     - New parameter passing to linuxboot() (linuxboot_args)&n;**&n;** This file is subject to the terms and conditions of the GNU General Public&n;** License.  See the file COPYING in the main directory of this archive&n;** for more details.&n;**&n;*/
macro_line|#include &lt;stddef.h&gt;
macro_line|#include &lt;stdlib.h&gt;
macro_line|#include &lt;stdio.h&gt;
macro_line|#include &lt;stdarg.h&gt;
macro_line|#include &lt;string.h&gt;
macro_line|#include &lt;sys/file.h&gt;
macro_line|#include &lt;sys/types.h&gt;
macro_line|#include &lt;unistd.h&gt;
multiline_comment|/* required Linux/m68k include files */
macro_line|#include &lt;linux/a.out.h&gt;
macro_line|#include &lt;linux/elf.h&gt;
macro_line|#include &lt;asm/setup.h&gt;
macro_line|#include &lt;asm/page.h&gt;
multiline_comment|/* Amiga bootstrap include files */
macro_line|#include &quot;linuxboot.h&quot;
macro_line|#include &quot;bootstrap.h&quot;
multiline_comment|/* Library Bases */
r_extern
r_const
r_struct
id|ExecBase
op_star
id|SysBase
suffix:semicolon
DECL|variable|ExpansionBase
r_const
r_struct
id|ExpansionBase
op_star
id|ExpansionBase
suffix:semicolon
DECL|variable|GfxBase
r_const
r_struct
id|GfxBase
op_star
id|GfxBase
suffix:semicolon
DECL|variable|memfile_name
r_static
r_const
r_char
op_star
id|memfile_name
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|model
r_static
r_int
id|model
op_assign
id|AMI_UNKNOWN
suffix:semicolon
DECL|variable|ProgramName
r_static
r_const
r_char
op_star
id|ProgramName
suffix:semicolon
DECL|variable|args
r_struct
id|linuxboot_args
id|args
suffix:semicolon
multiline_comment|/*&n;     *  Function Prototypes&n;     */
r_static
r_void
id|Usage
c_func
(paren
r_void
)paren
id|__attribute__
(paren
(paren
id|noreturn
)paren
)paren
suffix:semicolon
r_int
id|main
c_func
(paren
r_int
id|argc
comma
r_char
op_star
id|argv
(braket
)braket
)paren
suffix:semicolon
r_static
r_void
id|Puts
c_func
(paren
r_const
r_char
op_star
id|str
)paren
suffix:semicolon
r_static
r_int
id|GetChar
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|PutChar
c_func
(paren
r_char
id|c
)paren
suffix:semicolon
r_static
r_void
id|Printf
c_func
(paren
r_const
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
suffix:semicolon
r_static
r_int
id|Open
c_func
(paren
r_const
r_char
op_star
id|path
)paren
suffix:semicolon
r_static
r_int
id|Seek
c_func
(paren
r_int
id|fd
comma
r_int
id|offset
)paren
suffix:semicolon
r_static
r_int
id|Read
c_func
(paren
r_int
id|fd
comma
r_char
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_void
id|Close
c_func
(paren
r_int
id|fd
)paren
suffix:semicolon
r_static
r_int
id|FileSize
c_func
(paren
r_const
r_char
op_star
id|path
)paren
suffix:semicolon
r_static
r_void
id|Sleep
c_func
(paren
id|u_long
id|micros
)paren
suffix:semicolon
r_static
r_int
id|ModifyBootinfo
c_func
(paren
r_struct
id|bootinfo
op_star
id|bi
)paren
suffix:semicolon
DECL|function|Usage
r_static
r_void
id|Usage
c_func
(paren
r_void
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Linux/m68k Amiga Bootstrap version &quot;
id|AMIBOOT_VERSION
l_string|&quot;&bslash;n&bslash;n&quot;
l_string|&quot;Usage: %s [options] [kernel command line]&bslash;n&bslash;n&quot;
l_string|&quot;Valid options are:&bslash;n&quot;
l_string|&quot;    -h, --help           Display this usage information&bslash;n&quot;
l_string|&quot;    -k, --kernel file    Use kernel image `file&squot; (default is `vmlinux&squot;)&bslash;n&quot;
l_string|&quot;    -r, --ramdisk file   Use ramdisk image `file&squot;&bslash;n&quot;
l_string|&quot;    -d, --debug          Enable debug mode&bslash;n&quot;
l_string|&quot;    -m, --memfile file   Use memory file `file&squot;&bslash;n&quot;
l_string|&quot;    -v, --keep-video     Don&squot;t reset the video mode&bslash;n&quot;
l_string|&quot;    -t, --model id       Set the Amiga model to `id&squot;&bslash;n&bslash;n&quot;
comma
id|ProgramName
)paren
suffix:semicolon
m_exit
(paren
id|EXIT_FAILURE
)paren
suffix:semicolon
)brace
DECL|function|main
r_int
id|main
c_func
(paren
r_int
id|argc
comma
r_char
op_star
id|argv
(braket
)braket
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|debugflag
op_assign
l_int|0
comma
id|keep_video
op_assign
l_int|0
suffix:semicolon
r_const
r_char
op_star
id|kernel_name
op_assign
l_int|NULL
suffix:semicolon
r_const
r_char
op_star
id|ramdisk_name
op_assign
l_int|NULL
suffix:semicolon
r_char
id|commandline
(braket
id|CL_SIZE
)braket
op_assign
l_string|&quot;&quot;
suffix:semicolon
id|ProgramName
op_assign
id|argv
(braket
l_int|0
)braket
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|argc
)paren
(brace
id|argv
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|argv
(braket
l_int|0
)braket
comma
l_string|&quot;-h&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
c_func
(paren
id|argv
(braket
l_int|0
)braket
comma
l_string|&quot;--help&quot;
)paren
)paren
id|Usage
c_func
(paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|argv
(braket
l_int|0
)braket
comma
l_string|&quot;-k&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
c_func
(paren
id|argv
(braket
l_int|0
)braket
comma
l_string|&quot;--kernel&quot;
)paren
)paren
r_if
c_cond
(paren
op_decrement
id|argc
op_logical_and
op_logical_neg
id|kernel_name
)paren
(brace
id|kernel_name
op_assign
id|argv
(braket
l_int|1
)braket
suffix:semicolon
id|argv
op_increment
suffix:semicolon
)brace
r_else
id|Usage
c_func
(paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|argv
(braket
l_int|0
)braket
comma
l_string|&quot;-r&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
c_func
(paren
id|argv
(braket
l_int|0
)braket
comma
l_string|&quot;--ramdisk&quot;
)paren
)paren
r_if
c_cond
(paren
op_decrement
id|argc
op_logical_and
op_logical_neg
id|ramdisk_name
)paren
(brace
id|ramdisk_name
op_assign
id|argv
(braket
l_int|1
)braket
suffix:semicolon
id|argv
op_increment
suffix:semicolon
)brace
r_else
id|Usage
c_func
(paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|argv
(braket
l_int|0
)braket
comma
l_string|&quot;-d&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
c_func
(paren
id|argv
(braket
l_int|0
)braket
comma
l_string|&quot;--debug&quot;
)paren
)paren
id|debugflag
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|argv
(braket
l_int|0
)braket
comma
l_string|&quot;-m&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
c_func
(paren
id|argv
(braket
l_int|0
)braket
comma
l_string|&quot;--memfile&quot;
)paren
)paren
r_if
c_cond
(paren
op_decrement
id|argc
op_logical_and
op_logical_neg
id|memfile_name
)paren
(brace
id|memfile_name
op_assign
id|argv
(braket
l_int|1
)braket
suffix:semicolon
id|argv
op_increment
suffix:semicolon
)brace
r_else
id|Usage
c_func
(paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|argv
(braket
l_int|0
)braket
comma
l_string|&quot;-v&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
c_func
(paren
id|argv
(braket
l_int|0
)braket
comma
l_string|&quot;--keep-video&quot;
)paren
)paren
id|keep_video
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|argv
(braket
l_int|0
)braket
comma
l_string|&quot;-t&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
c_func
(paren
id|argv
(braket
l_int|0
)braket
comma
l_string|&quot;--model&quot;
)paren
)paren
r_if
c_cond
(paren
op_decrement
id|argc
op_logical_and
op_logical_neg
id|model
)paren
(brace
id|model
op_assign
id|atoi
c_func
(paren
id|argv
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|argv
op_increment
suffix:semicolon
)brace
r_else
id|Usage
c_func
(paren
)paren
suffix:semicolon
r_else
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|kernel_name
)paren
id|kernel_name
op_assign
l_string|&quot;vmlinux&quot;
suffix:semicolon
id|SysBase
op_assign
op_star
(paren
r_struct
id|ExecBase
op_star
op_star
)paren
l_int|4
suffix:semicolon
multiline_comment|/* open Expansion Library */
id|ExpansionBase
op_assign
(paren
r_struct
id|ExpansionBase
op_star
)paren
id|OpenLibrary
c_func
(paren
l_string|&quot;expansion.library&quot;
comma
l_int|36
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ExpansionBase
)paren
(brace
id|fputs
c_func
(paren
l_string|&quot;Unable to open expansion.library V36 or greater!  Aborting...&bslash;n&quot;
comma
id|stderr
)paren
suffix:semicolon
m_exit
(paren
id|EXIT_FAILURE
)paren
suffix:semicolon
)brace
multiline_comment|/* open Graphics Library */
id|GfxBase
op_assign
(paren
r_struct
id|GfxBase
op_star
)paren
id|OpenLibrary
(paren
l_string|&quot;graphics.library&quot;
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|GfxBase
)paren
(brace
id|fputs
c_func
(paren
l_string|&quot;Unable to open graphics.library!  Aborting...&bslash;n&quot;
comma
id|stderr
)paren
suffix:semicolon
m_exit
(paren
id|EXIT_FAILURE
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;     *&t;Join command line options&n;     */
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|argc
op_decrement
)paren
(brace
r_if
c_cond
(paren
(paren
id|i
op_plus
id|strlen
c_func
(paren
op_star
id|argv
)paren
op_plus
l_int|1
)paren
OL
id|CL_SIZE
)paren
(brace
id|i
op_add_assign
id|strlen
c_func
(paren
op_star
id|argv
)paren
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|commandline
(braket
l_int|0
)braket
)paren
id|strcat
c_func
(paren
id|commandline
comma
l_string|&quot; &quot;
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|commandline
comma
op_star
id|argv
op_increment
)paren
suffix:semicolon
)brace
)brace
id|args.kernelname
op_assign
id|kernel_name
suffix:semicolon
id|args.ramdiskname
op_assign
id|ramdisk_name
suffix:semicolon
id|args.commandline
op_assign
id|commandline
suffix:semicolon
id|args.debugflag
op_assign
id|debugflag
suffix:semicolon
id|args.keep_video
op_assign
id|keep_video
suffix:semicolon
id|args.reset_boards
op_assign
l_int|1
suffix:semicolon
id|args.puts
op_assign
id|Puts
suffix:semicolon
id|args.getchar
op_assign
id|GetChar
suffix:semicolon
id|args.putchar
op_assign
id|PutChar
suffix:semicolon
id|args.printf
op_assign
id|Printf
suffix:semicolon
id|args.open
op_assign
id|Open
suffix:semicolon
id|args.seek
op_assign
id|Seek
suffix:semicolon
id|args.read
op_assign
id|Read
suffix:semicolon
id|args.close
op_assign
id|Close
suffix:semicolon
id|args.filesize
op_assign
id|FileSize
suffix:semicolon
id|args.sleep
op_assign
id|Sleep
suffix:semicolon
id|args.modify_bootinfo
op_assign
id|ModifyBootinfo
suffix:semicolon
multiline_comment|/* Do The Right Stuff */
id|linuxboot
c_func
(paren
op_amp
id|args
)paren
suffix:semicolon
id|CloseLibrary
c_func
(paren
(paren
r_struct
id|Library
op_star
)paren
id|GfxBase
)paren
suffix:semicolon
id|CloseLibrary
c_func
(paren
(paren
r_struct
id|Library
op_star
)paren
id|ExpansionBase
)paren
suffix:semicolon
multiline_comment|/* if we ever get here, something went wrong */
m_exit
(paren
id|EXIT_FAILURE
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Routines needed by linuxboot&n;     */
DECL|function|Puts
r_static
r_void
id|Puts
c_func
(paren
r_const
r_char
op_star
id|str
)paren
(brace
id|fputs
c_func
(paren
id|str
comma
id|stderr
)paren
suffix:semicolon
)brace
DECL|function|GetChar
r_static
r_int
id|GetChar
c_func
(paren
r_void
)paren
(brace
r_return
id|getchar
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|PutChar
r_static
r_void
id|PutChar
c_func
(paren
r_char
id|c
)paren
(brace
id|fputc
c_func
(paren
id|c
comma
id|stderr
)paren
suffix:semicolon
)brace
DECL|function|Printf
r_static
r_void
id|Printf
c_func
(paren
r_const
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
id|va_list
id|args
suffix:semicolon
id|va_start
c_func
(paren
id|args
comma
id|fmt
)paren
suffix:semicolon
id|vfprintf
c_func
(paren
id|stderr
comma
id|fmt
comma
id|args
)paren
suffix:semicolon
id|va_end
c_func
(paren
id|args
)paren
suffix:semicolon
)brace
DECL|function|Open
r_static
r_int
id|Open
c_func
(paren
r_const
r_char
op_star
id|path
)paren
(brace
r_return
id|open
c_func
(paren
id|path
comma
id|O_RDONLY
)paren
suffix:semicolon
)brace
DECL|function|Seek
r_static
r_int
id|Seek
c_func
(paren
r_int
id|fd
comma
r_int
id|offset
)paren
(brace
r_return
id|lseek
c_func
(paren
id|fd
comma
id|offset
comma
id|SEEK_SET
)paren
suffix:semicolon
)brace
DECL|function|Read
r_static
r_int
id|Read
c_func
(paren
r_int
id|fd
comma
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_return
id|read
c_func
(paren
id|fd
comma
id|buf
comma
id|count
)paren
suffix:semicolon
)brace
DECL|function|Close
r_static
r_void
id|Close
c_func
(paren
r_int
id|fd
)paren
(brace
id|close
c_func
(paren
id|fd
)paren
suffix:semicolon
)brace
DECL|function|FileSize
r_static
r_int
id|FileSize
c_func
(paren
r_const
r_char
op_star
id|path
)paren
(brace
r_int
id|fd
comma
id|size
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|fd
op_assign
id|open
c_func
(paren
id|path
comma
id|O_RDONLY
)paren
)paren
op_ne
op_minus
l_int|1
)paren
(brace
id|size
op_assign
id|lseek
c_func
(paren
id|fd
comma
l_int|0
comma
id|SEEK_END
)paren
suffix:semicolon
id|close
c_func
(paren
id|fd
)paren
suffix:semicolon
)brace
r_return
id|size
suffix:semicolon
)brace
DECL|function|Sleep
r_static
r_void
id|Sleep
c_func
(paren
id|u_long
id|micros
)paren
(brace
r_struct
id|MsgPort
op_star
id|TimerPort
suffix:semicolon
r_struct
id|timerequest
op_star
id|TimerRequest
suffix:semicolon
r_if
c_cond
(paren
(paren
id|TimerPort
op_assign
id|CreateMsgPort
c_func
(paren
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|TimerRequest
op_assign
id|CreateIORequest
c_func
(paren
id|TimerPort
comma
r_sizeof
(paren
r_struct
id|timerequest
)paren
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|OpenDevice
c_func
(paren
l_string|&quot;timer.device&quot;
comma
id|UNIT_VBLANK
comma
(paren
r_struct
id|IORequest
op_star
)paren
id|TimerRequest
comma
l_int|0
)paren
)paren
(brace
id|TimerRequest-&gt;io_Command
op_assign
id|TR_ADDREQUEST
suffix:semicolon
id|TimerRequest-&gt;io_Flags
op_assign
id|IOF_QUICK
suffix:semicolon
id|TimerRequest-&gt;tv_secs
op_assign
id|micros
op_div
l_int|1000000
suffix:semicolon
id|TimerRequest-&gt;tv_micro
op_assign
id|micros
op_mod
l_int|1000000
suffix:semicolon
id|DoIO
c_func
(paren
(paren
r_struct
id|IORequest
op_star
)paren
id|TimerRequest
)paren
suffix:semicolon
id|CloseDevice
c_func
(paren
(paren
r_struct
id|IORequest
op_star
)paren
id|TimerRequest
)paren
suffix:semicolon
)brace
id|DeleteIORequest
c_func
(paren
id|TimerRequest
)paren
suffix:semicolon
)brace
id|DeleteMsgPort
c_func
(paren
id|TimerPort
)paren
suffix:semicolon
)brace
)brace
DECL|function|ModifyBootinfo
r_static
r_int
id|ModifyBootinfo
c_func
(paren
r_struct
id|bootinfo
op_star
id|bi
)paren
(brace
multiline_comment|/*&n;    * if we have a memory file, read the memory information from it&n;    */
r_if
c_cond
(paren
id|memfile_name
)paren
(brace
id|FILE
op_star
id|fp
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|fp
op_assign
id|fopen
c_func
(paren
id|memfile_name
comma
l_string|&quot;r&quot;
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|perror
c_func
(paren
l_string|&quot;open memory file&quot;
)paren
suffix:semicolon
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Cannot open memory file %s&bslash;n&quot;
comma
id|memfile_name
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fscanf
c_func
(paren
id|fp
comma
l_string|&quot;%lu&quot;
comma
op_amp
id|bi-&gt;bi_amiga.chip_size
)paren
op_ne
l_int|1
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;memory file does not contain chip memory size&bslash;n&quot;
)paren
suffix:semicolon
id|fclose
c_func
(paren
id|fp
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_MEMINFO
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|fscanf
c_func
(paren
id|fp
comma
l_string|&quot;%lx %lu&quot;
comma
op_amp
id|bi-&gt;memory
(braket
id|i
)braket
dot
id|addr
comma
op_amp
id|bi-&gt;memory
(braket
id|i
)braket
dot
id|size
)paren
op_ne
l_int|2
)paren
r_break
suffix:semicolon
)brace
id|fclose
c_func
(paren
id|fp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
id|bi-&gt;num_memory
op_logical_and
id|i
OG
l_int|0
)paren
id|bi-&gt;num_memory
op_assign
id|i
suffix:semicolon
)brace
multiline_comment|/*&n;    * change the Amiga model, if necessary&n;    */
r_if
c_cond
(paren
id|model
op_ne
id|AMI_UNKNOWN
)paren
id|bi-&gt;bi_amiga.model
op_assign
id|model
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
eof
