multiline_comment|/*&n; * Architecture-specific setup.&n; *&n; * Copyright (C) 1998-2000 Hewlett-Packard Co&n; * Copyright (C) 1998-2000 David Mosberger-Tang &lt;davidm@hpl.hp.com&gt;&n; * Copyright (C) 1998, 1999 Stephane Eranian &lt;eranian@hpl.hp.com&gt;&n; * Copyright (C) 2000, Rohit Seth &lt;rohit.seth@intel.com&gt;&n; * Copyright (C) 1999 VA Linux Systems&n; * Copyright (C) 1999 Walt Drummond &lt;drummond@valinux.com&gt;&n; *&n; * 04/04/00 D.Mosberger renamed cpu_initialized to cpu_online_map&n; * 03/31/00 R.Seth&t;cpu_initialized and current-&gt;processor fixes&n; * 02/04/00 D.Mosberger&t;some more get_cpuinfo fixes...&n; * 02/01/00 R.Seth&t;fixed get_cpuinfo for SMP&n; * 01/07/99 S.Eranian&t;added the support for command line argument&n; * 06/24/99 W.Drummond&t;added boot_cpu_data.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/reboot.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/threads.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;asm/acpi-ext.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/machvec.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/sal.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/efi.h&gt;
macro_line|#include &lt;asm/mca.h&gt;
r_extern
r_char
id|_end
suffix:semicolon
multiline_comment|/* cpu_data[bootstrap_processor] is data for the bootstrap processor: */
DECL|variable|cpu_data
r_struct
id|cpuinfo_ia64
id|cpu_data
(braket
id|NR_CPUS
)braket
suffix:semicolon
DECL|variable|ia64_cycles_per_usec
r_int
r_int
id|ia64_cycles_per_usec
suffix:semicolon
DECL|variable|ia64_boot_param
r_struct
id|ia64_boot_param
id|ia64_boot_param
suffix:semicolon
DECL|variable|screen_info
r_struct
id|screen_info
id|screen_info
suffix:semicolon
multiline_comment|/* This tells _start which CPU is booting.  */
DECL|variable|cpu_now_booting
r_int
id|cpu_now_booting
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
DECL|variable|cpu_online_map
r_volatile
r_int
r_int
id|cpu_online_map
suffix:semicolon
macro_line|#endif
DECL|macro|COMMAND_LINE_SIZE
mdefine_line|#define COMMAND_LINE_SIZE&t;512
DECL|variable|saved_command_line
r_char
id|saved_command_line
(braket
id|COMMAND_LINE_SIZE
)braket
suffix:semicolon
multiline_comment|/* used in proc filesystem */
r_static
r_int
DECL|function|find_max_pfn
id|find_max_pfn
(paren
r_int
r_int
id|start
comma
r_int
r_int
id|end
comma
r_void
op_star
id|arg
)paren
(brace
r_int
r_int
op_star
id|max_pfn
op_assign
id|arg
comma
id|pfn
suffix:semicolon
id|pfn
op_assign
(paren
id|PAGE_ALIGN
c_func
(paren
id|end
op_minus
l_int|1
)paren
op_minus
id|PAGE_OFFSET
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
r_if
c_cond
(paren
id|pfn
OG
op_star
id|max_pfn
)paren
op_star
id|max_pfn
op_assign
id|pfn
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|free_available_memory
id|free_available_memory
(paren
r_int
r_int
id|start
comma
r_int
r_int
id|end
comma
r_void
op_star
id|arg
)paren
(brace
DECL|macro|KERNEL_END
macro_line|#&t;define KERNEL_END&t;((unsigned long) &amp;_end)
DECL|macro|MIN
macro_line|#&t;define MIN(a,b)&t;&t;((a) &lt; (b) ? (a) : (b))
DECL|macro|MAX
macro_line|#&t;define MAX(a,b)&t;&t;((a) &gt; (b) ? (a) : (b))
r_int
r_int
id|range_start
comma
id|range_end
suffix:semicolon
id|range_start
op_assign
id|MIN
c_func
(paren
id|start
comma
id|KERNEL_START
)paren
suffix:semicolon
id|range_end
op_assign
id|MIN
c_func
(paren
id|end
comma
id|KERNEL_START
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * XXX This should not be necessary, but the bootmem allocator&n;&t; * is broken and fails to work correctly when the starting&n;&t; * address is not properly aligned.&n;&t; */
id|range_start
op_assign
id|PAGE_ALIGN
c_func
(paren
id|range_start
)paren
suffix:semicolon
r_if
c_cond
(paren
id|range_start
OL
id|range_end
)paren
id|free_bootmem
c_func
(paren
id|__pa
c_func
(paren
id|range_start
)paren
comma
id|range_end
op_minus
id|range_start
)paren
suffix:semicolon
id|range_start
op_assign
id|MAX
c_func
(paren
id|start
comma
id|KERNEL_END
)paren
suffix:semicolon
id|range_end
op_assign
id|MAX
c_func
(paren
id|end
comma
id|KERNEL_END
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * XXX This should not be necessary, but the bootmem allocator&n;&t; * is broken and fails to work correctly when the starting&n;&t; * address is not properly aligned.&n;&t; */
id|range_start
op_assign
id|PAGE_ALIGN
c_func
(paren
id|range_start
)paren
suffix:semicolon
r_if
c_cond
(paren
id|range_start
OL
id|range_end
)paren
id|free_bootmem
c_func
(paren
id|__pa
c_func
(paren
id|range_start
)paren
comma
id|range_end
op_minus
id|range_start
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
id|__init
DECL|function|setup_arch
id|setup_arch
(paren
r_char
op_star
op_star
id|cmdline_p
)paren
(brace
r_int
r_int
id|max_pfn
comma
id|bootmap_start
comma
id|bootmap_size
suffix:semicolon
multiline_comment|/*&n;&t; * The secondary bootstrap loader passes us the boot&n;&t; * parameters at the beginning of the ZERO_PAGE, so let&squot;s&n;&t; * stash away those values before ZERO_PAGE gets cleared out.&n;&t; */
id|memcpy
c_func
(paren
op_amp
id|ia64_boot_param
comma
(paren
r_void
op_star
)paren
id|ZERO_PAGE_ADDR
comma
r_sizeof
(paren
id|ia64_boot_param
)paren
)paren
suffix:semicolon
id|efi_init
c_func
(paren
)paren
suffix:semicolon
id|max_pfn
op_assign
l_int|0
suffix:semicolon
id|efi_memmap_walk
c_func
(paren
id|find_max_pfn
comma
op_amp
id|max_pfn
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * This is wrong, wrong, wrong.  Darn it, you&squot;d think if they&n;&t; * change APIs, they&squot;d do things for the better.  Grumble...&n;&t; */
id|bootmap_start
op_assign
id|PAGE_ALIGN
c_func
(paren
id|__pa
c_func
(paren
op_amp
id|_end
)paren
)paren
suffix:semicolon
id|bootmap_size
op_assign
id|init_bootmem
c_func
(paren
id|bootmap_start
op_rshift
id|PAGE_SHIFT
comma
id|max_pfn
)paren
suffix:semicolon
id|efi_memmap_walk
c_func
(paren
id|free_available_memory
comma
l_int|0
)paren
suffix:semicolon
id|reserve_bootmem
c_func
(paren
id|bootmap_start
comma
id|bootmap_size
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* XXX fix me */
id|init_mm.start_code
op_assign
(paren
r_int
r_int
)paren
op_amp
id|_stext
suffix:semicolon
id|init_mm.end_code
op_assign
(paren
r_int
r_int
)paren
op_amp
id|_etext
suffix:semicolon
id|init_mm.end_data
op_assign
(paren
r_int
r_int
)paren
op_amp
id|_edata
suffix:semicolon
id|init_mm.brk
op_assign
(paren
r_int
r_int
)paren
op_amp
id|_end
suffix:semicolon
id|code_resource.start
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|_text
)paren
suffix:semicolon
id|code_resource.end
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|_etext
)paren
op_minus
l_int|1
suffix:semicolon
id|data_resource.start
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|_etext
)paren
suffix:semicolon
id|data_resource.end
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|_edata
)paren
op_minus
l_int|1
suffix:semicolon
macro_line|#endif
multiline_comment|/* process SAL system table: */
id|ia64_sal_init
c_func
(paren
id|efi.sal_systab
)paren
suffix:semicolon
op_star
id|cmdline_p
op_assign
id|__va
c_func
(paren
id|ia64_boot_param.command_line
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|saved_command_line
comma
op_star
id|cmdline_p
comma
r_sizeof
(paren
id|saved_command_line
)paren
)paren
suffix:semicolon
id|saved_command_line
(braket
id|COMMAND_LINE_SIZE
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
multiline_comment|/* for safety */
id|printk
c_func
(paren
l_string|&quot;args to kernel: %s&bslash;n&quot;
comma
op_star
id|cmdline_p
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
id|bootstrap_processor
op_assign
id|hard_smp_processor_id
c_func
(paren
)paren
suffix:semicolon
id|current-&gt;processor
op_assign
id|bootstrap_processor
suffix:semicolon
macro_line|#else
id|cpu_init
c_func
(paren
)paren
suffix:semicolon
id|identify_cpu
c_func
(paren
op_amp
id|cpu_data
(braket
l_int|0
)braket
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|efi.acpi
)paren
(brace
multiline_comment|/* Parse the ACPI tables */
id|acpi_parse
c_func
(paren
id|efi.acpi
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IA64_GENERIC
id|machvec_init
c_func
(paren
id|acpi_get_sysname
c_func
(paren
)paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_VT
macro_line|# if defined(CONFIG_VGA_CONSOLE)
id|conswitchp
op_assign
op_amp
id|vga_con
suffix:semicolon
macro_line|# elif defined(CONFIG_DUMMY_CONSOLE)
id|conswitchp
op_assign
op_amp
id|dummy_con
suffix:semicolon
macro_line|# endif
macro_line|#endif
macro_line|#ifdef CONFIG_IA64_MCA
multiline_comment|/* enable IA-64 Machine Check Abort Handling */
id|ia64_mca_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|paging_init
c_func
(paren
)paren
suffix:semicolon
id|platform_setup
c_func
(paren
id|cmdline_p
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Display cpu info for all cpu&squot;s.&n; */
r_int
DECL|function|get_cpuinfo
id|get_cpuinfo
(paren
r_char
op_star
id|buffer
)paren
(brace
r_char
id|family
(braket
l_int|32
)braket
comma
id|model
(braket
l_int|32
)braket
comma
id|features
(braket
l_int|128
)braket
comma
op_star
id|cp
comma
op_star
id|p
op_assign
id|buffer
suffix:semicolon
r_struct
id|cpuinfo_ia64
op_star
id|c
suffix:semicolon
r_int
r_int
id|mask
suffix:semicolon
r_for
c_loop
(paren
id|c
op_assign
id|cpu_data
suffix:semicolon
id|c
OL
id|cpu_data
op_plus
id|NR_CPUS
suffix:semicolon
op_increment
id|c
)paren
(brace
macro_line|#ifdef CONFIG_SMP
r_if
c_cond
(paren
op_logical_neg
(paren
id|cpu_online_map
op_amp
(paren
l_int|1UL
op_lshift
(paren
id|c
op_minus
id|cpu_data
)paren
)paren
)paren
)paren
r_continue
suffix:semicolon
macro_line|#endif
id|mask
op_assign
id|c-&gt;features
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;family
op_eq
l_int|7
)paren
id|memcpy
c_func
(paren
id|family
comma
l_string|&quot;IA-64&quot;
comma
l_int|6
)paren
suffix:semicolon
r_else
id|sprintf
c_func
(paren
id|family
comma
l_string|&quot;%u&quot;
comma
id|c-&gt;family
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|c-&gt;model
)paren
(brace
r_case
l_int|0
suffix:colon
id|strcpy
c_func
(paren
id|model
comma
l_string|&quot;Itanium&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|sprintf
c_func
(paren
id|model
comma
l_string|&quot;%u&quot;
comma
id|c-&gt;model
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* build the feature string: */
id|memcpy
c_func
(paren
id|features
comma
l_string|&quot; standard&quot;
comma
l_int|10
)paren
suffix:semicolon
id|cp
op_assign
id|features
suffix:semicolon
r_if
c_cond
(paren
id|mask
op_amp
l_int|1
)paren
(brace
id|strcpy
c_func
(paren
id|cp
comma
l_string|&quot; branchlong&quot;
)paren
suffix:semicolon
id|cp
op_assign
id|strchr
c_func
(paren
id|cp
comma
l_char|&squot;&bslash;0&squot;
)paren
suffix:semicolon
id|mask
op_and_assign
op_complement
l_int|1UL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mask
)paren
id|sprintf
c_func
(paren
id|cp
comma
l_string|&quot; 0x%lx&quot;
comma
id|mask
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;CPU# %lu&bslash;n&quot;
l_string|&quot;&bslash;tvendor     : %s&bslash;n&quot;
l_string|&quot;&bslash;tfamily     : %s&bslash;n&quot;
l_string|&quot;&bslash;tmodel      : %s&bslash;n&quot;
l_string|&quot;&bslash;trevision   : %u&bslash;n&quot;
l_string|&quot;&bslash;tarchrev    : %u&bslash;n&quot;
l_string|&quot;&bslash;tfeatures   :%s&bslash;n&quot;
multiline_comment|/* don&squot;t change this---it _is_ right! */
l_string|&quot;&bslash;tcpu number : %lu&bslash;n&quot;
l_string|&quot;&bslash;tcpu regs   : %u&bslash;n&quot;
l_string|&quot;&bslash;tcpu MHz    : %lu.%06lu&bslash;n&quot;
l_string|&quot;&bslash;titc MHz    : %lu.%06lu&bslash;n&quot;
l_string|&quot;&bslash;tBogoMIPS   : %lu.%02lu&bslash;n&bslash;n&quot;
comma
id|c
op_minus
id|cpu_data
comma
id|c-&gt;vendor
comma
id|family
comma
id|model
comma
id|c-&gt;revision
comma
id|c-&gt;archrev
comma
id|features
comma
id|c-&gt;ppn
comma
id|c-&gt;number
comma
id|c-&gt;proc_freq
op_div
l_int|1000000
comma
id|c-&gt;proc_freq
op_mod
l_int|1000000
comma
id|c-&gt;itc_freq
op_div
l_int|1000000
comma
id|c-&gt;itc_freq
op_mod
l_int|1000000
comma
id|loops_per_sec
c_func
(paren
)paren
op_div
l_int|500000
comma
(paren
id|loops_per_sec
c_func
(paren
)paren
op_div
l_int|5000
)paren
op_mod
l_int|100
)paren
suffix:semicolon
)brace
r_return
id|p
op_minus
id|buffer
suffix:semicolon
)brace
r_void
DECL|function|identify_cpu
id|identify_cpu
(paren
r_struct
id|cpuinfo_ia64
op_star
id|c
)paren
(brace
r_union
(brace
r_int
r_int
id|bits
(braket
l_int|5
)braket
suffix:semicolon
r_struct
(brace
multiline_comment|/* id 0 &amp; 1: */
r_char
id|vendor
(braket
l_int|16
)braket
suffix:semicolon
multiline_comment|/* id 2 */
id|u64
id|ppn
suffix:semicolon
multiline_comment|/* processor serial number */
multiline_comment|/* id 3: */
r_int
id|number
suffix:colon
l_int|8
suffix:semicolon
r_int
id|revision
suffix:colon
l_int|8
suffix:semicolon
r_int
id|model
suffix:colon
l_int|8
suffix:semicolon
r_int
id|family
suffix:colon
l_int|8
suffix:semicolon
r_int
id|archrev
suffix:colon
l_int|8
suffix:semicolon
r_int
id|reserved
suffix:colon
l_int|24
suffix:semicolon
multiline_comment|/* id 4: */
id|u64
id|features
suffix:semicolon
)brace
id|field
suffix:semicolon
)brace
id|cpuid
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
op_increment
id|i
)paren
(brace
id|cpuid.bits
(braket
id|i
)braket
op_assign
id|ia64_get_cpuid
c_func
(paren
id|i
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SMP
multiline_comment|/*&n;&t; * XXX Instead of copying the ITC info from the bootstrap&n;&t; * processor, ia64_init_itm() should be done per CPU.  That&n;&t; * should get you the right info.  --davidm 1/24/00&n;&t; */
r_if
c_cond
(paren
id|c
op_ne
op_amp
id|cpu_data
(braket
id|bootstrap_processor
)braket
)paren
(brace
id|memset
c_func
(paren
id|c
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|cpuinfo_ia64
)paren
)paren
suffix:semicolon
id|c-&gt;proc_freq
op_assign
id|cpu_data
(braket
id|bootstrap_processor
)braket
dot
id|proc_freq
suffix:semicolon
id|c-&gt;itc_freq
op_assign
id|cpu_data
(braket
id|bootstrap_processor
)braket
dot
id|itc_freq
suffix:semicolon
id|c-&gt;cyc_per_usec
op_assign
id|cpu_data
(braket
id|bootstrap_processor
)braket
dot
id|cyc_per_usec
suffix:semicolon
id|c-&gt;usec_per_cyc
op_assign
id|cpu_data
(braket
id|bootstrap_processor
)braket
dot
id|usec_per_cyc
suffix:semicolon
)brace
macro_line|#else
id|memset
c_func
(paren
id|c
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|cpuinfo_ia64
)paren
)paren
suffix:semicolon
macro_line|#endif
id|memcpy
c_func
(paren
id|c-&gt;vendor
comma
id|cpuid.field.vendor
comma
l_int|16
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_IA64_SOFTSDV_HACKS
multiline_comment|/* BUG: SoftSDV doesn&squot;t support the cpuid registers. */
r_if
c_cond
(paren
id|c-&gt;vendor
(braket
l_int|0
)braket
op_eq
l_char|&squot;&bslash;0&squot;
)paren
id|memcpy
c_func
(paren
id|c-&gt;vendor
comma
l_string|&quot;Intel&quot;
comma
l_int|6
)paren
suffix:semicolon
macro_line|#endif                                   
id|c-&gt;ppn
op_assign
id|cpuid.field.ppn
suffix:semicolon
id|c-&gt;number
op_assign
id|cpuid.field.number
suffix:semicolon
id|c-&gt;revision
op_assign
id|cpuid.field.revision
suffix:semicolon
id|c-&gt;model
op_assign
id|cpuid.field.model
suffix:semicolon
id|c-&gt;family
op_assign
id|cpuid.field.family
suffix:semicolon
id|c-&gt;archrev
op_assign
id|cpuid.field.archrev
suffix:semicolon
id|c-&gt;features
op_assign
id|cpuid.field.features
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
id|c-&gt;loops_per_sec
op_assign
id|loops_per_sec
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * cpu_init() initializes state that is per-CPU.  This function acts&n; * as a &squot;CPU state barrier&squot;, nothing should get across.&n; */
r_void
DECL|function|cpu_init
id|cpu_init
(paren
r_void
)paren
(brace
multiline_comment|/* Clear the stack memory reserved for pt_regs: */
id|memset
c_func
(paren
id|ia64_task_regs
c_func
(paren
id|current
)paren
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pt_regs
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Initialize default control register to defer speculative&n;&t; * faults.  On a speculative load, we want to defer access&n;&t; * right, key miss, and key permission faults.  We currently&n;&t; * do NOT defer TLB misses, page-not-present, access bit, or&n;&t; * debug faults but kernel code should not rely on any&n;&t; * particular setting of these bits.&n;&t; */
id|ia64_set_dcr
c_func
(paren
id|IA64_DCR_DR
op_or
id|IA64_DCR_DK
op_or
id|IA64_DCR_DX
op_or
id|IA64_DCR_PP
)paren
suffix:semicolon
id|ia64_set_fpu_owner
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* initialize ar.k5 */
id|atomic_inc
c_func
(paren
op_amp
id|init_mm.mm_count
)paren
suffix:semicolon
id|current-&gt;active_mm
op_assign
op_amp
id|init_mm
suffix:semicolon
)brace
eof
