multiline_comment|/*&n; * Extensible Firmware Interface&n; *&n; * Based on Extensible Firmware Interface Specification version 0.9 April 30, 1999&n; *&n; * Copyright (C) 1999 VA Linux Systems&n; * Copyright (C) 1999 Walt Drummond &lt;drummond@valinux.com&gt;&n; * Copyright (C) 1999-2000 Hewlett-Packard Co.&n; * Copyright (C) 1999 David Mosberger-Tang &lt;davidm@hpl.hp.com&gt;&n; * Copyright (C) 1999-2000 Stephane Eranian &lt;eranian@hpl.hp.com&gt;&n; *&n; * All EFI Runtime Services are not implemented yet as EFI only&n; * supports physical mode addressing on SoftSDV. This is to be fixed&n; * in a future version.  --drummond 1999-07-20&n; *&n; * Implemented EFI runtime services and virtual mode calls.  --davidm&n; *&n; * Goutham Rao: &lt;goutham.rao@intel.com&gt;&n; * &t;Skip non-WB memory and ignore empty memory ranges.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;asm/efi.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
DECL|macro|EFI_DEBUG
mdefine_line|#define EFI_DEBUG&t;0
r_extern
id|efi_status_t
id|efi_call_phys
(paren
r_void
op_star
comma
dot
dot
dot
)paren
suffix:semicolon
DECL|variable|efi
r_struct
id|efi
id|efi
suffix:semicolon
DECL|variable|runtime
r_static
id|efi_runtime_services_t
op_star
id|runtime
suffix:semicolon
DECL|variable|mem_limit
r_static
r_int
r_int
id|mem_limit
op_assign
op_complement
l_int|0UL
suffix:semicolon
r_static
id|efi_status_t
DECL|function|phys_get_time
id|phys_get_time
(paren
id|efi_time_t
op_star
id|tm
comma
id|efi_time_cap_t
op_star
id|tc
)paren
(brace
r_return
id|efi_call_phys
c_func
(paren
id|__va
c_func
(paren
id|runtime-&gt;get_time
)paren
comma
id|__pa
c_func
(paren
id|tm
)paren
comma
id|__pa
c_func
(paren
id|tc
)paren
)paren
suffix:semicolon
)brace
r_static
id|efi_status_t
DECL|function|phys_set_time
id|phys_set_time
(paren
id|efi_time_t
op_star
id|tm
)paren
(brace
r_return
id|efi_call_phys
c_func
(paren
id|__va
c_func
(paren
id|runtime-&gt;set_time
)paren
comma
id|__pa
c_func
(paren
id|tm
)paren
)paren
suffix:semicolon
)brace
r_static
id|efi_status_t
DECL|function|phys_get_wakeup_time
id|phys_get_wakeup_time
(paren
id|efi_bool_t
op_star
id|enabled
comma
id|efi_bool_t
op_star
id|pending
comma
id|efi_time_t
op_star
id|tm
)paren
(brace
r_return
id|efi_call_phys
c_func
(paren
id|__va
c_func
(paren
id|runtime-&gt;get_wakeup_time
)paren
comma
id|__pa
c_func
(paren
id|enabled
)paren
comma
id|__pa
c_func
(paren
id|pending
)paren
comma
id|__pa
c_func
(paren
id|tm
)paren
)paren
suffix:semicolon
)brace
r_static
id|efi_status_t
DECL|function|phys_set_wakeup_time
id|phys_set_wakeup_time
(paren
id|efi_bool_t
id|enabled
comma
id|efi_time_t
op_star
id|tm
)paren
(brace
r_return
id|efi_call_phys
c_func
(paren
id|__va
c_func
(paren
id|runtime-&gt;set_wakeup_time
)paren
comma
id|enabled
comma
id|__pa
c_func
(paren
id|tm
)paren
)paren
suffix:semicolon
)brace
r_static
id|efi_status_t
DECL|function|phys_get_variable
id|phys_get_variable
(paren
id|efi_char16_t
op_star
id|name
comma
id|efi_guid_t
op_star
id|vendor
comma
id|u32
op_star
id|attr
comma
r_int
r_int
op_star
id|data_size
comma
r_void
op_star
id|data
)paren
(brace
r_return
id|efi_call_phys
c_func
(paren
id|__va
c_func
(paren
id|runtime-&gt;get_variable
)paren
comma
id|__pa
c_func
(paren
id|name
)paren
comma
id|__pa
c_func
(paren
id|vendor
)paren
comma
id|__pa
c_func
(paren
id|attr
)paren
comma
id|__pa
c_func
(paren
id|data_size
)paren
comma
id|__pa
c_func
(paren
id|data
)paren
)paren
suffix:semicolon
)brace
r_static
id|efi_status_t
DECL|function|phys_get_next_variable
id|phys_get_next_variable
(paren
r_int
r_int
op_star
id|name_size
comma
id|efi_char16_t
op_star
id|name
comma
id|efi_guid_t
op_star
id|vendor
)paren
(brace
r_return
id|efi_call_phys
c_func
(paren
id|__va
c_func
(paren
id|runtime-&gt;get_next_variable
)paren
comma
id|__pa
c_func
(paren
id|name_size
)paren
comma
id|__pa
c_func
(paren
id|name
)paren
comma
id|__pa
c_func
(paren
id|vendor
)paren
)paren
suffix:semicolon
)brace
r_static
id|efi_status_t
DECL|function|phys_set_variable
id|phys_set_variable
(paren
id|efi_char16_t
op_star
id|name
comma
id|efi_guid_t
op_star
id|vendor
comma
id|u32
id|attr
comma
r_int
r_int
id|data_size
comma
r_void
op_star
id|data
)paren
(brace
r_return
id|efi_call_phys
c_func
(paren
id|__va
c_func
(paren
id|runtime-&gt;set_variable
)paren
comma
id|__pa
c_func
(paren
id|name
)paren
comma
id|__pa
c_func
(paren
id|vendor
)paren
comma
id|attr
comma
id|data_size
comma
id|__pa
c_func
(paren
id|data
)paren
)paren
suffix:semicolon
)brace
r_static
id|efi_status_t
DECL|function|phys_get_next_high_mono_count
id|phys_get_next_high_mono_count
(paren
id|u64
op_star
id|count
)paren
(brace
r_return
id|efi_call_phys
c_func
(paren
id|__va
c_func
(paren
id|runtime-&gt;get_next_high_mono_count
)paren
comma
id|__pa
c_func
(paren
id|count
)paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|phys_reset_system
id|phys_reset_system
(paren
r_int
id|reset_type
comma
id|efi_status_t
id|status
comma
r_int
r_int
id|data_size
comma
id|efi_char16_t
op_star
id|data
)paren
(brace
id|efi_call_phys
c_func
(paren
id|__va
c_func
(paren
id|runtime-&gt;reset_system
)paren
comma
id|status
comma
id|data_size
comma
id|__pa
c_func
(paren
id|data
)paren
)paren
suffix:semicolon
)brace
r_void
DECL|function|efi_gettimeofday
id|efi_gettimeofday
(paren
r_struct
id|timeval
op_star
id|tv
)paren
(brace
id|efi_time_t
id|tm
suffix:semicolon
id|memset
c_func
(paren
id|tv
comma
l_int|0
comma
r_sizeof
(paren
id|tv
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|efi.get_time
)paren
(paren
op_amp
id|tm
comma
l_int|0
)paren
op_ne
id|EFI_SUCCESS
)paren
r_return
suffix:semicolon
id|tv-&gt;tv_sec
op_assign
id|mktime
c_func
(paren
id|tm.year
comma
id|tm.month
comma
id|tm.day
comma
id|tm.hour
comma
id|tm.minute
comma
id|tm.second
)paren
suffix:semicolon
id|tv-&gt;tv_usec
op_assign
id|tm.nanosecond
op_div
l_int|1000
suffix:semicolon
)brace
multiline_comment|/*&n; * Walks the EFI memory map and calls CALLBACK once for each EFI&n; * memory descriptor that has memory that is available for OS use.&n; */
r_void
DECL|function|efi_memmap_walk
id|efi_memmap_walk
(paren
id|efi_freemem_callback_t
id|callback
comma
r_void
op_star
id|arg
)paren
(brace
r_int
id|prev_valid
op_assign
l_int|0
suffix:semicolon
r_struct
id|range
(brace
id|u64
id|start
suffix:semicolon
id|u64
id|end
suffix:semicolon
)brace
id|prev
comma
id|curr
suffix:semicolon
r_void
op_star
id|efi_map_start
comma
op_star
id|efi_map_end
comma
op_star
id|p
suffix:semicolon
id|efi_memory_desc_t
op_star
id|md
suffix:semicolon
id|u64
id|efi_desc_size
comma
id|start
comma
id|end
suffix:semicolon
id|efi_map_start
op_assign
id|__va
c_func
(paren
id|ia64_boot_param.efi_memmap
)paren
suffix:semicolon
id|efi_map_end
op_assign
id|efi_map_start
op_plus
id|ia64_boot_param.efi_memmap_size
suffix:semicolon
id|efi_desc_size
op_assign
id|ia64_boot_param.efi_memdesc_size
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|efi_map_start
suffix:semicolon
id|p
OL
id|efi_map_end
suffix:semicolon
id|p
op_add_assign
id|efi_desc_size
)paren
(brace
id|md
op_assign
id|p
suffix:semicolon
r_switch
c_cond
(paren
id|md-&gt;type
)paren
(brace
r_case
id|EFI_LOADER_CODE
suffix:colon
r_case
id|EFI_LOADER_DATA
suffix:colon
r_case
id|EFI_BOOT_SERVICES_CODE
suffix:colon
r_case
id|EFI_BOOT_SERVICES_DATA
suffix:colon
r_case
id|EFI_CONVENTIONAL_MEMORY
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|md-&gt;attribute
op_amp
id|EFI_MEMORY_WB
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|md-&gt;phys_addr
op_plus
(paren
id|md-&gt;num_pages
op_lshift
l_int|12
)paren
OG
id|mem_limit
)paren
(brace
r_if
c_cond
(paren
id|md-&gt;phys_addr
OG
id|mem_limit
)paren
r_continue
suffix:semicolon
id|md-&gt;num_pages
op_assign
(paren
id|mem_limit
op_minus
id|md-&gt;phys_addr
)paren
op_rshift
l_int|12
suffix:semicolon
)brace
r_if
c_cond
(paren
id|md-&gt;num_pages
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;efi_memmap_walk: ignoring empty region at 0x%lx&quot;
comma
id|md-&gt;phys_addr
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|curr.start
op_assign
id|PAGE_OFFSET
op_plus
id|md-&gt;phys_addr
suffix:semicolon
id|curr.end
op_assign
id|curr.start
op_plus
(paren
id|md-&gt;num_pages
op_lshift
l_int|12
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|prev_valid
)paren
(brace
id|prev
op_assign
id|curr
suffix:semicolon
id|prev_valid
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|curr.start
OL
id|prev.start
)paren
id|printk
c_func
(paren
l_string|&quot;Oops: EFI memory table not ordered!&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|prev.end
op_eq
id|curr.start
)paren
(brace
multiline_comment|/* merge two consecutive memory ranges */
id|prev.end
op_assign
id|curr.end
suffix:semicolon
)brace
r_else
(brace
id|start
op_assign
id|PAGE_ALIGN
c_func
(paren
id|prev.start
)paren
suffix:semicolon
id|end
op_assign
id|prev.end
op_amp
id|PAGE_MASK
suffix:semicolon
r_if
c_cond
(paren
(paren
id|end
OG
id|start
)paren
op_logical_and
(paren
op_star
id|callback
)paren
(paren
id|start
comma
id|end
comma
id|arg
)paren
OL
l_int|0
)paren
r_return
suffix:semicolon
id|prev
op_assign
id|curr
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_continue
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|prev_valid
)paren
(brace
id|start
op_assign
id|PAGE_ALIGN
c_func
(paren
id|prev.start
)paren
suffix:semicolon
id|end
op_assign
id|prev.end
op_amp
id|PAGE_MASK
suffix:semicolon
r_if
c_cond
(paren
id|end
OG
id|start
)paren
(paren
op_star
id|callback
)paren
(paren
id|start
comma
id|end
comma
id|arg
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Look for the PAL_CODE region reported by EFI and maps it using an&n; * ITR to enable safe PAL calls in virtual mode.  See IA-64 Processor&n; * Abstraction Layer chapter 11 in ADAG&n; */
r_void
DECL|function|efi_map_pal_code
id|efi_map_pal_code
(paren
r_void
)paren
(brace
r_void
op_star
id|efi_map_start
comma
op_star
id|efi_map_end
comma
op_star
id|p
suffix:semicolon
id|efi_memory_desc_t
op_star
id|md
suffix:semicolon
id|u64
id|efi_desc_size
suffix:semicolon
r_int
id|pal_code_count
op_assign
l_int|0
suffix:semicolon
id|u64
id|mask
comma
id|flags
suffix:semicolon
id|u64
id|vaddr
suffix:semicolon
id|efi_map_start
op_assign
id|__va
c_func
(paren
id|ia64_boot_param.efi_memmap
)paren
suffix:semicolon
id|efi_map_end
op_assign
id|efi_map_start
op_plus
id|ia64_boot_param.efi_memmap_size
suffix:semicolon
id|efi_desc_size
op_assign
id|ia64_boot_param.efi_memdesc_size
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|efi_map_start
suffix:semicolon
id|p
OL
id|efi_map_end
suffix:semicolon
id|p
op_add_assign
id|efi_desc_size
)paren
(brace
id|md
op_assign
id|p
suffix:semicolon
r_if
c_cond
(paren
id|md-&gt;type
op_ne
id|EFI_PAL_CODE
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|pal_code_count
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Too many EFI Pal Code memory ranges, dropped @ %lx&bslash;n&quot;
comma
id|md-&gt;phys_addr
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * We must use the same page size as the one used&n;&t;&t; * for the kernel region when we map the PAL code.&n;&t;&t; * This way, we avoid overlapping TRs if code is &n;&t;&t; * executed nearby. The Alt I-TLB installs 256MB&n;&t;&t; * page sizes as defined for region 7.&n;&t;&t; *&n;&t;&t; * XXX Fixme: should be dynamic here (for page size)&n;&t;&t; */
id|mask
op_assign
op_complement
(paren
(paren
l_int|1
op_lshift
id|_PAGE_SIZE_256M
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|vaddr
op_assign
id|PAGE_OFFSET
op_plus
id|md-&gt;phys_addr
suffix:semicolon
multiline_comment|/*&n;&t;&t; * We must check that the PAL mapping won&squot;t overlap&n;&t;&t; * with the kernel mapping on ITR1. &n;&t;&t; *&n;&t;&t; * PAL code is guaranteed to be aligned on a power of 2&n;&t;&t; * between 4k and 256KB.&n;&t;&t; * Also from the documentation, it seems like there is an&n;&t;&t; * implicit guarantee that you will need only ONE ITR to&n;&t;&t; * map it. This implies that the PAL code is always aligned&n;&t;&t; * on its size, i.e., the closest matching page size supported&n;&t;&t; * by the TLB. Therefore PAL code is guaranteed never to cross&n;&t;&t; * a 256MB unless it is bigger than 256MB (very unlikely!).&n;&t;&t; * So for now the following test is enough to determine whether&n;&t;&t; * or not we need a dedicated ITR for the PAL code.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|vaddr
op_amp
id|mask
)paren
op_eq
(paren
id|PAGE_OFFSET
op_amp
id|mask
)paren
)paren
(brace
id|printk
c_func
(paren
id|__FUNCTION__
l_string|&quot; : no need to install ITR for PAL Code&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;CPU %d: mapping PAL code [0x%lx-0x%lx) into [0x%lx-0x%lx)&bslash;n&quot;
comma
id|smp_processor_id
c_func
(paren
)paren
comma
id|md-&gt;phys_addr
comma
id|md-&gt;phys_addr
op_plus
(paren
id|md-&gt;num_pages
op_lshift
l_int|12
)paren
comma
id|vaddr
op_amp
id|mask
comma
(paren
id|vaddr
op_amp
id|mask
)paren
op_plus
l_int|256
op_star
l_int|1024
op_star
l_int|1024
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Cannot write to CRx with PSR.ic=1&n;&t;&t; */
id|ia64_clear_ic
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * ITR0/DTR0: used for kernel code/data&n;&t;&t; * ITR1/DTR1: used by HP simulator&n;&t;&t; * ITR2/DTR2: map PAL code&n;&t;&t; */
id|ia64_itr
c_func
(paren
l_int|0x1
comma
l_int|2
comma
id|vaddr
op_amp
id|mask
comma
id|pte_val
c_func
(paren
id|mk_pte_phys
c_func
(paren
id|md-&gt;phys_addr
comma
id|__pgprot
c_func
(paren
id|__DIRTY_BITS
op_or
id|_PAGE_PL_0
op_or
id|_PAGE_AR_RX
)paren
)paren
)paren
comma
id|_PAGE_SIZE_256M
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
id|ia64_srlz_i
(paren
)paren
suffix:semicolon
)brace
)brace
r_void
id|__init
DECL|function|efi_init
id|efi_init
(paren
r_void
)paren
(brace
r_void
op_star
id|efi_map_start
comma
op_star
id|efi_map_end
suffix:semicolon
id|efi_config_table_t
op_star
id|config_tables
suffix:semicolon
id|efi_char16_t
op_star
id|c16
suffix:semicolon
id|u64
id|efi_desc_size
suffix:semicolon
r_char
op_star
id|cp
comma
op_star
id|end
comma
id|vendor
(braket
l_int|100
)braket
op_assign
l_string|&quot;unknown&quot;
suffix:semicolon
r_extern
r_char
id|saved_command_line
(braket
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* it&squot;s too early to be able to use the standard kernel command line support... */
r_for
c_loop
(paren
id|cp
op_assign
id|saved_command_line
suffix:semicolon
op_star
id|cp
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|cp
comma
l_string|&quot;mem=&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
(brace
id|cp
op_add_assign
l_int|4
suffix:semicolon
id|mem_limit
op_assign
id|memparse
c_func
(paren
id|cp
comma
op_amp
id|end
)paren
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|end
op_ne
id|cp
)paren
r_break
suffix:semicolon
id|cp
op_assign
id|end
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
op_star
id|cp
op_ne
l_char|&squot; &squot;
op_logical_and
op_star
id|cp
)paren
op_increment
id|cp
suffix:semicolon
r_while
c_loop
(paren
op_star
id|cp
op_eq
l_char|&squot; &squot;
)paren
op_increment
id|cp
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|mem_limit
op_ne
op_complement
l_int|0UL
)paren
id|printk
c_func
(paren
l_string|&quot;Ignoring memory above %luMB&bslash;n&quot;
comma
id|mem_limit
op_rshift
l_int|20
)paren
suffix:semicolon
id|efi.systab
op_assign
id|__va
c_func
(paren
id|ia64_boot_param.efi_systab
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Verify the EFI Table&n; &t; */
r_if
c_cond
(paren
id|efi.systab
op_eq
l_int|NULL
)paren
id|panic
c_func
(paren
l_string|&quot;Woah! Can&squot;t find EFI system table.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|efi.systab-&gt;hdr.signature
op_ne
id|EFI_SYSTEM_TABLE_SIGNATURE
)paren
id|panic
c_func
(paren
l_string|&quot;Woah! EFI system table signature incorrect&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|efi.systab-&gt;hdr.revision
op_xor
id|EFI_SYSTEM_TABLE_REVISION
)paren
op_rshift
l_int|16
op_ne
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;Warning: EFI system table major version mismatch: &quot;
l_string|&quot;got %d.%02d, expected %d.%02d&bslash;n&quot;
comma
id|efi.systab-&gt;hdr.revision
op_rshift
l_int|16
comma
id|efi.systab-&gt;hdr.revision
op_amp
l_int|0xffff
comma
id|EFI_SYSTEM_TABLE_REVISION
op_rshift
l_int|16
comma
id|EFI_SYSTEM_TABLE_REVISION
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|config_tables
op_assign
id|__va
c_func
(paren
id|efi.systab-&gt;tables
)paren
suffix:semicolon
multiline_comment|/* Show what we know for posterity */
id|c16
op_assign
id|__va
c_func
(paren
id|efi.systab-&gt;fw_vendor
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c16
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|vendor
)paren
op_logical_and
op_star
id|c16
suffix:semicolon
op_increment
id|i
)paren
id|vendor
(braket
id|i
)braket
op_assign
op_star
id|c16
op_increment
suffix:semicolon
id|vendor
(braket
id|i
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;EFI v%u.%.02u by %s:&quot;
comma
id|efi.systab-&gt;hdr.revision
op_rshift
l_int|16
comma
id|efi.systab-&gt;hdr.revision
op_amp
l_int|0xffff
comma
id|vendor
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|efi.systab-&gt;nr_tables
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|efi_guidcmp
c_func
(paren
id|config_tables
(braket
id|i
)braket
dot
id|guid
comma
id|MPS_TABLE_GUID
)paren
op_eq
l_int|0
)paren
(brace
id|efi.mps
op_assign
id|__va
c_func
(paren
id|config_tables
(braket
id|i
)braket
dot
id|table
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; MPS=0x%lx&quot;
comma
id|config_tables
(braket
id|i
)braket
dot
id|table
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|efi_guidcmp
c_func
(paren
id|config_tables
(braket
id|i
)braket
dot
id|guid
comma
id|ACPI_20_TABLE_GUID
)paren
op_eq
l_int|0
)paren
(brace
id|efi.acpi20
op_assign
id|__va
c_func
(paren
id|config_tables
(braket
id|i
)braket
dot
id|table
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; ACPI 2.0=0x%lx&quot;
comma
id|config_tables
(braket
id|i
)braket
dot
id|table
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|efi_guidcmp
c_func
(paren
id|config_tables
(braket
id|i
)braket
dot
id|guid
comma
id|ACPI_TABLE_GUID
)paren
op_eq
l_int|0
)paren
(brace
id|efi.acpi
op_assign
id|__va
c_func
(paren
id|config_tables
(braket
id|i
)braket
dot
id|table
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; ACPI=0x%lx&quot;
comma
id|config_tables
(braket
id|i
)braket
dot
id|table
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|efi_guidcmp
c_func
(paren
id|config_tables
(braket
id|i
)braket
dot
id|guid
comma
id|SMBIOS_TABLE_GUID
)paren
op_eq
l_int|0
)paren
(brace
id|efi.smbios
op_assign
id|__va
c_func
(paren
id|config_tables
(braket
id|i
)braket
dot
id|table
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; SMBIOS=0x%lx&quot;
comma
id|config_tables
(braket
id|i
)braket
dot
id|table
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|efi_guidcmp
c_func
(paren
id|config_tables
(braket
id|i
)braket
dot
id|guid
comma
id|SAL_SYSTEM_TABLE_GUID
)paren
op_eq
l_int|0
)paren
(brace
id|efi.sal_systab
op_assign
id|__va
c_func
(paren
id|config_tables
(braket
id|i
)braket
dot
id|table
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; SALsystab=0x%lx&quot;
comma
id|config_tables
(braket
id|i
)braket
dot
id|table
)paren
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|runtime
op_assign
id|__va
c_func
(paren
id|efi.systab-&gt;runtime
)paren
suffix:semicolon
id|efi.get_time
op_assign
id|phys_get_time
suffix:semicolon
id|efi.set_time
op_assign
id|phys_set_time
suffix:semicolon
id|efi.get_wakeup_time
op_assign
id|phys_get_wakeup_time
suffix:semicolon
id|efi.set_wakeup_time
op_assign
id|phys_set_wakeup_time
suffix:semicolon
id|efi.get_variable
op_assign
id|phys_get_variable
suffix:semicolon
id|efi.get_next_variable
op_assign
id|phys_get_next_variable
suffix:semicolon
id|efi.set_variable
op_assign
id|phys_set_variable
suffix:semicolon
id|efi.get_next_high_mono_count
op_assign
id|phys_get_next_high_mono_count
suffix:semicolon
id|efi.reset_system
op_assign
id|phys_reset_system
suffix:semicolon
id|efi_map_start
op_assign
id|__va
c_func
(paren
id|ia64_boot_param.efi_memmap
)paren
suffix:semicolon
id|efi_map_end
op_assign
id|efi_map_start
op_plus
id|ia64_boot_param.efi_memmap_size
suffix:semicolon
id|efi_desc_size
op_assign
id|ia64_boot_param.efi_memdesc_size
suffix:semicolon
macro_line|#if EFI_DEBUG
multiline_comment|/* print EFI memory map: */
(brace
id|efi_memory_desc_t
op_star
id|md
suffix:semicolon
r_void
op_star
id|p
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|p
op_assign
id|efi_map_start
suffix:semicolon
id|p
OL
id|efi_map_end
suffix:semicolon
op_increment
id|i
comma
id|p
op_add_assign
id|efi_desc_size
)paren
(brace
id|md
op_assign
id|p
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;mem%02u: type=%u, attr=0x%lx, range=[0x%016lx-0x%016lx) (%luMB)&bslash;n&quot;
comma
id|i
comma
id|md-&gt;type
comma
id|md-&gt;attribute
comma
id|md-&gt;phys_addr
comma
id|md-&gt;phys_addr
op_plus
(paren
id|md-&gt;num_pages
op_lshift
l_int|12
)paren
op_minus
l_int|1
comma
id|md-&gt;num_pages
op_rshift
l_int|8
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
id|efi_map_pal_code
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifndef CONFIG_IA64_SOFTSDV_HACKS
multiline_comment|/*&n;&t; * (Some) SoftSDVs seem to have a problem with this call.&n;&t; * Since it&squot;s mostly a performance optimization, just don&squot;t do&n;&t; * it for now...  --davidm 99/12/6&n;&t; */
id|efi_enter_virtual_mode
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
)brace
r_void
DECL|function|efi_enter_virtual_mode
id|efi_enter_virtual_mode
(paren
r_void
)paren
(brace
r_void
op_star
id|efi_map_start
comma
op_star
id|efi_map_end
comma
op_star
id|p
suffix:semicolon
id|efi_memory_desc_t
op_star
id|md
suffix:semicolon
id|efi_status_t
id|status
suffix:semicolon
id|u64
id|efi_desc_size
suffix:semicolon
id|efi_map_start
op_assign
id|__va
c_func
(paren
id|ia64_boot_param.efi_memmap
)paren
suffix:semicolon
id|efi_map_end
op_assign
id|efi_map_start
op_plus
id|ia64_boot_param.efi_memmap_size
suffix:semicolon
id|efi_desc_size
op_assign
id|ia64_boot_param.efi_memdesc_size
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|efi_map_start
suffix:semicolon
id|p
OL
id|efi_map_end
suffix:semicolon
id|p
op_add_assign
id|efi_desc_size
)paren
(brace
id|md
op_assign
id|p
suffix:semicolon
r_if
c_cond
(paren
id|md-&gt;attribute
op_amp
id|EFI_MEMORY_RUNTIME
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Some descriptors have multiple bits set, so the order of&n;&t;&t;&t; * the tests is relevant.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|md-&gt;attribute
op_amp
id|EFI_MEMORY_WB
)paren
(brace
id|md-&gt;virt_addr
op_assign
(paren
id|u64
)paren
id|__va
c_func
(paren
id|md-&gt;phys_addr
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|md-&gt;attribute
op_amp
id|EFI_MEMORY_UC
)paren
(brace
id|md-&gt;virt_addr
op_assign
(paren
id|u64
)paren
id|ioremap
c_func
(paren
id|md-&gt;phys_addr
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|md-&gt;attribute
op_amp
id|EFI_MEMORY_WC
)paren
(brace
macro_line|#if 0
id|md-&gt;virt_addr
op_assign
id|ia64_remap
c_func
(paren
id|md-&gt;phys_addr
comma
(paren
id|_PAGE_A
op_or
id|_PAGE_P
op_or
id|_PAGE_D
op_or
id|_PAGE_MA_WC
op_or
id|_PAGE_PL_0
op_or
id|_PAGE_AR_RW
)paren
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
l_string|&quot;EFI_MEMORY_WC mapping&bslash;n&quot;
)paren
suffix:semicolon
id|md-&gt;virt_addr
op_assign
(paren
id|u64
)paren
id|ioremap
c_func
(paren
id|md-&gt;phys_addr
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
r_if
c_cond
(paren
id|md-&gt;attribute
op_amp
id|EFI_MEMORY_WT
)paren
(brace
macro_line|#if 0
id|md-&gt;virt_addr
op_assign
id|ia64_remap
c_func
(paren
id|md-&gt;phys_addr
comma
(paren
id|_PAGE_A
op_or
id|_PAGE_P
op_or
id|_PAGE_D
op_or
id|_PAGE_MA_WT
op_or
id|_PAGE_PL_0
op_or
id|_PAGE_AR_RW
)paren
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
l_string|&quot;EFI_MEMORY_WT mapping&bslash;n&quot;
)paren
suffix:semicolon
id|md-&gt;virt_addr
op_assign
(paren
id|u64
)paren
id|ioremap
c_func
(paren
id|md-&gt;phys_addr
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
)brace
id|status
op_assign
id|efi_call_phys
c_func
(paren
id|__va
c_func
(paren
id|runtime-&gt;set_virtual_address_map
)paren
comma
id|ia64_boot_param.efi_memmap_size
comma
id|efi_desc_size
comma
id|ia64_boot_param.efi_memdesc_version
comma
id|ia64_boot_param.efi_memmap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
id|EFI_SUCCESS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Warning: unable to switch EFI into virtual mode (status=%lu)&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Now that EFI is in virtual mode, we arrange for EFI functions to be&n;&t; * called directly:&n;&t; */
id|efi.get_time
op_assign
id|__va
c_func
(paren
id|runtime-&gt;get_time
)paren
suffix:semicolon
id|efi.set_time
op_assign
id|__va
c_func
(paren
id|runtime-&gt;set_time
)paren
suffix:semicolon
id|efi.get_wakeup_time
op_assign
id|__va
c_func
(paren
id|runtime-&gt;get_wakeup_time
)paren
suffix:semicolon
id|efi.set_wakeup_time
op_assign
id|__va
c_func
(paren
id|runtime-&gt;set_wakeup_time
)paren
suffix:semicolon
id|efi.get_variable
op_assign
id|__va
c_func
(paren
id|runtime-&gt;get_variable
)paren
suffix:semicolon
id|efi.get_next_variable
op_assign
id|__va
c_func
(paren
id|runtime-&gt;get_next_variable
)paren
suffix:semicolon
id|efi.set_variable
op_assign
id|__va
c_func
(paren
id|runtime-&gt;set_variable
)paren
suffix:semicolon
id|efi.get_next_high_mono_count
op_assign
id|__va
c_func
(paren
id|runtime-&gt;get_next_high_mono_count
)paren
suffix:semicolon
id|efi.reset_system
op_assign
id|__va
c_func
(paren
id|runtime-&gt;reset_system
)paren
suffix:semicolon
)brace
eof
