multiline_comment|/*&n; * Copyright (C) 1999 Hewlett-Packard Co&n; * Copyright (C) 1999 David Mosberger-Tang &lt;davidm@hpl.hp.com&gt;&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/unwind.h&gt;
r_void
DECL|function|ia64_unwind_init_from_blocked_task
id|ia64_unwind_init_from_blocked_task
(paren
r_struct
id|ia64_frame_info
op_star
id|info
comma
r_struct
id|task_struct
op_star
id|t
)paren
(brace
r_struct
id|switch_stack
op_star
id|sw
op_assign
(paren
r_struct
id|switch_stack
op_star
)paren
(paren
id|t-&gt;thread.ksp
op_plus
l_int|16
)paren
suffix:semicolon
r_int
r_int
id|sol
comma
id|limit
comma
id|top
suffix:semicolon
id|memset
c_func
(paren
id|info
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|info
)paren
)paren
suffix:semicolon
id|sol
op_assign
(paren
id|sw-&gt;ar_pfs
op_rshift
l_int|7
)paren
op_amp
l_int|0x7f
suffix:semicolon
multiline_comment|/* size of locals */
id|limit
op_assign
(paren
r_int
r_int
)paren
id|t
op_plus
id|IA64_RBS_OFFSET
suffix:semicolon
id|top
op_assign
id|sw-&gt;ar_bspstore
suffix:semicolon
r_if
c_cond
(paren
id|top
op_minus
(paren
r_int
r_int
)paren
id|t
op_ge
id|IA64_STK_OFFSET
)paren
id|top
op_assign
id|limit
suffix:semicolon
id|info-&gt;regstk.limit
op_assign
(paren
r_int
r_int
op_star
)paren
id|limit
suffix:semicolon
id|info-&gt;regstk.top
op_assign
(paren
r_int
r_int
op_star
)paren
id|top
suffix:semicolon
id|info-&gt;bsp
op_assign
id|ia64_rse_skip_regs
c_func
(paren
id|info-&gt;regstk.top
comma
op_minus
id|sol
)paren
suffix:semicolon
id|info-&gt;top_rnat
op_assign
id|sw-&gt;ar_rnat
suffix:semicolon
id|info-&gt;cfm
op_assign
id|sw-&gt;ar_pfs
suffix:semicolon
id|info-&gt;ip
op_assign
id|sw-&gt;b0
suffix:semicolon
)brace
r_void
DECL|function|ia64_unwind_init_from_current
id|ia64_unwind_init_from_current
(paren
r_struct
id|ia64_frame_info
op_star
id|info
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|switch_stack
op_star
id|sw
op_assign
(paren
r_struct
id|switch_stack
op_star
)paren
id|regs
op_minus
l_int|1
suffix:semicolon
r_int
r_int
id|sol
comma
id|sof
comma
op_star
id|bsp
comma
id|limit
comma
id|top
suffix:semicolon
id|limit
op_assign
(paren
r_int
r_int
)paren
id|current
op_plus
id|IA64_RBS_OFFSET
suffix:semicolon
id|top
op_assign
id|sw-&gt;ar_bspstore
suffix:semicolon
r_if
c_cond
(paren
id|top
op_minus
(paren
r_int
r_int
)paren
id|current
op_ge
id|IA64_STK_OFFSET
)paren
id|top
op_assign
id|limit
suffix:semicolon
id|memset
c_func
(paren
id|info
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|info
)paren
)paren
suffix:semicolon
id|sol
op_assign
(paren
id|sw-&gt;ar_pfs
op_rshift
l_int|7
)paren
op_amp
l_int|0x7f
suffix:semicolon
multiline_comment|/* size of frame */
id|info-&gt;regstk.limit
op_assign
(paren
r_int
r_int
op_star
)paren
id|limit
suffix:semicolon
id|info-&gt;regstk.top
op_assign
(paren
r_int
r_int
op_star
)paren
id|top
suffix:semicolon
id|info-&gt;top_rnat
op_assign
id|sw-&gt;ar_rnat
suffix:semicolon
multiline_comment|/* this gives us the bsp top level frame (kdb interrupt frame): */
id|bsp
op_assign
id|ia64_rse_skip_regs
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|top
comma
op_minus
id|sol
)paren
suffix:semicolon
multiline_comment|/* now skip past the interrupt frame: */
id|sof
op_assign
id|regs-&gt;cr_ifs
op_amp
l_int|0x7f
suffix:semicolon
multiline_comment|/* size of frame */
id|info-&gt;cfm
op_assign
id|regs-&gt;cr_ifs
suffix:semicolon
id|info-&gt;bsp
op_assign
id|ia64_rse_skip_regs
c_func
(paren
id|bsp
comma
op_minus
id|sof
)paren
suffix:semicolon
id|info-&gt;ip
op_assign
id|regs-&gt;cr_iip
suffix:semicolon
)brace
r_static
r_int
r_int
DECL|function|read_reg
id|read_reg
(paren
r_struct
id|ia64_frame_info
op_star
id|info
comma
r_int
id|regnum
comma
r_int
op_star
id|is_nat
)paren
(brace
r_int
r_int
op_star
id|addr
comma
op_star
id|rnat_addr
comma
id|rnat
suffix:semicolon
id|addr
op_assign
id|ia64_rse_skip_regs
c_func
(paren
id|info-&gt;bsp
comma
id|regnum
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr
OL
id|info-&gt;regstk.limit
op_logical_or
id|addr
op_ge
id|info-&gt;regstk.top
op_logical_or
(paren
(paren
r_int
)paren
id|addr
op_amp
l_int|0x7
)paren
op_ne
l_int|0
)paren
(brace
op_star
id|is_nat
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0xdeadbeefdeadbeef
suffix:semicolon
)brace
id|rnat_addr
op_assign
id|ia64_rse_rnat_addr
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rnat_addr
op_ge
id|info-&gt;regstk.top
)paren
id|rnat
op_assign
id|info-&gt;top_rnat
suffix:semicolon
r_else
id|rnat
op_assign
op_star
id|rnat_addr
suffix:semicolon
op_star
id|is_nat
op_assign
(paren
id|rnat
op_amp
(paren
l_int|1UL
op_lshift
id|ia64_rse_slot_num
c_func
(paren
id|addr
)paren
)paren
)paren
op_ne
l_int|0
suffix:semicolon
r_return
op_star
id|addr
suffix:semicolon
)brace
multiline_comment|/*&n; * On entry, info-&gt;regstk.top should point to the register backing&n; * store for r32.&n; */
r_int
DECL|function|ia64_unwind_to_previous_frame
id|ia64_unwind_to_previous_frame
(paren
r_struct
id|ia64_frame_info
op_star
id|info
)paren
(brace
r_int
r_int
id|sol
comma
id|cfm
op_assign
id|info-&gt;cfm
suffix:semicolon
r_int
id|is_nat
suffix:semicolon
id|sol
op_assign
(paren
id|cfm
op_rshift
l_int|7
)paren
op_amp
l_int|0x7f
suffix:semicolon
multiline_comment|/* size of locals */
multiline_comment|/*&n;&t; * In general, we would have to make use of unwind info to&n;&t; * unwind an IA-64 stack, but for now gcc uses a special&n;&t; * convention that makes this possible without full-fledged&n;&t; * unwindo info.  Specifically, we expect &quot;rp&quot; in the second&n;&t; * last, and &quot;ar.pfs&quot; in the last local register, so the&n;&t; * number of locals in a frame must be at least two.  If it&squot;s&n;&t; * less than that, we reached the end of the C call stack.&n;&t; */
r_if
c_cond
(paren
id|sol
OL
l_int|2
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|info-&gt;ip
op_assign
id|read_reg
c_func
(paren
id|info
comma
id|sol
op_minus
l_int|2
comma
op_amp
id|is_nat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_nat
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|cfm
op_assign
id|read_reg
c_func
(paren
id|info
comma
id|sol
op_minus
l_int|1
comma
op_amp
id|is_nat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_nat
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|sol
op_assign
(paren
id|cfm
op_rshift
l_int|7
)paren
op_amp
l_int|0x7f
suffix:semicolon
id|info-&gt;cfm
op_assign
id|cfm
suffix:semicolon
id|info-&gt;bsp
op_assign
id|ia64_rse_skip_regs
c_func
(paren
id|info-&gt;bsp
comma
op_minus
id|sol
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
