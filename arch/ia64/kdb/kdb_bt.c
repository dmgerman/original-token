multiline_comment|/**&n; * Minimalist Kernel Debugger &n; * Machine dependent stack traceback code for IA-64.&n; *&n; * Copyright (C) 1999 Goutham Rao &lt;goutham.rao@intel.com&gt;&n; * Copyright (C) 1999 Sreenivas Subramoney &lt;sreenivas.subramoney@intel.com&gt;&n; * Intel Corporation, August 1999.&n; * Copyright (C) 1999 Hewlett-Packard Co&n; * Copyright (C) 1999 David Mosberger-Tang &lt;davidm@hpl.hp.com&gt;&n; *&n; * 99/12/03 D. Mosberger&t;Reimplemented based on &lt;asm-ia64/unwind.h&gt; API.&n; * 99/12/06 D. Mosberger&t;Added support for backtracing other processes.&n; */
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kdb.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/current.h&gt;
macro_line|#include &lt;asm/kdbsupport.h&gt;
multiline_comment|/*&n; * Minimal stack back trace functionality.&n; */
r_int
DECL|function|kdb_bt
id|kdb_bt
(paren
r_int
id|argc
comma
r_const
r_char
op_star
op_star
id|argv
comma
r_const
r_char
op_star
op_star
id|envp
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|task_struct
op_star
id|task
op_assign
id|current
suffix:semicolon
r_struct
id|ia64_frame_info
id|info
suffix:semicolon
r_char
op_star
id|name
suffix:semicolon
r_int
id|diag
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|argv
(braket
l_int|0
)braket
comma
l_string|&quot;btp&quot;
)paren
op_eq
l_int|0
)paren
(brace
r_int
r_int
id|pid
suffix:semicolon
id|diag
op_assign
id|kdbgetularg
c_func
(paren
id|argv
(braket
l_int|1
)braket
comma
op_amp
id|pid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|diag
)paren
r_return
id|diag
suffix:semicolon
id|task
op_assign
id|find_task_by_pid
c_func
(paren
id|pid
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|task
)paren
(brace
id|kdb_printf
c_func
(paren
l_string|&quot;No process with pid == %d found&bslash;n&quot;
comma
id|pid
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|regs
op_assign
id|ia64_task_regs
c_func
(paren
id|task
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|argc
)paren
(brace
id|kdb_printf
c_func
(paren
l_string|&quot;bt &lt;address&gt; is unsupported for IA-64&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|task
op_eq
id|current
)paren
(brace
multiline_comment|/*&n;&t;&t; * Upon entering kdb, the stack frame looks like this:&n;&t;&t; *&n;&t;&t; *&t;+---------------------+&n;&t;&t; *&t;|   struct pt_regs    |&n;&t;&t; *&t;+---------------------+&n;&t;&t; *&t;|&t;&t;      |&n;&t;&t; *&t;|   kernel stack      |&n;&t;&t; *&t;|&t;&t;      |&n;&t;&t; *&t;+=====================+ &lt;--- top of stack upon entering kdb&n;&t;&t; *&t;|   struct pt_regs    |&n;&t;&t; *&t;+---------------------+&n;&t;&t; *&t;| struct switch_stack |&n;&t;&t; *&t;+---------------------+&n;&t;&t; */
r_if
c_cond
(paren
id|user_mode
c_func
(paren
id|regs
)paren
)paren
(brace
multiline_comment|/* We are not implementing stack backtrace from user mode code */
id|kdb_printf
(paren
l_string|&quot;Not in Kernel&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|ia64_unwind_init_from_current
c_func
(paren
op_amp
id|info
comma
id|regs
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * For a blocked task, the stack frame looks like this:&n;&t;&t; *&n;&t;&t; *&t;+---------------------+&n;&t;&t; *&t;|   struct pt_regs    |&n;&t;&t; *&t;+---------------------+&n;&t;&t; *&t;|&t;&t;      |&n;&t;&t; *&t;|   kernel stack      |&n;&t;&t; *&t;|&t;&t;      |&n;&t;&t; *&t;+---------------------+&n;&t;&t; *&t;| struct switch_stack |&n;&t;&t; *&t;+=====================+ &lt;--- task-&gt;thread.ksp&n;&t;&t; */
id|ia64_unwind_init_from_blocked_task
c_func
(paren
op_amp
id|info
comma
id|task
)paren
suffix:semicolon
)brace
id|kdb_printf
c_func
(paren
l_string|&quot;Ret Address           Reg Stack base       Name&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
r_do
(brace
r_int
r_int
id|ip
op_assign
id|ia64_unwind_get_ip
c_func
(paren
op_amp
id|info
)paren
suffix:semicolon
id|name
op_assign
id|kdbnearsym
c_func
(paren
id|ip
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|name
)paren
(brace
id|kdb_printf
c_func
(paren
l_string|&quot;Interrupt&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|kdb_printf
c_func
(paren
l_string|&quot;0x%016lx: [0x%016lx] %s&bslash;n&quot;
comma
id|ip
comma
id|ia64_unwind_get_bsp
c_func
(paren
op_amp
id|info
)paren
comma
id|name
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|ia64_unwind_to_previous_frame
c_func
(paren
op_amp
id|info
)paren
op_ge
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
