multiline_comment|/*&n; * IA32 exceptions handler&n; *&n; * 06/16/00&t;A. Mallick&t;added siginfo for most cases (close to IA32)&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/ia32.h&gt;
macro_line|#include &lt;asm/ptrace.h&gt;
r_int
DECL|function|ia32_exception
id|ia32_exception
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|isr
)paren
(brace
r_struct
id|siginfo
id|siginfo
suffix:semicolon
id|siginfo.si_errno
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
(paren
id|isr
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
)paren
(brace
r_case
l_int|1
suffix:colon
r_case
l_int|2
suffix:colon
id|siginfo.si_signo
op_assign
id|SIGTRAP
suffix:semicolon
r_if
c_cond
(paren
id|isr
op_eq
l_int|0
)paren
id|siginfo.si_code
op_assign
id|TRAP_TRACE
suffix:semicolon
r_else
r_if
c_cond
(paren
id|isr
op_amp
l_int|0x4
)paren
id|siginfo.si_code
op_assign
id|TRAP_BRANCH
suffix:semicolon
r_else
id|siginfo.si_code
op_assign
id|TRAP_BRKPT
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|siginfo.si_signo
op_assign
id|SIGTRAP
suffix:semicolon
id|siginfo.si_code
op_assign
id|TRAP_BRKPT
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0
suffix:colon
multiline_comment|/* Divide fault */
id|siginfo.si_signo
op_assign
id|SIGFPE
suffix:semicolon
id|siginfo.si_code
op_assign
id|FPE_INTDIV
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
multiline_comment|/* Overflow */
r_case
l_int|5
suffix:colon
multiline_comment|/* Bounds fault */
id|siginfo.si_signo
op_assign
id|SIGFPE
suffix:semicolon
id|siginfo.si_code
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
multiline_comment|/* Invalid Op-code */
id|siginfo.si_signo
op_assign
id|SIGILL
suffix:semicolon
id|siginfo.si_code
op_assign
id|ILL_ILLOPN
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
multiline_comment|/* FP DNA */
r_case
l_int|8
suffix:colon
multiline_comment|/* Double Fault */
r_case
l_int|9
suffix:colon
multiline_comment|/* Invalid TSS */
r_case
l_int|11
suffix:colon
multiline_comment|/* Segment not present */
r_case
l_int|12
suffix:colon
multiline_comment|/* Stack fault */
r_case
l_int|13
suffix:colon
multiline_comment|/* General Protection Fault */
id|siginfo.si_signo
op_assign
id|SIGSEGV
suffix:semicolon
id|siginfo.si_code
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
multiline_comment|/* Pending FP error */
(brace
r_int
r_int
id|fsr
comma
id|fcr
suffix:semicolon
id|asm
(paren
l_string|&quot;mov %0=ar.fsr;&quot;
l_string|&quot;mov %1=ar.fcr;&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|fsr
)paren
comma
l_string|&quot;=r&quot;
(paren
id|fcr
)paren
)paren
suffix:semicolon
id|siginfo.si_signo
op_assign
id|SIGFPE
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * (~cwd &amp; swd) will mask out exceptions that are not set to unmasked&n;&t;&t;&t; * status.  0x3f is the exception bits in these regs, 0x200 is the&n;&t;&t;&t; * C1 reg you need in case of a stack fault, 0x040 is the stack&n;&t;&t;&t; * fault bit.  We should only be taking one exception at a time,&n;&t;&t;&t; * so if this combination doesn&squot;t produce any single exception,&n;&t;&t;&t; * then we have a bad program that isn&squot;t syncronizing its FPU usage&n;&t;&t;&t; * and it will suffer the consequences since we won&squot;t be able to&n;&t;&t;&t; * fully reproduce the context of the exception&n;&t;&t;&t; */
r_switch
c_cond
(paren
(paren
(paren
op_complement
id|fcr
)paren
op_amp
(paren
id|fsr
op_amp
l_int|0x3f
)paren
)paren
op_or
(paren
id|fsr
op_amp
l_int|0x240
)paren
)paren
(brace
r_case
l_int|0x000
suffix:colon
r_default
suffix:colon
id|siginfo.si_code
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x001
suffix:colon
multiline_comment|/* Invalid Op */
r_case
l_int|0x040
suffix:colon
multiline_comment|/* Stack Fault */
r_case
l_int|0x240
suffix:colon
multiline_comment|/* Stack Fault | Direction */
id|siginfo.si_code
op_assign
id|FPE_FLTINV
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x002
suffix:colon
multiline_comment|/* Denormalize */
r_case
l_int|0x010
suffix:colon
multiline_comment|/* Underflow */
id|siginfo.si_code
op_assign
id|FPE_FLTUND
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x004
suffix:colon
multiline_comment|/* Zero Divide */
id|siginfo.si_code
op_assign
id|FPE_FLTDIV
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x008
suffix:colon
multiline_comment|/* Overflow */
id|siginfo.si_code
op_assign
id|FPE_FLTOVF
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x020
suffix:colon
multiline_comment|/* Precision */
id|siginfo.si_code
op_assign
id|FPE_FLTRES
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_case
l_int|17
suffix:colon
multiline_comment|/* Alignment check */
id|siginfo.si_signo
op_assign
id|SIGSEGV
suffix:semicolon
id|siginfo.si_code
op_assign
id|BUS_ADRALN
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|19
suffix:colon
multiline_comment|/* SSE Numeric error */
id|siginfo.si_signo
op_assign
id|SIGFPE
suffix:semicolon
id|siginfo.si_code
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|force_sig_info
c_func
(paren
id|siginfo.si_signo
comma
op_amp
id|siginfo
comma
id|current
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
