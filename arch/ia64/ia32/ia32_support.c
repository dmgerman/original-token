multiline_comment|/*&n; * IA32 helper functions&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/ia32.h&gt;
r_extern
r_int
r_int
op_star
id|ia32_gdt_table
comma
op_star
id|ia32_tss
suffix:semicolon
r_extern
r_void
id|die_if_kernel
(paren
r_char
op_star
id|str
comma
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|err
)paren
suffix:semicolon
multiline_comment|/*&n; * Setup IA32 GDT and TSS &n; */
r_void
DECL|function|ia32_gdt_init
id|ia32_gdt_init
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|gdt_and_tss_page
suffix:semicolon
multiline_comment|/* allocate two IA-32 pages of memory: */
id|gdt_and_tss_page
op_assign
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
comma
(paren
id|IA32_PAGE_SHIFT
OL
id|PAGE_SHIFT
)paren
ques
c_cond
l_int|0
suffix:colon
(paren
id|IA32_PAGE_SHIFT
op_plus
l_int|1
)paren
op_minus
id|PAGE_SHIFT
)paren
suffix:semicolon
id|ia32_gdt_table
op_assign
(paren
r_int
r_int
op_star
)paren
id|gdt_and_tss_page
suffix:semicolon
id|ia32_tss
op_assign
(paren
r_int
r_int
op_star
)paren
(paren
id|gdt_and_tss_page
op_plus
id|IA32_PAGE_SIZE
)paren
suffix:semicolon
multiline_comment|/* Zero the gdt and tss */
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|gdt_and_tss_page
comma
l_int|0
comma
l_int|2
op_star
id|IA32_PAGE_SIZE
)paren
suffix:semicolon
multiline_comment|/* CS descriptor in IA-32 format */
id|ia32_gdt_table
(braket
l_int|4
)braket
op_assign
id|IA32_SEG_DESCRIPTOR
c_func
(paren
l_int|0L
comma
l_int|0xBFFFFFFFL
comma
l_int|0xBL
comma
l_int|1L
comma
l_int|3L
comma
l_int|1L
comma
l_int|1L
comma
l_int|1L
comma
l_int|1L
)paren
suffix:semicolon
multiline_comment|/* DS descriptor in IA-32 format */
id|ia32_gdt_table
(braket
l_int|5
)braket
op_assign
id|IA32_SEG_DESCRIPTOR
c_func
(paren
l_int|0L
comma
l_int|0xBFFFFFFFL
comma
l_int|0x3L
comma
l_int|1L
comma
l_int|3L
comma
l_int|1L
comma
l_int|1L
comma
l_int|1L
comma
l_int|1L
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Handle bad IA32 interrupt via syscall &n; */
r_void
DECL|function|ia32_bad_interrupt
id|ia32_bad_interrupt
(paren
r_int
r_int
id|int_num
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|siginfo_t
id|siginfo
suffix:semicolon
id|die_if_kernel
c_func
(paren
l_string|&quot;Bad IA-32 interrupt&quot;
comma
id|regs
comma
id|int_num
)paren
suffix:semicolon
id|siginfo.si_signo
op_assign
id|SIGTRAP
suffix:semicolon
id|siginfo.si_errno
op_assign
id|int_num
suffix:semicolon
multiline_comment|/* XXX is it legal to abuse si_errno like this? */
id|siginfo.si_code
op_assign
id|TRAP_BRKPT
suffix:semicolon
id|force_sig_info
c_func
(paren
id|SIGTRAP
comma
op_amp
id|siginfo
comma
id|current
)paren
suffix:semicolon
)brace
eof
