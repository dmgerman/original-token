multiline_comment|/*&n; * IA32 helper functions&n; *&n; * 06/16/00&t;A. Mallick&t;added csd/ssd/tssd for ia32 thread context&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/ia32.h&gt;
r_extern
r_int
r_int
op_star
id|ia32_gdt_table
comma
op_star
id|ia32_tss
suffix:semicolon
r_extern
r_void
id|die_if_kernel
(paren
r_char
op_star
id|str
comma
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|err
)paren
suffix:semicolon
r_void
DECL|function|ia32_save_state
id|ia32_save_state
(paren
r_struct
id|thread_struct
op_star
id|thread
)paren
(brace
r_int
r_int
id|eflag
comma
id|fsr
comma
id|fcr
comma
id|fir
comma
id|fdr
comma
id|csd
comma
id|ssd
comma
id|tssd
suffix:semicolon
id|asm
(paren
l_string|&quot;mov %0=ar.eflag;&quot;
l_string|&quot;mov %1=ar.fsr;&quot;
l_string|&quot;mov %2=ar.fcr;&quot;
l_string|&quot;mov %3=ar.fir;&quot;
l_string|&quot;mov %4=ar.fdr;&quot;
l_string|&quot;mov %5=ar.csd;&quot;
l_string|&quot;mov %6=ar.ssd;&quot;
l_string|&quot;mov %7=ar.k1&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|eflag
)paren
comma
l_string|&quot;=r&quot;
(paren
id|fsr
)paren
comma
l_string|&quot;=r&quot;
(paren
id|fcr
)paren
comma
l_string|&quot;=r&quot;
(paren
id|fir
)paren
comma
l_string|&quot;=r&quot;
(paren
id|fdr
)paren
comma
l_string|&quot;=r&quot;
(paren
id|csd
)paren
comma
l_string|&quot;=r&quot;
(paren
id|ssd
)paren
comma
l_string|&quot;=r&quot;
(paren
id|tssd
)paren
)paren
suffix:semicolon
id|thread-&gt;eflag
op_assign
id|eflag
suffix:semicolon
id|thread-&gt;fsr
op_assign
id|fsr
suffix:semicolon
id|thread-&gt;fcr
op_assign
id|fcr
suffix:semicolon
id|thread-&gt;fir
op_assign
id|fir
suffix:semicolon
id|thread-&gt;fdr
op_assign
id|fdr
suffix:semicolon
id|thread-&gt;csd
op_assign
id|csd
suffix:semicolon
id|thread-&gt;ssd
op_assign
id|ssd
suffix:semicolon
id|thread-&gt;tssd
op_assign
id|tssd
suffix:semicolon
id|asm
(paren
l_string|&quot;mov ar.k0=%0 ;;&quot;
op_scope_resolution
l_string|&quot;r&quot;
(paren
id|thread-&gt;old_iob
)paren
)paren
suffix:semicolon
)brace
r_void
DECL|function|ia32_load_state
id|ia32_load_state
(paren
r_struct
id|thread_struct
op_star
id|thread
)paren
(brace
r_int
r_int
id|eflag
comma
id|fsr
comma
id|fcr
comma
id|fir
comma
id|fdr
comma
id|csd
comma
id|ssd
comma
id|tssd
suffix:semicolon
id|eflag
op_assign
id|thread-&gt;eflag
suffix:semicolon
id|fsr
op_assign
id|thread-&gt;fsr
suffix:semicolon
id|fcr
op_assign
id|thread-&gt;fcr
suffix:semicolon
id|fir
op_assign
id|thread-&gt;fir
suffix:semicolon
id|fdr
op_assign
id|thread-&gt;fdr
suffix:semicolon
id|csd
op_assign
id|thread-&gt;csd
suffix:semicolon
id|ssd
op_assign
id|thread-&gt;ssd
suffix:semicolon
id|tssd
op_assign
id|thread-&gt;tssd
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;mov ar.eflag=%0;&quot;
l_string|&quot;mov ar.fsr=%1;&quot;
l_string|&quot;mov ar.fcr=%2;&quot;
l_string|&quot;mov ar.fir=%3;&quot;
l_string|&quot;mov ar.fdr=%4;&quot;
l_string|&quot;mov ar.csd=%5;&quot;
l_string|&quot;mov ar.ssd=%6;&quot;
l_string|&quot;mov ar.k1=%7&quot;
op_scope_resolution
l_string|&quot;r&quot;
(paren
id|eflag
)paren
comma
l_string|&quot;r&quot;
(paren
id|fsr
)paren
comma
l_string|&quot;r&quot;
(paren
id|fcr
)paren
comma
l_string|&quot;r&quot;
(paren
id|fir
)paren
comma
l_string|&quot;r&quot;
(paren
id|fdr
)paren
comma
l_string|&quot;r&quot;
(paren
id|csd
)paren
comma
l_string|&quot;r&quot;
(paren
id|ssd
)paren
comma
l_string|&quot;r&quot;
(paren
id|tssd
)paren
)paren
suffix:semicolon
id|asm
(paren
l_string|&quot;mov %0=ar.k0 ;;&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|thread-&gt;old_iob
)paren
)paren
suffix:semicolon
id|asm
(paren
l_string|&quot;mov ar.k0=%0 ;;&quot;
op_scope_resolution
l_string|&quot;r&quot;
(paren
id|IA32_IOBASE
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Setup IA32 GDT and TSS &n; */
r_void
DECL|function|ia32_gdt_init
id|ia32_gdt_init
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|gdt_and_tss_page
suffix:semicolon
multiline_comment|/* allocate two IA-32 pages of memory: */
id|gdt_and_tss_page
op_assign
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
comma
(paren
id|IA32_PAGE_SHIFT
OL
id|PAGE_SHIFT
)paren
ques
c_cond
l_int|0
suffix:colon
(paren
id|IA32_PAGE_SHIFT
op_plus
l_int|1
)paren
op_minus
id|PAGE_SHIFT
)paren
suffix:semicolon
id|ia32_gdt_table
op_assign
(paren
r_int
r_int
op_star
)paren
id|gdt_and_tss_page
suffix:semicolon
id|ia32_tss
op_assign
(paren
r_int
r_int
op_star
)paren
(paren
id|gdt_and_tss_page
op_plus
id|IA32_PAGE_SIZE
)paren
suffix:semicolon
multiline_comment|/* Zero the gdt and tss */
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|gdt_and_tss_page
comma
l_int|0
comma
l_int|2
op_star
id|IA32_PAGE_SIZE
)paren
suffix:semicolon
multiline_comment|/* CS descriptor in IA-32 format */
id|ia32_gdt_table
(braket
l_int|4
)braket
op_assign
id|IA32_SEG_DESCRIPTOR
c_func
(paren
l_int|0L
comma
l_int|0xBFFFFFFFL
comma
l_int|0xBL
comma
l_int|1L
comma
l_int|3L
comma
l_int|1L
comma
l_int|1L
comma
l_int|1L
comma
l_int|1L
)paren
suffix:semicolon
multiline_comment|/* DS descriptor in IA-32 format */
id|ia32_gdt_table
(braket
l_int|5
)braket
op_assign
id|IA32_SEG_DESCRIPTOR
c_func
(paren
l_int|0L
comma
l_int|0xBFFFFFFFL
comma
l_int|0x3L
comma
l_int|1L
comma
l_int|3L
comma
l_int|1L
comma
l_int|1L
comma
l_int|1L
comma
l_int|1L
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Handle bad IA32 interrupt via syscall &n; */
r_void
DECL|function|ia32_bad_interrupt
id|ia32_bad_interrupt
(paren
r_int
r_int
id|int_num
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|siginfo_t
id|siginfo
suffix:semicolon
id|die_if_kernel
c_func
(paren
l_string|&quot;Bad IA-32 interrupt&quot;
comma
id|regs
comma
id|int_num
)paren
suffix:semicolon
id|siginfo.si_signo
op_assign
id|SIGTRAP
suffix:semicolon
id|siginfo.si_errno
op_assign
id|int_num
suffix:semicolon
multiline_comment|/* XXX is it legal to abuse si_errno like this? */
id|siginfo.si_code
op_assign
id|TRAP_BRKPT
suffix:semicolon
id|force_sig_info
c_func
(paren
id|SIGTRAP
comma
op_amp
id|siginfo
comma
id|current
)paren
suffix:semicolon
)brace
eof
