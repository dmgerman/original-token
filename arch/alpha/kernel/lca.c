multiline_comment|/*&n; * Code common to all LCA chips.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/bios32.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/lca.h&gt;
multiline_comment|/*&n; * BIOS32-style PCI interface:&n; */
multiline_comment|/*&n; * PCI BIOS32 interface:&n; */
DECL|macro|MAJOR_REV
mdefine_line|#define MAJOR_REV&t;0
DECL|macro|MINOR_REV
mdefine_line|#define MINOR_REV&t;0
macro_line|#ifdef CONFIG_PCI
DECL|macro|mtpr_mces
mdefine_line|#define mtpr_mces(v) &bslash;&n;({ &bslash;&n;    register unsigned long v0 asm (&quot;0&quot;); &bslash;&n;    register unsigned long a0 asm (&quot;16&quot;); &bslash;&n;    a0 = (v); &bslash;&n;    asm volatile (&quot;call_pal %1 # %0 %2&quot; : &quot;r=&quot;(v0) &bslash;&n;&t;&t;  : &quot;i&quot;(PAL_mtpr_mces), &quot;r&quot;(a0) &bslash;&n;&t;&t;  : &quot;memory&quot;, &quot;0&quot;, &quot;1&quot;, &quot;16&quot;, &quot;22&quot;, &quot;23&quot;, &quot;24&quot;, &quot;25&quot;); &bslash;&n;    v0; &bslash;&n;})
DECL|macro|draina
mdefine_line|#define draina()&t;asm volatile (&quot;call_pal %0&quot; :: &quot;i&quot;(PAL_draina))
multiline_comment|/*&n; * Given a bus, device, and function number, compute resulting&n; * configuration space address and setup the LCA_IOC_CONF register&n; * accordingly.  It is therefore not safe to have concurrent&n; * invocations to configuration space access routines, but there&n; * really shouldn&squot;t be any need for this.&n; */
r_static
r_int
DECL|function|mk_conf_addr
id|mk_conf_addr
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|device_fn
comma
r_int
r_char
id|where
comma
r_int
r_int
op_star
id|pci_addr
)paren
(brace
r_int
r_int
id|addr
suffix:semicolon
r_if
c_cond
(paren
id|bus
op_eq
l_int|0
)paren
(brace
r_int
id|device
op_assign
id|device_fn
op_rshift
l_int|3
suffix:semicolon
r_int
id|func
op_assign
id|device_fn
op_amp
l_int|0x7
suffix:semicolon
multiline_comment|/* type 0 configuration cycle: */
r_if
c_cond
(paren
id|device
OG
l_int|12
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* if */
op_star
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
id|LCA_IOC_CONF
)paren
op_assign
l_int|0
suffix:semicolon
id|addr
op_assign
(paren
l_int|1
op_lshift
(paren
l_int|11
op_plus
id|device
)paren
)paren
op_or
(paren
id|func
op_lshift
l_int|8
)paren
op_or
id|where
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* type 1 configuration cycle: */
op_star
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
id|LCA_IOC_CONF
)paren
op_assign
l_int|1
suffix:semicolon
id|addr
op_assign
(paren
id|bus
op_lshift
l_int|16
)paren
op_or
(paren
id|device_fn
op_lshift
l_int|8
)paren
op_or
id|where
suffix:semicolon
)brace
multiline_comment|/* if */
op_star
id|pci_addr
op_assign
id|addr
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
r_int
DECL|function|conf_read
id|conf_read
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_int
r_int
id|old_ipl
comma
id|code
comma
id|stat0
suffix:semicolon
r_int
r_int
id|value
suffix:semicolon
id|old_ipl
op_assign
id|swpipl
c_func
(paren
l_int|7
)paren
suffix:semicolon
multiline_comment|/* avoid getting hit by machine check */
multiline_comment|/* reset status register to avoid loosing errors: */
id|stat0
op_assign
op_star
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
id|LCA_IOC_STAT0
)paren
suffix:semicolon
op_star
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
id|LCA_IOC_STAT0
)paren
op_assign
id|stat0
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* access configuration space: */
id|value
op_assign
op_star
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
id|addr
)paren
suffix:semicolon
id|draina
c_func
(paren
)paren
suffix:semicolon
id|stat0
op_assign
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|LCA_IOC_STAT0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat0
op_amp
id|LCA_IOC_STAT0_ERR
)paren
(brace
id|code
op_assign
(paren
(paren
id|stat0
op_rshift
id|LCA_IOC_STAT0_CODE_SHIFT
)paren
op_amp
id|LCA_IOC_STAT0_CODE_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|code
op_ne
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;lca.c:conf_read: got stat0=%lx&bslash;n&quot;
comma
id|stat0
)paren
suffix:semicolon
)brace
multiline_comment|/* reset error status: */
op_star
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
id|LCA_IOC_STAT0
)paren
op_assign
id|stat0
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|mtpr_mces
c_func
(paren
l_int|0x7
)paren
suffix:semicolon
multiline_comment|/* reset machine check */
id|value
op_assign
l_int|0xffffffff
suffix:semicolon
)brace
id|swpipl
c_func
(paren
id|old_ipl
)paren
suffix:semicolon
r_return
id|value
suffix:semicolon
)brace
r_static
r_void
DECL|function|conf_write
id|conf_write
c_func
(paren
r_int
r_int
id|addr
comma
r_int
r_int
id|value
)paren
(brace
)brace
r_int
DECL|function|pcibios_present
id|pcibios_present
(paren
r_void
)paren
(brace
r_return
l_int|1
suffix:semicolon
multiline_comment|/* present if configured */
)brace
r_int
DECL|function|pcibios_find_class
id|pcibios_find_class
(paren
r_int
r_int
id|class_code
comma
r_int
r_int
id|index
comma
r_int
r_char
op_star
id|bus
comma
r_int
r_char
op_star
id|device_fn
)paren
(brace
id|pci_resource_t
op_star
id|dev
suffix:semicolon
r_int
r_int
id|w
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
id|pci_device_list
suffix:semicolon
id|dev
suffix:semicolon
id|dev
op_assign
id|dev-&gt;next
)paren
(brace
id|pcibios_read_config_dword
c_func
(paren
id|dev-&gt;bus
comma
id|dev-&gt;dev_fn
comma
id|PCI_CLASS_REVISION
comma
op_amp
id|w
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|w
op_rshift
l_int|8
)paren
op_eq
id|class_code
)paren
(brace
r_if
c_cond
(paren
id|index
op_eq
l_int|0
)paren
(brace
op_star
id|bus
op_assign
id|dev-&gt;bus
suffix:semicolon
op_star
id|device_fn
op_assign
id|dev-&gt;dev_fn
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
op_decrement
id|index
suffix:semicolon
)brace
)brace
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
)brace
r_int
DECL|function|pcibios_find_device
id|pcibios_find_device
(paren
r_int
r_int
id|vendor
comma
r_int
r_int
id|device_id
comma
r_int
r_int
id|index
comma
r_int
r_char
op_star
id|bus
comma
r_int
r_char
op_star
id|device_fn
)paren
(brace
r_int
r_int
id|w
comma
id|desired
op_assign
(paren
id|device_id
op_lshift
l_int|16
)paren
op_or
id|vendor
suffix:semicolon
id|pci_resource_t
op_star
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|vendor
op_eq
l_int|0xffff
)paren
(brace
r_return
id|PCIBIOS_BAD_VENDOR_ID
suffix:semicolon
)brace
r_for
c_loop
(paren
id|dev
op_assign
id|pci_device_list
suffix:semicolon
id|dev
suffix:semicolon
id|dev
op_assign
id|dev-&gt;next
)paren
(brace
id|pcibios_read_config_dword
c_func
(paren
id|dev-&gt;bus
comma
id|dev-&gt;dev_fn
comma
id|PCI_VENDOR_ID
comma
op_amp
id|w
)paren
suffix:semicolon
r_if
c_cond
(paren
id|w
op_eq
id|desired
)paren
(brace
r_if
c_cond
(paren
id|index
op_eq
l_int|0
)paren
(brace
op_star
id|bus
op_assign
id|dev-&gt;bus
suffix:semicolon
op_star
id|device_fn
op_assign
id|dev-&gt;dev_fn
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
op_decrement
id|index
suffix:semicolon
)brace
)brace
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
)brace
r_int
DECL|function|pcibios_read_config_byte
id|pcibios_read_config_byte
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|device_fn
comma
r_int
r_char
id|where
comma
r_int
r_char
op_star
id|value
)paren
(brace
r_int
r_int
id|addr
op_assign
id|LCA_CONF
suffix:semicolon
r_int
r_int
id|pci_addr
suffix:semicolon
op_star
id|value
op_assign
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|mk_conf_addr
c_func
(paren
id|bus
comma
id|device_fn
comma
id|where
comma
op_amp
id|pci_addr
)paren
OL
l_int|0
)paren
(brace
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
multiline_comment|/* if */
id|addr
op_or_assign
(paren
id|pci_addr
op_lshift
l_int|5
)paren
op_plus
l_int|0x00
suffix:semicolon
op_star
id|value
op_assign
id|conf_read
c_func
(paren
id|addr
)paren
op_rshift
(paren
(paren
id|where
op_amp
l_int|3
)paren
op_star
l_int|8
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
r_int
DECL|function|pcibios_read_config_word
id|pcibios_read_config_word
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|device_fn
comma
r_int
r_char
id|where
comma
r_int
r_int
op_star
id|value
)paren
(brace
r_int
r_int
id|addr
op_assign
id|LCA_CONF
suffix:semicolon
r_int
r_int
id|pci_addr
suffix:semicolon
op_star
id|value
op_assign
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
id|where
op_amp
l_int|0x1
)paren
(brace
r_return
id|PCIBIOS_BAD_REGISTER_NUMBER
suffix:semicolon
)brace
multiline_comment|/* if */
r_if
c_cond
(paren
id|mk_conf_addr
c_func
(paren
id|bus
comma
id|device_fn
comma
id|where
comma
op_amp
id|pci_addr
)paren
)paren
(brace
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
multiline_comment|/* if */
id|addr
op_or_assign
(paren
id|pci_addr
op_lshift
l_int|5
)paren
op_plus
l_int|0x08
suffix:semicolon
op_star
id|value
op_assign
id|conf_read
c_func
(paren
id|addr
)paren
op_rshift
(paren
(paren
id|where
op_amp
l_int|3
)paren
op_star
l_int|8
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
r_int
DECL|function|pcibios_read_config_dword
id|pcibios_read_config_dword
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|device_fn
comma
r_int
r_char
id|where
comma
r_int
r_int
op_star
id|value
)paren
(brace
r_int
r_int
id|addr
op_assign
id|LCA_CONF
suffix:semicolon
r_int
r_int
id|pci_addr
suffix:semicolon
op_star
id|value
op_assign
l_int|0xffffffff
suffix:semicolon
r_if
c_cond
(paren
id|where
op_amp
l_int|0x3
)paren
(brace
r_return
id|PCIBIOS_BAD_REGISTER_NUMBER
suffix:semicolon
)brace
multiline_comment|/* if */
r_if
c_cond
(paren
id|mk_conf_addr
c_func
(paren
id|bus
comma
id|device_fn
comma
id|where
comma
op_amp
id|pci_addr
)paren
)paren
(brace
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
multiline_comment|/* if */
id|addr
op_or_assign
(paren
id|pci_addr
op_lshift
l_int|5
)paren
op_plus
l_int|0x18
suffix:semicolon
op_star
id|value
op_assign
id|conf_read
c_func
(paren
id|addr
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
r_int
DECL|function|pcibios_write_config_byte
id|pcibios_write_config_byte
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|device_fn
comma
r_int
r_char
id|where
comma
r_int
r_char
id|value
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;pcibios_write_config_byte&quot;
)paren
suffix:semicolon
)brace
r_int
DECL|function|pcibios_write_config_word
id|pcibios_write_config_word
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|device_fn
comma
r_int
r_char
id|where
comma
r_int
r_int
id|value
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;pcibios_write_config_word&quot;
)paren
suffix:semicolon
)brace
r_int
DECL|function|pcibios_write_config_dword
id|pcibios_write_config_dword
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|device_fn
comma
r_int
r_char
id|where
comma
r_int
r_int
id|value
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;pcibios_write_config_dword&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PCI */
r_int
r_int
DECL|function|bios32_init
id|bios32_init
c_func
(paren
r_int
r_int
id|memory_start
comma
r_int
r_int
id|memory_end
)paren
(brace
macro_line|#ifdef CONFIG_PCI
id|printk
c_func
(paren
l_string|&quot;LCA PCI BIOS32 revision %x.%02x&bslash;n&quot;
comma
id|MAJOR_REV
comma
id|MINOR_REV
)paren
suffix:semicolon
id|probe_pci
c_func
(paren
)paren
suffix:semicolon
macro_line|#if 0
(brace
r_char
id|buf
(braket
l_int|4096
)braket
suffix:semicolon
id|get_pci_list
c_func
(paren
id|buf
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s&quot;
comma
id|buf
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if 0
(brace
r_extern
r_void
id|NCR53c810_test
c_func
(paren
r_void
)paren
suffix:semicolon
id|NCR53c810_test
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#endif /* CONFIG_PCI */
r_return
id|memory_start
suffix:semicolon
)brace
multiline_comment|/* bios32_init */
multiline_comment|/*** end of lca.c ***/
eof
