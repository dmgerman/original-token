multiline_comment|/*&n; *&t;linux/arch/alpha/kernel/smp.c&n; */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/kernel_stat.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/tasks.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/hwrpb.h&gt;
macro_line|#include &lt;asm/ptrace.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/spinlock.h&gt;
macro_line|#include &lt;asm/hardirq.h&gt;
macro_line|#include &lt;asm/softirq.h&gt;
DECL|macro|__KERNEL_SYSCALLS__
mdefine_line|#define __KERNEL_SYSCALLS__
macro_line|#include &lt;asm/unistd.h&gt;
macro_line|#include &quot;proto.h&quot;
DECL|macro|DEBUG_SMP
mdefine_line|#define DEBUG_SMP 0
macro_line|#if DEBUG_SMP
DECL|macro|DBGS
mdefine_line|#define DBGS(args)&t;printk args
macro_line|#else
DECL|macro|DBGS
mdefine_line|#define DBGS(args)
macro_line|#endif
DECL|variable|__cacheline_aligned
r_struct
id|ipi_msg_flush_tb_struct
id|ipi_msg_flush_tb
id|__cacheline_aligned
suffix:semicolon
DECL|variable|cpu_data
r_struct
id|cpuinfo_alpha
id|cpu_data
(braket
id|NR_CPUS
)braket
suffix:semicolon
DECL|variable|ticker_lock
id|spinlock_t
id|ticker_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|kernel_flag
id|spinlock_t
id|kernel_flag
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|boot_cpu_id
r_int
r_int
id|boot_cpu_id
op_assign
l_int|0
suffix:semicolon
DECL|variable|smp_activated
r_static
r_int
id|smp_activated
op_assign
l_int|0
suffix:semicolon
DECL|variable|smp_found_config
r_int
id|smp_found_config
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Have we found an SMP box */
DECL|variable|max_cpus
r_static
r_int
id|max_cpus
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|cpu_present_map
r_int
r_int
id|cpu_present_map
op_assign
l_int|0
suffix:semicolon
DECL|variable|smp_num_cpus
r_int
id|smp_num_cpus
op_assign
l_int|1
suffix:semicolon
DECL|variable|smp_num_probed
r_int
id|smp_num_probed
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Internal processor count */
DECL|variable|smp_threads_ready
r_int
id|smp_threads_ready
op_assign
l_int|0
suffix:semicolon
DECL|variable|cpu_callin_map
r_volatile
r_int
r_int
id|cpu_callin_map
(braket
id|NR_CPUS
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
DECL|variable|smp_spinning
r_volatile
r_int
r_int
id|smp_spinning
(braket
id|NR_CPUS
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
DECL|variable|cacheflush_time
id|cycles_t
id|cacheflush_time
suffix:semicolon
DECL|variable|prof_multiplier
r_int
r_int
id|prof_multiplier
(braket
id|NR_CPUS
)braket
suffix:semicolon
DECL|variable|prof_counter
r_int
r_int
id|prof_counter
(braket
id|NR_CPUS
)braket
suffix:semicolon
DECL|variable|__cacheline_aligned
r_volatile
r_int
id|ipi_bits
(braket
id|NR_CPUS
)braket
id|__cacheline_aligned
suffix:semicolon
DECL|variable|boot_cpu_palrev
r_int
r_int
id|boot_cpu_palrev
suffix:semicolon
DECL|variable|smp_commenced
r_volatile
r_int
id|smp_commenced
op_assign
l_int|0
suffix:semicolon
DECL|variable|smp_processors_ready
r_volatile
r_int
id|smp_processors_ready
op_assign
l_int|0
suffix:semicolon
DECL|variable|cpu_number_map
r_volatile
r_int
id|cpu_number_map
(braket
id|NR_CPUS
)braket
suffix:semicolon
DECL|variable|cpu_logical_map
r_volatile
r_int
id|cpu_logical_map
(braket
id|NR_CPUS
)braket
suffix:semicolon
r_extern
r_void
id|calibrate_delay
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_struct
id|thread_struct
op_star
id|original_pcb_ptr
suffix:semicolon
r_static
r_void
id|smp_setup_percpu_timer
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|secondary_cpu_start
c_func
(paren
r_int
comma
r_struct
id|task_struct
op_star
)paren
suffix:semicolon
r_static
r_void
id|send_cpu_msg
c_func
(paren
r_char
op_star
comma
r_int
)paren
suffix:semicolon
multiline_comment|/* Process bootcommand SMP options, like &quot;nosmp&quot; and &quot;maxcpus=&quot; */
r_void
id|__init
DECL|function|smp_setup
id|smp_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
r_if
c_cond
(paren
id|ints
op_logical_and
id|ints
(braket
l_int|0
)braket
OG
l_int|0
)paren
id|max_cpus
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
r_else
id|max_cpus
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_void
id|__init
DECL|function|smp_store_cpu_info
id|smp_store_cpu_info
c_func
(paren
r_int
id|id
)paren
(brace
multiline_comment|/* This is it on Alpha, so far. */
id|cpu_data
(braket
id|id
)braket
dot
id|loops_per_sec
op_assign
id|loops_per_sec
suffix:semicolon
)brace
r_void
id|__init
DECL|function|smp_commence
id|smp_commence
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Lets the callin&squot;s below out of their loop. */
id|mb
c_func
(paren
)paren
suffix:semicolon
id|smp_commenced
op_assign
l_int|1
suffix:semicolon
)brace
r_void
id|__init
DECL|function|smp_callin
id|smp_callin
c_func
(paren
r_void
)paren
(brace
r_int
id|cpuid
op_assign
id|hard_smp_processor_id
c_func
(paren
)paren
suffix:semicolon
id|DBGS
c_func
(paren
(paren
l_string|&quot;CALLIN %d state 0x%lx&bslash;n&quot;
comma
id|cpuid
comma
id|current-&gt;state
)paren
)paren
suffix:semicolon
macro_line|#ifdef HUH
id|local_flush_cache_all
c_func
(paren
)paren
suffix:semicolon
id|local_flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if 0
id|set_irq_udt
c_func
(paren
id|mid_xlate
(braket
id|boot_cpu_id
)braket
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Get our local ticker going. */
id|smp_setup_percpu_timer
c_func
(paren
)paren
suffix:semicolon
macro_line|#if 0
id|calibrate_delay
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|smp_store_cpu_info
c_func
(paren
id|cpuid
)paren
suffix:semicolon
macro_line|#ifdef HUH
id|local_flush_cache_all
c_func
(paren
)paren
suffix:semicolon
id|local_flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Allow master to continue. */
id|set_bit
c_func
(paren
id|cpuid
comma
(paren
r_int
r_int
op_star
)paren
op_amp
id|cpu_callin_map
(braket
id|cpuid
)braket
)paren
suffix:semicolon
macro_line|#ifdef HUH
id|local_flush_cache_all
c_func
(paren
)paren
suffix:semicolon
id|local_flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef NOT_YET
r_while
c_loop
(paren
op_logical_neg
id|task
(braket
id|cpuid
)braket
op_logical_or
id|current_set
(braket
id|cpuid
)braket
op_ne
id|task
(braket
id|cpuid
)braket
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef HUH
id|local_flush_cache_all
c_func
(paren
)paren
suffix:semicolon
id|local_flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if 0
id|__sti
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
)brace
id|asmlinkage
r_int
id|__init
DECL|function|start_secondary
id|start_secondary
c_func
(paren
r_void
op_star
id|unused
)paren
(brace
r_extern
id|asmlinkage
r_void
id|entInt
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|paging_init_secondary
c_func
(paren
r_void
)paren
suffix:semicolon
id|wrmces
c_func
(paren
l_int|7
)paren
suffix:semicolon
id|paging_init_secondary
c_func
(paren
)paren
suffix:semicolon
id|trap_init
c_func
(paren
)paren
suffix:semicolon
id|wrent
c_func
(paren
id|entInt
comma
l_int|0
)paren
suffix:semicolon
id|smp_callin
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|smp_commenced
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
macro_line|#if 1
id|printk
c_func
(paren
l_string|&quot;start_secondary: commencing CPU %d current %p&bslash;n&quot;
comma
id|hard_smp_processor_id
c_func
(paren
)paren
comma
id|current
)paren
suffix:semicolon
macro_line|#endif
id|cpu_idle
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
r_static
r_void
id|__init
DECL|function|smp_tune_scheduling
id|smp_tune_scheduling
(paren
r_void
)paren
(brace
multiline_comment|/*&n;&t; * Rough estimation for SMP scheduling, this is the number of&n;&t; * cycles it takes for a fully memory-limited process to flush&n;&t; * the SMP-local cache.&n;&t; *&n;&t; * We are not told how much cache there is, so we have to guess.&n;&t; */
r_struct
id|percpu_struct
op_star
id|cpu
suffix:semicolon
r_int
r_int
id|on_chip_cache
suffix:semicolon
r_int
r_int
id|freq
suffix:semicolon
id|cpu
op_assign
(paren
r_struct
id|percpu_struct
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|hwrpb
op_plus
id|hwrpb-&gt;processor_offset
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cpu-&gt;type
)paren
(brace
r_case
id|EV45_CPU
suffix:colon
id|on_chip_cache
op_assign
l_int|16
op_plus
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EV5_CPU
suffix:colon
r_case
id|EV56_CPU
suffix:colon
id|on_chip_cache
op_assign
l_int|8
op_plus
l_int|8
op_plus
l_int|96
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCA56_CPU
suffix:colon
id|on_chip_cache
op_assign
l_int|16
op_plus
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EV6_CPU
suffix:colon
id|on_chip_cache
op_assign
l_int|64
op_plus
l_int|64
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|on_chip_cache
op_assign
l_int|8
op_plus
l_int|8
suffix:semicolon
r_break
suffix:semicolon
)brace
id|freq
op_assign
id|hwrpb-&gt;cycle_freq
ques
c_cond
suffix:colon
id|est_cycle_freq
suffix:semicolon
multiline_comment|/* Magic estimation stolen from x86 port.  */
id|cacheflush_time
op_assign
id|freq
op_div
l_int|1024
op_star
id|on_chip_cache
op_div
l_int|5000
suffix:semicolon
)brace
multiline_comment|/*&n; *      Cycle through the processors sending START msgs to boot each.&n; */
r_void
id|__init
DECL|function|smp_boot_cpus
id|smp_boot_cpus
c_func
(paren
r_void
)paren
(brace
r_int
id|cpucount
op_assign
l_int|0
suffix:semicolon
r_int
id|i
comma
id|first
comma
id|prev
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Entering SMP Mode.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if 0
id|__sti
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_CPUS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cpu_number_map
(braket
id|i
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
id|cpu_logical_map
(braket
id|i
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
id|prof_counter
(braket
id|i
)braket
op_assign
l_int|1
suffix:semicolon
id|prof_multiplier
(braket
id|i
)braket
op_assign
l_int|1
suffix:semicolon
id|ipi_bits
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|cpu_number_map
(braket
id|boot_cpu_id
)braket
op_assign
l_int|0
suffix:semicolon
id|cpu_logical_map
(braket
l_int|0
)braket
op_assign
id|boot_cpu_id
suffix:semicolon
id|current-&gt;processor
op_assign
id|boot_cpu_id
suffix:semicolon
multiline_comment|/* ??? */
id|smp_store_cpu_info
c_func
(paren
id|boot_cpu_id
)paren
suffix:semicolon
id|smp_tune_scheduling
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef NOT_YET
id|printk
c_func
(paren
l_string|&quot;CPU%d: &quot;
comma
id|boot_cpu_id
)paren
suffix:semicolon
id|print_cpu_info
c_func
(paren
op_amp
id|cpu_data
(braket
id|boot_cpu_id
)braket
)paren
suffix:semicolon
id|set_irq_udt
c_func
(paren
id|mid_xlate
(braket
id|boot_cpu_id
)braket
)paren
suffix:semicolon
macro_line|#endif
id|smp_setup_percpu_timer
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef HUH
id|local_flush_cache_all
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|smp_num_probed
op_eq
l_int|1
)paren
r_return
suffix:semicolon
multiline_comment|/* Not an MP box. */
macro_line|#if NOT_YET
multiline_comment|/*&n;&t; * If SMP should be disabled, then really disable it!&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|max_cpus
)paren
(brace
id|smp_found_config
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;SMP mode deactivated.&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_CPUS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
id|boot_cpu_id
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|cpu_present_map
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
(brace
r_struct
id|task_struct
op_star
id|idle
suffix:semicolon
r_int
id|timeout
suffix:semicolon
multiline_comment|/* Cook up an idler for this guy. */
id|kernel_thread
c_func
(paren
id|start_secondary
comma
l_int|NULL
comma
id|CLONE_PID
)paren
suffix:semicolon
id|idle
op_assign
id|task
(braket
op_increment
id|cpucount
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|idle
)paren
id|panic
c_func
(paren
l_string|&quot;No idle process for CPU %d&quot;
comma
id|i
)paren
suffix:semicolon
id|idle-&gt;processor
op_assign
id|i
suffix:semicolon
id|DBGS
c_func
(paren
(paren
l_string|&quot;smp_boot_cpus: CPU %d state 0x%lx flags 0x%lx&bslash;n&quot;
comma
id|i
comma
id|idle-&gt;state
comma
id|idle-&gt;flags
)paren
)paren
suffix:semicolon
multiline_comment|/* whirrr, whirrr, whirrrrrrrrr... */
macro_line|#ifdef HUH
id|local_flush_cache_all
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|secondary_cpu_start
c_func
(paren
id|i
comma
id|idle
)paren
suffix:semicolon
multiline_comment|/* wheee... it&squot;s going... wait for 5 secs...*/
r_for
c_loop
(paren
id|timeout
op_assign
l_int|0
suffix:semicolon
id|timeout
OL
l_int|50000
suffix:semicolon
id|timeout
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cpu_callin_map
(braket
id|i
)braket
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cpu_callin_map
(braket
id|i
)braket
)paren
(brace
multiline_comment|/* Another &quot;Red Snapper&quot;. */
id|cpu_number_map
(braket
id|i
)braket
op_assign
id|cpucount
suffix:semicolon
id|cpu_logical_map
(braket
id|cpucount
)braket
op_assign
id|i
suffix:semicolon
)brace
r_else
(brace
id|cpucount
op_decrement
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;smp_boot_cpus: Processor %d&quot;
l_string|&quot; is stuck 0x%lx.&bslash;n&quot;
comma
id|i
comma
id|idle-&gt;flags
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|cpu_callin_map
(braket
id|i
)braket
)paren
)paren
(brace
id|cpu_present_map
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|i
)paren
suffix:semicolon
id|cpu_number_map
(braket
id|i
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
)brace
macro_line|#ifdef HUH
id|local_flush_cache_all
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|cpucount
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smp_boot_cpus: ERROR - only one Processor found.&bslash;n&quot;
)paren
suffix:semicolon
id|cpu_present_map
op_assign
(paren
l_int|1
op_lshift
id|smp_processor_id
c_func
(paren
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
r_int
id|bogosum
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_CPUS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cpu_present_map
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
id|bogosum
op_add_assign
id|cpu_data
(braket
id|i
)braket
dot
id|loops_per_sec
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;smp_boot_cpus: Total of %d Processors activated&quot;
l_string|&quot; (%lu.%02lu BogoMIPS).&bslash;n&quot;
comma
id|cpucount
op_plus
l_int|1
comma
(paren
id|bogosum
op_plus
l_int|2500
)paren
op_div
l_int|500000
comma
(paren
(paren
id|bogosum
op_plus
l_int|2500
)paren
op_div
l_int|5000
)paren
op_mod
l_int|100
)paren
suffix:semicolon
id|smp_activated
op_assign
l_int|1
suffix:semicolon
id|smp_num_cpus
op_assign
id|cpucount
op_plus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Setup CPU list for IRQ distribution scheme. */
id|first
op_assign
id|prev
op_assign
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_CPUS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cpu_present_map
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
(brace
r_if
c_cond
(paren
id|first
op_eq
op_minus
l_int|1
)paren
id|first
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|prev
op_ne
op_minus
l_int|1
)paren
id|cpu_data
(braket
id|i
)braket
dot
id|next
op_assign
id|i
suffix:semicolon
id|prev
op_assign
id|i
suffix:semicolon
)brace
)brace
id|cpu_data
(braket
id|prev
)braket
dot
id|next
op_assign
id|first
suffix:semicolon
multiline_comment|/* Ok, they are spinning and ready to go. */
id|smp_processors_ready
op_assign
l_int|1
suffix:semicolon
)brace
r_static
r_void
id|__init
DECL|function|smp_setup_percpu_timer
id|smp_setup_percpu_timer
c_func
(paren
r_void
)paren
(brace
r_int
id|cpu
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
id|prof_counter
(braket
id|cpu
)braket
op_assign
id|prof_multiplier
(braket
id|cpu
)braket
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef NOT_YET
id|load_profile_irq
c_func
(paren
id|mid_xlate
(braket
id|cpu
)braket
comma
id|lvl14_resolution
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpu
op_eq
id|boot_cpu_id
)paren
id|enable_pil_irq
c_func
(paren
l_int|14
)paren
suffix:semicolon
macro_line|#endif
)brace
r_extern
r_void
id|update_one_process
c_func
(paren
r_struct
id|task_struct
op_star
id|p
comma
r_int
r_int
id|ticks
comma
r_int
r_int
id|user
comma
r_int
r_int
id|system
comma
r_int
id|cpu
)paren
suffix:semicolon
r_void
DECL|function|smp_percpu_timer_interrupt
id|smp_percpu_timer_interrupt
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|cpu
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef NOT_YET
id|clear_profile_irq
c_func
(paren
id|mid_xlate
(braket
id|cpu
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|user_mode
c_func
(paren
id|regs
)paren
)paren
(brace
id|alpha_do_profile
c_func
(paren
id|regs-&gt;pc
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|prof_counter
(braket
id|cpu
)braket
)paren
(brace
r_int
id|user
op_assign
id|user_mode
c_func
(paren
id|regs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;pid
)paren
(brace
id|update_one_process
c_func
(paren
id|current
comma
l_int|1
comma
id|user
comma
op_logical_neg
id|user
comma
id|cpu
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|current-&gt;counter
OL
l_int|0
)paren
(brace
id|current-&gt;counter
op_assign
l_int|0
suffix:semicolon
id|current-&gt;need_resched
op_assign
l_int|1
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|ticker_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|user
)paren
(brace
r_if
c_cond
(paren
id|current-&gt;priority
OL
id|DEF_PRIORITY
)paren
(brace
id|kstat.cpu_nice
op_increment
suffix:semicolon
id|kstat.per_cpu_nice
(braket
id|cpu
)braket
op_increment
suffix:semicolon
)brace
r_else
(brace
id|kstat.cpu_user
op_increment
suffix:semicolon
id|kstat.per_cpu_user
(braket
id|cpu
)braket
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
id|kstat.cpu_system
op_increment
suffix:semicolon
id|kstat.per_cpu_system
(braket
id|cpu
)braket
op_increment
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|ticker_lock
)paren
suffix:semicolon
)brace
id|prof_counter
(braket
id|cpu
)braket
op_assign
id|prof_multiplier
(braket
id|cpu
)braket
suffix:semicolon
)brace
)brace
r_int
id|__init
DECL|function|setup_profiling_timer
id|setup_profiling_timer
c_func
(paren
r_int
r_int
id|multiplier
)paren
(brace
macro_line|#ifdef NOT_YET
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* Prevent level14 ticker IRQ flooding. */
r_if
c_cond
(paren
(paren
op_logical_neg
id|multiplier
)paren
op_logical_or
(paren
id|lvl14_resolution
op_div
id|multiplier
)paren
OL
l_int|500
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_CPUS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cpu_present_map
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
(brace
id|load_profile_irq
c_func
(paren
id|mid_xlate
(braket
id|i
)braket
comma
id|lvl14_resolution
op_div
id|multip
id|lier
)paren
suffix:semicolon
id|prof_multiplier
(braket
id|i
)braket
op_assign
id|multiplier
suffix:semicolon
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Only broken Intel needs this, thus it should not even be&n;   referenced globally.  */
r_void
id|__init
DECL|function|initialize_secondary
id|initialize_secondary
c_func
(paren
r_void
)paren
(brace
)brace
r_static
r_void
id|__init
DECL|function|secondary_cpu_start
id|secondary_cpu_start
c_func
(paren
r_int
id|cpuid
comma
r_struct
id|task_struct
op_star
id|idle
)paren
(brace
r_struct
id|percpu_struct
op_star
id|cpu
suffix:semicolon
r_int
id|timeout
suffix:semicolon
id|cpu
op_assign
(paren
r_struct
id|percpu_struct
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|hwrpb
op_plus
id|hwrpb-&gt;processor_offset
op_plus
id|cpuid
op_star
id|hwrpb-&gt;processor_size
)paren
suffix:semicolon
multiline_comment|/* Set context to idle thread this CPU will use when running&n;&t;   assumption is that the idle thread is all set to go... ??? */
id|memcpy
c_func
(paren
op_amp
id|cpu-&gt;hwpcb
(braket
l_int|0
)braket
comma
op_amp
id|idle-&gt;tss
comma
r_sizeof
(paren
r_struct
id|pcb_struct
)paren
)paren
suffix:semicolon
id|cpu-&gt;hwpcb
(braket
l_int|4
)braket
op_assign
id|cpu-&gt;hwpcb
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* UNIQUE set to KSP ??? */
id|DBGS
c_func
(paren
(paren
l_string|&quot;KSP 0x%lx PTBR 0x%lx VPTBR 0x%lx&bslash;n&quot;
comma
id|cpu-&gt;hwpcb
(braket
l_int|0
)braket
comma
id|cpu-&gt;hwpcb
(braket
l_int|2
)braket
comma
id|hwrpb-&gt;vptb
)paren
)paren
suffix:semicolon
id|DBGS
c_func
(paren
(paren
l_string|&quot;Starting secondary cpu %d: state 0x%lx pal_flags 0x%lx&bslash;n&quot;
comma
id|cpuid
comma
id|idle-&gt;state
comma
id|idle-&gt;tss.pal_flags
)paren
)paren
suffix:semicolon
multiline_comment|/* Setup HWRPB fields that SRM uses to activate secondary CPU */
id|hwrpb-&gt;CPU_restart
op_assign
id|__start_cpu
suffix:semicolon
id|hwrpb-&gt;CPU_restart_data
op_assign
(paren
r_int
r_int
)paren
id|idle
suffix:semicolon
multiline_comment|/* Recalculate and update the HWRPB checksum */
id|hwrpb_update_checksum
c_func
(paren
id|hwrpb
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Send a &quot;start&quot; command to the specified processor.&n;&t; */
multiline_comment|/* SRM III 3.4.1.3 */
id|cpu-&gt;flags
op_or_assign
l_int|0x22
suffix:semicolon
multiline_comment|/* turn on Context Valid and Restart Capable */
id|cpu-&gt;flags
op_and_assign
op_complement
l_int|1
suffix:semicolon
multiline_comment|/* turn off Bootstrap In Progress */
id|mb
c_func
(paren
)paren
suffix:semicolon
id|send_cpu_msg
c_func
(paren
l_string|&quot;START&bslash;r&bslash;n&quot;
comma
id|cpuid
)paren
suffix:semicolon
multiline_comment|/* now, we wait... */
r_for
c_loop
(paren
id|timeout
op_assign
l_int|10000
suffix:semicolon
op_logical_neg
(paren
id|cpu-&gt;flags
op_amp
l_int|1
)paren
suffix:semicolon
id|timeout
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|timeout
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Processor %d failed to start&bslash;n&quot;
comma
id|cpuid
)paren
suffix:semicolon
multiline_comment|/* needed for pset_info to work */
macro_line|#if 0
id|ipc_processor_enable
c_func
(paren
id|cpu_to_processor
c_func
(paren
id|cpunum
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|DBGS
c_func
(paren
(paren
l_string|&quot;secondary_cpu_start: SUCCESS for CPU %d!!!&bslash;n&quot;
comma
id|cpuid
)paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|send_cpu_msg
id|send_cpu_msg
c_func
(paren
r_char
op_star
id|str
comma
r_int
id|cpuid
)paren
(brace
r_struct
id|percpu_struct
op_star
id|cpu
suffix:semicolon
r_register
r_char
op_star
id|cp1
comma
op_star
id|cp2
suffix:semicolon
r_int
r_int
id|cpumask
suffix:semicolon
r_int
id|len
suffix:semicolon
r_int
id|timeout
suffix:semicolon
id|cpu
op_assign
(paren
r_struct
id|percpu_struct
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|hwrpb
op_plus
id|hwrpb-&gt;processor_offset
op_plus
id|cpuid
op_star
id|hwrpb-&gt;processor_size
)paren
suffix:semicolon
id|cpumask
op_assign
(paren
l_int|1L
op_lshift
id|cpuid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hwrpb-&gt;txrdy
op_amp
id|cpumask
)paren
r_goto
id|delay1
suffix:semicolon
id|ready1
suffix:colon
id|cp2
op_assign
id|str
suffix:semicolon
id|len
op_assign
id|strlen
c_func
(paren
id|cp2
)paren
suffix:semicolon
op_star
(paren
r_int
r_int
op_star
)paren
op_amp
id|cpu-&gt;ipc_buffer
(braket
l_int|0
)braket
op_assign
id|len
suffix:semicolon
id|cp1
op_assign
(paren
r_char
op_star
)paren
op_amp
id|cpu-&gt;ipc_buffer
(braket
l_int|1
)braket
suffix:semicolon
id|memcpy
c_func
(paren
id|cp1
comma
id|cp2
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* atomic test and set */
id|set_bit
c_func
(paren
id|cpuid
comma
op_amp
id|hwrpb-&gt;rxrdy
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hwrpb-&gt;txrdy
op_amp
id|cpumask
)paren
r_goto
id|delay2
suffix:semicolon
id|ready2
suffix:colon
r_return
suffix:semicolon
id|delay1
suffix:colon
r_for
c_loop
(paren
id|timeout
op_assign
l_int|10000
suffix:semicolon
id|timeout
OG
l_int|0
suffix:semicolon
op_decrement
id|timeout
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|hwrpb-&gt;txrdy
op_amp
id|cpumask
)paren
)paren
r_goto
id|ready1
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
)brace
r_goto
id|timeout
suffix:semicolon
id|delay2
suffix:colon
r_for
c_loop
(paren
id|timeout
op_assign
l_int|10000
suffix:semicolon
id|timeout
OG
l_int|0
suffix:semicolon
op_decrement
id|timeout
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|hwrpb-&gt;txrdy
op_amp
id|cpumask
)paren
)paren
r_goto
id|ready2
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
)brace
r_goto
id|timeout
suffix:semicolon
id|timeout
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Processor %x not ready&bslash;n&quot;
comma
id|cpuid
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * setup_smp()&n; *&n; * called from arch/alpha/kernel/setup.c:setup_arch() when __SMP__ defined&n; */
r_void
id|__init
DECL|function|setup_smp
id|setup_smp
c_func
(paren
r_void
)paren
(brace
r_struct
id|percpu_struct
op_star
id|cpubase
comma
op_star
id|cpu
suffix:semicolon
r_int
id|i
suffix:semicolon
id|boot_cpu_id
op_assign
id|hard_smp_processor_id
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|boot_cpu_id
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;setup_smp: boot_cpu_id != 0 (%d).&bslash;n&quot;
comma
id|boot_cpu_id
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hwrpb-&gt;nr_processors
OG
l_int|1
)paren
(brace
id|DBGS
c_func
(paren
(paren
l_string|&quot;setup_smp: nr_processors %ld&bslash;n&quot;
comma
id|hwrpb-&gt;nr_processors
)paren
)paren
suffix:semicolon
id|cpubase
op_assign
(paren
r_struct
id|percpu_struct
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|hwrpb
op_plus
id|hwrpb-&gt;processor_offset
)paren
suffix:semicolon
id|boot_cpu_palrev
op_assign
id|cpubase-&gt;pal_revision
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|hwrpb-&gt;nr_processors
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cpu
op_assign
(paren
r_struct
id|percpu_struct
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|cpubase
op_plus
id|i
op_star
id|hwrpb-&gt;processor_size
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cpu-&gt;flags
op_amp
l_int|0x1cc
)paren
op_eq
l_int|0x1cc
)paren
(brace
id|smp_num_probed
op_increment
suffix:semicolon
multiline_comment|/* assume here that &quot;whami&quot; == index */
id|cpu_present_map
op_or_assign
(paren
l_int|1
op_lshift
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
id|boot_cpu_id
)paren
id|cpu-&gt;pal_revision
op_assign
id|boot_cpu_palrev
suffix:semicolon
)brace
id|DBGS
c_func
(paren
(paren
l_string|&quot;setup_smp: CPU %d: flags 0x%lx type 0x%lx&bslash;n&quot;
comma
id|i
comma
id|cpu-&gt;flags
comma
id|cpu-&gt;type
)paren
)paren
suffix:semicolon
id|DBGS
c_func
(paren
(paren
l_string|&quot;setup_smp: CPU %d: PAL rev 0x%lx&bslash;n&quot;
comma
id|i
comma
id|cpu-&gt;pal_revision
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|smp_num_probed
op_assign
l_int|1
suffix:semicolon
id|cpu_present_map
op_assign
(paren
l_int|1
op_lshift
id|boot_cpu_id
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;setup_smp: %d CPUs probed, cpu_present_map 0x%x,&quot;
l_string|&quot; boot_cpu_id %d&bslash;n&quot;
comma
id|smp_num_probed
comma
id|cpu_present_map
comma
id|boot_cpu_id
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|secondary_console_message
id|secondary_console_message
c_func
(paren
r_void
)paren
(brace
r_int
id|mycpu
comma
id|i
comma
id|cnt
suffix:semicolon
r_int
r_int
id|txrdy
op_assign
id|hwrpb-&gt;txrdy
suffix:semicolon
r_char
op_star
id|cp1
comma
op_star
id|cp2
comma
id|buf
(braket
l_int|80
)braket
suffix:semicolon
r_struct
id|percpu_struct
op_star
id|cpu
suffix:semicolon
id|DBGS
c_func
(paren
(paren
l_string|&quot;secondary_console_message: TXRDY 0x%lx.&bslash;n&quot;
comma
id|txrdy
)paren
)paren
suffix:semicolon
id|mycpu
op_assign
id|hard_smp_processor_id
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_CPUS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|txrdy
op_amp
(paren
l_int|1L
op_lshift
id|i
)paren
)paren
)paren
r_continue
suffix:semicolon
id|DBGS
c_func
(paren
(paren
l_string|&quot;secondary_console_message: &quot;
l_string|&quot;TXRDY contains CPU %d.&bslash;n&quot;
comma
id|i
)paren
)paren
suffix:semicolon
id|cpu
op_assign
(paren
r_struct
id|percpu_struct
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|hwrpb
op_plus
id|hwrpb-&gt;processor_offset
op_plus
id|i
op_star
id|hwrpb-&gt;processor_size
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;secondary_console_message: on %d from %d&quot;
l_string|&quot; HALT_REASON 0x%lx FLAGS 0x%lx&bslash;n&quot;
comma
id|mycpu
comma
id|i
comma
id|cpu-&gt;halt_reason
comma
id|cpu-&gt;flags
)paren
suffix:semicolon
id|cnt
op_assign
id|cpu-&gt;ipc_buffer
(braket
l_int|0
)braket
op_rshift
l_int|32
suffix:semicolon
r_if
c_cond
(paren
id|cnt
op_le
l_int|0
op_logical_or
id|cnt
op_ge
l_int|80
)paren
id|strcpy
c_func
(paren
id|buf
comma
l_string|&quot;&lt;&lt;&lt; BOGUS MSG &gt;&gt;&gt;&quot;
)paren
suffix:semicolon
r_else
(brace
id|cp1
op_assign
(paren
r_char
op_star
)paren
op_amp
id|cpu-&gt;ipc_buffer
(braket
l_int|11
)braket
suffix:semicolon
id|cp2
op_assign
id|buf
suffix:semicolon
id|strcpy
c_func
(paren
id|cp2
comma
id|cp1
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|cp2
op_assign
id|strchr
c_func
(paren
id|cp2
comma
l_char|&squot;&bslash;r&squot;
)paren
)paren
op_ne
l_int|0
)paren
(brace
op_star
id|cp2
op_assign
l_char|&squot; &squot;
suffix:semicolon
r_if
c_cond
(paren
id|cp2
(braket
l_int|1
)braket
op_eq
l_char|&squot;&bslash;n&squot;
)paren
id|cp2
(braket
l_int|1
)braket
op_assign
l_char|&squot; &squot;
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;secondary_console_message: on %d message is &squot;%s&squot;&bslash;n&quot;
comma
id|mycpu
comma
id|buf
)paren
suffix:semicolon
)brace
id|hwrpb-&gt;txrdy
op_assign
l_int|0
suffix:semicolon
)brace
DECL|enum|ipi_message_type
r_enum
id|ipi_message_type
(brace
DECL|enumerator|IPI_TLB_ALL
id|IPI_TLB_ALL
comma
DECL|enumerator|IPI_TLB_MM
id|IPI_TLB_MM
comma
DECL|enumerator|IPI_TLB_PAGE
id|IPI_TLB_PAGE
comma
DECL|enumerator|IPI_RESCHEDULE
id|IPI_RESCHEDULE
comma
DECL|enumerator|IPI_CPU_STOP
id|IPI_CPU_STOP
)brace
suffix:semicolon
r_void
DECL|function|handle_ipi
id|handle_ipi
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|this_cpu
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
r_volatile
r_int
op_star
id|pending_ipis
op_assign
op_amp
id|ipi_bits
(braket
id|this_cpu
)braket
suffix:semicolon
r_int
r_int
id|ops
suffix:semicolon
id|DBGS
c_func
(paren
(paren
l_string|&quot;handle_ipi: on CPU %d ops 0x%x PC 0x%lx&bslash;n&quot;
comma
id|this_cpu
comma
op_star
id|pending_ipis
comma
id|regs-&gt;pc
)paren
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Order interrupt and bit testing. */
r_while
c_loop
(paren
(paren
id|ops
op_assign
id|xchg
c_func
(paren
id|pending_ipis
comma
l_int|0
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|mb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Order bit clearing and data access. */
r_do
(brace
r_int
r_int
id|which
suffix:semicolon
id|which
op_assign
id|ops
op_amp
op_minus
id|ops
suffix:semicolon
id|ops
op_and_assign
op_complement
id|which
suffix:semicolon
id|which
op_assign
id|ffz
c_func
(paren
op_complement
id|which
)paren
suffix:semicolon
r_if
c_cond
(paren
id|which
OL
id|IPI_RESCHEDULE
)paren
(brace
r_if
c_cond
(paren
id|which
op_eq
id|IPI_TLB_ALL
)paren
id|tbia
c_func
(paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|which
op_eq
id|IPI_TLB_MM
)paren
(brace
r_struct
id|mm_struct
op_star
id|mm
suffix:semicolon
id|mm
op_assign
id|ipi_msg_flush_tb.p.flush_mm
suffix:semicolon
r_if
c_cond
(paren
id|mm
op_eq
id|current-&gt;mm
)paren
id|flush_tlb_current
c_func
(paren
id|mm
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* IPI_TLB_PAGE */
(brace
r_struct
id|vm_area_struct
op_star
id|vma
suffix:semicolon
r_struct
id|mm_struct
op_star
id|mm
suffix:semicolon
r_int
r_int
id|addr
suffix:semicolon
id|vma
op_assign
id|ipi_msg_flush_tb.p.flush_vma
suffix:semicolon
id|mm
op_assign
id|vma-&gt;vm_mm
suffix:semicolon
id|addr
op_assign
id|ipi_msg_flush_tb.flush_addr
suffix:semicolon
r_if
c_cond
(paren
id|mm
op_eq
id|current-&gt;mm
)paren
id|flush_tlb_current_page
c_func
(paren
id|mm
comma
id|vma
comma
id|addr
)paren
suffix:semicolon
)brace
id|clear_bit
c_func
(paren
id|this_cpu
comma
op_amp
id|ipi_msg_flush_tb.flush_tb_mask
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|which
op_eq
id|IPI_RESCHEDULE
)paren
(brace
multiline_comment|/* Reschedule callback.  Everything to be done&n;&t;&t;&t;   is done by the interrupt return path.  */
)brace
r_else
r_if
c_cond
(paren
id|which
op_eq
id|IPI_CPU_STOP
)paren
(brace
id|halt
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;unknown_ipi() on CPU %d: %lu&bslash;n&quot;
comma
id|this_cpu
comma
id|which
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|ops
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Order data access and bit testing. */
)brace
id|cpu_data
(braket
id|this_cpu
)braket
dot
id|ipi_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|hwrpb-&gt;txrdy
)paren
id|secondary_console_message
c_func
(paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|send_ipi_message
id|send_ipi_message
c_func
(paren
r_int
r_int
id|to_whom
comma
r_enum
id|ipi_message_type
id|operation
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
multiline_comment|/* Reduce the number of memory barriers by doing two loops,&n;&t;   one to set the bits, one to invoke the interrupts.  */
id|mb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Order out-of-band data and bit setting. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|j
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|NR_CPUS
suffix:semicolon
op_increment
id|i
comma
id|j
op_lshift_assign
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|to_whom
op_amp
id|j
)paren
id|set_bit
c_func
(paren
id|operation
comma
op_amp
id|ipi_bits
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|mb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Order bit setting and interrupt. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|j
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|NR_CPUS
suffix:semicolon
op_increment
id|i
comma
id|j
op_lshift_assign
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|to_whom
op_amp
id|j
)paren
id|wripir
c_func
(paren
id|i
)paren
suffix:semicolon
)brace
)brace
r_int
DECL|function|smp_info
id|smp_info
c_func
(paren
r_char
op_star
id|buffer
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|sum
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_CPUS
suffix:semicolon
id|i
op_increment
)paren
id|sum
op_add_assign
id|cpu_data
(braket
id|i
)braket
dot
id|ipi_count
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;CPUs probed %d active %d map 0x%x IPIs %ld&bslash;n&quot;
comma
id|smp_num_probed
comma
id|smp_num_cpus
comma
id|cpu_present_map
comma
id|sum
)paren
suffix:semicolon
)brace
r_void
DECL|function|smp_send_reschedule
id|smp_send_reschedule
c_func
(paren
r_int
id|cpu
)paren
(brace
id|send_ipi_message
c_func
(paren
l_int|1
op_lshift
id|cpu
comma
id|IPI_RESCHEDULE
)paren
suffix:semicolon
)brace
r_void
DECL|function|smp_send_stop
id|smp_send_stop
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|to_whom
op_assign
id|cpu_present_map
op_xor
(paren
l_int|1
op_lshift
id|smp_processor_id
c_func
(paren
)paren
)paren
suffix:semicolon
id|send_ipi_message
c_func
(paren
id|to_whom
comma
id|IPI_CPU_STOP
)paren
suffix:semicolon
)brace
r_void
DECL|function|flush_tlb_all
id|flush_tlb_all
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|to_whom
op_assign
id|cpu_present_map
op_xor
(paren
l_int|1
op_lshift
id|smp_processor_id
c_func
(paren
)paren
)paren
suffix:semicolon
r_int
id|timeout
op_assign
l_int|1000000
suffix:semicolon
id|spin_lock_own
c_func
(paren
op_amp
id|kernel_flag
comma
l_string|&quot;flush_tlb_all&quot;
)paren
suffix:semicolon
id|ipi_msg_flush_tb.flush_tb_mask
op_assign
id|to_whom
suffix:semicolon
id|send_ipi_message
c_func
(paren
id|to_whom
comma
id|IPI_TLB_ALL
)paren
suffix:semicolon
id|tbia
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|ipi_msg_flush_tb.flush_tb_mask
op_logical_and
op_decrement
id|timeout
)paren
(brace
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|timeout
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;flush_tlb_all: STUCK on CPU %d mask 0x%x&bslash;n&quot;
comma
id|smp_processor_id
c_func
(paren
)paren
comma
id|ipi_msg_flush_tb.flush_tb_mask
)paren
suffix:semicolon
id|ipi_msg_flush_tb.flush_tb_mask
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_void
DECL|function|flush_tlb_mm
id|flush_tlb_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
r_int
r_int
id|to_whom
op_assign
id|cpu_present_map
op_xor
(paren
l_int|1
op_lshift
id|smp_processor_id
c_func
(paren
)paren
)paren
suffix:semicolon
r_int
id|timeout
op_assign
l_int|1000000
suffix:semicolon
id|spin_lock_own
c_func
(paren
op_amp
id|kernel_flag
comma
l_string|&quot;flush_tlb_mm&quot;
)paren
suffix:semicolon
id|ipi_msg_flush_tb.flush_tb_mask
op_assign
id|to_whom
suffix:semicolon
id|ipi_msg_flush_tb.p.flush_mm
op_assign
id|mm
suffix:semicolon
id|send_ipi_message
c_func
(paren
id|to_whom
comma
id|IPI_TLB_MM
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mm
op_ne
id|current-&gt;mm
)paren
id|flush_tlb_other
c_func
(paren
id|mm
)paren
suffix:semicolon
r_else
id|flush_tlb_current
c_func
(paren
id|mm
)paren
suffix:semicolon
r_while
c_loop
(paren
id|ipi_msg_flush_tb.flush_tb_mask
op_logical_and
op_decrement
id|timeout
)paren
(brace
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|timeout
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;flush_tlb_mm: STUCK on CPU %d mask 0x%x&bslash;n&quot;
comma
id|smp_processor_id
c_func
(paren
)paren
comma
id|ipi_msg_flush_tb.flush_tb_mask
)paren
suffix:semicolon
id|ipi_msg_flush_tb.flush_tb_mask
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_void
DECL|function|flush_tlb_page
id|flush_tlb_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|addr
)paren
(brace
r_int
id|cpu
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
r_int
r_int
id|to_whom
op_assign
id|cpu_present_map
op_xor
(paren
l_int|1
op_lshift
id|cpu
)paren
suffix:semicolon
r_struct
id|mm_struct
op_star
id|mm
op_assign
id|vma-&gt;vm_mm
suffix:semicolon
r_int
id|timeout
op_assign
l_int|1000000
suffix:semicolon
id|spin_lock_own
c_func
(paren
op_amp
id|kernel_flag
comma
l_string|&quot;flush_tlb_page&quot;
)paren
suffix:semicolon
id|ipi_msg_flush_tb.flush_tb_mask
op_assign
id|to_whom
suffix:semicolon
id|ipi_msg_flush_tb.p.flush_vma
op_assign
id|vma
suffix:semicolon
id|ipi_msg_flush_tb.flush_addr
op_assign
id|addr
suffix:semicolon
id|send_ipi_message
c_func
(paren
id|to_whom
comma
id|IPI_TLB_PAGE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mm
op_ne
id|current-&gt;mm
)paren
id|flush_tlb_other
c_func
(paren
id|mm
)paren
suffix:semicolon
r_else
id|flush_tlb_current_page
c_func
(paren
id|mm
comma
id|vma
comma
id|addr
)paren
suffix:semicolon
r_while
c_loop
(paren
id|ipi_msg_flush_tb.flush_tb_mask
op_logical_and
op_decrement
id|timeout
)paren
(brace
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|timeout
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;flush_tlb_page: STUCK on CPU %d mask 0x%x&bslash;n&quot;
comma
id|smp_processor_id
c_func
(paren
)paren
comma
id|ipi_msg_flush_tb.flush_tb_mask
)paren
suffix:semicolon
id|ipi_msg_flush_tb.flush_tb_mask
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_void
DECL|function|flush_tlb_range
id|flush_tlb_range
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
multiline_comment|/* On the Alpha we always flush the whole user tlb.  */
id|flush_tlb_mm
c_func
(paren
id|mm
)paren
suffix:semicolon
)brace
macro_line|#if DEBUG_SPINLOCK
macro_line|#ifdef MANAGE_SPINLOCK_IPL
r_static
r_inline
r_int
DECL|function|spinlock_raise_ipl
id|spinlock_raise_ipl
c_func
(paren
id|spinlock_t
op_star
id|lock
)paren
(brace
r_int
id|min_ipl
op_assign
id|lock-&gt;target_ipl
suffix:semicolon
r_int
id|last_ipl
op_assign
id|swpipl
c_func
(paren
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|last_ipl
OL
l_int|7
op_logical_and
id|min_ipl
OL
l_int|7
)paren
id|setipl
c_func
(paren
id|min_ipl
OL
id|last_ipl
ques
c_cond
id|last_ipl
suffix:colon
id|min_ipl
)paren
suffix:semicolon
r_return
id|last_ipl
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|spinlock_restore_ipl
id|spinlock_restore_ipl
c_func
(paren
r_int
id|prev
)paren
(brace
id|setipl
c_func
(paren
id|prev
)paren
suffix:semicolon
)brace
macro_line|#else
DECL|macro|spinlock_raise_ipl
mdefine_line|#define spinlock_raise_ipl(LOCK)&t;((void)(LOCK), 0)
DECL|macro|spinlock_restore_ipl
mdefine_line|#define spinlock_restore_ipl(PREV)&t;((void)(PREV))
macro_line|#endif /* MANAGE_SPINLOCK_IPL */
r_void
DECL|function|spin_unlock
id|spin_unlock
c_func
(paren
id|spinlock_t
op_star
id|lock
)paren
(brace
r_int
id|old_ipl
op_assign
id|lock-&gt;saved_ipl
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|lock-&gt;lock
op_assign
l_int|0
suffix:semicolon
id|spinlock_restore_ipl
c_func
(paren
id|old_ipl
)paren
suffix:semicolon
)brace
r_void
DECL|function|spin_lock
id|spin_lock
c_func
(paren
id|spinlock_t
op_star
id|lock
)paren
(brace
r_int
id|tmp
suffix:semicolon
r_int
id|stuck
op_assign
l_int|1
op_lshift
l_int|27
suffix:semicolon
r_void
op_star
id|inline_pc
op_assign
id|__builtin_return_address
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_int
r_int
id|started
op_assign
id|jiffies
suffix:semicolon
r_int
id|printed
op_assign
l_int|0
suffix:semicolon
r_int
id|cpu
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
r_int
id|old_ipl
op_assign
id|spinlock_raise_ipl
c_func
(paren
id|lock
)paren
suffix:semicolon
id|try_again
suffix:colon
id|stuck
op_assign
l_int|0x10000000
suffix:semicolon
multiline_comment|/* was 4G, now 256M */
multiline_comment|/* Use sub-sections to put the actual loop at the end&n;&t;   of this object file&squot;s text section so as to perfect&n;&t;   branch prediction.  */
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;1:&t;ldl_l&t;%0,%1&bslash;n&quot;
l_string|&quot;&t;subq&t;%2,1,%2&bslash;n&quot;
l_string|&quot;&t;blbs&t;%0,2f&bslash;n&quot;
l_string|&quot;&t;or&t;%0,1,%0&bslash;n&quot;
l_string|&quot;&t;stl_c&t;%0,%1&bslash;n&quot;
l_string|&quot;&t;beq&t;%0,3f&bslash;n&quot;
l_string|&quot;4:&t;mb&bslash;n&quot;
l_string|&quot;.section .text2,&bslash;&quot;ax&bslash;&quot;&bslash;n&quot;
l_string|&quot;2:&t;ldl&t;%0,%1&bslash;n&quot;
l_string|&quot;&t;subq&t;%2,1,%2&bslash;n&quot;
l_string|&quot;3:&t;blt&t;%2,4b&bslash;n&quot;
l_string|&quot;&t;blbs&t;%0,2b&bslash;n&quot;
l_string|&quot;&t;br&t;1b&bslash;n&quot;
l_string|&quot;.previous&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|tmp
)paren
comma
l_string|&quot;=m&quot;
(paren
id|__dummy_lock
c_func
(paren
id|lock
)paren
)paren
comma
l_string|&quot;=r&quot;
(paren
id|stuck
)paren
suffix:colon
l_string|&quot;2&quot;
(paren
id|stuck
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stuck
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|printed
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;spinlock stuck at %p(%d) owner %s at %p&bslash;n&quot;
comma
id|inline_pc
comma
id|cpu
comma
id|lock-&gt;task-&gt;comm
comma
id|lock-&gt;previous
)paren
suffix:semicolon
id|printed
op_assign
l_int|1
suffix:semicolon
)brace
id|stuck
op_assign
l_int|1
op_lshift
l_int|30
suffix:semicolon
r_goto
id|try_again
suffix:semicolon
)brace
multiline_comment|/* Exiting.  Got the lock.  */
id|lock-&gt;saved_ipl
op_assign
id|old_ipl
suffix:semicolon
id|lock-&gt;on_cpu
op_assign
id|cpu
suffix:semicolon
id|lock-&gt;previous
op_assign
id|inline_pc
suffix:semicolon
id|lock-&gt;task
op_assign
id|current
suffix:semicolon
r_if
c_cond
(paren
id|printed
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;spinlock grabbed at %p(%d) %ld ticks&bslash;n&quot;
comma
id|inline_pc
comma
id|cpu
comma
id|jiffies
op_minus
id|started
)paren
suffix:semicolon
)brace
)brace
r_int
DECL|function|spin_trylock
id|spin_trylock
c_func
(paren
id|spinlock_t
op_star
id|lock
)paren
(brace
r_int
id|old_ipl
op_assign
id|spinlock_raise_ipl
c_func
(paren
id|lock
)paren
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
op_logical_neg
id|test_and_set_bit
c_func
(paren
l_int|0
comma
id|lock
)paren
)paren
)paren
(brace
id|mb
c_func
(paren
)paren
suffix:semicolon
id|lock-&gt;saved_ipl
op_assign
id|old_ipl
suffix:semicolon
id|lock-&gt;on_cpu
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
id|lock-&gt;previous
op_assign
id|__builtin_return_address
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|lock-&gt;task
op_assign
id|current
suffix:semicolon
)brace
r_else
(brace
id|spinlock_restore_ipl
c_func
(paren
id|old_ipl
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
macro_line|#endif /* DEBUG_SPINLOCK */
macro_line|#if DEBUG_RWLOCK
DECL|function|write_lock
r_void
id|write_lock
c_func
(paren
id|rwlock_t
op_star
id|lock
)paren
(brace
r_int
id|regx
comma
id|regy
suffix:semicolon
r_int
id|stuck_lock
comma
id|stuck_reader
suffix:semicolon
r_void
op_star
id|inline_pc
op_assign
id|__builtin_return_address
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|try_again
suffix:colon
id|stuck_lock
op_assign
l_int|1
op_lshift
l_int|26
suffix:semicolon
id|stuck_reader
op_assign
l_int|1
op_lshift
l_int|26
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;1:&t;ldl_l&t;%1,%0&bslash;n&quot;
l_string|&quot;&t;blbs&t;%1,6f&bslash;n&quot;
l_string|&quot;&t;blt&t;%1,8f&bslash;n&quot;
l_string|&quot;&t;mov&t;1,%1&bslash;n&quot;
l_string|&quot;&t;stl_c&t;%1,%0&bslash;n&quot;
l_string|&quot;&t;beq&t;%1,6f&bslash;n&quot;
l_string|&quot;4:&t;mb&bslash;n&quot;
l_string|&quot;.section .text2,&bslash;&quot;ax&bslash;&quot;&bslash;n&quot;
l_string|&quot;6:&t;blt&t;%3,4b&t;# debug&bslash;n&quot;
l_string|&quot;&t;subl&t;%3,1,%3&t;# debug&bslash;n&quot;
l_string|&quot;&t;ldl&t;%1,%0&bslash;n&quot;
l_string|&quot;&t;blbs&t;%1,6b&bslash;n&quot;
l_string|&quot;8:&t;blt&t;%4,4b&t;# debug&bslash;n&quot;
l_string|&quot;&t;subl&t;%4,1,%4&t;# debug&bslash;n&quot;
l_string|&quot;&t;ldl&t;%1,%0&bslash;n&quot;
l_string|&quot;&t;blt&t;%1,8b&bslash;n&quot;
l_string|&quot;&t;br&t;1b&bslash;n&quot;
l_string|&quot;.previous&quot;
suffix:colon
l_string|&quot;=m&quot;
(paren
id|__dummy_lock
c_func
(paren
id|lock
)paren
)paren
comma
l_string|&quot;=&amp;r&quot;
(paren
id|regx
)paren
comma
l_string|&quot;=&amp;r&quot;
(paren
id|regy
)paren
comma
l_string|&quot;=&amp;r&quot;
(paren
id|stuck_lock
)paren
comma
l_string|&quot;=&amp;r&quot;
(paren
id|stuck_reader
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|__dummy_lock
c_func
(paren
id|lock
)paren
)paren
comma
l_string|&quot;3&quot;
(paren
id|stuck_lock
)paren
comma
l_string|&quot;4&quot;
(paren
id|stuck_reader
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stuck_lock
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;write_lock stuck at %p&bslash;n&quot;
comma
id|inline_pc
)paren
suffix:semicolon
r_goto
id|try_again
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stuck_reader
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;write_lock stuck on readers at %p&bslash;n&quot;
comma
id|inline_pc
)paren
suffix:semicolon
r_goto
id|try_again
suffix:semicolon
)brace
)brace
DECL|function|read_lock
r_void
id|read_lock
c_func
(paren
id|rwlock_t
op_star
id|lock
)paren
(brace
r_int
id|regx
suffix:semicolon
r_int
id|stuck_lock
suffix:semicolon
r_void
op_star
id|inline_pc
op_assign
id|__builtin_return_address
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|try_again
suffix:colon
id|stuck_lock
op_assign
l_int|1
op_lshift
l_int|26
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;1:&t;ldl_l&t;%1,%0;&quot;
l_string|&quot;&t;blbs&t;%1,6f;&quot;
l_string|&quot;&t;subl&t;%1,2,%1;&quot;
l_string|&quot;&t;stl_c&t;%1,%0;&quot;
l_string|&quot;&t;beq&t;%1,6f;&quot;
l_string|&quot;4:&t;mb&bslash;n&quot;
l_string|&quot;.section .text2,&bslash;&quot;ax&bslash;&quot;&bslash;n&quot;
l_string|&quot;6:&t;ldl&t;%1,%0;&quot;
l_string|&quot;&t;blt&t;%2,4b&t;# debug&bslash;n&quot;
l_string|&quot;&t;subl&t;%2,1,%2&t;# debug&bslash;n&quot;
l_string|&quot;&t;blbs&t;%1,6b;&quot;
l_string|&quot;&t;br&t;1b&bslash;n&quot;
l_string|&quot;.previous&quot;
suffix:colon
l_string|&quot;=m&quot;
(paren
id|__dummy_lock
c_func
(paren
id|lock
)paren
)paren
comma
l_string|&quot;=&amp;r&quot;
(paren
id|regx
)paren
comma
l_string|&quot;=&amp;r&quot;
(paren
id|stuck_lock
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|__dummy_lock
c_func
(paren
id|lock
)paren
)paren
comma
l_string|&quot;2&quot;
(paren
id|stuck_lock
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stuck_lock
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;read_lock stuck at %p&bslash;n&quot;
comma
id|inline_pc
)paren
suffix:semicolon
r_goto
id|try_again
suffix:semicolon
)brace
)brace
macro_line|#endif /* DEBUG_RWLOCK */
eof
