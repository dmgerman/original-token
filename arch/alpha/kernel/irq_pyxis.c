multiline_comment|/*&n; *&t;linux/arch/alpha/kernel/irq_pyxis.c&n; *&n; * Based on code written by David A Rusling (david.rusling@reo.mts.dec.com).&n; *&n; * IRQ Code common to all PYXIS core logic chips.&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/core_cia.h&gt;
macro_line|#include &quot;proto.h&quot;
macro_line|#include &quot;irq_impl.h&quot;
multiline_comment|/* Note mask bit is true for ENABLED irqs.  */
DECL|variable|cached_irq_mask
r_static
r_int
r_int
id|cached_irq_mask
suffix:semicolon
r_static
r_inline
r_void
DECL|function|pyxis_update_irq_hw
id|pyxis_update_irq_hw
c_func
(paren
r_int
r_int
id|mask
)paren
(brace
op_star
(paren
id|vulp
)paren
id|PYXIS_INT_MASK
op_assign
id|mask
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
op_star
(paren
id|vulp
)paren
id|PYXIS_INT_MASK
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|pyxis_enable_irq
id|pyxis_enable_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|pyxis_update_irq_hw
c_func
(paren
id|cached_irq_mask
op_or_assign
l_int|1UL
op_lshift
(paren
id|irq
op_minus
l_int|16
)paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|pyxis_disable_irq
id|pyxis_disable_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|pyxis_update_irq_hw
c_func
(paren
id|cached_irq_mask
op_and_assign
op_complement
(paren
l_int|1UL
op_lshift
(paren
id|irq
op_minus
l_int|16
)paren
)paren
)paren
suffix:semicolon
)brace
r_static
r_int
r_int
DECL|function|pyxis_startup_irq
id|pyxis_startup_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|pyxis_enable_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|pyxis_end_irq
id|pyxis_end_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|irq_desc
(braket
id|irq
)braket
dot
id|status
op_amp
(paren
id|IRQ_DISABLED
op_or
id|IRQ_INPROGRESS
)paren
)paren
)paren
id|pyxis_enable_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|pyxis_mask_and_ack_irq
id|pyxis_mask_and_ack_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
r_int
id|bit
op_assign
l_int|1UL
op_lshift
(paren
id|irq
op_minus
l_int|16
)paren
suffix:semicolon
r_int
r_int
id|mask
op_assign
id|cached_irq_mask
op_and_assign
op_complement
id|bit
suffix:semicolon
multiline_comment|/* Disable the interrupt.  */
op_star
(paren
id|vulp
)paren
id|PYXIS_INT_MASK
op_assign
id|mask
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Ack PYXIS PCI interrupt.  */
op_star
(paren
id|vulp
)paren
id|PYXIS_INT_REQ
op_assign
id|bit
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Re-read to force both writes.  */
op_star
(paren
id|vulp
)paren
id|PYXIS_INT_MASK
suffix:semicolon
)brace
DECL|variable|pyxis_irq_type
r_static
r_struct
id|hw_interrupt_type
id|pyxis_irq_type
op_assign
(brace
r_typename
suffix:colon
l_string|&quot;PYXIS&quot;
comma
id|startup
suffix:colon
id|pyxis_startup_irq
comma
id|shutdown
suffix:colon
id|pyxis_disable_irq
comma
id|enable
suffix:colon
id|pyxis_enable_irq
comma
id|disable
suffix:colon
id|pyxis_disable_irq
comma
id|ack
suffix:colon
id|pyxis_mask_and_ack_irq
comma
id|end
suffix:colon
id|pyxis_end_irq
comma
)brace
suffix:semicolon
r_void
DECL|function|pyxis_device_interrupt
id|pyxis_device_interrupt
c_func
(paren
r_int
r_int
id|vector
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|pld
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
multiline_comment|/* Read the interrupt summary register of PYXIS */
id|pld
op_assign
op_star
(paren
id|vulp
)paren
id|PYXIS_INT_REQ
suffix:semicolon
id|pld
op_and_assign
id|cached_irq_mask
suffix:semicolon
multiline_comment|/*&n;&t; * Now for every possible bit set, work through them and call&n;&t; * the appropriate interrupt handler.&n;&t; */
r_while
c_loop
(paren
id|pld
)paren
(brace
id|i
op_assign
id|ffz
c_func
(paren
op_complement
id|pld
)paren
suffix:semicolon
id|pld
op_and_assign
id|pld
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* clear least bit set */
r_if
c_cond
(paren
id|i
op_eq
l_int|7
)paren
id|isa_device_interrupt
c_func
(paren
id|vector
comma
id|regs
)paren
suffix:semicolon
r_else
id|handle_irq
c_func
(paren
l_int|16
op_plus
id|i
comma
id|regs
)paren
suffix:semicolon
)brace
)brace
r_void
id|__init
DECL|function|init_pyxis_irqs
id|init_pyxis_irqs
c_func
(paren
r_int
r_int
id|ignore_mask
)paren
(brace
r_int
id|i
suffix:semicolon
op_star
(paren
id|vulp
)paren
id|PYXIS_INT_MASK
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* disable all */
op_star
(paren
id|vulp
)paren
id|PYXIS_INT_REQ
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* flush all */
id|mb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Send -INTA pulses to clear any pending interrupts ...*/
op_star
(paren
id|vuip
)paren
id|CIA_IACK_SC
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|16
suffix:semicolon
id|i
OL
l_int|48
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
(paren
id|ignore_mask
op_rshift
id|i
)paren
op_amp
l_int|1
)paren
r_continue
suffix:semicolon
id|irq_desc
(braket
id|i
)braket
dot
id|status
op_assign
id|IRQ_DISABLED
op_or
id|IRQ_LEVEL
suffix:semicolon
id|irq_desc
(braket
id|i
)braket
dot
id|handler
op_assign
op_amp
id|pyxis_irq_type
suffix:semicolon
)brace
id|setup_irq
c_func
(paren
l_int|16
op_plus
l_int|7
comma
op_amp
id|isa_cascade_irqaction
)paren
suffix:semicolon
)brace
eof
