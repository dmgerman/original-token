multiline_comment|/* started hacking from linux-2.3.30pre6/arch/i386/kernel/i8259.c */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/cache.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/delay.h&gt;
multiline_comment|/*&n; * This is the &squot;legacy&squot; 8259A Programmable Interrupt Controller,&n; * present in the majority of PC/AT boxes.&n; */
r_static
r_void
id|enable_8259A_irq
c_func
(paren
r_int
r_int
id|irq
)paren
suffix:semicolon
r_static
r_void
id|disable_8259A_irq
c_func
(paren
r_int
r_int
id|irq
)paren
suffix:semicolon
multiline_comment|/* shutdown is same as &quot;disable&quot; */
DECL|macro|end_8259A_irq
mdefine_line|#define end_8259A_irq&t;&t;enable_8259A_irq
DECL|macro|shutdown_8259A_irq
mdefine_line|#define shutdown_8259A_irq&t;disable_8259A_irq
r_static
r_void
id|mask_and_ack_8259A
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
DECL|function|startup_8259A_irq
r_static
r_int
r_int
id|startup_8259A_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|enable_8259A_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* never anything pending */
)brace
DECL|variable|i8259A_irq_type
r_static
r_struct
id|hw_interrupt_type
id|i8259A_irq_type
op_assign
(brace
l_string|&quot;XT-PIC&quot;
comma
id|startup_8259A_irq
comma
id|shutdown_8259A_irq
comma
id|enable_8259A_irq
comma
id|disable_8259A_irq
comma
id|mask_and_ack_8259A
comma
id|end_8259A_irq
)brace
suffix:semicolon
multiline_comment|/*&n; * 8259A PIC functions to handle ISA devices:&n; */
multiline_comment|/*&n; * This contains the irq mask for both 8259A irq controllers,&n; */
DECL|variable|cached_irq_mask
r_static
r_int
r_int
id|cached_irq_mask
op_assign
l_int|0xffff
suffix:semicolon
DECL|macro|__byte
mdefine_line|#define __byte(x,y) &t;(((unsigned char *)&amp;(y))[x])
DECL|macro|cached_21
mdefine_line|#define cached_21&t;(__byte(0,cached_irq_mask))
DECL|macro|cached_A1
mdefine_line|#define cached_A1&t;(__byte(1,cached_irq_mask))
multiline_comment|/*&n; * These have to be protected by the irq controller spinlock&n; * before being called.&n; */
DECL|function|disable_8259A_irq
r_static
r_void
id|disable_8259A_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
r_int
id|mask
op_assign
l_int|1
op_lshift
id|irq
suffix:semicolon
id|cached_irq_mask
op_or_assign
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|irq
op_amp
l_int|8
)paren
id|outb
c_func
(paren
id|cached_A1
comma
l_int|0xA1
)paren
suffix:semicolon
r_else
id|outb
c_func
(paren
id|cached_21
comma
l_int|0x21
)paren
suffix:semicolon
)brace
DECL|function|enable_8259A_irq
r_static
r_void
id|enable_8259A_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
r_int
id|mask
op_assign
op_complement
(paren
l_int|1
op_lshift
id|irq
)paren
suffix:semicolon
id|cached_irq_mask
op_and_assign
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|irq
op_amp
l_int|8
)paren
id|outb
c_func
(paren
id|cached_A1
comma
l_int|0xA1
)paren
suffix:semicolon
r_else
id|outb
c_func
(paren
id|cached_21
comma
l_int|0x21
)paren
suffix:semicolon
)brace
DECL|function|mask_and_ack_8259A
r_static
r_void
id|mask_and_ack_8259A
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|disable_8259A_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
multiline_comment|/* Ack the interrupt making it the lowest priority */
multiline_comment|/*  First the slave .. */
r_if
c_cond
(paren
id|irq
OG
l_int|7
)paren
(brace
id|outb
c_func
(paren
l_int|0xE0
op_or
(paren
id|irq
op_minus
l_int|8
)paren
comma
l_int|0xa0
)paren
suffix:semicolon
id|irq
op_assign
l_int|2
suffix:semicolon
)brace
multiline_comment|/* .. then the master */
id|outb
c_func
(paren
l_int|0xE0
op_or
id|irq
comma
l_int|0x20
)paren
suffix:semicolon
)brace
DECL|function|init_8259A
r_static
r_void
id|init_8259A
c_func
(paren
r_void
)paren
(brace
id|outb
c_func
(paren
l_int|0xff
comma
l_int|0x21
)paren
suffix:semicolon
multiline_comment|/* mask all of 8259A-1 */
id|outb
c_func
(paren
l_int|0xff
comma
l_int|0xA1
)paren
suffix:semicolon
multiline_comment|/* mask all of 8259A-2 */
)brace
multiline_comment|/*&n; * IRQ2 is cascade interrupt to second interrupt controller&n; */
DECL|variable|irq2
r_static
r_struct
id|irqaction
id|irq2
op_assign
(brace
id|no_action
comma
l_int|0
comma
l_int|0
comma
l_string|&quot;cascade&quot;
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
r_void
id|__init
DECL|function|init_ISA_irqs
id|init_ISA_irqs
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_IRQS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
id|RTC_IRQ
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
l_int|16
)paren
r_break
suffix:semicolon
id|irq_desc
(braket
id|i
)braket
dot
id|status
op_assign
id|IRQ_DISABLED
suffix:semicolon
multiline_comment|/*&n;&t;&t; * 16 old-style INTA-cycle interrupts:&n;&t;&t; */
id|irq_desc
(braket
id|i
)braket
dot
id|handler
op_assign
op_amp
id|i8259A_irq_type
suffix:semicolon
)brace
id|init_8259A
c_func
(paren
)paren
suffix:semicolon
id|setup_irq
c_func
(paren
l_int|2
comma
op_amp
id|irq2
)paren
suffix:semicolon
)brace
eof
