multiline_comment|/*&n; * SMC 37C93X initialization code&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/hwrpb.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
DECL|macro|SMC_DEBUG
mdefine_line|#define SMC_DEBUG 0
macro_line|#if SMC_DEBUG
DECL|macro|DBG_DEVS
macro_line|# define DBG_DEVS(args)         printk args
macro_line|#else
DECL|macro|DBG_DEVS
macro_line|# define DBG_DEVS(args)
macro_line|#endif
DECL|macro|KB
mdefine_line|#define KB              1024
DECL|macro|MB
mdefine_line|#define MB              (1024*KB)
DECL|macro|GB
mdefine_line|#define GB              (1024*MB)
multiline_comment|/* device &quot;activate&quot; register contents */
DECL|macro|DEVICE_ON
mdefine_line|#define DEVICE_ON&t;&t;1
DECL|macro|DEVICE_OFF
mdefine_line|#define DEVICE_OFF&t;&t;0
multiline_comment|/* configuration on/off keys */
DECL|macro|CONFIG_ON_KEY
mdefine_line|#define CONFIG_ON_KEY&t;&t;0x55
DECL|macro|CONFIG_OFF_KEY
mdefine_line|#define CONFIG_OFF_KEY&t;&t;0xaa
multiline_comment|/* configuration space device definitions */
DECL|macro|FDC
mdefine_line|#define FDC&t;&t;&t;0
DECL|macro|IDE1
mdefine_line|#define IDE1&t;&t;&t;1
DECL|macro|IDE2
mdefine_line|#define IDE2&t;&t;&t;2
DECL|macro|PARP
mdefine_line|#define PARP&t;&t;&t;3
DECL|macro|SER1
mdefine_line|#define SER1&t;&t;&t;4
DECL|macro|SER2
mdefine_line|#define SER2&t;&t;&t;5
DECL|macro|RTCL
mdefine_line|#define RTCL&t;&t;&t;6
DECL|macro|KYBD
mdefine_line|#define KYBD&t;&t;&t;7
DECL|macro|AUXIO
mdefine_line|#define AUXIO&t;&t;&t;8
multiline_comment|/* Chip register offsets from base */
DECL|macro|CONFIG_CONTROL
mdefine_line|#define CONFIG_CONTROL&t;&t;0x02
DECL|macro|INDEX_ADDRESS
mdefine_line|#define INDEX_ADDRESS&t;&t;0x03
DECL|macro|LOGICAL_DEVICE_NUMBER
mdefine_line|#define LOGICAL_DEVICE_NUMBER&t;0x07
DECL|macro|DEVICE_ID
mdefine_line|#define DEVICE_ID&t;&t;0x20
DECL|macro|DEVICE_REV
mdefine_line|#define DEVICE_REV&t;&t;0x21
DECL|macro|POWER_CONTROL
mdefine_line|#define POWER_CONTROL&t;&t;0x22
DECL|macro|POWER_MGMT
mdefine_line|#define POWER_MGMT&t;&t;0x23
DECL|macro|OSC
mdefine_line|#define OSC&t;&t;&t;0x24
DECL|macro|ACTIVATE
mdefine_line|#define ACTIVATE&t;&t;0x30
DECL|macro|ADDR_HI
mdefine_line|#define ADDR_HI&t;&t;&t;0x60
DECL|macro|ADDR_LO
mdefine_line|#define ADDR_LO&t;&t;&t;0x61
DECL|macro|INTERRUPT_SEL
mdefine_line|#define INTERRUPT_SEL&t;&t;0x70
DECL|macro|INTERRUPT_SEL_2
mdefine_line|#define INTERRUPT_SEL_2&t;&t;0x72 /* KYBD/MOUS only */
DECL|macro|DMA_CHANNEL_SEL
mdefine_line|#define DMA_CHANNEL_SEL&t;&t;0x74 /* FDC/PARP only */
DECL|macro|FDD_MODE_REGISTER
mdefine_line|#define FDD_MODE_REGISTER&t;0x90
DECL|macro|FDD_OPTION_REGISTER
mdefine_line|#define FDD_OPTION_REGISTER&t;0x91
multiline_comment|/* values that we read back that are expected ... */
DECL|macro|VALID_DEVICE_ID
mdefine_line|#define VALID_DEVICE_ID&t;&t;2
multiline_comment|/* default device addresses */
DECL|macro|KYBD_INTERRUPT
mdefine_line|#define KYBD_INTERRUPT&t;&t;1
DECL|macro|MOUS_INTERRUPT
mdefine_line|#define MOUS_INTERRUPT&t;&t;12
DECL|macro|COM2_BASE
mdefine_line|#define COM2_BASE&t;&t;0x2f8
DECL|macro|COM2_INTERRUPT
mdefine_line|#define COM2_INTERRUPT&t;&t;3
DECL|macro|COM1_BASE
mdefine_line|#define COM1_BASE&t;&t;0x3f8
DECL|macro|COM1_INTERRUPT
mdefine_line|#define COM1_INTERRUPT&t;&t;4
DECL|macro|PARP_BASE
mdefine_line|#define PARP_BASE&t;&t;0x3bc
DECL|macro|PARP_INTERRUPT
mdefine_line|#define PARP_INTERRUPT&t;&t;7
DECL|function|SMCConfigState
r_static
r_int
r_int
id|__init
id|SMCConfigState
c_func
(paren
r_int
r_int
id|baseAddr
)paren
(brace
r_int
r_char
id|devId
suffix:semicolon
r_int
r_char
id|devRev
suffix:semicolon
r_int
r_int
id|configPort
suffix:semicolon
r_int
r_int
id|indexPort
suffix:semicolon
r_int
r_int
id|dataPort
suffix:semicolon
r_int
id|i
suffix:semicolon
id|configPort
op_assign
id|indexPort
op_assign
id|baseAddr
suffix:semicolon
id|dataPort
op_assign
id|configPort
op_plus
l_int|1
suffix:semicolon
DECL|macro|NUM_RETRIES
mdefine_line|#define NUM_RETRIES 5
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_RETRIES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outb
c_func
(paren
id|CONFIG_ON_KEY
comma
id|configPort
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CONFIG_ON_KEY
comma
id|configPort
)paren
suffix:semicolon
id|outb
c_func
(paren
id|DEVICE_ID
comma
id|indexPort
)paren
suffix:semicolon
id|devId
op_assign
id|inb
c_func
(paren
id|dataPort
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devId
op_eq
id|VALID_DEVICE_ID
)paren
(brace
id|outb
c_func
(paren
id|DEVICE_REV
comma
id|indexPort
)paren
suffix:semicolon
id|devRev
op_assign
id|inb
c_func
(paren
id|dataPort
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
)brace
r_return
(paren
id|i
op_ne
id|NUM_RETRIES
)paren
ques
c_cond
id|baseAddr
suffix:colon
l_int|0L
suffix:semicolon
)brace
DECL|function|SMCRunState
r_static
r_void
id|__init
id|SMCRunState
c_func
(paren
r_int
r_int
id|baseAddr
)paren
(brace
id|outb
c_func
(paren
id|CONFIG_OFF_KEY
comma
id|baseAddr
)paren
suffix:semicolon
)brace
DECL|function|SMCDetectUltraIO
r_static
r_int
r_int
id|__init
id|SMCDetectUltraIO
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|baseAddr
suffix:semicolon
id|baseAddr
op_assign
l_int|0x3F0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|baseAddr
op_assign
id|SMCConfigState
c_func
(paren
id|baseAddr
)paren
)paren
op_eq
l_int|0x3F0
)paren
(brace
r_return
id|baseAddr
suffix:semicolon
)brace
id|baseAddr
op_assign
l_int|0x370
suffix:semicolon
r_if
c_cond
(paren
(paren
id|baseAddr
op_assign
id|SMCConfigState
c_func
(paren
id|baseAddr
)paren
)paren
op_eq
l_int|0x370
)paren
(brace
r_return
id|baseAddr
suffix:semicolon
)brace
r_return
(paren
r_int
r_int
)paren
l_int|0
suffix:semicolon
)brace
DECL|function|SMCEnableDevice
r_static
r_void
id|__init
id|SMCEnableDevice
c_func
(paren
r_int
r_int
id|baseAddr
comma
r_int
r_int
id|device
comma
r_int
r_int
id|portaddr
comma
r_int
r_int
id|interrupt
)paren
(brace
r_int
r_int
id|indexPort
suffix:semicolon
r_int
r_int
id|dataPort
suffix:semicolon
id|indexPort
op_assign
id|baseAddr
suffix:semicolon
id|dataPort
op_assign
id|baseAddr
op_plus
l_int|1
suffix:semicolon
id|outb
c_func
(paren
id|LOGICAL_DEVICE_NUMBER
comma
id|indexPort
)paren
suffix:semicolon
id|outb
c_func
(paren
id|device
comma
id|dataPort
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ADDR_LO
comma
id|indexPort
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|portaddr
op_amp
l_int|0xFF
)paren
comma
id|dataPort
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ADDR_HI
comma
id|indexPort
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|portaddr
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
comma
id|dataPort
)paren
suffix:semicolon
id|outb
c_func
(paren
id|INTERRUPT_SEL
comma
id|indexPort
)paren
suffix:semicolon
id|outb
c_func
(paren
id|interrupt
comma
id|dataPort
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ACTIVATE
comma
id|indexPort
)paren
suffix:semicolon
id|outb
c_func
(paren
id|DEVICE_ON
comma
id|dataPort
)paren
suffix:semicolon
)brace
DECL|function|SMCEnableKYBD
r_static
r_void
id|__init
id|SMCEnableKYBD
c_func
(paren
r_int
r_int
id|baseAddr
)paren
(brace
r_int
r_int
id|indexPort
suffix:semicolon
r_int
r_int
id|dataPort
suffix:semicolon
id|indexPort
op_assign
id|baseAddr
suffix:semicolon
id|dataPort
op_assign
id|baseAddr
op_plus
l_int|1
suffix:semicolon
id|outb
c_func
(paren
id|LOGICAL_DEVICE_NUMBER
comma
id|indexPort
)paren
suffix:semicolon
id|outb
c_func
(paren
id|KYBD
comma
id|dataPort
)paren
suffix:semicolon
id|outb
c_func
(paren
id|INTERRUPT_SEL
comma
id|indexPort
)paren
suffix:semicolon
multiline_comment|/* Primary interrupt select */
id|outb
c_func
(paren
id|KYBD_INTERRUPT
comma
id|dataPort
)paren
suffix:semicolon
id|outb
c_func
(paren
id|INTERRUPT_SEL_2
comma
id|indexPort
)paren
suffix:semicolon
multiline_comment|/* Secondary interrupt select */
id|outb
c_func
(paren
id|MOUS_INTERRUPT
comma
id|dataPort
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ACTIVATE
comma
id|indexPort
)paren
suffix:semicolon
id|outb
c_func
(paren
id|DEVICE_ON
comma
id|dataPort
)paren
suffix:semicolon
)brace
DECL|function|SMCEnableFDC
r_static
r_void
id|__init
id|SMCEnableFDC
c_func
(paren
r_int
r_int
id|baseAddr
)paren
(brace
r_int
r_int
id|indexPort
suffix:semicolon
r_int
r_int
id|dataPort
suffix:semicolon
r_int
r_char
id|oldValue
suffix:semicolon
id|indexPort
op_assign
id|baseAddr
suffix:semicolon
id|dataPort
op_assign
id|baseAddr
op_plus
l_int|1
suffix:semicolon
id|outb
c_func
(paren
id|LOGICAL_DEVICE_NUMBER
comma
id|indexPort
)paren
suffix:semicolon
id|outb
c_func
(paren
id|FDC
comma
id|dataPort
)paren
suffix:semicolon
id|outb
c_func
(paren
id|FDD_MODE_REGISTER
comma
id|indexPort
)paren
suffix:semicolon
id|oldValue
op_assign
id|inb
c_func
(paren
id|dataPort
)paren
suffix:semicolon
id|oldValue
op_or_assign
l_int|0x0E
suffix:semicolon
multiline_comment|/* Enable burst mode */
id|outb
c_func
(paren
id|oldValue
comma
id|dataPort
)paren
suffix:semicolon
id|outb
c_func
(paren
id|INTERRUPT_SEL
comma
id|indexPort
)paren
suffix:semicolon
multiline_comment|/* Primary interrupt select */
id|outb
c_func
(paren
l_int|0x06
comma
id|dataPort
)paren
suffix:semicolon
id|outb
c_func
(paren
id|DMA_CHANNEL_SEL
comma
id|indexPort
)paren
suffix:semicolon
multiline_comment|/* DMA channel select */
id|outb
c_func
(paren
l_int|0x02
comma
id|dataPort
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ACTIVATE
comma
id|indexPort
)paren
suffix:semicolon
id|outb
c_func
(paren
id|DEVICE_ON
comma
id|dataPort
)paren
suffix:semicolon
)brace
macro_line|#if SMC_DEBUG
DECL|function|SMCReportDeviceStatus
r_static
r_void
id|__init
id|SMCReportDeviceStatus
c_func
(paren
r_int
r_int
id|baseAddr
)paren
(brace
r_int
r_int
id|indexPort
suffix:semicolon
r_int
r_int
id|dataPort
suffix:semicolon
r_int
r_char
id|currentControl
suffix:semicolon
id|indexPort
op_assign
id|baseAddr
suffix:semicolon
id|dataPort
op_assign
id|baseAddr
op_plus
l_int|1
suffix:semicolon
id|outb
c_func
(paren
id|POWER_CONTROL
comma
id|indexPort
)paren
suffix:semicolon
id|currentControl
op_assign
id|inb
c_func
(paren
id|dataPort
)paren
suffix:semicolon
id|printk
c_func
(paren
id|currentControl
op_amp
(paren
l_int|1
op_lshift
id|FDC
)paren
ques
c_cond
l_string|&quot;&bslash;t+FDC Enabled&bslash;n&quot;
suffix:colon
l_string|&quot;&bslash;t-FDC Disabled&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|currentControl
op_amp
(paren
l_int|1
op_lshift
id|IDE1
)paren
ques
c_cond
l_string|&quot;&bslash;t+IDE1 Enabled&bslash;n&quot;
suffix:colon
l_string|&quot;&bslash;t-IDE1 Disabled&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|currentControl
op_amp
(paren
l_int|1
op_lshift
id|IDE2
)paren
ques
c_cond
l_string|&quot;&bslash;t+IDE2 Enabled&bslash;n&quot;
suffix:colon
l_string|&quot;&bslash;t-IDE2 Disabled&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|currentControl
op_amp
(paren
l_int|1
op_lshift
id|PARP
)paren
ques
c_cond
l_string|&quot;&bslash;t+PARP Enabled&bslash;n&quot;
suffix:colon
l_string|&quot;&bslash;t-PARP Disabled&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|currentControl
op_amp
(paren
l_int|1
op_lshift
id|SER1
)paren
ques
c_cond
l_string|&quot;&bslash;t+SER1 Enabled&bslash;n&quot;
suffix:colon
l_string|&quot;&bslash;t-SER1 Disabled&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|currentControl
op_amp
(paren
l_int|1
op_lshift
id|SER2
)paren
ques
c_cond
l_string|&quot;&bslash;t+SER2 Enabled&bslash;n&quot;
suffix:colon
l_string|&quot;&bslash;t-SER2 Disabled&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|SMC93x_Init
r_int
id|__init
id|SMC93x_Init
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|SMCUltraBase
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|__save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|SMCUltraBase
op_assign
id|SMCDetectUltraIO
c_func
(paren
)paren
)paren
op_ne
l_int|0UL
)paren
(brace
macro_line|#if SMC_DEBUG
id|SMCReportDeviceStatus
c_func
(paren
id|SMCUltraBase
)paren
suffix:semicolon
macro_line|#endif
id|SMCEnableDevice
c_func
(paren
id|SMCUltraBase
comma
id|SER1
comma
id|COM1_BASE
comma
id|COM1_INTERRUPT
)paren
suffix:semicolon
id|DBG_DEVS
c_func
(paren
(paren
l_string|&quot;SMC FDC37C93X: SER1 done&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|SMCEnableDevice
c_func
(paren
id|SMCUltraBase
comma
id|SER2
comma
id|COM2_BASE
comma
id|COM2_INTERRUPT
)paren
suffix:semicolon
id|DBG_DEVS
c_func
(paren
(paren
l_string|&quot;SMC FDC37C93X: SER2 done&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|SMCEnableDevice
c_func
(paren
id|SMCUltraBase
comma
id|PARP
comma
id|PARP_BASE
comma
id|PARP_INTERRUPT
)paren
suffix:semicolon
id|DBG_DEVS
c_func
(paren
(paren
l_string|&quot;SMC FDC37C93X: PARP done&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* On PC164, IDE on the SMC is not enabled;&n;&t;&t;   CMD646 (PCI) on MB */
id|SMCEnableKYBD
c_func
(paren
id|SMCUltraBase
)paren
suffix:semicolon
id|DBG_DEVS
c_func
(paren
(paren
l_string|&quot;SMC FDC37C93X: KYB done&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|SMCEnableFDC
c_func
(paren
id|SMCUltraBase
)paren
suffix:semicolon
id|DBG_DEVS
c_func
(paren
(paren
l_string|&quot;SMC FDC37C93X: FDC done&bslash;n&quot;
)paren
)paren
suffix:semicolon
macro_line|#if SMC_DEBUG
id|SMCReportDeviceStatus
c_func
(paren
id|SMCUltraBase
)paren
suffix:semicolon
macro_line|#endif
id|SMCRunState
c_func
(paren
id|SMCUltraBase
)paren
suffix:semicolon
id|__restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SMC FDC37C93X Ultra I/O Controller found @ 0x%lx&bslash;n&quot;
comma
id|SMCUltraBase
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|__restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|DBG_DEVS
c_func
(paren
(paren
l_string|&quot;No SMC FDC37C93X Ultra I/O Controller found&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
eof
