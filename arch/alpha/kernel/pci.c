multiline_comment|/*&n; *&t;linux/arch/alpha/kernel/pci.c&n; *&n; * Extruded from code written by&n; *&t;Dave Rusling (david.rusling@reo.mts.dec.com)&n; *&t;David Mosberger (davidm@cs.arizona.edu)&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;asm/pci.h&gt;
macro_line|#include &lt;asm/machvec.h&gt;
macro_line|#include &quot;proto.h&quot;
macro_line|#include &quot;pci_impl.h&quot;
multiline_comment|/*&n; * Some string constants used by the various core logics. &n; */
DECL|variable|pci_io_names
r_const
r_char
op_star
r_const
id|pci_io_names
(braket
)braket
op_assign
(brace
l_string|&quot;PCI IO bus 0&quot;
comma
l_string|&quot;PCI IO bus 1&quot;
comma
l_string|&quot;PCI IO bus 2&quot;
comma
l_string|&quot;PCI IO bus 3&quot;
)brace
suffix:semicolon
DECL|variable|pci_mem_names
r_const
r_char
op_star
r_const
id|pci_mem_names
(braket
)braket
op_assign
(brace
l_string|&quot;PCI mem bus 0&quot;
comma
l_string|&quot;PCI mem bus 1&quot;
comma
l_string|&quot;PCI mem bus 2&quot;
comma
l_string|&quot;PCI mem bus 3&quot;
)brace
suffix:semicolon
DECL|variable|pci_hae0_name
r_const
r_char
id|pci_hae0_name
(braket
)braket
op_assign
l_string|&quot;HAE0&quot;
suffix:semicolon
multiline_comment|/*&n; * The PCI controler list.&n; */
DECL|variable|hose_head
DECL|variable|hose_tail
r_struct
id|pci_controler
op_star
id|hose_head
comma
op_star
op_star
id|hose_tail
op_assign
op_amp
id|hose_head
suffix:semicolon
DECL|variable|probing_hose
r_struct
id|pci_controler
op_star
id|probing_hose
suffix:semicolon
multiline_comment|/*&n; * Quirks.&n; */
r_static
r_void
id|__init
DECL|function|quirk_eisa_bridge
id|quirk_eisa_bridge
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|dev
op_member_access_from_pointer
r_class
op_assign
id|PCI_CLASS_BRIDGE_EISA
suffix:semicolon
)brace
r_static
r_void
id|__init
DECL|function|quirk_isa_bridge
id|quirk_isa_bridge
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|dev
op_member_access_from_pointer
r_class
op_assign
id|PCI_CLASS_BRIDGE_ISA
suffix:semicolon
)brace
DECL|variable|__initdata
r_struct
id|pci_fixup
id|pcibios_fixups
(braket
)braket
id|__initdata
op_assign
(brace
(brace
id|PCI_FIXUP_HEADER
comma
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82375
comma
id|quirk_eisa_bridge
)brace
comma
(brace
id|PCI_FIXUP_HEADER
comma
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82378
comma
id|quirk_isa_bridge
)brace
comma
(brace
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/* &n; * Pre-layout host-independant device initialization.&n; */
r_static
r_void
id|__init
DECL|function|pci_assign_special
id|pci_assign_special
c_func
(paren
r_void
)paren
(brace
r_struct
id|pci_dev
op_star
id|dev
suffix:semicolon
multiline_comment|/* The first three resources of the Cypress IDE controler need&n;&t;   to remain unchanged.  So allocate them as-is.  */
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
(paren
id|dev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_CONTAQ
comma
id|PCI_DEVICE_ID_CONTAQ_82C693
comma
id|dev
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|dev
op_member_access_from_pointer
r_class
op_rshift
l_int|8
)paren
op_eq
id|PCI_CLASS_STORAGE_IDE
)paren
(brace
id|pci_record_assignment
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|pci_record_assignment
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
id|pci_record_assignment
c_func
(paren
id|dev
comma
l_int|2
)paren
suffix:semicolon
)brace
)brace
)brace
r_void
id|__init
DECL|function|pcibios_init
id|pcibios_init
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|alpha_mv.init_pci
)paren
r_return
suffix:semicolon
id|alpha_mv
dot
id|init_pci
c_func
(paren
)paren
suffix:semicolon
)brace
r_char
op_star
id|__init
DECL|function|pcibios_setup
id|pcibios_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_return
id|str
suffix:semicolon
)brace
r_void
id|__init
DECL|function|pcibios_fixup_bus
id|pcibios_fixup_bus
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
)paren
(brace
multiline_comment|/* Propogate hose info into the subordinate devices.  */
r_struct
id|pci_dev
op_star
id|dev
suffix:semicolon
r_void
op_star
id|sysdata
suffix:semicolon
id|sysdata
op_assign
(paren
id|bus-&gt;parent
ques
c_cond
id|bus-&gt;parent-&gt;sysdata
suffix:colon
id|bus-&gt;sysdata
)paren
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
id|bus-&gt;devices
suffix:semicolon
id|dev
suffix:semicolon
id|dev
op_assign
id|dev-&gt;sibling
)paren
id|dev-&gt;sysdata
op_assign
id|sysdata
suffix:semicolon
)brace
r_void
id|__init
DECL|function|pcibios_base_address_update
id|pcibios_base_address_update
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|resource
)paren
(brace
r_struct
id|pci_controler
op_star
id|hose
op_assign
id|dev-&gt;sysdata
suffix:semicolon
r_struct
id|resource
op_star
id|res
op_assign
op_amp
id|dev-&gt;resource
(braket
id|resource
)braket
suffix:semicolon
r_int
r_int
id|base
comma
id|where
comma
id|size
suffix:semicolon
id|u32
id|reg
suffix:semicolon
r_if
c_cond
(paren
id|res-&gt;flags
op_amp
id|IORESOURCE_IO
)paren
id|base
op_assign
id|hose-&gt;io_space-&gt;start
suffix:semicolon
r_else
id|base
op_assign
id|hose-&gt;mem_space-&gt;start
suffix:semicolon
id|where
op_assign
id|PCI_BASE_ADDRESS_0
op_plus
(paren
id|resource
op_star
l_int|4
)paren
suffix:semicolon
id|size
op_assign
id|res-&gt;end
op_minus
id|res-&gt;start
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|dev
comma
id|where
comma
op_amp
id|reg
)paren
suffix:semicolon
id|reg
op_assign
(paren
id|reg
op_amp
id|size
)paren
op_or
(paren
(paren
(paren
id|u32
)paren
(paren
id|res-&gt;start
op_minus
id|base
)paren
)paren
op_amp
op_complement
id|size
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|dev
comma
id|where
comma
id|reg
)paren
suffix:semicolon
multiline_comment|/* ??? FIXME -- record old value for shutdown.  */
)brace
r_void
id|__init
DECL|function|pcibios_irq_update
id|pcibios_irq_update
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
id|u8
id|irq
)paren
(brace
id|pci_write_config_byte
c_func
(paren
id|dev
comma
id|PCI_INTERRUPT_LINE
comma
id|dev-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* ??? FIXME -- record old value for shutdown.  */
)brace
multiline_comment|/* Most Alphas have straight-forward swizzling needs.  */
id|u8
id|__init
DECL|function|common_swizzle
id|common_swizzle
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
id|u8
op_star
id|pinp
)paren
(brace
r_struct
id|pci_controler
op_star
id|hose
op_assign
id|dev-&gt;sysdata
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;bus-&gt;number
op_ne
id|hose-&gt;first_busno
)paren
(brace
id|u8
id|pin
op_assign
op_star
id|pinp
suffix:semicolon
r_do
(brace
id|pin
op_assign
id|bridge_swizzle
c_func
(paren
id|pin
comma
id|PCI_SLOT
c_func
(paren
id|dev-&gt;devfn
)paren
)paren
suffix:semicolon
multiline_comment|/* Move up the chain of bridges. */
id|dev
op_assign
id|dev-&gt;bus-&gt;self
suffix:semicolon
)brace
r_while
c_loop
(paren
id|dev-&gt;bus-&gt;self
)paren
suffix:semicolon
op_star
id|pinp
op_assign
id|pin
suffix:semicolon
multiline_comment|/* The slot is the slot of the last bridge. */
)brace
r_return
id|PCI_SLOT
c_func
(paren
id|dev-&gt;devfn
)paren
suffix:semicolon
)brace
r_void
id|__init
DECL|function|common_init_pci
id|common_init_pci
c_func
(paren
r_void
)paren
(brace
r_struct
id|pci_controler
op_star
id|hose
suffix:semicolon
r_struct
id|pci_bus
op_star
id|bus
suffix:semicolon
r_int
id|next_busno
suffix:semicolon
multiline_comment|/* Scan all of the recorded PCI controlers.  */
r_for
c_loop
(paren
id|next_busno
op_assign
l_int|0
comma
id|hose
op_assign
id|hose_head
suffix:semicolon
id|hose
suffix:semicolon
id|hose
op_assign
id|hose-&gt;next
)paren
(brace
id|hose-&gt;first_busno
op_assign
id|next_busno
suffix:semicolon
id|hose-&gt;last_busno
op_assign
l_int|0xff
suffix:semicolon
id|probing_hose
op_assign
id|hose
suffix:semicolon
id|bus
op_assign
id|pci_scan_bus
c_func
(paren
id|next_busno
comma
id|alpha_mv.pci_ops
comma
id|hose
)paren
suffix:semicolon
id|hose-&gt;bus
op_assign
id|bus
suffix:semicolon
id|next_busno
op_assign
id|hose-&gt;last_busno
op_assign
id|bus-&gt;subordinate
suffix:semicolon
id|next_busno
op_add_assign
l_int|1
suffix:semicolon
)brace
id|probing_hose
op_assign
l_int|NULL
suffix:semicolon
id|pci_assign_special
c_func
(paren
)paren
suffix:semicolon
id|pci_assign_unassigned
c_func
(paren
id|alpha_mv.min_io_address
comma
id|alpha_mv.min_mem_address
)paren
suffix:semicolon
id|pci_fixup_irq
c_func
(paren
id|alpha_mv.pci_swizzle
comma
id|alpha_mv.pci_map_irq
)paren
suffix:semicolon
id|pci_set_bus_ranges
c_func
(paren
)paren
suffix:semicolon
)brace
r_struct
id|pci_controler
op_star
id|__init
DECL|function|alloc_pci_controler
id|alloc_pci_controler
c_func
(paren
r_int
r_int
op_star
id|mem_start
)paren
(brace
r_int
r_int
id|start
op_assign
op_star
id|mem_start
suffix:semicolon
r_struct
id|pci_controler
op_star
id|hose
suffix:semicolon
r_if
c_cond
(paren
id|start
op_amp
l_int|31
)paren
id|start
op_assign
(paren
id|start
op_or
l_int|31
)paren
op_plus
l_int|1
suffix:semicolon
id|hose
op_assign
(paren
r_void
op_star
)paren
id|start
suffix:semicolon
id|start
op_assign
(paren
r_int
r_int
)paren
(paren
id|hose
op_plus
l_int|1
)paren
suffix:semicolon
op_star
id|mem_start
op_assign
id|start
suffix:semicolon
id|memset
c_func
(paren
id|hose
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|hose
)paren
)paren
suffix:semicolon
op_star
id|hose_tail
op_assign
id|hose
suffix:semicolon
id|hose_tail
op_assign
op_amp
id|hose-&gt;next
suffix:semicolon
r_return
id|hose
suffix:semicolon
)brace
r_struct
id|resource
op_star
id|__init
DECL|function|alloc_resource
id|alloc_resource
c_func
(paren
r_int
r_int
op_star
id|mem_start
)paren
(brace
r_int
r_int
id|start
op_assign
op_star
id|mem_start
suffix:semicolon
r_struct
id|resource
op_star
id|res
suffix:semicolon
r_if
c_cond
(paren
id|start
op_amp
l_int|31
)paren
id|start
op_assign
(paren
id|start
op_or
l_int|31
)paren
op_plus
l_int|1
suffix:semicolon
id|res
op_assign
(paren
r_void
op_star
)paren
id|start
suffix:semicolon
id|start
op_assign
(paren
r_int
r_int
)paren
(paren
id|res
op_plus
l_int|1
)paren
suffix:semicolon
op_star
id|mem_start
op_assign
id|start
suffix:semicolon
id|memset
c_func
(paren
id|res
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|res
)paren
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
eof
