multiline_comment|/*&n; * arch/alpha/boot/tools/build.c&n; *&n; * Build a bootable image from the vmlinux binary&n; */
macro_line|#include &lt;string.h&gt;
macro_line|#include &lt;stdio.h&gt;
macro_line|#include &lt;unistd.h&gt;
macro_line|#include &lt;fcntl.h&gt;
macro_line|#include &lt;linux/a.out.h&gt;
macro_line|#include &lt;asm/system.h&gt;
DECL|macro|MAXSECT
mdefine_line|#define MAXSECT 10
DECL|macro|MAXBUF
mdefine_line|#define MAXBUF 8192
DECL|variable|verbose
r_int
id|verbose
op_assign
l_int|0
suffix:semicolon
DECL|variable|pad
r_int
id|pad
op_assign
l_int|0
suffix:semicolon
DECL|variable|program
r_char
op_star
id|program
op_assign
l_string|&quot;tools/build&quot;
suffix:semicolon
DECL|variable|buffer
r_char
id|buffer
(braket
id|MAXBUF
)braket
suffix:semicolon
DECL|variable|bootblock
r_int
r_int
id|bootblock
(braket
l_int|64
)braket
suffix:semicolon
DECL|variable|fhdr
r_struct
id|filehdr
id|fhdr
suffix:semicolon
DECL|variable|ahdr
r_struct
id|aouthdr
id|ahdr
suffix:semicolon
DECL|variable|shdr
r_struct
id|scnhdr
id|shdr
(braket
id|MAXSECT
)braket
suffix:semicolon
DECL|variable|usage
r_char
op_star
id|usage
op_assign
l_string|&quot;&squot;build [-b] system &gt; secondary&squot; or &squot;build &gt; primary&squot;&quot;
suffix:semicolon
DECL|function|die
r_static
r_void
id|die
c_func
(paren
r_char
op_star
id|str
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s: %s&bslash;n&quot;
comma
id|program
comma
id|str
)paren
suffix:semicolon
m_exit
(paren
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|comp
r_static
r_int
id|comp
c_func
(paren
r_struct
id|scnhdr
op_star
id|a
comma
r_struct
id|scnhdr
op_star
id|b
)paren
(brace
r_return
id|a-&gt;s_vaddr
op_minus
id|b-&gt;s_vaddr
suffix:semicolon
)brace
DECL|function|main
r_int
id|main
c_func
(paren
r_int
id|argc
comma
r_char
op_star
op_star
id|argv
)paren
(brace
r_int
id|fd
comma
id|i
suffix:semicolon
r_int
r_int
id|tmp
comma
id|start
suffix:semicolon
r_int
r_int
id|system_start
comma
id|system_size
suffix:semicolon
r_char
op_star
id|infile
op_assign
l_int|NULL
suffix:semicolon
id|system_start
op_assign
id|START_ADDR
suffix:semicolon
id|system_size
op_assign
id|START_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|argc
)paren
(brace
id|program
op_assign
op_star
(paren
id|argv
op_increment
)paren
suffix:semicolon
id|argc
op_decrement
suffix:semicolon
)brace
r_while
c_loop
(paren
id|argc
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_star
op_star
id|argv
op_eq
l_char|&squot;-&squot;
)paren
(brace
r_while
c_loop
(paren
op_star
op_increment
op_star
id|argv
)paren
(brace
r_switch
c_cond
(paren
op_star
op_star
id|argv
)paren
(brace
r_case
l_char|&squot;b&squot;
suffix:colon
id|system_start
op_assign
id|BOOT_ADDR
suffix:semicolon
id|system_size
op_assign
id|BOOT_SIZE
suffix:semicolon
id|pad
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;v&squot;
suffix:colon
id|verbose
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|die
c_func
(paren
id|usage
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|infile
)paren
id|die
c_func
(paren
id|usage
)paren
suffix:semicolon
r_else
id|infile
op_assign
op_star
id|argv
suffix:semicolon
id|argv
op_increment
suffix:semicolon
id|argc
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|infile
)paren
(brace
id|memcpy
c_func
(paren
id|bootblock
comma
l_string|&quot;Linux Test&quot;
comma
l_int|10
)paren
suffix:semicolon
id|bootblock
(braket
l_int|60
)braket
op_assign
id|BOOT_SIZE
op_div
l_int|512
suffix:semicolon
multiline_comment|/* count */
id|bootblock
(braket
l_int|61
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* starting LBM */
id|bootblock
(braket
l_int|62
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* flags */
id|tmp
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|63
suffix:semicolon
id|i
op_increment
)paren
id|tmp
op_add_assign
id|bootblock
(braket
id|i
)braket
suffix:semicolon
id|bootblock
(braket
l_int|63
)braket
op_assign
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|write
c_func
(paren
l_int|1
comma
(paren
r_char
op_star
)paren
id|bootblock
comma
l_int|512
)paren
op_ne
l_int|512
)paren
(brace
id|perror
c_func
(paren
l_string|&quot;bbwrite&quot;
)paren
suffix:semicolon
m_exit
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
id|fd
op_assign
id|open
c_func
(paren
id|infile
comma
id|O_RDONLY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fd
OL
l_int|0
)paren
(brace
id|perror
c_func
(paren
id|infile
)paren
suffix:semicolon
m_exit
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|read
c_func
(paren
id|fd
comma
op_amp
id|fhdr
comma
r_sizeof
(paren
r_struct
id|filehdr
)paren
)paren
op_ne
r_sizeof
(paren
r_struct
id|filehdr
)paren
)paren
id|die
c_func
(paren
l_string|&quot;unable to read file header&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fhdr.f_nscns
OG
id|MAXSECT
)paren
id|die
c_func
(paren
l_string|&quot;Too many sections&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fhdr.f_opthdr
op_ne
id|AOUTHSZ
)paren
id|die
c_func
(paren
l_string|&quot;optional header doesn&squot;t look like a.out&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read
c_func
(paren
id|fd
comma
op_amp
id|ahdr
comma
r_sizeof
(paren
r_struct
id|aouthdr
)paren
)paren
op_ne
r_sizeof
(paren
r_struct
id|aouthdr
)paren
)paren
id|die
c_func
(paren
l_string|&quot;unable to read a.out header&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|fhdr.f_nscns
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|read
c_func
(paren
id|fd
comma
id|i
op_plus
id|shdr
comma
r_sizeof
(paren
r_struct
id|scnhdr
)paren
)paren
op_ne
r_sizeof
(paren
r_struct
id|scnhdr
)paren
)paren
id|die
c_func
(paren
l_string|&quot;unable to read section header&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|shdr
(braket
id|i
)braket
dot
id|s_paddr
op_ne
id|shdr
(braket
id|i
)braket
dot
id|s_vaddr
)paren
id|die
c_func
(paren
l_string|&quot;unable to handle different phys/virt addresses&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|shdr
(braket
id|i
)braket
dot
id|s_relptr
)paren
id|die
c_func
(paren
l_string|&quot;Unable to handle relocation info&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|verbose
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;section %d (%.8s):&bslash;t%lx - %lx (at %x)&bslash;n&quot;
comma
id|i
comma
id|shdr
(braket
id|i
)braket
dot
id|s_name
comma
id|shdr
(braket
id|i
)braket
dot
id|s_vaddr
comma
id|shdr
(braket
id|i
)braket
dot
id|s_vaddr
op_plus
id|shdr
(braket
id|i
)braket
dot
id|s_size
comma
id|shdr
(braket
id|i
)braket
dot
id|s_scnptr
)paren
suffix:semicolon
)brace
)brace
id|qsort
c_func
(paren
id|shdr
comma
id|fhdr.f_nscns
comma
r_sizeof
(paren
id|shdr
(braket
l_int|1
)braket
)paren
comma
id|comp
)paren
suffix:semicolon
id|start
op_assign
id|system_start
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|fhdr.f_nscns
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|size
comma
id|offset
suffix:semicolon
id|memset
c_func
(paren
id|buffer
comma
l_int|0
comma
id|MAXBUF
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|shdr
(braket
id|i
)braket
dot
id|s_name
comma
l_string|&quot;.comment&quot;
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|shdr
(braket
id|i
)braket
dot
id|s_vaddr
op_ne
id|start
)paren
id|die
c_func
(paren
l_string|&quot;Unordered or badly placed segments&quot;
)paren
suffix:semicolon
id|size
op_assign
id|shdr
(braket
id|i
)braket
dot
id|s_size
suffix:semicolon
id|start
op_add_assign
id|size
suffix:semicolon
id|offset
op_assign
id|shdr
(braket
id|i
)braket
dot
id|s_scnptr
suffix:semicolon
r_if
c_cond
(paren
id|lseek
c_func
(paren
id|fd
comma
id|offset
comma
id|SEEK_SET
)paren
op_ne
id|offset
)paren
id|die
c_func
(paren
l_string|&quot;Unable to seek in in-file&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
r_int
r_int
id|num
op_assign
id|size
suffix:semicolon
r_if
c_cond
(paren
id|num
OG
id|MAXBUF
)paren
id|num
op_assign
id|MAXBUF
suffix:semicolon
r_if
c_cond
(paren
id|offset
)paren
r_if
c_cond
(paren
id|read
c_func
(paren
id|fd
comma
id|buffer
comma
id|num
)paren
op_ne
id|num
)paren
id|die
c_func
(paren
l_string|&quot;partial read&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|write
c_func
(paren
l_int|1
comma
id|buffer
comma
id|num
)paren
op_ne
id|num
)paren
id|die
c_func
(paren
l_string|&quot;partial write&quot;
)paren
suffix:semicolon
id|size
op_sub_assign
id|num
suffix:semicolon
)brace
r_if
c_cond
(paren
id|verbose
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;section %d (%.8s):&bslash;t%lx - %lx (at %x)&bslash;n&quot;
comma
id|i
comma
id|shdr
(braket
id|i
)braket
dot
id|s_name
comma
id|shdr
(braket
id|i
)braket
dot
id|s_vaddr
comma
id|shdr
(braket
id|i
)braket
dot
id|s_vaddr
op_plus
id|shdr
(braket
id|i
)braket
dot
id|s_size
comma
id|shdr
(braket
id|i
)braket
dot
id|s_scnptr
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|start
OG
id|system_start
op_plus
id|system_size
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Boot image too large&bslash;n&quot;
)paren
suffix:semicolon
m_exit
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pad
)paren
(brace
r_int
r_int
id|count
op_assign
(paren
id|system_start
op_plus
id|system_size
)paren
op_minus
id|start
suffix:semicolon
id|memset
c_func
(paren
id|buffer
comma
l_int|0
comma
id|MAXBUF
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
r_int
id|i
op_assign
id|MAXBUF
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
id|count
)paren
id|i
op_assign
id|count
suffix:semicolon
id|i
op_assign
id|write
c_func
(paren
l_int|1
comma
id|buffer
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_le
l_int|0
)paren
(brace
id|perror
c_func
(paren
l_string|&quot;pad write&quot;
)paren
suffix:semicolon
m_exit
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|count
op_sub_assign
id|i
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
eof
