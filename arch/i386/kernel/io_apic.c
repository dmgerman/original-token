multiline_comment|/*&n; *&t;Intel IO-APIC support for multi-pentium hosts.&n; *&n; *&t;Copyright (C) 1997, 1998 Ingo Molnar, Hajnalka Szabo&n; *&n; *&t;Many thanks to Stig Venaas for trying out countless experimental&n; *&t;patches and reporting/debugging problems patiently!&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/kernel_stat.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/mc146818rtc.h&gt;
macro_line|#include &lt;asm/i82489.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/smp.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;irq.h&quot;
multiline_comment|/*&n; * volatile is justified in this case, it might change&n; * spontaneously, GCC should not cache it&n; */
DECL|macro|IO_APIC_BASE
mdefine_line|#define IO_APIC_BASE ((volatile int *)0xfec00000)
DECL|enum|mp_irq_source_types
r_enum
id|mp_irq_source_types
(brace
DECL|enumerator|mp_INT
id|mp_INT
op_assign
l_int|0
comma
DECL|enumerator|mp_NMI
id|mp_NMI
op_assign
l_int|1
comma
DECL|enumerator|mp_SMI
id|mp_SMI
op_assign
l_int|2
comma
DECL|enumerator|mp_ExtINT
id|mp_ExtINT
op_assign
l_int|3
)brace
suffix:semicolon
DECL|enum|ioapic_irq_destination_types
r_enum
id|ioapic_irq_destination_types
(brace
DECL|enumerator|dest_Fixed
id|dest_Fixed
op_assign
l_int|0
comma
DECL|enumerator|dest_LowestPrio
id|dest_LowestPrio
op_assign
l_int|1
comma
DECL|enumerator|dest_ExtINT
id|dest_ExtINT
op_assign
l_int|7
)brace
suffix:semicolon
multiline_comment|/*&n; * The structure of the IO-APIC:&n; */
DECL|struct|IO_APIC_reg_00
r_struct
id|IO_APIC_reg_00
(brace
DECL|member|__reserved_2
id|__u32
id|__reserved_2
suffix:colon
l_int|24
comma
DECL|member|ID
id|ID
suffix:colon
l_int|4
comma
DECL|member|__reserved_1
id|__reserved_1
suffix:colon
l_int|4
suffix:semicolon
)brace
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|struct|IO_APIC_reg_01
r_struct
id|IO_APIC_reg_01
(brace
DECL|member|version
id|__u32
id|version
suffix:colon
l_int|8
comma
DECL|member|__reserved_2
id|__reserved_2
suffix:colon
l_int|8
comma
DECL|member|entries
id|entries
suffix:colon
l_int|8
comma
DECL|member|__reserved_1
id|__reserved_1
suffix:colon
l_int|8
suffix:semicolon
)brace
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|struct|IO_APIC_reg_02
r_struct
id|IO_APIC_reg_02
(brace
DECL|member|__reserved_2
id|__u32
id|__reserved_2
suffix:colon
l_int|24
comma
DECL|member|arbitration
id|arbitration
suffix:colon
l_int|4
comma
DECL|member|__reserved_1
id|__reserved_1
suffix:colon
l_int|4
suffix:semicolon
)brace
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|struct|IO_APIC_route_entry
r_struct
id|IO_APIC_route_entry
(brace
DECL|member|vector
id|__u32
id|vector
suffix:colon
l_int|8
comma
DECL|member|delivery_mode
id|delivery_mode
suffix:colon
l_int|3
comma
multiline_comment|/* 000: FIXED&n;&t;&t;&t;&t;&t; * 001: lowest prio&n;&t;&t;&t;&t;&t; * 111: ExtINT&n;&t;&t;&t;&t;&t; */
DECL|member|dest_mode
id|dest_mode
suffix:colon
l_int|1
comma
multiline_comment|/* 0: physical, 1: logical */
DECL|member|delivery_status
id|delivery_status
suffix:colon
l_int|1
comma
DECL|member|polarity
id|polarity
suffix:colon
l_int|1
comma
DECL|member|irr
id|irr
suffix:colon
l_int|1
comma
DECL|member|trigger
id|trigger
suffix:colon
l_int|1
comma
multiline_comment|/* 0: edge, 1: level */
DECL|member|mask
id|mask
suffix:colon
l_int|1
comma
multiline_comment|/* 0: enabled, 1: disabled */
DECL|member|__reserved_2
id|__reserved_2
suffix:colon
l_int|15
suffix:semicolon
r_union
(brace
r_struct
(brace
id|__u32
DECL|member|__reserved_1
id|__reserved_1
suffix:colon
l_int|24
comma
DECL|member|physical_dest
id|physical_dest
suffix:colon
l_int|4
comma
DECL|member|__reserved_2
id|__reserved_2
suffix:colon
l_int|4
suffix:semicolon
DECL|member|physical
)brace
id|physical
suffix:semicolon
r_struct
(brace
id|__u32
DECL|member|__reserved_1
id|__reserved_1
suffix:colon
l_int|24
comma
DECL|member|logical_dest
id|logical_dest
suffix:colon
l_int|8
suffix:semicolon
DECL|member|logical
)brace
id|logical
suffix:semicolon
DECL|member|dest
)brace
id|dest
suffix:semicolon
)brace
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|macro|UNEXPECTED_IO_APIC
mdefine_line|#define UNEXPECTED_IO_APIC()&t;&t;&t;&t;&t;&t;&bslash;&n;&t;{&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;printk(&quot; WARNING: unexpected IO-APIC, please mail&bslash;n&quot;);&t;&bslash;&n;&t;&t;printk(&quot;          to linux-smp@vger.rutgers.edu&bslash;n&quot;);&t;&bslash;&n;&t;}
DECL|variable|nr_ioapic_registers
r_int
id|nr_ioapic_registers
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* # of IRQ routing registers */
DECL|variable|mp_irq_entries
r_int
id|mp_irq_entries
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* # of MP IRQ source entries */
DECL|variable|mp_irqs
r_struct
id|mpc_config_intsrc
id|mp_irqs
(braket
id|MAX_IRQ_SOURCES
)braket
suffix:semicolon
multiline_comment|/* MP IRQ source entries */
DECL|variable|mpc_default_type
r_int
id|mpc_default_type
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* non-0 if default (table-less)&n;&t;&t;&t;&t;&t;&t;   MP configuration */
multiline_comment|/*&n; * This is performance-critical, we want to do it O(1)&n; */
DECL|variable|irq_2_pin
r_static
r_int
id|irq_2_pin
(braket
id|NR_IRQS
)braket
suffix:semicolon
DECL|function|io_apic_read
r_int
r_int
id|io_apic_read
(paren
r_int
r_int
id|reg
)paren
(brace
op_star
id|IO_APIC_BASE
op_assign
id|reg
suffix:semicolon
r_return
op_star
(paren
id|IO_APIC_BASE
op_plus
l_int|4
)paren
suffix:semicolon
)brace
DECL|function|io_apic_write
r_void
id|io_apic_write
(paren
r_int
r_int
id|reg
comma
r_int
r_int
id|value
)paren
(brace
op_star
id|IO_APIC_BASE
op_assign
id|reg
suffix:semicolon
op_star
(paren
id|IO_APIC_BASE
op_plus
l_int|4
)paren
op_assign
id|value
suffix:semicolon
)brace
multiline_comment|/*&n; * We disable IO-APIC IRQs by setting their &squot;destination CPU mask&squot; to&n; * zero. Trick, trick.&n; */
DECL|function|disable_IO_APIC_irq
r_void
id|disable_IO_APIC_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
id|pin
op_assign
id|irq_2_pin
(braket
id|irq
)braket
suffix:semicolon
r_struct
id|IO_APIC_route_entry
id|entry
suffix:semicolon
r_if
c_cond
(paren
id|pin
op_ne
op_minus
l_int|1
)paren
(brace
op_star
(paren
(paren
(paren
r_int
op_star
)paren
op_amp
id|entry
)paren
op_plus
l_int|1
)paren
op_assign
id|io_apic_read
c_func
(paren
l_int|0x11
op_plus
id|pin
op_star
l_int|2
)paren
suffix:semicolon
id|entry.dest.logical.logical_dest
op_assign
l_int|0x0
suffix:semicolon
id|io_apic_write
c_func
(paren
l_int|0x11
op_plus
l_int|2
op_star
id|pin
comma
op_star
(paren
(paren
(paren
r_int
op_star
)paren
op_amp
id|entry
)paren
op_plus
l_int|1
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|enable_IO_APIC_irq
r_void
id|enable_IO_APIC_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
id|pin
op_assign
id|irq_2_pin
(braket
id|irq
)braket
suffix:semicolon
r_struct
id|IO_APIC_route_entry
id|entry
suffix:semicolon
r_if
c_cond
(paren
id|pin
op_ne
op_minus
l_int|1
)paren
(brace
op_star
(paren
(paren
(paren
r_int
op_star
)paren
op_amp
id|entry
)paren
op_plus
l_int|1
)paren
op_assign
id|io_apic_read
c_func
(paren
l_int|0x11
op_plus
id|pin
op_star
l_int|2
)paren
suffix:semicolon
id|entry.dest.logical.logical_dest
op_assign
l_int|0xff
suffix:semicolon
id|io_apic_write
c_func
(paren
l_int|0x11
op_plus
l_int|2
op_star
id|pin
comma
op_star
(paren
(paren
(paren
r_int
op_star
)paren
op_amp
id|entry
)paren
op_plus
l_int|1
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|mask_IO_APIC_irq
r_void
id|mask_IO_APIC_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
id|pin
op_assign
id|irq_2_pin
(braket
id|irq
)braket
suffix:semicolon
r_struct
id|IO_APIC_route_entry
id|entry
suffix:semicolon
r_if
c_cond
(paren
id|pin
op_ne
op_minus
l_int|1
)paren
(brace
op_star
(paren
(paren
(paren
r_int
op_star
)paren
op_amp
id|entry
)paren
op_plus
l_int|0
)paren
op_assign
id|io_apic_read
c_func
(paren
l_int|0x10
op_plus
id|pin
op_star
l_int|2
)paren
suffix:semicolon
id|entry.mask
op_assign
l_int|1
suffix:semicolon
id|io_apic_write
c_func
(paren
l_int|0x10
op_plus
l_int|2
op_star
id|pin
comma
op_star
(paren
(paren
(paren
r_int
op_star
)paren
op_amp
id|entry
)paren
op_plus
l_int|0
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|unmask_IO_APIC_irq
r_void
id|unmask_IO_APIC_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
id|pin
op_assign
id|irq_2_pin
(braket
id|irq
)braket
suffix:semicolon
r_struct
id|IO_APIC_route_entry
id|entry
suffix:semicolon
r_if
c_cond
(paren
id|pin
op_ne
op_minus
l_int|1
)paren
(brace
op_star
(paren
(paren
(paren
r_int
op_star
)paren
op_amp
id|entry
)paren
op_plus
l_int|0
)paren
op_assign
id|io_apic_read
c_func
(paren
l_int|0x10
op_plus
id|pin
op_star
l_int|2
)paren
suffix:semicolon
id|entry.mask
op_assign
l_int|0
suffix:semicolon
id|io_apic_write
c_func
(paren
l_int|0x10
op_plus
l_int|2
op_star
id|pin
comma
op_star
(paren
(paren
(paren
r_int
op_star
)paren
op_amp
id|entry
)paren
op_plus
l_int|0
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|clear_IO_APIC_pin
r_void
id|clear_IO_APIC_pin
(paren
r_int
r_int
id|pin
)paren
(brace
r_struct
id|IO_APIC_route_entry
id|entry
suffix:semicolon
multiline_comment|/*&n;&t; * Disable it in the IO-APIC irq-routing table:&n;&t; */
id|memset
c_func
(paren
op_amp
id|entry
comma
l_int|0
comma
r_sizeof
(paren
id|entry
)paren
)paren
suffix:semicolon
id|entry.mask
op_assign
l_int|1
suffix:semicolon
id|io_apic_write
c_func
(paren
l_int|0x10
op_plus
l_int|2
op_star
id|pin
comma
op_star
(paren
(paren
(paren
r_int
op_star
)paren
op_amp
id|entry
)paren
op_plus
l_int|0
)paren
)paren
suffix:semicolon
id|io_apic_write
c_func
(paren
l_int|0x11
op_plus
l_int|2
op_star
id|pin
comma
op_star
(paren
(paren
(paren
r_int
op_star
)paren
op_amp
id|entry
)paren
op_plus
l_int|1
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * support for broken MP BIOSes, enables hand-redirection of PIRQ0-7 to&n; * specific CPU-side IRQs.&n; */
DECL|macro|MAX_PIRQS
mdefine_line|#define MAX_PIRQS 8
DECL|variable|pirq_entries
r_int
id|pirq_entries
(braket
id|MAX_PIRQS
)braket
suffix:semicolon
DECL|variable|pirqs_enabled
r_int
id|pirqs_enabled
suffix:semicolon
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|ioapic_pirq_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
)paren
(brace
r_int
id|i
comma
id|max
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_PIRQS
suffix:semicolon
id|i
op_increment
)paren
id|pirq_entries
(braket
id|i
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ints
)paren
(brace
id|pirqs_enabled
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PIRQ redirection SETUP, trusting MP-BIOS.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|pirqs_enabled
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PIRQ redirection SETUP, working around broken MP-BIOS.&bslash;n&quot;
)paren
suffix:semicolon
id|max
op_assign
id|MAX_PIRQS
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
OL
id|MAX_PIRQS
)paren
id|max
op_assign
id|ints
(braket
l_int|0
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|max
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;... PIRQ%d -&gt; IRQ %d&bslash;n&quot;
comma
id|i
comma
id|ints
(braket
id|i
op_plus
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * PIRQs are mapped upside down, usually.&n;&t;&t;&t; */
id|pirq_entries
(braket
id|MAX_PIRQS
op_minus
id|i
op_minus
l_int|1
)braket
op_assign
id|ints
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * Find the irq entry nr of a certain pin.&n; */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_int
id|find_irq_entry
c_func
(paren
r_int
id|pin
comma
r_int
id|type
)paren
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|mp_irq_entries
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
id|mp_irqs
(braket
id|i
)braket
dot
id|mpc_irqtype
op_eq
id|type
)paren
op_logical_and
(paren
id|mp_irqs
(braket
id|i
)braket
dot
id|mpc_dstirq
op_eq
id|pin
)paren
)paren
r_return
id|i
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Find the pin to which IRQ0 (ISA) is connected&n; */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|find_timer_pin
(paren
r_int
id|type
)paren
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|mp_irq_entries
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|lbus
op_assign
id|mp_irqs
(braket
id|i
)braket
dot
id|mpc_srcbus
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mp_bus_id_to_type
(braket
id|lbus
)braket
op_eq
id|MP_BUS_ISA
)paren
op_logical_and
(paren
id|mp_irqs
(braket
id|i
)braket
dot
id|mpc_irqtype
op_eq
id|type
)paren
op_logical_and
(paren
id|mp_irqs
(braket
id|i
)braket
dot
id|mpc_srcbusirq
op_eq
l_int|0x00
)paren
)paren
r_return
id|mp_irqs
(braket
id|i
)braket
dot
id|mpc_dstirq
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Find a specific PCI IRQ entry.&n; * Not an initfunc, possibly needed by modules&n; */
DECL|function|IO_APIC_get_PCI_irq_vector
r_int
id|IO_APIC_get_PCI_irq_vector
(paren
r_int
id|bus
comma
r_int
id|slot
comma
r_int
id|pci_pin
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|mp_irq_entries
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|lbus
op_assign
id|mp_irqs
(braket
id|i
)braket
dot
id|mpc_srcbus
suffix:semicolon
r_if
c_cond
(paren
id|IO_APIC_IRQ
c_func
(paren
id|mp_irqs
(braket
id|i
)braket
dot
id|mpc_dstirq
)paren
op_logical_and
(paren
id|mp_bus_id_to_type
(braket
id|lbus
)braket
op_eq
id|MP_BUS_PCI
)paren
op_logical_and
op_logical_neg
id|mp_irqs
(braket
id|i
)braket
dot
id|mpc_irqtype
op_logical_and
(paren
id|bus
op_eq
id|mp_bus_id_to_pci_bus
(braket
id|mp_irqs
(braket
id|i
)braket
dot
id|mpc_srcbus
)braket
)paren
op_logical_and
(paren
id|slot
op_eq
(paren
(paren
id|mp_irqs
(braket
id|i
)braket
dot
id|mpc_srcbusirq
op_rshift
l_int|2
)paren
op_amp
l_int|0x1f
)paren
)paren
op_logical_and
(paren
id|pci_pin
op_eq
(paren
id|mp_irqs
(braket
id|i
)braket
dot
id|mpc_srcbusirq
op_amp
l_int|3
)paren
)paren
)paren
r_return
id|mp_irqs
(braket
id|i
)braket
dot
id|mpc_dstirq
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * There are broken mptables which register ISA+high-active+level IRQs,&n; * these are illegal and are converted here to ISA+high-active+edge&n; * IRQ sources. Careful, ISA+low-active+level is another broken entry&n; * type, it represents PCI IRQs &squot;embedded into an ISA bus&squot;, they have&n; * to be accepted. Yes, ugh.&n; */
DECL|function|MPBIOS_polarity
r_static
r_int
id|MPBIOS_polarity
c_func
(paren
r_int
id|idx
)paren
(brace
r_int
id|bus
op_assign
id|mp_irqs
(braket
id|idx
)braket
dot
id|mpc_srcbus
suffix:semicolon
r_int
id|polarity
suffix:semicolon
multiline_comment|/*&n;&t; * Determine IRQ line polarity (high active or low active):&n;&t; */
r_switch
c_cond
(paren
id|mp_irqs
(braket
id|idx
)braket
dot
id|mpc_irqflag
op_amp
l_int|3
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* conforms, ie. bus-type dependent polarity */
(brace
r_switch
c_cond
(paren
id|mp_bus_id_to_type
(braket
id|bus
)braket
)paren
(brace
r_case
id|MP_BUS_ISA
suffix:colon
multiline_comment|/* ISA pin */
(brace
id|polarity
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|MP_BUS_PCI
suffix:colon
multiline_comment|/* PCI pin */
(brace
id|polarity
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
(brace
)brace
(brace
id|printk
c_func
(paren
l_string|&quot;broken BIOS!!&bslash;n&quot;
)paren
suffix:semicolon
id|polarity
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
)brace
r_case
l_int|1
suffix:colon
multiline_comment|/* high active */
(brace
id|polarity
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|2
suffix:colon
multiline_comment|/* reserved */
(brace
id|printk
c_func
(paren
l_string|&quot;broken BIOS!!&bslash;n&quot;
)paren
suffix:semicolon
id|polarity
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|3
suffix:colon
multiline_comment|/* low active */
(brace
id|polarity
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
(brace
)brace
multiline_comment|/* invalid */
(brace
id|printk
c_func
(paren
l_string|&quot;broken BIOS!!&bslash;n&quot;
)paren
suffix:semicolon
id|polarity
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|polarity
suffix:semicolon
)brace
DECL|function|MPBIOS_trigger
r_static
r_int
id|MPBIOS_trigger
c_func
(paren
r_int
id|idx
)paren
(brace
r_int
id|bus
op_assign
id|mp_irqs
(braket
id|idx
)braket
dot
id|mpc_srcbus
suffix:semicolon
r_int
id|trigger
suffix:semicolon
multiline_comment|/*&n;&t; * Determine IRQ trigger mode (edge or level sensitive):&n;&t; */
r_switch
c_cond
(paren
(paren
id|mp_irqs
(braket
id|idx
)braket
dot
id|mpc_irqflag
op_rshift
l_int|2
)paren
op_amp
l_int|3
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* conforms, ie. bus-type dependent */
(brace
r_switch
c_cond
(paren
id|mp_bus_id_to_type
(braket
id|bus
)braket
)paren
(brace
r_case
id|MP_BUS_ISA
suffix:colon
multiline_comment|/* ISA pin, edge */
(brace
id|trigger
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|MP_BUS_PCI
suffix:colon
multiline_comment|/* PCI pin, level */
(brace
id|trigger
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
(brace
)brace
(brace
id|printk
c_func
(paren
l_string|&quot;broken BIOS!!&bslash;n&quot;
)paren
suffix:semicolon
id|trigger
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
)brace
r_case
l_int|1
suffix:colon
multiline_comment|/* edge */
(brace
id|trigger
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|2
suffix:colon
multiline_comment|/* reserved */
(brace
id|printk
c_func
(paren
l_string|&quot;broken BIOS!!&bslash;n&quot;
)paren
suffix:semicolon
id|trigger
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|3
suffix:colon
multiline_comment|/* level */
(brace
id|trigger
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
(brace
)brace
multiline_comment|/* invalid */
(brace
id|printk
c_func
(paren
l_string|&quot;broken BIOS!!&bslash;n&quot;
)paren
suffix:semicolon
id|trigger
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|trigger
suffix:semicolon
)brace
DECL|function|trigger_flag_broken
r_static
r_int
id|trigger_flag_broken
(paren
r_int
id|idx
)paren
(brace
r_int
id|bus
op_assign
id|mp_irqs
(braket
id|idx
)braket
dot
id|mpc_srcbus
suffix:semicolon
r_int
id|polarity
op_assign
id|MPBIOS_polarity
c_func
(paren
id|idx
)paren
suffix:semicolon
r_int
id|trigger
op_assign
id|MPBIOS_trigger
c_func
(paren
id|idx
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mp_bus_id_to_type
(braket
id|bus
)braket
op_eq
id|MP_BUS_ISA
)paren
op_logical_and
(paren
id|polarity
op_eq
l_int|0
)paren
multiline_comment|/* active-high */
op_logical_and
(paren
id|trigger
op_eq
l_int|1
)paren
multiline_comment|/* level */
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* broken */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|irq_polarity
r_static
r_int
id|irq_polarity
(paren
r_int
id|idx
)paren
(brace
multiline_comment|/*&n;&t; * There are no known BIOS bugs wrt polarity.                yet.&n;&t; */
r_return
id|MPBIOS_polarity
c_func
(paren
id|idx
)paren
suffix:semicolon
)brace
DECL|function|irq_trigger
r_static
r_int
id|irq_trigger
(paren
r_int
id|idx
)paren
(brace
r_int
id|trigger
op_assign
id|MPBIOS_trigger
c_func
(paren
id|idx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|trigger_flag_broken
(paren
id|idx
)paren
)paren
id|trigger
op_assign
l_int|0
suffix:semicolon
r_return
id|trigger
suffix:semicolon
)brace
DECL|function|pin_2_irq
r_static
r_int
id|pin_2_irq
(paren
r_int
id|idx
comma
r_int
id|pin
)paren
(brace
r_int
id|irq
suffix:semicolon
r_int
id|bus
op_assign
id|mp_irqs
(braket
id|idx
)braket
dot
id|mpc_srcbus
suffix:semicolon
multiline_comment|/*&n;&t; * Debugging check, we are in big trouble if this message pops up!&n;&t; */
r_if
c_cond
(paren
id|mp_irqs
(braket
id|idx
)braket
dot
id|mpc_dstirq
op_ne
id|pin
)paren
id|printk
c_func
(paren
l_string|&quot;broken BIOS or MPTABLE parser, ayiee!!&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|mp_bus_id_to_type
(braket
id|bus
)braket
)paren
(brace
r_case
id|MP_BUS_ISA
suffix:colon
multiline_comment|/* ISA pin */
(brace
id|irq
op_assign
id|mp_irqs
(braket
id|idx
)braket
dot
id|mpc_srcbusirq
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|MP_BUS_PCI
suffix:colon
multiline_comment|/* PCI pin */
(brace
multiline_comment|/*&n;&t;&t;&t; * PCI IRQs are &squot;directly mapped&squot;&n;&t;&t;&t; */
id|irq
op_assign
id|pin
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
(brace
)brace
(brace
id|printk
c_func
(paren
l_string|&quot;unknown bus type %d.&bslash;n&quot;
comma
id|bus
)paren
suffix:semicolon
id|irq
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * PCI IRQ command line redirection. Yes, limits are hardcoded.&n;&t; */
r_if
c_cond
(paren
(paren
id|pin
op_ge
l_int|16
)paren
op_logical_and
(paren
id|pin
op_le
l_int|23
)paren
)paren
(brace
r_if
c_cond
(paren
id|pirq_entries
(braket
id|pin
op_minus
l_int|16
)braket
op_ne
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pirq_entries
(braket
id|pin
op_minus
l_int|16
)braket
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;disabling PIRQ%d&bslash;n&quot;
comma
id|pin
op_minus
l_int|16
)paren
suffix:semicolon
)brace
r_else
(brace
id|irq
op_assign
id|pirq_entries
(braket
id|pin
op_minus
l_int|16
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;using PIRQ%d -&gt; IRQ %d&bslash;n&quot;
comma
id|pin
op_minus
l_int|16
comma
id|irq
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
id|irq
suffix:semicolon
)brace
DECL|function|IO_APIC_irq_trigger
r_int
id|IO_APIC_irq_trigger
(paren
r_int
id|irq
)paren
(brace
r_int
id|idx
comma
id|pin
suffix:semicolon
r_for
c_loop
(paren
id|pin
op_assign
l_int|0
suffix:semicolon
id|pin
OL
id|nr_ioapic_registers
suffix:semicolon
id|pin
op_increment
)paren
(brace
id|idx
op_assign
id|find_irq_entry
c_func
(paren
id|pin
comma
id|mp_INT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|idx
op_ne
op_minus
l_int|1
)paren
op_logical_and
(paren
id|irq
op_eq
id|pin_2_irq
c_func
(paren
id|idx
comma
id|pin
)paren
)paren
)paren
r_return
(paren
id|irq_trigger
c_func
(paren
id|idx
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * nonexistant IRQs are edge default&n;&t; */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|setup_IO_APIC_irqs
(paren
r_void
)paren
)paren
(brace
r_struct
id|IO_APIC_route_entry
id|entry
suffix:semicolon
r_int
id|pin
comma
id|idx
comma
id|bus
comma
id|irq
comma
id|first_notcon
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;init IO_APIC IRQs&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|pin
op_assign
l_int|0
suffix:semicolon
id|pin
OL
id|nr_ioapic_registers
suffix:semicolon
id|pin
op_increment
)paren
(brace
multiline_comment|/*&n;&t;&t; * add it to the IO-APIC irq-routing table:&n;&t;&t; */
id|memset
c_func
(paren
op_amp
id|entry
comma
l_int|0
comma
r_sizeof
(paren
id|entry
)paren
)paren
suffix:semicolon
id|entry.delivery_mode
op_assign
id|dest_LowestPrio
suffix:semicolon
id|entry.dest_mode
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* logical delivery */
id|entry.mask
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* enable IRQ */
id|entry.dest.logical.logical_dest
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* all CPUs */
id|idx
op_assign
id|find_irq_entry
c_func
(paren
id|pin
comma
id|mp_INT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idx
op_eq
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|first_notcon
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; IO-APIC pin %d&quot;
comma
id|pin
)paren
suffix:semicolon
id|first_notcon
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;, %d&quot;
comma
id|pin
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|entry.trigger
op_assign
id|irq_trigger
c_func
(paren
id|idx
)paren
suffix:semicolon
id|entry.polarity
op_assign
id|irq_polarity
c_func
(paren
id|idx
)paren
suffix:semicolon
id|irq
op_assign
id|pin_2_irq
c_func
(paren
id|idx
comma
id|pin
)paren
suffix:semicolon
id|irq_2_pin
(braket
id|irq
)braket
op_assign
id|pin
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IO_APIC_IRQ
c_func
(paren
id|irq
)paren
)paren
r_continue
suffix:semicolon
id|entry.vector
op_assign
id|IO_APIC_VECTOR
c_func
(paren
id|irq
)paren
suffix:semicolon
id|bus
op_assign
id|mp_irqs
(braket
id|idx
)braket
dot
id|mpc_srcbus
suffix:semicolon
r_if
c_cond
(paren
id|trigger_flag_broken
(paren
id|idx
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;broken BIOS, changing pin %d to edge&bslash;n&quot;
comma
id|pin
)paren
suffix:semicolon
id|io_apic_write
c_func
(paren
l_int|0x10
op_plus
l_int|2
op_star
id|pin
comma
op_star
(paren
(paren
(paren
r_int
op_star
)paren
op_amp
id|entry
)paren
op_plus
l_int|0
)paren
)paren
suffix:semicolon
id|io_apic_write
c_func
(paren
l_int|0x11
op_plus
l_int|2
op_star
id|pin
comma
op_star
(paren
(paren
(paren
r_int
op_star
)paren
op_amp
id|entry
)paren
op_plus
l_int|1
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|first_notcon
)paren
id|printk
c_func
(paren
l_string|&quot; not connected.&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|setup_IO_APIC_irq_ISA_default
(paren
r_int
r_int
id|irq
)paren
)paren
(brace
r_struct
id|IO_APIC_route_entry
id|entry
suffix:semicolon
multiline_comment|/*&n;&t; * add it to the IO-APIC irq-routing table:&n;&t; */
id|memset
c_func
(paren
op_amp
id|entry
comma
l_int|0
comma
r_sizeof
(paren
id|entry
)paren
)paren
suffix:semicolon
id|entry.delivery_mode
op_assign
id|dest_LowestPrio
suffix:semicolon
multiline_comment|/* lowest prio */
id|entry.dest_mode
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* logical delivery */
id|entry.mask
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* unmask IRQ now */
id|entry.dest.logical.logical_dest
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* all CPUs */
id|entry.vector
op_assign
id|IO_APIC_VECTOR
c_func
(paren
id|irq
)paren
suffix:semicolon
id|entry.polarity
op_assign
l_int|0
suffix:semicolon
id|entry.trigger
op_assign
l_int|0
suffix:semicolon
id|io_apic_write
c_func
(paren
l_int|0x10
op_plus
l_int|2
op_star
id|irq
comma
op_star
(paren
(paren
(paren
r_int
op_star
)paren
op_amp
id|entry
)paren
op_plus
l_int|0
)paren
)paren
suffix:semicolon
id|io_apic_write
c_func
(paren
l_int|0x11
op_plus
l_int|2
op_star
id|irq
comma
op_star
(paren
(paren
(paren
r_int
op_star
)paren
op_amp
id|entry
)paren
op_plus
l_int|1
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Set up a certain pin as ExtINT delivered interrupt&n; */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|setup_ExtINT_pin
(paren
r_int
r_int
id|pin
)paren
)paren
(brace
r_struct
id|IO_APIC_route_entry
id|entry
suffix:semicolon
multiline_comment|/*&n;&t; * add it to the IO-APIC irq-routing table:&n;&t; */
id|memset
c_func
(paren
op_amp
id|entry
comma
l_int|0
comma
r_sizeof
(paren
id|entry
)paren
)paren
suffix:semicolon
id|entry.delivery_mode
op_assign
id|dest_ExtINT
suffix:semicolon
id|entry.dest_mode
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* logical delivery */
id|entry.mask
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* unmask IRQ now */
id|entry.dest.logical.logical_dest
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* all CPUs */
id|entry.vector
op_assign
id|IO_APIC_VECTOR
c_func
(paren
id|pin
)paren
suffix:semicolon
multiline_comment|/* it&squot;s ignored */
id|entry.polarity
op_assign
l_int|0
suffix:semicolon
id|entry.trigger
op_assign
l_int|0
suffix:semicolon
id|io_apic_write
c_func
(paren
l_int|0x10
op_plus
l_int|2
op_star
id|pin
comma
op_star
(paren
(paren
(paren
r_int
op_star
)paren
op_amp
id|entry
)paren
op_plus
l_int|0
)paren
)paren
suffix:semicolon
id|io_apic_write
c_func
(paren
l_int|0x11
op_plus
l_int|2
op_star
id|pin
comma
op_star
(paren
(paren
(paren
r_int
op_star
)paren
op_amp
id|entry
)paren
op_plus
l_int|1
)paren
)paren
suffix:semicolon
)brace
DECL|function|print_IO_APIC
r_void
id|print_IO_APIC
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|IO_APIC_reg_00
id|reg_00
suffix:semicolon
r_struct
id|IO_APIC_reg_01
id|reg_01
suffix:semicolon
r_struct
id|IO_APIC_reg_02
id|reg_02
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;nr of MP irq sources: %d.&bslash;n&quot;
comma
id|mp_irq_entries
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;nr of IO-APIC registers: %d.&bslash;n&quot;
comma
id|nr_ioapic_registers
)paren
suffix:semicolon
op_star
(paren
r_int
op_star
)paren
op_amp
id|reg_00
op_assign
id|io_apic_read
c_func
(paren
l_int|0
)paren
suffix:semicolon
op_star
(paren
r_int
op_star
)paren
op_amp
id|reg_01
op_assign
id|io_apic_read
c_func
(paren
l_int|1
)paren
suffix:semicolon
op_star
(paren
r_int
op_star
)paren
op_amp
id|reg_02
op_assign
id|io_apic_read
c_func
(paren
l_int|2
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We are a bit conservative about what we expect, we have to&n;&t; * know about every HW change ASAP ...&n;&t; */
id|printk
c_func
(paren
l_string|&quot;testing the IO APIC.......................&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;.... register #00: %08X&bslash;n&quot;
comma
op_star
(paren
r_int
op_star
)paren
op_amp
id|reg_00
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;.......    : physical APIC id: %02X&bslash;n&quot;
comma
id|reg_00.ID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg_00.__reserved_1
op_logical_or
id|reg_00.__reserved_2
)paren
id|UNEXPECTED_IO_APIC
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;.... register #01: %08X&bslash;n&quot;
comma
op_star
(paren
r_int
op_star
)paren
op_amp
id|reg_01
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;.......     : max redirection entries: %04X&bslash;n&quot;
comma
id|reg_01.entries
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|reg_01.entries
op_ne
l_int|0x0f
)paren
op_logical_and
multiline_comment|/* ISA-only Neptune boards */
(paren
id|reg_01.entries
op_ne
l_int|0x17
)paren
multiline_comment|/* ISA+PCI boards */
)paren
id|UNEXPECTED_IO_APIC
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg_01.entries
op_eq
l_int|0x0f
)paren
id|printk
c_func
(paren
l_string|&quot;.......       [IO-APIC cannot route PCI PIRQ 0-3]&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;.......     : IO APIC version: %04X&bslash;n&quot;
comma
id|reg_01.version
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|reg_01.version
op_ne
l_int|0x10
)paren
op_logical_and
multiline_comment|/* oldest IO-APICs */
(paren
id|reg_01.version
op_ne
l_int|0x11
)paren
multiline_comment|/* my IO-APIC */
)paren
id|UNEXPECTED_IO_APIC
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg_01.__reserved_1
op_logical_or
id|reg_01.__reserved_2
)paren
id|UNEXPECTED_IO_APIC
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;.... register #02: %08X&bslash;n&quot;
comma
op_star
(paren
r_int
op_star
)paren
op_amp
id|reg_02
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;.......     : arbitration: %02X&bslash;n&quot;
comma
id|reg_02.arbitration
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg_02.__reserved_1
op_logical_or
id|reg_02.__reserved_2
)paren
id|UNEXPECTED_IO_APIC
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;.... IRQ redirection table:&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; NR Log Phy &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Mask Trig IRR Pol Stat Dest Deli Vect:   &bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|reg_01.entries
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|IO_APIC_route_entry
id|entry
suffix:semicolon
op_star
(paren
(paren
(paren
r_int
op_star
)paren
op_amp
id|entry
)paren
op_plus
l_int|0
)paren
op_assign
id|io_apic_read
c_func
(paren
l_int|0x10
op_plus
id|i
op_star
l_int|2
)paren
suffix:semicolon
op_star
(paren
(paren
(paren
r_int
op_star
)paren
op_amp
id|entry
)paren
op_plus
l_int|1
)paren
op_assign
id|io_apic_read
c_func
(paren
l_int|0x11
op_plus
id|i
op_star
l_int|2
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; %02x %03X %02X  &quot;
comma
id|i
comma
id|entry.dest.logical.logical_dest
comma
id|entry.dest.physical.physical_dest
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%1d    %1d    %1d   %1d   %1d    %1d    %1d    %02X&bslash;n&quot;
comma
id|entry.mask
comma
id|entry.trigger
comma
id|entry.irr
comma
id|entry.polarity
comma
id|entry.delivery_status
comma
id|entry.dest_mode
comma
id|entry.delivery_mode
comma
id|entry.vector
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;IRQ to pin mappings:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_IRQS
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%d-&gt;%d &quot;
comma
id|i
comma
id|irq_2_pin
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;.................................... done.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_void
id|init_sym_mode
(paren
r_void
)paren
)paren
(brace
r_int
id|i
comma
id|pin
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_IRQS
suffix:semicolon
id|i
op_increment
)paren
id|irq_2_pin
(braket
id|i
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pirqs_enabled
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_PIRQS
suffix:semicolon
id|i
op_increment
)paren
id|pirq_entries
(braket
id|i
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;enabling Symmetric IO mode ... &quot;
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x70
comma
l_int|0x22
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x01
comma
l_int|0x23
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;...done.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * The number of IO-APIC irq-registers (== #pins):&n;&t; */
(brace
r_struct
id|IO_APIC_reg_01
id|reg_01
suffix:semicolon
op_star
(paren
r_int
op_star
)paren
op_amp
id|reg_01
op_assign
id|io_apic_read
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|nr_ioapic_registers
op_assign
id|reg_01.entries
op_plus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Do not trust the IO-APIC being empty at bootup&n;&t; */
r_for
c_loop
(paren
id|pin
op_assign
l_int|0
suffix:semicolon
id|pin
OL
id|nr_ioapic_registers
suffix:semicolon
id|pin
op_increment
)paren
id|clear_IO_APIC_pin
(paren
id|pin
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Not an initfunc, needed by the reboot code&n; */
DECL|function|init_pic_mode
r_void
id|init_pic_mode
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;disabling Symmetric IO mode ... &quot;
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x70
comma
l_int|0x22
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x00
comma
l_int|0x23
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;...done.&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|variable|ioapic_OEM_ID
r_char
id|ioapic_OEM_ID
(braket
l_int|16
)braket
suffix:semicolon
DECL|variable|ioapic_Product_ID
r_char
id|ioapic_Product_ID
(braket
l_int|16
)braket
suffix:semicolon
DECL|struct|ioapic_list_entry
r_struct
id|ioapic_list_entry
(brace
DECL|member|oem_id
r_char
op_star
id|oem_id
suffix:semicolon
DECL|member|product_id
r_char
op_star
id|product_id
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|ioapic_whitelist
r_struct
id|ioapic_list_entry
id|ioapic_whitelist
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;INTEL   &quot;
comma
l_string|&quot;PR440FX     &quot;
)brace
comma
(brace
l_string|&quot;INTEL   &quot;
comma
l_string|&quot;82440FX     &quot;
)brace
comma
(brace
l_string|&quot;AIR     &quot;
comma
l_string|&quot;KDI         &quot;
)brace
comma
(brace
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|ioapic_blacklist
r_struct
id|ioapic_list_entry
id|ioapic_blacklist
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;OEM00000&quot;
comma
l_string|&quot;PROD00000000&quot;
)brace
comma
(brace
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_int
id|in_ioapic_list
(paren
r_struct
id|ioapic_list_entry
op_star
id|table
)paren
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
id|table-&gt;oem_id
suffix:semicolon
id|table
op_increment
)paren
r_if
c_cond
(paren
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|table-&gt;oem_id
comma
id|ioapic_OEM_ID
)paren
)paren
op_logical_and
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|table-&gt;product_id
comma
id|ioapic_Product_ID
)paren
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_int
id|ioapic_whitelisted
(paren
r_void
)paren
)paren
(brace
multiline_comment|/*&n; * Right now, whitelist everything to see whether the new parsing&n; * routines really do work for everybody..&n; */
macro_line|#if 1
r_return
l_int|1
suffix:semicolon
macro_line|#else
r_return
id|in_ioapic_list
c_func
(paren
id|ioapic_whitelist
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_int
id|ioapic_blacklisted
(paren
r_void
)paren
)paren
(brace
r_return
id|in_ioapic_list
c_func
(paren
id|ioapic_blacklist
)paren
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_void
id|setup_ioapic_id
(paren
r_void
)paren
)paren
(brace
r_struct
id|IO_APIC_reg_00
id|reg_00
suffix:semicolon
multiline_comment|/*&n;&t; * &squot;default&squot; mptable configurations mean a hardwired setup,&n;&t; * 2 CPUs, 16 APIC registers. IO-APIC ID is usually set to 0,&n;&t; * setting it to ID 2 should be fine.&n;&t; */
multiline_comment|/*&n;&t; * Sanity check, is ID 2 really free? Every APIC in the&n;&t; * system must have a unique ID or we get lots of nice&n;&t; * &squot;stuck on smp_invalidate_needed IPI wait&squot; messages.&n;&t; */
r_if
c_cond
(paren
id|cpu_present_map
op_amp
(paren
l_int|1
op_lshift
l_int|0x2
)paren
)paren
id|panic
c_func
(paren
l_string|&quot;APIC ID 2 already used&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set the ID&n;&t; */
op_star
(paren
r_int
op_star
)paren
op_amp
id|reg_00
op_assign
id|io_apic_read
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;... changing IO-APIC physical APIC ID to 2 ...&bslash;n&quot;
)paren
suffix:semicolon
id|reg_00.ID
op_assign
l_int|0x2
suffix:semicolon
id|io_apic_write
c_func
(paren
l_int|0
comma
op_star
(paren
r_int
op_star
)paren
op_amp
id|reg_00
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Sanity check&n;&t; */
op_star
(paren
r_int
op_star
)paren
op_amp
id|reg_00
op_assign
id|io_apic_read
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg_00.ID
op_ne
l_int|0x2
)paren
id|panic
c_func
(paren
l_string|&quot;could not set ID&quot;
)paren
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_void
id|construct_default_ISA_mptable
(paren
r_void
)paren
)paren
(brace
r_int
id|i
comma
id|pos
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|IO_APIC_IRQ
c_func
(paren
id|i
)paren
)paren
r_continue
suffix:semicolon
id|mp_irqs
(braket
id|pos
)braket
dot
id|mpc_irqtype
op_assign
l_int|0
suffix:semicolon
id|mp_irqs
(braket
id|pos
)braket
dot
id|mpc_irqflag
op_assign
l_int|0
suffix:semicolon
id|mp_irqs
(braket
id|pos
)braket
dot
id|mpc_srcbus
op_assign
l_int|0
suffix:semicolon
id|mp_irqs
(braket
id|pos
)braket
dot
id|mpc_srcbusirq
op_assign
id|i
suffix:semicolon
id|mp_irqs
(braket
id|pos
)braket
dot
id|mpc_dstapic
op_assign
l_int|0
suffix:semicolon
id|mp_irqs
(braket
id|pos
)braket
dot
id|mpc_dstirq
op_assign
id|i
suffix:semicolon
id|pos
op_increment
suffix:semicolon
)brace
id|mp_irq_entries
op_assign
id|pos
suffix:semicolon
id|mp_bus_id_to_type
(braket
l_int|0
)braket
op_assign
id|MP_BUS_ISA
suffix:semicolon
multiline_comment|/*&n;&t; * MP specification 1.4 defines some extra rules for default&n;&t; * configurations, fix them up here:&n;&t; */
r_switch
c_cond
(paren
id|mpc_default_type
)paren
(brace
r_case
l_int|2
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/*&n;&t;&t; * pin 2 is IRQ0:&n;&t;&t; */
id|mp_irqs
(braket
l_int|0
)braket
dot
id|mpc_dstirq
op_assign
l_int|2
suffix:semicolon
)brace
id|setup_ioapic_id
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * There is a nasty bug in some older SMP boards, their mptable lies&n; * about the timer IRQ. We do the following to work around the situation:&n; *&n; *&t;- timer IRQ defaults to IO-APIC IRQ&n; *&t;- if this function detects that timer IRQs are defunct, then we fall&n; *&t;  back to ISA timer IRQs&n; */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_int
id|timer_irq_works
(paren
r_void
)paren
)paren
(brace
r_int
r_int
id|t1
op_assign
id|jiffies
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
op_star
l_int|10000
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_minus
id|t1
OG
l_int|1
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This code may look a bit paranoid, but it&squot;s supposed to cooperate with&n; * a wide range of boards and BIOS bugs ... fortunately only the timer IRQ&n; * is so screwy. Thanks to Brian Perkins for testing/hacking this beast&n; * fanatically on his truly bugged board.&n; */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_void
id|check_timer
(paren
r_void
)paren
)paren
(brace
r_int
id|pin1
comma
id|pin2
suffix:semicolon
id|pin1
op_assign
id|find_timer_pin
(paren
id|mp_INT
)paren
suffix:semicolon
id|pin2
op_assign
id|find_timer_pin
(paren
id|mp_ExtINT
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timer_irq_works
(paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|pin1
op_ne
op_minus
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;..MP-BIOS bug: 8254 timer not connected to IO-APIC&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;..trying to set up timer as ExtINT ... &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pin2
op_ne
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;.. (found pin %d) ...&quot;
comma
id|pin2
)paren
suffix:semicolon
id|setup_ExtINT_pin
(paren
id|pin2
)paren
suffix:semicolon
id|make_8259A_irq
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|timer_irq_works
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; failed.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;..trying to set up timer as BP irq ...&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Just in case ...&n;&t;&t;&t; */
r_if
c_cond
(paren
id|pin1
op_ne
op_minus
l_int|1
)paren
id|clear_IO_APIC_pin
(paren
id|pin1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pin2
op_ne
op_minus
l_int|1
)paren
id|clear_IO_APIC_pin
(paren
id|pin2
)paren
suffix:semicolon
id|make_8259A_irq
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timer_irq_works
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; failed.&bslash;n&quot;
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;IO-APIC + timer doesnt work!&quot;
)paren
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot; works.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|setup_IO_APIC
(paren
r_void
)paren
)paren
(brace
id|init_sym_mode
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Determine the range of IRQs handled by the IO-APIC. The&n;&t; * following boards can be fully enabled:&n;&t; *&n;&t; * - whitelisted ones&n;&t; * - those which have no PCI pins connected&n;&t; * - those for which the user has specified a pirq= parameter&n;&t; */
r_if
c_cond
(paren
id|ioapic_whitelisted
c_func
(paren
)paren
op_logical_or
(paren
id|nr_ioapic_registers
op_eq
l_int|16
)paren
op_logical_or
id|pirqs_enabled
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ENABLING IO-APIC IRQs&bslash;n&quot;
)paren
suffix:semicolon
id|io_apic_irqs
op_assign
op_complement
(paren
(paren
l_int|1
op_lshift
l_int|2
)paren
op_or
(paren
l_int|1
op_lshift
l_int|13
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ioapic_blacklisted
c_func
(paren
)paren
)paren
id|printk
c_func
(paren
l_string|&quot; blacklisted board, DISABLING IO-APIC IRQs&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot; unlisted board, DISABLING IO-APIC IRQs&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; see Documentation/IO-APIC.txt to enable them&bslash;n&quot;
)paren
suffix:semicolon
id|io_apic_irqs
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * If there are no explicit mp irq entries: it&squot;s either one of the&n;&t; * default configuration types or we are broken. In both cases it&squot;s&n;&t; * fine to set up most of the low 16 IO-APIC pins to ISA defaults.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|mp_irq_entries
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;no explicit IRQ entries, using default mptable&bslash;n&quot;
)paren
suffix:semicolon
id|construct_default_ISA_mptable
c_func
(paren
)paren
suffix:semicolon
)brace
id|init_IO_APIC_traps
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set up the IO-APIC irq routing table by parsing the MP-BIOS&n;&t; * mptable:&n;&t; */
id|setup_IO_APIC_irqs
(paren
)paren
suffix:semicolon
id|check_timer
c_func
(paren
)paren
suffix:semicolon
id|print_IO_APIC
c_func
(paren
)paren
suffix:semicolon
)brace
eof
