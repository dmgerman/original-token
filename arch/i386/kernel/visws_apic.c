multiline_comment|/*&n; *&t;linux/arch/i386/kernel/visws_apic.c&n; *&n; *&t;Copyright (C) 1999 Bent Hagemark, Ingo Molnar&n; *&n; *  SGI Visual Workstation interrupt controller&n; *&n; *  The Cobalt system ASIC in the Visual Workstation contains a &quot;Cobalt&quot; APIC&n; *  which serves as the main interrupt controller in the system.  Non-legacy&n; *  hardware in the system uses this controller directly.  Legacy devices&n; *  are connected to the PIIX4 which in turn has its 8259(s) connected to&n; *  a of the Cobalt APIC entry.&n; */
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel_stat.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/timex.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/random.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/smp.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/delay.h&gt;
macro_line|#include &lt;asm/desc.h&gt;
macro_line|#include &lt;asm/cobalt.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
multiline_comment|/*&n; * This is the PIIX4-based 8259 that is wired up indirectly to Cobalt&n; * -- not the manner expected by the normal 8259 code in irq.c.&n; *&n; * there is a &squot;master&squot; physical interrupt source that gets sent to&n; * the CPU. But in the chipset there are various &squot;virtual&squot; interrupts&n; * waiting to be handled. We represent this to Linux through a &squot;master&squot;&n; * interrupt controller type, and through a special virtual interrupt-&n; * controller. Device drivers only see the virtual interrupt sources.&n; */
DECL|macro|CO_IRQ_BASE
mdefine_line|#define&t;CO_IRQ_BASE&t;0x20&t;/* This is the 0x20 in init_IRQ()! */
r_static
r_void
id|startup_piix4_master_irq
c_func
(paren
r_int
r_int
id|irq
)paren
suffix:semicolon
r_static
r_void
id|shutdown_piix4_master_irq
c_func
(paren
r_int
r_int
id|irq
)paren
suffix:semicolon
r_static
r_void
id|do_piix4_master_IRQ
c_func
(paren
r_int
r_int
id|irq
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
DECL|macro|enable_piix4_master_irq
mdefine_line|#define enable_piix4_master_irq startup_piix4_master_irq
DECL|macro|disable_piix4_master_irq
mdefine_line|#define disable_piix4_master_irq shutdown_piix4_master_irq
DECL|variable|piix4_master_irq_type
r_static
r_struct
id|hw_interrupt_type
id|piix4_master_irq_type
op_assign
(brace
l_string|&quot;PIIX4-master&quot;
comma
id|startup_piix4_master_irq
comma
id|shutdown_piix4_master_irq
comma
id|do_piix4_master_IRQ
comma
id|enable_piix4_master_irq
comma
id|disable_piix4_master_irq
)brace
suffix:semicolon
r_static
r_void
id|enable_piix4_virtual_irq
c_func
(paren
r_int
r_int
id|irq
)paren
suffix:semicolon
r_static
r_void
id|disable_piix4_virtual_irq
c_func
(paren
r_int
r_int
id|irq
)paren
suffix:semicolon
DECL|macro|startup_piix4_virtual_irq
mdefine_line|#define startup_piix4_virtual_irq enable_piix4_virtual_irq
DECL|macro|shutdown_piix4_virtual_irq
mdefine_line|#define shutdown_piix4_virtual_irq disable_piix4_virtual_irq
DECL|variable|piix4_virtual_irq_type
r_static
r_struct
id|hw_interrupt_type
id|piix4_virtual_irq_type
op_assign
(brace
l_string|&quot;PIIX4-virtual&quot;
comma
id|startup_piix4_virtual_irq
comma
id|shutdown_piix4_virtual_irq
comma
l_int|0
comma
multiline_comment|/* no handler, it&squot;s never called physically */
id|enable_piix4_virtual_irq
comma
id|disable_piix4_virtual_irq
)brace
suffix:semicolon
multiline_comment|/*&n; * This is the SGI Cobalt (IO-)APIC:&n; */
r_static
r_void
id|do_cobalt_IRQ
c_func
(paren
r_int
r_int
id|irq
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|enable_cobalt_irq
c_func
(paren
r_int
r_int
id|irq
)paren
suffix:semicolon
r_static
r_void
id|disable_cobalt_irq
c_func
(paren
r_int
r_int
id|irq
)paren
suffix:semicolon
r_static
r_void
id|startup_cobalt_irq
c_func
(paren
r_int
r_int
id|irq
)paren
suffix:semicolon
DECL|macro|shutdown_cobalt_irq
mdefine_line|#define shutdown_cobalt_irq disable_cobalt_irq
DECL|variable|irq_controller_lock
r_static
id|spinlock_t
id|irq_controller_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|cobalt_irq_type
r_static
r_struct
id|hw_interrupt_type
id|cobalt_irq_type
op_assign
(brace
l_string|&quot;Cobalt-APIC&quot;
comma
id|startup_cobalt_irq
comma
id|shutdown_cobalt_irq
comma
id|do_cobalt_IRQ
comma
id|enable_cobalt_irq
comma
id|disable_cobalt_irq
)brace
suffix:semicolon
multiline_comment|/*&n; * Not an __init, needed by the reboot code&n; */
DECL|function|disable_IO_APIC
r_void
id|disable_IO_APIC
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Nop on Cobalt */
)brace
multiline_comment|/*&n; * Cobalt (IO)-APIC functions to handle PCI devices.&n; */
DECL|function|disable_cobalt_irq
r_static
r_void
id|disable_cobalt_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
multiline_comment|/* XXX undo the APIC entry here? */
multiline_comment|/*&n;&t; * definitely, we do not want to have IRQ storms from&n;&t; * unused devices --mingo&n;&t; */
)brace
DECL|function|enable_cobalt_irq
r_static
r_void
id|enable_cobalt_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
)brace
multiline_comment|/*&n; * Set the given Cobalt APIC Redirection Table entry to point&n; * to the given IDT vector/index.&n; */
DECL|function|co_apic_set
r_static
r_void
id|co_apic_set
c_func
(paren
r_int
id|entry
comma
r_int
id|idtvec
)paren
(brace
id|co_apic_write
c_func
(paren
id|CO_APIC_LO
c_func
(paren
id|entry
)paren
comma
id|CO_APIC_LEVEL
op_or
(paren
id|CO_IRQ_BASE
op_plus
id|idtvec
)paren
)paren
suffix:semicolon
id|co_apic_write
c_func
(paren
id|CO_APIC_HI
c_func
(paren
id|entry
)paren
comma
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Cobalt APIC Entry %d IDT Vector %d&bslash;n&quot;
comma
id|entry
comma
id|idtvec
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * &quot;irq&quot; really just serves to identify the device.  Here is where we&n; * map this to the Cobalt APIC entry where it&squot;s physically wired.&n; * This is called via request_irq -&gt; setup_x86_irq -&gt; irq_desc-&gt;startup()&n; */
DECL|function|startup_cobalt_irq
r_static
r_void
id|startup_cobalt_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
multiline_comment|/*&n;&t; * These &quot;irq&quot;&squot;s are wired to the same Cobalt APIC entries&n;&t; * for all (known) motherboard types/revs&n;&t; */
r_switch
c_cond
(paren
id|irq
)paren
(brace
r_case
id|CO_IRQ_TIMER
suffix:colon
id|co_apic_set
c_func
(paren
id|CO_APIC_CPU
comma
id|CO_IRQ_TIMER
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|CO_IRQ_ENET
suffix:colon
id|co_apic_set
c_func
(paren
id|CO_APIC_ENET
comma
id|CO_IRQ_ENET
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|CO_IRQ_SERIAL
suffix:colon
r_return
suffix:semicolon
multiline_comment|/* XXX move to piix4-8259 &quot;virtual&quot; */
r_case
id|CO_IRQ_8259
suffix:colon
id|co_apic_set
c_func
(paren
id|CO_APIC_8259
comma
id|CO_IRQ_8259
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|CO_IRQ_IDE
suffix:colon
r_switch
c_cond
(paren
id|visws_board_type
)paren
(brace
r_case
id|VISWS_320
suffix:colon
r_switch
c_cond
(paren
id|visws_board_rev
)paren
(brace
r_case
l_int|5
suffix:colon
id|co_apic_set
c_func
(paren
id|CO_APIC_0_5_IDE0
comma
id|CO_IRQ_IDE
)paren
suffix:semicolon
id|co_apic_set
c_func
(paren
id|CO_APIC_0_5_IDE1
comma
id|CO_IRQ_IDE
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|6
suffix:colon
id|co_apic_set
c_func
(paren
id|CO_APIC_0_6_IDE0
comma
id|CO_IRQ_IDE
)paren
suffix:semicolon
id|co_apic_set
c_func
(paren
id|CO_APIC_0_6_IDE1
comma
id|CO_IRQ_IDE
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_case
id|VISWS_540
suffix:colon
r_switch
c_cond
(paren
id|visws_board_rev
)paren
(brace
r_case
l_int|2
suffix:colon
id|co_apic_set
c_func
(paren
id|CO_APIC_1_2_IDE0
comma
id|CO_IRQ_IDE
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|panic
c_func
(paren
l_string|&quot;huh?&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * This is the handle() op in do_IRQ()&n; */
DECL|function|do_cobalt_IRQ
r_static
r_void
id|do_cobalt_IRQ
c_func
(paren
r_int
r_int
id|irq
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|irqaction
op_star
id|action
suffix:semicolon
id|irq_desc_t
op_star
id|desc
op_assign
id|irq_desc
op_plus
id|irq
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|irq_controller_lock
)paren
suffix:semicolon
(brace
r_int
r_int
id|status
suffix:semicolon
multiline_comment|/* XXX APIC EOI? */
id|status
op_assign
id|desc-&gt;status
op_amp
op_complement
(paren
id|IRQ_REPLAY
op_or
id|IRQ_WAITING
)paren
suffix:semicolon
id|action
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
(paren
id|IRQ_DISABLED
op_or
id|IRQ_INPROGRESS
)paren
)paren
)paren
(brace
id|action
op_assign
id|desc-&gt;action
suffix:semicolon
id|status
op_or_assign
id|IRQ_INPROGRESS
suffix:semicolon
)brace
id|desc-&gt;status
op_assign
id|status
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|irq_controller_lock
)paren
suffix:semicolon
multiline_comment|/* Exit early if we had no action or it was disabled */
r_if
c_cond
(paren
op_logical_neg
id|action
)paren
r_return
suffix:semicolon
id|handle_IRQ_event
c_func
(paren
id|irq
comma
id|regs
comma
id|action
)paren
suffix:semicolon
(paren
r_void
)paren
id|co_cpu_read
c_func
(paren
id|CO_CPU_REV
)paren
suffix:semicolon
multiline_comment|/* Sync driver ack to its h/w */
id|apic_write
c_func
(paren
id|APIC_EOI
comma
id|APIC_EIO_ACK
)paren
suffix:semicolon
multiline_comment|/* Send EOI to Cobalt APIC */
id|spin_lock
c_func
(paren
op_amp
id|irq_controller_lock
)paren
suffix:semicolon
(brace
r_int
r_int
id|status
op_assign
id|desc-&gt;status
op_amp
op_complement
id|IRQ_INPROGRESS
suffix:semicolon
id|desc-&gt;status
op_assign
id|status
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|IRQ_DISABLED
)paren
)paren
id|enable_cobalt_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|irq_controller_lock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * PIIX4-8259 master/virtual functions to handle:&n; *&n; *&t;floppy&n; *&t;parallel&n; *&t;serial&n; *&t;audio (?)&n; *&n; * None of these get Cobalt APIC entries, neither do they have IDT&n; * entries. These interrupts are purely virtual and distributed from&n; * the &squot;master&squot; interrupt source: CO_IRQ_8259.&n; *&n; * When the 8259 interrupts its handler figures out which of these&n; * devices is interrupting and dispatches to it&squot;s handler.&n; *&n; * CAREFUL: devices see the &squot;virtual&squot; interrupt only. Thus disable/&n; * enable_irq gets the right irq. This &squot;master&squot; irq is never directly&n; * manipulated by any driver.&n; */
DECL|function|startup_piix4_master_irq
r_static
r_void
id|startup_piix4_master_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
multiline_comment|/* ICW1 */
id|outb
c_func
(paren
l_int|0x11
comma
l_int|0x20
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x11
comma
l_int|0xa0
)paren
suffix:semicolon
multiline_comment|/* ICW2 */
id|outb
c_func
(paren
l_int|0x08
comma
l_int|0x21
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x70
comma
l_int|0xa1
)paren
suffix:semicolon
multiline_comment|/* ICW3 */
id|outb
c_func
(paren
l_int|0x04
comma
l_int|0x21
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x02
comma
l_int|0xa1
)paren
suffix:semicolon
multiline_comment|/* ICW4 */
id|outb
c_func
(paren
l_int|0x01
comma
l_int|0x21
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x01
comma
l_int|0xa1
)paren
suffix:semicolon
multiline_comment|/* OCW1 - disable all interrupts in both 8259&squot;s */
id|outb
c_func
(paren
l_int|0xff
comma
l_int|0x21
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xff
comma
l_int|0xa1
)paren
suffix:semicolon
id|startup_cobalt_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|function|shutdown_piix4_master_irq
r_static
r_void
id|shutdown_piix4_master_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
multiline_comment|/*&n;&t; * [we skip the 8259 magic here, not strictly necessary]&n;&t; */
id|shutdown_cobalt_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|function|do_piix4_master_IRQ
r_static
r_void
id|do_piix4_master_IRQ
c_func
(paren
r_int
r_int
id|irq
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|realirq
comma
id|mask
suffix:semicolon
multiline_comment|/* Find out what&squot;s interrupting in the PIIX4 8259 */
id|spin_lock
c_func
(paren
op_amp
id|irq_controller_lock
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x0c
comma
l_int|0x20
)paren
suffix:semicolon
multiline_comment|/* OCW3 Poll command */
id|realirq
op_assign
id|inb
c_func
(paren
l_int|0x20
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|realirq
op_amp
l_int|0x80
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * Bit 7 == 0 means invalid/spurious&n;&t;&t; */
r_goto
id|out_unlock
suffix:semicolon
)brace
id|realirq
op_and_assign
l_int|0x7f
suffix:semicolon
multiline_comment|/*&n;&t; * mask and ack the 8259&n;&t; */
id|mask
op_assign
id|inb
c_func
(paren
l_int|0x21
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mask
op_rshift
id|realirq
)paren
op_amp
l_int|0x01
)paren
multiline_comment|/*&n;&t;&t; * This IRQ is masked... ignore&n;&t;&t; */
r_goto
id|out_unlock
suffix:semicolon
id|outb
c_func
(paren
id|mask
op_or
(paren
l_int|1
op_lshift
id|realirq
)paren
comma
l_int|0x21
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * OCW2 - non-specific EOI&n;&t; */
id|outb
c_func
(paren
l_int|0x20
comma
l_int|0x20
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|irq_controller_lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * handle this &squot;virtual interrupt&squot; as a Cobalt one now.&n;&t; */
id|kstat.irqs
(braket
id|smp_processor_id
c_func
(paren
)paren
)braket
(braket
id|irq
)braket
op_increment
suffix:semicolon
id|do_cobalt_IRQ
c_func
(paren
id|realirq
comma
id|regs
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|irq_controller_lock
)paren
suffix:semicolon
(brace
id|irq_desc_t
op_star
id|desc
op_assign
id|irq_desc
op_plus
id|realirq
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|desc-&gt;status
op_amp
id|IRQ_DISABLED
)paren
)paren
id|enable_piix4_virtual_irq
c_func
(paren
id|realirq
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|irq_controller_lock
)paren
suffix:semicolon
r_return
suffix:semicolon
id|out_unlock
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|irq_controller_lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|enable_piix4_virtual_irq
r_static
r_void
id|enable_piix4_virtual_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
multiline_comment|/*&n;&t; * assumes this irq is one of the legacy devices&n;&t; */
r_int
r_int
id|mask
op_assign
id|inb
c_func
(paren
l_int|0x21
)paren
suffix:semicolon
id|mask
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|irq
)paren
suffix:semicolon
id|outb
c_func
(paren
id|mask
comma
l_int|0x21
)paren
suffix:semicolon
id|enable_cobalt_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * assumes this irq is one of the legacy devices&n; */
DECL|function|disable_piix4_virtual_irq
r_static
r_void
id|disable_piix4_virtual_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
r_int
id|mask
suffix:semicolon
id|disable_cobalt_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
id|mask
op_assign
id|inb
c_func
(paren
l_int|0x21
)paren
suffix:semicolon
id|mask
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|irq
)paren
suffix:semicolon
id|outb
c_func
(paren
id|mask
comma
l_int|0x21
)paren
suffix:semicolon
)brace
DECL|variable|master_action
r_static
r_struct
id|irqaction
id|master_action
op_assign
(brace
id|no_action
comma
l_int|0
comma
l_int|0
comma
l_string|&quot;PIIX4-8259&quot;
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
DECL|function|init_VISWS_APIC_irqs
r_void
id|init_VISWS_APIC_irqs
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|irq_desc
(braket
id|i
)braket
dot
id|status
op_assign
id|IRQ_DISABLED
suffix:semicolon
id|irq_desc
(braket
id|i
)braket
dot
id|action
op_assign
l_int|0
suffix:semicolon
id|irq_desc
(braket
id|i
)braket
dot
id|depth
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Cobalt IRQs are mapped to standard ISA&n;&t;&t; * interrupt vectors:&n;&t;&t; */
r_switch
c_cond
(paren
id|i
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Only CO_IRQ_8259 will be raised&n;&t;&t;&t; * externally.&n;&t;&t;&t; */
r_case
id|CO_IRQ_8259
suffix:colon
id|irq_desc
(braket
id|i
)braket
dot
id|handler
op_assign
op_amp
id|piix4_master_irq_type
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CO_IRQ_FLOPPY
suffix:colon
r_case
id|CO_IRQ_PARLL
suffix:colon
id|irq_desc
(braket
id|i
)braket
dot
id|handler
op_assign
op_amp
id|piix4_virtual_irq_type
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|irq_desc
(braket
id|i
)braket
dot
id|handler
op_assign
op_amp
id|cobalt_irq_type
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * The master interrupt is always present:&n;&t; */
id|setup_x86_irq
c_func
(paren
id|CO_IRQ_8259
comma
op_amp
id|master_action
)paren
suffix:semicolon
)brace
eof
