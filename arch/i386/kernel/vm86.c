multiline_comment|/*&n; *  linux/kernel/vm86.c&n; *&n; *  Copyright (C) 1994  Linus Torvalds&n; */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/io.h&gt;
multiline_comment|/*&n; * Known problems:&n; *&n; * Interrupt handling is not guaranteed:&n; * - a real x86 will disable all interrupts for one instruction&n; *   after a &quot;mov ss,xx&quot; to make stack handling atomic even without&n; *   the &squot;lss&squot; instruction. We can&squot;t guarantee this in v86 mode,&n; *   as the next instruction might result in a page fault or similar.&n; * - a real x86 will have interrupts disabled for one instruction&n; *   past the &squot;sti&squot; that enables them. We don&squot;t bother with all the&n; *   details yet..&n; *&n; * Hopefully these problems do not actually matter for anything.&n; */
multiline_comment|/*&n; * 8- and 16-bit register defines..&n; */
DECL|macro|AL
mdefine_line|#define AL(regs)&t;(((unsigned char *)&amp;((regs)-&gt;eax))[0])
DECL|macro|AH
mdefine_line|#define AH(regs)&t;(((unsigned char *)&amp;((regs)-&gt;eax))[1])
DECL|macro|IP
mdefine_line|#define IP(regs)&t;(*(unsigned short *)&amp;((regs)-&gt;eip))
DECL|macro|SP
mdefine_line|#define SP(regs)&t;(*(unsigned short *)&amp;((regs)-&gt;esp))
multiline_comment|/*&n; * virtual flags (16 and 32-bit versions)&n; */
DECL|macro|VFLAGS
mdefine_line|#define VFLAGS&t;(*(unsigned short *)&amp;(current-&gt;tss.v86flags))
DECL|macro|VEFLAGS
mdefine_line|#define VEFLAGS&t;(current-&gt;tss.v86flags)
DECL|macro|set_flags
mdefine_line|#define set_flags(X,new,mask) &bslash;&n;((X) = ((X) &amp; ~(mask)) | ((new) &amp; (mask)))
DECL|macro|SAFE_MASK
mdefine_line|#define SAFE_MASK&t;(0xDD5)
DECL|macro|RETURN_MASK
mdefine_line|#define RETURN_MASK&t;(0xDFF)
DECL|function|save_v86_state
id|asmlinkage
r_struct
id|pt_regs
op_star
id|save_v86_state
c_func
(paren
r_struct
id|vm86_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|tmp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|current-&gt;tss.vm86_info
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;no vm86_info: BAD&bslash;n&quot;
)paren
suffix:semicolon
id|do_exit
c_func
(paren
id|SIGSEGV
)paren
suffix:semicolon
)brace
id|set_flags
c_func
(paren
id|regs-&gt;eflags
comma
id|VEFLAGS
comma
id|VIF_MASK
op_or
id|current-&gt;tss.v86mask
)paren
suffix:semicolon
id|memcpy_tofs
c_func
(paren
op_amp
id|current-&gt;tss.vm86_info-&gt;regs
comma
id|regs
comma
r_sizeof
(paren
op_star
id|regs
)paren
)paren
suffix:semicolon
id|put_fs_long
c_func
(paren
id|current-&gt;tss.screen_bitmap
comma
op_amp
id|current-&gt;tss.vm86_info-&gt;screen_bitmap
)paren
suffix:semicolon
id|tmp
op_assign
id|current-&gt;tss.esp0
suffix:semicolon
id|current-&gt;tss.esp0
op_assign
id|current-&gt;saved_kernel_stack
suffix:semicolon
id|current-&gt;saved_kernel_stack
op_assign
l_int|0
suffix:semicolon
r_return
(paren
r_struct
id|pt_regs
op_star
)paren
id|tmp
suffix:semicolon
)brace
DECL|function|mark_screen_rdonly
r_static
r_void
id|mark_screen_rdonly
c_func
(paren
r_struct
id|task_struct
op_star
id|tsk
)paren
(brace
id|pgd_t
op_star
id|pgd
suffix:semicolon
id|pmd_t
op_star
id|pmd
suffix:semicolon
id|pte_t
op_star
id|pte
suffix:semicolon
r_int
id|i
suffix:semicolon
id|pgd
op_assign
id|pgd_offset
c_func
(paren
id|tsk-&gt;mm
comma
l_int|0xA0000
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pgd_none
c_func
(paren
op_star
id|pgd
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|pgd_bad
c_func
(paren
op_star
id|pgd
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;vm86: bad pgd entry [%p]:%08lx&bslash;n&quot;
comma
id|pgd
comma
id|pgd_val
c_func
(paren
op_star
id|pgd
)paren
)paren
suffix:semicolon
id|pgd_clear
c_func
(paren
id|pgd
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|pmd
op_assign
id|pmd_offset
c_func
(paren
id|pgd
comma
l_int|0xA0000
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pmd_none
c_func
(paren
op_star
id|pmd
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|pmd_bad
c_func
(paren
op_star
id|pmd
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;vm86: bad pmd entry [%p]:%08lx&bslash;n&quot;
comma
id|pmd
comma
id|pmd_val
c_func
(paren
op_star
id|pmd
)paren
)paren
suffix:semicolon
id|pmd_clear
c_func
(paren
id|pmd
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|pte
op_assign
id|pte_offset
c_func
(paren
id|pmd
comma
l_int|0xA0000
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pte_present
c_func
(paren
op_star
id|pte
)paren
)paren
id|set_pte
c_func
(paren
id|pte
comma
id|pte_wrprotect
c_func
(paren
op_star
id|pte
)paren
)paren
suffix:semicolon
id|pte
op_increment
suffix:semicolon
)brace
id|flush_tlb
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|sys_vm86
id|asmlinkage
r_int
id|sys_vm86
c_func
(paren
r_struct
id|vm86_struct
op_star
id|v86
)paren
(brace
r_struct
id|vm86_struct
id|info
suffix:semicolon
r_struct
id|pt_regs
op_star
id|pt_regs
op_assign
(paren
r_struct
id|pt_regs
op_star
)paren
op_amp
id|v86
suffix:semicolon
r_int
id|error
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;saved_kernel_stack
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
multiline_comment|/* v86 must be readable (now) and writable (for save_v86_state) */
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|v86
comma
r_sizeof
(paren
op_star
id|v86
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
op_amp
id|info
comma
id|v86
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
multiline_comment|/*&n; * make sure the vm86() system call doesn&squot;t try to do anything silly&n; */
id|info.regs.__null_ds
op_assign
l_int|0
suffix:semicolon
id|info.regs.__null_es
op_assign
l_int|0
suffix:semicolon
id|info.regs.__null_fs
op_assign
l_int|0
suffix:semicolon
id|info.regs.__null_gs
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; * The eflags register is also special: we cannot trust that the user&n; * has set it up safely, so this makes sure interrupt etc flags are&n; * inherited from protected mode.&n; */
id|VEFLAGS
op_assign
id|info.regs.eflags
suffix:semicolon
id|info.regs.eflags
op_and_assign
id|SAFE_MASK
suffix:semicolon
id|info.regs.eflags
op_or_assign
id|pt_regs-&gt;eflags
op_amp
op_complement
id|SAFE_MASK
suffix:semicolon
id|info.regs.eflags
op_or_assign
id|VM_MASK
suffix:semicolon
r_switch
c_cond
(paren
id|info.cpu_type
)paren
(brace
r_case
id|CPU_286
suffix:colon
id|current-&gt;tss.v86mask
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPU_386
suffix:colon
id|current-&gt;tss.v86mask
op_assign
id|NT_MASK
op_or
id|IOPL_MASK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPU_486
suffix:colon
id|current-&gt;tss.v86mask
op_assign
id|AC_MASK
op_or
id|NT_MASK
op_or
id|IOPL_MASK
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|current-&gt;tss.v86mask
op_assign
id|ID_MASK
op_or
id|AC_MASK
op_or
id|NT_MASK
op_or
id|IOPL_MASK
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n; * Save old state, set default return value (%eax) to 0&n; */
id|pt_regs-&gt;eax
op_assign
l_int|0
suffix:semicolon
id|current-&gt;saved_kernel_stack
op_assign
id|current-&gt;tss.esp0
suffix:semicolon
id|current-&gt;tss.esp0
op_assign
(paren
r_int
r_int
)paren
id|pt_regs
suffix:semicolon
id|current-&gt;tss.vm86_info
op_assign
id|v86
suffix:semicolon
id|current-&gt;tss.screen_bitmap
op_assign
id|info.screen_bitmap
suffix:semicolon
r_if
c_cond
(paren
id|info.flags
op_amp
id|VM86_SCREEN_BITMAP
)paren
id|mark_screen_rdonly
c_func
(paren
id|current
)paren
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;movl %0,%%esp&bslash;n&bslash;t&quot;
l_string|&quot;jmp ret_from_sys_call&quot;
suffix:colon
multiline_comment|/* no outputs */
suffix:colon
l_string|&quot;r&quot;
(paren
op_amp
id|info.regs
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|return_to_32bit
r_static
r_inline
r_void
id|return_to_32bit
c_func
(paren
r_struct
id|vm86_regs
op_star
id|regs16
comma
r_int
id|retval
)paren
(brace
r_struct
id|pt_regs
op_star
id|regs32
suffix:semicolon
id|regs32
op_assign
id|save_v86_state
c_func
(paren
id|regs16
)paren
suffix:semicolon
id|regs32-&gt;eax
op_assign
id|retval
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;movl %0,%%esp&bslash;n&bslash;t&quot;
l_string|&quot;jmp ret_from_sys_call&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|regs32
)paren
)paren
suffix:semicolon
)brace
DECL|function|set_IF
r_static
r_inline
r_void
id|set_IF
c_func
(paren
r_struct
id|vm86_regs
op_star
id|regs
)paren
(brace
id|VEFLAGS
op_or_assign
id|VIF_MASK
suffix:semicolon
r_if
c_cond
(paren
id|VEFLAGS
op_amp
id|VIP_MASK
)paren
id|return_to_32bit
c_func
(paren
id|regs
comma
id|VM86_STI
)paren
suffix:semicolon
)brace
DECL|function|clear_IF
r_static
r_inline
r_void
id|clear_IF
c_func
(paren
r_struct
id|vm86_regs
op_star
id|regs
)paren
(brace
id|VEFLAGS
op_and_assign
op_complement
id|VIF_MASK
suffix:semicolon
)brace
DECL|function|clear_TF
r_static
r_inline
r_void
id|clear_TF
c_func
(paren
r_struct
id|vm86_regs
op_star
id|regs
)paren
(brace
id|regs-&gt;eflags
op_and_assign
op_complement
id|TF_MASK
suffix:semicolon
)brace
DECL|function|set_vflags_long
r_static
r_inline
r_void
id|set_vflags_long
c_func
(paren
r_int
r_int
id|eflags
comma
r_struct
id|vm86_regs
op_star
id|regs
)paren
(brace
id|set_flags
c_func
(paren
id|VEFLAGS
comma
id|eflags
comma
id|current-&gt;tss.v86mask
)paren
suffix:semicolon
id|set_flags
c_func
(paren
id|regs-&gt;eflags
comma
id|eflags
comma
id|SAFE_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eflags
op_amp
id|IF_MASK
)paren
id|set_IF
c_func
(paren
id|regs
)paren
suffix:semicolon
)brace
DECL|function|set_vflags_short
r_static
r_inline
r_void
id|set_vflags_short
c_func
(paren
r_int
r_int
id|flags
comma
r_struct
id|vm86_regs
op_star
id|regs
)paren
(brace
id|set_flags
c_func
(paren
id|VFLAGS
comma
id|flags
comma
id|current-&gt;tss.v86mask
)paren
suffix:semicolon
id|set_flags
c_func
(paren
id|regs-&gt;eflags
comma
id|flags
comma
id|SAFE_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|IF_MASK
)paren
id|set_IF
c_func
(paren
id|regs
)paren
suffix:semicolon
)brace
DECL|function|get_vflags
r_static
r_inline
r_int
r_int
id|get_vflags
c_func
(paren
r_struct
id|vm86_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|flags
op_assign
id|regs-&gt;eflags
op_amp
id|RETURN_MASK
suffix:semicolon
r_if
c_cond
(paren
id|VEFLAGS
op_amp
id|VIF_MASK
)paren
id|flags
op_or_assign
id|IF_MASK
suffix:semicolon
r_return
id|flags
op_or
(paren
id|VEFLAGS
op_amp
id|current-&gt;tss.v86mask
)paren
suffix:semicolon
)brace
DECL|function|is_revectored
r_static
r_inline
r_int
id|is_revectored
c_func
(paren
r_int
id|nr
comma
r_struct
id|revectored_struct
op_star
id|bitmap
)paren
(brace
r_if
c_cond
(paren
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|bitmap
comma
l_int|256
op_div
l_int|8
)paren
OL
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;btl %2,%%fs:%1&bslash;n&bslash;tsbbl %0,%0&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|nr
)paren
suffix:colon
l_string|&quot;m&quot;
(paren
op_star
id|bitmap
)paren
comma
l_string|&quot;r&quot;
(paren
id|nr
)paren
)paren
suffix:semicolon
r_return
id|nr
suffix:semicolon
)brace
multiline_comment|/*&n; * Boy are these ugly, but we need to do the correct 16-bit arithmetic.&n; * Gcc makes a mess of it, so we do it inline and use non-obvious calling&n; * conventions..&n; */
DECL|macro|pushb
mdefine_line|#define pushb(base, ptr, val) &bslash;&n;__asm__ __volatile__( &bslash;&n;&t;&quot;decw %w0&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;movb %2,%%fs:0(%1,%0)&quot; &bslash;&n;&t;: &quot;=r&quot; (ptr) &bslash;&n;&t;: &quot;r&quot; (base), &quot;q&quot; (val), &quot;0&quot; (ptr))
DECL|macro|pushw
mdefine_line|#define pushw(base, ptr, val) &bslash;&n;__asm__ __volatile__( &bslash;&n;&t;&quot;decw %w0&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;movb %h2,%%fs:0(%1,%0)&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;decw %w0&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;movb %b2,%%fs:0(%1,%0)&quot; &bslash;&n;&t;: &quot;=r&quot; (ptr) &bslash;&n;&t;: &quot;r&quot; (base), &quot;q&quot; (val), &quot;0&quot; (ptr))
DECL|macro|pushl
mdefine_line|#define pushl(base, ptr, val) &bslash;&n;__asm__ __volatile__( &bslash;&n;&t;&quot;decw %w0&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;rorl $16,%2&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;movb %h2,%%fs:0(%1,%0)&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;decw %w0&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;movb %b2,%%fs:0(%1,%0)&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;decw %w0&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;rorl $16,%2&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;movb %h2,%%fs:0(%1,%0)&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;decw %w0&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;movb %b2,%%fs:0(%1,%0)&quot; &bslash;&n;&t;: &quot;=r&quot; (ptr) &bslash;&n;&t;: &quot;r&quot; (base), &quot;q&quot; (val), &quot;0&quot; (ptr))
DECL|macro|popb
mdefine_line|#define popb(base, ptr) &bslash;&n;({ unsigned long __res; &bslash;&n;__asm__ __volatile__( &bslash;&n;&t;&quot;movb %%fs:0(%1,%0),%b2&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;incw %w0&quot; &bslash;&n;&t;: &quot;=r&quot; (ptr), &quot;=r&quot; (base), &quot;=q&quot; (__res) &bslash;&n;&t;: &quot;0&quot; (ptr), &quot;1&quot; (base), &quot;2&quot; (0)); &bslash;&n;__res; })
DECL|macro|popw
mdefine_line|#define popw(base, ptr) &bslash;&n;({ unsigned long __res; &bslash;&n;__asm__ __volatile__( &bslash;&n;&t;&quot;movb %%fs:0(%1,%0),%b2&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;incw %w0&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;movb %%fs:0(%1,%0),%h2&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;incw %w0&quot; &bslash;&n;&t;: &quot;=r&quot; (ptr), &quot;=r&quot; (base), &quot;=q&quot; (__res) &bslash;&n;&t;: &quot;0&quot; (ptr), &quot;1&quot; (base), &quot;2&quot; (0)); &bslash;&n;__res; })
DECL|macro|popl
mdefine_line|#define popl(base, ptr) &bslash;&n;({ unsigned long __res; &bslash;&n;__asm__ __volatile__( &bslash;&n;&t;&quot;movb %%fs:0(%1,%0),%b2&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;incw %w0&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;movb %%fs:0(%1,%0),%h2&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;incw %w0&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;rorl $16,%2&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;movb %%fs:0(%1,%0),%b2&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;incw %w0&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;movb %%fs:0(%1,%0),%h2&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;incw %w0&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;rorl $16,%2&quot; &bslash;&n;&t;: &quot;=r&quot; (ptr), &quot;=r&quot; (base), &quot;=q&quot; (__res) &bslash;&n;&t;: &quot;0&quot; (ptr), &quot;1&quot; (base)); &bslash;&n;__res; })
DECL|function|do_int
r_static
r_void
id|do_int
c_func
(paren
r_struct
id|vm86_regs
op_star
id|regs
comma
r_int
id|i
comma
r_int
r_char
op_star
id|ssp
comma
r_int
r_int
id|sp
)paren
(brace
r_int
r_int
op_star
id|intr_ptr
comma
id|seg
suffix:semicolon
r_if
c_cond
(paren
id|regs-&gt;cs
op_eq
id|BIOSSEG
)paren
r_goto
id|cannot_handle
suffix:semicolon
r_if
c_cond
(paren
id|is_revectored
c_func
(paren
id|i
comma
op_amp
id|current-&gt;tss.vm86_info-&gt;int_revectored
)paren
)paren
r_goto
id|cannot_handle
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|0x21
op_logical_and
id|is_revectored
c_func
(paren
id|AH
c_func
(paren
id|regs
)paren
comma
op_amp
id|current-&gt;tss.vm86_info-&gt;int21_revectored
)paren
)paren
r_goto
id|cannot_handle
suffix:semicolon
id|intr_ptr
op_assign
(paren
r_int
r_int
op_star
)paren
(paren
id|i
op_lshift
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|intr_ptr
comma
l_int|4
)paren
OL
l_int|0
)paren
r_goto
id|cannot_handle
suffix:semicolon
id|seg
op_assign
id|get_fs_word
c_func
(paren
id|intr_ptr
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|seg
op_eq
id|BIOSSEG
)paren
r_goto
id|cannot_handle
suffix:semicolon
id|pushw
c_func
(paren
id|ssp
comma
id|sp
comma
id|get_vflags
c_func
(paren
id|regs
)paren
)paren
suffix:semicolon
id|pushw
c_func
(paren
id|ssp
comma
id|sp
comma
id|regs-&gt;cs
)paren
suffix:semicolon
id|pushw
c_func
(paren
id|ssp
comma
id|sp
comma
id|IP
c_func
(paren
id|regs
)paren
)paren
suffix:semicolon
id|regs-&gt;cs
op_assign
id|seg
suffix:semicolon
id|SP
c_func
(paren
id|regs
)paren
op_sub_assign
l_int|6
suffix:semicolon
id|IP
c_func
(paren
id|regs
)paren
op_assign
id|get_fs_word
c_func
(paren
id|intr_ptr
op_plus
l_int|0
)paren
suffix:semicolon
id|clear_TF
c_func
(paren
id|regs
)paren
suffix:semicolon
id|clear_IF
c_func
(paren
id|regs
)paren
suffix:semicolon
r_return
suffix:semicolon
id|cannot_handle
suffix:colon
id|return_to_32bit
c_func
(paren
id|regs
comma
id|VM86_INTx
op_plus
(paren
id|i
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
)brace
DECL|function|handle_vm86_debug
r_void
id|handle_vm86_debug
c_func
(paren
r_struct
id|vm86_regs
op_star
id|regs
comma
r_int
id|error_code
)paren
(brace
macro_line|#if 0
id|do_int
c_func
(paren
id|regs
comma
l_int|1
comma
(paren
r_int
r_char
op_star
)paren
(paren
id|regs-&gt;ss
op_lshift
l_int|4
)paren
comma
id|SP
c_func
(paren
id|regs
)paren
)paren
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|current-&gt;flags
op_amp
id|PF_PTRACED
)paren
id|current-&gt;blocked
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|SIGTRAP
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|send_sig
c_func
(paren
id|SIGTRAP
comma
id|current
comma
l_int|1
)paren
suffix:semicolon
id|current-&gt;tss.trap_no
op_assign
l_int|1
suffix:semicolon
id|current-&gt;tss.error_code
op_assign
id|error_code
suffix:semicolon
macro_line|#endif
)brace
DECL|function|handle_vm86_fault
r_void
id|handle_vm86_fault
c_func
(paren
r_struct
id|vm86_regs
op_star
id|regs
comma
r_int
id|error_code
)paren
(brace
r_int
r_char
op_star
id|csp
comma
op_star
id|ssp
suffix:semicolon
r_int
r_int
id|ip
comma
id|sp
suffix:semicolon
id|csp
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|regs-&gt;cs
op_lshift
l_int|4
)paren
suffix:semicolon
id|ssp
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|regs-&gt;ss
op_lshift
l_int|4
)paren
suffix:semicolon
id|sp
op_assign
id|SP
c_func
(paren
id|regs
)paren
suffix:semicolon
id|ip
op_assign
id|IP
c_func
(paren
id|regs
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|popb
c_func
(paren
id|csp
comma
id|ip
)paren
)paren
(brace
multiline_comment|/* operand size override */
r_case
l_int|0x66
suffix:colon
r_switch
c_cond
(paren
id|popb
c_func
(paren
id|csp
comma
id|ip
)paren
)paren
(brace
multiline_comment|/* pushfd */
r_case
l_int|0x9c
suffix:colon
id|SP
c_func
(paren
id|regs
)paren
op_sub_assign
l_int|4
suffix:semicolon
id|IP
c_func
(paren
id|regs
)paren
op_add_assign
l_int|2
suffix:semicolon
id|pushl
c_func
(paren
id|ssp
comma
id|sp
comma
id|get_vflags
c_func
(paren
id|regs
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* popfd */
r_case
l_int|0x9d
suffix:colon
id|SP
c_func
(paren
id|regs
)paren
op_add_assign
l_int|4
suffix:semicolon
id|IP
c_func
(paren
id|regs
)paren
op_add_assign
l_int|2
suffix:semicolon
id|set_vflags_long
c_func
(paren
id|popl
c_func
(paren
id|ssp
comma
id|sp
)paren
comma
id|regs
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* iretd */
r_case
l_int|0xcf
suffix:colon
id|SP
c_func
(paren
id|regs
)paren
op_add_assign
l_int|12
suffix:semicolon
id|IP
c_func
(paren
id|regs
)paren
op_assign
(paren
r_int
r_int
)paren
id|popl
c_func
(paren
id|ssp
comma
id|sp
)paren
suffix:semicolon
id|regs-&gt;cs
op_assign
(paren
r_int
r_int
)paren
id|popl
c_func
(paren
id|ssp
comma
id|sp
)paren
suffix:semicolon
id|set_vflags_long
c_func
(paren
id|popl
c_func
(paren
id|ssp
comma
id|sp
)paren
comma
id|regs
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
multiline_comment|/* pushf */
r_case
l_int|0x9c
suffix:colon
id|SP
c_func
(paren
id|regs
)paren
op_sub_assign
l_int|2
suffix:semicolon
id|IP
c_func
(paren
id|regs
)paren
op_increment
suffix:semicolon
id|pushw
c_func
(paren
id|ssp
comma
id|sp
comma
id|get_vflags
c_func
(paren
id|regs
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* popf */
r_case
l_int|0x9d
suffix:colon
id|SP
c_func
(paren
id|regs
)paren
op_add_assign
l_int|2
suffix:semicolon
id|IP
c_func
(paren
id|regs
)paren
op_increment
suffix:semicolon
id|set_vflags_short
c_func
(paren
id|popw
c_func
(paren
id|ssp
comma
id|sp
)paren
comma
id|regs
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* int xx */
r_case
l_int|0xcd
suffix:colon
id|IP
c_func
(paren
id|regs
)paren
op_add_assign
l_int|2
suffix:semicolon
id|do_int
c_func
(paren
id|regs
comma
id|popb
c_func
(paren
id|csp
comma
id|ip
)paren
comma
id|ssp
comma
id|sp
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* iret */
r_case
l_int|0xcf
suffix:colon
id|SP
c_func
(paren
id|regs
)paren
op_add_assign
l_int|6
suffix:semicolon
id|IP
c_func
(paren
id|regs
)paren
op_assign
id|popw
c_func
(paren
id|ssp
comma
id|sp
)paren
suffix:semicolon
id|regs-&gt;cs
op_assign
id|popw
c_func
(paren
id|ssp
comma
id|sp
)paren
suffix:semicolon
id|set_vflags_short
c_func
(paren
id|popw
c_func
(paren
id|ssp
comma
id|sp
)paren
comma
id|regs
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* cli */
r_case
l_int|0xfa
suffix:colon
id|IP
c_func
(paren
id|regs
)paren
op_increment
suffix:semicolon
id|clear_IF
c_func
(paren
id|regs
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* sti */
multiline_comment|/*&n;&t; * Damn. This is incorrect: the &squot;sti&squot; instruction should actually&n;&t; * enable interrupts after the /next/ instruction. Not good.&n;&t; *&n;&t; * Probably needs some horsing around with the TF flag. Aiee..&n;&t; */
r_case
l_int|0xfb
suffix:colon
id|IP
c_func
(paren
id|regs
)paren
op_increment
suffix:semicolon
id|set_IF
c_func
(paren
id|regs
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * We didn&squot;t recognize it, let the emulator take care of it..&n;&t; */
id|return_to_32bit
c_func
(paren
id|regs
comma
id|VM86_UNKNOWN
)paren
suffix:semicolon
)brace
eof
