multiline_comment|/*---------------------------------------------------------------------------+&n; |  poly_atan.c                                                              |&n; |                                                                           |&n; | Compute the arctan of a FPU_REG, using a polynomial approximation.        |&n; |                                                                           |&n; | Copyright (C) 1992,1993,1994,1997                                         |&n; |                  W. Metzenthen, 22 Parker St, Ormond, Vic 3163, Australia |&n; |                  E-mail   billm@suburbia.net                              |&n; |                                                                           |&n; |                                                                           |&n; +---------------------------------------------------------------------------*/
macro_line|#include &quot;exception.h&quot;
macro_line|#include &quot;reg_constant.h&quot;
macro_line|#include &quot;fpu_emu.h&quot;
macro_line|#include &quot;fpu_system.h&quot;
macro_line|#include &quot;status_w.h&quot;
macro_line|#include &quot;control_w.h&quot;
macro_line|#include &quot;poly.h&quot;
DECL|macro|HIPOWERon
mdefine_line|#define&t;HIPOWERon&t;6&t;/* odd poly, negative terms */
DECL|variable|oddnegterms
r_static
r_const
r_int
r_int
r_int
id|oddnegterms
(braket
id|HIPOWERon
)braket
op_assign
(brace
l_int|0x0000000000000000LL
comma
multiline_comment|/* Dummy (not for - 1.0) */
l_int|0x015328437f756467LL
comma
l_int|0x0005dda27b73dec6LL
comma
l_int|0x0000226bf2bfb91aLL
comma
l_int|0x000000ccc439c5f7LL
comma
l_int|0x0000000355438407LL
)brace
suffix:semicolon
DECL|macro|HIPOWERop
mdefine_line|#define&t;HIPOWERop&t;6&t;/* odd poly, positive terms */
DECL|variable|oddplterms
r_static
r_const
r_int
r_int
r_int
id|oddplterms
(braket
id|HIPOWERop
)braket
op_assign
(brace
multiline_comment|/*  0xaaaaaaaaaaaaaaabLL,  transferred to fixedpterm[] */
l_int|0x0db55a71875c9ac2LL
comma
l_int|0x0029fce2d67880b0LL
comma
l_int|0x0000dfd3908b4596LL
comma
l_int|0x00000550fd61dab4LL
comma
l_int|0x0000001c9422b3f9LL
comma
l_int|0x000000003e3301e1LL
)brace
suffix:semicolon
DECL|variable|denomterm
r_static
r_const
r_int
r_int
r_int
id|denomterm
op_assign
l_int|0xebd9b842c5c53a0eLL
suffix:semicolon
DECL|variable|fixedpterm
r_static
r_const
id|Xsig
id|fixedpterm
op_assign
id|MK_XSIG
c_func
(paren
l_int|0xaaaaaaaa
comma
l_int|0xaaaaaaaa
comma
l_int|0xaaaaaaaa
)paren
suffix:semicolon
DECL|variable|pi_signif
r_static
r_const
id|Xsig
id|pi_signif
op_assign
id|MK_XSIG
c_func
(paren
l_int|0xc90fdaa2
comma
l_int|0x2168c234
comma
l_int|0xc4c6628b
)paren
suffix:semicolon
multiline_comment|/*--- poly_atan() -----------------------------------------------------------+&n; |                                                                           |&n; +---------------------------------------------------------------------------*/
DECL|function|poly_atan
r_void
id|poly_atan
c_func
(paren
id|FPU_REG
op_star
id|st0_ptr
comma
id|u_char
id|st0_tag
comma
id|FPU_REG
op_star
id|st1_ptr
comma
id|u_char
id|st1_tag
)paren
(brace
id|u_char
id|transformed
comma
id|inverted
comma
id|sign1
comma
id|sign2
suffix:semicolon
r_int
id|exponent
suffix:semicolon
r_int
r_int
id|dummy_exp
suffix:semicolon
id|Xsig
id|accumulator
comma
id|Numer
comma
id|Denom
comma
id|accumulatore
comma
id|argSignif
comma
id|argSq
comma
id|argSqSq
suffix:semicolon
id|u_char
id|tag
suffix:semicolon
id|sign1
op_assign
id|getsign
c_func
(paren
id|st0_ptr
)paren
suffix:semicolon
id|sign2
op_assign
id|getsign
c_func
(paren
id|st1_ptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st0_tag
op_eq
id|TAG_Valid
)paren
(brace
id|exponent
op_assign
id|exponent
c_func
(paren
id|st0_ptr
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* This gives non-compatible stack contents... */
id|FPU_to_exp16
c_func
(paren
id|st0_ptr
comma
id|st0_ptr
)paren
suffix:semicolon
id|exponent
op_assign
id|exponent16
c_func
(paren
id|st0_ptr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|st1_tag
op_eq
id|TAG_Valid
)paren
(brace
id|exponent
op_sub_assign
id|exponent
c_func
(paren
id|st1_ptr
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* This gives non-compatible stack contents... */
id|FPU_to_exp16
c_func
(paren
id|st1_ptr
comma
id|st1_ptr
)paren
suffix:semicolon
id|exponent
op_sub_assign
id|exponent16
c_func
(paren
id|st1_ptr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|exponent
OL
l_int|0
)paren
op_logical_or
(paren
(paren
id|exponent
op_eq
l_int|0
)paren
op_logical_and
(paren
(paren
id|st0_ptr-&gt;sigh
OL
id|st1_ptr-&gt;sigh
)paren
op_logical_or
(paren
(paren
id|st0_ptr-&gt;sigh
op_eq
id|st1_ptr-&gt;sigh
)paren
op_logical_and
(paren
id|st0_ptr-&gt;sigl
OL
id|st1_ptr-&gt;sigl
)paren
)paren
)paren
)paren
)paren
(brace
id|inverted
op_assign
l_int|1
suffix:semicolon
id|Numer.lsw
op_assign
id|Denom.lsw
op_assign
l_int|0
suffix:semicolon
id|XSIG_LL
c_func
(paren
id|Numer
)paren
op_assign
id|significand
c_func
(paren
id|st0_ptr
)paren
suffix:semicolon
id|XSIG_LL
c_func
(paren
id|Denom
)paren
op_assign
id|significand
c_func
(paren
id|st1_ptr
)paren
suffix:semicolon
)brace
r_else
(brace
id|inverted
op_assign
l_int|0
suffix:semicolon
id|exponent
op_assign
op_minus
id|exponent
suffix:semicolon
id|Numer.lsw
op_assign
id|Denom.lsw
op_assign
l_int|0
suffix:semicolon
id|XSIG_LL
c_func
(paren
id|Numer
)paren
op_assign
id|significand
c_func
(paren
id|st1_ptr
)paren
suffix:semicolon
id|XSIG_LL
c_func
(paren
id|Denom
)paren
op_assign
id|significand
c_func
(paren
id|st0_ptr
)paren
suffix:semicolon
)brace
id|div_Xsig
c_func
(paren
op_amp
id|Numer
comma
op_amp
id|Denom
comma
op_amp
id|argSignif
)paren
suffix:semicolon
id|exponent
op_add_assign
id|norm_Xsig
c_func
(paren
op_amp
id|argSignif
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|exponent
op_ge
op_minus
l_int|1
)paren
op_logical_or
(paren
(paren
id|exponent
op_eq
op_minus
l_int|2
)paren
op_logical_and
(paren
id|argSignif.msw
OG
l_int|0xd413ccd0
)paren
)paren
)paren
(brace
multiline_comment|/* The argument is greater than sqrt(2)-1 (=0.414213562...) */
multiline_comment|/* Convert the argument by an identity for atan */
id|transformed
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|exponent
op_ge
l_int|0
)paren
(brace
macro_line|#ifdef PARANOID
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|exponent
op_eq
l_int|0
)paren
op_logical_and
(paren
id|argSignif.lsw
op_eq
l_int|0
)paren
op_logical_and
(paren
id|argSignif.midw
op_eq
l_int|0
)paren
op_logical_and
(paren
id|argSignif.msw
op_eq
l_int|0x80000000
)paren
)paren
)paren
(brace
id|EXCEPTION
c_func
(paren
id|EX_INTERNAL
op_or
l_int|0x104
)paren
suffix:semicolon
multiline_comment|/* There must be a logic error */
r_return
suffix:semicolon
)brace
macro_line|#endif PARANOID
id|argSignif.msw
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Make the transformed arg -&gt; 0.0 */
)brace
r_else
(brace
id|Numer.lsw
op_assign
id|Denom.lsw
op_assign
id|argSignif.lsw
suffix:semicolon
id|XSIG_LL
c_func
(paren
id|Numer
)paren
op_assign
id|XSIG_LL
c_func
(paren
id|Denom
)paren
op_assign
id|XSIG_LL
c_func
(paren
id|argSignif
)paren
suffix:semicolon
r_if
c_cond
(paren
id|exponent
OL
op_minus
l_int|1
)paren
id|shr_Xsig
c_func
(paren
op_amp
id|Numer
comma
op_minus
l_int|1
op_minus
id|exponent
)paren
suffix:semicolon
id|negate_Xsig
c_func
(paren
op_amp
id|Numer
)paren
suffix:semicolon
id|shr_Xsig
c_func
(paren
op_amp
id|Denom
comma
op_minus
id|exponent
)paren
suffix:semicolon
id|Denom.msw
op_or_assign
l_int|0x80000000
suffix:semicolon
id|div_Xsig
c_func
(paren
op_amp
id|Numer
comma
op_amp
id|Denom
comma
op_amp
id|argSignif
)paren
suffix:semicolon
id|exponent
op_assign
op_minus
l_int|1
op_plus
id|norm_Xsig
c_func
(paren
op_amp
id|argSignif
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|transformed
op_assign
l_int|0
suffix:semicolon
)brace
id|argSq.lsw
op_assign
id|argSignif.lsw
suffix:semicolon
id|argSq.midw
op_assign
id|argSignif.midw
suffix:semicolon
id|argSq.msw
op_assign
id|argSignif.msw
suffix:semicolon
id|mul_Xsig_Xsig
c_func
(paren
op_amp
id|argSq
comma
op_amp
id|argSq
)paren
suffix:semicolon
id|argSqSq.lsw
op_assign
id|argSq.lsw
suffix:semicolon
id|argSqSq.midw
op_assign
id|argSq.midw
suffix:semicolon
id|argSqSq.msw
op_assign
id|argSq.msw
suffix:semicolon
id|mul_Xsig_Xsig
c_func
(paren
op_amp
id|argSqSq
comma
op_amp
id|argSqSq
)paren
suffix:semicolon
id|accumulatore.lsw
op_assign
id|argSq.lsw
suffix:semicolon
id|XSIG_LL
c_func
(paren
id|accumulatore
)paren
op_assign
id|XSIG_LL
c_func
(paren
id|argSq
)paren
suffix:semicolon
id|shr_Xsig
c_func
(paren
op_amp
id|argSq
comma
l_int|2
op_star
(paren
op_minus
l_int|1
op_minus
id|exponent
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|shr_Xsig
c_func
(paren
op_amp
id|argSqSq
comma
l_int|4
op_star
(paren
op_minus
l_int|1
op_minus
id|exponent
op_minus
l_int|1
)paren
)paren
suffix:semicolon
multiline_comment|/* Now have argSq etc with binary point at the left&n;     .1xxxxxxxx */
multiline_comment|/* Do the basic fixed point polynomial evaluation */
id|accumulator.msw
op_assign
id|accumulator.midw
op_assign
id|accumulator.lsw
op_assign
l_int|0
suffix:semicolon
id|polynomial_Xsig
c_func
(paren
op_amp
id|accumulator
comma
op_amp
id|XSIG_LL
c_func
(paren
id|argSqSq
)paren
comma
id|oddplterms
comma
id|HIPOWERop
op_minus
l_int|1
)paren
suffix:semicolon
id|mul64_Xsig
c_func
(paren
op_amp
id|accumulator
comma
op_amp
id|XSIG_LL
c_func
(paren
id|argSq
)paren
)paren
suffix:semicolon
id|negate_Xsig
c_func
(paren
op_amp
id|accumulator
)paren
suffix:semicolon
id|polynomial_Xsig
c_func
(paren
op_amp
id|accumulator
comma
op_amp
id|XSIG_LL
c_func
(paren
id|argSqSq
)paren
comma
id|oddnegterms
comma
id|HIPOWERon
op_minus
l_int|1
)paren
suffix:semicolon
id|negate_Xsig
c_func
(paren
op_amp
id|accumulator
)paren
suffix:semicolon
id|add_two_Xsig
c_func
(paren
op_amp
id|accumulator
comma
op_amp
id|fixedpterm
comma
op_amp
id|dummy_exp
)paren
suffix:semicolon
id|mul64_Xsig
c_func
(paren
op_amp
id|accumulatore
comma
op_amp
id|denomterm
)paren
suffix:semicolon
id|shr_Xsig
c_func
(paren
op_amp
id|accumulatore
comma
l_int|1
op_plus
l_int|2
op_star
(paren
op_minus
l_int|1
op_minus
id|exponent
)paren
)paren
suffix:semicolon
id|accumulatore.msw
op_or_assign
l_int|0x80000000
suffix:semicolon
id|div_Xsig
c_func
(paren
op_amp
id|accumulator
comma
op_amp
id|accumulatore
comma
op_amp
id|accumulator
)paren
suffix:semicolon
id|mul_Xsig_Xsig
c_func
(paren
op_amp
id|accumulator
comma
op_amp
id|argSignif
)paren
suffix:semicolon
id|mul_Xsig_Xsig
c_func
(paren
op_amp
id|accumulator
comma
op_amp
id|argSq
)paren
suffix:semicolon
id|shr_Xsig
c_func
(paren
op_amp
id|accumulator
comma
l_int|3
)paren
suffix:semicolon
id|negate_Xsig
c_func
(paren
op_amp
id|accumulator
)paren
suffix:semicolon
id|add_Xsig_Xsig
c_func
(paren
op_amp
id|accumulator
comma
op_amp
id|argSignif
)paren
suffix:semicolon
r_if
c_cond
(paren
id|transformed
)paren
(brace
multiline_comment|/* compute pi/4 - accumulator */
id|shr_Xsig
c_func
(paren
op_amp
id|accumulator
comma
op_minus
l_int|1
op_minus
id|exponent
)paren
suffix:semicolon
id|negate_Xsig
c_func
(paren
op_amp
id|accumulator
)paren
suffix:semicolon
id|add_Xsig_Xsig
c_func
(paren
op_amp
id|accumulator
comma
op_amp
id|pi_signif
)paren
suffix:semicolon
id|exponent
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inverted
)paren
(brace
multiline_comment|/* compute pi/2 - accumulator */
id|shr_Xsig
c_func
(paren
op_amp
id|accumulator
comma
op_minus
id|exponent
)paren
suffix:semicolon
id|negate_Xsig
c_func
(paren
op_amp
id|accumulator
)paren
suffix:semicolon
id|add_Xsig_Xsig
c_func
(paren
op_amp
id|accumulator
comma
op_amp
id|pi_signif
)paren
suffix:semicolon
id|exponent
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sign1
)paren
(brace
multiline_comment|/* compute pi - accumulator */
id|shr_Xsig
c_func
(paren
op_amp
id|accumulator
comma
l_int|1
op_minus
id|exponent
)paren
suffix:semicolon
id|negate_Xsig
c_func
(paren
op_amp
id|accumulator
)paren
suffix:semicolon
id|add_Xsig_Xsig
c_func
(paren
op_amp
id|accumulator
comma
op_amp
id|pi_signif
)paren
suffix:semicolon
id|exponent
op_assign
l_int|1
suffix:semicolon
)brace
id|exponent
op_add_assign
id|round_Xsig
c_func
(paren
op_amp
id|accumulator
)paren
suffix:semicolon
id|significand
c_func
(paren
id|st1_ptr
)paren
op_assign
id|XSIG_LL
c_func
(paren
id|accumulator
)paren
suffix:semicolon
id|setexponent16
c_func
(paren
id|st1_ptr
comma
id|exponent
)paren
suffix:semicolon
id|tag
op_assign
id|FPU_round
c_func
(paren
id|st1_ptr
comma
l_int|1
comma
l_int|0
comma
id|FULL_PRECISION
comma
id|sign2
)paren
suffix:semicolon
id|FPU_settagi
c_func
(paren
l_int|1
comma
id|tag
)paren
suffix:semicolon
id|set_precision_flag_up
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* We do not really know if up or down,&n;&t;&t;&t;       use this as the default. */
)brace
eof
