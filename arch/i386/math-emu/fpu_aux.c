multiline_comment|/*---------------------------------------------------------------------------+&n; |  fpu_aux.c                                                                |&n; |                                                                           |&n; | Code to implement some of the FPU auxiliary instructions.                 |&n; |                                                                           |&n; | Copyright (C) 1992,1993,1994,1997                                         |&n; |                  W. Metzenthen, 22 Parker St, Ormond, Vic 3163, Australia |&n; |                  E-mail   billm@suburbia.net                              |&n; |                                                                           |&n; |                                                                           |&n; +---------------------------------------------------------------------------*/
macro_line|#include &quot;fpu_system.h&quot;
macro_line|#include &quot;exception.h&quot;
macro_line|#include &quot;fpu_emu.h&quot;
macro_line|#include &quot;status_w.h&quot;
macro_line|#include &quot;control_w.h&quot;
DECL|function|fnop
r_static
r_void
id|fnop
c_func
(paren
r_void
)paren
(brace
)brace
DECL|function|fclex
r_void
id|fclex
c_func
(paren
r_void
)paren
(brace
id|partial_status
op_and_assign
op_complement
(paren
id|SW_Backward
op_or
id|SW_Summary
op_or
id|SW_Stack_Fault
op_or
id|SW_Precision
op_or
id|SW_Underflow
op_or
id|SW_Overflow
op_or
id|SW_Zero_Div
op_or
id|SW_Denorm_Op
op_or
id|SW_Invalid
)paren
suffix:semicolon
id|no_ip_update
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Needs to be externally visible */
DECL|function|finit
r_void
id|finit
c_func
(paren
)paren
(brace
id|control_word
op_assign
l_int|0x037f
suffix:semicolon
id|partial_status
op_assign
l_int|0
suffix:semicolon
id|top
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* We don&squot;t keep top in the status word internally. */
id|fpu_tag_word
op_assign
l_int|0xffff
suffix:semicolon
multiline_comment|/* The behaviour is different from that detailed in&n;     Section 15.1.6 of the Intel manual */
id|operand_address.offset
op_assign
l_int|0
suffix:semicolon
id|operand_address.selector
op_assign
l_int|0
suffix:semicolon
id|instruction_address.offset
op_assign
l_int|0
suffix:semicolon
id|instruction_address.selector
op_assign
l_int|0
suffix:semicolon
id|instruction_address.opcode
op_assign
l_int|0
suffix:semicolon
id|no_ip_update
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * These are nops on the i387..&n; */
DECL|macro|feni
mdefine_line|#define feni fnop
DECL|macro|fdisi
mdefine_line|#define fdisi fnop
DECL|macro|fsetpm
mdefine_line|#define fsetpm fnop
DECL|variable|finit_table
r_static
id|FUNC
r_const
id|finit_table
(braket
)braket
op_assign
(brace
id|feni
comma
id|fdisi
comma
id|fclex
comma
id|finit
comma
id|fsetpm
comma
id|FPU_illegal
comma
id|FPU_illegal
comma
id|FPU_illegal
)brace
suffix:semicolon
DECL|function|finit_
r_void
id|finit_
c_func
(paren
)paren
(brace
(paren
id|finit_table
(braket
id|FPU_rm
)braket
)paren
(paren
)paren
suffix:semicolon
)brace
DECL|function|fstsw_ax
r_static
r_void
id|fstsw_ax
c_func
(paren
r_void
)paren
(brace
op_star
(paren
r_int
op_star
)paren
op_amp
id|FPU_EAX
op_assign
id|status_word
c_func
(paren
)paren
suffix:semicolon
id|no_ip_update
op_assign
l_int|1
suffix:semicolon
)brace
DECL|variable|fstsw_table
r_static
id|FUNC
r_const
id|fstsw_table
(braket
)braket
op_assign
(brace
id|fstsw_ax
comma
id|FPU_illegal
comma
id|FPU_illegal
comma
id|FPU_illegal
comma
id|FPU_illegal
comma
id|FPU_illegal
comma
id|FPU_illegal
comma
id|FPU_illegal
)brace
suffix:semicolon
DECL|function|fstsw_
r_void
id|fstsw_
c_func
(paren
)paren
(brace
(paren
id|fstsw_table
(braket
id|FPU_rm
)braket
)paren
(paren
)paren
suffix:semicolon
)brace
DECL|variable|fp_nop_table
r_static
id|FUNC
r_const
id|fp_nop_table
(braket
)braket
op_assign
(brace
id|fnop
comma
id|FPU_illegal
comma
id|FPU_illegal
comma
id|FPU_illegal
comma
id|FPU_illegal
comma
id|FPU_illegal
comma
id|FPU_illegal
comma
id|FPU_illegal
)brace
suffix:semicolon
DECL|function|fp_nop
r_void
id|fp_nop
c_func
(paren
)paren
(brace
(paren
id|fp_nop_table
(braket
id|FPU_rm
)braket
)paren
(paren
)paren
suffix:semicolon
)brace
DECL|function|fld_i_
r_void
id|fld_i_
c_func
(paren
)paren
(brace
id|FPU_REG
op_star
id|st_new_ptr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u_char
id|tag
suffix:semicolon
r_if
c_cond
(paren
id|STACK_OVERFLOW
)paren
(brace
id|FPU_stack_overflow
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* fld st(i) */
id|i
op_assign
id|FPU_rm
suffix:semicolon
r_if
c_cond
(paren
id|NOT_EMPTY
c_func
(paren
id|i
)paren
)paren
(brace
id|reg_copy
c_func
(paren
op_amp
id|st
c_func
(paren
id|i
)paren
comma
id|st_new_ptr
)paren
suffix:semicolon
id|tag
op_assign
id|FPU_gettagi
c_func
(paren
id|i
)paren
suffix:semicolon
id|push
c_func
(paren
)paren
suffix:semicolon
id|FPU_settag0
c_func
(paren
id|tag
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|control_word
op_amp
id|CW_Invalid
)paren
(brace
multiline_comment|/* The masked response */
id|FPU_stack_underflow
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
id|EXCEPTION
c_func
(paren
id|EX_StackUnder
)paren
suffix:semicolon
)brace
)brace
DECL|function|fxch_i
r_void
id|fxch_i
c_func
(paren
)paren
(brace
multiline_comment|/* fxch st(i) */
id|FPU_REG
id|t
suffix:semicolon
r_int
id|i
op_assign
id|FPU_rm
suffix:semicolon
id|FPU_REG
op_star
id|st0_ptr
op_assign
op_amp
id|st
c_func
(paren
l_int|0
)paren
comma
op_star
id|sti_ptr
op_assign
op_amp
id|st
c_func
(paren
id|i
)paren
suffix:semicolon
r_int
id|tag_word
op_assign
id|fpu_tag_word
suffix:semicolon
r_int
id|regnr
op_assign
id|top
op_amp
l_int|7
comma
id|regnri
op_assign
(paren
(paren
id|regnr
op_plus
id|i
)paren
op_amp
l_int|7
)paren
suffix:semicolon
id|u_char
id|st0_tag
op_assign
(paren
id|tag_word
op_rshift
(paren
id|regnr
op_star
l_int|2
)paren
)paren
op_amp
l_int|3
suffix:semicolon
id|u_char
id|sti_tag
op_assign
(paren
id|tag_word
op_rshift
(paren
id|regnri
op_star
l_int|2
)paren
)paren
op_amp
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|st0_tag
op_eq
id|TAG_Empty
)paren
(brace
r_if
c_cond
(paren
id|sti_tag
op_eq
id|TAG_Empty
)paren
(brace
id|FPU_stack_underflow
c_func
(paren
)paren
suffix:semicolon
id|FPU_stack_underflow_i
c_func
(paren
id|i
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|control_word
op_amp
id|CW_Invalid
)paren
(brace
multiline_comment|/* Masked response */
id|FPU_copy_to_reg0
c_func
(paren
id|sti_ptr
comma
id|sti_tag
)paren
suffix:semicolon
)brace
id|FPU_stack_underflow_i
c_func
(paren
id|i
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sti_tag
op_eq
id|TAG_Empty
)paren
(brace
r_if
c_cond
(paren
id|control_word
op_amp
id|CW_Invalid
)paren
(brace
multiline_comment|/* Masked response */
id|FPU_copy_to_regi
c_func
(paren
id|st0_ptr
comma
id|st0_tag
comma
id|i
)paren
suffix:semicolon
)brace
id|FPU_stack_underflow
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|clear_C1
c_func
(paren
)paren
suffix:semicolon
id|reg_copy
c_func
(paren
id|st0_ptr
comma
op_amp
id|t
)paren
suffix:semicolon
id|reg_copy
c_func
(paren
id|sti_ptr
comma
id|st0_ptr
)paren
suffix:semicolon
id|reg_copy
c_func
(paren
op_amp
id|t
comma
id|sti_ptr
)paren
suffix:semicolon
id|tag_word
op_and_assign
op_complement
(paren
l_int|3
op_lshift
(paren
id|regnr
op_star
l_int|2
)paren
)paren
op_amp
op_complement
(paren
l_int|3
op_lshift
(paren
id|regnri
op_star
l_int|2
)paren
)paren
suffix:semicolon
id|tag_word
op_or_assign
(paren
id|sti_tag
op_lshift
(paren
id|regnr
op_star
l_int|2
)paren
)paren
op_or
(paren
id|st0_tag
op_lshift
(paren
id|regnri
op_star
l_int|2
)paren
)paren
suffix:semicolon
id|fpu_tag_word
op_assign
id|tag_word
suffix:semicolon
)brace
DECL|function|ffree_
r_void
id|ffree_
c_func
(paren
)paren
(brace
multiline_comment|/* ffree st(i) */
id|FPU_settagi
c_func
(paren
id|FPU_rm
comma
id|TAG_Empty
)paren
suffix:semicolon
)brace
DECL|function|ffreep
r_void
id|ffreep
c_func
(paren
)paren
(brace
multiline_comment|/* ffree st(i) + pop - unofficial code */
id|FPU_settagi
c_func
(paren
id|FPU_rm
comma
id|TAG_Empty
)paren
suffix:semicolon
id|FPU_pop
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|fst_i_
r_void
id|fst_i_
c_func
(paren
)paren
(brace
multiline_comment|/* fst st(i) */
id|FPU_copy_to_regi
c_func
(paren
op_amp
id|st
c_func
(paren
l_int|0
)paren
comma
id|FPU_gettag0
c_func
(paren
)paren
comma
id|FPU_rm
)paren
suffix:semicolon
)brace
DECL|function|fstp_i
r_void
id|fstp_i
c_func
(paren
)paren
(brace
multiline_comment|/* fstp st(i) */
id|FPU_copy_to_regi
c_func
(paren
op_amp
id|st
c_func
(paren
l_int|0
)paren
comma
id|FPU_gettag0
c_func
(paren
)paren
comma
id|FPU_rm
)paren
suffix:semicolon
id|FPU_pop
c_func
(paren
)paren
suffix:semicolon
)brace
eof
