multiline_comment|/*&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; * Copyright (C) 2000 Hewlett Packard (Paul Bame bame@puffin.external.hp.com)&n; *&n; * most of these calls might reasonably be moved to ../kernel -PB&n; *&n; * The basic principle is to construct a stack frame in C then call&n; * some assembly which adopts that stack, does some rfi magic, may&n; * switch wide/narrow mode, and calls the routine described by the&n; * &squot;fn&squot; parameter WHICH IS NOT A FUNCTION POINTER!!!!!!!!!!!!!!!!&n; */
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;stdarg.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;&t;&t;/* for __pa() */
macro_line|#include &lt;asm/pdc.h&gt;
DECL|variable|pdc_lock
r_static
id|spinlock_t
id|pdc_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/***************** 32-bit real-mode calls ***********/
multiline_comment|/* The struct below is used&n; * to overlay real_stack (real2.S), preparing a 32-bit call frame.&n; * real32_call_asm() then uses this stack in narrow real mode&n; */
DECL|struct|narrow_stack
r_struct
id|narrow_stack
(brace
multiline_comment|/* use int, not long which is 64 bits */
DECL|member|arg13
r_int
r_int
id|arg13
suffix:semicolon
DECL|member|arg12
r_int
r_int
id|arg12
suffix:semicolon
DECL|member|arg11
r_int
r_int
id|arg11
suffix:semicolon
DECL|member|arg10
r_int
r_int
id|arg10
suffix:semicolon
DECL|member|arg9
r_int
r_int
id|arg9
suffix:semicolon
DECL|member|arg8
r_int
r_int
id|arg8
suffix:semicolon
DECL|member|arg7
r_int
r_int
id|arg7
suffix:semicolon
DECL|member|arg6
r_int
r_int
id|arg6
suffix:semicolon
DECL|member|arg5
r_int
r_int
id|arg5
suffix:semicolon
DECL|member|arg4
r_int
r_int
id|arg4
suffix:semicolon
DECL|member|arg3
r_int
r_int
id|arg3
suffix:semicolon
DECL|member|arg2
r_int
r_int
id|arg2
suffix:semicolon
DECL|member|arg1
r_int
r_int
id|arg1
suffix:semicolon
DECL|member|arg0
r_int
r_int
id|arg0
suffix:semicolon
DECL|member|frame_marker
r_int
r_int
id|frame_marker
(braket
l_int|8
)braket
suffix:semicolon
DECL|member|sp
r_int
r_int
id|sp
suffix:semicolon
multiline_comment|/* in reality, there&squot;s nearly 8k of stack after this */
)brace
suffix:semicolon
r_int
DECL|function|real32_call
id|real32_call
c_func
(paren
r_int
r_int
id|fn
comma
dot
dot
dot
)paren
(brace
r_int
r_int
id|r
suffix:semicolon
id|va_list
id|args
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_extern
r_struct
id|narrow_stack
id|real_stack
suffix:semicolon
r_extern
r_int
r_int
id|real32_call_asm
c_func
(paren
r_int
r_int
op_star
comma
r_int
r_int
op_star
comma
r_int
r_int
)paren
suffix:semicolon
id|va_start
c_func
(paren
id|args
comma
id|fn
)paren
suffix:semicolon
id|real_stack.arg0
op_assign
id|va_arg
c_func
(paren
id|args
comma
r_int
r_int
)paren
suffix:semicolon
id|real_stack.arg1
op_assign
id|va_arg
c_func
(paren
id|args
comma
r_int
r_int
)paren
suffix:semicolon
id|real_stack.arg2
op_assign
id|va_arg
c_func
(paren
id|args
comma
r_int
r_int
)paren
suffix:semicolon
id|real_stack.arg3
op_assign
id|va_arg
c_func
(paren
id|args
comma
r_int
r_int
)paren
suffix:semicolon
id|real_stack.arg4
op_assign
id|va_arg
c_func
(paren
id|args
comma
r_int
r_int
)paren
suffix:semicolon
id|real_stack.arg5
op_assign
id|va_arg
c_func
(paren
id|args
comma
r_int
r_int
)paren
suffix:semicolon
id|real_stack.arg6
op_assign
id|va_arg
c_func
(paren
id|args
comma
r_int
r_int
)paren
suffix:semicolon
id|real_stack.arg7
op_assign
id|va_arg
c_func
(paren
id|args
comma
r_int
r_int
)paren
suffix:semicolon
id|real_stack.arg8
op_assign
id|va_arg
c_func
(paren
id|args
comma
r_int
r_int
)paren
suffix:semicolon
id|real_stack.arg9
op_assign
id|va_arg
c_func
(paren
id|args
comma
r_int
r_int
)paren
suffix:semicolon
id|real_stack.arg10
op_assign
id|va_arg
c_func
(paren
id|args
comma
r_int
r_int
)paren
suffix:semicolon
id|real_stack.arg11
op_assign
id|va_arg
c_func
(paren
id|args
comma
r_int
r_int
)paren
suffix:semicolon
id|real_stack.arg12
op_assign
id|va_arg
c_func
(paren
id|args
comma
r_int
r_int
)paren
suffix:semicolon
id|real_stack.arg13
op_assign
id|va_arg
c_func
(paren
id|args
comma
r_int
r_int
)paren
suffix:semicolon
id|va_end
c_func
(paren
id|args
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fn
op_eq
l_int|0
)paren
(brace
multiline_comment|/* mem_pdc call */
id|fn
op_assign
id|PAGE0-&gt;mem_pdc
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pdc_lock
comma
id|flags
)paren
suffix:semicolon
id|r
op_assign
id|real32_call_asm
c_func
(paren
op_amp
id|real_stack.sp
comma
op_amp
id|real_stack.arg0
comma
id|fn
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pdc_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
macro_line|#ifdef __LP64__
multiline_comment|/***************** 64-bit real-mode calls ***********/
DECL|struct|wide_stack
r_struct
id|wide_stack
(brace
DECL|member|arg0
r_int
r_int
id|arg0
suffix:semicolon
DECL|member|arg1
r_int
r_int
id|arg1
suffix:semicolon
DECL|member|arg2
r_int
r_int
id|arg2
suffix:semicolon
DECL|member|arg3
r_int
r_int
id|arg3
suffix:semicolon
DECL|member|arg4
r_int
r_int
id|arg4
suffix:semicolon
DECL|member|arg5
r_int
r_int
id|arg5
suffix:semicolon
DECL|member|arg6
r_int
r_int
id|arg6
suffix:semicolon
DECL|member|arg7
r_int
r_int
id|arg7
suffix:semicolon
DECL|member|arg8
r_int
r_int
id|arg8
suffix:semicolon
DECL|member|arg9
r_int
r_int
id|arg9
suffix:semicolon
DECL|member|arg10
r_int
r_int
id|arg10
suffix:semicolon
DECL|member|arg11
r_int
r_int
id|arg11
suffix:semicolon
DECL|member|arg12
r_int
r_int
id|arg12
suffix:semicolon
DECL|member|arg13
r_int
r_int
id|arg13
suffix:semicolon
DECL|member|frame_marker
r_int
r_int
id|frame_marker
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* rp, previous sp */
DECL|member|sp
r_int
r_int
id|sp
suffix:semicolon
multiline_comment|/* in reality, there&squot;s nearly 8k of stack after this */
)brace
suffix:semicolon
r_int
DECL|function|real64_call
id|real64_call
c_func
(paren
r_int
r_int
id|fn
comma
dot
dot
dot
)paren
(brace
r_int
r_int
id|r
suffix:semicolon
id|va_list
id|args
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_extern
r_struct
id|wide_stack
id|real_stack
suffix:semicolon
r_extern
r_int
r_int
id|real64_call_asm
c_func
(paren
r_int
r_int
op_star
comma
r_int
r_int
op_star
comma
r_int
r_int
)paren
suffix:semicolon
id|va_start
c_func
(paren
id|args
comma
id|fn
)paren
suffix:semicolon
id|real_stack.arg0
op_assign
id|va_arg
c_func
(paren
id|args
comma
r_int
r_int
)paren
suffix:semicolon
id|real_stack.arg1
op_assign
id|va_arg
c_func
(paren
id|args
comma
r_int
r_int
)paren
suffix:semicolon
id|real_stack.arg2
op_assign
id|va_arg
c_func
(paren
id|args
comma
r_int
r_int
)paren
suffix:semicolon
id|real_stack.arg3
op_assign
id|va_arg
c_func
(paren
id|args
comma
r_int
r_int
)paren
suffix:semicolon
id|real_stack.arg4
op_assign
id|va_arg
c_func
(paren
id|args
comma
r_int
r_int
)paren
suffix:semicolon
id|real_stack.arg5
op_assign
id|va_arg
c_func
(paren
id|args
comma
r_int
r_int
)paren
suffix:semicolon
id|real_stack.arg6
op_assign
id|va_arg
c_func
(paren
id|args
comma
r_int
r_int
)paren
suffix:semicolon
id|real_stack.arg7
op_assign
id|va_arg
c_func
(paren
id|args
comma
r_int
r_int
)paren
suffix:semicolon
id|real_stack.arg8
op_assign
id|va_arg
c_func
(paren
id|args
comma
r_int
r_int
)paren
suffix:semicolon
id|real_stack.arg9
op_assign
id|va_arg
c_func
(paren
id|args
comma
r_int
r_int
)paren
suffix:semicolon
id|real_stack.arg10
op_assign
id|va_arg
c_func
(paren
id|args
comma
r_int
r_int
)paren
suffix:semicolon
id|real_stack.arg11
op_assign
id|va_arg
c_func
(paren
id|args
comma
r_int
r_int
)paren
suffix:semicolon
id|real_stack.arg12
op_assign
id|va_arg
c_func
(paren
id|args
comma
r_int
r_int
)paren
suffix:semicolon
id|real_stack.arg13
op_assign
id|va_arg
c_func
(paren
id|args
comma
r_int
r_int
)paren
suffix:semicolon
id|va_end
c_func
(paren
id|args
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fn
op_eq
l_int|0
)paren
(brace
multiline_comment|/* mem_pdc call */
id|fn
op_assign
id|PAGE0-&gt;mem_pdc_hi
suffix:semicolon
id|fn
op_lshift_assign
l_int|32
suffix:semicolon
id|fn
op_or_assign
id|PAGE0-&gt;mem_pdc
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pdc_lock
comma
id|flags
)paren
suffix:semicolon
id|r
op_assign
id|real64_call_asm
c_func
(paren
op_amp
id|real_stack.sp
comma
op_amp
id|real_stack.arg0
comma
id|fn
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pdc_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
macro_line|#endif
eof
