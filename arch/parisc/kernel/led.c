multiline_comment|/*&n; *    Chassis LCD/LED driver for HP-PARISC workstations&n; *&n; *      (c) Copyright 2000 Red Hat Software&n; *      (c) Copyright 2000 Helge Deller &lt;hdeller@redhat.com&gt;&n; *&n; *      This program is free software; you can redistribute it and/or modify&n; *      it under the terms of the GNU General Public License as published by&n; *      the Free Software Foundation; either version 2 of the License, or&n; *      (at your option) any later version.&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel_stat.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/gsc.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/param.h&gt;&t;&t;/* HZ */
macro_line|#include &lt;asm/led.h&gt;
multiline_comment|/* define to disable all LED functions */
DECL|macro|DISABLE_LEDS
macro_line|#undef  DISABLE_LEDS
DECL|macro|CPU_HVERSION
mdefine_line|#define CPU_HVERSION ((boot_cpu_data.hversion &gt;&gt; 4) &amp; 0x0FFF)
DECL|struct|lcd_block
r_struct
id|lcd_block
(brace
DECL|member|command
r_int
r_char
id|command
suffix:semicolon
multiline_comment|/* stores the command byte      */
DECL|member|on
r_int
r_char
id|on
suffix:semicolon
multiline_comment|/* value for turning LED on     */
DECL|member|off
r_int
r_char
id|off
suffix:semicolon
multiline_comment|/* value for turning LED off    */
)brace
suffix:semicolon
multiline_comment|/* Structure returned by PDC_RETURN_CHASSIS_INFO */
DECL|struct|pdc_chassis_lcd_info_ret_block
r_struct
id|pdc_chassis_lcd_info_ret_block
(brace
DECL|member|model
r_int
r_int
id|model
suffix:colon
l_int|16
suffix:semicolon
multiline_comment|/* DISPLAY_MODEL_XXXX (see below)  */
DECL|member|lcd_width
r_int
r_int
id|lcd_width
suffix:colon
l_int|16
suffix:semicolon
multiline_comment|/* width of the LCD in chars (DISPLAY_MODEL_LCD only) */
DECL|member|lcd_cmd_reg_addr
r_char
op_star
id|lcd_cmd_reg_addr
suffix:semicolon
multiline_comment|/* ptr to LCD cmd-register &amp; data ptr for LED */
DECL|member|lcd_data_reg_addr
r_char
op_star
id|lcd_data_reg_addr
suffix:semicolon
multiline_comment|/* ptr to LCD data-register (LCD only) */
DECL|member|min_cmd_delay
r_int
r_int
id|min_cmd_delay
suffix:semicolon
multiline_comment|/* delay in uS after cmd-write (LCD only) */
DECL|member|reset_cmd1
r_int
r_char
id|reset_cmd1
suffix:semicolon
multiline_comment|/* command #1 for writing LCD string (LCD only) */
DECL|member|reset_cmd2
r_int
r_char
id|reset_cmd2
suffix:semicolon
multiline_comment|/* command #2 for writing LCD string (LCD only) */
DECL|member|act_enable
r_int
r_char
id|act_enable
suffix:semicolon
multiline_comment|/* 0 = no activity (LCD only) */
DECL|member|heartbeat
r_struct
id|lcd_block
id|heartbeat
suffix:semicolon
DECL|member|disk_io
r_struct
id|lcd_block
id|disk_io
suffix:semicolon
DECL|member|lan_rcv
r_struct
id|lcd_block
id|lan_rcv
suffix:semicolon
DECL|member|lan_tx
r_struct
id|lcd_block
id|lan_tx
suffix:semicolon
DECL|member|_pad
r_char
id|_pad
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* values for pdc_chassis_lcd_info_ret_block.model: */
DECL|macro|DISPLAY_MODEL_LCD
mdefine_line|#define DISPLAY_MODEL_LCD  0&t;/* KittyHawk LED or LCD */
DECL|macro|DISPLAY_MODEL_NONE
mdefine_line|#define DISPLAY_MODEL_NONE 1&t;/* no LED or LCD */
DECL|macro|DISPLAY_MODEL_LASI
mdefine_line|#define DISPLAY_MODEL_LASI 2&t;/* LASI style 8 bit LED */
DECL|macro|DISPLAY_MODEL_OLD_ASP
mdefine_line|#define DISPLAY_MODEL_OLD_ASP 0x7F /* faked: ASP style 8 x 1 bit LED (only very old ASP versions) */
multiline_comment|/* LCD_CMD and LCD_DATA for KittyHawk machines */
macro_line|#ifdef __LP64__
DECL|macro|KITTYHAWK_LCD_CMD
mdefine_line|#define KITTYHAWK_LCD_CMD 0xfffffffff0190000L
macro_line|#else
DECL|macro|KITTYHAWK_LCD_CMD
mdefine_line|#define KITTYHAWK_LCD_CMD 0xf0190000
macro_line|#endif
DECL|macro|KITTYHAWK_LCD_DATA
mdefine_line|#define KITTYHAWK_LCD_DATA (KITTYHAWK_LCD_CMD + 1)
multiline_comment|/* lcd_info is pre-initialized to the values needed to program KittyHawk LCD&squot;s */
r_static
r_struct
id|pdc_chassis_lcd_info_ret_block
DECL|variable|lcd_info
id|lcd_info
id|__attribute__
c_func
(paren
(paren
id|aligned
c_func
(paren
l_int|8
)paren
)paren
)paren
op_assign
(brace
id|model
suffix:colon
id|DISPLAY_MODEL_LCD
comma
id|lcd_width
suffix:colon
l_int|16
comma
id|lcd_cmd_reg_addr
suffix:colon
(paren
r_char
op_star
)paren
id|KITTYHAWK_LCD_CMD
comma
id|lcd_data_reg_addr
suffix:colon
(paren
r_char
op_star
)paren
id|KITTYHAWK_LCD_DATA
comma
id|min_cmd_delay
suffix:colon
l_int|40
comma
id|reset_cmd1
suffix:colon
l_int|0x80
comma
id|reset_cmd2
suffix:colon
l_int|0xc0
comma
)brace
suffix:semicolon
multiline_comment|/* direct access to some of the lcd_info variables */
DECL|macro|LCD_CMD_REG
mdefine_line|#define LCD_CMD_REG&t;lcd_info.lcd_cmd_reg_addr&t; 
DECL|macro|LCD_DATA_REG
mdefine_line|#define LCD_DATA_REG&t;lcd_info.lcd_data_reg_addr&t; 
DECL|macro|LED_DATA_REG
mdefine_line|#define LED_DATA_REG&t;lcd_info.lcd_cmd_reg_addr&t;/* LASI &amp; ASP only */
multiline_comment|/*&n;   ** &n;   ** led_ASP_driver()&n;   ** &n; */
DECL|macro|LED_DATA
mdefine_line|#define&t;LED_DATA&t;0x01&t;/* data to shift (0:on 1:off) */
DECL|macro|LED_STROBE
mdefine_line|#define&t;LED_STROBE&t;0x02&t;/* strobe to clock data */
DECL|function|led_ASP_driver
r_static
r_void
id|led_ASP_driver
c_func
(paren
r_int
r_char
id|leds
)paren
(brace
r_int
id|i
suffix:semicolon
id|leds
op_assign
op_complement
id|leds
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_char
id|value
suffix:semicolon
id|value
op_assign
(paren
id|leds
op_amp
l_int|0x80
)paren
op_rshift
l_int|7
suffix:semicolon
id|gsc_writeb
c_func
(paren
id|value
comma
id|LED_DATA_REG
)paren
suffix:semicolon
id|gsc_writeb
c_func
(paren
id|value
op_or
id|LED_STROBE
comma
id|LED_DATA_REG
)paren
suffix:semicolon
id|leds
op_lshift_assign
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;   ** &n;   ** led_LASI_driver()&n;   ** &n; */
DECL|function|led_LASI_driver
r_static
r_void
id|led_LASI_driver
c_func
(paren
r_int
r_char
id|leds
)paren
(brace
id|leds
op_assign
op_complement
id|leds
suffix:semicolon
id|gsc_writeb
c_func
(paren
id|leds
comma
id|LED_DATA_REG
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;   ** &n;   ** led_LCD_driver()&n;   ** &n;   ** The logic of the LCD driver is, that we write at every interrupt&n;   ** only to one of LCD_CMD_REG _or_ LCD_DATA_REG - registers.&n;   ** That way we don&squot;t need to let this interrupt routine busywait&n;   ** the &quot;min_cmd_delay&quot;, since idlewaiting in an interrupt-routine is&n;   ** allways a BAD IDEA !&n;   **&n;   ** TODO: check the value of &quot;min_cmd_delay&quot; against the value of HZ.&n;   **   &n; */
DECL|function|led_LCD_driver
r_static
r_void
id|led_LCD_driver
c_func
(paren
r_int
r_char
id|leds
)paren
(brace
r_static
r_int
id|last_index
suffix:semicolon
multiline_comment|/* 0:heartbeat, 1:disk, 2:lan_in, 3:lan_out */
r_static
r_int
id|last_was_cmd
suffix:semicolon
multiline_comment|/* 0: CMD was written last, 1: DATA was last */
r_struct
id|lcd_block
op_star
id|block_ptr
suffix:semicolon
r_int
id|value
suffix:semicolon
singleline_comment|// leds = ~leds;&t;/* needed ? */ 
r_switch
c_cond
(paren
id|last_index
)paren
(brace
r_case
l_int|0
suffix:colon
id|block_ptr
op_assign
op_amp
id|lcd_info.heartbeat
suffix:semicolon
id|value
op_assign
id|leds
op_amp
id|LED_HEARTBEAT
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|block_ptr
op_assign
op_amp
id|lcd_info.disk_io
suffix:semicolon
id|value
op_assign
id|leds
op_amp
id|LED_DISK_IO
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|block_ptr
op_assign
op_amp
id|lcd_info.lan_rcv
suffix:semicolon
id|value
op_assign
id|leds
op_amp
id|LED_LAN_RCV
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|block_ptr
op_assign
op_amp
id|lcd_info.lan_tx
suffix:semicolon
id|value
op_assign
id|leds
op_amp
id|LED_LAN_TX
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* should never happen: */
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|last_was_cmd
)paren
(brace
multiline_comment|/* write the value to the LCD data port */
id|gsc_writeb
c_func
(paren
id|value
ques
c_cond
id|block_ptr-&gt;on
suffix:colon
id|block_ptr-&gt;off
comma
id|LCD_DATA_REG
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* write the command-byte to the LCD command register */
id|gsc_writeb
c_func
(paren
id|block_ptr-&gt;command
comma
id|LCD_CMD_REG
)paren
suffix:semicolon
)brace
multiline_comment|/* now update the vars for the next interrupt iteration */
r_if
c_cond
(paren
op_increment
id|last_was_cmd
op_eq
l_int|2
)paren
(brace
id|last_was_cmd
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|last_index
op_eq
l_int|4
)paren
id|last_index
op_assign
l_int|0
suffix:semicolon
)brace
)brace
DECL|variable|currentleds
r_static
r_char
id|currentleds
suffix:semicolon
multiline_comment|/* stores current value of the LEDs */
DECL|variable|led_func_ptr
r_static
r_void
(paren
op_star
id|led_func_ptr
)paren
(paren
r_int
r_char
)paren
suffix:semicolon
multiline_comment|/* ptr to LCD/LED-specific function */
multiline_comment|/*&n;   ** led_interrupt_func()&n;   ** &n;   ** is called at every timer interrupt from time.c,&n;   ** updates the chassis LCD/LED &n; */
DECL|macro|HEARTBEAT_LEN
mdefine_line|#define HEARTBEAT_LEN&t;(HZ/16)
DECL|function|led_interrupt_func
r_void
id|led_interrupt_func
c_func
(paren
r_void
)paren
(brace
macro_line|#ifndef DISABLE_LEDS
r_static
r_int
id|count
suffix:semicolon
r_static
r_int
id|lastleds
op_assign
op_minus
l_int|1
suffix:semicolon
r_static
r_int
id|nr
suffix:semicolon
multiline_comment|/* exit, if not initialized */
r_if
c_cond
(paren
op_logical_neg
id|led_func_ptr
)paren
r_return
suffix:semicolon
multiline_comment|/* increment the local counter */
r_if
c_cond
(paren
id|count
op_eq
(paren
id|HZ
op_minus
l_int|1
)paren
)paren
id|count
op_assign
l_int|0
suffix:semicolon
r_else
id|count
op_increment
suffix:semicolon
multiline_comment|/* calculate the Heartbeat */
r_if
c_cond
(paren
(paren
id|count
op_mod
(paren
id|HZ
op_div
l_int|2
)paren
)paren
OL
id|HEARTBEAT_LEN
)paren
id|currentleds
op_or_assign
id|LED_HEARTBEAT
suffix:semicolon
r_else
id|currentleds
op_and_assign
op_complement
id|LED_HEARTBEAT
suffix:semicolon
multiline_comment|/* roll LEDs 0..2 */
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|nr
op_increment
op_ge
l_int|2
)paren
id|nr
op_assign
l_int|0
suffix:semicolon
id|currentleds
op_and_assign
op_complement
l_int|7
suffix:semicolon
id|currentleds
op_or_assign
(paren
l_int|1
op_lshift
id|nr
)paren
suffix:semicolon
)brace
multiline_comment|/* now update the LEDs */
r_if
c_cond
(paren
id|currentleds
op_ne
id|lastleds
)paren
(brace
id|led_func_ptr
c_func
(paren
id|currentleds
)paren
suffix:semicolon
id|lastleds
op_assign
id|currentleds
suffix:semicolon
)brace
macro_line|#endif
)brace
multiline_comment|/*&n;   ** register_led_driver()&n;   ** &n;   ** All information in lcd_info needs to be set up prior&n;   ** calling this function. &n; */
DECL|function|register_led_driver
r_static
r_void
id|__init
id|register_led_driver
c_func
(paren
r_void
)paren
(brace
macro_line|#ifndef DISABLE_LEDS
r_switch
c_cond
(paren
id|lcd_info.model
)paren
(brace
r_case
id|DISPLAY_MODEL_LCD
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;LCD display at (%p,%p)&bslash;n&quot;
comma
id|LCD_CMD_REG
comma
id|LCD_DATA_REG
)paren
suffix:semicolon
id|led_func_ptr
op_assign
id|led_LCD_driver
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DISPLAY_MODEL_LASI
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;LED display at %p&bslash;n&quot;
comma
id|LED_DATA_REG
)paren
suffix:semicolon
id|led_func_ptr
op_assign
id|led_LASI_driver
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DISPLAY_MODEL_OLD_ASP
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;LED (ASP-style) display at %p&bslash;n&quot;
comma
id|LED_DATA_REG
)paren
suffix:semicolon
id|led_func_ptr
op_assign
id|led_ASP_driver
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Wrong LCD/LED model %d !&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|lcd_info.model
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif
)brace
multiline_comment|/*&n; * XXX - could this move to lasi.c ??&n; */
multiline_comment|/*&n;   ** lasi_led_init()&n;   ** &n;   ** lasi_led_init() is called from lasi.c with the base hpa  &n;   ** of the lasi controller chip. &n;   ** Since Mirage and Electra machines use a different LED&n;   ** address register, we need to check for these machines &n;   ** explicitly.&n; */
macro_line|#ifdef CONFIG_GSC_LASI
DECL|function|lasi_led_init
r_void
id|__init
id|lasi_led_init
c_func
(paren
r_int
r_int
id|lasi_hpa
)paren
(brace
r_if
c_cond
(paren
id|lcd_info.model
op_ne
id|DISPLAY_MODEL_NONE
op_logical_or
id|lasi_hpa
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: CPU_HVERSION %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|CPU_HVERSION
)paren
suffix:semicolon
multiline_comment|/* Mirage and Electra machines need special offsets */
r_switch
c_cond
(paren
id|CPU_HVERSION
)paren
(brace
r_case
l_int|0x60A
suffix:colon
multiline_comment|/* Mirage Jr (715/64) */
r_case
l_int|0x60B
suffix:colon
multiline_comment|/* Mirage 100 */
r_case
l_int|0x60C
suffix:colon
multiline_comment|/* Mirage 100+ */
r_case
l_int|0x60D
suffix:colon
multiline_comment|/* Electra 100 */
r_case
l_int|0x60E
suffix:colon
multiline_comment|/* Electra 120 */
id|LED_DATA_REG
op_assign
(paren
r_char
op_star
)paren
(paren
id|lasi_hpa
op_minus
l_int|0x00020000
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|LED_DATA_REG
op_assign
(paren
r_char
op_star
)paren
(paren
id|lasi_hpa
op_plus
l_int|0x0000C000
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* switch() */
id|lcd_info.model
op_assign
id|DISPLAY_MODEL_LASI
suffix:semicolon
id|register_led_driver
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;   ** asp_led_init()&n;   ** &n;   ** asp_led_init() is called from asp.c with the ptr &n;   ** to the LED display.&n; */
macro_line|#ifdef CONFIG_GSC_LASI
DECL|function|asp_led_init
r_void
id|__init
id|asp_led_init
c_func
(paren
r_int
r_int
id|led_ptr
)paren
(brace
r_if
c_cond
(paren
id|lcd_info.model
op_ne
id|DISPLAY_MODEL_NONE
op_logical_or
id|led_ptr
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|lcd_info.model
op_assign
id|DISPLAY_MODEL_OLD_ASP
suffix:semicolon
id|LED_DATA_REG
op_assign
(paren
r_char
op_star
)paren
id|led_ptr
suffix:semicolon
id|register_led_driver
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;   ** register_led_regions()&n;   ** &n;   ** Simple function, which registers the LCD/LED regions for /procfs.&n;   ** At bootup - where the initialisation of the LCD/LED normally happens - &n;   ** not all internal structures of request_region() are properly set up,&n;   ** so that we delay the registration until busdevice.c is executed.&n;   **&n; */
DECL|function|register_led_regions
r_void
id|__init
id|register_led_regions
c_func
(paren
r_void
)paren
(brace
r_switch
c_cond
(paren
id|lcd_info.model
)paren
(brace
r_case
id|DISPLAY_MODEL_LCD
suffix:colon
id|request_region
c_func
(paren
(paren
r_int
r_int
)paren
id|LCD_CMD_REG
comma
l_int|1
comma
l_string|&quot;lcd_cmd&quot;
)paren
suffix:semicolon
id|request_region
c_func
(paren
(paren
r_int
r_int
)paren
id|LCD_DATA_REG
comma
l_int|1
comma
l_string|&quot;lcd_data&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DISPLAY_MODEL_LASI
suffix:colon
r_case
id|DISPLAY_MODEL_OLD_ASP
suffix:colon
id|request_region
c_func
(paren
(paren
r_int
r_int
)paren
id|LED_DATA_REG
comma
l_int|1
comma
l_string|&quot;led_data&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;   ** led_init()&n;   ** &n;   ** led_init() is called very early in the bootup-process from setup.c &n;   ** and asks the PDC for an usable chassis LCD or LED.&n;   ** If the PDC doesn&squot;t return any info, then the LED&n;   ** is detected by lasi.c or asp.c and registered with the&n;   ** above functions lasi_led_init() or asp_led_init().&n;   ** KittyHawk machines have often a buggy PDC, so that&n;   ** we explicitly check for those machines here.&n; */
DECL|function|led_init
r_int
id|__init
id|led_init
c_func
(paren
r_void
)paren
(brace
macro_line|#ifndef DISABLE_LEDS
r_int
id|pdc_result
(braket
l_int|32
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: CPU_HVERSION %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|CPU_HVERSION
)paren
suffix:semicolon
multiline_comment|/* Work around the buggy PDC of KittyHawk-machines */
r_switch
c_cond
(paren
id|CPU_HVERSION
)paren
(brace
r_case
l_int|0x580
suffix:colon
multiline_comment|/* KittyHawk DC2-100 (K100) */
r_case
l_int|0x581
suffix:colon
multiline_comment|/* KittyHawk DC3-120 (K210) */
r_case
l_int|0x582
suffix:colon
multiline_comment|/* KittyHawk DC3 100 (K400) */
r_case
l_int|0x583
suffix:colon
multiline_comment|/* KittyHawk DC3 120 (K410) */
r_case
l_int|0x58B
suffix:colon
multiline_comment|/* KittyHawk DC2 100 (K200) */
id|printk
c_func
(paren
l_string|&quot;%s: KittyHawk-Machine found !!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|found
suffix:semicolon
multiline_comment|/* use the preinitialized values of lcd_info */
r_default
suffix:colon
r_break
suffix:semicolon
)brace
multiline_comment|/* initialize pdc_result, so we can check the return values of pdc_chassis_info() */
id|pdc_result
(braket
l_int|0
)braket
op_assign
id|pdc_result
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pdc_chassis_info
c_func
(paren
op_amp
id|pdc_result
comma
op_amp
id|lcd_info
comma
r_sizeof
(paren
id|lcd_info
)paren
)paren
op_eq
id|PDC_OK
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: chassis info: model %d, ret0=%d, ret1=%d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|lcd_info.model
comma
id|pdc_result
(braket
l_int|0
)braket
comma
id|pdc_result
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/* check the results. Some machines have a buggy PDC */
r_if
c_cond
(paren
id|pdc_result
(braket
l_int|0
)braket
op_le
l_int|0
op_logical_or
id|pdc_result
(braket
l_int|0
)braket
op_ne
id|pdc_result
(braket
l_int|1
)braket
)paren
r_goto
id|not_found
suffix:semicolon
r_switch
c_cond
(paren
id|lcd_info.model
)paren
(brace
r_case
id|DISPLAY_MODEL_LCD
suffix:colon
multiline_comment|/* LCD display */
r_if
c_cond
(paren
id|pdc_result
(braket
l_int|0
)braket
op_ne
r_sizeof
(paren
r_struct
id|pdc_chassis_lcd_info_ret_block
)paren
op_logical_and
id|pdc_result
(braket
l_int|0
)braket
op_ne
r_sizeof
(paren
r_struct
id|pdc_chassis_lcd_info_ret_block
)paren
op_minus
l_int|1
)paren
r_goto
id|not_found
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: min_cmd_delay = %d uS&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|lcd_info.min_cmd_delay
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DISPLAY_MODEL_NONE
suffix:colon
multiline_comment|/* no LED or LCD available */
r_goto
id|not_found
suffix:semicolon
r_case
id|DISPLAY_MODEL_LASI
suffix:colon
multiline_comment|/* Lasi style 8 bit LED display */
r_if
c_cond
(paren
id|pdc_result
(braket
l_int|0
)braket
op_ne
l_int|8
op_logical_and
id|pdc_result
(braket
l_int|0
)braket
op_ne
l_int|32
)paren
r_goto
id|not_found
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Unknown LCD/LED model %d&bslash;n&quot;
comma
id|lcd_info.model
)paren
suffix:semicolon
r_goto
id|not_found
suffix:semicolon
)brace
multiline_comment|/* switch() */
id|found
suffix:colon
multiline_comment|/* register the LCD/LED driver */
id|register_led_driver
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* if() */
id|not_found
suffix:colon
id|lcd_info.model
op_assign
id|DISPLAY_MODEL_NONE
suffix:semicolon
r_return
l_int|1
suffix:semicolon
macro_line|#endif
)brace
eof
