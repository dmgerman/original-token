multiline_comment|/* $Id: setup_cqreek.c,v 1.5 2000/09/18 05:51:24 gniibe Exp $&n; *&n; * arch/sh/kernel/setup_cqreek.c&n; *&n; * Copyright (C) 2000  Niibe Yutaka&n; *&n; * CqREEK IDE/ISA Bridge Support.&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/io_generic.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/machvec.h&gt;
macro_line|#include &lt;asm/machvec_init.h&gt;
DECL|macro|BRIDGE_FEATURE
mdefine_line|#define BRIDGE_FEATURE&t;&t;0x0002
DECL|macro|BRIDGE_IDE_CTRL
mdefine_line|#define BRIDGE_IDE_CTRL&t;&t;0x0018
DECL|macro|BRIDGE_IDE_INTR_LVL
mdefine_line|#define BRIDGE_IDE_INTR_LVL    &t;0x001A
DECL|macro|BRIDGE_IDE_INTR_MASK
mdefine_line|#define BRIDGE_IDE_INTR_MASK&t;0x001C
DECL|macro|BRIDGE_IDE_INTR_STAT
mdefine_line|#define BRIDGE_IDE_INTR_STAT&t;0x001E
DECL|macro|BRIDGE_ISA_CTRL
mdefine_line|#define BRIDGE_ISA_CTRL&t;&t;0x0028
DECL|macro|BRIDGE_ISA_INTR_LVL
mdefine_line|#define BRIDGE_ISA_INTR_LVL    &t;0x002A
DECL|macro|BRIDGE_ISA_INTR_MASK
mdefine_line|#define BRIDGE_ISA_INTR_MASK&t;0x002C
DECL|macro|BRIDGE_ISA_INTR_STAT
mdefine_line|#define BRIDGE_ISA_INTR_STAT&t;0x002E
DECL|macro|IDE_OFFSET
mdefine_line|#define IDE_OFFSET 0xA4000000UL
DECL|macro|ISA_OFFSET
mdefine_line|#define ISA_OFFSET 0xA4A00000UL
"&f;"
DECL|function|cqreek_port2addr
r_static
r_int
r_int
id|cqreek_port2addr
c_func
(paren
r_int
r_int
id|port
)paren
(brace
r_if
c_cond
(paren
l_int|0x0000
op_le
id|port
op_logical_and
id|port
op_le
l_int|0x0040
)paren
r_return
id|IDE_OFFSET
op_plus
id|port
suffix:semicolon
r_if
c_cond
(paren
(paren
l_int|0x01f0
op_le
id|port
op_logical_and
id|port
op_le
l_int|0x01f7
)paren
op_logical_or
id|port
op_eq
l_int|0x03f6
)paren
r_return
id|IDE_OFFSET
op_plus
id|port
suffix:semicolon
r_return
id|ISA_OFFSET
op_plus
id|port
suffix:semicolon
)brace
DECL|struct|cqreek_irq_data
r_struct
id|cqreek_irq_data
(brace
DECL|member|mask_port
r_int
r_int
id|mask_port
suffix:semicolon
multiline_comment|/* Port of Interrupt Mask Register */
DECL|member|stat_port
r_int
r_int
id|stat_port
suffix:semicolon
multiline_comment|/* Port of Interrupt Status Register */
DECL|member|bit
r_int
r_int
id|bit
suffix:semicolon
multiline_comment|/* Value of the bit */
)brace
suffix:semicolon
DECL|variable|cqreek_irq_data
r_static
r_struct
id|cqreek_irq_data
id|cqreek_irq_data
(braket
id|NR_IRQS
)braket
suffix:semicolon
DECL|function|disable_cqreek_irq
r_static
r_void
id|disable_cqreek_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|mask
suffix:semicolon
r_int
r_int
id|mask_port
op_assign
id|cqreek_irq_data
(braket
id|irq
)braket
dot
id|mask_port
suffix:semicolon
r_int
r_int
id|bit
op_assign
id|cqreek_irq_data
(braket
id|irq
)braket
dot
id|bit
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Disable IRQ */
id|mask
op_assign
id|inw
c_func
(paren
id|mask_port
)paren
op_amp
op_complement
id|bit
suffix:semicolon
id|outw_p
c_func
(paren
id|mask
comma
id|mask_port
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|enable_cqreek_irq
r_static
r_void
id|enable_cqreek_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|mask
suffix:semicolon
r_int
r_int
id|mask_port
op_assign
id|cqreek_irq_data
(braket
id|irq
)braket
dot
id|mask_port
suffix:semicolon
r_int
r_int
id|bit
op_assign
id|cqreek_irq_data
(braket
id|irq
)braket
dot
id|bit
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Enable IRQ */
id|mask
op_assign
id|inw
c_func
(paren
id|mask_port
)paren
op_or
id|bit
suffix:semicolon
id|outw_p
c_func
(paren
id|mask
comma
id|mask_port
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|mask_and_ack_cqreek
r_static
r_void
id|mask_and_ack_cqreek
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
r_int
id|stat_port
op_assign
id|cqreek_irq_data
(braket
id|irq
)braket
dot
id|stat_port
suffix:semicolon
r_int
r_int
id|bit
op_assign
id|cqreek_irq_data
(braket
id|irq
)braket
dot
id|bit
suffix:semicolon
id|inw
c_func
(paren
id|stat_port
)paren
suffix:semicolon
id|disable_cqreek_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
multiline_comment|/* Clear IRQ (it might be edge IRQ) */
id|outw_p
c_func
(paren
id|bit
comma
id|stat_port
)paren
suffix:semicolon
)brace
DECL|function|end_cqreek_irq
r_static
r_void
id|end_cqreek_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|enable_cqreek_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|function|startup_cqreek_irq
r_static
r_int
r_int
id|startup_cqreek_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|enable_cqreek_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|shutdown_cqreek_irq
r_static
r_void
id|shutdown_cqreek_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|disable_cqreek_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|variable|cqreek_irq_type
r_static
r_struct
id|hw_interrupt_type
id|cqreek_irq_type
op_assign
(brace
l_string|&quot;CqREEK-IRQ&quot;
comma
id|startup_cqreek_irq
comma
id|shutdown_cqreek_irq
comma
id|enable_cqreek_irq
comma
id|disable_cqreek_irq
comma
id|mask_and_ack_cqreek
comma
id|end_cqreek_irq
)brace
suffix:semicolon
DECL|variable|has_ide
DECL|variable|has_isa
r_static
r_int
id|has_ide
comma
id|has_isa
suffix:semicolon
multiline_comment|/* XXX: This is just for test for my NE2000 ISA board&n;   What we really need is virtualized IRQ and demultiplexer like HP600 port */
DECL|function|init_cqreek_IRQ
r_void
id|__init
id|init_cqreek_IRQ
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|has_ide
)paren
(brace
id|cqreek_irq_data
(braket
l_int|14
)braket
dot
id|mask_port
op_assign
id|BRIDGE_IDE_INTR_MASK
suffix:semicolon
id|cqreek_irq_data
(braket
l_int|14
)braket
dot
id|stat_port
op_assign
id|BRIDGE_IDE_INTR_STAT
suffix:semicolon
id|cqreek_irq_data
(braket
l_int|14
)braket
dot
id|bit
op_assign
l_int|1
suffix:semicolon
id|irq_desc
(braket
l_int|14
)braket
dot
id|handler
op_assign
op_amp
id|cqreek_irq_type
suffix:semicolon
id|irq_desc
(braket
l_int|14
)braket
dot
id|status
op_assign
id|IRQ_DISABLED
suffix:semicolon
id|irq_desc
(braket
l_int|14
)braket
dot
id|action
op_assign
l_int|0
suffix:semicolon
id|irq_desc
(braket
l_int|14
)braket
dot
id|depth
op_assign
l_int|1
suffix:semicolon
id|disable_cqreek_irq
c_func
(paren
l_int|14
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|has_isa
)paren
(brace
id|cqreek_irq_data
(braket
l_int|10
)braket
dot
id|mask_port
op_assign
id|BRIDGE_ISA_INTR_MASK
suffix:semicolon
id|cqreek_irq_data
(braket
l_int|10
)braket
dot
id|stat_port
op_assign
id|BRIDGE_ISA_INTR_STAT
suffix:semicolon
id|cqreek_irq_data
(braket
l_int|10
)braket
dot
id|bit
op_assign
(paren
l_int|1
op_lshift
l_int|10
)paren
suffix:semicolon
multiline_comment|/* XXX: Err... we may need demultiplexer for ISA irq... */
id|irq_desc
(braket
l_int|10
)braket
dot
id|handler
op_assign
op_amp
id|cqreek_irq_type
suffix:semicolon
id|irq_desc
(braket
l_int|10
)braket
dot
id|status
op_assign
id|IRQ_DISABLED
suffix:semicolon
id|irq_desc
(braket
l_int|10
)braket
dot
id|action
op_assign
l_int|0
suffix:semicolon
id|irq_desc
(braket
l_int|10
)braket
dot
id|depth
op_assign
l_int|1
suffix:semicolon
id|disable_cqreek_irq
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Initialize the board&n; */
DECL|function|setup_cqreek
r_void
id|__init
id|setup_cqreek
c_func
(paren
r_void
)paren
(brace
r_extern
r_void
id|disable_hlt
c_func
(paren
r_void
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* udelay is not available at setup time yet... */
DECL|macro|DELAY
mdefine_line|#define DELAY() do {for (i=0; i&lt;10000; i++) ctrl_inw(0xa0000000);} while(0)
multiline_comment|/*&n;&t; * XXX: I don&squot;t know the reason, but it becomes so fragile with&n;&t; * &quot;sleep&quot;, so we need to stop sleeping.&n;&t; */
id|disable_hlt
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inw
(paren
id|BRIDGE_FEATURE
)paren
op_amp
l_int|1
)paren
)paren
(brace
multiline_comment|/* We have IDE interface */
id|outw_p
c_func
(paren
l_int|0
comma
id|BRIDGE_IDE_INTR_LVL
)paren
suffix:semicolon
id|outw_p
c_func
(paren
l_int|0
comma
id|BRIDGE_IDE_INTR_MASK
)paren
suffix:semicolon
id|outw_p
c_func
(paren
l_int|0
comma
id|BRIDGE_IDE_CTRL
)paren
suffix:semicolon
id|DELAY
c_func
(paren
)paren
suffix:semicolon
id|outw_p
c_func
(paren
l_int|0x8000
comma
id|BRIDGE_IDE_CTRL
)paren
suffix:semicolon
id|DELAY
c_func
(paren
)paren
suffix:semicolon
id|outw_p
c_func
(paren
l_int|0xffff
comma
id|BRIDGE_IDE_INTR_STAT
)paren
suffix:semicolon
multiline_comment|/* Clear interrupt status */
id|outw_p
c_func
(paren
l_int|0x0f
op_minus
l_int|14
comma
id|BRIDGE_IDE_INTR_LVL
)paren
suffix:semicolon
multiline_comment|/* Use 14 IPR */
id|outw_p
c_func
(paren
l_int|1
comma
id|BRIDGE_IDE_INTR_MASK
)paren
suffix:semicolon
multiline_comment|/* Enable interrupt */
id|has_ide
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|inw
(paren
id|BRIDGE_FEATURE
)paren
op_amp
l_int|2
)paren
)paren
(brace
multiline_comment|/* We have ISA interface */
id|outw_p
c_func
(paren
l_int|0
comma
id|BRIDGE_ISA_INTR_LVL
)paren
suffix:semicolon
id|outw_p
c_func
(paren
l_int|0
comma
id|BRIDGE_ISA_INTR_MASK
)paren
suffix:semicolon
id|outw_p
c_func
(paren
l_int|0
comma
id|BRIDGE_ISA_CTRL
)paren
suffix:semicolon
id|DELAY
c_func
(paren
)paren
suffix:semicolon
id|outw_p
c_func
(paren
l_int|0x8000
comma
id|BRIDGE_ISA_CTRL
)paren
suffix:semicolon
id|DELAY
c_func
(paren
)paren
suffix:semicolon
id|outw_p
c_func
(paren
l_int|0xffff
comma
id|BRIDGE_ISA_INTR_STAT
)paren
suffix:semicolon
multiline_comment|/* Clear interrupt status */
id|outw_p
c_func
(paren
l_int|0x0f
op_minus
l_int|10
comma
id|BRIDGE_ISA_INTR_LVL
)paren
suffix:semicolon
multiline_comment|/* Use 10 IPR */
id|outw_p
c_func
(paren
l_int|0xfff8
comma
id|BRIDGE_ISA_INTR_MASK
)paren
suffix:semicolon
multiline_comment|/* Enable interrupt */
id|has_isa
op_assign
l_int|1
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;CqREEK Setup (IDE=%d, ISA=%d)...done&bslash;n&quot;
comma
id|has_ide
comma
id|has_isa
)paren
suffix:semicolon
)brace
"&f;"
multiline_comment|/*&n; * The Machine Vector&n; */
DECL|variable|__initmv
r_struct
id|sh_machine_vector
id|mv_cqreek
id|__initmv
op_assign
(brace
id|mv_name
suffix:colon
l_string|&quot;CqREEK&quot;
comma
macro_line|#if defined(__SH4__)
id|mv_nr_irqs
suffix:colon
l_int|48
comma
macro_line|#elif defined(CONFIG_CPU_SUBTYPE_SH7708)
id|mv_nr_irqs
suffix:colon
l_int|32
comma
macro_line|#elif defined(CONFIG_CPU_SUBTYPE_SH7709)
id|mv_nr_irqs
suffix:colon
l_int|61
comma
macro_line|#endif
id|mv_inb
suffix:colon
id|generic_inb
comma
id|mv_inw
suffix:colon
id|generic_inw
comma
id|mv_inl
suffix:colon
id|generic_inl
comma
id|mv_outb
suffix:colon
id|generic_outb
comma
id|mv_outw
suffix:colon
id|generic_outw
comma
id|mv_outl
suffix:colon
id|generic_outl
comma
id|mv_inb_p
suffix:colon
id|generic_inb_p
comma
id|mv_inw_p
suffix:colon
id|generic_inw_p
comma
id|mv_inl_p
suffix:colon
id|generic_inl_p
comma
id|mv_outb_p
suffix:colon
id|generic_outb_p
comma
id|mv_outw_p
suffix:colon
id|generic_outw_p
comma
id|mv_outl_p
suffix:colon
id|generic_outl_p
comma
id|mv_insb
suffix:colon
id|generic_insb
comma
id|mv_insw
suffix:colon
id|generic_insw
comma
id|mv_insl
suffix:colon
id|generic_insl
comma
id|mv_outsb
suffix:colon
id|generic_outsb
comma
id|mv_outsw
suffix:colon
id|generic_outsw
comma
id|mv_outsl
suffix:colon
id|generic_outsl
comma
id|mv_readb
suffix:colon
id|generic_readb
comma
id|mv_readw
suffix:colon
id|generic_readw
comma
id|mv_readl
suffix:colon
id|generic_readl
comma
id|mv_writeb
suffix:colon
id|generic_writeb
comma
id|mv_writew
suffix:colon
id|generic_writew
comma
id|mv_writel
suffix:colon
id|generic_writel
comma
id|mv_init_arch
suffix:colon
id|setup_cqreek
comma
id|mv_init_irq
suffix:colon
id|init_cqreek_IRQ
comma
id|mv_isa_port2addr
suffix:colon
id|cqreek_port2addr
comma
)brace
suffix:semicolon
id|ALIAS_MV
c_func
(paren
id|cqreek
)paren
eof
