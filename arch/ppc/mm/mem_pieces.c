multiline_comment|/*&n; *    Copyright (c) 1996 Paul Mackerras &lt;paulus@cs.anu.edu.au&gt;&n; *      Changes to accomodate Power Macintoshes.&n; *    Cort Dougan &lt;cort@cs.nmt.edu&gt;&n; *      Rewrites.&n; *    Grant Erickson &lt;grant@lcse.umn.edu&gt;&n; *      General rework and split from mm/init.c.&n; *&n; *    Module name: mem_pieces.c&n; *&n; *    Description:&n; *      Routines and data structures for manipulating and representing&n; *      phyiscal memory extents (i.e. address/length pairs).&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &quot;mem_pieces.h&quot;
r_extern
r_struct
id|mem_pieces
id|phys_avail
suffix:semicolon
r_static
r_void
id|mem_pieces_print
c_func
(paren
r_struct
id|mem_pieces
op_star
)paren
suffix:semicolon
multiline_comment|/*&n; * Scan a region for a piece of a given size with the required alignment.&n; */
r_void
id|__init
op_star
DECL|function|mem_pieces_find
id|mem_pieces_find
c_func
(paren
r_int
r_int
id|size
comma
r_int
r_int
id|align
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|a
comma
id|e
suffix:semicolon
r_struct
id|mem_pieces
op_star
id|mp
op_assign
op_amp
id|phys_avail
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|mp-&gt;n_regions
suffix:semicolon
op_increment
id|i
)paren
(brace
id|a
op_assign
id|mp-&gt;regions
(braket
id|i
)braket
dot
id|address
suffix:semicolon
id|e
op_assign
id|a
op_plus
id|mp-&gt;regions
(braket
id|i
)braket
dot
id|size
suffix:semicolon
id|a
op_assign
(paren
id|a
op_plus
id|align
op_minus
l_int|1
)paren
op_amp
op_minus
id|align
suffix:semicolon
r_if
c_cond
(paren
id|a
op_plus
id|size
op_le
id|e
)paren
(brace
id|mem_pieces_remove
c_func
(paren
id|mp
comma
id|a
comma
id|size
comma
l_int|1
)paren
suffix:semicolon
r_return
id|__va
c_func
(paren
id|a
)paren
suffix:semicolon
)brace
)brace
id|panic
c_func
(paren
l_string|&quot;Couldn&squot;t find %u bytes at %u alignment&bslash;n&quot;
comma
id|size
comma
id|align
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Remove some memory from an array of pieces&n; */
r_void
id|__init
DECL|function|mem_pieces_remove
id|mem_pieces_remove
c_func
(paren
r_struct
id|mem_pieces
op_star
id|mp
comma
r_int
r_int
id|start
comma
r_int
r_int
id|size
comma
r_int
id|must_exist
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_int
r_int
id|end
comma
id|rs
comma
id|re
suffix:semicolon
r_struct
id|reg_property
op_star
id|rp
suffix:semicolon
id|end
op_assign
id|start
op_plus
id|size
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|rp
op_assign
id|mp-&gt;regions
suffix:semicolon
id|i
OL
id|mp-&gt;n_regions
suffix:semicolon
op_increment
id|i
comma
op_increment
id|rp
)paren
(brace
r_if
c_cond
(paren
id|end
OG
id|rp-&gt;address
op_logical_and
id|start
OL
id|rp-&gt;address
op_plus
id|rp-&gt;size
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ge
id|mp-&gt;n_regions
)paren
(brace
r_if
c_cond
(paren
id|must_exist
)paren
id|printk
c_func
(paren
l_string|&quot;mem_pieces_remove: [%x,%x) not in any region&bslash;n&quot;
comma
id|start
comma
id|end
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
id|i
template_param
id|rp-&gt;address
suffix:semicolon
op_increment
id|i
comma
op_increment
id|rp
)paren
(brace
id|rs
op_assign
id|rp-&gt;address
suffix:semicolon
id|re
op_assign
id|rs
op_plus
id|rp-&gt;size
suffix:semicolon
r_if
c_cond
(paren
id|must_exist
op_logical_and
(paren
id|start
template_param
id|re
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;mem_pieces_remove: bad overlap [%x,%x) with&quot;
comma
id|start
comma
id|end
)paren
suffix:semicolon
id|mem_pieces_print
c_func
(paren
id|mp
)paren
suffix:semicolon
id|must_exist
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|start
OG
id|rs
)paren
(brace
id|rp-&gt;size
op_assign
id|start
op_minus
id|rs
suffix:semicolon
r_if
c_cond
(paren
id|end
OL
id|re
)paren
(brace
multiline_comment|/* need to split this entry */
r_if
c_cond
(paren
id|mp-&gt;n_regions
op_ge
id|MEM_PIECES_MAX
)paren
id|panic
c_func
(paren
l_string|&quot;eek... mem_pieces overflow&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
id|mp-&gt;n_regions
suffix:semicolon
id|j
OG
id|i
op_plus
l_int|1
suffix:semicolon
op_decrement
id|j
)paren
id|mp-&gt;regions
(braket
id|j
)braket
op_assign
id|mp-&gt;regions
(braket
id|j
op_minus
l_int|1
)braket
suffix:semicolon
op_increment
id|mp-&gt;n_regions
suffix:semicolon
id|rp
(braket
l_int|1
)braket
dot
id|address
op_assign
id|end
suffix:semicolon
id|rp
(braket
l_int|1
)braket
dot
id|size
op_assign
id|re
op_minus
id|end
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|end
OL
id|re
)paren
(brace
id|rp-&gt;address
op_assign
id|end
suffix:semicolon
id|rp-&gt;size
op_assign
id|re
op_minus
id|end
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* need to delete this entry */
r_for
c_loop
(paren
id|j
op_assign
id|i
suffix:semicolon
id|j
OL
id|mp-&gt;n_regions
op_minus
l_int|1
suffix:semicolon
op_increment
id|j
)paren
id|mp-&gt;regions
(braket
id|j
)braket
op_assign
id|mp-&gt;regions
(braket
id|j
op_plus
l_int|1
)braket
suffix:semicolon
op_decrement
id|mp-&gt;n_regions
suffix:semicolon
op_decrement
id|i
suffix:semicolon
op_decrement
id|rp
suffix:semicolon
)brace
)brace
)brace
)brace
r_static
r_void
id|__init
DECL|function|mem_pieces_print
id|mem_pieces_print
c_func
(paren
r_struct
id|mem_pieces
op_star
id|mp
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|mp-&gt;n_regions
suffix:semicolon
op_increment
id|i
)paren
id|printk
c_func
(paren
l_string|&quot; [%x, %x)&quot;
comma
id|mp-&gt;regions
(braket
id|i
)braket
dot
id|address
comma
id|mp-&gt;regions
(braket
id|i
)braket
dot
id|address
op_plus
id|mp-&gt;regions
(braket
id|i
)braket
dot
id|size
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#if defined(CONFIG_APUS) || defined(CONFIG_ALL_PPC)
multiline_comment|/*&n; * Add some memory to an array of pieces&n; */
r_void
id|__init
DECL|function|mem_pieces_append
id|mem_pieces_append
c_func
(paren
r_struct
id|mem_pieces
op_star
id|mp
comma
r_int
r_int
id|start
comma
r_int
r_int
id|size
)paren
(brace
r_struct
id|reg_property
op_star
id|rp
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;n_regions
op_ge
id|MEM_PIECES_MAX
)paren
r_return
suffix:semicolon
id|rp
op_assign
op_amp
id|mp-&gt;regions
(braket
id|mp-&gt;n_regions
op_increment
)braket
suffix:semicolon
id|rp-&gt;address
op_assign
id|start
suffix:semicolon
id|rp-&gt;size
op_assign
id|size
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_APUS || CONFIG_ALL_PPC */
r_void
id|__init
DECL|function|mem_pieces_sort
id|mem_pieces_sort
c_func
(paren
r_struct
id|mem_pieces
op_star
id|mp
)paren
(brace
r_int
r_int
id|a
comma
id|s
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|mp-&gt;n_regions
suffix:semicolon
op_increment
id|i
)paren
(brace
id|a
op_assign
id|mp-&gt;regions
(braket
id|i
)braket
dot
id|address
suffix:semicolon
id|s
op_assign
id|mp-&gt;regions
(braket
id|i
)braket
dot
id|size
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
id|i
op_minus
l_int|1
suffix:semicolon
id|j
op_ge
l_int|0
suffix:semicolon
op_decrement
id|j
)paren
(brace
r_if
c_cond
(paren
id|a
op_ge
id|mp-&gt;regions
(braket
id|j
)braket
dot
id|address
)paren
r_break
suffix:semicolon
id|mp-&gt;regions
(braket
id|j
op_plus
l_int|1
)braket
op_assign
id|mp-&gt;regions
(braket
id|j
)braket
suffix:semicolon
)brace
id|mp-&gt;regions
(braket
id|j
op_plus
l_int|1
)braket
dot
id|address
op_assign
id|a
suffix:semicolon
id|mp-&gt;regions
(braket
id|j
op_plus
l_int|1
)braket
dot
id|size
op_assign
id|s
suffix:semicolon
)brace
)brace
r_void
id|__init
DECL|function|mem_pieces_coalesce
id|mem_pieces_coalesce
c_func
(paren
r_struct
id|mem_pieces
op_star
id|mp
)paren
(brace
r_int
r_int
id|a
comma
id|s
comma
id|ns
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|d
suffix:semicolon
id|d
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|mp-&gt;n_regions
suffix:semicolon
id|i
op_assign
id|j
)paren
(brace
id|a
op_assign
id|mp-&gt;regions
(braket
id|i
)braket
dot
id|address
suffix:semicolon
id|s
op_assign
id|mp-&gt;regions
(braket
id|i
)braket
dot
id|size
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
id|i
op_plus
l_int|1
suffix:semicolon
id|j
OL
id|mp-&gt;n_regions
op_logical_and
id|mp-&gt;regions
(braket
id|j
)braket
dot
id|address
op_minus
id|a
op_le
id|s
suffix:semicolon
op_increment
id|j
)paren
(brace
id|ns
op_assign
id|mp-&gt;regions
(braket
id|j
)braket
dot
id|address
op_plus
id|mp-&gt;regions
(braket
id|j
)braket
dot
id|size
op_minus
id|a
suffix:semicolon
r_if
c_cond
(paren
id|ns
OG
id|s
)paren
id|s
op_assign
id|ns
suffix:semicolon
)brace
id|mp-&gt;regions
(braket
id|d
)braket
dot
id|address
op_assign
id|a
suffix:semicolon
id|mp-&gt;regions
(braket
id|d
)braket
dot
id|size
op_assign
id|s
suffix:semicolon
op_increment
id|d
suffix:semicolon
)brace
id|mp-&gt;n_regions
op_assign
id|d
suffix:semicolon
)brace
eof
