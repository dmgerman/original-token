multiline_comment|/*&n; *  ARCH/ppc/mm/fault.c&n; *&n; *  Copyright (C) 1991, 1992, 1993, 1994  Linus Torvalds&n; *  Ported to PPC by Gary Thomas&n; *  Modified by Cort Dougan (cort@cs.nmt.edu) &n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/head.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/mman.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
r_extern
r_void
id|die_if_kernel
c_func
(paren
r_char
op_star
comma
r_struct
id|pt_regs
op_star
comma
r_int
)paren
suffix:semicolon
r_extern
r_void
id|do_page_fault
c_func
(paren
r_struct
id|pt_regs
op_star
comma
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
r_void
id|new_page_fault
c_func
(paren
r_int
r_int
id|address
comma
r_int
r_int
id|code
comma
r_int
r_int
id|text
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
DECL|macro|SHOW_FAULTS
macro_line|#undef SHOW_FAULTS
DECL|macro|NOISY_INSTRFAULT
macro_line|#undef NOISY_INSTRFAULT
DECL|macro|NOISY_DATAFAULT
macro_line|#undef NOISY_DATAFAULT
DECL|variable|probingmem
r_int
r_int
id|probingmem
op_assign
l_int|0
suffix:semicolon
DECL|macro|NEWMM
mdefine_line|#define NEWMM 1
DECL|function|new_page_fault
r_void
id|new_page_fault
c_func
(paren
r_int
r_int
id|address
comma
r_int
r_int
id|ppc_code
comma
r_int
r_int
id|text
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|vm_area_struct
op_star
id|vma
suffix:semicolon
r_struct
id|mm_struct
op_star
id|mm
op_assign
id|current-&gt;mm
suffix:semicolon
r_int
id|intel_code
op_assign
l_int|0
suffix:semicolon
id|pgd_t
op_star
id|dir
suffix:semicolon
id|pmd_t
op_star
id|pmd
suffix:semicolon
id|pte_t
op_star
id|pte
suffix:semicolon
multiline_comment|/*&n;   *&t;bit 0 == 0 means no page found, 1 means protection fault&n;   *&t;bit 1 == 0 means read, 1 means write&n;   *&t;bit 2 == 0 means kernel, 1 means user-mode&n;   */
r_if
c_cond
(paren
id|user_mode
c_func
(paren
id|regs
)paren
)paren
id|intel_code
op_or_assign
l_int|0x04
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|text
op_logical_and
(paren
id|ppc_code
op_amp
l_int|0x02000000
)paren
)paren
id|intel_code
op_or_assign
l_int|0x02
suffix:semicolon
multiline_comment|/* Load/store */
r_if
c_cond
(paren
op_logical_neg
id|text
op_logical_and
(paren
id|ppc_code
op_amp
l_int|0x08000000
)paren
)paren
(brace
id|intel_code
op_or_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* prot viol */
r_goto
id|do_page
suffix:semicolon
)brace
id|dir
op_assign
id|pgd_offset
c_func
(paren
id|mm
comma
id|address
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dir
)paren
(brace
id|pmd
op_assign
id|pmd_offset
c_func
(paren
id|dir
comma
id|address
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pmd
op_logical_and
id|pmd_present
c_func
(paren
op_star
id|pmd
)paren
)paren
(brace
id|pte
op_assign
id|pte_offset
c_func
(paren
id|pmd
comma
id|address
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pte
op_logical_and
id|pte_present
c_func
(paren
op_star
id|pte
)paren
)paren
(brace
id|MMU_hash_page
c_func
(paren
op_amp
id|current-&gt;tss
comma
id|address
op_amp
id|PAGE_MASK
comma
id|pte
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
)brace
id|do_page
suffix:colon
id|down
c_func
(paren
op_amp
id|mm-&gt;mmap_sem
)paren
suffix:semicolon
id|vma
op_assign
id|find_vma
c_func
(paren
id|current-&gt;mm
comma
id|address
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vma
)paren
r_goto
id|bad_area
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_start
op_le
id|address
)paren
r_goto
id|good_area
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_GROWSDOWN
)paren
)paren
r_goto
id|bad_area
suffix:semicolon
r_if
c_cond
(paren
id|expand_stack
c_func
(paren
id|vma
comma
id|address
)paren
)paren
r_goto
id|bad_area
suffix:semicolon
id|good_area
suffix:colon
multiline_comment|/* a write */
r_if
c_cond
(paren
id|intel_code
op_amp
l_int|2
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_WRITE
)paren
)paren
(brace
r_goto
id|bad_area
suffix:semicolon
)brace
multiline_comment|/* a read */
)brace
r_else
(brace
multiline_comment|/* protection fault */
r_if
c_cond
(paren
id|intel_code
op_amp
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;prot fault&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|bad_area
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|vma-&gt;vm_flags
op_amp
(paren
id|VM_READ
op_or
id|VM_EXEC
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;no read or exec&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|bad_area
suffix:semicolon
)brace
)brace
id|handle_mm_fault
c_func
(paren
id|vma
comma
id|address
comma
id|intel_code
op_amp
l_int|2
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|mm-&gt;mmap_sem
)paren
suffix:semicolon
id|flush_page
c_func
(paren
id|address
)paren
suffix:semicolon
multiline_comment|/* Flush &amp; Invalidate cache - note: address is OK now */
r_return
suffix:semicolon
id|bad_area
suffix:colon
id|up
c_func
(paren
op_amp
id|mm-&gt;mmap_sem
)paren
suffix:semicolon
multiline_comment|/* Did we have an exception handler installed? */
r_if
c_cond
(paren
id|current-&gt;tss.excount
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|user_mode
c_func
(paren
id|regs
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Exception signalled from user mode!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
macro_line|#if 0      
id|printk
c_func
(paren
l_string|&quot;Exception from kernel mode. pc %x expc %x count %d&bslash;n&quot;
comma
id|regs-&gt;nip
comma
id|current-&gt;tss.expc
comma
id|current-&gt;tss.excount
)paren
suffix:semicolon
macro_line|#endif      
id|current-&gt;tss.excount
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;gpr
(braket
l_int|3
)braket
op_assign
op_minus
id|EFAULT
suffix:semicolon
id|regs-&gt;nip
op_assign
id|current-&gt;tss.expc
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|user_mode
c_func
(paren
id|regs
)paren
)paren
(brace
id|force_sig
c_func
(paren
id|SIGSEGV
comma
id|current
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|panic
c_func
(paren
l_string|&quot;KERNEL access of bad area PC %x address %x vm_flags %x&bslash;n&quot;
comma
id|regs-&gt;nip
comma
id|address
comma
id|vma-&gt;vm_flags
)paren
suffix:semicolon
)brace
DECL|function|va_to_phys
id|va_to_phys
c_func
(paren
r_int
r_int
id|address
)paren
(brace
id|pgd_t
op_star
id|dir
suffix:semicolon
id|pmd_t
op_star
id|pmd
suffix:semicolon
id|pte_t
op_star
id|pte
suffix:semicolon
id|dir
op_assign
id|pgd_offset
c_func
(paren
id|current-&gt;mm
comma
id|address
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dir
)paren
(brace
id|pmd
op_assign
id|pmd_offset
c_func
(paren
id|dir
comma
id|address
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pmd
op_logical_and
id|pmd_present
c_func
(paren
op_star
id|pmd
)paren
)paren
(brace
id|pte
op_assign
id|pte_offset
c_func
(paren
id|pmd
comma
id|address
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pte
op_logical_and
id|pte_present
c_func
(paren
op_star
id|pte
)paren
)paren
(brace
r_return
id|pte_page
c_func
(paren
op_star
id|pte
)paren
op_or
(paren
id|address
op_amp
op_complement
(paren
id|PAGE_MASK
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_inline
r_void
DECL|function|update_mmu_cache
id|update_mmu_cache
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|address
comma
id|pte_t
id|_pte
)paren
(brace
id|MMU_hash_page
c_func
(paren
op_amp
id|current-&gt;tss
comma
id|address
op_amp
id|PAGE_MASK
comma
(paren
id|pte
op_star
)paren
op_amp
id|_pte
)paren
suffix:semicolon
)brace
eof
