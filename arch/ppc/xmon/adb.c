multiline_comment|/*&n; * Copyright (C) 1996 Paul Mackerras.&n; */
macro_line|#include &quot;nonstdio.h&quot;
macro_line|#include &quot;privinst.h&quot;
DECL|macro|scanhex
mdefine_line|#define scanhex&t;xmon_scanhex
DECL|macro|skipbl
mdefine_line|#define skipbl&t;xmon_skipbl
DECL|macro|ADB_B
mdefine_line|#define ADB_B&t;&t;(*(volatile unsigned char *)0xf3016000)
DECL|macro|ADB_SR
mdefine_line|#define ADB_SR&t;&t;(*(volatile unsigned char *)0xf3017400)
DECL|macro|ADB_ACR
mdefine_line|#define ADB_ACR&t;&t;(*(volatile unsigned char *)0xf3017600)
DECL|macro|ADB_IFR
mdefine_line|#define ADB_IFR&t;&t;(*(volatile unsigned char *)0xf3017a00)
DECL|function|eieio
r_static
r_inline
r_void
id|eieio
c_func
(paren
r_void
)paren
(brace
id|asm
r_volatile
(paren
l_string|&quot;eieio&quot;
suffix:colon
suffix:colon
)paren
suffix:semicolon
)brace
DECL|macro|N_ADB_LOG
mdefine_line|#define N_ADB_LOG&t;1000
DECL|struct|adb_log
r_struct
id|adb_log
(brace
DECL|member|b
r_int
r_char
id|b
suffix:semicolon
DECL|member|ifr
r_int
r_char
id|ifr
suffix:semicolon
DECL|member|acr
r_int
r_char
id|acr
suffix:semicolon
DECL|member|time
r_int
r_int
id|time
suffix:semicolon
DECL|variable|adb_log
)brace
id|adb_log
(braket
id|N_ADB_LOG
)braket
suffix:semicolon
DECL|variable|n_adb_log
r_int
id|n_adb_log
suffix:semicolon
r_void
DECL|function|init_adb_log
id|init_adb_log
c_func
(paren
r_void
)paren
(brace
id|adb_log
(braket
l_int|0
)braket
dot
id|b
op_assign
id|ADB_B
suffix:semicolon
id|adb_log
(braket
l_int|0
)braket
dot
id|ifr
op_assign
id|ADB_IFR
suffix:semicolon
id|adb_log
(braket
l_int|0
)braket
dot
id|acr
op_assign
id|ADB_ACR
suffix:semicolon
id|adb_log
(braket
l_int|0
)braket
dot
id|time
op_assign
id|get_dec
c_func
(paren
)paren
suffix:semicolon
id|n_adb_log
op_assign
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|dump_adb_log
id|dump_adb_log
c_func
(paren
r_void
)paren
(brace
r_int
id|t
comma
id|t0
suffix:semicolon
r_struct
id|adb_log
op_star
id|ap
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ap
op_assign
id|adb_log
suffix:semicolon
id|t0
op_assign
id|ap-&gt;time
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|n_adb_log
suffix:semicolon
op_increment
id|i
comma
op_increment
id|ap
)paren
(brace
id|t
op_assign
id|t0
op_minus
id|ap-&gt;time
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;b=%x ifr=%x acr=%x at %d.%.7d&bslash;n&quot;
comma
id|ap-&gt;b
comma
id|ap-&gt;ifr
comma
id|ap-&gt;acr
comma
id|t
op_div
l_int|1000000000
comma
(paren
id|t
op_mod
l_int|1000000000
)paren
op_div
l_int|100
)paren
suffix:semicolon
)brace
)brace
r_void
DECL|function|adb_chklog
id|adb_chklog
c_func
(paren
r_void
)paren
(brace
r_struct
id|adb_log
op_star
id|ap
op_assign
op_amp
id|adb_log
(braket
id|n_adb_log
op_plus
l_int|1
)braket
suffix:semicolon
id|ap-&gt;b
op_assign
id|ADB_B
suffix:semicolon
id|ap-&gt;ifr
op_assign
id|ADB_IFR
suffix:semicolon
id|ap-&gt;acr
op_assign
id|ADB_ACR
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;b
op_ne
id|ap
(braket
op_minus
l_int|1
)braket
dot
id|b
op_logical_or
(paren
id|ap-&gt;ifr
op_amp
l_int|4
)paren
op_ne
(paren
id|ap
(braket
op_minus
l_int|1
)braket
dot
id|ifr
op_amp
l_int|4
)paren
op_logical_or
id|ap-&gt;acr
op_ne
id|ap
(braket
op_minus
l_int|1
)braket
dot
id|acr
)paren
(brace
id|ap-&gt;time
op_assign
id|get_dec
c_func
(paren
)paren
suffix:semicolon
op_increment
id|n_adb_log
suffix:semicolon
)brace
)brace
r_int
DECL|function|adb_bitwait
id|adb_bitwait
c_func
(paren
r_int
id|bmask
comma
r_int
id|bval
comma
r_int
id|fmask
comma
r_int
id|fval
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|adb_log
op_star
id|ap
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|10000
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
op_decrement
id|i
)paren
(brace
id|adb_chklog
c_func
(paren
)paren
suffix:semicolon
id|ap
op_assign
op_amp
id|adb_log
(braket
id|n_adb_log
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ap-&gt;b
op_amp
id|bmask
)paren
op_eq
id|bval
op_logical_and
(paren
id|ap-&gt;ifr
op_amp
id|fmask
)paren
op_eq
id|fval
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_int
DECL|function|adb_wait
id|adb_wait
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|adb_bitwait
c_func
(paren
l_int|0
comma
l_int|0
comma
l_int|4
comma
l_int|4
)paren
OL
l_int|0
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;adb: ready wait timeout&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|adb_readin
id|adb_readin
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_int
r_char
id|d
(braket
l_int|64
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ADB_B
op_amp
l_int|8
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;ADB_B: %x&bslash;n&quot;
comma
id|ADB_B
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|i
op_assign
l_int|0
suffix:semicolon
id|adb_wait
c_func
(paren
)paren
suffix:semicolon
id|j
op_assign
id|ADB_SR
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|ADB_B
op_and_assign
op_complement
l_int|0x20
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|adb_wait
c_func
(paren
)paren
OL
l_int|0
)paren
r_break
suffix:semicolon
id|d
(braket
id|i
op_increment
)braket
op_assign
id|ADB_SR
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ADB_B
op_amp
l_int|8
)paren
r_break
suffix:semicolon
id|ADB_B
op_xor_assign
l_int|0x10
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
)brace
id|ADB_B
op_or_assign
l_int|0x30
suffix:semicolon
r_if
c_cond
(paren
id|adb_wait
c_func
(paren
)paren
op_eq
l_int|0
)paren
id|j
op_assign
id|ADB_SR
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|i
suffix:semicolon
op_increment
id|j
)paren
id|printf
c_func
(paren
l_string|&quot;%.2x &quot;
comma
id|d
(braket
id|j
)braket
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_int
DECL|function|adb_write
id|adb_write
c_func
(paren
r_int
r_char
op_star
id|d
comma
r_int
id|i
)paren
(brace
r_int
id|j
suffix:semicolon
r_int
id|x
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ADB_B
op_amp
l_int|8
)paren
op_eq
l_int|0
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;r: &quot;
)paren
suffix:semicolon
id|adb_readin
c_func
(paren
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|ADB_ACR
op_assign
l_int|0x1c
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|ADB_SR
op_assign
id|d
(braket
l_int|0
)braket
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|ADB_B
op_and_assign
op_complement
l_int|0x20
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ADB_B
op_amp
l_int|8
)paren
r_break
suffix:semicolon
id|ADB_ACR
op_assign
l_int|0xc
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|ADB_B
op_or_assign
l_int|0x20
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|adb_readin
c_func
(paren
)paren
suffix:semicolon
)brace
id|adb_wait
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|1
suffix:semicolon
id|j
OL
id|i
suffix:semicolon
op_increment
id|j
)paren
(brace
id|ADB_SR
op_assign
id|d
(braket
id|j
)braket
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|ADB_B
op_xor_assign
l_int|0x10
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adb_wait
c_func
(paren
)paren
OL
l_int|0
)paren
r_break
suffix:semicolon
)brace
id|ADB_ACR
op_assign
l_int|0xc
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|x
op_assign
id|ADB_SR
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|ADB_B
op_or_assign
l_int|0x30
suffix:semicolon
r_return
id|j
suffix:semicolon
)brace
r_void
DECL|function|adbcmds
id|adbcmds
c_func
(paren
r_void
)paren
(brace
r_char
id|cmd
suffix:semicolon
r_int
id|rtcu
comma
id|rtcl
comma
id|dec
comma
id|pdec
comma
id|x
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
r_int
r_char
id|d
(braket
l_int|64
)braket
suffix:semicolon
id|cmd
op_assign
id|skipbl
c_func
(paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
l_char|&squot;t&squot;
suffix:colon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|rtcl
op_assign
id|get_rtcl
c_func
(paren
)paren
suffix:semicolon
id|rtcu
op_assign
id|get_rtcu
c_func
(paren
)paren
suffix:semicolon
id|dec
op_assign
id|get_dec
c_func
(paren
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;rtc u=%u l=%u dec=%x (%d = %d.%.7d)&bslash;n&quot;
comma
id|rtcu
comma
id|rtcl
comma
id|dec
comma
id|pdec
op_minus
id|dec
comma
(paren
id|pdec
op_minus
id|dec
)paren
op_div
l_int|1000000000
comma
(paren
(paren
id|pdec
op_minus
id|dec
)paren
op_mod
l_int|1000000000
)paren
op_div
l_int|100
)paren
suffix:semicolon
id|pdec
op_assign
id|dec
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
l_char|&squot;x&squot;
)paren
r_break
suffix:semicolon
r_while
c_loop
(paren
id|xmon_read
c_func
(paren
id|stdin
comma
op_amp
id|cmd
comma
l_int|1
)paren
op_ne
l_int|1
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_char|&squot;r&squot;
suffix:colon
id|init_adb_log
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|adb_bitwait
c_func
(paren
l_int|8
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
op_eq
l_int|0
)paren
id|adb_readin
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;w&squot;
suffix:colon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|scanhex
c_func
(paren
op_amp
id|x
)paren
)paren
id|d
(braket
id|i
op_increment
)braket
op_assign
id|x
suffix:semicolon
id|init_adb_log
c_func
(paren
)paren
suffix:semicolon
id|j
op_assign
id|adb_write
c_func
(paren
id|d
comma
id|i
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;sent %d bytes&bslash;n&quot;
comma
id|j
)paren
suffix:semicolon
r_while
c_loop
(paren
id|adb_bitwait
c_func
(paren
l_int|8
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
op_eq
l_int|0
)paren
id|adb_readin
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;l&squot;
suffix:colon
id|dump_adb_log
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
eof
