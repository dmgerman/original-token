multiline_comment|/* Board specific functions for those embedded 8xx boards that do&n; * not have boot monitor support for board information.&n; */
macro_line|#include &lt;sys/types.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#ifdef CONFIG_8xx
macro_line|#include &lt;asm/mpc8xx.h&gt;
macro_line|#endif
macro_line|#ifdef CONFIG_8260
macro_line|#include &lt;asm/mpc8260.h&gt;
macro_line|#endif
multiline_comment|/* IIC functions.&n; * These are just the basic master read/write operations so we can&n; * examine serial EEPROM.&n; */
r_extern
r_void
id|iic_read
c_func
(paren
id|uint
id|devaddr
comma
id|u_char
op_star
id|buf
comma
id|uint
id|offset
comma
id|uint
id|count
)paren
suffix:semicolon
r_extern
id|u_char
id|aschex_to_byte
c_func
(paren
id|u_char
op_star
id|cp
)paren
suffix:semicolon
multiline_comment|/* Supply a default Ethernet address for those eval boards that don&squot;t&n; * ship with one.  This is an address from the MBX board I have, so&n; * it is unlikely you will find it on your network.&n; */
DECL|variable|def_enet_addr
r_static
id|ushort
id|def_enet_addr
(braket
)braket
op_assign
(brace
l_int|0x0800
comma
l_int|0x3e26
comma
l_int|0x1559
)brace
suffix:semicolon
macro_line|#if defined(CONFIG_RPXLITE) || defined(CONFIG_RPXCLASSIC)
r_static
r_void
id|rpx_eth
c_func
(paren
id|bd_t
op_star
id|bd
comma
id|u_char
op_star
id|cp
)paren
suffix:semicolon
r_static
r_void
id|rpx_brate
c_func
(paren
id|bd_t
op_star
id|bd
comma
id|u_char
op_star
id|cp
)paren
suffix:semicolon
r_static
r_void
id|rpx_memsize
c_func
(paren
id|bd_t
op_star
id|bd
comma
id|u_char
op_star
id|cp
)paren
suffix:semicolon
r_static
r_void
id|rpx_cpuspeed
c_func
(paren
id|bd_t
op_star
id|bd
comma
id|u_char
op_star
id|cp
)paren
suffix:semicolon
multiline_comment|/* Read the EEPROM on the RPX-Lite board.&n;*/
r_void
DECL|function|rpx_cfg
id|rpx_cfg
c_func
(paren
id|bd_t
op_star
id|bd
)paren
(brace
id|u_char
id|eebuf
(braket
l_int|256
)braket
comma
op_star
id|cp
suffix:semicolon
multiline_comment|/* Read the first 256 bytes of the EEPROM.  I think this&n;&t; * is really all there is, and I hope if it gets bigger the&n;&t; * info we want is still up front.&n;&t; */
macro_line|#if 1
id|iic_read
c_func
(paren
l_int|0xa8
comma
id|eebuf
comma
l_int|0
comma
l_int|128
)paren
suffix:semicolon
id|iic_read
c_func
(paren
l_int|0xa8
comma
op_amp
id|eebuf
(braket
l_int|128
)braket
comma
l_int|128
comma
l_int|128
)paren
suffix:semicolon
(brace
r_int
id|i
suffix:semicolon
id|cp
op_assign
(paren
id|u_char
op_star
)paren
l_int|0xfa000000
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_increment
)paren
op_star
id|cp
op_increment
op_assign
id|eebuf
(braket
id|i
)braket
suffix:semicolon
)brace
multiline_comment|/* We look for two things, the Ethernet address and the&n;&t; * serial baud rate.  The records are separated by&n;&t; * newlines.&n;&t; */
id|cp
op_assign
id|eebuf
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
op_star
id|cp
op_eq
l_char|&squot;E&squot;
)paren
(brace
id|cp
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_star
id|cp
op_eq
l_char|&squot;A&squot;
)paren
(brace
id|cp
op_add_assign
l_int|2
suffix:semicolon
id|rpx_eth
c_func
(paren
id|bd
comma
id|cp
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_star
id|cp
op_eq
l_char|&squot;S&squot;
)paren
(brace
id|cp
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_star
id|cp
op_eq
l_char|&squot;B&squot;
)paren
(brace
id|cp
op_add_assign
l_int|2
suffix:semicolon
id|rpx_brate
c_func
(paren
id|bd
comma
id|cp
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_star
id|cp
op_eq
l_char|&squot;D&squot;
)paren
(brace
id|cp
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_star
id|cp
op_eq
l_char|&squot;1&squot;
)paren
(brace
id|cp
op_add_assign
l_int|2
suffix:semicolon
id|rpx_memsize
c_func
(paren
id|bd
comma
id|cp
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_star
id|cp
op_eq
l_char|&squot;H&squot;
)paren
(brace
id|cp
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_star
id|cp
op_eq
l_char|&squot;Z&squot;
)paren
(brace
id|cp
op_add_assign
l_int|2
suffix:semicolon
id|rpx_cpuspeed
c_func
(paren
id|bd
comma
id|cp
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Scan to the end of the record.&n;&t;&t;*/
r_while
c_loop
(paren
(paren
op_star
id|cp
op_ne
l_char|&squot;&bslash;n&squot;
)paren
op_logical_and
(paren
op_star
id|cp
op_ne
l_int|0xff
)paren
)paren
id|cp
op_increment
suffix:semicolon
multiline_comment|/* If the next character is a 0 or ff, we are done.&n;&t;&t;*/
id|cp
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|cp
op_eq
l_int|0
)paren
op_logical_or
(paren
op_star
id|cp
op_eq
l_int|0xff
)paren
)paren
r_break
suffix:semicolon
)brace
id|bd-&gt;bi_memstart
op_assign
l_int|0
suffix:semicolon
macro_line|#else
multiline_comment|/* For boards without initialized EEPROM.&n;&t;*/
id|bd-&gt;bi_memstart
op_assign
l_int|0
suffix:semicolon
id|bd-&gt;bi_memsize
op_assign
(paren
l_int|8
op_star
l_int|1024
op_star
l_int|1024
)paren
suffix:semicolon
id|bd-&gt;bi_intfreq
op_assign
l_int|48
suffix:semicolon
id|bd-&gt;bi_busfreq
op_assign
l_int|48
suffix:semicolon
id|bd-&gt;bi_baudrate
op_assign
l_int|9600
suffix:semicolon
macro_line|#endif
)brace
r_static
r_void
DECL|function|rpx_eth
id|rpx_eth
c_func
(paren
id|bd_t
op_star
id|bd
comma
id|u_char
op_star
id|cp
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|bd-&gt;bi_enetaddr
(braket
id|i
)braket
op_assign
id|aschex_to_byte
c_func
(paren
id|cp
)paren
suffix:semicolon
id|cp
op_add_assign
l_int|2
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|rpx_brate
id|rpx_brate
c_func
(paren
id|bd_t
op_star
id|bd
comma
id|u_char
op_star
id|cp
)paren
(brace
id|uint
id|rate
suffix:semicolon
id|rate
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_star
id|cp
op_ne
l_char|&squot;&bslash;n&squot;
)paren
(brace
id|rate
op_mul_assign
l_int|10
suffix:semicolon
id|rate
op_add_assign
(paren
op_star
id|cp
)paren
op_minus
l_char|&squot;0&squot;
suffix:semicolon
id|cp
op_increment
suffix:semicolon
)brace
id|bd-&gt;bi_baudrate
op_assign
id|rate
op_star
l_int|100
suffix:semicolon
)brace
r_static
r_void
DECL|function|rpx_memsize
id|rpx_memsize
c_func
(paren
id|bd_t
op_star
id|bd
comma
id|u_char
op_star
id|cp
)paren
(brace
id|uint
id|size
suffix:semicolon
id|size
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_star
id|cp
op_ne
l_char|&squot;&bslash;n&squot;
)paren
(brace
id|size
op_mul_assign
l_int|10
suffix:semicolon
id|size
op_add_assign
(paren
op_star
id|cp
)paren
op_minus
l_char|&squot;0&squot;
suffix:semicolon
id|cp
op_increment
suffix:semicolon
)brace
id|bd-&gt;bi_memsize
op_assign
id|size
op_star
l_int|1024
op_star
l_int|1024
suffix:semicolon
)brace
r_static
r_void
DECL|function|rpx_cpuspeed
id|rpx_cpuspeed
c_func
(paren
id|bd_t
op_star
id|bd
comma
id|u_char
op_star
id|cp
)paren
(brace
id|uint
id|num
comma
id|den
suffix:semicolon
id|num
op_assign
id|den
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_star
id|cp
op_ne
l_char|&squot;&bslash;n&squot;
)paren
(brace
id|num
op_mul_assign
l_int|10
suffix:semicolon
id|num
op_add_assign
(paren
op_star
id|cp
)paren
op_minus
l_char|&squot;0&squot;
suffix:semicolon
id|cp
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_star
id|cp
op_eq
l_char|&squot;/&squot;
)paren
(brace
id|cp
op_increment
suffix:semicolon
id|den
op_assign
(paren
op_star
id|cp
)paren
op_minus
l_char|&squot;0&squot;
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* I don&squot;t know why the RPX just can&squot;t state the actual&n;&t; * CPU speed.....&n;&t; */
r_if
c_cond
(paren
id|den
)paren
(brace
id|num
op_div_assign
id|den
suffix:semicolon
id|num
op_mul_assign
id|den
suffix:semicolon
)brace
id|bd-&gt;bi_intfreq
op_assign
id|bd-&gt;bi_busfreq
op_assign
id|num
suffix:semicolon
multiline_comment|/* The 8xx can only run a maximum 50 MHz bus speed (until&n;&t; * Motorola changes this :-).  Greater than 50 MHz parts&n;&t; * run internal/2 for bus speed.&n;&t; */
r_if
c_cond
(paren
id|num
OG
l_int|50
)paren
id|bd-&gt;bi_busfreq
op_div_assign
l_int|2
suffix:semicolon
)brace
macro_line|#endif /* RPXLITE || RPXCLASSIC */
macro_line|#ifdef CONFIG_BSEIP
multiline_comment|/* Build a board information structure for the BSE ip-Engine.&n; * There is more to come since we will add some environment&n; * variables and a function to read them.&n; */
r_void
DECL|function|bseip_cfg
id|bseip_cfg
c_func
(paren
id|bd_t
op_star
id|bd
)paren
(brace
id|u_char
op_star
id|cp
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Baud rate and processor speed will eventually come&n;&t; * from the environment variables.&n;&t; */
id|bd-&gt;bi_baudrate
op_assign
l_int|9600
suffix:semicolon
multiline_comment|/* Get the Ethernet station address from the Flash ROM.&n;&t;*/
id|cp
op_assign
(paren
id|u_char
op_star
)paren
l_int|0xfe003ffa
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|bd-&gt;bi_enetaddr
(braket
id|i
)braket
op_assign
op_star
id|cp
op_increment
suffix:semicolon
)brace
multiline_comment|/* The rest of this should come from the environment as well.&n;&t;*/
id|bd-&gt;bi_memstart
op_assign
l_int|0
suffix:semicolon
id|bd-&gt;bi_memsize
op_assign
(paren
l_int|16
op_star
l_int|1024
op_star
l_int|1024
)paren
suffix:semicolon
id|bd-&gt;bi_intfreq
op_assign
l_int|48
suffix:semicolon
id|bd-&gt;bi_busfreq
op_assign
l_int|48
suffix:semicolon
)brace
macro_line|#endif /* BSEIP */
macro_line|#ifdef CONFIG_EST8260
r_void
DECL|function|embed_config
id|embed_config
c_func
(paren
id|bd_t
op_star
id|bd
)paren
(brace
id|u_char
op_star
id|cp
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#if 0
multiline_comment|/* This is actually provided by my boot rom.  I have it&n;&t; * here for those people that may load the kernel with&n;&t; * a JTAG/COP tool and not the rom monitor.&n;&t; */
id|bd-&gt;bi_baudrate
op_assign
l_int|115200
suffix:semicolon
id|bd-&gt;bi_intfreq
op_assign
l_int|200
suffix:semicolon
id|bd-&gt;bi_busfreq
op_assign
l_int|66
suffix:semicolon
id|bd-&gt;bi_cpmfreq
op_assign
l_int|66
suffix:semicolon
id|bd-&gt;bi_brgfreq
op_assign
l_int|33
suffix:semicolon
id|bd-&gt;bi_memsize
op_assign
l_int|16
op_star
l_int|1024
op_star
l_int|1024
suffix:semicolon
macro_line|#endif
id|cp
op_assign
(paren
id|u_char
op_star
)paren
id|def_enet_addr
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|bd-&gt;bi_enetaddr
(braket
id|i
)braket
op_assign
op_star
id|cp
op_increment
suffix:semicolon
)brace
)brace
macro_line|#endif /* EST8260 */
eof
