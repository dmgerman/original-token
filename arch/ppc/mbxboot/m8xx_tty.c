multiline_comment|/* Minimal serial functions needed to send messages out the serial&n; * port on the MBX console.&n; *&n; * The MBX uxes SMC1 for the serial port.  We reset the port and use&n; * only the first BD that EPPC-Bug set up as a character FIFO.&n; *&n; * Later versions (at least 1.4, maybe earlier) of the MBX EPPC-Bug&n; * use COM1 instead of SMC1 as the console port.  This kinda sucks&n; * for the rest of the kernel, so here we force the use of SMC1 again.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/mpc8xx.h&gt;
macro_line|#include &quot;../8xx_io/commproc.h&quot;
macro_line|#ifdef CONFIG_MBX
DECL|macro|MBX_CSR1
mdefine_line|#define MBX_CSR1&t;((volatile u_char *)0xfa100000)
DECL|macro|CSR1_COMEN
mdefine_line|#define CSR1_COMEN&t;(u_char)0x02
macro_line|#endif
macro_line|#ifdef TQM_SMC2_CONSOLE
DECL|macro|PROFF_CONS
mdefine_line|#define PROFF_CONS&t;PROFF_SMC2
DECL|macro|CPM_CR_CH_CONS
mdefine_line|#define CPM_CR_CH_CONS&t;CPM_CR_CH_SMC2
DECL|macro|SMC_INDEX
mdefine_line|#define SMC_INDEX&t;1
DECL|variable|iopp
r_static
r_volatile
id|iop8xx_t
op_star
id|iopp
op_assign
(paren
id|iop8xx_t
op_star
)paren
op_amp
(paren
(paren
(paren
id|immap_t
op_star
)paren
id|IMAP_ADDR
)paren
op_member_access_from_pointer
id|im_ioport
)paren
suffix:semicolon
macro_line|#else
DECL|macro|PROFF_CONS
mdefine_line|#define PROFF_CONS&t;PROFF_SMC1
DECL|macro|CPM_CR_CH_CONS
mdefine_line|#define CPM_CR_CH_CONS&t;CPM_CR_CH_SMC1
DECL|macro|SMC_INDEX
mdefine_line|#define SMC_INDEX&t;0
macro_line|#endif
DECL|variable|cpmp
r_static
id|cpm8xx_t
op_star
id|cpmp
op_assign
(paren
id|cpm8xx_t
op_star
)paren
op_amp
(paren
(paren
(paren
id|immap_t
op_star
)paren
id|IMAP_ADDR
)paren
op_member_access_from_pointer
id|im_cpm
)paren
suffix:semicolon
r_void
DECL|function|serial_init
id|serial_init
c_func
(paren
id|bd_t
op_star
id|bd
)paren
(brace
r_volatile
id|smc_t
op_star
id|sp
suffix:semicolon
r_volatile
id|smc_uart_t
op_star
id|up
suffix:semicolon
r_volatile
id|cbd_t
op_star
id|tbdf
comma
op_star
id|rbdf
suffix:semicolon
r_volatile
id|cpm8xx_t
op_star
id|cp
suffix:semicolon
id|uint
id|dpaddr
comma
id|memaddr
suffix:semicolon
id|cp
op_assign
id|cpmp
suffix:semicolon
id|sp
op_assign
(paren
id|smc_t
op_star
)paren
op_amp
(paren
id|cp-&gt;cp_smc
(braket
id|SMC_INDEX
)braket
)paren
suffix:semicolon
id|up
op_assign
(paren
id|smc_uart_t
op_star
)paren
op_amp
id|cp-&gt;cp_dparam
(braket
id|PROFF_CONS
)braket
suffix:semicolon
multiline_comment|/* Disable transmitter/receiver.&n;&t;*/
id|sp-&gt;smc_smcmr
op_and_assign
op_complement
(paren
id|SMCMR_REN
op_or
id|SMCMR_TEN
)paren
suffix:semicolon
macro_line|#ifndef CONFIG_MBX
(brace
multiline_comment|/* Initialize SMCx and use it for the console port.&n;&t; */
multiline_comment|/* Enable SDMA.&n;&t;*/
(paren
(paren
id|immap_t
op_star
)paren
id|IMAP_ADDR
)paren
op_member_access_from_pointer
id|im_siu_conf.sc_sdcr
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef TQM_SMC2_CONSOLE
multiline_comment|/* Use Port A for SMC2 instead of other functions.&n;&t;*/
id|iopp-&gt;iop_papar
op_or_assign
l_int|0x00c0
suffix:semicolon
id|iopp-&gt;iop_padir
op_and_assign
op_complement
l_int|0x00c0
suffix:semicolon
id|iopp-&gt;iop_paodr
op_and_assign
op_complement
l_int|0x00c0
suffix:semicolon
macro_line|#else
multiline_comment|/* Use Port B for SMCs instead of other functions.&n;&t;*/
id|cp-&gt;cp_pbpar
op_or_assign
l_int|0x00000cc0
suffix:semicolon
id|cp-&gt;cp_pbdir
op_and_assign
op_complement
l_int|0x00000cc0
suffix:semicolon
id|cp-&gt;cp_pbodr
op_and_assign
op_complement
l_int|0x00000cc0
suffix:semicolon
macro_line|#endif
multiline_comment|/* Allocate space for two buffer descriptors in the DP ram.&n;&t; * For now, this address seems OK, but it may have to&n;&t; * change with newer versions of the firmware.&n;&t; */
id|dpaddr
op_assign
l_int|0x0800
suffix:semicolon
multiline_comment|/* Grab a few bytes from the top of memory for SMC FIFOs.&n;&t; */
id|memaddr
op_assign
(paren
id|bd-&gt;bi_memsize
op_minus
l_int|32
)paren
op_amp
op_complement
l_int|15
suffix:semicolon
multiline_comment|/* Set the physical address of the host memory buffers in&n;&t; * the buffer descriptors.&n;&t; */
id|rbdf
op_assign
(paren
id|cbd_t
op_star
)paren
op_amp
id|cp-&gt;cp_dpmem
(braket
id|dpaddr
)braket
suffix:semicolon
id|rbdf-&gt;cbd_bufaddr
op_assign
id|memaddr
suffix:semicolon
id|rbdf-&gt;cbd_sc
op_assign
l_int|0
suffix:semicolon
id|tbdf
op_assign
id|rbdf
op_plus
l_int|1
suffix:semicolon
id|tbdf-&gt;cbd_bufaddr
op_assign
id|memaddr
op_plus
l_int|4
suffix:semicolon
id|tbdf-&gt;cbd_sc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Set up the uart parameters in the parameter ram.&n;&t;*/
id|up-&gt;smc_rbase
op_assign
id|dpaddr
suffix:semicolon
id|up-&gt;smc_tbase
op_assign
id|dpaddr
op_plus
r_sizeof
(paren
id|cbd_t
)paren
suffix:semicolon
id|up-&gt;smc_rfcr
op_assign
id|SMC_EB
suffix:semicolon
id|up-&gt;smc_tfcr
op_assign
id|SMC_EB
suffix:semicolon
multiline_comment|/* Set UART mode, 8 bit, no parity, one stop.&n;&t; * Enable receive and transmit.&n;&t; */
id|sp-&gt;smc_smcmr
op_assign
id|smcr_mk_clen
c_func
(paren
l_int|9
)paren
op_or
id|SMCMR_SM_UART
suffix:semicolon
multiline_comment|/* Mask all interrupts and remove anything pending.&n;&t;*/
id|sp-&gt;smc_smcm
op_assign
l_int|0
suffix:semicolon
id|sp-&gt;smc_smce
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* Set up the baud rate generator.&n;&t; * See 8xx_io/commproc.c for details.&n;&t; * This wires BRG1 to SMC1 and BRG2 to SMC2;&n;&t; */
id|cp-&gt;cp_simode
op_assign
l_int|0x10000000
suffix:semicolon
macro_line|#ifdef TQM_SMC2_CONSOLE
id|cp-&gt;cp_brgc2
op_assign
macro_line|#else
id|cp-&gt;cp_brgc1
op_assign
macro_line|#endif
(paren
(paren
(paren
(paren
id|bd-&gt;bi_intfreq
op_star
l_int|1000000
)paren
op_div
l_int|16
)paren
op_div
id|bd-&gt;bi_baudrate
)paren
op_lshift
l_int|1
)paren
op_or
id|CPM_BRG_EN
suffix:semicolon
macro_line|#else /* CONFIG_MBX */
r_if
c_cond
(paren
op_star
id|MBX_CSR1
op_amp
id|CSR1_COMEN
)paren
(brace
multiline_comment|/* COM1 is enabled.  Initialize SMC1 and use it for&n;&t;&t; * the console port.&n;&t;&t; */
multiline_comment|/* Enable SDMA.&n;&t;&t;*/
(paren
(paren
id|immap_t
op_star
)paren
id|IMAP_ADDR
)paren
op_member_access_from_pointer
id|im_siu_conf.sc_sdcr
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Use Port B for SMCs instead of other functions.&n;&t;&t;*/
id|cp-&gt;cp_pbpar
op_or_assign
l_int|0x00000cc0
suffix:semicolon
id|cp-&gt;cp_pbdir
op_and_assign
op_complement
l_int|0x00000cc0
suffix:semicolon
id|cp-&gt;cp_pbodr
op_and_assign
op_complement
l_int|0x00000cc0
suffix:semicolon
multiline_comment|/* Allocate space for two buffer descriptors in the DP ram.&n;&t;&t; * For now, this address seems OK, but it may have to&n;&t;&t; * change with newer versions of the firmware.&n;&t;&t; */
id|dpaddr
op_assign
l_int|0x0800
suffix:semicolon
multiline_comment|/* Grab a few bytes from the top of memory.  EPPC-Bug isn&squot;t&n;&t;&t; * running any more, so we can do this.&n;&t;&t; */
id|memaddr
op_assign
(paren
id|bd-&gt;bi_memsize
op_minus
l_int|32
)paren
op_amp
op_complement
l_int|15
suffix:semicolon
multiline_comment|/* Set the physical address of the host memory buffers in&n;&t;&t; * the buffer descriptors.&n;&t;&t; */
id|rbdf
op_assign
(paren
id|cbd_t
op_star
)paren
op_amp
id|cp-&gt;cp_dpmem
(braket
id|dpaddr
)braket
suffix:semicolon
id|rbdf-&gt;cbd_bufaddr
op_assign
id|memaddr
suffix:semicolon
id|rbdf-&gt;cbd_sc
op_assign
l_int|0
suffix:semicolon
id|tbdf
op_assign
id|rbdf
op_plus
l_int|1
suffix:semicolon
id|tbdf-&gt;cbd_bufaddr
op_assign
id|memaddr
op_plus
l_int|4
suffix:semicolon
id|tbdf-&gt;cbd_sc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Set up the uart parameters in the parameter ram.&n;&t;&t;*/
id|up-&gt;smc_rbase
op_assign
id|dpaddr
suffix:semicolon
id|up-&gt;smc_tbase
op_assign
id|dpaddr
op_plus
r_sizeof
(paren
id|cbd_t
)paren
suffix:semicolon
id|up-&gt;smc_rfcr
op_assign
id|SMC_EB
suffix:semicolon
id|up-&gt;smc_tfcr
op_assign
id|SMC_EB
suffix:semicolon
multiline_comment|/* Set UART mode, 8 bit, no parity, one stop.&n;&t;&t; * Enable receive and transmit.&n;&t;&t; */
id|sp-&gt;smc_smcmr
op_assign
id|smcr_mk_clen
c_func
(paren
l_int|9
)paren
op_or
id|SMCMR_SM_UART
suffix:semicolon
multiline_comment|/* Mask all interrupts and remove anything pending.&n;&t;&t;*/
id|sp-&gt;smc_smcm
op_assign
l_int|0
suffix:semicolon
id|sp-&gt;smc_smce
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* Set up the baud rate generator.&n;&t;&t; * See 8xx_io/commproc.c for details.&n;&t;&t; */
id|cp-&gt;cp_simode
op_assign
l_int|0x10000000
suffix:semicolon
id|cp-&gt;cp_brgc1
op_assign
(paren
(paren
(paren
(paren
id|bd-&gt;bi_intfreq
op_star
l_int|1000000
)paren
op_div
l_int|16
)paren
op_div
l_int|9600
)paren
op_lshift
l_int|1
)paren
op_or
id|CPM_BRG_EN
suffix:semicolon
multiline_comment|/* Enable SMC1 for console output.&n;&t;&t;*/
op_star
id|MBX_CSR1
op_and_assign
op_complement
id|CSR1_COMEN
suffix:semicolon
)brace
r_else
(brace
macro_line|#endif /* ndef CONFIG_MBX */
multiline_comment|/* SMCx is used as console port.&n;&t;&t;*/
id|tbdf
op_assign
(paren
id|cbd_t
op_star
)paren
op_amp
id|cp-&gt;cp_dpmem
(braket
id|up-&gt;smc_tbase
)braket
suffix:semicolon
id|rbdf
op_assign
(paren
id|cbd_t
op_star
)paren
op_amp
id|cp-&gt;cp_dpmem
(braket
id|up-&gt;smc_rbase
)braket
suffix:semicolon
multiline_comment|/* Issue a stop transmit, and wait for it.&n;&t;&t;*/
id|cp-&gt;cp_cpcr
op_assign
id|mk_cr_cmd
c_func
(paren
id|CPM_CR_CH_CONS
comma
id|CPM_CR_STOP_TX
)paren
op_or
id|CPM_CR_FLG
suffix:semicolon
r_while
c_loop
(paren
id|cp-&gt;cp_cpcr
op_amp
id|CPM_CR_FLG
)paren
suffix:semicolon
)brace
multiline_comment|/* Make the first buffer the only buffer.&n;&t;*/
id|tbdf-&gt;cbd_sc
op_or_assign
id|BD_SC_WRAP
suffix:semicolon
id|rbdf-&gt;cbd_sc
op_or_assign
id|BD_SC_EMPTY
op_or
id|BD_SC_WRAP
suffix:semicolon
multiline_comment|/* Single character receive.&n;&t;*/
id|up-&gt;smc_mrblr
op_assign
l_int|1
suffix:semicolon
id|up-&gt;smc_maxidl
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Initialize Tx/Rx parameters.&n;&t;*/
id|cp-&gt;cp_cpcr
op_assign
id|mk_cr_cmd
c_func
(paren
id|CPM_CR_CH_CONS
comma
id|CPM_CR_INIT_TRX
)paren
op_or
id|CPM_CR_FLG
suffix:semicolon
r_while
c_loop
(paren
id|cp-&gt;cp_cpcr
op_amp
id|CPM_CR_FLG
)paren
suffix:semicolon
multiline_comment|/* Enable transmitter/receiver.&n;&t;*/
id|sp-&gt;smc_smcmr
op_or_assign
id|SMCMR_REN
op_or
id|SMCMR_TEN
suffix:semicolon
)brace
r_void
DECL|function|serial_putchar
id|serial_putchar
c_func
(paren
r_const
r_char
id|c
)paren
(brace
r_volatile
id|cbd_t
op_star
id|tbdf
suffix:semicolon
r_volatile
r_char
op_star
id|buf
suffix:semicolon
r_volatile
id|smc_uart_t
op_star
id|up
suffix:semicolon
id|up
op_assign
(paren
id|smc_uart_t
op_star
)paren
op_amp
id|cpmp-&gt;cp_dparam
(braket
id|PROFF_CONS
)braket
suffix:semicolon
id|tbdf
op_assign
(paren
id|cbd_t
op_star
)paren
op_amp
id|cpmp-&gt;cp_dpmem
(braket
id|up-&gt;smc_tbase
)braket
suffix:semicolon
multiline_comment|/* Wait for last character to go.&n;&t;*/
id|buf
op_assign
(paren
r_char
op_star
)paren
id|tbdf-&gt;cbd_bufaddr
suffix:semicolon
r_while
c_loop
(paren
id|tbdf-&gt;cbd_sc
op_amp
id|BD_SC_READY
)paren
suffix:semicolon
op_star
id|buf
op_assign
id|c
suffix:semicolon
id|tbdf-&gt;cbd_datlen
op_assign
l_int|1
suffix:semicolon
id|tbdf-&gt;cbd_sc
op_or_assign
id|BD_SC_READY
suffix:semicolon
)brace
r_char
DECL|function|serial_getc
id|serial_getc
c_func
(paren
)paren
(brace
r_volatile
id|cbd_t
op_star
id|rbdf
suffix:semicolon
r_volatile
r_char
op_star
id|buf
suffix:semicolon
r_volatile
id|smc_uart_t
op_star
id|up
suffix:semicolon
r_char
id|c
suffix:semicolon
id|up
op_assign
(paren
id|smc_uart_t
op_star
)paren
op_amp
id|cpmp-&gt;cp_dparam
(braket
id|PROFF_CONS
)braket
suffix:semicolon
id|rbdf
op_assign
(paren
id|cbd_t
op_star
)paren
op_amp
id|cpmp-&gt;cp_dpmem
(braket
id|up-&gt;smc_rbase
)braket
suffix:semicolon
multiline_comment|/* Wait for character to show up.&n;&t;*/
id|buf
op_assign
(paren
r_char
op_star
)paren
id|rbdf-&gt;cbd_bufaddr
suffix:semicolon
r_while
c_loop
(paren
id|rbdf-&gt;cbd_sc
op_amp
id|BD_SC_EMPTY
)paren
suffix:semicolon
id|c
op_assign
op_star
id|buf
suffix:semicolon
id|rbdf-&gt;cbd_sc
op_or_assign
id|BD_SC_EMPTY
suffix:semicolon
r_return
id|c
suffix:semicolon
)brace
r_int
DECL|function|serial_tstc
id|serial_tstc
c_func
(paren
)paren
(brace
r_volatile
id|cbd_t
op_star
id|rbdf
suffix:semicolon
r_volatile
id|smc_uart_t
op_star
id|up
suffix:semicolon
id|up
op_assign
(paren
id|smc_uart_t
op_star
)paren
op_amp
id|cpmp-&gt;cp_dparam
(braket
id|PROFF_CONS
)braket
suffix:semicolon
id|rbdf
op_assign
(paren
id|cbd_t
op_star
)paren
op_amp
id|cpmp-&gt;cp_dpmem
(braket
id|up-&gt;smc_rbase
)braket
suffix:semicolon
r_return
op_logical_neg
(paren
id|rbdf-&gt;cbd_sc
op_amp
id|BD_SC_EMPTY
)paren
suffix:semicolon
)brace
eof
