multiline_comment|/*&n; * Fast Ethernet Controller (FEC) driver for Motorola MPC8xx.&n; * Copyright (c) 1997 Dan Malek (dmalek@jlc.net)&n; *&n; * This version of the driver is specific to the FADS implementation,&n; * since the board contains control registers external to the processor&n; * for the control of the LevelOne LXT970 transceiver.  The MPC860T manual&n; * describes connections using the internal parallel port I/O, which&n; * is basically all of Port D.&n; *&n; * Right now, I am very watseful with the buffers.  I allocate memory&n; * pages and then divide them into 2K frame buffers.  This way I know I&n; * have buffers large enough to hold one frame within one buffer descriptor.&n; * Once I get this working, I will use 64 or 128 byte CPM buffers, which&n; * will be much more memory efficient and will easily handle lots of&n; * small packets.&n; *&n; * Much better multiple PHY support by Magnus Damm.&n; * Copyright (c) 2000 Ericsson Radio Systems AB.&n; *&n; */
multiline_comment|/* List of PHYs we wish to support.&n;*/
DECL|macro|CONFIG_FEC_LXT970
mdefine_line|#define CONFIG_FEC_LXT970
DECL|macro|CONFIG_FEC_LXT971
mdefine_line|#define CONFIG_FEC_LXT971
DECL|macro|CONFIG_FEC_QS6612
mdefine_line|#define CONFIG_FEC_QS6612
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#ifdef CONFIG_FEC_PACKETHOOK
macro_line|#include &lt;linux/pkthook.h&gt;
macro_line|#endif
macro_line|#include &lt;asm/8xx_immap.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/mpc8xx.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &quot;commproc.h&quot;
multiline_comment|/* Forward declarations of some structures to support different PHYs&n;*/
r_typedef
r_struct
(brace
DECL|member|mii_data
id|uint
id|mii_data
suffix:semicolon
DECL|member|funct
r_void
(paren
op_star
id|funct
)paren
(paren
id|uint
id|mii_reg
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
DECL|typedef|phy_cmd_t
)brace
id|phy_cmd_t
suffix:semicolon
r_typedef
r_struct
(brace
DECL|member|id
id|uint
id|id
suffix:semicolon
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|config
r_const
id|phy_cmd_t
op_star
id|config
suffix:semicolon
DECL|member|startup
r_const
id|phy_cmd_t
op_star
id|startup
suffix:semicolon
DECL|member|ack_int
r_const
id|phy_cmd_t
op_star
id|ack_int
suffix:semicolon
DECL|member|shutdown
r_const
id|phy_cmd_t
op_star
id|shutdown
suffix:semicolon
DECL|typedef|phy_info_t
)brace
id|phy_info_t
suffix:semicolon
multiline_comment|/* The number of Tx and Rx buffers.  These are allocated from the page&n; * pool.  The code may assume these are power of two, so it it best&n; * to keep them that size.&n; * We don&squot;t need to allocate pages for the transmitter.  We just use&n; * the skbuffer directly.&n; */
macro_line|#if 1
DECL|macro|FEC_ENET_RX_PAGES
mdefine_line|#define FEC_ENET_RX_PAGES&t;4
DECL|macro|FEC_ENET_RX_FRSIZE
mdefine_line|#define FEC_ENET_RX_FRSIZE&t;2048
DECL|macro|FEC_ENET_RX_FRPPG
mdefine_line|#define FEC_ENET_RX_FRPPG&t;(PAGE_SIZE / FEC_ENET_RX_FRSIZE)
DECL|macro|RX_RING_SIZE
mdefine_line|#define RX_RING_SIZE&t;&t;(FEC_ENET_RX_FRPPG * FEC_ENET_RX_PAGES)
DECL|macro|TX_RING_SIZE
mdefine_line|#define TX_RING_SIZE&t;&t;8&t;/* Must be power of two */
DECL|macro|TX_RING_MOD_MASK
mdefine_line|#define TX_RING_MOD_MASK&t;7&t;/*   for this to work */
macro_line|#else
DECL|macro|FEC_ENET_RX_PAGES
mdefine_line|#define FEC_ENET_RX_PAGES&t;16
DECL|macro|FEC_ENET_RX_FRSIZE
mdefine_line|#define FEC_ENET_RX_FRSIZE&t;2048
DECL|macro|FEC_ENET_RX_FRPPG
mdefine_line|#define FEC_ENET_RX_FRPPG&t;(PAGE_SIZE / FEC_ENET_RX_FRSIZE)
DECL|macro|RX_RING_SIZE
mdefine_line|#define RX_RING_SIZE&t;&t;(FEC_ENET_RX_FRPPG * FEC_ENET_RX_PAGES)
DECL|macro|TX_RING_SIZE
mdefine_line|#define TX_RING_SIZE&t;&t;16&t;/* Must be power of two */
DECL|macro|TX_RING_MOD_MASK
mdefine_line|#define TX_RING_MOD_MASK&t;15&t;/*   for this to work */
macro_line|#endif
multiline_comment|/* Interrupt events/masks.&n;*/
DECL|macro|FEC_ENET_HBERR
mdefine_line|#define FEC_ENET_HBERR&t;((uint)0x80000000)&t;/* Heartbeat error */
DECL|macro|FEC_ENET_BABR
mdefine_line|#define FEC_ENET_BABR&t;((uint)0x40000000)&t;/* Babbling receiver */
DECL|macro|FEC_ENET_BABT
mdefine_line|#define FEC_ENET_BABT&t;((uint)0x20000000)&t;/* Babbling transmitter */
DECL|macro|FEC_ENET_GRA
mdefine_line|#define FEC_ENET_GRA&t;((uint)0x10000000)&t;/* Graceful stop complete */
DECL|macro|FEC_ENET_TXF
mdefine_line|#define FEC_ENET_TXF&t;((uint)0x08000000)&t;/* Full frame transmitted */
DECL|macro|FEC_ENET_TXB
mdefine_line|#define FEC_ENET_TXB&t;((uint)0x04000000)&t;/* A buffer was transmitted */
DECL|macro|FEC_ENET_RXF
mdefine_line|#define FEC_ENET_RXF&t;((uint)0x02000000)&t;/* Full frame received */
DECL|macro|FEC_ENET_RXB
mdefine_line|#define FEC_ENET_RXB&t;((uint)0x01000000)&t;/* A buffer was received */
DECL|macro|FEC_ENET_MII
mdefine_line|#define FEC_ENET_MII&t;((uint)0x00800000)&t;/* MII interrupt */
DECL|macro|FEC_ENET_EBERR
mdefine_line|#define FEC_ENET_EBERR&t;((uint)0x00400000)&t;/* SDMA bus error */
multiline_comment|/* The FEC stores dest/src/type, data, and checksum for receive packets.&n; */
DECL|macro|PKT_MAXBUF_SIZE
mdefine_line|#define PKT_MAXBUF_SIZE&t;&t;1518
DECL|macro|PKT_MINBUF_SIZE
mdefine_line|#define PKT_MINBUF_SIZE&t;&t;64
DECL|macro|PKT_MAXBLR_SIZE
mdefine_line|#define PKT_MAXBLR_SIZE&t;&t;1520
multiline_comment|/* The FEC buffer descriptors track the ring buffers.  The rx_bd_base and&n; * tx_bd_base always point to the base of the buffer descriptors.  The&n; * cur_rx and cur_tx point to the currently available buffer.&n; * The dirty_tx tracks the current buffer that is being sent by the&n; * controller.  The cur_tx and dirty_tx are equal under both completely&n; * empty and completely full conditions.  The empty/ready indicator in&n; * the buffer descriptor determines the actual condition.&n; */
DECL|struct|fec_enet_private
r_struct
id|fec_enet_private
(brace
multiline_comment|/* The saved address of a sent-in-place packet/buffer, for skfree(). */
DECL|member|tx_skbuff
r_struct
id|sk_buff
op_star
id|tx_skbuff
(braket
id|TX_RING_SIZE
)braket
suffix:semicolon
DECL|member|skb_cur
id|ushort
id|skb_cur
suffix:semicolon
DECL|member|skb_dirty
id|ushort
id|skb_dirty
suffix:semicolon
multiline_comment|/* CPM dual port RAM relative addresses.&n;&t;*/
DECL|member|rx_bd_base
id|cbd_t
op_star
id|rx_bd_base
suffix:semicolon
multiline_comment|/* Address of Rx and Tx buffers. */
DECL|member|tx_bd_base
id|cbd_t
op_star
id|tx_bd_base
suffix:semicolon
DECL|member|cur_rx
DECL|member|cur_tx
id|cbd_t
op_star
id|cur_rx
comma
op_star
id|cur_tx
suffix:semicolon
multiline_comment|/* The next free ring entry */
DECL|member|dirty_tx
id|cbd_t
op_star
id|dirty_tx
suffix:semicolon
multiline_comment|/* The ring entries to be free()ed. */
DECL|member|sccp
id|scc_t
op_star
id|sccp
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|tx_full
id|uint
id|tx_full
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|phy_id
id|uint
id|phy_id
suffix:semicolon
DECL|member|phy_id_done
id|uint
id|phy_id_done
suffix:semicolon
DECL|member|phy_status
id|uint
id|phy_status
suffix:semicolon
DECL|member|phy_speed
id|uint
id|phy_speed
suffix:semicolon
DECL|member|phy
id|phy_info_t
op_star
id|phy
suffix:semicolon
DECL|member|phy_task
r_struct
id|tq_struct
id|phy_task
suffix:semicolon
DECL|member|sequence_done
id|uint
id|sequence_done
suffix:semicolon
DECL|member|phy_addr
id|uint
id|phy_addr
suffix:semicolon
DECL|member|link
r_int
id|link
suffix:semicolon
DECL|member|old_link
r_int
id|old_link
suffix:semicolon
DECL|member|full_duplex
r_int
id|full_duplex
suffix:semicolon
macro_line|#ifdef CONFIG_FEC_PACKETHOOK
DECL|member|ph_lock
r_int
r_int
id|ph_lock
suffix:semicolon
DECL|member|ph_rxhandler
id|fec_ph_func
op_star
id|ph_rxhandler
suffix:semicolon
DECL|member|ph_txhandler
id|fec_ph_func
op_star
id|ph_txhandler
suffix:semicolon
DECL|member|ph_proto
id|__u16
id|ph_proto
suffix:semicolon
DECL|member|ph_regaddr
r_volatile
id|__u32
op_star
id|ph_regaddr
suffix:semicolon
DECL|member|ph_priv
r_void
op_star
id|ph_priv
suffix:semicolon
macro_line|#endif
)brace
suffix:semicolon
r_static
r_int
id|fec_enet_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|fec_enet_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|fec_enet_mii
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|fec_enet_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_FEC_PACKETHOOK
r_static
r_void
id|fec_enet_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|__u32
id|regval
)paren
suffix:semicolon
r_static
r_void
id|fec_enet_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|__u32
id|regval
)paren
suffix:semicolon
macro_line|#else
r_static
r_void
id|fec_enet_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|fec_enet_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_static
r_int
id|fec_enet_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|fec_enet_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|fec_restart
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|duplex
)paren
suffix:semicolon
r_static
r_void
id|fec_stop
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
DECL|variable|my_enet_addr
r_static
id|ushort
id|my_enet_addr
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* MII processing.  We keep this as simple as possible.  Requests are&n; * placed on the list (if there is room).  When the request is finished&n; * by the MII, an optional function may be called.&n; */
DECL|struct|mii_list
r_typedef
r_struct
id|mii_list
(brace
DECL|member|mii_regval
id|uint
id|mii_regval
suffix:semicolon
DECL|member|mii_func
r_void
(paren
op_star
id|mii_func
)paren
(paren
id|uint
id|val
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
DECL|member|mii_next
r_struct
id|mii_list
op_star
id|mii_next
suffix:semicolon
DECL|typedef|mii_list_t
)brace
id|mii_list_t
suffix:semicolon
DECL|macro|NMII
mdefine_line|#define&t;&t;NMII&t;20
DECL|variable|mii_cmds
id|mii_list_t
id|mii_cmds
(braket
id|NMII
)braket
suffix:semicolon
DECL|variable|mii_free
id|mii_list_t
op_star
id|mii_free
suffix:semicolon
DECL|variable|mii_head
id|mii_list_t
op_star
id|mii_head
suffix:semicolon
DECL|variable|mii_tail
id|mii_list_t
op_star
id|mii_tail
suffix:semicolon
r_static
r_int
id|mii_queue
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|request
comma
r_void
(paren
op_star
id|func
)paren
(paren
id|uint
comma
r_struct
id|net_device
op_star
)paren
)paren
suffix:semicolon
multiline_comment|/* Make MII read/write commands for the FEC.&n;*/
DECL|macro|mk_mii_read
mdefine_line|#define mk_mii_read(REG)&t;(0x60020000 | ((REG &amp; 0x1f) &lt;&lt; 18))
DECL|macro|mk_mii_write
mdefine_line|#define mk_mii_write(REG, VAL)&t;(0x50020000 | ((REG &amp; 0x1f) &lt;&lt; 18) | &bslash;&n;&t;&t;&t;&t;&t;&t;(VAL &amp; 0xffff))
DECL|macro|mk_mii_end
mdefine_line|#define mk_mii_end&t;0
multiline_comment|/* Transmitter timeout.&n;*/
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT (2*HZ)
multiline_comment|/* Register definitions for the PHY.&n;*/
DECL|macro|MII_REG_CR
mdefine_line|#define MII_REG_CR          0  /* Control Register                         */
DECL|macro|MII_REG_SR
mdefine_line|#define MII_REG_SR          1  /* Status Register                          */
DECL|macro|MII_REG_PHYIR1
mdefine_line|#define MII_REG_PHYIR1      2  /* PHY Identification Register 1            */
DECL|macro|MII_REG_PHYIR2
mdefine_line|#define MII_REG_PHYIR2      3  /* PHY Identification Register 2            */
DECL|macro|MII_REG_ANAR
mdefine_line|#define MII_REG_ANAR        4  /* A-N Advertisement Register               */ 
DECL|macro|MII_REG_ANLPAR
mdefine_line|#define MII_REG_ANLPAR      5  /* A-N Link Partner Ability Register        */
DECL|macro|MII_REG_ANER
mdefine_line|#define MII_REG_ANER        6  /* A-N Expansion Register                   */
DECL|macro|MII_REG_ANNPTR
mdefine_line|#define MII_REG_ANNPTR      7  /* A-N Next Page Transmit Register          */
DECL|macro|MII_REG_ANLPRNPR
mdefine_line|#define MII_REG_ANLPRNPR    8  /* A-N Link Partner Received Next Page Reg. */
multiline_comment|/* values for phy_status */
DECL|macro|PHY_CONF_ANE
mdefine_line|#define PHY_CONF_ANE&t;0x0001  /* 1 auto-negotiation enabled */
DECL|macro|PHY_CONF_LOOP
mdefine_line|#define PHY_CONF_LOOP&t;0x0002  /* 1 loopback mode enabled */
DECL|macro|PHY_CONF_SPMASK
mdefine_line|#define PHY_CONF_SPMASK&t;0x00f0  /* mask for speed */
DECL|macro|PHY_CONF_10HDX
mdefine_line|#define PHY_CONF_10HDX&t;0x0010  /* 10 Mbit half duplex supported */
DECL|macro|PHY_CONF_10FDX
mdefine_line|#define PHY_CONF_10FDX&t;0x0020  /* 10 Mbit full duplex supported */ 
DECL|macro|PHY_CONF_100HDX
mdefine_line|#define PHY_CONF_100HDX&t;0x0040  /* 100 Mbit half duplex supported */
DECL|macro|PHY_CONF_100FDX
mdefine_line|#define PHY_CONF_100FDX&t;0x0080  /* 100 Mbit full duplex supported */ 
DECL|macro|PHY_STAT_LINK
mdefine_line|#define PHY_STAT_LINK&t;0x0100  /* 1 up - 0 down */
DECL|macro|PHY_STAT_FAULT
mdefine_line|#define PHY_STAT_FAULT&t;0x0200  /* 1 remote fault */
DECL|macro|PHY_STAT_ANC
mdefine_line|#define PHY_STAT_ANC&t;0x0400  /* 1 auto-negotiation complete&t;*/
DECL|macro|PHY_STAT_SPMASK
mdefine_line|#define PHY_STAT_SPMASK&t;0xf000  /* mask for speed */
DECL|macro|PHY_STAT_10HDX
mdefine_line|#define PHY_STAT_10HDX&t;0x1000  /* 10 Mbit half duplex selected&t;*/
DECL|macro|PHY_STAT_10FDX
mdefine_line|#define PHY_STAT_10FDX&t;0x2000  /* 10 Mbit full duplex selected&t;*/ 
DECL|macro|PHY_STAT_100HDX
mdefine_line|#define PHY_STAT_100HDX&t;0x4000  /* 100 Mbit half duplex selected */
DECL|macro|PHY_STAT_100FDX
mdefine_line|#define PHY_STAT_100FDX&t;0x8000  /* 100 Mbit full duplex selected */ 
macro_line|#ifdef CONFIG_FEC_PACKETHOOK
r_int
DECL|function|fec_register_ph
id|fec_register_ph
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|fec_ph_func
op_star
id|rxfun
comma
id|fec_ph_func
op_star
id|txfun
comma
id|__u16
id|proto
comma
r_volatile
id|__u32
op_star
id|regaddr
comma
r_void
op_star
id|priv
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|fep-&gt;ph_lock
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Someone is messing with the packet hook */
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fep-&gt;ph_rxhandler
op_ne
l_int|NULL
op_logical_or
id|fep-&gt;ph_txhandler
op_ne
l_int|NULL
)paren
(brace
id|retval
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|fep-&gt;ph_rxhandler
op_assign
id|rxfun
suffix:semicolon
id|fep-&gt;ph_txhandler
op_assign
id|txfun
suffix:semicolon
id|fep-&gt;ph_proto
op_assign
id|proto
suffix:semicolon
id|fep-&gt;ph_regaddr
op_assign
id|regaddr
suffix:semicolon
id|fep-&gt;ph_priv
op_assign
id|priv
suffix:semicolon
id|out
suffix:colon
id|fep-&gt;ph_lock
op_assign
l_int|0
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_int
DECL|function|fec_unregister_ph
id|fec_unregister_ph
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|fep-&gt;ph_lock
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Someone is messing with the packet hook */
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|fep-&gt;ph_rxhandler
op_assign
id|fep-&gt;ph_txhandler
op_assign
l_int|NULL
suffix:semicolon
id|fep-&gt;ph_proto
op_assign
l_int|0
suffix:semicolon
id|fep-&gt;ph_regaddr
op_assign
l_int|NULL
suffix:semicolon
id|fep-&gt;ph_priv
op_assign
l_int|NULL
suffix:semicolon
id|fep-&gt;ph_lock
op_assign
l_int|0
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|variable|fec_register_ph
id|EXPORT_SYMBOL
c_func
(paren
id|fec_register_ph
)paren
suffix:semicolon
DECL|variable|fec_unregister_ph
id|EXPORT_SYMBOL
c_func
(paren
id|fec_unregister_ph
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_FEC_PACKETHOOK */
r_static
r_int
DECL|function|fec_enet_start_xmit
id|fec_enet_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
suffix:semicolon
r_volatile
id|fec_t
op_star
id|fecp
suffix:semicolon
r_volatile
id|cbd_t
op_star
id|bdp
suffix:semicolon
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
id|fecp
op_assign
(paren
r_volatile
id|fec_t
op_star
)paren
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fep-&gt;link
)paren
(brace
multiline_comment|/* Link is down or autonegotiation is in progress. */
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Fill in a Tx ring entry */
id|bdp
op_assign
id|fep-&gt;cur_tx
suffix:semicolon
macro_line|#ifndef final_version
r_if
c_cond
(paren
id|bdp-&gt;cbd_sc
op_amp
id|BD_ENET_TX_READY
)paren
(brace
multiline_comment|/* Ooops.  All transmit buffers are full.  Bail out.&n;&t;&t; * This should not happen, since dev-&gt;tbusy should be set.&n;&t;&t; */
id|printk
c_func
(paren
l_string|&quot;%s: tx queue full!.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Clear all of the status flags.&n;&t; */
id|bdp-&gt;cbd_sc
op_and_assign
op_complement
id|BD_ENET_TX_STATS
suffix:semicolon
multiline_comment|/* Set buffer length and buffer pointer.&n;&t;*/
id|bdp-&gt;cbd_bufaddr
op_assign
id|__pa
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
id|bdp-&gt;cbd_datlen
op_assign
id|skb-&gt;len
suffix:semicolon
multiline_comment|/* Save skb pointer.&n;&t;*/
id|fep-&gt;tx_skbuff
(braket
id|fep-&gt;skb_cur
)braket
op_assign
id|skb
suffix:semicolon
id|fep-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|fep-&gt;skb_cur
op_assign
(paren
id|fep-&gt;skb_cur
op_plus
l_int|1
)paren
op_amp
id|TX_RING_MOD_MASK
suffix:semicolon
multiline_comment|/* Push the data cache so the CPM does not get stale memory&n;&t; * data.&n;&t; */
id|flush_dcache_range
c_func
(paren
(paren
r_int
r_int
)paren
id|skb-&gt;data
comma
(paren
r_int
r_int
)paren
id|skb-&gt;data
op_plus
id|skb-&gt;len
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|fep-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* Send it on its way.  Tell FEC its ready, interrupt when done,&n;&t; * its the last BD of the frame, and to put the CRC on the end.&n;&t; */
id|bdp-&gt;cbd_sc
op_or_assign
(paren
id|BD_ENET_TX_READY
op_or
id|BD_ENET_TX_INTR
op_or
id|BD_ENET_TX_LAST
op_or
id|BD_ENET_TX_TC
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* Trigger transmission start */
id|fecp-&gt;fec_x_des_active
op_assign
l_int|0x01000000
suffix:semicolon
multiline_comment|/* If this was the last BD in the ring, start at the beginning again.&n;&t;*/
r_if
c_cond
(paren
id|bdp-&gt;cbd_sc
op_amp
id|BD_ENET_TX_WRAP
)paren
(brace
id|bdp
op_assign
id|fep-&gt;tx_bd_base
suffix:semicolon
)brace
r_else
(brace
id|bdp
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bdp-&gt;cbd_sc
op_amp
id|BD_ENET_TX_READY
)paren
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|fep-&gt;cur_tx
op_assign
(paren
id|cbd_t
op_star
)paren
id|bdp
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|fep-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|fec_timeout
id|fec_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: transmit timed out.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|fep-&gt;stats.tx_errors
op_increment
suffix:semicolon
macro_line|#ifndef final_version
(brace
r_int
id|i
suffix:semicolon
id|cbd_t
op_star
id|bdp
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Ring data dump: cur_tx %lx%s, dirty_tx %lx cur_rx: %lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|fep-&gt;cur_tx
comma
id|fep-&gt;tx_full
ques
c_cond
l_string|&quot; (full)&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
r_int
r_int
)paren
id|fep-&gt;dirty_tx
comma
(paren
r_int
r_int
)paren
id|fep-&gt;cur_rx
)paren
suffix:semicolon
id|bdp
op_assign
id|fep-&gt;tx_bd_base
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; tx: %u buffers&bslash;n&quot;
comma
id|TX_RING_SIZE
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;  %08x: %04x %04x %08x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|bdp
comma
id|bdp-&gt;cbd_sc
comma
id|bdp-&gt;cbd_datlen
comma
id|bdp-&gt;cbd_bufaddr
)paren
suffix:semicolon
id|bdp
op_increment
suffix:semicolon
)brace
id|bdp
op_assign
id|fep-&gt;rx_bd_base
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; rx: %lu buffers&bslash;n&quot;
comma
id|RX_RING_SIZE
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;  %08x: %04x %04x %08x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|bdp
comma
id|bdp-&gt;cbd_sc
comma
id|bdp-&gt;cbd_datlen
comma
id|bdp-&gt;cbd_bufaddr
)paren
suffix:semicolon
id|bdp
op_increment
suffix:semicolon
)brace
)brace
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|fep-&gt;tx_full
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* The interrupt handler.&n; * This is called from the MPC core interrupt.&n; */
r_static
r_void
DECL|function|fec_enet_interrupt
id|fec_enet_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|dev_id
suffix:semicolon
r_volatile
id|fec_t
op_star
id|fecp
suffix:semicolon
id|uint
id|int_events
suffix:semicolon
macro_line|#ifdef CONFIG_FEC_PACKETHOOK
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
id|__u32
id|regval
suffix:semicolon
r_if
c_cond
(paren
id|fep-&gt;ph_regaddr
)paren
id|regval
op_assign
op_star
id|fep-&gt;ph_regaddr
suffix:semicolon
macro_line|#endif
id|fecp
op_assign
(paren
r_volatile
id|fec_t
op_star
)paren
id|dev-&gt;base_addr
suffix:semicolon
multiline_comment|/* Get the interrupt events that caused us to be here.&n;&t;*/
r_while
c_loop
(paren
(paren
id|int_events
op_assign
id|fecp-&gt;fec_ievent
)paren
op_ne
l_int|0
)paren
(brace
id|fecp-&gt;fec_ievent
op_assign
id|int_events
suffix:semicolon
r_if
c_cond
(paren
(paren
id|int_events
op_amp
(paren
id|FEC_ENET_HBERR
op_or
id|FEC_ENET_BABR
op_or
id|FEC_ENET_BABT
op_or
id|FEC_ENET_EBERR
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;FEC ERROR %x&bslash;n&quot;
comma
id|int_events
)paren
suffix:semicolon
)brace
multiline_comment|/* Handle receive event in its own function.&n;&t;&t; */
r_if
c_cond
(paren
id|int_events
op_amp
id|FEC_ENET_RXF
)paren
(brace
macro_line|#ifdef CONFIG_FEC_PACKETHOOK
id|fec_enet_rx
c_func
(paren
id|dev
comma
id|regval
)paren
suffix:semicolon
macro_line|#else
id|fec_enet_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Transmit OK, or non-fatal error. Update the buffer&n;&t;&t;   descriptors. FEC handles all errors, we just discover&n;&t;&t;   them as part of the transmit process.&n;&t;&t;*/
r_if
c_cond
(paren
id|int_events
op_amp
id|FEC_ENET_TXF
)paren
(brace
macro_line|#ifdef CONFIG_FEC_PACKETHOOK
id|fec_enet_tx
c_func
(paren
id|dev
comma
id|regval
)paren
suffix:semicolon
macro_line|#else
id|fec_enet_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|int_events
op_amp
id|FEC_ENET_MII
)paren
(brace
id|fec_enet_mii
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
)brace
r_static
r_void
macro_line|#ifdef CONFIG_FEC_PACKETHOOK
DECL|function|fec_enet_tx
id|fec_enet_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|__u32
id|regval
)paren
macro_line|#else
id|fec_enet_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
macro_line|#endif
(brace
r_struct
id|fec_enet_private
op_star
id|fep
suffix:semicolon
r_volatile
id|cbd_t
op_star
id|bdp
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|fep-&gt;lock
)paren
suffix:semicolon
id|bdp
op_assign
id|fep-&gt;dirty_tx
suffix:semicolon
r_while
c_loop
(paren
(paren
id|bdp-&gt;cbd_sc
op_amp
id|BD_ENET_TX_READY
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|bdp
op_eq
id|fep-&gt;cur_tx
op_logical_and
id|fep-&gt;tx_full
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|skb
op_assign
id|fep-&gt;tx_skbuff
(braket
id|fep-&gt;skb_dirty
)braket
suffix:semicolon
multiline_comment|/* Check for errors. */
r_if
c_cond
(paren
id|bdp-&gt;cbd_sc
op_amp
(paren
id|BD_ENET_TX_HB
op_or
id|BD_ENET_TX_LC
op_or
id|BD_ENET_TX_RL
op_or
id|BD_ENET_TX_UN
op_or
id|BD_ENET_TX_CSL
)paren
)paren
(brace
id|fep-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|bdp-&gt;cbd_sc
op_amp
id|BD_ENET_TX_HB
)paren
multiline_comment|/* No heartbeat */
id|fep-&gt;stats.tx_heartbeat_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|bdp-&gt;cbd_sc
op_amp
id|BD_ENET_TX_LC
)paren
multiline_comment|/* Late collision */
id|fep-&gt;stats.tx_window_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|bdp-&gt;cbd_sc
op_amp
id|BD_ENET_TX_RL
)paren
multiline_comment|/* Retrans limit */
id|fep-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|bdp-&gt;cbd_sc
op_amp
id|BD_ENET_TX_UN
)paren
multiline_comment|/* Underrun */
id|fep-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|bdp-&gt;cbd_sc
op_amp
id|BD_ENET_TX_CSL
)paren
multiline_comment|/* Carrier lost */
id|fep-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
macro_line|#ifdef CONFIG_FEC_PACKETHOOK
multiline_comment|/* Packet hook ... */
r_if
c_cond
(paren
id|fep-&gt;ph_txhandler
op_logical_and
(paren
(paren
r_struct
id|ethhdr
op_star
)paren
id|skb-&gt;data
)paren
op_member_access_from_pointer
id|h_proto
op_eq
id|fep-&gt;ph_proto
)paren
(brace
id|fep
op_member_access_from_pointer
id|ph_txhandler
c_func
(paren
(paren
id|__u8
op_star
)paren
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|regval
comma
id|fep-&gt;ph_priv
)paren
suffix:semicolon
)brace
macro_line|#endif
id|fep-&gt;stats.tx_packets
op_increment
suffix:semicolon
)brace
macro_line|#ifndef final_version
r_if
c_cond
(paren
id|bdp-&gt;cbd_sc
op_amp
id|BD_ENET_TX_READY
)paren
id|printk
c_func
(paren
l_string|&quot;HEY! Enet xmit interrupt and TX_READY.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Deferred means some collisions occurred during transmit,&n;&t;&t; * but we eventually sent the packet OK.&n;&t;&t; */
r_if
c_cond
(paren
id|bdp-&gt;cbd_sc
op_amp
id|BD_ENET_TX_DEF
)paren
id|fep-&gt;stats.collisions
op_increment
suffix:semicolon
multiline_comment|/* Free the sk buffer associated with this last transmit.&n;&t;&t; */
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;TXI: %x %x %x&bslash;n&quot;
comma
id|bdp
comma
id|skb
comma
id|fep-&gt;skb_dirty
)paren
suffix:semicolon
macro_line|#endif
id|dev_kfree_skb
c_func
(paren
id|skb
multiline_comment|/*, FREE_WRITE*/
)paren
suffix:semicolon
id|fep-&gt;tx_skbuff
(braket
id|fep-&gt;skb_dirty
)braket
op_assign
l_int|NULL
suffix:semicolon
id|fep-&gt;skb_dirty
op_assign
(paren
id|fep-&gt;skb_dirty
op_plus
l_int|1
)paren
op_amp
id|TX_RING_MOD_MASK
suffix:semicolon
multiline_comment|/* Update pointer to next buffer descriptor to be transmitted.&n;&t;&t; */
r_if
c_cond
(paren
id|bdp-&gt;cbd_sc
op_amp
id|BD_ENET_TX_WRAP
)paren
id|bdp
op_assign
id|fep-&gt;tx_bd_base
suffix:semicolon
r_else
id|bdp
op_increment
suffix:semicolon
multiline_comment|/* Since we have freed up a buffer, the ring is no longer&n;&t;&t; * full.&n;&t;&t; */
r_if
c_cond
(paren
id|fep-&gt;tx_full
)paren
(brace
id|fep-&gt;tx_full
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_FEC_PACKETHOOK
multiline_comment|/* Re-read register. Not exactly guaranteed to be correct,&n;&t;&t;   but... */
r_if
c_cond
(paren
id|fep-&gt;ph_regaddr
)paren
id|regval
op_assign
op_star
id|fep-&gt;ph_regaddr
suffix:semicolon
macro_line|#endif
)brace
id|fep-&gt;dirty_tx
op_assign
(paren
id|cbd_t
op_star
)paren
id|bdp
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|fep-&gt;lock
)paren
suffix:semicolon
)brace
multiline_comment|/* During a receive, the cur_rx points to the current incoming buffer.&n; * When we update through the ring, if the next incoming buffer has&n; * not been given to the system, we just set the empty indicator,&n; * effectively tossing the packet.&n; */
r_static
r_void
macro_line|#ifdef CONFIG_FEC_PACKETHOOK
DECL|function|fec_enet_rx
id|fec_enet_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|__u32
id|regval
)paren
macro_line|#else
id|fec_enet_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
macro_line|#endif
(brace
r_struct
id|fec_enet_private
op_star
id|fep
suffix:semicolon
r_volatile
id|fec_t
op_star
id|fecp
suffix:semicolon
r_volatile
id|cbd_t
op_star
id|bdp
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|ushort
id|pkt_len
suffix:semicolon
id|__u8
op_star
id|data
suffix:semicolon
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
id|fecp
op_assign
(paren
r_volatile
id|fec_t
op_star
)paren
id|dev-&gt;base_addr
suffix:semicolon
multiline_comment|/* First, grab all of the stats for the incoming packet.&n;&t; * These get messed up if we get called due to a busy condition.&n;&t; */
id|bdp
op_assign
id|fep-&gt;cur_rx
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|bdp-&gt;cbd_sc
op_amp
id|BD_ENET_RX_EMPTY
)paren
)paren
(brace
macro_line|#ifndef final_version
multiline_comment|/* Since we have allocated space to hold a complete frame,&n;&t; * the last indicator should be set.&n;&t; */
r_if
c_cond
(paren
(paren
id|bdp-&gt;cbd_sc
op_amp
id|BD_ENET_RX_LAST
)paren
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;FEC ENET: rcv is not +last&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Check for errors. */
r_if
c_cond
(paren
id|bdp-&gt;cbd_sc
op_amp
(paren
id|BD_ENET_RX_LG
op_or
id|BD_ENET_RX_SH
op_or
id|BD_ENET_RX_NO
op_or
id|BD_ENET_RX_CR
op_or
id|BD_ENET_RX_OV
)paren
)paren
(brace
id|fep-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|bdp-&gt;cbd_sc
op_amp
(paren
id|BD_ENET_RX_LG
op_or
id|BD_ENET_RX_SH
)paren
)paren
(brace
multiline_comment|/* Frame too long or too short. */
id|fep-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bdp-&gt;cbd_sc
op_amp
id|BD_ENET_RX_NO
)paren
multiline_comment|/* Frame alignment */
id|fep-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|bdp-&gt;cbd_sc
op_amp
id|BD_ENET_RX_CR
)paren
multiline_comment|/* CRC Error */
id|fep-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|bdp-&gt;cbd_sc
op_amp
id|BD_ENET_RX_OV
)paren
multiline_comment|/* FIFO overrun */
id|fep-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
)brace
multiline_comment|/* Report late collisions as a frame error.&n;&t; * On this error, the BD is closed, but we don&squot;t know what we&n;&t; * have in the buffer.  So, just drop this frame on the floor.&n;&t; */
r_if
c_cond
(paren
id|bdp-&gt;cbd_sc
op_amp
id|BD_ENET_RX_CL
)paren
(brace
id|fep-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|fep-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_goto
id|rx_processing_done
suffix:semicolon
)brace
multiline_comment|/* Process the incoming frame.&n;&t; */
id|fep-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|pkt_len
op_assign
id|bdp-&gt;cbd_datlen
suffix:semicolon
id|fep-&gt;stats.rx_bytes
op_add_assign
id|pkt_len
suffix:semicolon
id|data
op_assign
(paren
id|__u8
op_star
)paren
id|__va
c_func
(paren
id|bdp-&gt;cbd_bufaddr
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_FEC_PACKETHOOK
multiline_comment|/* Packet hook ... */
r_if
c_cond
(paren
id|fep-&gt;ph_rxhandler
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
r_struct
id|ethhdr
op_star
)paren
id|data
)paren
op_member_access_from_pointer
id|h_proto
op_eq
id|fep-&gt;ph_proto
)paren
(brace
r_switch
c_cond
(paren
id|fep
op_member_access_from_pointer
id|ph_rxhandler
c_func
(paren
id|data
comma
id|pkt_len
comma
id|regval
comma
id|fep-&gt;ph_priv
)paren
)paren
(brace
r_case
l_int|1
suffix:colon
r_goto
id|rx_processing_done
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|fep-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_goto
id|rx_processing_done
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* If it wasn&squot;t filtered - copy it to an sk buffer. */
macro_line|#endif
multiline_comment|/* This does 16 byte alignment, exactly what we need.&n;&t; * The packet length includes FCS, but we don&squot;t want to&n;&t; * include that when passing upstream as it messes up&n;&t; * bridging applications.&n;&t; */
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_len
op_minus
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Memory squeeze, dropping packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|fep-&gt;stats.rx_dropped
op_increment
suffix:semicolon
)brace
r_else
(brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
op_minus
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Make room */
id|eth_copy_and_sum
c_func
(paren
id|skb
comma
(paren
r_int
r_char
op_star
)paren
id|__va
c_func
(paren
id|bdp-&gt;cbd_bufaddr
)paren
comma
id|pkt_len
op_minus
l_int|4
comma
l_int|0
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
id|rx_processing_done
suffix:colon
multiline_comment|/* Clear the status flags for this buffer.&n;&t;*/
id|bdp-&gt;cbd_sc
op_and_assign
op_complement
id|BD_ENET_RX_STATS
suffix:semicolon
multiline_comment|/* Mark the buffer empty.&n;&t;*/
id|bdp-&gt;cbd_sc
op_or_assign
id|BD_ENET_RX_EMPTY
suffix:semicolon
multiline_comment|/* Update BD pointer to next entry.&n;&t;*/
r_if
c_cond
(paren
id|bdp-&gt;cbd_sc
op_amp
id|BD_ENET_RX_WRAP
)paren
id|bdp
op_assign
id|fep-&gt;rx_bd_base
suffix:semicolon
r_else
id|bdp
op_increment
suffix:semicolon
macro_line|#if 1
multiline_comment|/* Doing this here will keep the FEC running while we process&n;&t; * incoming frames.  On a heavily loaded network, we should be&n;&t; * able to keep up at the expense of system resources.&n;&t; */
id|fecp-&gt;fec_r_des_active
op_assign
l_int|0x01000000
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_FEC_PACKETHOOK
multiline_comment|/* Re-read register. Not exactly guaranteed to be correct,&n;&t;   but... */
r_if
c_cond
(paren
id|fep-&gt;ph_regaddr
)paren
id|regval
op_assign
op_star
id|fep-&gt;ph_regaddr
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* while (!(bdp-&gt;cbd_sc &amp; BD_ENET_RX_EMPTY)) */
id|fep-&gt;cur_rx
op_assign
(paren
id|cbd_t
op_star
)paren
id|bdp
suffix:semicolon
macro_line|#if 0
multiline_comment|/* Doing this here will allow us to process all frames in the&n;&t; * ring before the FEC is allowed to put more there.  On a heavily&n;&t; * loaded network, some frames may be lost.  Unfortunately, this&n;&t; * increases the interrupt overhead since we can potentially work&n;&t; * our way back to the interrupt return only to come right back&n;&t; * here.&n;&t; */
id|fecp-&gt;fec_r_des_active
op_assign
l_int|0x01000000
suffix:semicolon
macro_line|#endif
)brace
r_static
r_void
DECL|function|fec_enet_mii
id|fec_enet_mii
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
suffix:semicolon
r_volatile
id|fec_t
op_star
id|ep
suffix:semicolon
id|mii_list_t
op_star
id|mip
suffix:semicolon
id|uint
id|mii_reg
suffix:semicolon
id|fep
op_assign
(paren
r_struct
id|fec_enet_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ep
op_assign
op_amp
(paren
(paren
(paren
id|immap_t
op_star
)paren
id|IMAP_ADDR
)paren
op_member_access_from_pointer
id|im_cpm.cp_fec
)paren
suffix:semicolon
id|mii_reg
op_assign
id|ep-&gt;fec_mii_data
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mip
op_assign
id|mii_head
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;MII and no head!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mip-&gt;mii_func
op_ne
l_int|NULL
)paren
(paren
op_star
(paren
id|mip-&gt;mii_func
)paren
)paren
(paren
id|mii_reg
comma
id|dev
)paren
suffix:semicolon
id|mii_head
op_assign
id|mip-&gt;mii_next
suffix:semicolon
id|mip-&gt;mii_next
op_assign
id|mii_free
suffix:semicolon
id|mii_free
op_assign
id|mip
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mip
op_assign
id|mii_head
)paren
op_ne
l_int|NULL
)paren
id|ep-&gt;fec_mii_data
op_assign
id|mip-&gt;mii_regval
suffix:semicolon
)brace
r_static
r_int
DECL|function|mii_queue
id|mii_queue
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|regval
comma
r_void
(paren
op_star
id|func
)paren
(paren
id|uint
comma
r_struct
id|net_device
op_star
)paren
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|mii_list_t
op_star
id|mip
suffix:semicolon
r_int
id|retval
suffix:semicolon
multiline_comment|/* Add PHY address to register command.&n;&t;*/
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
id|regval
op_or_assign
id|fep-&gt;phy_addr
op_lshift
l_int|23
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mip
op_assign
id|mii_free
)paren
op_ne
l_int|NULL
)paren
(brace
id|mii_free
op_assign
id|mip-&gt;mii_next
suffix:semicolon
id|mip-&gt;mii_regval
op_assign
id|regval
suffix:semicolon
id|mip-&gt;mii_func
op_assign
id|func
suffix:semicolon
id|mip-&gt;mii_next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|mii_head
)paren
(brace
id|mii_tail-&gt;mii_next
op_assign
id|mip
suffix:semicolon
id|mii_tail
op_assign
id|mip
suffix:semicolon
)brace
r_else
(brace
id|mii_head
op_assign
id|mii_tail
op_assign
id|mip
suffix:semicolon
(paren
op_amp
(paren
(paren
(paren
id|immap_t
op_star
)paren
id|IMAP_ADDR
)paren
op_member_access_from_pointer
id|im_cpm.cp_fec
)paren
)paren
op_member_access_from_pointer
id|fec_mii_data
op_assign
id|regval
suffix:semicolon
)brace
)brace
r_else
(brace
id|retval
op_assign
l_int|1
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|mii_do_cmd
r_static
r_void
id|mii_do_cmd
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_const
id|phy_cmd_t
op_star
id|c
)paren
(brace
r_int
id|k
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c
)paren
(brace
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
(paren
id|c
op_plus
id|k
)paren
op_member_access_from_pointer
id|mii_data
op_ne
id|mk_mii_end
suffix:semicolon
id|k
op_increment
)paren
(brace
id|mii_queue
c_func
(paren
id|dev
comma
(paren
id|c
op_plus
id|k
)paren
op_member_access_from_pointer
id|mii_data
comma
(paren
id|c
op_plus
id|k
)paren
op_member_access_from_pointer
id|funct
)paren
suffix:semicolon
)brace
)brace
DECL|function|mii_parse_sr
r_static
r_void
id|mii_parse_sr
c_func
(paren
id|uint
id|mii_reg
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
r_volatile
id|uint
op_star
id|s
op_assign
op_amp
(paren
id|fep-&gt;phy_status
)paren
suffix:semicolon
op_star
id|s
op_and_assign
op_complement
(paren
id|PHY_STAT_LINK
op_or
id|PHY_STAT_FAULT
op_or
id|PHY_STAT_ANC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mii_reg
op_amp
l_int|0x0004
)paren
op_star
id|s
op_or_assign
id|PHY_STAT_LINK
suffix:semicolon
r_if
c_cond
(paren
id|mii_reg
op_amp
l_int|0x0010
)paren
op_star
id|s
op_or_assign
id|PHY_STAT_FAULT
suffix:semicolon
r_if
c_cond
(paren
id|mii_reg
op_amp
l_int|0x0020
)paren
op_star
id|s
op_or_assign
id|PHY_STAT_ANC
suffix:semicolon
)brace
DECL|function|mii_parse_cr
r_static
r_void
id|mii_parse_cr
c_func
(paren
id|uint
id|mii_reg
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
r_volatile
id|uint
op_star
id|s
op_assign
op_amp
(paren
id|fep-&gt;phy_status
)paren
suffix:semicolon
op_star
id|s
op_and_assign
op_complement
(paren
id|PHY_CONF_ANE
op_or
id|PHY_CONF_LOOP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mii_reg
op_amp
l_int|0x1000
)paren
op_star
id|s
op_or_assign
id|PHY_CONF_ANE
suffix:semicolon
r_if
c_cond
(paren
id|mii_reg
op_amp
l_int|0x4000
)paren
op_star
id|s
op_or_assign
id|PHY_CONF_LOOP
suffix:semicolon
)brace
DECL|function|mii_parse_anar
r_static
r_void
id|mii_parse_anar
c_func
(paren
id|uint
id|mii_reg
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
r_volatile
id|uint
op_star
id|s
op_assign
op_amp
(paren
id|fep-&gt;phy_status
)paren
suffix:semicolon
op_star
id|s
op_and_assign
op_complement
(paren
id|PHY_CONF_SPMASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mii_reg
op_amp
l_int|0x0020
)paren
op_star
id|s
op_or_assign
id|PHY_CONF_10HDX
suffix:semicolon
r_if
c_cond
(paren
id|mii_reg
op_amp
l_int|0x0040
)paren
op_star
id|s
op_or_assign
id|PHY_CONF_10FDX
suffix:semicolon
r_if
c_cond
(paren
id|mii_reg
op_amp
l_int|0x0080
)paren
op_star
id|s
op_or_assign
id|PHY_CONF_100HDX
suffix:semicolon
r_if
c_cond
(paren
id|mii_reg
op_amp
l_int|0x00100
)paren
op_star
id|s
op_or_assign
id|PHY_CONF_100FDX
suffix:semicolon
)brace
macro_line|#if 0
r_static
r_void
id|mii_disp_reg
c_func
(paren
id|uint
id|mii_reg
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;reg %u = 0x%04x&bslash;n&quot;
comma
(paren
id|mii_reg
op_rshift
l_int|18
)paren
op_amp
l_int|0x1f
comma
id|mii_reg
op_amp
l_int|0xffff
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* ------------------------------------------------------------------------- */
multiline_comment|/* The Level one LXT970 is used by many boards&t;&t;&t;&t;     */
macro_line|#ifdef CONFIG_FEC_LXT970
DECL|macro|MII_LXT970_MIRROR
mdefine_line|#define MII_LXT970_MIRROR    16  /* Mirror register           */
DECL|macro|MII_LXT970_IER
mdefine_line|#define MII_LXT970_IER       17  /* Interrupt Enable Register */
DECL|macro|MII_LXT970_ISR
mdefine_line|#define MII_LXT970_ISR       18  /* Interrupt Status Register */
DECL|macro|MII_LXT970_CONFIG
mdefine_line|#define MII_LXT970_CONFIG    19  /* Configuration Register    */
DECL|macro|MII_LXT970_CSR
mdefine_line|#define MII_LXT970_CSR       20  /* Chip Status Register      */
DECL|function|mii_parse_lxt970_csr
r_static
r_void
id|mii_parse_lxt970_csr
c_func
(paren
id|uint
id|mii_reg
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
r_volatile
id|uint
op_star
id|s
op_assign
op_amp
(paren
id|fep-&gt;phy_status
)paren
suffix:semicolon
op_star
id|s
op_and_assign
op_complement
(paren
id|PHY_STAT_SPMASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mii_reg
op_amp
l_int|0x0800
)paren
(brace
r_if
c_cond
(paren
id|mii_reg
op_amp
l_int|0x1000
)paren
op_star
id|s
op_or_assign
id|PHY_STAT_100FDX
suffix:semicolon
r_else
op_star
id|s
op_or_assign
id|PHY_STAT_100HDX
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|mii_reg
op_amp
l_int|0x1000
)paren
op_star
id|s
op_or_assign
id|PHY_STAT_10FDX
suffix:semicolon
r_else
op_star
id|s
op_or_assign
id|PHY_STAT_10HDX
suffix:semicolon
)brace
)brace
DECL|variable|phy_info_lxt970
r_static
id|phy_info_t
id|phy_info_lxt970
op_assign
(brace
l_int|0x07810000
comma
l_string|&quot;LXT970&quot;
comma
(paren
r_const
id|phy_cmd_t
(braket
)braket
)paren
(brace
multiline_comment|/* config */
macro_line|#if 0
singleline_comment|//&t;&t;{ mk_mii_write(MII_REG_ANAR, 0x0021), NULL },
multiline_comment|/* Set default operation of 100-TX....for some reason&n;&t;&t; * some of these bits are set on power up, which is wrong.&n;&t;&t; */
(brace
id|mk_mii_write
c_func
(paren
id|MII_LXT970_CONFIG
comma
l_int|0
)paren
comma
l_int|NULL
)brace
comma
macro_line|#endif
(brace
id|mk_mii_read
c_func
(paren
id|MII_REG_CR
)paren
comma
id|mii_parse_cr
)brace
comma
(brace
id|mk_mii_read
c_func
(paren
id|MII_REG_ANAR
)paren
comma
id|mii_parse_anar
)brace
comma
(brace
id|mk_mii_end
comma
)brace
)brace
comma
(paren
r_const
id|phy_cmd_t
(braket
)braket
)paren
(brace
multiline_comment|/* startup - enable interrupts */
(brace
id|mk_mii_write
c_func
(paren
id|MII_LXT970_IER
comma
l_int|0x0002
)paren
comma
l_int|NULL
)brace
comma
(brace
id|mk_mii_write
c_func
(paren
id|MII_REG_CR
comma
l_int|0x1200
)paren
comma
l_int|NULL
)brace
comma
multiline_comment|/* autonegotiate */
(brace
id|mk_mii_end
comma
)brace
)brace
comma
(paren
r_const
id|phy_cmd_t
(braket
)braket
)paren
(brace
multiline_comment|/* ack_int */
multiline_comment|/* read SR and ISR to acknowledge */
(brace
id|mk_mii_read
c_func
(paren
id|MII_REG_SR
)paren
comma
id|mii_parse_sr
)brace
comma
(brace
id|mk_mii_read
c_func
(paren
id|MII_LXT970_ISR
)paren
comma
l_int|NULL
)brace
comma
multiline_comment|/* find out the current status */
(brace
id|mk_mii_read
c_func
(paren
id|MII_LXT970_CSR
)paren
comma
id|mii_parse_lxt970_csr
)brace
comma
(brace
id|mk_mii_end
comma
)brace
)brace
comma
(paren
r_const
id|phy_cmd_t
(braket
)braket
)paren
(brace
multiline_comment|/* shutdown - disable interrupts */
(brace
id|mk_mii_write
c_func
(paren
id|MII_LXT970_IER
comma
l_int|0x0000
)paren
comma
l_int|NULL
)brace
comma
(brace
id|mk_mii_end
comma
)brace
)brace
comma
)brace
suffix:semicolon
macro_line|#endif /* CONFIG_FEC_LXT970 */
multiline_comment|/* ------------------------------------------------------------------------- */
multiline_comment|/* The Level one LXT971 is used on some of my custom boards                  */
macro_line|#ifdef CONFIG_FEC_LXT971
multiline_comment|/* register definitions for the 971 */
DECL|macro|MII_LXT971_PCR
mdefine_line|#define MII_LXT971_PCR       16  /* Port Control Register     */
DECL|macro|MII_LXT971_SR2
mdefine_line|#define MII_LXT971_SR2       17  /* Status Register 2         */
DECL|macro|MII_LXT971_IER
mdefine_line|#define MII_LXT971_IER       18  /* Interrupt Enable Register */
DECL|macro|MII_LXT971_ISR
mdefine_line|#define MII_LXT971_ISR       19  /* Interrupt Status Register */
DECL|macro|MII_LXT971_LCR
mdefine_line|#define MII_LXT971_LCR       20  /* LED Control Register      */
DECL|macro|MII_LXT971_TCR
mdefine_line|#define MII_LXT971_TCR       30  /* Transmit Control Register */
multiline_comment|/* &n; * I had some nice ideas of running the MDIO faster...&n; * The 971 should support 8MHz and I tried it, but things acted really&n; * wierd, so 2.5 MHz ought to be enough for anyone...&n; */
DECL|function|mii_parse_lxt971_sr2
r_static
r_void
id|mii_parse_lxt971_sr2
c_func
(paren
id|uint
id|mii_reg
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
r_volatile
id|uint
op_star
id|s
op_assign
op_amp
(paren
id|fep-&gt;phy_status
)paren
suffix:semicolon
op_star
id|s
op_and_assign
op_complement
(paren
id|PHY_STAT_SPMASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mii_reg
op_amp
l_int|0x4000
)paren
(brace
r_if
c_cond
(paren
id|mii_reg
op_amp
l_int|0x0200
)paren
op_star
id|s
op_or_assign
id|PHY_STAT_100FDX
suffix:semicolon
r_else
op_star
id|s
op_or_assign
id|PHY_STAT_100HDX
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|mii_reg
op_amp
l_int|0x0200
)paren
op_star
id|s
op_or_assign
id|PHY_STAT_10FDX
suffix:semicolon
r_else
op_star
id|s
op_or_assign
id|PHY_STAT_10HDX
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mii_reg
op_amp
l_int|0x0008
)paren
op_star
id|s
op_or_assign
id|PHY_STAT_FAULT
suffix:semicolon
)brace
DECL|variable|phy_info_lxt971
r_static
id|phy_info_t
id|phy_info_lxt971
op_assign
(brace
l_int|0x0001378e
comma
l_string|&quot;LXT971&quot;
comma
(paren
r_const
id|phy_cmd_t
(braket
)braket
)paren
(brace
multiline_comment|/* config */
multiline_comment|/* limit to 10MBit because my protorype board &n;&t;&t; * doesn&squot;t work with 100. */
(brace
id|mk_mii_write
c_func
(paren
id|MII_REG_ANAR
comma
l_int|0x061
)paren
comma
l_int|NULL
)brace
comma
multiline_comment|/* 10 MBit */
(brace
id|mk_mii_read
c_func
(paren
id|MII_REG_CR
)paren
comma
id|mii_parse_cr
)brace
comma
(brace
id|mk_mii_read
c_func
(paren
id|MII_REG_ANAR
)paren
comma
id|mii_parse_anar
)brace
comma
(brace
id|mk_mii_end
comma
)brace
)brace
comma
(paren
r_const
id|phy_cmd_t
(braket
)braket
)paren
(brace
multiline_comment|/* startup - enable interrupts */
(brace
id|mk_mii_write
c_func
(paren
id|MII_LXT971_IER
comma
l_int|0x00f2
)paren
comma
l_int|NULL
)brace
comma
(brace
id|mk_mii_write
c_func
(paren
id|MII_REG_CR
comma
l_int|0x1200
)paren
comma
l_int|NULL
)brace
comma
multiline_comment|/* autonegotiate */
multiline_comment|/* Somehow does the 971 tell me that the link is down&n;&t;&t; * the first read after power-up.&n;&t;&t; * read here to get a valid value in ack_int */
(brace
id|mk_mii_read
c_func
(paren
id|MII_REG_SR
)paren
comma
id|mii_parse_sr
)brace
comma
(brace
id|mk_mii_end
comma
)brace
)brace
comma
(paren
r_const
id|phy_cmd_t
(braket
)braket
)paren
(brace
multiline_comment|/* ack_int */
multiline_comment|/* find out the current status */
(brace
id|mk_mii_read
c_func
(paren
id|MII_REG_SR
)paren
comma
id|mii_parse_sr
)brace
comma
(brace
id|mk_mii_read
c_func
(paren
id|MII_LXT971_SR2
)paren
comma
id|mii_parse_lxt971_sr2
)brace
comma
multiline_comment|/* we only need to read ISR to acknowledge */
(brace
id|mk_mii_read
c_func
(paren
id|MII_LXT971_ISR
)paren
comma
l_int|NULL
)brace
comma
(brace
id|mk_mii_end
comma
)brace
)brace
comma
(paren
r_const
id|phy_cmd_t
(braket
)braket
)paren
(brace
multiline_comment|/* shutdown - disable interrupts */
(brace
id|mk_mii_write
c_func
(paren
id|MII_LXT971_IER
comma
l_int|0x0000
)paren
comma
l_int|NULL
)brace
comma
(brace
id|mk_mii_end
comma
)brace
)brace
comma
)brace
suffix:semicolon
macro_line|#endif /* CONFIG_FEC_LXT970 */
multiline_comment|/* ------------------------------------------------------------------------- */
multiline_comment|/* The Quality Semiconductor QS6612 is used on the RPX CLLF                  */
macro_line|#ifdef CONFIG_FEC_QS6612
multiline_comment|/* register definitions */
DECL|macro|MII_QS6612_MCR
mdefine_line|#define MII_QS6612_MCR       17  /* Mode Control Register      */
DECL|macro|MII_QS6612_FTR
mdefine_line|#define MII_QS6612_FTR       27  /* Factory Test Register      */
DECL|macro|MII_QS6612_MCO
mdefine_line|#define MII_QS6612_MCO       28  /* Misc. Control Register     */
DECL|macro|MII_QS6612_ISR
mdefine_line|#define MII_QS6612_ISR       29  /* Interrupt Source Register  */
DECL|macro|MII_QS6612_IMR
mdefine_line|#define MII_QS6612_IMR       30  /* Interrupt Mask Register    */
DECL|macro|MII_QS6612_PCR
mdefine_line|#define MII_QS6612_PCR       31  /* 100BaseTx PHY Control Reg. */
DECL|function|mii_parse_qs6612_pcr
r_static
r_void
id|mii_parse_qs6612_pcr
c_func
(paren
id|uint
id|mii_reg
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
r_volatile
id|uint
op_star
id|s
op_assign
op_amp
(paren
id|fep-&gt;phy_status
)paren
suffix:semicolon
op_star
id|s
op_and_assign
op_complement
(paren
id|PHY_STAT_SPMASK
)paren
suffix:semicolon
r_switch
c_cond
(paren
(paren
id|mii_reg
op_rshift
l_int|2
)paren
op_amp
l_int|7
)paren
(brace
r_case
l_int|1
suffix:colon
op_star
id|s
op_or_assign
id|PHY_STAT_10HDX
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
op_star
id|s
op_or_assign
id|PHY_STAT_100HDX
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
op_star
id|s
op_or_assign
id|PHY_STAT_10FDX
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
op_star
id|s
op_or_assign
id|PHY_STAT_100FDX
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|variable|phy_info_qs6612
r_static
id|phy_info_t
id|phy_info_qs6612
op_assign
(brace
l_int|0x00181440
comma
l_string|&quot;QS6612&quot;
comma
(paren
r_const
id|phy_cmd_t
(braket
)braket
)paren
(brace
multiline_comment|/* config */
singleline_comment|//&t;{ mk_mii_write(MII_REG_ANAR, 0x061), NULL }, /* 10 MBit */
multiline_comment|/* The PHY powers up isolated on the RPX, &n;&t;&t; * so send a command to allow operation.&n;&t;&t; */
(brace
id|mk_mii_write
c_func
(paren
id|MII_QS6612_PCR
comma
l_int|0x0dc0
)paren
comma
l_int|NULL
)brace
comma
multiline_comment|/* parse cr and anar to get some info */
(brace
id|mk_mii_read
c_func
(paren
id|MII_REG_CR
)paren
comma
id|mii_parse_cr
)brace
comma
(brace
id|mk_mii_read
c_func
(paren
id|MII_REG_ANAR
)paren
comma
id|mii_parse_anar
)brace
comma
(brace
id|mk_mii_end
comma
)brace
)brace
comma
(paren
r_const
id|phy_cmd_t
(braket
)braket
)paren
(brace
multiline_comment|/* startup - enable interrupts */
(brace
id|mk_mii_write
c_func
(paren
id|MII_QS6612_IMR
comma
l_int|0x003a
)paren
comma
l_int|NULL
)brace
comma
(brace
id|mk_mii_write
c_func
(paren
id|MII_REG_CR
comma
l_int|0x1200
)paren
comma
l_int|NULL
)brace
comma
multiline_comment|/* autonegotiate */
(brace
id|mk_mii_end
comma
)brace
)brace
comma
(paren
r_const
id|phy_cmd_t
(braket
)braket
)paren
(brace
multiline_comment|/* ack_int */
multiline_comment|/* we need to read ISR, SR and ANER to acknowledge */
(brace
id|mk_mii_read
c_func
(paren
id|MII_QS6612_ISR
)paren
comma
l_int|NULL
)brace
comma
(brace
id|mk_mii_read
c_func
(paren
id|MII_REG_SR
)paren
comma
id|mii_parse_sr
)brace
comma
(brace
id|mk_mii_read
c_func
(paren
id|MII_REG_ANER
)paren
comma
l_int|NULL
)brace
comma
multiline_comment|/* read pcr to get info */
(brace
id|mk_mii_read
c_func
(paren
id|MII_QS6612_PCR
)paren
comma
id|mii_parse_qs6612_pcr
)brace
comma
(brace
id|mk_mii_end
comma
)brace
)brace
comma
(paren
r_const
id|phy_cmd_t
(braket
)braket
)paren
(brace
multiline_comment|/* shutdown - disable interrupts */
(brace
id|mk_mii_write
c_func
(paren
id|MII_QS6612_IMR
comma
l_int|0x0000
)paren
comma
l_int|NULL
)brace
comma
(brace
id|mk_mii_end
comma
)brace
)brace
comma
)brace
suffix:semicolon
macro_line|#endif /* CONFIG_FEC_QS6612 */
DECL|variable|phy_info
r_static
id|phy_info_t
op_star
id|phy_info
(braket
)braket
op_assign
(brace
macro_line|#ifdef CONFIG_FEC_LXT970
op_amp
id|phy_info_lxt970
comma
macro_line|#endif /* CONFIG_FEC_LXT970 */
macro_line|#ifdef CONFIG_FEC_LXT971
op_amp
id|phy_info_lxt971
comma
macro_line|#endif /* CONFIG_FEC_LXT971 */
macro_line|#ifdef CONFIG_FEC_QS6612
op_amp
id|phy_info_qs6612
comma
macro_line|#endif /* CONFIG_FEC_LXT971 */
l_int|NULL
)brace
suffix:semicolon
DECL|function|mii_display_status
r_static
r_void
id|mii_display_status
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
r_volatile
id|uint
op_star
id|s
op_assign
op_amp
(paren
id|fep-&gt;phy_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fep-&gt;link
op_logical_and
op_logical_neg
id|fep-&gt;old_link
)paren
(brace
multiline_comment|/* Link is still down - don&squot;t print anything */
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%s: status: &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fep-&gt;link
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;link down&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;link up&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|s
op_amp
id|PHY_STAT_SPMASK
)paren
(brace
r_case
id|PHY_STAT_100FDX
suffix:colon
id|printk
c_func
(paren
l_string|&quot;, 100MBit Full Duplex&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHY_STAT_100HDX
suffix:colon
id|printk
c_func
(paren
l_string|&quot;, 100MBit Half Duplex&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHY_STAT_10FDX
suffix:colon
id|printk
c_func
(paren
l_string|&quot;, 10MBit Full Duplex&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PHY_STAT_10HDX
suffix:colon
id|printk
c_func
(paren
l_string|&quot;, 10MBit Half Duplex&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;, Unknown speed/duplex&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|s
op_amp
id|PHY_STAT_ANC
)paren
id|printk
c_func
(paren
l_string|&quot;, auto-negotiation complete&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|s
op_amp
id|PHY_STAT_FAULT
)paren
id|printk
c_func
(paren
l_string|&quot;, remote fault&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;.&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|mii_display_config
r_static
r_void
id|mii_display_config
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
r_volatile
id|uint
op_star
id|s
op_assign
op_amp
(paren
id|fep-&gt;phy_status
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: config: auto-negotiation &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|s
op_amp
id|PHY_CONF_ANE
)paren
id|printk
c_func
(paren
l_string|&quot;on&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;off&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|s
op_amp
id|PHY_CONF_100FDX
)paren
id|printk
c_func
(paren
l_string|&quot;, 100FDX&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|s
op_amp
id|PHY_CONF_100HDX
)paren
id|printk
c_func
(paren
l_string|&quot;, 100HDX&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|s
op_amp
id|PHY_CONF_10FDX
)paren
id|printk
c_func
(paren
l_string|&quot;, 10FDX&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|s
op_amp
id|PHY_CONF_10HDX
)paren
id|printk
c_func
(paren
l_string|&quot;, 10HDX&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|s
op_amp
id|PHY_CONF_SPMASK
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;, No speed/duplex selected?&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|s
op_amp
id|PHY_CONF_LOOP
)paren
id|printk
c_func
(paren
l_string|&quot;, loopback enabled&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;.&bslash;n&quot;
)paren
suffix:semicolon
id|fep-&gt;sequence_done
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|mii_relink
r_static
r_void
id|mii_relink
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|duplex
suffix:semicolon
id|fep-&gt;link
op_assign
(paren
id|fep-&gt;phy_status
op_amp
id|PHY_STAT_LINK
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|mii_display_status
c_func
(paren
id|dev
)paren
suffix:semicolon
id|fep-&gt;old_link
op_assign
id|fep-&gt;link
suffix:semicolon
r_if
c_cond
(paren
id|fep-&gt;link
)paren
(brace
id|duplex
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|fep-&gt;phy_status
op_amp
(paren
id|PHY_STAT_100FDX
op_or
id|PHY_STAT_10FDX
)paren
)paren
id|duplex
op_assign
l_int|1
suffix:semicolon
id|fec_restart
c_func
(paren
id|dev
comma
id|duplex
)paren
suffix:semicolon
)brace
r_else
id|fec_stop
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#if 0
id|enable_irq
c_func
(paren
id|fep-&gt;mii_irq
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|mii_queue_relink
r_static
r_void
id|mii_queue_relink
c_func
(paren
id|uint
id|mii_reg
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
id|fep-&gt;phy_task.routine
op_assign
(paren
r_void
op_star
)paren
id|mii_relink
suffix:semicolon
id|fep-&gt;phy_task.data
op_assign
id|dev
suffix:semicolon
id|schedule_task
c_func
(paren
op_amp
id|fep-&gt;phy_task
)paren
suffix:semicolon
)brace
DECL|function|mii_queue_config
r_static
r_void
id|mii_queue_config
c_func
(paren
id|uint
id|mii_reg
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
id|fep-&gt;phy_task.routine
op_assign
(paren
r_void
op_star
)paren
id|mii_display_config
suffix:semicolon
id|fep-&gt;phy_task.data
op_assign
id|dev
suffix:semicolon
id|schedule_task
c_func
(paren
op_amp
id|fep-&gt;phy_task
)paren
suffix:semicolon
)brace
DECL|variable|phy_cmd_relink
id|phy_cmd_t
id|phy_cmd_relink
(braket
)braket
op_assign
(brace
(brace
id|mk_mii_read
c_func
(paren
id|MII_REG_CR
)paren
comma
id|mii_queue_relink
)brace
comma
(brace
id|mk_mii_end
comma
)brace
)brace
suffix:semicolon
DECL|variable|phy_cmd_config
id|phy_cmd_t
id|phy_cmd_config
(braket
)braket
op_assign
(brace
(brace
id|mk_mii_read
c_func
(paren
id|MII_REG_CR
)paren
comma
id|mii_queue_config
)brace
comma
(brace
id|mk_mii_end
comma
)brace
)brace
suffix:semicolon
multiline_comment|/* Read remainder of PHY ID.&n;*/
r_static
r_void
DECL|function|mii_discover_phy3
id|mii_discover_phy3
c_func
(paren
id|uint
id|mii_reg
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
suffix:semicolon
r_int
id|i
suffix:semicolon
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
id|fep-&gt;phy_id
op_or_assign
(paren
id|mii_reg
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;fec: Phy @ 0x%x, type 0x%08x&bslash;n&quot;
comma
id|fep-&gt;phy_addr
comma
id|fep-&gt;phy_id
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|phy_info
(braket
id|i
)braket
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|phy_info
(braket
id|i
)braket
op_member_access_from_pointer
id|id
op_eq
(paren
id|fep-&gt;phy_id
op_rshift
l_int|4
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|phy_info
(braket
id|i
)braket
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;%s: PHY id 0x%08x is not supported!&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|fep-&gt;phy_id
)paren
suffix:semicolon
)brace
id|fep-&gt;phy
op_assign
id|phy_info
(braket
id|i
)braket
suffix:semicolon
id|fep-&gt;phy_id_done
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Scan all of the MII PHY addresses looking for someone to respond&n; * with a valid ID.  This usually happens quickly.&n; */
r_static
r_void
DECL|function|mii_discover_phy
id|mii_discover_phy
c_func
(paren
id|uint
id|mii_reg
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
suffix:semicolon
id|uint
id|phytype
suffix:semicolon
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|fep-&gt;phy_addr
OL
l_int|32
)paren
(brace
r_if
c_cond
(paren
(paren
id|phytype
op_assign
(paren
id|mii_reg
op_amp
l_int|0xffff
)paren
)paren
op_ne
l_int|0xffff
)paren
(brace
multiline_comment|/* Got first part of ID, now get remainder.&n;&t;&t;&t;*/
id|fep-&gt;phy_id
op_assign
id|phytype
op_lshift
l_int|16
suffix:semicolon
id|mii_queue
c_func
(paren
id|dev
comma
id|mk_mii_read
c_func
(paren
id|MII_REG_PHYIR2
)paren
comma
id|mii_discover_phy3
)paren
suffix:semicolon
)brace
r_else
(brace
id|fep-&gt;phy_addr
op_increment
suffix:semicolon
id|mii_queue
c_func
(paren
id|dev
comma
id|mk_mii_read
c_func
(paren
id|MII_REG_PHYIR1
)paren
comma
id|mii_discover_phy
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;FEC: No PHY device found.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* This interrupt occurs when the PHY detects a link change.&n;*/
r_static
r_void
macro_line|#ifdef CONFIG_RPXCLASSIC
DECL|function|mii_link_interrupt
id|mii_link_interrupt
c_func
(paren
r_void
op_star
id|dev_id
)paren
macro_line|#else
id|mii_link_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
macro_line|#endif
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|dev_id
suffix:semicolon
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
macro_line|#if 0
id|disable_irq
c_func
(paren
id|fep-&gt;mii_irq
)paren
suffix:semicolon
multiline_comment|/* disable now, enable later */
macro_line|#endif
id|mii_do_cmd
c_func
(paren
id|dev
comma
id|fep-&gt;phy-&gt;ack_int
)paren
suffix:semicolon
id|mii_do_cmd
c_func
(paren
id|dev
comma
id|phy_cmd_relink
)paren
suffix:semicolon
multiline_comment|/* restart and display status */
)brace
r_static
r_int
DECL|function|fec_enet_open
id|fec_enet_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* I should reset the ring buffers here, but I don&squot;t yet know&n;&t; * a simple way to do that.&n;&t; */
id|fep-&gt;sequence_done
op_assign
l_int|0
suffix:semicolon
id|fep-&gt;link
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|fep-&gt;phy
)paren
(brace
id|mii_do_cmd
c_func
(paren
id|dev
comma
id|fep-&gt;phy-&gt;ack_int
)paren
suffix:semicolon
id|mii_do_cmd
c_func
(paren
id|dev
comma
id|fep-&gt;phy-&gt;config
)paren
suffix:semicolon
id|mii_do_cmd
c_func
(paren
id|dev
comma
id|phy_cmd_config
)paren
suffix:semicolon
multiline_comment|/* display configuration */
r_while
c_loop
(paren
op_logical_neg
id|fep-&gt;sequence_done
)paren
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
id|mii_do_cmd
c_func
(paren
id|dev
comma
id|fep-&gt;phy-&gt;startup
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Success */
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* No PHY we understand */
)brace
r_static
r_int
DECL|function|fec_enet_close
id|fec_enet_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
multiline_comment|/* Don&squot;t know what to do yet.&n;&t;*/
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|fec_stop
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|fec_enet_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|fec_enet_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
(paren
r_struct
id|fec_enet_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|fep-&gt;stats
suffix:semicolon
)brace
multiline_comment|/* Set or clear the multicast filter for this adaptor.&n; * Skeleton taken from sunlance driver.&n; * The CPM Ethernet implementation allows Multicast as well as individual&n; * MAC address filtering.  Some of the drivers check to make sure it is&n; * a group multicast address, and discard those that are not.  I guess I&n; * will do the same for now, but just remove the test if you want&n; * individual filtering as well (do the upper net layers want or support&n; * this kind of feature?).&n; */
DECL|function|set_multicast_list
r_static
r_void
id|set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
suffix:semicolon
r_volatile
id|fec_t
op_star
id|ep
suffix:semicolon
id|fep
op_assign
(paren
r_struct
id|fec_enet_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ep
op_assign
op_amp
(paren
(paren
(paren
id|immap_t
op_star
)paren
id|IMAP_ADDR
)paren
op_member_access_from_pointer
id|im_cpm.cp_fec
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* Log any net taps. */
id|printk
c_func
(paren
l_string|&quot;%s: Promiscuous mode enabled.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|ep-&gt;fec_r_cntrl
op_or_assign
l_int|0x0008
suffix:semicolon
)brace
r_else
(brace
id|ep-&gt;fec_r_cntrl
op_and_assign
op_complement
l_int|0x0008
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
(brace
multiline_comment|/* Catch all multicast addresses, so set the&n;&t;&t;&t; * filter to all 1&squot;s.&n;&t;&t;&t; */
id|ep-&gt;fec_hash_table_high
op_assign
l_int|0xffffffff
suffix:semicolon
id|ep-&gt;fec_hash_table_low
op_assign
l_int|0xffffffff
suffix:semicolon
)brace
macro_line|#if 0
r_else
(brace
multiline_comment|/* Clear filter and add the addresses in the list.&n;&t;&t;&t;*/
id|ep-&gt;sen_gaddr1
op_assign
l_int|0
suffix:semicolon
id|ep-&gt;sen_gaddr2
op_assign
l_int|0
suffix:semicolon
id|ep-&gt;sen_gaddr3
op_assign
l_int|0
suffix:semicolon
id|ep-&gt;sen_gaddr4
op_assign
l_int|0
suffix:semicolon
id|dmi
op_assign
id|dev-&gt;mc_list
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Only support group multicast for now.&n;&t;&t;&t;&t;*/
r_if
c_cond
(paren
op_logical_neg
(paren
id|dmi-&gt;dmi_addr
(braket
l_int|0
)braket
op_amp
l_int|1
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* The address in dmi_addr is LSB first,&n;&t;&t;&t;&t; * and taddr is MSB first.  We have to&n;&t;&t;&t;&t; * copy bytes MSB first from dmi_addr.&n;&t;&t;&t;&t; */
id|mcptr
op_assign
(paren
id|u_char
op_star
)paren
id|dmi-&gt;dmi_addr
op_plus
l_int|5
suffix:semicolon
id|tdptr
op_assign
(paren
id|u_char
op_star
)paren
op_amp
id|ep-&gt;sen_taddrh
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|6
suffix:semicolon
id|j
op_increment
)paren
op_star
id|tdptr
op_increment
op_assign
op_star
id|mcptr
op_decrement
suffix:semicolon
multiline_comment|/* Ask CPM to run CRC and set bit in&n;&t;&t;&t;&t; * filter mask.&n;&t;&t;&t;&t; */
id|cpmp-&gt;cp_cpcr
op_assign
id|mk_cr_cmd
c_func
(paren
id|CPM_CR_CH_SCC1
comma
id|CPM_CR_SET_GADDR
)paren
op_or
id|CPM_CR_FLG
suffix:semicolon
multiline_comment|/* this delay is necessary here -- Cort */
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_while
c_loop
(paren
id|cpmp-&gt;cp_cpcr
op_amp
id|CPM_CR_FLG
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
)brace
)brace
multiline_comment|/* Initialize the FEC Ethernet on 860T.&n; */
DECL|function|fec_enet_init
r_int
id|__init
id|fec_enet_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|fec_enet_private
op_star
id|fep
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
r_int
r_char
op_star
id|eap
comma
op_star
id|iap
suffix:semicolon
r_int
r_int
id|mem_addr
suffix:semicolon
id|pte_t
op_star
id|pte
suffix:semicolon
r_volatile
id|cbd_t
op_star
id|bdp
suffix:semicolon
id|cbd_t
op_star
id|cbd_base
suffix:semicolon
r_volatile
id|immap_t
op_star
id|immap
suffix:semicolon
r_volatile
id|fec_t
op_star
id|fecp
suffix:semicolon
id|bd_t
op_star
id|bd
suffix:semicolon
r_extern
id|uint
id|_get_IMMR
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_RPXCLASSIC
r_int
r_char
id|tmpaddr
(braket
l_int|6
)braket
suffix:semicolon
macro_line|#endif
id|immap
op_assign
(paren
id|immap_t
op_star
)paren
id|IMAP_ADDR
suffix:semicolon
multiline_comment|/* pointer to internal registers */
id|bd
op_assign
(paren
id|bd_t
op_star
)paren
id|__res
suffix:semicolon
multiline_comment|/* Allocate some private information.&n;&t;*/
id|fep
op_assign
(paren
r_struct
id|fec_enet_private
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|fep
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|__clear_user
c_func
(paren
id|fep
comma
r_sizeof
(paren
op_star
id|fep
)paren
)paren
suffix:semicolon
multiline_comment|/* Create an Ethernet device instance.&n;&t;*/
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|fecp
op_assign
op_amp
(paren
id|immap-&gt;im_cpm.cp_fec
)paren
suffix:semicolon
multiline_comment|/* Whack a reset.  We should wait for this.&n;&t;*/
id|fecp-&gt;fec_ecntrl
op_assign
l_int|1
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* Set the Ethernet address.  If using multiple Enets on the 8xx,&n;&t; * this needs some work to get unique addresses.&n;&t; */
id|eap
op_assign
(paren
r_int
r_char
op_star
)paren
id|my_enet_addr
suffix:semicolon
id|iap
op_assign
id|bd-&gt;bi_enetaddr
suffix:semicolon
macro_line|#ifdef CONFIG_RPXCLASSIC
multiline_comment|/* The Embedded Planet boards have only one MAC address in&n;&t; * the EEPROM, but can have two Ethernet ports.  For the&n;&t; * FEC port, we create another address by setting one of&n;&t; * the address bits above something that would have (up to&n;&t; * now) been allocated.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|tmpaddr
(braket
id|i
)braket
op_assign
op_star
id|iap
op_increment
suffix:semicolon
id|tmpaddr
(braket
l_int|3
)braket
op_or_assign
l_int|0x80
suffix:semicolon
id|iap
op_assign
id|tmpaddr
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
op_star
id|eap
op_increment
op_assign
op_star
id|iap
op_increment
suffix:semicolon
multiline_comment|/* Allocate memory for buffer descriptors.&n;&t;*/
r_if
c_cond
(paren
(paren
(paren
id|RX_RING_SIZE
op_plus
id|TX_RING_SIZE
)paren
op_star
r_sizeof
(paren
id|cbd_t
)paren
)paren
OG
id|PAGE_SIZE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;FEC init error.  Need more space.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;FEC initialization failed.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|mem_addr
op_assign
id|__get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
id|cbd_base
op_assign
(paren
id|cbd_t
op_star
)paren
id|mem_addr
suffix:semicolon
multiline_comment|/* Make it uncached.&n;&t;*/
id|pte
op_assign
id|va_to_pte
c_func
(paren
id|mem_addr
)paren
suffix:semicolon
id|pte_val
c_func
(paren
op_star
id|pte
)paren
op_or_assign
id|_PAGE_NO_CACHE
suffix:semicolon
id|flush_tlb_page
c_func
(paren
id|init_mm.mmap
comma
id|mem_addr
)paren
suffix:semicolon
multiline_comment|/* Set receive and transmit descriptor base.&n;&t;*/
id|fep-&gt;rx_bd_base
op_assign
id|cbd_base
suffix:semicolon
id|fep-&gt;tx_bd_base
op_assign
id|cbd_base
op_plus
id|RX_RING_SIZE
suffix:semicolon
id|fep-&gt;dirty_tx
op_assign
id|fep-&gt;cur_tx
op_assign
id|fep-&gt;tx_bd_base
suffix:semicolon
id|fep-&gt;cur_rx
op_assign
id|fep-&gt;rx_bd_base
suffix:semicolon
id|fep-&gt;skb_cur
op_assign
id|fep-&gt;skb_dirty
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Initialize the receive buffer descriptors.&n;&t;*/
id|bdp
op_assign
id|fep-&gt;rx_bd_base
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|FEC_ENET_RX_PAGES
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Allocate a page.&n;&t;&t;*/
id|mem_addr
op_assign
id|__get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
multiline_comment|/* Make it uncached.&n;&t;&t;*/
id|pte
op_assign
id|va_to_pte
c_func
(paren
id|mem_addr
)paren
suffix:semicolon
id|pte_val
c_func
(paren
op_star
id|pte
)paren
op_or_assign
id|_PAGE_NO_CACHE
suffix:semicolon
id|flush_tlb_page
c_func
(paren
id|init_mm.mmap
comma
id|mem_addr
)paren
suffix:semicolon
multiline_comment|/* Initialize the BD for every fragment in the page.&n;&t;&t;*/
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|FEC_ENET_RX_FRPPG
suffix:semicolon
id|j
op_increment
)paren
(brace
id|bdp-&gt;cbd_sc
op_assign
id|BD_ENET_RX_EMPTY
suffix:semicolon
id|bdp-&gt;cbd_bufaddr
op_assign
id|__pa
c_func
(paren
id|mem_addr
)paren
suffix:semicolon
id|mem_addr
op_add_assign
id|FEC_ENET_RX_FRSIZE
suffix:semicolon
id|bdp
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* Set the last buffer to wrap.&n;&t;*/
id|bdp
op_decrement
suffix:semicolon
id|bdp-&gt;cbd_sc
op_or_assign
id|BD_SC_WRAP
suffix:semicolon
macro_line|#ifdef CONFIG_FEC_PACKETHOOK
id|fep-&gt;ph_lock
op_assign
l_int|0
suffix:semicolon
id|fep-&gt;ph_rxhandler
op_assign
id|fep-&gt;ph_txhandler
op_assign
l_int|NULL
suffix:semicolon
id|fep-&gt;ph_proto
op_assign
l_int|0
suffix:semicolon
id|fep-&gt;ph_regaddr
op_assign
l_int|NULL
suffix:semicolon
id|fep-&gt;ph_priv
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
multiline_comment|/* Install our interrupt handler.&n;&t;*/
r_if
c_cond
(paren
id|request_8xxirq
c_func
(paren
id|FEC_INTERRUPT
comma
id|fec_enet_interrupt
comma
l_int|0
comma
l_string|&quot;fec&quot;
comma
id|dev
)paren
op_ne
l_int|0
)paren
id|panic
c_func
(paren
l_string|&quot;Could not allocate FEC IRQ!&quot;
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_RPXCLASSIC
multiline_comment|/* Make Port C, bit 15 an input that causes interrupts.&n;&t;*/
id|immap-&gt;im_ioport.iop_pcpar
op_and_assign
op_complement
l_int|0x0001
suffix:semicolon
id|immap-&gt;im_ioport.iop_pcdir
op_and_assign
op_complement
l_int|0x0001
suffix:semicolon
id|immap-&gt;im_ioport.iop_pcso
op_and_assign
op_complement
l_int|0x0001
suffix:semicolon
id|immap-&gt;im_ioport.iop_pcint
op_or_assign
l_int|0x0001
suffix:semicolon
id|cpm_install_handler
c_func
(paren
id|CPMVEC_PIO_PC15
comma
id|mii_link_interrupt
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/* Make LEDS reflect Link status.&n;&t;*/
op_star
(paren
(paren
id|uint
op_star
)paren
id|RPX_CSR_ADDR
)paren
op_and_assign
op_complement
id|BCSR2_FETHLEDMODE
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_FADS
r_if
c_cond
(paren
id|request_8xxirq
c_func
(paren
id|SIU_IRQ2
comma
id|mii_link_interrupt
comma
l_int|0
comma
l_string|&quot;mii&quot;
comma
id|dev
)paren
op_ne
l_int|0
)paren
id|panic
c_func
(paren
l_string|&quot;Could not allocate MII IRQ!&quot;
)paren
suffix:semicolon
macro_line|#endif
id|dev-&gt;base_addr
op_assign
(paren
r_int
r_int
)paren
id|fecp
suffix:semicolon
id|dev-&gt;priv
op_assign
id|fep
suffix:semicolon
multiline_comment|/* The FEC Ethernet specific entries in the device structure. */
id|dev-&gt;open
op_assign
id|fec_enet_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|fec_enet_start_xmit
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|fec_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|TX_TIMEOUT
suffix:semicolon
id|dev-&gt;stop
op_assign
id|fec_enet_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|fec_enet_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|set_multicast_list
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NMII
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
id|mii_cmds
(braket
id|i
)braket
dot
id|mii_next
op_assign
op_amp
id|mii_cmds
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
id|mii_free
op_assign
id|mii_cmds
suffix:semicolon
multiline_comment|/* Configure all of port D for MII.&n;&t;*/
id|immap-&gt;im_ioport.iop_pdpar
op_assign
l_int|0x1fff
suffix:semicolon
multiline_comment|/* Bits moved from Rev. D onward.&n;&t;*/
r_if
c_cond
(paren
(paren
id|_get_IMMR
c_func
(paren
)paren
op_amp
l_int|0xffff
)paren
OL
l_int|0x0501
)paren
id|immap-&gt;im_ioport.iop_pddir
op_assign
l_int|0x1c58
suffix:semicolon
multiline_comment|/* Pre rev. D */
r_else
id|immap-&gt;im_ioport.iop_pddir
op_assign
l_int|0x1fff
suffix:semicolon
multiline_comment|/* Rev. D and later */
multiline_comment|/* Set MII speed to 2.5 MHz&n;&t;*/
id|fecp-&gt;fec_mii_speed
op_assign
id|fep-&gt;phy_speed
op_assign
(paren
(paren
id|bd-&gt;bi_busfreq
op_star
l_int|1000000
)paren
op_div
l_int|2500000
)paren
op_amp
l_int|0x7e
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: FEC ENET Version 0.2, &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02x:&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%02x&bslash;n&quot;
comma
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
)paren
suffix:semicolon
multiline_comment|/* Queue up command to detect the PHY and initialize the&n;&t; * remainder of the interface.&n;&t; */
id|fep-&gt;phy_id_done
op_assign
l_int|0
suffix:semicolon
id|fep-&gt;phy_addr
op_assign
l_int|0
suffix:semicolon
id|mii_queue
c_func
(paren
id|dev
comma
id|mk_mii_read
c_func
(paren
id|MII_REG_PHYIR1
)paren
comma
id|mii_discover_phy
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This function is called to start or restart the FEC during a link&n; * change.  This only happens when switching between half and full&n; * duplex.&n; */
r_static
r_void
DECL|function|fec_restart
id|fec_restart
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|duplex
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_char
op_star
id|eap
suffix:semicolon
r_volatile
id|cbd_t
op_star
id|bdp
suffix:semicolon
r_volatile
id|immap_t
op_star
id|immap
suffix:semicolon
r_volatile
id|fec_t
op_star
id|fecp
suffix:semicolon
id|immap
op_assign
(paren
id|immap_t
op_star
)paren
id|IMAP_ADDR
suffix:semicolon
multiline_comment|/* pointer to internal registers */
id|fecp
op_assign
op_amp
(paren
id|immap-&gt;im_cpm.cp_fec
)paren
suffix:semicolon
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* Whack a reset.  We should wait for this.&n;&t;*/
id|fecp-&gt;fec_ecntrl
op_assign
l_int|1
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* Enable interrupts we wish to service.&n;&t;*/
id|fecp-&gt;fec_imask
op_assign
(paren
id|FEC_ENET_TXF
op_or
id|FEC_ENET_TXB
op_or
id|FEC_ENET_RXF
op_or
id|FEC_ENET_RXB
op_or
id|FEC_ENET_MII
)paren
suffix:semicolon
multiline_comment|/* Clear any outstanding interrupt.&n;&t;*/
id|fecp-&gt;fec_ievent
op_assign
l_int|0xffc0
suffix:semicolon
id|fecp-&gt;fec_ivec
op_assign
(paren
id|FEC_INTERRUPT
op_div
l_int|2
)paren
op_lshift
l_int|29
suffix:semicolon
multiline_comment|/* Set station address.&n;&t;*/
id|fecp-&gt;fec_addr_low
op_assign
(paren
id|my_enet_addr
(braket
l_int|0
)braket
op_lshift
l_int|16
)paren
op_or
id|my_enet_addr
(braket
l_int|1
)braket
suffix:semicolon
id|fecp-&gt;fec_addr_high
op_assign
id|my_enet_addr
(braket
l_int|2
)braket
suffix:semicolon
id|eap
op_assign
(paren
r_int
r_char
op_star
)paren
op_amp
id|my_enet_addr
(braket
l_int|0
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
op_star
id|eap
op_increment
suffix:semicolon
multiline_comment|/* Reset all multicast.&n;&t;*/
id|fecp-&gt;fec_hash_table_high
op_assign
l_int|0
suffix:semicolon
id|fecp-&gt;fec_hash_table_low
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Set maximum receive buffer size.&n;&t;*/
id|fecp-&gt;fec_r_buff_size
op_assign
id|PKT_MAXBLR_SIZE
suffix:semicolon
id|fecp-&gt;fec_r_hash
op_assign
id|PKT_MAXBUF_SIZE
suffix:semicolon
multiline_comment|/* Set receive and transmit descriptor base.&n;&t;*/
id|fecp-&gt;fec_r_des_start
op_assign
id|__pa
c_func
(paren
(paren
id|uint
)paren
(paren
id|fep-&gt;rx_bd_base
)paren
)paren
suffix:semicolon
id|fecp-&gt;fec_x_des_start
op_assign
id|__pa
c_func
(paren
(paren
id|uint
)paren
(paren
id|fep-&gt;tx_bd_base
)paren
)paren
suffix:semicolon
id|fep-&gt;dirty_tx
op_assign
id|fep-&gt;cur_tx
op_assign
id|fep-&gt;tx_bd_base
suffix:semicolon
id|fep-&gt;cur_rx
op_assign
id|fep-&gt;rx_bd_base
suffix:semicolon
multiline_comment|/* Reset SKB transmit buffers.&n;&t;*/
id|fep-&gt;skb_cur
op_assign
id|fep-&gt;skb_dirty
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|TX_RING_MOD_MASK
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|fep-&gt;tx_skbuff
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|fep-&gt;tx_skbuff
(braket
id|i
)braket
)paren
suffix:semicolon
id|fep-&gt;tx_skbuff
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/* Initialize the receive buffer descriptors.&n;&t;*/
id|bdp
op_assign
id|fep-&gt;rx_bd_base
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Initialize the BD for every fragment in the page.&n;&t;&t;*/
id|bdp-&gt;cbd_sc
op_assign
id|BD_ENET_RX_EMPTY
suffix:semicolon
id|bdp
op_increment
suffix:semicolon
)brace
multiline_comment|/* Set the last buffer to wrap.&n;&t;*/
id|bdp
op_decrement
suffix:semicolon
id|bdp-&gt;cbd_sc
op_or_assign
id|BD_SC_WRAP
suffix:semicolon
multiline_comment|/* ...and the same for transmmit.&n;&t;*/
id|bdp
op_assign
id|fep-&gt;tx_bd_base
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Initialize the BD for every fragment in the page.&n;&t;&t;*/
id|bdp-&gt;cbd_sc
op_assign
l_int|0
suffix:semicolon
id|bdp-&gt;cbd_bufaddr
op_assign
l_int|0
suffix:semicolon
id|bdp
op_increment
suffix:semicolon
)brace
multiline_comment|/* Set the last buffer to wrap.&n;&t;*/
id|bdp
op_decrement
suffix:semicolon
id|bdp-&gt;cbd_sc
op_or_assign
id|BD_SC_WRAP
suffix:semicolon
multiline_comment|/* Enable MII mode.&n;&t;*/
r_if
c_cond
(paren
id|duplex
)paren
(brace
id|fecp-&gt;fec_r_cntrl
op_assign
l_int|0x04
suffix:semicolon
multiline_comment|/* MII enable */
id|fecp-&gt;fec_x_cntrl
op_assign
l_int|0x04
suffix:semicolon
multiline_comment|/* FD enable */
)brace
r_else
(brace
id|fecp-&gt;fec_r_cntrl
op_assign
l_int|0x06
suffix:semicolon
multiline_comment|/* MII enable|No Rcv on Xmit */
id|fecp-&gt;fec_x_cntrl
op_assign
l_int|0x00
suffix:semicolon
)brace
id|fep-&gt;full_duplex
op_assign
id|duplex
suffix:semicolon
multiline_comment|/* Enable big endian and don&squot;t care about SDMA FC.&n;&t;*/
id|fecp-&gt;fec_fun_code
op_assign
l_int|0x78000000
suffix:semicolon
multiline_comment|/* Set MII speed.&n;&t;*/
id|fecp-&gt;fec_mii_speed
op_assign
id|fep-&gt;phy_speed
suffix:semicolon
multiline_comment|/* And last, enable the transmit and receive processing.&n;&t;*/
id|fecp-&gt;fec_ecntrl
op_assign
l_int|6
suffix:semicolon
id|fecp-&gt;fec_r_des_active
op_assign
l_int|0x01000000
suffix:semicolon
)brace
r_static
r_void
DECL|function|fec_stop
id|fec_stop
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_volatile
id|immap_t
op_star
id|immap
suffix:semicolon
r_volatile
id|fec_t
op_star
id|fecp
suffix:semicolon
r_struct
id|fec_enet_private
op_star
id|fep
suffix:semicolon
id|immap
op_assign
(paren
id|immap_t
op_star
)paren
id|IMAP_ADDR
suffix:semicolon
multiline_comment|/* pointer to internal registers */
id|fecp
op_assign
op_amp
(paren
id|immap-&gt;im_cpm.cp_fec
)paren
suffix:semicolon
id|fep
op_assign
id|dev-&gt;priv
suffix:semicolon
id|fecp-&gt;fec_x_cntrl
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* Graceful transmit stop */
r_while
c_loop
(paren
op_logical_neg
(paren
id|fecp-&gt;fec_ievent
op_amp
l_int|0x10000000
)paren
)paren
(brace
suffix:semicolon
)brace
multiline_comment|/* Whack a reset.  We should wait for this.&n;&t;*/
id|fecp-&gt;fec_ecntrl
op_assign
l_int|1
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* Clear outstanding MII command interrupts.&n;&t;*/
id|fecp-&gt;fec_ievent
op_assign
id|FEC_ENET_MII
suffix:semicolon
multiline_comment|/* Enable MII command finihed interrupt &n;&t;*/
id|fecp-&gt;fec_ivec
op_assign
(paren
id|FEC_INTERRUPT
op_div
l_int|2
)paren
op_lshift
l_int|29
suffix:semicolon
id|fecp-&gt;fec_imask
op_assign
id|FEC_ENET_MII
suffix:semicolon
multiline_comment|/* Set MII speed.&n;&t;*/
id|fecp-&gt;fec_mii_speed
op_assign
id|fep-&gt;phy_speed
suffix:semicolon
)brace
eof
