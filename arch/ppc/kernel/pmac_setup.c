multiline_comment|/*&n; *  linux/arch/ppc/kernel/setup.c&n; *&n; *  PowerPC version &n; *    Copyright (C) 1995-1996 Gary Thomas (gdt@linuxppc.org)&n; *&n; *  Adapted for Power Macintosh by Paul Mackerras&n; *    Copyright (C) 1996 Paul Mackerras (paulus@cs.anu.edu.au)&n; *&n; *  Derived from &quot;arch/alpha/kernel/setup.c&quot;&n; *    Copyright (C) 1995 Linus Torvalds&n; *&n; *  This program is free software; you can redistribute it and/or&n; *  modify it under the terms of the GNU General Public License&n; *  as published by the Free Software Foundation; either version&n; *  2 of the License, or (at your option) any later version.&n; *&n; */
multiline_comment|/*&n; * bootup setup stuff..&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/user.h&gt;
macro_line|#include &lt;linux/a.out.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#ifdef CONFIG_ABSTRACT_CONSOLE
macro_line|#include &lt;linux/console.h&gt;
macro_line|#endif
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/ide.h&gt;
macro_line|#include &lt;asm/pci-bridge.h&gt;
macro_line|#include &lt;asm/adb.h&gt;
macro_line|#include &lt;asm/cuda.h&gt;
macro_line|#include &lt;asm/pmu.h&gt;
macro_line|#include &lt;asm/mediabay.h&gt;
macro_line|#include &lt;asm/ohare.h&gt;
macro_line|#include &lt;asm/mediabay.h&gt;
macro_line|#include &quot;time.h&quot;
r_extern
r_int
id|root_mountflags
suffix:semicolon
DECL|variable|drive_info
r_int
r_char
id|drive_info
suffix:semicolon
DECL|macro|DEFAULT_ROOT_DEVICE
mdefine_line|#define DEFAULT_ROOT_DEVICE 0x0801&t;/* sda1 - slightly silly choice */
r_extern
r_void
id|zs_kgdb_hook
c_func
(paren
r_int
id|tty_num
)paren
suffix:semicolon
r_static
r_void
id|ohare_init
c_func
(paren
r_void
)paren
suffix:semicolon
id|__pmac
r_int
DECL|function|pmac_get_cpuinfo
id|pmac_get_cpuinfo
c_func
(paren
r_char
op_star
id|buffer
)paren
(brace
r_int
id|len
suffix:semicolon
multiline_comment|/* should find motherboard type here as well */
id|len
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;machine&bslash;t&bslash;t: PowerMac&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SCSI
multiline_comment|/* Find the device number for the disk (if any) at target tgt&n;   on host adaptor host.&n;   XXX this really really should be in drivers/scsi/sd.c. */
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &quot;../../../drivers/scsi/scsi.h&quot;
macro_line|#include &quot;../../../drivers/scsi/sd.h&quot;
macro_line|#include &quot;../../../drivers/scsi/hosts.h&quot;
DECL|function|sd_find_target
id|kdev_t
id|sd_find_target
c_func
(paren
r_void
op_star
id|host
comma
r_int
id|tgt
)paren
(brace
id|Scsi_Disk
op_star
id|dp
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|dp
op_assign
id|rscsi_disks
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sd_template.dev_max
suffix:semicolon
op_increment
id|i
comma
op_increment
id|dp
)paren
r_if
c_cond
(paren
id|dp-&gt;device
op_ne
l_int|NULL
op_logical_and
id|dp-&gt;device-&gt;host
op_eq
id|host
op_logical_and
id|dp-&gt;device-&gt;id
op_eq
id|tgt
)paren
r_return
id|MKDEV
c_func
(paren
id|SCSI_DISK_MAJOR
comma
id|i
op_lshift
l_int|4
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|pmac_setup_arch
c_func
(paren
r_int
r_int
op_star
id|memory_start_p
comma
r_int
r_int
op_star
id|memory_end_p
)paren
)paren
(brace
r_struct
id|device_node
op_star
id|cpu
suffix:semicolon
r_int
op_star
id|fp
suffix:semicolon
multiline_comment|/* Set loops_per_sec to a half-way reasonable value,&n;&t;   for use until calibrate_delay gets called. */
id|cpu
op_assign
id|find_type_devices
c_func
(paren
l_string|&quot;cpu&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpu
op_ne
l_int|0
)paren
(brace
id|fp
op_assign
(paren
r_int
op_star
)paren
id|get_property
c_func
(paren
id|cpu
comma
l_string|&quot;clock-frequency&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fp
op_ne
l_int|0
)paren
(brace
r_switch
c_cond
(paren
id|_get_PVR
c_func
(paren
)paren
op_rshift
l_int|16
)paren
(brace
r_case
l_int|4
suffix:colon
multiline_comment|/* 604 */
r_case
l_int|9
suffix:colon
multiline_comment|/* 604e */
r_case
l_int|10
suffix:colon
multiline_comment|/* mach V (604ev5) */
r_case
l_int|20
suffix:colon
multiline_comment|/* 620 */
id|loops_per_sec
op_assign
op_star
id|fp
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* 601, 603, etc. */
id|loops_per_sec
op_assign
op_star
id|fp
op_div
l_int|2
suffix:semicolon
)brace
)brace
r_else
id|loops_per_sec
op_assign
l_int|50000000
suffix:semicolon
)brace
multiline_comment|/* this area has the CPU identification register&n;&t;   and some registers used by smp boards */
id|ioremap
c_func
(paren
l_int|0xf8000000
comma
l_int|0x1000
)paren
suffix:semicolon
op_star
id|memory_start_p
op_assign
id|pmac_find_bridges
c_func
(paren
op_star
id|memory_start_p
comma
op_star
id|memory_end_p
)paren
suffix:semicolon
id|ohare_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_KGDB
id|zs_kgdb_hook
c_func
(paren
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|find_via_cuda
c_func
(paren
)paren
suffix:semicolon
id|find_via_pmu
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_FB
multiline_comment|/* Frame buffer device based console */
id|conswitchp
op_assign
op_amp
id|fb_con
suffix:semicolon
macro_line|#endif
)brace
DECL|variable|feature_addr
r_static
r_volatile
id|u32
op_star
id|feature_addr
suffix:semicolon
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_void
id|ohare_init
c_func
(paren
r_void
)paren
)paren
(brace
r_struct
id|device_node
op_star
id|np
suffix:semicolon
id|np
op_assign
id|find_devices
c_func
(paren
l_string|&quot;ohare&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|np
op_eq
l_int|0
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;next
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;only using the first ohare&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;n_addrs
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;No addresses for %s&bslash;n&quot;
comma
id|np-&gt;full_name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|feature_addr
op_assign
(paren
r_volatile
id|u32
op_star
)paren
id|ioremap
c_func
(paren
id|np-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
op_plus
id|OHARE_FEATURE_REG
comma
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|find_devices
c_func
(paren
l_string|&quot;via-pmu&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Twiddling the magic ohare bits&bslash;n&quot;
)paren
suffix:semicolon
id|out_le32
c_func
(paren
id|feature_addr
comma
id|STARMAX_FEATURES
)paren
suffix:semicolon
)brace
r_else
(brace
id|out_le32
c_func
(paren
id|feature_addr
comma
id|in_le32
c_func
(paren
id|feature_addr
)paren
op_or
id|PBOOK_FEATURES
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;feature reg = %x&bslash;n&quot;
comma
id|in_le32
c_func
(paren
id|feature_addr
)paren
)paren
suffix:semicolon
)brace
)brace
r_extern
r_char
op_star
id|bootpath
suffix:semicolon
r_extern
r_char
op_star
id|bootdevice
suffix:semicolon
DECL|variable|boot_host
r_void
op_star
id|boot_host
suffix:semicolon
DECL|variable|boot_target
r_int
id|boot_target
suffix:semicolon
DECL|variable|boot_part
r_int
id|boot_part
suffix:semicolon
DECL|variable|boot_dev
id|kdev_t
id|boot_dev
suffix:semicolon
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|powermac_init
c_func
(paren
r_void
)paren
)paren
(brace
id|adb_init
c_func
(paren
)paren
suffix:semicolon
id|pmac_nvram_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|_machine
op_eq
id|_MACH_Pmac
)paren
(brace
id|media_bay_init
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PMAC_CONSOLE
id|pmac_find_display
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|note_scsi_host
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_void
op_star
id|host
)paren
)paren
(brace
r_int
id|l
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
id|l
op_assign
id|strlen
c_func
(paren
id|node-&gt;full_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bootpath
op_ne
l_int|NULL
op_logical_and
id|bootdevice
op_ne
l_int|NULL
op_logical_and
id|strncmp
c_func
(paren
id|node-&gt;full_name
comma
id|bootdevice
comma
id|l
)paren
op_eq
l_int|0
op_logical_and
(paren
id|bootdevice
(braket
id|l
)braket
op_eq
l_char|&squot;/&squot;
op_logical_or
id|bootdevice
(braket
id|l
)braket
op_eq
l_int|0
)paren
)paren
(brace
id|boot_host
op_assign
id|host
suffix:semicolon
multiline_comment|/*&n;&t;&t; * There&squot;s a bug in OF 1.0.5.  (Why am I not surprised.)&n;&t;&t; * If you pass a path like scsi/sd@1:0 to canon, it returns&n;&t;&t; * something like /bandit@F2000000/gc@10/53c94@10000/sd@0,0&n;&t;&t; * That is, the scsi target number doesn&squot;t get preserved.&n;&t;&t; * So we pick the target number out of bootpath and use that.&n;&t;&t; */
id|p
op_assign
id|strstr
c_func
(paren
id|bootpath
comma
l_string|&quot;/sd@&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_ne
l_int|NULL
)paren
(brace
id|p
op_add_assign
l_int|4
suffix:semicolon
id|boot_target
op_assign
id|simple_strtoul
c_func
(paren
id|p
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
id|p
op_assign
id|strchr
c_func
(paren
id|p
comma
l_char|&squot;:&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_ne
l_int|NULL
)paren
id|boot_part
op_assign
id|simple_strtoul
c_func
(paren
id|p
op_plus
l_int|1
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|find_boot_device
c_func
(paren
r_void
)paren
)paren
(brace
id|kdev_t
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|kdev_t_to_nr
c_func
(paren
id|ROOT_DEV
)paren
op_ne
l_int|0
)paren
r_return
suffix:semicolon
id|ROOT_DEV
op_assign
id|to_kdev_t
c_func
(paren
id|DEFAULT_ROOT_DEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|boot_host
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
macro_line|#ifdef CONFIG_SCSI
id|dev
op_assign
id|sd_find_target
c_func
(paren
id|boot_host
comma
id|boot_target
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|boot_dev
op_assign
id|MKDEV
c_func
(paren
id|MAJOR
c_func
(paren
id|dev
)paren
comma
id|MINOR
c_func
(paren
id|dev
)paren
op_plus
id|boot_part
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* XXX should cope with booting from IDE also */
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|note_bootable_part
c_func
(paren
id|kdev_t
id|dev
comma
r_int
id|part
)paren
)paren
(brace
r_static
r_int
id|found_boot
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|found_boot
)paren
(brace
id|find_boot_device
c_func
(paren
)paren
suffix:semicolon
id|found_boot
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev
op_eq
id|boot_dev
)paren
(brace
id|ROOT_DEV
op_assign
id|MKDEV
c_func
(paren
id|MAJOR
c_func
(paren
id|dev
)paren
comma
id|MINOR
c_func
(paren
id|dev
)paren
op_plus
id|part
)paren
suffix:semicolon
id|boot_dev
op_assign
id|NODEV
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; (root)&quot;
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef CONFIG_BLK_DEV_IDE
DECL|variable|pmac_ide_ports_known
r_int
id|pmac_ide_ports_known
suffix:semicolon
DECL|variable|pmac_ide_regbase
id|ide_ioreg_t
id|pmac_ide_regbase
(braket
id|MAX_HWIFS
)braket
suffix:semicolon
DECL|variable|pmac_ide_irq
r_int
id|pmac_ide_irq
(braket
id|MAX_HWIFS
)braket
suffix:semicolon
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|pmac_ide_init_hwif_ports
c_func
(paren
id|ide_ioreg_t
op_star
id|p
comma
id|ide_ioreg_t
id|base
comma
r_int
op_star
id|irq
)paren
)paren
(brace
r_int
id|i
suffix:semicolon
op_star
id|p
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|base
op_eq
l_int|0
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|base
op_eq
id|mb_cd_base
op_logical_and
op_logical_neg
id|check_media_bay
c_func
(paren
id|MB_CD
)paren
)paren
(brace
id|mb_cd_index
op_assign
op_minus
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
op_increment
id|i
)paren
op_star
id|p
op_increment
op_assign
id|base
op_plus
id|i
op_star
l_int|0x10
suffix:semicolon
op_star
id|p
op_assign
id|base
op_plus
l_int|0x160
suffix:semicolon
r_if
c_cond
(paren
id|irq
op_ne
l_int|NULL
)paren
(brace
op_star
id|irq
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_HWIFS
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|base
op_eq
id|pmac_ide_regbase
(braket
id|i
)braket
)paren
(brace
op_star
id|irq
op_assign
id|pmac_ide_irq
(braket
id|i
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|pmac_ide_probe
c_func
(paren
r_void
)paren
)paren
(brace
r_struct
id|device_node
op_star
id|np
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|device_node
op_star
id|atas
suffix:semicolon
r_struct
id|device_node
op_star
id|p
comma
op_star
op_star
id|pp
comma
op_star
id|removables
comma
op_star
op_star
id|rp
suffix:semicolon
id|pp
op_assign
op_amp
id|atas
suffix:semicolon
id|rp
op_assign
op_amp
id|removables
suffix:semicolon
id|p
op_assign
id|find_devices
c_func
(paren
l_string|&quot;ATA&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
l_int|NULL
)paren
id|p
op_assign
id|find_devices
c_func
(paren
l_string|&quot;IDE&quot;
)paren
suffix:semicolon
multiline_comment|/* Move removable devices such as the media-bay CDROM&n;&t;   on the PB3400 to the end of the list. */
r_for
c_loop
(paren
suffix:semicolon
id|p
op_ne
l_int|NULL
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;parent
op_logical_and
id|p-&gt;parent-&gt;name
op_logical_and
id|strcasecmp
c_func
(paren
id|p-&gt;parent-&gt;name
comma
l_string|&quot;media-bay&quot;
)paren
op_eq
l_int|0
)paren
(brace
op_star
id|rp
op_assign
id|p
suffix:semicolon
id|rp
op_assign
op_amp
id|p-&gt;next
suffix:semicolon
)brace
r_else
(brace
op_star
id|pp
op_assign
id|p
suffix:semicolon
id|pp
op_assign
op_amp
id|p-&gt;next
suffix:semicolon
)brace
)brace
op_star
id|rp
op_assign
l_int|NULL
suffix:semicolon
op_star
id|pp
op_assign
id|removables
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|np
op_assign
id|atas
suffix:semicolon
id|i
OL
id|MAX_HWIFS
op_logical_and
id|np
op_ne
l_int|NULL
suffix:semicolon
id|np
op_assign
id|np-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|np-&gt;n_addrs
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ide: no address for device %s&bslash;n&quot;
comma
id|np-&gt;full_name
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|pmac_ide_regbase
(braket
id|i
)braket
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
id|np-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
comma
l_int|0x200
)paren
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;n_intrs
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ide: no intrs for device %s, using 13&bslash;n&quot;
comma
id|np-&gt;full_name
)paren
suffix:semicolon
id|pmac_ide_irq
(braket
id|i
)braket
op_assign
l_int|13
suffix:semicolon
)brace
r_else
(brace
id|pmac_ide_irq
(braket
id|i
)braket
op_assign
id|np-&gt;intrs
(braket
l_int|0
)braket
dot
id|line
suffix:semicolon
)brace
r_if
c_cond
(paren
id|np-&gt;parent
op_logical_and
id|np-&gt;parent-&gt;name
op_logical_and
id|strcasecmp
c_func
(paren
id|np-&gt;parent-&gt;name
comma
l_string|&quot;media-bay&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|mb_cd_index
op_assign
id|i
suffix:semicolon
id|mb_cd_base
op_assign
id|pmac_ide_regbase
(braket
id|i
)braket
suffix:semicolon
id|mb_cd_irq
op_assign
id|pmac_ide_irq
(braket
id|i
)braket
suffix:semicolon
)brace
op_increment
id|i
suffix:semicolon
)brace
id|pmac_ide_ports_known
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_BLK_DEV_IDE */
eof
