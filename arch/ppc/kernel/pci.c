multiline_comment|/*&n; * $Id: pci.c,v 1.64 1999/09/17 18:01:53 cort Exp $&n; * Common pmac/prep/chrp pci routines. -- Cort&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/openpic.h&gt;
macro_line|#include &lt;linux/capability.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/pci-bridge.h&gt;
macro_line|#include &lt;asm/residual.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/gg2.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &quot;pci.h&quot;
r_static
r_void
id|__init
id|pcibios_claim_resources
c_func
(paren
r_struct
id|list_head
op_star
)paren
suffix:semicolon
DECL|variable|isa_io_base
r_int
r_int
id|isa_io_base
op_assign
l_int|0
suffix:semicolon
DECL|variable|isa_mem_base
r_int
r_int
id|isa_mem_base
op_assign
l_int|0
suffix:semicolon
DECL|variable|pci_dram_offset
r_int
r_int
id|pci_dram_offset
op_assign
l_int|0
suffix:semicolon
DECL|variable|pcibios_fixups
r_struct
id|pci_fixup
id|pcibios_fixups
(braket
)braket
op_assign
(brace
(brace
l_int|0
)brace
)brace
suffix:semicolon
DECL|function|generic_pcibios_read_byte
r_int
id|generic_pcibios_read_byte
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u8
op_star
id|val
)paren
(brace
r_return
id|ppc_md
dot
id|pcibios_read_config_byte
c_func
(paren
id|dev-&gt;bus-&gt;number
comma
id|dev-&gt;devfn
comma
id|where
comma
id|val
)paren
suffix:semicolon
)brace
DECL|function|generic_pcibios_read_word
r_int
id|generic_pcibios_read_word
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u16
op_star
id|val
)paren
(brace
r_return
id|ppc_md
dot
id|pcibios_read_config_word
c_func
(paren
id|dev-&gt;bus-&gt;number
comma
id|dev-&gt;devfn
comma
id|where
comma
id|val
)paren
suffix:semicolon
)brace
DECL|function|generic_pcibios_read_dword
r_int
id|generic_pcibios_read_dword
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u32
op_star
id|val
)paren
(brace
r_return
id|ppc_md
dot
id|pcibios_read_config_dword
c_func
(paren
id|dev-&gt;bus-&gt;number
comma
id|dev-&gt;devfn
comma
id|where
comma
id|val
)paren
suffix:semicolon
)brace
DECL|function|generic_pcibios_write_byte
r_int
id|generic_pcibios_write_byte
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u8
id|val
)paren
(brace
r_return
id|ppc_md
dot
id|pcibios_write_config_byte
c_func
(paren
id|dev-&gt;bus-&gt;number
comma
id|dev-&gt;devfn
comma
id|where
comma
id|val
)paren
suffix:semicolon
)brace
DECL|function|generic_pcibios_write_word
r_int
id|generic_pcibios_write_word
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u16
id|val
)paren
(brace
r_return
id|ppc_md
dot
id|pcibios_write_config_word
c_func
(paren
id|dev-&gt;bus-&gt;number
comma
id|dev-&gt;devfn
comma
id|where
comma
id|val
)paren
suffix:semicolon
)brace
DECL|function|generic_pcibios_write_dword
r_int
id|generic_pcibios_write_dword
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u32
id|val
)paren
(brace
r_return
id|ppc_md
dot
id|pcibios_write_config_dword
c_func
(paren
id|dev-&gt;bus-&gt;number
comma
id|dev-&gt;devfn
comma
id|where
comma
id|val
)paren
suffix:semicolon
)brace
DECL|variable|generic_pci_ops
r_struct
id|pci_ops
id|generic_pci_ops
op_assign
(brace
id|generic_pcibios_read_byte
comma
id|generic_pcibios_read_word
comma
id|generic_pcibios_read_dword
comma
id|generic_pcibios_write_byte
comma
id|generic_pcibios_write_word
comma
id|generic_pcibios_write_dword
)brace
suffix:semicolon
DECL|function|pcibios_init
r_void
id|__init
id|pcibios_init
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: Probing PCI hardware&bslash;n&quot;
)paren
suffix:semicolon
id|pci_scan_bus
c_func
(paren
l_int|0
comma
op_amp
id|generic_pci_ops
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppc_md.pcibios_fixup
)paren
id|ppc_md
dot
id|pcibios_fixup
c_func
(paren
)paren
suffix:semicolon
id|pcibios_claim_resources
c_func
(paren
op_amp
id|pci_root_buses
)paren
suffix:semicolon
)brace
r_void
id|__init
DECL|function|pcibios_fixup_pbus_ranges
id|pcibios_fixup_pbus_ranges
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_struct
id|pbus_set_ranges_data
op_star
id|ranges
)paren
(brace
id|ranges-&gt;io_start
op_sub_assign
id|bus-&gt;resource
(braket
l_int|0
)braket
op_member_access_from_pointer
id|start
suffix:semicolon
id|ranges-&gt;io_end
op_sub_assign
id|bus-&gt;resource
(braket
l_int|0
)braket
op_member_access_from_pointer
id|start
suffix:semicolon
id|ranges-&gt;mem_start
op_sub_assign
id|bus-&gt;resource
(braket
l_int|1
)braket
op_member_access_from_pointer
id|start
suffix:semicolon
id|ranges-&gt;mem_end
op_sub_assign
id|bus-&gt;resource
(braket
l_int|1
)braket
op_member_access_from_pointer
id|start
suffix:semicolon
)brace
DECL|function|resource_fixup
r_int
r_int
id|resource_fixup
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_struct
id|resource
op_star
id|res
comma
r_int
r_int
id|start
comma
r_int
r_int
id|size
)paren
(brace
r_return
id|start
suffix:semicolon
)brace
DECL|function|pcibios_claim_resources
r_static
r_void
id|__init
id|pcibios_claim_resources
c_func
(paren
r_struct
id|list_head
op_star
id|bus_list
)paren
(brace
r_struct
id|list_head
op_star
id|ln
comma
op_star
id|dn
suffix:semicolon
r_struct
id|pci_bus
op_star
id|bus
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
suffix:semicolon
r_int
id|idx
suffix:semicolon
r_for
c_loop
(paren
id|ln
op_assign
id|bus_list-&gt;next
suffix:semicolon
id|ln
op_ne
id|bus_list
suffix:semicolon
id|ln
op_assign
id|ln-&gt;next
)paren
(brace
id|bus
op_assign
id|pci_bus_b
c_func
(paren
id|ln
)paren
suffix:semicolon
r_for
c_loop
(paren
id|dn
op_assign
id|bus-&gt;devices.next
suffix:semicolon
id|dn
op_ne
op_amp
id|bus-&gt;devices
suffix:semicolon
id|dn
op_assign
id|dn-&gt;next
)paren
(brace
id|dev
op_assign
id|pci_dev_b
c_func
(paren
id|dn
)paren
suffix:semicolon
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|PCI_NUM_RESOURCES
suffix:semicolon
id|idx
op_increment
)paren
(brace
r_struct
id|resource
op_star
id|r
op_assign
op_amp
id|dev-&gt;resource
(braket
id|idx
)braket
suffix:semicolon
r_struct
id|resource
op_star
id|pr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|r-&gt;start
)paren
r_continue
suffix:semicolon
id|pr
op_assign
id|pci_find_parent_resource
c_func
(paren
id|dev
comma
id|r
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr
op_logical_or
id|request_resource
c_func
(paren
id|pr
comma
id|r
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PCI: Address space collision on region %d of device %s&bslash;n&quot;
comma
id|idx
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* We probably should disable the region, shouldn&squot;t we? */
)brace
)brace
)brace
id|pcibios_claim_resources
c_func
(paren
op_amp
id|bus-&gt;children
)paren
suffix:semicolon
)brace
)brace
DECL|function|pcibios_fixup_bus
r_void
id|__init
id|pcibios_fixup_bus
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
)paren
(brace
r_if
c_cond
(paren
id|ppc_md.pcibios_fixup_bus
)paren
id|ppc_md
dot
id|pcibios_fixup_bus
c_func
(paren
id|bus
)paren
suffix:semicolon
)brace
DECL|function|pcibios_setup
r_char
id|__init
op_star
id|pcibios_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_return
id|str
suffix:semicolon
)brace
multiline_comment|/* the next two are stolen from the alpha port... */
r_void
id|__init
DECL|function|pcibios_update_resource
id|pcibios_update_resource
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_struct
id|resource
op_star
id|root
comma
r_struct
id|resource
op_star
id|res
comma
r_int
id|resource
)paren
(brace
r_int
r_int
id|where
comma
id|size
suffix:semicolon
id|u32
id|reg
suffix:semicolon
id|where
op_assign
id|PCI_BASE_ADDRESS_0
op_plus
(paren
id|resource
op_star
l_int|4
)paren
suffix:semicolon
id|size
op_assign
id|res-&gt;end
op_minus
id|res-&gt;start
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|dev
comma
id|where
comma
op_amp
id|reg
)paren
suffix:semicolon
id|reg
op_assign
(paren
id|reg
op_amp
id|size
)paren
op_or
(paren
(paren
(paren
id|u32
)paren
(paren
id|res-&gt;start
op_minus
id|root-&gt;start
)paren
)paren
op_amp
op_complement
id|size
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|dev
comma
id|where
comma
id|reg
)paren
suffix:semicolon
)brace
r_void
id|__init
DECL|function|pcibios_update_irq
id|pcibios_update_irq
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|irq
)paren
(brace
id|pci_write_config_byte
c_func
(paren
id|dev
comma
id|PCI_INTERRUPT_LINE
comma
id|irq
)paren
suffix:semicolon
multiline_comment|/* XXX FIXME - update OF device tree node interrupt property */
)brace
r_void
id|__init
DECL|function|pcibios_align_resource
id|pcibios_align_resource
c_func
(paren
r_void
op_star
id|data
comma
r_struct
id|resource
op_star
id|res
comma
r_int
r_int
id|size
)paren
(brace
)brace
DECL|function|pcibios_enable_device
r_int
id|pcibios_enable_device
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|u16
id|cmd
comma
id|old_cmd
suffix:semicolon
r_int
id|idx
suffix:semicolon
r_struct
id|resource
op_star
id|r
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
op_amp
id|cmd
)paren
suffix:semicolon
id|old_cmd
op_assign
id|cmd
suffix:semicolon
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
l_int|6
suffix:semicolon
id|idx
op_increment
)paren
(brace
id|r
op_assign
op_amp
id|dev-&gt;resource
(braket
id|idx
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|r-&gt;start
op_logical_and
id|r-&gt;end
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PCI: Device %s not available because of resource collisions&bslash;n&quot;
comma
id|dev-&gt;slot_name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|r-&gt;flags
op_amp
id|IORESOURCE_IO
)paren
id|cmd
op_or_assign
id|PCI_COMMAND_IO
suffix:semicolon
r_if
c_cond
(paren
id|r-&gt;flags
op_amp
id|IORESOURCE_MEM
)paren
id|cmd
op_or_assign
id|PCI_COMMAND_MEMORY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_ne
id|old_cmd
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: Enabling device %s (%04x -&gt; %04x)&bslash;n&quot;
comma
id|dev-&gt;slot_name
comma
id|old_cmd
comma
id|cmd
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
id|cmd
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Those syscalls are derived from the Alpha versions, they&n; * allow userland apps to retreive the per-device iobase and&n; * mem-base. They also provide wrapper for userland to do&n; * config space accesses.&n; * The &quot;host_number&quot; returns the number of the Uni-N sub bridge&n; */
id|asmlinkage
r_int
DECL|function|sys_pciconfig_read
id|sys_pciconfig_read
c_func
(paren
r_int
r_int
id|bus
comma
r_int
r_int
id|dfn
comma
r_int
r_int
id|off
comma
r_int
r_int
id|len
comma
r_int
r_char
op_star
id|buf
)paren
(brace
r_int
r_char
id|ubyte
suffix:semicolon
r_int
r_int
id|ushort
suffix:semicolon
r_int
r_int
id|uint
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pcibios_present
c_func
(paren
)paren
)paren
r_return
op_minus
id|ENOSYS
suffix:semicolon
r_switch
c_cond
(paren
id|len
)paren
(brace
r_case
l_int|1
suffix:colon
id|err
op_assign
id|pcibios_read_config_byte
c_func
(paren
id|bus
comma
id|dfn
comma
id|off
comma
op_amp
id|ubyte
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|ubyte
comma
id|buf
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|err
op_assign
id|pcibios_read_config_word
c_func
(paren
id|bus
comma
id|dfn
comma
id|off
comma
op_amp
id|ushort
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|ushort
comma
(paren
r_int
r_int
op_star
)paren
id|buf
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|err
op_assign
id|pcibios_read_config_dword
c_func
(paren
id|bus
comma
id|dfn
comma
id|off
comma
op_amp
id|uint
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|uint
comma
(paren
r_int
r_int
op_star
)paren
id|buf
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
id|asmlinkage
r_int
DECL|function|sys_pciconfig_write
id|sys_pciconfig_write
c_func
(paren
r_int
r_int
id|bus
comma
r_int
r_int
id|dfn
comma
r_int
r_int
id|off
comma
r_int
r_int
id|len
comma
r_int
r_char
op_star
id|buf
)paren
(brace
r_int
r_char
id|ubyte
suffix:semicolon
r_int
r_int
id|ushort
suffix:semicolon
r_int
r_int
id|uint
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pcibios_present
c_func
(paren
)paren
)paren
r_return
op_minus
id|ENOSYS
suffix:semicolon
r_switch
c_cond
(paren
id|len
)paren
(brace
r_case
l_int|1
suffix:colon
id|err
op_assign
id|get_user
c_func
(paren
id|ubyte
comma
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_break
suffix:semicolon
id|err
op_assign
id|pcibios_write_config_byte
c_func
(paren
id|bus
comma
id|dfn
comma
id|off
comma
id|ubyte
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|PCIBIOS_SUCCESSFUL
)paren
(brace
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|err
op_assign
id|get_user
c_func
(paren
id|ushort
comma
(paren
r_int
r_int
op_star
)paren
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_break
suffix:semicolon
id|err
op_assign
id|pcibios_write_config_word
c_func
(paren
id|bus
comma
id|dfn
comma
id|off
comma
id|ushort
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|PCIBIOS_SUCCESSFUL
)paren
(brace
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|err
op_assign
id|get_user
c_func
(paren
id|uint
comma
(paren
r_int
r_int
op_star
)paren
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_break
suffix:semicolon
id|err
op_assign
id|pcibios_write_config_dword
c_func
(paren
id|bus
comma
id|dfn
comma
id|off
comma
id|uint
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|PCIBIOS_SUCCESSFUL
)paren
(brace
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
r_void
op_star
DECL|function|pci_dev_io_base
id|pci_dev_io_base
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|devfn
)paren
(brace
multiline_comment|/* Defaults to old way */
r_if
c_cond
(paren
op_logical_neg
id|ppc_md.pci_dev_io_base
)paren
r_return
id|pci_io_base
c_func
(paren
id|bus
)paren
suffix:semicolon
r_return
id|ppc_md
dot
id|pci_dev_io_base
c_func
(paren
id|bus
comma
id|devfn
)paren
suffix:semicolon
)brace
r_void
op_star
DECL|function|pci_dev_mem_base
id|pci_dev_mem_base
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|devfn
)paren
(brace
multiline_comment|/* Default memory base is 0 (1:1 mapping) */
r_if
c_cond
(paren
op_logical_neg
id|ppc_md.pci_dev_mem_base
)paren
r_return
l_int|0
suffix:semicolon
r_return
id|ppc_md
dot
id|pci_dev_mem_base
c_func
(paren
id|bus
comma
id|devfn
)paren
suffix:semicolon
)brace
multiline_comment|/* Returns the root-bridge number (Uni-N number) of a device */
r_int
DECL|function|pci_dev_root_bridge
id|pci_dev_root_bridge
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|devfn
)paren
(brace
multiline_comment|/* Defaults to 0 */
r_if
c_cond
(paren
op_logical_neg
id|ppc_md.pci_dev_root_bridge
)paren
r_return
l_int|0
suffix:semicolon
r_return
id|ppc_md
dot
id|pci_dev_root_bridge
c_func
(paren
id|bus
comma
id|devfn
)paren
suffix:semicolon
)brace
multiline_comment|/* Provide information on locations of various I/O regions in physical&n; * memory.  Do this on a per-card basis so that we choose the right&n; * root bridge.&n; * Note that the returned IO or memory base is a physical address&n; */
id|asmlinkage
r_int
DECL|function|sys_pciconfig_iobase
id|sys_pciconfig_iobase
c_func
(paren
r_int
id|which
comma
r_int
r_int
id|bus
comma
r_int
r_int
id|devfn
)paren
(brace
r_switch
c_cond
(paren
id|which
)paren
(brace
r_case
id|IOBASE_BRIDGE_NUMBER
suffix:colon
r_return
(paren
r_int
)paren
id|pci_dev_root_bridge
c_func
(paren
id|bus
comma
id|devfn
)paren
suffix:semicolon
r_case
id|IOBASE_MEMORY
suffix:colon
r_return
(paren
r_int
)paren
id|pci_dev_mem_base
c_func
(paren
id|bus
comma
id|devfn
)paren
suffix:semicolon
r_case
id|IOBASE_IO
suffix:colon
r_return
(paren
r_int
)paren
id|pci_dev_io_base
c_func
(paren
id|bus
comma
id|devfn
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
eof
