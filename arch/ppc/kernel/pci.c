multiline_comment|/*&n; * PCI support&n; * -- rough emulation of &quot;PCI BIOS&quot; functions&n; *&n; * Note: these are very motherboard specific!  Some way needs to&n; * be worked out to handle the differences.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/bios32.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/ptrace.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
multiline_comment|/*&n; * PCI interrupt configuration.  This is motherboard specific.&n; */
multiline_comment|/* Which PCI interrupt line does a given device [slot] use? */
multiline_comment|/* Note: This really should be two dimensional based in slot/pin used */
DECL|variable|Motherboard_map
r_int
r_char
op_star
id|Motherboard_map
suffix:semicolon
DECL|variable|Motherboard_map_name
r_int
r_char
op_star
id|Motherboard_map_name
suffix:semicolon
multiline_comment|/* How is the 82378 PIRQ mapping setup? */
DECL|variable|Motherboard_routes
r_int
r_char
op_star
id|Motherboard_routes
suffix:semicolon
multiline_comment|/* Tables for known hardware */
multiline_comment|/* Motorola PowerStack */
DECL|variable|Blackhawk_pci_IRQ_map
r_static
r_char
id|Blackhawk_pci_IRQ_map
(braket
l_int|16
)braket
op_assign
(brace
l_int|0
comma
multiline_comment|/* Slot 0  - unused */
l_int|0
comma
multiline_comment|/* Slot 1  - unused */
l_int|0
comma
multiline_comment|/* Slot 2  - unused */
l_int|0
comma
multiline_comment|/* Slot 3  - unused */
l_int|0
comma
multiline_comment|/* Slot 4  - unused */
l_int|0
comma
multiline_comment|/* Slot 5  - unused */
l_int|0
comma
multiline_comment|/* Slot 6  - unused */
l_int|0
comma
multiline_comment|/* Slot 7  - unused */
l_int|0
comma
multiline_comment|/* Slot 8  - unused */
l_int|0
comma
multiline_comment|/* Slot 9  - unused */
l_int|0
comma
multiline_comment|/* Slot 10 - unused */
l_int|0
comma
multiline_comment|/* Slot 11 - unused */
l_int|3
comma
multiline_comment|/* Slot 12 - SCSI */
l_int|0
comma
multiline_comment|/* Slot 13 - unused */
l_int|1
comma
multiline_comment|/* Slot 14 - Ethernet */
l_int|0
comma
multiline_comment|/* Slot 15 - unused */
)brace
suffix:semicolon
DECL|variable|Blackhawk_pci_IRQ_routes
r_static
r_char
id|Blackhawk_pci_IRQ_routes
(braket
)braket
op_assign
(brace
l_int|0
comma
multiline_comment|/* Line 0 - Unused */
l_int|9
comma
multiline_comment|/* Line 1 */
l_int|11
comma
multiline_comment|/* Line 2 */
l_int|14
comma
multiline_comment|/* Line 3 */
l_int|15
multiline_comment|/* Line 4 */
)brace
suffix:semicolon
multiline_comment|/* Motorola MVME16xx */
DECL|variable|Genesis_pci_IRQ_map
r_static
r_char
id|Genesis_pci_IRQ_map
(braket
l_int|16
)braket
op_assign
(brace
l_int|0
comma
multiline_comment|/* Slot 0  - unused */
l_int|0
comma
multiline_comment|/* Slot 1  - unused */
l_int|0
comma
multiline_comment|/* Slot 2  - unused */
l_int|0
comma
multiline_comment|/* Slot 3  - unused */
l_int|0
comma
multiline_comment|/* Slot 4  - unused */
l_int|0
comma
multiline_comment|/* Slot 5  - unused */
l_int|0
comma
multiline_comment|/* Slot 6  - unused */
l_int|0
comma
multiline_comment|/* Slot 7  - unused */
l_int|0
comma
multiline_comment|/* Slot 8  - unused */
l_int|0
comma
multiline_comment|/* Slot 9  - unused */
l_int|0
comma
multiline_comment|/* Slot 10 - unused */
l_int|0
comma
multiline_comment|/* Slot 11 - unused */
l_int|3
comma
multiline_comment|/* Slot 12 - SCSI */
l_int|0
comma
multiline_comment|/* Slot 13 - unused */
l_int|1
comma
multiline_comment|/* Slot 14 - Ethernet */
l_int|0
comma
multiline_comment|/* Slot 15 - unused */
)brace
suffix:semicolon
DECL|variable|Genesis_pci_IRQ_routes
r_static
r_char
id|Genesis_pci_IRQ_routes
(braket
)braket
op_assign
(brace
l_int|0
comma
multiline_comment|/* Line 0 - Unused */
l_int|10
comma
multiline_comment|/* Line 1 */
l_int|11
comma
multiline_comment|/* Line 2 */
l_int|14
comma
multiline_comment|/* Line 3 */
l_int|15
multiline_comment|/* Line 4 */
)brace
suffix:semicolon
multiline_comment|/* Motorola Series-E */
DECL|variable|Comet_pci_IRQ_map
r_static
r_char
id|Comet_pci_IRQ_map
(braket
l_int|16
)braket
op_assign
(brace
l_int|0
comma
multiline_comment|/* Slot 0  - unused */
l_int|0
comma
multiline_comment|/* Slot 1  - unused */
l_int|0
comma
multiline_comment|/* Slot 2  - unused */
l_int|0
comma
multiline_comment|/* Slot 3  - unused */
l_int|0
comma
multiline_comment|/* Slot 4  - unused */
l_int|0
comma
multiline_comment|/* Slot 5  - unused */
l_int|0
comma
multiline_comment|/* Slot 6  - unused */
l_int|0
comma
multiline_comment|/* Slot 7  - unused */
l_int|0
comma
multiline_comment|/* Slot 8  - unused */
l_int|0
comma
multiline_comment|/* Slot 9  - unused */
l_int|0
comma
multiline_comment|/* Slot 10 - unused */
l_int|0
comma
multiline_comment|/* Slot 11 - unused */
l_int|3
comma
multiline_comment|/* Slot 12 - SCSI */
l_int|0
comma
multiline_comment|/* Slot 13 - unused */
l_int|1
comma
multiline_comment|/* Slot 14 - Ethernet */
l_int|0
comma
multiline_comment|/* Slot 15 - unused */
)brace
suffix:semicolon
DECL|variable|Comet_pci_IRQ_routes
r_static
r_char
id|Comet_pci_IRQ_routes
(braket
)braket
op_assign
(brace
l_int|0
comma
multiline_comment|/* Line 0 - Unused */
l_int|10
comma
multiline_comment|/* Line 1 */
l_int|11
comma
multiline_comment|/* Line 2 */
l_int|14
comma
multiline_comment|/* Line 3 */
l_int|15
multiline_comment|/* Line 4 */
)brace
suffix:semicolon
multiline_comment|/* BeBox */
DECL|variable|BeBox_pci_IRQ_map
r_static
r_char
id|BeBox_pci_IRQ_map
(braket
l_int|16
)braket
op_assign
(brace
l_int|0
comma
multiline_comment|/* Slot 0  - unused */
l_int|0
comma
multiline_comment|/* Slot 1  - unused */
l_int|0
comma
multiline_comment|/* Slot 2  - unused */
l_int|0
comma
multiline_comment|/* Slot 3  - unused */
l_int|0
comma
multiline_comment|/* Slot 4  - unused */
l_int|0
comma
multiline_comment|/* Slot 5  - unused */
l_int|0
comma
multiline_comment|/* Slot 6  - unused */
l_int|0
comma
multiline_comment|/* Slot 7  - unused */
l_int|0
comma
multiline_comment|/* Slot 8  - unused */
l_int|0
comma
multiline_comment|/* Slot 9  - unused */
l_int|0
comma
multiline_comment|/* Slot 10 - unused */
l_int|0
comma
multiline_comment|/* Slot 11 - unused */
l_int|16
comma
multiline_comment|/* Slot 12 - SCSI */
l_int|0
comma
multiline_comment|/* Slot 13 - unused */
l_int|0
comma
multiline_comment|/* Slot 14 - unused */
l_int|0
comma
multiline_comment|/* Slot 15 - unused */
)brace
suffix:semicolon
DECL|variable|BeBox_pci_IRQ_routes
r_static
r_char
id|BeBox_pci_IRQ_routes
(braket
)braket
op_assign
(brace
l_int|0
comma
multiline_comment|/* Line 0 - Unused */
l_int|9
comma
multiline_comment|/* Line 1 */
l_int|11
comma
multiline_comment|/* Line 2 */
l_int|14
comma
multiline_comment|/* Line 3 */
l_int|15
multiline_comment|/* Line 4 */
)brace
suffix:semicolon
multiline_comment|/* IBM Nobis */
DECL|variable|Nobis_pci_IRQ_map
r_static
r_char
id|Nobis_pci_IRQ_map
(braket
l_int|16
)braket
op_assign
(brace
l_int|0
comma
multiline_comment|/* Slot 0  - unused */
l_int|0
comma
multiline_comment|/* Slot 1  - unused */
l_int|0
comma
multiline_comment|/* Slot 2  - unused */
l_int|0
comma
multiline_comment|/* Slot 3  - unused */
l_int|0
comma
multiline_comment|/* Slot 4  - unused */
l_int|0
comma
multiline_comment|/* Slot 5  - unused */
l_int|0
comma
multiline_comment|/* Slot 6  - unused */
l_int|0
comma
multiline_comment|/* Slot 7  - unused */
l_int|0
comma
multiline_comment|/* Slot 8  - unused */
l_int|0
comma
multiline_comment|/* Slot 9  - unused */
l_int|0
comma
multiline_comment|/* Slot 10 - unused */
l_int|0
comma
multiline_comment|/* Slot 11 - unused */
l_int|3
comma
multiline_comment|/* Slot 12 - SCSI */
l_int|0
comma
multiline_comment|/* Slot 13 - unused */
l_int|0
comma
multiline_comment|/* Slot 14 - unused */
l_int|0
comma
multiline_comment|/* Slot 15 - unused */
)brace
suffix:semicolon
DECL|variable|Nobis_pci_IRQ_routes
r_static
r_char
id|Nobis_pci_IRQ_routes
(braket
)braket
op_assign
(brace
l_int|0
comma
multiline_comment|/* Line 0 - Unused */
l_int|13
comma
multiline_comment|/* Line 1 */
l_int|13
comma
multiline_comment|/* Line 2 */
l_int|13
comma
multiline_comment|/* Line 3 */
l_int|13
multiline_comment|/* Line 4 */
)brace
suffix:semicolon
multiline_comment|/*&n; * ibm 830 (and 850?).&n; * This is actually based on the Carolina motherboard&n; * -- Cort&n; */
DECL|variable|ibm8xx_pci_IRQ_map
r_static
r_char
id|ibm8xx_pci_IRQ_map
(braket
l_int|23
)braket
op_assign
(brace
l_int|0
comma
multiline_comment|/* Slot 0  - unused */
l_int|0
comma
multiline_comment|/* Slot 1  - unused */
l_int|0
comma
multiline_comment|/* Slot 2  - unused */
l_int|0
comma
multiline_comment|/* Slot 3  - unused */
l_int|0
comma
multiline_comment|/* Slot 4  - unused */
l_int|0
comma
multiline_comment|/* Slot 5  - unused */
l_int|0
comma
multiline_comment|/* Slot 6  - unused */
l_int|0
comma
multiline_comment|/* Slot 7  - unused */
l_int|0
comma
multiline_comment|/* Slot 8  - unused */
l_int|0
comma
multiline_comment|/* Slot 9  - unused */
l_int|0
comma
multiline_comment|/* Slot 10 - unused */
l_int|0
comma
multiline_comment|/* Slot 11 - FireCoral */
l_int|4
comma
multiline_comment|/* Slot 12 - Ethernet  PCIINTD# */
l_int|2
comma
multiline_comment|/* Slot 13 - PCI Slot #2 */
l_int|2
comma
multiline_comment|/* Slot 14 - S3 Video PCIINTD# */
l_int|0
comma
multiline_comment|/* Slot 15 - onboard SCSI (INDI) [1] */
l_int|3
comma
multiline_comment|/* Slot 16 - NCR58C810 RS6000 Only PCIINTC# */
l_int|0
comma
multiline_comment|/* Slot 17 - unused */
l_int|2
comma
multiline_comment|/* Slot 18 - PCI Slot 2 PCIINTx# (See below) */
l_int|0
comma
multiline_comment|/* Slot 19 - unused */
l_int|0
comma
multiline_comment|/* Slot 20 - unused */
l_int|0
comma
multiline_comment|/* Slot 21 - unused */
l_int|2
comma
multiline_comment|/* Slot 22 - PCI slot 1 PCIINTx# (See below) */
)brace
suffix:semicolon
DECL|variable|ibm8xx_pci_IRQ_routes
r_static
r_char
id|ibm8xx_pci_IRQ_routes
(braket
)braket
op_assign
(brace
l_int|0
comma
multiline_comment|/* Line 0 - unused */
l_int|13
comma
multiline_comment|/* Line 1 */
l_int|10
comma
multiline_comment|/* Line 2 */
l_int|15
comma
multiline_comment|/* Line 3 */
l_int|15
comma
multiline_comment|/* Line 4 */
)brace
suffix:semicolon
multiline_comment|/* This just changes the PCI slots &amp; onboard SCSI + S3 to IRQ10, but&n; * it really needs some logic to set them to unique IRQ&squot;s, or even&n; * add some logic to the drivers to ask an irq.c routine to re-map&n; * the IRQ if it needs one to itself...&n; */
DECL|variable|Carolina_PIRQ_routes
r_static
r_char
id|Carolina_PIRQ_routes
(braket
)braket
op_assign
(brace
l_int|0xad
comma
multiline_comment|/* INTB# = 10, INTA# = 13 */
l_int|0xff
multiline_comment|/* INTD# = 15, INTC# = 15 */
)brace
suffix:semicolon
multiline_comment|/* We have to turn on LEVEL mode for changed IRQ&squot;s */
multiline_comment|/* All PCI IRQ&squot;s need to be level mode, so this should be something&n; * other than hard-coded as well... IRQ&squot;s are individually mappable&n; * to either edge or level.&n; */
DECL|macro|CAROLINA_IRQ_EDGE_MASK_LO
mdefine_line|#define CAROLINA_IRQ_EDGE_MASK_LO   0x00  /* IRQ&squot;s 0-7  */
DECL|macro|CAROLINA_IRQ_EDGE_MASK_HI
mdefine_line|#define CAROLINA_IRQ_EDGE_MASK_HI   0xA4  /* IRQ&squot;s 8-15 [10,13,15] */
DECL|macro|PCI_DEVICE_ID_IBM_CORAL
mdefine_line|#define PCI_DEVICE_ID_IBM_CORAL&t;&t;0x000a
DECL|macro|PCI_DEBUG
macro_line|#undef  PCI_DEBUG
macro_line|#ifdef PCI_STATS
DECL|variable|PCI_conversions
r_int
id|PCI_conversions
(braket
l_int|2
)braket
suffix:semicolon
macro_line|#endif
DECL|function|pcibios_fixup
r_int
r_int
id|pcibios_fixup
c_func
(paren
r_int
r_int
id|mem_start
comma
r_int
r_int
id|mem_end
)paren
(brace
r_return
id|mem_start
suffix:semicolon
)brace
r_int
DECL|function|pcibios_present
id|pcibios_present
(paren
r_void
)paren
(brace
macro_line|#ifdef PCI_DEBUG&t;
id|printk
c_func
(paren
l_string|&quot;PCI [BIOS] present?&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif&t;
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_int
DECL|function|pcibios_read_config_dword
id|pcibios_read_config_dword
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev
comma
r_int
r_char
id|offset
comma
r_int
r_int
op_star
id|val
)paren
(brace
r_int
r_int
id|_val
suffix:semicolon
r_int
r_int
op_star
id|ptr
suffix:semicolon
id|dev
op_rshift_assign
l_int|3
suffix:semicolon
macro_line|#ifdef PCI_DEBUG&t;
id|printk
c_func
(paren
l_string|&quot;PCI Read config dword[%d.%d.%x] = &quot;
comma
id|bus
comma
id|dev
comma
id|offset
)paren
suffix:semicolon
macro_line|#endif&t;
r_if
c_cond
(paren
(paren
id|bus
op_ne
l_int|0
)paren
op_logical_or
(paren
id|dev
OL
l_int|11
)paren
op_logical_or
(paren
id|dev
OG
l_int|16
)paren
)paren
(brace
op_star
id|val
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
)brace
r_else
(brace
id|ptr
op_assign
(paren
r_int
r_int
op_star
)paren
(paren
l_int|0x80800000
op_or
(paren
l_int|1
op_lshift
id|dev
)paren
op_or
id|offset
)paren
suffix:semicolon
macro_line|#ifdef PCI_DEBUG&t;
id|printk
c_func
(paren
l_string|&quot;[%x] &quot;
comma
id|ptr
)paren
suffix:semicolon
macro_line|#endif&t;&t;
id|_val
op_assign
id|le32_to_cpu
c_func
(paren
op_star
id|ptr
)paren
suffix:semicolon
)brace
macro_line|#ifdef PCI_DEBUG&t;
id|printk
c_func
(paren
l_string|&quot;%x&bslash;n&quot;
comma
id|_val
)paren
suffix:semicolon
macro_line|#endif&t;
op_star
id|val
op_assign
id|_val
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
r_int
DECL|function|pcibios_read_config_word
id|pcibios_read_config_word
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev
comma
r_int
r_char
id|offset
comma
r_int
r_int
op_star
id|val
)paren
(brace
r_int
r_int
id|_val
suffix:semicolon
r_int
r_int
op_star
id|ptr
suffix:semicolon
id|dev
op_rshift_assign
l_int|3
suffix:semicolon
macro_line|#ifdef PCI_DEBUG
id|printk
c_func
(paren
l_string|&quot;PCI Read config word[%d.%d.%x] = &quot;
comma
id|bus
comma
id|dev
comma
id|offset
)paren
suffix:semicolon
macro_line|#endif&t;
r_if
c_cond
(paren
(paren
id|bus
op_ne
l_int|0
)paren
op_logical_or
(paren
id|dev
OL
l_int|11
)paren
op_logical_or
(paren
id|dev
OG
l_int|16
)paren
)paren
(brace
op_star
id|val
op_assign
(paren
r_int
r_int
)paren
l_int|0xFFFFFFFF
suffix:semicolon
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
)brace
r_else
(brace
id|ptr
op_assign
(paren
r_int
r_int
op_star
)paren
(paren
l_int|0x80800000
op_or
(paren
l_int|1
op_lshift
id|dev
)paren
op_or
id|offset
)paren
suffix:semicolon
macro_line|#ifdef PCI_DEBUG
id|printk
c_func
(paren
l_string|&quot;[%x] &quot;
comma
id|ptr
)paren
suffix:semicolon
macro_line|#endif&t;&t;
id|_val
op_assign
id|le16_to_cpu
c_func
(paren
op_star
id|ptr
)paren
suffix:semicolon
)brace
macro_line|#ifdef PCI_DEBUG
id|printk
c_func
(paren
l_string|&quot;%x&bslash;n&quot;
comma
id|_val
)paren
suffix:semicolon
macro_line|#endif&t;&t;
op_star
id|val
op_assign
id|_val
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
r_int
DECL|function|pcibios_read_config_byte
id|pcibios_read_config_byte
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev
comma
r_int
r_char
id|offset
comma
r_int
r_char
op_star
id|val
)paren
(brace
r_int
r_char
id|_val
suffix:semicolon
r_volatile
r_int
r_char
op_star
id|ptr
suffix:semicolon
id|dev
op_rshift_assign
l_int|3
suffix:semicolon
multiline_comment|/* Note: the configuration registers don&squot;t always have this right! */
r_if
c_cond
(paren
id|offset
op_eq
id|PCI_INTERRUPT_LINE
)paren
(brace
r_if
c_cond
(paren
id|Motherboard_map
(braket
id|dev
)braket
op_le
l_int|4
)paren
(brace
op_star
id|val
op_assign
id|Motherboard_routes
(braket
id|Motherboard_map
(braket
id|dev
)braket
)braket
suffix:semicolon
multiline_comment|/*printk(&quot;dev %d map %d route %d&bslash;n&quot;,&n;&t;&t;&t;  dev,Motherboard_map[dev],&n;&t;&t;&t;  Motherboard_routes[Motherboard_map[dev]]);*/
)brace
r_else
(brace
multiline_comment|/* Pseudo interrupts [for BeBox] */
op_star
id|val
op_assign
id|Motherboard_map
(braket
id|dev
)braket
suffix:semicolon
)brace
macro_line|#ifdef PCI_DEBUG&t;
id|printk
c_func
(paren
l_string|&quot;PCI Read Interrupt Line[%d.%d] = %d&bslash;n&quot;
comma
id|bus
comma
id|dev
comma
op_star
id|val
)paren
suffix:semicolon
macro_line|#endif&t;&t;
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
macro_line|#ifdef PCI_DEBUG&t;
id|printk
c_func
(paren
l_string|&quot;PCI Read config byte[%d.%d.%x] = &quot;
comma
id|bus
comma
id|dev
comma
id|offset
)paren
suffix:semicolon
macro_line|#endif&t;&t;
r_if
c_cond
(paren
(paren
id|bus
op_ne
l_int|0
)paren
op_logical_or
(paren
id|dev
OL
l_int|11
)paren
op_logical_or
(paren
id|dev
OG
l_int|16
)paren
)paren
(brace
op_star
id|val
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
)brace
r_else
(brace
id|ptr
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
l_int|0x80800000
op_or
(paren
l_int|1
op_lshift
id|dev
)paren
op_or
id|offset
op_xor
l_int|1
)paren
suffix:semicolon
macro_line|#ifdef PCI_DEBUG&t;
id|printk
c_func
(paren
l_string|&quot;[%x] &quot;
comma
id|ptr
)paren
suffix:semicolon
macro_line|#endif&t;&t;
id|_val
op_assign
op_star
id|ptr
suffix:semicolon
)brace
macro_line|#ifdef PCI_DEBUG&t;
id|printk
c_func
(paren
l_string|&quot;%x&bslash;n&quot;
comma
id|_val
)paren
suffix:semicolon
macro_line|#endif
op_star
id|val
op_assign
id|_val
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
r_int
DECL|function|pcibios_write_config_dword
id|pcibios_write_config_dword
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev
comma
r_int
r_char
id|offset
comma
r_int
r_int
id|val
)paren
(brace
r_int
r_int
id|_val
suffix:semicolon
r_int
r_int
op_star
id|ptr
suffix:semicolon
id|dev
op_rshift_assign
l_int|3
suffix:semicolon
id|_val
op_assign
id|le32_to_cpu
c_func
(paren
id|val
)paren
suffix:semicolon
macro_line|#ifdef PCI_DEBUG&t;
id|printk
c_func
(paren
l_string|&quot;PCI Write config dword[%d.%d.%x] = %x&bslash;n&quot;
comma
id|bus
comma
id|dev
comma
id|offset
comma
id|_val
)paren
suffix:semicolon
macro_line|#endif&t;&t;
r_if
c_cond
(paren
(paren
id|bus
op_ne
l_int|0
)paren
op_logical_or
(paren
id|dev
OL
l_int|11
)paren
op_logical_or
(paren
id|dev
OG
l_int|16
)paren
)paren
(brace
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
)brace
r_else
(brace
id|ptr
op_assign
(paren
r_int
r_int
op_star
)paren
(paren
l_int|0x80800000
op_or
(paren
l_int|1
op_lshift
id|dev
)paren
op_or
id|offset
)paren
suffix:semicolon
op_star
id|ptr
op_assign
id|_val
suffix:semicolon
)brace
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
r_int
DECL|function|pcibios_write_config_word
id|pcibios_write_config_word
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev
comma
r_int
r_char
id|offset
comma
r_int
r_int
id|val
)paren
(brace
r_int
r_int
id|_val
suffix:semicolon
r_int
r_int
op_star
id|ptr
suffix:semicolon
id|dev
op_rshift_assign
l_int|3
suffix:semicolon
id|_val
op_assign
id|le16_to_cpu
c_func
(paren
id|val
)paren
suffix:semicolon
macro_line|#ifdef PCI_DEBUG&t;
id|printk
c_func
(paren
l_string|&quot;PCI Write config word[%d.%d.%x] = %x&bslash;n&quot;
comma
id|bus
comma
id|dev
comma
id|offset
comma
id|_val
)paren
suffix:semicolon
macro_line|#endif&t;&t;
r_if
c_cond
(paren
(paren
id|bus
op_ne
l_int|0
)paren
op_logical_or
(paren
id|dev
OL
l_int|11
)paren
op_logical_or
(paren
id|dev
OG
l_int|16
)paren
)paren
(brace
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
)brace
r_else
(brace
id|ptr
op_assign
(paren
r_int
r_int
op_star
)paren
(paren
l_int|0x80800000
op_or
(paren
l_int|1
op_lshift
id|dev
)paren
op_or
id|offset
)paren
suffix:semicolon
op_star
id|ptr
op_assign
id|_val
suffix:semicolon
)brace
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
r_int
DECL|function|pcibios_write_config_byte
id|pcibios_write_config_byte
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev
comma
r_int
r_char
id|offset
comma
r_int
r_char
id|val
)paren
(brace
r_int
r_char
id|_val
suffix:semicolon
r_int
r_char
op_star
id|ptr
suffix:semicolon
id|dev
op_rshift_assign
l_int|3
suffix:semicolon
id|_val
op_assign
id|val
suffix:semicolon
macro_line|#ifdef PCI_DEBUG&t;
id|printk
c_func
(paren
l_string|&quot;PCI Write config byte[%d.%d.%x] = %x&bslash;n&quot;
comma
id|bus
comma
id|dev
comma
id|offset
comma
id|_val
)paren
suffix:semicolon
macro_line|#endif&t;&t;
r_if
c_cond
(paren
(paren
id|bus
op_ne
l_int|0
)paren
op_logical_or
(paren
id|dev
OL
l_int|11
)paren
op_logical_or
(paren
id|dev
OG
l_int|16
)paren
)paren
(brace
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
)brace
r_else
(brace
id|ptr
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
l_int|0x80800000
op_or
(paren
l_int|1
op_lshift
id|dev
)paren
op_or
id|offset
op_xor
l_int|1
)paren
suffix:semicolon
op_star
id|ptr
op_assign
id|_val
suffix:semicolon
)brace
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
r_int
DECL|function|pcibios_find_device
id|pcibios_find_device
(paren
r_int
r_int
id|vendor
comma
r_int
r_int
id|device_id
comma
r_int
r_int
id|index
comma
r_int
r_char
op_star
id|bus
comma
r_int
r_char
op_star
id|dev
)paren
(brace
r_int
r_int
id|w
comma
id|desired
op_assign
(paren
id|device_id
op_lshift
l_int|16
)paren
op_or
id|vendor
suffix:semicolon
r_int
id|devnr
suffix:semicolon
r_if
c_cond
(paren
id|vendor
op_eq
l_int|0xffff
)paren
(brace
r_return
id|PCIBIOS_BAD_VENDOR_ID
suffix:semicolon
)brace
r_for
c_loop
(paren
id|devnr
op_assign
l_int|11
suffix:semicolon
id|devnr
OL
l_int|16
suffix:semicolon
id|devnr
op_increment
)paren
(brace
id|pcibios_read_config_dword
c_func
(paren
l_int|0
comma
id|devnr
op_lshift
l_int|3
comma
id|PCI_VENDOR_ID
comma
op_amp
id|w
)paren
suffix:semicolon
r_if
c_cond
(paren
id|w
op_eq
id|desired
)paren
(brace
r_if
c_cond
(paren
id|index
op_eq
l_int|0
)paren
(brace
op_star
id|bus
op_assign
l_int|0
suffix:semicolon
op_star
id|dev
op_assign
id|devnr
op_lshift
l_int|3
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
op_decrement
id|index
suffix:semicolon
)brace
)brace
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
)brace
r_int
DECL|function|pcibios_find_class
id|pcibios_find_class
(paren
r_int
r_int
id|class_code
comma
r_int
r_int
id|index
comma
r_int
r_char
op_star
id|bus
comma
r_int
r_char
op_star
id|dev
)paren
(brace
r_int
id|dev_nr
comma
r_class
comma
id|indx
suffix:semicolon
id|indx
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef PCI_DEBUG&t;
id|printk
c_func
(paren
l_string|&quot;pcibios_find_class - class: %x, index: %x&quot;
comma
id|class_code
comma
id|index
)paren
suffix:semicolon
macro_line|#endif&t;
r_for
c_loop
(paren
id|dev_nr
op_assign
l_int|11
suffix:semicolon
id|dev_nr
OL
l_int|16
suffix:semicolon
id|dev_nr
op_increment
)paren
(brace
id|pcibios_read_config_dword
c_func
(paren
l_int|0
comma
id|dev_nr
op_lshift
l_int|3
comma
id|PCI_CLASS_REVISION
comma
op_amp
r_class
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_class
op_rshift
l_int|8
)paren
op_eq
id|class_code
)paren
(brace
r_if
c_cond
(paren
id|index
op_eq
id|indx
)paren
(brace
op_star
id|bus
op_assign
l_int|0
suffix:semicolon
op_star
id|dev
op_assign
id|dev_nr
op_lshift
l_int|3
suffix:semicolon
macro_line|#ifdef PCI_DEBUG
id|printk
c_func
(paren
l_string|&quot; - device: %x&bslash;n&quot;
comma
id|dev_nr
)paren
suffix:semicolon
macro_line|#endif&t;
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|indx
op_increment
suffix:semicolon
)brace
)brace
macro_line|#ifdef PCI_DEBUG
id|printk
c_func
(paren
l_string|&quot; - not found&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif&t;
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
)brace
DECL|function|pcibios_strerror
r_const
r_char
op_star
id|pcibios_strerror
c_func
(paren
r_int
id|error
)paren
(brace
r_static
r_char
id|buf
(braket
l_int|32
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|error
)paren
(brace
r_case
id|PCIBIOS_SUCCESSFUL
suffix:colon
r_return
(paren
l_string|&quot;PCI BIOS: no error&quot;
)paren
suffix:semicolon
r_case
id|PCIBIOS_FUNC_NOT_SUPPORTED
suffix:colon
r_return
(paren
l_string|&quot;PCI BIOS: function not supported&quot;
)paren
suffix:semicolon
r_case
id|PCIBIOS_BAD_VENDOR_ID
suffix:colon
r_return
(paren
l_string|&quot;PCI BIOS: bad vendor ID&quot;
)paren
suffix:semicolon
r_case
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:colon
r_return
(paren
l_string|&quot;PCI BIOS: device not found&quot;
)paren
suffix:semicolon
r_case
id|PCIBIOS_BAD_REGISTER_NUMBER
suffix:colon
r_return
(paren
l_string|&quot;PCI BIOS: bad register number&quot;
)paren
suffix:semicolon
r_case
id|PCIBIOS_SET_FAILED
suffix:colon
r_return
(paren
l_string|&quot;PCI BIOS: set failed&quot;
)paren
suffix:semicolon
r_case
id|PCIBIOS_BUFFER_TOO_SMALL
suffix:colon
r_return
(paren
l_string|&quot;PCI BIOS: buffer too small&quot;
)paren
suffix:semicolon
r_default
suffix:colon
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;PCI BIOS: invalid error #%d&quot;
comma
id|error
)paren
suffix:semicolon
r_return
id|buf
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Note: This routine has to access the PCI configuration space&n; * for the PCI bridge chip (Intel 82378).&n; */
DECL|function|pcibios_init
r_int
r_int
id|pcibios_init
c_func
(paren
r_int
r_int
id|mem_start
comma
r_int
r_int
id|mem_end
)paren
(brace
r_return
id|mem_start
suffix:semicolon
)brace
DECL|function|route_pci_interrupts
r_int
r_int
id|route_pci_interrupts
c_func
(paren
r_void
)paren
(brace
r_int
r_char
op_star
id|ibc_pirq
op_assign
(paren
r_int
r_char
op_star
)paren
l_int|0x80800860
suffix:semicolon
r_int
r_char
op_star
id|ibc_pcicon
op_assign
(paren
r_int
r_char
op_star
)paren
l_int|0x80800840
suffix:semicolon
r_extern
r_int
r_int
id|isBeBox
(braket
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|_machine
op_eq
id|_MACH_Motorola
)paren
(brace
r_switch
c_cond
(paren
id|inb
c_func
(paren
l_int|0x800
)paren
op_amp
l_int|0xF0
)paren
(brace
r_case
l_int|0x10
suffix:colon
multiline_comment|/* MVME16xx */
id|Motherboard_map_name
op_assign
l_string|&quot;Genesis&quot;
suffix:semicolon
id|Motherboard_map
op_assign
id|Genesis_pci_IRQ_map
suffix:semicolon
id|Motherboard_routes
op_assign
id|Genesis_pci_IRQ_routes
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x20
suffix:colon
multiline_comment|/* Series E */
id|Motherboard_map_name
op_assign
l_string|&quot;Series E&quot;
suffix:semicolon
id|Motherboard_map
op_assign
id|Comet_pci_IRQ_map
suffix:semicolon
id|Motherboard_routes
op_assign
id|Comet_pci_IRQ_routes
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x40
suffix:colon
multiline_comment|/* PowerStack */
r_default
suffix:colon
multiline_comment|/* Can&squot;t hurt, can it? */
id|Motherboard_map_name
op_assign
l_string|&quot;Blackhawk (Powerstack)&quot;
suffix:semicolon
id|Motherboard_map
op_assign
id|Blackhawk_pci_IRQ_map
suffix:semicolon
id|Motherboard_routes
op_assign
id|Blackhawk_pci_IRQ_routes
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|_machine
op_eq
id|_MACH_IBM
)paren
(brace
r_int
r_char
id|pl_id
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|index
suffix:semicolon
r_int
r_char
id|fn
comma
id|bus
suffix:semicolon
r_int
r_int
id|addr
suffix:semicolon
r_int
r_char
id|dma_mode
comma
id|ide_mode
suffix:semicolon
r_int
id|i
suffix:semicolon
id|Motherboard_map_name
op_assign
l_string|&quot;IBM 8xx (Carolina)&quot;
suffix:semicolon
id|Motherboard_map
op_assign
id|ibm8xx_pci_IRQ_map
suffix:semicolon
id|Motherboard_routes
op_assign
id|ibm8xx_pci_IRQ_routes
suffix:semicolon
id|ll_printk
c_func
(paren
l_string|&quot;before loop&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|index
op_assign
l_int|0
suffix:semicolon
op_logical_neg
id|pcibios_find_device
(paren
id|PCI_VENDOR_ID_IBM
comma
id|PCI_DEVICE_ID_IBM_CORAL
comma
id|index
comma
op_amp
id|bus
comma
op_amp
id|fn
)paren
suffix:semicolon
op_increment
id|index
)paren
(brace
id|pcibios_read_config_dword
c_func
(paren
id|bus
comma
id|fn
comma
l_int|0x10
comma
op_amp
id|addr
)paren
suffix:semicolon
id|addr
op_and_assign
op_complement
l_int|0x3
suffix:semicolon
id|outb
c_func
(paren
l_int|0x26
comma
id|addr
)paren
suffix:semicolon
id|dma_mode
op_assign
id|inb
c_func
(paren
id|addr
op_plus
l_int|4
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x25
comma
id|addr
)paren
suffix:semicolon
id|ide_mode
op_assign
id|inb
c_func
(paren
id|addr
op_plus
l_int|4
)paren
suffix:semicolon
multiline_comment|/*printk(&quot;CORAL I/O at 0x%x, DMA mode: %x, IDE mode: %x&quot;, &n;&t;&t;&t;&t;       addr, dma_mode, ide_mode);*/
multiline_comment|/* Make CDROM non-DMA */
id|ide_mode
op_assign
(paren
id|ide_mode
op_amp
l_int|0x0F
)paren
op_or
l_int|0x20
suffix:semicolon
id|outb
c_func
(paren
l_int|0x25
comma
id|addr
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ide_mode
comma
id|addr
op_plus
l_int|4
)paren
suffix:semicolon
id|dma_mode
op_assign
id|dma_mode
op_amp
op_complement
l_int|0x80
suffix:semicolon
id|outb
c_func
(paren
l_int|0x26
comma
id|addr
)paren
suffix:semicolon
id|outb
c_func
(paren
id|dma_mode
comma
id|addr
op_plus
l_int|4
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x26
comma
id|addr
)paren
suffix:semicolon
id|dma_mode
op_assign
id|inb
c_func
(paren
id|addr
op_plus
l_int|4
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x25
comma
id|addr
)paren
suffix:semicolon
id|ide_mode
op_assign
id|inb
c_func
(paren
id|addr
op_plus
l_int|4
)paren
suffix:semicolon
multiline_comment|/*printk(&quot;=&gt; DMA mode: %x, IDE mode: %x&bslash;n&quot;, &n;&t;&t;&t;&t;       dma_mode, ide_mode);*/
)brace
multiline_comment|/* Setup the PCI INT mappings for the Carolina */
multiline_comment|/* These are PCI Interrupt Route Control [1|2] Register */
id|outb
c_func
(paren
id|Carolina_PIRQ_routes
(braket
l_int|0
)braket
comma
l_int|0x0890
)paren
suffix:semicolon
id|outb
c_func
(paren
id|Carolina_PIRQ_routes
(braket
l_int|1
)braket
comma
l_int|0x0891
)paren
suffix:semicolon
id|pl_id
op_assign
id|inb
c_func
(paren
l_int|0x0852
)paren
suffix:semicolon
multiline_comment|/*printk(&quot;CPU Planar ID is %#0x&bslash;n&quot;, pl_id);*/
r_if
c_cond
(paren
id|pl_id
op_eq
l_int|0x0C
)paren
(brace
multiline_comment|/* INDI */
id|Motherboard_map
(braket
l_int|12
)braket
op_assign
l_int|1
suffix:semicolon
)brace
id|ll_printk
c_func
(paren
l_string|&quot;before edge/level&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if 0&t;&t;&t;
multiline_comment|/*printk(&quot;Changing IRQ mode&bslash;n&quot;);*/
id|pl_id
op_assign
id|inb
c_func
(paren
l_int|0x04d0
)paren
suffix:semicolon
multiline_comment|/*printk(&quot;Low mask is %#0x&bslash;n&quot;, pl_id);*/
id|outb
c_func
(paren
id|pl_id
op_or
id|CAROLINA_IRQ_EDGE_MASK_LO
comma
l_int|0x04d0
)paren
suffix:semicolon
id|pl_id
op_assign
id|inb
c_func
(paren
l_int|0x04d1
)paren
suffix:semicolon
multiline_comment|/*printk(&quot;Hi mask is  %#0x&bslash;n&quot;, pl_id);*/
id|outb
c_func
(paren
id|pl_id
op_or
id|CAROLINA_IRQ_EDGE_MASK_HI
comma
l_int|0x04d1
)paren
suffix:semicolon
id|pl_id
op_assign
id|inb
c_func
(paren
l_int|0x04d1
)paren
suffix:semicolon
multiline_comment|/*printk(&quot;Hi mask now %#0x&bslash;n&quot;, pl_id);*/
macro_line|#endif&t;&t;&t;
)brace
)brace
multiline_comment|/* Set up mapping from slots */
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_le
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ibc_pirq
(braket
id|i
op_minus
l_int|1
)braket
op_assign
id|Motherboard_routes
(braket
id|i
)braket
suffix:semicolon
)brace
multiline_comment|/* Enable PCI interrupts */
op_star
id|ibc_pcicon
op_or_assign
l_int|0x20
suffix:semicolon
)brace
eof
