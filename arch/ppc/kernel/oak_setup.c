multiline_comment|/*&n; *&n; *    Copyright (c) 1999-2000 Grant Erickson &lt;grant@lcse.umn.edu&gt;&n; *&n; *    Module name: oak_setup.c&n; *&n; *    Description:&n; *      Architecture- / platform-specific boot-time initialization code for&n; *      the IBM PowerPC 403GCX &quot;Oak&quot; evaluation board. Adapted from original&n; *      code by Gary Thomas, Cort Dougan &lt;cort@fsmlabs.com&gt;, and Dan Malek&n; *      &lt;dan@net4x.com&gt;.&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/threads.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/param.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/board.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &quot;local_irq.h&quot;
macro_line|#include &quot;ppc4xx_pic.h&quot;
macro_line|#include &lt;asm/time.h&gt;
macro_line|#include &quot;oak_setup.h&quot;
multiline_comment|/* Function Prototypes */
r_extern
r_void
m_abort
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/* Global Variables */
DECL|variable|__res
r_int
r_char
id|__res
(braket
r_sizeof
(paren
id|bd_t
)paren
)braket
suffix:semicolon
multiline_comment|/*&n; * void __init oak_init()&n; *&n; * Description:&n; *   This routine...&n; *&n; * Input(s):&n; *   r3 - Optional pointer to a board information structure.&n; *   r4 - Optional pointer to the physical starting address of the init RAM&n; *        disk.&n; *   r5 - Optional pointer to the physical ending address of the init RAM&n; *        disk.&n; *   r6 - Optional pointer to the physical starting address of any kernel&n; *        command-line parameters.&n; *   r7 - Optional pointer to the physical ending address of any kernel&n; *        command-line parameters.&n; *&n; * Output(s):&n; *   N/A&n; *&n; * Returns:&n; *   N/A&n; *&n; */
r_void
id|__init
DECL|function|oak_init
id|oak_init
c_func
(paren
r_int
r_int
id|r3
comma
r_int
r_int
id|r4
comma
r_int
r_int
id|r5
comma
r_int
r_int
id|r6
comma
r_int
r_int
id|r7
)paren
(brace
multiline_comment|/*&n;&t; * If we were passed in a board information, copy it into the&n;&t; * residual data area.&n;&t; */
r_if
c_cond
(paren
id|r3
)paren
(brace
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|__res
comma
(paren
r_void
op_star
)paren
(paren
id|r3
op_plus
id|KERNELBASE
)paren
comma
r_sizeof
(paren
id|bd_t
)paren
)paren
suffix:semicolon
)brace
macro_line|#if defined(CONFIG_BLK_DEV_INITRD)
multiline_comment|/*&n;&t; * If the init RAM disk has been configured in, and there&squot;s a valid&n;&t; * starting address for it, set it up.&n;&t; */
r_if
c_cond
(paren
id|r4
)paren
(brace
id|initrd_start
op_assign
id|r4
op_plus
id|KERNELBASE
suffix:semicolon
id|initrd_end
op_assign
id|r5
op_plus
id|KERNELBASE
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_BLK_DEV_INITRD */
multiline_comment|/* Copy the kernel command line arguments to a safe place. */
r_if
c_cond
(paren
id|r6
)paren
(brace
op_star
(paren
r_char
op_star
)paren
(paren
id|r7
op_plus
id|KERNELBASE
)paren
op_assign
l_int|0
suffix:semicolon
id|strcpy
c_func
(paren
id|cmd_line
comma
(paren
r_char
op_star
)paren
(paren
id|r6
op_plus
id|KERNELBASE
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialize machine-dependency vectors */
id|ppc_md.setup_arch
op_assign
id|oak_setup_arch
suffix:semicolon
id|ppc_md.setup_residual
op_assign
id|oak_setup_residual
suffix:semicolon
id|ppc_md.get_cpuinfo
op_assign
l_int|NULL
suffix:semicolon
id|ppc_md.irq_cannonicalize
op_assign
l_int|NULL
suffix:semicolon
id|ppc_md.init_IRQ
op_assign
id|oak_init_IRQ
suffix:semicolon
id|ppc_md.get_irq
op_assign
id|oak_get_irq
suffix:semicolon
id|ppc_md.init
op_assign
l_int|NULL
suffix:semicolon
id|ppc_md.restart
op_assign
id|oak_restart
suffix:semicolon
id|ppc_md.power_off
op_assign
id|oak_power_off
suffix:semicolon
id|ppc_md.halt
op_assign
id|oak_halt
suffix:semicolon
id|ppc_md.time_init
op_assign
id|oak_time_init
suffix:semicolon
id|ppc_md.set_rtc_time
op_assign
id|oak_set_rtc_time
suffix:semicolon
id|ppc_md.get_rtc_time
op_assign
id|oak_get_rtc_time
suffix:semicolon
id|ppc_md.calibrate_decr
op_assign
id|oak_calibrate_decr
suffix:semicolon
id|ppc_md.kbd_setkeycode
op_assign
l_int|NULL
suffix:semicolon
id|ppc_md.kbd_getkeycode
op_assign
l_int|NULL
suffix:semicolon
id|ppc_md.kbd_translate
op_assign
l_int|NULL
suffix:semicolon
id|ppc_md.kbd_unexpected_up
op_assign
l_int|NULL
suffix:semicolon
id|ppc_md.kbd_leds
op_assign
l_int|NULL
suffix:semicolon
id|ppc_md.kbd_init_hw
op_assign
l_int|NULL
suffix:semicolon
macro_line|#if defined(CONFIG_MAGIC_SYSRQ)
id|ppc_md.ppc_kbd_sysrq_xlate
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Document me.&n; */
r_void
id|__init
DECL|function|oak_setup_arch
id|oak_setup_arch
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* XXX - Implement me */
)brace
multiline_comment|/*&n; * int oak_setup_residual()&n; *&n; * Description:&n; *   This routine pretty-prints the platform&squot;s internal CPU and bus clock&n; *   frequencies into the buffer for usage in /proc/cpuinfo.&n; *&n; * Input(s):&n; *  *buffer - Buffer into which CPU and bus clock frequencies are to be&n; *            printed.&n; *&n; * Output(s):&n; *  *buffer - Buffer with the CPU and bus clock frequencies.&n; *&n; * Returns:&n; *   The number of bytes copied into &squot;buffer&squot; if OK, otherwise zero or less&n; *   on error.&n; */
r_int
DECL|function|oak_setup_residual
id|oak_setup_residual
c_func
(paren
r_char
op_star
id|buffer
)paren
(brace
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|bd_t
op_star
id|bp
op_assign
(paren
id|bd_t
op_star
)paren
id|__res
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|len
op_plus
id|buffer
comma
l_string|&quot;clock&bslash;t&bslash;t: %dMHz&bslash;n&quot;
l_string|&quot;bus clock&bslash;t&bslash;t: %dMHz&bslash;n&quot;
comma
id|bp-&gt;bi_intfreq
op_div
l_int|1000000
comma
id|bp-&gt;bi_busfreq
op_div
l_int|1000000
)paren
suffix:semicolon
r_return
(paren
id|len
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Document me.&n; */
r_void
id|__init
DECL|function|oak_init_IRQ
id|oak_init_IRQ
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|ppc4xx_pic_init
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_IRQS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|irq_desc
(braket
id|i
)braket
dot
id|handler
op_assign
id|ppc4xx_pic
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Document me.&n; */
r_int
DECL|function|oak_get_irq
id|oak_get_irq
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_return
(paren
id|ppc4xx_pic_get_irq
c_func
(paren
id|regs
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Document me.&n; */
r_void
DECL|function|oak_restart
id|oak_restart
c_func
(paren
r_char
op_star
id|cmd
)paren
(brace
m_abort
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Document me.&n; */
r_void
DECL|function|oak_power_off
id|oak_power_off
c_func
(paren
r_void
)paren
(brace
id|oak_restart
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Document me.&n; */
r_void
DECL|function|oak_halt
id|oak_halt
c_func
(paren
r_void
)paren
(brace
id|oak_restart
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Document me.&n; */
r_int
id|__init
DECL|function|oak_time_init
id|oak_time_init
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* XXX - Implement me */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Document me.&n; */
r_int
id|__init
DECL|function|oak_set_rtc_time
id|oak_set_rtc_time
c_func
(paren
r_int
r_int
id|time
)paren
(brace
multiline_comment|/* XXX - Implement me */
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Document me.&n; */
r_int
r_int
id|__init
DECL|function|oak_get_rtc_time
id|oak_get_rtc_time
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* XXX - Implement me */
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * void __init oak_calibrate_decr()&n; *&n; * Description:&n; *   This routine retrieves the internal processor frequency from the board&n; *   information structure, sets up the kernel timer decrementer based on&n; *   that value, enables the 403 programmable interval timer (PIT) and sets&n; *   it up for auto-reload.&n; *&n; * Input(s):&n; *   N/A&n; *&n; * Output(s):&n; *   N/A&n; *&n; * Returns:&n; *   N/A&n; *&n; */
r_void
id|__init
DECL|function|oak_calibrate_decr
id|oak_calibrate_decr
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|freq
suffix:semicolon
id|bd_t
op_star
id|bip
op_assign
(paren
id|bd_t
op_star
)paren
id|__res
suffix:semicolon
id|freq
op_assign
id|bip-&gt;bi_intfreq
suffix:semicolon
id|decrementer_count
op_assign
id|freq
op_div
id|HZ
suffix:semicolon
id|count_period_num
op_assign
l_int|1
suffix:semicolon
id|count_period_den
op_assign
id|freq
suffix:semicolon
multiline_comment|/* Enable the PIT and set auto-reload of its value */
id|mtspr
c_func
(paren
id|SPRN_TCR
comma
id|TCR_PIE
op_or
id|TCR_ARE
)paren
suffix:semicolon
multiline_comment|/* Clear any pending timer interrupts */
id|mtspr
c_func
(paren
id|SPRN_TSR
comma
id|TSR_ENW
op_or
id|TSR_WIS
op_or
id|TSR_PIS
op_or
id|TSR_FIS
)paren
suffix:semicolon
)brace
eof
