DECL|macro|FALSE
mdefine_line|#define FALSE 0
DECL|macro|TRUE
mdefine_line|#define TRUE  1
macro_line|#include &lt;stdarg.h&gt;
r_extern
r_void
id|cnputc
c_func
(paren
r_char
id|c
)paren
suffix:semicolon
r_char
id|cngetc
c_func
(paren
r_void
)paren
suffix:semicolon
r_int
id|cntstc
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|_cnpause
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|cnpause
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|video_on
c_func
(paren
r_void
)paren
suffix:semicolon
r_int
id|CRT_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_int
id|kbd
c_func
(paren
r_int
id|noblock
)paren
suffix:semicolon
r_int
id|scankbd
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|variable|_sprintk_ptr
r_static
r_char
op_star
id|_sprintk_ptr
suffix:semicolon
r_void
id|kbdreset
c_func
(paren
r_void
)paren
suffix:semicolon
r_int
id|CRT_test
c_func
(paren
r_void
)paren
suffix:semicolon
r_int
id|CRT_putc
c_func
(paren
r_int
comma
r_int
r_char
)paren
suffix:semicolon
multiline_comment|/*int CRT_putc(int port, u_char c)*/
r_int
id|CRT_getc
c_func
(paren
r_void
)paren
suffix:semicolon
r_int
id|_vprintk
c_func
(paren
r_int
(paren
op_star
id|putc
)paren
(paren
)paren
comma
r_const
r_char
op_star
id|fmt0
comma
id|va_list
id|ap
)paren
suffix:semicolon
r_static
id|_cvt
c_func
(paren
r_int
r_int
id|val
comma
r_char
op_star
id|buf
comma
r_int
id|radix
comma
r_char
op_star
id|digits
)paren
suffix:semicolon
r_static
r_void
id|cursor
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|initscreen
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/*&n; * COM1 NS16550 support&n; */
DECL|struct|NS16550
r_struct
id|NS16550
(brace
DECL|member|rbr
r_int
r_char
id|rbr
suffix:semicolon
multiline_comment|/* 0 */
DECL|member|ier
r_int
r_char
id|ier
suffix:semicolon
multiline_comment|/* 1 */
DECL|member|fcr
r_int
r_char
id|fcr
suffix:semicolon
multiline_comment|/* 2 */
DECL|member|lcr
r_int
r_char
id|lcr
suffix:semicolon
multiline_comment|/* 3 */
DECL|member|mcr
r_int
r_char
id|mcr
suffix:semicolon
multiline_comment|/* 4 */
DECL|member|lsr
r_int
r_char
id|lsr
suffix:semicolon
multiline_comment|/* 5 */
DECL|member|msr
r_int
r_char
id|msr
suffix:semicolon
multiline_comment|/* 6 */
DECL|member|scr
r_int
r_char
id|scr
suffix:semicolon
multiline_comment|/* 7 */
)brace
suffix:semicolon
DECL|macro|thr
mdefine_line|#define thr rbr
DECL|macro|iir
mdefine_line|#define iir fcr
DECL|macro|dll
mdefine_line|#define dll rbr
DECL|macro|dlm
mdefine_line|#define dlm ier
DECL|macro|LSR_DR
mdefine_line|#define LSR_DR   0x01  /* Data ready */
DECL|macro|LSR_OE
mdefine_line|#define LSR_OE   0x02  /* Overrun */
DECL|macro|LSR_PE
mdefine_line|#define LSR_PE   0x04  /* Parity error */
DECL|macro|LSR_FE
mdefine_line|#define LSR_FE   0x08  /* Framing error */
DECL|macro|LSR_BI
mdefine_line|#define LSR_BI   0x10  /* Break */
DECL|macro|LSR_THRE
mdefine_line|#define LSR_THRE 0x20  /* Xmit holding register empty */
DECL|macro|LSR_TEMT
mdefine_line|#define LSR_TEMT 0x40  /* Xmitter empty */
DECL|macro|LSR_ERR
mdefine_line|#define LSR_ERR  0x80  /* Error */
DECL|macro|COM1
mdefine_line|#define COM1&t;0x800003F8
DECL|macro|COM2
mdefine_line|#define COM2&t;0x800002F8
DECL|typedef|NS16550_t
r_typedef
r_struct
id|NS16550
op_star
id|NS16550_t
suffix:semicolon
DECL|variable|COM_PORTS
r_const
id|NS16550_t
id|COM_PORTS
(braket
)braket
op_assign
(brace
id|COM1
comma
id|COM2
)brace
suffix:semicolon
r_volatile
r_struct
id|NS16550
op_star
id|NS16550_init
c_func
(paren
r_int
id|chan
)paren
suffix:semicolon
r_void
id|NS16550_putc
c_func
(paren
r_volatile
r_struct
id|NS16550
op_star
id|com_port
comma
r_int
r_char
id|c
)paren
suffix:semicolon
r_int
r_char
id|NS16550_getc
c_func
(paren
r_volatile
r_struct
id|NS16550
op_star
id|com_port
)paren
suffix:semicolon
DECL|function|_sputc
r_static
id|_sputc
c_func
(paren
r_char
id|c
)paren
(brace
op_star
id|_sprintk_ptr
op_increment
op_assign
id|c
suffix:semicolon
op_star
id|_sprintk_ptr
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
DECL|function|_sprintk
id|_sprintk
c_func
(paren
r_char
op_star
id|buf
comma
r_char
r_const
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
r_int
id|ret
suffix:semicolon
id|va_list
id|ap
suffix:semicolon
id|va_start
c_func
(paren
id|ap
comma
id|fmt
)paren
suffix:semicolon
id|_sprintk_ptr
op_assign
id|buf
suffix:semicolon
id|ret
op_assign
id|_vprintk
c_func
(paren
id|_sputc
comma
id|fmt
comma
id|ap
)paren
suffix:semicolon
id|va_end
c_func
(paren
id|ap
)paren
suffix:semicolon
r_return
(paren
id|ret
)paren
suffix:semicolon
)brace
DECL|function|_vsprintk
id|_vsprintk
c_func
(paren
r_char
op_star
id|buf
comma
r_char
r_const
op_star
id|fmt
comma
id|va_list
id|ap
)paren
(brace
r_int
id|ret
suffix:semicolon
id|_sprintk_ptr
op_assign
id|buf
suffix:semicolon
id|ret
op_assign
id|_vprintk
c_func
(paren
id|_sputc
comma
id|fmt
comma
id|ap
)paren
suffix:semicolon
r_return
(paren
id|ret
)paren
suffix:semicolon
)brace
DECL|function|_printk
id|_printk
c_func
(paren
r_char
r_const
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
r_int
id|ret
suffix:semicolon
id|va_list
id|ap
suffix:semicolon
id|va_start
c_func
(paren
id|ap
comma
id|fmt
)paren
suffix:semicolon
id|ret
op_assign
id|_vprintk
c_func
(paren
id|cnputc
comma
id|fmt
comma
id|ap
)paren
suffix:semicolon
id|va_end
c_func
(paren
id|ap
)paren
suffix:semicolon
r_return
(paren
id|ret
)paren
suffix:semicolon
)brace
DECL|macro|is_digit
mdefine_line|#define is_digit(c) ((c &gt;= &squot;0&squot;) &amp;&amp; (c &lt;= &squot;9&squot;))
DECL|function|_vprintk
r_int
id|_vprintk
c_func
(paren
r_int
(paren
op_star
id|putc
)paren
(paren
)paren
comma
r_const
r_char
op_star
id|fmt0
comma
id|va_list
id|ap
)paren
(brace
r_char
id|c
comma
id|sign
comma
op_star
id|cp
suffix:semicolon
r_int
id|left_prec
comma
id|right_prec
comma
id|zero_fill
comma
id|length
comma
id|pad
comma
id|pad_on_right
suffix:semicolon
r_char
id|buf
(braket
l_int|32
)braket
suffix:semicolon
r_int
id|val
suffix:semicolon
r_while
c_loop
(paren
id|c
op_assign
op_star
id|fmt0
op_increment
)paren
(brace
r_if
c_cond
(paren
id|c
op_eq
l_char|&squot;%&squot;
)paren
(brace
id|c
op_assign
op_star
id|fmt0
op_increment
suffix:semicolon
id|left_prec
op_assign
id|right_prec
op_assign
id|pad_on_right
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|c
op_eq
l_char|&squot;-&squot;
)paren
(brace
id|c
op_assign
op_star
id|fmt0
op_increment
suffix:semicolon
id|pad_on_right
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|c
op_eq
l_char|&squot;0&squot;
)paren
(brace
id|zero_fill
op_assign
id|TRUE
suffix:semicolon
id|c
op_assign
op_star
id|fmt0
op_increment
suffix:semicolon
)brace
r_else
(brace
id|zero_fill
op_assign
id|FALSE
suffix:semicolon
)brace
r_while
c_loop
(paren
id|is_digit
c_func
(paren
id|c
)paren
)paren
(brace
id|left_prec
op_assign
(paren
id|left_prec
op_star
l_int|10
)paren
op_plus
(paren
id|c
op_minus
l_char|&squot;0&squot;
)paren
suffix:semicolon
id|c
op_assign
op_star
id|fmt0
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|c
op_eq
l_char|&squot;.&squot;
)paren
(brace
id|c
op_assign
op_star
id|fmt0
op_increment
suffix:semicolon
id|zero_fill
op_increment
suffix:semicolon
r_while
c_loop
(paren
id|is_digit
c_func
(paren
id|c
)paren
)paren
(brace
id|right_prec
op_assign
(paren
id|right_prec
op_star
l_int|10
)paren
op_plus
(paren
id|c
op_minus
l_char|&squot;0&squot;
)paren
suffix:semicolon
id|c
op_assign
op_star
id|fmt0
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
id|right_prec
op_assign
id|left_prec
suffix:semicolon
)brace
id|sign
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_switch
c_cond
(paren
id|c
)paren
(brace
r_case
l_char|&squot;d&squot;
suffix:colon
r_case
l_char|&squot;x&squot;
suffix:colon
r_case
l_char|&squot;X&squot;
suffix:colon
id|val
op_assign
id|va_arg
c_func
(paren
id|ap
comma
r_int
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|c
)paren
(brace
r_case
l_char|&squot;d&squot;
suffix:colon
r_if
c_cond
(paren
id|val
OL
l_int|0
)paren
(brace
id|sign
op_assign
l_char|&squot;-&squot;
suffix:semicolon
id|val
op_assign
op_minus
id|val
suffix:semicolon
)brace
id|length
op_assign
id|_cvt
c_func
(paren
id|val
comma
id|buf
comma
l_int|10
comma
l_string|&quot;0123456789&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;x&squot;
suffix:colon
id|length
op_assign
id|_cvt
c_func
(paren
id|val
comma
id|buf
comma
l_int|16
comma
l_string|&quot;0123456789abcdef&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;X&squot;
suffix:colon
id|length
op_assign
id|_cvt
c_func
(paren
id|val
comma
id|buf
comma
l_int|16
comma
l_string|&quot;0123456789ABCDEF&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|cp
op_assign
id|buf
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;s&squot;
suffix:colon
id|cp
op_assign
id|va_arg
c_func
(paren
id|ap
comma
r_char
op_star
)paren
suffix:semicolon
id|length
op_assign
id|strlen
c_func
(paren
id|cp
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;c&squot;
suffix:colon
id|c
op_assign
id|va_arg
c_func
(paren
id|ap
comma
r_int
multiline_comment|/*char*/
)paren
suffix:semicolon
(paren
op_star
id|putc
)paren
(paren
id|c
)paren
suffix:semicolon
r_continue
suffix:semicolon
r_default
suffix:colon
(paren
op_star
id|putc
)paren
(paren
l_char|&squot;?&squot;
)paren
suffix:semicolon
)brace
id|pad
op_assign
id|left_prec
op_minus
id|length
suffix:semicolon
r_if
c_cond
(paren
id|sign
op_ne
l_char|&squot;&bslash;0&squot;
)paren
(brace
id|pad
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|zero_fill
)paren
(brace
id|c
op_assign
l_char|&squot;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|sign
op_ne
l_char|&squot;&bslash;0&squot;
)paren
(brace
(paren
op_star
id|putc
)paren
(paren
id|sign
)paren
suffix:semicolon
id|sign
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
)brace
r_else
(brace
id|c
op_assign
l_char|&squot; &squot;
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pad_on_right
)paren
(brace
r_while
c_loop
(paren
id|pad
op_decrement
OG
l_int|0
)paren
(brace
(paren
op_star
id|putc
)paren
(paren
id|c
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|sign
op_ne
l_char|&squot;&bslash;0&squot;
)paren
(brace
(paren
op_star
id|putc
)paren
(paren
id|sign
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|length
op_decrement
OG
l_int|0
)paren
(brace
(paren
op_star
id|putc
)paren
(paren
id|c
op_assign
op_star
id|cp
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
op_eq
l_char|&squot;&bslash;n&squot;
)paren
(brace
(paren
op_star
id|putc
)paren
(paren
l_char|&squot;&bslash;r&squot;
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pad_on_right
)paren
(brace
r_while
c_loop
(paren
id|pad
op_decrement
OG
l_int|0
)paren
(brace
(paren
op_star
id|putc
)paren
(paren
id|c
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
(paren
op_star
id|putc
)paren
(paren
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
op_eq
l_char|&squot;&bslash;n&squot;
)paren
(brace
(paren
op_star
id|putc
)paren
(paren
l_char|&squot;&bslash;r&squot;
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
DECL|function|_cvt
r_static
id|_cvt
c_func
(paren
r_int
r_int
id|val
comma
r_char
op_star
id|buf
comma
r_int
id|radix
comma
r_char
op_star
id|digits
)paren
(brace
r_char
id|temp
(braket
l_int|80
)braket
suffix:semicolon
r_char
op_star
id|cp
op_assign
id|temp
suffix:semicolon
r_int
id|length
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Special case */
op_star
id|cp
op_increment
op_assign
l_char|&squot;0&squot;
suffix:semicolon
)brace
r_else
r_while
c_loop
(paren
id|val
)paren
(brace
op_star
id|cp
op_increment
op_assign
id|digits
(braket
id|val
op_mod
id|radix
)braket
suffix:semicolon
id|val
op_div_assign
id|radix
suffix:semicolon
)brace
r_while
c_loop
(paren
id|cp
op_ne
id|temp
)paren
(brace
op_star
id|buf
op_increment
op_assign
op_star
op_decrement
id|cp
suffix:semicolon
id|length
op_increment
suffix:semicolon
)brace
op_star
id|buf
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
(paren
id|length
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Console I/O interface&n; */
DECL|typedef|proc
r_typedef
r_const
(paren
op_star
id|proc
)paren
(paren
)paren
suffix:semicolon
DECL|typedef|dev_t
r_typedef
r_int
id|dev_t
suffix:semicolon
DECL|macro|FALSE
mdefine_line|#define FALSE 0
DECL|macro|TRUE
mdefine_line|#define TRUE  1
DECL|macro|CRT_PORT
mdefine_line|#define CRT_PORT 0x3D4  /* Pick one */
DECL|variable|init
r_static
r_int
id|init
op_assign
id|FALSE
suffix:semicolon
DECL|variable|is_crt
r_static
r_int
id|is_crt
op_assign
l_int|0
suffix:semicolon
DECL|variable|port
r_static
r_int
id|port
op_assign
l_int|0
suffix:semicolon
DECL|variable|line_num
r_static
r_int
id|line_num
op_assign
l_int|0
suffix:semicolon
DECL|macro|MAX_LINES
mdefine_line|#define MAX_LINES 24
DECL|function|cngetc
r_char
id|cngetc
c_func
(paren
r_void
)paren
(brace
r_int
id|s
op_assign
id|_disable_interrupts
c_func
(paren
)paren
suffix:semicolon
r_char
id|c
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|port
op_eq
id|CRT_PORT
)paren
(brace
multiline_comment|/*      c = CRT_getc(port);*/
id|c
op_assign
id|CRT_getc
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|port
)paren
(brace
id|c
op_assign
id|NS16550_getc
c_func
(paren
(paren
r_struct
id|NS16550
op_star
)paren
id|port
)paren
suffix:semicolon
)brace
id|_enable_interrupts
c_func
(paren
id|s
)paren
suffix:semicolon
r_return
(paren
id|c
)paren
suffix:semicolon
)brace
DECL|function|cntstc
r_int
id|cntstc
c_func
(paren
r_void
)paren
(brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|variable|_cn_trace
r_char
id|_cn_trace
(braket
l_int|1024
)braket
suffix:semicolon
DECL|variable|_cnp
r_char
op_star
id|_cnp
op_assign
id|_cn_trace
suffix:semicolon
multiline_comment|/*&n; * Console kernel output character routine.&n; */
r_void
DECL|function|cnputc
id|cnputc
c_func
(paren
r_char
id|c
)paren
(brace
op_star
id|_cnp
op_increment
op_assign
id|c
suffix:semicolon
r_if
c_cond
(paren
id|_cnp
op_eq
op_amp
id|_cn_trace
(braket
r_sizeof
(paren
id|_cn_trace
)paren
)braket
)paren
(brace
id|_cnp
op_assign
id|_cn_trace
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|init
)paren
(brace
r_if
c_cond
(paren
id|is_crt
op_assign
id|CRT_init
c_func
(paren
)paren
)paren
(brace
id|port
op_assign
id|CRT_PORT
suffix:semicolon
)brace
r_else
(brace
id|port
op_assign
(paren
r_int
)paren
id|NS16550_init
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|init
op_assign
id|TRUE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|port
op_eq
id|CRT_PORT
)paren
(brace
id|CRT_putc
c_func
(paren
id|port
comma
id|c
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|port
)paren
(brace
id|NS16550_putc
c_func
(paren
(paren
r_struct
id|NS16550
op_star
)paren
id|port
comma
id|c
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|c
op_eq
l_char|&squot;&bslash;n&squot;
)paren
(brace
r_if
c_cond
(paren
id|line_num
op_ge
l_int|0
)paren
id|line_num
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|c
op_eq
l_char|&squot;&bslash;r&squot;
)paren
(brace
r_if
c_cond
(paren
id|line_num
op_ge
id|MAX_LINES
)paren
(brace
id|line_num
op_assign
l_int|0
suffix:semicolon
id|_cnpause
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|_cnpause
r_void
id|_cnpause
c_func
(paren
r_void
)paren
(brace
r_int
id|c
suffix:semicolon
r_int
id|s
op_assign
id|_disable_interrupts
c_func
(paren
)paren
suffix:semicolon
id|_printk
c_func
(paren
l_string|&quot;-- More? &quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|c
op_assign
id|cngetc
c_func
(paren
)paren
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|_printk
c_func
(paren
l_string|&quot;&bslash;r         &bslash;r&quot;
)paren
suffix:semicolon
multiline_comment|/* Erase prompt */
r_if
c_cond
(paren
id|c
op_eq
l_char|&squot; &squot;
)paren
(brace
id|line_num
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|c
op_eq
l_char|&squot;n&squot;
)paren
(brace
id|line_num
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Turn off pause */
)brace
r_else
r_if
c_cond
(paren
(paren
id|c
op_eq
l_char|&squot;&bslash;r&squot;
)paren
op_logical_or
(paren
id|c
op_eq
l_char|&squot;&bslash;n&squot;
)paren
)paren
(brace
id|line_num
op_assign
id|MAX_LINES
op_minus
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|c
op_eq
l_int|0x03
)paren
multiline_comment|/* ^C */
(brace
m_abort
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|line_num
op_assign
id|MAX_LINES
op_minus
(paren
id|MAX_LINES
op_div
l_int|3
)paren
suffix:semicolon
)brace
id|_enable_interrupts
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
DECL|function|cnpause
r_void
id|cnpause
c_func
(paren
r_void
)paren
(brace
r_int
id|c
suffix:semicolon
r_int
id|s
op_assign
id|_disable_interrupts
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;-- More? &quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|c
op_assign
id|cngetc
c_func
(paren
)paren
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;r         &bslash;r&quot;
)paren
suffix:semicolon
multiline_comment|/* Erase prompt */
id|_enable_interrupts
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
DECL|function|NS16550_init
r_volatile
r_struct
id|NS16550
op_star
id|NS16550_init
c_func
(paren
r_int
id|chan
)paren
(brace
r_volatile
r_struct
id|NS16550
op_star
id|com_port
suffix:semicolon
r_volatile
r_int
r_char
id|xx
suffix:semicolon
id|com_port
op_assign
(paren
r_struct
id|NS16550
op_star
)paren
id|COM_PORTS
(braket
id|chan
)braket
suffix:semicolon
multiline_comment|/* See if port is present */
id|com_port-&gt;lcr
op_assign
l_int|0x00
suffix:semicolon
id|com_port-&gt;ier
op_assign
l_int|0xFF
suffix:semicolon
macro_line|#if 0&t;
r_if
c_cond
(paren
id|com_port-&gt;ier
op_ne
l_int|0x0F
)paren
r_return
(paren
(paren
r_struct
id|NS16550
op_star
)paren
l_int|0
)paren
suffix:semicolon
macro_line|#endif&t;
id|com_port-&gt;ier
op_assign
l_int|0x00
suffix:semicolon
id|com_port-&gt;lcr
op_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* Access baud rate */
id|com_port-&gt;dll
op_assign
l_int|12
suffix:semicolon
multiline_comment|/* 9600 baud */
id|com_port-&gt;dlm
op_assign
l_int|12
op_rshift
l_int|8
suffix:semicolon
id|com_port-&gt;lcr
op_assign
l_int|0x03
suffix:semicolon
multiline_comment|/* 8 data, 1 stop, no parity */
id|com_port-&gt;mcr
op_assign
l_int|0x03
suffix:semicolon
multiline_comment|/* RTS/DTR */
id|com_port-&gt;fcr
op_assign
l_int|0x07
suffix:semicolon
multiline_comment|/* Clear &amp; enable FIFOs */
r_return
(paren
id|com_port
)paren
suffix:semicolon
)brace
DECL|function|NS16550_putc
r_void
id|NS16550_putc
c_func
(paren
r_volatile
r_struct
id|NS16550
op_star
id|com_port
comma
r_int
r_char
id|c
)paren
(brace
r_volatile
r_int
id|i
suffix:semicolon
r_while
c_loop
(paren
(paren
id|com_port-&gt;lsr
op_amp
id|LSR_THRE
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|com_port-&gt;thr
op_assign
id|c
suffix:semicolon
)brace
DECL|function|NS16550_getc
r_int
r_char
id|NS16550_getc
c_func
(paren
r_volatile
r_struct
id|NS16550
op_star
id|com_port
)paren
(brace
r_while
c_loop
(paren
(paren
id|com_port-&gt;lsr
op_amp
id|LSR_DR
)paren
op_eq
l_int|0
)paren
suffix:semicolon
r_return
(paren
id|com_port-&gt;rbr
)paren
suffix:semicolon
)brace
DECL|function|NS16550_test
id|NS16550_test
c_func
(paren
r_volatile
r_struct
id|NS16550
op_star
id|com_port
)paren
(brace
r_return
(paren
(paren
id|com_port-&gt;lsr
op_amp
id|LSR_DR
)paren
op_ne
l_int|0
)paren
suffix:semicolon
)brace
DECL|typedef|u_short
r_typedef
r_int
r_int
id|u_short
suffix:semicolon
DECL|typedef|u_char
r_typedef
r_int
r_char
id|u_char
suffix:semicolon
DECL|macro|COL
mdefine_line|#define&t;COL&t;&t;80
DECL|macro|ROW
mdefine_line|#define&t;ROW&t;&t;25
DECL|macro|CHR
mdefine_line|#define&t;CHR&t;&t;2
DECL|macro|MONO_BASE
mdefine_line|#define MONO_BASE&t;0x3B4
DECL|macro|MONO_BUF
mdefine_line|#define MONO_BUF&t;0xB0000
DECL|macro|CGA_BASE
mdefine_line|#define CGA_BASE&t;0x3D4
DECL|macro|CGA_BUF
mdefine_line|#define CGA_BUF&t;&t;0xB8000
DECL|macro|ISA_mem
mdefine_line|#define ISA_mem&t;&t;((unsigned char *)0xC0000000)
DECL|macro|ISA_io
mdefine_line|#define ISA_io&t;&t;((unsigned char *)0x80000000)
DECL|variable|background
r_int
r_char
id|background
op_assign
l_int|0
suffix:semicolon
DECL|variable|foreground
r_int
r_char
id|foreground
op_assign
l_int|6
suffix:semicolon
DECL|variable|addr_6845
r_int
r_int
id|addr_6845
suffix:semicolon
DECL|variable|Crtat
r_int
r_int
op_star
id|Crtat
suffix:semicolon
DECL|variable|lastpos
r_int
id|lastpos
suffix:semicolon
DECL|variable|scroll
r_int
id|scroll
suffix:semicolon
r_static
r_void
DECL|function|outb
id|outb
c_func
(paren
r_int
id|port
comma
r_int
r_char
id|c
)paren
(brace
id|ISA_io
(braket
id|port
)braket
op_assign
id|c
suffix:semicolon
)brace
r_static
r_int
r_char
DECL|function|inb
id|inb
c_func
(paren
r_int
id|port
)paren
(brace
r_return
(paren
id|ISA_io
(braket
id|port
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * The current state of virtual displays&n; */
DECL|struct|screen
r_struct
id|screen
(brace
DECL|member|cp
id|u_short
op_star
id|cp
suffix:semicolon
multiline_comment|/* the current character address */
DECL|enum|state
r_enum
id|state
(brace
DECL|enumerator|NORMAL
id|NORMAL
comma
multiline_comment|/* no pending escape */
DECL|enumerator|ESC
id|ESC
comma
multiline_comment|/* saw ESC */
DECL|enumerator|EBRAC
id|EBRAC
comma
multiline_comment|/* saw ESC[ */
DECL|enumerator|EBRACEQ
id|EBRACEQ
multiline_comment|/* saw ESC[= */
DECL|member|state
)brace
id|state
suffix:semicolon
multiline_comment|/* command parser state */
DECL|member|cx
r_int
id|cx
suffix:semicolon
multiline_comment|/* the first escape seq argument */
DECL|member|cy
r_int
id|cy
suffix:semicolon
multiline_comment|/* the second escape seq argument */
DECL|member|accp
r_int
op_star
id|accp
suffix:semicolon
multiline_comment|/* pointer to the current processed argument */
DECL|member|row
r_int
id|row
suffix:semicolon
multiline_comment|/* current column */
DECL|member|so
r_int
id|so
suffix:semicolon
multiline_comment|/* standout mode */
DECL|member|color
id|u_short
id|color
suffix:semicolon
multiline_comment|/* normal character color */
DECL|member|color_so
id|u_short
id|color_so
suffix:semicolon
multiline_comment|/* standout color */
DECL|member|save_color
id|u_short
id|save_color
suffix:semicolon
multiline_comment|/* saved normal color */
DECL|member|save_color_so
id|u_short
id|save_color_so
suffix:semicolon
multiline_comment|/* saved standout color */
DECL|variable|screen
)brace
id|screen
suffix:semicolon
multiline_comment|/*&n; * Color and attributes for normal, standout and kernel output&n; * are stored in the least-significant byte of a u_short&n; * so they don&squot;t have to be shifted for use.&n; * This is all byte-order dependent.&n; */
DECL|macro|CATTR
mdefine_line|#define&t;CATTR(x) (x)&t;&t;/* store color/attributes un-shifted */
DECL|macro|ATTR_ADDR
mdefine_line|#define&t;ATTR_ADDR(which) (((u_char *)&amp;(which))+1) /* address of attributes */
DECL|variable|pccolor
r_int
r_int
id|pccolor
suffix:semicolon
multiline_comment|/* color/attributes for tty output */
DECL|variable|pccolor_so
r_int
r_int
id|pccolor_so
suffix:semicolon
multiline_comment|/* color/attributes, standout mode */
multiline_comment|/*&n; * cursor() sets an offset (0-1999) into the 80x25 text area   &n; */
DECL|function|cursor
r_static
r_void
id|cursor
c_func
(paren
r_void
)paren
(brace
r_int
id|pos
op_assign
id|screen.cp
op_minus
id|Crtat
suffix:semicolon
r_if
c_cond
(paren
id|lastpos
op_ne
id|pos
)paren
(brace
id|outb
c_func
(paren
id|addr_6845
comma
l_int|14
)paren
suffix:semicolon
id|outb
c_func
(paren
id|addr_6845
op_plus
l_int|1
comma
id|pos
op_rshift
l_int|8
)paren
suffix:semicolon
id|outb
c_func
(paren
id|addr_6845
comma
l_int|15
)paren
suffix:semicolon
id|outb
c_func
(paren
id|addr_6845
op_plus
l_int|1
comma
id|pos
)paren
suffix:semicolon
id|lastpos
op_assign
id|pos
suffix:semicolon
)brace
)brace
DECL|function|initscreen
r_static
r_void
id|initscreen
c_func
(paren
r_void
)paren
(brace
r_struct
id|screen
op_star
id|d
op_assign
op_amp
id|screen
suffix:semicolon
id|pccolor
op_assign
id|CATTR
c_func
(paren
(paren
id|background
op_lshift
l_int|4
)paren
op_or
id|foreground
)paren
suffix:semicolon
id|pccolor_so
op_assign
id|CATTR
c_func
(paren
(paren
id|foreground
op_lshift
l_int|4
)paren
op_or
id|background
)paren
suffix:semicolon
id|d-&gt;color
op_assign
id|pccolor
suffix:semicolon
id|d-&gt;save_color
op_assign
id|pccolor
suffix:semicolon
id|d-&gt;color_so
op_assign
id|pccolor_so
suffix:semicolon
id|d-&gt;save_color_so
op_assign
id|pccolor_so
suffix:semicolon
)brace
DECL|macro|wrtchar
mdefine_line|#define&t;wrtchar(c, d) { &bslash;&n;&t;*(d-&gt;cp) = c; &bslash;&n;&t;d-&gt;cp++; &bslash;&n;&t;d-&gt;row++; &bslash;&n;}
DECL|function|fillw
id|fillw
c_func
(paren
r_int
r_int
id|val
comma
r_int
r_int
op_star
id|buf
comma
r_int
id|num
)paren
(brace
multiline_comment|/* Need to byte swap value */
r_int
r_int
id|tmp
suffix:semicolon
id|tmp
op_assign
id|val
suffix:semicolon
r_while
c_loop
(paren
id|num
op_decrement
OG
l_int|0
)paren
(brace
op_star
id|buf
op_increment
op_assign
id|tmp
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * CRT_putc (nee sput) has support for emulation of the &squot;ibmpc&squot; termcap entry.&n; * This is a bare-bones implementation of a bare-bones entry&n; * One modification: Change li#24 to li#25 to reflect 25 lines&n; * &quot;ca&quot; is the color/attributes value (left-shifted by 8)&n; * or 0 if the current regular color for that screen is to be used.&n; */
DECL|function|CRT_putc
r_int
id|CRT_putc
c_func
(paren
r_int
id|port
comma
r_int
r_char
id|c
)paren
(brace
r_struct
id|screen
op_star
id|d
op_assign
op_amp
id|screen
suffix:semicolon
id|u_short
op_star
id|base
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
id|u_short
op_star
id|pp
suffix:semicolon
id|base
op_assign
id|Crtat
suffix:semicolon
r_switch
c_cond
(paren
id|d-&gt;state
)paren
(brace
r_case
id|NORMAL
suffix:colon
r_switch
c_cond
(paren
id|c
)paren
(brace
r_case
l_int|0x0
suffix:colon
multiline_comment|/* Ignore pad characters */
r_return
suffix:semicolon
r_case
l_int|0x1B
suffix:colon
id|d-&gt;state
op_assign
id|ESC
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;&bslash;t&squot;
suffix:colon
r_do
(brace
id|wrtchar
c_func
(paren
id|d-&gt;color
op_or
l_char|&squot; &squot;
comma
id|d
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|d-&gt;row
op_mod
l_int|8
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;&bslash;b&squot;
suffix:colon
multiline_comment|/* non-destructive backspace */
r_if
c_cond
(paren
id|d-&gt;cp
OG
id|base
)paren
(brace
id|d-&gt;cp
op_decrement
suffix:semicolon
id|d-&gt;row
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;row
OL
l_int|0
)paren
id|d-&gt;row
op_add_assign
id|COL
suffix:semicolon
multiline_comment|/* prev column */
)brace
r_break
suffix:semicolon
r_case
l_char|&squot;&bslash;r&squot;
suffix:colon
id|d-&gt;cp
op_sub_assign
id|d-&gt;row
suffix:semicolon
id|d-&gt;row
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;&bslash;n&squot;
suffix:colon
id|d-&gt;cp
op_add_assign
id|COL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;&bslash;007&squot;
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|d-&gt;so
)paren
(brace
id|wrtchar
c_func
(paren
id|d-&gt;color_so
op_or
(paren
id|c
op_lshift
l_int|8
)paren
comma
id|d
)paren
suffix:semicolon
)brace
r_else
(brace
id|wrtchar
c_func
(paren
id|d-&gt;color
op_or
(paren
id|c
op_lshift
l_int|8
)paren
comma
id|d
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|d-&gt;row
op_ge
id|COL
)paren
id|d-&gt;row
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|EBRAC
suffix:colon
multiline_comment|/*&n;&t;&t; * In this state, the action at the end of the switch&n;&t;&t; * on the character type is to go to NORMAL state,&n;&t;&t; * and intermediate states do a return rather than break.&n;&t;&t; */
r_switch
c_cond
(paren
id|c
)paren
(brace
r_case
l_char|&squot;m&squot;
suffix:colon
id|d-&gt;so
op_assign
id|d-&gt;cx
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;A&squot;
suffix:colon
multiline_comment|/* back one row */
r_if
c_cond
(paren
id|d-&gt;cp
op_ge
id|base
op_plus
id|COL
)paren
id|d-&gt;cp
op_sub_assign
id|COL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;B&squot;
suffix:colon
multiline_comment|/* down one row */
id|d-&gt;cp
op_add_assign
id|COL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;C&squot;
suffix:colon
multiline_comment|/* right cursor */
id|d-&gt;cp
op_increment
suffix:semicolon
id|d-&gt;row
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;D&squot;
suffix:colon
multiline_comment|/* left cursor */
r_if
c_cond
(paren
id|d-&gt;cp
OG
id|base
)paren
(brace
id|d-&gt;cp
op_decrement
suffix:semicolon
id|d-&gt;row
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;row
OL
l_int|0
)paren
id|d-&gt;row
op_add_assign
id|COL
suffix:semicolon
multiline_comment|/* prev column ??? */
)brace
r_break
suffix:semicolon
r_case
l_char|&squot;J&squot;
suffix:colon
multiline_comment|/* Clear to end of display */
id|fillw
c_func
(paren
id|d-&gt;color
op_or
(paren
l_char|&squot; &squot;
op_lshift
l_int|8
)paren
comma
id|d-&gt;cp
comma
id|base
op_plus
id|COL
op_star
id|ROW
op_minus
id|d-&gt;cp
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;K&squot;
suffix:colon
multiline_comment|/* Clear to EOL */
id|fillw
c_func
(paren
id|d-&gt;color
op_or
(paren
l_char|&squot; &squot;
op_lshift
l_int|8
)paren
comma
id|d-&gt;cp
comma
id|COL
op_minus
(paren
id|d-&gt;cp
op_minus
id|base
)paren
op_mod
id|COL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;H&squot;
suffix:colon
multiline_comment|/* Cursor move */
r_if
c_cond
(paren
id|d-&gt;cx
OG
id|ROW
)paren
id|d-&gt;cx
op_assign
id|ROW
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;cy
OG
id|COL
)paren
id|d-&gt;cy
op_assign
id|COL
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;cx
op_eq
l_int|0
op_logical_or
id|d-&gt;cy
op_eq
l_int|0
)paren
(brace
id|d-&gt;cp
op_assign
id|base
suffix:semicolon
id|d-&gt;row
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|d-&gt;cp
op_assign
id|base
op_plus
(paren
id|d-&gt;cx
op_minus
l_int|1
)paren
op_star
id|COL
op_plus
id|d-&gt;cy
op_minus
l_int|1
suffix:semicolon
id|d-&gt;row
op_assign
id|d-&gt;cy
op_minus
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_char|&squot;_&squot;
suffix:colon
multiline_comment|/* set cursor */
r_if
c_cond
(paren
id|d-&gt;cx
)paren
id|d-&gt;cx
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* block */
r_else
id|d-&gt;cx
op_assign
l_int|12
suffix:semicolon
multiline_comment|/* underline */
id|outb
c_func
(paren
id|addr_6845
comma
l_int|10
)paren
suffix:semicolon
id|outb
c_func
(paren
id|addr_6845
op_plus
l_int|1
comma
id|d-&gt;cx
)paren
suffix:semicolon
id|outb
c_func
(paren
id|addr_6845
comma
l_int|11
)paren
suffix:semicolon
id|outb
c_func
(paren
id|addr_6845
op_plus
l_int|1
comma
l_int|13
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;;&squot;
suffix:colon
multiline_comment|/* Switch params in cursor def */
id|d-&gt;accp
op_assign
op_amp
id|d-&gt;cy
suffix:semicolon
r_return
suffix:semicolon
r_case
l_char|&squot;=&squot;
suffix:colon
multiline_comment|/* ESC[= color change */
id|d-&gt;state
op_assign
id|EBRACEQ
suffix:semicolon
r_return
suffix:semicolon
r_case
l_char|&squot;L&squot;
suffix:colon
multiline_comment|/* Insert line */
id|i
op_assign
(paren
id|d-&gt;cp
op_minus
id|base
)paren
op_div
id|COL
suffix:semicolon
multiline_comment|/* avoid deficiency of bcopy implementation */
id|pp
op_assign
id|base
op_plus
id|COL
op_star
(paren
id|ROW
op_minus
l_int|2
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
id|ROW
op_minus
l_int|1
op_minus
id|i
suffix:semicolon
id|j
op_decrement
suffix:semicolon
id|pp
op_sub_assign
id|COL
)paren
id|bcopy
c_func
(paren
id|pp
comma
id|pp
op_plus
id|COL
comma
id|COL
op_star
id|CHR
)paren
suffix:semicolon
id|fillw
c_func
(paren
id|d-&gt;color
op_or
(paren
l_char|&squot; &squot;
op_lshift
l_int|8
)paren
comma
id|base
op_plus
id|i
op_star
id|COL
comma
id|COL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;M&squot;
suffix:colon
multiline_comment|/* Delete line */
id|i
op_assign
(paren
id|d-&gt;cp
op_minus
id|base
)paren
op_div
id|COL
suffix:semicolon
id|pp
op_assign
id|base
op_plus
id|i
op_star
id|COL
suffix:semicolon
id|bcopy
c_func
(paren
id|pp
op_plus
id|COL
comma
id|pp
comma
(paren
id|ROW
op_minus
l_int|1
op_minus
id|i
)paren
op_star
id|COL
op_star
id|CHR
)paren
suffix:semicolon
id|fillw
c_func
(paren
id|d-&gt;color
op_or
(paren
l_char|&squot; &squot;
op_lshift
l_int|8
)paren
comma
id|base
op_plus
id|COL
op_star
(paren
id|ROW
op_minus
l_int|1
)paren
comma
id|COL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
multiline_comment|/* Only numbers valid here */
r_if
c_cond
(paren
(paren
id|c
op_ge
l_char|&squot;0&squot;
)paren
op_logical_and
(paren
id|c
op_le
l_char|&squot;9&squot;
)paren
)paren
(brace
op_star
(paren
id|d-&gt;accp
)paren
op_mul_assign
l_int|10
suffix:semicolon
op_star
(paren
id|d-&gt;accp
)paren
op_add_assign
id|c
op_minus
l_char|&squot;0&squot;
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
r_break
suffix:semicolon
)brace
id|d-&gt;state
op_assign
id|NORMAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EBRACEQ
suffix:colon
(brace
multiline_comment|/*&n;&t;&t; * In this state, the action at the end of the switch&n;&t;&t; * on the character type is to go to NORMAL state,&n;&t;&t; * and intermediate states do a return rather than break.&n;&t;&t; */
id|u_char
op_star
id|colp
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Set foreground/background color&n;&t;&t; * for normal mode, standout mode&n;&t;&t; * or kernel output.&n;&t;&t; * Based on code from kentp@svmp03.&n;&t;&t; */
r_switch
c_cond
(paren
id|c
)paren
(brace
r_case
l_char|&squot;F&squot;
suffix:colon
id|colp
op_assign
id|ATTR_ADDR
c_func
(paren
id|d-&gt;color
)paren
suffix:semicolon
id|do_fg
suffix:colon
op_star
id|colp
op_assign
(paren
op_star
id|colp
op_amp
l_int|0xf0
)paren
op_or
(paren
id|d-&gt;cx
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;G&squot;
suffix:colon
id|colp
op_assign
id|ATTR_ADDR
c_func
(paren
id|d-&gt;color
)paren
suffix:semicolon
id|do_bg
suffix:colon
op_star
id|colp
op_assign
(paren
op_star
id|colp
op_amp
l_int|0xf
)paren
op_or
(paren
id|d-&gt;cx
op_lshift
l_int|4
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;H&squot;
suffix:colon
id|colp
op_assign
id|ATTR_ADDR
c_func
(paren
id|d-&gt;color_so
)paren
suffix:semicolon
r_goto
id|do_fg
suffix:semicolon
r_case
l_char|&squot;I&squot;
suffix:colon
id|colp
op_assign
id|ATTR_ADDR
c_func
(paren
id|d-&gt;color_so
)paren
suffix:semicolon
r_goto
id|do_bg
suffix:semicolon
r_case
l_char|&squot;S&squot;
suffix:colon
id|d-&gt;save_color
op_assign
id|d-&gt;color
suffix:semicolon
id|d-&gt;save_color_so
op_assign
id|d-&gt;color_so
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;R&squot;
suffix:colon
id|d-&gt;color
op_assign
id|d-&gt;save_color
suffix:semicolon
id|d-&gt;color_so
op_assign
id|d-&gt;save_color_so
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
multiline_comment|/* Only numbers valid here */
r_if
c_cond
(paren
(paren
id|c
op_ge
l_char|&squot;0&squot;
)paren
op_logical_and
(paren
id|c
op_le
l_char|&squot;9&squot;
)paren
)paren
(brace
id|d-&gt;cx
op_mul_assign
l_int|10
suffix:semicolon
id|d-&gt;cx
op_add_assign
id|c
op_minus
l_char|&squot;0&squot;
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
r_break
suffix:semicolon
)brace
id|d-&gt;state
op_assign
id|NORMAL
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ESC
suffix:colon
r_switch
c_cond
(paren
id|c
)paren
(brace
r_case
l_char|&squot;c&squot;
suffix:colon
multiline_comment|/* Clear screen &amp; home */
id|fillw
c_func
(paren
id|d-&gt;color
op_or
(paren
l_char|&squot; &squot;
op_lshift
l_int|8
)paren
comma
id|base
comma
id|COL
op_star
id|ROW
)paren
suffix:semicolon
id|d-&gt;cp
op_assign
id|base
suffix:semicolon
id|d-&gt;row
op_assign
l_int|0
suffix:semicolon
id|d-&gt;state
op_assign
id|NORMAL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;[&squot;
suffix:colon
multiline_comment|/* Start ESC [ sequence */
id|d-&gt;state
op_assign
id|EBRAC
suffix:semicolon
id|d-&gt;cx
op_assign
l_int|0
suffix:semicolon
id|d-&gt;cy
op_assign
l_int|0
suffix:semicolon
id|d-&gt;accp
op_assign
op_amp
id|d-&gt;cx
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* Invalid, clear state */
id|d-&gt;state
op_assign
id|NORMAL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|d-&gt;cp
op_ge
id|base
op_plus
(paren
id|COL
op_star
id|ROW
)paren
)paren
(brace
multiline_comment|/* scroll check */
id|bcopy
c_func
(paren
id|base
op_plus
id|COL
comma
id|base
comma
id|COL
op_star
(paren
id|ROW
op_minus
l_int|1
)paren
op_star
id|CHR
)paren
suffix:semicolon
id|fillw
c_func
(paren
id|d-&gt;color
op_or
(paren
l_char|&squot; &squot;
op_lshift
l_int|8
)paren
comma
id|base
op_plus
id|COL
op_star
(paren
id|ROW
op_minus
l_int|1
)paren
comma
id|COL
)paren
suffix:semicolon
id|d-&gt;cp
op_sub_assign
id|COL
suffix:semicolon
)brace
id|cursor
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|video_on
r_void
id|video_on
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Enable video */
id|outb
c_func
(paren
l_int|0x3C4
comma
l_int|0x01
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x3C5
comma
id|inb
c_func
(paren
l_int|0x3C5
)paren
op_amp
op_complement
l_int|20
)paren
suffix:semicolon
)brace
DECL|function|CRT_init
r_int
id|CRT_init
c_func
(paren
r_void
)paren
(brace
r_int
r_int
op_star
id|PCI_base
op_assign
(paren
r_int
r_int
op_star
)paren
l_int|0x80808010
suffix:semicolon
multiline_comment|/* Magic */
r_struct
id|screen
op_star
id|d
op_assign
op_amp
id|screen
suffix:semicolon
r_if
c_cond
(paren
op_star
id|PCI_base
)paren
(brace
multiline_comment|/* No CRT configured */
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|video_on
c_func
(paren
)paren
suffix:semicolon
id|d-&gt;cp
op_assign
id|Crtat
op_assign
(paren
id|u_short
op_star
)paren
op_amp
id|ISA_mem
(braket
l_int|0x0B8000
)braket
suffix:semicolon
id|addr_6845
op_assign
id|CGA_BASE
suffix:semicolon
id|initscreen
c_func
(paren
)paren
suffix:semicolon
id|fillw
c_func
(paren
id|pccolor
op_or
(paren
l_char|&squot; &squot;
op_lshift
l_int|8
)paren
comma
id|d-&gt;cp
comma
id|COL
op_star
id|ROW
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* Keyboard handler */
DECL|macro|L
mdefine_line|#define&t;L&t;&t;0x0001&t;/* locking function */
DECL|macro|SHF
mdefine_line|#define&t;SHF&t;&t;0x0002&t;/* keyboard shift */
DECL|macro|ALT
mdefine_line|#define&t;ALT&t;&t;0x0004&t;/* alternate shift -- alternate chars */
DECL|macro|NUM
mdefine_line|#define&t;NUM&t;&t;0x0008&t;/* numeric shift  cursors vs. numeric */
DECL|macro|CTL
mdefine_line|#define&t;CTL&t;&t;0x0010&t;/* control shift  -- allows ctl function */
DECL|macro|CPS
mdefine_line|#define&t;CPS&t;&t;0x0020&t;/* caps shift -- swaps case of letter */
DECL|macro|ASCII
mdefine_line|#define&t;ASCII&t;&t;0x0040&t;/* ascii code for this key */
DECL|macro|STP
mdefine_line|#define&t;STP&t;&t;0x0080&t;/* stop output */
DECL|macro|FUNC
mdefine_line|#define&t;FUNC&t;&t;0x0100&t;/* function key */
DECL|macro|SCROLL
mdefine_line|#define&t;SCROLL&t;&t;0x0200&t;/* scroll lock key */
multiline_comment|/* #include &quot;pcconstab.US&quot; */
multiline_comment|/*&t;BSDI $Id: pcconstab.US,v 1.1.1.1 1994/03/31 13:29:09 gary Exp $&t;*/
multiline_comment|/*-&n; * Copyright (c) 1990 The Regents of the University of California.&n; * All rights reserved.&n; *&n; * This code is derived from software contributed to Berkeley by&n; * William Jolitz and Don Ahn.&n; *&n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that the following conditions&n; * are met:&n; * 1. Redistributions of source code must retain the above copyright&n; *    notice, this list of conditions and the following disclaimer.&n; * 2. Redistributions in binary form must reproduce the above copyright&n; *    notice, this list of conditions and the following disclaimer in the&n; *    documentation and/or other materials provided with the distribution.&n; * 3. All advertising materials mentioning features or use of this software&n; *    must display the following acknowledgement:&n; *&t;This product includes software developed by the University of&n; *&t;California, Berkeley and its contributors.&n; * 4. Neither the name of the University nor the names of its contributors&n; *    may be used to endorse or promote products derived from this software&n; *    without specific prior written permission.&n; *&n; * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS&squot;&squot; AND&n; * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE&n; * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE&n; * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE&n; * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n; * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS&n; * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)&n; * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT&n; * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY&n; * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF&n; * SUCH DAMAGE.&n; *&n; *&t;from @(#)pccons.c&t;5.11 (Berkeley) 5/21/91&n; */
multiline_comment|/*&n; *&t;US Keyboard mapping tables&n; */
DECL|variable|action
r_const
r_int
r_int
id|action
(braket
)braket
op_assign
(brace
l_int|0
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
multiline_comment|/* scan  0- 7 */
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
multiline_comment|/* scan  8-15 */
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
multiline_comment|/* scan 16-23 */
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|CTL
comma
id|ASCII
comma
id|ASCII
comma
multiline_comment|/* scan 24-31 */
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
multiline_comment|/* scan 32-39 */
id|ASCII
comma
id|ASCII
comma
id|SHF
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
multiline_comment|/* scan 40-47 */
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|SHF
comma
id|ASCII
comma
multiline_comment|/* scan 48-55 */
id|ALT
comma
id|ASCII
comma
id|CPS
comma
id|FUNC
comma
id|FUNC
comma
id|FUNC
comma
id|FUNC
comma
id|FUNC
comma
multiline_comment|/* scan 56-63 */
id|FUNC
comma
id|FUNC
comma
id|FUNC
comma
id|FUNC
comma
id|FUNC
comma
id|NUM
comma
id|SCROLL
comma
id|ASCII
comma
multiline_comment|/* scan 64-71 */
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
multiline_comment|/* scan 72-79 */
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
id|ASCII
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* scan 80-87 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* scan 88-95 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* scan 96-103 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* scan 104-111 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* scan 112-119 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* scan 120-127 */
)brace
suffix:semicolon
DECL|variable|unshift
r_const
r_int
r_char
id|unshift
(braket
)braket
op_assign
(brace
multiline_comment|/* no shift */
l_int|0
comma
l_int|033
comma
l_char|&squot;1&squot;
comma
l_char|&squot;2&squot;
comma
l_char|&squot;3&squot;
comma
l_char|&squot;4&squot;
comma
l_char|&squot;5&squot;
comma
l_char|&squot;6&squot;
comma
multiline_comment|/* scan  0- 7 */
l_char|&squot;7&squot;
comma
l_char|&squot;8&squot;
comma
l_char|&squot;9&squot;
comma
l_char|&squot;0&squot;
comma
l_char|&squot;-&squot;
comma
l_char|&squot;=&squot;
comma
l_int|010
comma
l_char|&squot;&bslash;t&squot;
comma
multiline_comment|/* scan  8-15 */
l_char|&squot;q&squot;
comma
l_char|&squot;w&squot;
comma
l_char|&squot;e&squot;
comma
l_char|&squot;r&squot;
comma
l_char|&squot;t&squot;
comma
l_char|&squot;y&squot;
comma
l_char|&squot;u&squot;
comma
l_char|&squot;i&squot;
comma
multiline_comment|/* scan 16-23 */
l_char|&squot;o&squot;
comma
l_char|&squot;p&squot;
comma
l_char|&squot;[&squot;
comma
l_char|&squot;]&squot;
comma
l_char|&squot;&bslash;r&squot;
comma
id|CTL
comma
l_char|&squot;a&squot;
comma
l_char|&squot;s&squot;
comma
multiline_comment|/* scan 24-31 */
l_char|&squot;d&squot;
comma
l_char|&squot;f&squot;
comma
l_char|&squot;g&squot;
comma
l_char|&squot;h&squot;
comma
l_char|&squot;j&squot;
comma
l_char|&squot;k&squot;
comma
l_char|&squot;l&squot;
comma
l_char|&squot;;&squot;
comma
multiline_comment|/* scan 32-39 */
l_char|&squot;&bslash;&squot;&squot;
comma
l_char|&squot;`&squot;
comma
id|SHF
comma
l_char|&squot;&bslash;&bslash;&squot;
comma
l_char|&squot;z&squot;
comma
l_char|&squot;x&squot;
comma
l_char|&squot;c&squot;
comma
l_char|&squot;v&squot;
comma
multiline_comment|/* scan 40-47 */
l_char|&squot;b&squot;
comma
l_char|&squot;n&squot;
comma
l_char|&squot;m&squot;
comma
l_char|&squot;,&squot;
comma
l_char|&squot;.&squot;
comma
l_char|&squot;/&squot;
comma
id|SHF
comma
l_char|&squot;*&squot;
comma
multiline_comment|/* scan 48-55 */
id|ALT
comma
l_char|&squot; &squot;
comma
id|CPS
comma
l_int|1
comma
l_int|2
comma
l_int|3
comma
l_int|4
comma
l_int|5
comma
multiline_comment|/* scan 56-63 */
l_int|6
comma
l_int|7
comma
l_int|8
comma
l_int|9
comma
l_int|10
comma
id|NUM
comma
id|STP
comma
l_char|&squot;7&squot;
comma
multiline_comment|/* scan 64-71 */
l_char|&squot;8&squot;
comma
l_char|&squot;9&squot;
comma
l_char|&squot;-&squot;
comma
l_char|&squot;4&squot;
comma
l_char|&squot;5&squot;
comma
l_char|&squot;6&squot;
comma
l_char|&squot;+&squot;
comma
l_char|&squot;1&squot;
comma
multiline_comment|/* scan 72-79 */
l_char|&squot;2&squot;
comma
l_char|&squot;3&squot;
comma
l_char|&squot;0&squot;
comma
l_int|0177
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* scan 80-87 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* scan 88-95 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* scan 96-103 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* scan 104-111 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* scan 112-119 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* scan 120-127 */
)brace
suffix:semicolon
DECL|variable|shift
r_const
r_int
r_char
id|shift
(braket
)braket
op_assign
(brace
multiline_comment|/* shift shift */
l_int|0
comma
l_int|033
comma
l_char|&squot;!&squot;
comma
l_char|&squot;@&squot;
comma
l_char|&squot;#&squot;
comma
l_char|&squot;$&squot;
comma
l_char|&squot;%&squot;
comma
l_char|&squot;^&squot;
comma
multiline_comment|/* scan  0- 7 */
l_char|&squot;&amp;&squot;
comma
l_char|&squot;*&squot;
comma
l_char|&squot;(&squot;
comma
l_char|&squot;)&squot;
comma
l_char|&squot;_&squot;
comma
l_char|&squot;+&squot;
comma
l_int|010
comma
l_char|&squot;&bslash;t&squot;
comma
multiline_comment|/* scan  8-15 */
l_char|&squot;Q&squot;
comma
l_char|&squot;W&squot;
comma
l_char|&squot;E&squot;
comma
l_char|&squot;R&squot;
comma
l_char|&squot;T&squot;
comma
l_char|&squot;Y&squot;
comma
l_char|&squot;U&squot;
comma
l_char|&squot;I&squot;
comma
multiline_comment|/* scan 16-23 */
l_char|&squot;O&squot;
comma
l_char|&squot;P&squot;
comma
l_char|&squot;{&squot;
comma
l_char|&squot;}&squot;
comma
l_char|&squot;&bslash;r&squot;
comma
id|CTL
comma
l_char|&squot;A&squot;
comma
l_char|&squot;S&squot;
comma
multiline_comment|/* scan 24-31 */
l_char|&squot;D&squot;
comma
l_char|&squot;F&squot;
comma
l_char|&squot;G&squot;
comma
l_char|&squot;H&squot;
comma
l_char|&squot;J&squot;
comma
l_char|&squot;K&squot;
comma
l_char|&squot;L&squot;
comma
l_char|&squot;:&squot;
comma
multiline_comment|/* scan 32-39 */
l_char|&squot;&quot;&squot;
comma
l_char|&squot;~&squot;
comma
id|SHF
comma
l_char|&squot;|&squot;
comma
l_char|&squot;Z&squot;
comma
l_char|&squot;X&squot;
comma
l_char|&squot;C&squot;
comma
l_char|&squot;V&squot;
comma
multiline_comment|/* scan 40-47 */
l_char|&squot;B&squot;
comma
l_char|&squot;N&squot;
comma
l_char|&squot;M&squot;
comma
l_char|&squot;&lt;&squot;
comma
l_char|&squot;&gt;&squot;
comma
l_char|&squot;?&squot;
comma
id|SHF
comma
l_char|&squot;*&squot;
comma
multiline_comment|/* scan 48-55 */
id|ALT
comma
l_char|&squot; &squot;
comma
id|CPS
comma
l_int|0
comma
l_int|0
comma
l_char|&squot; &squot;
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* scan 56-63 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|NUM
comma
id|STP
comma
l_char|&squot;7&squot;
comma
multiline_comment|/* scan 64-71 */
l_char|&squot;8&squot;
comma
l_char|&squot;9&squot;
comma
l_char|&squot;-&squot;
comma
l_char|&squot;4&squot;
comma
l_char|&squot;5&squot;
comma
l_char|&squot;6&squot;
comma
l_char|&squot;+&squot;
comma
l_char|&squot;1&squot;
comma
multiline_comment|/* scan 72-79 */
l_char|&squot;2&squot;
comma
l_char|&squot;3&squot;
comma
l_char|&squot;0&squot;
comma
l_int|0177
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* scan 80-87 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* scan 88-95 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* scan 96-103 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* scan 104-111 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* scan 112-119 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* scan 120-127 */
)brace
suffix:semicolon
DECL|variable|ctl
r_const
r_int
r_char
id|ctl
(braket
)braket
op_assign
(brace
multiline_comment|/* CTL shift */
l_int|0
comma
l_int|033
comma
l_char|&squot;!&squot;
comma
l_int|000
comma
l_char|&squot;#&squot;
comma
l_char|&squot;$&squot;
comma
l_char|&squot;%&squot;
comma
l_int|036
comma
multiline_comment|/* scan  0- 7 */
l_char|&squot;&amp;&squot;
comma
l_char|&squot;*&squot;
comma
l_char|&squot;(&squot;
comma
l_char|&squot;)&squot;
comma
l_int|037
comma
l_char|&squot;+&squot;
comma
l_int|034
comma
l_char|&squot;&bslash;177&squot;
comma
multiline_comment|/* scan  8-15 */
l_int|021
comma
l_int|027
comma
l_int|005
comma
l_int|022
comma
l_int|024
comma
l_int|031
comma
l_int|025
comma
l_int|011
comma
multiline_comment|/* scan 16-23 */
l_int|017
comma
l_int|020
comma
l_int|033
comma
l_int|035
comma
l_char|&squot;&bslash;r&squot;
comma
id|CTL
comma
l_int|001
comma
l_int|023
comma
multiline_comment|/* scan 24-31 */
l_int|004
comma
l_int|006
comma
l_int|007
comma
l_int|010
comma
l_int|012
comma
l_int|013
comma
l_int|014
comma
l_char|&squot;;&squot;
comma
multiline_comment|/* scan 32-39 */
l_char|&squot;&bslash;&squot;&squot;
comma
l_char|&squot;`&squot;
comma
id|SHF
comma
l_int|034
comma
l_int|032
comma
l_int|030
comma
l_int|003
comma
l_int|026
comma
multiline_comment|/* scan 40-47 */
l_int|002
comma
l_int|016
comma
l_int|015
comma
l_char|&squot;&lt;&squot;
comma
l_char|&squot;&gt;&squot;
comma
l_char|&squot;?&squot;
comma
id|SHF
comma
l_char|&squot;*&squot;
comma
multiline_comment|/* scan 48-55 */
id|ALT
comma
l_char|&squot; &squot;
comma
id|CPS
comma
l_int|0
comma
l_int|0
comma
l_char|&squot; &squot;
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* scan 56-63 */
id|CPS
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* scan 64-71 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* scan 72-79 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0177
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* scan 80-87 */
l_int|0
comma
l_int|0
comma
l_int|033
comma
l_char|&squot;7&squot;
comma
l_char|&squot;4&squot;
comma
l_char|&squot;1&squot;
comma
l_int|0
comma
id|NUM
comma
multiline_comment|/* scan 88-95 */
l_char|&squot;8&squot;
comma
l_char|&squot;5&squot;
comma
l_char|&squot;2&squot;
comma
l_int|0
comma
id|STP
comma
l_char|&squot;9&squot;
comma
l_char|&squot;6&squot;
comma
l_char|&squot;3&squot;
comma
multiline_comment|/* scan 96-103*/
l_char|&squot;.&squot;
comma
l_int|0
comma
l_char|&squot;*&squot;
comma
l_char|&squot;-&squot;
comma
l_char|&squot;+&squot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/*scan 104-111*/
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* scan 112-119 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* scan 120-127 */
)brace
suffix:semicolon
DECL|variable|shfts
DECL|variable|ctls
DECL|variable|alts
DECL|variable|caps
DECL|variable|num
DECL|variable|stp
r_int
r_char
id|shfts
comma
id|ctls
comma
id|alts
comma
id|caps
comma
id|num
comma
id|stp
suffix:semicolon
DECL|macro|KBDATAP
mdefine_line|#define&t;KBDATAP&t;&t;0x60&t;/* kbd data port */
DECL|macro|KBSTATUSPORT
mdefine_line|#define&t;KBSTATUSPORT&t;0x61&t;/* kbd status */
DECL|macro|KBSTATP
mdefine_line|#define&t;KBSTATP&t;&t;0x64&t;/* kbd status port */
DECL|macro|KBINRDY
mdefine_line|#define&t;KBINRDY&t;&t;0x01
DECL|macro|KBOUTRDY
mdefine_line|#define&t;KBOUTRDY&t;0x02
DECL|macro|_x__
mdefine_line|#define _x__ 0x00  /* Unknown / unmapped */
DECL|variable|keycode
r_const
r_int
r_char
id|keycode
(braket
)braket
op_assign
(brace
id|_x__
comma
l_int|0x43
comma
l_int|0x41
comma
l_int|0x3F
comma
l_int|0x3D
comma
l_int|0x3B
comma
l_int|0x3C
comma
id|_x__
comma
multiline_comment|/* 0x00-0x07 */
id|_x__
comma
l_int|0x44
comma
l_int|0x42
comma
l_int|0x40
comma
l_int|0x3E
comma
l_int|0x0F
comma
l_int|0x29
comma
id|_x__
comma
multiline_comment|/* 0x08-0x0F */
id|_x__
comma
l_int|0x38
comma
l_int|0x2A
comma
id|_x__
comma
l_int|0x1D
comma
l_int|0x10
comma
l_int|0x02
comma
id|_x__
comma
multiline_comment|/* 0x10-0x17 */
id|_x__
comma
id|_x__
comma
l_int|0x2C
comma
l_int|0x1F
comma
l_int|0x1E
comma
l_int|0x11
comma
l_int|0x03
comma
id|_x__
comma
multiline_comment|/* 0x18-0x1F */
id|_x__
comma
l_int|0x2E
comma
l_int|0x2D
comma
l_int|0x20
comma
l_int|0x12
comma
l_int|0x05
comma
l_int|0x04
comma
id|_x__
comma
multiline_comment|/* 0x20-0x27 */
id|_x__
comma
l_int|0x39
comma
l_int|0x2F
comma
l_int|0x21
comma
l_int|0x14
comma
l_int|0x13
comma
l_int|0x06
comma
id|_x__
comma
multiline_comment|/* 0x28-0x2F */
id|_x__
comma
l_int|0x31
comma
l_int|0x30
comma
l_int|0x23
comma
l_int|0x22
comma
l_int|0x15
comma
l_int|0x07
comma
id|_x__
comma
multiline_comment|/* 0x30-0x37 */
id|_x__
comma
id|_x__
comma
l_int|0x32
comma
l_int|0x24
comma
l_int|0x16
comma
l_int|0x08
comma
l_int|0x09
comma
id|_x__
comma
multiline_comment|/* 0x38-0x3F */
id|_x__
comma
l_int|0x33
comma
l_int|0x25
comma
l_int|0x17
comma
l_int|0x18
comma
l_int|0x0B
comma
l_int|0x0A
comma
id|_x__
comma
multiline_comment|/* 0x40-0x47 */
id|_x__
comma
l_int|0x34
comma
l_int|0x35
comma
l_int|0x26
comma
l_int|0x27
comma
l_int|0x19
comma
l_int|0x0C
comma
id|_x__
comma
multiline_comment|/* 0x48-0x4F */
id|_x__
comma
id|_x__
comma
l_int|0x28
comma
id|_x__
comma
l_int|0x1A
comma
l_int|0x0D
comma
id|_x__
comma
id|_x__
comma
multiline_comment|/* 0x50-0x57 */
l_int|0x3A
comma
l_int|0x36
comma
l_int|0x1C
comma
l_int|0x1B
comma
id|_x__
comma
l_int|0x2B
comma
id|_x__
comma
id|_x__
comma
multiline_comment|/* 0x58-0x5F */
id|_x__
comma
id|_x__
comma
id|_x__
comma
id|_x__
comma
id|_x__
comma
id|_x__
comma
l_int|0x0E
comma
id|_x__
comma
multiline_comment|/* 0x60-0x67 */
id|_x__
comma
l_int|0x4F
comma
id|_x__
comma
l_int|0x4B
comma
l_int|0x47
comma
id|_x__
comma
id|_x__
comma
id|_x__
comma
multiline_comment|/* 0x68-0x6F */
l_int|0x52
comma
l_int|0x53
comma
l_int|0x50
comma
l_int|0x4C
comma
l_int|0x4D
comma
l_int|0x48
comma
l_int|0x01
comma
l_int|0x45
comma
multiline_comment|/* 0x70-0x77 */
id|_x__
comma
l_int|0x4E
comma
l_int|0x51
comma
l_int|0x4A
comma
id|_x__
comma
l_int|0x49
comma
l_int|0x46
comma
l_int|0x54
comma
multiline_comment|/* 0x78-0x7F */
)brace
suffix:semicolon
DECL|function|kbd
r_int
id|kbd
c_func
(paren
r_int
id|noblock
)paren
(brace
r_int
r_char
id|dt
comma
id|brk
comma
id|act
suffix:semicolon
r_int
id|first
op_assign
l_int|1
suffix:semicolon
id|loop
suffix:colon
r_if
c_cond
(paren
id|noblock
)paren
(brace
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|KBSTATP
)paren
op_amp
id|KBINRDY
)paren
op_eq
l_int|0
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_else
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|KBSTATP
)paren
op_amp
id|KBINRDY
)paren
op_eq
l_int|0
)paren
(brace
suffix:semicolon
)brace
id|dt
op_assign
id|inb
c_func
(paren
id|KBDATAP
)paren
suffix:semicolon
id|brk
op_assign
id|dt
op_amp
l_int|0x80
suffix:semicolon
multiline_comment|/* brk == 1 on key release */
id|dt
op_assign
id|dt
op_amp
l_int|0x7f
suffix:semicolon
multiline_comment|/* keycode */
id|act
op_assign
id|action
(braket
id|dt
)braket
suffix:semicolon
r_if
c_cond
(paren
id|act
op_amp
id|SHF
)paren
id|shfts
op_assign
id|brk
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|act
op_amp
id|ALT
)paren
id|alts
op_assign
id|brk
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|act
op_amp
id|NUM
)paren
r_if
c_cond
(paren
id|act
op_amp
id|L
)paren
(brace
multiline_comment|/* NUM lock */
r_if
c_cond
(paren
op_logical_neg
id|brk
)paren
(brace
id|num
op_assign
op_logical_neg
id|num
suffix:semicolon
)brace
)brace
r_else
id|num
op_assign
id|brk
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|act
op_amp
id|CTL
)paren
id|ctls
op_assign
id|brk
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|act
op_amp
id|CPS
)paren
r_if
c_cond
(paren
id|act
op_amp
id|L
)paren
(brace
multiline_comment|/* CAPS lock */
r_if
c_cond
(paren
op_logical_neg
id|brk
)paren
(brace
id|caps
op_assign
op_logical_neg
id|caps
suffix:semicolon
)brace
)brace
r_else
id|caps
op_assign
id|brk
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|act
op_amp
id|STP
)paren
r_if
c_cond
(paren
id|act
op_amp
id|L
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|brk
)paren
(brace
id|stp
op_assign
op_logical_neg
id|stp
suffix:semicolon
)brace
)brace
r_else
id|stp
op_assign
id|brk
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|act
op_amp
id|ASCII
)paren
op_logical_and
op_logical_neg
id|brk
)paren
(brace
r_int
r_char
id|chr
suffix:semicolon
r_if
c_cond
(paren
id|shfts
)paren
id|chr
op_assign
id|shift
(braket
id|dt
)braket
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ctls
)paren
id|chr
op_assign
id|ctl
(braket
id|dt
)braket
suffix:semicolon
r_else
id|chr
op_assign
id|unshift
(braket
id|dt
)braket
suffix:semicolon
r_if
c_cond
(paren
id|alts
)paren
id|chr
op_or_assign
l_int|0x80
suffix:semicolon
r_if
c_cond
(paren
id|caps
op_logical_and
(paren
id|chr
op_ge
l_char|&squot;a&squot;
op_logical_and
id|chr
op_le
l_char|&squot;z&squot;
)paren
)paren
id|chr
op_sub_assign
l_char|&squot;a&squot;
op_minus
l_char|&squot;A&squot;
suffix:semicolon
DECL|macro|CTRL
mdefine_line|#define CTRL(s) (s &amp; 0x1F)&t;&t;&t;
r_if
c_cond
(paren
(paren
id|chr
op_eq
l_char|&squot;&bslash;r&squot;
)paren
op_logical_or
(paren
id|chr
op_eq
l_char|&squot;&bslash;n&squot;
)paren
op_logical_or
(paren
id|chr
op_eq
id|CTRL
c_func
(paren
l_char|&squot;A&squot;
)paren
)paren
op_logical_or
(paren
id|chr
op_eq
id|CTRL
c_func
(paren
l_char|&squot;S&squot;
)paren
)paren
)paren
(brace
multiline_comment|/* Wait for key up */
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|KBSTATP
)paren
op_amp
id|KBINRDY
)paren
op_eq
l_int|0
)paren
(brace
suffix:semicolon
)brace
id|dt
op_assign
id|inb
c_func
(paren
id|KBDATAP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dt
op_amp
l_int|0x80
)paren
multiline_comment|/* key up */
r_break
suffix:semicolon
)brace
)brace
r_return
(paren
id|chr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|first
op_logical_and
id|brk
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Ignore initial &squot;key up&squot; codes */
r_goto
id|loop
suffix:semicolon
)brace
DECL|function|scankbd
r_int
id|scankbd
c_func
(paren
r_void
)paren
(brace
r_return
(paren
id|kbd
c_func
(paren
l_int|1
)paren
op_ne
op_minus
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|kbdreset
r_void
id|kbdreset
c_func
(paren
r_void
)paren
(brace
r_int
r_char
id|c
suffix:semicolon
multiline_comment|/* Enable interrupts and keyboard controller */
r_while
c_loop
(paren
id|inb
c_func
(paren
id|KBSTATP
)paren
op_amp
id|KBOUTRDY
)paren
suffix:semicolon
id|outb
c_func
(paren
id|KBSTATP
comma
l_int|0x60
)paren
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|KBSTATP
)paren
op_amp
id|KBOUTRDY
)paren
suffix:semicolon
id|outb
c_func
(paren
id|KBDATAP
comma
l_int|0x4D
)paren
suffix:semicolon
multiline_comment|/* Start keyboard stuff RESET */
r_while
c_loop
(paren
id|inb
c_func
(paren
id|KBSTATP
)paren
op_amp
id|KBOUTRDY
)paren
suffix:semicolon
multiline_comment|/* wait input ready */
id|outb
c_func
(paren
id|KBDATAP
comma
l_int|0xFF
)paren
suffix:semicolon
multiline_comment|/* RESET */
r_while
c_loop
(paren
(paren
id|c
op_assign
id|inb
c_func
(paren
id|KBDATAP
)paren
)paren
op_ne
l_int|0xFA
)paren
suffix:semicolon
)brace
DECL|function|CRT_getc
r_int
id|CRT_getc
c_func
(paren
r_void
)paren
(brace
r_int
id|c
suffix:semicolon
r_while
c_loop
(paren
(paren
id|c
op_assign
id|kbd
c_func
(paren
l_int|0
)paren
)paren
op_eq
l_int|0
)paren
suffix:semicolon
r_return
id|c
suffix:semicolon
)brace
DECL|function|CRT_test
r_int
id|CRT_test
c_func
(paren
r_void
)paren
(brace
r_return
(paren
(paren
id|inb
c_func
(paren
id|KBSTATP
)paren
op_amp
id|KBINRDY
)paren
op_ne
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|_dump_buf_with_offset
id|_dump_buf_with_offset
c_func
(paren
r_int
r_char
op_star
id|p
comma
r_int
id|s
comma
r_int
r_char
op_star
id|base
)paren
(brace
r_int
id|i
comma
id|c
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|s
OG
(paren
r_int
r_int
)paren
id|p
)paren
(brace
id|s
op_assign
(paren
r_int
r_int
)paren
id|s
op_minus
(paren
r_int
r_int
)paren
id|p
suffix:semicolon
)brace
r_while
c_loop
(paren
id|s
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|base
)paren
(brace
id|_printk
c_func
(paren
l_string|&quot;%06X: &quot;
comma
(paren
r_int
)paren
id|p
op_minus
(paren
r_int
)paren
id|base
)paren
suffix:semicolon
)brace
r_else
(brace
id|_printk
c_func
(paren
l_string|&quot;%06X: &quot;
comma
id|p
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OL
id|s
)paren
(brace
id|_printk
c_func
(paren
l_string|&quot;%02X&quot;
comma
id|p
(braket
id|i
)braket
op_amp
l_int|0xFF
)paren
suffix:semicolon
)brace
r_else
(brace
id|_printk
c_func
(paren
l_string|&quot;  &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|i
op_mod
l_int|2
)paren
op_eq
l_int|1
)paren
id|_printk
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_mod
l_int|8
)paren
op_eq
l_int|7
)paren
id|_printk
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
)brace
id|_printk
c_func
(paren
l_string|&quot; |&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OL
id|s
)paren
(brace
id|c
op_assign
id|p
(braket
id|i
)braket
op_amp
l_int|0xFF
suffix:semicolon
r_if
c_cond
(paren
(paren
id|c
OL
l_int|0x20
)paren
op_logical_or
(paren
id|c
op_ge
l_int|0x7F
)paren
)paren
id|c
op_assign
l_char|&squot;.&squot;
suffix:semicolon
)brace
r_else
(brace
id|c
op_assign
l_char|&squot; &squot;
suffix:semicolon
)brace
id|_printk
c_func
(paren
l_string|&quot;%c&quot;
comma
id|c
)paren
suffix:semicolon
)brace
id|_printk
c_func
(paren
l_string|&quot;|&bslash;n&quot;
)paren
suffix:semicolon
id|s
op_sub_assign
l_int|16
suffix:semicolon
id|p
op_add_assign
l_int|16
suffix:semicolon
)brace
)brace
DECL|function|_dump_buf
id|_dump_buf
c_func
(paren
r_int
r_char
op_star
id|p
comma
r_int
id|s
)paren
(brace
id|_dump_buf_with_offset
c_func
(paren
id|p
comma
id|s
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|dump_buf_with_offset
id|dump_buf_with_offset
c_func
(paren
r_int
r_char
op_star
id|p
comma
r_int
id|s
comma
r_int
r_char
op_star
id|base
)paren
(brace
r_int
id|i
comma
id|c
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|s
OG
(paren
r_int
r_int
)paren
id|p
)paren
(brace
id|s
op_assign
(paren
r_int
r_int
)paren
id|s
op_minus
(paren
r_int
r_int
)paren
id|p
suffix:semicolon
)brace
r_while
c_loop
(paren
id|s
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|base
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%06X: &quot;
comma
(paren
r_int
)paren
id|p
op_minus
(paren
r_int
)paren
id|base
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;%06X: &quot;
comma
id|p
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OL
id|s
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%02X&quot;
comma
id|p
(braket
id|i
)braket
op_amp
l_int|0xFF
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;  &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|i
op_mod
l_int|2
)paren
op_eq
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_mod
l_int|8
)paren
op_eq
l_int|7
)paren
id|printk
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot; |&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OL
id|s
)paren
(brace
id|c
op_assign
id|p
(braket
id|i
)braket
op_amp
l_int|0xFF
suffix:semicolon
r_if
c_cond
(paren
(paren
id|c
OL
l_int|0x20
)paren
op_logical_or
(paren
id|c
op_ge
l_int|0x7F
)paren
)paren
id|c
op_assign
l_char|&squot;.&squot;
suffix:semicolon
)brace
r_else
(brace
id|c
op_assign
l_char|&squot; &squot;
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%c&quot;
comma
id|c
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;|&bslash;n&quot;
)paren
suffix:semicolon
id|s
op_sub_assign
l_int|16
suffix:semicolon
id|p
op_add_assign
l_int|16
suffix:semicolon
)brace
)brace
DECL|function|dump_buf
id|dump_buf
c_func
(paren
r_int
r_char
op_star
id|p
comma
r_int
id|s
)paren
(brace
id|dump_buf_with_offset
c_func
(paren
id|p
comma
id|s
comma
l_int|0
)paren
suffix:semicolon
)brace
eof
