multiline_comment|/*&n; *  arch/ppc/kernel/feature.c&n; *&n; *  Copyright (C) 1996 Paul Mackerras (paulus@cs.anu.edu.au)&n; *&n; *  This program is free software; you can redistribute it and/or&n; *  modify it under the terms of the GNU General Public License&n; *  as published by the Free Software Foundation; either version&n; *  2 of the License, or (at your option) any later version.&n; *&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/errno.h&gt;
macro_line|#include &lt;asm/ohare.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/feature.h&gt;
DECL|macro|MAX_FEATURE_REGS
mdefine_line|#define MAX_FEATURE_REGS&t;&t;2
DECL|macro|DEBUG_FEATURE
macro_line|#undef DEBUG_FEATURE
DECL|variable|feature_bits_pbook
r_static
id|u32
id|feature_bits_pbook
(braket
)braket
op_assign
(brace
l_int|0
comma
multiline_comment|/* FEATURE_null */
id|OH_SCC_RESET
comma
multiline_comment|/* FEATURE_Serial_reset */
id|OH_SCC_ENABLE
comma
multiline_comment|/* FEATURE_Serial_enable */
id|OH_SCCA_IO
comma
multiline_comment|/* FEATURE_Serial_IO_A */
id|OH_SCCB_IO
comma
multiline_comment|/* FEATURE_Serial_IO_B */
id|OH_FLOPPY_ENABLE
comma
multiline_comment|/* FEATURE_SWIM3_enable */
id|OH_MESH_ENABLE
comma
multiline_comment|/* FEATURE_MESH_enable */
id|OH_IDE_ENABLE
comma
multiline_comment|/* FEATURE_IDE_enable */
id|OH_VIA_ENABLE
comma
multiline_comment|/* FEATURE_VIA_enable */
id|OH_IDECD_POWER
comma
multiline_comment|/* FEATURE_CD_power */
id|OH_BAY_RESET
comma
multiline_comment|/* FEATURE_Mediabay_reset */
id|OH_BAY_ENABLE
comma
multiline_comment|/* FEATURE_Mediabay_enable */
id|OH_BAY_PCI_ENABLE
comma
multiline_comment|/* FEATURE_Mediabay_PCI_enable */
id|OH_BAY_IDE_ENABLE
comma
multiline_comment|/* FEATURE_Mediabay_IDE_enable */
id|OH_BAY_FLOPPY_ENABLE
comma
multiline_comment|/* FEATURE_Mediabay_floppy_enable */
l_int|0
comma
multiline_comment|/* FEATURE_BMac_reset */
l_int|0
comma
multiline_comment|/* FEATURE_BMac_IO_enable */
l_int|0
comma
multiline_comment|/* FEATURE_Modem_PowerOn -&gt; guess...*/
l_int|0
multiline_comment|/* FEATURE_Modem_Reset -&gt; guess...*/
)brace
suffix:semicolon
multiline_comment|/* assume these are the same as the ohare until proven otherwise */
DECL|variable|feature_bits_heathrow
r_static
id|u32
id|feature_bits_heathrow
(braket
)braket
op_assign
(brace
l_int|0
comma
multiline_comment|/* FEATURE_null */
id|OH_SCC_RESET
comma
multiline_comment|/* FEATURE_Serial_reset */
id|OH_SCC_ENABLE
comma
multiline_comment|/* FEATURE_Serial_enable */
id|OH_SCCA_IO
comma
multiline_comment|/* FEATURE_Serial_IO_A */
id|OH_SCCB_IO
comma
multiline_comment|/* FEATURE_Serial_IO_B */
id|OH_FLOPPY_ENABLE
comma
multiline_comment|/* FEATURE_SWIM3_enable */
id|OH_MESH_ENABLE
comma
multiline_comment|/* FEATURE_MESH_enable */
id|OH_IDE_ENABLE
comma
multiline_comment|/* FEATURE_IDE_enable */
id|OH_VIA_ENABLE
comma
multiline_comment|/* FEATURE_VIA_enable */
id|OH_IDECD_POWER
comma
multiline_comment|/* FEATURE_CD_power */
id|OH_BAY_RESET
comma
multiline_comment|/* FEATURE_Mediabay_reset */
id|OH_BAY_ENABLE
comma
multiline_comment|/* FEATURE_Mediabay_enable */
id|OH_BAY_PCI_ENABLE
comma
multiline_comment|/* FEATURE_Mediabay_PCI_enable */
id|OH_BAY_IDE_ENABLE
comma
multiline_comment|/* FEATURE_Mediabay_IDE_enable */
id|OH_BAY_FLOPPY_ENABLE
comma
multiline_comment|/* FEATURE_Mediabay_floppy_enable */
l_int|0x80000000
comma
multiline_comment|/* FEATURE_BMac_reset */
l_int|0x60000000
comma
multiline_comment|/* FEATURE_BMac_IO_enable */
l_int|0x02000000
comma
multiline_comment|/* FEATURE_Modem_PowerOn -&gt; guess...*/
l_int|0x07000000
multiline_comment|/* FEATURE_Modem_Reset -&gt; guess...*/
)brace
suffix:semicolon
multiline_comment|/* definition of a feature controller object */
DECL|struct|feature_controller
r_struct
id|feature_controller
(brace
DECL|member|bits
id|u32
op_star
id|bits
suffix:semicolon
DECL|member|reg
r_volatile
id|u32
op_star
id|reg
suffix:semicolon
DECL|member|device
r_struct
id|device_node
op_star
id|device
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* static functions */
r_static
r_void
id|feature_add_controller
c_func
(paren
r_struct
id|device_node
op_star
id|controller_device
comma
id|u32
op_star
id|bits
)paren
suffix:semicolon
r_static
r_int
id|feature_lookup_controller
c_func
(paren
r_struct
id|device_node
op_star
id|device
)paren
suffix:semicolon
multiline_comment|/* static varialbles */
DECL|variable|controllers
r_static
r_struct
id|feature_controller
id|controllers
(braket
id|MAX_FEATURE_REGS
)braket
suffix:semicolon
DECL|variable|controller_count
r_static
r_int
id|controller_count
op_assign
l_int|0
suffix:semicolon
r_void
DECL|function|feature_init
id|feature_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|np
suffix:semicolon
id|np
op_assign
id|find_devices
c_func
(paren
l_string|&quot;mac-io&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|np
op_ne
l_int|NULL
)paren
(brace
id|feature_add_controller
c_func
(paren
id|np
comma
id|feature_bits_heathrow
)paren
suffix:semicolon
id|np
op_assign
id|np-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
id|controller_count
op_eq
l_int|0
)paren
(brace
id|np
op_assign
id|find_devices
c_func
(paren
l_string|&quot;ohare&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|np
)paren
(brace
r_if
c_cond
(paren
id|find_devices
c_func
(paren
l_string|&quot;via-pmu&quot;
)paren
op_ne
l_int|NULL
)paren
id|feature_add_controller
c_func
(paren
id|np
comma
id|feature_bits_pbook
)paren
suffix:semicolon
r_else
multiline_comment|/* else not sure; maybe this is a Starmax? */
id|feature_add_controller
c_func
(paren
id|np
comma
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|controller_count
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Registered %d feature controller(s)&bslash;n&quot;
comma
id|controller_count
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|feature_add_controller
id|feature_add_controller
c_func
(paren
r_struct
id|device_node
op_star
id|controller_device
comma
id|u32
op_star
id|bits
)paren
(brace
r_struct
id|feature_controller
op_star
id|controller
suffix:semicolon
r_if
c_cond
(paren
id|controller_count
op_ge
id|MAX_FEATURE_REGS
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Feature controller %s skipped(MAX:%d)&bslash;n&quot;
comma
id|controller_device-&gt;full_name
comma
id|MAX_FEATURE_REGS
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|controller
op_assign
op_amp
id|controllers
(braket
id|controller_count
)braket
suffix:semicolon
id|controller-&gt;bits
op_assign
id|bits
suffix:semicolon
id|controller-&gt;device
op_assign
id|controller_device
suffix:semicolon
r_if
c_cond
(paren
id|controller_device-&gt;n_addrs
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;No addresses for %s&bslash;n&quot;
comma
id|controller_device-&gt;full_name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|controller-&gt;reg
op_assign
(paren
r_volatile
id|u32
op_star
)paren
id|ioremap
c_func
(paren
id|controller_device-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
op_plus
id|OHARE_FEATURE_REG
comma
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Twiddling the magic ohare bits&bslash;n&quot;
)paren
suffix:semicolon
id|out_le32
c_func
(paren
id|controller-&gt;reg
comma
id|STARMAX_FEATURES
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|controller_count
op_increment
suffix:semicolon
)brace
r_static
r_int
DECL|function|feature_lookup_controller
id|feature_lookup_controller
c_func
(paren
r_struct
id|device_node
op_star
id|device
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|device
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_while
c_loop
(paren
id|device
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|controller_count
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|device
op_eq
id|controllers
(braket
id|i
)braket
dot
id|device
)paren
r_return
id|i
suffix:semicolon
id|device
op_assign
id|device-&gt;parent
suffix:semicolon
)brace
macro_line|#ifdef DEBUG_FEATURE
id|printk
c_func
(paren
l_string|&quot;feature: &lt;%s&gt; not found on any controller&bslash;n&quot;
comma
id|device-&gt;name
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_int
DECL|function|feature_set
id|feature_set
c_func
(paren
r_struct
id|device_node
op_star
id|device
comma
r_enum
id|system_feature
id|f
)paren
(brace
r_int
id|controller
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|f
op_ge
id|FEATURE_last
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|controller
op_assign
id|feature_lookup_controller
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|controller
OL
l_int|0
)paren
r_return
id|controller
suffix:semicolon
macro_line|#ifdef DEBUG_FEATURE
id|printk
c_func
(paren
l_string|&quot;feature: &lt;%s&gt; setting feature %d in controller @0x%x&bslash;n&quot;
comma
id|device-&gt;name
comma
(paren
r_int
)paren
id|f
comma
(paren
r_int
r_int
)paren
id|controllers
(braket
id|controller
)braket
dot
id|reg
)paren
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|st_le32
c_func
(paren
id|controllers
(braket
id|controller
)braket
dot
id|reg
comma
id|ld_le32
c_func
(paren
id|controllers
(braket
id|controller
)braket
dot
id|reg
)paren
op_or
id|controllers
(braket
id|controller
)braket
dot
id|bits
(braket
id|f
)braket
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|feature_clear
id|feature_clear
c_func
(paren
r_struct
id|device_node
op_star
id|device
comma
r_enum
id|system_feature
id|f
)paren
(brace
r_int
id|controller
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|f
op_ge
id|FEATURE_last
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|controller
op_assign
id|feature_lookup_controller
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|controller
OL
l_int|0
)paren
r_return
id|controller
suffix:semicolon
macro_line|#ifdef DEBUG_FEATURE
id|printk
c_func
(paren
l_string|&quot;feature: &lt;%s&gt; clearing feature %d in controller @0x%x&bslash;n&quot;
comma
id|device-&gt;name
comma
(paren
r_int
)paren
id|f
comma
(paren
r_int
r_int
)paren
id|controllers
(braket
id|controller
)braket
dot
id|reg
)paren
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|st_le32
c_func
(paren
id|controllers
(braket
id|controller
)braket
dot
id|reg
comma
id|ld_le32
c_func
(paren
id|controllers
(braket
id|controller
)braket
dot
id|reg
)paren
op_amp
op_complement
(paren
id|controllers
(braket
id|controller
)braket
dot
id|bits
(braket
id|f
)braket
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|feature_test
id|feature_test
c_func
(paren
r_struct
id|device_node
op_star
id|device
comma
r_enum
id|system_feature
id|f
)paren
(brace
r_int
id|controller
suffix:semicolon
r_if
c_cond
(paren
id|f
op_ge
id|FEATURE_last
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|controller
op_assign
id|feature_lookup_controller
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|controller
OL
l_int|0
)paren
r_return
id|controller
suffix:semicolon
r_return
(paren
id|ld_le32
c_func
(paren
id|controllers
(braket
id|controller
)braket
dot
id|reg
)paren
op_amp
id|controllers
(braket
id|controller
)braket
dot
id|bits
(braket
id|f
)braket
)paren
op_ne
l_int|0
suffix:semicolon
)brace
eof
