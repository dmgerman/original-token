multiline_comment|/*&n; *  arch/ppc/kernel/feature.c&n; *&n; *  Copyright (C) 1996 Paul Mackerras (paulus@cs.anu.edu.au)&n; *                     Ben. Herrenschmidt (bh40@calva.net)&n; *&n; *  This program is free software; you can redistribute it and/or&n; *  modify it under the terms of the GNU General Public License&n; *  as published by the Free Software Foundation; either version&n; *  2 of the License, or (at your option) any later version.&n; *&n; *  BenH: Changed implementation to work on multiple registers&n; * &t;  polarity is also taken into account. Removed delay (now&n; * &t;  responsibility of the caller). Added spinlocks.&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/errno.h&gt;
macro_line|#include &lt;asm/ohare.h&gt;
macro_line|#include &lt;asm/heathrow.h&gt;
macro_line|#include &lt;asm/keylargo.h&gt;
macro_line|#include &lt;asm/uninorth.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/feature.h&gt;
DECL|macro|DEBUG_FEATURE
macro_line|#undef DEBUG_FEATURE
DECL|macro|MAX_FEATURE_CONTROLLERS
mdefine_line|#define MAX_FEATURE_CONTROLLERS&t;&t;2
DECL|macro|MAX_FEATURE_OFFSET
mdefine_line|#define MAX_FEATURE_OFFSET&t;&t;0x100
DECL|macro|FREG
mdefine_line|#define FREG(c,r)&t;&t;&t;(&amp;(((c)-&gt;reg)[(r)&gt;&gt;2]))
multiline_comment|/* Keylargo reg. access. */
DECL|macro|KL_FCR
mdefine_line|#define KL_FCR(r)&t;(keylargo_base + ((r) &gt;&gt; 2))
DECL|macro|KL_IN
mdefine_line|#define KL_IN(r)&t;(in_le32(KL_FCR(r)))
DECL|macro|KL_OUT
mdefine_line|#define KL_OUT(r,v)&t;(out_le32(KL_FCR(r), (v)))
DECL|macro|KL_BIS
mdefine_line|#define KL_BIS(r,v)&t;(KL_OUT((r), KL_IN(r) | (v)))
DECL|macro|KL_BIC
mdefine_line|#define KL_BIC(r,v)&t;(KL_OUT((r), KL_IN(r) &amp; ~(v)))
multiline_comment|/* Uni-N reg. access. Note that Uni-N regs are big endian */
DECL|macro|UN_REG
mdefine_line|#define UN_REG(r)&t;(uninorth_base + ((r) &gt;&gt; 2))
DECL|macro|UN_IN
mdefine_line|#define UN_IN(r)&t;(in_be32(UN_REG(r)))
DECL|macro|UN_OUT
mdefine_line|#define UN_OUT(r,v)&t;(out_be32(UN_REG(r), (v)))
DECL|macro|UN_BIS
mdefine_line|#define UN_BIS(r,v)&t;(UN_OUT((r), UN_IN(r) | (v)))
DECL|macro|UN_BIC
mdefine_line|#define UN_BIC(r,v)&t;(UN_OUT((r), UN_IN(r) &amp; ~(v)))
DECL|struct|feature_bit
r_typedef
r_struct
id|feature_bit
(brace
DECL|member|reg
r_int
id|reg
suffix:semicolon
multiline_comment|/* reg. offset from mac-io base */
DECL|member|polarity
r_int
r_int
id|polarity
suffix:semicolon
multiline_comment|/* 0 = normal, 1 = inverse */
DECL|member|mask
r_int
r_int
id|mask
suffix:semicolon
multiline_comment|/* bit mask */
DECL|typedef|fbit
)brace
id|fbit
suffix:semicolon
multiline_comment|/* I don&squot;t have an OHare machine to test with, so I left those as they&n; * were. Someone with such a machine chould check out what OF says and&n; * try too see if they match the heathrow ones and should be changed too&n; */
DECL|variable|feature_bits_ohare_pbook
r_static
id|fbit
id|feature_bits_ohare_pbook
(braket
)braket
op_assign
(brace
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_null */
(brace
l_int|0x38
comma
l_int|0
comma
id|OH_SCC_RESET
)brace
comma
multiline_comment|/* FEATURE_Serial_reset */
(brace
l_int|0x38
comma
l_int|0
comma
id|OH_SCC_ENABLE
)brace
comma
multiline_comment|/* FEATURE_Serial_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|OH_SCCA_IO
)brace
comma
multiline_comment|/* FEATURE_Serial_IO_A */
(brace
l_int|0x38
comma
l_int|0
comma
id|OH_SCCB_IO
)brace
comma
multiline_comment|/* FEATURE_Serial_IO_B */
(brace
l_int|0x38
comma
l_int|0
comma
id|OH_FLOPPY_ENABLE
)brace
comma
multiline_comment|/* FEATURE_SWIM3_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|OH_MESH_ENABLE
)brace
comma
multiline_comment|/* FEATURE_MESH_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|OH_IDE0_ENABLE
)brace
comma
multiline_comment|/* FEATURE_IDE0_enable */
(brace
l_int|0x38
comma
l_int|1
comma
id|OH_IDE0_RESET_N
)brace
comma
multiline_comment|/* FEATURE_IDE0_reset */
(brace
l_int|0x38
comma
l_int|0
comma
id|OH_IOBUS_ENABLE
)brace
comma
multiline_comment|/* FEATURE_IOBUS_enable */
(brace
l_int|0x38
comma
l_int|1
comma
id|OH_BAY_RESET_N
)brace
comma
multiline_comment|/* FEATURE_Mediabay_reset */
(brace
l_int|0x38
comma
l_int|1
comma
id|OH_BAY_POWER_N
)brace
comma
multiline_comment|/* FEATURE_Mediabay_power */
(brace
l_int|0x38
comma
l_int|0
comma
id|OH_BAY_PCI_ENABLE
)brace
comma
multiline_comment|/* FEATURE_Mediabay_PCI_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|OH_BAY_IDE_ENABLE
)brace
comma
multiline_comment|/* FEATURE_IDE1_enable */
(brace
l_int|0x38
comma
l_int|1
comma
id|OH_IDE1_RESET_N
)brace
comma
multiline_comment|/* FEATURE_IDE1_reset */
(brace
l_int|0x38
comma
l_int|0
comma
id|OH_BAY_FLOPPY_ENABLE
)brace
comma
multiline_comment|/* FEATURE_Mediabay_floppy_enable */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_BMac_reset */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_BMac_IO_enable */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Modem_power */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Slow_SCC_PCLK */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Sound_Power */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Sound_CLK_Enable */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_IDE2_enable */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_IDE2_reset */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Mediabay_IDE_switch */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Mediabay_content */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Airport_reset */
)brace
suffix:semicolon
multiline_comment|/* Those bits concern heathrow-based desktop machines (Beige G3s). We have removed&n; * the SCC related bits and init them once. They have proven to occasionally cause&n; * problems with the desktop units.&n; */
DECL|variable|feature_bits_heathrow
r_static
id|fbit
id|feature_bits_heathrow
(braket
)braket
op_assign
(brace
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_null */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Serial_reset */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Serial_enable */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Serial_IO_A */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Serial_IO_B */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_SWIM_ENABLE
)brace
comma
multiline_comment|/* FEATURE_SWIM3_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_MESH_ENABLE
)brace
comma
multiline_comment|/* FEATURE_MESH_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_IDE0_ENABLE
)brace
comma
multiline_comment|/* FEATURE_IDE0_enable */
(brace
l_int|0x38
comma
l_int|1
comma
id|HRW_IDE0_RESET_N
)brace
comma
multiline_comment|/* FEATURE_IDE0_reset */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_IOBUS_ENABLE
)brace
comma
multiline_comment|/* FEATURE_IOBUS_enable */
(brace
l_int|0x38
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Mediabay_reset */
(brace
l_int|0x38
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Mediabay_power */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Mediabay_PCI_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_BAY_IDE_ENABLE
)brace
comma
multiline_comment|/* FEATURE_IDE1_enable */
(brace
l_int|0x38
comma
l_int|1
comma
id|HRW_IDE1_RESET_N
)brace
comma
multiline_comment|/* FEATURE_IDE1_reset */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Mediabay_floppy_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_BMAC_RESET
)brace
comma
multiline_comment|/* FEATURE_BMac_reset */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_BMAC_IO_ENABLE
)brace
comma
multiline_comment|/* FEATURE_BMac_IO_enable */
(brace
l_int|0x38
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Modem_power */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_SLOW_SCC_PCLK
)brace
comma
multiline_comment|/* FEATURE_Slow_SCC_PCLK */
(brace
l_int|0x38
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Sound_Power */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Sound_CLK_Enable */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_IDE2_enable */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_IDE2_reset */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Mediabay_IDE_switch */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Mediabay_content */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Airport_reset */
)brace
suffix:semicolon
multiline_comment|/* Those bits concern heathrow-based PowerBooks (wallstreet/mainstreet).&n; * Heathrow-based desktop macs (Beige G3s) are _not_ handled here&n; */
DECL|variable|feature_bits_wallstreet
r_static
id|fbit
id|feature_bits_wallstreet
(braket
)braket
op_assign
(brace
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_null */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_RESET_SCC
)brace
comma
multiline_comment|/* FEATURE_Serial_reset */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_SCC_ENABLE
)brace
comma
multiline_comment|/* FEATURE_Serial_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_SCCA_IO
)brace
comma
multiline_comment|/* FEATURE_Serial_IO_A */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_SCCB_IO
)brace
comma
multiline_comment|/* FEATURE_Serial_IO_B */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_SWIM_ENABLE
)brace
comma
multiline_comment|/* FEATURE_SWIM3_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_MESH_ENABLE
)brace
comma
multiline_comment|/* FEATURE_MESH_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_IDE0_ENABLE
)brace
comma
multiline_comment|/* FEATURE_IDE0_enable */
(brace
l_int|0x38
comma
l_int|1
comma
id|HRW_IDE0_RESET_N
)brace
comma
multiline_comment|/* FEATURE_IDE0_reset */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_IOBUS_ENABLE
)brace
comma
multiline_comment|/* FEATURE_IOBUS_enable */
(brace
l_int|0x38
comma
l_int|1
comma
id|HRW_BAY_RESET_N
)brace
comma
multiline_comment|/* FEATURE_Mediabay_reset */
(brace
l_int|0x38
comma
l_int|1
comma
id|HRW_BAY_POWER_N
)brace
comma
multiline_comment|/* FEATURE_Mediabay_power */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_BAY_PCI_ENABLE
)brace
comma
multiline_comment|/* FEATURE_Mediabay_PCI_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_BAY_IDE_ENABLE
)brace
comma
multiline_comment|/* FEATURE_IDE1_enable */
(brace
l_int|0x38
comma
l_int|1
comma
id|HRW_IDE1_RESET_N
)brace
comma
multiline_comment|/* FEATURE_IDE1_reset */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_BAY_FLOPPY_ENABLE
)brace
comma
multiline_comment|/* FEATURE_Mediabay_floppy_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_BMAC_RESET
)brace
comma
multiline_comment|/* FEATURE_BMac_reset */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_BMAC_IO_ENABLE
)brace
comma
multiline_comment|/* FEATURE_BMac_IO_enable */
(brace
l_int|0x38
comma
l_int|1
comma
id|HRW_MODEM_POWER_N
)brace
comma
multiline_comment|/* FEATURE_Modem_power */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_SLOW_SCC_PCLK
)brace
comma
multiline_comment|/* FEATURE_Slow_SCC_PCLK */
(brace
l_int|0x38
comma
l_int|1
comma
id|HRW_SOUND_POWER_N
)brace
comma
multiline_comment|/* FEATURE_Sound_Power */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_SOUND_CLK_ENABLE
)brace
comma
multiline_comment|/* FEATURE_Sound_CLK_Enable */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_IDE2_enable */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_IDE2_reset */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Mediabay_IDE_switch */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Mediabay_content */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Airport_reset */
)brace
suffix:semicolon
multiline_comment|/*&n; * Those bits are from a 1999 G3 PowerBook, with a paddington chip.&n; * Mostly the same as the heathrow.&n; */
DECL|variable|feature_bits_paddington
r_static
id|fbit
id|feature_bits_paddington
(braket
)braket
op_assign
(brace
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_null */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Serial_reset */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_SCC_ENABLE
)brace
comma
multiline_comment|/* FEATURE_Serial_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_SCCA_IO
)brace
comma
multiline_comment|/* FEATURE_Serial_IO_A */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_SCCB_IO
)brace
comma
multiline_comment|/* FEATURE_Serial_IO_B */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_SWIM_ENABLE
)brace
comma
multiline_comment|/* FEATURE_SWIM3_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_MESH_ENABLE
)brace
comma
multiline_comment|/* FEATURE_MESH_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_IDE0_ENABLE
)brace
comma
multiline_comment|/* FEATURE_IDE0_enable */
(brace
l_int|0x38
comma
l_int|1
comma
id|HRW_IDE0_RESET_N
)brace
comma
multiline_comment|/* FEATURE_IDE0_reset */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_IOBUS_ENABLE
)brace
comma
multiline_comment|/* FEATURE_IOBUS_enable */
(brace
l_int|0x38
comma
l_int|1
comma
id|HRW_BAY_RESET_N
)brace
comma
multiline_comment|/* FEATURE_Mediabay_reset */
(brace
l_int|0x38
comma
l_int|1
comma
id|HRW_BAY_POWER_N
)brace
comma
multiline_comment|/* FEATURE_Mediabay_power */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_BAY_PCI_ENABLE
)brace
comma
multiline_comment|/* FEATURE_Mediabay_PCI_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_BAY_IDE_ENABLE
)brace
comma
multiline_comment|/* FEATURE_IDE1_enable */
(brace
l_int|0x38
comma
l_int|1
comma
id|HRW_IDE1_RESET_N
)brace
comma
multiline_comment|/* FEATURE_IDE1_reset */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_BAY_FLOPPY_ENABLE
)brace
comma
multiline_comment|/* FEATURE_Mediabay_floppy_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_BMAC_RESET
)brace
comma
multiline_comment|/* FEATURE_BMac_reset */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_BMAC_IO_ENABLE
)brace
comma
multiline_comment|/* FEATURE_BMac_IO_enable */
(brace
l_int|0x38
comma
l_int|1
comma
id|PADD_MODEM_POWER_N
)brace
comma
multiline_comment|/* FEATURE_Modem_power */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_SLOW_SCC_PCLK
)brace
comma
multiline_comment|/* FEATURE_Slow_SCC_PCLK */
(brace
l_int|0x38
comma
l_int|1
comma
id|HRW_SOUND_POWER_N
)brace
comma
multiline_comment|/* FEATURE_Sound_Power */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_SOUND_CLK_ENABLE
)brace
comma
multiline_comment|/* FEATURE_Sound_CLK_Enable */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_IDE2_enable */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_IDE2_reset */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Mediabay_IDE_switch */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Mediabay_content */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Airport_reset */
)brace
suffix:semicolon
multiline_comment|/* Those bits are for Core99 machines (iBook,G4,iMacSL/DV,Pismo,...).&n; */
DECL|variable|feature_bits_keylargo
r_static
id|fbit
id|feature_bits_keylargo
(braket
)braket
op_assign
(brace
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_null */
(brace
l_int|0x38
comma
l_int|0
comma
id|KL0_SCC_RESET
)brace
comma
multiline_comment|/* FEATURE_Serial_reset */
(brace
l_int|0x38
comma
l_int|0
comma
id|KL0_SERIAL_ENABLE
)brace
comma
multiline_comment|/* FEATURE_Serial_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|KL0_SCC_A_INTF_ENABLE
)brace
comma
multiline_comment|/* FEATURE_Serial_IO_A */
(brace
l_int|0x38
comma
l_int|0
comma
id|KL0_SCC_B_INTF_ENABLE
)brace
comma
multiline_comment|/* FEATURE_Serial_IO_B */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_SWIM3_enable */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_MESH_enable */
(brace
l_int|0x3c
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_IDE0_enable */
(brace
l_int|0x3c
comma
l_int|1
comma
id|KL1_EIDE0_RESET_N
)brace
comma
multiline_comment|/* FEATURE_IDE0_reset */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_IOBUS_enable */
(brace
l_int|0x34
comma
l_int|1
comma
l_int|0x00000200
)brace
comma
multiline_comment|/* FEATURE_Mediabay_reset */
(brace
l_int|0x34
comma
l_int|1
comma
l_int|0x00000400
)brace
comma
multiline_comment|/* FEATURE_Mediabay_power */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Mediabay_PCI_enable */
(brace
l_int|0x3c
comma
l_int|0
comma
l_int|0x0
)brace
comma
multiline_comment|/* FEATURE_IDE1_enable */
(brace
l_int|0x3c
comma
l_int|1
comma
id|KL1_EIDE1_RESET_N
)brace
comma
multiline_comment|/* FEATURE_IDE1_reset */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Mediabay_floppy_enable */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_BMac_reset */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_BMac_IO_enable */
(brace
l_int|0x40
comma
l_int|1
comma
id|KL2_MODEM_POWER_N
)brace
comma
multiline_comment|/* FEATURE_Modem_power */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Slow_SCC_PCLK */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Sound_Power */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Sound_CLK_Enable */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_IDE2_enable */
(brace
l_int|0x3c
comma
l_int|1
comma
id|KL1_UIDE_RESET_N
)brace
comma
multiline_comment|/* FEATURE_IDE2_reset */
(brace
l_int|0x34
comma
l_int|0
comma
id|KL_MBCR_MBDEV_ENABLE
)brace
comma
multiline_comment|/* FEATURE_Mediabay_IDE_switch */
(brace
l_int|0x34
comma
l_int|0
comma
l_int|0x00000100
)brace
comma
multiline_comment|/* FEATURE_Mediabay_content */
(brace
l_int|0x40
comma
l_int|1
comma
id|KL2_AIRPORT_RESET_N
)brace
comma
multiline_comment|/* FEATURE_Airport_reset */
)brace
suffix:semicolon
multiline_comment|/* definition of a feature controller object */
DECL|struct|feature_controller
r_struct
id|feature_controller
(brace
DECL|member|bits
id|fbit
op_star
id|bits
suffix:semicolon
DECL|member|reg
r_volatile
id|u32
op_star
id|reg
suffix:semicolon
DECL|member|device
r_struct
id|device_node
op_star
id|device
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* static functions */
r_static
r_struct
id|feature_controller
op_star
id|feature_add_controller
c_func
(paren
r_struct
id|device_node
op_star
id|controller_device
comma
id|fbit
op_star
id|bits
)paren
suffix:semicolon
r_static
r_struct
id|feature_controller
op_star
id|feature_lookup_controller
c_func
(paren
r_struct
id|device_node
op_star
id|device
)paren
suffix:semicolon
r_static
r_void
id|heathrow_prepare_for_sleep
c_func
(paren
r_struct
id|feature_controller
op_star
id|ctrler
)paren
suffix:semicolon
r_static
r_void
id|heathrow_wakeup
c_func
(paren
r_struct
id|feature_controller
op_star
id|ctrler
)paren
suffix:semicolon
r_static
r_void
id|keylargo_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|uninorth_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|core99_prepare_for_sleep
c_func
(paren
r_struct
id|feature_controller
op_star
id|ctrler
)paren
suffix:semicolon
r_static
r_void
id|core99_wake_up
c_func
(paren
r_struct
id|feature_controller
op_star
id|ctrler
)paren
suffix:semicolon
multiline_comment|/* static variables */
DECL|variable|controllers
r_static
r_struct
id|feature_controller
id|controllers
(braket
id|MAX_FEATURE_CONTROLLERS
)braket
suffix:semicolon
DECL|variable|controller_count
r_static
r_int
id|controller_count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Core99 stuffs */
DECL|variable|uninorth_base
r_static
r_volatile
id|u32
op_star
id|uninorth_base
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|keylargo_base
r_static
r_volatile
id|u32
op_star
id|keylargo_base
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|uninorth_rev
r_static
r_int
id|uninorth_rev
suffix:semicolon
DECL|variable|keylargo_rev
r_static
r_int
id|keylargo_rev
suffix:semicolon
r_void
DECL|function|feature_init
id|feature_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|np
suffix:semicolon
id|u32
op_star
id|rev
suffix:semicolon
r_if
c_cond
(paren
id|_machine
op_ne
id|_MACH_Pmac
)paren
r_return
suffix:semicolon
id|np
op_assign
id|find_devices
c_func
(paren
l_string|&quot;mac-io&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|np
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* KeyLargo contains several (5 ?) FCR registers in mac-io,&n;&t;&t; * plus some gpio&squot;s which could eventually be handled here.&n;&t;&t; */
r_if
c_cond
(paren
id|device_is_compatible
c_func
(paren
id|np
comma
l_string|&quot;Keylargo&quot;
)paren
)paren
(brace
r_struct
id|feature_controller
op_star
id|ctrler
op_assign
id|feature_add_controller
c_func
(paren
id|np
comma
id|feature_bits_keylargo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ctrler
)paren
(brace
id|keylargo_base
op_assign
id|ctrler-&gt;reg
suffix:semicolon
id|rev
op_assign
(paren
id|u32
op_star
)paren
id|get_property
c_func
(paren
id|ctrler-&gt;device
comma
l_string|&quot;revision-id&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rev
)paren
id|keylargo_rev
op_assign
op_star
id|rev
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|device_is_compatible
c_func
(paren
id|np
comma
l_string|&quot;paddington&quot;
)paren
)paren
(brace
id|feature_add_controller
c_func
(paren
id|np
comma
id|feature_bits_paddington
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|machine_is_compatible
c_func
(paren
l_string|&quot;AAPL,PowerBook1998&quot;
)paren
)paren
(brace
id|feature_add_controller
c_func
(paren
id|np
comma
id|feature_bits_wallstreet
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|feature_controller
op_star
id|ctrler
op_assign
id|feature_add_controller
c_func
(paren
id|np
comma
id|feature_bits_heathrow
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ctrler
)paren
id|out_le32
c_func
(paren
id|FREG
c_func
(paren
id|ctrler
comma
id|HEATHROW_FEATURE_REG
)paren
comma
id|in_le32
c_func
(paren
id|FREG
c_func
(paren
id|ctrler
comma
id|HEATHROW_FEATURE_REG
)paren
)paren
op_or
id|HRW_DEFAULTS
)paren
suffix:semicolon
)brace
id|np
op_assign
id|np-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
id|controller_count
op_eq
l_int|0
)paren
(brace
id|np
op_assign
id|find_devices
c_func
(paren
l_string|&quot;ohare&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|np
)paren
(brace
r_if
c_cond
(paren
id|find_devices
c_func
(paren
l_string|&quot;via-pmu&quot;
)paren
op_ne
l_int|NULL
)paren
id|feature_add_controller
c_func
(paren
id|np
comma
id|feature_bits_ohare_pbook
)paren
suffix:semicolon
r_else
multiline_comment|/* else not sure; maybe this is a Starmax? */
id|feature_add_controller
c_func
(paren
id|np
comma
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Handle core99 Uni-N */
id|np
op_assign
id|find_devices
c_func
(paren
l_string|&quot;uni-n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|np
op_logical_and
id|np-&gt;n_addrs
OG
l_int|0
)paren
(brace
id|uninorth_base
op_assign
id|ioremap
c_func
(paren
id|np-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
comma
l_int|0x1000
)paren
suffix:semicolon
id|uninorth_rev
op_assign
id|in_be32
c_func
(paren
id|UN_REG
c_func
(paren
id|UNI_N_VERSION
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|uninorth_base
op_logical_and
id|keylargo_base
)paren
id|printk
c_func
(paren
l_string|&quot;Uni-N revision: %d, KeyLargo revision: %d&bslash;n&quot;
comma
id|uninorth_rev
comma
id|keylargo_rev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uninorth_base
)paren
id|uninorth_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|keylargo_base
)paren
id|keylargo_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|controller_count
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Registered %d feature controller(s)&bslash;n&quot;
comma
id|controller_count
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_PMAC_PBOOK) &amp;&amp; !defined(CONFIG_DMASOUND_AWACS)
multiline_comment|/* On PowerBooks, we disable the sound chip when dmasound is a module&n;&t; * or not used at all&n;&t; */
r_if
c_cond
(paren
id|controller_count
op_logical_and
id|find_devices
c_func
(paren
l_string|&quot;via-pmu&quot;
)paren
op_ne
l_int|NULL
)paren
(brace
id|feature_clear
c_func
(paren
id|controllers
(braket
l_int|0
)braket
dot
id|device
comma
id|FEATURE_Sound_power
)paren
suffix:semicolon
id|feature_clear
c_func
(paren
id|controllers
(braket
l_int|0
)braket
dot
id|device
comma
id|FEATURE_Sound_CLK_enable
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
r_static
r_struct
id|feature_controller
op_star
DECL|function|feature_add_controller
id|feature_add_controller
c_func
(paren
r_struct
id|device_node
op_star
id|controller_device
comma
id|fbit
op_star
id|bits
)paren
(brace
r_struct
id|feature_controller
op_star
id|controller
suffix:semicolon
r_if
c_cond
(paren
id|controller_count
op_ge
id|MAX_FEATURE_CONTROLLERS
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Feature controller %s skipped(MAX:%d)&bslash;n&quot;
comma
id|controller_device-&gt;full_name
comma
id|MAX_FEATURE_CONTROLLERS
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|controller
op_assign
op_amp
id|controllers
(braket
id|controller_count
)braket
suffix:semicolon
id|controller-&gt;bits
op_assign
id|bits
suffix:semicolon
id|controller-&gt;device
op_assign
id|controller_device
suffix:semicolon
r_if
c_cond
(paren
id|controller_device-&gt;n_addrs
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;No addresses for %s&bslash;n&quot;
comma
id|controller_device-&gt;full_name
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|controller-&gt;reg
op_assign
(paren
r_volatile
id|u32
op_star
)paren
id|ioremap
c_func
(paren
id|controller_device-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
comma
id|MAX_FEATURE_OFFSET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Twiddling the magic ohare bits&bslash;n&quot;
)paren
suffix:semicolon
id|out_le32
c_func
(paren
id|FREG
c_func
(paren
id|controller
comma
id|OHARE_FEATURE_REG
)paren
comma
id|STARMAX_FEATURES
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|spin_lock_init
c_func
(paren
op_amp
id|controller-&gt;lock
)paren
suffix:semicolon
id|controller_count
op_increment
suffix:semicolon
r_return
id|controller
suffix:semicolon
)brace
r_static
r_struct
id|feature_controller
op_star
DECL|function|feature_lookup_controller
id|feature_lookup_controller
c_func
(paren
r_struct
id|device_node
op_star
id|device
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|device
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
id|device
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|controller_count
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|device
op_eq
id|controllers
(braket
id|i
)braket
dot
id|device
)paren
r_return
op_amp
id|controllers
(braket
id|i
)braket
suffix:semicolon
id|device
op_assign
id|device-&gt;parent
suffix:semicolon
)brace
macro_line|#ifdef DEBUG_FEATURE
id|printk
c_func
(paren
l_string|&quot;feature: &lt;%s&gt; not found on any controller&bslash;n&quot;
comma
id|device-&gt;name
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|NULL
suffix:semicolon
)brace
r_int
DECL|function|feature_set
id|feature_set
c_func
(paren
r_struct
id|device_node
op_star
id|device
comma
r_enum
id|system_feature
id|f
)paren
(brace
r_struct
id|feature_controller
op_star
id|controller
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|value
suffix:semicolon
id|fbit
op_star
id|bit
suffix:semicolon
r_if
c_cond
(paren
id|f
op_ge
id|FEATURE_last
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|controller
op_assign
id|feature_lookup_controller
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|controller
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|bit
op_assign
op_amp
id|controller-&gt;bits
(braket
id|f
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bit-&gt;mask
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
macro_line|#ifdef DEBUG_FEATURE
id|printk
c_func
(paren
l_string|&quot;feature: &lt;%s&gt; setting feature %d in controller @0x%x&bslash;n&quot;
comma
id|device-&gt;name
comma
(paren
r_int
)paren
id|f
comma
(paren
r_int
r_int
)paren
id|controller-&gt;reg
)paren
suffix:semicolon
macro_line|#endif
id|spin_lock_irqsave
c_func
(paren
op_amp
id|controller-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|value
op_assign
id|in_le32
c_func
(paren
id|FREG
c_func
(paren
id|controller
comma
id|bit-&gt;reg
)paren
)paren
suffix:semicolon
id|value
op_assign
id|bit-&gt;polarity
ques
c_cond
(paren
id|value
op_amp
op_complement
id|bit-&gt;mask
)paren
suffix:colon
(paren
id|value
op_or
id|bit-&gt;mask
)paren
suffix:semicolon
id|out_le32
c_func
(paren
id|FREG
c_func
(paren
id|controller
comma
id|bit-&gt;reg
)paren
comma
id|value
)paren
suffix:semicolon
(paren
r_void
)paren
id|in_le32
c_func
(paren
id|FREG
c_func
(paren
id|controller
comma
id|bit-&gt;reg
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|controller-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|feature_clear
id|feature_clear
c_func
(paren
r_struct
id|device_node
op_star
id|device
comma
r_enum
id|system_feature
id|f
)paren
(brace
r_struct
id|feature_controller
op_star
id|controller
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|value
suffix:semicolon
id|fbit
op_star
id|bit
suffix:semicolon
r_if
c_cond
(paren
id|f
op_ge
id|FEATURE_last
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|controller
op_assign
id|feature_lookup_controller
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|controller
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|bit
op_assign
op_amp
id|controller-&gt;bits
(braket
id|f
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bit-&gt;mask
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
macro_line|#ifdef DEBUG_FEATURE
id|printk
c_func
(paren
l_string|&quot;feature: &lt;%s&gt; clearing feature %d in controller @0x%x&bslash;n&quot;
comma
id|device-&gt;name
comma
(paren
r_int
)paren
id|f
comma
(paren
r_int
r_int
)paren
id|controller-&gt;reg
)paren
suffix:semicolon
macro_line|#endif
id|spin_lock_irqsave
c_func
(paren
op_amp
id|controller-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|value
op_assign
id|in_le32
c_func
(paren
id|FREG
c_func
(paren
id|controller
comma
id|bit-&gt;reg
)paren
)paren
suffix:semicolon
id|value
op_assign
id|bit-&gt;polarity
ques
c_cond
(paren
id|value
op_or
id|bit-&gt;mask
)paren
suffix:colon
(paren
id|value
op_amp
op_complement
id|bit-&gt;mask
)paren
suffix:semicolon
id|out_le32
c_func
(paren
id|FREG
c_func
(paren
id|controller
comma
id|bit-&gt;reg
)paren
comma
id|value
)paren
suffix:semicolon
(paren
r_void
)paren
id|in_le32
c_func
(paren
id|FREG
c_func
(paren
id|controller
comma
id|bit-&gt;reg
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|controller-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|feature_test
id|feature_test
c_func
(paren
r_struct
id|device_node
op_star
id|device
comma
r_enum
id|system_feature
id|f
)paren
(brace
r_struct
id|feature_controller
op_star
id|controller
suffix:semicolon
r_int
r_int
id|value
suffix:semicolon
id|fbit
op_star
id|bit
suffix:semicolon
r_if
c_cond
(paren
id|f
op_ge
id|FEATURE_last
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|controller
op_assign
id|feature_lookup_controller
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|controller
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|bit
op_assign
op_amp
id|controller-&gt;bits
(braket
id|f
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bit-&gt;mask
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
macro_line|#ifdef DEBUG_FEATURE
id|printk
c_func
(paren
l_string|&quot;feature: &lt;%s&gt; clearing feature %d in controller @0x%x&bslash;n&quot;
comma
id|device-&gt;name
comma
(paren
r_int
)paren
id|f
comma
(paren
r_int
r_int
)paren
id|controller-&gt;reg
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* If one feature contains several bits, all of them must be set&n;&t; * for value to be true, or all of them must be 0 if polarity is&n;&t; * inverse&n;&t; */
id|value
op_assign
(paren
id|in_le32
c_func
(paren
id|FREG
c_func
(paren
id|controller
comma
id|bit-&gt;reg
)paren
)paren
op_amp
id|bit-&gt;mask
)paren
suffix:semicolon
r_return
id|bit-&gt;polarity
ques
c_cond
(paren
id|value
op_eq
l_int|0
)paren
suffix:colon
(paren
id|value
op_eq
id|bit-&gt;mask
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Core99 functions&n; * &n; * Note: We currently assume there is _one_ UniN chip and _one_ KeyLargo&n; *       chip, which is the case on all Core99 machines so far&n; */
multiline_comment|/* Only one GMAC is assumed */
r_void
DECL|function|feature_set_gmac_power
id|feature_set_gmac_power
c_func
(paren
r_struct
id|device_node
op_star
id|device
comma
r_int
id|power
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|uninorth_base
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|power
)paren
id|UN_BIS
c_func
(paren
id|UNI_N_CLOCK_CNTL
comma
id|UNI_N_CLOCK_CNTL_GMAC
)paren
suffix:semicolon
r_else
id|UN_BIC
c_func
(paren
id|UNI_N_CLOCK_CNTL
comma
id|UNI_N_CLOCK_CNTL_GMAC
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
)brace
r_void
DECL|function|feature_set_gmac_phy_reset
id|feature_set_gmac_phy_reset
c_func
(paren
r_struct
id|device_node
op_star
id|device
comma
r_int
id|reset
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|keylargo_base
)paren
r_return
suffix:semicolon
id|out_8
c_func
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|KL_GPIO_ETH_PHY_RESET
)paren
comma
id|reset
)paren
suffix:semicolon
(paren
r_void
)paren
id|in_8
c_func
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|KL_GPIO_ETH_PHY_RESET
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Pass the node of the correct controller, please */
r_void
DECL|function|feature_set_usb_power
id|feature_set_usb_power
c_func
(paren
r_struct
id|device_node
op_star
id|device
comma
r_int
id|power
)paren
(brace
)brace
multiline_comment|/* Not yet implemented */
r_void
DECL|function|feature_set_firewire_power
id|feature_set_firewire_power
c_func
(paren
r_struct
id|device_node
op_star
id|device
comma
r_int
id|power
)paren
(brace
)brace
multiline_comment|/* Initialize the Core99 UniNorth host bridge and memory controller&n; */
r_static
r_void
DECL|function|uninorth_init
id|uninorth_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|gmac
suffix:semicolon
r_int
r_int
id|actrl
suffix:semicolon
multiline_comment|/* Set the arbitrer QAck delay according to what Apple does&n;&t; */
id|actrl
op_assign
id|in_be32
c_func
(paren
id|UN_REG
c_func
(paren
id|UNI_N_ARB_CTRL
)paren
)paren
op_amp
op_complement
id|UNI_N_ARB_CTRL_QACK_DELAY_MASK
suffix:semicolon
id|actrl
op_or_assign
(paren
(paren
id|uninorth_rev
OL
l_int|3
)paren
ques
c_cond
id|UNI_N_ARB_CTRL_QACK_DELAY105
suffix:colon
id|UNI_N_ARB_CTRL_QACK_DELAY
)paren
op_lshift
id|UNI_N_ARB_CTRL_QACK_DELAY_SHIFT
suffix:semicolon
id|UN_OUT
c_func
(paren
id|UNI_N_ARB_CTRL
comma
id|actrl
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Turns OFF the gmac clock. The gmac driver will turn&n;&t; * it back ON when the interface is enabled. This save&n;&t; * power on portables.&n;&t; * &n;&t; * Note: We could also try to turn OFF the PHY. Since this&n;&t; * has to be done by both the gmac driver and this code,&n;&t; * I&squot;ll probably end-up moving some of this out of the&n;&t; * modular gmac driver into a non-modular stub containing&n;&t; * some basic PHY management and power management stuffs&n;&t; */
id|gmac
op_assign
id|find_devices
c_func
(paren
l_string|&quot;ethernet&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|gmac
)paren
(brace
r_if
c_cond
(paren
id|device_is_compatible
c_func
(paren
id|gmac
comma
l_string|&quot;gmac&quot;
)paren
)paren
r_break
suffix:semicolon
id|gmac
op_assign
id|gmac-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gmac
)paren
id|feature_set_gmac_power
c_func
(paren
id|gmac
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialize the Core99 KeyLargo ASIC. Currently, we just make sure&n; * OpenPIC is enabled&n; */
r_static
r_void
DECL|function|keylargo_init
id|keylargo_init
c_func
(paren
r_void
)paren
(brace
id|KL_BIS
c_func
(paren
id|KEYLARGO_FCR2
comma
id|KL2_MPIC_ENABLE
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PMAC_PBOOK
r_void
DECL|function|feature_prepare_for_sleep
id|feature_prepare_for_sleep
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* We assume gatwick is second */
r_struct
id|feature_controller
op_star
id|ctrler
op_assign
op_amp
id|controllers
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ctrler
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|controller_count
OG
l_int|1
op_logical_and
id|device_is_compatible
c_func
(paren
id|ctrler-&gt;device
comma
l_string|&quot;gatwick&quot;
)paren
)paren
id|ctrler
op_assign
op_amp
id|controllers
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ctrler-&gt;bits
op_eq
id|feature_bits_heathrow
op_logical_or
id|ctrler-&gt;bits
op_eq
id|feature_bits_paddington
)paren
(brace
id|heathrow_prepare_for_sleep
c_func
(paren
id|ctrler
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ctrler-&gt;bits
op_eq
id|feature_bits_keylargo
)paren
(brace
id|core99_prepare_for_sleep
c_func
(paren
id|ctrler
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_void
DECL|function|feature_wake_up
id|feature_wake_up
c_func
(paren
r_void
)paren
(brace
r_struct
id|feature_controller
op_star
id|ctrler
op_assign
op_amp
id|controllers
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ctrler
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|controller_count
OG
l_int|1
op_logical_and
id|device_is_compatible
c_func
(paren
id|ctrler-&gt;device
comma
l_string|&quot;gatwick&quot;
)paren
)paren
id|ctrler
op_assign
op_amp
id|controllers
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ctrler-&gt;bits
op_eq
id|feature_bits_heathrow
op_logical_or
id|ctrler-&gt;bits
op_eq
id|feature_bits_paddington
)paren
(brace
id|heathrow_wakeup
c_func
(paren
id|ctrler
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ctrler-&gt;bits
op_eq
id|feature_bits_keylargo
)paren
(brace
id|core99_wake_up
c_func
(paren
id|ctrler
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
DECL|variable|save_fcr
r_static
id|u32
id|save_fcr
(braket
l_int|5
)braket
suffix:semicolon
DECL|variable|save_mbcr
r_static
id|u32
id|save_mbcr
suffix:semicolon
r_static
r_void
DECL|function|heathrow_prepare_for_sleep
id|heathrow_prepare_for_sleep
c_func
(paren
r_struct
id|feature_controller
op_star
id|ctrler
)paren
(brace
id|save_mbcr
op_assign
id|in_le32
c_func
(paren
id|FREG
c_func
(paren
id|ctrler
comma
l_int|0x34
)paren
)paren
suffix:semicolon
id|save_fcr
(braket
l_int|0
)braket
op_assign
id|in_le32
c_func
(paren
id|FREG
c_func
(paren
id|ctrler
comma
l_int|0x38
)paren
)paren
suffix:semicolon
id|save_fcr
(braket
l_int|1
)braket
op_assign
id|in_le32
c_func
(paren
id|FREG
c_func
(paren
id|ctrler
comma
l_int|0x3c
)paren
)paren
suffix:semicolon
id|out_le32
c_func
(paren
id|FREG
c_func
(paren
id|ctrler
comma
l_int|0x38
)paren
comma
id|save_fcr
(braket
l_int|0
)braket
op_amp
op_complement
id|HRW_IOBUS_ENABLE
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|heathrow_wakeup
id|heathrow_wakeup
c_func
(paren
r_struct
id|feature_controller
op_star
id|ctrler
)paren
(brace
id|out_le32
c_func
(paren
id|FREG
c_func
(paren
id|ctrler
comma
l_int|0x38
)paren
comma
id|save_fcr
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|out_le32
c_func
(paren
id|FREG
c_func
(paren
id|ctrler
comma
l_int|0x3c
)paren
comma
id|save_fcr
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|out_le32
c_func
(paren
id|FREG
c_func
(paren
id|ctrler
comma
l_int|0x34
)paren
comma
id|save_mbcr
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_le32
c_func
(paren
id|FREG
c_func
(paren
id|ctrler
comma
l_int|0x38
)paren
comma
id|save_fcr
(braket
l_int|0
)braket
op_or
id|HRW_IOBUS_ENABLE
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|core99_prepare_for_sleep
id|core99_prepare_for_sleep
c_func
(paren
r_struct
id|feature_controller
op_star
id|ctrler
)paren
(brace
multiline_comment|/* Not yet implemented */
)brace
r_static
r_void
DECL|function|core99_wake_up
id|core99_wake_up
c_func
(paren
r_struct
id|feature_controller
op_star
id|ctrler
)paren
(brace
multiline_comment|/* Not yet implemented */
)brace
macro_line|#endif /* CONFIG_PMAC_PBOOK */
eof
