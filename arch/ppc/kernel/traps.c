multiline_comment|/*&n; *  linux/arch/ppc/kernel/traps.c&n; *&n; *  Copyright (C) 1995  Gary Thomas&n; *  Adapted for PowerPC by Gary Thomas&n; *  Modified by Cort Dougan (cort@cs.nmt.edu)&n; */
multiline_comment|/*&n; * This file handles the architecture-dependent parts of hardware exceptions&n; */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/user.h&gt;
macro_line|#include &lt;linux/a.out.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/ppc_machine.h&gt;
multiline_comment|/*&n; * Trap &amp; Exception support&n; */
r_void
DECL|function|trap_init
id|trap_init
c_func
(paren
r_void
)paren
(brace
)brace
r_void
DECL|function|_exception
id|_exception
c_func
(paren
r_int
id|signr
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
multiline_comment|/*&t;dump_regs(regs);*/
id|force_sig
c_func
(paren
id|signr
comma
id|current
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|user_mode
c_func
(paren
id|regs
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Failure in kernel at PC: %x, MSR: %x&bslash;n&quot;
comma
id|regs-&gt;nip
comma
id|regs-&gt;msr
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
)brace
)brace
DECL|function|MachineCheckException
id|MachineCheckException
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Machine check at PC: %x[%x], SR: %x&bslash;n&quot;
comma
id|regs-&gt;nip
comma
id|va_to_phys
c_func
(paren
id|regs-&gt;nip
)paren
comma
id|regs-&gt;msr
)paren
suffix:semicolon
id|_exception
c_func
(paren
id|SIGSEGV
comma
id|regs
)paren
suffix:semicolon
)brace
DECL|function|ProgramCheckException
id|ProgramCheckException
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;Program check at PC: %x[%x], SR: %x&bslash;n&quot;
comma
id|regs-&gt;nip
comma
id|va_to_phys
c_func
(paren
id|regs-&gt;nip
)paren
comma
id|regs-&gt;msr
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|current-&gt;flags
op_amp
id|PF_PTRACED
)paren
(brace
id|_exception
c_func
(paren
id|SIGTRAP
comma
id|regs
)paren
suffix:semicolon
)brace
r_else
(brace
id|_exception
c_func
(paren
id|SIGILL
comma
id|regs
)paren
suffix:semicolon
)brace
)brace
DECL|function|SingleStepException
id|SingleStepException
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|regs-&gt;msr
op_and_assign
op_complement
id|MSR_SE
suffix:semicolon
multiline_comment|/* Turn off &squot;trace&squot; bit */
id|_exception
c_func
(paren
id|SIGTRAP
comma
id|regs
)paren
suffix:semicolon
)brace
DECL|function|FloatingPointCheckException
id|FloatingPointCheckException
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
multiline_comment|/* if fpu already on -- then exception was generated by an error */
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
(paren
id|regs-&gt;msr
)paren
op_amp
(paren
r_int
r_int
)paren
id|MSR_FP
)paren
(brace
id|_exception
c_func
(paren
id|SIGFPE
comma
id|regs
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;fpu off -- turning on: %s pc %x fpscr %x msr %x ksp %x r1 %x&bslash;n&quot;
comma
id|current-&gt;comm
comma
id|regs-&gt;nip
comma
id|regs-&gt;fpcsr
comma
id|regs-&gt;msr
comma
id|regs
comma
id|regs-&gt;gpr
(braket
l_int|1
)braket
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* if the fpu is off then turn it on and return */
id|regs-&gt;msr
op_or_assign
id|MSR_FP
suffix:semicolon
id|current-&gt;tss.fp_used
op_increment
suffix:semicolon
multiline_comment|/* tells return_from_int to restore fp regs since fp was turned on&n;     see head.S -- Cort */
r_return
id|MSR_FP
suffix:semicolon
)brace
DECL|function|AlignmentException
id|AlignmentException
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
multiline_comment|/*&t;printk(&quot;Alignment error at PC: %x, SR: %x&bslash;n&quot;, regs-&gt;nip, regs-&gt;msr);&n;&t;dump_regs(regs);&n;&t;printk(&quot;Alignment error at PC: %x[%x], SR: %x&bslash;n&quot;, regs-&gt;nip, va_to_phys(regs-&gt;nip), regs-&gt;msr);*/
id|_exception
c_func
(paren
id|SIGBUS
comma
id|regs
)paren
suffix:semicolon
)brace
multiline_comment|/* see CHECK_STACK macro in head.S for argument definitions */
DECL|function|bad_stack
id|bad_stack
c_func
(paren
r_int
r_int
id|r3
comma
r_int
r_int
id|r4
comma
r_int
r_int
id|r5
comma
r_int
r_int
id|r6
)paren
(brace
multiline_comment|/* r6 (was r1) kernel stack pointer */
multiline_comment|/* r5 (was r2) kernel stack page */
multiline_comment|/* r4 kernel stack magic */
multiline_comment|/* r3 stack magic or ksp masked to page boundary */
id|printk
c_func
(paren
l_string|&quot;bad_stack(): Kernel stack bad.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ksp %x kpage %x stack magic %x r3 %x&bslash;n&quot;
comma
id|r6
comma
id|r5
comma
id|r4
comma
id|r3
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;current: %s/%d&bslash;n&quot;
comma
id|current-&gt;comm
comma
id|current-&gt;pid
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
suffix:semicolon
)brace
)brace
DECL|function|dump_regs
id|dump_regs
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;NIP: %08X, MSR: %08X, XER: %08X, LR: %08X, FRAME: %08X&bslash;n&quot;
comma
id|regs-&gt;nip
comma
id|regs-&gt;msr
comma
id|regs-&gt;xer
comma
id|regs-&gt;link
comma
id|regs
)paren
suffix:semicolon
macro_line|#if 0&t;
id|printk
c_func
(paren
l_string|&quot;HASH = %08X/%08X, MISS = %08X/%08X, CMP = %08X/%08X&bslash;n&quot;
comma
id|regs-&gt;hash1
comma
id|regs-&gt;hash2
comma
id|regs-&gt;imiss
comma
id|regs-&gt;dmiss
comma
id|regs-&gt;icmp
comma
id|regs-&gt;dcmp
)paren
suffix:semicolon
macro_line|#endif&t;
id|printk
c_func
(paren
l_string|&quot;TASK = %x[%d] &squot;%s&squot;&bslash;n&quot;
comma
id|current
comma
id|current-&gt;pid
comma
id|current-&gt;comm
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|i
op_mod
l_int|8
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;GPR%02d: &quot;
comma
id|i
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%08X &quot;
comma
id|regs-&gt;gpr
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_mod
l_int|8
)paren
op_eq
l_int|7
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
macro_line|#if 0&t;
r_if
c_cond
(paren
id|regs-&gt;nip
op_ge
l_int|0x1000
)paren
id|dump_buf
c_func
(paren
id|regs-&gt;nip
op_minus
l_int|32
comma
l_int|64
)paren
suffix:semicolon
id|dump_buf
c_func
(paren
(paren
id|regs-&gt;nip
op_amp
l_int|0x0FFFFFFF
)paren
op_or
id|KERNELBASE
comma
l_int|32
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|trace_syscall
id|trace_syscall
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_static
r_int
id|count
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Task: %08X(%d), PC: %08X/%08X, Syscall: %3d, Result: %s%d&bslash;n&quot;
comma
id|current
comma
id|current-&gt;pid
comma
id|regs-&gt;nip
comma
id|regs-&gt;link
comma
id|regs-&gt;gpr
(braket
l_int|0
)braket
comma
id|regs-&gt;ccr
op_amp
l_int|0x10000000
ques
c_cond
l_string|&quot;Error=&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|regs-&gt;gpr
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|count
op_eq
l_int|20
)paren
(brace
id|count
op_assign
l_int|0
suffix:semicolon
)brace
)brace
eof
