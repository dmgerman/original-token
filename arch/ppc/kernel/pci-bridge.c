multiline_comment|/*&n; * Support for PCI bridges found on Power Macintoshes.&n; * At present the &quot;bandit&quot; and &quot;chaos&quot; bridges are supported.&n; * Fortunately you access configuration space in the same&n; * way with either bridge.&n; *&n; * Copyright (C) 1997 Paul Mackerras (paulus@cs.anu.edu.au)&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/bios32.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/pci-bridge.h&gt;
DECL|struct|bridge_data
r_struct
id|bridge_data
(brace
DECL|member|cfg_addr
r_volatile
r_int
r_int
op_star
id|cfg_addr
suffix:semicolon
DECL|member|cfg_data
r_volatile
r_int
r_char
op_star
id|cfg_data
suffix:semicolon
DECL|member|io_base
r_void
op_star
id|io_base
suffix:semicolon
DECL|member|bus_number
r_int
id|bus_number
suffix:semicolon
DECL|member|max_bus
r_int
id|max_bus
suffix:semicolon
DECL|member|next
r_struct
id|bridge_data
op_star
id|next
suffix:semicolon
DECL|member|node
r_struct
id|device_node
op_star
id|node
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|bridges
DECL|variable|bridge_list
r_static
r_struct
id|bridge_data
op_star
op_star
id|bridges
comma
op_star
id|bridge_list
suffix:semicolon
DECL|variable|max_bus
r_static
r_int
id|max_bus
suffix:semicolon
r_static
r_void
id|add_bridges
c_func
(paren
r_struct
id|device_node
op_star
id|dev
comma
r_int
r_int
op_star
id|mem_ptr
)paren
suffix:semicolon
multiline_comment|/*&n; * Magic constants for enabling cache coherency in the bandit/PSX bridge.&n; */
DECL|macro|APPLE_VENDID
mdefine_line|#define APPLE_VENDID&t;0x106b
DECL|macro|BANDIT_DEVID
mdefine_line|#define BANDIT_DEVID&t;1
DECL|macro|BANDIT_REVID
mdefine_line|#define BANDIT_REVID&t;3
DECL|macro|BANDIT_DEVNUM
mdefine_line|#define BANDIT_DEVNUM&t;11
DECL|macro|BANDIT_MAGIC
mdefine_line|#define BANDIT_MAGIC&t;0x50
DECL|macro|BANDIT_COHERENT
mdefine_line|#define BANDIT_COHERENT&t;0x40
multiline_comment|/*&n; * For a bandit bridge, turn on cache coherency if necessary.&n; * N.B. we can&squot;t use pcibios_*_config_* here because bridges[]&n; * is not initialized yet.&n; */
DECL|function|init_bandit
r_static
r_void
id|init_bandit
c_func
(paren
r_struct
id|bridge_data
op_star
id|bp
)paren
(brace
r_int
r_int
id|vendev
comma
id|magic
suffix:semicolon
r_int
id|rev
suffix:semicolon
multiline_comment|/* read the word at offset 0 in config space for device 11 */
id|out_le32
c_func
(paren
id|bp-&gt;cfg_addr
comma
(paren
l_int|1UL
op_lshift
id|BANDIT_DEVNUM
)paren
op_plus
id|PCI_VENDOR_ID
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|vendev
op_assign
id|in_le32
c_func
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
id|bp-&gt;cfg_data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vendev
op_ne
(paren
id|BANDIT_DEVID
op_lshift
l_int|16
)paren
op_plus
id|APPLE_VENDID
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;bandit isn&squot;t? (%x)&bslash;n&quot;
comma
id|vendev
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* read the revision id */
id|out_le32
c_func
(paren
id|bp-&gt;cfg_addr
comma
(paren
l_int|1UL
op_lshift
id|BANDIT_DEVNUM
)paren
op_plus
id|PCI_REVISION_ID
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|rev
op_assign
id|in_8
c_func
(paren
id|bp-&gt;cfg_data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rev
op_ne
id|BANDIT_REVID
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Unknown revision %d for bandit at %p&bslash;n&quot;
comma
id|rev
comma
id|bp-&gt;io_base
)paren
suffix:semicolon
multiline_comment|/* read the word at offset 0x50 */
id|out_le32
c_func
(paren
id|bp-&gt;cfg_addr
comma
(paren
l_int|1UL
op_lshift
id|BANDIT_DEVNUM
)paren
op_plus
id|BANDIT_MAGIC
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|magic
op_assign
id|in_le32
c_func
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
id|bp-&gt;cfg_data
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|magic
op_amp
id|BANDIT_COHERENT
)paren
op_ne
l_int|0
)paren
r_return
suffix:semicolon
id|magic
op_or_assign
id|BANDIT_COHERENT
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|out_le32
c_func
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
id|bp-&gt;cfg_data
comma
id|magic
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Cache coherency enabled for bandit/PSX at %p&bslash;n&quot;
comma
id|bp-&gt;io_base
)paren
suffix:semicolon
)brace
DECL|function|pmac_find_bridges
r_int
r_int
id|pmac_find_bridges
c_func
(paren
r_int
r_int
id|mem_start
comma
r_int
r_int
id|mem_end
)paren
(brace
r_int
id|bus
suffix:semicolon
r_struct
id|bridge_data
op_star
id|bridge
suffix:semicolon
id|bridge_list
op_assign
l_int|0
suffix:semicolon
id|max_bus
op_assign
l_int|0
suffix:semicolon
id|add_bridges
c_func
(paren
id|find_devices
c_func
(paren
l_string|&quot;bandit&quot;
)paren
comma
op_amp
id|mem_start
)paren
suffix:semicolon
id|add_bridges
c_func
(paren
id|find_devices
c_func
(paren
l_string|&quot;chaos&quot;
)paren
comma
op_amp
id|mem_start
)paren
suffix:semicolon
id|bridges
op_assign
(paren
r_struct
id|bridge_data
op_star
op_star
)paren
id|mem_start
suffix:semicolon
id|mem_start
op_add_assign
(paren
id|max_bus
op_plus
l_int|1
)paren
op_star
r_sizeof
(paren
r_struct
id|bridge_data
op_star
)paren
suffix:semicolon
id|memset
c_func
(paren
id|bridges
comma
l_int|0
comma
(paren
id|max_bus
op_plus
l_int|1
)paren
op_star
r_sizeof
(paren
r_struct
id|bridge_data
op_star
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|bridge
op_assign
id|bridge_list
suffix:semicolon
id|bridge
op_ne
l_int|NULL
suffix:semicolon
id|bridge
op_assign
id|bridge-&gt;next
)paren
r_for
c_loop
(paren
id|bus
op_assign
id|bridge-&gt;bus_number
suffix:semicolon
id|bus
op_le
id|bridge-&gt;max_bus
suffix:semicolon
op_increment
id|bus
)paren
id|bridges
(braket
id|bus
)braket
op_assign
id|bridge
suffix:semicolon
r_return
id|mem_start
suffix:semicolon
)brace
DECL|function|add_bridges
r_static
r_void
id|add_bridges
c_func
(paren
r_struct
id|device_node
op_star
id|dev
comma
r_int
r_int
op_star
id|mem_ptr
)paren
(brace
r_int
op_star
id|bus_range
suffix:semicolon
r_int
id|len
suffix:semicolon
r_struct
id|bridge_data
op_star
id|bp
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|dev
op_ne
l_int|NULL
suffix:semicolon
id|dev
op_assign
id|dev-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;n_addrs
OL
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Can&squot;t use %s: no address&bslash;n&quot;
comma
id|dev-&gt;full_name
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|bus_range
op_assign
(paren
r_int
op_star
)paren
id|get_property
c_func
(paren
id|dev
comma
l_string|&quot;bus-range&quot;
comma
op_amp
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bus_range
op_eq
l_int|NULL
op_logical_or
id|len
OL
l_int|2
op_star
r_sizeof
(paren
r_int
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Can&squot;t get bus-range for %s&bslash;n&quot;
comma
id|dev-&gt;full_name
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bus_range
(braket
l_int|1
)braket
op_eq
id|bus_range
(braket
l_int|0
)braket
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PCI bus %d&quot;
comma
id|bus_range
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PCI buses %d..%d&quot;
comma
id|bus_range
(braket
l_int|0
)braket
comma
id|bus_range
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; controlled by %s at %x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
)paren
suffix:semicolon
id|bp
op_assign
(paren
r_struct
id|bridge_data
op_star
)paren
op_star
id|mem_ptr
suffix:semicolon
op_star
id|mem_ptr
op_add_assign
r_sizeof
(paren
r_struct
id|bridge_data
)paren
suffix:semicolon
id|bp-&gt;cfg_addr
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
(paren
id|dev-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
op_plus
l_int|0x800000
)paren
suffix:semicolon
id|bp-&gt;cfg_data
op_assign
(paren
r_volatile
r_int
r_char
op_star
)paren
(paren
id|dev-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
op_plus
l_int|0xc00000
)paren
suffix:semicolon
id|bp-&gt;io_base
op_assign
(paren
r_void
op_star
)paren
id|dev-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
suffix:semicolon
id|ioremap
c_func
(paren
id|dev-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
comma
l_int|0x800000
)paren
suffix:semicolon
id|bp-&gt;bus_number
op_assign
id|bus_range
(braket
l_int|0
)braket
suffix:semicolon
id|bp-&gt;max_bus
op_assign
id|bus_range
(braket
l_int|1
)braket
suffix:semicolon
id|bp-&gt;next
op_assign
id|bridge_list
suffix:semicolon
id|bp-&gt;node
op_assign
id|dev
suffix:semicolon
id|bridge_list
op_assign
id|bp
suffix:semicolon
r_if
c_cond
(paren
id|bp-&gt;max_bus
OG
id|max_bus
)paren
id|max_bus
op_assign
id|bp-&gt;max_bus
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|dev-&gt;name
comma
l_string|&quot;bandit&quot;
)paren
op_eq
l_int|0
)paren
id|init_bandit
c_func
(paren
id|bp
)paren
suffix:semicolon
)brace
)brace
DECL|function|pci_io_base
r_void
op_star
id|pci_io_base
c_func
(paren
r_int
r_int
id|bus
)paren
(brace
r_struct
id|bridge_data
op_star
id|bp
suffix:semicolon
r_if
c_cond
(paren
id|bus
OG
id|max_bus
op_logical_or
(paren
id|bp
op_assign
id|bridges
(braket
id|bus
)braket
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_return
id|bp-&gt;io_base
suffix:semicolon
)brace
DECL|function|pci_device_loc
r_int
id|pci_device_loc
c_func
(paren
r_struct
id|device_node
op_star
id|dev
comma
r_int
r_char
op_star
id|bus_ptr
comma
r_int
r_char
op_star
id|devfn_ptr
)paren
(brace
r_int
r_int
op_star
id|reg
suffix:semicolon
r_int
id|len
suffix:semicolon
id|reg
op_assign
(paren
r_int
r_int
op_star
)paren
id|get_property
c_func
(paren
id|dev
comma
l_string|&quot;reg&quot;
comma
op_amp
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_eq
l_int|0
op_logical_or
id|len
OL
l_int|5
op_star
r_sizeof
(paren
r_int
r_int
)paren
)paren
(brace
multiline_comment|/* doesn&squot;t look like a PCI device */
op_star
id|bus_ptr
op_assign
l_int|0xff
suffix:semicolon
op_star
id|devfn_ptr
op_assign
l_int|0xff
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
op_star
id|bus_ptr
op_assign
id|reg
(braket
l_int|0
)braket
op_rshift
l_int|16
suffix:semicolon
op_star
id|devfn_ptr
op_assign
id|reg
(braket
l_int|0
)braket
op_rshift
l_int|8
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pmac_pcibios_read_config_byte
r_int
id|pmac_pcibios_read_config_byte
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev_fn
comma
r_int
r_char
id|offset
comma
r_int
r_char
op_star
id|val
)paren
(brace
r_struct
id|bridge_data
op_star
id|bp
suffix:semicolon
op_star
id|val
op_assign
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|bus
OG
id|max_bus
op_logical_or
(paren
id|bp
op_assign
id|bridges
(braket
id|bus
)braket
)paren
op_eq
l_int|0
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
r_if
c_cond
(paren
id|bus
op_eq
id|bp-&gt;bus_number
)paren
(brace
r_if
c_cond
(paren
id|dev_fn
OL
(paren
l_int|11
op_lshift
l_int|3
)paren
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
id|out_le32
c_func
(paren
id|bp-&gt;cfg_addr
comma
(paren
l_int|1UL
op_lshift
(paren
id|dev_fn
op_rshift
l_int|3
)paren
)paren
op_plus
(paren
(paren
id|dev_fn
op_amp
l_int|7
)paren
op_lshift
l_int|8
)paren
op_plus
(paren
id|offset
op_amp
op_complement
l_int|3
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|out_le32
c_func
(paren
id|bp-&gt;cfg_addr
comma
(paren
id|dev_fn
op_lshift
l_int|8
)paren
op_plus
(paren
id|offset
op_amp
op_complement
l_int|3
)paren
op_plus
l_int|1
)paren
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
op_star
id|val
op_assign
id|in_8
c_func
(paren
id|bp-&gt;cfg_data
op_plus
(paren
id|offset
op_amp
l_int|3
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_eq
id|PCI_INTERRUPT_LINE
)paren
(brace
multiline_comment|/*&n;&t;&t; * Open Firmware often doesn&squot;t initialize this&n;&t;&t; * register properly, so we find the node and see&n;&t;&t; * if it has an AAPL,interrupts property.&n;&t;&t; */
r_struct
id|device_node
op_star
id|node
suffix:semicolon
r_int
r_int
op_star
id|reg
suffix:semicolon
r_for
c_loop
(paren
id|node
op_assign
id|bp-&gt;node-&gt;child
suffix:semicolon
id|node
op_ne
l_int|0
suffix:semicolon
id|node
op_assign
id|node-&gt;sibling
)paren
(brace
id|reg
op_assign
(paren
r_int
r_int
op_star
)paren
id|get_property
c_func
(paren
id|node
comma
l_string|&quot;reg&quot;
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_eq
l_int|0
op_logical_or
(paren
(paren
id|reg
(braket
l_int|0
)braket
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
op_ne
id|dev_fn
)paren
r_continue
suffix:semicolon
multiline_comment|/* this is the node, see if it has interrupts */
r_if
c_cond
(paren
id|node-&gt;n_intrs
OG
l_int|0
)paren
op_star
id|val
op_assign
id|node-&gt;intrs
(braket
l_int|0
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|pmac_pcibios_read_config_word
r_int
id|pmac_pcibios_read_config_word
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev_fn
comma
r_int
r_char
id|offset
comma
r_int
r_int
op_star
id|val
)paren
(brace
r_struct
id|bridge_data
op_star
id|bp
suffix:semicolon
op_star
id|val
op_assign
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
id|bus
OG
id|max_bus
op_logical_or
(paren
id|bp
op_assign
id|bridges
(braket
id|bus
)braket
)paren
op_eq
l_int|0
op_logical_or
(paren
id|offset
op_amp
l_int|1
)paren
op_ne
l_int|0
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
r_if
c_cond
(paren
id|bus
op_eq
id|bp-&gt;bus_number
)paren
(brace
r_if
c_cond
(paren
id|dev_fn
OL
(paren
l_int|11
op_lshift
l_int|3
)paren
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
id|out_le32
c_func
(paren
id|bp-&gt;cfg_addr
comma
(paren
l_int|1UL
op_lshift
(paren
id|dev_fn
op_rshift
l_int|3
)paren
)paren
op_plus
(paren
(paren
id|dev_fn
op_amp
l_int|7
)paren
op_lshift
l_int|8
)paren
op_plus
(paren
id|offset
op_amp
op_complement
l_int|3
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|out_le32
c_func
(paren
id|bp-&gt;cfg_addr
comma
(paren
id|dev_fn
op_lshift
l_int|8
)paren
op_plus
(paren
id|offset
op_amp
op_complement
l_int|3
)paren
op_plus
l_int|1
)paren
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
op_star
id|val
op_assign
id|in_le16
c_func
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
(paren
id|bp-&gt;cfg_data
op_plus
(paren
id|offset
op_amp
l_int|3
)paren
)paren
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|pmac_pcibios_read_config_dword
r_int
id|pmac_pcibios_read_config_dword
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev_fn
comma
r_int
r_char
id|offset
comma
r_int
r_int
op_star
id|val
)paren
(brace
r_struct
id|bridge_data
op_star
id|bp
suffix:semicolon
op_star
id|val
op_assign
l_int|0xffffffff
suffix:semicolon
r_if
c_cond
(paren
id|bus
OG
id|max_bus
op_logical_or
(paren
id|bp
op_assign
id|bridges
(braket
id|bus
)braket
)paren
op_eq
l_int|0
op_logical_or
(paren
id|offset
op_amp
l_int|3
)paren
op_ne
l_int|0
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
r_if
c_cond
(paren
id|bus
op_eq
id|bp-&gt;bus_number
)paren
(brace
r_if
c_cond
(paren
id|dev_fn
OL
(paren
l_int|11
op_lshift
l_int|3
)paren
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
id|out_le32
c_func
(paren
id|bp-&gt;cfg_addr
comma
(paren
l_int|1UL
op_lshift
(paren
id|dev_fn
op_rshift
l_int|3
)paren
)paren
op_plus
(paren
(paren
id|dev_fn
op_amp
l_int|7
)paren
op_lshift
l_int|8
)paren
op_plus
id|offset
)paren
suffix:semicolon
)brace
r_else
(brace
id|out_le32
c_func
(paren
id|bp-&gt;cfg_addr
comma
(paren
id|dev_fn
op_lshift
l_int|8
)paren
op_plus
id|offset
op_plus
l_int|1
)paren
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
op_star
id|val
op_assign
id|in_le32
c_func
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
id|bp-&gt;cfg_data
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|pmac_pcibios_write_config_byte
r_int
id|pmac_pcibios_write_config_byte
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev_fn
comma
r_int
r_char
id|offset
comma
r_int
r_char
id|val
)paren
(brace
r_struct
id|bridge_data
op_star
id|bp
suffix:semicolon
r_if
c_cond
(paren
id|bus
OG
id|max_bus
op_logical_or
(paren
id|bp
op_assign
id|bridges
(braket
id|bus
)braket
)paren
op_eq
l_int|0
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
r_if
c_cond
(paren
id|bus
op_eq
id|bp-&gt;bus_number
)paren
(brace
r_if
c_cond
(paren
id|dev_fn
OL
(paren
l_int|11
op_lshift
l_int|3
)paren
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
id|out_le32
c_func
(paren
id|bp-&gt;cfg_addr
comma
(paren
l_int|1UL
op_lshift
(paren
id|dev_fn
op_rshift
l_int|3
)paren
)paren
op_plus
(paren
(paren
id|dev_fn
op_amp
l_int|7
)paren
op_lshift
l_int|8
)paren
op_plus
(paren
id|offset
op_amp
op_complement
l_int|3
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|out_le32
c_func
(paren
id|bp-&gt;cfg_addr
comma
(paren
id|dev_fn
op_lshift
l_int|8
)paren
op_plus
(paren
id|offset
op_amp
op_complement
l_int|3
)paren
op_plus
l_int|1
)paren
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|bp-&gt;cfg_data
op_plus
(paren
id|offset
op_amp
l_int|3
)paren
comma
id|val
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|pmac_pcibios_write_config_word
r_int
id|pmac_pcibios_write_config_word
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev_fn
comma
r_int
r_char
id|offset
comma
r_int
r_int
id|val
)paren
(brace
r_struct
id|bridge_data
op_star
id|bp
suffix:semicolon
r_if
c_cond
(paren
id|bus
OG
id|max_bus
op_logical_or
(paren
id|bp
op_assign
id|bridges
(braket
id|bus
)braket
)paren
op_eq
l_int|0
op_logical_or
(paren
id|offset
op_amp
l_int|1
)paren
op_ne
l_int|0
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
r_if
c_cond
(paren
id|bus
op_eq
id|bp-&gt;bus_number
)paren
(brace
r_if
c_cond
(paren
id|dev_fn
OL
(paren
l_int|11
op_lshift
l_int|3
)paren
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
id|out_le32
c_func
(paren
id|bp-&gt;cfg_addr
comma
(paren
l_int|1UL
op_lshift
(paren
id|dev_fn
op_rshift
l_int|3
)paren
)paren
op_plus
(paren
(paren
id|dev_fn
op_amp
l_int|7
)paren
op_lshift
l_int|8
)paren
op_plus
(paren
id|offset
op_amp
op_complement
l_int|3
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|out_le32
c_func
(paren
id|bp-&gt;cfg_addr
comma
(paren
id|dev_fn
op_lshift
l_int|8
)paren
op_plus
(paren
id|offset
op_amp
op_complement
l_int|3
)paren
op_plus
l_int|1
)paren
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|out_le16
c_func
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
(paren
id|bp-&gt;cfg_data
op_plus
(paren
id|offset
op_amp
l_int|3
)paren
)paren
comma
id|val
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|pmac_pcibios_write_config_dword
r_int
id|pmac_pcibios_write_config_dword
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev_fn
comma
r_int
r_char
id|offset
comma
r_int
r_int
id|val
)paren
(brace
r_struct
id|bridge_data
op_star
id|bp
suffix:semicolon
r_if
c_cond
(paren
id|bus
OG
id|max_bus
op_logical_or
(paren
id|bp
op_assign
id|bridges
(braket
id|bus
)braket
)paren
op_eq
l_int|0
op_logical_or
(paren
id|offset
op_amp
l_int|3
)paren
op_ne
l_int|0
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
r_if
c_cond
(paren
id|bus
op_eq
id|bp-&gt;bus_number
)paren
(brace
r_if
c_cond
(paren
id|dev_fn
OL
(paren
l_int|11
op_lshift
l_int|3
)paren
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
id|out_le32
c_func
(paren
id|bp-&gt;cfg_addr
comma
(paren
l_int|1UL
op_lshift
(paren
id|dev_fn
op_rshift
l_int|3
)paren
)paren
op_plus
(paren
(paren
id|dev_fn
op_amp
l_int|7
)paren
op_lshift
l_int|8
)paren
op_plus
id|offset
)paren
suffix:semicolon
)brace
r_else
(brace
id|out_le32
c_func
(paren
id|bp-&gt;cfg_addr
comma
(paren
id|dev_fn
op_lshift
l_int|8
)paren
op_plus
id|offset
op_plus
l_int|1
)paren
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|out_le32
c_func
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
id|bp-&gt;cfg_data
comma
id|val
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|pmac_pcibios_find_device
r_int
id|pmac_pcibios_find_device
c_func
(paren
r_int
r_int
id|vendor
comma
r_int
r_int
id|dev_id
comma
r_int
r_int
id|index
comma
r_int
r_char
op_star
id|bus_ptr
comma
r_int
r_char
op_star
id|dev_fn_ptr
)paren
(brace
r_int
id|bus
comma
id|unit
comma
id|fn
comma
id|num
comma
id|devfn
suffix:semicolon
r_int
r_int
id|x
comma
id|vendev
suffix:semicolon
r_int
r_char
id|h
suffix:semicolon
r_if
c_cond
(paren
id|vendor
op_eq
l_int|0xffff
)paren
r_return
id|PCIBIOS_BAD_VENDOR_ID
suffix:semicolon
id|vendev
op_assign
(paren
id|dev_id
op_lshift
l_int|16
)paren
op_plus
id|vendor
suffix:semicolon
id|num
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|bus
op_assign
l_int|0
suffix:semicolon
id|bus
op_le
id|max_bus
suffix:semicolon
op_increment
id|bus
)paren
(brace
r_if
c_cond
(paren
id|bridges
(braket
id|bus
)braket
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
id|unit
op_assign
id|fn
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|bus
op_eq
id|bridges
(braket
id|bus
)braket
op_member_access_from_pointer
id|bus_number
)paren
id|unit
op_assign
l_int|11
suffix:semicolon
r_while
c_loop
(paren
id|unit
OL
l_int|32
)paren
(brace
id|devfn
op_assign
id|PCI_DEVFN
c_func
(paren
id|unit
comma
id|fn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcibios_read_config_dword
c_func
(paren
id|bus
comma
id|devfn
comma
id|PCI_VENDOR_ID
comma
op_amp
id|x
)paren
op_eq
id|PCIBIOS_SUCCESSFUL
op_logical_and
id|x
op_eq
id|vendev
)paren
(brace
r_if
c_cond
(paren
id|index
op_eq
id|num
)paren
(brace
op_star
id|bus_ptr
op_assign
id|bus
suffix:semicolon
op_star
id|dev_fn_ptr
op_assign
id|devfn
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
op_increment
id|num
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fn
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_increment
id|fn
op_ge
l_int|8
)paren
(brace
op_increment
id|unit
suffix:semicolon
id|fn
op_assign
l_int|0
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pcibios_read_config_byte
c_func
(paren
id|bus
comma
id|devfn
comma
id|PCI_HEADER_TYPE
comma
op_amp
id|h
)paren
op_eq
id|PCIBIOS_SUCCESSFUL
op_logical_and
(paren
id|h
op_amp
l_int|0x80
)paren
op_ne
l_int|0
)paren
op_increment
id|fn
suffix:semicolon
r_else
op_increment
id|unit
suffix:semicolon
)brace
)brace
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
)brace
DECL|function|pmac_pcibios_find_class
r_int
id|pmac_pcibios_find_class
c_func
(paren
r_int
r_int
id|class_code
comma
r_int
r_int
id|index
comma
r_int
r_char
op_star
id|bus_ptr
comma
r_int
r_char
op_star
id|dev_fn_ptr
)paren
(brace
r_int
id|bus
comma
id|unit
comma
id|fn
comma
id|num
comma
id|devfn
suffix:semicolon
r_int
r_int
id|x
suffix:semicolon
r_int
r_char
id|h
suffix:semicolon
id|num
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|bus
op_assign
l_int|0
suffix:semicolon
id|bus
op_le
id|max_bus
suffix:semicolon
op_increment
id|bus
)paren
(brace
r_if
c_cond
(paren
id|bridges
(braket
id|bus
)braket
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
id|unit
op_assign
id|fn
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|bus
op_eq
id|bridges
(braket
id|bus
)braket
op_member_access_from_pointer
id|bus_number
)paren
id|unit
op_assign
l_int|11
suffix:semicolon
r_while
c_loop
(paren
id|unit
OL
l_int|32
)paren
(brace
id|devfn
op_assign
id|PCI_DEVFN
c_func
(paren
id|unit
comma
id|fn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcibios_read_config_dword
c_func
(paren
id|bus
comma
id|devfn
comma
id|PCI_CLASS_REVISION
comma
op_amp
id|x
)paren
op_eq
id|PCIBIOS_SUCCESSFUL
op_logical_and
(paren
id|x
op_rshift
l_int|8
)paren
op_eq
id|class_code
)paren
(brace
r_if
c_cond
(paren
id|index
op_eq
id|num
)paren
(brace
op_star
id|bus_ptr
op_assign
id|bus
suffix:semicolon
op_star
id|dev_fn_ptr
op_assign
id|devfn
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
op_increment
id|num
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fn
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_increment
id|fn
op_ge
l_int|8
)paren
(brace
op_increment
id|unit
suffix:semicolon
id|fn
op_assign
l_int|0
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pcibios_read_config_byte
c_func
(paren
id|bus
comma
id|devfn
comma
id|PCI_HEADER_TYPE
comma
op_amp
id|h
)paren
op_eq
id|PCIBIOS_SUCCESSFUL
op_logical_and
(paren
id|h
op_amp
l_int|0x80
)paren
op_ne
l_int|0
)paren
op_increment
id|fn
suffix:semicolon
r_else
op_increment
id|unit
suffix:semicolon
)brace
)brace
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
r_int
id|route_pci_interrupts
c_func
(paren
r_void
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
eof
