multiline_comment|/*&n; * CHRP pci routines.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/bios32.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/openpic.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/hydra.h&gt;
multiline_comment|/* LongTrail */
DECL|macro|pci_config_addr
mdefine_line|#define pci_config_addr(bus, dev, offset) &bslash;&n;&t;(0xfec00000 | ((bus)&lt;&lt;16) | ((dev)&lt;&lt;8) | (offset))
DECL|function|chrp_pcibios_read_config_byte
r_int
id|chrp_pcibios_read_config_byte
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev_fn
comma
r_int
r_char
id|offset
comma
r_int
r_char
op_star
id|val
)paren
(brace
r_if
c_cond
(paren
id|bus
OG
l_int|7
)paren
(brace
op_star
id|val
op_assign
l_int|0xff
suffix:semicolon
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
)brace
op_star
id|val
op_assign
id|in_8
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|pci_config_addr
c_func
(paren
id|bus
comma
id|dev_fn
comma
id|offset
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_eq
id|PCI_INTERRUPT_LINE
)paren
(brace
multiline_comment|/* PCI interrupts are controlled by the OpenPIC */
r_if
c_cond
(paren
op_star
id|val
)paren
op_star
id|val
op_assign
id|openpic_to_irq
c_func
(paren
op_star
id|val
)paren
suffix:semicolon
)brace
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|chrp_pcibios_read_config_word
r_int
id|chrp_pcibios_read_config_word
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev_fn
comma
r_int
r_char
id|offset
comma
r_int
r_int
op_star
id|val
)paren
(brace
r_if
c_cond
(paren
id|bus
OG
l_int|7
)paren
(brace
op_star
id|val
op_assign
l_int|0xffff
suffix:semicolon
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
)brace
op_star
id|val
op_assign
id|in_le16
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|pci_config_addr
c_func
(paren
id|bus
comma
id|dev_fn
comma
id|offset
)paren
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|chrp_pcibios_read_config_dword
r_int
id|chrp_pcibios_read_config_dword
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev_fn
comma
r_int
r_char
id|offset
comma
r_int
r_int
op_star
id|val
)paren
(brace
r_if
c_cond
(paren
id|bus
OG
l_int|7
)paren
(brace
op_star
id|val
op_assign
l_int|0xffffffff
suffix:semicolon
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
)brace
op_star
id|val
op_assign
id|in_le32
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|pci_config_addr
c_func
(paren
id|bus
comma
id|dev_fn
comma
id|offset
)paren
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|chrp_pcibios_write_config_byte
r_int
id|chrp_pcibios_write_config_byte
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev_fn
comma
r_int
r_char
id|offset
comma
r_int
r_char
id|val
)paren
(brace
r_if
c_cond
(paren
id|bus
OG
l_int|7
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
id|out_8
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|pci_config_addr
c_func
(paren
id|bus
comma
id|dev_fn
comma
id|offset
)paren
comma
id|val
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|chrp_pcibios_write_config_word
r_int
id|chrp_pcibios_write_config_word
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev_fn
comma
r_int
r_char
id|offset
comma
r_int
r_int
id|val
)paren
(brace
r_if
c_cond
(paren
id|bus
OG
l_int|7
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
id|out_le16
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|pci_config_addr
c_func
(paren
id|bus
comma
id|dev_fn
comma
id|offset
)paren
comma
id|val
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|chrp_pcibios_write_config_dword
r_int
id|chrp_pcibios_write_config_dword
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev_fn
comma
r_int
r_char
id|offset
comma
r_int
r_int
id|val
)paren
(brace
r_if
c_cond
(paren
id|bus
OG
l_int|7
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
id|out_le32
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|pci_config_addr
c_func
(paren
id|bus
comma
id|dev_fn
comma
id|offset
)paren
comma
id|val
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|chrp_pcibios_find_device
r_int
id|chrp_pcibios_find_device
c_func
(paren
r_int
r_int
id|vendor
comma
r_int
r_int
id|dev_id
comma
r_int
r_int
id|index
comma
r_int
r_char
op_star
id|bus_ptr
comma
r_int
r_char
op_star
id|dev_fn_ptr
)paren
(brace
r_int
id|num
comma
id|devfn
suffix:semicolon
r_int
r_int
id|x
comma
id|vendev
suffix:semicolon
r_if
c_cond
(paren
id|vendor
op_eq
l_int|0xffff
)paren
r_return
id|PCIBIOS_BAD_VENDOR_ID
suffix:semicolon
id|vendev
op_assign
(paren
id|dev_id
op_lshift
l_int|16
)paren
op_plus
id|vendor
suffix:semicolon
id|num
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|devfn
op_assign
l_int|0
suffix:semicolon
id|devfn
OL
l_int|32
suffix:semicolon
id|devfn
op_increment
)paren
(brace
id|chrp_pcibios_read_config_dword
c_func
(paren
l_int|0
comma
id|devfn
op_lshift
l_int|3
comma
id|PCI_VENDOR_ID
comma
op_amp
id|x
)paren
suffix:semicolon
r_if
c_cond
(paren
id|x
op_eq
id|vendev
)paren
(brace
r_if
c_cond
(paren
id|index
op_eq
id|num
)paren
(brace
op_star
id|bus_ptr
op_assign
l_int|0
suffix:semicolon
op_star
id|dev_fn_ptr
op_assign
id|devfn
op_lshift
l_int|3
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
op_increment
id|num
suffix:semicolon
)brace
)brace
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
)brace
DECL|function|chrp_pcibios_find_class
r_int
id|chrp_pcibios_find_class
c_func
(paren
r_int
r_int
id|class_code
comma
r_int
r_int
id|index
comma
r_int
r_char
op_star
id|bus_ptr
comma
r_int
r_char
op_star
id|dev_fn_ptr
)paren
(brace
r_int
id|devnr
comma
id|x
comma
id|num
suffix:semicolon
id|num
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|devnr
op_assign
l_int|0
suffix:semicolon
id|devnr
OL
l_int|32
suffix:semicolon
id|devnr
op_increment
)paren
(brace
id|chrp_pcibios_read_config_dword
c_func
(paren
l_int|0
comma
id|devnr
op_lshift
l_int|3
comma
id|PCI_CLASS_REVISION
comma
op_amp
id|x
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|x
op_rshift
l_int|8
)paren
op_eq
id|class_code
)paren
(brace
r_if
c_cond
(paren
id|index
op_eq
id|num
)paren
(brace
op_star
id|bus_ptr
op_assign
l_int|0
suffix:semicolon
op_star
id|dev_fn_ptr
op_assign
id|devnr
op_lshift
l_int|3
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
op_increment
id|num
suffix:semicolon
)brace
)brace
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_volatile
r_struct
id|Hydra
op_star
id|find_hydra
c_func
(paren
r_void
)paren
)paren
(brace
id|u_char
id|bus
comma
id|dev
suffix:semicolon
r_volatile
r_struct
id|Hydra
op_star
id|hydra
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|chrp_pcibios_find_device
c_func
(paren
id|PCI_VENDOR_ID_APPLE
comma
id|PCI_DEVICE_ID_APPLE_HYDRA
comma
l_int|0
comma
op_amp
id|bus
comma
op_amp
id|dev
)paren
op_eq
id|PCIBIOS_SUCCESSFUL
)paren
id|chrp_pcibios_read_config_dword
c_func
(paren
id|bus
comma
id|dev
comma
id|PCI_BASE_ADDRESS_0
comma
(paren
r_int
r_int
op_star
)paren
op_amp
id|hydra
)paren
suffix:semicolon
r_return
id|hydra
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|hydra_post_openpic_init
c_func
(paren
r_void
)paren
)paren
(brace
id|openpic_set_sense
c_func
(paren
id|HYDRA_INT_SCSI_DMA
comma
l_int|0
)paren
suffix:semicolon
id|openpic_set_sense
c_func
(paren
id|HYDRA_INT_SCCA_TX_DMA
comma
l_int|0
)paren
suffix:semicolon
id|openpic_set_sense
c_func
(paren
id|HYDRA_INT_SCCA_RX_DMA
comma
l_int|0
)paren
suffix:semicolon
id|openpic_set_sense
c_func
(paren
id|HYDRA_INT_SCCB_TX_DMA
comma
l_int|0
)paren
suffix:semicolon
id|openpic_set_sense
c_func
(paren
id|HYDRA_INT_SCCB_RX_DMA
comma
l_int|0
)paren
suffix:semicolon
id|openpic_set_sense
c_func
(paren
id|HYDRA_INT_SCSI
comma
l_int|1
)paren
suffix:semicolon
id|openpic_set_sense
c_func
(paren
id|HYDRA_INT_SCCA
comma
l_int|1
)paren
suffix:semicolon
id|openpic_set_sense
c_func
(paren
id|HYDRA_INT_SCCB
comma
l_int|1
)paren
suffix:semicolon
id|openpic_set_sense
c_func
(paren
id|HYDRA_INT_VIA
comma
l_int|1
)paren
suffix:semicolon
id|openpic_set_sense
c_func
(paren
id|HYDRA_INT_ADB
comma
l_int|1
)paren
suffix:semicolon
id|openpic_set_sense
c_func
(paren
id|HYDRA_INT_ADB_NMI
comma
l_int|0
)paren
suffix:semicolon
)brace
eof
