multiline_comment|/*&n; * Support for periodic interrupts (100 per second) and for getting&n; * the current time from the RTC on Power Macintoshes.&n; *&n; * At present, we use the decrementer register in the 601 CPU&n; * for our periodic interrupts.  This will probably have to be&n; * changed for other processors.&n; *&n; * Paul Mackerras&t;August 1996.&n; * Copyright (C) 1996 Paul Mackerras.&n; */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/param.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/cuda.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/system.h&gt;
r_static
r_int
id|get_dec
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|set_dec
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_int
r_int
id|get_rtc_time
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/* Apparently the RTC stores seconds since 1 Jan 1904 */
DECL|macro|RTC_OFFSET
mdefine_line|#define RTC_OFFSET&t;2082844800
multiline_comment|/* Accessor functions for the decrementer register. */
r_static
r_inline
r_int
DECL|function|get_dec
id|get_dec
c_func
(paren
)paren
(brace
r_int
id|ret
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;mfspr %0,22&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|ret
)paren
suffix:colon
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|set_dec
id|set_dec
c_func
(paren
r_int
id|val
)paren
(brace
id|asm
r_volatile
(paren
l_string|&quot;mtspr 22,%0&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|val
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* The decrementer counts down by 128 every 128ns on a 601. */
DECL|macro|DECREMENTER_COUNT_601
mdefine_line|#define DECREMENTER_COUNT_601&t;(1000000000 / HZ)
DECL|macro|COUNT_PERIOD_NUM_601
mdefine_line|#define COUNT_PERIOD_NUM_601&t;1
DECL|macro|COUNT_PERIOD_DEN_601
mdefine_line|#define COUNT_PERIOD_DEN_601&t;1000
DECL|variable|decrementer_count
r_int
id|decrementer_count
suffix:semicolon
multiline_comment|/* count value for 1e6/HZ microseconds */
DECL|variable|count_period_num
r_int
id|count_period_num
suffix:semicolon
multiline_comment|/* 1 decrementer count equals */
DECL|variable|count_period_den
r_int
id|count_period_den
suffix:semicolon
multiline_comment|/* count_period_num / count_period_den us */
multiline_comment|/*&n; * This version of gettimeofday has microsecond resolution.&n; */
DECL|function|do_gettimeofday
r_void
id|do_gettimeofday
c_func
(paren
r_struct
id|timeval
op_star
id|tv
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
op_star
id|tv
op_assign
id|xtime
suffix:semicolon
id|tv-&gt;tv_usec
op_add_assign
(paren
id|decrementer_count
op_minus
id|get_dec
c_func
(paren
)paren
)paren
op_star
id|count_period_num
op_div
id|count_period_den
suffix:semicolon
r_if
c_cond
(paren
id|tv-&gt;tv_usec
op_ge
l_int|1000000
)paren
(brace
id|tv-&gt;tv_usec
op_sub_assign
l_int|1000000
suffix:semicolon
id|tv-&gt;tv_sec
op_increment
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|do_settimeofday
r_void
id|do_settimeofday
c_func
(paren
r_struct
id|timeval
op_star
id|tv
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|frac_tick
suffix:semicolon
id|frac_tick
op_assign
id|tv-&gt;tv_usec
op_mod
(paren
l_int|1000000
op_div
id|HZ
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|xtime.tv_sec
op_assign
id|tv-&gt;tv_sec
suffix:semicolon
id|xtime.tv_usec
op_assign
id|tv-&gt;tv_usec
op_minus
id|frac_tick
suffix:semicolon
id|set_dec
c_func
(paren
id|frac_tick
op_star
id|count_period_den
op_div
id|count_period_num
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * timer_interrupt - gets called when the decrementer overflows,&n; * with interrupts disabled.&n; * We set it up to overflow again in 1/HZ seconds.&n; */
DECL|function|timer_interrupt
r_void
id|timer_interrupt
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|dval
comma
id|d
suffix:semicolon
r_while
c_loop
(paren
(paren
id|dval
op_assign
id|get_dec
c_func
(paren
)paren
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t; * Wait for the decrementer to change, then jump&n;&t;&t; * in and add decrementer_count to its value&n;&t;&t; * (quickly, before it changes again!)&n;&t;&t; */
r_while
c_loop
(paren
(paren
id|d
op_assign
id|get_dec
c_func
(paren
)paren
)paren
op_eq
id|dval
)paren
suffix:semicolon
id|set_dec
c_func
(paren
id|d
op_plus
id|decrementer_count
)paren
suffix:semicolon
id|do_timer
c_func
(paren
id|regs
)paren
suffix:semicolon
)brace
)brace
r_void
DECL|function|time_init
id|time_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|cpu
suffix:semicolon
r_int
id|freq
comma
op_star
id|fp
comma
id|divisor
suffix:semicolon
r_if
c_cond
(paren
(paren
id|_get_PVR
c_func
(paren
)paren
op_rshift
l_int|16
)paren
op_eq
l_int|1
)paren
(brace
multiline_comment|/* 601 processor: dec counts down by 128 every 128ns */
id|decrementer_count
op_assign
id|DECREMENTER_COUNT_601
suffix:semicolon
id|count_period_num
op_assign
id|COUNT_PERIOD_NUM_601
suffix:semicolon
id|count_period_den
op_assign
id|COUNT_PERIOD_DEN_601
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * The cpu node should have a timebase-frequency property&n;&t;&t; * to tell us the rate at which the decrementer counts.&n;&t;&t; */
id|cpu
op_assign
id|find_type_devices
c_func
(paren
l_string|&quot;cpu&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpu
op_eq
l_int|0
)paren
id|panic
c_func
(paren
l_string|&quot;can&squot;t find cpu node in time_init&quot;
)paren
suffix:semicolon
id|fp
op_assign
(paren
r_int
op_star
)paren
id|get_property
c_func
(paren
id|cpu
comma
l_string|&quot;timebase-frequency&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fp
op_eq
l_int|0
)paren
id|panic
c_func
(paren
l_string|&quot;can&squot;t get cpu timebase frequency&quot;
)paren
suffix:semicolon
id|freq
op_assign
op_star
id|fp
op_star
l_int|60
suffix:semicolon
multiline_comment|/* try to make freq/1e6 an integer */
id|divisor
op_assign
l_int|60
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;time_init: decrementer frequency = %d/%d&bslash;n&quot;
comma
id|freq
comma
id|divisor
)paren
suffix:semicolon
id|decrementer_count
op_assign
id|freq
op_div
id|HZ
op_div
id|divisor
suffix:semicolon
id|count_period_num
op_assign
id|divisor
suffix:semicolon
id|count_period_den
op_assign
id|freq
op_div
l_int|1000000
suffix:semicolon
)brace
id|set_dec
c_func
(paren
id|decrementer_count
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * We can&squot;t do this in time_init, because via_cuda_init hasn&squot;t&n; * been called at that stage.&n; */
r_void
DECL|function|read_rtc_time
id|read_rtc_time
c_func
(paren
r_void
)paren
(brace
id|xtime.tv_sec
op_assign
id|get_rtc_time
c_func
(paren
)paren
suffix:semicolon
id|xtime.tv_usec
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_int
r_int
DECL|function|get_rtc_time
id|get_rtc_time
c_func
(paren
)paren
(brace
r_struct
id|cuda_request
id|req
suffix:semicolon
multiline_comment|/* Get the time from the RTC */
id|cuda_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|2
comma
id|CUDA_PACKET
comma
id|CUDA_GET_TIME
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|req.got_reply
)paren
id|cuda_poll
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req.reply_len
op_ne
l_int|7
)paren
id|panic
c_func
(paren
l_string|&quot;get_rtc_time: didn&squot;t expect %d byte reply&quot;
comma
id|req.reply_len
)paren
suffix:semicolon
r_return
(paren
id|req.reply
(braket
l_int|3
)braket
op_lshift
l_int|24
)paren
op_plus
(paren
id|req.reply
(braket
l_int|4
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|req.reply
(braket
l_int|5
)braket
op_lshift
l_int|8
)paren
op_plus
id|req.reply
(braket
l_int|6
)braket
op_minus
id|RTC_OFFSET
suffix:semicolon
)brace
eof
