multiline_comment|/*&n; * Support for periodic interrupts (100 per second) and for getting&n; * the current time from the RTC on Power Macintoshes.&n; *&n; * At present, we use the decrementer register in the 601 CPU&n; * for our periodic interrupts.  This will probably have to be&n; * changed for other processors.&n; *&n; * Paul Mackerras&t;August 1996.&n; * Copyright (C) 1996 Paul Mackerras.&n; */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/param.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/cuda.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &quot;time.h&quot;
multiline_comment|/* Apparently the RTC stores seconds since 1 Jan 1904 */
DECL|macro|RTC_OFFSET
mdefine_line|#define RTC_OFFSET&t;2082844800
multiline_comment|/*&n; * Query the OF and get the decr frequency.&n; * This was taken from the pmac time_init() when merging the prep/pmac&n; * time functions.&n; */
DECL|function|pmac_calibrate_decr
r_void
id|pmac_calibrate_decr
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|cpu
suffix:semicolon
r_int
id|freq
comma
op_star
id|fp
comma
id|divisor
suffix:semicolon
multiline_comment|/*&n;&t; * The cpu node should have a timebase-frequency property&n;&t; * to tell us the rate at which the decrementer counts.&n;&t; */
id|cpu
op_assign
id|find_type_devices
c_func
(paren
l_string|&quot;cpu&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpu
op_eq
l_int|0
)paren
id|panic
c_func
(paren
l_string|&quot;can&squot;t find cpu node in time_init&quot;
)paren
suffix:semicolon
id|fp
op_assign
(paren
r_int
op_star
)paren
id|get_property
c_func
(paren
id|cpu
comma
l_string|&quot;timebase-frequency&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fp
op_eq
l_int|0
)paren
id|panic
c_func
(paren
l_string|&quot;can&squot;t get cpu timebase frequency&quot;
)paren
suffix:semicolon
id|freq
op_assign
op_star
id|fp
op_star
l_int|60
suffix:semicolon
multiline_comment|/* try to make freq/1e6 an integer */
id|divisor
op_assign
l_int|60
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;time_init: decrementer frequency = %d/%d&bslash;n&quot;
comma
id|freq
comma
id|divisor
)paren
suffix:semicolon
id|decrementer_count
op_assign
id|freq
op_div
id|HZ
op_div
id|divisor
suffix:semicolon
id|count_period_num
op_assign
id|divisor
suffix:semicolon
id|count_period_den
op_assign
id|freq
op_div
l_int|1000000
suffix:semicolon
)brace
r_int
r_int
DECL|function|pmac_get_rtc_time
id|pmac_get_rtc_time
c_func
(paren
r_void
)paren
(brace
r_struct
id|cuda_request
id|req
suffix:semicolon
multiline_comment|/* Get the time from the RTC */
id|cuda_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|2
comma
id|CUDA_PACKET
comma
id|CUDA_GET_TIME
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|req.got_reply
)paren
id|cuda_poll
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req.reply_len
op_ne
l_int|7
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;pmac_get_rtc_time: got %d byte reply&bslash;n&quot;
comma
id|req.reply_len
)paren
suffix:semicolon
r_return
(paren
id|req.reply
(braket
l_int|3
)braket
op_lshift
l_int|24
)paren
op_plus
(paren
id|req.reply
(braket
l_int|4
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|req.reply
(braket
l_int|5
)braket
op_lshift
l_int|8
)paren
op_plus
id|req.reply
(braket
l_int|6
)braket
op_minus
id|RTC_OFFSET
suffix:semicolon
)brace
DECL|function|pmac_set_rtc_time
r_int
id|pmac_set_rtc_time
c_func
(paren
r_int
r_int
id|nowtime
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * We can&squot;t do this in time_init, because via_cuda_init hasn&squot;t&n; * been called at that stage.&n; */
r_void
DECL|function|pmac_read_rtc_time
id|pmac_read_rtc_time
c_func
(paren
r_void
)paren
(brace
id|xtime.tv_sec
op_assign
id|pmac_get_rtc_time
c_func
(paren
)paren
suffix:semicolon
id|xtime.tv_usec
op_assign
l_int|0
suffix:semicolon
)brace
eof
