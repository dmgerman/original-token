multiline_comment|/*&n; * Support for periodic interrupts (100 per second) and for getting&n; * the current time from the RTC on Power Macintoshes.&n; *&n; * We use the decrementer register for our periodic interrupts.&n; *&n; * Paul Mackerras&t;August 1996.&n; * Copyright (C) 1996 Paul Mackerras.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/param.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/adb.h&gt;
macro_line|#include &lt;linux/cuda.h&gt;
macro_line|#include &lt;linux/pmu.h&gt;
macro_line|#include &lt;asm/init.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/hardirq.h&gt;
macro_line|#include &lt;asm/time.h&gt;
macro_line|#include &lt;asm/nvram.h&gt;
r_extern
id|rwlock_t
id|xtime_lock
suffix:semicolon
multiline_comment|/* Apparently the RTC stores seconds since 1 Jan 1904 */
DECL|macro|RTC_OFFSET
mdefine_line|#define RTC_OFFSET&t;2082844800
multiline_comment|/*&n; * Calibrate the decrementer frequency with the VIA timer 1.&n; */
DECL|macro|VIA_TIMER_FREQ_6
mdefine_line|#define VIA_TIMER_FREQ_6&t;4700000&t;/* time 1 frequency * 6 */
multiline_comment|/* VIA registers */
DECL|macro|RS
mdefine_line|#define RS&t;&t;0x200&t;&t;/* skip between registers */
DECL|macro|T1CL
mdefine_line|#define T1CL&t;&t;(4*RS)&t;&t;/* Timer 1 ctr/latch (low 8 bits) */
DECL|macro|T1CH
mdefine_line|#define T1CH&t;&t;(5*RS)&t;&t;/* Timer 1 counter (high 8 bits) */
DECL|macro|T1LL
mdefine_line|#define T1LL&t;&t;(6*RS)&t;&t;/* Timer 1 latch (low 8 bits) */
DECL|macro|T1LH
mdefine_line|#define T1LH&t;&t;(7*RS)&t;&t;/* Timer 1 latch (high 8 bits) */
DECL|macro|ACR
mdefine_line|#define ACR&t;&t;(11*RS)&t;&t;/* Auxiliary control register */
DECL|macro|IFR
mdefine_line|#define IFR&t;&t;(13*RS)&t;&t;/* Interrupt flag register */
multiline_comment|/* Bits in ACR */
DECL|macro|T1MODE
mdefine_line|#define T1MODE&t;&t;0xc0&t;&t;/* Timer 1 mode */
DECL|macro|T1MODE_CONT
mdefine_line|#define T1MODE_CONT&t;0x40&t;&t;/*  continuous interrupts */
multiline_comment|/* Bits in IFR and IER */
DECL|macro|T1_INT
mdefine_line|#define T1_INT&t;&t;0x40&t;&t;/* Timer 1 interrupt */
r_extern
r_struct
id|timezone
id|sys_tz
suffix:semicolon
id|__init
DECL|function|pmac_time_init
r_int
id|pmac_time_init
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_NVRAM
id|s32
id|delta
op_assign
l_int|0
suffix:semicolon
r_int
id|dst
suffix:semicolon
id|delta
op_assign
(paren
(paren
id|s32
)paren
id|pmac_xpram_read
c_func
(paren
id|PMAC_XPRAM_MACHINE_LOC
op_plus
l_int|0x9
)paren
)paren
op_lshift
l_int|16
suffix:semicolon
id|delta
op_or_assign
(paren
(paren
id|s32
)paren
id|pmac_xpram_read
c_func
(paren
id|PMAC_XPRAM_MACHINE_LOC
op_plus
l_int|0xa
)paren
)paren
op_lshift
l_int|8
suffix:semicolon
id|delta
op_or_assign
id|pmac_xpram_read
c_func
(paren
id|PMAC_XPRAM_MACHINE_LOC
op_plus
l_int|0xb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|delta
op_amp
l_int|0x00800000UL
)paren
id|delta
op_or_assign
l_int|0xFF000000UL
suffix:semicolon
id|dst
op_assign
(paren
(paren
id|pmac_xpram_read
c_func
(paren
id|PMAC_XPRAM_MACHINE_LOC
op_plus
l_int|0x8
)paren
op_amp
l_int|0x80
)paren
op_ne
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;GMT Delta read from XPRAM: %d minutes, DST: %s&bslash;n&quot;
comma
id|delta
op_div
l_int|60
comma
id|dst
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
)paren
suffix:semicolon
r_return
id|delta
suffix:semicolon
macro_line|#else
r_return
l_int|0
suffix:semicolon
macro_line|#endif
)brace
id|__pmac
DECL|function|pmac_get_rtc_time
r_int
r_int
id|pmac_get_rtc_time
c_func
(paren
r_void
)paren
(brace
macro_line|#if defined(CONFIG_ADB_CUDA) || defined(CONFIG_ADB_PMU)
r_struct
id|adb_request
id|req
suffix:semicolon
r_int
r_int
id|now
suffix:semicolon
macro_line|#endif
multiline_comment|/* Get the time from the RTC */
r_switch
c_cond
(paren
id|sys_ctrler
)paren
(brace
macro_line|#ifdef CONFIG_ADB_CUDA
r_case
id|SYS_CTRLER_CUDA
suffix:colon
r_if
c_cond
(paren
id|cuda_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|2
comma
id|CUDA_PACKET
comma
id|CUDA_GET_TIME
)paren
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|req.complete
)paren
id|cuda_poll
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req.reply_len
op_ne
l_int|7
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;pmac_get_rtc_time: got %d byte reply&bslash;n&quot;
comma
id|req.reply_len
)paren
suffix:semicolon
id|now
op_assign
(paren
id|req.reply
(braket
l_int|3
)braket
op_lshift
l_int|24
)paren
op_plus
(paren
id|req.reply
(braket
l_int|4
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|req.reply
(braket
l_int|5
)braket
op_lshift
l_int|8
)paren
op_plus
id|req.reply
(braket
l_int|6
)braket
suffix:semicolon
r_return
id|now
op_minus
id|RTC_OFFSET
suffix:semicolon
macro_line|#endif /* CONFIG_ADB_CUDA */
macro_line|#ifdef CONFIG_ADB_PMU
r_case
id|SYS_CTRLER_PMU
suffix:colon
r_if
c_cond
(paren
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|1
comma
id|PMU_READ_RTC
)paren
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|req.complete
)paren
id|pmu_poll
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req.reply_len
op_ne
l_int|5
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;pmac_get_rtc_time: got %d byte reply&bslash;n&quot;
comma
id|req.reply_len
)paren
suffix:semicolon
id|now
op_assign
(paren
id|req.reply
(braket
l_int|1
)braket
op_lshift
l_int|24
)paren
op_plus
(paren
id|req.reply
(braket
l_int|2
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|req.reply
(braket
l_int|3
)braket
op_lshift
l_int|8
)paren
op_plus
id|req.reply
(braket
l_int|4
)braket
suffix:semicolon
r_return
id|now
op_minus
id|RTC_OFFSET
suffix:semicolon
macro_line|#endif /* CONFIG_ADB_PMU */
r_default
suffix:colon
(brace
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pmac_set_rtc_time
r_int
id|pmac_set_rtc_time
c_func
(paren
r_int
r_int
id|nowtime
)paren
(brace
macro_line|#if defined(CONFIG_ADB_CUDA) || defined(CONFIG_ADB_PMU)
r_struct
id|adb_request
id|req
suffix:semicolon
macro_line|#endif
id|nowtime
op_add_assign
id|RTC_OFFSET
suffix:semicolon
r_switch
c_cond
(paren
id|sys_ctrler
)paren
(brace
macro_line|#ifdef CONFIG_ADB_CUDA
r_case
id|SYS_CTRLER_CUDA
suffix:colon
r_if
c_cond
(paren
id|cuda_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|6
comma
id|CUDA_PACKET
comma
id|CUDA_SET_TIME
comma
id|nowtime
op_rshift
l_int|24
comma
id|nowtime
op_rshift
l_int|16
comma
id|nowtime
op_rshift
l_int|8
comma
id|nowtime
)paren
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|req.complete
)paren
id|cuda_poll
c_func
(paren
)paren
suffix:semicolon
singleline_comment|//&t;&t;if (req.reply_len != 7)
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;pmac_set_rtc_time: got %d byte reply&bslash;n&quot;
comma
id|req.reply_len
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
macro_line|#endif /* CONFIG_ADB_CUDA */
macro_line|#ifdef CONFIG_ADB_PMU
r_case
id|SYS_CTRLER_PMU
suffix:colon
r_if
c_cond
(paren
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|5
comma
id|PMU_SET_RTC
comma
id|nowtime
op_rshift
l_int|24
comma
id|nowtime
op_rshift
l_int|16
comma
id|nowtime
op_rshift
l_int|8
comma
id|nowtime
)paren
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|req.complete
)paren
id|pmu_poll
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req.reply_len
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;pmac_set_rtc_time: got %d byte reply&bslash;n&quot;
comma
id|req.reply_len
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
macro_line|#endif /* CONFIG_ADB_PMU */
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Calibrate the decrementer register using VIA timer 1.&n; * This is used both on powermacs and CHRP machines.&n; */
DECL|function|via_calibrate_decr
r_int
id|__init
id|via_calibrate_decr
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|vias
suffix:semicolon
r_volatile
r_int
r_char
op_star
id|via
suffix:semicolon
r_int
id|count
op_assign
id|VIA_TIMER_FREQ_6
op_div
id|HZ
suffix:semicolon
r_int
r_int
id|dstart
comma
id|dend
suffix:semicolon
id|vias
op_assign
id|find_devices
c_func
(paren
l_string|&quot;via-cuda&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vias
op_eq
l_int|0
)paren
id|vias
op_assign
id|find_devices
c_func
(paren
l_string|&quot;via-pmu&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vias
op_eq
l_int|0
)paren
id|vias
op_assign
id|find_devices
c_func
(paren
l_string|&quot;via&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vias
op_eq
l_int|0
op_logical_or
id|vias-&gt;n_addrs
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|via
op_assign
(paren
r_volatile
r_int
r_char
op_star
)paren
id|ioremap
c_func
(paren
id|vias-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
comma
id|vias-&gt;addrs
(braket
l_int|0
)braket
dot
id|size
)paren
suffix:semicolon
multiline_comment|/* set timer 1 for continuous interrupts */
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|ACR
)braket
comma
(paren
id|via
(braket
id|ACR
)braket
op_amp
op_complement
id|T1MODE
)paren
op_or
id|T1MODE_CONT
)paren
suffix:semicolon
multiline_comment|/* set the counter to a small value */
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|T1CH
)braket
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* set the latch to `count&squot; */
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|T1LL
)braket
comma
id|count
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|T1LH
)braket
comma
id|count
op_rshift
l_int|8
)paren
suffix:semicolon
multiline_comment|/* wait until it hits 0 */
r_while
c_loop
(paren
(paren
id|in_8
c_func
(paren
op_amp
id|via
(braket
id|IFR
)braket
)paren
op_amp
id|T1_INT
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|dstart
op_assign
id|get_dec
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* clear the interrupt &amp; wait until it hits 0 again */
id|in_8
c_func
(paren
op_amp
id|via
(braket
id|T1CL
)braket
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|in_8
c_func
(paren
op_amp
id|via
(braket
id|IFR
)braket
)paren
op_amp
id|T1_INT
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|dend
op_assign
id|get_dec
c_func
(paren
)paren
suffix:semicolon
id|tb_ticks_per_jiffy
op_assign
(paren
id|dstart
op_minus
id|dend
)paren
op_div
l_int|6
suffix:semicolon
id|tb_to_us
op_assign
id|mulhwu_scale_factor
c_func
(paren
id|dstart
op_minus
id|dend
comma
l_int|60000
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;via_calibrate_decr: ticks per jiffy = %u (%u ticks)&bslash;n&quot;
comma
id|tb_ticks_per_jiffy
comma
id|dstart
op_minus
id|dend
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PMAC_PBOOK
multiline_comment|/*&n; * Reset the time after a sleep.&n; */
DECL|function|time_sleep_notify
r_static
r_int
id|time_sleep_notify
c_func
(paren
r_struct
id|pmu_sleep_notifier
op_star
id|self
comma
r_int
id|when
)paren
(brace
r_static
r_int
r_int
id|time_diff
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_switch
c_cond
(paren
id|when
)paren
(brace
r_case
id|PBOOK_SLEEP_NOW
suffix:colon
id|read_lock_irqsave
c_func
(paren
op_amp
id|xtime_lock
comma
id|flags
)paren
suffix:semicolon
id|time_diff
op_assign
id|xtime.tv_sec
op_minus
id|pmac_get_rtc_time
c_func
(paren
)paren
suffix:semicolon
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|xtime_lock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PBOOK_WAKE
suffix:colon
id|write_lock_irqsave
c_func
(paren
op_amp
id|xtime_lock
comma
id|flags
)paren
suffix:semicolon
id|xtime.tv_sec
op_assign
id|pmac_get_rtc_time
c_func
(paren
)paren
op_plus
id|time_diff
suffix:semicolon
id|set_dec
c_func
(paren
id|tb_ticks_per_jiffy
)paren
suffix:semicolon
multiline_comment|/* No currently-supported powerbook has a 601,&n;&t;&t;   so use get_tbl, not native  */
id|last_jiffy_stamp
c_func
(paren
l_int|0
)paren
op_assign
id|tb_last_stamp
op_assign
id|get_tbl
c_func
(paren
)paren
suffix:semicolon
id|xtime.tv_usec
op_assign
l_int|0
suffix:semicolon
id|last_rtc_update
op_assign
id|xtime.tv_sec
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|xtime_lock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|PBOOK_SLEEP_OK
suffix:semicolon
)brace
DECL|variable|time_sleep_notifier
r_static
r_struct
id|pmu_sleep_notifier
id|time_sleep_notifier
op_assign
(brace
id|time_sleep_notify
comma
id|SLEEP_LEVEL_MISC
comma
)brace
suffix:semicolon
macro_line|#endif /* CONFIG_PMAC_PBOOK */
multiline_comment|/*&n; * Query the OF and get the decr frequency.&n; * This was taken from the pmac time_init() when merging the prep/pmac&n; * time functions.&n; */
DECL|function|pmac_calibrate_decr
r_void
id|__init
id|pmac_calibrate_decr
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|cpu
suffix:semicolon
r_int
r_int
id|freq
comma
op_star
id|fp
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_PBOOK
id|pmu_register_sleep_notifier
c_func
(paren
op_amp
id|time_sleep_notifier
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_PMAC_PBOOK */
r_if
c_cond
(paren
id|via_calibrate_decr
c_func
(paren
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t; * The cpu node should have a timebase-frequency property&n;&t; * to tell us the rate at which the decrementer counts.&n;&t; */
id|cpu
op_assign
id|find_type_devices
c_func
(paren
l_string|&quot;cpu&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpu
op_eq
l_int|0
)paren
id|panic
c_func
(paren
l_string|&quot;can&squot;t find cpu node in time_init&quot;
)paren
suffix:semicolon
id|fp
op_assign
(paren
r_int
r_int
op_star
)paren
id|get_property
c_func
(paren
id|cpu
comma
l_string|&quot;timebase-frequency&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fp
op_eq
l_int|0
)paren
id|panic
c_func
(paren
l_string|&quot;can&squot;t get cpu timebase frequency&quot;
)paren
suffix:semicolon
id|freq
op_assign
op_star
id|fp
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;time_init: decrementer frequency = %u.%.6u MHz&bslash;n&quot;
comma
id|freq
op_div
l_int|1000000
comma
id|freq
op_mod
l_int|1000000
)paren
suffix:semicolon
id|tb_ticks_per_jiffy
op_assign
id|freq
op_div
id|HZ
suffix:semicolon
id|tb_to_us
op_assign
id|mulhwu_scale_factor
c_func
(paren
id|freq
comma
l_int|1000000
)paren
suffix:semicolon
)brace
eof
