multiline_comment|/*&n; * mkboot - Make a &squot;boot&squot; image from a PowerPC (ELF) binary&n; *&n; * usage: mkboot &lt;ELF-file&gt; &lt;Boot-file&gt;&n; *&n; */
macro_line|#include &lt;stdlib.h&gt;
macro_line|#include &lt;stdio.h&gt;
macro_line|#include &lt;errno.h&gt;
macro_line|#include &lt;elf/common.h&gt;
macro_line|#include &lt;elf/external.h&gt;
DECL|macro|MAX_SECTIONS
mdefine_line|#define MAX_SECTIONS 64
DECL|variable|fd
r_int
id|fd
suffix:semicolon
DECL|variable|hdr
id|Elf32_External_Ehdr
id|hdr
suffix:semicolon
DECL|variable|sections
id|Elf32_External_Shdr
id|sections
(braket
id|MAX_SECTIONS
)braket
suffix:semicolon
DECL|variable|symtab
r_char
op_star
id|symtab
suffix:semicolon
multiline_comment|/* Boolean type definitions */
DECL|macro|FALSE
mdefine_line|#define FALSE     0
DECL|macro|TRUE
mdefine_line|#define TRUE      1
DECL|macro|bool
mdefine_line|#define bool  short
r_extern
r_char
op_star
id|strerror
c_func
(paren
)paren
suffix:semicolon
r_extern
r_int
id|errno
suffix:semicolon
DECL|macro|ADDR
mdefine_line|#define ADDR unsigned long
multiline_comment|/* Definitions that control the shape of the output */
DECL|macro|MAX_ITEMS
mdefine_line|#define MAX_ITEMS  32  /* Max # bytes per line */
DECL|variable|in_file
id|FILE
op_star
id|in_file
suffix:semicolon
multiline_comment|/* Input (binary image) file */
DECL|variable|out_file
id|FILE
op_star
id|out_file
suffix:semicolon
multiline_comment|/* Output (boot image) file */
DECL|variable|org
r_int
id|org
op_assign
op_minus
l_int|1
suffix:semicolon
macro_line|#ifdef linux
r_int
DECL|function|_LONG
id|_LONG
c_func
(paren
r_int
r_int
op_star
id|p
)paren
(brace
r_int
r_char
op_star
id|xp
op_assign
(paren
r_int
r_char
op_star
)paren
id|p
suffix:semicolon
r_return
(paren
(paren
id|xp
(braket
l_int|0
)braket
op_lshift
l_int|24
)paren
op_or
(paren
id|xp
(braket
l_int|1
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|xp
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
id|xp
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
r_int
r_int
DECL|function|_USHORT
id|_USHORT
c_func
(paren
r_int
r_int
op_star
id|p
)paren
(brace
r_int
r_char
op_star
id|xp
op_assign
(paren
r_int
r_char
op_star
)paren
id|p
suffix:semicolon
r_return
(paren
(paren
id|xp
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_or
id|xp
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
macro_line|#else
DECL|macro|_LONG
mdefine_line|#define _LONG *
DECL|macro|_USHORT
mdefine_line|#define _USHORT *
macro_line|#endif
id|Elf32_External_Shdr
op_star
DECL|function|find_section
id|find_section
c_func
(paren
r_char
op_star
id|section_name
)paren
(brace
id|Elf32_External_Shdr
op_star
id|shdr
op_assign
id|sections
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_SECTIONS
suffix:semicolon
id|i
op_increment
comma
id|shdr
op_increment
)paren
(brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|section_name
comma
op_amp
id|symtab
(braket
id|_LONG
c_func
(paren
(paren
r_int
op_star
)paren
id|shdr-&gt;sh_name
)paren
)braket
)paren
op_eq
l_int|0
)paren
(brace
r_return
(paren
id|shdr
)paren
suffix:semicolon
)brace
)brace
r_return
(paren
(paren
id|Elf32_External_Shdr
op_star
)paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|main
id|main
(paren
id|argc
comma
id|argv
)paren
r_int
id|argc
suffix:semicolon
r_char
op_star
id|argv
(braket
)braket
suffix:semicolon
(brace
r_if
c_cond
(paren
(paren
id|argc
op_eq
l_int|3
)paren
op_logical_or
(paren
id|argc
op_eq
l_int|4
)paren
)paren
(brace
r_if
c_cond
(paren
id|argc
op_eq
l_int|4
)paren
(brace
id|org
op_assign
id|strtol
c_func
(paren
id|argv
(braket
l_int|3
)braket
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|init
c_func
(paren
id|argc
comma
id|argv
)paren
)paren
(brace
id|process
c_func
(paren
id|argv
(braket
l_int|2
)braket
)paren
suffix:semicolon
)brace
r_else
m_exit
(paren
l_int|255
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Illegal command line */
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Syntax: mkboot &lt;bin_file&gt; &lt;out_file&gt;&bslash;n&quot;
)paren
suffix:semicolon
m_exit
(paren
l_int|255
)paren
suffix:semicolon
)brace
m_exit
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|init
id|init
c_func
(paren
id|argc
comma
id|argv
)paren
r_int
id|argc
suffix:semicolon
r_char
op_star
id|argv
(braket
)braket
suffix:semicolon
(brace
r_int
id|sizeof_sections
comma
id|size
suffix:semicolon
r_char
op_star
id|fn
op_assign
id|argv
(braket
l_int|1
)braket
suffix:semicolon
id|Elf32_External_Shdr
op_star
id|shdr
suffix:semicolon
r_if
c_cond
(paren
(paren
id|out_file
op_assign
id|fopen
c_func
(paren
id|argv
(braket
l_int|2
)braket
comma
l_string|&quot;w&quot;
)paren
)paren
op_eq
(paren
id|FILE
op_star
)paren
l_int|NULL
)paren
(brace
id|io_err
c_func
(paren
l_string|&quot;creating output file&quot;
)paren
suffix:semicolon
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|in_file
op_assign
id|fopen
c_func
(paren
id|fn
comma
l_string|&quot;r&quot;
)paren
)paren
op_eq
(paren
id|FILE
op_star
)paren
l_int|NULL
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Can&squot;t open &squot;%s&squot;: %s&bslash;n&quot;
comma
id|fn
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fread
c_func
(paren
op_amp
id|hdr
comma
r_sizeof
(paren
id|hdr
)paren
comma
l_int|1
comma
id|in_file
)paren
op_ne
l_int|1
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Can&squot;t read ELF header: %s&bslash;n&quot;
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
multiline_comment|/* Make sure this is a file we like */
r_if
c_cond
(paren
(paren
id|hdr.e_ident
(braket
id|EI_MAG0
)braket
op_ne
id|ELFMAG0
)paren
op_logical_or
(paren
id|hdr.e_ident
(braket
id|EI_MAG1
)braket
op_ne
id|ELFMAG1
)paren
op_logical_or
(paren
id|hdr.e_ident
(braket
id|EI_MAG2
)braket
op_ne
id|ELFMAG2
)paren
op_logical_or
(paren
id|hdr.e_ident
(braket
id|EI_MAG3
)braket
op_ne
id|ELFMAG3
)paren
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Invalid binary file (not ELF)&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hdr.e_ident
(braket
id|EI_CLASS
)braket
op_ne
id|ELFCLASS32
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Invalid binary file (not ELF32)&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|_USHORT
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|hdr.e_machine
)paren
op_ne
id|EM_CYGNUS_POWERPC
)paren
op_logical_and
(paren
id|_USHORT
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|hdr.e_machine
)paren
op_ne
id|EM_PPC
)paren
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Invalid binary file (not PowerPC)&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|_USHORT
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|hdr.e_shnum
)paren
OG
id|MAX_SECTIONS
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Invalid binary file (too many sections)&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
id|fseek
c_func
(paren
id|in_file
comma
id|_LONG
c_func
(paren
(paren
r_int
op_star
)paren
id|hdr.e_shoff
)paren
comma
l_int|0
)paren
suffix:semicolon
id|sizeof_sections
op_assign
id|_USHORT
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|hdr.e_shnum
)paren
op_star
r_sizeof
(paren
id|sections
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fread
c_func
(paren
id|sections
comma
id|sizeof_sections
comma
l_int|1
comma
id|in_file
)paren
op_ne
l_int|1
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Can&squot;t read sections: %s&bslash;n&quot;
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
multiline_comment|/* Read in symbol table */
id|shdr
op_assign
op_amp
id|sections
(braket
id|_USHORT
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|hdr.e_shstrndx
)paren
)braket
suffix:semicolon
id|size
op_assign
id|_LONG
c_func
(paren
(paren
r_int
op_star
)paren
id|shdr-&gt;sh_size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|symtab
op_assign
id|malloc
c_func
(paren
l_int|256
)paren
)paren
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Can&squot;t allocate memory for symbol table.&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
id|fseek
c_func
(paren
id|in_file
comma
id|_LONG
c_func
(paren
(paren
r_int
op_star
)paren
id|shdr-&gt;sh_offset
)paren
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fread
c_func
(paren
id|symtab
comma
id|size
comma
l_int|1
comma
id|in_file
)paren
op_ne
l_int|1
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Can&squot;t read symbol table: %s&bslash;n&quot;
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
DECL|function|process
id|process
c_func
(paren
id|out_name
)paren
r_char
op_star
id|out_name
suffix:semicolon
(brace
id|Elf32_External_Shdr
op_star
id|shdr_text
comma
op_star
id|shdr_data
suffix:semicolon
r_int
id|relocated_text_base
comma
id|text_base
comma
id|text_offset
comma
id|text_size
suffix:semicolon
r_int
id|relocated_data_base
comma
id|data_base
comma
id|data_offset
comma
id|data_size
suffix:semicolon
id|shdr_text
op_assign
id|find_section
c_func
(paren
l_string|&quot;.text&quot;
)paren
suffix:semicolon
id|shdr_data
op_assign
id|find_section
c_func
(paren
l_string|&quot;.data&quot;
)paren
suffix:semicolon
id|text_base
op_assign
id|relocated_text_base
op_assign
id|_LONG
c_func
(paren
(paren
r_int
op_star
)paren
id|shdr_text-&gt;sh_addr
)paren
suffix:semicolon
id|text_size
op_assign
id|_LONG
c_func
(paren
(paren
r_int
op_star
)paren
id|shdr_text-&gt;sh_size
)paren
suffix:semicolon
id|text_offset
op_assign
id|_LONG
c_func
(paren
(paren
r_int
op_star
)paren
id|shdr_text-&gt;sh_offset
)paren
suffix:semicolon
id|data_base
op_assign
id|relocated_data_base
op_assign
id|_LONG
c_func
(paren
(paren
r_int
op_star
)paren
id|shdr_data-&gt;sh_addr
)paren
suffix:semicolon
id|data_size
op_assign
id|_LONG
c_func
(paren
(paren
r_int
op_star
)paren
id|shdr_data-&gt;sh_size
)paren
suffix:semicolon
id|data_offset
op_assign
id|_LONG
c_func
(paren
(paren
r_int
op_star
)paren
id|shdr_data-&gt;sh_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|org
op_ge
l_int|0
)paren
(brace
id|relocated_text_base
op_assign
id|org
suffix:semicolon
id|relocated_data_base
op_assign
id|data_base
op_minus
id|text_base
op_plus
id|org
suffix:semicolon
)brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;TEXT %x bytes at %x[%x]&bslash;n&quot;
comma
id|text_size
comma
id|text_base
comma
id|relocated_text_base
)paren
suffix:semicolon
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;DATA %x bytes at %x[%x]&bslash;n&quot;
comma
id|data_size
comma
id|data_base
comma
id|relocated_data_base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dump_segment
c_func
(paren
id|text_offset
comma
id|relocated_text_base
comma
id|text_size
)paren
op_logical_and
id|dump_segment
c_func
(paren
id|data_offset
comma
id|relocated_data_base
comma
id|data_size
)paren
)paren
(brace
)brace
r_else
(brace
id|unlink
c_func
(paren
id|out_name
)paren
suffix:semicolon
)brace
)brace
DECL|function|dump_segment
id|dump_segment
c_func
(paren
id|off
comma
id|base
comma
id|size
)paren
r_int
id|off
suffix:semicolon
id|ADDR
id|base
suffix:semicolon
r_int
id|size
suffix:semicolon
(brace
r_char
id|buf
(braket
l_int|4096
)braket
suffix:semicolon
r_int
id|len
suffix:semicolon
r_bool
id|ok
op_assign
id|TRUE
suffix:semicolon
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Reading %x bytes at %x.%x&bslash;n&quot;
comma
id|size
comma
id|off
comma
id|base
)paren
suffix:semicolon
id|fseek
c_func
(paren
id|in_file
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|fseek
c_func
(paren
id|in_file
comma
id|off
comma
l_int|0
)paren
suffix:semicolon
macro_line|#if 0  
r_if
c_cond
(paren
id|org
op_ge
l_int|0
)paren
(brace
id|fseek
c_func
(paren
id|out_file
comma
id|base
op_plus
id|org
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|fseek
c_func
(paren
id|out_file
comma
id|base
comma
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#else
id|fseek
c_func
(paren
id|out_file
comma
id|base
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif  
r_while
c_loop
(paren
id|size
op_logical_and
id|ok
)paren
(brace
id|len
op_assign
id|size
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
r_sizeof
(paren
id|buf
)paren
)paren
(brace
id|len
op_assign
r_sizeof
(paren
id|buf
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fread
c_func
(paren
id|buf
comma
r_sizeof
(paren
r_char
)paren
comma
id|len
comma
id|in_file
)paren
op_eq
id|len
)paren
(brace
id|fwrite
c_func
(paren
id|buf
comma
r_sizeof
(paren
r_char
)paren
comma
id|len
comma
id|out_file
)paren
suffix:semicolon
)brace
r_else
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Premature EOF encountered.&bslash;n&quot;
)paren
suffix:semicolon
id|ok
op_assign
id|FALSE
suffix:semicolon
)brace
id|size
op_sub_assign
id|len
suffix:semicolon
)brace
r_return
(paren
id|ok
)paren
suffix:semicolon
)brace
DECL|function|io_err
id|io_err
c_func
(paren
id|what
)paren
r_char
op_star
id|what
suffix:semicolon
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Error %s: %s&bslash;n&quot;
comma
id|what
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef sun
r_extern
r_int
id|sys_nerr
suffix:semicolon
r_extern
r_char
op_star
id|sys_errlist
(braket
)braket
suffix:semicolon
r_char
op_star
DECL|function|strerror
id|strerror
c_func
(paren
r_int
id|errno
)paren
(brace
r_static
r_char
id|msg
(braket
l_int|32
)braket
suffix:semicolon
r_if
c_cond
(paren
id|errno
op_le
id|sys_nerr
)paren
(brace
r_return
(paren
id|sys_errlist
(braket
id|errno
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|sprintf
c_func
(paren
id|msg
comma
l_string|&quot;&lt;&lt;Unknown error: %d&gt;&gt;&quot;
comma
id|errno
)paren
suffix:semicolon
r_return
(paren
id|msg
)paren
suffix:semicolon
)brace
)brace
DECL|function|strtoul
id|strtoul
c_func
(paren
r_char
op_star
id|str
comma
r_char
op_star
op_star
id|radix
comma
r_int
id|base
)paren
(brace
r_return
id|strtol
c_func
(paren
id|str
comma
id|radix
comma
id|base
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
