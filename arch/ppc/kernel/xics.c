multiline_comment|/*&n; * arch/ppc/kernel/xics.c&n; *&n; * Copyright 2000 IBM Corporation.&n; *&n; *  This program is free software; you can redistribute it and/or&n; *  modify it under the terms of the GNU General Public License&n; *  as published by the Free Software Foundation; either version&n; *  2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/threads.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;i8259.h&quot;
macro_line|#include &quot;xics.h&quot;
r_void
id|xics_enable_irq
c_func
(paren
id|u_int
id|irq
)paren
suffix:semicolon
r_void
id|xics_disable_irq
c_func
(paren
id|u_int
id|irq
)paren
suffix:semicolon
r_void
id|xics_mask_and_ack_irq
c_func
(paren
id|u_int
id|irq
)paren
suffix:semicolon
r_void
id|xics_end_irq
c_func
(paren
id|u_int
id|irq
)paren
suffix:semicolon
DECL|variable|xics_pic
r_struct
id|hw_interrupt_type
id|xics_pic
op_assign
(brace
l_string|&quot; XICS     &quot;
comma
l_int|NULL
comma
l_int|NULL
comma
id|xics_enable_irq
comma
id|xics_disable_irq
comma
id|xics_mask_and_ack_irq
comma
id|xics_end_irq
)brace
suffix:semicolon
DECL|variable|xics_8259_pic
r_struct
id|hw_interrupt_type
id|xics_8259_pic
op_assign
(brace
l_string|&quot; XICS/8259&quot;
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
id|xics_mask_and_ack_irq
comma
l_int|NULL
)brace
suffix:semicolon
DECL|macro|XICS_IPI
mdefine_line|#define XICS_IPI&t;&t;2
DECL|macro|XICS_IRQ_8259_CASCADE
mdefine_line|#define XICS_IRQ_8259_CASCADE&t;0x2c
DECL|macro|XICS_IRQ_OFFSET
mdefine_line|#define XICS_IRQ_OFFSET&t;&t;16
DECL|macro|XICS_IRQ_SPURIOUS
mdefine_line|#define XICS_IRQ_SPURIOUS&t;0
DECL|macro|DEFAULT_SERVER
mdefine_line|#define DEFAULT_SERVER&t;&t;0
DECL|macro|DEFAULT_PRIORITY
mdefine_line|#define&t;DEFAULT_PRIORITY&t;0
DECL|struct|xics_ipl
r_struct
id|xics_ipl
(brace
r_union
(brace
DECL|member|word
id|u32
id|word
suffix:semicolon
DECL|member|bytes
id|u8
id|bytes
(braket
l_int|4
)braket
suffix:semicolon
DECL|member|xirr_poll
)brace
id|xirr_poll
suffix:semicolon
r_union
(brace
DECL|member|word
id|u32
id|word
suffix:semicolon
DECL|member|bytes
id|u8
id|bytes
(braket
l_int|4
)braket
suffix:semicolon
DECL|member|xirr
)brace
id|xirr
suffix:semicolon
DECL|member|dummy
id|u32
id|dummy
suffix:semicolon
r_union
(brace
DECL|member|word
id|u32
id|word
suffix:semicolon
DECL|member|bytes
id|u8
id|bytes
(braket
l_int|4
)braket
suffix:semicolon
DECL|member|qirr
)brace
id|qirr
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|xics_info
r_struct
id|xics_info
(brace
DECL|member|per_cpu
r_volatile
r_struct
id|xics_ipl
op_star
id|per_cpu
(braket
id|NR_CPUS
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|xics_info
r_struct
id|xics_info
id|xics_info
suffix:semicolon
DECL|macro|xirr_info
mdefine_line|#define xirr_info(n_cpu)&t;(xics_info.per_cpu[n_cpu]-&gt;xirr.word)
DECL|macro|cppr_info
mdefine_line|#define cppr_info(n_cpu)&t;(xics_info.per_cpu[n_cpu]-&gt;xirr.bytes[0])
DECL|macro|poll_info
mdefine_line|#define poll_info(n_cpu)&t;(xics_info.per_cpu[n_cpu]-&gt;xirr_poll.word)
DECL|macro|qirr_info
mdefine_line|#define qirr_info(n_cpu)&t;(xics_info.per_cpu[n_cpu]-&gt;qirr.bytes[0])
r_void
DECL|function|xics_enable_irq
id|xics_enable_irq
c_func
(paren
id|u_int
id|irq
)paren
(brace
r_int
id|status
suffix:semicolon
r_int
id|call_status
suffix:semicolon
id|irq
op_sub_assign
id|XICS_IRQ_OFFSET
suffix:semicolon
r_if
c_cond
(paren
id|irq
op_eq
id|XICS_IPI
)paren
r_return
suffix:semicolon
id|call_status
op_assign
id|call_rtas
c_func
(paren
l_string|&quot;ibm,set-xive&quot;
comma
l_int|3
comma
l_int|1
comma
(paren
id|ulong
op_star
)paren
op_amp
id|status
comma
id|irq
comma
id|DEFAULT_SERVER
comma
id|DEFAULT_PRIORITY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|call_status
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;xics_enable_irq: irq=%x: call_rtas failed; retn=%x, status=%x&bslash;n&quot;
comma
id|irq
comma
id|call_status
comma
id|status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_void
DECL|function|xics_disable_irq
id|xics_disable_irq
c_func
(paren
id|u_int
id|irq
)paren
(brace
r_int
id|status
suffix:semicolon
r_int
id|call_status
suffix:semicolon
id|irq
op_sub_assign
id|XICS_IRQ_OFFSET
suffix:semicolon
id|call_status
op_assign
id|call_rtas
c_func
(paren
l_string|&quot;ibm,int-off&quot;
comma
l_int|1
comma
l_int|1
comma
(paren
id|ulong
op_star
)paren
op_amp
id|status
comma
id|irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|call_status
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;xics_disable_irq: irq=%x: call_rtas failed, retn=%x&bslash;n&quot;
comma
id|irq
comma
id|call_status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_void
DECL|function|xics_end_irq
id|xics_end_irq
c_func
(paren
id|u_int
id|irq
)paren
(brace
r_int
id|cpu
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
id|cppr_info
c_func
(paren
id|cpu
)paren
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* actually the value overwritten by ack */
id|xirr_info
c_func
(paren
id|cpu
)paren
op_assign
(paren
l_int|0xff
op_lshift
l_int|24
)paren
op_or
(paren
id|irq
op_minus
id|XICS_IRQ_OFFSET
)paren
suffix:semicolon
)brace
r_void
DECL|function|xics_mask_and_ack_irq
id|xics_mask_and_ack_irq
c_func
(paren
id|u_int
id|irq
)paren
(brace
r_int
id|cpu
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq
OL
id|XICS_IRQ_OFFSET
)paren
(brace
id|i8259_pic
dot
id|ack
c_func
(paren
id|irq
)paren
suffix:semicolon
id|xirr_info
c_func
(paren
id|cpu
)paren
op_assign
(paren
l_int|0xff
op_lshift
l_int|24
)paren
op_or
id|XICS_IRQ_8259_CASCADE
suffix:semicolon
)brace
r_else
(brace
id|cppr_info
c_func
(paren
id|cpu
)paren
op_assign
l_int|0xff
suffix:semicolon
)brace
)brace
r_int
DECL|function|xics_get_irq
id|xics_get_irq
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|u_int
id|cpu
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
id|u_int
id|vec
suffix:semicolon
r_int
id|irq
suffix:semicolon
id|vec
op_assign
id|xirr_info
c_func
(paren
id|cpu
)paren
suffix:semicolon
multiline_comment|/*  (vec &gt;&gt; 24) == old priority */
id|vec
op_and_assign
l_int|0x00ffffff
suffix:semicolon
multiline_comment|/* for sanity, this had better be &lt; NR_IRQS - 16 */
r_if
c_cond
(paren
id|vec
op_eq
id|XICS_IRQ_8259_CASCADE
)paren
(brace
id|irq
op_assign
id|i8259_irq
c_func
(paren
id|cpu
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vec
op_eq
id|XICS_IRQ_SPURIOUS
)paren
(brace
id|irq
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_else
id|irq
op_assign
id|vec
op_plus
id|XICS_IRQ_OFFSET
suffix:semicolon
r_return
id|irq
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SMP
DECL|function|xics_ipi_action
r_void
id|xics_ipi_action
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|qirr_info
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
)paren
op_assign
l_int|0xff
suffix:semicolon
id|smp_message_recv
c_func
(paren
id|MSG_RESCHEDULE
comma
id|regs
)paren
suffix:semicolon
)brace
DECL|function|xics_cause_IPI
r_void
id|xics_cause_IPI
c_func
(paren
r_int
id|cpu
)paren
(brace
id|qirr_info
c_func
(paren
id|cpu
)paren
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|xics_setup_cpu
r_void
id|xics_setup_cpu
c_func
(paren
r_void
)paren
(brace
r_int
id|cpu
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
id|cppr_info
c_func
(paren
id|cpu
)paren
op_assign
l_int|0xff
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_SMP */
r_void
DECL|function|xics_init_IRQ
id|xics_init_IRQ
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_extern
r_int
r_int
id|smp_chrp_cpu_nr
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|smp_chrp_cpu_nr
suffix:semicolon
op_increment
id|i
)paren
id|xics_info.per_cpu
(braket
id|i
)braket
op_assign
id|ioremap
c_func
(paren
l_int|0xfe000000
op_plus
id|smp_hw_index
(braket
id|i
)braket
op_star
l_int|0x1000
comma
l_int|0x20
)paren
suffix:semicolon
macro_line|#else
id|xics_info.per_cpu
(braket
l_int|0
)braket
op_assign
id|ioremap
c_func
(paren
l_int|0xfe000000
comma
l_int|0x20
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_SMP */
id|xics_8259_pic.enable
op_assign
id|i8259_pic.enable
suffix:semicolon
id|xics_8259_pic.disable
op_assign
id|i8259_pic.disable
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
op_increment
id|i
)paren
id|irq_desc
(braket
id|i
)braket
dot
id|handler
op_assign
op_amp
id|xics_8259_pic
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
id|NR_IRQS
suffix:semicolon
op_increment
id|i
)paren
id|irq_desc
(braket
id|i
)braket
dot
id|handler
op_assign
op_amp
id|xics_pic
suffix:semicolon
id|cppr_info
c_func
(paren
l_int|0
)paren
op_assign
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|XICS_IRQ_8259_CASCADE
op_plus
id|XICS_IRQ_OFFSET
comma
id|no_action
comma
l_int|0
comma
l_string|&quot;8259 cascade&quot;
comma
l_int|0
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;xics_init_IRQ: couldn&squot;t get 8259 cascade&bslash;n&quot;
)paren
suffix:semicolon
id|i8259_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
id|request_irq
c_func
(paren
id|XICS_IPI
op_plus
id|XICS_IRQ_OFFSET
comma
id|xics_ipi_action
comma
l_int|0
comma
l_string|&quot;IPI&quot;
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
)brace
eof
