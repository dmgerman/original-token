macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/gemini.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &quot;pci.h&quot;
DECL|macro|pci_config_addr
mdefine_line|#define pci_config_addr(bus,dev,offset) &bslash;&n;        (0x80000000 | (bus&lt;&lt;16) | (dev&lt;&lt;8) | offset)
r_int
DECL|function|gemini_pcibios_read_config_byte
id|gemini_pcibios_read_config_byte
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev
comma
r_int
r_char
id|offset
comma
r_int
r_char
op_star
id|val
)paren
(brace
r_int
r_int
id|reg
suffix:semicolon
id|reg
op_assign
id|grackle_read
c_func
(paren
id|pci_config_addr
c_func
(paren
id|bus
comma
id|dev
comma
(paren
id|offset
op_amp
op_complement
(paren
l_int|0x3
)paren
)paren
)paren
)paren
suffix:semicolon
op_star
id|val
op_assign
(paren
(paren
id|reg
op_rshift
(paren
(paren
id|offset
op_amp
l_int|0x3
)paren
op_lshift
l_int|3
)paren
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
r_int
DECL|function|gemini_pcibios_read_config_word
id|gemini_pcibios_read_config_word
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev
comma
r_int
r_char
id|offset
comma
r_int
r_int
op_star
id|val
)paren
(brace
r_int
r_int
id|reg
suffix:semicolon
id|reg
op_assign
id|grackle_read
c_func
(paren
id|pci_config_addr
c_func
(paren
id|bus
comma
id|dev
comma
(paren
id|offset
op_amp
op_complement
(paren
l_int|0x3
)paren
)paren
)paren
)paren
suffix:semicolon
op_star
id|val
op_assign
(paren
(paren
id|reg
op_rshift
(paren
(paren
id|offset
op_amp
l_int|0x3
)paren
op_lshift
l_int|3
)paren
)paren
op_amp
l_int|0xffff
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
r_int
DECL|function|gemini_pcibios_read_config_dword
id|gemini_pcibios_read_config_dword
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev
comma
r_int
r_char
id|offset
comma
r_int
r_int
op_star
id|val
)paren
(brace
op_star
id|val
op_assign
id|grackle_read
c_func
(paren
id|pci_config_addr
c_func
(paren
id|bus
comma
id|dev
comma
(paren
id|offset
op_amp
op_complement
(paren
l_int|0x3
)paren
)paren
)paren
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
r_int
DECL|function|gemini_pcibios_write_config_byte
id|gemini_pcibios_write_config_byte
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev
comma
r_int
r_char
id|offset
comma
r_int
r_char
id|val
)paren
(brace
r_int
r_int
id|reg
suffix:semicolon
r_int
id|shifts
op_assign
id|offset
op_amp
l_int|0x3
suffix:semicolon
id|reg
op_assign
id|grackle_read
c_func
(paren
id|pci_config_addr
c_func
(paren
id|bus
comma
id|dev
comma
(paren
id|offset
op_amp
op_complement
(paren
l_int|0x3
)paren
)paren
)paren
)paren
suffix:semicolon
id|reg
op_assign
(paren
id|reg
op_amp
op_complement
(paren
l_int|0xff
op_lshift
(paren
id|shifts
op_lshift
l_int|3
)paren
)paren
)paren
op_or
(paren
id|val
op_lshift
(paren
id|shifts
op_lshift
l_int|3
)paren
)paren
suffix:semicolon
id|grackle_write
c_func
(paren
id|pci_config_addr
c_func
(paren
id|bus
comma
id|dev
comma
(paren
id|offset
op_amp
op_complement
(paren
l_int|0x3
)paren
)paren
)paren
comma
id|reg
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
r_int
DECL|function|gemini_pcibios_write_config_word
id|gemini_pcibios_write_config_word
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev
comma
r_int
r_char
id|offset
comma
r_int
r_int
id|val
)paren
(brace
r_int
r_int
id|reg
suffix:semicolon
r_int
id|shifts
op_assign
id|offset
op_amp
l_int|0x3
suffix:semicolon
id|reg
op_assign
id|grackle_read
c_func
(paren
id|pci_config_addr
c_func
(paren
id|bus
comma
id|dev
comma
(paren
id|offset
op_amp
op_complement
(paren
l_int|0x3
)paren
)paren
)paren
)paren
suffix:semicolon
id|reg
op_assign
(paren
id|reg
op_amp
op_complement
(paren
l_int|0xffff
op_lshift
(paren
id|shifts
op_lshift
l_int|3
)paren
)paren
)paren
op_or
(paren
id|val
op_lshift
(paren
id|shifts
op_lshift
l_int|3
)paren
)paren
suffix:semicolon
id|grackle_write
c_func
(paren
id|pci_config_addr
c_func
(paren
id|bus
comma
id|dev
comma
(paren
id|offset
op_amp
op_complement
(paren
l_int|0x3
)paren
)paren
)paren
comma
id|reg
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
r_int
DECL|function|gemini_pcibios_write_config_dword
id|gemini_pcibios_write_config_dword
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev
comma
r_int
r_char
id|offset
comma
r_int
r_int
id|val
)paren
(brace
id|grackle_write
c_func
(paren
id|pci_config_addr
c_func
(paren
id|bus
comma
id|dev
comma
(paren
id|offset
op_amp
op_complement
(paren
l_int|0x3
)paren
)paren
)paren
comma
id|val
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|struct|gemini_device
r_struct
id|gemini_device
(brace
DECL|member|vendor
DECL|member|device
r_int
r_int
id|vendor
comma
id|device
suffix:semicolon
DECL|member|irq
r_int
r_char
id|irq
suffix:semicolon
DECL|member|cmd
r_int
r_int
id|cmd
suffix:semicolon
DECL|member|cache_line
DECL|member|latency
r_int
r_char
id|cache_line
comma
id|latency
suffix:semicolon
DECL|member|init
r_void
(paren
op_star
id|init
)paren
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|gemini_map
r_static
r_struct
id|gemini_device
id|gemini_map
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_NCR
comma
id|PCI_DEVICE_ID_NCR_53C885
comma
l_int|11
comma
l_int|0x15
comma
l_int|32
comma
l_int|248
comma
l_int|NULL
)brace
comma
(brace
id|PCI_VENDOR_ID_NCR
comma
l_int|0x701
comma
l_int|10
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
)brace
comma
(brace
id|PCI_VENDOR_ID_TUNDRA
comma
id|PCI_DEVICE_ID_TUNDRA_CA91C042
comma
l_int|3
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
)brace
comma
(brace
id|PCI_VENDOR_ID_IBM
comma
id|PCI_DEVICE_ID_IBM_MPIC
comma
l_int|0xff
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
)brace
comma
(brace
id|PCI_VENDOR_ID_CMD
comma
id|PCI_DEVICE_ID_CMD_670
comma
l_int|0xff
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
)brace
comma
(brace
id|PCI_VENDOR_ID_MOTOROLA
comma
id|PCI_DEVICE_ID_MOTOROLA_MPC106
comma
l_int|0xff
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
)brace
comma
)brace
suffix:semicolon
DECL|variable|gemini_map_count
r_static
r_int
id|gemini_map_count
op_assign
(paren
r_sizeof
(paren
id|gemini_map
)paren
op_div
r_sizeof
(paren
id|gemini_map
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/*  This just sets up the known devices on the board. */
DECL|function|mapin_device
r_static
r_void
id|__init
id|mapin_device
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_struct
id|gemini_device
op_star
id|p
suffix:semicolon
r_int
r_int
id|cmd
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|gemini_map_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p
op_assign
op_amp
(paren
id|gemini_map
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;vendor
op_eq
id|dev-&gt;vendor
op_logical_and
id|p-&gt;device
op_eq
id|dev-&gt;device
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;irq
op_ne
l_int|0xff
)paren
(brace
id|pci_write_config_byte
c_func
(paren
id|dev
comma
id|PCI_INTERRUPT_LINE
comma
id|p-&gt;irq
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
id|p-&gt;irq
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p-&gt;cmd
)paren
(brace
id|pci_read_config_word
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
op_amp
id|cmd
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
(paren
id|p-&gt;cmd
op_or
id|cmd
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p-&gt;cache_line
)paren
id|pci_write_config_byte
c_func
(paren
id|dev
comma
id|PCI_CACHE_LINE_SIZE
comma
id|p-&gt;cache_line
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;latency
)paren
id|pci_write_config_byte
c_func
(paren
id|dev
comma
id|PCI_LATENCY_TIMER
comma
id|p-&gt;latency
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|macro|KB
mdefine_line|#define KB 1024
DECL|macro|MB
mdefine_line|#define MB (KB*KB)
DECL|macro|ALIGN
mdefine_line|#define ALIGN(val,align) (((val) + ((align) -1))&amp;(~((align) -1)))
DECL|macro|MAX
mdefine_line|#define MAX(a,b)   (((a) &gt; (b)) ? (a) : (b))
DECL|macro|FIRST_IO_ADDR
mdefine_line|#define FIRST_IO_ADDR 0x10000
DECL|macro|FIRST_MEM_ADDR
mdefine_line|#define FIRST_MEM_ADDR 0x02000000
DECL|macro|GEMINI_PCI_MEM_BASE
mdefine_line|#define GEMINI_PCI_MEM_BASE (0xf0000000)
DECL|macro|GEMINI_PCI_IO_BASE
mdefine_line|#define GEMINI_PCI_IO_BASE  (0xfe800000)
DECL|variable|pci_mem_base
r_static
r_int
r_int
id|pci_mem_base
op_assign
id|GEMINI_PCI_MEM_BASE
suffix:semicolon
DECL|variable|pci_io_base
r_static
r_int
r_int
id|pci_io_base
op_assign
id|GEMINI_PCI_IO_BASE
suffix:semicolon
DECL|variable|io_base
r_static
r_int
r_int
id|io_base
op_assign
id|FIRST_IO_ADDR
suffix:semicolon
DECL|variable|mem_base
r_static
r_int
r_int
id|mem_base
op_assign
id|FIRST_MEM_ADDR
suffix:semicolon
DECL|function|layout_dev
id|__init
r_void
id|layout_dev
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|pci_bus
op_star
id|bus
suffix:semicolon
r_int
r_int
id|cmd
suffix:semicolon
r_int
r_int
id|reg
comma
id|base
comma
id|mask
comma
id|size
comma
id|alignto
comma
id|type
suffix:semicolon
id|bus
op_assign
id|dev-&gt;bus
suffix:semicolon
multiline_comment|/* make any known settings happen */
id|mapin_device
c_func
(paren
id|dev
)paren
suffix:semicolon
id|gemini_pcibios_read_config_word
c_func
(paren
id|bus-&gt;number
comma
id|dev-&gt;devfn
comma
id|PCI_COMMAND
comma
op_amp
id|cmd
)paren
suffix:semicolon
r_for
c_loop
(paren
id|reg
op_assign
id|PCI_BASE_ADDRESS_0
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|reg
op_le
id|PCI_BASE_ADDRESS_5
suffix:semicolon
id|reg
op_add_assign
l_int|4
comma
id|i
op_increment
)paren
(brace
multiline_comment|/* MPIC already done */
r_if
c_cond
(paren
id|dev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_IBM
op_logical_and
id|dev-&gt;device
op_eq
id|PCI_DEVICE_ID_IBM_MPIC
)paren
r_return
suffix:semicolon
id|gemini_pcibios_write_config_dword
c_func
(paren
id|bus-&gt;number
comma
id|dev-&gt;devfn
comma
id|reg
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|gemini_pcibios_read_config_dword
c_func
(paren
id|bus-&gt;number
comma
id|dev-&gt;devfn
comma
id|reg
comma
op_amp
id|base
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|base
)paren
(brace
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|base
op_amp
id|PCI_BASE_ADDRESS_SPACE_IO
)paren
(brace
id|cmd
op_or_assign
id|PCI_COMMAND_IO
suffix:semicolon
id|base
op_and_assign
id|PCI_BASE_ADDRESS_IO_MASK
suffix:semicolon
id|mask
op_assign
(paren
op_complement
id|base
op_lshift
l_int|1
)paren
op_or
l_int|0x1
suffix:semicolon
id|size
op_assign
(paren
id|mask
op_amp
id|base
)paren
op_amp
l_int|0xffffffff
suffix:semicolon
id|alignto
op_assign
id|MAX
c_func
(paren
l_int|0x400
comma
id|size
)paren
suffix:semicolon
id|base
op_assign
id|ALIGN
c_func
(paren
id|io_base
comma
id|alignto
)paren
suffix:semicolon
id|io_base
op_assign
id|base
op_plus
id|size
suffix:semicolon
id|gemini_pcibios_write_config_dword
c_func
(paren
id|bus-&gt;number
comma
id|dev-&gt;devfn
comma
id|reg
comma
(paren
(paren
id|pci_io_base
op_plus
id|base
)paren
op_amp
l_int|0x00ffffff
)paren
op_or
l_int|0x1
)paren
suffix:semicolon
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
op_assign
(paren
id|pci_io_base
op_plus
id|base
)paren
op_or
l_int|0x1
suffix:semicolon
)brace
r_else
(brace
id|cmd
op_or_assign
id|PCI_COMMAND_MEMORY
suffix:semicolon
id|type
op_assign
id|base
op_amp
id|PCI_BASE_ADDRESS_MEM_TYPE_MASK
suffix:semicolon
id|mask
op_assign
(paren
op_complement
id|base
op_lshift
l_int|1
)paren
op_or
l_int|0x1
suffix:semicolon
id|size
op_assign
(paren
id|mask
op_amp
id|base
)paren
op_amp
l_int|0xffffffff
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|PCI_BASE_ADDRESS_MEM_TYPE_32
suffix:colon
r_break
suffix:semicolon
r_case
id|PCI_BASE_ADDRESS_MEM_TYPE_64
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Warning: Ignoring 64-bit device; slot %d, function %d.&bslash;n&quot;
comma
id|PCI_SLOT
c_func
(paren
id|dev-&gt;devfn
)paren
comma
id|PCI_FUNC
c_func
(paren
id|dev-&gt;devfn
)paren
)paren
suffix:semicolon
id|reg
op_add_assign
l_int|4
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|alignto
op_assign
id|MAX
c_func
(paren
l_int|0x1000
comma
id|size
)paren
suffix:semicolon
id|base
op_assign
id|ALIGN
c_func
(paren
id|mem_base
comma
id|alignto
)paren
suffix:semicolon
id|mem_base
op_assign
id|base
op_plus
id|size
suffix:semicolon
id|gemini_pcibios_write_config_dword
c_func
(paren
id|bus-&gt;number
comma
id|dev-&gt;devfn
comma
id|reg
comma
(paren
id|pci_mem_base
op_plus
id|base
)paren
)paren
suffix:semicolon
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
op_assign
id|pci_mem_base
op_plus
id|base
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|dev
op_member_access_from_pointer
r_class
op_rshift
l_int|8
)paren
op_eq
id|PCI_CLASS_DISPLAY_VGA
)paren
id|cmd
op_or_assign
id|PCI_COMMAND_IO
suffix:semicolon
id|gemini_pcibios_write_config_word
c_func
(paren
id|bus-&gt;number
comma
id|dev-&gt;devfn
comma
id|PCI_COMMAND
comma
(paren
id|cmd
op_or
id|PCI_COMMAND_MASTER
)paren
)paren
suffix:semicolon
)brace
DECL|function|layout_bus
id|__init
r_void
id|layout_bus
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
)paren
(brace
r_struct
id|pci_dev
op_star
id|dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bus-&gt;devices
op_logical_and
op_logical_neg
id|bus-&gt;children
)paren
r_return
suffix:semicolon
id|io_base
op_assign
id|ALIGN
c_func
(paren
id|io_base
comma
l_int|4
op_star
id|KB
)paren
suffix:semicolon
id|mem_base
op_assign
id|ALIGN
c_func
(paren
id|mem_base
comma
l_int|4
op_star
id|KB
)paren
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
id|bus-&gt;devices
suffix:semicolon
id|dev
suffix:semicolon
id|dev
op_assign
id|dev-&gt;sibling
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|dev
op_member_access_from_pointer
r_class
op_rshift
l_int|16
)paren
op_ne
id|PCI_BASE_CLASS_BRIDGE
)paren
op_logical_or
(paren
(paren
id|dev
op_member_access_from_pointer
r_class
op_rshift
l_int|8
)paren
op_eq
id|PCI_CLASS_BRIDGE_OTHER
)paren
)paren
id|layout_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
DECL|function|gemini_pcibios_fixup
r_void
id|__init
id|gemini_pcibios_fixup
c_func
(paren
r_void
)paren
(brace
r_struct
id|pci_bus
op_star
id|bus
suffix:semicolon
r_int
r_int
id|orig_mem_base
comma
id|orig_io_base
suffix:semicolon
id|orig_mem_base
op_assign
id|pci_mem_base
suffix:semicolon
id|orig_io_base
op_assign
id|pci_io_base
suffix:semicolon
id|pci_mem_base
op_assign
id|orig_mem_base
suffix:semicolon
id|pci_io_base
op_assign
id|orig_io_base
suffix:semicolon
)brace
DECL|variable|gemini
id|decl_config_access_method
c_func
(paren
id|gemini
)paren
suffix:semicolon
multiline_comment|/* The &quot;bootloader&quot; for Synergy boards does none of this for us, so we need to&n;   lay it all out ourselves... --Dan */
DECL|function|gemini_setup_pci_ptrs
r_void
id|__init
id|gemini_setup_pci_ptrs
c_func
(paren
r_void
)paren
(brace
id|set_config_access_method
c_func
(paren
id|gemini
)paren
suffix:semicolon
id|ppc_md.pcibios_fixup
op_assign
id|gemini_pcibios_fixup
suffix:semicolon
)brace
eof
