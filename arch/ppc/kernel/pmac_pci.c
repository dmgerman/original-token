multiline_comment|/*&n; * Support for PCI bridges found on Power Macintoshes.&n; * At present the &quot;bandit&quot; and &quot;chaos&quot; bridges are supported.&n; * Fortunately you access configuration space in the same&n; * way with either bridge.&n; *&n; * Copyright (C) 1997 Paul Mackerras (paulus@cs.anu.edu.au)&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;asm/init.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/pci-bridge.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &quot;pci.h&quot;
DECL|variable|bridges
DECL|variable|bridge_list
r_struct
id|bridge_data
op_star
op_star
id|bridges
comma
op_star
id|bridge_list
suffix:semicolon
DECL|variable|max_bus
r_static
r_int
id|max_bus
suffix:semicolon
r_static
r_void
id|add_bridges
c_func
(paren
r_struct
id|device_node
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n; * Magic constants for enabling cache coherency in the bandit/PSX bridge.&n; */
DECL|macro|APPLE_VENDID
mdefine_line|#define APPLE_VENDID&t;0x106b
DECL|macro|BANDIT_DEVID
mdefine_line|#define BANDIT_DEVID&t;1
DECL|macro|BANDIT_DEVID_2
mdefine_line|#define BANDIT_DEVID_2&t;8
DECL|macro|BANDIT_REVID
mdefine_line|#define BANDIT_REVID&t;3
DECL|macro|BANDIT_DEVNUM
mdefine_line|#define BANDIT_DEVNUM&t;11
DECL|macro|BANDIT_MAGIC
mdefine_line|#define BANDIT_MAGIC&t;0x50
DECL|macro|BANDIT_COHERENT
mdefine_line|#define BANDIT_COHERENT&t;0x40
id|__pmac
DECL|function|pci_io_base
r_void
op_star
id|pci_io_base
c_func
(paren
r_int
r_int
id|bus
)paren
(brace
r_struct
id|bridge_data
op_star
id|bp
suffix:semicolon
r_if
c_cond
(paren
id|bus
OG
id|max_bus
op_logical_or
(paren
id|bp
op_assign
id|bridges
(braket
id|bus
)braket
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_return
id|bp-&gt;io_base
suffix:semicolon
)brace
id|__pmac
DECL|function|pci_device_loc
r_int
id|pci_device_loc
c_func
(paren
r_struct
id|device_node
op_star
id|dev
comma
r_int
r_char
op_star
id|bus_ptr
comma
r_int
r_char
op_star
id|devfn_ptr
)paren
(brace
r_int
r_int
op_star
id|reg
suffix:semicolon
r_int
id|len
suffix:semicolon
id|reg
op_assign
(paren
r_int
r_int
op_star
)paren
id|get_property
c_func
(paren
id|dev
comma
l_string|&quot;reg&quot;
comma
op_amp
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_eq
l_int|0
op_logical_or
id|len
OL
l_int|5
op_star
r_sizeof
(paren
r_int
r_int
)paren
)paren
(brace
multiline_comment|/* doesn&squot;t look like a PCI device */
op_star
id|bus_ptr
op_assign
l_int|0xff
suffix:semicolon
op_star
id|devfn_ptr
op_assign
l_int|0xff
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
op_star
id|bus_ptr
op_assign
id|reg
(braket
l_int|0
)braket
op_rshift
l_int|16
suffix:semicolon
op_star
id|devfn_ptr
op_assign
id|reg
(braket
l_int|0
)braket
op_rshift
l_int|8
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|__pmac
DECL|function|pmac_pcibios_read_config_byte
r_int
id|pmac_pcibios_read_config_byte
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev_fn
comma
r_int
r_char
id|offset
comma
r_int
r_char
op_star
id|val
)paren
(brace
r_struct
id|bridge_data
op_star
id|bp
suffix:semicolon
op_star
id|val
op_assign
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|bus
OG
id|max_bus
op_logical_or
(paren
id|bp
op_assign
id|bridges
(braket
id|bus
)braket
)paren
op_eq
l_int|0
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
r_if
c_cond
(paren
id|bus
op_eq
id|bp-&gt;bus_number
)paren
(brace
r_if
c_cond
(paren
id|dev_fn
OL
(paren
l_int|11
op_lshift
l_int|3
)paren
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
id|out_le32
c_func
(paren
id|bp-&gt;cfg_addr
comma
(paren
l_int|1UL
op_lshift
(paren
id|dev_fn
op_rshift
l_int|3
)paren
)paren
op_plus
(paren
(paren
id|dev_fn
op_amp
l_int|7
)paren
op_lshift
l_int|8
)paren
op_plus
(paren
id|offset
op_amp
op_complement
l_int|3
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Bus number once again taken into consideration.&n;&t;&t; * Change applied from 2.1.24. This makes devices located&n;&t;&t; * behind PCI-PCI bridges visible.&n;&t;&t; * -Ranjit Deshpande, 01/20/99&n;&t;&t; */
id|out_le32
c_func
(paren
id|bp-&gt;cfg_addr
comma
(paren
id|bus
op_lshift
l_int|16
)paren
op_plus
(paren
id|dev_fn
op_lshift
l_int|8
)paren
op_plus
(paren
id|offset
op_amp
op_complement
l_int|3
)paren
op_plus
l_int|1
)paren
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
op_star
id|val
op_assign
id|in_8
c_func
(paren
id|bp-&gt;cfg_data
op_plus
(paren
id|offset
op_amp
l_int|3
)paren
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
id|__pmac
DECL|function|pmac_pcibios_read_config_word
r_int
id|pmac_pcibios_read_config_word
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev_fn
comma
r_int
r_char
id|offset
comma
r_int
r_int
op_star
id|val
)paren
(brace
r_struct
id|bridge_data
op_star
id|bp
suffix:semicolon
op_star
id|val
op_assign
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
id|bus
OG
id|max_bus
op_logical_or
(paren
id|bp
op_assign
id|bridges
(braket
id|bus
)braket
)paren
op_eq
l_int|0
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
r_if
c_cond
(paren
(paren
id|offset
op_amp
l_int|1
)paren
op_ne
l_int|0
)paren
r_return
id|PCIBIOS_BAD_REGISTER_NUMBER
suffix:semicolon
r_if
c_cond
(paren
id|bus
op_eq
id|bp-&gt;bus_number
)paren
(brace
r_if
c_cond
(paren
id|dev_fn
OL
(paren
l_int|11
op_lshift
l_int|3
)paren
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
id|out_le32
c_func
(paren
id|bp-&gt;cfg_addr
comma
(paren
l_int|1UL
op_lshift
(paren
id|dev_fn
op_rshift
l_int|3
)paren
)paren
op_plus
(paren
(paren
id|dev_fn
op_amp
l_int|7
)paren
op_lshift
l_int|8
)paren
op_plus
(paren
id|offset
op_amp
op_complement
l_int|3
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* See pci_read_config_byte */
id|out_le32
c_func
(paren
id|bp-&gt;cfg_addr
comma
(paren
id|bus
op_lshift
l_int|16
)paren
op_plus
(paren
id|dev_fn
op_lshift
l_int|8
)paren
op_plus
(paren
id|offset
op_amp
op_complement
l_int|3
)paren
op_plus
l_int|1
)paren
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
op_star
id|val
op_assign
id|in_le16
c_func
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
(paren
id|bp-&gt;cfg_data
op_plus
(paren
id|offset
op_amp
l_int|3
)paren
)paren
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
id|__pmac
DECL|function|pmac_pcibios_read_config_dword
r_int
id|pmac_pcibios_read_config_dword
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev_fn
comma
r_int
r_char
id|offset
comma
r_int
r_int
op_star
id|val
)paren
(brace
r_struct
id|bridge_data
op_star
id|bp
suffix:semicolon
op_star
id|val
op_assign
l_int|0xffffffff
suffix:semicolon
r_if
c_cond
(paren
id|bus
OG
id|max_bus
op_logical_or
(paren
id|bp
op_assign
id|bridges
(braket
id|bus
)braket
)paren
op_eq
l_int|0
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
r_if
c_cond
(paren
(paren
id|offset
op_amp
l_int|3
)paren
op_ne
l_int|0
)paren
r_return
id|PCIBIOS_BAD_REGISTER_NUMBER
suffix:semicolon
r_if
c_cond
(paren
id|bus
op_eq
id|bp-&gt;bus_number
)paren
(brace
r_if
c_cond
(paren
id|dev_fn
OL
(paren
l_int|11
op_lshift
l_int|3
)paren
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
id|out_le32
c_func
(paren
id|bp-&gt;cfg_addr
comma
(paren
l_int|1UL
op_lshift
(paren
id|dev_fn
op_rshift
l_int|3
)paren
)paren
op_plus
(paren
(paren
id|dev_fn
op_amp
l_int|7
)paren
op_lshift
l_int|8
)paren
op_plus
id|offset
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* See pci_read_config_byte */
id|out_le32
c_func
(paren
id|bp-&gt;cfg_addr
comma
(paren
id|bus
op_lshift
l_int|16
)paren
op_plus
(paren
id|dev_fn
op_lshift
l_int|8
)paren
op_plus
id|offset
op_plus
l_int|1
)paren
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
op_star
id|val
op_assign
id|in_le32
c_func
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
id|bp-&gt;cfg_data
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
id|__pmac
DECL|function|pmac_pcibios_write_config_byte
r_int
id|pmac_pcibios_write_config_byte
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev_fn
comma
r_int
r_char
id|offset
comma
r_int
r_char
id|val
)paren
(brace
r_struct
id|bridge_data
op_star
id|bp
suffix:semicolon
r_if
c_cond
(paren
id|bus
OG
id|max_bus
op_logical_or
(paren
id|bp
op_assign
id|bridges
(braket
id|bus
)braket
)paren
op_eq
l_int|0
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
r_if
c_cond
(paren
id|bus
op_eq
id|bp-&gt;bus_number
)paren
(brace
r_if
c_cond
(paren
id|dev_fn
OL
(paren
l_int|11
op_lshift
l_int|3
)paren
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
id|out_le32
c_func
(paren
id|bp-&gt;cfg_addr
comma
(paren
l_int|1UL
op_lshift
(paren
id|dev_fn
op_rshift
l_int|3
)paren
)paren
op_plus
(paren
(paren
id|dev_fn
op_amp
l_int|7
)paren
op_lshift
l_int|8
)paren
op_plus
(paren
id|offset
op_amp
op_complement
l_int|3
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* See pci_read_config_byte */
id|out_le32
c_func
(paren
id|bp-&gt;cfg_addr
comma
(paren
id|bus
op_lshift
l_int|16
)paren
op_plus
(paren
id|dev_fn
op_lshift
l_int|8
)paren
op_plus
(paren
id|offset
op_amp
op_complement
l_int|3
)paren
op_plus
l_int|1
)paren
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|bp-&gt;cfg_data
op_plus
(paren
id|offset
op_amp
l_int|3
)paren
comma
id|val
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
id|__pmac
DECL|function|pmac_pcibios_write_config_word
r_int
id|pmac_pcibios_write_config_word
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev_fn
comma
r_int
r_char
id|offset
comma
r_int
r_int
id|val
)paren
(brace
r_struct
id|bridge_data
op_star
id|bp
suffix:semicolon
r_if
c_cond
(paren
id|bus
OG
id|max_bus
op_logical_or
(paren
id|bp
op_assign
id|bridges
(braket
id|bus
)braket
)paren
op_eq
l_int|0
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
r_if
c_cond
(paren
(paren
id|offset
op_amp
l_int|1
)paren
op_ne
l_int|0
)paren
r_return
id|PCIBIOS_BAD_REGISTER_NUMBER
suffix:semicolon
r_if
c_cond
(paren
id|bus
op_eq
id|bp-&gt;bus_number
)paren
(brace
r_if
c_cond
(paren
id|dev_fn
OL
(paren
l_int|11
op_lshift
l_int|3
)paren
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
id|out_le32
c_func
(paren
id|bp-&gt;cfg_addr
comma
(paren
l_int|1UL
op_lshift
(paren
id|dev_fn
op_rshift
l_int|3
)paren
)paren
op_plus
(paren
(paren
id|dev_fn
op_amp
l_int|7
)paren
op_lshift
l_int|8
)paren
op_plus
(paren
id|offset
op_amp
op_complement
l_int|3
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* See pci_read_config_byte */
id|out_le32
c_func
(paren
id|bp-&gt;cfg_addr
comma
(paren
id|bus
op_lshift
l_int|16
)paren
op_plus
(paren
id|dev_fn
op_lshift
l_int|8
)paren
op_plus
(paren
id|offset
op_amp
op_complement
l_int|3
)paren
op_plus
l_int|1
)paren
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|out_le16
c_func
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
(paren
id|bp-&gt;cfg_data
op_plus
(paren
id|offset
op_amp
l_int|3
)paren
)paren
comma
id|val
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
id|__pmac
DECL|function|pmac_pcibios_write_config_dword
r_int
id|pmac_pcibios_write_config_dword
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev_fn
comma
r_int
r_char
id|offset
comma
r_int
r_int
id|val
)paren
(brace
r_struct
id|bridge_data
op_star
id|bp
suffix:semicolon
r_if
c_cond
(paren
id|bus
OG
id|max_bus
op_logical_or
(paren
id|bp
op_assign
id|bridges
(braket
id|bus
)braket
)paren
op_eq
l_int|0
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
r_if
c_cond
(paren
(paren
id|offset
op_amp
l_int|3
)paren
op_ne
l_int|0
)paren
r_return
id|PCIBIOS_BAD_REGISTER_NUMBER
suffix:semicolon
r_if
c_cond
(paren
id|bus
op_eq
id|bp-&gt;bus_number
)paren
(brace
r_if
c_cond
(paren
id|dev_fn
OL
(paren
l_int|11
op_lshift
l_int|3
)paren
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
id|out_le32
c_func
(paren
id|bp-&gt;cfg_addr
comma
(paren
l_int|1UL
op_lshift
(paren
id|dev_fn
op_rshift
l_int|3
)paren
)paren
op_plus
(paren
(paren
id|dev_fn
op_amp
l_int|7
)paren
op_lshift
l_int|8
)paren
op_plus
id|offset
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* See pci_read_config_byte */
id|out_le32
c_func
(paren
id|bp-&gt;cfg_addr
comma
(paren
id|bus
op_lshift
l_int|16
)paren
op_plus
(paren
id|dev_fn
op_lshift
l_int|8
)paren
op_plus
(paren
id|offset
op_amp
op_complement
l_int|3
)paren
op_plus
l_int|1
)paren
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|out_le32
c_func
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
id|bp-&gt;cfg_data
comma
id|val
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|macro|GRACKLE_CFA
mdefine_line|#define GRACKLE_CFA(b, d, o)&t;(0x80 | ((b) &lt;&lt; 8) | ((d) &lt;&lt; 16) &bslash;&n;&t;&t;&t;&t; | (((o) &amp; ~3) &lt;&lt; 24))
DECL|function|grackle_pcibios_read_config_byte
r_int
id|grackle_pcibios_read_config_byte
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev_fn
comma
r_int
r_char
id|offset
comma
r_int
r_char
op_star
id|val
)paren
(brace
r_struct
id|bridge_data
op_star
id|bp
suffix:semicolon
op_star
id|val
op_assign
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|bus
OG
id|max_bus
op_logical_or
(paren
id|bp
op_assign
id|bridges
(braket
id|bus
)braket
)paren
op_eq
l_int|0
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
id|out_be32
c_func
(paren
id|bp-&gt;cfg_addr
comma
id|GRACKLE_CFA
c_func
(paren
id|bus
comma
id|dev_fn
comma
id|offset
)paren
)paren
suffix:semicolon
op_star
id|val
op_assign
id|in_8
c_func
(paren
id|bp-&gt;cfg_data
op_plus
(paren
id|offset
op_amp
l_int|3
)paren
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|grackle_pcibios_read_config_word
r_int
id|grackle_pcibios_read_config_word
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev_fn
comma
r_int
r_char
id|offset
comma
r_int
r_int
op_star
id|val
)paren
(brace
r_struct
id|bridge_data
op_star
id|bp
suffix:semicolon
op_star
id|val
op_assign
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
id|bus
OG
id|max_bus
op_logical_or
(paren
id|bp
op_assign
id|bridges
(braket
id|bus
)braket
)paren
op_eq
l_int|0
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
r_if
c_cond
(paren
(paren
id|offset
op_amp
l_int|1
)paren
op_ne
l_int|0
)paren
r_return
id|PCIBIOS_BAD_REGISTER_NUMBER
suffix:semicolon
id|out_be32
c_func
(paren
id|bp-&gt;cfg_addr
comma
id|GRACKLE_CFA
c_func
(paren
id|bus
comma
id|dev_fn
comma
id|offset
)paren
)paren
suffix:semicolon
op_star
id|val
op_assign
id|in_le16
c_func
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
(paren
id|bp-&gt;cfg_data
op_plus
(paren
id|offset
op_amp
l_int|3
)paren
)paren
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|grackle_pcibios_read_config_dword
r_int
id|grackle_pcibios_read_config_dword
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev_fn
comma
r_int
r_char
id|offset
comma
r_int
r_int
op_star
id|val
)paren
(brace
r_struct
id|bridge_data
op_star
id|bp
suffix:semicolon
op_star
id|val
op_assign
l_int|0xffffffff
suffix:semicolon
r_if
c_cond
(paren
id|bus
OG
id|max_bus
op_logical_or
(paren
id|bp
op_assign
id|bridges
(braket
id|bus
)braket
)paren
op_eq
l_int|0
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
r_if
c_cond
(paren
(paren
id|offset
op_amp
l_int|3
)paren
op_ne
l_int|0
)paren
r_return
id|PCIBIOS_BAD_REGISTER_NUMBER
suffix:semicolon
id|out_be32
c_func
(paren
id|bp-&gt;cfg_addr
comma
id|GRACKLE_CFA
c_func
(paren
id|bus
comma
id|dev_fn
comma
id|offset
)paren
)paren
suffix:semicolon
op_star
id|val
op_assign
id|in_le32
c_func
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
id|bp-&gt;cfg_data
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|grackle_pcibios_write_config_byte
r_int
id|grackle_pcibios_write_config_byte
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev_fn
comma
r_int
r_char
id|offset
comma
r_int
r_char
id|val
)paren
(brace
r_struct
id|bridge_data
op_star
id|bp
suffix:semicolon
r_if
c_cond
(paren
id|bus
OG
id|max_bus
op_logical_or
(paren
id|bp
op_assign
id|bridges
(braket
id|bus
)braket
)paren
op_eq
l_int|0
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
id|out_be32
c_func
(paren
id|bp-&gt;cfg_addr
comma
id|GRACKLE_CFA
c_func
(paren
id|bus
comma
id|dev_fn
comma
id|offset
)paren
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|bp-&gt;cfg_data
op_plus
(paren
id|offset
op_amp
l_int|3
)paren
comma
id|val
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|grackle_pcibios_write_config_word
r_int
id|grackle_pcibios_write_config_word
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev_fn
comma
r_int
r_char
id|offset
comma
r_int
r_int
id|val
)paren
(brace
r_struct
id|bridge_data
op_star
id|bp
suffix:semicolon
r_if
c_cond
(paren
id|bus
OG
id|max_bus
op_logical_or
(paren
id|bp
op_assign
id|bridges
(braket
id|bus
)braket
)paren
op_eq
l_int|0
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
r_if
c_cond
(paren
(paren
id|offset
op_amp
l_int|1
)paren
op_ne
l_int|0
)paren
r_return
id|PCIBIOS_BAD_REGISTER_NUMBER
suffix:semicolon
id|out_be32
c_func
(paren
id|bp-&gt;cfg_addr
comma
id|GRACKLE_CFA
c_func
(paren
id|bus
comma
id|dev_fn
comma
id|offset
)paren
)paren
suffix:semicolon
id|out_le16
c_func
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
(paren
id|bp-&gt;cfg_data
op_plus
(paren
id|offset
op_amp
l_int|3
)paren
)paren
comma
id|val
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|grackle_pcibios_write_config_dword
r_int
id|grackle_pcibios_write_config_dword
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev_fn
comma
r_int
r_char
id|offset
comma
r_int
r_int
id|val
)paren
(brace
r_struct
id|bridge_data
op_star
id|bp
suffix:semicolon
r_if
c_cond
(paren
id|bus
OG
id|max_bus
op_logical_or
(paren
id|bp
op_assign
id|bridges
(braket
id|bus
)braket
)paren
op_eq
l_int|0
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
r_if
c_cond
(paren
(paren
id|offset
op_amp
l_int|1
)paren
op_ne
l_int|0
)paren
r_return
id|PCIBIOS_BAD_REGISTER_NUMBER
suffix:semicolon
id|out_be32
c_func
(paren
id|bp-&gt;cfg_addr
comma
id|GRACKLE_CFA
c_func
(paren
id|bus
comma
id|dev_fn
comma
id|offset
)paren
)paren
suffix:semicolon
id|out_le32
c_func
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
id|bp-&gt;cfg_data
comma
id|val
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
multiline_comment|/*&n; * For a bandit bridge, turn on cache coherency if necessary.&n; * N.B. we can&squot;t use pcibios_*_config_* here because bridges[]&n; * is not initialized yet.&n; */
DECL|function|init_bandit
r_static
r_void
id|__init
id|init_bandit
c_func
(paren
r_struct
id|bridge_data
op_star
id|bp
)paren
(brace
r_int
r_int
id|vendev
comma
id|magic
suffix:semicolon
r_int
id|rev
suffix:semicolon
multiline_comment|/* read the word at offset 0 in config space for device 11 */
id|out_le32
c_func
(paren
id|bp-&gt;cfg_addr
comma
(paren
l_int|1UL
op_lshift
id|BANDIT_DEVNUM
)paren
op_plus
id|PCI_VENDOR_ID
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|vendev
op_assign
id|in_le32
c_func
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
id|bp-&gt;cfg_data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vendev
op_eq
(paren
id|BANDIT_DEVID
op_lshift
l_int|16
)paren
op_plus
id|APPLE_VENDID
)paren
(brace
multiline_comment|/* read the revision id */
id|out_le32
c_func
(paren
id|bp-&gt;cfg_addr
comma
(paren
l_int|1UL
op_lshift
id|BANDIT_DEVNUM
)paren
op_plus
id|PCI_REVISION_ID
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|rev
op_assign
id|in_8
c_func
(paren
id|bp-&gt;cfg_data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rev
op_ne
id|BANDIT_REVID
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Unknown revision %d for bandit at %p&bslash;n&quot;
comma
id|rev
comma
id|bp-&gt;io_base
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vendev
op_ne
(paren
id|BANDIT_DEVID_2
op_lshift
l_int|16
)paren
op_plus
id|APPLE_VENDID
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;bandit isn&squot;t? (%x)&bslash;n&quot;
comma
id|vendev
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* read the revision id */
id|out_le32
c_func
(paren
id|bp-&gt;cfg_addr
comma
(paren
l_int|1UL
op_lshift
id|BANDIT_DEVNUM
)paren
op_plus
id|PCI_REVISION_ID
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|rev
op_assign
id|in_8
c_func
(paren
id|bp-&gt;cfg_data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rev
op_ne
id|BANDIT_REVID
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Unknown revision %d for bandit at %p&bslash;n&quot;
comma
id|rev
comma
id|bp-&gt;io_base
)paren
suffix:semicolon
multiline_comment|/* read the word at offset 0x50 */
id|out_le32
c_func
(paren
id|bp-&gt;cfg_addr
comma
(paren
l_int|1UL
op_lshift
id|BANDIT_DEVNUM
)paren
op_plus
id|BANDIT_MAGIC
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|magic
op_assign
id|in_le32
c_func
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
id|bp-&gt;cfg_data
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|magic
op_amp
id|BANDIT_COHERENT
)paren
op_ne
l_int|0
)paren
r_return
suffix:semicolon
id|magic
op_or_assign
id|BANDIT_COHERENT
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|out_le32
c_func
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
id|bp-&gt;cfg_data
comma
id|magic
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Cache coherency enabled for bandit/PSX at %p&bslash;n&quot;
comma
id|bp-&gt;io_base
)paren
suffix:semicolon
)brace
DECL|function|pmac_find_bridges
r_void
id|__init
id|pmac_find_bridges
c_func
(paren
r_void
)paren
(brace
r_int
id|bus
suffix:semicolon
r_struct
id|bridge_data
op_star
id|bridge
suffix:semicolon
id|bridge_list
op_assign
l_int|0
suffix:semicolon
id|max_bus
op_assign
l_int|0
suffix:semicolon
id|add_bridges
c_func
(paren
id|find_devices
c_func
(paren
l_string|&quot;bandit&quot;
)paren
)paren
suffix:semicolon
id|add_bridges
c_func
(paren
id|find_devices
c_func
(paren
l_string|&quot;chaos&quot;
)paren
)paren
suffix:semicolon
id|add_bridges
c_func
(paren
id|find_devices
c_func
(paren
l_string|&quot;pci&quot;
)paren
)paren
suffix:semicolon
id|bridges
op_assign
(paren
r_struct
id|bridge_data
op_star
op_star
)paren
id|alloc_bootmem
c_func
(paren
(paren
id|max_bus
op_plus
l_int|1
)paren
op_star
r_sizeof
(paren
r_struct
id|bridge_data
op_star
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|bridges
comma
l_int|0
comma
(paren
id|max_bus
op_plus
l_int|1
)paren
op_star
r_sizeof
(paren
r_struct
id|bridge_data
op_star
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|bridge
op_assign
id|bridge_list
suffix:semicolon
id|bridge
op_ne
l_int|NULL
suffix:semicolon
id|bridge
op_assign
id|bridge-&gt;next
)paren
r_for
c_loop
(paren
id|bus
op_assign
id|bridge-&gt;bus_number
suffix:semicolon
id|bus
op_le
id|bridge-&gt;max_bus
suffix:semicolon
op_increment
id|bus
)paren
id|bridges
(braket
id|bus
)braket
op_assign
id|bridge
suffix:semicolon
)brace
multiline_comment|/*&n; * We assume that if we have a G3 powermac, we have one bridge called&n; * &quot;pci&quot; (a MPC106) and no bandit or chaos bridges, and contrariwise,&n; * if we have one or more bandit or chaos bridges, we don&squot;t have a MPC106.&n; */
DECL|function|add_bridges
r_static
r_void
id|__init
id|add_bridges
c_func
(paren
r_struct
id|device_node
op_star
id|dev
)paren
(brace
r_int
op_star
id|bus_range
suffix:semicolon
r_int
id|len
suffix:semicolon
r_struct
id|bridge_data
op_star
id|bp
suffix:semicolon
r_struct
id|reg_property
op_star
id|addr
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|dev
op_ne
l_int|NULL
suffix:semicolon
id|dev
op_assign
id|dev-&gt;next
)paren
(brace
id|addr
op_assign
(paren
r_struct
id|reg_property
op_star
)paren
id|get_property
c_func
(paren
id|dev
comma
l_string|&quot;reg&quot;
comma
op_amp
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_eq
l_int|NULL
op_logical_or
id|len
OL
r_sizeof
(paren
op_star
id|addr
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Can&squot;t use %s: no address&bslash;n&quot;
comma
id|dev-&gt;full_name
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|bus_range
op_assign
(paren
r_int
op_star
)paren
id|get_property
c_func
(paren
id|dev
comma
l_string|&quot;bus-range&quot;
comma
op_amp
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bus_range
op_eq
l_int|NULL
op_logical_or
id|len
OL
l_int|2
op_star
r_sizeof
(paren
r_int
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Can&squot;t get bus-range for %s&bslash;n&quot;
comma
id|dev-&gt;full_name
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bus_range
(braket
l_int|1
)braket
op_eq
id|bus_range
(braket
l_int|0
)braket
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PCI bus %d&quot;
comma
id|bus_range
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PCI buses %d..%d&quot;
comma
id|bus_range
(braket
l_int|0
)braket
comma
id|bus_range
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; controlled by %s at %x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|addr-&gt;address
)paren
suffix:semicolon
id|bp
op_assign
(paren
r_struct
id|bridge_data
op_star
)paren
id|alloc_bootmem
c_func
(paren
r_sizeof
(paren
op_star
id|bp
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|dev-&gt;name
comma
l_string|&quot;pci&quot;
)paren
op_ne
l_int|0
)paren
(brace
id|bp-&gt;cfg_addr
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|ioremap
c_func
(paren
id|addr-&gt;address
op_plus
l_int|0x800000
comma
l_int|0x1000
)paren
suffix:semicolon
id|bp-&gt;cfg_data
op_assign
(paren
r_volatile
r_int
r_char
op_star
)paren
id|ioremap
c_func
(paren
id|addr-&gt;address
op_plus
l_int|0xc00000
comma
l_int|0x1000
)paren
suffix:semicolon
id|bp-&gt;io_base
op_assign
(paren
r_void
op_star
)paren
id|ioremap
c_func
(paren
id|addr-&gt;address
comma
l_int|0x10000
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* XXX */
id|bp-&gt;cfg_addr
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|ioremap
c_func
(paren
l_int|0xfec00000
comma
l_int|0x1000
)paren
suffix:semicolon
id|bp-&gt;cfg_data
op_assign
(paren
r_volatile
r_int
r_char
op_star
)paren
id|ioremap
c_func
(paren
l_int|0xfee00000
comma
l_int|0x1000
)paren
suffix:semicolon
id|bp-&gt;io_base
op_assign
(paren
r_void
op_star
)paren
id|ioremap
c_func
(paren
l_int|0xfe000000
comma
l_int|0x20000
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|isa_io_base
op_eq
l_int|0
)paren
id|isa_io_base
op_assign
(paren
r_int
r_int
)paren
id|bp-&gt;io_base
suffix:semicolon
id|bp-&gt;bus_number
op_assign
id|bus_range
(braket
l_int|0
)braket
suffix:semicolon
id|bp-&gt;max_bus
op_assign
id|bus_range
(braket
l_int|1
)braket
suffix:semicolon
id|bp-&gt;next
op_assign
id|bridge_list
suffix:semicolon
id|bp-&gt;node
op_assign
id|dev
suffix:semicolon
id|bridge_list
op_assign
id|bp
suffix:semicolon
r_if
c_cond
(paren
id|bp-&gt;max_bus
OG
id|max_bus
)paren
id|max_bus
op_assign
id|bp-&gt;max_bus
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|dev-&gt;name
comma
l_string|&quot;bandit&quot;
)paren
op_eq
l_int|0
)paren
id|init_bandit
c_func
(paren
id|bp
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Recursively searches any node that is of type PCI-PCI bridge. Without&n; * this, the old code would miss children of P2P bridges and hence not&n; * fix IRQ&squot;s for cards located behind P2P bridges.&n; * - Ranjit Deshpande, 01/20/99&n; */
r_void
id|__init
DECL|function|fix_intr
id|fix_intr
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_int
r_int
op_star
id|reg
comma
op_star
id|class_code
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|node
op_ne
l_int|0
suffix:semicolon
id|node
op_assign
id|node-&gt;sibling
)paren
(brace
id|class_code
op_assign
(paren
r_int
r_int
op_star
)paren
id|get_property
c_func
(paren
id|node
comma
l_string|&quot;class-code&quot;
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|class_code
op_rshift
l_int|8
)paren
op_eq
id|PCI_CLASS_BRIDGE_PCI
)paren
(brace
id|fix_intr
c_func
(paren
id|node-&gt;child
comma
id|dev
)paren
suffix:semicolon
)brace
id|reg
op_assign
(paren
r_int
r_int
op_star
)paren
id|get_property
c_func
(paren
id|node
comma
l_string|&quot;reg&quot;
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_eq
l_int|0
op_logical_or
(paren
(paren
id|reg
(braket
l_int|0
)braket
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
op_ne
id|dev-&gt;devfn
)paren
r_continue
suffix:semicolon
multiline_comment|/* this is the node, see if it has interrupts */
r_if
c_cond
(paren
id|node-&gt;n_intrs
OG
l_int|0
)paren
id|dev-&gt;irq
op_assign
id|node-&gt;intrs
(braket
l_int|0
)braket
dot
id|line
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_void
id|__init
DECL|function|pmac_pcibios_fixup
id|pmac_pcibios_fixup
c_func
(paren
r_void
)paren
(brace
r_struct
id|pci_dev
op_star
id|dev
suffix:semicolon
multiline_comment|/*&n;&t; * FIXME: This is broken: We should not assign IRQ&squot;s to IRQless&n;&t; *&t;  devices (look at PCI_INTERRUPT_PIN) and we also should&n;&t; *&t;  honor the existence of multi-function devices where&n;&t; *&t;  different functions have different interrupt pins. [mj]&n;&t; */
r_for
c_loop
(paren
id|dev
op_assign
id|pci_devices
suffix:semicolon
id|dev
suffix:semicolon
id|dev
op_assign
id|dev-&gt;next
)paren
(brace
multiline_comment|/*&n;&t;&t; * Open Firmware often doesn&squot;t initialize the,&n;&t;&t; * PCI_INTERRUPT_LINE config register properly, so we&n;&t;&t; * should find the device node and se if it has an&n;&t;&t; * AAPL,interrupts property.&n;&t;&t; */
r_struct
id|bridge_data
op_star
id|bp
op_assign
id|bridges
(braket
id|dev-&gt;bus-&gt;number
)braket
suffix:semicolon
r_int
r_char
id|pin
suffix:semicolon
r_if
c_cond
(paren
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|PCI_INTERRUPT_PIN
comma
op_amp
id|pin
)paren
op_logical_or
op_logical_neg
id|pin
)paren
r_continue
suffix:semicolon
multiline_comment|/* No interrupt generated -&gt; no fixup */
id|fix_intr
c_func
(paren
id|bp-&gt;node-&gt;child
comma
id|dev
)paren
suffix:semicolon
)brace
)brace
r_void
id|__init
DECL|function|pmac_setup_pci_ptrs
id|pmac_setup_pci_ptrs
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|find_devices
c_func
(paren
l_string|&quot;pci&quot;
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* looks like a G3 powermac */
id|set_config_access_method
c_func
(paren
id|grackle
)paren
suffix:semicolon
)brace
r_else
(brace
id|set_config_access_method
c_func
(paren
id|pmac
)paren
suffix:semicolon
)brace
id|ppc_md.pcibios_fixup
op_assign
id|pmac_pcibios_fixup
suffix:semicolon
)brace
eof
