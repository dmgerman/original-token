multiline_comment|/* Minimal serial functions needed to send messages out the serial&n; * port on the MBX console.&n; *&n; * The MBX uxes SMC1 for the serial port.  We reset the port and use&n; * only the first BD that EPPC-Bug set up as a character FIFO.&n; *&n; * It&squot;s a big hack, but I don&squot;t have time right now....I want a kernel&n; * that boots.&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;asm/mbx.h&gt;
macro_line|#include &quot;../8xx_io/commproc.h&quot;
DECL|macro|CPM_CPCR
mdefine_line|#define CPM_CPCR&t;((volatile ushort *)0xfa2009c0)
DECL|macro|SMC1_MODE
mdefine_line|#define SMC1_MODE&t;((volatile ushort *)0xfa200a82)
DECL|macro|SMC1_TBDF
mdefine_line|#define SMC1_TBDF&t;((volatile bd_t *)0xfa202c90)
DECL|macro|SMC1_RBDF
mdefine_line|#define SMC1_RBDF&t;((volatile bd_t *)0xfa202c10)
DECL|variable|cpmp
r_static
id|cpm8xx_t
op_star
id|cpmp
op_assign
(paren
id|cpm8xx_t
op_star
)paren
op_amp
(paren
(paren
(paren
id|immap_t
op_star
)paren
id|MBX_IMAP_ADDR
)paren
op_member_access_from_pointer
id|im_cpm
)paren
suffix:semicolon
r_void
DECL|function|serial_init
id|serial_init
c_func
(paren
r_void
)paren
(brace
r_volatile
id|smc_t
op_star
id|sp
suffix:semicolon
r_volatile
id|smc_uart_t
op_star
id|up
suffix:semicolon
r_volatile
id|cbd_t
op_star
id|tbdf
comma
op_star
id|rbdf
suffix:semicolon
r_volatile
id|cpm8xx_t
op_star
id|cp
suffix:semicolon
id|cp
op_assign
id|cpmp
suffix:semicolon
id|sp
op_assign
(paren
id|smc_t
op_star
)paren
op_amp
(paren
id|cp-&gt;cp_smc
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|up
op_assign
(paren
id|smc_uart_t
op_star
)paren
op_amp
id|cp-&gt;cp_dparam
(braket
id|PROFF_SMC1
)braket
suffix:semicolon
multiline_comment|/* Disable transmitter/receiver.&n;&t;*/
id|sp-&gt;smc_smcm
op_and_assign
op_complement
(paren
id|SMCMR_REN
op_or
id|SMCMR_TEN
)paren
suffix:semicolon
id|tbdf
op_assign
(paren
id|cbd_t
op_star
)paren
op_amp
id|cp-&gt;cp_dpmem
(braket
id|up-&gt;smc_tbase
)braket
suffix:semicolon
id|rbdf
op_assign
(paren
id|cbd_t
op_star
)paren
op_amp
id|cp-&gt;cp_dpmem
(braket
id|up-&gt;smc_rbase
)braket
suffix:semicolon
multiline_comment|/* Issue a stop transmit, and wait for it.&n;&t;*/
id|cp-&gt;cp_cpcr
op_assign
id|mk_cr_cmd
c_func
(paren
id|CPM_CR_CH_SMC1
comma
id|CPM_CR_STOP_TX
)paren
op_or
id|CPM_CR_FLG
suffix:semicolon
r_while
c_loop
(paren
id|cp-&gt;cp_cpcr
op_amp
id|CPM_CR_FLG
)paren
suffix:semicolon
multiline_comment|/* Make the first buffer the only buffer.&n;&t;*/
id|tbdf-&gt;cbd_sc
op_or_assign
id|BD_SC_WRAP
suffix:semicolon
id|rbdf-&gt;cbd_sc
op_or_assign
id|BD_SC_EMPTY
op_or
id|BD_SC_WRAP
suffix:semicolon
multiline_comment|/* Single character receive.&n;&t;*/
id|up-&gt;smc_mrblr
op_assign
l_int|1
suffix:semicolon
id|up-&gt;smc_maxidl
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Initialize Tx/Rx parameters.&n;&t;*/
id|cp-&gt;cp_cpcr
op_assign
id|mk_cr_cmd
c_func
(paren
id|CPM_CR_CH_SMC1
comma
id|CPM_CR_INIT_TRX
)paren
op_or
id|CPM_CR_FLG
suffix:semicolon
r_while
c_loop
(paren
id|cp-&gt;cp_cpcr
op_amp
id|CPM_CR_FLG
)paren
suffix:semicolon
multiline_comment|/* Enable transmitter/receiver.&n;&t;*/
id|sp-&gt;smc_smcm
op_or_assign
id|SMCMR_REN
op_or
id|SMCMR_TEN
suffix:semicolon
)brace
r_void
DECL|function|serial_putchar
id|serial_putchar
c_func
(paren
r_const
r_char
id|c
)paren
(brace
r_volatile
id|cbd_t
op_star
id|tbdf
suffix:semicolon
r_volatile
r_char
op_star
id|buf
suffix:semicolon
r_volatile
id|smc_uart_t
op_star
id|up
suffix:semicolon
id|up
op_assign
(paren
id|smc_uart_t
op_star
)paren
op_amp
id|cpmp-&gt;cp_dparam
(braket
id|PROFF_SMC1
)braket
suffix:semicolon
id|tbdf
op_assign
(paren
id|cbd_t
op_star
)paren
op_amp
id|cpmp-&gt;cp_dpmem
(braket
id|up-&gt;smc_tbase
)braket
suffix:semicolon
multiline_comment|/* Wait for last character to go.&n;&t;*/
id|buf
op_assign
(paren
r_char
op_star
)paren
id|tbdf-&gt;cbd_bufaddr
suffix:semicolon
r_while
c_loop
(paren
id|tbdf-&gt;cbd_sc
op_amp
id|BD_SC_READY
)paren
suffix:semicolon
op_star
id|buf
op_assign
id|c
suffix:semicolon
id|tbdf-&gt;cbd_datlen
op_assign
l_int|1
suffix:semicolon
id|tbdf-&gt;cbd_sc
op_or_assign
id|BD_SC_READY
suffix:semicolon
)brace
r_char
DECL|function|serial_getc
id|serial_getc
c_func
(paren
)paren
(brace
r_volatile
id|cbd_t
op_star
id|rbdf
suffix:semicolon
r_volatile
r_char
op_star
id|buf
suffix:semicolon
r_volatile
id|smc_uart_t
op_star
id|up
suffix:semicolon
r_char
id|c
suffix:semicolon
id|up
op_assign
(paren
id|smc_uart_t
op_star
)paren
op_amp
id|cpmp-&gt;cp_dparam
(braket
id|PROFF_SMC1
)braket
suffix:semicolon
id|rbdf
op_assign
(paren
id|cbd_t
op_star
)paren
op_amp
id|cpmp-&gt;cp_dpmem
(braket
id|up-&gt;smc_rbase
)braket
suffix:semicolon
multiline_comment|/* Wait for character to show up.&n;&t;*/
id|buf
op_assign
(paren
r_char
op_star
)paren
id|rbdf-&gt;cbd_bufaddr
suffix:semicolon
r_while
c_loop
(paren
id|rbdf-&gt;cbd_sc
op_amp
id|BD_SC_EMPTY
)paren
suffix:semicolon
id|c
op_assign
op_star
id|buf
suffix:semicolon
id|rbdf-&gt;cbd_sc
op_or_assign
id|BD_SC_EMPTY
suffix:semicolon
r_return
id|c
suffix:semicolon
)brace
r_int
DECL|function|serial_tstc
id|serial_tstc
c_func
(paren
)paren
(brace
r_volatile
id|cbd_t
op_star
id|rbdf
suffix:semicolon
r_volatile
id|smc_uart_t
op_star
id|up
suffix:semicolon
id|up
op_assign
(paren
id|smc_uart_t
op_star
)paren
op_amp
id|cpmp-&gt;cp_dparam
(braket
id|PROFF_SMC1
)braket
suffix:semicolon
id|rbdf
op_assign
(paren
id|cbd_t
op_star
)paren
op_amp
id|cpmp-&gt;cp_dpmem
(braket
id|up-&gt;smc_rbase
)braket
suffix:semicolon
r_return
op_logical_neg
(paren
id|rbdf-&gt;cbd_sc
op_amp
id|BD_SC_EMPTY
)paren
suffix:semicolon
)brace
eof
