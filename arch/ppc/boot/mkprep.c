multiline_comment|/*&n; * This program will make a type 0x41 load image from an&n; * executable file.  Note:  assumes that the executable has&n; * already been &quot;flattened&quot; by &squot;mkboot&squot;.&n; *&n; * usage: mk_type41 flat-file image&n; */
macro_line|#include &lt;stdio.h&gt;
macro_line|#include &lt;errno.h&gt;
macro_line|#ifdef linux
macro_line|#include &lt;asm/stat.h&gt;
macro_line|#else
macro_line|#include &lt;sys/stat.h&gt;
macro_line|#endif
macro_line|#include &lt;asm/byteorder.h&gt; /* use same as kernel -- Cort */
DECL|typedef|dword_t
r_typedef
r_int
r_int
id|dword_t
suffix:semicolon
DECL|typedef|word_t
r_typedef
r_int
r_int
id|word_t
suffix:semicolon
DECL|typedef|byte_t
r_typedef
r_int
r_char
id|byte_t
suffix:semicolon
DECL|typedef|block_t
r_typedef
id|byte_t
id|block_t
(braket
l_int|512
)braket
suffix:semicolon
DECL|typedef|page_t
r_typedef
id|byte_t
id|page_t
(braket
l_int|4096
)braket
suffix:semicolon
DECL|function|_LE
id|_LE
c_func
(paren
r_int
id|val
comma
r_int
r_char
op_star
id|le
)paren
(brace
id|le
(braket
l_int|0
)braket
op_assign
id|val
suffix:semicolon
id|le
(braket
l_int|1
)braket
op_assign
id|val
op_rshift
l_int|8
suffix:semicolon
id|le
(braket
l_int|2
)braket
op_assign
id|val
op_rshift
l_int|16
suffix:semicolon
id|le
(braket
l_int|3
)braket
op_assign
id|val
op_rshift
l_int|24
suffix:semicolon
)brace
multiline_comment|/*&n; * Partition table entry&n; *  - from the PReP spec&n; */
DECL|struct|partition_entry
r_typedef
r_struct
id|partition_entry
(brace
DECL|member|boot_indicator
id|byte_t
id|boot_indicator
suffix:semicolon
DECL|member|starting_head
id|byte_t
id|starting_head
suffix:semicolon
DECL|member|starting_sector
id|byte_t
id|starting_sector
suffix:semicolon
DECL|member|starting_cylinder
id|byte_t
id|starting_cylinder
suffix:semicolon
DECL|member|system_indicator
id|byte_t
id|system_indicator
suffix:semicolon
DECL|member|ending_head
id|byte_t
id|ending_head
suffix:semicolon
DECL|member|ending_sector
id|byte_t
id|ending_sector
suffix:semicolon
DECL|member|ending_cylinder
id|byte_t
id|ending_cylinder
suffix:semicolon
DECL|member|beginning_sector
id|dword_t
id|beginning_sector
suffix:semicolon
DECL|member|number_of_sectors
id|dword_t
id|number_of_sectors
suffix:semicolon
DECL|typedef|partition_entry_t
)brace
id|partition_entry_t
suffix:semicolon
DECL|macro|BootActive
mdefine_line|#define BootActive&t;0x80
DECL|macro|SystemPrep
mdefine_line|#define SystemPrep&t;0x41
DECL|function|main
r_int
id|main
c_func
(paren
r_int
id|argc
comma
r_char
op_star
id|argv
(braket
)braket
)paren
(brace
r_struct
id|stat
id|info
suffix:semicolon
r_char
id|buf
(braket
l_int|8192
)braket
suffix:semicolon
r_int
id|in_fd
comma
id|out_fd
comma
id|len
suffix:semicolon
r_int
r_char
id|block
(braket
l_int|512
)braket
suffix:semicolon
id|partition_entry_t
op_star
id|pe
op_assign
(paren
id|partition_entry_t
op_star
)paren
op_amp
id|block
(braket
l_int|0x1BE
)braket
suffix:semicolon
id|dword_t
op_star
id|entry
op_assign
(paren
id|dword_t
op_star
)paren
op_amp
id|block
(braket
l_int|0x50
)braket
suffix:semicolon
id|dword_t
op_star
id|length
op_assign
(paren
id|dword_t
op_star
)paren
op_amp
id|block
(braket
l_int|0x51
)braket
suffix:semicolon
r_if
c_cond
(paren
id|argc
op_ne
l_int|3
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;usage: mk_type41 &lt;boot-file&gt; &lt;image&gt;&bslash;n&quot;
)paren
suffix:semicolon
m_exit
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|in_fd
op_assign
id|open
c_func
(paren
id|argv
(braket
l_int|1
)braket
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
m_exit
(paren
l_int|2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|out_fd
op_assign
id|creat
c_func
(paren
id|argv
(braket
l_int|2
)braket
comma
l_int|0755
)paren
)paren
OL
l_int|0
)paren
(brace
m_exit
(paren
l_int|2
)paren
suffix:semicolon
)brace
id|bzero
c_func
(paren
op_amp
id|block
comma
r_sizeof
id|block
)paren
suffix:semicolon
multiline_comment|/*&n;   * Magic marker&n;   */
id|block
(braket
l_int|510
)braket
op_assign
l_int|0x55
suffix:semicolon
id|block
(braket
l_int|511
)braket
op_assign
l_int|0xAA
suffix:semicolon
id|pe-&gt;boot_indicator
op_assign
id|BootActive
suffix:semicolon
id|pe-&gt;system_indicator
op_assign
id|SystemPrep
suffix:semicolon
id|pe-&gt;starting_head
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* zero-based&t;&t;&t;     */
id|pe-&gt;starting_sector
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* one-based&t;&t;&t;     */
id|pe-&gt;starting_cylinder
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* zero-based&t;&t;&t;     */
id|pe-&gt;ending_head
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* assumes two heads&t;&t;     */
id|pe-&gt;ending_sector
op_assign
l_int|18
suffix:semicolon
multiline_comment|/* assumes 18 sectors/track&t;     */
id|pe-&gt;ending_cylinder
op_assign
l_int|79
suffix:semicolon
multiline_comment|/* assumes 80 cylinders/diskette     */
macro_line|#if 0
macro_line|#if 0    
id|pe-&gt;beginning_sector
op_assign
id|LeDword
c_func
(paren
l_int|1
)paren
suffix:semicolon
macro_line|#else
multiline_comment|/* This has to be 0 on the PowerStack? */
id|pe-&gt;beginning_sector
op_assign
id|LeDword
c_func
(paren
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|pe-&gt;number_of_sectors
op_assign
id|LeDword
c_func
(paren
l_int|2
op_star
l_int|18
op_star
l_int|80
op_minus
l_int|1
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|fstat
c_func
(paren
id|in_fd
comma
op_amp
id|info
)paren
OL
l_int|0
)paren
(brace
m_exit
(paren
l_int|4
)paren
suffix:semicolon
)brace
multiline_comment|/* begin execution at 0x400 */
id|_LE
c_func
(paren
l_int|0x400
comma
(paren
r_int
r_char
op_star
)paren
id|entry
)paren
suffix:semicolon
id|_LE
c_func
(paren
id|info.st_size
op_plus
l_int|0x400
comma
id|length
)paren
suffix:semicolon
id|lseek
c_func
(paren
id|out_fd
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* write out 1st block */
id|write
c_func
(paren
id|out_fd
comma
id|block
comma
r_sizeof
id|block
)paren
suffix:semicolon
multiline_comment|/* copy image */
macro_line|#if 1 
id|lseek
c_func
(paren
id|out_fd
comma
l_int|0x400
comma
l_int|0
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|len
op_assign
id|read
c_func
(paren
id|in_fd
comma
id|buf
comma
r_sizeof
(paren
id|buf
)paren
)paren
)paren
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|write
c_func
(paren
id|out_fd
comma
id|buf
comma
id|len
)paren
op_ne
id|len
)paren
(brace
m_exit
(paren
l_int|5
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
(brace
m_exit
(paren
l_int|6
)paren
suffix:semicolon
)brace
id|close
c_func
(paren
id|in_fd
)paren
suffix:semicolon
id|close
c_func
(paren
id|out_fd
)paren
suffix:semicolon
macro_line|#endif&t;
r_return
l_int|0
suffix:semicolon
)brace
eof
