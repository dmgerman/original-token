macro_line|#include &lt;linux/keyboard.h&gt;
macro_line|#include &lt;../drivers/char/defkeymap.c&gt;&t;/* yeah I know it&squot;s bad -- Cort */
DECL|variable|shfts
DECL|variable|ctls
DECL|variable|alts
DECL|variable|caps
r_int
r_char
id|shfts
comma
id|ctls
comma
id|alts
comma
id|caps
suffix:semicolon
DECL|macro|KBDATAP
mdefine_line|#define&t;KBDATAP&t;&t;0x60&t;/* kbd data port */
DECL|macro|KBSTATUSPORT
mdefine_line|#define&t;KBSTATUSPORT&t;0x61&t;/* kbd status */
DECL|macro|KBSTATP
mdefine_line|#define&t;KBSTATP&t;&t;0x64&t;/* kbd status port */
DECL|macro|KBINRDY
mdefine_line|#define&t;KBINRDY&t;&t;0x01
DECL|macro|KBOUTRDY
mdefine_line|#define&t;KBOUTRDY&t;0x02
DECL|function|kbd
r_static
r_int
id|kbd
c_func
(paren
r_int
id|noblock
)paren
(brace
r_int
r_char
id|dt
comma
id|brk
comma
id|val
suffix:semicolon
r_int
id|code
suffix:semicolon
id|loop
suffix:colon
r_if
c_cond
(paren
id|noblock
)paren
(brace
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|KBSTATP
)paren
op_amp
id|KBINRDY
)paren
op_eq
l_int|0
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_else
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|KBSTATP
)paren
op_amp
id|KBINRDY
)paren
op_eq
l_int|0
)paren
(brace
suffix:semicolon
)brace
id|dt
op_assign
id|inb
c_func
(paren
id|KBDATAP
)paren
suffix:semicolon
id|brk
op_assign
id|dt
op_amp
l_int|0x80
suffix:semicolon
multiline_comment|/* brk == 1 on key release */
id|dt
op_assign
id|dt
op_amp
l_int|0x7f
suffix:semicolon
multiline_comment|/* keycode */
r_if
c_cond
(paren
id|shfts
)paren
id|code
op_assign
id|shift_map
(braket
id|dt
)braket
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ctls
)paren
id|code
op_assign
id|ctrl_map
(braket
id|dt
)braket
suffix:semicolon
r_else
id|code
op_assign
id|plain_map
(braket
id|dt
)braket
suffix:semicolon
id|val
op_assign
id|KVAL
c_func
(paren
id|code
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|KTYP
c_func
(paren
id|code
)paren
op_amp
l_int|0x0f
)paren
(brace
r_case
id|KT_LATIN
suffix:colon
r_if
c_cond
(paren
id|brk
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|alts
)paren
id|val
op_or_assign
l_int|0x80
suffix:semicolon
r_if
c_cond
(paren
id|val
op_eq
l_int|0x7f
)paren
multiline_comment|/* map delete to backspace */
id|val
op_assign
l_char|&squot;&bslash;b&squot;
suffix:semicolon
r_return
id|val
suffix:semicolon
r_case
id|KT_LETTER
suffix:colon
r_if
c_cond
(paren
id|brk
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|caps
)paren
id|val
op_sub_assign
l_char|&squot;a&squot;
op_minus
l_char|&squot;A&squot;
suffix:semicolon
r_return
id|val
suffix:semicolon
r_case
id|KT_SPEC
suffix:colon
r_if
c_cond
(paren
id|brk
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|val
op_eq
id|KVAL
c_func
(paren
id|K_CAPS
)paren
)paren
id|caps
op_assign
op_logical_neg
id|caps
suffix:semicolon
r_else
r_if
c_cond
(paren
id|val
op_eq
id|KVAL
c_func
(paren
id|K_ENTER
)paren
)paren
(brace
id|enter
suffix:colon
multiline_comment|/* Wait for key up */
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|KBSTATP
)paren
op_amp
id|KBINRDY
)paren
op_eq
l_int|0
)paren
(brace
suffix:semicolon
)brace
id|dt
op_assign
id|inb
c_func
(paren
id|KBDATAP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dt
op_amp
l_int|0x80
)paren
multiline_comment|/* key up */
r_break
suffix:semicolon
)brace
r_return
l_int|10
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|KT_PAD
suffix:colon
r_if
c_cond
(paren
id|brk
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|val
OL
l_int|10
)paren
r_return
id|val
suffix:semicolon
r_if
c_cond
(paren
id|val
op_eq
id|KVAL
c_func
(paren
id|K_PENTER
)paren
)paren
r_goto
id|enter
suffix:semicolon
r_break
suffix:semicolon
r_case
id|KT_SHIFT
suffix:colon
r_switch
c_cond
(paren
id|val
)paren
(brace
r_case
id|KG_SHIFT
suffix:colon
r_case
id|KG_SHIFTL
suffix:colon
r_case
id|KG_SHIFTR
suffix:colon
id|shfts
op_assign
id|brk
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|KG_ALT
suffix:colon
r_case
id|KG_ALTGR
suffix:colon
id|alts
op_assign
id|brk
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|KG_CTRL
suffix:colon
r_case
id|KG_CTRLL
suffix:colon
r_case
id|KG_CTRLR
suffix:colon
id|ctls
op_assign
id|brk
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|KT_LOCK
suffix:colon
r_switch
c_cond
(paren
id|val
)paren
(brace
r_case
id|KG_SHIFT
suffix:colon
r_case
id|KG_SHIFTL
suffix:colon
r_case
id|KG_SHIFTR
suffix:colon
r_if
c_cond
(paren
id|brk
)paren
id|shfts
op_assign
op_logical_neg
id|shfts
suffix:semicolon
r_break
suffix:semicolon
r_case
id|KG_ALT
suffix:colon
r_case
id|KG_ALTGR
suffix:colon
r_if
c_cond
(paren
id|brk
)paren
id|alts
op_assign
op_logical_neg
id|alts
suffix:semicolon
r_break
suffix:semicolon
r_case
id|KG_CTRL
suffix:colon
r_case
id|KG_CTRLL
suffix:colon
r_case
id|KG_CTRLR
suffix:colon
r_if
c_cond
(paren
id|brk
)paren
id|ctls
op_assign
op_logical_neg
id|ctls
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|brk
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Ignore initial &squot;key up&squot; codes */
r_goto
id|loop
suffix:semicolon
)brace
DECL|function|kbdreset
r_static
r_void
id|kbdreset
c_func
(paren
r_void
)paren
(brace
r_int
r_char
id|c
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* flush input queue */
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|KBSTATP
)paren
op_amp
id|KBINRDY
)paren
)paren
(brace
(paren
r_void
)paren
id|inb
c_func
(paren
id|KBDATAP
)paren
suffix:semicolon
)brace
multiline_comment|/* Send self-test */
r_while
c_loop
(paren
id|inb
c_func
(paren
id|KBSTATP
)paren
op_amp
id|KBOUTRDY
)paren
suffix:semicolon
id|outb
c_func
(paren
id|KBSTATP
comma
l_int|0xAA
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|KBSTATP
)paren
op_amp
id|KBINRDY
)paren
op_eq
l_int|0
)paren
suffix:semicolon
multiline_comment|/* wait input ready */
r_if
c_cond
(paren
(paren
id|c
op_assign
id|inb
c_func
(paren
id|KBDATAP
)paren
)paren
op_ne
l_int|0x55
)paren
(brace
id|puts
c_func
(paren
l_string|&quot;Keyboard self test failed - result:&quot;
)paren
suffix:semicolon
id|puthex
c_func
(paren
id|c
)paren
suffix:semicolon
id|puts
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Enable interrupts and keyboard controller */
r_while
c_loop
(paren
id|inb
c_func
(paren
id|KBSTATP
)paren
op_amp
id|KBOUTRDY
)paren
suffix:semicolon
id|outb
c_func
(paren
id|KBSTATP
comma
l_int|0x60
)paren
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|KBSTATP
)paren
op_amp
id|KBOUTRDY
)paren
suffix:semicolon
id|outb
c_func
(paren
id|KBDATAP
comma
l_int|0x45
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10000
suffix:semicolon
id|i
op_increment
)paren
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|KBSTATP
)paren
op_amp
id|KBOUTRDY
)paren
suffix:semicolon
id|outb
c_func
(paren
id|KBSTATP
comma
l_int|0x20
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|KBSTATP
)paren
op_amp
id|KBINRDY
)paren
op_eq
l_int|0
)paren
suffix:semicolon
multiline_comment|/* wait input ready */
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|KBDATAP
)paren
op_amp
l_int|0x40
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * Quote from PS/2 System Reference Manual:&n;&t;&t; *&n;&t;&t; * &quot;Address hex 0060 and address hex 0064 should be&n;&t;&t; * written only when the input-buffer-full bit and&n;&t;&t; * output-buffer-full bit in the Controller Status&n;&t;&t; * register are set 0.&quot; (KBINRDY and KBOUTRDY)&n;&t;&t; */
r_while
c_loop
(paren
id|inb
c_func
(paren
id|KBSTATP
)paren
op_amp
(paren
id|KBINRDY
op_or
id|KBOUTRDY
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|KBDATAP
comma
l_int|0xF0
)paren
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|KBSTATP
)paren
op_amp
(paren
id|KBINRDY
op_or
id|KBOUTRDY
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|KBDATAP
comma
l_int|0x01
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|inb
c_func
(paren
id|KBSTATP
)paren
op_amp
id|KBOUTRDY
)paren
suffix:semicolon
id|outb
c_func
(paren
id|KBSTATP
comma
l_int|0xAE
)paren
suffix:semicolon
)brace
multiline_comment|/* We have to actually read the keyboard when CRT_tstc is called,&n; * since the pending data might be a key release code, and therefore&n; * not valid data.  In this case, kbd() will return -1, even though there&squot;s&n; * data to be read.  Of course, we might actually read a valid key press,&n; * in which case it gets queued into key_pending for use by CRT_getc.&n; */
DECL|variable|kbd_reset
r_static
r_int
id|kbd_reset
op_assign
l_int|0
suffix:semicolon
DECL|variable|key_pending
r_static
r_int
id|key_pending
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|function|CRT_getc
r_int
id|CRT_getc
c_func
(paren
r_void
)paren
(brace
r_int
id|c
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|kbd_reset
)paren
(brace
id|kbdreset
c_func
(paren
)paren
suffix:semicolon
id|kbd_reset
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|key_pending
op_ne
op_minus
l_int|1
)paren
(brace
id|c
op_assign
id|key_pending
suffix:semicolon
id|key_pending
op_assign
op_minus
l_int|1
suffix:semicolon
r_return
id|c
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
(paren
id|c
op_assign
id|kbd
c_func
(paren
l_int|0
)paren
)paren
op_eq
l_int|0
)paren
suffix:semicolon
r_return
id|c
suffix:semicolon
)brace
)brace
DECL|function|CRT_tstc
r_int
id|CRT_tstc
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|kbd_reset
)paren
(brace
id|kbdreset
c_func
(paren
)paren
suffix:semicolon
id|kbd_reset
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|key_pending
op_eq
op_minus
l_int|1
op_logical_and
(paren
(paren
id|inb
c_func
(paren
id|KBSTATP
)paren
op_amp
id|KBINRDY
)paren
op_ne
l_int|0
)paren
)paren
(brace
id|key_pending
op_assign
id|kbd
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_return
(paren
id|key_pending
op_ne
op_minus
l_int|1
)paren
suffix:semicolon
)brace
eof
