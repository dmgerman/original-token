multiline_comment|/*&n;**  linux/amiga/chipram.c&n;**&n;**      Modified 03-May-94 by Geert Uytterhoeven &lt;geert@linux-m68k.org&gt;&n;**          - 64-bit aligned allocations for full AGA compatibility&n;*/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/zorro.h&gt;
macro_line|#include &lt;asm/amigahw.h&gt;
DECL|struct|chip_desc
r_struct
id|chip_desc
(brace
DECL|member|first
r_int
id|first
suffix:colon
l_int|1
suffix:semicolon
DECL|member|last
r_int
id|last
suffix:colon
l_int|1
suffix:semicolon
DECL|member|alloced
r_int
id|alloced
suffix:colon
l_int|1
suffix:semicolon
DECL|member|length
r_int
id|length
suffix:colon
l_int|24
suffix:semicolon
DECL|member|pad
r_int
id|pad
suffix:semicolon
multiline_comment|/* We suppose this makes this struct 64 bits long!! */
)brace
suffix:semicolon
DECL|macro|DP
mdefine_line|#define DP(ptr) ((struct chip_desc *)(ptr))
DECL|variable|amiga_chip_size
id|u_long
id|amiga_chip_size
suffix:semicolon
DECL|variable|chipavail
r_static
r_int
r_int
id|chipavail
suffix:semicolon
DECL|variable|chipram
r_static
r_struct
id|resource
id|chipram
op_assign
(brace
l_string|&quot;Chip RAM&quot;
comma
l_int|0
)brace
suffix:semicolon
DECL|function|amiga_chip_avail
r_int
r_int
id|amiga_chip_avail
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;chip_avail : %ld bytes&bslash;n&quot;
comma
id|chipavail
)paren
suffix:semicolon
macro_line|#endif
r_return
id|chipavail
suffix:semicolon
)brace
DECL|function|amiga_chip_init
r_void
id|__init
id|amiga_chip_init
(paren
r_void
)paren
(brace
r_struct
id|chip_desc
op_star
id|dp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|AMIGAHW_PRESENT
c_func
(paren
id|CHIP_RAM
)paren
)paren
r_return
suffix:semicolon
macro_line|#ifndef CONFIG_APUS_FAST_EXCEPT
multiline_comment|/*&n;   * Remove the first 4 pages where PPC exception handlers will&n;   * be located.&n;   */
id|amiga_chip_size
op_sub_assign
l_int|0x4000
suffix:semicolon
macro_line|#endif
id|chipram.end
op_assign
id|amiga_chip_size
op_minus
l_int|1
suffix:semicolon
id|request_resource
c_func
(paren
op_amp
id|iomem_resource
comma
op_amp
id|chipram
)paren
suffix:semicolon
multiline_comment|/* initialize start boundary */
id|dp
op_assign
id|DP
c_func
(paren
id|chipaddr
)paren
suffix:semicolon
id|dp-&gt;first
op_assign
l_int|1
suffix:semicolon
id|dp-&gt;alloced
op_assign
l_int|0
suffix:semicolon
id|dp-&gt;length
op_assign
id|amiga_chip_size
op_minus
l_int|2
op_star
r_sizeof
(paren
op_star
id|dp
)paren
suffix:semicolon
multiline_comment|/* initialize end boundary */
id|dp
op_assign
id|DP
c_func
(paren
id|chipaddr
op_plus
id|amiga_chip_size
)paren
op_minus
l_int|1
suffix:semicolon
id|dp-&gt;last
op_assign
l_int|1
suffix:semicolon
id|dp-&gt;alloced
op_assign
l_int|0
suffix:semicolon
id|dp-&gt;length
op_assign
id|amiga_chip_size
op_minus
l_int|2
op_star
r_sizeof
(paren
op_star
id|dp
)paren
suffix:semicolon
id|chipavail
op_assign
id|dp-&gt;length
suffix:semicolon
multiline_comment|/*MILAN*/
macro_line|#ifdef DEBUG
id|printk
(paren
l_string|&quot;chipram end boundary is %p, length is %d&bslash;n&quot;
comma
id|dp
comma
id|dp-&gt;length
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|amiga_chip_alloc
r_void
op_star
id|amiga_chip_alloc
c_func
(paren
r_int
id|size
comma
r_const
r_char
op_star
id|name
)paren
(brace
multiline_comment|/* last chunk */
r_struct
id|chip_desc
op_star
id|dp
suffix:semicolon
r_void
op_star
id|ptr
suffix:semicolon
multiline_comment|/* round off */
id|size
op_assign
(paren
id|size
op_plus
l_int|7
)paren
op_amp
op_complement
l_int|7
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;amiga_chip_alloc: allocate %ld bytes&bslash;n&quot;
comma
id|size
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * get pointer to descriptor for last chunk by &n;&t; * going backwards from end chunk&n;&t; */
id|dp
op_assign
id|DP
c_func
(paren
id|chipaddr
op_plus
id|amiga_chip_size
)paren
op_minus
l_int|1
suffix:semicolon
id|dp
op_assign
id|DP
c_func
(paren
(paren
r_int
r_int
)paren
id|dp
op_minus
id|dp-&gt;length
)paren
op_minus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
(paren
id|dp-&gt;alloced
op_logical_or
id|dp-&gt;length
OL
id|size
)paren
op_logical_and
op_logical_neg
id|dp-&gt;first
)paren
id|dp
op_assign
id|DP
(paren
(paren
r_int
r_int
)paren
id|dp
op_minus
id|dp
(braket
op_minus
l_int|1
)braket
dot
id|length
)paren
op_minus
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|dp-&gt;alloced
op_logical_or
id|dp-&gt;length
OL
id|size
)paren
(brace
id|printk
(paren
l_string|&quot;no chipmem available for %ld allocation&bslash;n&quot;
comma
id|size
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dp-&gt;length
OL
(paren
id|size
op_plus
l_int|2
op_star
r_sizeof
(paren
op_star
id|dp
)paren
)paren
)paren
(brace
multiline_comment|/* length too small to split; allocate the whole thing */
id|dp-&gt;alloced
op_assign
l_int|1
suffix:semicolon
id|ptr
op_assign
(paren
r_void
op_star
)paren
(paren
id|dp
op_plus
l_int|1
)paren
suffix:semicolon
id|dp
op_assign
id|DP
c_func
(paren
(paren
r_int
r_int
)paren
id|ptr
op_plus
id|dp-&gt;length
)paren
suffix:semicolon
id|dp-&gt;alloced
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
l_string|&quot;amiga_chip_alloc: no split&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
multiline_comment|/* split the extent; use the end part */
r_int
id|newsize
op_assign
id|dp-&gt;length
op_minus
(paren
l_int|2
op_star
r_sizeof
(paren
op_star
id|dp
)paren
op_plus
id|size
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
l_string|&quot;amiga_chip_alloc: splitting %d to %ld&bslash;n&quot;
comma
id|dp-&gt;length
comma
id|newsize
)paren
suffix:semicolon
macro_line|#endif
id|dp-&gt;length
op_assign
id|newsize
suffix:semicolon
id|dp
op_assign
id|DP
c_func
(paren
(paren
r_int
r_int
)paren
(paren
id|dp
op_plus
l_int|1
)paren
op_plus
id|newsize
)paren
suffix:semicolon
id|dp-&gt;first
op_assign
id|dp-&gt;last
op_assign
l_int|0
suffix:semicolon
id|dp-&gt;alloced
op_assign
l_int|0
suffix:semicolon
id|dp-&gt;length
op_assign
id|newsize
suffix:semicolon
id|dp
op_increment
suffix:semicolon
id|dp-&gt;first
op_assign
id|dp-&gt;last
op_assign
l_int|0
suffix:semicolon
id|dp-&gt;alloced
op_assign
l_int|1
suffix:semicolon
id|dp-&gt;length
op_assign
id|size
suffix:semicolon
id|ptr
op_assign
(paren
r_void
op_star
)paren
(paren
id|dp
op_plus
l_int|1
)paren
suffix:semicolon
id|dp
op_assign
id|DP
c_func
(paren
(paren
r_int
r_int
)paren
id|ptr
op_plus
id|size
)paren
suffix:semicolon
id|dp-&gt;alloced
op_assign
l_int|1
suffix:semicolon
id|dp-&gt;length
op_assign
id|size
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
id|printk
(paren
l_string|&quot;amiga_chip_alloc: returning %p&bslash;n&quot;
comma
id|ptr
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|ptr
op_amp
l_int|7
)paren
id|panic
c_func
(paren
l_string|&quot;amiga_chip_alloc: alignment violation&bslash;n&quot;
)paren
suffix:semicolon
id|chipavail
op_sub_assign
id|size
op_plus
(paren
l_int|2
op_star
r_sizeof
(paren
op_star
id|dp
)paren
)paren
suffix:semicolon
multiline_comment|/*MILAN*/
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|ZTWO_PADDR
c_func
(paren
id|ptr
)paren
comma
id|size
comma
id|name
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;amiga_chip_alloc: region of size %ld at 0x%08lx &quot;
l_string|&quot;is busy&bslash;n&quot;
comma
id|size
comma
id|ZTWO_PADDR
c_func
(paren
id|ptr
)paren
)paren
suffix:semicolon
r_return
id|ptr
suffix:semicolon
)brace
DECL|function|amiga_chip_free
r_void
id|amiga_chip_free
(paren
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|chip_desc
op_star
id|sdp
op_assign
id|DP
c_func
(paren
id|ptr
)paren
op_minus
l_int|1
comma
op_star
id|dp2
suffix:semicolon
r_struct
id|chip_desc
op_star
id|edp
op_assign
id|DP
c_func
(paren
(paren
r_int
r_int
)paren
id|ptr
op_plus
id|sdp-&gt;length
)paren
suffix:semicolon
id|chipavail
op_add_assign
id|sdp-&gt;length
op_plus
(paren
l_int|2
op_star
r_sizeof
(paren
id|sdp
)paren
)paren
suffix:semicolon
multiline_comment|/*MILAN*/
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;chip_free: free %ld bytes at %p&bslash;n&quot;
comma
id|sdp-&gt;length
comma
id|ptr
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* deallocate the chunk */
id|sdp-&gt;alloced
op_assign
id|edp-&gt;alloced
op_assign
l_int|0
suffix:semicolon
id|release_mem_region
c_func
(paren
id|ZTWO_PADDR
c_func
(paren
id|ptr
)paren
comma
id|sdp-&gt;length
)paren
suffix:semicolon
multiline_comment|/* check if we should merge with the previous chunk */
r_if
c_cond
(paren
op_logical_neg
id|sdp-&gt;first
op_logical_and
op_logical_neg
id|sdp
(braket
op_minus
l_int|1
)braket
dot
id|alloced
)paren
(brace
id|dp2
op_assign
id|DP
c_func
(paren
(paren
r_int
r_int
)paren
id|sdp
op_minus
id|sdp
(braket
op_minus
l_int|1
)braket
dot
id|length
)paren
op_minus
l_int|2
suffix:semicolon
id|dp2-&gt;length
op_add_assign
id|sdp-&gt;length
op_plus
l_int|2
op_star
r_sizeof
(paren
op_star
id|sdp
)paren
suffix:semicolon
id|edp-&gt;length
op_assign
id|dp2-&gt;length
suffix:semicolon
id|sdp
op_assign
id|dp2
suffix:semicolon
)brace
multiline_comment|/* check if we should merge with the following chunk */
r_if
c_cond
(paren
op_logical_neg
id|edp-&gt;last
op_logical_and
op_logical_neg
id|edp
(braket
l_int|1
)braket
dot
id|alloced
)paren
(brace
id|dp2
op_assign
id|DP
c_func
(paren
(paren
r_int
r_int
)paren
id|edp
op_plus
id|edp
(braket
l_int|1
)braket
dot
id|length
)paren
op_plus
l_int|2
suffix:semicolon
id|dp2-&gt;length
op_add_assign
id|edp-&gt;length
op_plus
l_int|2
op_star
r_sizeof
(paren
op_star
id|sdp
)paren
suffix:semicolon
id|sdp-&gt;length
op_assign
id|dp2-&gt;length
suffix:semicolon
id|edp
op_assign
id|dp2
suffix:semicolon
)brace
)brace
eof
