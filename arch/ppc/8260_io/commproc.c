multiline_comment|/*&n; * General Purpose functions for the global management of the&n; * 8260 Communication Processor Module.&n; * Copyright (c) 1999 Dan Malek (dmalek@jlc.net)&n; * Copyright (c) 2000 MontaVista Software, Inc (source@mvista.com)&n; *&t;2.3.99 Updates&n; *&n; * In addition to the individual control of the communication&n; * channels, there are a few functions that globally affect the&n; * communication processor.&n; *&n; * Buffer descriptors must be allocated from the dual ported memory&n; * space.  The allocator for that is here.  When the communication&n; * process is reset, we reclaim the memory available.  There is&n; * currently no deallocator for this memory.&n; */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/param.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/mpc8260.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/immap_8260.h&gt;
macro_line|#include &lt;asm/cpm_8260.h&gt;
DECL|variable|dp_alloc_base
r_static
id|uint
id|dp_alloc_base
suffix:semicolon
multiline_comment|/* Starting offset in DP ram */
DECL|variable|dp_alloc_top
r_static
id|uint
id|dp_alloc_top
suffix:semicolon
multiline_comment|/* Max offset + 1 */
DECL|variable|host_buffer
r_static
id|uint
id|host_buffer
suffix:semicolon
multiline_comment|/* One page of host buffer */
DECL|variable|host_end
r_static
id|uint
id|host_end
suffix:semicolon
multiline_comment|/* end + 1 */
DECL|variable|cpmp
id|cpm8260_t
op_star
id|cpmp
suffix:semicolon
multiline_comment|/* Pointer to comm processor space */
multiline_comment|/* We allocate this here because it is used almost exclusively for&n; * the communication processor devices.&n; */
DECL|variable|immr
id|immap_t
op_star
id|immr
suffix:semicolon
r_void
DECL|function|m8260_cpm_reset
id|m8260_cpm_reset
c_func
(paren
r_void
)paren
(brace
r_volatile
id|immap_t
op_star
id|imp
suffix:semicolon
r_volatile
id|cpm8260_t
op_star
id|commproc
suffix:semicolon
id|uint
id|vpgaddr
suffix:semicolon
id|immr
op_assign
id|imp
op_assign
(paren
r_volatile
id|immap_t
op_star
)paren
id|IMAP_ADDR
suffix:semicolon
id|commproc
op_assign
op_amp
id|imp-&gt;im_cpm
suffix:semicolon
multiline_comment|/* Reclaim the DP memory for our use.&n;&t;*/
id|dp_alloc_base
op_assign
id|CPM_DATAONLY_BASE
suffix:semicolon
id|dp_alloc_top
op_assign
id|dp_alloc_base
op_plus
id|CPM_DATAONLY_SIZE
suffix:semicolon
multiline_comment|/* Set the host page for allocation.&n;&t;*/
id|host_buffer
op_assign
(paren
id|uint
)paren
id|alloc_bootmem_pages
c_func
(paren
id|PAGE_SIZE
op_star
id|NUM_CPM_HOST_PAGES
)paren
suffix:semicolon
id|host_end
op_assign
id|host_buffer
op_plus
(paren
id|PAGE_SIZE
op_star
id|NUM_CPM_HOST_PAGES
)paren
suffix:semicolon
id|vpgaddr
op_assign
id|host_buffer
suffix:semicolon
multiline_comment|/* Tell everyone where the comm processor resides.&n;&t;*/
id|cpmp
op_assign
(paren
id|cpm8260_t
op_star
)paren
id|commproc
suffix:semicolon
)brace
multiline_comment|/* Allocate some memory from the dual ported ram.&n; * To help protocols with object alignment restrictions, we do that&n; * if they ask.&n; */
id|uint
DECL|function|m8260_cpm_dpalloc
id|m8260_cpm_dpalloc
c_func
(paren
id|uint
id|size
comma
id|uint
id|align
)paren
(brace
id|uint
id|retloc
suffix:semicolon
id|uint
id|align_mask
comma
id|off
suffix:semicolon
id|uint
id|savebase
suffix:semicolon
id|align_mask
op_assign
id|align
op_minus
l_int|1
suffix:semicolon
id|savebase
op_assign
id|dp_alloc_base
suffix:semicolon
r_if
c_cond
(paren
(paren
id|off
op_assign
(paren
id|dp_alloc_base
op_amp
id|align_mask
)paren
)paren
op_ne
l_int|0
)paren
id|dp_alloc_base
op_add_assign
(paren
id|align
op_minus
id|off
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dp_alloc_base
op_plus
id|size
)paren
op_ge
id|dp_alloc_top
)paren
(brace
id|dp_alloc_base
op_assign
id|savebase
suffix:semicolon
r_return
id|CPM_DP_NOSPACE
suffix:semicolon
)brace
id|retloc
op_assign
id|dp_alloc_base
suffix:semicolon
id|dp_alloc_base
op_add_assign
id|size
suffix:semicolon
r_return
id|retloc
suffix:semicolon
)brace
multiline_comment|/* We also own one page of host buffer space for the allocation of&n; * UART &quot;fifos&quot; and the like.&n; */
id|uint
DECL|function|m8260_cpm_hostalloc
id|m8260_cpm_hostalloc
c_func
(paren
id|uint
id|size
comma
id|uint
id|align
)paren
(brace
id|uint
id|retloc
suffix:semicolon
id|uint
id|align_mask
comma
id|off
suffix:semicolon
id|uint
id|savebase
suffix:semicolon
id|align_mask
op_assign
id|align
op_minus
l_int|1
suffix:semicolon
id|savebase
op_assign
id|host_buffer
suffix:semicolon
r_if
c_cond
(paren
(paren
id|off
op_assign
(paren
id|host_buffer
op_amp
id|align_mask
)paren
)paren
op_ne
l_int|0
)paren
id|host_buffer
op_add_assign
(paren
id|align
op_minus
id|off
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|host_buffer
op_plus
id|size
)paren
op_ge
id|host_end
)paren
(brace
id|host_buffer
op_assign
id|savebase
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|retloc
op_assign
id|host_buffer
suffix:semicolon
id|host_buffer
op_add_assign
id|size
suffix:semicolon
r_return
id|retloc
suffix:semicolon
)brace
multiline_comment|/* Set a baud rate generator.  This needs lots of work.  There are&n; * eight BRGs, which can be connected to the CPM channels or output&n; * as clocks.  The BRGs are in two different block of internal&n; * memory mapped space.&n; * The baud rate clock is the system clock divided by something.&n; * It was set up long ago during the initial boot phase and is&n; * is given to us.&n; * Baud rate clocks are zero-based in the driver code (as that maps&n; * to port numbers).  Documentation uses 1-based numbering.&n; */
DECL|macro|BRG_INT_CLK
mdefine_line|#define BRG_INT_CLK&t;(((bd_t *)__res)-&gt;bi_brgfreq * 1000000)
DECL|macro|BRG_UART_CLK
mdefine_line|#define BRG_UART_CLK&t;(BRG_INT_CLK/16)
multiline_comment|/* This function is used by UARTS, or anything else that uses a 16x&n; * oversampled clock.&n; */
r_void
DECL|function|m8260_cpm_setbrg
id|m8260_cpm_setbrg
c_func
(paren
id|uint
id|brg
comma
id|uint
id|rate
)paren
(brace
r_volatile
id|uint
op_star
id|bp
suffix:semicolon
multiline_comment|/* This is good enough to get SMCs running.....&n;&t;*/
r_if
c_cond
(paren
id|brg
OL
l_int|4
)paren
(brace
id|bp
op_assign
(paren
id|uint
op_star
)paren
op_amp
id|immr-&gt;im_brgc1
suffix:semicolon
)brace
r_else
(brace
id|bp
op_assign
(paren
id|uint
op_star
)paren
op_amp
id|immr-&gt;im_brgc5
suffix:semicolon
id|brg
op_sub_assign
l_int|4
suffix:semicolon
)brace
id|bp
op_add_assign
id|brg
suffix:semicolon
op_star
id|bp
op_assign
(paren
(paren
id|BRG_UART_CLK
op_div
id|rate
)paren
op_lshift
l_int|1
)paren
op_or
id|CPM_BRG_EN
suffix:semicolon
)brace
multiline_comment|/* This function is used to set high speed synchronous baud rate&n; * clocks.&n; */
r_void
DECL|function|m8260_cpm_fastbrg
id|m8260_cpm_fastbrg
c_func
(paren
id|uint
id|brg
comma
id|uint
id|rate
comma
r_int
id|div16
)paren
(brace
r_volatile
id|uint
op_star
id|bp
suffix:semicolon
multiline_comment|/* This is good enough to get SMCs running.....&n;&t;*/
r_if
c_cond
(paren
id|brg
OL
l_int|4
)paren
(brace
id|bp
op_assign
(paren
id|uint
op_star
)paren
op_amp
id|immr-&gt;im_brgc1
suffix:semicolon
)brace
r_else
(brace
id|bp
op_assign
(paren
id|uint
op_star
)paren
op_amp
id|immr-&gt;im_brgc5
suffix:semicolon
id|brg
op_sub_assign
l_int|4
suffix:semicolon
)brace
id|bp
op_add_assign
id|brg
suffix:semicolon
op_star
id|bp
op_assign
(paren
(paren
id|BRG_INT_CLK
op_div
id|rate
)paren
op_lshift
l_int|1
)paren
op_or
id|CPM_BRG_EN
suffix:semicolon
r_if
c_cond
(paren
id|div16
)paren
op_star
id|bp
op_or_assign
id|CPM_BRG_DIV16
suffix:semicolon
)brace
eof
