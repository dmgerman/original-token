multiline_comment|/*&n;   * Copyright 1996 The Australian National University.&n;   * Copyright 1996 Fujitsu Laboratories Limited&n;   * &n;   * This software may be distributed under the terms of the Gnu&n;   * Public License version 2 or later&n;  */
multiline_comment|/*&n; * Initialize the AP1000 hardware: BIF, MSC+, MC+, etc.&n; */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/mpp.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/ap1000/apservice.h&gt;
macro_line|#include &lt;asm/ap1000/apreg.h&gt;
DECL|macro|APLOG
mdefine_line|#define APLOG 0
multiline_comment|/* these make using CellOS code easier */
DECL|variable|cap_nopt0
r_int
id|cap_nopt0
suffix:semicolon
DECL|variable|cap_cid0
r_int
id|cap_cid0
suffix:semicolon
DECL|variable|cap_ncel0
r_int
id|cap_ncel0
suffix:semicolon
DECL|variable|_cid
DECL|variable|_ncel
DECL|variable|_ncelx
DECL|variable|_ncely
DECL|variable|_cidx
DECL|variable|_cidy
r_int
id|_cid
comma
id|_ncel
comma
id|_ncelx
comma
id|_ncely
comma
id|_cidx
comma
id|_cidy
suffix:semicolon
multiline_comment|/* yuck - needed for sun4c! */
DECL|variable|dummy
r_static
r_int
r_char
id|dummy
suffix:semicolon
DECL|variable|auxio_register
r_int
r_char
op_star
id|auxio_register
op_assign
op_amp
id|dummy
suffix:semicolon
r_extern
r_struct
id|cap_init
id|cap_init
suffix:semicolon
DECL|function|unexpected_irq
r_static
r_void
id|unexpected_irq
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|ap_panic
c_func
(paren
l_string|&quot;** unexpected interrupt %d **&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
)brace
DECL|function|ap_other_irqs
r_static
r_void
id|ap_other_irqs
c_func
(paren
r_void
)paren
(brace
id|request_irq
c_func
(paren
l_int|3
comma
id|unexpected_irq
comma
id|SA_INTERRUPT
comma
l_string|&quot;unused&quot;
comma
l_int|0
)paren
suffix:semicolon
id|request_irq
c_func
(paren
l_int|5
comma
id|unexpected_irq
comma
id|SA_INTERRUPT
comma
l_string|&quot;unused&quot;
comma
l_int|0
)paren
suffix:semicolon
id|request_irq
c_func
(paren
l_int|12
comma
id|unexpected_irq
comma
id|SA_INTERRUPT
comma
l_string|&quot;unused&quot;
comma
l_int|0
)paren
suffix:semicolon
id|request_irq
c_func
(paren
l_int|15
comma
id|unexpected_irq
comma
id|SA_INTERRUPT
comma
l_string|&quot;unused&quot;
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|ap_memory_size
r_int
id|ap_memory_size
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
(paren
id|MSC_IN
c_func
(paren
id|MSC_SIMMCHK
)paren
op_amp
id|MSC_SIMMCHK_MASK
)paren
op_eq
l_int|0
)paren
(brace
r_return
l_int|16
op_star
l_int|1024
op_star
l_int|1024
suffix:semicolon
)brace
r_return
l_int|64
op_star
l_int|1024
op_star
l_int|1024
suffix:semicolon
)brace
DECL|function|show_registers
r_static
r_void
id|show_registers
c_func
(paren
r_void
)paren
(brace
r_extern
r_struct
id|pt_regs
op_star
id|bif_pt_regs
suffix:semicolon
r_if
c_cond
(paren
id|bif_pt_regs
)paren
id|show_regs
c_func
(paren
id|bif_pt_regs
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;unable to show registers&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|check_alive
r_static
r_void
id|check_alive
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Cell %d is alive&bslash;n&quot;
comma
id|mpp_cid
c_func
(paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|show_task
r_static
r_void
id|show_task
c_func
(paren
r_struct
id|task_struct
op_star
id|t
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cell=%3d uid=%5d pid=%5d utime=%3d stime=%3d etime=%3d name=%s&bslash;n&quot;
comma
id|mpp_cid
c_func
(paren
)paren
comma
id|t-&gt;uid
comma
(paren
r_int
)paren
id|t-&gt;pid
comma
(paren
r_int
)paren
id|t-&gt;utime
comma
(paren
r_int
)paren
id|t-&gt;stime
comma
(paren
id|jiffies
op_minus
(paren
r_int
)paren
id|t-&gt;start_time
)paren
op_div
l_int|100
comma
id|t-&gt;comm
)paren
suffix:semicolon
)brace
DECL|function|show_ptasks
r_static
r_void
id|show_ptasks
c_func
(paren
r_void
)paren
(brace
r_extern
r_struct
id|task_struct
op_star
id|task
(braket
)braket
suffix:semicolon
r_struct
id|task_struct
op_star
id|p
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|tasklist_lock
)paren
suffix:semicolon
id|for_each_task
c_func
(paren
id|p
)paren
(brace
r_struct
id|task_struct
op_star
op_star
id|tp
op_assign
id|p-&gt;tarray_ptr
suffix:semicolon
r_if
c_cond
(paren
id|tp
op_ge
op_amp
id|task
(braket
id|MPP_TASK_BASE
)braket
)paren
(brace
id|show_task
c_func
(paren
id|p
)paren
suffix:semicolon
id|count
op_increment
suffix:semicolon
)brace
)brace
id|read_unlock
c_func
(paren
op_amp
id|tasklist_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;no parallel tasks on cell %d&bslash;n&quot;
comma
id|mpp_cid
c_func
(paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|show_utasks
r_static
r_void
id|show_utasks
c_func
(paren
r_void
)paren
(brace
r_extern
r_struct
id|task_struct
op_star
id|task
(braket
)braket
suffix:semicolon
r_struct
id|task_struct
op_star
id|p
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|tasklist_lock
)paren
suffix:semicolon
id|for_each_task
c_func
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;uid
OG
l_int|1
)paren
(brace
id|show_task
c_func
(paren
id|task
(braket
id|i
)braket
)paren
suffix:semicolon
id|count
op_increment
suffix:semicolon
)brace
)brace
id|read_unlock
c_func
(paren
op_amp
id|tasklist_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;no user tasks on cell %d&bslash;n&quot;
comma
id|mpp_cid
c_func
(paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|show_otasks
r_static
r_void
id|show_otasks
c_func
(paren
r_void
)paren
(brace
r_extern
r_struct
id|task_struct
op_star
id|task
(braket
)braket
suffix:semicolon
r_struct
id|task_struct
op_star
id|p
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_extern
r_int
id|ap_current_uid
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|tasklist_lock
)paren
suffix:semicolon
id|for_each_task
c_func
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;uid
op_eq
id|ap_current_uid
)paren
(brace
id|show_task
c_func
(paren
id|task
(braket
id|i
)braket
)paren
suffix:semicolon
id|count
op_increment
suffix:semicolon
)brace
)brace
id|read_unlock
c_func
(paren
op_amp
id|tasklist_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;no tasks on cell %d&bslash;n&quot;
comma
id|mpp_cid
c_func
(paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|do_panic
r_void
id|do_panic
c_func
(paren
r_void
)paren
(brace
r_int
op_star
id|x
op_assign
l_int|0
suffix:semicolon
op_star
id|x
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* uggh */
)brace
DECL|function|mpp_hw_init
r_void
id|mpp_hw_init
c_func
(paren
r_void
)paren
(brace
r_extern
r_void
id|show_state
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|breakpoint
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|ctrl_alt_del
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|mac_print_state
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|show_debug_keys
c_func
(paren
r_void
)paren
suffix:semicolon
id|bif_add_debug_key
c_func
(paren
l_char|&squot;c&squot;
comma
id|check_alive
comma
l_string|&quot;check if a cell is alive&quot;
)paren
suffix:semicolon
id|bif_add_debug_key
c_func
(paren
l_char|&squot;k&squot;
comma
id|show_debug_keys
comma
l_string|&quot;show the kernel debug keys&quot;
)paren
suffix:semicolon
id|bif_add_debug_key
c_func
(paren
l_char|&squot;p&squot;
comma
id|show_registers
comma
l_string|&quot;show register info&quot;
)paren
suffix:semicolon
id|bif_add_debug_key
c_func
(paren
l_char|&squot;p&squot;
comma
id|show_registers
comma
l_string|&quot;show register info&quot;
)paren
suffix:semicolon
id|bif_add_debug_key
c_func
(paren
l_char|&squot;m&squot;
comma
id|show_mem
comma
l_string|&quot;detailed memory stats&quot;
)paren
suffix:semicolon
id|bif_add_debug_key
c_func
(paren
l_char|&squot;s&squot;
comma
id|show_state
comma
l_string|&quot;detailed process stats&quot;
)paren
suffix:semicolon
id|bif_add_debug_key
c_func
(paren
l_char|&squot;D&squot;
comma
id|ap_start_debugger
comma
l_string|&quot;launch the kernel debugger&quot;
)paren
suffix:semicolon
id|bif_add_debug_key
c_func
(paren
l_char|&squot;i&squot;
comma
id|breakpoint
comma
l_string|&quot;send a breakpoint&quot;
)paren
suffix:semicolon
id|bif_add_debug_key
c_func
(paren
l_char|&squot;r&squot;
comma
id|ctrl_alt_del
comma
l_string|&quot;run shutdown (doesn&squot;t work)&quot;
)paren
suffix:semicolon
id|bif_add_debug_key
c_func
(paren
l_char|&squot;P&squot;
comma
id|show_ptasks
comma
l_string|&quot;show running parallel tasks&quot;
)paren
suffix:semicolon
id|bif_add_debug_key
c_func
(paren
l_char|&squot;U&squot;
comma
id|show_utasks
comma
l_string|&quot;show all user tasks&quot;
)paren
suffix:semicolon
id|bif_add_debug_key
c_func
(paren
l_char|&squot;O&squot;
comma
id|show_otasks
comma
l_string|&quot;show own user tasks&quot;
)paren
suffix:semicolon
id|bif_add_debug_key
c_func
(paren
l_char|&squot;^&squot;
comma
id|do_panic
comma
l_string|&quot;panic :-)&quot;
)paren
suffix:semicolon
id|cap_cid0
op_assign
id|BIF_IN
c_func
(paren
id|BIF_CIDR1
)paren
suffix:semicolon
id|cap_ncel0
op_assign
id|cap_init.numcells
suffix:semicolon
id|_cid
op_assign
id|cap_cid0
suffix:semicolon
id|_ncel
op_assign
id|cap_ncel0
suffix:semicolon
id|_ncelx
op_assign
id|_ncel
OL
l_int|8
ques
c_cond
id|_ncel
suffix:colon
l_int|8
suffix:semicolon
id|_ncely
op_assign
(paren
(paren
id|_ncel
op_minus
l_int|1
)paren
op_div
id|_ncelx
)paren
op_plus
l_int|1
suffix:semicolon
id|_cidx
op_assign
id|_cid
op_mod
id|_ncelx
suffix:semicolon
id|_cidy
op_assign
id|_cid
op_div
id|_ncelx
suffix:semicolon
id|ap_bif_init
c_func
(paren
)paren
suffix:semicolon
id|ap_msc_init
c_func
(paren
)paren
suffix:semicolon
id|ap_tnet_init
c_func
(paren
)paren
suffix:semicolon
id|ap_profile_init
c_func
(paren
)paren
suffix:semicolon
id|ap_other_irqs
c_func
(paren
)paren
suffix:semicolon
id|ap_ringbuf_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#if APLOG
id|ap_log
c_func
(paren
l_int|NULL
comma
op_minus
l_int|1
)paren
suffix:semicolon
macro_line|#endif
)brace
eof
