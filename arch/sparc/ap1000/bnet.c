multiline_comment|/*&n;   * Copyright 1996 The Australian National University.&n;   * Copyright 1996 Fujitsu Laboratories Limited&n;   * &n;   * This software may be distributed under the terms of the Gnu&n;   * Public License version 2 or later&n;  */
multiline_comment|/* routines to control the AP1000 bif interface. This is the interface&n;   used to talk to the front end processor */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/ap1000/apservice.h&gt;
macro_line|#include &lt;asm/ap1000/apreg.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
DECL|macro|NET_DEBUG
mdefine_line|#define NET_DEBUG 0
DECL|macro|DUMMY_MSG_LEN
mdefine_line|#define DUMMY_MSG_LEN 100
DECL|macro|DUMMY_MSG_WAIT
mdefine_line|#define DUMMY_MSG_WAIT 30
DECL|macro|MAX_CELLS
mdefine_line|#define MAX_CELLS 128
DECL|macro|HAVE_BIF
mdefine_line|#define HAVE_BIF() (BIF_IN(BIF_SDCSR) &amp; BIF_SDCSR_BG)
DECL|macro|BIF_BUSY
mdefine_line|#define BIF_BUSY() (BIF_IN(BIF_SDCSR) &amp; BIF_SDCSR_BB)
DECL|macro|SNET_ARBITRATION
mdefine_line|#define SNET_ARBITRATION 0
DECL|macro|TOKEN_ARBITRATION
mdefine_line|#define TOKEN_ARBITRATION 1
DECL|macro|DEBUG
mdefine_line|#define DEBUG(x) 
macro_line|#if TOKEN_ARBITRATION
DECL|variable|have_token
r_static
r_int
id|have_token
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_extern
r_struct
id|cap_init
id|cap_init
suffix:semicolon
DECL|variable|interrupt_driven
r_static
r_int
id|interrupt_driven
op_assign
l_int|0
suffix:semicolon
DECL|variable|use_dma
r_static
r_int
id|use_dma
op_assign
l_int|0
suffix:semicolon
DECL|variable|bif_pt_regs
r_struct
id|pt_regs
op_star
id|bif_pt_regs
op_assign
l_int|NULL
suffix:semicolon
DECL|enum|dma_state
DECL|enumerator|DMA_IDLE
DECL|enumerator|DMA_INCOMING
DECL|enumerator|DMA_OUTGOING
r_enum
id|dma_state
(brace
id|DMA_IDLE
comma
id|DMA_INCOMING
comma
id|DMA_OUTGOING
)brace
suffix:semicolon
DECL|variable|dma_state
r_static
r_enum
id|dma_state
id|dma_state
op_assign
id|DMA_IDLE
suffix:semicolon
DECL|variable|net_started
r_static
r_int
id|net_started
op_assign
l_int|0
suffix:semicolon
DECL|variable|waiting_for_bif
r_static
r_int
id|waiting_for_bif
op_assign
l_int|0
suffix:semicolon
DECL|variable|queue_length
r_static
r_int
id|queue_length
op_assign
l_int|0
suffix:semicolon
DECL|variable|drop_ip_packets
r_static
r_int
id|drop_ip_packets
op_assign
l_int|0
suffix:semicolon
DECL|macro|DMA_THRESHOLD
mdefine_line|#define DMA_THRESHOLD 64
DECL|variable|bread_req
r_static
r_struct
id|cap_request
id|bread_req
suffix:semicolon
DECL|variable|tnet_ip_enabled
r_int
id|tnet_ip_enabled
op_assign
l_int|1
suffix:semicolon
DECL|macro|BIF_DATA_WAITING
mdefine_line|#define BIF_DATA_WAITING() (BIF_IN(BIF_SDCSR) &amp; BIF_SDCSR_RB)
DECL|macro|ROUND4
mdefine_line|#define ROUND4(x)&t;(((x) + 3) &amp; -4)
r_static
r_void
id|bif_intr_receive
c_func
(paren
r_struct
id|cap_request
op_star
id|req1
)paren
suffix:semicolon
multiline_comment|/* read some data from the bif */
DECL|function|read_bif
r_void
id|read_bif
c_func
(paren
r_char
op_star
id|buf
comma
r_int
id|size
)paren
(brace
r_int
op_star
id|ibuf
op_assign
(paren
r_int
op_star
)paren
id|buf
suffix:semicolon
r_int
id|avail
suffix:semicolon
id|DEBUG
c_func
(paren
(paren
l_string|&quot;|read_bif %d&bslash;n&quot;
comma
id|size
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_state
op_ne
id|DMA_IDLE
)paren
id|ap_dma_wait
c_func
(paren
id|DMA_CH2
)paren
suffix:semicolon
id|size
op_assign
(paren
id|size
op_plus
l_int|3
)paren
op_rshift
l_int|2
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|4
)paren
(brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|avail
op_assign
(paren
id|BIF_IN
c_func
(paren
id|BIF_SDCSR
)paren
op_rshift
id|BIF_SDCSR_RB_SHIFT
)paren
op_amp
l_int|7
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|avail
op_amp
l_int|4
)paren
(brace
id|ibuf
(braket
l_int|0
)braket
op_assign
id|BIF_IN
c_func
(paren
id|BIF_DATA
)paren
suffix:semicolon
id|ibuf
(braket
l_int|1
)braket
op_assign
id|BIF_IN
c_func
(paren
id|BIF_DATA
)paren
suffix:semicolon
id|ibuf
(braket
l_int|2
)braket
op_assign
id|BIF_IN
c_func
(paren
id|BIF_DATA
)paren
suffix:semicolon
id|ibuf
(braket
l_int|3
)braket
op_assign
id|BIF_IN
c_func
(paren
id|BIF_DATA
)paren
suffix:semicolon
id|size
op_sub_assign
l_int|4
suffix:semicolon
id|ibuf
op_add_assign
l_int|4
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|avail
op_amp
l_int|2
)paren
(brace
id|ibuf
(braket
l_int|0
)braket
op_assign
id|BIF_IN
c_func
(paren
id|BIF_DATA
)paren
suffix:semicolon
id|ibuf
(braket
l_int|1
)braket
op_assign
id|BIF_IN
c_func
(paren
id|BIF_DATA
)paren
suffix:semicolon
id|size
op_sub_assign
l_int|2
suffix:semicolon
id|ibuf
op_add_assign
l_int|2
suffix:semicolon
r_continue
suffix:semicolon
)brace
op_star
id|ibuf
op_increment
op_assign
id|BIF_IN
c_func
(paren
id|BIF_DATA
)paren
suffix:semicolon
id|size
op_decrement
suffix:semicolon
)brace
r_while
c_loop
(paren
id|size
op_decrement
)paren
(brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|BIF_IN
c_func
(paren
id|BIF_SDCSR
)paren
op_amp
id|BIF_SDCSR_RB
)paren
)paren
suffix:semicolon
op_star
id|ibuf
op_increment
op_assign
id|BIF_IN
c_func
(paren
id|BIF_DATA
)paren
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
(paren
l_string|&quot;|read bif done&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* throw out some data from the bif. This is usually called when we&n; don&squot;t have the resources to handle it immediately */
DECL|function|bif_toss
r_void
id|bif_toss
c_func
(paren
r_int
id|size
)paren
(brace
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
(paren
l_string|&quot;|bif toss %d&bslash;n&quot;
comma
id|size
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
r_while
c_loop
(paren
op_logical_neg
id|BIF_DATA_WAITING
c_func
(paren
)paren
)paren
suffix:semicolon
id|BIF_IN
c_func
(paren
id|BIF_DATA
)paren
suffix:semicolon
id|size
op_sub_assign
l_int|4
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
(paren
l_string|&quot;|bif toss done&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|bif_reset_interrupts
r_static
r_void
id|bif_reset_interrupts
c_func
(paren
r_void
)paren
(brace
id|BIF_OUT
c_func
(paren
id|BIF_INTR
comma
id|AP_INTR_WENABLE
op_lshift
id|BIF_INTR_GET_SH
)paren
suffix:semicolon
id|BIF_OUT
c_func
(paren
id|BIF_INTR
comma
id|AP_INTR_WENABLE
op_lshift
id|BIF_INTR_HEADER_SH
)paren
suffix:semicolon
)brace
DECL|function|bif_mask_interrupts
r_static
r_void
id|bif_mask_interrupts
c_func
(paren
r_void
)paren
(brace
id|BIF_OUT
c_func
(paren
id|BIF_INTR
comma
(paren
id|AP_INTR_MASK
op_or
id|AP_INTR_WENABLE
)paren
op_lshift
id|BIF_INTR_GET_SH
)paren
suffix:semicolon
id|BIF_OUT
c_func
(paren
id|BIF_INTR
comma
(paren
id|AP_INTR_MASK
op_or
id|AP_INTR_WENABLE
)paren
op_lshift
id|BIF_INTR_HEADER_SH
)paren
suffix:semicolon
)brace
DECL|function|attn_enable
r_static
r_void
id|attn_enable
c_func
(paren
r_void
)paren
(brace
id|BIF_OUT
c_func
(paren
id|BIF_INTR
comma
id|AP_INTR_WENABLE
op_lshift
id|BIF_INTR_ATTN_SH
)paren
suffix:semicolon
)brace
DECL|function|attn_mask
r_static
r_void
id|attn_mask
c_func
(paren
r_void
)paren
(brace
id|BIF_OUT
c_func
(paren
id|BIF_INTR
comma
(paren
id|AP_INTR_MASK
op_or
id|AP_INTR_WENABLE
)paren
op_lshift
id|BIF_INTR_ATTN_SH
)paren
suffix:semicolon
)brace
DECL|function|ap_bif_status
r_void
id|ap_bif_status
c_func
(paren
r_void
)paren
(brace
r_static
r_int
id|bif_sdcsr
suffix:semicolon
r_static
r_int
id|bif_intr
suffix:semicolon
r_static
r_int
id|bif_mhocr
suffix:semicolon
r_static
r_int
id|bif_x0sk
suffix:semicolon
r_static
r_int
id|bif_xsk
suffix:semicolon
r_static
r_int
id|bif_xsz
suffix:semicolon
r_static
r_int
id|bif_y0sk
suffix:semicolon
r_static
r_int
id|bif_ysk
suffix:semicolon
r_static
r_int
id|bif_ysz
suffix:semicolon
r_static
r_int
id|bif_cx0sk
suffix:semicolon
r_static
r_int
id|bif_cxsk
suffix:semicolon
r_static
r_int
id|bif_cxsz
suffix:semicolon
r_static
r_int
id|bif_cy0sk
suffix:semicolon
r_static
r_int
id|bif_cysk
suffix:semicolon
r_static
r_int
id|bif_cysz
suffix:semicolon
r_static
r_int
id|bif_ttl
suffix:semicolon
r_static
r_int
id|bif_cttl
suffix:semicolon
r_static
r_int
id|bif_header
suffix:semicolon
id|bif_sdcsr
op_assign
id|BIF_IN
c_func
(paren
id|BIF_SDCSR
)paren
suffix:semicolon
id|bif_intr
op_assign
id|BIF_IN
c_func
(paren
id|BIF_INTR
)paren
suffix:semicolon
id|bif_mhocr
op_assign
id|BIF_IN
c_func
(paren
id|BIF_MHOCR
)paren
suffix:semicolon
id|bif_x0sk
op_assign
id|BIF_IN
c_func
(paren
id|BIF_X0SK
)paren
suffix:semicolon
id|bif_xsk
op_assign
id|BIF_IN
c_func
(paren
id|BIF_XSK
)paren
suffix:semicolon
id|bif_xsz
op_assign
id|BIF_IN
c_func
(paren
id|BIF_XSZ
)paren
suffix:semicolon
id|bif_y0sk
op_assign
id|BIF_IN
c_func
(paren
id|BIF_Y0SK
)paren
suffix:semicolon
id|bif_ysk
op_assign
id|BIF_IN
c_func
(paren
id|BIF_YSK
)paren
suffix:semicolon
id|bif_ysz
op_assign
id|BIF_IN
c_func
(paren
id|BIF_YSZ
)paren
suffix:semicolon
id|bif_cx0sk
op_assign
id|BIF_IN
c_func
(paren
id|BIF_CX0SK
)paren
suffix:semicolon
id|bif_cxsk
op_assign
id|BIF_IN
c_func
(paren
id|BIF_CXSK
)paren
suffix:semicolon
id|bif_cxsz
op_assign
id|BIF_IN
c_func
(paren
id|BIF_CXSZ
)paren
suffix:semicolon
id|bif_cy0sk
op_assign
id|BIF_IN
c_func
(paren
id|BIF_CY0SK
)paren
suffix:semicolon
id|bif_cysk
op_assign
id|BIF_IN
c_func
(paren
id|BIF_CYSK
)paren
suffix:semicolon
id|bif_cysz
op_assign
id|BIF_IN
c_func
(paren
id|BIF_CYSZ
)paren
suffix:semicolon
id|bif_ttl
op_assign
id|BIF_IN
c_func
(paren
id|BIF_TTL
)paren
suffix:semicolon
id|bif_cttl
op_assign
id|BIF_IN
c_func
(paren
id|BIF_CTTL
)paren
suffix:semicolon
id|bif_header
op_assign
id|BIF_IN
c_func
(paren
id|BIF_HEADER
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;|&bslash;t***** BIF REG. *****&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;|&bslash;tBIF_SDCSR  = %08x  &quot;
comma
id|bif_sdcsr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bif_sdcsr
op_amp
id|BIF_SDCSR_CN
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;|&lt;BUS DISCONNECT&gt;&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bif_sdcsr
op_amp
id|BIF_SDCSR_FN
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;|&lt;SC/GA ENABLE&gt;&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bif_sdcsr
op_amp
id|BIF_SDCSR_DE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;|&lt;DMA ENABLE&gt;&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bif_sdcsr
op_amp
id|BIF_SDCSR_DR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;|&lt;GATHER&gt;&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bif_sdcsr
op_amp
id|BIF_SDCSR_BB
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;|&lt;BUS BSY&gt;&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bif_sdcsr
op_amp
id|BIF_SDCSR_BR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;|&lt;BUS REQ&gt;&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bif_sdcsr
op_amp
id|BIF_SDCSR_BG
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;|&lt;BUS GET&gt;&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bif_sdcsr
op_amp
id|BIF_SDCSR_ER
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;|&lt;ERROR:&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bif_sdcsr
op_amp
id|BIF_SDCSR_SP
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;|SYNC PARITY:&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bif_sdcsr
op_amp
id|BIF_SDCSR_LP
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;|LBUS PARITY:&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bif_sdcsr
op_amp
id|BIF_SDCSR_LR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;|READ EMPTY FIFO:&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bif_sdcsr
op_amp
id|BIF_SDCSR_LW
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;|WRITE FULL FIFO:&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bif_sdcsr
op_amp
id|BIF_SDCSR_AL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;|READ ENDBIT:&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bif_sdcsr
op_amp
id|BIF_SDCSR_SS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;|SET MASK SSTAT:&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bif_sdcsr
op_amp
id|BIF_SDCSR_SC
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;|CLR SSYNC ILLEGALLY:&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bif_sdcsr
op_amp
id|BIF_SDCSR_SY
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;|REQ SSYNC ILLEGALLY:&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bif_sdcsr
op_amp
id|BIF_SDCSR_FS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;|SET MASK FSTAT:&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bif_sdcsr
op_amp
id|BIF_SDCSR_FC
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;|CLR FSYNC ILLEGALLY:&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bif_sdcsr
op_amp
id|BIF_SDCSR_FY
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;|REQ FSYNC ILLEGALLY:&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bif_sdcsr
op_amp
id|BIF_SDCSR_CP
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;|BNET PARITY:&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bif_sdcsr
op_amp
id|BIF_SDCSR_FP
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;|FE NOT SET WHEN SC/GA:&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bif_sdcsr
op_amp
id|BIF_SDCSR_PS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;|RECV PACKET ILLEGALLY:&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bif_sdcsr
op_amp
id|BIF_SDCSR_RA
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;|CHANGE FE ILLEGALLY:&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bif_sdcsr
op_amp
id|BIF_SDCSR_PA
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;|SEND/RECV ILLEGALLY:&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bif_sdcsr
op_amp
id|BIF_SDCSR_DL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;|DATA LOST:&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bif_sdcsr
op_amp
id|BIF_SDCSR_ER
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;|&gt;&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bif_sdcsr
op_amp
id|BIF_SDCSR_PE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;|&lt;SYNC PARITY ENABLE&gt;&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;|&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;|&bslash;tBIF_INTR   = %08x&bslash;n&quot;
comma
id|bif_intr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;|&bslash;tBIF_MHOCR  = %08x&bslash;n&quot;
comma
id|bif_mhocr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;|&bslash;tBIF_X0SK   = %08x&bslash;n&quot;
comma
id|bif_x0sk
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;|&bslash;tBIF_XSK    = %08x&bslash;n&quot;
comma
id|bif_xsk
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;|&bslash;tBIF_XSZ    = %08x&bslash;n&quot;
comma
id|bif_xsz
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;|&bslash;tBIF_Y0SK   = %08x&bslash;n&quot;
comma
id|bif_y0sk
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;|&bslash;tBIF_YSK    = %08x&bslash;n&quot;
comma
id|bif_ysk
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;|&bslash;tBIF_YSZ    = %08x&bslash;n&quot;
comma
id|bif_ysz
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;|&bslash;tBIF_CX0SK  = %08x&bslash;n&quot;
comma
id|bif_cx0sk
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;|&bslash;tBIF_CXSK   = %08x&bslash;n&quot;
comma
id|bif_cxsk
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;|&bslash;tBIF_CXSZ   = %08x&bslash;n&quot;
comma
id|bif_cxsz
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;|&bslash;tBIF_CY0SK  = %08x&bslash;n&quot;
comma
id|bif_cy0sk
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;|&bslash;tBIF_CYSK   = %08x&bslash;n&quot;
comma
id|bif_cysk
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;|&bslash;tBIF_CYSZ   = %08x&bslash;n&quot;
comma
id|bif_cysz
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;|&bslash;tBIF_TTL    = %08x&bslash;n&quot;
comma
id|bif_ttl
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;|&bslash;tBIF_CTTL   = %08x&bslash;n&quot;
comma
id|bif_cttl
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;|&bslash;tBIF_HEADER = %08x&bslash;n&quot;
comma
id|bif_header
)paren
suffix:semicolon
)brace
DECL|function|bif_led_status
r_void
id|bif_led_status
c_func
(paren
r_void
)paren
(brace
macro_line|#if 1
r_static
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|res
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|i
)paren
(brace
r_case
l_int|0
suffix:colon
r_case
l_int|2
suffix:colon
id|res
op_assign
l_int|0xff
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
r_case
l_int|3
suffix:colon
id|res
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|res
op_assign
l_int|0xFF
op_amp
(paren
id|BIF_IN
c_func
(paren
id|BIF_SDCSR
)paren
op_rshift
(paren
(paren
(paren
id|i
op_minus
l_int|4
)paren
op_div
l_int|4
)paren
op_star
l_int|8
)paren
)paren
suffix:semicolon
)brace
id|i
op_assign
(paren
id|i
op_plus
l_int|1
)paren
op_mod
l_int|20
suffix:semicolon
id|ap_led
c_func
(paren
id|res
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|get_bif
r_static
r_void
id|get_bif
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|HAVE_BIF
c_func
(paren
)paren
)paren
r_return
suffix:semicolon
id|drop_ip_packets
op_assign
l_int|1
suffix:semicolon
id|DEBUG
c_func
(paren
(paren
l_string|&quot;|get_bif started&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_state
op_ne
id|DMA_IDLE
)paren
id|ap_dma_wait
c_func
(paren
id|DMA_CH2
)paren
suffix:semicolon
macro_line|#if SNET_ARBITRATION
multiline_comment|/* wait till the host doesn&squot;t want the BIF anymore, tossing&n;&t;   any data that arrives */
r_while
c_loop
(paren
id|BIF_IN
c_func
(paren
id|FSTT_CLR
)paren
op_amp
id|HOST_STATUS_BIT
)paren
r_if
c_cond
(paren
id|BIF_IN
c_func
(paren
id|BIF_SDCSR
)paren
op_amp
id|BIF_SDCSR_RB
)paren
id|bif_intr_receive
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
id|waiting_for_bif
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#if TOKEN_ARBITRATION
id|BIF_OUT
c_func
(paren
id|FSTT_CLR
comma
id|HOST_STATUS_BIT
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* request the BIF */
id|BIF_OUT
c_func
(paren
id|BIF_SDCSR
comma
id|BIF_SDCSR_BR
)paren
suffix:semicolon
multiline_comment|/* loop waiting for us to get the BIF, tossing any data */
r_while
c_loop
(paren
op_logical_neg
id|HAVE_BIF
c_func
(paren
)paren
)paren
r_if
c_cond
(paren
id|BIF_IN
c_func
(paren
id|BIF_SDCSR
)paren
op_amp
id|BIF_SDCSR_RB
)paren
id|bif_intr_receive
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
id|bif_reset_interrupts
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|interrupt_driven
)paren
id|bif_mask_interrupts
c_func
(paren
)paren
suffix:semicolon
id|drop_ip_packets
op_assign
l_int|0
suffix:semicolon
macro_line|#if TOKEN_ARBITRATION
id|BIF_OUT
c_func
(paren
id|FSTT_SET
comma
id|HOST_STATUS_BIT
)paren
suffix:semicolon
macro_line|#endif
id|DEBUG
c_func
(paren
(paren
l_string|&quot;|get_bif done&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* write a message to the front end over the Bnet. This can be in&n;   multiple parts, as long as the first part sets &quot;start&quot; and the last&n;   part sets &quot;end&quot;. The bus will be grabbed while this is going on &n;   */
DECL|function|write_bif
r_static
r_void
id|write_bif
c_func
(paren
r_char
op_star
id|buf
comma
r_int
id|size
comma
r_int
id|start
comma
r_int
id|end
)paren
(brace
r_int
op_star
id|ibuf
suffix:semicolon
r_int
id|avail
suffix:semicolon
id|DEBUG
c_func
(paren
(paren
l_string|&quot;|write_bif %d %d %d&bslash;n&quot;
comma
id|size
comma
id|start
comma
id|end
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|start
)paren
(brace
multiline_comment|/* a dma op may be in progress */
r_if
c_cond
(paren
id|dma_state
op_ne
id|DMA_IDLE
)paren
id|ap_dma_wait
c_func
(paren
id|DMA_CH2
)paren
suffix:semicolon
)brace
id|size
op_assign
(paren
id|size
op_plus
l_int|3
)paren
op_rshift
l_int|2
suffix:semicolon
id|ibuf
op_assign
(paren
r_int
op_star
)paren
id|buf
suffix:semicolon
r_if
c_cond
(paren
id|end
)paren
id|size
op_decrement
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|4
)paren
(brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|avail
op_assign
(paren
id|BIF_IN
c_func
(paren
id|BIF_SDCSR
)paren
op_rshift
id|BIF_SDCSR_TB_SHIFT
)paren
op_amp
l_int|7
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|avail
op_amp
l_int|4
)paren
(brace
id|BIF_OUT
c_func
(paren
id|BIF_DATA
comma
id|ibuf
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|BIF_OUT
c_func
(paren
id|BIF_DATA
comma
id|ibuf
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|BIF_OUT
c_func
(paren
id|BIF_DATA
comma
id|ibuf
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|BIF_OUT
c_func
(paren
id|BIF_DATA
comma
id|ibuf
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|size
op_sub_assign
l_int|4
suffix:semicolon
id|ibuf
op_add_assign
l_int|4
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|avail
op_amp
l_int|2
)paren
(brace
id|BIF_OUT
c_func
(paren
id|BIF_DATA
comma
id|ibuf
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|BIF_OUT
c_func
(paren
id|BIF_DATA
comma
id|ibuf
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|size
op_sub_assign
l_int|2
suffix:semicolon
id|ibuf
op_add_assign
l_int|2
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|BIF_OUT
c_func
(paren
id|BIF_DATA
comma
id|ibuf
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|ibuf
op_increment
suffix:semicolon
id|size
op_decrement
suffix:semicolon
)brace
r_while
c_loop
(paren
id|size
op_decrement
)paren
(brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|BIF_IN
c_func
(paren
id|BIF_SDCSR
)paren
op_amp
id|BIF_SDCSR_TB
)paren
)paren
suffix:semicolon
id|BIF_OUT
c_func
(paren
id|BIF_DATA
comma
id|ibuf
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|ibuf
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|end
)paren
(brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|BIF_IN
c_func
(paren
id|BIF_SDCSR
)paren
op_amp
id|BIF_SDCSR_TB
)paren
)paren
suffix:semicolon
id|BIF_OUT
c_func
(paren
id|BIF_EDATA
comma
op_star
id|ibuf
)paren
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
(paren
l_string|&quot;|write bif done&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
macro_line|#if TOKEN_ARBITRATION
DECL|function|forward_token
r_static
r_void
id|forward_token
c_func
(paren
r_void
)paren
(brace
r_struct
id|cap_request
id|req
suffix:semicolon
id|req.cid
op_assign
id|mpp_cid
c_func
(paren
)paren
suffix:semicolon
id|req.type
op_assign
id|REQ_BIF_TOKEN
suffix:semicolon
id|req.size
op_assign
r_sizeof
(paren
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req.cid
op_eq
id|cap_init.numcells
op_minus
l_int|1
)paren
id|req.header
op_assign
id|MAKE_HEADER
c_func
(paren
id|HOST_CID
)paren
suffix:semicolon
r_else
id|req.header
op_assign
id|MAKE_HEADER
c_func
(paren
id|req.cid
op_plus
l_int|1
)paren
suffix:semicolon
id|write_bif
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|req
comma
r_sizeof
(paren
id|req
)paren
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
id|have_token
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|function|release_bif
r_static
r_void
id|release_bif
c_func
(paren
r_void
)paren
(brace
r_static
r_int
id|dummy
(braket
id|DUMMY_MSG_LEN
)braket
suffix:semicolon
id|waiting_for_bif
op_assign
l_int|0
suffix:semicolon
macro_line|#if SNET_ARBITRATION
multiline_comment|/* mask the attention interrupt */
id|attn_mask
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* maybe we don&squot;t have it?? */
r_if
c_cond
(paren
op_logical_neg
id|HAVE_BIF
c_func
(paren
)paren
)paren
r_return
suffix:semicolon
id|DEBUG
c_func
(paren
(paren
l_string|&quot;|release bif started&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_state
op_ne
id|DMA_IDLE
)paren
id|ap_dma_wait
c_func
(paren
id|DMA_CH2
)paren
suffix:semicolon
macro_line|#if TOKEN_ARBITRATION
r_if
c_cond
(paren
id|have_token
)paren
id|forward_token
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if 1
multiline_comment|/* send a dummy message to ensure FIFO flushing&n;&t;   (suggestion from woods to overcome bif release&n;&t;   hardware bug) */
id|dummy
(braket
l_int|0
)braket
op_assign
l_int|0xEEEE4000
suffix:semicolon
id|write_bif
c_func
(paren
(paren
r_char
op_star
)paren
id|dummy
comma
id|DUMMY_MSG_LEN
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* wait till the send FIFO is completely empty */
r_while
c_loop
(paren
op_logical_neg
(paren
(paren
id|BIF_IN
c_func
(paren
id|BIF_SDCSR
)paren
op_amp
id|BIF_SDCSR_TB
)paren
op_eq
id|BIF_SDCSR_TB
)paren
)paren
suffix:semicolon
multiline_comment|/* wait another few us */
id|udelay
c_func
(paren
id|DUMMY_MSG_WAIT
)paren
suffix:semicolon
multiline_comment|/* send release-data */
id|BIF_OUT
c_func
(paren
id|BIF_DATA
comma
id|BIF_HEADER_RS
)paren
suffix:semicolon
multiline_comment|/* wait until we don&squot;t have the bus */
r_while
c_loop
(paren
id|HAVE_BIF
c_func
(paren
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
(paren
l_string|&quot;|release bif done&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* wait for a particular request type - throwing away anything else! */
DECL|function|ap_wait_request
r_void
id|ap_wait_request
c_func
(paren
r_struct
id|cap_request
op_star
id|req
comma
r_int
id|type
)paren
(brace
id|drop_ip_packets
op_assign
l_int|1
suffix:semicolon
r_do
(brace
r_while
c_loop
(paren
op_logical_neg
id|BIF_DATA_WAITING
c_func
(paren
)paren
)paren
r_if
c_cond
(paren
id|HAVE_BIF
c_func
(paren
)paren
)paren
id|release_bif
c_func
(paren
)paren
suffix:semicolon
id|read_bif
c_func
(paren
(paren
r_char
op_star
)paren
id|req
comma
r_sizeof
(paren
op_star
id|req
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;type
op_ne
id|type
)paren
(brace
id|bif_intr_receive
c_func
(paren
id|req
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|req-&gt;type
op_ne
id|type
)paren
suffix:semicolon
id|drop_ip_packets
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|write_bif_polled
r_void
id|write_bif_polled
c_func
(paren
r_char
op_star
id|buf1
comma
r_int
id|len1
comma
r_char
op_star
id|buf2
comma
r_int
id|len2
)paren
(brace
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|get_bif
c_func
(paren
)paren
suffix:semicolon
id|write_bif
c_func
(paren
id|buf1
comma
id|len1
comma
l_int|1
comma
(paren
id|buf2
op_logical_and
id|len2
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf2
op_logical_and
id|len2
)paren
id|write_bif
c_func
(paren
id|buf2
comma
id|len2
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|release_bif
c_func
(paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|want_bif
r_static
r_void
id|want_bif
c_func
(paren
r_void
)paren
(brace
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* maybe we&squot;ve already got it */
r_if
c_cond
(paren
id|HAVE_BIF
c_func
(paren
)paren
)paren
(brace
id|waiting_for_bif
op_assign
l_int|0
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#if SNET_ARBITRATION&t;
r_if
c_cond
(paren
id|interrupt_driven
)paren
id|attn_enable
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* check if the host wants it */
r_if
c_cond
(paren
id|BIF_IN
c_func
(paren
id|FSTT_CLR
)paren
op_amp
id|HOST_STATUS_BIT
)paren
(brace
multiline_comment|/* the host wants it - don&squot;t get it yet  */
id|waiting_for_bif
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* the host doesn&squot;t want it - just set bus request */
id|waiting_for_bif
op_assign
l_int|0
suffix:semicolon
id|BIF_OUT
c_func
(paren
id|BIF_SDCSR
comma
id|BIF_SDCSR_BR
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|HAVE_BIF
c_func
(paren
)paren
op_logical_and
op_logical_neg
id|BIF_BUSY
c_func
(paren
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
(paren
l_string|&quot;|set bif request&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
macro_line|#endif
macro_line|#if TOKEN_ARBITRATION
r_if
c_cond
(paren
id|net_started
op_logical_and
op_logical_neg
id|have_token
)paren
(brace
id|BIF_OUT
c_func
(paren
id|FSTT_CLR
comma
id|HOST_STATUS_BIT
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|BIF_OUT
c_func
(paren
id|FSTT_SET
comma
id|HOST_STATUS_BIT
)paren
suffix:semicolon
macro_line|#endif
id|BIF_OUT
c_func
(paren
id|BIF_SDCSR
comma
id|BIF_SDCSR_BR
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|macro|BIF_NOCOPY
mdefine_line|#define BIF_NOCOPY (1&lt;&lt;0)
multiline_comment|/* a queue of requests that need to be sent over the bif. Needs to be&n;modified sometime to allow the direct queueing of skb&squot;s */
DECL|struct|bif_queue
r_struct
id|bif_queue
(brace
DECL|member|next
r_volatile
r_struct
id|bif_queue
op_star
id|next
suffix:semicolon
DECL|member|req
r_struct
id|cap_request
id|req
suffix:semicolon
DECL|member|data
r_char
op_star
id|data
suffix:semicolon
DECL|member|data_size
r_int
id|data_size
suffix:semicolon
DECL|member|flags
r_int
id|flags
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|bif_queue_top
r_static
r_volatile
r_struct
id|bif_queue
op_star
id|bif_queue_top
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|bif_queue_end
r_static
r_volatile
r_struct
id|bif_queue
op_star
id|bif_queue_end
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|skb_out
r_static
r_struct
id|sk_buff
op_star
id|skb_out
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|skb_in
r_static
r_struct
id|sk_buff
op_star
id|skb_in
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|bif_dma_data
r_static
r_char
op_star
id|bif_dma_data
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|bif_dma_out_size
r_static
r_int
id|bif_dma_out_size
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* send waiting elements. Called mainly when we get a bif &quot;bus get&quot;&n;   interrupt to say we now have the bus */
DECL|function|bif_intr_runqueue
r_static
r_void
id|bif_intr_runqueue
c_func
(paren
r_void
)paren
(brace
r_int
id|flags
suffix:semicolon
multiline_comment|/* if I don&squot;t have the bus then return */
r_if
c_cond
(paren
op_logical_neg
id|HAVE_BIF
c_func
(paren
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|dma_state
op_ne
id|DMA_IDLE
)paren
r_return
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|bif_queue_top
)paren
(brace
r_volatile
r_struct
id|bif_queue
op_star
id|q
op_assign
id|bif_queue_top
suffix:semicolon
id|bif_queue_top
op_assign
id|q-&gt;next
suffix:semicolon
multiline_comment|/* printk(&quot;|queue run (length=%d)&bslash;n&quot;,queue_length); */
id|queue_length
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|q-&gt;data
)paren
(brace
multiline_comment|/* use programmed IO for small requests */
id|write_bif
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|q-&gt;req
comma
r_sizeof
(paren
id|q-&gt;req
)paren
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
(paren
r_char
op_star
)paren
id|q
comma
r_sizeof
(paren
op_star
id|q
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|q-&gt;flags
op_amp
id|BIF_NOCOPY
)paren
(brace
id|write_bif
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|q-&gt;req
comma
r_sizeof
(paren
id|q-&gt;req
)paren
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|use_dma
op_logical_and
id|q-&gt;data_size
OG
id|DMA_THRESHOLD
)paren
(brace
id|dma_state
op_assign
id|DMA_OUTGOING
suffix:semicolon
r_if
c_cond
(paren
id|q-&gt;req.type
op_eq
id|REQ_IP
)paren
(brace
id|skb_out
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|q-&gt;data
suffix:semicolon
id|ap_dma_go
c_func
(paren
id|DMA_CH2
comma
(paren
r_int
)paren
id|skb_out-&gt;data
comma
id|q-&gt;data_size
comma
id|DMA_DCMD_TD_MD
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|q-&gt;flags
op_amp
id|BIF_NOCOPY
)paren
)paren
(brace
id|bif_dma_data
op_assign
id|q-&gt;data
suffix:semicolon
id|bif_dma_out_size
op_assign
id|q-&gt;data_size
suffix:semicolon
)brace
id|ap_dma_go
c_func
(paren
id|DMA_CH2
comma
(paren
r_int
)paren
id|q-&gt;data
comma
id|q-&gt;data_size
comma
id|DMA_DCMD_TD_MD
)paren
suffix:semicolon
)brace
id|kfree_s
c_func
(paren
(paren
r_char
op_star
)paren
id|q
comma
r_sizeof
(paren
op_star
id|q
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* wait for DMA to complete */
)brace
r_if
c_cond
(paren
id|q-&gt;req.type
op_eq
id|REQ_IP
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|q-&gt;data
suffix:semicolon
id|write_bif
c_func
(paren
id|skb-&gt;data
comma
id|q-&gt;data_size
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
)brace
r_else
(brace
id|write_bif
c_func
(paren
id|q-&gt;data
comma
id|q-&gt;data_size
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|q-&gt;flags
op_amp
id|BIF_NOCOPY
)paren
)paren
id|kfree_s
c_func
(paren
id|q-&gt;data
comma
id|q-&gt;data_size
)paren
suffix:semicolon
)brace
id|kfree_s
c_func
(paren
(paren
r_char
op_star
)paren
id|q
comma
r_sizeof
(paren
op_star
id|q
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* I don&squot;t want the bus now */
id|release_bif
c_func
(paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|queue_attach
r_static
r_void
id|queue_attach
c_func
(paren
r_struct
id|bif_queue
op_star
id|q
)paren
(brace
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* attach it to the end of the queue */
r_if
c_cond
(paren
op_logical_neg
id|bif_queue_top
)paren
(brace
id|bif_queue_top
op_assign
id|q
suffix:semicolon
)brace
r_else
(brace
id|bif_queue_end-&gt;next
op_assign
id|q
suffix:semicolon
)brace
id|bif_queue_end
op_assign
id|q
suffix:semicolon
id|queue_length
op_increment
suffix:semicolon
multiline_comment|/* printk(&quot;|queue add (length=%d)&bslash;n&quot;,queue_length); */
multiline_comment|/* tell the bus we want access */
id|want_bif
c_func
(paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* queue an element for sending over the bif. */
DECL|function|bif_queue
r_int
id|bif_queue
c_func
(paren
r_struct
id|cap_request
op_star
id|req
comma
r_char
op_star
id|buf
comma
r_int
id|bufsize
)paren
(brace
r_struct
id|bif_queue
op_star
id|q
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;header
op_eq
l_int|0
)paren
id|req-&gt;header
op_assign
id|MAKE_HEADER
c_func
(paren
id|HOST_CID
)paren
suffix:semicolon
multiline_comment|/* if we aren&squot;t running interrupt driven then just send it &n;&t;   immediately */
r_if
c_cond
(paren
op_logical_neg
id|interrupt_driven
)paren
(brace
id|write_bif_polled
c_func
(paren
(paren
r_char
op_star
)paren
id|req
comma
r_sizeof
(paren
op_star
id|req
)paren
comma
id|buf
comma
id|bufsize
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* allocate a queue element */
id|q
op_assign
(paren
r_struct
id|bif_queue
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|q
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|q
)paren
(brace
multiline_comment|/* yikes! */
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|q-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|q-&gt;data
op_assign
l_int|NULL
suffix:semicolon
id|q-&gt;data_size
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|buf
op_logical_and
id|bufsize
OG
l_int|0
)paren
(brace
id|q-&gt;data_size
op_assign
id|bufsize
op_plus
r_sizeof
(paren
op_star
id|req
)paren
suffix:semicolon
id|q-&gt;data
op_assign
(paren
r_char
op_star
)paren
id|kmalloc
c_func
(paren
id|q-&gt;data_size
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|q-&gt;data
)paren
(brace
id|kfree_s
c_func
(paren
id|q
comma
r_sizeof
(paren
op_star
id|q
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
id|q-&gt;req
op_assign
op_star
id|req
suffix:semicolon
r_if
c_cond
(paren
id|buf
op_logical_and
id|bufsize
)paren
(brace
id|memcpy
c_func
(paren
id|q-&gt;data
comma
(paren
r_char
op_star
)paren
id|req
comma
r_sizeof
(paren
op_star
id|req
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|q-&gt;data
op_plus
r_sizeof
(paren
op_star
id|req
)paren
comma
id|buf
comma
id|bufsize
)paren
suffix:semicolon
)brace
id|q-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|queue_attach
c_func
(paren
id|q
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* queue an element for sending over the bif. */
DECL|function|bif_queue_nocopy
r_int
id|bif_queue_nocopy
c_func
(paren
r_struct
id|cap_request
op_star
id|req
comma
r_char
op_star
id|buf
comma
r_int
id|bufsize
)paren
(brace
r_struct
id|bif_queue
op_star
id|q
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;header
op_eq
l_int|0
)paren
id|req-&gt;header
op_assign
id|MAKE_HEADER
c_func
(paren
id|HOST_CID
)paren
suffix:semicolon
multiline_comment|/* allocate a queue element */
id|q
op_assign
(paren
r_struct
id|bif_queue
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|q
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|q
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|q-&gt;data
op_assign
id|buf
suffix:semicolon
id|q-&gt;data_size
op_assign
id|bufsize
suffix:semicolon
id|q-&gt;flags
op_assign
id|BIF_NOCOPY
suffix:semicolon
id|q-&gt;req
op_assign
op_star
id|req
suffix:semicolon
id|q-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|queue_attach
c_func
(paren
id|q
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* put an IP packet into the bif queue */
DECL|function|bif_send_ip
r_int
id|bif_send_ip
c_func
(paren
r_int
id|cid
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|cap_request
op_star
id|req
op_assign
(paren
r_struct
id|cap_request
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_struct
id|bif_queue
op_star
id|q
suffix:semicolon
id|u_long
id|destip
suffix:semicolon
id|destip
op_assign
op_star
(paren
id|u_long
op_star
)paren
(paren
id|skb-&gt;data
op_plus
r_sizeof
(paren
op_star
id|req
)paren
op_plus
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cid
op_ne
op_minus
l_int|1
)paren
(brace
id|req-&gt;header
op_assign
id|MAKE_HEADER
c_func
(paren
id|cid
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|destip
op_eq
(paren
id|cap_init.baseIP
op_or
op_complement
id|cap_init.netmask
)paren
)paren
(brace
id|req-&gt;header
op_assign
id|BIF_HEADER_IN
op_or
id|BIF_HEADER_BR
suffix:semicolon
)brace
r_else
(brace
id|req-&gt;header
op_assign
id|MAKE_HEADER
c_func
(paren
id|HOST_CID
)paren
suffix:semicolon
)brace
multiline_comment|/* allocate a queue element */
id|q
op_assign
(paren
r_struct
id|bif_queue
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|q
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|q
)paren
(brace
multiline_comment|/* yikes! */
id|dev_kfree_skb
c_func
(paren
id|skb
comma
id|FREE_WRITE
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|req-&gt;size
op_assign
id|ROUND4
c_func
(paren
id|skb-&gt;len
)paren
suffix:semicolon
id|req-&gt;cid
op_assign
id|mpp_cid
c_func
(paren
)paren
suffix:semicolon
id|req-&gt;type
op_assign
id|REQ_IP
suffix:semicolon
id|q-&gt;data
op_assign
(paren
r_char
op_star
)paren
id|skb
suffix:semicolon
id|q-&gt;data_size
op_assign
id|req-&gt;size
suffix:semicolon
id|q-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|q-&gt;req
op_assign
op_star
id|req
suffix:semicolon
id|q-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|queue_attach
c_func
(paren
id|q
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* send an OPENNET request to tell the front end to open the apnet&n;   network interface */
DECL|function|start_apnet
r_void
id|start_apnet
c_func
(paren
r_void
)paren
(brace
r_struct
id|cap_request
id|req
suffix:semicolon
id|req.cid
op_assign
id|mpp_cid
c_func
(paren
)paren
suffix:semicolon
id|req.type
op_assign
id|REQ_OPENNET
suffix:semicolon
id|req.size
op_assign
r_sizeof
(paren
id|req
)paren
suffix:semicolon
id|req.header
op_assign
id|MAKE_HEADER
c_func
(paren
id|HOST_CID
)paren
suffix:semicolon
id|bif_queue
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;sent start_apnet request&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* we have received an IP packet - pass it to the bif network&n;   interface code */
DECL|function|reply_ip
r_static
r_void
id|reply_ip
c_func
(paren
r_struct
id|cap_request
op_star
id|req
)paren
(brace
r_if
c_cond
(paren
id|drop_ip_packets
op_logical_or
op_logical_neg
(paren
id|skb_in
op_assign
id|dev_alloc_skb
c_func
(paren
id|req-&gt;size
op_minus
r_sizeof
(paren
op_star
id|req
)paren
)paren
)paren
)paren
(brace
id|bif_toss
c_func
(paren
id|req-&gt;size
op_minus
r_sizeof
(paren
op_star
id|req
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|use_dma
op_logical_and
id|req-&gt;size
OG
id|DMA_THRESHOLD
)paren
(brace
id|dma_state
op_assign
id|DMA_INCOMING
suffix:semicolon
id|ap_dma_go
c_func
(paren
id|DMA_CH2
comma
(paren
r_int
)paren
id|skb_put
c_func
(paren
id|skb_in
comma
id|req-&gt;size
op_minus
r_sizeof
(paren
op_star
id|req
)paren
)paren
comma
id|req-&gt;size
op_minus
r_sizeof
(paren
op_star
id|req
)paren
comma
id|DMA_DCMD_TD_DM
)paren
suffix:semicolon
)brace
r_else
(brace
id|read_bif
c_func
(paren
id|skb_put
c_func
(paren
id|skb_in
comma
id|req-&gt;size
op_minus
r_sizeof
(paren
op_star
id|req
)paren
)paren
comma
id|req-&gt;size
op_minus
r_sizeof
(paren
op_star
id|req
)paren
)paren
suffix:semicolon
id|bif_rx
c_func
(paren
id|skb_in
)paren
suffix:semicolon
id|skb_in
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/* we have received a bread block - DMA it in */
DECL|function|reply_bread
r_static
r_void
id|reply_bread
c_func
(paren
r_struct
id|cap_request
op_star
id|req
)paren
(brace
r_extern
r_char
op_star
id|ap_buffer
c_func
(paren
r_struct
id|cap_request
op_star
id|creq
)paren
suffix:semicolon
r_char
op_star
id|buffer
suffix:semicolon
id|buffer
op_assign
id|ap_buffer
c_func
(paren
id|req
)paren
suffix:semicolon
id|bread_req
op_assign
op_star
id|req
suffix:semicolon
r_if
c_cond
(paren
id|use_dma
)paren
(brace
id|dma_state
op_assign
id|DMA_INCOMING
suffix:semicolon
id|ap_dma_go
c_func
(paren
id|DMA_CH2
comma
(paren
r_int
)paren
id|buffer
comma
id|req-&gt;size
op_minus
r_sizeof
(paren
op_star
id|req
)paren
comma
id|DMA_DCMD_TD_DM
)paren
suffix:semicolon
)brace
r_else
(brace
id|read_bif
c_func
(paren
id|buffer
comma
id|req-&gt;size
op_minus
r_sizeof
(paren
op_star
id|req
)paren
)paren
suffix:semicolon
id|ap_complete
c_func
(paren
op_amp
id|bread_req
)paren
suffix:semicolon
id|bread_req.type
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
)brace
DECL|struct|debug_key
r_static
r_struct
id|debug_key
(brace
DECL|member|next
r_struct
id|debug_key
op_star
id|next
suffix:semicolon
DECL|member|key
r_char
id|key
suffix:semicolon
DECL|member|fn
r_void
(paren
op_star
id|fn
)paren
(paren
r_void
)paren
suffix:semicolon
DECL|member|description
r_char
op_star
id|description
suffix:semicolon
DECL|variable|debug_keys
)brace
op_star
id|debug_keys
op_assign
l_int|NULL
suffix:semicolon
DECL|function|show_debug_keys
r_void
id|show_debug_keys
c_func
(paren
r_void
)paren
(brace
r_struct
id|debug_key
op_star
id|r
suffix:semicolon
r_for
c_loop
(paren
id|r
op_assign
id|debug_keys
suffix:semicolon
id|r
suffix:semicolon
id|r
op_assign
id|r-&gt;next
)paren
id|printk
c_func
(paren
l_string|&quot;%c: %s&bslash;n&quot;
comma
id|r-&gt;key
comma
id|r-&gt;description
)paren
suffix:semicolon
)brace
DECL|function|bif_add_debug_key
r_void
id|bif_add_debug_key
c_func
(paren
r_char
id|key
comma
r_void
(paren
op_star
id|fn
)paren
(paren
r_void
)paren
comma
r_char
op_star
id|description
)paren
(brace
r_struct
id|debug_key
op_star
id|r
comma
op_star
id|r2
suffix:semicolon
id|r
op_assign
(paren
r_struct
id|debug_key
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|r
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
(brace
id|r-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|r-&gt;key
op_assign
id|key
suffix:semicolon
id|r-&gt;fn
op_assign
id|fn
suffix:semicolon
id|r-&gt;description
op_assign
id|description
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|debug_keys
)paren
(brace
id|debug_keys
op_assign
id|r
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|r2
op_assign
id|debug_keys
suffix:semicolon
id|r2-&gt;next
op_logical_and
id|r2-&gt;key
op_ne
id|key
suffix:semicolon
id|r2
op_assign
id|r2-&gt;next
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r2-&gt;key
op_eq
id|key
)paren
(brace
id|r2-&gt;fn
op_assign
id|fn
suffix:semicolon
id|r2-&gt;description
op_assign
id|description
suffix:semicolon
id|kfree_s
c_func
(paren
id|r
comma
r_sizeof
(paren
op_star
id|r
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|r2-&gt;next
op_assign
id|r
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/* these are very useful for debugging ! */
DECL|function|reply_putchar
r_static
r_void
id|reply_putchar
c_func
(paren
r_struct
id|cap_request
op_star
id|req
)paren
(brace
r_struct
id|debug_key
op_star
id|r
suffix:semicolon
r_char
id|c
op_assign
id|req-&gt;data
(braket
l_int|0
)braket
suffix:semicolon
id|ap_set_user
c_func
(paren
id|req-&gt;data
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|r
op_assign
id|debug_keys
suffix:semicolon
id|r
suffix:semicolon
id|r
op_assign
id|r-&gt;next
)paren
r_if
c_cond
(paren
id|r-&gt;key
op_eq
id|c
)paren
(brace
id|r
op_member_access_from_pointer
id|fn
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|r
)paren
id|printk
c_func
(paren
l_string|&quot;cell %d got character %d [%c]&bslash;n&quot;
comma
id|mpp_cid
c_func
(paren
)paren
comma
(paren
r_int
)paren
id|c
comma
id|c
)paren
suffix:semicolon
id|ap_set_user
c_func
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* send a signal to a task by name or pid */
DECL|function|reply_kill
r_static
r_void
id|reply_kill
c_func
(paren
r_struct
id|cap_request
op_star
id|req
)paren
(brace
r_int
id|sig
op_assign
id|req-&gt;data
(braket
l_int|0
)braket
suffix:semicolon
r_struct
id|task_struct
op_star
id|p
suffix:semicolon
r_int
id|len
suffix:semicolon
r_char
id|name
(braket
l_int|32
)braket
suffix:semicolon
id|len
op_assign
id|req-&gt;size
op_minus
r_sizeof
(paren
op_star
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_eq
l_int|0
)paren
(brace
r_int
id|pid
op_assign
id|req-&gt;data
(braket
l_int|1
)braket
suffix:semicolon
id|p
op_assign
id|find_task_by_pid
c_func
(paren
id|pid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
id|send_sig
c_func
(paren
id|sig
comma
id|p
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;cell %d: no task with pid %d&bslash;n&quot;
comma
id|mpp_cid
c_func
(paren
)paren
comma
id|pid
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OG
r_sizeof
(paren
id|name
)paren
op_minus
l_int|1
)paren
(brace
id|bif_toss
c_func
(paren
id|len
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|read_bif
c_func
(paren
id|name
comma
id|len
)paren
suffix:semicolon
id|name
(braket
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|tasklist_lock
)paren
suffix:semicolon
id|for_each_task
c_func
(paren
id|p
)paren
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|name
comma
id|p-&gt;comm
)paren
op_eq
l_int|0
)paren
id|send_sig
c_func
(paren
id|sig
comma
id|p
comma
l_int|1
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|tasklist_lock
)paren
suffix:semicolon
)brace
DECL|struct|req_list
r_static
r_struct
id|req_list
(brace
DECL|member|next
r_struct
id|req_list
op_star
id|next
suffix:semicolon
DECL|member|type
r_int
id|type
suffix:semicolon
DECL|member|fn
r_void
(paren
op_star
id|fn
)paren
(paren
r_struct
id|cap_request
op_star
)paren
suffix:semicolon
DECL|variable|reg_req_list
)brace
op_star
id|reg_req_list
op_assign
l_int|NULL
suffix:semicolon
DECL|function|bif_register_request
r_void
id|bif_register_request
c_func
(paren
r_int
id|type
comma
r_void
(paren
op_star
id|fn
)paren
(paren
r_struct
id|cap_request
op_star
)paren
)paren
(brace
r_struct
id|req_list
op_star
id|r
comma
op_star
id|r2
suffix:semicolon
id|r
op_assign
(paren
r_struct
id|req_list
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|r
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
(brace
id|r-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|r-&gt;type
op_assign
id|type
suffix:semicolon
id|r-&gt;fn
op_assign
id|fn
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|reg_req_list
)paren
(brace
id|reg_req_list
op_assign
id|r
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|r2
op_assign
id|reg_req_list
suffix:semicolon
id|r2-&gt;next
op_logical_and
id|r2-&gt;type
op_ne
id|type
suffix:semicolon
id|r2
op_assign
id|r2-&gt;next
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r2-&gt;type
op_eq
id|type
)paren
(brace
id|r2-&gt;fn
op_assign
id|fn
suffix:semicolon
id|kfree_s
c_func
(paren
id|r
comma
r_sizeof
(paren
op_star
id|r
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|r2-&gt;next
op_assign
id|r
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/* a request has come in on the bif - process it */
DECL|function|bif_intr_receive
r_static
r_void
id|bif_intr_receive
c_func
(paren
r_struct
id|cap_request
op_star
id|req1
)paren
(brace
r_struct
id|req_list
op_star
id|r
suffix:semicolon
r_extern
r_void
id|ap_open_reply
c_func
(paren
r_struct
id|cap_request
op_star
id|creq
)paren
suffix:semicolon
r_struct
id|cap_request
id|req
suffix:semicolon
r_if
c_cond
(paren
id|req1
)paren
(brace
id|req
op_assign
op_star
id|req1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* read the main cap request header */
id|read_bif
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|req
comma
r_sizeof
(paren
id|req
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* service it */
r_switch
c_cond
(paren
id|req.type
)paren
(brace
r_case
id|REQ_PUTCHAR
suffix:colon
id|reply_putchar
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|REQ_KILL
suffix:colon
id|reply_kill
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|REQ_BREAK
suffix:colon
id|breakpoint
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|REQ_IP
suffix:colon
id|reply_ip
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#if TOKEN_ARBITRATION
r_case
id|REQ_BIF_TOKEN
suffix:colon
id|have_token
op_assign
l_int|1
suffix:semicolon
id|want_bif
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
id|REQ_OPENNET
suffix:colon
id|net_started
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|REQ_BREAD
suffix:colon
id|reply_bread
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|REQ_BOPEN
suffix:colon
id|ap_open_reply
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|REQ_BWRITE
suffix:colon
id|ap_complete
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|REQ_SCHEDULE
suffix:colon
id|mpp_schedule
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_for
c_loop
(paren
id|r
op_assign
id|reg_req_list
suffix:semicolon
id|r
suffix:semicolon
id|r
op_assign
id|r-&gt;next
)paren
r_if
c_cond
(paren
id|r-&gt;type
op_eq
id|req.type
)paren
(brace
id|r
op_member_access_from_pointer
id|fn
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;Unknown request %d&bslash;n&quot;
comma
id|req.type
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|bif_dma_complete
r_static
r_void
id|bif_dma_complete
c_func
(paren
r_void
)paren
(brace
r_extern
r_int
id|bif_rx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_enum
id|dma_state
id|old_state
op_assign
id|dma_state
suffix:semicolon
r_int
id|a
suffix:semicolon
id|a
op_assign
id|DMA_IN
c_func
(paren
id|DMA2_DMST
)paren
suffix:semicolon
r_if
c_cond
(paren
id|a
op_amp
id|DMA_DMST_AC
)paren
r_return
suffix:semicolon
id|DMA_OUT
c_func
(paren
id|DMA2_DMST
comma
id|AP_CLR_INTR_REQ
op_lshift
id|DMA_INTR_NORMAL_SH
)paren
suffix:semicolon
id|DMA_OUT
c_func
(paren
id|DMA2_DMST
comma
id|AP_CLR_INTR_REQ
op_lshift
id|DMA_INTR_ERROR_SH
)paren
suffix:semicolon
r_if
c_cond
(paren
id|old_state
op_eq
id|DMA_INCOMING
)paren
(brace
r_if
c_cond
(paren
id|skb_in
)paren
id|bif_rx
c_func
(paren
id|skb_in
)paren
suffix:semicolon
id|skb_in
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bread_req.type
op_ne
op_minus
l_int|1
)paren
(brace
id|ap_complete
c_func
(paren
op_amp
id|bread_req
)paren
suffix:semicolon
id|bread_req.type
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bif_dma_data
)paren
(brace
id|kfree_s
c_func
(paren
id|bif_dma_data
comma
id|bif_dma_out_size
)paren
suffix:semicolon
id|bif_dma_data
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb_out
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb_out
comma
id|FREE_WRITE
)paren
suffix:semicolon
id|skb_out
op_assign
l_int|NULL
suffix:semicolon
)brace
id|dma_state
op_assign
id|DMA_IDLE
suffix:semicolon
r_if
c_cond
(paren
id|a
op_amp
(paren
id|AP_INTR_REQ
op_lshift
id|DMA_INTR_ERROR_SH
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;BIF: got dma error&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* handle bif related interrupts. Currently handles 3 interrupts, the&n;   bif header interrupt, the bif get interrupt and the dma transfer&n;   complete interrupt */
DECL|function|bif_interrupt
r_static
r_void
id|bif_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|flags
suffix:semicolon
id|bif_pt_regs
op_assign
id|regs
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|mac_dma_complete
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_state
op_ne
id|DMA_IDLE
)paren
(brace
id|bif_dma_complete
c_func
(paren
)paren
suffix:semicolon
)brace
id|bif_reset_interrupts
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|dma_state
op_eq
id|DMA_IDLE
op_logical_and
id|BIF_DATA_WAITING
c_func
(paren
)paren
)paren
(brace
id|bif_intr_receive
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dma_state
op_ne
id|DMA_IDLE
)paren
(brace
id|bif_dma_complete
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dma_state
op_eq
id|DMA_IDLE
op_logical_and
id|bif_queue_top
op_logical_and
op_logical_neg
id|HAVE_BIF
c_func
(paren
)paren
)paren
(brace
id|want_bif
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dma_state
op_eq
id|DMA_IDLE
op_logical_and
id|HAVE_BIF
c_func
(paren
)paren
)paren
(brace
id|waiting_for_bif
op_assign
l_int|0
suffix:semicolon
id|bif_intr_runqueue
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dma_state
op_eq
id|DMA_IDLE
op_logical_and
id|HAVE_BIF
c_func
(paren
)paren
)paren
(brace
id|release_bif
c_func
(paren
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|bif_pt_regs
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* handle the attention interrupt - used for BIF arbitration */
DECL|function|attn_interrupt
r_static
r_void
id|attn_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|attn_enable
c_func
(paren
)paren
suffix:semicolon
macro_line|#if SNET_ARBITRATION
id|attn_mask
c_func
(paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
(paren
l_string|&quot;|bif attn irq %d&bslash;n&quot;
comma
id|irq
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|waiting_for_bif
)paren
id|want_bif
c_func
(paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
(paren
l_string|&quot;|bif attn irq %d done&bslash;n&quot;
comma
id|irq
)paren
)paren
suffix:semicolon
macro_line|#endif
id|bif_interrupt
c_func
(paren
id|irq
comma
id|dev_id
comma
id|regs
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|bif_timer
r_void
id|bif_timer
c_func
(paren
r_void
)paren
(brace
macro_line|#if 1
r_if
c_cond
(paren
id|interrupt_driven
)paren
id|bif_interrupt
c_func
(paren
l_int|0
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|tnet_ip_enable
r_static
r_void
id|tnet_ip_enable
c_func
(paren
r_void
)paren
(brace
id|tnet_ip_enabled
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;tnet_ip_enabled=%d&bslash;n&quot;
comma
id|tnet_ip_enabled
)paren
suffix:semicolon
)brace
DECL|function|tnet_ip_disable
r_static
r_void
id|tnet_ip_disable
c_func
(paren
r_void
)paren
(brace
id|tnet_ip_enabled
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;tnet_ip_enabled=%d&bslash;n&quot;
comma
id|tnet_ip_enabled
)paren
suffix:semicolon
)brace
multiline_comment|/* initialise the bif code */
DECL|function|ap_bif_init
r_void
id|ap_bif_init
c_func
(paren
r_void
)paren
(brace
r_int
id|res
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;doing ap_bif_init()&bslash;n&quot;
)paren
suffix:semicolon
id|bif_add_debug_key
c_func
(paren
l_char|&squot;+&squot;
comma
id|tnet_ip_enable
comma
l_string|&quot;enable Tnet based IP&quot;
)paren
suffix:semicolon
id|bif_add_debug_key
c_func
(paren
l_char|&squot;-&squot;
comma
id|tnet_ip_disable
comma
l_string|&quot;disable Tnet based IP&quot;
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* register the BIF interrupt */
r_if
c_cond
(paren
(paren
id|res
op_assign
id|request_irq
c_func
(paren
id|APBIF_IRQ
comma
id|bif_interrupt
comma
id|SA_INTERRUPT
comma
l_string|&quot;apbif&quot;
comma
l_int|NULL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Failed to install bif interrupt handler&bslash;n&quot;
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* and the bus get interrupt */
r_if
c_cond
(paren
(paren
id|res
op_assign
id|request_irq
c_func
(paren
id|APBIFGET_IRQ
comma
id|bif_interrupt
comma
id|SA_INTERRUPT
comma
l_string|&quot;apbifget&quot;
comma
l_int|NULL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Failed to install bifget interrupt handler&bslash;n&quot;
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* dma complete interrupt */
r_if
c_cond
(paren
(paren
id|res
op_assign
id|request_irq
c_func
(paren
id|APDMA_IRQ
comma
id|bif_interrupt
comma
id|SA_INTERRUPT
comma
l_string|&quot;apdma&quot;
comma
l_int|NULL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Failed to install bifdma interrupt handler&bslash;n&quot;
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* attention interrupt */
r_if
c_cond
(paren
(paren
id|res
op_assign
id|request_irq
c_func
(paren
id|APATTN_IRQ
comma
id|attn_interrupt
comma
id|SA_INTERRUPT
comma
l_string|&quot;apattn&quot;
comma
l_int|NULL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Failed to install apattn interrupt handler&bslash;n&quot;
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;Installed bif handlers&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* enable dma-request */
id|BIF_OUT
c_func
(paren
id|BIF_SDCSR
comma
id|BIF_SDCSR_DE
)paren
suffix:semicolon
id|DMA_OUT
c_func
(paren
id|DMA2_DCMD
comma
id|DMA_DCMD_SA
)paren
suffix:semicolon
id|DMA_OUT
c_func
(paren
id|DMA2_DMST
comma
id|DMA_DMST_RST
)paren
suffix:semicolon
id|DMA_OUT
c_func
(paren
id|DMA2_DMST
comma
id|AP_CLR_INTR_REQ
op_lshift
id|DMA_INTR_NORMAL_SH
)paren
suffix:semicolon
id|DMA_OUT
c_func
(paren
id|DMA2_DMST
comma
id|AP_CLR_INTR_MASK
op_lshift
id|DMA_INTR_NORMAL_SH
)paren
suffix:semicolon
id|DMA_OUT
c_func
(paren
id|DMA2_DMST
comma
id|AP_CLR_INTR_REQ
op_lshift
id|DMA_INTR_ERROR_SH
)paren
suffix:semicolon
id|DMA_OUT
c_func
(paren
id|DMA2_DMST
comma
id|AP_CLR_INTR_MASK
op_lshift
id|DMA_INTR_ERROR_SH
)paren
suffix:semicolon
multiline_comment|/* enable the attention interrupt */
id|attn_enable
c_func
(paren
)paren
suffix:semicolon
id|DMA_OUT
c_func
(paren
id|DMA_BIF_BCMD
comma
id|DMA_BCMD_SA
)paren
suffix:semicolon
id|DMA_OUT
c_func
(paren
id|DMA_BIF_BRST
comma
id|DMA_DMST_RST
)paren
suffix:semicolon
multiline_comment|/* from now on we are interrupt driven */
id|bread_req.type
op_assign
op_minus
l_int|1
suffix:semicolon
id|dma_state
op_assign
id|DMA_IDLE
suffix:semicolon
id|interrupt_driven
op_assign
l_int|1
suffix:semicolon
id|use_dma
op_assign
l_int|1
suffix:semicolon
id|bif_reset_interrupts
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* if theres something in the queue then we also want the bus */
r_if
c_cond
(paren
id|bif_queue_top
)paren
id|want_bif
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* tell the host that networking is now OK */
id|start_apnet
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;bif initialised&bslash;n&quot;
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
eof
