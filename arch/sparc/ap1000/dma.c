multiline_comment|/*&n;   * Copyright 1996 The Australian National University.&n;   * Copyright 1996 Fujitsu Laboratories Limited&n;   * &n;   * This software may be distributed under the terms of the Gnu&n;   * Public License version 2 or later&n;  */
multiline_comment|/* dma routines for the AP1000 */
macro_line|#include &lt;asm/ap1000/apservice.h&gt;
macro_line|#include &lt;asm/ap1000/apreg.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
DECL|macro|DMA_MAX_TRANS_SIZE2
mdefine_line|#define DMA_MAX_TRANS_SIZE2 (0xfffffc)
DECL|function|ap_dma_wait
r_int
id|ap_dma_wait
c_func
(paren
r_int
id|ch
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|DMA_IN
c_func
(paren
id|ch
op_plus
id|DMA_DMST
)paren
op_amp
id|DMA_DMST_AC
)paren
id|i
op_increment
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
multiline_comment|/* send some data out a dma channel */
DECL|function|ap_dma_go
r_int
id|ap_dma_go
c_func
(paren
r_int
r_int
id|ch
comma
r_int
r_int
id|p
comma
r_int
id|size
comma
r_int
r_int
id|cmd
)paren
(brace
r_int
id|rest
suffix:semicolon
id|p
op_assign
id|mmu_v2p
c_func
(paren
id|p
)paren
suffix:semicolon
id|cmd
op_or_assign
id|DMA_DCMD_ST
op_or
id|DMA_DCMD_TYP_AUTO
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|ap_dma_wait
c_func
(paren
id|ch
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;WARNING: dma started when not complete&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_eq
id|DMA_DCMD_TD_MD
op_logical_and
op_logical_neg
(paren
id|BIF_IN
c_func
(paren
id|BIF_SDCSR
)paren
op_amp
id|BIF_SDCSR_BG
)paren
)paren
(brace
id|ap_led
c_func
(paren
l_int|0xAA
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;attempt to dma without holding the bus&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* reset the dma system */
id|DMA_OUT
c_func
(paren
id|ch
op_plus
id|DMA_DMST
comma
id|DMA_DMST_RST
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
op_le
id|DMA_MAX_TRANS_SIZE
)paren
(brace
id|DMA_OUT
c_func
(paren
id|ch
op_plus
id|DMA_MADDR
comma
(paren
r_int
r_int
)paren
id|p
)paren
suffix:semicolon
id|DMA_OUT
c_func
(paren
id|ch
op_plus
id|DMA_HSKIP
comma
l_int|1
)paren
suffix:semicolon
id|DMA_OUT
c_func
(paren
id|ch
op_plus
id|DMA_VSKIP
comma
l_int|1
)paren
suffix:semicolon
id|DMA_OUT
c_func
(paren
id|ch
op_plus
id|DMA_DCMD
comma
id|cmd
op_or
id|B2W
c_func
(paren
id|size
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|size
op_le
id|DMA_MAX_TRANS_SIZE2
)paren
(brace
r_if
c_cond
(paren
id|size
op_amp
l_int|0x3
)paren
(brace
id|size
op_add_assign
l_int|4
suffix:semicolon
)brace
id|rest
op_assign
(paren
id|size
op_amp
(paren
id|DMA_TRANS_BLOCK_SIZE
op_minus
l_int|1
)paren
)paren
op_rshift
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|rest
)paren
(brace
id|DMA_OUT
c_func
(paren
id|ch
op_plus
id|DMA_HDRP
comma
(paren
r_int
)paren
id|p
)paren
suffix:semicolon
id|p
op_add_assign
id|rest
op_lshift
l_int|2
suffix:semicolon
)brace
id|DMA_OUT
c_func
(paren
id|ch
op_plus
id|DMA_MADDR
comma
(paren
r_int
)paren
id|p
)paren
suffix:semicolon
id|DMA_OUT
c_func
(paren
id|ch
op_plus
id|DMA_HSKIP
comma
id|size
op_rshift
(paren
l_int|2
op_plus
l_int|6
)paren
)paren
suffix:semicolon
id|DMA_OUT
c_func
(paren
id|ch
op_plus
id|DMA_VSKIP
comma
l_int|1
)paren
suffix:semicolon
id|DMA_OUT
c_func
(paren
id|ch
op_plus
id|DMA_DCMD
comma
id|cmd
op_or
(paren
id|rest
op_lshift
l_int|16
)paren
op_or
l_int|64
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;AP1000 DMA operation too big (%d bytes) - aborting&bslash;n&quot;
comma
id|size
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
eof
