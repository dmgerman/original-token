multiline_comment|/* $Id: sun4c.c,v 1.202 2000/12/01 03:17:31 anton Exp $&n; * sun4c.c: Doing in software what should be done in hardware.&n; *&n; * Copyright (C) 1996 David S. Miller (davem@caip.rutgers.edu)&n; * Copyright (C) 1996 Eddie C. Dost (ecd@skynet.be)&n; * Copyright (C) 1996 Andrew Tridgell (Andrew.Tridgell@anu.edu.au)&n; * Copyright (C) 1997-2000 Anton Blanchard (anton@linuxcare.com)&n; * Copyright (C) 1998 Jakub Jelinek (jj@sunsite.mff.cuni.cz)&n; */
DECL|macro|NR_TASK_BUCKETS
mdefine_line|#define NR_TASK_BUCKETS 512
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;asm/scatterlist.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgalloc.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/vaddrs.h&gt;
macro_line|#include &lt;asm/idprom.h&gt;
macro_line|#include &lt;asm/machines.h&gt;
macro_line|#include &lt;asm/memreg.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/auxio.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/openprom.h&gt;
macro_line|#include &lt;asm/mmu_context.h&gt;
macro_line|#include &lt;asm/sun4paddr.h&gt;
multiline_comment|/* Because of our dynamic kernel TLB miss strategy, and how&n; * our DVMA mapping allocation works, you _MUST_:&n; *&n; * 1) Disable interrupts _and_ not touch any dynamic kernel&n; *    memory while messing with kernel MMU state.  By&n; *    dynamic memory I mean any object which is not in&n; *    the kernel image itself or a task_struct (both of&n; *    which are locked into the MMU).&n; * 2) Disable interrupts while messing with user MMU state.&n; */
r_extern
r_int
id|num_segmaps
comma
id|num_contexts
suffix:semicolon
r_extern
r_int
r_int
id|page_kernel
suffix:semicolon
macro_line|#ifdef CONFIG_SUN4
DECL|macro|SUN4C_VAC_SIZE
mdefine_line|#define SUN4C_VAC_SIZE sun4c_vacinfo.num_bytes
macro_line|#else
multiline_comment|/* That&squot;s it, we prom_halt() on sun4c if the cache size is something other than 65536.&n; * So let&squot;s save some cycles and just use that everywhere except for that bootup&n; * sanity check.&n; */
DECL|macro|SUN4C_VAC_SIZE
mdefine_line|#define SUN4C_VAC_SIZE 65536
macro_line|#endif
DECL|macro|SUN4C_KERNEL_BUCKETS
mdefine_line|#define SUN4C_KERNEL_BUCKETS 32
macro_line|#ifndef MAX
DECL|macro|MAX
mdefine_line|#define MAX(a,b) ((a)&lt;(b)?(b):(a))
macro_line|#endif
macro_line|#ifndef MIN
DECL|macro|MIN
mdefine_line|#define MIN(a,b) ((a)&lt;(b)?(a):(b))
macro_line|#endif
multiline_comment|/* Flushing the cache. */
DECL|variable|sun4c_vacinfo
r_struct
id|sun4c_vac_props
id|sun4c_vacinfo
suffix:semicolon
DECL|variable|sun4c_kernel_faults
r_int
r_int
id|sun4c_kernel_faults
suffix:semicolon
multiline_comment|/* Invalidate every sun4c cache line tag. */
DECL|function|sun4c_flush_all
r_void
id|sun4c_flush_all
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|begin
comma
id|end
suffix:semicolon
r_if
c_cond
(paren
id|sun4c_vacinfo.on
)paren
id|panic
c_func
(paren
l_string|&quot;SUN4C: AIEEE, trying to invalidate vac while&quot;
l_string|&quot; it is on.&quot;
)paren
suffix:semicolon
multiline_comment|/* Clear &squot;valid&squot; bit in all cache line tags */
id|begin
op_assign
id|AC_CACHETAGS
suffix:semicolon
id|end
op_assign
(paren
id|AC_CACHETAGS
op_plus
id|SUN4C_VAC_SIZE
)paren
suffix:semicolon
r_while
c_loop
(paren
id|begin
OL
id|end
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;sta %%g0, [%0] %1&bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|begin
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_CONTROL
)paren
)paren
suffix:semicolon
id|begin
op_add_assign
id|sun4c_vacinfo.linesize
suffix:semicolon
)brace
)brace
DECL|function|sun4c_flush_context_hw
r_static
id|__inline__
r_void
id|sun4c_flush_context_hw
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|end
op_assign
id|SUN4C_VAC_SIZE
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;1:&t;addcc&t;%0, -4096, %0&bslash;n&bslash;t&quot;
l_string|&quot;&t;bne&t;1b&bslash;n&bslash;t&quot;
l_string|&quot;&t; sta&t;%%g0, [%0] %2&quot;
suffix:colon
l_string|&quot;=&amp;r&quot;
(paren
id|end
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|end
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_HWFLUSHCONTEXT
)paren
suffix:colon
l_string|&quot;cc&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Must be called minimally with IRQs disabled. */
DECL|function|sun4c_flush_segment_hw
r_static
r_void
id|sun4c_flush_segment_hw
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_if
c_cond
(paren
id|sun4c_get_segmap
c_func
(paren
id|addr
)paren
op_ne
id|invalid_segment
)paren
(brace
r_int
r_int
id|vac_size
op_assign
id|SUN4C_VAC_SIZE
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;1:&t;addcc&t;%0, -4096, %0&bslash;n&bslash;t&quot;
l_string|&quot;&t;bne&t;1b&bslash;n&bslash;t&quot;
l_string|&quot;&t; sta&t;%%g0, [%2 + %0] %3&quot;
suffix:colon
l_string|&quot;=&amp;r&quot;
(paren
id|vac_size
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|vac_size
)paren
comma
l_string|&quot;r&quot;
(paren
id|addr
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_HWFLUSHSEG
)paren
suffix:colon
l_string|&quot;cc&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Must be called minimally with interrupts disabled. */
DECL|function|sun4c_flush_page_hw
r_static
id|__inline__
r_void
id|sun4c_flush_page_hw
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
id|addr
op_and_assign
id|PAGE_MASK
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|sun4c_get_pte
c_func
(paren
id|addr
)paren
OL
l_int|0
)paren
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;sta %%g0, [%0] %1&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|addr
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_HWFLUSHPAGE
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Don&squot;t inline the software version as it eats too many cache lines if expanded. */
DECL|function|sun4c_flush_context_sw
r_static
r_void
id|sun4c_flush_context_sw
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|nbytes
op_assign
id|SUN4C_VAC_SIZE
suffix:semicolon
r_int
r_int
id|lsize
op_assign
id|sun4c_vacinfo.linesize
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
"&quot;"
id|add
op_mod
l_int|2
comma
op_mod
l_int|2
comma
op_mod
op_mod
id|g1
id|add
op_mod
l_int|2
comma
op_mod
op_mod
id|g1
comma
op_mod
op_mod
id|g2
id|add
op_mod
l_int|2
comma
op_mod
op_mod
id|g2
comma
op_mod
op_mod
id|g3
id|add
op_mod
l_int|2
comma
op_mod
op_mod
id|g3
comma
op_mod
op_mod
id|g4
id|add
op_mod
l_int|2
comma
op_mod
op_mod
id|g4
comma
op_mod
op_mod
id|g5
id|add
op_mod
l_int|2
comma
op_mod
op_mod
id|g5
comma
op_mod
op_mod
id|o4
id|add
op_mod
l_int|2
comma
op_mod
op_mod
id|o4
comma
op_mod
op_mod
id|o5
l_int|1
suffix:colon
id|subcc
op_mod
l_int|0
comma
op_mod
op_mod
id|o5
comma
op_mod
l_int|0
id|sta
op_mod
op_mod
id|g0
comma
(braket
op_mod
l_int|0
)braket
op_mod
l_int|3
id|sta
op_mod
op_mod
id|g0
comma
(braket
op_mod
l_int|0
op_plus
op_mod
l_int|2
)braket
op_mod
l_int|3
id|sta
op_mod
op_mod
id|g0
comma
(braket
op_mod
l_int|0
op_plus
op_mod
op_mod
id|g1
)braket
op_mod
l_int|3
id|sta
op_mod
op_mod
id|g0
comma
(braket
op_mod
l_int|0
op_plus
op_mod
op_mod
id|g2
)braket
op_mod
l_int|3
id|sta
op_mod
op_mod
id|g0
comma
(braket
op_mod
l_int|0
op_plus
op_mod
op_mod
id|g3
)braket
op_mod
l_int|3
id|sta
op_mod
op_mod
id|g0
comma
(braket
op_mod
l_int|0
op_plus
op_mod
op_mod
id|g4
)braket
op_mod
l_int|3
id|sta
op_mod
op_mod
id|g0
comma
(braket
op_mod
l_int|0
op_plus
op_mod
op_mod
id|g5
)braket
op_mod
l_int|3
id|bg
l_int|1
id|b
id|sta
op_mod
op_mod
id|g0
comma
(braket
op_mod
l_int|1
op_plus
op_mod
op_mod
id|o4
)braket
op_mod
l_int|3
l_string|&quot;&t;: &quot;
op_assign
op_amp
id|r
"&quot;"
(paren
id|nbytes
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|nbytes
)paren
comma
l_string|&quot;r&quot;
(paren
id|lsize
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_FLUSHCTX
)paren
suffix:colon
l_string|&quot;g1&quot;
comma
l_string|&quot;g2&quot;
comma
l_string|&quot;g3&quot;
comma
l_string|&quot;g4&quot;
comma
l_string|&quot;g5&quot;
comma
l_string|&quot;o4&quot;
comma
l_string|&quot;o5&quot;
comma
l_string|&quot;cc&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Don&squot;t inline the software version as it eats too many cache lines if expanded. */
DECL|function|sun4c_flush_segment_sw
r_static
r_void
id|sun4c_flush_segment_sw
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_if
c_cond
(paren
id|sun4c_get_segmap
c_func
(paren
id|addr
)paren
op_ne
id|invalid_segment
)paren
(brace
r_int
r_int
id|nbytes
op_assign
id|SUN4C_VAC_SIZE
suffix:semicolon
r_int
r_int
id|lsize
op_assign
id|sun4c_vacinfo.linesize
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
"&quot;"
id|add
op_mod
l_int|2
comma
op_mod
l_int|2
comma
op_mod
op_mod
id|g1
id|add
op_mod
l_int|2
comma
op_mod
op_mod
id|g1
comma
op_mod
op_mod
id|g2
id|add
op_mod
l_int|2
comma
op_mod
op_mod
id|g2
comma
op_mod
op_mod
id|g3
id|add
op_mod
l_int|2
comma
op_mod
op_mod
id|g3
comma
op_mod
op_mod
id|g4
id|add
op_mod
l_int|2
comma
op_mod
op_mod
id|g4
comma
op_mod
op_mod
id|g5
id|add
op_mod
l_int|2
comma
op_mod
op_mod
id|g5
comma
op_mod
op_mod
id|o4
id|add
op_mod
l_int|2
comma
op_mod
op_mod
id|o4
comma
op_mod
op_mod
id|o5
l_int|1
suffix:colon
id|subcc
op_mod
l_int|1
comma
op_mod
op_mod
id|o5
comma
op_mod
l_int|1
id|sta
op_mod
op_mod
id|g0
comma
(braket
op_mod
l_int|0
)braket
op_mod
l_int|6
id|sta
op_mod
op_mod
id|g0
comma
(braket
op_mod
l_int|0
op_plus
op_mod
l_int|2
)braket
op_mod
l_int|6
id|sta
op_mod
op_mod
id|g0
comma
(braket
op_mod
l_int|0
op_plus
op_mod
op_mod
id|g1
)braket
op_mod
l_int|6
id|sta
op_mod
op_mod
id|g0
comma
(braket
op_mod
l_int|0
op_plus
op_mod
op_mod
id|g2
)braket
op_mod
l_int|6
id|sta
op_mod
op_mod
id|g0
comma
(braket
op_mod
l_int|0
op_plus
op_mod
op_mod
id|g3
)braket
op_mod
l_int|6
id|sta
op_mod
op_mod
id|g0
comma
(braket
op_mod
l_int|0
op_plus
op_mod
op_mod
id|g4
)braket
op_mod
l_int|6
id|sta
op_mod
op_mod
id|g0
comma
(braket
op_mod
l_int|0
op_plus
op_mod
op_mod
id|g5
)braket
op_mod
l_int|6
id|sta
op_mod
op_mod
id|g0
comma
(braket
op_mod
l_int|0
op_plus
op_mod
op_mod
id|o4
)braket
op_mod
l_int|6
id|bg
l_int|1
id|b
id|add
op_mod
l_int|0
comma
op_mod
op_mod
id|o5
comma
op_mod
l_int|0
l_string|&quot;&t;&t;: &quot;
op_assign
op_amp
id|r
l_string|&quot; (addr), &quot;
op_assign
op_amp
id|r
l_string|&quot; (nbytes), &quot;
op_assign
op_amp
id|r
"&quot;"
(paren
id|lsize
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|addr
)paren
comma
l_string|&quot;1&quot;
(paren
id|nbytes
)paren
comma
l_string|&quot;2&quot;
(paren
id|lsize
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_FLUSHSEG
)paren
suffix:colon
l_string|&quot;g1&quot;
comma
l_string|&quot;g2&quot;
comma
l_string|&quot;g3&quot;
comma
l_string|&quot;g4&quot;
comma
l_string|&quot;g5&quot;
comma
l_string|&quot;o4&quot;
comma
l_string|&quot;o5&quot;
comma
l_string|&quot;cc&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Bolix one page from the virtual cache. */
DECL|function|sun4c_flush_page
r_static
r_void
id|sun4c_flush_page
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
id|addr
op_and_assign
id|PAGE_MASK
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sun4c_get_pte
c_func
(paren
id|addr
)paren
op_amp
(paren
id|_SUN4C_PAGE_NOCACHE
op_or
id|_SUN4C_PAGE_VALID
)paren
)paren
op_ne
id|_SUN4C_PAGE_VALID
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|sun4c_vacinfo.do_hwflushes
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;sta %%g0, [%0] %1;nop;nop;nop;&bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|addr
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_HWFLUSHPAGE
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
r_int
id|left
op_assign
id|PAGE_SIZE
suffix:semicolon
r_int
r_int
id|lsize
op_assign
id|sun4c_vacinfo.linesize
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;add&t;%2, %2, %%g1&bslash;n&bslash;t&quot;
l_string|&quot;add&t;%2, %%g1, %%g2&bslash;n&bslash;t&quot;
l_string|&quot;add&t;%2, %%g2, %%g3&bslash;n&bslash;t&quot;
l_string|&quot;add&t;%2, %%g3, %%g4&bslash;n&bslash;t&quot;
l_string|&quot;add&t;%2, %%g4, %%g5&bslash;n&bslash;t&quot;
l_string|&quot;add&t;%2, %%g5, %%o4&bslash;n&bslash;t&quot;
l_string|&quot;add&t;%2, %%o4, %%o5&bslash;n&quot;
l_string|&quot;1:&bslash;n&bslash;t&quot;
l_string|&quot;subcc&t;%1, %%o5, %1&bslash;n&bslash;t&quot;
l_string|&quot;sta&t;%%g0, [%0] %6&bslash;n&bslash;t&quot;
l_string|&quot;sta&t;%%g0, [%0 + %2] %6&bslash;n&bslash;t&quot;
l_string|&quot;sta&t;%%g0, [%0 + %%g1] %6&bslash;n&bslash;t&quot;
l_string|&quot;sta&t;%%g0, [%0 + %%g2] %6&bslash;n&bslash;t&quot;
l_string|&quot;sta&t;%%g0, [%0 + %%g3] %6&bslash;n&bslash;t&quot;
l_string|&quot;sta&t;%%g0, [%0 + %%g4] %6&bslash;n&bslash;t&quot;
l_string|&quot;sta&t;%%g0, [%0 + %%g5] %6&bslash;n&bslash;t&quot;
l_string|&quot;sta&t;%%g0, [%0 + %%o4] %6&bslash;n&bslash;t&quot;
l_string|&quot;bg&t;1b&bslash;n&bslash;t&quot;
l_string|&quot; add&t;%0, %%o5, %0&bslash;n&bslash;t&quot;
suffix:colon
l_string|&quot;=&amp;r&quot;
(paren
id|addr
)paren
comma
l_string|&quot;=&amp;r&quot;
(paren
id|left
)paren
comma
l_string|&quot;=&amp;r&quot;
(paren
id|lsize
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|addr
)paren
comma
l_string|&quot;1&quot;
(paren
id|left
)paren
comma
l_string|&quot;2&quot;
(paren
id|lsize
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_FLUSHPG
)paren
suffix:colon
l_string|&quot;g1&quot;
comma
l_string|&quot;g2&quot;
comma
l_string|&quot;g3&quot;
comma
l_string|&quot;g4&quot;
comma
l_string|&quot;g5&quot;
comma
l_string|&quot;o4&quot;
comma
l_string|&quot;o5&quot;
comma
l_string|&quot;cc&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Don&squot;t inline the software version as it eats too many cache lines if expanded. */
DECL|function|sun4c_flush_page_sw
r_static
r_void
id|sun4c_flush_page_sw
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
id|addr
op_and_assign
id|PAGE_MASK
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sun4c_get_pte
c_func
(paren
id|addr
)paren
op_amp
(paren
id|_SUN4C_PAGE_NOCACHE
op_or
id|_SUN4C_PAGE_VALID
)paren
)paren
op_eq
id|_SUN4C_PAGE_VALID
)paren
(brace
r_int
r_int
id|left
op_assign
id|PAGE_SIZE
suffix:semicolon
r_int
r_int
id|lsize
op_assign
id|sun4c_vacinfo.linesize
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
"&quot;"
id|add
op_mod
l_int|2
comma
op_mod
l_int|2
comma
op_mod
op_mod
id|g1
id|add
op_mod
l_int|2
comma
op_mod
op_mod
id|g1
comma
op_mod
op_mod
id|g2
id|add
op_mod
l_int|2
comma
op_mod
op_mod
id|g2
comma
op_mod
op_mod
id|g3
id|add
op_mod
l_int|2
comma
op_mod
op_mod
id|g3
comma
op_mod
op_mod
id|g4
id|add
op_mod
l_int|2
comma
op_mod
op_mod
id|g4
comma
op_mod
op_mod
id|g5
id|add
op_mod
l_int|2
comma
op_mod
op_mod
id|g5
comma
op_mod
op_mod
id|o4
id|add
op_mod
l_int|2
comma
op_mod
op_mod
id|o4
comma
op_mod
op_mod
id|o5
l_int|1
suffix:colon
id|subcc
op_mod
l_int|1
comma
op_mod
op_mod
id|o5
comma
op_mod
l_int|1
id|sta
op_mod
op_mod
id|g0
comma
(braket
op_mod
l_int|0
)braket
op_mod
l_int|6
id|sta
op_mod
op_mod
id|g0
comma
(braket
op_mod
l_int|0
op_plus
op_mod
l_int|2
)braket
op_mod
l_int|6
id|sta
op_mod
op_mod
id|g0
comma
(braket
op_mod
l_int|0
op_plus
op_mod
op_mod
id|g1
)braket
op_mod
l_int|6
id|sta
op_mod
op_mod
id|g0
comma
(braket
op_mod
l_int|0
op_plus
op_mod
op_mod
id|g2
)braket
op_mod
l_int|6
id|sta
op_mod
op_mod
id|g0
comma
(braket
op_mod
l_int|0
op_plus
op_mod
op_mod
id|g3
)braket
op_mod
l_int|6
id|sta
op_mod
op_mod
id|g0
comma
(braket
op_mod
l_int|0
op_plus
op_mod
op_mod
id|g4
)braket
op_mod
l_int|6
id|sta
op_mod
op_mod
id|g0
comma
(braket
op_mod
l_int|0
op_plus
op_mod
op_mod
id|g5
)braket
op_mod
l_int|6
id|sta
op_mod
op_mod
id|g0
comma
(braket
op_mod
l_int|0
op_plus
op_mod
op_mod
id|o4
)braket
op_mod
l_int|6
id|bg
l_int|1
id|b
id|add
op_mod
l_int|0
comma
op_mod
op_mod
id|o5
comma
op_mod
l_int|0
l_string|&quot;&t;&t;: &quot;
op_assign
op_amp
id|r
l_string|&quot; (addr), &quot;
op_assign
op_amp
id|r
l_string|&quot; (left), &quot;
op_assign
op_amp
id|r
"&quot;"
(paren
id|lsize
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|addr
)paren
comma
l_string|&quot;1&quot;
(paren
id|left
)paren
comma
l_string|&quot;2&quot;
(paren
id|lsize
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_FLUSHPG
)paren
suffix:colon
l_string|&quot;g1&quot;
comma
l_string|&quot;g2&quot;
comma
l_string|&quot;g3&quot;
comma
l_string|&quot;g4&quot;
comma
l_string|&quot;g5&quot;
comma
l_string|&quot;o4&quot;
comma
l_string|&quot;o5&quot;
comma
l_string|&quot;cc&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* The sun4c&squot;s do have an on chip store buffer.  And the way you&n; * clear them out isn&squot;t so obvious.  The only way I can think of&n; * to accomplish this is to read the current context register,&n; * store the same value there, then read an external hardware&n; * register.&n; */
DECL|function|sun4c_complete_all_stores
r_void
id|sun4c_complete_all_stores
c_func
(paren
r_void
)paren
(brace
r_volatile
r_int
id|_unused
suffix:semicolon
id|_unused
op_assign
id|sun4c_get_context
c_func
(paren
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
id|_unused
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SUN_AUXIO
id|_unused
op_assign
op_star
id|AUXREG
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Bootup utility functions. */
DECL|function|sun4c_init_clean_segmap
r_static
r_inline
r_void
id|sun4c_init_clean_segmap
c_func
(paren
r_int
r_char
id|pseg
)paren
(brace
r_int
r_int
id|vaddr
suffix:semicolon
id|sun4c_put_segmap
c_func
(paren
l_int|0
comma
id|pseg
)paren
suffix:semicolon
r_for
c_loop
(paren
id|vaddr
op_assign
l_int|0
suffix:semicolon
id|vaddr
OL
id|SUN4C_REAL_PGDIR_SIZE
suffix:semicolon
id|vaddr
op_add_assign
id|PAGE_SIZE
)paren
id|sun4c_put_pte
c_func
(paren
id|vaddr
comma
l_int|0
)paren
suffix:semicolon
id|sun4c_put_segmap
c_func
(paren
l_int|0
comma
id|invalid_segment
)paren
suffix:semicolon
)brace
DECL|function|sun4c_init_clean_mmu
r_static
r_inline
r_void
id|sun4c_init_clean_mmu
c_func
(paren
r_int
r_int
id|kernel_end
)paren
(brace
r_int
r_int
id|vaddr
suffix:semicolon
r_int
r_char
id|savectx
comma
id|ctx
suffix:semicolon
id|savectx
op_assign
id|sun4c_get_context
c_func
(paren
)paren
suffix:semicolon
id|kernel_end
op_assign
id|SUN4C_REAL_PGDIR_ALIGN
c_func
(paren
id|kernel_end
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ctx
op_assign
l_int|0
suffix:semicolon
id|ctx
OL
id|num_contexts
suffix:semicolon
id|ctx
op_increment
)paren
(brace
id|sun4c_set_context
c_func
(paren
id|ctx
)paren
suffix:semicolon
r_for
c_loop
(paren
id|vaddr
op_assign
l_int|0
suffix:semicolon
id|vaddr
OL
l_int|0x20000000
suffix:semicolon
id|vaddr
op_add_assign
id|SUN4C_REAL_PGDIR_SIZE
)paren
id|sun4c_put_segmap
c_func
(paren
id|vaddr
comma
id|invalid_segment
)paren
suffix:semicolon
r_for
c_loop
(paren
id|vaddr
op_assign
l_int|0xe0000000
suffix:semicolon
id|vaddr
OL
id|KERNBASE
suffix:semicolon
id|vaddr
op_add_assign
id|SUN4C_REAL_PGDIR_SIZE
)paren
id|sun4c_put_segmap
c_func
(paren
id|vaddr
comma
id|invalid_segment
)paren
suffix:semicolon
r_for
c_loop
(paren
id|vaddr
op_assign
id|kernel_end
suffix:semicolon
id|vaddr
OL
id|KADB_DEBUGGER_BEGVM
suffix:semicolon
id|vaddr
op_add_assign
id|SUN4C_REAL_PGDIR_SIZE
)paren
id|sun4c_put_segmap
c_func
(paren
id|vaddr
comma
id|invalid_segment
)paren
suffix:semicolon
r_for
c_loop
(paren
id|vaddr
op_assign
id|LINUX_OPPROM_ENDVM
suffix:semicolon
id|vaddr
suffix:semicolon
id|vaddr
op_add_assign
id|SUN4C_REAL_PGDIR_SIZE
)paren
id|sun4c_put_segmap
c_func
(paren
id|vaddr
comma
id|invalid_segment
)paren
suffix:semicolon
)brace
id|sun4c_set_context
c_func
(paren
id|savectx
)paren
suffix:semicolon
)brace
DECL|function|sun4c_probe_vac
r_void
id|__init
id|sun4c_probe_vac
c_func
(paren
r_void
)paren
(brace
id|sun4c_disable_vac
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ARCH_SUN4
)paren
(brace
r_switch
c_cond
(paren
id|idprom-&gt;id_machtype
)paren
(brace
r_case
(paren
id|SM_SUN4
op_or
id|SM_4_110
)paren
suffix:colon
id|sun4c_vacinfo.type
op_assign
id|NONE
suffix:semicolon
id|sun4c_vacinfo.num_bytes
op_assign
l_int|0
suffix:semicolon
id|sun4c_vacinfo.linesize
op_assign
l_int|0
suffix:semicolon
id|sun4c_vacinfo.do_hwflushes
op_assign
l_int|0
suffix:semicolon
id|prom_printf
c_func
(paren
l_string|&quot;No VAC. Get some bucks and buy a real computer.&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|SM_SUN4
op_or
id|SM_4_260
)paren
suffix:colon
id|sun4c_vacinfo.type
op_assign
id|WRITE_BACK
suffix:semicolon
id|sun4c_vacinfo.num_bytes
op_assign
l_int|128
op_star
l_int|1024
suffix:semicolon
id|sun4c_vacinfo.linesize
op_assign
l_int|16
suffix:semicolon
id|sun4c_vacinfo.do_hwflushes
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|SM_SUN4
op_or
id|SM_4_330
)paren
suffix:colon
id|sun4c_vacinfo.type
op_assign
id|WRITE_THROUGH
suffix:semicolon
id|sun4c_vacinfo.num_bytes
op_assign
l_int|128
op_star
l_int|1024
suffix:semicolon
id|sun4c_vacinfo.linesize
op_assign
l_int|16
suffix:semicolon
id|sun4c_vacinfo.do_hwflushes
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|SM_SUN4
op_or
id|SM_4_470
)paren
suffix:colon
id|sun4c_vacinfo.type
op_assign
id|WRITE_BACK
suffix:semicolon
id|sun4c_vacinfo.num_bytes
op_assign
l_int|128
op_star
l_int|1024
suffix:semicolon
id|sun4c_vacinfo.linesize
op_assign
l_int|32
suffix:semicolon
id|sun4c_vacinfo.do_hwflushes
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|prom_printf
c_func
(paren
l_string|&quot;Cannot initialize VAC - wierd sun4 model idprom-&gt;id_machtype = %d&quot;
comma
id|idprom-&gt;id_machtype
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
suffix:semicolon
)brace
r_else
(brace
id|sun4c_vacinfo.type
op_assign
id|WRITE_THROUGH
suffix:semicolon
r_if
c_cond
(paren
(paren
id|idprom-&gt;id_machtype
op_eq
(paren
id|SM_SUN4C
op_or
id|SM_4C_SS1
)paren
)paren
op_logical_or
(paren
id|idprom-&gt;id_machtype
op_eq
(paren
id|SM_SUN4C
op_or
id|SM_4C_SS1PLUS
)paren
)paren
)paren
(brace
multiline_comment|/* PROM on SS1 lacks this info, to be super safe we&n;&t;&t;&t; * hard code it here since this arch is cast in stone.&n;&t;&t;&t; */
id|sun4c_vacinfo.num_bytes
op_assign
l_int|65536
suffix:semicolon
id|sun4c_vacinfo.linesize
op_assign
l_int|16
suffix:semicolon
)brace
r_else
(brace
id|sun4c_vacinfo.num_bytes
op_assign
id|prom_getintdefault
c_func
(paren
id|prom_root_node
comma
l_string|&quot;vac-size&quot;
comma
l_int|65536
)paren
suffix:semicolon
id|sun4c_vacinfo.linesize
op_assign
id|prom_getintdefault
c_func
(paren
id|prom_root_node
comma
l_string|&quot;vac-linesize&quot;
comma
l_int|16
)paren
suffix:semicolon
)brace
id|sun4c_vacinfo.do_hwflushes
op_assign
id|prom_getintdefault
c_func
(paren
id|prom_root_node
comma
l_string|&quot;vac-hwflush&quot;
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sun4c_vacinfo.do_hwflushes
op_eq
l_int|0
)paren
id|sun4c_vacinfo.do_hwflushes
op_assign
id|prom_getintdefault
c_func
(paren
id|prom_root_node
comma
l_string|&quot;vac_hwflush&quot;
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sun4c_vacinfo.num_bytes
op_ne
l_int|65536
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;WEIRD Sun4C VAC cache size, tell davem&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
id|sun4c_vacinfo.num_lines
op_assign
(paren
id|sun4c_vacinfo.num_bytes
op_div
id|sun4c_vacinfo.linesize
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|sun4c_vacinfo.linesize
)paren
(brace
r_case
l_int|16
suffix:colon
id|sun4c_vacinfo.log2lsize
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|sun4c_vacinfo.log2lsize
op_assign
l_int|5
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|prom_printf
c_func
(paren
l_string|&quot;probe_vac: Didn&squot;t expect vac-linesize of %d, halting&bslash;n&quot;
comma
id|sun4c_vacinfo.linesize
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
suffix:semicolon
id|sun4c_flush_all
c_func
(paren
)paren
suffix:semicolon
id|sun4c_enable_vac
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Patch instructions for the low level kernel fault handler. */
r_extern
r_int
r_int
id|invalid_segment_patch1
comma
id|invalid_segment_patch1_ff
suffix:semicolon
r_extern
r_int
r_int
id|invalid_segment_patch2
comma
id|invalid_segment_patch2_ff
suffix:semicolon
r_extern
r_int
r_int
id|invalid_segment_patch1_1ff
comma
id|invalid_segment_patch2_1ff
suffix:semicolon
r_extern
r_int
r_int
id|num_context_patch1
comma
id|num_context_patch1_16
suffix:semicolon
r_extern
r_int
r_int
id|num_context_patch2
comma
id|num_context_patch2_16
suffix:semicolon
r_extern
r_int
r_int
id|vac_linesize_patch
comma
id|vac_linesize_patch_32
suffix:semicolon
r_extern
r_int
r_int
id|vac_hwflush_patch1
comma
id|vac_hwflush_patch1_on
suffix:semicolon
r_extern
r_int
r_int
id|vac_hwflush_patch2
comma
id|vac_hwflush_patch2_on
suffix:semicolon
DECL|macro|PATCH_INSN
mdefine_line|#define PATCH_INSN(src, dst) do {&t;&bslash;&n;&t;&t;daddr = &amp;(dst);&t;&t;&bslash;&n;&t;&t;iaddr = &amp;(src);&t;&t;&bslash;&n;&t;&t;*daddr = *iaddr;&t;&bslash;&n;&t;} while (0);
DECL|function|patch_kernel_fault_handler
r_static
r_void
id|patch_kernel_fault_handler
c_func
(paren
r_void
)paren
(brace
r_int
r_int
op_star
id|iaddr
comma
op_star
id|daddr
suffix:semicolon
r_switch
c_cond
(paren
id|num_segmaps
)paren
(brace
r_case
l_int|128
suffix:colon
multiline_comment|/* Default, nothing to do. */
r_break
suffix:semicolon
r_case
l_int|256
suffix:colon
id|PATCH_INSN
c_func
(paren
id|invalid_segment_patch1_ff
comma
id|invalid_segment_patch1
)paren
suffix:semicolon
id|PATCH_INSN
c_func
(paren
id|invalid_segment_patch2_ff
comma
id|invalid_segment_patch2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|512
suffix:colon
id|PATCH_INSN
c_func
(paren
id|invalid_segment_patch1_1ff
comma
id|invalid_segment_patch1
)paren
suffix:semicolon
id|PATCH_INSN
c_func
(paren
id|invalid_segment_patch2_1ff
comma
id|invalid_segment_patch2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|prom_printf
c_func
(paren
l_string|&quot;Unhandled number of segmaps: %d&bslash;n&quot;
comma
id|num_segmaps
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
suffix:semicolon
r_switch
c_cond
(paren
id|num_contexts
)paren
(brace
r_case
l_int|8
suffix:colon
multiline_comment|/* Default, nothing to do. */
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|PATCH_INSN
c_func
(paren
id|num_context_patch1_16
comma
id|num_context_patch1
)paren
suffix:semicolon
macro_line|#if 0
id|PATCH_INSN
c_func
(paren
id|num_context_patch2_16
comma
id|num_context_patch2
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_default
suffix:colon
id|prom_printf
c_func
(paren
l_string|&quot;Unhandled number of contexts: %d&bslash;n&quot;
comma
id|num_contexts
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
id|sun4c_vacinfo.do_hwflushes
op_ne
l_int|0
)paren
(brace
id|PATCH_INSN
c_func
(paren
id|vac_hwflush_patch1_on
comma
id|vac_hwflush_patch1
)paren
suffix:semicolon
id|PATCH_INSN
c_func
(paren
id|vac_hwflush_patch2_on
comma
id|vac_hwflush_patch2
)paren
suffix:semicolon
)brace
r_else
(brace
r_switch
c_cond
(paren
id|sun4c_vacinfo.linesize
)paren
(brace
r_case
l_int|16
suffix:colon
multiline_comment|/* Default, nothing to do. */
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|PATCH_INSN
c_func
(paren
id|vac_linesize_patch_32
comma
id|vac_linesize_patch
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|prom_printf
c_func
(paren
l_string|&quot;Impossible VAC linesize %d, halting...&bslash;n&quot;
comma
id|sun4c_vacinfo.linesize
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
suffix:semicolon
)brace
)brace
DECL|function|sun4c_probe_mmu
r_static
r_void
id|__init
id|sun4c_probe_mmu
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|ARCH_SUN4
)paren
(brace
r_switch
c_cond
(paren
id|idprom-&gt;id_machtype
)paren
(brace
r_case
(paren
id|SM_SUN4
op_or
id|SM_4_110
)paren
suffix:colon
id|prom_printf
c_func
(paren
l_string|&quot;No support for 4100 yet&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
id|num_segmaps
op_assign
l_int|256
suffix:semicolon
id|num_contexts
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|SM_SUN4
op_or
id|SM_4_260
)paren
suffix:colon
multiline_comment|/* should be 512 segmaps. when it get fixed */
id|num_segmaps
op_assign
l_int|256
suffix:semicolon
id|num_contexts
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|SM_SUN4
op_or
id|SM_4_330
)paren
suffix:colon
id|num_segmaps
op_assign
l_int|256
suffix:semicolon
id|num_contexts
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|SM_SUN4
op_or
id|SM_4_470
)paren
suffix:colon
multiline_comment|/* should be 1024 segmaps. when it get fixed */
id|num_segmaps
op_assign
l_int|256
suffix:semicolon
id|num_contexts
op_assign
l_int|64
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|prom_printf
c_func
(paren
l_string|&quot;Invalid SUN4 model&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|idprom-&gt;id_machtype
op_eq
(paren
id|SM_SUN4C
op_or
id|SM_4C_SS1
)paren
)paren
op_logical_or
(paren
id|idprom-&gt;id_machtype
op_eq
(paren
id|SM_SUN4C
op_or
id|SM_4C_SS1PLUS
)paren
)paren
)paren
(brace
multiline_comment|/* Hardcode these just to be safe, PROM on SS1 does&n;&t;&t; &t;* not have this info available in the root node.&n;&t;&t; &t;*/
id|num_segmaps
op_assign
l_int|128
suffix:semicolon
id|num_contexts
op_assign
l_int|8
suffix:semicolon
)brace
r_else
(brace
id|num_segmaps
op_assign
id|prom_getintdefault
c_func
(paren
id|prom_root_node
comma
l_string|&quot;mmu-npmg&quot;
comma
l_int|128
)paren
suffix:semicolon
id|num_contexts
op_assign
id|prom_getintdefault
c_func
(paren
id|prom_root_node
comma
l_string|&quot;mmu-nctx&quot;
comma
l_int|0x8
)paren
suffix:semicolon
)brace
)brace
id|patch_kernel_fault_handler
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|variable|sun4c_memerr_reg
r_volatile
r_int
r_int
op_star
id|sun4c_memerr_reg
op_assign
l_int|0
suffix:semicolon
DECL|function|sun4c_probe_memerr_reg
r_void
id|__init
id|sun4c_probe_memerr_reg
c_func
(paren
r_void
)paren
(brace
r_int
id|node
suffix:semicolon
r_struct
id|linux_prom_registers
id|regs
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ARCH_SUN4
)paren
(brace
id|sun4c_memerr_reg
op_assign
id|ioremap
c_func
(paren
id|sun4_memreg_physaddr
comma
id|PAGE_SIZE
)paren
suffix:semicolon
)brace
r_else
(brace
id|node
op_assign
id|prom_getchild
c_func
(paren
id|prom_root_node
)paren
suffix:semicolon
id|node
op_assign
id|prom_searchsiblings
c_func
(paren
id|prom_root_node
comma
l_string|&quot;memory-error&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
r_return
suffix:semicolon
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;reg&quot;
comma
(paren
r_char
op_star
)paren
id|regs
comma
r_sizeof
(paren
id|regs
)paren
)paren
suffix:semicolon
multiline_comment|/* hmm I think regs[0].which_io is zero here anyways */
id|sun4c_memerr_reg
op_assign
id|ioremap
c_func
(paren
id|regs
(braket
l_int|0
)braket
dot
id|phys_addr
comma
id|regs
(braket
l_int|0
)braket
dot
id|reg_size
)paren
suffix:semicolon
)brace
)brace
DECL|function|sun4c_init_ss2_cache_bug
r_static
r_inline
r_void
id|sun4c_init_ss2_cache_bug
c_func
(paren
r_void
)paren
(brace
r_extern
r_int
r_int
id|start
suffix:semicolon
r_if
c_cond
(paren
(paren
id|idprom-&gt;id_machtype
op_eq
(paren
id|SM_SUN4C
op_or
id|SM_4C_SS2
)paren
)paren
op_logical_or
(paren
id|idprom-&gt;id_machtype
op_eq
(paren
id|SM_SUN4C
op_or
id|SM_4C_IPX
)paren
)paren
op_logical_or
(paren
id|idprom-&gt;id_machtype
op_eq
(paren
id|SM_SUN4
op_or
id|SM_4_330
)paren
)paren
op_logical_or
(paren
id|idprom-&gt;id_machtype
op_eq
(paren
id|SM_SUN4C
op_or
id|SM_4C_ELC
)paren
)paren
)paren
(brace
multiline_comment|/* Whee.. */
id|printk
c_func
(paren
l_string|&quot;SS2 cache bug detected, uncaching trap table page&bslash;n&quot;
)paren
suffix:semicolon
id|sun4c_flush_page
c_func
(paren
(paren
r_int
r_int
)paren
op_amp
id|start
)paren
suffix:semicolon
id|sun4c_put_pte
c_func
(paren
(paren
(paren
r_int
r_int
)paren
op_amp
id|start
)paren
comma
(paren
id|sun4c_get_pte
c_func
(paren
(paren
r_int
r_int
)paren
op_amp
id|start
)paren
op_or
id|_SUN4C_PAGE_NOCACHE
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Addr is always aligned on a page boundry for us already. */
DECL|function|sun4c_map_dma_area
r_static
r_void
id|sun4c_map_dma_area
c_func
(paren
r_int
r_int
id|va
comma
id|u32
id|addr
comma
r_int
id|len
)paren
(brace
r_int
r_int
id|page
comma
id|end
suffix:semicolon
id|end
op_assign
id|PAGE_ALIGN
c_func
(paren
(paren
id|addr
op_plus
id|len
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|addr
OL
id|end
)paren
(brace
id|page
op_assign
id|va
suffix:semicolon
id|sun4c_flush_page
c_func
(paren
id|page
)paren
suffix:semicolon
id|page
op_sub_assign
id|PAGE_OFFSET
suffix:semicolon
id|page
op_rshift_assign
id|PAGE_SHIFT
suffix:semicolon
id|page
op_or_assign
(paren
id|_SUN4C_PAGE_VALID
op_or
id|_SUN4C_PAGE_DIRTY
op_or
id|_SUN4C_PAGE_NOCACHE
op_or
id|_SUN4C_PAGE_PRIV
)paren
suffix:semicolon
id|sun4c_put_pte
c_func
(paren
id|addr
comma
id|page
)paren
suffix:semicolon
id|addr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|va
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
)brace
DECL|function|sun4c_translate_dvma
r_static
r_int
r_int
id|sun4c_translate_dvma
c_func
(paren
r_int
r_int
id|busa
)paren
(brace
multiline_comment|/* Fortunately for us, bus_addr == uncached_virt in sun4c. */
r_int
r_int
id|pte
op_assign
id|sun4c_get_pte
c_func
(paren
id|busa
)paren
suffix:semicolon
r_return
(paren
id|pte
op_lshift
id|PAGE_SHIFT
)paren
op_plus
id|PAGE_OFFSET
suffix:semicolon
)brace
DECL|function|sun4c_unmap_dma_area
r_static
r_void
id|sun4c_unmap_dma_area
c_func
(paren
r_int
r_int
id|busa
comma
r_int
id|len
)paren
(brace
multiline_comment|/* Fortunately for us, bus_addr == uncached_virt in sun4c. */
multiline_comment|/* XXX Implement this */
)brace
multiline_comment|/* TLB management. */
multiline_comment|/* Don&squot;t change this struct without changing entry.S. This is used&n; * in the in-window kernel fault handler, and you don&squot;t want to mess&n; * with that. (See sun4c_fault in entry.S).&n; */
DECL|struct|sun4c_mmu_entry
r_struct
id|sun4c_mmu_entry
(brace
DECL|member|next
r_struct
id|sun4c_mmu_entry
op_star
id|next
suffix:semicolon
DECL|member|prev
r_struct
id|sun4c_mmu_entry
op_star
id|prev
suffix:semicolon
DECL|member|vaddr
r_int
r_int
id|vaddr
suffix:semicolon
DECL|member|pseg
r_int
r_char
id|pseg
suffix:semicolon
DECL|member|locked
r_int
r_char
id|locked
suffix:semicolon
multiline_comment|/* For user mappings only, and completely hidden from kernel&n;&t; * TLB miss code.&n;&t; */
DECL|member|ctx
r_int
r_char
id|ctx
suffix:semicolon
DECL|member|lru_next
r_struct
id|sun4c_mmu_entry
op_star
id|lru_next
suffix:semicolon
DECL|member|lru_prev
r_struct
id|sun4c_mmu_entry
op_star
id|lru_prev
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|mmu_entry_pool
r_static
r_struct
id|sun4c_mmu_entry
id|mmu_entry_pool
(braket
id|SUN4C_MAX_SEGMAPS
)braket
suffix:semicolon
DECL|function|sun4c_init_mmu_entry_pool
r_static
r_void
id|__init
id|sun4c_init_mmu_entry_pool
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SUN4C_MAX_SEGMAPS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mmu_entry_pool
(braket
id|i
)braket
dot
id|pseg
op_assign
id|i
suffix:semicolon
id|mmu_entry_pool
(braket
id|i
)braket
dot
id|next
op_assign
l_int|0
suffix:semicolon
id|mmu_entry_pool
(braket
id|i
)braket
dot
id|prev
op_assign
l_int|0
suffix:semicolon
id|mmu_entry_pool
(braket
id|i
)braket
dot
id|vaddr
op_assign
l_int|0
suffix:semicolon
id|mmu_entry_pool
(braket
id|i
)braket
dot
id|locked
op_assign
l_int|0
suffix:semicolon
id|mmu_entry_pool
(braket
id|i
)braket
dot
id|ctx
op_assign
l_int|0
suffix:semicolon
id|mmu_entry_pool
(braket
id|i
)braket
dot
id|lru_next
op_assign
l_int|0
suffix:semicolon
id|mmu_entry_pool
(braket
id|i
)braket
dot
id|lru_prev
op_assign
l_int|0
suffix:semicolon
)brace
id|mmu_entry_pool
(braket
id|invalid_segment
)braket
dot
id|locked
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|fix_permissions
r_static
r_inline
r_void
id|fix_permissions
c_func
(paren
r_int
r_int
id|vaddr
comma
r_int
r_int
id|bits_on
comma
r_int
r_int
id|bits_off
)paren
(brace
r_int
r_int
id|start
comma
id|end
suffix:semicolon
id|end
op_assign
id|vaddr
op_plus
id|SUN4C_REAL_PGDIR_SIZE
suffix:semicolon
r_for
c_loop
(paren
id|start
op_assign
id|vaddr
suffix:semicolon
id|start
OL
id|end
suffix:semicolon
id|start
op_add_assign
id|PAGE_SIZE
)paren
r_if
c_cond
(paren
id|sun4c_get_pte
c_func
(paren
id|start
)paren
op_amp
id|_SUN4C_PAGE_VALID
)paren
id|sun4c_put_pte
c_func
(paren
id|start
comma
(paren
id|sun4c_get_pte
c_func
(paren
id|start
)paren
op_or
id|bits_on
)paren
op_amp
op_complement
id|bits_off
)paren
suffix:semicolon
)brace
DECL|function|sun4c_init_map_kernelprom
r_static
r_inline
r_void
id|sun4c_init_map_kernelprom
c_func
(paren
r_int
r_int
id|kernel_end
)paren
(brace
r_int
r_int
id|vaddr
suffix:semicolon
r_int
r_char
id|pseg
comma
id|ctx
suffix:semicolon
macro_line|#ifdef CONFIG_SUN4
multiline_comment|/* sun4/110 and 260 have no kadb. */
r_if
c_cond
(paren
(paren
id|idprom-&gt;id_machtype
op_ne
(paren
id|SM_SUN4
op_or
id|SM_4_260
)paren
)paren
op_logical_and
(paren
id|idprom-&gt;id_machtype
op_ne
(paren
id|SM_SUN4
op_or
id|SM_4_110
)paren
)paren
)paren
(brace
macro_line|#endif
r_for
c_loop
(paren
id|vaddr
op_assign
id|KADB_DEBUGGER_BEGVM
suffix:semicolon
id|vaddr
OL
id|LINUX_OPPROM_ENDVM
suffix:semicolon
id|vaddr
op_add_assign
id|SUN4C_REAL_PGDIR_SIZE
)paren
(brace
id|pseg
op_assign
id|sun4c_get_segmap
c_func
(paren
id|vaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pseg
op_ne
id|invalid_segment
)paren
(brace
id|mmu_entry_pool
(braket
id|pseg
)braket
dot
id|locked
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|ctx
op_assign
l_int|0
suffix:semicolon
id|ctx
OL
id|num_contexts
suffix:semicolon
id|ctx
op_increment
)paren
id|prom_putsegment
c_func
(paren
id|ctx
comma
id|vaddr
comma
id|pseg
)paren
suffix:semicolon
id|fix_permissions
c_func
(paren
id|vaddr
comma
id|_SUN4C_PAGE_PRIV
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef CONFIG_SUN4
)brace
macro_line|#endif
r_for
c_loop
(paren
id|vaddr
op_assign
id|KERNBASE
suffix:semicolon
id|vaddr
OL
id|kernel_end
suffix:semicolon
id|vaddr
op_add_assign
id|SUN4C_REAL_PGDIR_SIZE
)paren
(brace
id|pseg
op_assign
id|sun4c_get_segmap
c_func
(paren
id|vaddr
)paren
suffix:semicolon
id|mmu_entry_pool
(braket
id|pseg
)braket
dot
id|locked
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|ctx
op_assign
l_int|0
suffix:semicolon
id|ctx
OL
id|num_contexts
suffix:semicolon
id|ctx
op_increment
)paren
id|prom_putsegment
c_func
(paren
id|ctx
comma
id|vaddr
comma
id|pseg
)paren
suffix:semicolon
id|fix_permissions
c_func
(paren
id|vaddr
comma
id|_SUN4C_PAGE_PRIV
comma
id|_SUN4C_PAGE_NOCACHE
)paren
suffix:semicolon
)brace
)brace
DECL|function|sun4c_init_lock_area
r_static
r_void
id|__init
id|sun4c_init_lock_area
c_func
(paren
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
r_int
id|i
comma
id|ctx
suffix:semicolon
r_while
c_loop
(paren
id|start
OL
id|end
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|invalid_segment
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|mmu_entry_pool
(braket
id|i
)braket
dot
id|locked
)paren
r_break
suffix:semicolon
id|mmu_entry_pool
(braket
id|i
)braket
dot
id|locked
op_assign
l_int|1
suffix:semicolon
id|sun4c_init_clean_segmap
c_func
(paren
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ctx
op_assign
l_int|0
suffix:semicolon
id|ctx
OL
id|num_contexts
suffix:semicolon
id|ctx
op_increment
)paren
id|prom_putsegment
c_func
(paren
id|ctx
comma
id|start
comma
id|mmu_entry_pool
(braket
id|i
)braket
dot
id|pseg
)paren
suffix:semicolon
id|start
op_add_assign
id|SUN4C_REAL_PGDIR_SIZE
suffix:semicolon
)brace
)brace
multiline_comment|/* Don&squot;t change this struct without changing entry.S. This is used&n; * in the in-window kernel fault handler, and you don&squot;t want to mess&n; * with that. (See sun4c_fault in entry.S).&n; */
DECL|struct|sun4c_mmu_ring
r_struct
id|sun4c_mmu_ring
(brace
DECL|member|ringhd
r_struct
id|sun4c_mmu_entry
id|ringhd
suffix:semicolon
DECL|member|num_entries
r_int
id|num_entries
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|sun4c_context_ring
r_static
r_struct
id|sun4c_mmu_ring
id|sun4c_context_ring
(braket
id|SUN4C_MAX_CONTEXTS
)braket
suffix:semicolon
multiline_comment|/* used user entries */
DECL|variable|sun4c_ufree_ring
r_static
r_struct
id|sun4c_mmu_ring
id|sun4c_ufree_ring
suffix:semicolon
multiline_comment|/* free user entries */
DECL|variable|sun4c_ulru_ring
r_static
r_struct
id|sun4c_mmu_ring
id|sun4c_ulru_ring
suffix:semicolon
multiline_comment|/* LRU user entries */
DECL|variable|sun4c_kernel_ring
r_struct
id|sun4c_mmu_ring
id|sun4c_kernel_ring
suffix:semicolon
multiline_comment|/* used kernel entries */
DECL|variable|sun4c_kfree_ring
r_struct
id|sun4c_mmu_ring
id|sun4c_kfree_ring
suffix:semicolon
multiline_comment|/* free kernel entries */
DECL|function|sun4c_init_rings
r_static
r_inline
r_void
id|sun4c_init_rings
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SUN4C_MAX_CONTEXTS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sun4c_context_ring
(braket
id|i
)braket
dot
id|ringhd.next
op_assign
id|sun4c_context_ring
(braket
id|i
)braket
dot
id|ringhd.prev
op_assign
op_amp
id|sun4c_context_ring
(braket
id|i
)braket
dot
id|ringhd
suffix:semicolon
id|sun4c_context_ring
(braket
id|i
)braket
dot
id|num_entries
op_assign
l_int|0
suffix:semicolon
)brace
id|sun4c_ufree_ring.ringhd.next
op_assign
id|sun4c_ufree_ring.ringhd.prev
op_assign
op_amp
id|sun4c_ufree_ring.ringhd
suffix:semicolon
id|sun4c_ufree_ring.num_entries
op_assign
l_int|0
suffix:semicolon
id|sun4c_ulru_ring.ringhd.lru_next
op_assign
id|sun4c_ulru_ring.ringhd.lru_prev
op_assign
op_amp
id|sun4c_ulru_ring.ringhd
suffix:semicolon
id|sun4c_ulru_ring.num_entries
op_assign
l_int|0
suffix:semicolon
id|sun4c_kernel_ring.ringhd.next
op_assign
id|sun4c_kernel_ring.ringhd.prev
op_assign
op_amp
id|sun4c_kernel_ring.ringhd
suffix:semicolon
id|sun4c_kernel_ring.num_entries
op_assign
l_int|0
suffix:semicolon
id|sun4c_kfree_ring.ringhd.next
op_assign
id|sun4c_kfree_ring.ringhd.prev
op_assign
op_amp
id|sun4c_kfree_ring.ringhd
suffix:semicolon
id|sun4c_kfree_ring.num_entries
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|add_ring
r_static
r_void
id|add_ring
c_func
(paren
r_struct
id|sun4c_mmu_ring
op_star
id|ring
comma
r_struct
id|sun4c_mmu_entry
op_star
id|entry
)paren
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|head
op_assign
op_amp
id|ring-&gt;ringhd
suffix:semicolon
id|entry-&gt;prev
op_assign
id|head
suffix:semicolon
(paren
id|entry-&gt;next
op_assign
id|head-&gt;next
)paren
op_member_access_from_pointer
id|prev
op_assign
id|entry
suffix:semicolon
id|head-&gt;next
op_assign
id|entry
suffix:semicolon
id|ring-&gt;num_entries
op_increment
suffix:semicolon
)brace
DECL|function|add_lru
r_static
id|__inline__
r_void
id|add_lru
c_func
(paren
r_struct
id|sun4c_mmu_entry
op_star
id|entry
)paren
(brace
r_struct
id|sun4c_mmu_ring
op_star
id|ring
op_assign
op_amp
id|sun4c_ulru_ring
suffix:semicolon
r_struct
id|sun4c_mmu_entry
op_star
id|head
op_assign
op_amp
id|ring-&gt;ringhd
suffix:semicolon
id|entry-&gt;lru_next
op_assign
id|head
suffix:semicolon
(paren
id|entry-&gt;lru_prev
op_assign
id|head-&gt;lru_prev
)paren
op_member_access_from_pointer
id|lru_next
op_assign
id|entry
suffix:semicolon
id|head-&gt;lru_prev
op_assign
id|entry
suffix:semicolon
)brace
DECL|function|add_ring_ordered
r_static
r_void
id|add_ring_ordered
c_func
(paren
r_struct
id|sun4c_mmu_ring
op_star
id|ring
comma
r_struct
id|sun4c_mmu_entry
op_star
id|entry
)paren
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|head
op_assign
op_amp
id|ring-&gt;ringhd
suffix:semicolon
r_int
r_int
id|addr
op_assign
id|entry-&gt;vaddr
suffix:semicolon
r_while
c_loop
(paren
(paren
id|head-&gt;next
op_ne
op_amp
id|ring-&gt;ringhd
)paren
op_logical_and
(paren
id|head-&gt;next-&gt;vaddr
OL
id|addr
)paren
)paren
id|head
op_assign
id|head-&gt;next
suffix:semicolon
id|entry-&gt;prev
op_assign
id|head
suffix:semicolon
(paren
id|entry-&gt;next
op_assign
id|head-&gt;next
)paren
op_member_access_from_pointer
id|prev
op_assign
id|entry
suffix:semicolon
id|head-&gt;next
op_assign
id|entry
suffix:semicolon
id|ring-&gt;num_entries
op_increment
suffix:semicolon
id|add_lru
c_func
(paren
id|entry
)paren
suffix:semicolon
)brace
DECL|function|remove_ring
r_static
id|__inline__
r_void
id|remove_ring
c_func
(paren
r_struct
id|sun4c_mmu_ring
op_star
id|ring
comma
r_struct
id|sun4c_mmu_entry
op_star
id|entry
)paren
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|next
op_assign
id|entry-&gt;next
suffix:semicolon
(paren
id|next-&gt;prev
op_assign
id|entry-&gt;prev
)paren
op_member_access_from_pointer
id|next
op_assign
id|next
suffix:semicolon
id|ring-&gt;num_entries
op_decrement
suffix:semicolon
)brace
DECL|function|remove_lru
r_static
r_void
id|remove_lru
c_func
(paren
r_struct
id|sun4c_mmu_entry
op_star
id|entry
)paren
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|next
op_assign
id|entry-&gt;lru_next
suffix:semicolon
(paren
id|next-&gt;lru_prev
op_assign
id|entry-&gt;lru_prev
)paren
op_member_access_from_pointer
id|lru_next
op_assign
id|next
suffix:semicolon
)brace
DECL|function|free_user_entry
r_static
r_void
id|free_user_entry
c_func
(paren
r_int
id|ctx
comma
r_struct
id|sun4c_mmu_entry
op_star
id|entry
)paren
(brace
id|remove_ring
c_func
(paren
id|sun4c_context_ring
op_plus
id|ctx
comma
id|entry
)paren
suffix:semicolon
id|remove_lru
c_func
(paren
id|entry
)paren
suffix:semicolon
id|add_ring
c_func
(paren
op_amp
id|sun4c_ufree_ring
comma
id|entry
)paren
suffix:semicolon
)brace
DECL|function|free_kernel_entry
r_static
r_void
id|free_kernel_entry
c_func
(paren
r_struct
id|sun4c_mmu_entry
op_star
id|entry
comma
r_struct
id|sun4c_mmu_ring
op_star
id|ring
)paren
(brace
id|remove_ring
c_func
(paren
id|ring
comma
id|entry
)paren
suffix:semicolon
id|add_ring
c_func
(paren
op_amp
id|sun4c_kfree_ring
comma
id|entry
)paren
suffix:semicolon
)brace
DECL|function|sun4c_init_fill_kernel_ring
r_static
r_void
id|__init
id|sun4c_init_fill_kernel_ring
c_func
(paren
r_int
id|howmany
)paren
(brace
r_int
id|i
suffix:semicolon
r_while
c_loop
(paren
id|howmany
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|invalid_segment
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|mmu_entry_pool
(braket
id|i
)braket
dot
id|locked
)paren
r_break
suffix:semicolon
id|mmu_entry_pool
(braket
id|i
)braket
dot
id|locked
op_assign
l_int|1
suffix:semicolon
id|sun4c_init_clean_segmap
c_func
(paren
id|i
)paren
suffix:semicolon
id|add_ring
c_func
(paren
op_amp
id|sun4c_kfree_ring
comma
op_amp
id|mmu_entry_pool
(braket
id|i
)braket
)paren
suffix:semicolon
id|howmany
op_decrement
suffix:semicolon
)brace
)brace
DECL|function|sun4c_init_fill_user_ring
r_static
r_void
id|__init
id|sun4c_init_fill_user_ring
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|invalid_segment
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|mmu_entry_pool
(braket
id|i
)braket
dot
id|locked
)paren
r_continue
suffix:semicolon
id|sun4c_init_clean_segmap
c_func
(paren
id|i
)paren
suffix:semicolon
id|add_ring
c_func
(paren
op_amp
id|sun4c_ufree_ring
comma
op_amp
id|mmu_entry_pool
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
DECL|function|sun4c_kernel_unmap
r_static
r_void
id|sun4c_kernel_unmap
c_func
(paren
r_struct
id|sun4c_mmu_entry
op_star
id|kentry
)paren
(brace
r_int
id|savectx
comma
id|ctx
suffix:semicolon
id|savectx
op_assign
id|sun4c_get_context
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ctx
op_assign
l_int|0
suffix:semicolon
id|ctx
OL
id|num_contexts
suffix:semicolon
id|ctx
op_increment
)paren
(brace
id|sun4c_set_context
c_func
(paren
id|ctx
)paren
suffix:semicolon
id|sun4c_put_segmap
c_func
(paren
id|kentry-&gt;vaddr
comma
id|invalid_segment
)paren
suffix:semicolon
)brace
id|sun4c_set_context
c_func
(paren
id|savectx
)paren
suffix:semicolon
)brace
DECL|function|sun4c_kernel_map
r_static
r_void
id|sun4c_kernel_map
c_func
(paren
r_struct
id|sun4c_mmu_entry
op_star
id|kentry
)paren
(brace
r_int
id|savectx
comma
id|ctx
suffix:semicolon
id|savectx
op_assign
id|sun4c_get_context
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ctx
op_assign
l_int|0
suffix:semicolon
id|ctx
OL
id|num_contexts
suffix:semicolon
id|ctx
op_increment
)paren
(brace
id|sun4c_set_context
c_func
(paren
id|ctx
)paren
suffix:semicolon
id|sun4c_put_segmap
c_func
(paren
id|kentry-&gt;vaddr
comma
id|kentry-&gt;pseg
)paren
suffix:semicolon
)brace
id|sun4c_set_context
c_func
(paren
id|savectx
)paren
suffix:semicolon
)brace
DECL|macro|sun4c_user_unmap
mdefine_line|#define sun4c_user_unmap(__entry) &bslash;&n;&t;sun4c_put_segmap((__entry)-&gt;vaddr, invalid_segment)
DECL|function|sun4c_demap_context_hw
r_static
r_void
id|sun4c_demap_context_hw
c_func
(paren
r_struct
id|sun4c_mmu_ring
op_star
id|crp
comma
r_int
r_char
id|ctx
)paren
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|head
op_assign
op_amp
id|crp-&gt;ringhd
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|head-&gt;next
op_ne
id|head
)paren
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|entry
op_assign
id|head-&gt;next
suffix:semicolon
r_int
id|savectx
op_assign
id|sun4c_get_context
c_func
(paren
)paren
suffix:semicolon
id|flush_user_windows
c_func
(paren
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
id|ctx
)paren
suffix:semicolon
id|sun4c_flush_context_hw
c_func
(paren
)paren
suffix:semicolon
r_do
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|next
op_assign
id|entry-&gt;next
suffix:semicolon
id|sun4c_user_unmap
c_func
(paren
id|entry
)paren
suffix:semicolon
id|free_user_entry
c_func
(paren
id|ctx
comma
id|entry
)paren
suffix:semicolon
id|entry
op_assign
id|next
suffix:semicolon
)brace
r_while
c_loop
(paren
id|entry
op_ne
id|head
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
id|savectx
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|sun4c_demap_context_sw
r_static
r_void
id|sun4c_demap_context_sw
c_func
(paren
r_struct
id|sun4c_mmu_ring
op_star
id|crp
comma
r_int
r_char
id|ctx
)paren
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|head
op_assign
op_amp
id|crp-&gt;ringhd
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|head-&gt;next
op_ne
id|head
)paren
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|entry
op_assign
id|head-&gt;next
suffix:semicolon
r_int
id|savectx
op_assign
id|sun4c_get_context
c_func
(paren
)paren
suffix:semicolon
id|flush_user_windows
c_func
(paren
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
id|ctx
)paren
suffix:semicolon
id|sun4c_flush_context_sw
c_func
(paren
)paren
suffix:semicolon
r_do
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|next
op_assign
id|entry-&gt;next
suffix:semicolon
id|sun4c_user_unmap
c_func
(paren
id|entry
)paren
suffix:semicolon
id|free_user_entry
c_func
(paren
id|ctx
comma
id|entry
)paren
suffix:semicolon
id|entry
op_assign
id|next
suffix:semicolon
)brace
r_while
c_loop
(paren
id|entry
op_ne
id|head
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
id|savectx
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|variable|sun4c_user_taken_entries
r_static
r_int
id|sun4c_user_taken_entries
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* This is how much we have.             */
DECL|variable|max_user_taken_entries
r_static
r_int
id|max_user_taken_entries
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* This limits us and prevents deadlock. */
DECL|function|sun4c_kernel_strategy
r_static
r_struct
id|sun4c_mmu_entry
op_star
id|sun4c_kernel_strategy
c_func
(paren
r_void
)paren
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|this_entry
suffix:semicolon
multiline_comment|/* If some are free, return first one. */
r_if
c_cond
(paren
id|sun4c_kfree_ring.num_entries
)paren
(brace
id|this_entry
op_assign
id|sun4c_kfree_ring.ringhd.next
suffix:semicolon
r_return
id|this_entry
suffix:semicolon
)brace
multiline_comment|/* Else free one up. */
id|this_entry
op_assign
id|sun4c_kernel_ring.ringhd.prev
suffix:semicolon
r_if
c_cond
(paren
id|sun4c_vacinfo.do_hwflushes
)paren
id|sun4c_flush_segment_hw
c_func
(paren
id|this_entry-&gt;vaddr
)paren
suffix:semicolon
r_else
id|sun4c_flush_segment_sw
c_func
(paren
id|this_entry-&gt;vaddr
)paren
suffix:semicolon
id|sun4c_kernel_unmap
c_func
(paren
id|this_entry
)paren
suffix:semicolon
id|free_kernel_entry
c_func
(paren
id|this_entry
comma
op_amp
id|sun4c_kernel_ring
)paren
suffix:semicolon
id|this_entry
op_assign
id|sun4c_kfree_ring.ringhd.next
suffix:semicolon
r_return
id|this_entry
suffix:semicolon
)brace
multiline_comment|/* Using this method to free up mmu entries eliminates a lot of&n; * potential races since we have a kernel that incurs tlb&n; * replacement faults.  There may be performance penalties.&n; *&n; * NOTE: Must be called with interrupts disabled.&n; */
DECL|function|sun4c_user_strategy
r_static
r_struct
id|sun4c_mmu_entry
op_star
id|sun4c_user_strategy
c_func
(paren
r_void
)paren
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|entry
suffix:semicolon
r_int
r_char
id|ctx
suffix:semicolon
r_int
id|savectx
suffix:semicolon
multiline_comment|/* If some are free, return first one. */
r_if
c_cond
(paren
id|sun4c_ufree_ring.num_entries
)paren
(brace
id|entry
op_assign
id|sun4c_ufree_ring.ringhd.next
suffix:semicolon
r_goto
id|unlink_out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sun4c_user_taken_entries
)paren
(brace
id|entry
op_assign
id|sun4c_kernel_strategy
c_func
(paren
)paren
suffix:semicolon
id|sun4c_user_taken_entries
op_decrement
suffix:semicolon
r_goto
id|kunlink_out
suffix:semicolon
)brace
multiline_comment|/* Grab from the beginning of the LRU list. */
id|entry
op_assign
id|sun4c_ulru_ring.ringhd.lru_next
suffix:semicolon
id|ctx
op_assign
id|entry-&gt;ctx
suffix:semicolon
id|savectx
op_assign
id|sun4c_get_context
c_func
(paren
)paren
suffix:semicolon
id|flush_user_windows
c_func
(paren
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
id|ctx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sun4c_vacinfo.do_hwflushes
)paren
id|sun4c_flush_segment_hw
c_func
(paren
id|entry-&gt;vaddr
)paren
suffix:semicolon
r_else
id|sun4c_flush_segment_sw
c_func
(paren
id|entry-&gt;vaddr
)paren
suffix:semicolon
id|sun4c_user_unmap
c_func
(paren
id|entry
)paren
suffix:semicolon
id|remove_ring
c_func
(paren
id|sun4c_context_ring
op_plus
id|ctx
comma
id|entry
)paren
suffix:semicolon
id|remove_lru
c_func
(paren
id|entry
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
id|savectx
)paren
suffix:semicolon
r_return
id|entry
suffix:semicolon
id|unlink_out
suffix:colon
id|remove_ring
c_func
(paren
op_amp
id|sun4c_ufree_ring
comma
id|entry
)paren
suffix:semicolon
r_return
id|entry
suffix:semicolon
id|kunlink_out
suffix:colon
id|remove_ring
c_func
(paren
op_amp
id|sun4c_kfree_ring
comma
id|entry
)paren
suffix:semicolon
r_return
id|entry
suffix:semicolon
)brace
multiline_comment|/* NOTE: Must be called with interrupts disabled. */
DECL|function|sun4c_grow_kernel_ring
r_void
id|sun4c_grow_kernel_ring
c_func
(paren
r_void
)paren
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|entry
suffix:semicolon
multiline_comment|/* Prevent deadlock condition. */
r_if
c_cond
(paren
id|sun4c_user_taken_entries
op_ge
id|max_user_taken_entries
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|sun4c_ufree_ring.num_entries
)paren
(brace
id|entry
op_assign
id|sun4c_ufree_ring.ringhd.next
suffix:semicolon
id|remove_ring
c_func
(paren
op_amp
id|sun4c_ufree_ring
comma
id|entry
)paren
suffix:semicolon
id|add_ring
c_func
(paren
op_amp
id|sun4c_kfree_ring
comma
id|entry
)paren
suffix:semicolon
id|sun4c_user_taken_entries
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* 2 page buckets for task struct and kernel stack allocation.&n; *&n; * TASK_STACK_BEGIN&n; * bucket[0]&n; * bucket[1]&n; *   [ ... ]&n; * bucket[NR_TASK_BUCKETS-1]&n; * TASK_STACK_BEGIN + (sizeof(struct task_bucket) * NR_TASK_BUCKETS)&n; *&n; * Each slot looks like:&n; *&n; *  page 1 --  task struct + beginning of kernel stack&n; *  page 2 --  rest of kernel stack&n; */
DECL|variable|sun4c_bucket
r_union
id|task_union
op_star
id|sun4c_bucket
(braket
id|NR_TASK_BUCKETS
)braket
suffix:semicolon
DECL|variable|sun4c_lowbucket_avail
r_static
r_int
id|sun4c_lowbucket_avail
suffix:semicolon
DECL|macro|BUCKET_EMPTY
mdefine_line|#define BUCKET_EMPTY     ((union task_union *) 0)
DECL|macro|BUCKET_SHIFT
mdefine_line|#define BUCKET_SHIFT     (PAGE_SHIFT + 1)        /* log2(sizeof(struct task_bucket)) */
DECL|macro|BUCKET_SIZE
mdefine_line|#define BUCKET_SIZE      (1 &lt;&lt; BUCKET_SHIFT)
DECL|macro|BUCKET_NUM
mdefine_line|#define BUCKET_NUM(addr) ((((addr) - SUN4C_LOCK_VADDR) &gt;&gt; BUCKET_SHIFT))
DECL|macro|BUCKET_ADDR
mdefine_line|#define BUCKET_ADDR(num) (((num) &lt;&lt; BUCKET_SHIFT) + SUN4C_LOCK_VADDR)
DECL|macro|BUCKET_PTE
mdefine_line|#define BUCKET_PTE(page)       &bslash;&n;        ((((page) - PAGE_OFFSET) &gt;&gt; PAGE_SHIFT) | pgprot_val(SUN4C_PAGE_KERNEL))
DECL|macro|BUCKET_PTE_PAGE
mdefine_line|#define BUCKET_PTE_PAGE(pte)   &bslash;&n;        (PAGE_OFFSET + (((pte) &amp; SUN4C_PFN_MASK) &lt;&lt; PAGE_SHIFT))
DECL|function|get_locked_segment
r_static
r_void
id|get_locked_segment
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|stolen
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|addr
op_and_assign
id|SUN4C_REAL_PGDIR_MASK
suffix:semicolon
id|stolen
op_assign
id|sun4c_user_strategy
c_func
(paren
)paren
suffix:semicolon
id|max_user_taken_entries
op_decrement
suffix:semicolon
id|stolen-&gt;vaddr
op_assign
id|addr
suffix:semicolon
id|flush_user_windows
c_func
(paren
)paren
suffix:semicolon
id|sun4c_kernel_map
c_func
(paren
id|stolen
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|free_locked_segment
r_static
r_void
id|free_locked_segment
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|entry
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|pseg
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|addr
op_and_assign
id|SUN4C_REAL_PGDIR_MASK
suffix:semicolon
id|pseg
op_assign
id|sun4c_get_segmap
c_func
(paren
id|addr
)paren
suffix:semicolon
id|entry
op_assign
op_amp
id|mmu_entry_pool
(braket
id|pseg
)braket
suffix:semicolon
id|flush_user_windows
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sun4c_vacinfo.do_hwflushes
)paren
id|sun4c_flush_segment_hw
c_func
(paren
id|addr
)paren
suffix:semicolon
r_else
id|sun4c_flush_segment_sw
c_func
(paren
id|addr
)paren
suffix:semicolon
id|sun4c_kernel_unmap
c_func
(paren
id|entry
)paren
suffix:semicolon
id|add_ring
c_func
(paren
op_amp
id|sun4c_ufree_ring
comma
id|entry
)paren
suffix:semicolon
id|max_user_taken_entries
op_increment
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|garbage_collect
r_static
r_inline
r_void
id|garbage_collect
c_func
(paren
r_int
id|entry
)paren
(brace
r_int
id|start
comma
id|end
suffix:semicolon
multiline_comment|/* 32 buckets per segment... */
id|entry
op_and_assign
op_complement
l_int|31
suffix:semicolon
id|start
op_assign
id|entry
suffix:semicolon
r_for
c_loop
(paren
id|end
op_assign
(paren
id|start
op_plus
l_int|32
)paren
suffix:semicolon
id|start
OL
id|end
suffix:semicolon
id|start
op_increment
)paren
r_if
c_cond
(paren
id|sun4c_bucket
(braket
id|start
)braket
op_ne
id|BUCKET_EMPTY
)paren
r_return
suffix:semicolon
multiline_comment|/* Entire segment empty, release it. */
id|free_locked_segment
c_func
(paren
id|BUCKET_ADDR
c_func
(paren
id|entry
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SUN4
DECL|macro|TASK_STRUCT_ORDER
mdefine_line|#define TASK_STRUCT_ORDER&t;0
macro_line|#else
DECL|macro|TASK_STRUCT_ORDER
mdefine_line|#define TASK_STRUCT_ORDER&t;1
macro_line|#endif
DECL|function|sun4c_alloc_task_struct
r_static
r_struct
id|task_struct
op_star
id|sun4c_alloc_task_struct
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|addr
comma
id|pages
suffix:semicolon
r_int
id|entry
suffix:semicolon
id|pages
op_assign
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
comma
id|TASK_STRUCT_ORDER
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pages
)paren
r_return
(paren
r_struct
id|task_struct
op_star
)paren
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|entry
op_assign
id|sun4c_lowbucket_avail
suffix:semicolon
id|entry
OL
id|NR_TASK_BUCKETS
suffix:semicolon
id|entry
op_increment
)paren
r_if
c_cond
(paren
id|sun4c_bucket
(braket
id|entry
)braket
op_eq
id|BUCKET_EMPTY
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|entry
op_eq
id|NR_TASK_BUCKETS
)paren
(brace
id|free_pages
c_func
(paren
id|pages
comma
id|TASK_STRUCT_ORDER
)paren
suffix:semicolon
r_return
(paren
r_struct
id|task_struct
op_star
)paren
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|entry
op_ge
id|sun4c_lowbucket_avail
)paren
id|sun4c_lowbucket_avail
op_assign
id|entry
op_plus
l_int|1
suffix:semicolon
id|addr
op_assign
id|BUCKET_ADDR
c_func
(paren
id|entry
)paren
suffix:semicolon
id|sun4c_bucket
(braket
id|entry
)braket
op_assign
(paren
r_union
id|task_union
op_star
)paren
id|addr
suffix:semicolon
r_if
c_cond
(paren
id|sun4c_get_segmap
c_func
(paren
id|addr
)paren
op_eq
id|invalid_segment
)paren
(brace
id|get_locked_segment
c_func
(paren
id|addr
)paren
suffix:semicolon
)brace
multiline_comment|/* We are changing the virtual color of the page(s)&n;&t; * so we must flush the cache to guarentee consistancy.&n;&t; */
r_if
c_cond
(paren
id|sun4c_vacinfo.do_hwflushes
)paren
(brace
id|sun4c_flush_page_hw
c_func
(paren
id|pages
)paren
suffix:semicolon
macro_line|#ifndef CONFIG_SUN4&t;
id|sun4c_flush_page_hw
c_func
(paren
id|pages
op_plus
id|PAGE_SIZE
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|sun4c_flush_page_sw
c_func
(paren
id|pages
)paren
suffix:semicolon
macro_line|#ifndef CONFIG_SUN4&t;
id|sun4c_flush_page_sw
c_func
(paren
id|pages
op_plus
id|PAGE_SIZE
)paren
suffix:semicolon
macro_line|#endif
)brace
id|sun4c_put_pte
c_func
(paren
id|addr
comma
id|BUCKET_PTE
c_func
(paren
id|pages
)paren
)paren
suffix:semicolon
macro_line|#ifndef CONFIG_SUN4&t;
id|sun4c_put_pte
c_func
(paren
id|addr
op_plus
id|PAGE_SIZE
comma
id|BUCKET_PTE
c_func
(paren
id|pages
op_plus
id|PAGE_SIZE
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
r_struct
id|task_struct
op_star
)paren
id|addr
suffix:semicolon
)brace
DECL|function|sun4c_free_task_struct_hw
r_static
r_void
id|sun4c_free_task_struct_hw
c_func
(paren
r_struct
id|task_struct
op_star
id|tsk
)paren
(brace
r_int
r_int
id|tsaddr
op_assign
(paren
r_int
r_int
)paren
id|tsk
suffix:semicolon
r_int
r_int
id|pages
op_assign
id|BUCKET_PTE_PAGE
c_func
(paren
id|sun4c_get_pte
c_func
(paren
id|tsaddr
)paren
)paren
suffix:semicolon
r_int
id|entry
op_assign
id|BUCKET_NUM
c_func
(paren
id|tsaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
(paren
id|tsk
)paren
op_member_access_from_pointer
id|thread.refcount
)paren
)paren
(brace
multiline_comment|/* We are deleting a mapping, so the flush here is mandatory. */
id|sun4c_flush_page_hw
c_func
(paren
id|tsaddr
)paren
suffix:semicolon
macro_line|#ifndef CONFIG_SUN4&t;
id|sun4c_flush_page_hw
c_func
(paren
id|tsaddr
op_plus
id|PAGE_SIZE
)paren
suffix:semicolon
macro_line|#endif
id|sun4c_put_pte
c_func
(paren
id|tsaddr
comma
l_int|0
)paren
suffix:semicolon
macro_line|#ifndef CONFIG_SUN4&t;
id|sun4c_put_pte
c_func
(paren
id|tsaddr
op_plus
id|PAGE_SIZE
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|sun4c_bucket
(braket
id|entry
)braket
op_assign
id|BUCKET_EMPTY
suffix:semicolon
r_if
c_cond
(paren
id|entry
OL
id|sun4c_lowbucket_avail
)paren
id|sun4c_lowbucket_avail
op_assign
id|entry
suffix:semicolon
id|free_pages
c_func
(paren
id|pages
comma
id|TASK_STRUCT_ORDER
)paren
suffix:semicolon
id|garbage_collect
c_func
(paren
id|entry
)paren
suffix:semicolon
)brace
)brace
DECL|function|sun4c_free_task_struct_sw
r_static
r_void
id|sun4c_free_task_struct_sw
c_func
(paren
r_struct
id|task_struct
op_star
id|tsk
)paren
(brace
r_int
r_int
id|tsaddr
op_assign
(paren
r_int
r_int
)paren
id|tsk
suffix:semicolon
r_int
r_int
id|pages
op_assign
id|BUCKET_PTE_PAGE
c_func
(paren
id|sun4c_get_pte
c_func
(paren
id|tsaddr
)paren
)paren
suffix:semicolon
r_int
id|entry
op_assign
id|BUCKET_NUM
c_func
(paren
id|tsaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
(paren
id|tsk
)paren
op_member_access_from_pointer
id|thread.refcount
)paren
)paren
(brace
multiline_comment|/* We are deleting a mapping, so the flush here is mandatory. */
id|sun4c_flush_page_sw
c_func
(paren
id|tsaddr
)paren
suffix:semicolon
macro_line|#ifndef CONFIG_SUN4&t;
id|sun4c_flush_page_sw
c_func
(paren
id|tsaddr
op_plus
id|PAGE_SIZE
)paren
suffix:semicolon
macro_line|#endif
id|sun4c_put_pte
c_func
(paren
id|tsaddr
comma
l_int|0
)paren
suffix:semicolon
macro_line|#ifndef CONFIG_SUN4&t;
id|sun4c_put_pte
c_func
(paren
id|tsaddr
op_plus
id|PAGE_SIZE
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|sun4c_bucket
(braket
id|entry
)braket
op_assign
id|BUCKET_EMPTY
suffix:semicolon
r_if
c_cond
(paren
id|entry
OL
id|sun4c_lowbucket_avail
)paren
id|sun4c_lowbucket_avail
op_assign
id|entry
suffix:semicolon
id|free_pages
c_func
(paren
id|pages
comma
id|TASK_STRUCT_ORDER
)paren
suffix:semicolon
id|garbage_collect
c_func
(paren
id|entry
)paren
suffix:semicolon
)brace
)brace
DECL|function|sun4c_get_task_struct
r_static
r_void
id|sun4c_get_task_struct
c_func
(paren
r_struct
id|task_struct
op_star
id|tsk
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
(paren
id|tsk
)paren
op_member_access_from_pointer
id|thread.refcount
)paren
suffix:semicolon
)brace
DECL|function|sun4c_init_buckets
r_static
r_void
id|__init
id|sun4c_init_buckets
c_func
(paren
r_void
)paren
(brace
r_int
id|entry
suffix:semicolon
r_if
c_cond
(paren
r_sizeof
(paren
r_union
id|task_union
)paren
op_ne
(paren
id|PAGE_SIZE
op_lshift
id|TASK_STRUCT_ORDER
)paren
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;task union not %d page(s)!&bslash;n&quot;
comma
l_int|1
op_lshift
id|TASK_STRUCT_ORDER
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|entry
op_assign
l_int|0
suffix:semicolon
id|entry
OL
id|NR_TASK_BUCKETS
suffix:semicolon
id|entry
op_increment
)paren
id|sun4c_bucket
(braket
id|entry
)braket
op_assign
id|BUCKET_EMPTY
suffix:semicolon
id|sun4c_lowbucket_avail
op_assign
l_int|0
suffix:semicolon
)brace
DECL|variable|sun4c_iobuffer_start
r_static
r_int
r_int
id|sun4c_iobuffer_start
suffix:semicolon
DECL|variable|sun4c_iobuffer_end
r_static
r_int
r_int
id|sun4c_iobuffer_end
suffix:semicolon
DECL|variable|sun4c_iobuffer_high
r_static
r_int
r_int
id|sun4c_iobuffer_high
suffix:semicolon
DECL|variable|sun4c_iobuffer_map
r_static
r_int
r_int
op_star
id|sun4c_iobuffer_map
suffix:semicolon
DECL|variable|iobuffer_map_size
r_static
r_int
id|iobuffer_map_size
suffix:semicolon
multiline_comment|/*&n; * Alias our pages so they do not cause a trap.&n; * Also one page may be aliased into several I/O areas and we may&n; * finish these I/O separately.&n; */
DECL|function|sun4c_lockarea
r_static
r_char
op_star
id|sun4c_lockarea
c_func
(paren
r_char
op_star
id|vaddr
comma
r_int
r_int
id|size
)paren
(brace
r_int
r_int
id|base
comma
id|scan
suffix:semicolon
r_int
r_int
id|npages
suffix:semicolon
r_int
r_int
id|vpage
suffix:semicolon
r_int
r_int
id|pte
suffix:semicolon
r_int
r_int
id|apage
suffix:semicolon
r_int
r_int
id|high
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|npages
op_assign
(paren
(paren
(paren
r_int
r_int
)paren
id|vaddr
op_amp
op_complement
id|PAGE_MASK
)paren
op_plus
id|size
op_plus
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
id|scan
op_assign
l_int|0
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|scan
op_assign
id|find_next_zero_bit
c_func
(paren
id|sun4c_iobuffer_map
comma
id|iobuffer_map_size
comma
id|scan
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|base
op_assign
id|scan
)paren
op_plus
id|npages
OG
id|iobuffer_map_size
)paren
r_goto
id|abend
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|scan
op_ge
id|base
op_plus
id|npages
)paren
r_goto
id|found
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|scan
comma
id|sun4c_iobuffer_map
)paren
)paren
r_break
suffix:semicolon
id|scan
op_increment
suffix:semicolon
)brace
)brace
id|found
suffix:colon
id|high
op_assign
(paren
(paren
id|base
op_plus
id|npages
)paren
op_lshift
id|PAGE_SHIFT
)paren
op_plus
id|sun4c_iobuffer_start
suffix:semicolon
id|high
op_assign
id|SUN4C_REAL_PGDIR_ALIGN
c_func
(paren
id|high
)paren
suffix:semicolon
r_while
c_loop
(paren
id|high
OG
id|sun4c_iobuffer_high
)paren
(brace
id|get_locked_segment
c_func
(paren
id|sun4c_iobuffer_high
)paren
suffix:semicolon
id|sun4c_iobuffer_high
op_add_assign
id|SUN4C_REAL_PGDIR_SIZE
suffix:semicolon
)brace
id|vpage
op_assign
(paren
(paren
r_int
r_int
)paren
id|vaddr
)paren
op_amp
id|PAGE_MASK
suffix:semicolon
r_for
c_loop
(paren
id|scan
op_assign
id|base
suffix:semicolon
id|scan
OL
id|base
op_plus
id|npages
suffix:semicolon
id|scan
op_increment
)paren
(brace
id|pte
op_assign
(paren
(paren
id|vpage
op_minus
id|PAGE_OFFSET
)paren
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|pte
op_or_assign
id|pgprot_val
c_func
(paren
id|SUN4C_PAGE_KERNEL
)paren
suffix:semicolon
id|pte
op_or_assign
id|_SUN4C_PAGE_NOCACHE
suffix:semicolon
id|set_bit
c_func
(paren
id|scan
comma
id|sun4c_iobuffer_map
)paren
suffix:semicolon
id|apage
op_assign
(paren
id|scan
op_lshift
id|PAGE_SHIFT
)paren
op_plus
id|sun4c_iobuffer_start
suffix:semicolon
multiline_comment|/* Flush original mapping so we see the right things later. */
id|sun4c_flush_page
c_func
(paren
id|vpage
)paren
suffix:semicolon
id|sun4c_put_pte
c_func
(paren
id|apage
comma
id|pte
)paren
suffix:semicolon
id|vpage
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
(paren
r_char
op_star
)paren
(paren
(paren
id|base
op_lshift
id|PAGE_SHIFT
)paren
op_plus
id|sun4c_iobuffer_start
op_plus
(paren
(paren
(paren
r_int
r_int
)paren
id|vaddr
)paren
op_amp
op_complement
id|PAGE_MASK
)paren
)paren
suffix:semicolon
id|abend
suffix:colon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;DMA vaddr=0x%p size=%08lx&bslash;n&quot;
comma
id|vaddr
comma
id|size
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;Out of iobuffer table&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sun4c_unlockarea
r_static
r_void
id|sun4c_unlockarea
c_func
(paren
r_char
op_star
id|vaddr
comma
r_int
r_int
id|size
)paren
(brace
r_int
r_int
id|vpage
comma
id|npages
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|scan
comma
id|high
suffix:semicolon
id|vpage
op_assign
(paren
r_int
r_int
)paren
id|vaddr
op_amp
id|PAGE_MASK
suffix:semicolon
id|npages
op_assign
(paren
(paren
(paren
r_int
r_int
)paren
id|vaddr
op_amp
op_complement
id|PAGE_MASK
)paren
op_plus
id|size
op_plus
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|npages
op_ne
l_int|0
)paren
(brace
op_decrement
id|npages
suffix:semicolon
multiline_comment|/* This mapping is marked non-cachable, no flush necessary. */
id|sun4c_put_pte
c_func
(paren
id|vpage
comma
l_int|0
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
(paren
id|vpage
op_minus
id|sun4c_iobuffer_start
)paren
op_rshift
id|PAGE_SHIFT
comma
id|sun4c_iobuffer_map
)paren
suffix:semicolon
id|vpage
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
multiline_comment|/* garbage collect */
id|scan
op_assign
(paren
id|sun4c_iobuffer_high
op_minus
id|sun4c_iobuffer_start
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
r_while
c_loop
(paren
id|scan
op_ge
l_int|0
op_logical_and
op_logical_neg
id|sun4c_iobuffer_map
(braket
id|scan
op_rshift
l_int|5
)braket
)paren
id|scan
op_sub_assign
l_int|32
suffix:semicolon
id|scan
op_add_assign
l_int|32
suffix:semicolon
id|high
op_assign
id|sun4c_iobuffer_start
op_plus
(paren
id|scan
op_lshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|high
op_assign
id|SUN4C_REAL_PGDIR_ALIGN
c_func
(paren
id|high
)paren
op_plus
id|SUN4C_REAL_PGDIR_SIZE
suffix:semicolon
r_while
c_loop
(paren
id|high
OL
id|sun4c_iobuffer_high
)paren
(brace
id|sun4c_iobuffer_high
op_sub_assign
id|SUN4C_REAL_PGDIR_SIZE
suffix:semicolon
id|free_locked_segment
c_func
(paren
id|sun4c_iobuffer_high
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Note the scsi code at init time passes to here buffers&n; * which sit on the kernel stack, those are already locked&n; * by implication and fool the page locking code above&n; * if passed to by mistake.&n; */
DECL|function|sun4c_get_scsi_one
r_static
id|__u32
id|sun4c_get_scsi_one
c_func
(paren
r_char
op_star
id|bufptr
comma
r_int
r_int
id|len
comma
r_struct
id|sbus_bus
op_star
id|sbus
)paren
(brace
r_int
r_int
id|page
suffix:semicolon
id|page
op_assign
(paren
(paren
r_int
r_int
)paren
id|bufptr
)paren
op_amp
id|PAGE_MASK
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|VALID_PAGE
c_func
(paren
id|virt_to_page
c_func
(paren
id|page
)paren
)paren
)paren
(brace
id|sun4c_flush_page
c_func
(paren
id|page
)paren
suffix:semicolon
r_return
(paren
id|__u32
)paren
id|bufptr
suffix:semicolon
multiline_comment|/* already locked */
)brace
r_return
(paren
id|__u32
)paren
id|sun4c_lockarea
c_func
(paren
id|bufptr
comma
id|len
)paren
suffix:semicolon
)brace
DECL|function|sun4c_get_scsi_sgl
r_static
r_void
id|sun4c_get_scsi_sgl
c_func
(paren
r_struct
id|scatterlist
op_star
id|sg
comma
r_int
id|sz
comma
r_struct
id|sbus_bus
op_star
id|sbus
)paren
(brace
r_while
c_loop
(paren
id|sz
op_ge
l_int|0
)paren
(brace
id|sg
(braket
id|sz
)braket
dot
id|dvma_address
op_assign
(paren
id|__u32
)paren
id|sun4c_lockarea
c_func
(paren
id|sg
(braket
id|sz
)braket
dot
id|address
comma
id|sg
(braket
id|sz
)braket
dot
id|length
)paren
suffix:semicolon
id|sg
(braket
id|sz
)braket
dot
id|dvma_length
op_assign
id|sg
(braket
id|sz
)braket
dot
id|length
suffix:semicolon
id|sz
op_decrement
suffix:semicolon
)brace
)brace
DECL|function|sun4c_release_scsi_one
r_static
r_void
id|sun4c_release_scsi_one
c_func
(paren
id|__u32
id|bufptr
comma
r_int
r_int
id|len
comma
r_struct
id|sbus_bus
op_star
id|sbus
)paren
(brace
r_if
c_cond
(paren
id|bufptr
OL
id|sun4c_iobuffer_start
)paren
r_return
suffix:semicolon
multiline_comment|/* On kernel stack or similar, see above */
id|sun4c_unlockarea
c_func
(paren
(paren
r_char
op_star
)paren
id|bufptr
comma
id|len
)paren
suffix:semicolon
)brace
DECL|function|sun4c_release_scsi_sgl
r_static
r_void
id|sun4c_release_scsi_sgl
c_func
(paren
r_struct
id|scatterlist
op_star
id|sg
comma
r_int
id|sz
comma
r_struct
id|sbus_bus
op_star
id|sbus
)paren
(brace
r_while
c_loop
(paren
id|sz
op_ge
l_int|0
)paren
(brace
id|sun4c_unlockarea
c_func
(paren
(paren
r_char
op_star
)paren
id|sg
(braket
id|sz
)braket
dot
id|dvma_address
comma
id|sg
(braket
id|sz
)braket
dot
id|length
)paren
suffix:semicolon
id|sz
op_decrement
suffix:semicolon
)brace
)brace
DECL|macro|TASK_ENTRY_SIZE
mdefine_line|#define TASK_ENTRY_SIZE    BUCKET_SIZE /* see above */
DECL|macro|LONG_ALIGN
mdefine_line|#define LONG_ALIGN(x) (((x)+(sizeof(long))-1)&amp;~((sizeof(long))-1))
DECL|variable|sun4c_kstack_vma
r_struct
id|vm_area_struct
id|sun4c_kstack_vma
suffix:semicolon
DECL|function|sun4c_init_lock_areas
r_static
r_void
id|__init
id|sun4c_init_lock_areas
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|sun4c_taskstack_start
suffix:semicolon
r_int
r_int
id|sun4c_taskstack_end
suffix:semicolon
r_int
id|bitmap_size
suffix:semicolon
id|sun4c_init_buckets
c_func
(paren
)paren
suffix:semicolon
id|sun4c_taskstack_start
op_assign
id|SUN4C_LOCK_VADDR
suffix:semicolon
id|sun4c_taskstack_end
op_assign
(paren
id|sun4c_taskstack_start
op_plus
(paren
id|TASK_ENTRY_SIZE
op_star
id|NR_TASK_BUCKETS
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sun4c_taskstack_end
op_ge
id|SUN4C_LOCK_END
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;Too many tasks, decrease NR_TASK_BUCKETS please.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|sun4c_iobuffer_start
op_assign
id|sun4c_iobuffer_high
op_assign
id|SUN4C_REAL_PGDIR_ALIGN
c_func
(paren
id|sun4c_taskstack_end
)paren
suffix:semicolon
id|sun4c_iobuffer_end
op_assign
id|SUN4C_LOCK_END
suffix:semicolon
id|bitmap_size
op_assign
(paren
id|sun4c_iobuffer_end
op_minus
id|sun4c_iobuffer_start
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
id|bitmap_size
op_assign
(paren
id|bitmap_size
op_plus
l_int|7
)paren
op_rshift
l_int|3
suffix:semicolon
id|bitmap_size
op_assign
id|LONG_ALIGN
c_func
(paren
id|bitmap_size
)paren
suffix:semicolon
id|iobuffer_map_size
op_assign
id|bitmap_size
op_lshift
l_int|3
suffix:semicolon
id|sun4c_iobuffer_map
op_assign
id|__alloc_bootmem
c_func
(paren
id|bitmap_size
comma
id|SMP_CACHE_BYTES
comma
l_int|0UL
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|sun4c_iobuffer_map
comma
l_int|0
comma
id|bitmap_size
)paren
suffix:semicolon
id|sun4c_kstack_vma.vm_mm
op_assign
op_amp
id|init_mm
suffix:semicolon
id|sun4c_kstack_vma.vm_start
op_assign
id|sun4c_taskstack_start
suffix:semicolon
id|sun4c_kstack_vma.vm_end
op_assign
id|sun4c_taskstack_end
suffix:semicolon
id|sun4c_kstack_vma.vm_page_prot
op_assign
id|PAGE_SHARED
suffix:semicolon
id|sun4c_kstack_vma.vm_flags
op_assign
id|VM_READ
op_or
id|VM_WRITE
op_or
id|VM_EXEC
suffix:semicolon
id|insert_vm_struct
c_func
(paren
op_amp
id|init_mm
comma
op_amp
id|sun4c_kstack_vma
)paren
suffix:semicolon
)brace
multiline_comment|/* Cache flushing on the sun4c. */
DECL|function|sun4c_flush_cache_all
r_static
r_void
id|sun4c_flush_cache_all
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|begin
comma
id|end
suffix:semicolon
id|flush_user_windows
c_func
(paren
)paren
suffix:semicolon
id|begin
op_assign
(paren
id|KERNBASE
op_plus
id|SUN4C_REAL_PGDIR_SIZE
)paren
suffix:semicolon
id|end
op_assign
(paren
id|begin
op_plus
id|SUN4C_VAC_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sun4c_vacinfo.linesize
op_eq
l_int|32
)paren
(brace
r_while
c_loop
(paren
id|begin
OL
id|end
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
"&quot;"
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0x00
)braket
comma
op_mod
op_mod
id|g0
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0x20
)braket
comma
op_mod
op_mod
id|g0
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0x40
)braket
comma
op_mod
op_mod
id|g0
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0x60
)braket
comma
op_mod
op_mod
id|g0
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0x80
)braket
comma
op_mod
op_mod
id|g0
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0xa0
)braket
comma
op_mod
op_mod
id|g0
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0xc0
)braket
comma
op_mod
op_mod
id|g0
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0xe0
)braket
comma
op_mod
op_mod
id|g0
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0x100
)braket
comma
op_mod
op_mod
id|g0
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0x120
)braket
comma
op_mod
op_mod
id|g0
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0x140
)braket
comma
op_mod
op_mod
id|g0
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0x160
)braket
comma
op_mod
op_mod
id|g0
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0x180
)braket
comma
op_mod
op_mod
id|g0
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0x1a0
)braket
comma
op_mod
op_mod
id|g0
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0x1c0
)braket
comma
op_mod
op_mod
id|g0
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0x1e0
)braket
comma
op_mod
op_mod
id|g0
l_string|&quot; : : &quot;
id|r
"&quot;"
(paren
id|begin
)paren
)paren
suffix:semicolon
id|begin
op_add_assign
l_int|512
suffix:semicolon
)brace
)brace
r_else
(brace
r_while
c_loop
(paren
id|begin
OL
id|end
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
"&quot;"
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0x00
)braket
comma
op_mod
op_mod
id|g0
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0x10
)braket
comma
op_mod
op_mod
id|g0
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0x20
)braket
comma
op_mod
op_mod
id|g0
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0x30
)braket
comma
op_mod
op_mod
id|g0
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0x40
)braket
comma
op_mod
op_mod
id|g0
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0x50
)braket
comma
op_mod
op_mod
id|g0
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0x60
)braket
comma
op_mod
op_mod
id|g0
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0x70
)braket
comma
op_mod
op_mod
id|g0
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0x80
)braket
comma
op_mod
op_mod
id|g0
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0x90
)braket
comma
op_mod
op_mod
id|g0
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0xa0
)braket
comma
op_mod
op_mod
id|g0
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0xb0
)braket
comma
op_mod
op_mod
id|g0
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0xc0
)braket
comma
op_mod
op_mod
id|g0
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0xd0
)braket
comma
op_mod
op_mod
id|g0
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0xe0
)braket
comma
op_mod
op_mod
id|g0
id|ld
(braket
op_mod
l_int|0
op_plus
l_int|0xf0
)braket
comma
op_mod
op_mod
id|g0
l_string|&quot; : : &quot;
id|r
"&quot;"
(paren
id|begin
)paren
)paren
suffix:semicolon
id|begin
op_add_assign
l_int|256
suffix:semicolon
)brace
)brace
)brace
DECL|function|sun4c_flush_cache_mm_hw
r_static
r_void
id|sun4c_flush_cache_mm_hw
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
r_int
id|new_ctx
op_assign
id|mm-&gt;context
suffix:semicolon
r_if
c_cond
(paren
id|new_ctx
op_ne
id|NO_CONTEXT
)paren
(brace
id|flush_user_windows
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sun4c_context_ring
(braket
id|new_ctx
)braket
dot
id|num_entries
)paren
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|head
op_assign
op_amp
id|sun4c_context_ring
(braket
id|new_ctx
)braket
dot
id|ringhd
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|head-&gt;next
op_ne
id|head
)paren
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|entry
op_assign
id|head-&gt;next
suffix:semicolon
r_int
id|savectx
op_assign
id|sun4c_get_context
c_func
(paren
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
id|new_ctx
)paren
suffix:semicolon
id|sun4c_flush_context_hw
c_func
(paren
)paren
suffix:semicolon
r_do
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|next
op_assign
id|entry-&gt;next
suffix:semicolon
id|sun4c_user_unmap
c_func
(paren
id|entry
)paren
suffix:semicolon
id|free_user_entry
c_func
(paren
id|new_ctx
comma
id|entry
)paren
suffix:semicolon
id|entry
op_assign
id|next
suffix:semicolon
)brace
r_while
c_loop
(paren
id|entry
op_ne
id|head
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
id|savectx
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|sun4c_flush_cache_range_hw
r_static
r_void
id|sun4c_flush_cache_range_hw
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
r_int
id|new_ctx
op_assign
id|mm-&gt;context
suffix:semicolon
r_if
c_cond
(paren
id|new_ctx
op_ne
id|NO_CONTEXT
)paren
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|head
op_assign
op_amp
id|sun4c_context_ring
(braket
id|new_ctx
)braket
dot
id|ringhd
suffix:semicolon
r_struct
id|sun4c_mmu_entry
op_star
id|entry
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|flush_user_windows
c_func
(paren
)paren
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* All user segmap chains are ordered on entry-&gt;vaddr. */
r_for
c_loop
(paren
id|entry
op_assign
id|head-&gt;next
suffix:semicolon
(paren
id|entry
op_ne
id|head
)paren
op_logical_and
(paren
(paren
id|entry-&gt;vaddr
op_plus
id|SUN4C_REAL_PGDIR_SIZE
)paren
OL
id|start
)paren
suffix:semicolon
id|entry
op_assign
id|entry-&gt;next
)paren
suffix:semicolon
multiline_comment|/* Tracing various job mixtures showed that this conditional&n;&t;&t; * only passes ~35% of the time for most worse case situations,&n;&t;&t; * therefore we avoid all of this gross overhead ~65% of the time.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|entry
op_ne
id|head
)paren
op_logical_and
(paren
id|entry-&gt;vaddr
OL
id|end
)paren
)paren
(brace
r_int
id|octx
op_assign
id|sun4c_get_context
c_func
(paren
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
id|new_ctx
)paren
suffix:semicolon
multiline_comment|/* At this point, always, (start &gt;= entry-&gt;vaddr) and&n;&t;&t;&t; * (entry-&gt;vaddr &lt; end), once the latter condition&n;&t;&t;&t; * ceases to hold, or we hit the end of the list, we&n;&t;&t;&t; * exit the loop.  The ordering of all user allocated&n;&t;&t;&t; * segmaps makes this all work out so beautifully.&n;&t;&t;&t; */
r_do
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|next
op_assign
id|entry-&gt;next
suffix:semicolon
r_int
r_int
id|realend
suffix:semicolon
multiline_comment|/* &quot;realstart&quot; is always &gt;= entry-&gt;vaddr */
id|realend
op_assign
id|entry-&gt;vaddr
op_plus
id|SUN4C_REAL_PGDIR_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|end
OL
id|realend
)paren
id|realend
op_assign
id|end
suffix:semicolon
r_if
c_cond
(paren
(paren
id|realend
op_minus
id|entry-&gt;vaddr
)paren
op_le
(paren
id|PAGE_SIZE
op_lshift
l_int|3
)paren
)paren
(brace
r_int
r_int
id|page
op_assign
id|entry-&gt;vaddr
suffix:semicolon
r_while
c_loop
(paren
id|page
OL
id|realend
)paren
(brace
id|sun4c_flush_page_hw
c_func
(paren
id|page
)paren
suffix:semicolon
id|page
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
)brace
r_else
(brace
id|sun4c_flush_segment_hw
c_func
(paren
id|entry-&gt;vaddr
)paren
suffix:semicolon
id|sun4c_user_unmap
c_func
(paren
id|entry
)paren
suffix:semicolon
id|free_user_entry
c_func
(paren
id|new_ctx
comma
id|entry
)paren
suffix:semicolon
)brace
id|entry
op_assign
id|next
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|entry
op_ne
id|head
)paren
op_logical_and
(paren
id|entry-&gt;vaddr
OL
id|end
)paren
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
id|octx
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
DECL|function|sun4c_flush_cache_page_hw
r_static
r_void
id|sun4c_flush_cache_page_hw
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
(brace
r_struct
id|mm_struct
op_star
id|mm
op_assign
id|vma-&gt;vm_mm
suffix:semicolon
r_int
id|new_ctx
op_assign
id|mm-&gt;context
suffix:semicolon
multiline_comment|/* Sun4c has no separate I/D caches so cannot optimize for non&n;&t; * text page flushes.&n;&t; */
r_if
c_cond
(paren
id|new_ctx
op_ne
id|NO_CONTEXT
)paren
(brace
r_int
id|octx
op_assign
id|sun4c_get_context
c_func
(paren
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|flush_user_windows
c_func
(paren
)paren
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
id|new_ctx
)paren
suffix:semicolon
id|sun4c_flush_page_hw
c_func
(paren
id|page
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
id|octx
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
DECL|function|sun4c_flush_page_to_ram_hw
r_static
r_void
id|sun4c_flush_page_to_ram_hw
c_func
(paren
r_int
r_int
id|page
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|sun4c_flush_page_hw
c_func
(paren
id|page
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|sun4c_flush_cache_mm_sw
r_static
r_void
id|sun4c_flush_cache_mm_sw
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
r_int
id|new_ctx
op_assign
id|mm-&gt;context
suffix:semicolon
r_if
c_cond
(paren
id|new_ctx
op_ne
id|NO_CONTEXT
)paren
(brace
id|flush_user_windows
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sun4c_context_ring
(braket
id|new_ctx
)braket
dot
id|num_entries
)paren
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|head
op_assign
op_amp
id|sun4c_context_ring
(braket
id|new_ctx
)braket
dot
id|ringhd
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|head-&gt;next
op_ne
id|head
)paren
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|entry
op_assign
id|head-&gt;next
suffix:semicolon
r_int
id|savectx
op_assign
id|sun4c_get_context
c_func
(paren
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
id|new_ctx
)paren
suffix:semicolon
id|sun4c_flush_context_sw
c_func
(paren
)paren
suffix:semicolon
r_do
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|next
op_assign
id|entry-&gt;next
suffix:semicolon
id|sun4c_user_unmap
c_func
(paren
id|entry
)paren
suffix:semicolon
id|free_user_entry
c_func
(paren
id|new_ctx
comma
id|entry
)paren
suffix:semicolon
id|entry
op_assign
id|next
suffix:semicolon
)brace
r_while
c_loop
(paren
id|entry
op_ne
id|head
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
id|savectx
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|sun4c_flush_cache_range_sw
r_static
r_void
id|sun4c_flush_cache_range_sw
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
r_int
id|new_ctx
op_assign
id|mm-&gt;context
suffix:semicolon
r_if
c_cond
(paren
id|new_ctx
op_ne
id|NO_CONTEXT
)paren
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|head
op_assign
op_amp
id|sun4c_context_ring
(braket
id|new_ctx
)braket
dot
id|ringhd
suffix:semicolon
r_struct
id|sun4c_mmu_entry
op_star
id|entry
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|flush_user_windows
c_func
(paren
)paren
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* All user segmap chains are ordered on entry-&gt;vaddr. */
r_for
c_loop
(paren
id|entry
op_assign
id|head-&gt;next
suffix:semicolon
(paren
id|entry
op_ne
id|head
)paren
op_logical_and
(paren
(paren
id|entry-&gt;vaddr
op_plus
id|SUN4C_REAL_PGDIR_SIZE
)paren
OL
id|start
)paren
suffix:semicolon
id|entry
op_assign
id|entry-&gt;next
)paren
suffix:semicolon
multiline_comment|/* Tracing various job mixtures showed that this conditional&n;&t;&t; * only passes ~35% of the time for most worse case situations,&n;&t;&t; * therefore we avoid all of this gross overhead ~65% of the time.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|entry
op_ne
id|head
)paren
op_logical_and
(paren
id|entry-&gt;vaddr
OL
id|end
)paren
)paren
(brace
r_int
id|octx
op_assign
id|sun4c_get_context
c_func
(paren
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
id|new_ctx
)paren
suffix:semicolon
multiline_comment|/* At this point, always, (start &gt;= entry-&gt;vaddr) and&n;&t;&t;&t; * (entry-&gt;vaddr &lt; end), once the latter condition&n;&t;&t;&t; * ceases to hold, or we hit the end of the list, we&n;&t;&t;&t; * exit the loop.  The ordering of all user allocated&n;&t;&t;&t; * segmaps makes this all work out so beautifully.&n;&t;&t;&t; */
r_do
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|next
op_assign
id|entry-&gt;next
suffix:semicolon
r_int
r_int
id|realend
suffix:semicolon
multiline_comment|/* &quot;realstart&quot; is always &gt;= entry-&gt;vaddr */
id|realend
op_assign
id|entry-&gt;vaddr
op_plus
id|SUN4C_REAL_PGDIR_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|end
OL
id|realend
)paren
id|realend
op_assign
id|end
suffix:semicolon
r_if
c_cond
(paren
(paren
id|realend
op_minus
id|entry-&gt;vaddr
)paren
op_le
(paren
id|PAGE_SIZE
op_lshift
l_int|3
)paren
)paren
(brace
r_int
r_int
id|page
op_assign
id|entry-&gt;vaddr
suffix:semicolon
r_while
c_loop
(paren
id|page
OL
id|realend
)paren
(brace
id|sun4c_flush_page_sw
c_func
(paren
id|page
)paren
suffix:semicolon
id|page
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
)brace
r_else
(brace
id|sun4c_flush_segment_sw
c_func
(paren
id|entry-&gt;vaddr
)paren
suffix:semicolon
id|sun4c_user_unmap
c_func
(paren
id|entry
)paren
suffix:semicolon
id|free_user_entry
c_func
(paren
id|new_ctx
comma
id|entry
)paren
suffix:semicolon
)brace
id|entry
op_assign
id|next
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|entry
op_ne
id|head
)paren
op_logical_and
(paren
id|entry-&gt;vaddr
OL
id|end
)paren
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
id|octx
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
DECL|function|sun4c_flush_cache_page_sw
r_static
r_void
id|sun4c_flush_cache_page_sw
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
(brace
r_struct
id|mm_struct
op_star
id|mm
op_assign
id|vma-&gt;vm_mm
suffix:semicolon
r_int
id|new_ctx
op_assign
id|mm-&gt;context
suffix:semicolon
multiline_comment|/* Sun4c has no separate I/D caches so cannot optimize for non&n;&t; * text page flushes.&n;&t; */
r_if
c_cond
(paren
id|new_ctx
op_ne
id|NO_CONTEXT
)paren
(brace
r_int
id|octx
op_assign
id|sun4c_get_context
c_func
(paren
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|flush_user_windows
c_func
(paren
)paren
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
id|new_ctx
)paren
suffix:semicolon
id|sun4c_flush_page_sw
c_func
(paren
id|page
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
id|octx
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
DECL|function|sun4c_flush_page_to_ram_sw
r_static
r_void
id|sun4c_flush_page_to_ram_sw
c_func
(paren
r_int
r_int
id|page
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|sun4c_flush_page_sw
c_func
(paren
id|page
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Sun4c cache is unified, both instructions and data live there, so&n; * no need to flush the on-stack instructions for new signal handlers.&n; */
DECL|function|sun4c_flush_sig_insns
r_static
r_void
id|sun4c_flush_sig_insns
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|insn_addr
)paren
(brace
)brace
multiline_comment|/* TLB flushing on the sun4c.  These routines count on the cache&n; * flushing code to flush the user register windows so that we need&n; * not do so when we get here.&n; */
DECL|function|sun4c_flush_tlb_all
r_static
r_void
id|sun4c_flush_tlb_all
c_func
(paren
r_void
)paren
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|this_entry
comma
op_star
id|next_entry
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|savectx
comma
id|ctx
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|this_entry
op_assign
id|sun4c_kernel_ring.ringhd.next
suffix:semicolon
id|savectx
op_assign
id|sun4c_get_context
c_func
(paren
)paren
suffix:semicolon
id|flush_user_windows
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|sun4c_kernel_ring.num_entries
)paren
(brace
id|next_entry
op_assign
id|this_entry-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|sun4c_vacinfo.do_hwflushes
)paren
id|sun4c_flush_segment_hw
c_func
(paren
id|this_entry-&gt;vaddr
)paren
suffix:semicolon
r_else
id|sun4c_flush_segment_sw
c_func
(paren
id|this_entry-&gt;vaddr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ctx
op_assign
l_int|0
suffix:semicolon
id|ctx
OL
id|num_contexts
suffix:semicolon
id|ctx
op_increment
)paren
(brace
id|sun4c_set_context
c_func
(paren
id|ctx
)paren
suffix:semicolon
id|sun4c_put_segmap
c_func
(paren
id|this_entry-&gt;vaddr
comma
id|invalid_segment
)paren
suffix:semicolon
)brace
id|free_kernel_entry
c_func
(paren
id|this_entry
comma
op_amp
id|sun4c_kernel_ring
)paren
suffix:semicolon
id|this_entry
op_assign
id|next_entry
suffix:semicolon
)brace
id|sun4c_set_context
c_func
(paren
id|savectx
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|sun4c_flush_tlb_mm_hw
r_static
r_void
id|sun4c_flush_tlb_mm_hw
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
r_int
id|new_ctx
op_assign
id|mm-&gt;context
suffix:semicolon
r_if
c_cond
(paren
id|new_ctx
op_ne
id|NO_CONTEXT
)paren
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|head
op_assign
op_amp
id|sun4c_context_ring
(braket
id|new_ctx
)braket
dot
id|ringhd
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|head-&gt;next
op_ne
id|head
)paren
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|entry
op_assign
id|head-&gt;next
suffix:semicolon
r_int
id|savectx
op_assign
id|sun4c_get_context
c_func
(paren
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
id|new_ctx
)paren
suffix:semicolon
id|sun4c_flush_context_hw
c_func
(paren
)paren
suffix:semicolon
r_do
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|next
op_assign
id|entry-&gt;next
suffix:semicolon
id|sun4c_user_unmap
c_func
(paren
id|entry
)paren
suffix:semicolon
id|free_user_entry
c_func
(paren
id|new_ctx
comma
id|entry
)paren
suffix:semicolon
id|entry
op_assign
id|next
suffix:semicolon
)brace
r_while
c_loop
(paren
id|entry
op_ne
id|head
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
id|savectx
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
DECL|function|sun4c_flush_tlb_range_hw
r_static
r_void
id|sun4c_flush_tlb_range_hw
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
r_int
id|new_ctx
op_assign
id|mm-&gt;context
suffix:semicolon
r_if
c_cond
(paren
id|new_ctx
op_ne
id|NO_CONTEXT
)paren
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|head
op_assign
op_amp
id|sun4c_context_ring
(braket
id|new_ctx
)braket
dot
id|ringhd
suffix:semicolon
r_struct
id|sun4c_mmu_entry
op_star
id|entry
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* See commentary in sun4c_flush_cache_range_*(). */
r_for
c_loop
(paren
id|entry
op_assign
id|head-&gt;next
suffix:semicolon
(paren
id|entry
op_ne
id|head
)paren
op_logical_and
(paren
(paren
id|entry-&gt;vaddr
op_plus
id|SUN4C_REAL_PGDIR_SIZE
)paren
OL
id|start
)paren
suffix:semicolon
id|entry
op_assign
id|entry-&gt;next
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|entry
op_ne
id|head
)paren
op_logical_and
(paren
id|entry-&gt;vaddr
OL
id|end
)paren
)paren
(brace
r_int
id|octx
op_assign
id|sun4c_get_context
c_func
(paren
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
id|new_ctx
)paren
suffix:semicolon
r_do
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|next
op_assign
id|entry-&gt;next
suffix:semicolon
id|sun4c_flush_segment_hw
c_func
(paren
id|entry-&gt;vaddr
)paren
suffix:semicolon
id|sun4c_user_unmap
c_func
(paren
id|entry
)paren
suffix:semicolon
id|free_user_entry
c_func
(paren
id|new_ctx
comma
id|entry
)paren
suffix:semicolon
id|entry
op_assign
id|next
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|entry
op_ne
id|head
)paren
op_logical_and
(paren
id|entry-&gt;vaddr
OL
id|end
)paren
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
id|octx
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
DECL|function|sun4c_flush_tlb_page_hw
r_static
r_void
id|sun4c_flush_tlb_page_hw
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
(brace
r_struct
id|mm_struct
op_star
id|mm
op_assign
id|vma-&gt;vm_mm
suffix:semicolon
r_int
id|new_ctx
op_assign
id|mm-&gt;context
suffix:semicolon
r_if
c_cond
(paren
id|new_ctx
op_ne
id|NO_CONTEXT
)paren
(brace
r_int
id|savectx
op_assign
id|sun4c_get_context
c_func
(paren
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
id|new_ctx
)paren
suffix:semicolon
id|page
op_and_assign
id|PAGE_MASK
suffix:semicolon
id|sun4c_flush_page_hw
c_func
(paren
id|page
)paren
suffix:semicolon
id|sun4c_put_pte
c_func
(paren
id|page
comma
l_int|0
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
id|savectx
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
DECL|function|sun4c_flush_tlb_mm_sw
r_static
r_void
id|sun4c_flush_tlb_mm_sw
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
r_int
id|new_ctx
op_assign
id|mm-&gt;context
suffix:semicolon
r_if
c_cond
(paren
id|new_ctx
op_ne
id|NO_CONTEXT
)paren
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|head
op_assign
op_amp
id|sun4c_context_ring
(braket
id|new_ctx
)braket
dot
id|ringhd
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|head-&gt;next
op_ne
id|head
)paren
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|entry
op_assign
id|head-&gt;next
suffix:semicolon
r_int
id|savectx
op_assign
id|sun4c_get_context
c_func
(paren
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
id|new_ctx
)paren
suffix:semicolon
id|sun4c_flush_context_sw
c_func
(paren
)paren
suffix:semicolon
r_do
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|next
op_assign
id|entry-&gt;next
suffix:semicolon
id|sun4c_user_unmap
c_func
(paren
id|entry
)paren
suffix:semicolon
id|free_user_entry
c_func
(paren
id|new_ctx
comma
id|entry
)paren
suffix:semicolon
id|entry
op_assign
id|next
suffix:semicolon
)brace
r_while
c_loop
(paren
id|entry
op_ne
id|head
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
id|savectx
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
DECL|function|sun4c_flush_tlb_range_sw
r_static
r_void
id|sun4c_flush_tlb_range_sw
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
r_int
id|new_ctx
op_assign
id|mm-&gt;context
suffix:semicolon
r_if
c_cond
(paren
id|new_ctx
op_ne
id|NO_CONTEXT
)paren
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|head
op_assign
op_amp
id|sun4c_context_ring
(braket
id|new_ctx
)braket
dot
id|ringhd
suffix:semicolon
r_struct
id|sun4c_mmu_entry
op_star
id|entry
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* See commentary in sun4c_flush_cache_range_*(). */
r_for
c_loop
(paren
id|entry
op_assign
id|head-&gt;next
suffix:semicolon
(paren
id|entry
op_ne
id|head
)paren
op_logical_and
(paren
(paren
id|entry-&gt;vaddr
op_plus
id|SUN4C_REAL_PGDIR_SIZE
)paren
OL
id|start
)paren
suffix:semicolon
id|entry
op_assign
id|entry-&gt;next
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|entry
op_ne
id|head
)paren
op_logical_and
(paren
id|entry-&gt;vaddr
OL
id|end
)paren
)paren
(brace
r_int
id|octx
op_assign
id|sun4c_get_context
c_func
(paren
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
id|new_ctx
)paren
suffix:semicolon
r_do
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|next
op_assign
id|entry-&gt;next
suffix:semicolon
id|sun4c_flush_segment_sw
c_func
(paren
id|entry-&gt;vaddr
)paren
suffix:semicolon
id|sun4c_user_unmap
c_func
(paren
id|entry
)paren
suffix:semicolon
id|free_user_entry
c_func
(paren
id|new_ctx
comma
id|entry
)paren
suffix:semicolon
id|entry
op_assign
id|next
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|entry
op_ne
id|head
)paren
op_logical_and
(paren
id|entry-&gt;vaddr
OL
id|end
)paren
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
id|octx
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
DECL|function|sun4c_flush_tlb_page_sw
r_static
r_void
id|sun4c_flush_tlb_page_sw
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
(brace
r_struct
id|mm_struct
op_star
id|mm
op_assign
id|vma-&gt;vm_mm
suffix:semicolon
r_int
id|new_ctx
op_assign
id|mm-&gt;context
suffix:semicolon
r_if
c_cond
(paren
id|new_ctx
op_ne
id|NO_CONTEXT
)paren
(brace
r_int
id|savectx
op_assign
id|sun4c_get_context
c_func
(paren
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
id|new_ctx
)paren
suffix:semicolon
id|page
op_and_assign
id|PAGE_MASK
suffix:semicolon
id|sun4c_flush_page_sw
c_func
(paren
id|page
)paren
suffix:semicolon
id|sun4c_put_pte
c_func
(paren
id|page
comma
l_int|0
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
id|savectx
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
DECL|function|sun4c_set_pte
r_static
r_void
id|sun4c_set_pte
c_func
(paren
id|pte_t
op_star
id|ptep
comma
id|pte_t
id|pte
)paren
(brace
op_star
id|ptep
op_assign
id|pte
suffix:semicolon
)brace
DECL|function|sun4c_pgd_set
r_static
r_void
id|sun4c_pgd_set
c_func
(paren
id|pgd_t
op_star
id|pgdp
comma
id|pmd_t
op_star
id|pmdp
)paren
(brace
)brace
DECL|function|sun4c_pmd_set
r_static
r_void
id|sun4c_pmd_set
c_func
(paren
id|pmd_t
op_star
id|pmdp
comma
id|pte_t
op_star
id|ptep
)paren
(brace
)brace
DECL|function|sun4c_mapioaddr
r_void
id|sun4c_mapioaddr
c_func
(paren
r_int
r_int
id|physaddr
comma
r_int
r_int
id|virt_addr
comma
r_int
id|bus_type
comma
r_int
id|rdonly
)paren
(brace
r_int
r_int
id|page_entry
suffix:semicolon
id|page_entry
op_assign
(paren
(paren
id|physaddr
op_rshift
id|PAGE_SHIFT
)paren
op_amp
id|SUN4C_PFN_MASK
)paren
suffix:semicolon
id|page_entry
op_or_assign
(paren
(paren
id|pg_iobits
op_or
id|_SUN4C_PAGE_PRIV
)paren
op_amp
op_complement
(paren
id|_SUN4C_PAGE_PRESENT
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rdonly
)paren
id|page_entry
op_and_assign
op_complement
id|_SUN4C_WRITEABLE
suffix:semicolon
id|sun4c_put_pte
c_func
(paren
id|virt_addr
comma
id|page_entry
)paren
suffix:semicolon
)brace
DECL|function|sun4c_unmapioaddr
r_void
id|sun4c_unmapioaddr
c_func
(paren
r_int
r_int
id|virt_addr
)paren
(brace
id|sun4c_put_pte
c_func
(paren
id|virt_addr
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|sun4c_alloc_context_hw
r_static
r_void
id|sun4c_alloc_context_hw
c_func
(paren
r_struct
id|mm_struct
op_star
id|old_mm
comma
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
r_struct
id|ctx_list
op_star
id|ctxp
suffix:semicolon
id|ctxp
op_assign
id|ctx_free.next
suffix:semicolon
r_if
c_cond
(paren
id|ctxp
op_ne
op_amp
id|ctx_free
)paren
(brace
id|remove_from_ctx_list
c_func
(paren
id|ctxp
)paren
suffix:semicolon
id|add_to_used_ctxlist
c_func
(paren
id|ctxp
)paren
suffix:semicolon
id|mm-&gt;context
op_assign
id|ctxp-&gt;ctx_number
suffix:semicolon
id|ctxp-&gt;ctx_mm
op_assign
id|mm
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ctxp
op_assign
id|ctx_used.next
suffix:semicolon
r_if
c_cond
(paren
id|ctxp-&gt;ctx_mm
op_eq
id|old_mm
)paren
id|ctxp
op_assign
id|ctxp-&gt;next
suffix:semicolon
id|remove_from_ctx_list
c_func
(paren
id|ctxp
)paren
suffix:semicolon
id|add_to_used_ctxlist
c_func
(paren
id|ctxp
)paren
suffix:semicolon
id|ctxp-&gt;ctx_mm-&gt;context
op_assign
id|NO_CONTEXT
suffix:semicolon
id|ctxp-&gt;ctx_mm
op_assign
id|mm
suffix:semicolon
id|mm-&gt;context
op_assign
id|ctxp-&gt;ctx_number
suffix:semicolon
id|sun4c_demap_context_hw
c_func
(paren
op_amp
id|sun4c_context_ring
(braket
id|ctxp-&gt;ctx_number
)braket
comma
id|ctxp-&gt;ctx_number
)paren
suffix:semicolon
)brace
multiline_comment|/* Switch the current MM context. */
DECL|function|sun4c_switch_mm_hw
r_static
r_void
id|sun4c_switch_mm_hw
c_func
(paren
r_struct
id|mm_struct
op_star
id|old_mm
comma
r_struct
id|mm_struct
op_star
id|mm
comma
r_struct
id|task_struct
op_star
id|tsk
comma
r_int
id|cpu
)paren
(brace
r_struct
id|ctx_list
op_star
id|ctx
suffix:semicolon
r_int
id|dirty
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mm-&gt;context
op_eq
id|NO_CONTEXT
)paren
(brace
id|dirty
op_assign
l_int|1
suffix:semicolon
id|sun4c_alloc_context_hw
c_func
(paren
id|old_mm
comma
id|mm
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Update the LRU ring of contexts. */
id|ctx
op_assign
id|ctx_list_pool
op_plus
id|mm-&gt;context
suffix:semicolon
id|remove_from_ctx_list
c_func
(paren
id|ctx
)paren
suffix:semicolon
id|add_to_used_ctxlist
c_func
(paren
id|ctx
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dirty
op_logical_or
id|old_mm
op_ne
id|mm
)paren
id|sun4c_set_context
c_func
(paren
id|mm-&gt;context
)paren
suffix:semicolon
)brace
DECL|function|sun4c_destroy_context_hw
r_static
r_void
id|sun4c_destroy_context_hw
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
r_struct
id|ctx_list
op_star
id|ctx_old
suffix:semicolon
r_if
c_cond
(paren
id|mm-&gt;context
op_ne
id|NO_CONTEXT
)paren
(brace
id|sun4c_demap_context_hw
c_func
(paren
op_amp
id|sun4c_context_ring
(braket
id|mm-&gt;context
)braket
comma
id|mm-&gt;context
)paren
suffix:semicolon
id|ctx_old
op_assign
id|ctx_list_pool
op_plus
id|mm-&gt;context
suffix:semicolon
id|remove_from_ctx_list
c_func
(paren
id|ctx_old
)paren
suffix:semicolon
id|add_to_free_ctxlist
c_func
(paren
id|ctx_old
)paren
suffix:semicolon
id|mm-&gt;context
op_assign
id|NO_CONTEXT
suffix:semicolon
)brace
)brace
DECL|function|sun4c_alloc_context_sw
r_static
r_void
id|sun4c_alloc_context_sw
c_func
(paren
r_struct
id|mm_struct
op_star
id|old_mm
comma
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
r_struct
id|ctx_list
op_star
id|ctxp
suffix:semicolon
id|ctxp
op_assign
id|ctx_free.next
suffix:semicolon
r_if
c_cond
(paren
id|ctxp
op_ne
op_amp
id|ctx_free
)paren
(brace
id|remove_from_ctx_list
c_func
(paren
id|ctxp
)paren
suffix:semicolon
id|add_to_used_ctxlist
c_func
(paren
id|ctxp
)paren
suffix:semicolon
id|mm-&gt;context
op_assign
id|ctxp-&gt;ctx_number
suffix:semicolon
id|ctxp-&gt;ctx_mm
op_assign
id|mm
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ctxp
op_assign
id|ctx_used.next
suffix:semicolon
r_if
c_cond
(paren
id|ctxp-&gt;ctx_mm
op_eq
id|old_mm
)paren
(brace
id|ctxp
op_assign
id|ctxp-&gt;next
suffix:semicolon
)brace
id|remove_from_ctx_list
c_func
(paren
id|ctxp
)paren
suffix:semicolon
id|add_to_used_ctxlist
c_func
(paren
id|ctxp
)paren
suffix:semicolon
id|ctxp-&gt;ctx_mm-&gt;context
op_assign
id|NO_CONTEXT
suffix:semicolon
id|ctxp-&gt;ctx_mm
op_assign
id|mm
suffix:semicolon
id|mm-&gt;context
op_assign
id|ctxp-&gt;ctx_number
suffix:semicolon
id|sun4c_demap_context_sw
c_func
(paren
op_amp
id|sun4c_context_ring
(braket
id|ctxp-&gt;ctx_number
)braket
comma
id|ctxp-&gt;ctx_number
)paren
suffix:semicolon
)brace
multiline_comment|/* Switch the current MM context. */
DECL|function|sun4c_switch_mm_sw
r_static
r_void
id|sun4c_switch_mm_sw
c_func
(paren
r_struct
id|mm_struct
op_star
id|old_mm
comma
r_struct
id|mm_struct
op_star
id|mm
comma
r_struct
id|task_struct
op_star
id|tsk
comma
r_int
id|cpu
)paren
(brace
r_struct
id|ctx_list
op_star
id|ctx
suffix:semicolon
r_int
id|dirty
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mm-&gt;context
op_eq
id|NO_CONTEXT
)paren
(brace
id|dirty
op_assign
l_int|1
suffix:semicolon
id|sun4c_alloc_context_sw
c_func
(paren
id|old_mm
comma
id|mm
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Update the LRU ring of contexts. */
id|ctx
op_assign
id|ctx_list_pool
op_plus
id|mm-&gt;context
suffix:semicolon
id|remove_from_ctx_list
c_func
(paren
id|ctx
)paren
suffix:semicolon
id|add_to_used_ctxlist
c_func
(paren
id|ctx
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dirty
op_logical_or
id|old_mm
op_ne
id|mm
)paren
id|sun4c_set_context
c_func
(paren
id|mm-&gt;context
)paren
suffix:semicolon
)brace
DECL|function|sun4c_destroy_context_sw
r_static
r_void
id|sun4c_destroy_context_sw
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
r_struct
id|ctx_list
op_star
id|ctx_old
suffix:semicolon
r_if
c_cond
(paren
id|mm-&gt;context
op_ne
id|NO_CONTEXT
)paren
(brace
id|sun4c_demap_context_sw
c_func
(paren
op_amp
id|sun4c_context_ring
(braket
id|mm-&gt;context
)braket
comma
id|mm-&gt;context
)paren
suffix:semicolon
id|ctx_old
op_assign
id|ctx_list_pool
op_plus
id|mm-&gt;context
suffix:semicolon
id|remove_from_ctx_list
c_func
(paren
id|ctx_old
)paren
suffix:semicolon
id|add_to_free_ctxlist
c_func
(paren
id|ctx_old
)paren
suffix:semicolon
id|mm-&gt;context
op_assign
id|NO_CONTEXT
suffix:semicolon
)brace
)brace
DECL|function|sun4c_mmu_info
r_static
r_int
id|sun4c_mmu_info
c_func
(paren
r_char
op_star
id|buf
)paren
(brace
r_int
id|used_user_entries
comma
id|i
suffix:semicolon
r_int
id|len
suffix:semicolon
id|used_user_entries
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_contexts
suffix:semicolon
id|i
op_increment
)paren
id|used_user_entries
op_add_assign
id|sun4c_context_ring
(braket
id|i
)braket
dot
id|num_entries
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;vacsize&bslash;t&bslash;t: %d bytes&bslash;n&quot;
l_string|&quot;vachwflush&bslash;t: %s&bslash;n&quot;
l_string|&quot;vaclinesize&bslash;t: %d bytes&bslash;n&quot;
l_string|&quot;mmuctxs&bslash;t&bslash;t: %d&bslash;n&quot;
l_string|&quot;mmupsegs&bslash;t: %d&bslash;n&quot;
l_string|&quot;kernelpsegs&bslash;t: %d&bslash;n&quot;
l_string|&quot;kfreepsegs&bslash;t: %d&bslash;n&quot;
l_string|&quot;usedpsegs&bslash;t: %d&bslash;n&quot;
l_string|&quot;ufreepsegs&bslash;t: %d&bslash;n&quot;
l_string|&quot;user_taken&bslash;t: %d&bslash;n&quot;
l_string|&quot;max_taken&bslash;t: %d&bslash;n&quot;
comma
id|sun4c_vacinfo.num_bytes
comma
(paren
id|sun4c_vacinfo.do_hwflushes
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
)paren
comma
id|sun4c_vacinfo.linesize
comma
id|num_contexts
comma
(paren
id|invalid_segment
op_plus
l_int|1
)paren
comma
id|sun4c_kernel_ring.num_entries
comma
id|sun4c_kfree_ring.num_entries
comma
id|used_user_entries
comma
id|sun4c_ufree_ring.num_entries
comma
id|sun4c_user_taken_entries
comma
id|max_user_taken_entries
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/* Nothing below here should touch the mmu hardware nor the mmu_entry&n; * data structures.&n; */
multiline_comment|/* First the functions which the mid-level code uses to directly&n; * manipulate the software page tables.  Some defines since we are&n; * emulating the i386 page directory layout.&n; */
DECL|macro|PGD_PRESENT
mdefine_line|#define PGD_PRESENT  0x001
DECL|macro|PGD_RW
mdefine_line|#define PGD_RW       0x002
DECL|macro|PGD_USER
mdefine_line|#define PGD_USER     0x004
DECL|macro|PGD_ACCESSED
mdefine_line|#define PGD_ACCESSED 0x020
DECL|macro|PGD_DIRTY
mdefine_line|#define PGD_DIRTY    0x040
DECL|macro|PGD_TABLE
mdefine_line|#define PGD_TABLE    (PGD_PRESENT | PGD_RW | PGD_USER | PGD_ACCESSED | PGD_DIRTY)
DECL|function|sun4c_pte_present
r_static
r_int
id|sun4c_pte_present
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
(paren
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
(paren
id|_SUN4C_PAGE_PRESENT
op_or
id|_SUN4C_PAGE_PRIV
)paren
)paren
op_ne
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|sun4c_pte_clear
r_static
r_void
id|sun4c_pte_clear
c_func
(paren
id|pte_t
op_star
id|ptep
)paren
(brace
op_star
id|ptep
op_assign
id|__pte
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|sun4c_pmd_none
r_static
r_int
id|sun4c_pmd_none
c_func
(paren
id|pmd_t
id|pmd
)paren
(brace
r_return
op_logical_neg
id|pmd_val
c_func
(paren
id|pmd
)paren
suffix:semicolon
)brace
DECL|function|sun4c_pmd_bad
r_static
r_int
id|sun4c_pmd_bad
c_func
(paren
id|pmd_t
id|pmd
)paren
(brace
r_return
(paren
(paren
(paren
id|pmd_val
c_func
(paren
id|pmd
)paren
op_amp
op_complement
id|PAGE_MASK
)paren
op_ne
id|PGD_TABLE
)paren
op_logical_or
(paren
op_logical_neg
id|VALID_PAGE
c_func
(paren
id|virt_to_page
c_func
(paren
id|pmd_val
c_func
(paren
id|pmd
)paren
)paren
)paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|sun4c_pmd_present
r_static
r_int
id|sun4c_pmd_present
c_func
(paren
id|pmd_t
id|pmd
)paren
(brace
r_return
(paren
(paren
id|pmd_val
c_func
(paren
id|pmd
)paren
op_amp
id|PGD_PRESENT
)paren
op_ne
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|sun4c_pmd_clear
r_static
r_void
id|sun4c_pmd_clear
c_func
(paren
id|pmd_t
op_star
id|pmdp
)paren
(brace
op_star
id|pmdp
op_assign
id|__pmd
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|sun4c_pgd_none
r_static
r_int
id|sun4c_pgd_none
c_func
(paren
id|pgd_t
id|pgd
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sun4c_pgd_bad
r_static
r_int
id|sun4c_pgd_bad
c_func
(paren
id|pgd_t
id|pgd
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sun4c_pgd_present
r_static
r_int
id|sun4c_pgd_present
c_func
(paren
id|pgd_t
id|pgd
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|sun4c_pgd_clear
r_static
r_void
id|sun4c_pgd_clear
c_func
(paren
id|pgd_t
op_star
id|pgdp
)paren
(brace
)brace
multiline_comment|/*&n; * The following only work if pte_present() is true.&n; * Undefined behaviour if not..&n; */
DECL|function|sun4c_pte_mkwrite
r_static
id|pte_t
id|sun4c_pte_mkwrite
c_func
(paren
id|pte_t
id|pte
)paren
(brace
id|pte
op_assign
id|__pte
c_func
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_or
id|_SUN4C_PAGE_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
id|_SUN4C_PAGE_MODIFIED
)paren
id|pte
op_assign
id|__pte
c_func
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_or
id|_SUN4C_PAGE_SILENT_WRITE
)paren
suffix:semicolon
r_return
id|pte
suffix:semicolon
)brace
DECL|function|sun4c_pte_mkdirty
r_static
id|pte_t
id|sun4c_pte_mkdirty
c_func
(paren
id|pte_t
id|pte
)paren
(brace
id|pte
op_assign
id|__pte
c_func
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_or
id|_SUN4C_PAGE_MODIFIED
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
id|_SUN4C_PAGE_WRITE
)paren
id|pte
op_assign
id|__pte
c_func
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_or
id|_SUN4C_PAGE_SILENT_WRITE
)paren
suffix:semicolon
r_return
id|pte
suffix:semicolon
)brace
DECL|function|sun4c_pte_mkyoung
r_static
id|pte_t
id|sun4c_pte_mkyoung
c_func
(paren
id|pte_t
id|pte
)paren
(brace
id|pte
op_assign
id|__pte
c_func
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_or
id|_SUN4C_PAGE_ACCESSED
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
id|_SUN4C_PAGE_READ
)paren
id|pte
op_assign
id|__pte
c_func
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_or
id|_SUN4C_PAGE_SILENT_READ
)paren
suffix:semicolon
r_return
id|pte
suffix:semicolon
)brace
multiline_comment|/*&n; * Conversion functions: convert a page and protection to a page entry,&n; * and a page entry and page directory to the page they refer to.&n; */
DECL|function|sun4c_mk_pte
r_static
id|pte_t
id|sun4c_mk_pte
c_func
(paren
r_struct
id|page
op_star
id|page
comma
id|pgprot_t
id|pgprot
)paren
(brace
r_return
id|__pte
c_func
(paren
(paren
id|page
op_minus
id|mem_map
)paren
op_or
id|pgprot_val
c_func
(paren
id|pgprot
)paren
)paren
suffix:semicolon
)brace
DECL|function|sun4c_mk_pte_phys
r_static
id|pte_t
id|sun4c_mk_pte_phys
c_func
(paren
r_int
r_int
id|phys_page
comma
id|pgprot_t
id|pgprot
)paren
(brace
r_return
id|__pte
c_func
(paren
(paren
id|phys_page
op_rshift
id|PAGE_SHIFT
)paren
op_or
id|pgprot_val
c_func
(paren
id|pgprot
)paren
)paren
suffix:semicolon
)brace
DECL|function|sun4c_mk_pte_io
r_static
id|pte_t
id|sun4c_mk_pte_io
c_func
(paren
r_int
r_int
id|page
comma
id|pgprot_t
id|pgprot
comma
r_int
id|space
)paren
(brace
r_return
id|__pte
c_func
(paren
(paren
(paren
id|page
op_minus
id|PAGE_OFFSET
)paren
op_rshift
id|PAGE_SHIFT
)paren
op_or
id|pgprot_val
c_func
(paren
id|pgprot
)paren
)paren
suffix:semicolon
)brace
DECL|function|sun4c_pte_page
r_static
r_struct
id|page
op_star
id|sun4c_pte_page
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
(paren
id|mem_map
op_plus
(paren
r_int
r_int
)paren
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
id|SUN4C_PFN_MASK
)paren
)paren
suffix:semicolon
)brace
DECL|function|sun4c_pmd_page
r_static
r_inline
r_int
r_int
id|sun4c_pmd_page
c_func
(paren
id|pmd_t
id|pmd
)paren
(brace
r_return
(paren
id|pmd_val
c_func
(paren
id|pmd
)paren
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
)brace
DECL|function|sun4c_pgd_page
r_static
r_int
r_int
id|sun4c_pgd_page
c_func
(paren
id|pgd_t
id|pgd
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* to find an entry in a page-table-directory */
DECL|function|sun4c_pgd_offset
r_extern
r_inline
id|pgd_t
op_star
id|sun4c_pgd_offset
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|address
)paren
(brace
r_return
id|mm-&gt;pgd
op_plus
(paren
id|address
op_rshift
id|SUN4C_PGDIR_SHIFT
)paren
suffix:semicolon
)brace
multiline_comment|/* Find an entry in the second-level page table.. */
DECL|function|sun4c_pmd_offset
r_static
id|pmd_t
op_star
id|sun4c_pmd_offset
c_func
(paren
id|pgd_t
op_star
id|dir
comma
r_int
r_int
id|address
)paren
(brace
r_return
(paren
id|pmd_t
op_star
)paren
id|dir
suffix:semicolon
)brace
multiline_comment|/* Find an entry in the third-level page table.. */
DECL|function|sun4c_pte_offset
id|pte_t
op_star
id|sun4c_pte_offset
c_func
(paren
id|pmd_t
op_star
id|dir
comma
r_int
r_int
id|address
)paren
(brace
r_return
(paren
id|pte_t
op_star
)paren
id|sun4c_pmd_page
c_func
(paren
op_star
id|dir
)paren
op_plus
(paren
(paren
id|address
op_rshift
id|PAGE_SHIFT
)paren
op_amp
(paren
id|SUN4C_PTRS_PER_PTE
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Please take special note on the foo_kernel() routines below, our&n; * fast in window fault handler wants to get at the pte&squot;s for vmalloc&n; * area with traps off, therefore they _MUST_ be locked down to prevent&n; * a watchdog from happening.  It only takes 4 pages of pte&squot;s to lock&n; * down the maximum vmalloc space possible on sun4c so we statically&n; * allocate these page table pieces in the kernel image.  Therefore&n; * we should never have to really allocate or free any kernel page&n; * table information.&n; */
multiline_comment|/* Allocate and free page tables. The xxx_kernel() versions are&n; * used to allocate a kernel page table - this turns on ASN bits&n; * if any, and marks the page tables reserved.&n; */
DECL|function|sun4c_pte_free_kernel
r_static
r_void
id|sun4c_pte_free_kernel
c_func
(paren
id|pte_t
op_star
id|pte
)paren
(brace
multiline_comment|/* This should never get called. */
id|panic
c_func
(paren
l_string|&quot;sun4c_pte_free_kernel called, can&squot;t happen...&quot;
)paren
suffix:semicolon
)brace
DECL|function|sun4c_pte_alloc_kernel
r_static
id|pte_t
op_star
id|sun4c_pte_alloc_kernel
c_func
(paren
id|pmd_t
op_star
id|pmd
comma
r_int
r_int
id|address
)paren
(brace
r_if
c_cond
(paren
id|address
op_ge
id|SUN4C_LOCK_VADDR
)paren
r_return
l_int|NULL
suffix:semicolon
id|address
op_assign
(paren
id|address
op_rshift
id|PAGE_SHIFT
)paren
op_amp
(paren
id|SUN4C_PTRS_PER_PTE
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sun4c_pmd_none
c_func
(paren
op_star
id|pmd
)paren
)paren
id|panic
c_func
(paren
l_string|&quot;sun4c_pmd_none for kernel pmd, can&squot;t happen...&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sun4c_pmd_bad
c_func
(paren
op_star
id|pmd
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Bad pmd in pte_alloc_kernel: %08lx&bslash;n&quot;
comma
id|pmd_val
c_func
(paren
op_star
id|pmd
)paren
)paren
suffix:semicolon
op_star
id|pmd
op_assign
id|__pmd
c_func
(paren
id|PGD_TABLE
op_or
(paren
r_int
r_int
)paren
id|BAD_PAGETABLE
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
(paren
id|pte_t
op_star
)paren
id|sun4c_pmd_page
c_func
(paren
op_star
id|pmd
)paren
op_plus
id|address
suffix:semicolon
)brace
DECL|function|sun4c_free_pte_slow
r_static
r_void
id|sun4c_free_pte_slow
c_func
(paren
id|pte_t
op_star
id|pte
)paren
(brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|pte
)paren
suffix:semicolon
)brace
DECL|function|sun4c_free_pgd_slow
r_static
r_void
id|sun4c_free_pgd_slow
c_func
(paren
id|pgd_t
op_star
id|pgd
)paren
(brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|pgd
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * allocating and freeing a pmd is trivial: the 1-entry pmd is&n; * inside the pgd, so has no extra memory associated with it.&n; */
DECL|function|sun4c_pmd_free_kernel
r_static
r_void
id|sun4c_pmd_free_kernel
c_func
(paren
id|pmd_t
op_star
id|pmd
)paren
(brace
)brace
DECL|function|sun4c_pmd_alloc_kernel
r_static
id|pmd_t
op_star
id|sun4c_pmd_alloc_kernel
c_func
(paren
id|pgd_t
op_star
id|pgd
comma
r_int
r_int
id|address
)paren
(brace
r_return
(paren
id|pmd_t
op_star
)paren
id|pgd
suffix:semicolon
)brace
DECL|function|sun4c_get_pgd_fast
r_extern
id|__inline__
id|pgd_t
op_star
id|sun4c_get_pgd_fast
c_func
(paren
r_void
)paren
(brace
r_int
r_int
op_star
id|ret
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|pgd_quicklist
)paren
op_ne
l_int|NULL
)paren
(brace
id|pgd_quicklist
op_assign
(paren
r_int
r_int
op_star
)paren
(paren
op_star
id|ret
)paren
suffix:semicolon
id|ret
(braket
l_int|0
)braket
op_assign
id|ret
(braket
l_int|1
)braket
suffix:semicolon
id|pgtable_cache_size
op_decrement
suffix:semicolon
)brace
r_else
(brace
id|pgd_t
op_star
id|init
suffix:semicolon
id|ret
op_assign
(paren
r_int
r_int
op_star
)paren
id|__get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
id|memset
(paren
id|ret
comma
l_int|0
comma
(paren
id|KERNBASE
op_div
id|SUN4C_PGDIR_SIZE
)paren
op_star
r_sizeof
(paren
id|pgd_t
)paren
)paren
suffix:semicolon
id|init
op_assign
id|sun4c_pgd_offset
c_func
(paren
op_amp
id|init_mm
comma
l_int|0
)paren
suffix:semicolon
id|memcpy
(paren
(paren
(paren
id|pgd_t
op_star
)paren
id|ret
)paren
op_plus
id|USER_PTRS_PER_PGD
comma
id|init
op_plus
id|USER_PTRS_PER_PGD
comma
(paren
id|PTRS_PER_PGD
op_minus
id|USER_PTRS_PER_PGD
)paren
op_star
r_sizeof
(paren
id|pgd_t
)paren
)paren
suffix:semicolon
)brace
r_return
(paren
id|pgd_t
op_star
)paren
id|ret
suffix:semicolon
)brace
DECL|function|sun4c_free_pgd_fast
r_extern
id|__inline__
r_void
id|sun4c_free_pgd_fast
c_func
(paren
id|pgd_t
op_star
id|pgd
)paren
(brace
op_star
(paren
r_int
r_int
op_star
)paren
id|pgd
op_assign
(paren
r_int
r_int
)paren
id|pgd_quicklist
suffix:semicolon
id|pgd_quicklist
op_assign
(paren
r_int
r_int
op_star
)paren
id|pgd
suffix:semicolon
id|pgtable_cache_size
op_increment
suffix:semicolon
)brace
DECL|function|sun4c_get_pte_fast
r_extern
id|__inline__
id|pte_t
op_star
id|sun4c_get_pte_fast
c_func
(paren
r_void
)paren
(brace
r_int
r_int
op_star
id|ret
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
(paren
r_int
r_int
op_star
)paren
id|pte_quicklist
)paren
op_ne
l_int|NULL
)paren
(brace
id|pte_quicklist
op_assign
(paren
r_int
r_int
op_star
)paren
(paren
op_star
id|ret
)paren
suffix:semicolon
id|ret
(braket
l_int|0
)braket
op_assign
id|ret
(braket
l_int|1
)braket
suffix:semicolon
id|pgtable_cache_size
op_decrement
suffix:semicolon
)brace
r_return
(paren
id|pte_t
op_star
)paren
id|ret
suffix:semicolon
)brace
DECL|function|sun4c_free_pte_fast
r_extern
id|__inline__
r_void
id|sun4c_free_pte_fast
c_func
(paren
id|pte_t
op_star
id|pte
)paren
(brace
op_star
(paren
r_int
r_int
op_star
)paren
id|pte
op_assign
(paren
r_int
r_int
)paren
id|pte_quicklist
suffix:semicolon
id|pte_quicklist
op_assign
(paren
r_int
r_int
op_star
)paren
id|pte
suffix:semicolon
id|pgtable_cache_size
op_increment
suffix:semicolon
)brace
DECL|function|sun4c_pte_free
r_static
r_void
id|sun4c_pte_free
c_func
(paren
id|pte_t
op_star
id|pte
)paren
(brace
id|sun4c_free_pte_fast
c_func
(paren
id|pte
)paren
suffix:semicolon
)brace
DECL|function|sun4c_pte_alloc
r_static
id|pte_t
op_star
id|sun4c_pte_alloc
c_func
(paren
id|pmd_t
op_star
id|pmd
comma
r_int
r_int
id|address
)paren
(brace
id|address
op_assign
(paren
id|address
op_rshift
id|PAGE_SHIFT
)paren
op_amp
(paren
id|SUN4C_PTRS_PER_PTE
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sun4c_pmd_none
c_func
(paren
op_star
id|pmd
)paren
)paren
(brace
id|pte_t
op_star
id|page
op_assign
(paren
id|pte_t
op_star
)paren
id|sun4c_get_pte_fast
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|page
)paren
(brace
op_star
id|pmd
op_assign
id|__pmd
c_func
(paren
id|PGD_TABLE
op_or
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
r_return
id|page
op_plus
id|address
suffix:semicolon
)brace
id|page
op_assign
(paren
id|pte_t
op_star
)paren
id|get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sun4c_pmd_none
c_func
(paren
op_star
id|pmd
)paren
)paren
(brace
r_if
c_cond
(paren
id|page
)paren
(brace
op_star
id|pmd
op_assign
id|__pmd
c_func
(paren
id|PGD_TABLE
op_or
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
r_return
id|page
op_plus
id|address
suffix:semicolon
)brace
op_star
id|pmd
op_assign
id|__pmd
c_func
(paren
id|PGD_TABLE
op_or
(paren
r_int
r_int
)paren
id|BAD_PAGETABLE
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sun4c_pmd_bad
c_func
(paren
op_star
id|pmd
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Bad pmd in pte_alloc: %08lx&bslash;n&quot;
comma
id|pmd_val
c_func
(paren
op_star
id|pmd
)paren
)paren
suffix:semicolon
op_star
id|pmd
op_assign
id|__pmd
c_func
(paren
id|PGD_TABLE
op_or
(paren
r_int
r_int
)paren
id|BAD_PAGETABLE
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
(paren
id|pte_t
op_star
)paren
id|sun4c_pmd_page
c_func
(paren
op_star
id|pmd
)paren
op_plus
id|address
suffix:semicolon
)brace
multiline_comment|/*&n; * allocating and freeing a pmd is trivial: the 1-entry pmd is&n; * inside the pgd, so has no extra memory associated with it.&n; */
DECL|function|sun4c_pmd_free
r_static
r_void
id|sun4c_pmd_free
c_func
(paren
id|pmd_t
op_star
id|pmd
)paren
(brace
)brace
DECL|function|sun4c_pmd_alloc
r_static
id|pmd_t
op_star
id|sun4c_pmd_alloc
c_func
(paren
id|pgd_t
op_star
id|pgd
comma
r_int
r_int
id|address
)paren
(brace
r_return
(paren
id|pmd_t
op_star
)paren
id|pgd
suffix:semicolon
)brace
DECL|function|sun4c_pgd_free
r_static
r_void
id|sun4c_pgd_free
c_func
(paren
id|pgd_t
op_star
id|pgd
)paren
(brace
id|sun4c_free_pgd_fast
c_func
(paren
id|pgd
)paren
suffix:semicolon
)brace
DECL|function|sun4c_pgd_alloc
r_static
id|pgd_t
op_star
id|sun4c_pgd_alloc
c_func
(paren
r_void
)paren
(brace
r_return
id|sun4c_get_pgd_fast
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|sun4c_check_pgt_cache
r_static
r_int
id|sun4c_check_pgt_cache
c_func
(paren
r_int
id|low
comma
r_int
id|high
)paren
(brace
r_int
id|freed
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pgtable_cache_size
OG
id|high
)paren
(brace
r_do
(brace
r_if
c_cond
(paren
id|pgd_quicklist
)paren
id|sun4c_free_pgd_slow
c_func
(paren
id|sun4c_get_pgd_fast
c_func
(paren
)paren
)paren
comma
id|freed
op_increment
suffix:semicolon
multiline_comment|/* Only two level page tables at the moment, sun4 3 level mmu is not supported - Anton */
macro_line|#if 0
r_if
c_cond
(paren
id|pmd_quicklist
)paren
id|sun4c_free_pmd_slow
c_func
(paren
id|sun4c_get_pmd_fast
c_func
(paren
)paren
)paren
comma
id|freed
op_increment
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|pte_quicklist
)paren
id|sun4c_free_pte_slow
c_func
(paren
id|sun4c_get_pte_fast
c_func
(paren
)paren
)paren
comma
id|freed
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|pgtable_cache_size
OG
id|low
)paren
suffix:semicolon
)brace
r_return
id|freed
suffix:semicolon
)brace
multiline_comment|/* An experiment, turn off by default for now... -DaveM */
DECL|macro|SUN4C_PRELOAD_PSEG
mdefine_line|#define SUN4C_PRELOAD_PSEG
DECL|function|sun4c_update_mmu_cache
r_void
id|sun4c_update_mmu_cache
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|address
comma
id|pte_t
id|pte
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|pseg
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|address
op_and_assign
id|PAGE_MASK
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pseg
op_assign
id|sun4c_get_segmap
c_func
(paren
id|address
)paren
)paren
op_eq
id|invalid_segment
)paren
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|entry
op_assign
id|sun4c_user_strategy
c_func
(paren
)paren
suffix:semicolon
r_struct
id|mm_struct
op_star
id|mm
op_assign
id|vma-&gt;vm_mm
suffix:semicolon
r_int
r_int
id|start
comma
id|end
suffix:semicolon
id|entry-&gt;vaddr
op_assign
id|start
op_assign
(paren
id|address
op_amp
id|SUN4C_REAL_PGDIR_MASK
)paren
suffix:semicolon
id|entry-&gt;ctx
op_assign
id|mm-&gt;context
suffix:semicolon
id|add_ring_ordered
c_func
(paren
id|sun4c_context_ring
op_plus
id|mm-&gt;context
comma
id|entry
)paren
suffix:semicolon
id|sun4c_put_segmap
c_func
(paren
id|entry-&gt;vaddr
comma
id|entry-&gt;pseg
)paren
suffix:semicolon
id|end
op_assign
id|start
op_plus
id|SUN4C_REAL_PGDIR_SIZE
suffix:semicolon
r_while
c_loop
(paren
id|start
OL
id|end
)paren
(brace
macro_line|#ifdef SUN4C_PRELOAD_PSEG
id|pgd_t
op_star
id|pgdp
op_assign
id|sun4c_pgd_offset
c_func
(paren
id|mm
comma
id|start
)paren
suffix:semicolon
id|pte_t
op_star
id|ptep
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pgdp
)paren
r_goto
id|no_mapping
suffix:semicolon
id|ptep
op_assign
id|sun4c_pte_offset
c_func
(paren
(paren
id|pmd_t
op_star
)paren
id|pgdp
comma
id|start
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ptep
op_logical_or
op_logical_neg
(paren
id|pte_val
c_func
(paren
op_star
id|ptep
)paren
op_amp
id|_SUN4C_PAGE_PRESENT
)paren
)paren
r_goto
id|no_mapping
suffix:semicolon
id|sun4c_put_pte
c_func
(paren
id|start
comma
id|pte_val
c_func
(paren
op_star
id|ptep
)paren
)paren
suffix:semicolon
r_goto
id|next
suffix:semicolon
id|no_mapping
suffix:colon
macro_line|#endif
id|sun4c_put_pte
c_func
(paren
id|start
comma
l_int|0
)paren
suffix:semicolon
macro_line|#ifdef SUN4C_PRELOAD_PSEG
id|next
suffix:colon
macro_line|#endif
id|start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
macro_line|#ifndef SUN4C_PRELOAD_PSEG
id|sun4c_put_pte
c_func
(paren
id|address
comma
id|pte_val
c_func
(paren
id|pte
)paren
)paren
suffix:semicolon
macro_line|#endif
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
(brace
r_struct
id|sun4c_mmu_entry
op_star
id|entry
op_assign
op_amp
id|mmu_entry_pool
(braket
id|pseg
)braket
suffix:semicolon
id|remove_lru
c_func
(paren
id|entry
)paren
suffix:semicolon
id|add_lru
c_func
(paren
id|entry
)paren
suffix:semicolon
)brace
id|sun4c_put_pte
c_func
(paren
id|address
comma
id|pte_val
c_func
(paren
id|pte
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_extern
r_void
id|sparc_context_init
c_func
(paren
r_int
)paren
suffix:semicolon
r_extern
r_int
r_int
id|end
suffix:semicolon
r_extern
r_void
id|bootmem_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_int
r_int
id|last_valid_pfn
suffix:semicolon
r_extern
r_void
id|sun_serial_setup
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|function|sun4c_paging_init
r_void
id|__init
id|sun4c_paging_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|cnt
suffix:semicolon
r_int
r_int
id|kernel_end
comma
id|vaddr
suffix:semicolon
r_extern
r_struct
id|resource
id|sparc_iomap
suffix:semicolon
r_int
r_int
id|end_pfn
suffix:semicolon
id|kernel_end
op_assign
(paren
r_int
r_int
)paren
op_amp
id|end
suffix:semicolon
id|kernel_end
op_add_assign
(paren
id|SUN4C_REAL_PGDIR_SIZE
op_star
l_int|4
)paren
suffix:semicolon
id|kernel_end
op_assign
id|SUN4C_REAL_PGDIR_ALIGN
c_func
(paren
id|kernel_end
)paren
suffix:semicolon
id|bootmem_init
c_func
(paren
)paren
suffix:semicolon
id|end_pfn
op_assign
id|last_valid_pfn
suffix:semicolon
multiline_comment|/* This does not logically belong here, but we need to&n;&t; * call it at the moment we are able to use the bootmem&n;&t; * allocator.&n;&t; */
id|sun_serial_setup
c_func
(paren
)paren
suffix:semicolon
id|sun4c_probe_mmu
c_func
(paren
)paren
suffix:semicolon
id|invalid_segment
op_assign
(paren
id|num_segmaps
op_minus
l_int|1
)paren
suffix:semicolon
id|sun4c_init_mmu_entry_pool
c_func
(paren
)paren
suffix:semicolon
id|sun4c_init_rings
c_func
(paren
)paren
suffix:semicolon
id|sun4c_init_map_kernelprom
c_func
(paren
id|kernel_end
)paren
suffix:semicolon
id|sun4c_init_clean_mmu
c_func
(paren
id|kernel_end
)paren
suffix:semicolon
id|sun4c_init_fill_kernel_ring
c_func
(paren
id|SUN4C_KERNEL_BUCKETS
)paren
suffix:semicolon
id|sun4c_init_lock_area
c_func
(paren
id|sparc_iomap.start
comma
id|IOBASE_END
)paren
suffix:semicolon
id|sun4c_init_lock_area
c_func
(paren
id|DVMA_VADDR
comma
id|DVMA_END
)paren
suffix:semicolon
id|sun4c_init_lock_areas
c_func
(paren
)paren
suffix:semicolon
id|sun4c_init_fill_user_ring
c_func
(paren
)paren
suffix:semicolon
id|sun4c_set_context
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|memset
c_func
(paren
id|swapper_pg_dir
comma
l_int|0
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|memset
c_func
(paren
id|pg0
comma
l_int|0
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|memset
c_func
(paren
id|pg1
comma
l_int|0
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|memset
c_func
(paren
id|pg2
comma
l_int|0
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|memset
c_func
(paren
id|pg3
comma
l_int|0
comma
id|PAGE_SIZE
)paren
suffix:semicolon
multiline_comment|/* Save work later. */
id|vaddr
op_assign
id|VMALLOC_START
suffix:semicolon
id|swapper_pg_dir
(braket
id|vaddr
op_rshift
id|SUN4C_PGDIR_SHIFT
)braket
op_assign
id|__pgd
c_func
(paren
id|PGD_TABLE
op_or
(paren
r_int
r_int
)paren
id|pg0
)paren
suffix:semicolon
id|vaddr
op_add_assign
id|SUN4C_PGDIR_SIZE
suffix:semicolon
id|swapper_pg_dir
(braket
id|vaddr
op_rshift
id|SUN4C_PGDIR_SHIFT
)braket
op_assign
id|__pgd
c_func
(paren
id|PGD_TABLE
op_or
(paren
r_int
r_int
)paren
id|pg1
)paren
suffix:semicolon
id|vaddr
op_add_assign
id|SUN4C_PGDIR_SIZE
suffix:semicolon
id|swapper_pg_dir
(braket
id|vaddr
op_rshift
id|SUN4C_PGDIR_SHIFT
)braket
op_assign
id|__pgd
c_func
(paren
id|PGD_TABLE
op_or
(paren
r_int
r_int
)paren
id|pg2
)paren
suffix:semicolon
id|vaddr
op_add_assign
id|SUN4C_PGDIR_SIZE
suffix:semicolon
id|swapper_pg_dir
(braket
id|vaddr
op_rshift
id|SUN4C_PGDIR_SHIFT
)braket
op_assign
id|__pgd
c_func
(paren
id|PGD_TABLE
op_or
(paren
r_int
r_int
)paren
id|pg3
)paren
suffix:semicolon
id|sun4c_init_ss2_cache_bug
c_func
(paren
)paren
suffix:semicolon
id|sparc_context_init
c_func
(paren
id|num_contexts
)paren
suffix:semicolon
(brace
r_int
r_int
id|zones_size
(braket
id|MAX_NR_ZONES
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|zones_size
(braket
id|ZONE_DMA
)braket
op_assign
id|end_pfn
suffix:semicolon
id|free_area_init
c_func
(paren
id|zones_size
)paren
suffix:semicolon
)brace
id|cnt
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_segmaps
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|mmu_entry_pool
(braket
id|i
)braket
dot
id|locked
)paren
id|cnt
op_increment
suffix:semicolon
id|max_user_taken_entries
op_assign
id|num_segmaps
op_minus
id|cnt
op_minus
l_int|40
op_minus
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SUN4C: %d mmu entries for the kernel&bslash;n&quot;
comma
id|cnt
)paren
suffix:semicolon
)brace
multiline_comment|/* Load up routines and constants for sun4c mmu */
DECL|function|ld_mmu_sun4c
r_void
id|__init
id|ld_mmu_sun4c
c_func
(paren
r_void
)paren
(brace
r_extern
r_void
id|___xchg32_sun4c
c_func
(paren
r_void
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Loading sun4c MMU routines&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* First the constants */
id|BTFIXUPSET_SIMM13
c_func
(paren
id|pmd_shift
comma
id|SUN4C_PMD_SHIFT
)paren
suffix:semicolon
id|BTFIXUPSET_SETHI
c_func
(paren
id|pmd_size
comma
id|SUN4C_PMD_SIZE
)paren
suffix:semicolon
id|BTFIXUPSET_SETHI
c_func
(paren
id|pmd_mask
comma
id|SUN4C_PMD_MASK
)paren
suffix:semicolon
id|BTFIXUPSET_SIMM13
c_func
(paren
id|pgdir_shift
comma
id|SUN4C_PGDIR_SHIFT
)paren
suffix:semicolon
id|BTFIXUPSET_SETHI
c_func
(paren
id|pgdir_size
comma
id|SUN4C_PGDIR_SIZE
)paren
suffix:semicolon
id|BTFIXUPSET_SETHI
c_func
(paren
id|pgdir_mask
comma
id|SUN4C_PGDIR_MASK
)paren
suffix:semicolon
id|BTFIXUPSET_SIMM13
c_func
(paren
id|ptrs_per_pte
comma
id|SUN4C_PTRS_PER_PTE
)paren
suffix:semicolon
id|BTFIXUPSET_SIMM13
c_func
(paren
id|ptrs_per_pmd
comma
id|SUN4C_PTRS_PER_PMD
)paren
suffix:semicolon
id|BTFIXUPSET_SIMM13
c_func
(paren
id|ptrs_per_pgd
comma
id|SUN4C_PTRS_PER_PGD
)paren
suffix:semicolon
id|BTFIXUPSET_SIMM13
c_func
(paren
id|user_ptrs_per_pgd
comma
id|KERNBASE
op_div
id|SUN4C_PGDIR_SIZE
)paren
suffix:semicolon
id|BTFIXUPSET_INT
c_func
(paren
id|page_none
comma
id|pgprot_val
c_func
(paren
id|SUN4C_PAGE_NONE
)paren
)paren
suffix:semicolon
id|BTFIXUPSET_INT
c_func
(paren
id|page_shared
comma
id|pgprot_val
c_func
(paren
id|SUN4C_PAGE_SHARED
)paren
)paren
suffix:semicolon
id|BTFIXUPSET_INT
c_func
(paren
id|page_copy
comma
id|pgprot_val
c_func
(paren
id|SUN4C_PAGE_COPY
)paren
)paren
suffix:semicolon
id|BTFIXUPSET_INT
c_func
(paren
id|page_readonly
comma
id|pgprot_val
c_func
(paren
id|SUN4C_PAGE_READONLY
)paren
)paren
suffix:semicolon
id|BTFIXUPSET_INT
c_func
(paren
id|page_kernel
comma
id|pgprot_val
c_func
(paren
id|SUN4C_PAGE_KERNEL
)paren
)paren
suffix:semicolon
id|page_kernel
op_assign
id|pgprot_val
c_func
(paren
id|SUN4C_PAGE_KERNEL
)paren
suffix:semicolon
id|pg_iobits
op_assign
id|_SUN4C_PAGE_PRESENT
op_or
id|_SUN4C_READABLE
op_or
id|_SUN4C_WRITEABLE
op_or
id|_SUN4C_PAGE_IO
op_or
id|_SUN4C_PAGE_NOCACHE
suffix:semicolon
multiline_comment|/* Functions */
macro_line|#ifndef CONFIG_SMP
id|BTFIXUPSET_CALL
c_func
(paren
id|___xchg32
comma
id|___xchg32_sun4c
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
macro_line|#endif
id|BTFIXUPSET_CALL
c_func
(paren
id|do_check_pgt_cache
comma
id|sun4c_check_pgt_cache
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_all
comma
id|sun4c_flush_cache_all
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sun4c_vacinfo.do_hwflushes
)paren
(brace
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_mm
comma
id|sun4c_flush_cache_mm_hw
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_range
comma
id|sun4c_flush_cache_range_hw
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_page
comma
id|sun4c_flush_cache_page_hw
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|__flush_page_to_ram
comma
id|sun4c_flush_page_to_ram_hw
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_mm
comma
id|sun4c_flush_tlb_mm_hw
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_range
comma
id|sun4c_flush_tlb_range_hw
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_page
comma
id|sun4c_flush_tlb_page_hw
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|free_task_struct
comma
id|sun4c_free_task_struct_hw
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|switch_mm
comma
id|sun4c_switch_mm_hw
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|destroy_context
comma
id|sun4c_destroy_context_hw
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
)brace
r_else
(brace
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_mm
comma
id|sun4c_flush_cache_mm_sw
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_range
comma
id|sun4c_flush_cache_range_sw
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_page
comma
id|sun4c_flush_cache_page_sw
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|__flush_page_to_ram
comma
id|sun4c_flush_page_to_ram_sw
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_mm
comma
id|sun4c_flush_tlb_mm_sw
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_range
comma
id|sun4c_flush_tlb_range_sw
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_page
comma
id|sun4c_flush_tlb_page_sw
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|free_task_struct
comma
id|sun4c_free_task_struct_sw
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|switch_mm
comma
id|sun4c_switch_mm_sw
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|destroy_context
comma
id|sun4c_destroy_context_sw
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
)brace
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_all
comma
id|sun4c_flush_tlb_all
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_sig_insns
comma
id|sun4c_flush_sig_insns
comma
id|BTFIXUPCALL_NOP
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|set_pte
comma
id|sun4c_set_pte
comma
id|BTFIXUPCALL_STO1O0
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pte_page
comma
id|sun4c_pte_page
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
macro_line|#if PAGE_SHIFT &lt;= 12&t;
id|BTFIXUPSET_CALL
c_func
(paren
id|pmd_page
comma
id|sun4c_pmd_page
comma
id|BTFIXUPCALL_ANDNINT
c_func
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
suffix:semicolon
macro_line|#else
id|BTFIXUPSET_CALL
c_func
(paren
id|pmd_page
comma
id|sun4c_pmd_page
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
macro_line|#endif
id|BTFIXUPSET_CALL
c_func
(paren
id|pte_present
comma
id|sun4c_pte_present
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pte_clear
comma
id|sun4c_pte_clear
comma
id|BTFIXUPCALL_STG0O0
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pmd_bad
comma
id|sun4c_pmd_bad
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pmd_present
comma
id|sun4c_pmd_present
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pmd_clear
comma
id|sun4c_pmd_clear
comma
id|BTFIXUPCALL_STG0O0
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pgd_none
comma
id|sun4c_pgd_none
comma
id|BTFIXUPCALL_RETINT
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pgd_bad
comma
id|sun4c_pgd_bad
comma
id|BTFIXUPCALL_RETINT
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pgd_present
comma
id|sun4c_pgd_present
comma
id|BTFIXUPCALL_RETINT
c_func
(paren
l_int|1
)paren
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pgd_clear
comma
id|sun4c_pgd_clear
comma
id|BTFIXUPCALL_NOP
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|mk_pte
comma
id|sun4c_mk_pte
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|mk_pte_phys
comma
id|sun4c_mk_pte_phys
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|mk_pte_io
comma
id|sun4c_mk_pte_io
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_INT
c_func
(paren
id|pte_modify_mask
comma
id|_SUN4C_PAGE_CHG_MASK
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pmd_offset
comma
id|sun4c_pmd_offset
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pte_offset
comma
id|sun4c_pte_offset
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pte_free_kernel
comma
id|sun4c_pte_free_kernel
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pmd_free_kernel
comma
id|sun4c_pmd_free_kernel
comma
id|BTFIXUPCALL_NOP
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pte_alloc_kernel
comma
id|sun4c_pte_alloc_kernel
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pmd_alloc_kernel
comma
id|sun4c_pmd_alloc_kernel
comma
id|BTFIXUPCALL_RETO0
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pte_free
comma
id|sun4c_pte_free
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pte_alloc
comma
id|sun4c_pte_alloc
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pmd_free
comma
id|sun4c_pmd_free
comma
id|BTFIXUPCALL_NOP
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pmd_alloc
comma
id|sun4c_pmd_alloc
comma
id|BTFIXUPCALL_RETO0
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pgd_free
comma
id|sun4c_pgd_free
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pgd_alloc
comma
id|sun4c_pgd_alloc
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_HALF
c_func
(paren
id|pte_writei
comma
id|_SUN4C_PAGE_WRITE
)paren
suffix:semicolon
id|BTFIXUPSET_HALF
c_func
(paren
id|pte_dirtyi
comma
id|_SUN4C_PAGE_MODIFIED
)paren
suffix:semicolon
id|BTFIXUPSET_HALF
c_func
(paren
id|pte_youngi
comma
id|_SUN4C_PAGE_ACCESSED
)paren
suffix:semicolon
id|BTFIXUPSET_HALF
c_func
(paren
id|pte_wrprotecti
comma
id|_SUN4C_PAGE_WRITE
op_or
id|_SUN4C_PAGE_SILENT_WRITE
)paren
suffix:semicolon
id|BTFIXUPSET_HALF
c_func
(paren
id|pte_mkcleani
comma
id|_SUN4C_PAGE_MODIFIED
op_or
id|_SUN4C_PAGE_SILENT_WRITE
)paren
suffix:semicolon
id|BTFIXUPSET_HALF
c_func
(paren
id|pte_mkoldi
comma
id|_SUN4C_PAGE_ACCESSED
op_or
id|_SUN4C_PAGE_SILENT_READ
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pte_mkwrite
comma
id|sun4c_pte_mkwrite
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pte_mkdirty
comma
id|sun4c_pte_mkdirty
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pte_mkyoung
comma
id|sun4c_pte_mkyoung
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|update_mmu_cache
comma
id|sun4c_update_mmu_cache
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|mmu_lockarea
comma
id|sun4c_lockarea
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|mmu_unlockarea
comma
id|sun4c_unlockarea
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|mmu_get_scsi_one
comma
id|sun4c_get_scsi_one
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|mmu_get_scsi_sgl
comma
id|sun4c_get_scsi_sgl
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|mmu_release_scsi_one
comma
id|sun4c_release_scsi_one
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|mmu_release_scsi_sgl
comma
id|sun4c_release_scsi_sgl
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|mmu_map_dma_area
comma
id|sun4c_map_dma_area
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|mmu_unmap_dma_area
comma
id|sun4c_unmap_dma_area
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|mmu_translate_dvma
comma
id|sun4c_translate_dvma
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
multiline_comment|/* Task struct and kernel stack allocating/freeing. */
id|BTFIXUPSET_CALL
c_func
(paren
id|alloc_task_struct
comma
id|sun4c_alloc_task_struct
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|get_task_struct
comma
id|sun4c_get_task_struct
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|mmu_info
comma
id|sun4c_mmu_info
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
multiline_comment|/* These should _never_ get called with two level tables. */
id|BTFIXUPSET_CALL
c_func
(paren
id|pgd_set
comma
id|sun4c_pgd_set
comma
id|BTFIXUPCALL_NOP
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pgd_page
comma
id|sun4c_pgd_page
comma
id|BTFIXUPCALL_RETO0
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pmd_set
comma
id|sun4c_pmd_set
comma
id|BTFIXUPCALL_NOP
)paren
suffix:semicolon
)brace
eof
