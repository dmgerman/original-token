multiline_comment|/* $Id: io-unit.c,v 1.5 1997/12/22 16:09:26 jj Exp $&n; * io-unit.c:  IO-UNIT specific routines for memory management.&n; *&n; * Copyright (C) 1997 Jakub Jelinek    (jj@sunsite.mff.cuni.cz)&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/sbus.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/io-unit.h&gt;
macro_line|#include &lt;asm/mxcc.h&gt;
DECL|macro|LONG_ALIGN
mdefine_line|#define LONG_ALIGN(x) (((x)+(sizeof(long))-1)&amp;~((sizeof(long))-1))
DECL|macro|IOPERM
mdefine_line|#define IOPERM        (IOUPTE_CACHE | IOUPTE_WRITE | IOUPTE_VALID)
DECL|macro|MKIOPTE
mdefine_line|#define MKIOPTE(phys) ((((phys)&gt;&gt;4) &amp; IOUPTE_PAGE) | IOPERM)
DECL|variable|sun4d_dma_base
r_int
r_int
id|sun4d_dma_base
suffix:semicolon
DECL|variable|sun4d_dma_vbase
r_int
r_int
id|sun4d_dma_vbase
suffix:semicolon
DECL|variable|sun4d_dma_size
r_int
r_int
id|sun4d_dma_size
suffix:semicolon
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
r_int
id|iounit_init
c_func
(paren
r_int
id|sbi_node
comma
r_int
id|io_node
comma
r_int
r_int
id|memory_start
comma
r_int
r_int
id|memory_end
comma
r_struct
id|linux_sbus
op_star
id|sbus
)paren
)paren
(brace
id|iopte_t
op_star
id|xpt
comma
op_star
id|xptend
suffix:semicolon
r_int
r_int
id|paddr
suffix:semicolon
r_struct
id|iounit_struct
op_star
id|iounit
suffix:semicolon
r_struct
id|linux_prom_registers
id|iommu_promregs
(braket
id|PROMREG_MAX
)braket
suffix:semicolon
id|memory_start
op_assign
id|LONG_ALIGN
c_func
(paren
id|memory_start
)paren
suffix:semicolon
id|iounit
op_assign
(paren
r_struct
id|iounit_struct
op_star
)paren
id|memory_start
suffix:semicolon
id|memory_start
op_add_assign
r_sizeof
(paren
r_struct
id|iounit_struct
)paren
suffix:semicolon
id|prom_getproperty
c_func
(paren
id|sbi_node
comma
l_string|&quot;reg&quot;
comma
(paren
r_void
op_star
)paren
id|iommu_promregs
comma
r_sizeof
(paren
id|iommu_promregs
)paren
)paren
suffix:semicolon
id|prom_apply_generic_ranges
c_func
(paren
id|io_node
comma
l_int|0
comma
id|iommu_promregs
comma
l_int|3
)paren
suffix:semicolon
id|xpt
op_assign
(paren
id|iopte_t
op_star
)paren
id|sparc_alloc_io
c_func
(paren
id|iommu_promregs
(braket
l_int|2
)braket
dot
id|phys_addr
comma
l_int|0
comma
(paren
id|PAGE_SIZE
op_star
l_int|16
)paren
comma
l_string|&quot;XPT&quot;
comma
id|iommu_promregs
(braket
l_int|2
)braket
dot
id|which_io
comma
l_int|0x0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|xpt
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Cannot map External Page Table.&quot;
)paren
suffix:semicolon
)brace
id|sbus-&gt;iommu
op_assign
(paren
r_struct
id|iommu_struct
op_star
)paren
id|iounit
suffix:semicolon
id|iounit-&gt;page_table
op_assign
id|xpt
suffix:semicolon
multiline_comment|/* Initialize new table. */
id|paddr
op_assign
id|IOUNIT_DMA_BASE
op_minus
id|sun4d_dma_base
suffix:semicolon
r_for
c_loop
(paren
id|xptend
op_assign
id|xpt
op_plus
(paren
id|sun4d_dma_size
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|xpt
OL
id|xptend
suffix:semicolon
id|paddr
op_increment
)paren
op_star
id|xpt
op_increment
op_assign
id|MKIOPTE
c_func
(paren
id|paddr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|xptend
op_assign
id|iounit-&gt;page_table
op_plus
(paren
l_int|16
op_star
id|PAGE_SIZE
)paren
op_div
r_sizeof
(paren
id|iopte_t
)paren
suffix:semicolon
id|xpt
OL
id|xptend
suffix:semicolon
)paren
op_star
id|xpt
op_increment
op_assign
l_int|0
suffix:semicolon
r_return
id|memory_start
suffix:semicolon
)brace
DECL|function|iounit_get_scsi_one
r_static
id|__u32
id|iounit_get_scsi_one
c_func
(paren
r_char
op_star
id|vaddr
comma
r_int
r_int
id|len
comma
r_struct
id|linux_sbus
op_star
id|sbus
)paren
(brace
multiline_comment|/* Viking MXCC is IO coherent, just need to translate the address to DMA handle */
macro_line|#ifdef IOUNIT_DEBUG
r_if
c_cond
(paren
(paren
(paren
(paren
r_int
r_int
)paren
id|vaddr
)paren
op_amp
id|PAGE_MASK
)paren
template_param
id|sun4d_dma_vbase
op_plus
id|sun4d_dma_size
)paren
id|panic
c_func
(paren
l_string|&quot;Using non-DMA memory for iounit_get_scsi_one&quot;
)paren
suffix:semicolon
macro_line|#endif&t;
r_return
(paren
id|__u32
)paren
(paren
id|sun4d_dma_base
op_plus
id|mmu_v2p
c_func
(paren
(paren
r_int
)paren
id|vaddr
)paren
)paren
suffix:semicolon
)brace
DECL|function|iounit_get_scsi_sgl
r_static
r_void
id|iounit_get_scsi_sgl
c_func
(paren
r_struct
id|mmu_sglist
op_star
id|sg
comma
r_int
id|sz
comma
r_struct
id|linux_sbus
op_star
id|sbus
)paren
(brace
multiline_comment|/* Viking MXCC is IO coherent, just need to translate the address to DMA handle */
r_for
c_loop
(paren
suffix:semicolon
id|sz
op_ge
l_int|0
suffix:semicolon
id|sz
op_decrement
)paren
(brace
macro_line|#ifdef IOUNIT_DEBUG
r_int
r_int
id|page
op_assign
(paren
(paren
r_int
r_int
)paren
id|sg
(braket
id|sz
)braket
dot
id|addr
)paren
op_amp
id|PAGE_MASK
suffix:semicolon
r_if
c_cond
(paren
id|page
template_param
id|sun4d_dma_vbase
op_plus
id|sun4d_dma_size
)paren
id|panic
c_func
(paren
l_string|&quot;Using non-DMA memory for iounit_get_scsi_sgl&quot;
)paren
suffix:semicolon
macro_line|#endif&t;
id|sg
(braket
id|sz
)braket
dot
id|dvma_addr
op_assign
(paren
id|__u32
)paren
(paren
id|sun4d_dma_base
op_plus
id|mmu_v2p
c_func
(paren
(paren
r_int
)paren
id|sg
(braket
id|sz
)braket
dot
id|addr
)paren
)paren
suffix:semicolon
suffix:semicolon
)brace
)brace
DECL|function|iounit_release_scsi_one
r_static
r_void
id|iounit_release_scsi_one
c_func
(paren
id|__u32
id|vaddr
comma
r_int
r_int
id|len
comma
r_struct
id|linux_sbus
op_star
id|sbus
)paren
(brace
)brace
DECL|function|iounit_release_scsi_sgl
r_static
r_void
id|iounit_release_scsi_sgl
c_func
(paren
r_struct
id|mmu_sglist
op_star
id|sg
comma
r_int
id|sz
comma
r_struct
id|linux_sbus
op_star
id|sbus
)paren
(brace
)brace
macro_line|#ifdef CONFIG_SBUS
DECL|function|iounit_map_dma_area
r_static
r_void
id|iounit_map_dma_area
c_func
(paren
r_int
r_int
id|addr
comma
r_int
id|len
)paren
(brace
r_int
r_int
id|page
comma
id|end
suffix:semicolon
id|pgprot_t
id|dvma_prot
suffix:semicolon
id|iopte_t
op_star
id|iopte
suffix:semicolon
r_struct
id|linux_sbus
op_star
id|sbus
suffix:semicolon
id|dvma_prot
op_assign
id|__pgprot
c_func
(paren
id|SRMMU_CACHE
op_or
id|SRMMU_ET_PTE
op_or
id|SRMMU_PRIV
)paren
suffix:semicolon
id|end
op_assign
id|PAGE_ALIGN
c_func
(paren
(paren
id|addr
op_plus
id|len
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|addr
OL
id|end
)paren
(brace
id|page
op_assign
id|get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|page
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;alloc_dvma: Cannot get a dvma page&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|pgd_t
op_star
id|pgdp
suffix:semicolon
id|pmd_t
op_star
id|pmdp
suffix:semicolon
id|pte_t
op_star
id|ptep
suffix:semicolon
r_int
id|i
suffix:semicolon
id|pgdp
op_assign
id|pgd_offset
c_func
(paren
id|init_task.mm
comma
id|addr
)paren
suffix:semicolon
id|pmdp
op_assign
id|pmd_offset
c_func
(paren
id|pgdp
comma
id|addr
)paren
suffix:semicolon
id|ptep
op_assign
id|pte_offset
c_func
(paren
id|pmdp
comma
id|addr
)paren
suffix:semicolon
id|set_pte
c_func
(paren
id|ptep
comma
id|pte_val
c_func
(paren
id|mk_pte
c_func
(paren
id|page
comma
id|dvma_prot
)paren
)paren
)paren
suffix:semicolon
id|i
op_assign
(paren
(paren
id|addr
op_minus
id|IOUNIT_DMA_BASE
)paren
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|for_each_sbus
c_func
(paren
id|sbus
)paren
(brace
r_struct
id|iounit_struct
op_star
id|iounit
op_assign
(paren
r_struct
id|iounit_struct
op_star
)paren
id|sbus-&gt;iommu
suffix:semicolon
id|iopte
op_assign
(paren
id|iopte_t
op_star
)paren
(paren
id|iounit-&gt;page_table
op_plus
id|i
)paren
suffix:semicolon
op_star
id|iopte
op_assign
id|__iopte
c_func
(paren
id|MKIOPTE
c_func
(paren
id|mmu_v2p
c_func
(paren
id|page
)paren
)paren
)paren
suffix:semicolon
)brace
)brace
id|addr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
id|flush_cache_all
c_func
(paren
)paren
suffix:semicolon
id|flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|iounit_lockarea
r_static
r_char
op_star
id|iounit_lockarea
c_func
(paren
r_char
op_star
id|vaddr
comma
r_int
r_int
id|len
)paren
(brace
r_return
id|vaddr
suffix:semicolon
)brace
DECL|function|iounit_unlockarea
r_static
r_void
id|iounit_unlockarea
c_func
(paren
r_char
op_star
id|vaddr
comma
r_int
r_int
id|len
)paren
(brace
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|ld_mmu_iounit
c_func
(paren
r_void
)paren
)paren
(brace
id|mmu_lockarea
op_assign
id|iounit_lockarea
suffix:semicolon
id|mmu_unlockarea
op_assign
id|iounit_unlockarea
suffix:semicolon
id|mmu_get_scsi_one
op_assign
id|iounit_get_scsi_one
suffix:semicolon
id|mmu_get_scsi_sgl
op_assign
id|iounit_get_scsi_sgl
suffix:semicolon
id|mmu_release_scsi_one
op_assign
id|iounit_release_scsi_one
suffix:semicolon
id|mmu_release_scsi_sgl
op_assign
id|iounit_release_scsi_sgl
suffix:semicolon
macro_line|#ifdef CONFIG_SBUS
id|mmu_map_dma_area
op_assign
id|iounit_map_dma_area
suffix:semicolon
macro_line|#endif
)brace
eof
