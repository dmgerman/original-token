multiline_comment|/* $Id: srmmu.c,v 1.225 2000/11/30 08:37:31 anton Exp $&n; * srmmu.c:  SRMMU specific routines for memory management.&n; *&n; * Copyright (C) 1995 David S. Miller  (davem@caip.rutgers.edu)&n; * Copyright (C) 1995 Pete Zaitcev&n; * Copyright (C) 1996 Eddie C. Dost    (ecd@skynet.be)&n; * Copyright (C) 1997,1998 Jakub Jelinek (jj@sunsite.mff.cuni.cz)&n; * Copyright (C) 1999,2000 Anton Blanchard (anton@linuxcare.com)&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/pagemap.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgalloc.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/kdebug.h&gt;
macro_line|#include &lt;asm/vaddrs.h&gt;
macro_line|#include &lt;asm/traps.h&gt;
macro_line|#include &lt;asm/smp.h&gt;
macro_line|#include &lt;asm/mbus.h&gt;
macro_line|#include &lt;asm/cache.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/sbus.h&gt;
macro_line|#include &lt;asm/asi.h&gt;
macro_line|#include &lt;asm/msi.h&gt;
macro_line|#include &lt;asm/a.out.h&gt;
macro_line|#include &lt;asm/mmu_context.h&gt;
macro_line|#include &lt;asm/io-unit.h&gt;
multiline_comment|/* Now the cpu specific definitions. */
macro_line|#include &lt;asm/viking.h&gt;
macro_line|#include &lt;asm/mxcc.h&gt;
macro_line|#include &lt;asm/ross.h&gt;
macro_line|#include &lt;asm/tsunami.h&gt;
macro_line|#include &lt;asm/swift.h&gt;
macro_line|#include &lt;asm/turbosparc.h&gt;
macro_line|#include &lt;asm/btfixup.h&gt;
DECL|variable|srmmu_modtype
r_enum
id|mbus_module
id|srmmu_modtype
suffix:semicolon
DECL|variable|hwbug_bitmask
r_int
r_int
id|hwbug_bitmask
suffix:semicolon
DECL|variable|vac_cache_size
r_int
id|vac_cache_size
suffix:semicolon
DECL|variable|vac_line_size
r_int
id|vac_line_size
suffix:semicolon
r_extern
r_struct
id|resource
id|sparc_iomap
suffix:semicolon
r_extern
r_int
r_int
id|last_valid_pfn
suffix:semicolon
r_extern
r_int
r_int
id|page_kernel
suffix:semicolon
DECL|variable|srmmu_swapper_pg_dir
id|pgd_t
op_star
id|srmmu_swapper_pg_dir
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
DECL|macro|FLUSH_BEGIN
mdefine_line|#define FLUSH_BEGIN(mm)
DECL|macro|FLUSH_END
mdefine_line|#define FLUSH_END
macro_line|#else
DECL|macro|FLUSH_BEGIN
mdefine_line|#define FLUSH_BEGIN(mm) if((mm)-&gt;context != NO_CONTEXT) {
DECL|macro|FLUSH_END
mdefine_line|#define FLUSH_END&t;}
macro_line|#endif
id|BTFIXUPDEF_CALL
c_func
(paren
r_void
comma
id|flush_page_for_dma
comma
r_int
r_int
)paren
DECL|macro|flush_page_for_dma
mdefine_line|#define flush_page_for_dma(page) BTFIXUP_CALL(flush_page_for_dma)(page)
DECL|variable|flush_page_for_dma_global
r_int
id|flush_page_for_dma_global
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
id|BTFIXUPDEF_CALL
c_func
(paren
r_void
comma
id|local_flush_page_for_dma
comma
r_int
r_int
)paren
DECL|macro|local_flush_page_for_dma
mdefine_line|#define local_flush_page_for_dma(page) BTFIXUP_CALL(local_flush_page_for_dma)(page)
macro_line|#endif
DECL|variable|srmmu_name
r_char
op_star
id|srmmu_name
suffix:semicolon
DECL|variable|srmmu_ctx_table_phys
id|ctxd_t
op_star
id|srmmu_ctx_table_phys
suffix:semicolon
DECL|variable|srmmu_context_table
id|ctxd_t
op_star
id|srmmu_context_table
suffix:semicolon
DECL|variable|viking_mxcc_present
r_int
id|viking_mxcc_present
suffix:semicolon
DECL|variable|srmmu_context_spinlock
id|spinlock_t
id|srmmu_context_spinlock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|is_hypersparc
r_int
id|is_hypersparc
suffix:semicolon
multiline_comment|/*&n; * In general all page table modifications should use the V8 atomic&n; * swap instruction.  This insures the mmu and the cpu are in sync&n; * with respect to ref/mod bits in the page tables.&n; */
DECL|function|srmmu_swap
r_static
r_inline
r_int
r_int
id|srmmu_swap
c_func
(paren
r_int
r_int
op_star
id|addr
comma
r_int
r_int
id|value
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;swap [%2], %0&quot;
suffix:colon
l_string|&quot;=&amp;r&quot;
(paren
id|value
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|value
)paren
comma
l_string|&quot;r&quot;
(paren
id|addr
)paren
)paren
suffix:semicolon
r_return
id|value
suffix:semicolon
)brace
DECL|function|srmmu_set_pte
r_static
r_inline
r_void
id|srmmu_set_pte
c_func
(paren
id|pte_t
op_star
id|ptep
comma
id|pte_t
id|pteval
)paren
(brace
id|srmmu_swap
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|ptep
comma
id|pte_val
c_func
(paren
id|pteval
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* The very generic SRMMU page table operations. */
DECL|function|srmmu_device_memory
r_static
r_inline
r_int
id|srmmu_device_memory
c_func
(paren
r_int
r_int
id|x
)paren
(brace
r_return
(paren
(paren
id|x
op_amp
l_int|0xF0000000
)paren
op_ne
l_int|0
)paren
suffix:semicolon
)brace
DECL|variable|srmmu_cache_pagetables
r_int
id|srmmu_cache_pagetables
suffix:semicolon
multiline_comment|/* XXX Make this dynamic based on ram size - Anton */
DECL|macro|SRMMU_NOCACHE_BITMAP_SIZE
mdefine_line|#define SRMMU_NOCACHE_BITMAP_SIZE (SRMMU_NOCACHE_NPAGES * 16)
DECL|macro|SRMMU_NOCACHE_BITMAP_SHIFT
mdefine_line|#define SRMMU_NOCACHE_BITMAP_SHIFT (PAGE_SHIFT - 4)
DECL|variable|srmmu_nocache_pool
r_void
op_star
id|srmmu_nocache_pool
suffix:semicolon
DECL|variable|srmmu_nocache_bitmap
r_void
op_star
id|srmmu_nocache_bitmap
suffix:semicolon
DECL|variable|srmmu_nocache_low
r_int
id|srmmu_nocache_low
suffix:semicolon
DECL|variable|srmmu_nocache_used
r_int
id|srmmu_nocache_used
suffix:semicolon
DECL|variable|srmmu_nocache_spinlock
id|spinlock_t
id|srmmu_nocache_spinlock
suffix:semicolon
multiline_comment|/* This makes sense. Honest it does - Anton */
DECL|macro|__nocache_pa
mdefine_line|#define __nocache_pa(VADDR) (((unsigned long)VADDR) - SRMMU_NOCACHE_VADDR + __pa((unsigned long)srmmu_nocache_pool))
DECL|macro|__nocache_va
mdefine_line|#define __nocache_va(PADDR) (__va((unsigned long)PADDR) - (unsigned long)srmmu_nocache_pool + SRMMU_NOCACHE_VADDR)
DECL|macro|__nocache_fix
mdefine_line|#define __nocache_fix(VADDR) __va(__nocache_pa(VADDR))
DECL|function|srmmu_pgd_page
r_static
r_inline
r_int
r_int
id|srmmu_pgd_page
c_func
(paren
id|pgd_t
id|pgd
)paren
(brace
r_return
id|srmmu_device_memory
c_func
(paren
id|pgd_val
c_func
(paren
id|pgd
)paren
)paren
ques
c_cond
op_complement
l_int|0
suffix:colon
(paren
r_int
r_int
)paren
id|__nocache_va
c_func
(paren
(paren
id|pgd_val
c_func
(paren
id|pgd
)paren
op_amp
id|SRMMU_PTD_PMASK
)paren
op_lshift
l_int|4
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pmd_page
r_static
r_inline
r_int
r_int
id|srmmu_pmd_page
c_func
(paren
id|pmd_t
id|pmd
)paren
(brace
r_return
id|srmmu_device_memory
c_func
(paren
id|pmd_val
c_func
(paren
id|pmd
)paren
)paren
ques
c_cond
op_complement
l_int|0
suffix:colon
(paren
r_int
r_int
)paren
id|__nocache_va
c_func
(paren
(paren
id|pmd_val
c_func
(paren
id|pmd
)paren
op_amp
id|SRMMU_PTD_PMASK
)paren
op_lshift
l_int|4
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pte_page
r_static
r_inline
r_struct
id|page
op_star
id|srmmu_pte_page
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
(paren
id|mem_map
op_plus
(paren
r_int
r_int
)paren
(paren
id|srmmu_device_memory
c_func
(paren
id|pte_val
c_func
(paren
id|pte
)paren
)paren
ques
c_cond
op_complement
l_int|0
suffix:colon
(paren
(paren
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
id|SRMMU_PTE_PMASK
)paren
op_lshift
l_int|4
)paren
op_rshift
id|PAGE_SHIFT
)paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pte_none
r_static
r_inline
r_int
id|srmmu_pte_none
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
op_logical_neg
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
l_int|0xFFFFFFF
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pte_present
r_static
r_inline
r_int
id|srmmu_pte_present
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
(paren
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
id|SRMMU_ET_MASK
)paren
op_eq
id|SRMMU_ET_PTE
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pte_clear
r_static
r_inline
r_void
id|srmmu_pte_clear
c_func
(paren
id|pte_t
op_star
id|ptep
)paren
(brace
id|srmmu_set_pte
c_func
(paren
id|ptep
comma
id|__pte
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pmd_none
r_static
r_inline
r_int
id|srmmu_pmd_none
c_func
(paren
id|pmd_t
id|pmd
)paren
(brace
r_return
op_logical_neg
(paren
id|pmd_val
c_func
(paren
id|pmd
)paren
op_amp
l_int|0xFFFFFFF
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pmd_bad
r_static
r_inline
r_int
id|srmmu_pmd_bad
c_func
(paren
id|pmd_t
id|pmd
)paren
(brace
r_return
(paren
id|pmd_val
c_func
(paren
id|pmd
)paren
op_amp
id|SRMMU_ET_MASK
)paren
op_ne
id|SRMMU_ET_PTD
suffix:semicolon
)brace
DECL|function|srmmu_pmd_present
r_static
r_inline
r_int
id|srmmu_pmd_present
c_func
(paren
id|pmd_t
id|pmd
)paren
(brace
r_return
(paren
(paren
id|pmd_val
c_func
(paren
id|pmd
)paren
op_amp
id|SRMMU_ET_MASK
)paren
op_eq
id|SRMMU_ET_PTD
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pmd_clear
r_static
r_inline
r_void
id|srmmu_pmd_clear
c_func
(paren
id|pmd_t
op_star
id|pmdp
)paren
(brace
id|srmmu_set_pte
c_func
(paren
(paren
id|pte_t
op_star
)paren
id|pmdp
comma
id|__pte
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pgd_none
r_static
r_inline
r_int
id|srmmu_pgd_none
c_func
(paren
id|pgd_t
id|pgd
)paren
(brace
r_return
op_logical_neg
(paren
id|pgd_val
c_func
(paren
id|pgd
)paren
op_amp
l_int|0xFFFFFFF
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pgd_bad
r_static
r_inline
r_int
id|srmmu_pgd_bad
c_func
(paren
id|pgd_t
id|pgd
)paren
(brace
r_return
(paren
id|pgd_val
c_func
(paren
id|pgd
)paren
op_amp
id|SRMMU_ET_MASK
)paren
op_ne
id|SRMMU_ET_PTD
suffix:semicolon
)brace
DECL|function|srmmu_pgd_present
r_static
r_inline
r_int
id|srmmu_pgd_present
c_func
(paren
id|pgd_t
id|pgd
)paren
(brace
r_return
(paren
(paren
id|pgd_val
c_func
(paren
id|pgd
)paren
op_amp
id|SRMMU_ET_MASK
)paren
op_eq
id|SRMMU_ET_PTD
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pgd_clear
r_static
r_inline
r_void
id|srmmu_pgd_clear
c_func
(paren
id|pgd_t
op_star
id|pgdp
)paren
(brace
id|srmmu_set_pte
c_func
(paren
(paren
id|pte_t
op_star
)paren
id|pgdp
comma
id|__pte
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pte_write
r_static
r_inline
r_int
id|srmmu_pte_write
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
id|SRMMU_WRITE
suffix:semicolon
)brace
DECL|function|srmmu_pte_dirty
r_static
r_inline
r_int
id|srmmu_pte_dirty
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
id|SRMMU_DIRTY
suffix:semicolon
)brace
DECL|function|srmmu_pte_young
r_static
r_inline
r_int
id|srmmu_pte_young
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
id|SRMMU_REF
suffix:semicolon
)brace
DECL|function|srmmu_pte_wrprotect
r_static
r_inline
id|pte_t
id|srmmu_pte_wrprotect
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
id|__pte
c_func
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
op_complement
id|SRMMU_WRITE
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pte_mkclean
r_static
r_inline
id|pte_t
id|srmmu_pte_mkclean
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
id|__pte
c_func
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
op_complement
id|SRMMU_DIRTY
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pte_mkold
r_static
r_inline
id|pte_t
id|srmmu_pte_mkold
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
id|__pte
c_func
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
op_complement
id|SRMMU_REF
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pte_mkwrite
r_static
r_inline
id|pte_t
id|srmmu_pte_mkwrite
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
id|__pte
c_func
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_or
id|SRMMU_WRITE
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pte_mkdirty
r_static
r_inline
id|pte_t
id|srmmu_pte_mkdirty
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
id|__pte
c_func
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_or
id|SRMMU_DIRTY
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pte_mkyoung
r_static
r_inline
id|pte_t
id|srmmu_pte_mkyoung
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
id|__pte
c_func
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_or
id|SRMMU_REF
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Conversion functions: convert a page and protection to a page entry,&n; * and a page entry and page directory to the page they refer to.&n; */
DECL|function|srmmu_mk_pte
r_static
id|pte_t
id|srmmu_mk_pte
c_func
(paren
r_struct
id|page
op_star
id|page
comma
id|pgprot_t
id|pgprot
)paren
(brace
r_return
id|__pte
c_func
(paren
(paren
(paren
(paren
id|page
op_minus
id|mem_map
)paren
op_lshift
id|PAGE_SHIFT
)paren
op_rshift
l_int|4
)paren
op_or
id|pgprot_val
c_func
(paren
id|pgprot
)paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_mk_pte_phys
r_static
id|pte_t
id|srmmu_mk_pte_phys
c_func
(paren
r_int
r_int
id|page
comma
id|pgprot_t
id|pgprot
)paren
(brace
r_return
id|__pte
c_func
(paren
(paren
(paren
id|page
)paren
op_rshift
l_int|4
)paren
op_or
id|pgprot_val
c_func
(paren
id|pgprot
)paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_mk_pte_io
r_static
id|pte_t
id|srmmu_mk_pte_io
c_func
(paren
r_int
r_int
id|page
comma
id|pgprot_t
id|pgprot
comma
r_int
id|space
)paren
(brace
r_return
id|__pte
c_func
(paren
(paren
(paren
id|page
)paren
op_rshift
l_int|4
)paren
op_or
(paren
id|space
op_lshift
l_int|28
)paren
op_or
id|pgprot_val
c_func
(paren
id|pgprot
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* XXX should we hyper_flush_whole_icache here - Anton */
DECL|function|srmmu_ctxd_set
r_static
r_inline
r_void
id|srmmu_ctxd_set
c_func
(paren
id|ctxd_t
op_star
id|ctxp
comma
id|pgd_t
op_star
id|pgdp
)paren
(brace
id|srmmu_set_pte
c_func
(paren
(paren
id|pte_t
op_star
)paren
id|ctxp
comma
(paren
id|SRMMU_ET_PTD
op_or
(paren
id|__nocache_pa
c_func
(paren
(paren
r_int
r_int
)paren
id|pgdp
)paren
op_rshift
l_int|4
)paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pgd_set
r_static
r_inline
r_void
id|srmmu_pgd_set
c_func
(paren
id|pgd_t
op_star
id|pgdp
comma
id|pmd_t
op_star
id|pmdp
)paren
(brace
id|srmmu_set_pte
c_func
(paren
(paren
id|pte_t
op_star
)paren
id|pgdp
comma
(paren
id|SRMMU_ET_PTD
op_or
(paren
id|__nocache_pa
c_func
(paren
(paren
r_int
r_int
)paren
id|pmdp
)paren
op_rshift
l_int|4
)paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pmd_set
r_static
r_inline
r_void
id|srmmu_pmd_set
c_func
(paren
id|pmd_t
op_star
id|pmdp
comma
id|pte_t
op_star
id|ptep
)paren
(brace
id|srmmu_set_pte
c_func
(paren
(paren
id|pte_t
op_star
)paren
id|pmdp
comma
(paren
id|SRMMU_ET_PTD
op_or
(paren
id|__nocache_pa
c_func
(paren
(paren
r_int
r_int
)paren
id|ptep
)paren
op_rshift
l_int|4
)paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pte_modify
r_static
r_inline
id|pte_t
id|srmmu_pte_modify
c_func
(paren
id|pte_t
id|pte
comma
id|pgprot_t
id|newprot
)paren
(brace
r_return
id|__pte
c_func
(paren
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
id|SRMMU_CHG_MASK
)paren
op_or
id|pgprot_val
c_func
(paren
id|newprot
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* to find an entry in a top-level page table... */
DECL|function|srmmu_pgd_offset
r_extern
r_inline
id|pgd_t
op_star
id|srmmu_pgd_offset
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|address
)paren
(brace
r_return
id|mm-&gt;pgd
op_plus
(paren
id|address
op_rshift
id|SRMMU_PGDIR_SHIFT
)paren
suffix:semicolon
)brace
multiline_comment|/* Find an entry in the second-level page table.. */
DECL|function|srmmu_pmd_offset
r_static
r_inline
id|pmd_t
op_star
id|srmmu_pmd_offset
c_func
(paren
id|pgd_t
op_star
id|dir
comma
r_int
r_int
id|address
)paren
(brace
r_return
(paren
id|pmd_t
op_star
)paren
id|srmmu_pgd_page
c_func
(paren
op_star
id|dir
)paren
op_plus
(paren
(paren
id|address
op_rshift
id|SRMMU_PMD_SHIFT
)paren
op_amp
(paren
id|SRMMU_PTRS_PER_PMD
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Find an entry in the third-level page table.. */
DECL|function|srmmu_pte_offset
r_static
r_inline
id|pte_t
op_star
id|srmmu_pte_offset
c_func
(paren
id|pmd_t
op_star
id|dir
comma
r_int
r_int
id|address
)paren
(brace
r_return
(paren
id|pte_t
op_star
)paren
id|srmmu_pmd_page
c_func
(paren
op_star
id|dir
)paren
op_plus
(paren
(paren
id|address
op_rshift
id|PAGE_SHIFT
)paren
op_amp
(paren
id|SRMMU_PTRS_PER_PTE
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
DECL|function|__srmmu_get_nocache
r_int
r_int
id|__srmmu_get_nocache
c_func
(paren
r_int
id|size
comma
r_int
id|align
)paren
(brace
r_int
id|offset
op_assign
id|srmmu_nocache_low
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|va_tmp
comma
id|phys_tmp
suffix:semicolon
r_int
id|lowest_failed
op_assign
l_int|0
suffix:semicolon
id|size
op_assign
id|size
op_rshift
id|SRMMU_NOCACHE_BITMAP_SHIFT
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|srmmu_nocache_spinlock
)paren
suffix:semicolon
id|repeat
suffix:colon
id|offset
op_assign
id|find_next_zero_bit
c_func
(paren
id|srmmu_nocache_bitmap
comma
id|SRMMU_NOCACHE_BITMAP_SIZE
comma
id|offset
)paren
suffix:semicolon
multiline_comment|/* we align on physical address */
r_if
c_cond
(paren
id|align
)paren
(brace
id|va_tmp
op_assign
(paren
id|SRMMU_NOCACHE_VADDR
op_plus
(paren
id|offset
op_lshift
id|SRMMU_NOCACHE_BITMAP_SHIFT
)paren
)paren
suffix:semicolon
id|phys_tmp
op_assign
(paren
id|__nocache_pa
c_func
(paren
id|va_tmp
)paren
op_plus
id|align
op_minus
l_int|1
)paren
op_amp
op_complement
(paren
id|align
op_minus
l_int|1
)paren
suffix:semicolon
id|va_tmp
op_assign
(paren
r_int
r_int
)paren
id|__nocache_va
c_func
(paren
id|phys_tmp
)paren
suffix:semicolon
id|offset
op_assign
(paren
id|va_tmp
op_minus
id|SRMMU_NOCACHE_VADDR
)paren
op_rshift
id|SRMMU_NOCACHE_BITMAP_SHIFT
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|SRMMU_NOCACHE_BITMAP_SIZE
op_minus
id|offset
)paren
OL
id|size
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Run out of nocached RAM!&bslash;n&quot;
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|srmmu_nocache_spinlock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
id|size
)paren
(brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|offset
op_plus
id|i
comma
id|srmmu_nocache_bitmap
)paren
)paren
(brace
id|lowest_failed
op_assign
l_int|1
suffix:semicolon
id|offset
op_assign
id|offset
op_plus
id|i
op_plus
l_int|1
suffix:semicolon
r_goto
id|repeat
suffix:semicolon
)brace
id|i
op_increment
suffix:semicolon
)brace
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
id|size
)paren
(brace
id|set_bit
c_func
(paren
id|offset
op_plus
id|i
comma
id|srmmu_nocache_bitmap
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
id|srmmu_nocache_used
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|lowest_failed
op_logical_and
(paren
(paren
id|align
op_rshift
id|SRMMU_NOCACHE_BITMAP_SHIFT
)paren
op_le
l_int|1
)paren
op_logical_and
(paren
id|offset
OG
id|srmmu_nocache_low
)paren
)paren
id|srmmu_nocache_low
op_assign
id|offset
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|srmmu_nocache_spinlock
)paren
suffix:semicolon
r_return
(paren
id|SRMMU_NOCACHE_VADDR
op_plus
(paren
id|offset
op_lshift
id|SRMMU_NOCACHE_BITMAP_SHIFT
)paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_get_nocache
r_int
r_inline
r_int
id|srmmu_get_nocache
c_func
(paren
r_int
id|size
comma
r_int
id|align
)paren
(brace
r_int
r_int
id|tmp
suffix:semicolon
id|tmp
op_assign
id|__srmmu_get_nocache
c_func
(paren
id|size
comma
id|align
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
)paren
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|tmp
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
r_return
id|tmp
suffix:semicolon
)brace
DECL|function|srmmu_free_nocache
r_void
id|srmmu_free_nocache
c_func
(paren
r_int
r_int
id|vaddr
comma
r_int
id|size
)paren
(brace
r_int
id|offset
op_assign
(paren
id|vaddr
op_minus
id|SRMMU_NOCACHE_VADDR
)paren
op_rshift
id|SRMMU_NOCACHE_BITMAP_SHIFT
suffix:semicolon
id|size
op_assign
id|size
op_rshift
id|SRMMU_NOCACHE_BITMAP_SHIFT
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|srmmu_nocache_spinlock
)paren
suffix:semicolon
r_while
c_loop
(paren
id|size
op_decrement
)paren
(brace
id|clear_bit
c_func
(paren
id|offset
op_plus
id|size
comma
id|srmmu_nocache_bitmap
)paren
suffix:semicolon
id|srmmu_nocache_used
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|offset
OL
id|srmmu_nocache_low
)paren
id|srmmu_nocache_low
op_assign
id|offset
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|srmmu_nocache_spinlock
)paren
suffix:semicolon
)brace
r_void
id|srmmu_early_allocate_ptable_skeleton
c_func
(paren
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
suffix:semicolon
DECL|function|srmmu_nocache_init
r_void
id|srmmu_nocache_init
c_func
(paren
r_void
)paren
(brace
id|pgd_t
op_star
id|pgd
suffix:semicolon
id|pmd_t
op_star
id|pmd
suffix:semicolon
id|pte_t
op_star
id|pte
suffix:semicolon
r_int
r_int
id|paddr
comma
id|vaddr
suffix:semicolon
r_int
r_int
id|pteval
suffix:semicolon
id|srmmu_nocache_pool
op_assign
id|__alloc_bootmem
c_func
(paren
id|SRMMU_NOCACHE_SIZE
comma
id|PAGE_SIZE
comma
l_int|0UL
)paren
suffix:semicolon
id|memset
c_func
(paren
id|srmmu_nocache_pool
comma
l_int|0
comma
id|SRMMU_NOCACHE_SIZE
)paren
suffix:semicolon
id|srmmu_nocache_bitmap
op_assign
id|__alloc_bootmem
c_func
(paren
id|SRMMU_NOCACHE_BITMAP_SIZE
comma
id|SMP_CACHE_BYTES
comma
l_int|0UL
)paren
suffix:semicolon
id|memset
c_func
(paren
id|srmmu_nocache_bitmap
comma
l_int|0
comma
id|SRMMU_NOCACHE_BITMAP_SIZE
)paren
suffix:semicolon
id|srmmu_swapper_pg_dir
op_assign
(paren
id|pgd_t
op_star
)paren
id|__srmmu_get_nocache
c_func
(paren
id|SRMMU_PGD_TABLE_SIZE
comma
id|SRMMU_PGD_TABLE_SIZE
)paren
suffix:semicolon
id|memset
c_func
(paren
id|__nocache_fix
c_func
(paren
id|srmmu_swapper_pg_dir
)paren
comma
l_int|0
comma
id|SRMMU_PGD_TABLE_SIZE
)paren
suffix:semicolon
id|init_mm.pgd
op_assign
id|srmmu_swapper_pg_dir
suffix:semicolon
id|srmmu_early_allocate_ptable_skeleton
c_func
(paren
id|SRMMU_NOCACHE_VADDR
comma
id|SRMMU_NOCACHE_END
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|srmmu_nocache_spinlock
)paren
suffix:semicolon
id|paddr
op_assign
id|__pa
c_func
(paren
(paren
r_int
r_int
)paren
id|srmmu_nocache_pool
)paren
suffix:semicolon
id|vaddr
op_assign
id|SRMMU_NOCACHE_VADDR
suffix:semicolon
r_while
c_loop
(paren
id|vaddr
OL
id|SRMMU_NOCACHE_END
)paren
(brace
id|pgd
op_assign
id|pgd_offset_k
c_func
(paren
id|vaddr
)paren
suffix:semicolon
id|pmd
op_assign
id|srmmu_pmd_offset
c_func
(paren
id|__nocache_fix
c_func
(paren
id|pgd
)paren
comma
id|vaddr
)paren
suffix:semicolon
id|pte
op_assign
id|srmmu_pte_offset
c_func
(paren
id|__nocache_fix
c_func
(paren
id|pmd
)paren
comma
id|vaddr
)paren
suffix:semicolon
id|pteval
op_assign
(paren
(paren
id|paddr
op_rshift
l_int|4
)paren
op_or
id|SRMMU_ET_PTE
op_or
id|SRMMU_PRIV
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_cache_pagetables
)paren
id|pteval
op_or_assign
id|SRMMU_CACHE
suffix:semicolon
id|srmmu_set_pte
c_func
(paren
id|__nocache_fix
c_func
(paren
id|pte
)paren
comma
id|pteval
)paren
suffix:semicolon
id|vaddr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|paddr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
id|flush_cache_all
c_func
(paren
)paren
suffix:semicolon
id|flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pgd_alloc
r_static
r_inline
id|pgd_t
op_star
id|srmmu_pgd_alloc
c_func
(paren
r_void
)paren
(brace
id|pgd_t
op_star
id|pgd
op_assign
l_int|NULL
suffix:semicolon
id|pgd
op_assign
(paren
id|pgd_t
op_star
)paren
id|__srmmu_get_nocache
c_func
(paren
id|SRMMU_PGD_TABLE_SIZE
comma
id|SRMMU_PGD_TABLE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pgd
)paren
(brace
id|pgd_t
op_star
id|init
op_assign
id|pgd_offset_k
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|memset
c_func
(paren
id|pgd
comma
l_int|0
comma
id|USER_PTRS_PER_PGD
op_star
r_sizeof
(paren
id|pgd_t
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|pgd
op_plus
id|USER_PTRS_PER_PGD
comma
id|init
op_plus
id|USER_PTRS_PER_PGD
comma
(paren
id|PTRS_PER_PGD
op_minus
id|USER_PTRS_PER_PGD
)paren
op_star
r_sizeof
(paren
id|pgd_t
)paren
)paren
suffix:semicolon
)brace
r_return
id|pgd
suffix:semicolon
)brace
DECL|function|srmmu_pgd_free
r_static
r_void
id|srmmu_pgd_free
c_func
(paren
id|pgd_t
op_star
id|pgd
)paren
(brace
id|srmmu_free_nocache
c_func
(paren
(paren
r_int
r_int
)paren
id|pgd
comma
id|SRMMU_PGD_TABLE_SIZE
)paren
suffix:semicolon
)brace
DECL|variable|empty_bad_pmd_table
id|pmd_t
op_star
id|empty_bad_pmd_table
suffix:semicolon
DECL|variable|empty_bad_pte_table
id|pte_t
op_star
id|empty_bad_pte_table
suffix:semicolon
multiline_comment|/*&n; * We init them before every return and make them writable-shared.&n; * This guarantees we get out of the kernel in some more or less sane&n; * way.&n; */
DECL|function|get_bad_pmd_table
r_static
id|pmd_t
op_star
id|get_bad_pmd_table
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PAGE_SIZE
op_div
r_sizeof
(paren
id|pmd_t
)paren
suffix:semicolon
id|i
op_increment
)paren
id|srmmu_pmd_set
c_func
(paren
op_amp
(paren
id|empty_bad_pmd_table
(braket
id|i
)braket
)paren
comma
id|empty_bad_pte_table
)paren
suffix:semicolon
r_return
id|empty_bad_pmd_table
suffix:semicolon
)brace
DECL|function|get_bad_pte_table
r_static
id|pte_t
op_star
id|get_bad_pte_table
c_func
(paren
r_void
)paren
(brace
id|pte_t
id|v
suffix:semicolon
r_int
id|i
suffix:semicolon
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|empty_bad_page
comma
l_int|0
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|v
op_assign
id|srmmu_pte_mkdirty
c_func
(paren
id|srmmu_mk_pte_phys
c_func
(paren
id|__pa
c_func
(paren
op_amp
id|empty_bad_page
)paren
op_plus
id|phys_base
comma
id|PAGE_SHARED
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PAGE_SIZE
op_div
r_sizeof
(paren
id|pte_t
)paren
suffix:semicolon
id|i
op_increment
)paren
id|srmmu_set_pte
c_func
(paren
op_amp
(paren
id|empty_bad_pte_table
(braket
id|i
)braket
)paren
comma
id|v
)paren
suffix:semicolon
r_return
id|empty_bad_pte_table
suffix:semicolon
)brace
DECL|function|__handle_bad_pgd
r_void
id|__handle_bad_pgd
c_func
(paren
id|pgd_t
op_star
id|pgd
)paren
(brace
id|pgd_ERROR
c_func
(paren
op_star
id|pgd
)paren
suffix:semicolon
id|srmmu_pgd_set
c_func
(paren
id|pgd
comma
id|get_bad_pmd_table
c_func
(paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|__handle_bad_pmd
r_void
id|__handle_bad_pmd
c_func
(paren
id|pmd_t
op_star
id|pmd
)paren
(brace
id|pmd_ERROR
c_func
(paren
op_star
id|pmd
)paren
suffix:semicolon
id|srmmu_pmd_set
c_func
(paren
id|pmd
comma
id|get_bad_pte_table
c_func
(paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pte_alloc
r_static
id|pte_t
op_star
id|srmmu_pte_alloc
c_func
(paren
id|pmd_t
op_star
id|pmd
comma
r_int
r_int
id|address
)paren
(brace
id|address
op_assign
(paren
id|address
op_rshift
id|PAGE_SHIFT
)paren
op_amp
(paren
id|SRMMU_PTRS_PER_PTE
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_pmd_none
c_func
(paren
op_star
id|pmd
)paren
)paren
(brace
id|pte_t
op_star
id|page
op_assign
(paren
id|pte_t
op_star
)paren
id|srmmu_get_nocache
c_func
(paren
id|SRMMU_PTE_TABLE_SIZE
comma
id|SRMMU_PTE_TABLE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|page
)paren
(brace
id|srmmu_pmd_set
c_func
(paren
id|pmd
comma
id|page
)paren
suffix:semicolon
r_return
id|page
op_plus
id|address
suffix:semicolon
)brace
id|srmmu_pmd_set
c_func
(paren
id|pmd
comma
id|get_bad_pte_table
c_func
(paren
)paren
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|srmmu_pmd_bad
c_func
(paren
op_star
id|pmd
)paren
)paren
(brace
id|__handle_bad_pmd
c_func
(paren
id|pmd
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
(paren
(paren
id|pte_t
op_star
)paren
id|pmd_page
c_func
(paren
op_star
id|pmd
)paren
)paren
op_plus
id|address
suffix:semicolon
)brace
DECL|function|srmmu_pte_free
r_static
r_inline
r_void
id|srmmu_pte_free
c_func
(paren
id|pte_t
op_star
id|pte
)paren
(brace
id|srmmu_free_nocache
c_func
(paren
(paren
r_int
r_int
)paren
id|pte
comma
id|SRMMU_PTE_TABLE_SIZE
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pmd_alloc
r_static
id|pmd_t
op_star
id|srmmu_pmd_alloc
c_func
(paren
id|pgd_t
op_star
id|pgd
comma
r_int
r_int
id|address
)paren
(brace
id|address
op_assign
(paren
id|address
op_rshift
id|SRMMU_PMD_SHIFT
)paren
op_amp
(paren
id|SRMMU_PTRS_PER_PMD
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_pgd_none
c_func
(paren
op_star
id|pgd
)paren
)paren
(brace
id|pmd_t
op_star
id|page
op_assign
(paren
id|pmd_t
op_star
)paren
id|srmmu_get_nocache
c_func
(paren
id|SRMMU_PMD_TABLE_SIZE
comma
id|SRMMU_PMD_TABLE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|page
)paren
(brace
id|srmmu_pgd_set
c_func
(paren
id|pgd
comma
id|page
)paren
suffix:semicolon
r_return
id|page
op_plus
id|address
suffix:semicolon
)brace
id|srmmu_pgd_set
c_func
(paren
id|pgd
comma
id|get_bad_pmd_table
c_func
(paren
)paren
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|srmmu_pgd_bad
c_func
(paren
op_star
id|pgd
)paren
)paren
(brace
id|__handle_bad_pgd
c_func
(paren
id|pgd
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
(paren
id|pmd_t
op_star
)paren
id|srmmu_pgd_page
c_func
(paren
op_star
id|pgd
)paren
op_plus
id|address
suffix:semicolon
)brace
DECL|function|srmmu_pmd_free
r_static
r_void
id|srmmu_pmd_free
c_func
(paren
id|pmd_t
op_star
id|pmd
)paren
(brace
id|srmmu_free_nocache
c_func
(paren
(paren
r_int
r_int
)paren
id|pmd
comma
id|SRMMU_PMD_TABLE_SIZE
)paren
suffix:semicolon
)brace
DECL|function|alloc_context
r_static
r_inline
r_void
id|alloc_context
c_func
(paren
r_struct
id|mm_struct
op_star
id|old_mm
comma
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
r_struct
id|ctx_list
op_star
id|ctxp
suffix:semicolon
id|ctxp
op_assign
id|ctx_free.next
suffix:semicolon
r_if
c_cond
(paren
id|ctxp
op_ne
op_amp
id|ctx_free
)paren
(brace
id|remove_from_ctx_list
c_func
(paren
id|ctxp
)paren
suffix:semicolon
id|add_to_used_ctxlist
c_func
(paren
id|ctxp
)paren
suffix:semicolon
id|mm-&gt;context
op_assign
id|ctxp-&gt;ctx_number
suffix:semicolon
id|ctxp-&gt;ctx_mm
op_assign
id|mm
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ctxp
op_assign
id|ctx_used.next
suffix:semicolon
r_if
c_cond
(paren
id|ctxp-&gt;ctx_mm
op_eq
id|old_mm
)paren
(brace
id|ctxp
op_assign
id|ctxp-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ctxp
op_eq
op_amp
id|ctx_used
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;out of mmu contexts&quot;
)paren
suffix:semicolon
)brace
id|flush_cache_mm
c_func
(paren
id|ctxp-&gt;ctx_mm
)paren
suffix:semicolon
id|flush_tlb_mm
c_func
(paren
id|ctxp-&gt;ctx_mm
)paren
suffix:semicolon
id|remove_from_ctx_list
c_func
(paren
id|ctxp
)paren
suffix:semicolon
id|add_to_used_ctxlist
c_func
(paren
id|ctxp
)paren
suffix:semicolon
id|ctxp-&gt;ctx_mm-&gt;context
op_assign
id|NO_CONTEXT
suffix:semicolon
id|ctxp-&gt;ctx_mm
op_assign
id|mm
suffix:semicolon
id|mm-&gt;context
op_assign
id|ctxp-&gt;ctx_number
suffix:semicolon
)brace
DECL|function|free_context
r_static
r_inline
r_void
id|free_context
c_func
(paren
r_int
id|context
)paren
(brace
r_struct
id|ctx_list
op_star
id|ctx_old
suffix:semicolon
id|ctx_old
op_assign
id|ctx_list_pool
op_plus
id|context
suffix:semicolon
id|remove_from_ctx_list
c_func
(paren
id|ctx_old
)paren
suffix:semicolon
id|add_to_free_ctxlist
c_func
(paren
id|ctx_old
)paren
suffix:semicolon
)brace
DECL|function|srmmu_switch_mm
r_static
r_void
id|srmmu_switch_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|old_mm
comma
r_struct
id|mm_struct
op_star
id|mm
comma
r_struct
id|task_struct
op_star
id|tsk
comma
r_int
id|cpu
)paren
(brace
r_if
c_cond
(paren
id|mm-&gt;context
op_eq
id|NO_CONTEXT
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|srmmu_context_spinlock
)paren
suffix:semicolon
id|alloc_context
c_func
(paren
id|old_mm
comma
id|mm
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|srmmu_context_spinlock
)paren
suffix:semicolon
id|srmmu_ctxd_set
c_func
(paren
op_amp
id|srmmu_context_table
(braket
id|mm-&gt;context
)braket
comma
id|mm-&gt;pgd
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|is_hypersparc
)paren
id|hyper_flush_whole_icache
c_func
(paren
)paren
suffix:semicolon
id|srmmu_set_context
c_func
(paren
id|mm-&gt;context
)paren
suffix:semicolon
)brace
multiline_comment|/* Low level IO area allocation on the SRMMU. */
DECL|function|srmmu_mapioaddr
r_void
id|srmmu_mapioaddr
c_func
(paren
r_int
r_int
id|physaddr
comma
r_int
r_int
id|virt_addr
comma
r_int
id|bus_type
comma
r_int
id|rdonly
)paren
(brace
id|pgd_t
op_star
id|pgdp
suffix:semicolon
id|pmd_t
op_star
id|pmdp
suffix:semicolon
id|pte_t
op_star
id|ptep
suffix:semicolon
r_int
r_int
id|tmp
suffix:semicolon
id|physaddr
op_and_assign
id|PAGE_MASK
suffix:semicolon
id|pgdp
op_assign
id|pgd_offset_k
c_func
(paren
id|virt_addr
)paren
suffix:semicolon
id|pmdp
op_assign
id|srmmu_pmd_offset
c_func
(paren
id|pgdp
comma
id|virt_addr
)paren
suffix:semicolon
id|ptep
op_assign
id|srmmu_pte_offset
c_func
(paren
id|pmdp
comma
id|virt_addr
)paren
suffix:semicolon
id|tmp
op_assign
(paren
id|physaddr
op_rshift
l_int|4
)paren
op_or
id|SRMMU_ET_PTE
suffix:semicolon
multiline_comment|/*&n;&t; * I need to test whether this is consistent over all&n;&t; * sun4m&squot;s.  The bus_type represents the upper 4 bits of&n;&t; * 36-bit physical address on the I/O space lines...&n;&t; */
id|tmp
op_or_assign
(paren
id|bus_type
op_lshift
l_int|28
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rdonly
)paren
(brace
id|tmp
op_or_assign
id|SRMMU_PRIV_RDONLY
suffix:semicolon
)brace
r_else
id|tmp
op_or_assign
id|SRMMU_PRIV
suffix:semicolon
id|__flush_page_to_ram
c_func
(paren
id|virt_addr
)paren
suffix:semicolon
id|srmmu_set_pte
c_func
(paren
id|ptep
comma
id|__pte
c_func
(paren
id|tmp
)paren
)paren
suffix:semicolon
id|flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_unmapioaddr
r_void
id|srmmu_unmapioaddr
c_func
(paren
r_int
r_int
id|virt_addr
)paren
(brace
id|pgd_t
op_star
id|pgdp
suffix:semicolon
id|pmd_t
op_star
id|pmdp
suffix:semicolon
id|pte_t
op_star
id|ptep
suffix:semicolon
id|pgdp
op_assign
id|pgd_offset_k
c_func
(paren
id|virt_addr
)paren
suffix:semicolon
id|pmdp
op_assign
id|srmmu_pmd_offset
c_func
(paren
id|pgdp
comma
id|virt_addr
)paren
suffix:semicolon
id|ptep
op_assign
id|srmmu_pte_offset
c_func
(paren
id|pmdp
comma
id|virt_addr
)paren
suffix:semicolon
multiline_comment|/* No need to flush uncacheable page. */
id|srmmu_pte_clear
c_func
(paren
id|ptep
)paren
suffix:semicolon
id|flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * On the SRMMU we do not have the problems with limited tlb entries&n; * for mapping kernel pages, so we just take things from the free page&n; * pool.  As a side effect we are putting a little too much pressure&n; * on the gfp() subsystem.  This setup also makes the logic of the&n; * iommu mapping code a lot easier as we can transparently handle&n; * mappings on the kernel stack without any special code as we did&n; * need on the sun4c.&n; */
DECL|function|srmmu_alloc_task_struct
r_struct
id|task_struct
op_star
id|srmmu_alloc_task_struct
c_func
(paren
r_void
)paren
(brace
r_return
(paren
r_struct
id|task_struct
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|srmmu_free_task_struct
r_static
r_void
id|srmmu_free_task_struct
c_func
(paren
r_struct
id|task_struct
op_star
id|tsk
)paren
(brace
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|tsk
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|srmmu_get_task_struct
r_static
r_void
id|srmmu_get_task_struct
c_func
(paren
r_struct
id|task_struct
op_star
id|tsk
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|virt_to_page
c_func
(paren
id|tsk
)paren
op_member_access_from_pointer
id|count
)paren
suffix:semicolon
)brace
multiline_comment|/* tsunami.S */
r_extern
r_void
id|tsunami_flush_cache_all
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|tsunami_flush_cache_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
suffix:semicolon
r_extern
r_void
id|tsunami_flush_cache_range
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
suffix:semicolon
r_extern
r_void
id|tsunami_flush_cache_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
suffix:semicolon
r_extern
r_void
id|tsunami_flush_page_to_ram
c_func
(paren
r_int
r_int
id|page
)paren
suffix:semicolon
r_extern
r_void
id|tsunami_flush_page_for_dma
c_func
(paren
r_int
r_int
id|page
)paren
suffix:semicolon
r_extern
r_void
id|tsunami_flush_sig_insns
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|insn_addr
)paren
suffix:semicolon
r_extern
r_void
id|tsunami_flush_tlb_all
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|tsunami_flush_tlb_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
suffix:semicolon
r_extern
r_void
id|tsunami_flush_tlb_range
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
suffix:semicolon
r_extern
r_void
id|tsunami_flush_tlb_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
suffix:semicolon
r_extern
r_void
id|tsunami_setup_blockops
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/*&n; * Workaround, until we find what&squot;s going on with Swift. When low on memory,&n; * it sometimes loops in fault/handle_mm_fault incl. flush_tlb_page to find&n; * out it is already in page tables/ fault again on the same instruction.&n; * I really don&squot;t understand it, have checked it and contexts&n; * are right, flush_tlb_all is done as well, and it faults again...&n; * Strange. -jj&n; *&n; * The following code is a deadwood that may be necessary when&n; * we start to make precise page flushes again. --zaitcev&n; */
DECL|function|swift_update_mmu_cache
r_static
r_void
id|swift_update_mmu_cache
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|address
comma
id|pte_t
id|pte
)paren
(brace
macro_line|#if 0
r_static
r_int
r_int
id|last
suffix:semicolon
r_int
r_int
id|val
suffix:semicolon
multiline_comment|/* unsigned int n; */
r_if
c_cond
(paren
id|address
op_eq
id|last
)paren
(brace
id|val
op_assign
id|srmmu_hwprobe
c_func
(paren
id|address
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
l_int|0
op_logical_and
id|pte_val
c_func
(paren
id|pte
)paren
op_ne
id|val
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;swift_update_mmu_cache: &quot;
l_string|&quot;addr %lx put %08x probed %08x from %p&bslash;n&quot;
comma
id|address
comma
id|pte_val
c_func
(paren
id|pte
)paren
comma
id|val
comma
id|__builtin_return_address
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
id|srmmu_flush_whole_tlb
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
id|last
op_assign
id|address
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* swift.S */
r_extern
r_void
id|swift_flush_cache_all
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|swift_flush_cache_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
suffix:semicolon
r_extern
r_void
id|swift_flush_cache_range
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
suffix:semicolon
r_extern
r_void
id|swift_flush_cache_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
suffix:semicolon
r_extern
r_void
id|swift_flush_page_to_ram
c_func
(paren
r_int
r_int
id|page
)paren
suffix:semicolon
r_extern
r_void
id|swift_flush_page_for_dma
c_func
(paren
r_int
r_int
id|page
)paren
suffix:semicolon
r_extern
r_void
id|swift_flush_sig_insns
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|insn_addr
)paren
suffix:semicolon
r_extern
r_void
id|swift_flush_tlb_all
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|swift_flush_tlb_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
suffix:semicolon
r_extern
r_void
id|swift_flush_tlb_range
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
suffix:semicolon
r_extern
r_void
id|swift_flush_tlb_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
suffix:semicolon
macro_line|#if 0  /* P3: deadwood to debug precise flushes on Swift. */
r_void
id|swift_flush_tlb_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
(brace
r_int
id|cctx
comma
id|ctx1
suffix:semicolon
id|page
op_and_assign
id|PAGE_MASK
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ctx1
op_assign
id|vma-&gt;vm_mm-&gt;context
)paren
op_ne
op_minus
l_int|1
)paren
(brace
id|cctx
op_assign
id|srmmu_get_context
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Is context # ever different from current context? P3 */
r_if
c_cond
(paren
id|cctx
op_ne
id|ctx1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;flush ctx %02x curr %02x&bslash;n&quot;
comma
id|ctx1
comma
id|cctx
)paren
suffix:semicolon
id|srmmu_set_context
c_func
(paren
id|ctx1
)paren
suffix:semicolon
id|swift_flush_page
c_func
(paren
id|page
)paren
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;sta %%g0, [%0] %1&bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|page
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_FLUSH_PROBE
)paren
)paren
suffix:semicolon
id|srmmu_set_context
c_func
(paren
id|cctx
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Rm. prot. bits from virt. c. */
multiline_comment|/* swift_flush_cache_all(); */
multiline_comment|/* swift_flush_cache_page(vma, page); */
id|swift_flush_page
c_func
(paren
id|page
)paren
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;sta %%g0, [%0] %1&bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|page
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_FLUSH_PROBE
)paren
)paren
suffix:semicolon
multiline_comment|/* same as above: srmmu_flush_tlb_page() */
)brace
)brace
)brace
macro_line|#endif
multiline_comment|/*&n; * The following are all MBUS based SRMMU modules, and therefore could&n; * be found in a multiprocessor configuration.  On the whole, these&n; * chips seems to be much more touchy about DVMA and page tables&n; * with respect to cache coherency.&n; */
multiline_comment|/* Cypress flushes. */
DECL|function|cypress_flush_cache_all
r_static
r_void
id|cypress_flush_cache_all
c_func
(paren
r_void
)paren
(brace
r_volatile
r_int
r_int
id|cypress_sucks
suffix:semicolon
r_int
r_int
id|faddr
comma
id|tagval
suffix:semicolon
id|flush_user_windows
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|faddr
op_assign
l_int|0
suffix:semicolon
id|faddr
OL
l_int|0x10000
suffix:semicolon
id|faddr
op_add_assign
l_int|0x20
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;lda [%1 + %2] %3, %0&bslash;n&bslash;t&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|tagval
)paren
suffix:colon
l_string|&quot;r&quot;
(paren
id|faddr
)paren
comma
l_string|&quot;r&quot;
(paren
l_int|0x40000
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_DATAC_TAG
)paren
)paren
suffix:semicolon
multiline_comment|/* If modified and valid, kick it. */
r_if
c_cond
(paren
(paren
id|tagval
op_amp
l_int|0x60
)paren
op_eq
l_int|0x60
)paren
(brace
id|cypress_sucks
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
(paren
l_int|0xf0020000
op_plus
id|faddr
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|cypress_flush_cache_mm
r_static
r_void
id|cypress_flush_cache_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
r_register
r_int
r_int
id|a
comma
id|b
comma
id|c
comma
id|d
comma
id|e
comma
id|f
comma
id|g
suffix:semicolon
r_int
r_int
id|flags
comma
id|faddr
suffix:semicolon
r_int
id|octx
suffix:semicolon
id|FLUSH_BEGIN
c_func
(paren
id|mm
)paren
id|flush_user_windows
c_func
(paren
)paren
suffix:semicolon
id|__save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|octx
op_assign
id|srmmu_get_context
c_func
(paren
)paren
suffix:semicolon
id|srmmu_set_context
c_func
(paren
id|mm-&gt;context
)paren
suffix:semicolon
id|a
op_assign
l_int|0x20
suffix:semicolon
id|b
op_assign
l_int|0x40
suffix:semicolon
id|c
op_assign
l_int|0x60
suffix:semicolon
id|d
op_assign
l_int|0x80
suffix:semicolon
id|e
op_assign
l_int|0xa0
suffix:semicolon
id|f
op_assign
l_int|0xc0
suffix:semicolon
id|g
op_assign
l_int|0xe0
suffix:semicolon
id|faddr
op_assign
(paren
l_int|0x10000
op_minus
l_int|0x100
)paren
suffix:semicolon
r_goto
id|inside
suffix:semicolon
r_do
(brace
id|faddr
op_sub_assign
l_int|0x100
suffix:semicolon
id|inside
suffix:colon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;sta %%g0, [%0] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %2] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %3] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %4] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %5] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %6] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %7] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %8] %1&bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|faddr
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_FLUSH_CTX
)paren
comma
l_string|&quot;r&quot;
(paren
id|a
)paren
comma
l_string|&quot;r&quot;
(paren
id|b
)paren
comma
l_string|&quot;r&quot;
(paren
id|c
)paren
comma
l_string|&quot;r&quot;
(paren
id|d
)paren
comma
l_string|&quot;r&quot;
(paren
id|e
)paren
comma
l_string|&quot;r&quot;
(paren
id|f
)paren
comma
l_string|&quot;r&quot;
(paren
id|g
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|faddr
)paren
(brace
suffix:semicolon
)brace
id|srmmu_set_context
c_func
(paren
id|octx
)paren
suffix:semicolon
id|__restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|FLUSH_END
)brace
DECL|function|cypress_flush_cache_range
r_static
r_void
id|cypress_flush_cache_range
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
r_register
r_int
r_int
id|a
comma
id|b
comma
id|c
comma
id|d
comma
id|e
comma
id|f
comma
id|g
suffix:semicolon
r_int
r_int
id|flags
comma
id|faddr
suffix:semicolon
r_int
id|octx
suffix:semicolon
id|FLUSH_BEGIN
c_func
(paren
id|mm
)paren
id|flush_user_windows
c_func
(paren
)paren
suffix:semicolon
id|__save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|octx
op_assign
id|srmmu_get_context
c_func
(paren
)paren
suffix:semicolon
id|srmmu_set_context
c_func
(paren
id|mm-&gt;context
)paren
suffix:semicolon
id|a
op_assign
l_int|0x20
suffix:semicolon
id|b
op_assign
l_int|0x40
suffix:semicolon
id|c
op_assign
l_int|0x60
suffix:semicolon
id|d
op_assign
l_int|0x80
suffix:semicolon
id|e
op_assign
l_int|0xa0
suffix:semicolon
id|f
op_assign
l_int|0xc0
suffix:semicolon
id|g
op_assign
l_int|0xe0
suffix:semicolon
id|start
op_and_assign
id|SRMMU_PMD_MASK
suffix:semicolon
r_while
c_loop
(paren
id|start
OL
id|end
)paren
(brace
id|faddr
op_assign
(paren
id|start
op_plus
(paren
l_int|0x10000
op_minus
l_int|0x100
)paren
)paren
suffix:semicolon
r_goto
id|inside
suffix:semicolon
r_do
(brace
id|faddr
op_sub_assign
l_int|0x100
suffix:semicolon
id|inside
suffix:colon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;sta %%g0, [%0] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %2] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %3] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %4] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %5] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %6] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %7] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %8] %1&bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|faddr
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_FLUSH_SEG
)paren
comma
l_string|&quot;r&quot;
(paren
id|a
)paren
comma
l_string|&quot;r&quot;
(paren
id|b
)paren
comma
l_string|&quot;r&quot;
(paren
id|c
)paren
comma
l_string|&quot;r&quot;
(paren
id|d
)paren
comma
l_string|&quot;r&quot;
(paren
id|e
)paren
comma
l_string|&quot;r&quot;
(paren
id|f
)paren
comma
l_string|&quot;r&quot;
(paren
id|g
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|faddr
op_ne
id|start
)paren
suffix:semicolon
id|start
op_add_assign
id|SRMMU_PMD_SIZE
suffix:semicolon
)brace
id|srmmu_set_context
c_func
(paren
id|octx
)paren
suffix:semicolon
id|__restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|FLUSH_END
)brace
DECL|function|cypress_flush_cache_page
r_static
r_void
id|cypress_flush_cache_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
(brace
r_register
r_int
r_int
id|a
comma
id|b
comma
id|c
comma
id|d
comma
id|e
comma
id|f
comma
id|g
suffix:semicolon
r_struct
id|mm_struct
op_star
id|mm
op_assign
id|vma-&gt;vm_mm
suffix:semicolon
r_int
r_int
id|flags
comma
id|line
suffix:semicolon
r_int
id|octx
suffix:semicolon
id|FLUSH_BEGIN
c_func
(paren
id|mm
)paren
id|flush_user_windows
c_func
(paren
)paren
suffix:semicolon
id|__save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|octx
op_assign
id|srmmu_get_context
c_func
(paren
)paren
suffix:semicolon
id|srmmu_set_context
c_func
(paren
id|mm-&gt;context
)paren
suffix:semicolon
id|a
op_assign
l_int|0x20
suffix:semicolon
id|b
op_assign
l_int|0x40
suffix:semicolon
id|c
op_assign
l_int|0x60
suffix:semicolon
id|d
op_assign
l_int|0x80
suffix:semicolon
id|e
op_assign
l_int|0xa0
suffix:semicolon
id|f
op_assign
l_int|0xc0
suffix:semicolon
id|g
op_assign
l_int|0xe0
suffix:semicolon
id|page
op_and_assign
id|PAGE_MASK
suffix:semicolon
id|line
op_assign
(paren
id|page
op_plus
id|PAGE_SIZE
)paren
op_minus
l_int|0x100
suffix:semicolon
r_goto
id|inside
suffix:semicolon
r_do
(brace
id|line
op_sub_assign
l_int|0x100
suffix:semicolon
id|inside
suffix:colon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;sta %%g0, [%0] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %2] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %3] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %4] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %5] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %6] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %7] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %8] %1&bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|line
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_FLUSH_PAGE
)paren
comma
l_string|&quot;r&quot;
(paren
id|a
)paren
comma
l_string|&quot;r&quot;
(paren
id|b
)paren
comma
l_string|&quot;r&quot;
(paren
id|c
)paren
comma
l_string|&quot;r&quot;
(paren
id|d
)paren
comma
l_string|&quot;r&quot;
(paren
id|e
)paren
comma
l_string|&quot;r&quot;
(paren
id|f
)paren
comma
l_string|&quot;r&quot;
(paren
id|g
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|line
op_ne
id|page
)paren
(brace
suffix:semicolon
)brace
id|srmmu_set_context
c_func
(paren
id|octx
)paren
suffix:semicolon
id|__restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|FLUSH_END
)brace
multiline_comment|/* Cypress is copy-back, at least that is how we configure it. */
DECL|function|cypress_flush_page_to_ram
r_static
r_void
id|cypress_flush_page_to_ram
c_func
(paren
r_int
r_int
id|page
)paren
(brace
r_register
r_int
r_int
id|a
comma
id|b
comma
id|c
comma
id|d
comma
id|e
comma
id|f
comma
id|g
suffix:semicolon
r_int
r_int
id|line
suffix:semicolon
id|a
op_assign
l_int|0x20
suffix:semicolon
id|b
op_assign
l_int|0x40
suffix:semicolon
id|c
op_assign
l_int|0x60
suffix:semicolon
id|d
op_assign
l_int|0x80
suffix:semicolon
id|e
op_assign
l_int|0xa0
suffix:semicolon
id|f
op_assign
l_int|0xc0
suffix:semicolon
id|g
op_assign
l_int|0xe0
suffix:semicolon
id|page
op_and_assign
id|PAGE_MASK
suffix:semicolon
id|line
op_assign
(paren
id|page
op_plus
id|PAGE_SIZE
)paren
op_minus
l_int|0x100
suffix:semicolon
r_goto
id|inside
suffix:semicolon
r_do
(brace
id|line
op_sub_assign
l_int|0x100
suffix:semicolon
id|inside
suffix:colon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;sta %%g0, [%0] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %2] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %3] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %4] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %5] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %6] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %7] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %8] %1&bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|line
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_FLUSH_PAGE
)paren
comma
l_string|&quot;r&quot;
(paren
id|a
)paren
comma
l_string|&quot;r&quot;
(paren
id|b
)paren
comma
l_string|&quot;r&quot;
(paren
id|c
)paren
comma
l_string|&quot;r&quot;
(paren
id|d
)paren
comma
l_string|&quot;r&quot;
(paren
id|e
)paren
comma
l_string|&quot;r&quot;
(paren
id|f
)paren
comma
l_string|&quot;r&quot;
(paren
id|g
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|line
op_ne
id|page
)paren
(brace
suffix:semicolon
)brace
)brace
multiline_comment|/* Cypress is also IO cache coherent. */
DECL|function|cypress_flush_page_for_dma
r_static
r_void
id|cypress_flush_page_for_dma
c_func
(paren
r_int
r_int
id|page
)paren
(brace
)brace
multiline_comment|/* Cypress has unified L2 VIPT, from which both instructions and data&n; * are stored.  It does not have an onboard icache of any sort, therefore&n; * no flush is necessary.&n; */
DECL|function|cypress_flush_sig_insns
r_static
r_void
id|cypress_flush_sig_insns
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|insn_addr
)paren
(brace
)brace
DECL|function|cypress_flush_tlb_all
r_static
r_void
id|cypress_flush_tlb_all
c_func
(paren
r_void
)paren
(brace
id|srmmu_flush_whole_tlb
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|cypress_flush_tlb_mm
r_static
r_void
id|cypress_flush_tlb_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
id|FLUSH_BEGIN
c_func
(paren
id|mm
)paren
id|__asm__
id|__volatile__
c_func
(paren
"&quot;"
id|lda
(braket
op_mod
l_int|0
)braket
op_mod
l_int|3
comma
op_mod
op_mod
id|g5
id|sta
op_mod
l_int|2
comma
(braket
op_mod
l_int|0
)braket
op_mod
l_int|3
id|sta
op_mod
op_mod
id|g0
comma
(braket
op_mod
l_int|1
)braket
op_mod
l_int|4
id|sta
op_mod
op_mod
id|g5
comma
(braket
op_mod
l_int|0
)braket
op_mod
l_int|3
"&quot;"
suffix:colon
multiline_comment|/* no outputs */
suffix:colon
l_string|&quot;r&quot;
(paren
id|SRMMU_CTX_REG
)paren
comma
l_string|&quot;r&quot;
(paren
l_int|0x300
)paren
comma
l_string|&quot;r&quot;
(paren
id|mm-&gt;context
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_MMUREGS
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_FLUSH_PROBE
)paren
suffix:colon
l_string|&quot;g5&quot;
)paren
suffix:semicolon
id|FLUSH_END
)brace
DECL|function|cypress_flush_tlb_range
r_static
r_void
id|cypress_flush_tlb_range
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
r_int
r_int
id|size
suffix:semicolon
id|FLUSH_BEGIN
c_func
(paren
id|mm
)paren
id|start
op_and_assign
id|SRMMU_PGDIR_MASK
suffix:semicolon
id|size
op_assign
id|SRMMU_PGDIR_ALIGN
c_func
(paren
id|end
)paren
op_minus
id|start
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
"&quot;"
id|lda
(braket
op_mod
l_int|0
)braket
op_mod
l_int|5
comma
op_mod
op_mod
id|g5
id|sta
op_mod
l_int|1
comma
(braket
op_mod
l_int|0
)braket
op_mod
l_int|5
l_int|1
suffix:colon
id|subcc
op_mod
l_int|3
comma
op_mod
l_int|4
comma
op_mod
l_int|3
id|bne
l_int|1
id|b
id|sta
op_mod
op_mod
id|g0
comma
(braket
op_mod
l_int|2
op_plus
op_mod
l_int|3
)braket
op_mod
l_int|6
id|sta
op_mod
op_mod
id|g5
comma
(braket
op_mod
l_int|0
)braket
op_mod
l_int|5
"&quot;"
suffix:colon
multiline_comment|/* no outputs */
suffix:colon
l_string|&quot;r&quot;
(paren
id|SRMMU_CTX_REG
)paren
comma
l_string|&quot;r&quot;
(paren
id|mm-&gt;context
)paren
comma
l_string|&quot;r&quot;
(paren
id|start
op_or
l_int|0x200
)paren
comma
l_string|&quot;r&quot;
(paren
id|size
)paren
comma
l_string|&quot;r&quot;
(paren
id|SRMMU_PGDIR_SIZE
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_MMUREGS
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_FLUSH_PROBE
)paren
suffix:colon
l_string|&quot;g5&quot;
comma
l_string|&quot;cc&quot;
)paren
suffix:semicolon
id|FLUSH_END
)brace
DECL|function|cypress_flush_tlb_page
r_static
r_void
id|cypress_flush_tlb_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
(brace
r_struct
id|mm_struct
op_star
id|mm
op_assign
id|vma-&gt;vm_mm
suffix:semicolon
id|FLUSH_BEGIN
c_func
(paren
id|mm
)paren
id|__asm__
id|__volatile__
c_func
(paren
"&quot;"
id|lda
(braket
op_mod
l_int|0
)braket
op_mod
l_int|3
comma
op_mod
op_mod
id|g5
id|sta
op_mod
l_int|1
comma
(braket
op_mod
l_int|0
)braket
op_mod
l_int|3
id|sta
op_mod
op_mod
id|g0
comma
(braket
op_mod
l_int|2
)braket
op_mod
l_int|4
id|sta
op_mod
op_mod
id|g5
comma
(braket
op_mod
l_int|0
)braket
op_mod
l_int|3
"&quot;"
suffix:colon
multiline_comment|/* no outputs */
suffix:colon
l_string|&quot;r&quot;
(paren
id|SRMMU_CTX_REG
)paren
comma
l_string|&quot;r&quot;
(paren
id|mm-&gt;context
)paren
comma
l_string|&quot;r&quot;
(paren
id|page
op_amp
id|PAGE_MASK
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_MMUREGS
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_FLUSH_PROBE
)paren
suffix:colon
l_string|&quot;g5&quot;
)paren
suffix:semicolon
id|FLUSH_END
)brace
multiline_comment|/* viking.S */
r_extern
r_void
id|viking_flush_cache_all
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|viking_flush_cache_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
suffix:semicolon
r_extern
r_void
id|viking_flush_cache_range
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
suffix:semicolon
r_extern
r_void
id|viking_flush_cache_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
suffix:semicolon
r_extern
r_void
id|viking_flush_page_to_ram
c_func
(paren
r_int
r_int
id|page
)paren
suffix:semicolon
r_extern
r_void
id|viking_flush_page_for_dma
c_func
(paren
r_int
r_int
id|page
)paren
suffix:semicolon
r_extern
r_void
id|viking_flush_sig_insns
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|addr
)paren
suffix:semicolon
r_extern
r_void
id|viking_flush_page
c_func
(paren
r_int
r_int
id|page
)paren
suffix:semicolon
r_extern
r_void
id|viking_mxcc_flush_page
c_func
(paren
r_int
r_int
id|page
)paren
suffix:semicolon
r_extern
r_void
id|viking_flush_tlb_all
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|viking_flush_tlb_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
suffix:semicolon
r_extern
r_void
id|viking_flush_tlb_range
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
suffix:semicolon
r_extern
r_void
id|viking_flush_tlb_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
suffix:semicolon
r_extern
r_void
id|sun4dsmp_flush_tlb_all
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|sun4dsmp_flush_tlb_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
suffix:semicolon
r_extern
r_void
id|sun4dsmp_flush_tlb_range
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
suffix:semicolon
r_extern
r_void
id|sun4dsmp_flush_tlb_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
suffix:semicolon
multiline_comment|/* hypersparc.S */
r_extern
r_void
id|hypersparc_flush_cache_all
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|hypersparc_flush_cache_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
suffix:semicolon
r_extern
r_void
id|hypersparc_flush_cache_range
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
suffix:semicolon
r_extern
r_void
id|hypersparc_flush_cache_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
suffix:semicolon
r_extern
r_void
id|hypersparc_flush_page_to_ram
c_func
(paren
r_int
r_int
id|page
)paren
suffix:semicolon
r_extern
r_void
id|hypersparc_flush_page_for_dma
c_func
(paren
r_int
r_int
id|page
)paren
suffix:semicolon
r_extern
r_void
id|hypersparc_flush_sig_insns
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|insn_addr
)paren
suffix:semicolon
r_extern
r_void
id|hypersparc_flush_tlb_all
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|hypersparc_flush_tlb_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
suffix:semicolon
r_extern
r_void
id|hypersparc_flush_tlb_range
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
suffix:semicolon
r_extern
r_void
id|hypersparc_flush_tlb_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
suffix:semicolon
r_extern
r_void
id|hypersparc_setup_blockops
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/*&n; * NOTE: All of this startup code assumes the low 16mb (approx.) of&n; *       kernel mappings are done with one single contiguous chunk of&n; *       ram.  On small ram machines (classics mainly) we only get&n; *       around 8mb mapped for us.&n; */
DECL|function|early_pgtable_allocfail
r_void
id|__init
id|early_pgtable_allocfail
c_func
(paren
r_char
op_star
id|type
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;inherit_prom_mappings: Cannot alloc kernel %s.&bslash;n&quot;
comma
id|type
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_early_allocate_ptable_skeleton
r_void
id|__init
id|srmmu_early_allocate_ptable_skeleton
c_func
(paren
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
id|pgd_t
op_star
id|pgdp
suffix:semicolon
id|pmd_t
op_star
id|pmdp
suffix:semicolon
id|pte_t
op_star
id|ptep
suffix:semicolon
r_while
c_loop
(paren
id|start
OL
id|end
)paren
(brace
id|pgdp
op_assign
id|pgd_offset_k
c_func
(paren
id|start
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_pgd_none
c_func
(paren
op_star
(paren
id|pgd_t
op_star
)paren
id|__nocache_fix
c_func
(paren
id|pgdp
)paren
)paren
)paren
(brace
id|pmdp
op_assign
(paren
id|pmd_t
op_star
)paren
id|__srmmu_get_nocache
c_func
(paren
id|SRMMU_PMD_TABLE_SIZE
comma
id|SRMMU_PMD_TABLE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pmdp
op_eq
l_int|NULL
)paren
id|early_pgtable_allocfail
c_func
(paren
l_string|&quot;pmd&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
id|__nocache_fix
c_func
(paren
id|pmdp
)paren
comma
l_int|0
comma
id|SRMMU_PMD_TABLE_SIZE
)paren
suffix:semicolon
id|srmmu_pgd_set
c_func
(paren
id|__nocache_fix
c_func
(paren
id|pgdp
)paren
comma
id|pmdp
)paren
suffix:semicolon
)brace
id|pmdp
op_assign
id|srmmu_pmd_offset
c_func
(paren
id|__nocache_fix
c_func
(paren
id|pgdp
)paren
comma
id|start
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_pmd_none
c_func
(paren
op_star
(paren
id|pmd_t
op_star
)paren
id|__nocache_fix
c_func
(paren
id|pmdp
)paren
)paren
)paren
(brace
id|ptep
op_assign
(paren
id|pte_t
op_star
)paren
id|__srmmu_get_nocache
c_func
(paren
id|SRMMU_PTE_TABLE_SIZE
comma
id|SRMMU_PTE_TABLE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptep
op_eq
l_int|NULL
)paren
id|early_pgtable_allocfail
c_func
(paren
l_string|&quot;pte&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
id|__nocache_fix
c_func
(paren
id|ptep
)paren
comma
l_int|0
comma
id|SRMMU_PTE_TABLE_SIZE
)paren
suffix:semicolon
id|srmmu_pmd_set
c_func
(paren
id|__nocache_fix
c_func
(paren
id|pmdp
)paren
comma
id|ptep
)paren
suffix:semicolon
)brace
id|start
op_assign
(paren
id|start
op_plus
id|SRMMU_PMD_SIZE
)paren
op_amp
id|SRMMU_PMD_MASK
suffix:semicolon
)brace
)brace
DECL|function|srmmu_allocate_ptable_skeleton
r_void
id|__init
id|srmmu_allocate_ptable_skeleton
c_func
(paren
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
id|pgd_t
op_star
id|pgdp
suffix:semicolon
id|pmd_t
op_star
id|pmdp
suffix:semicolon
id|pte_t
op_star
id|ptep
suffix:semicolon
r_while
c_loop
(paren
id|start
OL
id|end
)paren
(brace
id|pgdp
op_assign
id|pgd_offset_k
c_func
(paren
id|start
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_pgd_none
c_func
(paren
op_star
id|pgdp
)paren
)paren
(brace
id|pmdp
op_assign
(paren
id|pmd_t
op_star
)paren
id|__srmmu_get_nocache
c_func
(paren
id|SRMMU_PMD_TABLE_SIZE
comma
id|SRMMU_PMD_TABLE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pmdp
op_eq
l_int|NULL
)paren
id|early_pgtable_allocfail
c_func
(paren
l_string|&quot;pmd&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
id|pmdp
comma
l_int|0
comma
id|SRMMU_PMD_TABLE_SIZE
)paren
suffix:semicolon
id|srmmu_pgd_set
c_func
(paren
id|pgdp
comma
id|pmdp
)paren
suffix:semicolon
)brace
id|pmdp
op_assign
id|srmmu_pmd_offset
c_func
(paren
id|pgdp
comma
id|start
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_pmd_none
c_func
(paren
op_star
id|pmdp
)paren
)paren
(brace
id|ptep
op_assign
(paren
id|pte_t
op_star
)paren
id|__srmmu_get_nocache
c_func
(paren
id|SRMMU_PTE_TABLE_SIZE
comma
id|SRMMU_PTE_TABLE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptep
op_eq
l_int|NULL
)paren
id|early_pgtable_allocfail
c_func
(paren
l_string|&quot;pte&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
id|ptep
comma
l_int|0
comma
id|SRMMU_PTE_TABLE_SIZE
)paren
suffix:semicolon
id|srmmu_pmd_set
c_func
(paren
id|pmdp
comma
id|ptep
)paren
suffix:semicolon
)brace
id|start
op_assign
(paren
id|start
op_plus
id|SRMMU_PMD_SIZE
)paren
op_amp
id|SRMMU_PMD_MASK
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * This is much cleaner than poking around physical address space&n; * looking at the prom&squot;s page table directly which is what most&n; * other OS&squot;s do.  Yuck... this is much better.&n; */
DECL|function|srmmu_inherit_prom_mappings
r_void
id|__init
id|srmmu_inherit_prom_mappings
c_func
(paren
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
id|pgd_t
op_star
id|pgdp
suffix:semicolon
id|pmd_t
op_star
id|pmdp
suffix:semicolon
id|pte_t
op_star
id|ptep
suffix:semicolon
r_int
id|what
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 0 = normal-pte, 1 = pmd-level pte, 2 = pgd-level pte */
r_int
r_int
id|prompte
suffix:semicolon
r_while
c_loop
(paren
id|start
op_le
id|end
)paren
(brace
r_if
c_cond
(paren
id|start
op_eq
l_int|0
)paren
r_break
suffix:semicolon
multiline_comment|/* probably wrap around */
r_if
c_cond
(paren
id|start
op_eq
l_int|0xfef00000
)paren
(brace
id|start
op_assign
id|KADB_DEBUGGER_BEGVM
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|prompte
op_assign
id|srmmu_hwprobe
c_func
(paren
id|start
)paren
)paren
)paren
(brace
id|start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* A red snapper, see what it really is. */
id|what
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|start
op_amp
op_complement
(paren
id|SRMMU_PMD_MASK
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|srmmu_hwprobe
c_func
(paren
(paren
id|start
op_minus
id|PAGE_SIZE
)paren
op_plus
id|SRMMU_PMD_SIZE
)paren
op_eq
id|prompte
)paren
(brace
id|what
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|start
op_amp
op_complement
(paren
id|SRMMU_PGDIR_MASK
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|srmmu_hwprobe
c_func
(paren
(paren
id|start
op_minus
id|PAGE_SIZE
)paren
op_plus
id|SRMMU_PGDIR_SIZE
)paren
op_eq
id|prompte
)paren
(brace
id|what
op_assign
l_int|2
suffix:semicolon
)brace
)brace
id|pgdp
op_assign
id|pgd_offset_k
c_func
(paren
id|start
)paren
suffix:semicolon
r_if
c_cond
(paren
id|what
op_eq
l_int|2
)paren
(brace
op_star
(paren
id|pgd_t
op_star
)paren
id|__nocache_fix
c_func
(paren
id|pgdp
)paren
op_assign
id|__pgd
c_func
(paren
id|prompte
)paren
suffix:semicolon
id|start
op_add_assign
id|SRMMU_PGDIR_SIZE
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|srmmu_pgd_none
c_func
(paren
op_star
(paren
id|pgd_t
op_star
)paren
id|__nocache_fix
c_func
(paren
id|pgdp
)paren
)paren
)paren
(brace
id|pmdp
op_assign
(paren
id|pmd_t
op_star
)paren
id|__srmmu_get_nocache
c_func
(paren
id|SRMMU_PMD_TABLE_SIZE
comma
id|SRMMU_PMD_TABLE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pmdp
op_eq
l_int|NULL
)paren
id|early_pgtable_allocfail
c_func
(paren
l_string|&quot;pmd&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
id|__nocache_fix
c_func
(paren
id|pmdp
)paren
comma
l_int|0
comma
id|SRMMU_PMD_TABLE_SIZE
)paren
suffix:semicolon
id|srmmu_pgd_set
c_func
(paren
id|__nocache_fix
c_func
(paren
id|pgdp
)paren
comma
id|pmdp
)paren
suffix:semicolon
)brace
id|pmdp
op_assign
id|srmmu_pmd_offset
c_func
(paren
id|__nocache_fix
c_func
(paren
id|pgdp
)paren
comma
id|start
)paren
suffix:semicolon
r_if
c_cond
(paren
id|what
op_eq
l_int|1
)paren
(brace
op_star
(paren
id|pmd_t
op_star
)paren
id|__nocache_fix
c_func
(paren
id|pmdp
)paren
op_assign
id|__pmd
c_func
(paren
id|prompte
)paren
suffix:semicolon
id|start
op_add_assign
id|SRMMU_PMD_SIZE
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|srmmu_pmd_none
c_func
(paren
op_star
(paren
id|pmd_t
op_star
)paren
id|__nocache_fix
c_func
(paren
id|pmdp
)paren
)paren
)paren
(brace
id|ptep
op_assign
(paren
id|pte_t
op_star
)paren
id|__srmmu_get_nocache
c_func
(paren
id|SRMMU_PTE_TABLE_SIZE
comma
id|SRMMU_PTE_TABLE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptep
op_eq
l_int|NULL
)paren
id|early_pgtable_allocfail
c_func
(paren
l_string|&quot;pte&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
id|__nocache_fix
c_func
(paren
id|ptep
)paren
comma
l_int|0
comma
id|SRMMU_PTE_TABLE_SIZE
)paren
suffix:semicolon
id|srmmu_pmd_set
c_func
(paren
id|__nocache_fix
c_func
(paren
id|pmdp
)paren
comma
id|ptep
)paren
suffix:semicolon
)brace
id|ptep
op_assign
id|srmmu_pte_offset
c_func
(paren
id|__nocache_fix
c_func
(paren
id|pmdp
)paren
comma
id|start
)paren
suffix:semicolon
op_star
(paren
id|pte_t
op_star
)paren
id|__nocache_fix
c_func
(paren
id|ptep
)paren
op_assign
id|__pte
c_func
(paren
id|prompte
)paren
suffix:semicolon
id|start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
)brace
DECL|macro|KERNEL_PTE
mdefine_line|#define KERNEL_PTE(page_shifted) ((page_shifted)|SRMMU_CACHE|SRMMU_PRIV|SRMMU_VALID)
multiline_comment|/* Create a third-level SRMMU 16MB page mapping. */
DECL|function|do_large_mapping
r_static
r_void
id|__init
id|do_large_mapping
c_func
(paren
r_int
r_int
id|vaddr
comma
r_int
r_int
id|phys_base
)paren
(brace
id|pgd_t
op_star
id|pgdp
op_assign
id|pgd_offset_k
c_func
(paren
id|vaddr
)paren
suffix:semicolon
r_int
r_int
id|big_pte
suffix:semicolon
id|big_pte
op_assign
id|KERNEL_PTE
c_func
(paren
id|phys_base
op_rshift
l_int|4
)paren
suffix:semicolon
op_star
(paren
id|pgd_t
op_star
)paren
id|__nocache_fix
c_func
(paren
id|pgdp
)paren
op_assign
id|__pgd
c_func
(paren
id|big_pte
)paren
suffix:semicolon
)brace
multiline_comment|/* Map sp_bank entry SP_ENTRY, starting at virtual address VBASE. */
DECL|function|map_spbank
r_static
r_int
r_int
id|__init
id|map_spbank
c_func
(paren
r_int
r_int
id|vbase
comma
r_int
id|sp_entry
)paren
(brace
r_int
r_int
id|pstart
op_assign
(paren
id|sp_banks
(braket
id|sp_entry
)braket
dot
id|base_addr
op_amp
id|SRMMU_PGDIR_MASK
)paren
suffix:semicolon
r_int
r_int
id|vstart
op_assign
(paren
id|vbase
op_amp
id|SRMMU_PGDIR_MASK
)paren
suffix:semicolon
r_int
r_int
id|vend
op_assign
id|SRMMU_PGDIR_ALIGN
c_func
(paren
id|vbase
op_plus
id|sp_banks
(braket
id|sp_entry
)braket
dot
id|num_bytes
)paren
suffix:semicolon
r_while
c_loop
(paren
id|vstart
OL
id|vend
)paren
(brace
id|do_large_mapping
c_func
(paren
id|vstart
comma
id|pstart
)paren
suffix:semicolon
id|vstart
op_add_assign
id|SRMMU_PGDIR_SIZE
suffix:semicolon
id|pstart
op_add_assign
id|SRMMU_PGDIR_SIZE
suffix:semicolon
)brace
r_return
id|vstart
suffix:semicolon
)brace
DECL|function|memprobe_error
r_static
r_inline
r_void
id|memprobe_error
c_func
(paren
r_char
op_star
id|msg
)paren
(brace
id|prom_printf
c_func
(paren
id|msg
)paren
suffix:semicolon
id|prom_printf
c_func
(paren
l_string|&quot;Halting now...&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|map_kernel
r_static
r_inline
r_void
id|map_kernel
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|phys_base
OG
l_int|0
)paren
(brace
id|do_large_mapping
c_func
(paren
id|PAGE_OFFSET
comma
id|phys_base
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|sp_banks
(braket
id|i
)braket
dot
id|num_bytes
op_ne
l_int|0
suffix:semicolon
id|i
op_increment
)paren
(brace
id|map_spbank
c_func
(paren
(paren
r_int
r_int
)paren
id|__va
c_func
(paren
id|sp_banks
(braket
id|i
)braket
dot
id|base_addr
)paren
comma
id|i
)paren
suffix:semicolon
)brace
id|init_mm.mmap-&gt;vm_start
op_assign
id|PAGE_OFFSET
suffix:semicolon
id|BTFIXUPSET_SIMM13
c_func
(paren
id|user_ptrs_per_pgd
comma
id|PAGE_OFFSET
op_div
id|SRMMU_PGDIR_SIZE
)paren
suffix:semicolon
)brace
multiline_comment|/* Paging initialization on the Sparc Reference MMU. */
r_extern
r_void
id|sparc_context_init
c_func
(paren
r_int
)paren
suffix:semicolon
r_extern
r_int
id|linux_num_cpus
suffix:semicolon
r_void
(paren
op_star
id|poke_srmmu
)paren
(paren
r_void
)paren
id|__initdata
op_assign
l_int|NULL
suffix:semicolon
r_extern
r_void
id|bootmem_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|sun_serial_setup
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|function|srmmu_paging_init
r_void
id|__init
id|srmmu_paging_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|cpunode
suffix:semicolon
r_char
id|node_str
(braket
l_int|128
)braket
suffix:semicolon
id|pgd_t
op_star
id|pgd
suffix:semicolon
id|pmd_t
op_star
id|pmd
suffix:semicolon
id|pte_t
op_star
id|pte
suffix:semicolon
id|sparc_iomap.start
op_assign
id|SUN4M_IOBASE_VADDR
suffix:semicolon
multiline_comment|/* 16MB of IOSPACE on all sun4m&squot;s. */
r_if
c_cond
(paren
id|sparc_cpu_model
op_eq
id|sun4d
)paren
id|num_contexts
op_assign
l_int|65536
suffix:semicolon
multiline_comment|/* We know it is Viking */
r_else
(brace
multiline_comment|/* Find the number of contexts on the srmmu. */
id|cpunode
op_assign
id|prom_getchild
c_func
(paren
id|prom_root_node
)paren
suffix:semicolon
id|num_contexts
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|cpunode
op_ne
l_int|0
)paren
(brace
id|prom_getstring
c_func
(paren
id|cpunode
comma
l_string|&quot;device_type&quot;
comma
id|node_str
comma
r_sizeof
(paren
id|node_str
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|node_str
comma
l_string|&quot;cpu&quot;
)paren
)paren
(brace
id|num_contexts
op_assign
id|prom_getintdefault
c_func
(paren
id|cpunode
comma
l_string|&quot;mmu-nctx&quot;
comma
l_int|0x8
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|cpunode
op_assign
id|prom_getsibling
c_func
(paren
id|cpunode
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|num_contexts
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;Something wrong, can&squot;t find cpu node in paging_init.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|bootmem_init
c_func
(paren
)paren
suffix:semicolon
id|srmmu_nocache_init
c_func
(paren
)paren
suffix:semicolon
id|srmmu_inherit_prom_mappings
c_func
(paren
l_int|0xfe400000
comma
(paren
id|LINUX_OPPROM_ENDVM
op_minus
id|PAGE_SIZE
)paren
)paren
suffix:semicolon
id|map_kernel
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* ctx table has to be physically aligned to its size */
id|srmmu_context_table
op_assign
(paren
id|ctxd_t
op_star
)paren
id|__srmmu_get_nocache
c_func
(paren
id|num_contexts
op_star
r_sizeof
(paren
id|ctxd_t
)paren
comma
id|num_contexts
op_star
r_sizeof
(paren
id|ctxd_t
)paren
)paren
suffix:semicolon
id|srmmu_ctx_table_phys
op_assign
(paren
id|ctxd_t
op_star
)paren
id|__nocache_pa
c_func
(paren
(paren
r_int
r_int
)paren
id|srmmu_context_table
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_contexts
suffix:semicolon
id|i
op_increment
)paren
(brace
id|srmmu_ctxd_set
c_func
(paren
(paren
id|ctxd_t
op_star
)paren
id|__nocache_fix
c_func
(paren
op_amp
id|srmmu_context_table
(braket
id|i
)braket
)paren
comma
id|srmmu_swapper_pg_dir
)paren
suffix:semicolon
)brace
id|flush_cache_all
c_func
(paren
)paren
suffix:semicolon
id|srmmu_set_ctable_ptr
c_func
(paren
(paren
r_int
r_int
)paren
id|srmmu_ctx_table_phys
)paren
suffix:semicolon
id|flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
id|poke_srmmu
c_func
(paren
)paren
suffix:semicolon
macro_line|#if CONFIG_SUN_IO
id|srmmu_allocate_ptable_skeleton
c_func
(paren
id|sparc_iomap.start
comma
id|IOBASE_END
)paren
suffix:semicolon
id|srmmu_allocate_ptable_skeleton
c_func
(paren
id|DVMA_VADDR
comma
id|DVMA_END
)paren
suffix:semicolon
macro_line|#endif
id|srmmu_allocate_ptable_skeleton
c_func
(paren
id|FIX_KMAP_BEGIN
comma
id|FIX_KMAP_END
)paren
suffix:semicolon
id|srmmu_allocate_ptable_skeleton
c_func
(paren
id|PKMAP_BASE
comma
id|PKMAP_BASE_END
)paren
suffix:semicolon
id|pgd
op_assign
id|pgd_offset_k
c_func
(paren
id|PKMAP_BASE
)paren
suffix:semicolon
id|pmd
op_assign
id|pmd_offset
c_func
(paren
id|pgd
comma
id|PKMAP_BASE
)paren
suffix:semicolon
id|pte
op_assign
id|pte_offset
c_func
(paren
id|pmd
comma
id|PKMAP_BASE
)paren
suffix:semicolon
id|pkmap_page_table
op_assign
id|pte
suffix:semicolon
id|flush_cache_all
c_func
(paren
)paren
suffix:semicolon
id|flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
id|empty_bad_pmd_table
op_assign
(paren
id|pte_t
op_star
)paren
id|srmmu_get_nocache
c_func
(paren
id|SRMMU_PMD_TABLE_SIZE
comma
id|SRMMU_PMD_TABLE_SIZE
)paren
suffix:semicolon
id|empty_bad_pte_table
op_assign
(paren
id|pte_t
op_star
)paren
id|srmmu_get_nocache
c_func
(paren
id|SRMMU_PTE_TABLE_SIZE
comma
id|SRMMU_PTE_TABLE_SIZE
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * This does not logically belong here, but we need to&n;&t; * call it at the moment we are able to use the bootmem&n;&t; * allocator.&n;&t; */
id|sun_serial_setup
c_func
(paren
)paren
suffix:semicolon
id|sparc_context_init
c_func
(paren
id|num_contexts
)paren
suffix:semicolon
id|kmap_init
c_func
(paren
)paren
suffix:semicolon
(brace
r_int
r_int
id|zones_size
(braket
id|MAX_NR_ZONES
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|zones_size
(braket
id|ZONE_DMA
)braket
op_assign
id|max_low_pfn
suffix:semicolon
id|zones_size
(braket
id|ZONE_HIGHMEM
)braket
op_assign
id|highend_pfn
op_minus
id|max_low_pfn
suffix:semicolon
id|free_area_init
c_func
(paren
id|zones_size
)paren
suffix:semicolon
)brace
)brace
DECL|function|srmmu_mmu_info
r_static
r_int
id|srmmu_mmu_info
c_func
(paren
r_char
op_star
id|buf
)paren
(brace
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;MMU type&bslash;t: %s&bslash;n&quot;
l_string|&quot;contexts&bslash;t: %d&bslash;n&quot;
l_string|&quot;nocache total&bslash;t: %ld&bslash;n&quot;
l_string|&quot;nocache used&bslash;t: %d&bslash;n&quot;
comma
id|srmmu_name
comma
id|num_contexts
comma
id|SRMMU_NOCACHE_SIZE
comma
(paren
id|srmmu_nocache_used
op_lshift
id|SRMMU_NOCACHE_BITMAP_SHIFT
)paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_update_mmu_cache
r_static
r_void
id|srmmu_update_mmu_cache
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|address
comma
id|pte_t
id|pte
)paren
(brace
)brace
DECL|function|srmmu_destroy_context
r_static
r_void
id|srmmu_destroy_context
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
r_if
c_cond
(paren
id|mm-&gt;context
op_ne
id|NO_CONTEXT
)paren
(brace
id|flush_cache_mm
c_func
(paren
id|mm
)paren
suffix:semicolon
id|srmmu_ctxd_set
c_func
(paren
op_amp
id|srmmu_context_table
(braket
id|mm-&gt;context
)braket
comma
id|srmmu_swapper_pg_dir
)paren
suffix:semicolon
id|flush_tlb_mm
c_func
(paren
id|mm
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|srmmu_context_spinlock
)paren
suffix:semicolon
id|free_context
c_func
(paren
id|mm-&gt;context
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|srmmu_context_spinlock
)paren
suffix:semicolon
id|mm-&gt;context
op_assign
id|NO_CONTEXT
suffix:semicolon
)brace
)brace
multiline_comment|/* Init various srmmu chip types. */
DECL|function|srmmu_is_bad
r_static
r_void
id|__init
id|srmmu_is_bad
c_func
(paren
r_void
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;Could not determine SRMMU chip type.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|init_vac_layout
r_static
r_void
id|__init
id|init_vac_layout
c_func
(paren
r_void
)paren
(brace
r_int
id|nd
comma
id|cache_lines
suffix:semicolon
r_char
id|node_str
(braket
l_int|128
)braket
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
r_int
id|cpu
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|max_size
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|min_line_size
op_assign
l_int|0x10000000
suffix:semicolon
macro_line|#endif
id|nd
op_assign
id|prom_getchild
c_func
(paren
id|prom_root_node
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|nd
op_assign
id|prom_getsibling
c_func
(paren
id|nd
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|prom_getstring
c_func
(paren
id|nd
comma
l_string|&quot;device_type&quot;
comma
id|node_str
comma
r_sizeof
(paren
id|node_str
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|node_str
comma
l_string|&quot;cpu&quot;
)paren
)paren
(brace
id|vac_line_size
op_assign
id|prom_getint
c_func
(paren
id|nd
comma
l_string|&quot;cache-line-size&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vac_line_size
op_eq
op_minus
l_int|1
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;can&squot;t determine cache-line-size, &quot;
l_string|&quot;halting.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|cache_lines
op_assign
id|prom_getint
c_func
(paren
id|nd
comma
l_string|&quot;cache-nlines&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cache_lines
op_eq
op_minus
l_int|1
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;can&squot;t determine cache-nlines, halting.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|vac_cache_size
op_assign
id|cache_lines
op_star
id|vac_line_size
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
r_if
c_cond
(paren
id|vac_cache_size
OG
id|max_size
)paren
(brace
id|max_size
op_assign
id|vac_cache_size
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vac_line_size
OL
id|min_line_size
)paren
(brace
id|min_line_size
op_assign
id|vac_line_size
suffix:semicolon
)brace
id|cpu
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|cpu
op_eq
id|smp_num_cpus
)paren
(brace
r_break
suffix:semicolon
)brace
macro_line|#else
r_break
suffix:semicolon
macro_line|#endif
)brace
)brace
r_if
c_cond
(paren
id|nd
op_eq
l_int|0
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;No CPU nodes found, halting.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SMP
id|vac_cache_size
op_assign
id|max_size
suffix:semicolon
id|vac_line_size
op_assign
id|min_line_size
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;SRMMU: Using VAC size of %d bytes, line size %d bytes.&bslash;n&quot;
comma
(paren
r_int
)paren
id|vac_cache_size
comma
(paren
r_int
)paren
id|vac_line_size
)paren
suffix:semicolon
)brace
DECL|function|poke_hypersparc
r_static
r_void
id|__init
id|poke_hypersparc
c_func
(paren
r_void
)paren
(brace
r_volatile
r_int
r_int
id|clear
suffix:semicolon
r_int
r_int
id|mreg
op_assign
id|srmmu_get_mmureg
c_func
(paren
)paren
suffix:semicolon
id|hyper_flush_unconditional_combined
c_func
(paren
)paren
suffix:semicolon
id|mreg
op_and_assign
op_complement
(paren
id|HYPERSPARC_CWENABLE
)paren
suffix:semicolon
id|mreg
op_or_assign
(paren
id|HYPERSPARC_CENABLE
op_or
id|HYPERSPARC_WBENABLE
)paren
suffix:semicolon
id|mreg
op_or_assign
(paren
id|HYPERSPARC_CMODE
)paren
suffix:semicolon
id|srmmu_set_mmureg
c_func
(paren
id|mreg
)paren
suffix:semicolon
macro_line|#if 0 /* XXX I think this is bad news... -DaveM */
id|hyper_clear_all_tags
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|put_ross_icr
c_func
(paren
id|HYPERSPARC_ICCR_FTD
op_or
id|HYPERSPARC_ICCR_ICE
)paren
suffix:semicolon
id|hyper_flush_whole_icache
c_func
(paren
)paren
suffix:semicolon
id|clear
op_assign
id|srmmu_get_faddr
c_func
(paren
)paren
suffix:semicolon
id|clear
op_assign
id|srmmu_get_fstatus
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|init_hypersparc
r_static
r_void
id|__init
id|init_hypersparc
c_func
(paren
r_void
)paren
(brace
id|srmmu_name
op_assign
l_string|&quot;ROSS HyperSparc&quot;
suffix:semicolon
id|init_vac_layout
c_func
(paren
)paren
suffix:semicolon
id|is_hypersparc
op_assign
l_int|1
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pte_clear
comma
id|srmmu_pte_clear
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pmd_clear
comma
id|srmmu_pmd_clear
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pgd_clear
comma
id|srmmu_pgd_clear
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_all
comma
id|hypersparc_flush_cache_all
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_mm
comma
id|hypersparc_flush_cache_mm
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_range
comma
id|hypersparc_flush_cache_range
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_page
comma
id|hypersparc_flush_cache_page
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_all
comma
id|hypersparc_flush_tlb_all
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_mm
comma
id|hypersparc_flush_tlb_mm
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_range
comma
id|hypersparc_flush_tlb_range
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_page
comma
id|hypersparc_flush_tlb_page
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|__flush_page_to_ram
comma
id|hypersparc_flush_page_to_ram
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_sig_insns
comma
id|hypersparc_flush_sig_insns
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_page_for_dma
comma
id|hypersparc_flush_page_for_dma
comma
id|BTFIXUPCALL_NOP
)paren
suffix:semicolon
id|poke_srmmu
op_assign
id|poke_hypersparc
suffix:semicolon
id|hypersparc_setup_blockops
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|poke_cypress
r_static
r_void
id|__init
id|poke_cypress
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|mreg
op_assign
id|srmmu_get_mmureg
c_func
(paren
)paren
suffix:semicolon
r_int
r_int
id|faddr
comma
id|tagval
suffix:semicolon
r_volatile
r_int
r_int
id|cypress_sucks
suffix:semicolon
r_volatile
r_int
r_int
id|clear
suffix:semicolon
id|clear
op_assign
id|srmmu_get_faddr
c_func
(paren
)paren
suffix:semicolon
id|clear
op_assign
id|srmmu_get_fstatus
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mreg
op_amp
id|CYPRESS_CENABLE
)paren
)paren
(brace
r_for
c_loop
(paren
id|faddr
op_assign
l_int|0x0
suffix:semicolon
id|faddr
OL
l_int|0x10000
suffix:semicolon
id|faddr
op_add_assign
l_int|20
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;sta %%g0, [%0 + %1] %2&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0] %2&bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|faddr
)paren
comma
l_string|&quot;r&quot;
(paren
l_int|0x40000
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_DATAC_TAG
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_for
c_loop
(paren
id|faddr
op_assign
l_int|0
suffix:semicolon
id|faddr
OL
l_int|0x10000
suffix:semicolon
id|faddr
op_add_assign
l_int|0x20
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;lda [%1 + %2] %3, %0&bslash;n&bslash;t&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|tagval
)paren
suffix:colon
l_string|&quot;r&quot;
(paren
id|faddr
)paren
comma
l_string|&quot;r&quot;
(paren
l_int|0x40000
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_DATAC_TAG
)paren
)paren
suffix:semicolon
multiline_comment|/* If modified and valid, kick it. */
r_if
c_cond
(paren
(paren
id|tagval
op_amp
l_int|0x60
)paren
op_eq
l_int|0x60
)paren
(brace
id|cypress_sucks
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
(paren
l_int|0xf0020000
op_plus
id|faddr
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* And one more, for our good neighbor, Mr. Broken Cypress. */
id|clear
op_assign
id|srmmu_get_faddr
c_func
(paren
)paren
suffix:semicolon
id|clear
op_assign
id|srmmu_get_fstatus
c_func
(paren
)paren
suffix:semicolon
id|mreg
op_or_assign
(paren
id|CYPRESS_CENABLE
op_or
id|CYPRESS_CMODE
)paren
suffix:semicolon
id|srmmu_set_mmureg
c_func
(paren
id|mreg
)paren
suffix:semicolon
)brace
DECL|function|init_cypress_common
r_static
r_void
id|__init
id|init_cypress_common
c_func
(paren
r_void
)paren
(brace
id|init_vac_layout
c_func
(paren
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pte_clear
comma
id|srmmu_pte_clear
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pmd_clear
comma
id|srmmu_pmd_clear
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pgd_clear
comma
id|srmmu_pgd_clear
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_all
comma
id|cypress_flush_cache_all
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_mm
comma
id|cypress_flush_cache_mm
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_range
comma
id|cypress_flush_cache_range
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_page
comma
id|cypress_flush_cache_page
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_all
comma
id|cypress_flush_tlb_all
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_mm
comma
id|cypress_flush_tlb_mm
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_page
comma
id|cypress_flush_tlb_page
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_range
comma
id|cypress_flush_tlb_range
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|__flush_page_to_ram
comma
id|cypress_flush_page_to_ram
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_sig_insns
comma
id|cypress_flush_sig_insns
comma
id|BTFIXUPCALL_NOP
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_page_for_dma
comma
id|cypress_flush_page_for_dma
comma
id|BTFIXUPCALL_NOP
)paren
suffix:semicolon
id|poke_srmmu
op_assign
id|poke_cypress
suffix:semicolon
)brace
DECL|function|init_cypress_604
r_static
r_void
id|__init
id|init_cypress_604
c_func
(paren
r_void
)paren
(brace
id|srmmu_name
op_assign
l_string|&quot;ROSS Cypress-604(UP)&quot;
suffix:semicolon
id|srmmu_modtype
op_assign
id|Cypress
suffix:semicolon
id|init_cypress_common
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|init_cypress_605
r_static
r_void
id|__init
id|init_cypress_605
c_func
(paren
r_int
r_int
id|mrev
)paren
(brace
id|srmmu_name
op_assign
l_string|&quot;ROSS Cypress-605(MP)&quot;
suffix:semicolon
r_if
c_cond
(paren
id|mrev
op_eq
l_int|0xe
)paren
(brace
id|srmmu_modtype
op_assign
id|Cypress_vE
suffix:semicolon
id|hwbug_bitmask
op_or_assign
id|HWBUG_COPYBACK_BROKEN
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|mrev
op_eq
l_int|0xd
)paren
(brace
id|srmmu_modtype
op_assign
id|Cypress_vD
suffix:semicolon
id|hwbug_bitmask
op_or_assign
id|HWBUG_ASIFLUSH_BROKEN
suffix:semicolon
)brace
r_else
(brace
id|srmmu_modtype
op_assign
id|Cypress
suffix:semicolon
)brace
)brace
id|init_cypress_common
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|poke_swift
r_static
r_void
id|__init
id|poke_swift
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|mreg
suffix:semicolon
multiline_comment|/* Clear any crap from the cache or else... */
id|swift_flush_cache_all
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Enable I &amp; D caches */
id|mreg
op_assign
id|srmmu_get_mmureg
c_func
(paren
)paren
suffix:semicolon
id|mreg
op_or_assign
(paren
id|SWIFT_IE
op_or
id|SWIFT_DE
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * The Swift branch folding logic is completely broken.  At&n;&t; * trap time, if things are just right, if can mistakenly&n;&t; * think that a trap is coming from kernel mode when in fact&n;&t; * it is coming from user mode (it mis-executes the branch in&n;&t; * the trap code).  So you see things like crashme completely&n;&t; * hosing your machine which is completely unacceptable.  Turn&n;&t; * this shit off... nice job Fujitsu.&n;&t; */
id|mreg
op_and_assign
op_complement
(paren
id|SWIFT_BF
)paren
suffix:semicolon
id|srmmu_set_mmureg
c_func
(paren
id|mreg
)paren
suffix:semicolon
)brace
DECL|macro|SWIFT_MASKID_ADDR
mdefine_line|#define SWIFT_MASKID_ADDR  0x10003018
DECL|function|init_swift
r_static
r_void
id|__init
id|init_swift
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|swift_rev
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;lda [%1] %2, %0&bslash;n&bslash;t&quot;
l_string|&quot;srl %0, 0x18, %0&bslash;n&bslash;t&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|swift_rev
)paren
suffix:colon
l_string|&quot;r&quot;
(paren
id|SWIFT_MASKID_ADDR
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_BYPASS
)paren
)paren
suffix:semicolon
id|srmmu_name
op_assign
l_string|&quot;Fujitsu Swift&quot;
suffix:semicolon
r_switch
c_cond
(paren
id|swift_rev
)paren
(brace
r_case
l_int|0x11
suffix:colon
r_case
l_int|0x20
suffix:colon
r_case
l_int|0x23
suffix:colon
r_case
l_int|0x30
suffix:colon
id|srmmu_modtype
op_assign
id|Swift_lots_o_bugs
suffix:semicolon
id|hwbug_bitmask
op_or_assign
(paren
id|HWBUG_KERN_ACCBROKEN
op_or
id|HWBUG_KERN_CBITBROKEN
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Gee george, I wonder why Sun is so hush hush about&n;&t;&t; * this hardware bug... really braindamage stuff going&n;&t;&t; * on here.  However I think we can find a way to avoid&n;&t;&t; * all of the workaround overhead under Linux.  Basically,&n;&t;&t; * any page fault can cause kernel pages to become user&n;&t;&t; * accessible (the mmu gets confused and clears some of&n;&t;&t; * the ACC bits in kernel ptes).  Aha, sounds pretty&n;&t;&t; * horrible eh?  But wait, after extensive testing it appears&n;&t;&t; * that if you use pgd_t level large kernel pte&squot;s (like the&n;&t;&t; * 4MB pages on the Pentium) the bug does not get tripped&n;&t;&t; * at all.  This avoids almost all of the major overhead.&n;&t;&t; * Welcome to a world where your vendor tells you to,&n;&t;&t; * &quot;apply this kernel patch&quot; instead of &quot;sorry for the&n;&t;&t; * broken hardware, send it back and we&squot;ll give you&n;&t;&t; * properly functioning parts&quot;&n;&t;&t; */
r_break
suffix:semicolon
r_case
l_int|0x25
suffix:colon
r_case
l_int|0x31
suffix:colon
id|srmmu_modtype
op_assign
id|Swift_bad_c
suffix:semicolon
id|hwbug_bitmask
op_or_assign
id|HWBUG_KERN_CBITBROKEN
suffix:semicolon
multiline_comment|/*&n;&t;&t; * You see Sun allude to this hardware bug but never&n;&t;&t; * admit things directly, they&squot;ll say things like,&n;&t;&t; * &quot;the Swift chip cache problems&quot; or similar.&n;&t;&t; */
r_break
suffix:semicolon
r_default
suffix:colon
id|srmmu_modtype
op_assign
id|Swift_ok
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_all
comma
id|swift_flush_cache_all
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_mm
comma
id|swift_flush_cache_mm
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_page
comma
id|swift_flush_cache_page
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_range
comma
id|swift_flush_cache_range
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_all
comma
id|swift_flush_tlb_all
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_mm
comma
id|swift_flush_tlb_mm
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_page
comma
id|swift_flush_tlb_page
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_range
comma
id|swift_flush_tlb_range
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|__flush_page_to_ram
comma
id|swift_flush_page_to_ram
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_sig_insns
comma
id|swift_flush_sig_insns
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_page_for_dma
comma
id|swift_flush_page_for_dma
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|update_mmu_cache
comma
id|swift_update_mmu_cache
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|flush_page_for_dma_global
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Are you now convinced that the Swift is one of the&n;&t; * biggest VLSI abortions of all time?  Bravo Fujitsu!&n;&t; * Fujitsu, the !#?!%$&squot;d up processor people.  I bet if&n;&t; * you examined the microcode of the Swift you&squot;d find&n;&t; * XXX&squot;s all over the place.&n;&t; */
id|poke_srmmu
op_assign
id|poke_swift
suffix:semicolon
)brace
DECL|function|turbosparc_flush_cache_all
r_static
r_void
id|turbosparc_flush_cache_all
c_func
(paren
r_void
)paren
(brace
id|flush_user_windows
c_func
(paren
)paren
suffix:semicolon
id|turbosparc_idflash_clear
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|turbosparc_flush_cache_mm
r_static
r_void
id|turbosparc_flush_cache_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
id|FLUSH_BEGIN
c_func
(paren
id|mm
)paren
id|flush_user_windows
c_func
(paren
)paren
suffix:semicolon
id|turbosparc_idflash_clear
c_func
(paren
)paren
suffix:semicolon
id|FLUSH_END
)brace
DECL|function|turbosparc_flush_cache_range
r_static
r_void
id|turbosparc_flush_cache_range
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
id|FLUSH_BEGIN
c_func
(paren
id|mm
)paren
id|flush_user_windows
c_func
(paren
)paren
suffix:semicolon
id|turbosparc_idflash_clear
c_func
(paren
)paren
suffix:semicolon
id|FLUSH_END
)brace
DECL|function|turbosparc_flush_cache_page
r_static
r_void
id|turbosparc_flush_cache_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
(brace
id|FLUSH_BEGIN
c_func
(paren
id|vma-&gt;vm_mm
)paren
id|flush_user_windows
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_EXEC
)paren
id|turbosparc_flush_icache
c_func
(paren
)paren
suffix:semicolon
id|turbosparc_flush_dcache
c_func
(paren
)paren
suffix:semicolon
id|FLUSH_END
)brace
multiline_comment|/* TurboSparc is copy-back, if we turn it on, but this does not work. */
DECL|function|turbosparc_flush_page_to_ram
r_static
r_void
id|turbosparc_flush_page_to_ram
c_func
(paren
r_int
r_int
id|page
)paren
(brace
macro_line|#ifdef TURBOSPARC_WRITEBACK
r_volatile
r_int
r_int
id|clear
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_hwprobe
c_func
(paren
id|page
)paren
)paren
id|turbosparc_flush_page_cache
c_func
(paren
id|page
)paren
suffix:semicolon
id|clear
op_assign
id|srmmu_get_fstatus
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|turbosparc_flush_sig_insns
r_static
r_void
id|turbosparc_flush_sig_insns
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|insn_addr
)paren
(brace
)brace
DECL|function|turbosparc_flush_page_for_dma
r_static
r_void
id|turbosparc_flush_page_for_dma
c_func
(paren
r_int
r_int
id|page
)paren
(brace
id|turbosparc_flush_dcache
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|turbosparc_flush_tlb_all
r_static
r_void
id|turbosparc_flush_tlb_all
c_func
(paren
r_void
)paren
(brace
id|srmmu_flush_whole_tlb
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|turbosparc_flush_tlb_mm
r_static
r_void
id|turbosparc_flush_tlb_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
id|FLUSH_BEGIN
c_func
(paren
id|mm
)paren
id|srmmu_flush_whole_tlb
c_func
(paren
)paren
suffix:semicolon
id|FLUSH_END
)brace
DECL|function|turbosparc_flush_tlb_range
r_static
r_void
id|turbosparc_flush_tlb_range
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
id|FLUSH_BEGIN
c_func
(paren
id|mm
)paren
id|srmmu_flush_whole_tlb
c_func
(paren
)paren
suffix:semicolon
id|FLUSH_END
)brace
DECL|function|turbosparc_flush_tlb_page
r_static
r_void
id|turbosparc_flush_tlb_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
(brace
id|FLUSH_BEGIN
c_func
(paren
id|vma-&gt;vm_mm
)paren
id|srmmu_flush_whole_tlb
c_func
(paren
)paren
suffix:semicolon
id|FLUSH_END
)brace
DECL|function|poke_turbosparc
r_static
r_void
id|__init
id|poke_turbosparc
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|mreg
op_assign
id|srmmu_get_mmureg
c_func
(paren
)paren
suffix:semicolon
r_int
r_int
id|ccreg
suffix:semicolon
multiline_comment|/* Clear any crap from the cache or else... */
id|turbosparc_flush_cache_all
c_func
(paren
)paren
suffix:semicolon
id|mreg
op_and_assign
op_complement
(paren
id|TURBOSPARC_ICENABLE
op_or
id|TURBOSPARC_DCENABLE
)paren
suffix:semicolon
multiline_comment|/* Temporarily disable I &amp; D caches */
id|mreg
op_and_assign
op_complement
(paren
id|TURBOSPARC_PCENABLE
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t check parity */
id|srmmu_set_mmureg
c_func
(paren
id|mreg
)paren
suffix:semicolon
id|ccreg
op_assign
id|turbosparc_get_ccreg
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef TURBOSPARC_WRITEBACK
id|ccreg
op_or_assign
(paren
id|TURBOSPARC_SNENABLE
)paren
suffix:semicolon
multiline_comment|/* Do DVMA snooping in Dcache */
id|ccreg
op_and_assign
op_complement
(paren
id|TURBOSPARC_uS2
op_or
id|TURBOSPARC_WTENABLE
)paren
suffix:semicolon
multiline_comment|/* Write-back D-cache, emulate VLSI&n;&t;&t;&t; * abortion number three, not number one */
macro_line|#else
multiline_comment|/* For now let&squot;s play safe, optimize later */
id|ccreg
op_or_assign
(paren
id|TURBOSPARC_SNENABLE
op_or
id|TURBOSPARC_WTENABLE
)paren
suffix:semicolon
multiline_comment|/* Do DVMA snooping in Dcache, Write-thru D-cache */
id|ccreg
op_and_assign
op_complement
(paren
id|TURBOSPARC_uS2
)paren
suffix:semicolon
multiline_comment|/* Emulate VLSI abortion number three, not number one */
macro_line|#endif
r_switch
c_cond
(paren
id|ccreg
op_amp
l_int|7
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* No SE cache */
r_case
l_int|7
suffix:colon
multiline_comment|/* Test mode */
r_break
suffix:semicolon
r_default
suffix:colon
id|ccreg
op_or_assign
(paren
id|TURBOSPARC_SCENABLE
)paren
suffix:semicolon
)brace
id|turbosparc_set_ccreg
(paren
id|ccreg
)paren
suffix:semicolon
id|mreg
op_or_assign
(paren
id|TURBOSPARC_ICENABLE
op_or
id|TURBOSPARC_DCENABLE
)paren
suffix:semicolon
multiline_comment|/* I &amp; D caches on */
id|mreg
op_or_assign
(paren
id|TURBOSPARC_ICSNOOP
)paren
suffix:semicolon
multiline_comment|/* Icache snooping on */
id|srmmu_set_mmureg
c_func
(paren
id|mreg
)paren
suffix:semicolon
)brace
DECL|function|init_turbosparc
r_static
r_void
id|__init
id|init_turbosparc
c_func
(paren
r_void
)paren
(brace
id|srmmu_name
op_assign
l_string|&quot;Fujitsu TurboSparc&quot;
suffix:semicolon
id|srmmu_modtype
op_assign
id|TurboSparc
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_all
comma
id|turbosparc_flush_cache_all
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_mm
comma
id|turbosparc_flush_cache_mm
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_page
comma
id|turbosparc_flush_cache_page
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_range
comma
id|turbosparc_flush_cache_range
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_all
comma
id|turbosparc_flush_tlb_all
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_mm
comma
id|turbosparc_flush_tlb_mm
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_page
comma
id|turbosparc_flush_tlb_page
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_range
comma
id|turbosparc_flush_tlb_range
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|__flush_page_to_ram
comma
id|turbosparc_flush_page_to_ram
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_sig_insns
comma
id|turbosparc_flush_sig_insns
comma
id|BTFIXUPCALL_NOP
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_page_for_dma
comma
id|turbosparc_flush_page_for_dma
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|poke_srmmu
op_assign
id|poke_turbosparc
suffix:semicolon
)brace
DECL|function|poke_tsunami
r_static
r_void
id|__init
id|poke_tsunami
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|mreg
op_assign
id|srmmu_get_mmureg
c_func
(paren
)paren
suffix:semicolon
id|tsunami_flush_icache
c_func
(paren
)paren
suffix:semicolon
id|tsunami_flush_dcache
c_func
(paren
)paren
suffix:semicolon
id|mreg
op_and_assign
op_complement
id|TSUNAMI_ITD
suffix:semicolon
id|mreg
op_or_assign
(paren
id|TSUNAMI_IENAB
op_or
id|TSUNAMI_DENAB
)paren
suffix:semicolon
id|srmmu_set_mmureg
c_func
(paren
id|mreg
)paren
suffix:semicolon
)brace
DECL|function|init_tsunami
r_static
r_void
id|__init
id|init_tsunami
c_func
(paren
r_void
)paren
(brace
multiline_comment|/*&n;&t; * Tsunami&squot;s pretty sane, Sun and TI actually got it&n;&t; * somewhat right this time.  Fujitsu should have&n;&t; * taken some lessons from them.&n;&t; */
id|srmmu_name
op_assign
l_string|&quot;TI Tsunami&quot;
suffix:semicolon
id|srmmu_modtype
op_assign
id|Tsunami
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_all
comma
id|tsunami_flush_cache_all
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_mm
comma
id|tsunami_flush_cache_mm
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_page
comma
id|tsunami_flush_cache_page
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_range
comma
id|tsunami_flush_cache_range
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_all
comma
id|tsunami_flush_tlb_all
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_mm
comma
id|tsunami_flush_tlb_mm
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_page
comma
id|tsunami_flush_tlb_page
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_range
comma
id|tsunami_flush_tlb_range
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|__flush_page_to_ram
comma
id|tsunami_flush_page_to_ram
comma
id|BTFIXUPCALL_NOP
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_sig_insns
comma
id|tsunami_flush_sig_insns
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_page_for_dma
comma
id|tsunami_flush_page_for_dma
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|poke_srmmu
op_assign
id|poke_tsunami
suffix:semicolon
id|tsunami_setup_blockops
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|poke_viking
r_static
r_void
id|__init
id|poke_viking
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|mreg
op_assign
id|srmmu_get_mmureg
c_func
(paren
)paren
suffix:semicolon
r_static
r_int
id|smp_catch
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|viking_mxcc_present
)paren
(brace
r_int
r_int
id|mxcc_control
op_assign
id|mxcc_get_creg
c_func
(paren
)paren
suffix:semicolon
id|mxcc_control
op_or_assign
(paren
id|MXCC_CTL_ECE
op_or
id|MXCC_CTL_PRE
op_or
id|MXCC_CTL_MCE
)paren
suffix:semicolon
id|mxcc_control
op_and_assign
op_complement
(paren
id|MXCC_CTL_RRC
)paren
suffix:semicolon
id|mxcc_set_creg
c_func
(paren
id|mxcc_control
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * We don&squot;t need memory parity checks.&n;&t;&t; * XXX This is a mess, have to dig out later. ecd.&n;&t;&t;viking_mxcc_turn_off_parity(&amp;mreg, &amp;mxcc_control);&n;&t;&t; */
multiline_comment|/* We do cache ptables on MXCC. */
id|mreg
op_or_assign
id|VIKING_TCENABLE
suffix:semicolon
)brace
r_else
(brace
r_int
r_int
id|bpreg
suffix:semicolon
id|mreg
op_and_assign
op_complement
(paren
id|VIKING_TCENABLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smp_catch
op_increment
)paren
(brace
multiline_comment|/* Must disable mixed-cmd mode here for other cpu&squot;s. */
id|bpreg
op_assign
id|viking_get_bpreg
c_func
(paren
)paren
suffix:semicolon
id|bpreg
op_and_assign
op_complement
(paren
id|VIKING_ACTION_MIX
)paren
suffix:semicolon
id|viking_set_bpreg
c_func
(paren
id|bpreg
)paren
suffix:semicolon
multiline_comment|/* Just in case PROM does something funny. */
id|msi_set_sync
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
id|mreg
op_or_assign
id|VIKING_SPENABLE
suffix:semicolon
id|mreg
op_or_assign
(paren
id|VIKING_ICENABLE
op_or
id|VIKING_DCENABLE
)paren
suffix:semicolon
id|mreg
op_or_assign
id|VIKING_SBENABLE
suffix:semicolon
id|mreg
op_and_assign
op_complement
(paren
id|VIKING_ACENABLE
)paren
suffix:semicolon
id|srmmu_set_mmureg
c_func
(paren
id|mreg
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
multiline_comment|/* Avoid unnecessary cross calls. */
id|BTFIXUPCOPY_CALL
c_func
(paren
id|flush_cache_all
comma
id|local_flush_cache_all
)paren
suffix:semicolon
id|BTFIXUPCOPY_CALL
c_func
(paren
id|flush_cache_mm
comma
id|local_flush_cache_mm
)paren
suffix:semicolon
id|BTFIXUPCOPY_CALL
c_func
(paren
id|flush_cache_range
comma
id|local_flush_cache_range
)paren
suffix:semicolon
id|BTFIXUPCOPY_CALL
c_func
(paren
id|flush_cache_page
comma
id|local_flush_cache_page
)paren
suffix:semicolon
id|BTFIXUPCOPY_CALL
c_func
(paren
id|__flush_page_to_ram
comma
id|local_flush_page_to_ram
)paren
suffix:semicolon
id|BTFIXUPCOPY_CALL
c_func
(paren
id|flush_sig_insns
comma
id|local_flush_sig_insns
)paren
suffix:semicolon
id|BTFIXUPCOPY_CALL
c_func
(paren
id|flush_page_for_dma
comma
id|local_flush_page_for_dma
)paren
suffix:semicolon
id|btfixup
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|init_viking
r_static
r_void
id|__init
id|init_viking
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|mreg
op_assign
id|srmmu_get_mmureg
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Ahhh, the viking.  SRMMU VLSI abortion number two... */
r_if
c_cond
(paren
id|mreg
op_amp
id|VIKING_MMODE
)paren
(brace
id|srmmu_name
op_assign
l_string|&quot;TI Viking&quot;
suffix:semicolon
id|viking_mxcc_present
op_assign
l_int|0
suffix:semicolon
id|msi_set_sync
c_func
(paren
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pte_clear
comma
id|srmmu_pte_clear
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pmd_clear
comma
id|srmmu_pmd_clear
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pgd_clear
comma
id|srmmu_pgd_clear
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * We need this to make sure old viking takes no hits&n;&t;&t; * on it&squot;s cache for dma snoops to workaround the&n;&t;&t; * &quot;load from non-cacheable memory&quot; interrupt bug.&n;&t;&t; * This is only necessary because of the new way in&n;&t;&t; * which we use the IOMMU.&n;&t;&t; */
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_page_for_dma
comma
id|viking_flush_page
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|flush_page_for_dma_global
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|srmmu_name
op_assign
l_string|&quot;TI Viking/MXCC&quot;
suffix:semicolon
id|viking_mxcc_present
op_assign
l_int|1
suffix:semicolon
id|srmmu_cache_pagetables
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* MXCC vikings lack the DMA snooping bug. */
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_page_for_dma
comma
id|viking_flush_page_for_dma
comma
id|BTFIXUPCALL_NOP
)paren
suffix:semicolon
)brace
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_all
comma
id|viking_flush_cache_all
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_mm
comma
id|viking_flush_cache_mm
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_page
comma
id|viking_flush_cache_page
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_range
comma
id|viking_flush_cache_range
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
r_if
c_cond
(paren
id|sparc_cpu_model
op_eq
id|sun4d
)paren
(brace
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_all
comma
id|sun4dsmp_flush_tlb_all
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_mm
comma
id|sun4dsmp_flush_tlb_mm
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_page
comma
id|sun4dsmp_flush_tlb_page
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_range
comma
id|sun4dsmp_flush_tlb_range
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif
(brace
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_all
comma
id|viking_flush_tlb_all
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_mm
comma
id|viking_flush_tlb_mm
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_page
comma
id|viking_flush_tlb_page
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_range
comma
id|viking_flush_tlb_range
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
)brace
id|BTFIXUPSET_CALL
c_func
(paren
id|__flush_page_to_ram
comma
id|viking_flush_page_to_ram
comma
id|BTFIXUPCALL_NOP
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_sig_insns
comma
id|viking_flush_sig_insns
comma
id|BTFIXUPCALL_NOP
)paren
suffix:semicolon
id|poke_srmmu
op_assign
id|poke_viking
suffix:semicolon
)brace
multiline_comment|/* Probe for the srmmu chip version. */
DECL|function|get_srmmu_type
r_static
r_void
id|__init
id|get_srmmu_type
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|mreg
comma
id|psr
suffix:semicolon
r_int
r_int
id|mod_typ
comma
id|mod_rev
comma
id|psr_typ
comma
id|psr_vers
suffix:semicolon
id|srmmu_modtype
op_assign
id|SRMMU_INVAL_MOD
suffix:semicolon
id|hwbug_bitmask
op_assign
l_int|0
suffix:semicolon
id|mreg
op_assign
id|srmmu_get_mmureg
c_func
(paren
)paren
suffix:semicolon
id|psr
op_assign
id|get_psr
c_func
(paren
)paren
suffix:semicolon
id|mod_typ
op_assign
(paren
id|mreg
op_amp
l_int|0xf0000000
)paren
op_rshift
l_int|28
suffix:semicolon
id|mod_rev
op_assign
(paren
id|mreg
op_amp
l_int|0x0f000000
)paren
op_rshift
l_int|24
suffix:semicolon
id|psr_typ
op_assign
(paren
id|psr
op_rshift
l_int|28
)paren
op_amp
l_int|0xf
suffix:semicolon
id|psr_vers
op_assign
(paren
id|psr
op_rshift
l_int|24
)paren
op_amp
l_int|0xf
suffix:semicolon
multiline_comment|/* First, check for HyperSparc or Cypress. */
r_if
c_cond
(paren
id|mod_typ
op_eq
l_int|1
)paren
(brace
r_switch
c_cond
(paren
id|mod_rev
)paren
(brace
r_case
l_int|7
suffix:colon
multiline_comment|/* UP or MP Hypersparc */
id|init_hypersparc
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0
suffix:colon
r_case
l_int|2
suffix:colon
multiline_comment|/* Uniprocessor Cypress */
id|init_cypress_604
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|10
suffix:colon
r_case
l_int|11
suffix:colon
r_case
l_int|12
suffix:colon
multiline_comment|/* _REALLY OLD_ Cypress MP chips... */
r_case
l_int|13
suffix:colon
r_case
l_int|14
suffix:colon
r_case
l_int|15
suffix:colon
multiline_comment|/* MP Cypress mmu/cache-controller */
id|init_cypress_605
c_func
(paren
id|mod_rev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* Some other Cypress revision, assume a 605. */
id|init_cypress_605
c_func
(paren
id|mod_rev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Now Fujitsu TurboSparc. It might happen that it is&n;&t; * in Swift emulation mode, so we will check later...&n;&t; */
r_if
c_cond
(paren
id|psr_typ
op_eq
l_int|0
op_logical_and
id|psr_vers
op_eq
l_int|5
)paren
(brace
id|init_turbosparc
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Next check for Fujitsu Swift. */
r_if
c_cond
(paren
id|psr_typ
op_eq
l_int|0
op_logical_and
id|psr_vers
op_eq
l_int|4
)paren
(brace
r_int
id|cpunode
suffix:semicolon
r_char
id|node_str
(braket
l_int|128
)braket
suffix:semicolon
multiline_comment|/* Look if it is not a TurboSparc emulating Swift... */
id|cpunode
op_assign
id|prom_getchild
c_func
(paren
id|prom_root_node
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|cpunode
op_assign
id|prom_getsibling
c_func
(paren
id|cpunode
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|prom_getstring
c_func
(paren
id|cpunode
comma
l_string|&quot;device_type&quot;
comma
id|node_str
comma
r_sizeof
(paren
id|node_str
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|node_str
comma
l_string|&quot;cpu&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|prom_getintdefault
c_func
(paren
id|cpunode
comma
l_string|&quot;psr-implementation&quot;
comma
l_int|1
)paren
op_logical_and
id|prom_getintdefault
c_func
(paren
id|cpunode
comma
l_string|&quot;psr-version&quot;
comma
l_int|1
)paren
op_eq
l_int|5
)paren
(brace
id|init_turbosparc
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
id|init_swift
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Now the Viking family of srmmu. */
r_if
c_cond
(paren
id|psr_typ
op_eq
l_int|4
op_logical_and
(paren
(paren
id|psr_vers
op_eq
l_int|0
)paren
op_logical_or
(paren
(paren
id|psr_vers
op_eq
l_int|1
)paren
op_logical_and
(paren
id|mod_typ
op_eq
l_int|0
)paren
op_logical_and
(paren
id|mod_rev
op_eq
l_int|0
)paren
)paren
)paren
)paren
(brace
id|init_viking
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Finally the Tsunami. */
r_if
c_cond
(paren
id|psr_typ
op_eq
l_int|4
op_logical_and
id|psr_vers
op_eq
l_int|1
op_logical_and
(paren
id|mod_typ
op_logical_or
id|mod_rev
)paren
)paren
(brace
id|init_tsunami
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Oh well */
id|srmmu_is_bad
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* dont laugh, static pagetables */
DECL|function|srmmu_check_pgt_cache
r_static
r_int
id|srmmu_check_pgt_cache
c_func
(paren
r_int
id|low
comma
r_int
id|high
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_extern
r_int
r_int
id|spwin_mmu_patchme
comma
id|fwin_mmu_patchme
comma
id|tsetup_mmu_patchme
comma
id|rtrap_mmu_patchme
suffix:semicolon
r_extern
r_int
r_int
id|spwin_srmmu_stackchk
comma
id|srmmu_fwin_stackchk
comma
id|tsetup_srmmu_stackchk
comma
id|srmmu_rett_stackchk
suffix:semicolon
r_extern
r_int
r_int
id|srmmu_fault
suffix:semicolon
DECL|macro|PATCH_BRANCH
mdefine_line|#define PATCH_BRANCH(insn, dest) do { &bslash;&n;&t;&t;iaddr = &amp;(insn); &bslash;&n;&t;&t;daddr = &amp;(dest); &bslash;&n;&t;&t;*iaddr = SPARC_BRANCH((unsigned long) daddr, (unsigned long) iaddr); &bslash;&n;&t;} while(0);
DECL|function|patch_window_trap_handlers
r_static
r_void
id|__init
id|patch_window_trap_handlers
c_func
(paren
r_void
)paren
(brace
r_int
r_int
op_star
id|iaddr
comma
op_star
id|daddr
suffix:semicolon
id|PATCH_BRANCH
c_func
(paren
id|spwin_mmu_patchme
comma
id|spwin_srmmu_stackchk
)paren
suffix:semicolon
id|PATCH_BRANCH
c_func
(paren
id|fwin_mmu_patchme
comma
id|srmmu_fwin_stackchk
)paren
suffix:semicolon
id|PATCH_BRANCH
c_func
(paren
id|tsetup_mmu_patchme
comma
id|tsetup_srmmu_stackchk
)paren
suffix:semicolon
id|PATCH_BRANCH
c_func
(paren
id|rtrap_mmu_patchme
comma
id|srmmu_rett_stackchk
)paren
suffix:semicolon
id|PATCH_BRANCH
c_func
(paren
id|sparc_ttable
(braket
id|SP_TRAP_TFLT
)braket
dot
id|inst_three
comma
id|srmmu_fault
)paren
suffix:semicolon
id|PATCH_BRANCH
c_func
(paren
id|sparc_ttable
(braket
id|SP_TRAP_DFLT
)braket
dot
id|inst_three
comma
id|srmmu_fault
)paren
suffix:semicolon
id|PATCH_BRANCH
c_func
(paren
id|sparc_ttable
(braket
id|SP_TRAP_DACC
)braket
dot
id|inst_three
comma
id|srmmu_fault
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SMP
multiline_comment|/* Local cross-calls. */
DECL|function|smp_flush_page_for_dma
r_static
r_void
id|smp_flush_page_for_dma
c_func
(paren
r_int
r_int
id|page
)paren
(brace
id|xc1
c_func
(paren
(paren
id|smpfunc_t
)paren
id|BTFIXUP_CALL
c_func
(paren
id|local_flush_page_for_dma
)paren
comma
id|page
)paren
suffix:semicolon
id|local_flush_page_for_dma
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Load up routines and constants for sun4m and sun4d mmu */
DECL|function|ld_mmu_srmmu
r_void
id|__init
id|ld_mmu_srmmu
c_func
(paren
r_void
)paren
(brace
r_extern
r_void
id|ld_mmu_iommu
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|ld_mmu_iounit
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|___xchg32_sun4md
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/* First the constants */
id|BTFIXUPSET_SIMM13
c_func
(paren
id|pmd_shift
comma
id|SRMMU_PMD_SHIFT
)paren
suffix:semicolon
id|BTFIXUPSET_SETHI
c_func
(paren
id|pmd_size
comma
id|SRMMU_PMD_SIZE
)paren
suffix:semicolon
id|BTFIXUPSET_SETHI
c_func
(paren
id|pmd_mask
comma
id|SRMMU_PMD_MASK
)paren
suffix:semicolon
id|BTFIXUPSET_SIMM13
c_func
(paren
id|pgdir_shift
comma
id|SRMMU_PGDIR_SHIFT
)paren
suffix:semicolon
id|BTFIXUPSET_SETHI
c_func
(paren
id|pgdir_size
comma
id|SRMMU_PGDIR_SIZE
)paren
suffix:semicolon
id|BTFIXUPSET_SETHI
c_func
(paren
id|pgdir_mask
comma
id|SRMMU_PGDIR_MASK
)paren
suffix:semicolon
id|BTFIXUPSET_SIMM13
c_func
(paren
id|ptrs_per_pte
comma
id|SRMMU_PTRS_PER_PTE
)paren
suffix:semicolon
id|BTFIXUPSET_SIMM13
c_func
(paren
id|ptrs_per_pmd
comma
id|SRMMU_PTRS_PER_PMD
)paren
suffix:semicolon
id|BTFIXUPSET_SIMM13
c_func
(paren
id|ptrs_per_pgd
comma
id|SRMMU_PTRS_PER_PGD
)paren
suffix:semicolon
id|BTFIXUPSET_INT
c_func
(paren
id|page_none
comma
id|pgprot_val
c_func
(paren
id|SRMMU_PAGE_NONE
)paren
)paren
suffix:semicolon
id|BTFIXUPSET_INT
c_func
(paren
id|page_shared
comma
id|pgprot_val
c_func
(paren
id|SRMMU_PAGE_SHARED
)paren
)paren
suffix:semicolon
id|BTFIXUPSET_INT
c_func
(paren
id|page_copy
comma
id|pgprot_val
c_func
(paren
id|SRMMU_PAGE_COPY
)paren
)paren
suffix:semicolon
id|BTFIXUPSET_INT
c_func
(paren
id|page_readonly
comma
id|pgprot_val
c_func
(paren
id|SRMMU_PAGE_RDONLY
)paren
)paren
suffix:semicolon
id|BTFIXUPSET_INT
c_func
(paren
id|page_kernel
comma
id|pgprot_val
c_func
(paren
id|SRMMU_PAGE_KERNEL
)paren
)paren
suffix:semicolon
id|page_kernel
op_assign
id|pgprot_val
c_func
(paren
id|SRMMU_PAGE_KERNEL
)paren
suffix:semicolon
id|pg_iobits
op_assign
id|SRMMU_VALID
op_or
id|SRMMU_WRITE
op_or
id|SRMMU_REF
suffix:semicolon
multiline_comment|/* Functions */
macro_line|#ifndef CONFIG_SMP&t;
id|BTFIXUPSET_CALL
c_func
(paren
id|___xchg32
comma
id|___xchg32_sun4md
comma
id|BTFIXUPCALL_SWAPG1G2
)paren
suffix:semicolon
macro_line|#endif
id|BTFIXUPSET_CALL
c_func
(paren
id|do_check_pgt_cache
comma
id|srmmu_check_pgt_cache
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|set_pte
comma
id|srmmu_set_pte
comma
id|BTFIXUPCALL_SWAPO0O1
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|switch_mm
comma
id|srmmu_switch_mm
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pte_page
comma
id|srmmu_pte_page
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pmd_page
comma
id|srmmu_pmd_page
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pgd_page
comma
id|srmmu_pgd_page
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_SETHI
c_func
(paren
id|none_mask
comma
l_int|0xF0000000
)paren
suffix:semicolon
multiline_comment|/* XXX P3: is it used? */
id|BTFIXUPSET_CALL
c_func
(paren
id|pte_present
comma
id|srmmu_pte_present
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pte_clear
comma
id|srmmu_pte_clear
comma
id|BTFIXUPCALL_SWAPO0G0
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pmd_bad
comma
id|srmmu_pmd_bad
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pmd_present
comma
id|srmmu_pmd_present
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pmd_clear
comma
id|srmmu_pmd_clear
comma
id|BTFIXUPCALL_SWAPO0G0
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pgd_none
comma
id|srmmu_pgd_none
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pgd_bad
comma
id|srmmu_pgd_bad
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pgd_present
comma
id|srmmu_pgd_present
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pgd_clear
comma
id|srmmu_pgd_clear
comma
id|BTFIXUPCALL_SWAPO0G0
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|mk_pte
comma
id|srmmu_mk_pte
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|mk_pte_phys
comma
id|srmmu_mk_pte_phys
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|mk_pte_io
comma
id|srmmu_mk_pte_io
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pgd_set
comma
id|srmmu_pgd_set
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pmd_set
comma
id|srmmu_pmd_set
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_INT
c_func
(paren
id|pte_modify_mask
comma
id|SRMMU_CHG_MASK
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pmd_offset
comma
id|srmmu_pmd_offset
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pte_offset
comma
id|srmmu_pte_offset
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pte_free_kernel
comma
id|srmmu_pte_free
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pmd_free_kernel
comma
id|srmmu_pmd_free
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pte_alloc_kernel
comma
id|srmmu_pte_alloc
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pmd_alloc_kernel
comma
id|srmmu_pmd_alloc
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pte_free
comma
id|srmmu_pte_free
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pte_alloc
comma
id|srmmu_pte_alloc
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pmd_free
comma
id|srmmu_pmd_free
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pmd_alloc
comma
id|srmmu_pmd_alloc
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pgd_free
comma
id|srmmu_pgd_free
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pgd_alloc
comma
id|srmmu_pgd_alloc
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_HALF
c_func
(paren
id|pte_writei
comma
id|SRMMU_WRITE
)paren
suffix:semicolon
id|BTFIXUPSET_HALF
c_func
(paren
id|pte_dirtyi
comma
id|SRMMU_DIRTY
)paren
suffix:semicolon
id|BTFIXUPSET_HALF
c_func
(paren
id|pte_youngi
comma
id|SRMMU_REF
)paren
suffix:semicolon
id|BTFIXUPSET_HALF
c_func
(paren
id|pte_wrprotecti
comma
id|SRMMU_WRITE
)paren
suffix:semicolon
id|BTFIXUPSET_HALF
c_func
(paren
id|pte_mkcleani
comma
id|SRMMU_DIRTY
)paren
suffix:semicolon
id|BTFIXUPSET_HALF
c_func
(paren
id|pte_mkoldi
comma
id|SRMMU_REF
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pte_mkwrite
comma
id|srmmu_pte_mkwrite
comma
id|BTFIXUPCALL_ORINT
c_func
(paren
id|SRMMU_WRITE
)paren
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pte_mkdirty
comma
id|srmmu_pte_mkdirty
comma
id|BTFIXUPCALL_ORINT
c_func
(paren
id|SRMMU_DIRTY
)paren
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|pte_mkyoung
comma
id|srmmu_pte_mkyoung
comma
id|BTFIXUPCALL_ORINT
c_func
(paren
id|SRMMU_REF
)paren
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|update_mmu_cache
comma
id|srmmu_update_mmu_cache
comma
id|BTFIXUPCALL_NOP
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|destroy_context
comma
id|srmmu_destroy_context
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|mmu_info
comma
id|srmmu_mmu_info
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
multiline_comment|/* Task struct and kernel stack allocating/freeing. */
id|BTFIXUPSET_CALL
c_func
(paren
id|alloc_task_struct
comma
id|srmmu_alloc_task_struct
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|free_task_struct
comma
id|srmmu_free_task_struct
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|get_task_struct
comma
id|srmmu_get_task_struct
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|get_srmmu_type
c_func
(paren
)paren
suffix:semicolon
id|patch_window_trap_handlers
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
multiline_comment|/* El switcheroo... */
id|BTFIXUPCOPY_CALL
c_func
(paren
id|local_flush_cache_all
comma
id|flush_cache_all
)paren
suffix:semicolon
id|BTFIXUPCOPY_CALL
c_func
(paren
id|local_flush_cache_mm
comma
id|flush_cache_mm
)paren
suffix:semicolon
id|BTFIXUPCOPY_CALL
c_func
(paren
id|local_flush_cache_range
comma
id|flush_cache_range
)paren
suffix:semicolon
id|BTFIXUPCOPY_CALL
c_func
(paren
id|local_flush_cache_page
comma
id|flush_cache_page
)paren
suffix:semicolon
id|BTFIXUPCOPY_CALL
c_func
(paren
id|local_flush_tlb_all
comma
id|flush_tlb_all
)paren
suffix:semicolon
id|BTFIXUPCOPY_CALL
c_func
(paren
id|local_flush_tlb_mm
comma
id|flush_tlb_mm
)paren
suffix:semicolon
id|BTFIXUPCOPY_CALL
c_func
(paren
id|local_flush_tlb_range
comma
id|flush_tlb_range
)paren
suffix:semicolon
id|BTFIXUPCOPY_CALL
c_func
(paren
id|local_flush_tlb_page
comma
id|flush_tlb_page
)paren
suffix:semicolon
id|BTFIXUPCOPY_CALL
c_func
(paren
id|local_flush_page_to_ram
comma
id|__flush_page_to_ram
)paren
suffix:semicolon
id|BTFIXUPCOPY_CALL
c_func
(paren
id|local_flush_sig_insns
comma
id|flush_sig_insns
)paren
suffix:semicolon
id|BTFIXUPCOPY_CALL
c_func
(paren
id|local_flush_page_for_dma
comma
id|flush_page_for_dma
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_all
comma
id|smp_flush_cache_all
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_mm
comma
id|smp_flush_cache_mm
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_range
comma
id|smp_flush_cache_range
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_cache_page
comma
id|smp_flush_cache_page
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sparc_cpu_model
op_ne
id|sun4d
)paren
(brace
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_all
comma
id|smp_flush_tlb_all
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_mm
comma
id|smp_flush_tlb_mm
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_range
comma
id|smp_flush_tlb_range
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_tlb_page
comma
id|smp_flush_tlb_page
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
)brace
id|BTFIXUPSET_CALL
c_func
(paren
id|__flush_page_to_ram
comma
id|smp_flush_page_to_ram
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_sig_insns
comma
id|smp_flush_sig_insns
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
id|BTFIXUPSET_CALL
c_func
(paren
id|flush_page_for_dma
comma
id|smp_flush_page_for_dma
comma
id|BTFIXUPCALL_NORM
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|sparc_cpu_model
op_eq
id|sun4d
)paren
id|ld_mmu_iounit
c_func
(paren
)paren
suffix:semicolon
r_else
id|ld_mmu_iommu
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
r_if
c_cond
(paren
id|sparc_cpu_model
op_eq
id|sun4d
)paren
id|sun4d_init_smp
c_func
(paren
)paren
suffix:semicolon
r_else
id|sun4m_init_smp
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
)brace
eof
