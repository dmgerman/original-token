multiline_comment|/* srmmu.c:  SRMMU specific routines for memory management.&n; *&n; * Copyright (C) 1995 David S. Miller  (davem@caip.rutgers.edu)&n; * Copyright (C) 1995 Peter A. Zaitcev (zaitcev@lab.ipmce.su)&n; */
macro_line|#include &lt;linux/kernel.h&gt;  /* for printk */
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/kdebug.h&gt;
macro_line|#include &lt;asm/vaddrs.h&gt;
macro_line|#include &lt;asm/traps.h&gt;
macro_line|#include &lt;asm/mp.h&gt;
macro_line|#include &lt;asm/cache.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
r_extern
r_int
r_int
id|free_area_init
c_func
(paren
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
DECL|function|srmmu_pmd_align
r_int
r_int
id|srmmu_pmd_align
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_return
id|SRMMU_PMD_ALIGN
c_func
(paren
id|addr
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pgdir_align
r_int
r_int
id|srmmu_pgdir_align
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_return
id|SRMMU_PGDIR_ALIGN
c_func
(paren
id|addr
)paren
suffix:semicolon
)brace
multiline_comment|/* Idea taken from Hamish McDonald&squot;s MC680x0 Linux code, nice job.&n; * Many of the page table/directory functions on the SRMMU use this&n; * routine.&n; *&n; * Having a complete physical ram structure walk happen for each&n; * invocation is quite costly.  However, this does do some nice&n; * sanity checking and we&squot;ll see when our maps don&squot;t match.  Eventually&n; * when I trust my code I will just do a direct mmu probe in mk_pte().&n; */
r_static
r_inline
r_int
r_int
DECL|function|srmmu_virt_to_phys
id|srmmu_virt_to_phys
c_func
(paren
r_int
r_int
id|vaddr
)paren
(brace
r_int
r_int
id|paddr
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|voff
op_assign
(paren
id|vaddr
op_minus
id|PAGE_OFFSET
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|sp_banks
(braket
id|i
)braket
dot
id|num_bytes
op_ne
l_int|0
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|voff
OL
id|paddr
op_plus
id|sp_banks
(braket
id|i
)braket
dot
id|num_bytes
)paren
(brace
multiline_comment|/* This matches. */
r_return
id|sp_banks
(braket
id|i
)braket
dot
id|base_addr
op_plus
id|voff
op_minus
id|paddr
suffix:semicolon
)brace
r_else
id|paddr
op_add_assign
id|sp_banks
(braket
id|i
)braket
dot
id|num_bytes
suffix:semicolon
)brace
multiline_comment|/* Shit, gotta consult the MMU, this shouldn&squot;t happen... */
id|printk
c_func
(paren
l_string|&quot;srmmu_virt_to_phys: SRMMU virt to phys translation failed, halting&bslash;n&quot;
)paren
suffix:semicolon
id|halt
c_func
(paren
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
r_int
DECL|function|srmmu_phys_to_virt
id|srmmu_phys_to_virt
c_func
(paren
r_int
r_int
id|paddr
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|offset
op_assign
id|PAGE_OFFSET
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|sp_banks
(braket
id|i
)braket
dot
id|num_bytes
op_ne
l_int|0
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|paddr
op_ge
id|sp_banks
(braket
id|i
)braket
dot
id|base_addr
op_logical_and
id|paddr
OL
(paren
id|sp_banks
(braket
id|i
)braket
dot
id|base_addr
op_plus
id|sp_banks
(braket
id|i
)braket
dot
id|num_bytes
)paren
)paren
(brace
r_return
(paren
id|paddr
op_minus
id|sp_banks
(braket
id|i
)braket
dot
id|base_addr
)paren
op_plus
id|offset
suffix:semicolon
)brace
r_else
id|offset
op_add_assign
id|sp_banks
(braket
id|i
)braket
dot
id|num_bytes
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;srmmu_phys_to_virt: Could not make translation, halting...&bslash;n&quot;
)paren
suffix:semicolon
id|halt
c_func
(paren
)paren
suffix:semicolon
)brace
r_int
r_int
DECL|function|srmmu_vmalloc_start
id|srmmu_vmalloc_start
c_func
(paren
r_void
)paren
(brace
r_return
(paren
(paren
id|high_memory
op_plus
id|SRMMU_VMALLOC_OFFSET
)paren
op_amp
op_complement
(paren
id|SRMMU_VMALLOC_OFFSET
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
r_int
r_int
DECL|function|srmmu_pmd_page
id|srmmu_pmd_page
c_func
(paren
id|pmd_t
id|pmd
)paren
(brace
r_int
r_int
id|page
suffix:semicolon
id|page
op_assign
(paren
id|pmd_val
c_func
(paren
id|pmd
)paren
op_amp
(paren
id|SRMMU_PTD_PTP_MASK
)paren
)paren
op_lshift
id|SRMMU_PTD_PTP_PADDR_SHIFT
suffix:semicolon
r_return
id|srmmu_phys_to_virt
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
r_int
r_int
DECL|function|srmmu_pgd_page
id|srmmu_pgd_page
c_func
(paren
id|pgd_t
id|pgd
)paren
(brace
r_int
r_int
id|page
suffix:semicolon
id|page
op_assign
(paren
id|pgd_val
c_func
(paren
id|pgd
)paren
op_amp
(paren
id|SRMMU_PTD_PTP_MASK
)paren
)paren
op_lshift
id|SRMMU_PTD_PTP_PADDR_SHIFT
suffix:semicolon
r_return
id|srmmu_phys_to_virt
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
r_int
r_int
DECL|function|srmmu_pte_page
id|srmmu_pte_page
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_int
r_int
id|page
suffix:semicolon
id|page
op_assign
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
(paren
id|SRMMU_PTE_PPN_MASK
)paren
)paren
op_lshift
id|SRMMU_PTE_PPN_PADDR_SHIFT
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;srmmu_pte_page: page = %08lx&bslash;n&quot;
comma
id|page
)paren
suffix:semicolon
r_return
id|srmmu_phys_to_virt
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pte_none
r_int
id|srmmu_pte_none
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
op_logical_neg
id|pte_val
c_func
(paren
id|pte
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pte_present
r_int
id|srmmu_pte_present
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
id|SRMMU_ET_PTE
suffix:semicolon
)brace
DECL|function|srmmu_pte_inuse
r_int
id|srmmu_pte_inuse
c_func
(paren
id|pte_t
op_star
id|ptep
)paren
(brace
r_return
id|mem_map
(braket
id|MAP_NR
c_func
(paren
id|ptep
)paren
)braket
op_ne
l_int|1
suffix:semicolon
)brace
DECL|function|srmmu_pte_clear
r_void
id|srmmu_pte_clear
c_func
(paren
id|pte_t
op_star
id|ptep
)paren
(brace
id|pte_val
c_func
(paren
op_star
id|ptep
)paren
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|srmmu_pte_reuse
r_void
id|srmmu_pte_reuse
c_func
(paren
id|pte_t
op_star
id|ptep
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|mem_map
(braket
id|MAP_NR
c_func
(paren
id|ptep
)paren
)braket
op_amp
id|MAP_PAGE_RESERVED
)paren
)paren
(brace
id|mem_map
(braket
id|MAP_NR
c_func
(paren
id|ptep
)paren
)braket
op_increment
suffix:semicolon
)brace
)brace
DECL|function|srmmu_pmd_none
r_int
id|srmmu_pmd_none
c_func
(paren
id|pmd_t
id|pmd
)paren
(brace
r_return
op_logical_neg
id|pmd_val
c_func
(paren
id|pmd
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pmd_bad
r_int
id|srmmu_pmd_bad
c_func
(paren
id|pmd_t
id|pmd
)paren
(brace
r_return
(paren
(paren
id|pmd_val
c_func
(paren
id|pmd
)paren
op_amp
id|SRMMU_ET_PTDBAD
)paren
op_eq
id|SRMMU_ET_PTDBAD
)paren
op_logical_or
(paren
id|srmmu_pmd_page
c_func
(paren
id|pmd
)paren
OG
id|high_memory
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pmd_present
r_int
id|srmmu_pmd_present
c_func
(paren
id|pmd_t
id|pmd
)paren
(brace
r_return
id|pmd_val
c_func
(paren
id|pmd
)paren
op_amp
id|SRMMU_ET_PTD
suffix:semicolon
)brace
DECL|function|srmmu_pmd_inuse
r_int
id|srmmu_pmd_inuse
c_func
(paren
id|pmd_t
op_star
id|pmdp
)paren
(brace
r_return
id|mem_map
(braket
id|MAP_NR
c_func
(paren
id|pmdp
)paren
)braket
op_ne
l_int|1
suffix:semicolon
)brace
DECL|function|srmmu_pmd_clear
r_void
id|srmmu_pmd_clear
c_func
(paren
id|pmd_t
op_star
id|pmdp
)paren
(brace
id|pmd_val
c_func
(paren
op_star
id|pmdp
)paren
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|srmmu_pmd_reuse
r_void
id|srmmu_pmd_reuse
c_func
(paren
id|pmd_t
op_star
id|pmdp
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|mem_map
(braket
id|MAP_NR
c_func
(paren
id|pmdp
)paren
)braket
op_amp
id|MAP_PAGE_RESERVED
)paren
)paren
id|mem_map
(braket
id|MAP_NR
c_func
(paren
id|pmdp
)paren
)braket
op_increment
suffix:semicolon
)brace
DECL|function|srmmu_pgd_none
r_int
id|srmmu_pgd_none
c_func
(paren
id|pgd_t
id|pgd
)paren
(brace
r_return
op_logical_neg
id|pgd_val
c_func
(paren
id|pgd
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pgd_bad
r_int
id|srmmu_pgd_bad
c_func
(paren
id|pgd_t
id|pgd
)paren
(brace
r_return
(paren
(paren
id|pgd_val
c_func
(paren
id|pgd
)paren
op_amp
id|SRMMU_ET_PTDBAD
)paren
op_eq
id|SRMMU_ET_PTDBAD
)paren
op_logical_or
(paren
id|srmmu_pgd_page
c_func
(paren
id|pgd
)paren
OG
id|high_memory
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pgd_present
r_int
id|srmmu_pgd_present
c_func
(paren
id|pgd_t
id|pgd
)paren
(brace
r_return
id|pgd_val
c_func
(paren
id|pgd
)paren
op_amp
id|SRMMU_ET_PTD
suffix:semicolon
)brace
DECL|function|srmmu_pgd_inuse
r_int
id|srmmu_pgd_inuse
c_func
(paren
id|pgd_t
op_star
id|pgdp
)paren
(brace
r_return
id|mem_map
(braket
id|MAP_NR
c_func
(paren
id|pgdp
)paren
)braket
op_ne
l_int|1
suffix:semicolon
)brace
DECL|function|srmmu_pgd_clear
r_void
id|srmmu_pgd_clear
c_func
(paren
id|pgd_t
op_star
id|pgdp
)paren
(brace
id|pgd_val
c_func
(paren
op_star
id|pgdp
)paren
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|srmmu_pgd_reuse
r_void
id|srmmu_pgd_reuse
c_func
(paren
id|pgd_t
op_star
id|pgdp
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|mem_map
(braket
id|MAP_NR
c_func
(paren
id|pgdp
)paren
)braket
op_amp
id|MAP_PAGE_RESERVED
)paren
)paren
id|mem_map
(braket
id|MAP_NR
c_func
(paren
id|pgdp
)paren
)braket
op_increment
suffix:semicolon
)brace
multiline_comment|/*&n; * The following only work if pte_present() is true.&n; * Undefined behaviour if not..&n; */
DECL|function|srmmu_pte_read
r_int
id|srmmu_pte_read
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
id|_SRMMU_PAGE_RDONLY
)paren
op_logical_or
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
id|_SRMMU_PAGE_WRITE_USR
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pte_write
r_int
id|srmmu_pte_write
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
id|_SRMMU_PAGE_WRITE_USR
suffix:semicolon
)brace
DECL|function|srmmu_pte_exec
r_int
id|srmmu_pte_exec
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
id|_SRMMU_PAGE_EXEC
suffix:semicolon
)brace
DECL|function|srmmu_pte_dirty
r_int
id|srmmu_pte_dirty
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
id|_SRMMU_PAGE_DIRTY
suffix:semicolon
)brace
DECL|function|srmmu_pte_young
r_int
id|srmmu_pte_young
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
id|_SRMMU_PAGE_REF
suffix:semicolon
)brace
DECL|function|srmmu_pte_cow
r_int
id|srmmu_pte_cow
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
id|_SRMMU_PAGE_COW
suffix:semicolon
)brace
multiline_comment|/* When we change permissions, we first clear all bits in the ACCESS field&n; * then apply the wanted bits.&n; */
DECL|function|srmmu_pte_wrprotect
id|pte_t
id|srmmu_pte_wrprotect
c_func
(paren
id|pte_t
id|pte
)paren
(brace
id|pte_val
c_func
(paren
id|pte
)paren
op_and_assign
op_complement
id|SRMMU_PTE_ACC_MASK
suffix:semicolon
id|pte_val
c_func
(paren
id|pte
)paren
op_or_assign
id|_SRMMU_PAGE_EXEC
suffix:semicolon
r_return
id|pte
suffix:semicolon
)brace
DECL|function|srmmu_pte_rdprotect
id|pte_t
id|srmmu_pte_rdprotect
c_func
(paren
id|pte_t
id|pte
)paren
(brace
id|pte_val
c_func
(paren
id|pte
)paren
op_and_assign
op_complement
id|SRMMU_PTE_ACC_MASK
suffix:semicolon
id|pte_val
c_func
(paren
id|pte
)paren
op_or_assign
id|_SRMMU_PAGE_NOREAD
suffix:semicolon
r_return
id|pte
suffix:semicolon
)brace
DECL|function|srmmu_pte_exprotect
id|pte_t
id|srmmu_pte_exprotect
c_func
(paren
id|pte_t
id|pte
)paren
(brace
id|pte_val
c_func
(paren
id|pte
)paren
op_and_assign
op_complement
id|SRMMU_PTE_ACC_MASK
suffix:semicolon
id|pte_val
c_func
(paren
id|pte
)paren
op_or_assign
id|_SRMMU_PAGE_WRITE_USR
suffix:semicolon
r_return
id|pte
suffix:semicolon
)brace
DECL|function|srmmu_pte_mkclean
id|pte_t
id|srmmu_pte_mkclean
c_func
(paren
id|pte_t
id|pte
)paren
(brace
id|pte_val
c_func
(paren
id|pte
)paren
op_and_assign
op_complement
id|_SRMMU_PAGE_DIRTY
suffix:semicolon
r_return
id|pte
suffix:semicolon
)brace
DECL|function|srmmu_pte_mkold
id|pte_t
id|srmmu_pte_mkold
c_func
(paren
id|pte_t
id|pte
)paren
(brace
id|pte_val
c_func
(paren
id|pte
)paren
op_and_assign
op_complement
id|_SRMMU_PAGE_REF
suffix:semicolon
r_return
id|pte
suffix:semicolon
)brace
DECL|function|srmmu_pte_uncow
id|pte_t
id|srmmu_pte_uncow
c_func
(paren
id|pte_t
id|pte
)paren
(brace
id|pte_val
c_func
(paren
id|pte
)paren
op_and_assign
op_complement
id|SRMMU_PTE_ACC_MASK
suffix:semicolon
id|pte_val
c_func
(paren
id|pte
)paren
op_or_assign
id|_SRMMU_PAGE_UNCOW
suffix:semicolon
r_return
id|pte
suffix:semicolon
)brace
DECL|function|srmmu_pte_mkwrite
id|pte_t
id|srmmu_pte_mkwrite
c_func
(paren
id|pte_t
id|pte
)paren
(brace
id|pte_val
c_func
(paren
id|pte
)paren
op_and_assign
op_complement
id|SRMMU_PTE_ACC_MASK
suffix:semicolon
id|pte_val
c_func
(paren
id|pte
)paren
op_or_assign
id|_SRMMU_PAGE_WRITE_USR
suffix:semicolon
r_return
id|pte
suffix:semicolon
)brace
DECL|function|srmmu_pte_mkread
id|pte_t
id|srmmu_pte_mkread
c_func
(paren
id|pte_t
id|pte
)paren
(brace
id|pte_val
c_func
(paren
id|pte
)paren
op_and_assign
op_complement
id|SRMMU_PTE_ACC_MASK
suffix:semicolon
id|pte_val
c_func
(paren
id|pte
)paren
op_or_assign
id|_SRMMU_PAGE_RDONLY
suffix:semicolon
r_return
id|pte
suffix:semicolon
)brace
DECL|function|srmmu_pte_mkexec
id|pte_t
id|srmmu_pte_mkexec
c_func
(paren
id|pte_t
id|pte
)paren
(brace
id|pte_val
c_func
(paren
id|pte
)paren
op_and_assign
op_complement
id|SRMMU_PTE_ACC_MASK
suffix:semicolon
id|pte_val
c_func
(paren
id|pte
)paren
op_or_assign
id|_SRMMU_PAGE_EXEC
suffix:semicolon
r_return
id|pte
suffix:semicolon
)brace
DECL|function|srmmu_pte_mkdirty
id|pte_t
id|srmmu_pte_mkdirty
c_func
(paren
id|pte_t
id|pte
)paren
(brace
id|pte_val
c_func
(paren
id|pte
)paren
op_or_assign
id|_SRMMU_PAGE_DIRTY
suffix:semicolon
r_return
id|pte
suffix:semicolon
)brace
DECL|function|srmmu_pte_mkyoung
id|pte_t
id|srmmu_pte_mkyoung
c_func
(paren
id|pte_t
id|pte
)paren
(brace
id|pte_val
c_func
(paren
id|pte
)paren
op_or_assign
id|_SRMMU_PAGE_REF
suffix:semicolon
r_return
id|pte
suffix:semicolon
)brace
DECL|function|srmmu_pte_mkcow
id|pte_t
id|srmmu_pte_mkcow
c_func
(paren
id|pte_t
id|pte
)paren
(brace
id|pte_val
c_func
(paren
id|pte
)paren
op_and_assign
op_complement
id|SRMMU_PTE_ACC_MASK
suffix:semicolon
id|pte_val
c_func
(paren
id|pte
)paren
op_or_assign
id|_SRMMU_PAGE_COW
suffix:semicolon
r_return
id|pte
suffix:semicolon
)brace
multiline_comment|/*&n; * Conversion functions: convert a page and protection to a page entry,&n; * and a page entry and page directory to the page they refer to.&n; */
id|pte_t
DECL|function|srmmu_mk_pte
id|srmmu_mk_pte
c_func
(paren
r_int
r_int
id|page
comma
id|pgprot_t
id|pgprot
)paren
(brace
id|pte_t
id|pte
suffix:semicolon
r_if
c_cond
(paren
id|page
op_amp
(paren
op_complement
id|PAGE_MASK
)paren
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;srmmu_mk_pte() called with unaligned page&quot;
)paren
suffix:semicolon
)brace
id|page
op_assign
(paren
id|srmmu_virt_to_phys
c_func
(paren
id|page
)paren
op_rshift
id|SRMMU_PTE_PPN_PADDR_SHIFT
)paren
suffix:semicolon
id|pte_val
c_func
(paren
id|pte
)paren
op_assign
(paren
id|page
op_amp
id|SRMMU_PTE_PPN_MASK
)paren
suffix:semicolon
id|pte_val
c_func
(paren
id|pte
)paren
op_or_assign
id|pgprot_val
c_func
(paren
id|pgprot
)paren
suffix:semicolon
r_return
id|pte
suffix:semicolon
)brace
r_void
DECL|function|srmmu_pgd_set
id|srmmu_pgd_set
c_func
(paren
id|pgd_t
op_star
id|pgdp
comma
id|pmd_t
op_star
id|pmdp
)paren
(brace
r_int
r_int
id|page
op_assign
(paren
r_int
r_int
)paren
id|pmdp
suffix:semicolon
id|page
op_assign
(paren
id|srmmu_virt_to_phys
c_func
(paren
id|page
)paren
op_rshift
id|SRMMU_PTD_PTP_PADDR_SHIFT
)paren
suffix:semicolon
id|pgd_val
c_func
(paren
op_star
id|pgdp
)paren
op_assign
(paren
(paren
id|page
op_amp
id|SRMMU_PTD_PTP_MASK
)paren
op_or
id|SRMMU_ET_PTD
)paren
suffix:semicolon
)brace
r_void
DECL|function|srmmu_pmd_set
id|srmmu_pmd_set
c_func
(paren
id|pmd_t
op_star
id|pmdp
comma
id|pte_t
op_star
id|ptep
)paren
(brace
r_int
r_int
id|page
op_assign
(paren
r_int
r_int
)paren
id|ptep
suffix:semicolon
id|page
op_assign
(paren
id|srmmu_virt_to_phys
c_func
(paren
id|page
)paren
op_rshift
id|SRMMU_PTD_PTP_PADDR_SHIFT
)paren
suffix:semicolon
id|pmd_val
c_func
(paren
op_star
id|pmdp
)paren
op_assign
(paren
(paren
id|page
op_amp
id|SRMMU_PTD_PTP_MASK
)paren
op_or
id|SRMMU_ET_PTD
)paren
suffix:semicolon
)brace
id|pte_t
DECL|function|srmmu_pte_modify
id|srmmu_pte_modify
c_func
(paren
id|pte_t
id|pte
comma
id|pgprot_t
id|newprot
)paren
(brace
id|pte_val
c_func
(paren
id|pte
)paren
op_assign
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
(paren
op_complement
id|SRMMU_PTE_ACC_MASK
)paren
)paren
op_or
id|pgprot_val
c_func
(paren
id|newprot
)paren
suffix:semicolon
r_return
id|pte
suffix:semicolon
)brace
multiline_comment|/* to find an entry in a top-level page table... */
id|pgd_t
op_star
DECL|function|srmmu_pgd_offset
id|srmmu_pgd_offset
c_func
(paren
r_struct
id|task_struct
op_star
id|tsk
comma
r_int
r_int
id|address
)paren
(brace
r_return
(paren
(paren
id|pgd_t
op_star
)paren
id|tsk-&gt;tss.pgd_ptr
)paren
op_plus
(paren
(paren
id|address
op_rshift
id|SRMMU_PGDIR_SHIFT
)paren
op_amp
(paren
id|SRMMU_PTRS_PER_PGD
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Find an entry in the second-level page table.. */
id|pmd_t
op_star
DECL|function|srmmu_pmd_offset
id|srmmu_pmd_offset
c_func
(paren
id|pgd_t
op_star
id|dir
comma
r_int
r_int
id|address
)paren
(brace
r_return
(paren
(paren
id|pmd_t
op_star
)paren
id|pgd_page
c_func
(paren
op_star
id|dir
)paren
)paren
op_plus
(paren
(paren
id|address
op_rshift
id|SRMMU_PMD_SHIFT
)paren
op_amp
(paren
id|SRMMU_PTRS_PER_PMD
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Find an entry in the third-level page table.. */
id|pte_t
op_star
DECL|function|srmmu_pte_offset
id|srmmu_pte_offset
c_func
(paren
id|pmd_t
op_star
id|dir
comma
r_int
r_int
id|address
)paren
(brace
r_return
(paren
(paren
id|pte_t
op_star
)paren
id|pmd_page
c_func
(paren
op_star
id|dir
)paren
)paren
op_plus
(paren
(paren
id|address
op_rshift
id|PAGE_SHIFT
)paren
op_amp
(paren
id|SRMMU_PTRS_PER_PTE
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* This must update the context register for this process. */
r_void
DECL|function|srmmu_update_rootmmu_dir
id|srmmu_update_rootmmu_dir
c_func
(paren
r_struct
id|task_struct
op_star
id|tsk
comma
id|pgd_t
op_star
id|pgdir
)paren
(brace
multiline_comment|/* See if this process has a context entry already, like after execve() */
r_if
c_cond
(paren
id|tsk-&gt;tss.context
op_ne
op_minus
l_int|1
)paren
(brace
id|pgd_t
op_star
id|ctable_ptr
op_assign
l_int|0
suffix:semicolon
id|ctable_ptr
op_assign
(paren
id|pgd_t
op_star
)paren
id|srmmu_phys_to_virt
c_func
(paren
id|srmmu_get_ctable_ptr
c_func
(paren
)paren
)paren
suffix:semicolon
id|ctable_ptr
op_add_assign
id|tsk-&gt;tss.context
suffix:semicolon
id|srmmu_pgd_set
c_func
(paren
id|ctable_ptr
comma
(paren
id|pmd_t
op_star
)paren
id|pgdir
)paren
suffix:semicolon
multiline_comment|/* Should flush caches here too... */
id|srmmu_flush_whole_tlb
c_func
(paren
)paren
suffix:semicolon
)brace
id|tsk-&gt;tss.pgd_ptr
op_assign
(paren
r_int
r_int
)paren
id|pgdir
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Allocate and free page tables. The xxx_kernel() versions are&n; * used to allocate a kernel page table - this turns on ASN bits&n; * if any, and marks the page tables reserved.&n; */
r_void
DECL|function|srmmu_pte_free_kernel
id|srmmu_pte_free_kernel
c_func
(paren
id|pte_t
op_star
id|pte
)paren
(brace
id|mem_map
(braket
id|MAP_NR
c_func
(paren
id|pte
)paren
)braket
op_assign
l_int|1
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|pte
)paren
suffix:semicolon
)brace
id|pte_t
op_star
DECL|function|srmmu_pte_alloc_kernel
id|srmmu_pte_alloc_kernel
c_func
(paren
id|pmd_t
op_star
id|pmd
comma
r_int
r_int
id|address
)paren
(brace
id|pte_t
op_star
id|page
suffix:semicolon
id|address
op_assign
(paren
id|address
op_rshift
id|PAGE_SHIFT
)paren
op_amp
(paren
id|SRMMU_PTRS_PER_PTE
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_pmd_none
c_func
(paren
op_star
id|pmd
)paren
)paren
(brace
id|page
op_assign
(paren
id|pte_t
op_star
)paren
id|get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_pmd_none
c_func
(paren
op_star
id|pmd
)paren
)paren
(brace
r_if
c_cond
(paren
id|page
)paren
(brace
id|srmmu_pmd_set
c_func
(paren
id|pmd
comma
id|page
)paren
suffix:semicolon
id|mem_map
(braket
id|MAP_NR
c_func
(paren
id|page
)paren
)braket
op_assign
id|MAP_PAGE_RESERVED
suffix:semicolon
r_return
id|page
op_plus
id|address
suffix:semicolon
)brace
id|srmmu_pmd_set
c_func
(paren
id|pmd
comma
(paren
id|pte_t
op_star
)paren
id|SRMMU_ET_PTDBAD
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|srmmu_pmd_bad
c_func
(paren
op_star
id|pmd
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Bad pmd in pte_alloc_kernel: %08lx&bslash;n&quot;
comma
id|pmd_val
c_func
(paren
op_star
id|pmd
)paren
)paren
suffix:semicolon
id|srmmu_pmd_set
c_func
(paren
id|pmd
comma
(paren
id|pte_t
op_star
)paren
id|SRMMU_ET_PTDBAD
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
(paren
id|pte_t
op_star
)paren
id|srmmu_pmd_page
c_func
(paren
op_star
id|pmd
)paren
op_plus
id|address
suffix:semicolon
)brace
multiline_comment|/* Full three level on SRMMU */
r_void
DECL|function|srmmu_pmd_free_kernel
id|srmmu_pmd_free_kernel
c_func
(paren
id|pmd_t
op_star
id|pmd
)paren
(brace
id|mem_map
(braket
id|MAP_NR
c_func
(paren
id|pmd
)paren
)braket
op_assign
l_int|1
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|pmd
)paren
suffix:semicolon
)brace
id|pmd_t
op_star
DECL|function|srmmu_pmd_alloc_kernel
id|srmmu_pmd_alloc_kernel
c_func
(paren
id|pgd_t
op_star
id|pgd
comma
r_int
r_int
id|address
)paren
(brace
id|pmd_t
op_star
id|page
suffix:semicolon
id|address
op_assign
(paren
id|address
op_rshift
id|SRMMU_PMD_SHIFT
)paren
op_amp
(paren
id|SRMMU_PTRS_PER_PMD
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_pgd_none
c_func
(paren
op_star
id|pgd
)paren
)paren
(brace
id|page
op_assign
(paren
id|pmd_t
op_star
)paren
id|get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_pgd_none
c_func
(paren
op_star
id|pgd
)paren
)paren
(brace
r_if
c_cond
(paren
id|page
)paren
(brace
id|srmmu_pgd_set
c_func
(paren
id|pgd
comma
id|page
)paren
suffix:semicolon
id|mem_map
(braket
id|MAP_NR
c_func
(paren
id|page
)paren
)braket
op_assign
id|MAP_PAGE_RESERVED
suffix:semicolon
r_return
id|page
op_plus
id|address
suffix:semicolon
)brace
id|srmmu_pgd_set
c_func
(paren
id|pgd
comma
(paren
id|pmd_t
op_star
)paren
id|SRMMU_ET_PTDBAD
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|srmmu_pgd_bad
c_func
(paren
op_star
id|pgd
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Bad pgd in pmd_alloc_kernel: %08lx&bslash;n&quot;
comma
id|pgd_val
c_func
(paren
op_star
id|pgd
)paren
)paren
suffix:semicolon
id|srmmu_pgd_set
c_func
(paren
id|pgd
comma
(paren
id|pmd_t
op_star
)paren
id|SRMMU_ET_PTDBAD
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
(paren
id|pmd_t
op_star
)paren
id|srmmu_pgd_page
c_func
(paren
op_star
id|pgd
)paren
op_plus
id|address
suffix:semicolon
)brace
r_void
DECL|function|srmmu_pte_free
id|srmmu_pte_free
c_func
(paren
id|pte_t
op_star
id|pte
)paren
(brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|pte
)paren
suffix:semicolon
)brace
id|pte_t
op_star
DECL|function|srmmu_pte_alloc
id|srmmu_pte_alloc
c_func
(paren
id|pmd_t
op_star
id|pmd
comma
r_int
r_int
id|address
)paren
(brace
id|pte_t
op_star
id|page
suffix:semicolon
id|address
op_assign
(paren
id|address
op_rshift
id|PAGE_SHIFT
)paren
op_amp
(paren
id|SRMMU_PTRS_PER_PTE
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_pmd_none
c_func
(paren
op_star
id|pmd
)paren
)paren
(brace
id|page
op_assign
(paren
id|pte_t
op_star
)paren
id|get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_pmd_none
c_func
(paren
op_star
id|pmd
)paren
)paren
(brace
r_if
c_cond
(paren
id|page
)paren
(brace
id|srmmu_pmd_set
c_func
(paren
id|pmd
comma
id|page
)paren
suffix:semicolon
id|mem_map
(braket
id|MAP_NR
c_func
(paren
id|page
)paren
)braket
op_assign
id|MAP_PAGE_RESERVED
suffix:semicolon
r_return
id|page
op_plus
id|address
suffix:semicolon
)brace
id|srmmu_pmd_set
c_func
(paren
id|pmd
comma
(paren
id|pte_t
op_star
)paren
id|SRMMU_ET_PTDBAD
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|srmmu_pmd_bad
c_func
(paren
op_star
id|pmd
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Bad pmd in pte_alloc_kernel: %08lx&bslash;n&quot;
comma
id|pmd_val
c_func
(paren
op_star
id|pmd
)paren
)paren
suffix:semicolon
id|srmmu_pmd_set
c_func
(paren
id|pmd
comma
(paren
id|pte_t
op_star
)paren
id|SRMMU_ET_PTDBAD
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
(paren
id|pte_t
op_star
)paren
id|srmmu_pmd_page
c_func
(paren
op_star
id|pmd
)paren
op_plus
id|address
suffix:semicolon
)brace
multiline_comment|/*&n; * allocating and freeing a pmd is trivial: the 1-entry pmd is&n; * inside the pgd, so has no extra memory associated with it.&n; */
r_void
DECL|function|srmmu_pmd_free
id|srmmu_pmd_free
c_func
(paren
id|pmd_t
op_star
id|pmd
)paren
(brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|pmd
)paren
suffix:semicolon
)brace
id|pmd_t
op_star
DECL|function|srmmu_pmd_alloc
id|srmmu_pmd_alloc
c_func
(paren
id|pgd_t
op_star
id|pgd
comma
r_int
r_int
id|address
)paren
(brace
id|pmd_t
op_star
id|page
suffix:semicolon
id|address
op_assign
(paren
id|address
op_rshift
id|SRMMU_PMD_SHIFT
)paren
op_amp
(paren
id|SRMMU_PTRS_PER_PMD
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_pgd_none
c_func
(paren
op_star
id|pgd
)paren
)paren
(brace
id|page
op_assign
(paren
id|pmd_t
op_star
)paren
id|get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_pgd_none
c_func
(paren
op_star
id|pgd
)paren
)paren
(brace
r_if
c_cond
(paren
id|page
)paren
(brace
id|srmmu_pgd_set
c_func
(paren
id|pgd
comma
id|page
)paren
suffix:semicolon
id|mem_map
(braket
id|MAP_NR
c_func
(paren
id|page
)paren
)braket
op_assign
id|MAP_PAGE_RESERVED
suffix:semicolon
r_return
id|page
op_plus
id|address
suffix:semicolon
)brace
id|srmmu_pgd_set
c_func
(paren
id|pgd
comma
(paren
id|pmd_t
op_star
)paren
id|SRMMU_ET_PTDBAD
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|srmmu_pgd_bad
c_func
(paren
op_star
id|pgd
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Bad pgd in pmd_alloc_kernel: %08lx&bslash;n&quot;
comma
id|pgd_val
c_func
(paren
op_star
id|pgd
)paren
)paren
suffix:semicolon
id|srmmu_pgd_set
c_func
(paren
id|pgd
comma
(paren
id|pmd_t
op_star
)paren
id|SRMMU_ET_PTDBAD
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
(paren
id|pmd_t
op_star
)paren
id|srmmu_pgd_page
c_func
(paren
op_star
id|pgd
)paren
op_plus
id|address
suffix:semicolon
)brace
r_void
DECL|function|srmmu_pgd_free
id|srmmu_pgd_free
c_func
(paren
id|pgd_t
op_star
id|pgd
)paren
(brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|pgd
)paren
suffix:semicolon
)brace
multiline_comment|/* A page directory on the srmmu needs 1k, but for now to simplify the&n; * alignment constraints and allocation we just grab a whole page.&n; */
id|pgd_t
op_star
DECL|function|srmmu_pgd_alloc
id|srmmu_pgd_alloc
c_func
(paren
r_void
)paren
(brace
r_return
(paren
id|pgd_t
op_star
)paren
id|get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
multiline_comment|/* Just flush the whole thing for now. We will need module&n; * specific invalidate routines in certain circumstances,&n; * because of different flushing facilities and hardware&n; * bugs.&n; */
r_void
DECL|function|srmmu_invalidate
id|srmmu_invalidate
c_func
(paren
r_void
)paren
(brace
id|srmmu_flush_whole_tlb
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|srmmu_set_pte
id|srmmu_set_pte
c_func
(paren
id|pte_t
op_star
id|ptep
comma
id|pte_t
id|entry
)paren
(brace
multiline_comment|/* for now... */
op_star
id|ptep
op_assign
id|entry
suffix:semicolon
)brace
multiline_comment|/* XXX Needs to be written */
r_void
DECL|function|srmmu_switch_to_context
id|srmmu_switch_to_context
c_func
(paren
r_int
id|context
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;switching to context %d&bslash;n&quot;
comma
id|context
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Low level IO area allocation on the SRMMU.&n; *&n; * I think we can get away with just using a regular page translation,&n; * just making sure the cacheable bit is off.  I would like to avoid&n; * having to mess with the IOMMU if at all possible at first.&n; *&n; * Aparently IOMMU is only necessary for SBus devices, maybe VME too.&n; * We&squot;ll see...&n; */
r_void
DECL|function|srmmu_mapioaddr
id|srmmu_mapioaddr
c_func
(paren
r_int
r_int
id|physaddr
comma
r_int
r_int
id|virt_addr
comma
r_int
id|bus_type
comma
r_int
id|rdonly
)paren
(brace
id|pgd_t
op_star
id|pgdp
suffix:semicolon
id|pmd_t
op_star
id|pmdp
suffix:semicolon
id|pte_t
op_star
id|ptep
suffix:semicolon
id|pgdp
op_assign
id|srmmu_pgd_offset
c_func
(paren
op_amp
id|init_task
comma
id|virt_addr
)paren
suffix:semicolon
id|pmdp
op_assign
id|srmmu_pmd_offset
c_func
(paren
id|pgdp
comma
id|virt_addr
)paren
suffix:semicolon
id|ptep
op_assign
id|srmmu_pte_offset
c_func
(paren
id|pmdp
comma
id|virt_addr
)paren
suffix:semicolon
id|pte_val
c_func
(paren
op_star
id|ptep
)paren
op_assign
(paren
id|physaddr
op_rshift
id|SRMMU_PTE_PPN_PADDR_SHIFT
)paren
op_amp
id|SRMMU_PTE_PPN_MASK
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rdonly
)paren
(brace
id|pte_val
c_func
(paren
op_star
id|ptep
)paren
op_or_assign
(paren
id|SRMMU_ACC_S_RDWREXEC
op_or
id|SRMMU_ET_PTE
)paren
suffix:semicolon
)brace
r_else
id|pte_val
c_func
(paren
op_star
id|ptep
)paren
op_or_assign
(paren
id|SRMMU_ACC_S_RDEXEC
op_or
id|SRMMU_ET_PTE
)paren
suffix:semicolon
id|pte_val
c_func
(paren
op_star
id|ptep
)paren
op_or_assign
(paren
id|bus_type
op_lshift
l_int|28
)paren
suffix:semicolon
id|pte_val
c_func
(paren
op_star
id|ptep
)paren
op_and_assign
op_complement
(paren
id|SRMMU_PTE_C_MASK
)paren
suffix:semicolon
multiline_comment|/* Make sure cacheable bit is off. */
id|srmmu_flush_whole_tlb
c_func
(paren
)paren
suffix:semicolon
id|flush_ei_ctx
c_func
(paren
l_int|0x0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Perfom a some soft of MMU tablewalk.&n; * Long contiguous mappings are not supported (yet ?).&n; *&n; * Origionally written by Peter Zaitcev, modified by David S.&n; * Miller.  This is only used to copy over the PROM/KADB mappings&n; * in srmmu_paging_init().&n; *&n; * The return value encodes at what level the entry was found,&n; * basically this is found in the lower 2 bits of the return&n; * value.  If the return value is zero, there was no valid mapping&n; * found at all, the low bits for a non-zero return value&n; * are:&n; *         0 -- Level 1 PTE&n; *         1 -- Level 2 PTE&n; *         2 -- Normal level 3 PTE&n; *         3 -- Context Table PTE (unlikely, but still)&n; * &n; * Also note that this is called before the context table pointer&n; * register is changed, so the PROMs entry is still in there.  Also,&n; * it is safe to assume that the context 0 contains the mappings.&n; */
multiline_comment|/* TODO chop out &squot;trace&squot; when stable */
r_int
r_int
DECL|function|srmmu_init_twalk
id|srmmu_init_twalk
c_func
(paren
r_int
id|virt
comma
r_int
id|trace
)paren
(brace
r_int
r_int
id|wh
comma
id|root
suffix:semicolon
id|root
op_assign
(paren
r_int
r_int
)paren
id|srmmu_get_ctable_ptr
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|trace
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;:0x%x &gt;&gt; &quot;
comma
id|virt
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|trace
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; 0x%x :&quot;
comma
id|root
)paren
suffix:semicolon
)brace
id|wh
op_assign
id|ldw_sun4m_bypass
c_func
(paren
id|root
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|wh
op_amp
id|SRMMU_PTE_ET_MASK
)paren
op_eq
id|SRMMU_ET_INVALID
)paren
(brace
r_if
c_cond
(paren
id|trace
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|wh
op_amp
id|SRMMU_PTE_ET_MASK
)paren
op_eq
id|SRMMU_ET_PTE
)paren
(brace
id|wh
op_and_assign
op_complement
id|SRMMU_PTE_ET_MASK
suffix:semicolon
id|wh
op_or_assign
l_int|0x3
suffix:semicolon
r_if
c_cond
(paren
id|trace
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;AIEEE context table level pte prom mapping!&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|trace
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; 0x%x .&quot;
comma
id|wh
)paren
suffix:semicolon
)brace
id|wh
op_assign
id|ldw_sun4m_bypass
c_func
(paren
(paren
(paren
id|wh
op_amp
id|SRMMU_PTD_PTP_MASK
)paren
op_lshift
l_int|4
)paren
op_plus
(paren
(paren
id|virt
op_amp
id|SRMMU_IDX1_MASK
)paren
op_rshift
id|SRMMU_IDX1_SHIFT
)paren
op_star
r_sizeof
(paren
id|pte_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|wh
op_amp
id|SRMMU_PTE_ET_MASK
)paren
op_eq
id|SRMMU_ET_INVALID
)paren
(brace
r_if
c_cond
(paren
id|trace
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|wh
op_amp
id|SRMMU_PTE_ET_MASK
)paren
op_eq
id|SRMMU_ET_PTE
)paren
(brace
id|wh
op_and_assign
op_complement
id|SRMMU_PTE_ET_MASK
suffix:semicolon
r_if
c_cond
(paren
id|trace
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|wh
suffix:semicolon
)brace
r_if
c_cond
(paren
id|trace
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; 0x%x .&quot;
comma
id|wh
)paren
suffix:semicolon
)brace
id|wh
op_assign
id|ldw_sun4m_bypass
c_func
(paren
(paren
(paren
id|wh
op_amp
id|SRMMU_PTD_PTP_MASK
)paren
op_lshift
l_int|4
)paren
op_plus
(paren
(paren
id|virt
op_amp
id|SRMMU_IDX2_MASK
)paren
op_rshift
id|SRMMU_IDX2_SHIFT
)paren
op_star
r_sizeof
(paren
id|pte_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|wh
op_amp
id|SRMMU_PTE_ET_MASK
)paren
op_eq
id|SRMMU_ET_INVALID
)paren
(brace
r_if
c_cond
(paren
id|trace
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|wh
op_amp
id|SRMMU_PTE_ET_MASK
)paren
op_eq
id|SRMMU_ET_PTE
)paren
(brace
id|wh
op_and_assign
op_complement
id|SRMMU_PTE_ET_MASK
suffix:semicolon
id|wh
op_or_assign
l_int|0x1
suffix:semicolon
r_if
c_cond
(paren
id|trace
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|wh
suffix:semicolon
)brace
r_if
c_cond
(paren
id|trace
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; 0x%x .&quot;
comma
id|wh
)paren
suffix:semicolon
)brace
id|wh
op_assign
id|ldw_sun4m_bypass
c_func
(paren
(paren
(paren
id|wh
op_amp
id|SRMMU_PTD_PTP_MASK
)paren
op_lshift
l_int|4
)paren
op_plus
(paren
(paren
id|virt
op_amp
id|SRMMU_IDX3_MASK
)paren
op_rshift
id|SRMMU_IDX3_SHIFT
)paren
op_star
r_sizeof
(paren
id|pte_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|wh
op_amp
id|SRMMU_PTE_ET_MASK
)paren
op_eq
id|SRMMU_ET_INVALID
)paren
(brace
r_if
c_cond
(paren
id|trace
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|trace
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; 0x%x&bslash;n&quot;
comma
id|wh
)paren
suffix:semicolon
)brace
r_return
id|wh
suffix:semicolon
)brace
multiline_comment|/* Allocate a block of RAM which is aligned to its size.&n; * This procedure can be used until the call to mem_init().&n; *&n; * To get around the elf bootloader nastyness we have a&n; * early-on page table pool allocation area starting at&n; * C_LABEL(pg0) which is 256k, this should be enough for now.&n; */
r_static
r_void
op_star
DECL|function|srmmu_init_alloc
id|srmmu_init_alloc
c_func
(paren
r_int
r_int
op_star
id|kbrk
comma
r_int
id|size
)paren
(brace
r_register
r_int
id|mask
op_assign
id|size
op_minus
l_int|1
suffix:semicolon
r_register
r_int
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|size
op_eq
l_int|0
)paren
(brace
r_return
l_int|0x0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|size
op_amp
id|mask
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;panic: srmmu_init_alloc botch&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|ret
op_assign
(paren
op_star
id|kbrk
op_plus
id|mask
)paren
op_amp
op_complement
id|mask
suffix:semicolon
op_star
id|kbrk
op_assign
id|ret
op_plus
id|size
suffix:semicolon
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|ret
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
r_return
(paren
r_void
op_star
)paren
id|ret
suffix:semicolon
)brace
r_extern
r_int
r_int
id|srmmu_data_fault
comma
id|srmmu_text_fault
suffix:semicolon
multiline_comment|/* Patch in the SRMMU fault handlers for the trap table. */
r_void
DECL|function|srmmu_patch_fhandlers
id|srmmu_patch_fhandlers
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Say the following ten times fast... */
id|sparc_ttable
(braket
id|SP_TRAP_TFLT
)braket
dot
id|inst_one
op_assign
id|SPARC_MOV_CONST_L3
c_func
(paren
l_int|0x1
)paren
suffix:semicolon
id|sparc_ttable
(braket
id|SP_TRAP_TFLT
)braket
dot
id|inst_two
op_assign
id|SPARC_BRANCH
c_func
(paren
(paren
r_int
r_int
)paren
op_amp
id|srmmu_text_fault
comma
(paren
r_int
r_int
)paren
op_amp
id|sparc_ttable
(braket
id|SP_TRAP_TFLT
)braket
dot
id|inst_two
)paren
suffix:semicolon
id|sparc_ttable
(braket
id|SP_TRAP_TFLT
)braket
dot
id|inst_three
op_assign
id|SPARC_RD_PSR_L0
suffix:semicolon
id|sparc_ttable
(braket
id|SP_TRAP_TFLT
)braket
dot
id|inst_four
op_assign
id|SPARC_NOP
suffix:semicolon
id|sparc_ttable
(braket
id|SP_TRAP_DFLT
)braket
dot
id|inst_one
op_assign
id|SPARC_MOV_CONST_L3
c_func
(paren
l_int|0x9
)paren
suffix:semicolon
id|sparc_ttable
(braket
id|SP_TRAP_DFLT
)braket
dot
id|inst_two
op_assign
id|SPARC_BRANCH
c_func
(paren
(paren
r_int
r_int
)paren
op_amp
id|srmmu_data_fault
comma
(paren
r_int
r_int
)paren
op_amp
id|sparc_ttable
(braket
id|SP_TRAP_DFLT
)braket
dot
id|inst_two
)paren
suffix:semicolon
id|sparc_ttable
(braket
id|SP_TRAP_DFLT
)braket
dot
id|inst_three
op_assign
id|SPARC_RD_PSR_L0
suffix:semicolon
id|sparc_ttable
(braket
id|SP_TRAP_DFLT
)braket
dot
id|inst_four
op_assign
id|SPARC_NOP
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Paging initialization on the Sparc Reference MMU. */
multiline_comment|/* This is all poorly designed, we cannot assume any pages are valid&n; * past _end until *after* this routine runs, thus we can&squot;t use the&n; * start_mem mechanism during initialization...&n; */
DECL|variable|mempool
r_static
r_int
r_int
id|mempool
suffix:semicolon
multiline_comment|/* The following is global because trap_init needs it to fire up&n; * the other cpu&squot;s on multiprocessors.&n; */
DECL|variable|lnx_root
id|pgd_t
op_star
id|lnx_root
suffix:semicolon
multiline_comment|/* Pointer to the new root table */
r_extern
r_char
id|start
(braket
)braket
suffix:semicolon
r_int
r_int
DECL|function|srmmu_paging_init
id|srmmu_paging_init
c_func
(paren
r_int
r_int
id|start_mem
comma
r_int
r_int
id|end_mem
)paren
(brace
r_int
r_int
id|vaddr
suffix:semicolon
multiline_comment|/* Virtual counter */
r_int
id|i
suffix:semicolon
id|pte_t
op_star
id|ptep
op_assign
l_int|0
suffix:semicolon
id|pmd_t
op_star
id|pmdp
op_assign
l_int|0
suffix:semicolon
id|pgd_t
op_star
id|pgdp
op_assign
l_int|0
suffix:semicolon
id|mempool
op_assign
id|start_mem
suffix:semicolon
id|lnx_root
op_assign
id|srmmu_init_alloc
c_func
(paren
op_amp
id|mempool
comma
id|num_contexts
op_star
r_sizeof
(paren
id|pgd_t
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|swapper_pg_dir
comma
l_int|0
comma
id|PAGE_SIZE
)paren
suffix:semicolon
multiline_comment|/* For every entry in the new Linux context table, put in&n;&t; * an entry which points to swapper_pg_dir .&n;&t; */
id|pmdp
op_assign
(paren
id|pmd_t
op_star
)paren
id|swapper_pg_dir
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_contexts
suffix:semicolon
id|i
op_increment
)paren
(brace
id|srmmu_pgd_set
c_func
(paren
op_amp
id|lnx_root
(braket
id|i
)braket
comma
id|pmdp
)paren
suffix:semicolon
)brace
multiline_comment|/* Make Linux physical page tables. */
r_for
c_loop
(paren
id|vaddr
op_assign
id|KERNBASE
suffix:semicolon
id|vaddr
OL
id|end_mem
suffix:semicolon
id|vaddr
op_add_assign
id|PAGE_SIZE
)paren
(brace
id|pgdp
op_assign
id|srmmu_pgd_offset
c_func
(paren
op_amp
id|init_task
comma
id|vaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_pgd_none
c_func
(paren
op_star
id|pgdp
)paren
)paren
(brace
id|pmdp
op_assign
id|srmmu_init_alloc
c_func
(paren
op_amp
id|mempool
comma
id|SRMMU_PTRS_PER_PMD
op_star
r_sizeof
(paren
id|pmd_t
)paren
)paren
suffix:semicolon
id|srmmu_pgd_set
c_func
(paren
id|pgdp
comma
id|pmdp
)paren
suffix:semicolon
)brace
id|pmdp
op_assign
id|srmmu_pmd_offset
c_func
(paren
id|pgdp
comma
id|vaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_pmd_none
c_func
(paren
op_star
id|pmdp
)paren
)paren
(brace
id|ptep
op_assign
id|srmmu_init_alloc
c_func
(paren
op_amp
id|mempool
comma
id|SRMMU_PTRS_PER_PTE
op_star
r_sizeof
(paren
id|pte_t
)paren
)paren
suffix:semicolon
id|srmmu_pmd_set
c_func
(paren
id|pmdp
comma
id|ptep
)paren
suffix:semicolon
)brace
id|ptep
op_assign
id|srmmu_pte_offset
c_func
(paren
id|pmdp
comma
id|vaddr
)paren
suffix:semicolon
op_star
id|ptep
op_assign
id|srmmu_mk_pte
c_func
(paren
id|vaddr
comma
id|SRMMU_PAGE_KERNEL
)paren
suffix:semicolon
)brace
multiline_comment|/* Map IO areas. */
r_for
c_loop
(paren
id|vaddr
op_assign
id|IOBASE_VADDR
suffix:semicolon
id|vaddr
OL
(paren
id|IOBASE_VADDR
op_plus
id|IOBASE_LEN
)paren
suffix:semicolon
id|vaddr
op_add_assign
id|SRMMU_PMD_SIZE
)paren
(brace
id|pgdp
op_assign
id|srmmu_pgd_offset
c_func
(paren
op_amp
id|init_task
comma
id|vaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_pgd_none
c_func
(paren
op_star
id|pgdp
)paren
)paren
(brace
id|pmdp
op_assign
id|srmmu_init_alloc
c_func
(paren
op_amp
id|mempool
comma
id|SRMMU_PTRS_PER_PMD
op_star
r_sizeof
(paren
id|pmd_t
)paren
)paren
suffix:semicolon
id|srmmu_pgd_set
c_func
(paren
id|pgdp
comma
id|pmdp
)paren
suffix:semicolon
)brace
id|pmdp
op_assign
id|srmmu_pmd_offset
c_func
(paren
id|pgdp
comma
id|vaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_pmd_none
c_func
(paren
op_star
id|pmdp
)paren
)paren
(brace
id|ptep
op_assign
id|srmmu_init_alloc
c_func
(paren
op_amp
id|mempool
comma
id|SRMMU_PTRS_PER_PTE
op_star
r_sizeof
(paren
id|pte_t
)paren
)paren
suffix:semicolon
id|srmmu_pmd_set
c_func
(paren
id|pmdp
comma
id|ptep
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Map in the PERCPU areas in virtual address space. */
id|printk
c_func
(paren
l_string|&quot;PERCPU_VADDR + PERCPU_LEN = %08lx&bslash;n&quot;
comma
(paren
id|PERCPU_VADDR
op_plus
id|PERCPU_LEN
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|vaddr
op_assign
id|PERCPU_VADDR
suffix:semicolon
id|vaddr
OL
(paren
id|PERCPU_VADDR
op_plus
id|PERCPU_LEN
)paren
suffix:semicolon
id|vaddr
op_add_assign
id|PERCPU_ENTSIZE
)paren
(brace
id|pgdp
op_assign
id|srmmu_pgd_offset
c_func
(paren
op_amp
id|init_task
comma
id|vaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_pgd_none
c_func
(paren
op_star
id|pgdp
)paren
)paren
(brace
id|pmdp
op_assign
id|srmmu_init_alloc
c_func
(paren
op_amp
id|mempool
comma
id|SRMMU_PTRS_PER_PMD
op_star
r_sizeof
(paren
id|pmd_t
)paren
)paren
suffix:semicolon
id|srmmu_pgd_set
c_func
(paren
id|pgdp
comma
id|pmdp
)paren
suffix:semicolon
)brace
id|pmdp
op_assign
id|srmmu_pmd_offset
c_func
(paren
id|pgdp
comma
id|vaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_pmd_none
c_func
(paren
op_star
id|pmdp
)paren
)paren
(brace
id|ptep
op_assign
id|srmmu_init_alloc
c_func
(paren
op_amp
id|mempool
comma
id|SRMMU_PTRS_PER_PTE
op_star
r_sizeof
(paren
id|pte_t
)paren
)paren
suffix:semicolon
id|srmmu_pmd_set
c_func
(paren
id|pmdp
comma
id|ptep
)paren
suffix:semicolon
)brace
id|ptep
op_assign
id|srmmu_pte_offset
c_func
(paren
id|pmdp
comma
id|vaddr
)paren
suffix:semicolon
multiline_comment|/* Per-cpu trap table page. */
op_star
id|ptep
op_increment
op_assign
id|srmmu_mk_pte
c_func
(paren
(paren
r_int
r_int
)paren
id|start
comma
id|SRMMU_PAGE_KERNEL
)paren
suffix:semicolon
multiline_comment|/* Per-cpu kernel stack page. */
op_star
id|ptep
op_increment
op_assign
id|srmmu_mk_pte
c_func
(paren
(paren
r_int
r_int
)paren
id|srmmu_init_alloc
c_func
(paren
op_amp
id|mempool
comma
id|PAGE_SIZE
)paren
comma
id|SRMMU_PAGE_KERNEL
)paren
suffix:semicolon
multiline_comment|/* Per-cpu Prom MBox. */
op_star
id|ptep
op_increment
op_assign
id|srmmu_mk_pte
c_func
(paren
(paren
r_int
r_int
)paren
id|srmmu_init_alloc
c_func
(paren
op_amp
id|mempool
comma
id|PAGE_SIZE
)paren
comma
id|SRMMU_PAGE_KERNEL
)paren
suffix:semicolon
multiline_comment|/* Per-cpu state variables. */
op_star
id|ptep
op_assign
id|srmmu_mk_pte
c_func
(paren
(paren
r_int
r_int
)paren
id|srmmu_init_alloc
c_func
(paren
op_amp
id|mempool
comma
id|PAGE_SIZE
)paren
comma
id|SRMMU_PAGE_KERNEL
)paren
suffix:semicolon
)brace
id|percpu_table
op_assign
(paren
r_struct
id|sparc_percpu
op_star
)paren
id|PERCPU_VADDR
suffix:semicolon
multiline_comment|/* Ugh, have to map DVMA that the prom has mapped too or else&n;&t; * you will lose with video cards when we take over the ctx table.&n;&t; * Also, must take into consideration that prom might be using level&n;&t; * two or one PTE&squot;s. TODO&n;&t; */
r_for
c_loop
(paren
id|vaddr
op_assign
id|KADB_DEBUGGER_BEGVM
suffix:semicolon
id|vaddr
op_ne
l_int|0x0
suffix:semicolon
)paren
(brace
r_int
r_int
id|prom_pte
suffix:semicolon
id|prom_pte
op_assign
id|srmmu_init_twalk
c_func
(paren
id|vaddr
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|prom_pte
)paren
(brace
id|pgdp
op_assign
id|srmmu_pgd_offset
c_func
(paren
op_amp
id|init_task
comma
id|vaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|prom_pte
op_amp
l_int|0x3
)paren
op_eq
l_int|0x0
)paren
(brace
id|prom_pte
op_and_assign
op_complement
l_int|0x3
suffix:semicolon
id|prom_pte
op_or_assign
id|SRMMU_ET_PTE
suffix:semicolon
id|pgd_val
c_func
(paren
op_star
id|pgdp
)paren
op_assign
id|prom_pte
suffix:semicolon
id|vaddr
op_assign
id|SRMMU_PGDIR_ALIGN
c_func
(paren
id|vaddr
op_plus
l_int|1
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|srmmu_pgd_none
c_func
(paren
op_star
id|pgdp
)paren
)paren
(brace
id|pmdp
op_assign
id|srmmu_init_alloc
c_func
(paren
op_amp
id|mempool
comma
id|SRMMU_PTRS_PER_PMD
op_star
r_sizeof
(paren
id|pmd_t
)paren
)paren
suffix:semicolon
id|srmmu_pgd_set
c_func
(paren
id|pgdp
comma
id|pmdp
)paren
suffix:semicolon
)brace
id|pmdp
op_assign
id|srmmu_pmd_offset
c_func
(paren
id|pgdp
comma
id|vaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|prom_pte
op_amp
l_int|0x3
)paren
op_eq
l_int|0x1
)paren
(brace
id|prom_pte
op_and_assign
op_complement
l_int|0x3
suffix:semicolon
id|prom_pte
op_or_assign
id|SRMMU_ET_PTE
suffix:semicolon
id|pgd_val
c_func
(paren
op_star
id|pgdp
)paren
op_assign
id|prom_pte
suffix:semicolon
id|vaddr
op_assign
id|SRMMU_PMD_ALIGN
c_func
(paren
id|vaddr
op_plus
l_int|1
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|srmmu_pmd_none
c_func
(paren
op_star
id|pmdp
)paren
)paren
(brace
id|ptep
op_assign
id|srmmu_init_alloc
c_func
(paren
op_amp
id|mempool
comma
id|SRMMU_PTRS_PER_PTE
op_star
r_sizeof
(paren
id|pte_t
)paren
)paren
suffix:semicolon
id|srmmu_pmd_set
c_func
(paren
id|pmdp
comma
id|ptep
)paren
suffix:semicolon
)brace
multiline_comment|/* A normal 3rd level PTE, no need to change ET bits. */
id|ptep
op_assign
id|srmmu_pte_offset
c_func
(paren
id|pmdp
comma
id|vaddr
)paren
suffix:semicolon
id|pte_val
c_func
(paren
op_star
id|ptep
)paren
op_assign
id|prom_pte
suffix:semicolon
)brace
id|vaddr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
multiline_comment|/* I believe I do not need to flush VAC here since my stores  */
multiline_comment|/* probably already reached the physical RAM.             --P3 */
multiline_comment|/* We probably do, and should do it just to be safe... -Davem */
multiline_comment|/* Take the MMU over from the PROM */
id|printk
c_func
(paren
l_string|&quot;Taking over MMU from PROM.&bslash;n&quot;
)paren
suffix:semicolon
id|srmmu_set_ctable_ptr
c_func
(paren
id|srmmu_virt_to_phys
c_func
(paren
(paren
r_int
)paren
id|lnx_root
)paren
)paren
suffix:semicolon
id|srmmu_flush_whole_tlb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Now it is ok to use memory at start_mem. */
id|start_mem
op_assign
id|PAGE_ALIGN
c_func
(paren
id|mempool
)paren
suffix:semicolon
id|start_mem
op_assign
id|free_area_init
c_func
(paren
id|start_mem
comma
id|end_mem
)paren
suffix:semicolon
id|start_mem
op_assign
id|PAGE_ALIGN
c_func
(paren
id|start_mem
)paren
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;Testing context switches...&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_contexts
suffix:semicolon
id|i
op_increment
)paren
(brace
id|srmmu_set_context
c_func
(paren
id|i
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;done...&bslash;n&quot;
)paren
suffix:semicolon
id|srmmu_set_context
c_func
(paren
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;survived...&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|start_mem
suffix:semicolon
)brace
multiline_comment|/* Test the WP bit on the Sparc Reference MMU. */
r_void
DECL|function|srmmu_test_wp
id|srmmu_test_wp
c_func
(paren
r_void
)paren
(brace
id|pgd_t
op_star
id|pgdp
suffix:semicolon
id|pmd_t
op_star
id|pmdp
suffix:semicolon
id|pte_t
op_star
id|ptep
suffix:semicolon
id|wp_works_ok
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* We mapped page zero as a read-only page in paging_init()&n;&t; * So fire up the test, then invalidate the pgd for page zero.&n;&t; * It is no longer needed.&n;&t; */
multiline_comment|/* Let it rip... */
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;st %%g0, [0x0]&bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
suffix:colon
l_string|&quot;memory&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wp_works_ok
OL
l_int|0
)paren
id|wp_works_ok
op_assign
l_int|0
suffix:semicolon
id|pgdp
op_assign
id|srmmu_pgd_offset
c_func
(paren
op_amp
id|init_task
comma
l_int|0x0
)paren
suffix:semicolon
id|pgd_val
c_func
(paren
op_star
id|pgdp
)paren
op_assign
l_int|0x0
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Load up routines and constants for sun4m mmu */
r_void
DECL|function|ld_mmu_srmmu
id|ld_mmu_srmmu
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Loading srmmu MMU routines&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* First the constants */
id|pmd_shift
op_assign
id|SRMMU_PMD_SHIFT
suffix:semicolon
id|pmd_size
op_assign
id|SRMMU_PMD_SIZE
suffix:semicolon
id|pmd_mask
op_assign
id|SRMMU_PMD_MASK
suffix:semicolon
id|pgdir_shift
op_assign
id|SRMMU_PGDIR_SHIFT
suffix:semicolon
id|pgdir_size
op_assign
id|SRMMU_PGDIR_SIZE
suffix:semicolon
id|pgdir_mask
op_assign
id|SRMMU_PGDIR_MASK
suffix:semicolon
id|ptrs_per_pte
op_assign
id|SRMMU_PTRS_PER_PTE
suffix:semicolon
id|ptrs_per_pmd
op_assign
id|SRMMU_PTRS_PER_PMD
suffix:semicolon
id|ptrs_per_pgd
op_assign
id|SRMMU_PTRS_PER_PGD
suffix:semicolon
id|page_none
op_assign
id|SRMMU_PAGE_NONE
suffix:semicolon
id|page_shared
op_assign
id|SRMMU_PAGE_SHARED
suffix:semicolon
id|page_copy
op_assign
id|SRMMU_PAGE_COPY
suffix:semicolon
id|page_readonly
op_assign
id|SRMMU_PAGE_READONLY
suffix:semicolon
id|page_kernel
op_assign
id|SRMMU_PAGE_KERNEL
suffix:semicolon
id|page_invalid
op_assign
id|SRMMU_PAGE_INVALID
suffix:semicolon
multiline_comment|/* Functions */
id|invalidate
op_assign
id|srmmu_invalidate
suffix:semicolon
id|set_pte
op_assign
id|srmmu_set_pte
suffix:semicolon
id|switch_to_context
op_assign
id|srmmu_switch_to_context
suffix:semicolon
id|pmd_align
op_assign
id|srmmu_pmd_align
suffix:semicolon
id|pgdir_align
op_assign
id|srmmu_pgdir_align
suffix:semicolon
id|vmalloc_start
op_assign
id|srmmu_vmalloc_start
suffix:semicolon
id|pte_page
op_assign
id|srmmu_pte_page
suffix:semicolon
id|pmd_page
op_assign
id|srmmu_pmd_page
suffix:semicolon
id|pgd_page
op_assign
id|srmmu_pgd_page
suffix:semicolon
id|sparc_update_rootmmu_dir
op_assign
id|srmmu_update_rootmmu_dir
suffix:semicolon
id|pte_none
op_assign
id|srmmu_pte_none
suffix:semicolon
id|pte_present
op_assign
id|srmmu_pte_present
suffix:semicolon
id|pte_inuse
op_assign
id|srmmu_pte_inuse
suffix:semicolon
id|pte_clear
op_assign
id|srmmu_pte_clear
suffix:semicolon
id|pte_reuse
op_assign
id|srmmu_pte_reuse
suffix:semicolon
id|pmd_none
op_assign
id|srmmu_pmd_none
suffix:semicolon
id|pmd_bad
op_assign
id|srmmu_pmd_bad
suffix:semicolon
id|pmd_present
op_assign
id|srmmu_pmd_present
suffix:semicolon
id|pmd_inuse
op_assign
id|srmmu_pmd_inuse
suffix:semicolon
id|pmd_clear
op_assign
id|srmmu_pmd_clear
suffix:semicolon
id|pmd_reuse
op_assign
id|srmmu_pmd_reuse
suffix:semicolon
id|pgd_none
op_assign
id|srmmu_pgd_none
suffix:semicolon
id|pgd_bad
op_assign
id|srmmu_pgd_bad
suffix:semicolon
id|pgd_present
op_assign
id|srmmu_pgd_present
suffix:semicolon
id|pgd_inuse
op_assign
id|srmmu_pgd_inuse
suffix:semicolon
id|pgd_clear
op_assign
id|srmmu_pgd_clear
suffix:semicolon
id|pgd_reuse
op_assign
id|srmmu_pgd_reuse
suffix:semicolon
id|mk_pte
op_assign
id|srmmu_mk_pte
suffix:semicolon
id|pgd_set
op_assign
id|srmmu_pgd_set
suffix:semicolon
multiline_comment|/* XXX needs a cast */
id|pte_modify
op_assign
id|srmmu_pte_modify
suffix:semicolon
id|pgd_offset
op_assign
id|srmmu_pgd_offset
suffix:semicolon
id|pmd_offset
op_assign
id|srmmu_pmd_offset
suffix:semicolon
id|pte_offset
op_assign
id|srmmu_pte_offset
suffix:semicolon
id|pte_free_kernel
op_assign
id|srmmu_pte_free_kernel
suffix:semicolon
id|pmd_free_kernel
op_assign
id|srmmu_pmd_free_kernel
suffix:semicolon
id|pte_alloc_kernel
op_assign
id|srmmu_pte_alloc_kernel
suffix:semicolon
id|pmd_alloc_kernel
op_assign
id|srmmu_pmd_alloc_kernel
suffix:semicolon
id|pte_free
op_assign
id|srmmu_pte_free
suffix:semicolon
id|pte_alloc
op_assign
id|srmmu_pte_alloc
suffix:semicolon
id|pmd_free
op_assign
id|srmmu_pmd_free
suffix:semicolon
id|pmd_alloc
op_assign
id|srmmu_pmd_alloc
suffix:semicolon
id|pgd_free
op_assign
id|srmmu_pgd_free
suffix:semicolon
id|pgd_alloc
op_assign
id|srmmu_pgd_alloc
suffix:semicolon
id|pte_read
op_assign
id|srmmu_pte_read
suffix:semicolon
id|pte_write
op_assign
id|srmmu_pte_write
suffix:semicolon
id|pte_exec
op_assign
id|srmmu_pte_exec
suffix:semicolon
id|pte_dirty
op_assign
id|srmmu_pte_dirty
suffix:semicolon
id|pte_young
op_assign
id|srmmu_pte_young
suffix:semicolon
id|pte_cow
op_assign
id|srmmu_pte_cow
suffix:semicolon
id|pte_wrprotect
op_assign
id|srmmu_pte_wrprotect
suffix:semicolon
id|pte_rdprotect
op_assign
id|srmmu_pte_rdprotect
suffix:semicolon
id|pte_exprotect
op_assign
id|srmmu_pte_exprotect
suffix:semicolon
id|pte_mkclean
op_assign
id|srmmu_pte_mkclean
suffix:semicolon
id|pte_mkold
op_assign
id|srmmu_pte_mkold
suffix:semicolon
id|pte_uncow
op_assign
id|srmmu_pte_uncow
suffix:semicolon
id|pte_mkwrite
op_assign
id|srmmu_pte_mkwrite
suffix:semicolon
id|pte_mkread
op_assign
id|srmmu_pte_mkread
suffix:semicolon
id|pte_mkexec
op_assign
id|srmmu_pte_mkexec
suffix:semicolon
id|pte_mkdirty
op_assign
id|srmmu_pte_mkdirty
suffix:semicolon
id|pte_mkyoung
op_assign
id|srmmu_pte_mkyoung
suffix:semicolon
id|pte_mkcow
op_assign
id|srmmu_pte_mkcow
suffix:semicolon
r_return
suffix:semicolon
)brace
eof
