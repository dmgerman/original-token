multiline_comment|/* $Id: srmmu.c,v 1.149 1997/07/20 05:59:34 davem Exp $&n; * srmmu.c:  SRMMU specific routines for memory management.&n; *&n; * Copyright (C) 1995 David S. Miller  (davem@caip.rutgers.edu)&n; * Copyright (C) 1995 Peter A. Zaitcev (zaitcev@ithil.mcst.ru)&n; * Copyright (C) 1996 Eddie C. Dost    (ecd@skynet.be)&n; * Copyright (C) 1997 Jakub Jelinek    (jj@sunsite.mff.cuni.cz)&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/kdebug.h&gt;
macro_line|#include &lt;asm/vaddrs.h&gt;
macro_line|#include &lt;asm/traps.h&gt;
macro_line|#include &lt;asm/smp.h&gt;
macro_line|#include &lt;asm/mbus.h&gt;
macro_line|#include &lt;asm/cache.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/sbus.h&gt;
macro_line|#include &lt;asm/iommu.h&gt;
macro_line|#include &lt;asm/asi.h&gt;
macro_line|#include &lt;asm/msi.h&gt;
macro_line|#include &lt;asm/a.out.h&gt;
macro_line|#include &lt;asm/mmu_context.h&gt;
multiline_comment|/* Now the cpu specific definitions. */
macro_line|#include &lt;asm/viking.h&gt;
macro_line|#include &lt;asm/mxcc.h&gt;
macro_line|#include &lt;asm/ross.h&gt;
macro_line|#include &lt;asm/tsunami.h&gt;
macro_line|#include &lt;asm/swift.h&gt;
macro_line|#include &lt;asm/turbosparc.h&gt;
DECL|variable|srmmu_modtype
r_enum
id|mbus_module
id|srmmu_modtype
suffix:semicolon
DECL|variable|hwbug_bitmask
r_int
r_int
id|hwbug_bitmask
suffix:semicolon
DECL|variable|vac_cache_size
r_int
id|vac_cache_size
suffix:semicolon
DECL|variable|vac_line_size
r_int
id|vac_line_size
suffix:semicolon
DECL|variable|vac_badbits
r_int
id|vac_badbits
suffix:semicolon
r_extern
r_int
r_int
id|sparc_iobase_vaddr
suffix:semicolon
macro_line|#ifdef __SMP__
DECL|macro|FLUSH_BEGIN
mdefine_line|#define FLUSH_BEGIN(mm)
DECL|macro|FLUSH_END
mdefine_line|#define FLUSH_END
macro_line|#else
DECL|macro|FLUSH_BEGIN
mdefine_line|#define FLUSH_BEGIN(mm) if((mm)-&gt;context != NO_CONTEXT) {
DECL|macro|FLUSH_END
mdefine_line|#define FLUSH_END&t;}
macro_line|#endif
DECL|variable|ctxd_set
r_static
r_void
(paren
op_star
id|ctxd_set
)paren
(paren
id|ctxd_t
op_star
id|ctxp
comma
id|pgd_t
op_star
id|pgdp
)paren
suffix:semicolon
DECL|variable|pmd_set
r_static
r_void
(paren
op_star
id|pmd_set
)paren
(paren
id|pmd_t
op_star
id|pmdp
comma
id|pte_t
op_star
id|ptep
)paren
suffix:semicolon
DECL|variable|flush_page_for_dma
r_static
r_void
(paren
op_star
id|flush_page_for_dma
)paren
(paren
r_int
r_int
id|page
)paren
suffix:semicolon
DECL|variable|flush_chunk
r_static
r_void
(paren
op_star
id|flush_chunk
)paren
(paren
r_int
r_int
id|chunk
)paren
suffix:semicolon
macro_line|#ifdef __SMP__
DECL|variable|local_flush_page_for_dma
r_static
r_void
(paren
op_star
id|local_flush_page_for_dma
)paren
(paren
r_int
r_int
id|page
)paren
suffix:semicolon
macro_line|#endif
DECL|struct|srmmu_stats
r_static
r_struct
id|srmmu_stats
(brace
DECL|member|invall
r_int
id|invall
suffix:semicolon
DECL|member|invpg
r_int
id|invpg
suffix:semicolon
DECL|member|invrnge
r_int
id|invrnge
suffix:semicolon
DECL|member|invmm
r_int
id|invmm
suffix:semicolon
DECL|variable|module_stats
)brace
id|module_stats
suffix:semicolon
DECL|variable|srmmu_name
r_static
r_char
op_star
id|srmmu_name
suffix:semicolon
DECL|variable|srmmu_ctx_table_phys
id|ctxd_t
op_star
id|srmmu_ctx_table_phys
suffix:semicolon
DECL|variable|srmmu_context_table
id|ctxd_t
op_star
id|srmmu_context_table
suffix:semicolon
multiline_comment|/* Don&squot;t change this without changing access to this&n; * in arch/sparc/mm/viking.S&n; */
DECL|struct|srmmu_trans
r_static
r_struct
id|srmmu_trans
(brace
DECL|member|vbase
r_int
r_int
id|vbase
suffix:semicolon
DECL|member|pbase
r_int
r_int
id|pbase
suffix:semicolon
DECL|member|size
r_int
r_int
id|size
suffix:semicolon
DECL|variable|srmmu_map
)brace
id|srmmu_map
(braket
id|SPARC_PHYS_BANKS
)braket
suffix:semicolon
DECL|macro|SRMMU_HASHSZ
mdefine_line|#define SRMMU_HASHSZ&t;256
multiline_comment|/* Not static, viking.S uses it. */
DECL|variable|srmmu_v2p_hash
r_struct
id|srmmu_trans
op_star
id|srmmu_v2p_hash
(braket
id|SRMMU_HASHSZ
)braket
suffix:semicolon
DECL|variable|srmmu_p2v_hash
r_static
r_struct
id|srmmu_trans
op_star
id|srmmu_p2v_hash
(braket
id|SRMMU_HASHSZ
)braket
suffix:semicolon
DECL|macro|srmmu_ahashfn
mdefine_line|#define srmmu_ahashfn(addr)&t;((addr) &gt;&gt; 24)
DECL|variable|viking_mxcc_present
r_static
r_int
id|viking_mxcc_present
op_assign
l_int|0
suffix:semicolon
DECL|function|srmmu_frob_mem_map
r_void
id|srmmu_frob_mem_map
c_func
(paren
r_int
r_int
id|start_mem
)paren
(brace
r_int
r_int
id|bank_start
comma
id|bank_end
suffix:semicolon
r_int
r_int
id|addr
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* First, mark all pages as invalid. */
r_for
c_loop
(paren
id|addr
op_assign
id|PAGE_OFFSET
suffix:semicolon
id|MAP_NR
c_func
(paren
id|addr
)paren
OL
id|max_mapnr
suffix:semicolon
id|addr
op_add_assign
id|PAGE_SIZE
)paren
(brace
id|mem_map
(braket
id|MAP_NR
c_func
(paren
id|addr
)paren
)braket
dot
id|flags
op_or_assign
(paren
l_int|1
op_lshift
id|PG_reserved
)paren
suffix:semicolon
)brace
id|start_mem
op_assign
id|PAGE_ALIGN
c_func
(paren
id|start_mem
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|srmmu_map
(braket
id|i
)braket
dot
id|size
suffix:semicolon
id|i
op_increment
)paren
(brace
id|bank_start
op_assign
id|srmmu_map
(braket
id|i
)braket
dot
id|vbase
suffix:semicolon
id|bank_end
op_assign
id|bank_start
op_plus
id|srmmu_map
(braket
id|i
)braket
dot
id|size
suffix:semicolon
r_while
c_loop
(paren
id|bank_start
OL
id|bank_end
)paren
(brace
r_if
c_cond
(paren
(paren
id|bank_start
op_ge
id|KERNBASE
)paren
op_logical_and
(paren
id|bank_start
OL
id|start_mem
)paren
)paren
(brace
id|bank_start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|mem_map
(braket
id|MAP_NR
c_func
(paren
id|bank_start
)paren
)braket
dot
id|flags
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|PG_reserved
)paren
suffix:semicolon
id|bank_start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Physical memory can be _very_ non-contiguous on the sun4m, especially&n; * the SS10/20 class machines and with the latest openprom revisions.&n; * So we have to do a quick lookup.&n; */
DECL|function|srmmu_v2p
r_static
r_inline
r_int
r_int
id|srmmu_v2p
c_func
(paren
r_int
r_int
id|vaddr
)paren
(brace
r_struct
id|srmmu_trans
op_star
id|tp
op_assign
id|srmmu_v2p_hash
(braket
id|srmmu_ahashfn
c_func
(paren
id|vaddr
)paren
)braket
suffix:semicolon
r_if
c_cond
(paren
id|tp
)paren
(brace
r_return
(paren
id|vaddr
op_minus
id|tp-&gt;vbase
op_plus
id|tp-&gt;pbase
)paren
suffix:semicolon
)brace
r_else
r_return
l_int|0xffffffffUL
suffix:semicolon
)brace
DECL|function|srmmu_p2v
r_static
r_inline
r_int
r_int
id|srmmu_p2v
c_func
(paren
r_int
r_int
id|paddr
)paren
(brace
r_struct
id|srmmu_trans
op_star
id|tp
op_assign
id|srmmu_p2v_hash
(braket
id|srmmu_ahashfn
c_func
(paren
id|paddr
)paren
)braket
suffix:semicolon
r_if
c_cond
(paren
id|tp
)paren
(brace
r_return
(paren
id|paddr
op_minus
id|tp-&gt;pbase
op_plus
id|tp-&gt;vbase
)paren
suffix:semicolon
)brace
r_else
r_return
l_int|0xffffffffUL
suffix:semicolon
)brace
multiline_comment|/* In general all page table modifications should use the V8 atomic&n; * swap instruction.  This insures the mmu and the cpu are in sync&n; * with respect to ref/mod bits in the page tables.&n; */
DECL|function|srmmu_swap
r_static
r_inline
r_int
r_int
id|srmmu_swap
c_func
(paren
r_int
r_int
op_star
id|addr
comma
r_int
r_int
id|value
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;swap [%2], %0&quot;
suffix:colon
l_string|&quot;=&amp;r&quot;
(paren
id|value
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|value
)paren
comma
l_string|&quot;r&quot;
(paren
id|addr
)paren
)paren
suffix:semicolon
r_return
id|value
suffix:semicolon
)brace
multiline_comment|/* Functions really use this, not srmmu_swap directly. */
DECL|macro|srmmu_set_entry
mdefine_line|#define srmmu_set_entry(ptr, newentry) srmmu_swap((unsigned long *) (ptr), (newentry))
multiline_comment|/* The very generic SRMMU page table operations. */
DECL|function|srmmu_pmd_align
r_static
r_int
r_int
id|srmmu_pmd_align
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_return
id|SRMMU_PMD_ALIGN
c_func
(paren
id|addr
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pgdir_align
r_static
r_int
r_int
id|srmmu_pgdir_align
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_return
id|SRMMU_PGDIR_ALIGN
c_func
(paren
id|addr
)paren
suffix:semicolon
)brace
DECL|function|srmmu_vmalloc_start
r_static
r_int
r_int
id|srmmu_vmalloc_start
c_func
(paren
r_void
)paren
(brace
r_return
id|SRMMU_VMALLOC_START
suffix:semicolon
)brace
DECL|function|srmmu_device_memory
r_static
r_inline
r_int
id|srmmu_device_memory
c_func
(paren
r_int
r_int
id|x
)paren
(brace
r_return
(paren
(paren
id|x
op_amp
l_int|0xF0000000
)paren
op_ne
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pgd_page
r_static
r_int
r_int
id|srmmu_pgd_page
c_func
(paren
id|pgd_t
id|pgd
)paren
(brace
r_return
id|srmmu_device_memory
c_func
(paren
id|pgd_val
c_func
(paren
id|pgd
)paren
)paren
ques
c_cond
op_complement
l_int|0
suffix:colon
id|srmmu_p2v
c_func
(paren
(paren
id|pgd_val
c_func
(paren
id|pgd
)paren
op_amp
id|SRMMU_PTD_PMASK
)paren
op_lshift
l_int|4
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pmd_page
r_static
r_int
r_int
id|srmmu_pmd_page
c_func
(paren
id|pmd_t
id|pmd
)paren
(brace
r_return
id|srmmu_device_memory
c_func
(paren
id|pmd_val
c_func
(paren
id|pmd
)paren
)paren
ques
c_cond
op_complement
l_int|0
suffix:colon
id|srmmu_p2v
c_func
(paren
(paren
id|pmd_val
c_func
(paren
id|pmd
)paren
op_amp
id|SRMMU_PTD_PMASK
)paren
op_lshift
l_int|4
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pte_page
r_static
r_int
r_int
id|srmmu_pte_page
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
id|srmmu_device_memory
c_func
(paren
id|pte_val
c_func
(paren
id|pte
)paren
)paren
ques
c_cond
op_complement
l_int|0
suffix:colon
id|srmmu_p2v
c_func
(paren
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
id|SRMMU_PTE_PMASK
)paren
op_lshift
l_int|4
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pte_none
r_static
r_int
id|srmmu_pte_none
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
op_logical_neg
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
l_int|0xFFFFFFF
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pte_present
r_static
r_int
id|srmmu_pte_present
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
(paren
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
id|SRMMU_ET_MASK
)paren
op_eq
id|SRMMU_ET_PTE
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pte_clear
r_static
r_void
id|srmmu_pte_clear
c_func
(paren
id|pte_t
op_star
id|ptep
)paren
(brace
id|set_pte
c_func
(paren
id|ptep
comma
id|__pte
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pmd_none
r_static
r_int
id|srmmu_pmd_none
c_func
(paren
id|pmd_t
id|pmd
)paren
(brace
r_return
op_logical_neg
(paren
id|pmd_val
c_func
(paren
id|pmd
)paren
op_amp
l_int|0xFFFFFFF
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pmd_bad
r_static
r_int
id|srmmu_pmd_bad
c_func
(paren
id|pmd_t
id|pmd
)paren
(brace
r_return
(paren
id|pmd_val
c_func
(paren
id|pmd
)paren
op_amp
id|SRMMU_ET_MASK
)paren
op_ne
id|SRMMU_ET_PTD
suffix:semicolon
)brace
DECL|function|srmmu_pmd_present
r_static
r_int
id|srmmu_pmd_present
c_func
(paren
id|pmd_t
id|pmd
)paren
(brace
r_return
(paren
(paren
id|pmd_val
c_func
(paren
id|pmd
)paren
op_amp
id|SRMMU_ET_MASK
)paren
op_eq
id|SRMMU_ET_PTD
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pmd_clear
r_static
r_void
id|srmmu_pmd_clear
c_func
(paren
id|pmd_t
op_star
id|pmdp
)paren
(brace
id|set_pte
c_func
(paren
(paren
id|pte_t
op_star
)paren
id|pmdp
comma
id|__pte
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pgd_none
r_static
r_int
id|srmmu_pgd_none
c_func
(paren
id|pgd_t
id|pgd
)paren
(brace
r_return
op_logical_neg
(paren
id|pgd_val
c_func
(paren
id|pgd
)paren
op_amp
l_int|0xFFFFFFF
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pgd_bad
r_static
r_int
id|srmmu_pgd_bad
c_func
(paren
id|pgd_t
id|pgd
)paren
(brace
r_return
(paren
id|pgd_val
c_func
(paren
id|pgd
)paren
op_amp
id|SRMMU_ET_MASK
)paren
op_ne
id|SRMMU_ET_PTD
suffix:semicolon
)brace
DECL|function|srmmu_pgd_present
r_static
r_int
id|srmmu_pgd_present
c_func
(paren
id|pgd_t
id|pgd
)paren
(brace
r_return
(paren
(paren
id|pgd_val
c_func
(paren
id|pgd
)paren
op_amp
id|SRMMU_ET_MASK
)paren
op_eq
id|SRMMU_ET_PTD
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pgd_clear
r_static
r_void
id|srmmu_pgd_clear
c_func
(paren
id|pgd_t
op_star
id|pgdp
)paren
(brace
id|set_pte
c_func
(paren
(paren
id|pte_t
op_star
)paren
id|pgdp
comma
id|__pte
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pte_write
r_static
r_int
id|srmmu_pte_write
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
id|SRMMU_WRITE
suffix:semicolon
)brace
DECL|function|srmmu_pte_dirty
r_static
r_int
id|srmmu_pte_dirty
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
id|SRMMU_DIRTY
suffix:semicolon
)brace
DECL|function|srmmu_pte_young
r_static
r_int
id|srmmu_pte_young
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
id|SRMMU_REF
suffix:semicolon
)brace
DECL|function|srmmu_pte_wrprotect
r_static
id|pte_t
id|srmmu_pte_wrprotect
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
id|__pte
c_func
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
op_complement
id|SRMMU_WRITE
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pte_mkclean
r_static
id|pte_t
id|srmmu_pte_mkclean
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
id|__pte
c_func
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
op_complement
id|SRMMU_DIRTY
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pte_mkold
r_static
id|pte_t
id|srmmu_pte_mkold
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
id|__pte
c_func
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
op_complement
id|SRMMU_REF
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pte_mkwrite
r_static
id|pte_t
id|srmmu_pte_mkwrite
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
id|__pte
c_func
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_or
id|SRMMU_WRITE
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pte_mkdirty
r_static
id|pte_t
id|srmmu_pte_mkdirty
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
id|__pte
c_func
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_or
id|SRMMU_DIRTY
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pte_mkyoung
r_static
id|pte_t
id|srmmu_pte_mkyoung
c_func
(paren
id|pte_t
id|pte
)paren
(brace
r_return
id|__pte
c_func
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_or
id|SRMMU_REF
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Conversion functions: convert a page and protection to a page entry,&n; * and a page entry and page directory to the page they refer to.&n; */
DECL|function|srmmu_mk_pte
r_static
id|pte_t
id|srmmu_mk_pte
c_func
(paren
r_int
r_int
id|page
comma
id|pgprot_t
id|pgprot
)paren
(brace
r_return
id|__pte
c_func
(paren
(paren
(paren
id|srmmu_v2p
c_func
(paren
id|page
)paren
)paren
op_rshift
l_int|4
)paren
op_or
id|pgprot_val
c_func
(paren
id|pgprot
)paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_mk_pte_phys
r_static
id|pte_t
id|srmmu_mk_pte_phys
c_func
(paren
r_int
r_int
id|page
comma
id|pgprot_t
id|pgprot
)paren
(brace
r_return
id|__pte
c_func
(paren
(paren
(paren
id|page
)paren
op_rshift
l_int|4
)paren
op_or
id|pgprot_val
c_func
(paren
id|pgprot
)paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_mk_pte_io
r_static
id|pte_t
id|srmmu_mk_pte_io
c_func
(paren
r_int
r_int
id|page
comma
id|pgprot_t
id|pgprot
comma
r_int
id|space
)paren
(brace
r_return
id|__pte
c_func
(paren
(paren
(paren
id|page
)paren
op_rshift
l_int|4
)paren
op_or
(paren
id|space
op_lshift
l_int|28
)paren
op_or
id|pgprot_val
c_func
(paren
id|pgprot
)paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_ctxd_set
r_static
r_void
id|srmmu_ctxd_set
c_func
(paren
id|ctxd_t
op_star
id|ctxp
comma
id|pgd_t
op_star
id|pgdp
)paren
(brace
id|set_pte
c_func
(paren
(paren
id|pte_t
op_star
)paren
id|ctxp
comma
(paren
id|SRMMU_ET_PTD
op_or
(paren
id|srmmu_v2p
c_func
(paren
(paren
r_int
r_int
)paren
id|pgdp
)paren
op_rshift
l_int|4
)paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pgd_set
r_static
r_void
id|srmmu_pgd_set
c_func
(paren
id|pgd_t
op_star
id|pgdp
comma
id|pmd_t
op_star
id|pmdp
)paren
(brace
id|set_pte
c_func
(paren
(paren
id|pte_t
op_star
)paren
id|pgdp
comma
(paren
id|SRMMU_ET_PTD
op_or
(paren
id|srmmu_v2p
c_func
(paren
(paren
r_int
r_int
)paren
id|pmdp
)paren
op_rshift
l_int|4
)paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pmd_set
r_static
r_void
id|srmmu_pmd_set
c_func
(paren
id|pmd_t
op_star
id|pmdp
comma
id|pte_t
op_star
id|ptep
)paren
(brace
id|set_pte
c_func
(paren
(paren
id|pte_t
op_star
)paren
id|pmdp
comma
(paren
id|SRMMU_ET_PTD
op_or
(paren
id|srmmu_v2p
c_func
(paren
(paren
r_int
r_int
)paren
id|ptep
)paren
op_rshift
l_int|4
)paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pte_modify
r_static
id|pte_t
id|srmmu_pte_modify
c_func
(paren
id|pte_t
id|pte
comma
id|pgprot_t
id|newprot
)paren
(brace
r_return
id|__pte
c_func
(paren
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
id|SRMMU_CHG_MASK
)paren
op_or
id|pgprot_val
c_func
(paren
id|newprot
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* to find an entry in a top-level page table... */
DECL|function|srmmu_pgd_offset
r_static
id|pgd_t
op_star
id|srmmu_pgd_offset
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|address
)paren
(brace
r_return
id|mm-&gt;pgd
op_plus
(paren
(paren
id|address
op_rshift
id|SRMMU_PGDIR_SHIFT
)paren
op_amp
(paren
id|SRMMU_PTRS_PER_PGD
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Find an entry in the second-level page table.. */
DECL|function|srmmu_pmd_offset
r_static
id|pmd_t
op_star
id|srmmu_pmd_offset
c_func
(paren
id|pgd_t
op_star
id|dir
comma
r_int
r_int
id|address
)paren
(brace
r_return
(paren
id|pmd_t
op_star
)paren
id|srmmu_pgd_page
c_func
(paren
op_star
id|dir
)paren
op_plus
(paren
(paren
id|address
op_rshift
id|SRMMU_PMD_SHIFT
)paren
op_amp
(paren
id|SRMMU_PTRS_PER_PMD
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Find an entry in the third-level page table.. */
DECL|function|srmmu_pte_offset
r_static
id|pte_t
op_star
id|srmmu_pte_offset
c_func
(paren
id|pmd_t
op_star
id|dir
comma
r_int
r_int
id|address
)paren
(brace
r_return
(paren
id|pte_t
op_star
)paren
id|srmmu_pmd_page
c_func
(paren
op_star
id|dir
)paren
op_plus
(paren
(paren
id|address
op_rshift
id|PAGE_SHIFT
)paren
op_amp
(paren
id|SRMMU_PTRS_PER_PTE
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* This must update the context table entry for this process. */
DECL|function|srmmu_update_rootmmu_dir
r_static
r_void
id|srmmu_update_rootmmu_dir
c_func
(paren
r_struct
id|task_struct
op_star
id|tsk
comma
id|pgd_t
op_star
id|pgdp
)paren
(brace
r_if
c_cond
(paren
id|tsk-&gt;mm-&gt;context
op_ne
id|NO_CONTEXT
)paren
(brace
id|flush_cache_mm
c_func
(paren
id|tsk-&gt;mm
)paren
suffix:semicolon
id|ctxd_set
c_func
(paren
op_amp
id|srmmu_context_table
(braket
id|tsk-&gt;mm-&gt;context
)braket
comma
id|pgdp
)paren
suffix:semicolon
id|flush_tlb_mm
c_func
(paren
id|tsk-&gt;mm
)paren
suffix:semicolon
)brace
)brace
DECL|function|srmmu_putpage
r_static
r_inline
r_void
id|srmmu_putpage
c_func
(paren
r_int
r_int
id|page
)paren
(brace
id|free_page
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
DECL|macro|LC_HIGH_WATER
mdefine_line|#define LC_HIGH_WATER&t;128
DECL|macro|BC_HIGH_WATER
mdefine_line|#define BC_HIGH_WATER&t;32
DECL|variable|lcnks
r_static
r_int
r_int
op_star
id|lcnks
op_assign
l_int|0
suffix:semicolon
DECL|variable|bcnks
r_static
r_int
r_int
op_star
id|bcnks
op_assign
l_int|0
suffix:semicolon
DECL|variable|lcwater
r_static
r_int
id|lcwater
op_assign
l_int|0
suffix:semicolon
DECL|variable|bcwater
r_static
r_int
id|bcwater
op_assign
l_int|0
suffix:semicolon
DECL|variable|chunk_pages
r_static
r_int
id|chunk_pages
op_assign
l_int|0
suffix:semicolon
DECL|variable|clct_pages
r_static
r_int
id|clct_pages
op_assign
l_int|0
suffix:semicolon
DECL|macro|RELAX_JIFFIES
mdefine_line|#define RELAX_JIFFIES&t;16
DECL|variable|lcjiffies
r_static
r_int
id|lcjiffies
suffix:semicolon
DECL|variable|bcjiffies
r_static
r_int
id|bcjiffies
suffix:semicolon
DECL|struct|chunk
r_struct
id|chunk
(brace
DECL|member|next
r_struct
id|chunk
op_star
id|next
suffix:semicolon
DECL|member|prev
r_struct
id|chunk
op_star
id|prev
suffix:semicolon
DECL|member|npage
r_struct
id|chunk
op_star
id|npage
suffix:semicolon
DECL|member|ppage
r_struct
id|chunk
op_star
id|ppage
suffix:semicolon
DECL|member|count
r_int
id|count
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|garbage_calls
r_static
r_int
id|garbage_calls
op_assign
l_int|0
suffix:semicolon
DECL|macro|OTHER_PAGE
mdefine_line|#define OTHER_PAGE(p,q)&t;(((unsigned long)(p) ^ (unsigned long)(q)) &amp; PAGE_MASK)
DECL|function|garbage_collect
r_static
r_int
id|garbage_collect
c_func
(paren
r_int
r_int
op_star
op_star
id|cnks
comma
r_int
id|n
comma
r_int
id|cpp
)paren
(brace
r_struct
id|chunk
op_star
id|root
op_assign
(paren
r_struct
id|chunk
op_star
)paren
op_star
id|cnks
suffix:semicolon
r_struct
id|chunk
op_star
id|p
comma
op_star
id|q
comma
op_star
id|curr
comma
op_star
id|next
suffix:semicolon
r_int
id|water
op_assign
id|n
suffix:semicolon
id|next
op_assign
id|root-&gt;next
suffix:semicolon
id|curr
op_assign
id|root-&gt;prev
op_assign
id|root-&gt;next
op_assign
id|root-&gt;npage
op_assign
id|root-&gt;ppage
op_assign
id|root
suffix:semicolon
id|root-&gt;count
op_assign
l_int|1
suffix:semicolon
id|garbage_calls
op_increment
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|n
)paren
(brace
id|p
op_assign
id|next
suffix:semicolon
id|next
op_assign
id|next-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|OTHER_PAGE
c_func
(paren
id|p
comma
id|curr
)paren
)paren
(brace
id|q
op_assign
id|curr-&gt;npage
suffix:semicolon
r_while
c_loop
(paren
id|q
op_ne
id|curr
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|OTHER_PAGE
c_func
(paren
id|p
comma
id|q
)paren
)paren
r_break
suffix:semicolon
id|q
op_assign
id|q-&gt;npage
suffix:semicolon
)brace
r_if
c_cond
(paren
id|q
op_eq
id|curr
)paren
(brace
(paren
id|p-&gt;npage
op_assign
id|curr-&gt;npage
)paren
op_member_access_from_pointer
id|ppage
op_assign
id|p
suffix:semicolon
id|curr-&gt;npage
op_assign
id|p
suffix:semicolon
id|p-&gt;ppage
op_assign
id|curr
suffix:semicolon
id|p-&gt;next
op_assign
id|p-&gt;prev
op_assign
id|p
suffix:semicolon
id|p-&gt;count
op_assign
l_int|1
suffix:semicolon
id|curr
op_assign
id|p
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|curr
op_assign
id|q
suffix:semicolon
)brace
(paren
id|p-&gt;next
op_assign
id|curr-&gt;next
)paren
op_member_access_from_pointer
id|prev
op_assign
id|p
suffix:semicolon
id|curr-&gt;next
op_assign
id|p
suffix:semicolon
id|p-&gt;prev
op_assign
id|curr
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|curr-&gt;count
op_eq
id|cpp
)paren
(brace
id|q
op_assign
id|curr-&gt;npage
suffix:semicolon
r_if
c_cond
(paren
id|curr
op_eq
id|q
)paren
(brace
id|srmmu_putpage
c_func
(paren
(paren
r_int
r_int
)paren
id|curr
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
id|water
op_sub_assign
id|cpp
suffix:semicolon
id|clct_pages
op_increment
suffix:semicolon
id|chunk_pages
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|n
)paren
(brace
id|p
op_assign
id|next
suffix:semicolon
id|next
op_assign
id|next-&gt;next
suffix:semicolon
id|curr
op_assign
id|root-&gt;prev
op_assign
id|root-&gt;next
op_assign
id|root-&gt;npage
op_assign
id|root-&gt;ppage
op_assign
id|root
op_assign
id|p
suffix:semicolon
id|root-&gt;count
op_assign
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|curr
op_eq
id|root
)paren
id|root
op_assign
id|q
suffix:semicolon
id|curr-&gt;ppage-&gt;npage
op_assign
id|q
suffix:semicolon
id|q-&gt;ppage
op_assign
id|curr-&gt;ppage
suffix:semicolon
id|srmmu_putpage
c_func
(paren
(paren
r_int
r_int
)paren
id|curr
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
id|water
op_sub_assign
id|cpp
suffix:semicolon
id|clct_pages
op_increment
suffix:semicolon
id|chunk_pages
op_decrement
suffix:semicolon
id|curr
op_assign
id|q
suffix:semicolon
)brace
)brace
id|p
op_assign
id|root
suffix:semicolon
r_while
c_loop
(paren
id|p-&gt;npage
op_ne
id|root
)paren
(brace
id|p-&gt;prev-&gt;next
op_assign
id|p-&gt;npage
suffix:semicolon
id|p
op_assign
id|p-&gt;npage
suffix:semicolon
)brace
op_star
id|cnks
op_assign
(paren
r_int
r_int
op_star
)paren
id|root
suffix:semicolon
r_return
id|water
suffix:semicolon
)brace
DECL|function|get_small_chunk
r_static
r_int
r_int
op_star
id|get_small_chunk
c_func
(paren
r_void
)paren
(brace
r_int
r_int
op_star
id|rval
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lcwater
)paren
(brace
id|lcwater
op_decrement
suffix:semicolon
id|rval
op_assign
id|lcnks
suffix:semicolon
id|lcnks
op_assign
(paren
r_int
r_int
op_star
)paren
op_star
id|rval
suffix:semicolon
)brace
r_else
(brace
id|rval
op_assign
(paren
r_int
r_int
op_star
)paren
id|__get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rval
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|chunk_pages
op_increment
suffix:semicolon
id|lcnks
op_assign
(paren
id|rval
op_plus
l_int|64
)paren
suffix:semicolon
multiline_comment|/* Cache stomping, I know... */
op_star
(paren
id|rval
op_plus
l_int|64
)paren
op_assign
(paren
r_int
r_int
)paren
(paren
id|rval
op_plus
l_int|128
)paren
suffix:semicolon
op_star
(paren
id|rval
op_plus
l_int|128
)paren
op_assign
(paren
r_int
r_int
)paren
(paren
id|rval
op_plus
l_int|192
)paren
suffix:semicolon
op_star
(paren
id|rval
op_plus
l_int|192
)paren
op_assign
(paren
r_int
r_int
)paren
(paren
id|rval
op_plus
l_int|256
)paren
suffix:semicolon
op_star
(paren
id|rval
op_plus
l_int|256
)paren
op_assign
(paren
r_int
r_int
)paren
(paren
id|rval
op_plus
l_int|320
)paren
suffix:semicolon
op_star
(paren
id|rval
op_plus
l_int|320
)paren
op_assign
(paren
r_int
r_int
)paren
(paren
id|rval
op_plus
l_int|384
)paren
suffix:semicolon
op_star
(paren
id|rval
op_plus
l_int|384
)paren
op_assign
(paren
r_int
r_int
)paren
(paren
id|rval
op_plus
l_int|448
)paren
suffix:semicolon
op_star
(paren
id|rval
op_plus
l_int|448
)paren
op_assign
(paren
r_int
r_int
)paren
(paren
id|rval
op_plus
l_int|512
)paren
suffix:semicolon
op_star
(paren
id|rval
op_plus
l_int|512
)paren
op_assign
(paren
r_int
r_int
)paren
(paren
id|rval
op_plus
l_int|576
)paren
suffix:semicolon
op_star
(paren
id|rval
op_plus
l_int|576
)paren
op_assign
(paren
r_int
r_int
)paren
(paren
id|rval
op_plus
l_int|640
)paren
suffix:semicolon
op_star
(paren
id|rval
op_plus
l_int|640
)paren
op_assign
(paren
r_int
r_int
)paren
(paren
id|rval
op_plus
l_int|704
)paren
suffix:semicolon
op_star
(paren
id|rval
op_plus
l_int|704
)paren
op_assign
(paren
r_int
r_int
)paren
(paren
id|rval
op_plus
l_int|768
)paren
suffix:semicolon
op_star
(paren
id|rval
op_plus
l_int|768
)paren
op_assign
(paren
r_int
r_int
)paren
(paren
id|rval
op_plus
l_int|832
)paren
suffix:semicolon
op_star
(paren
id|rval
op_plus
l_int|832
)paren
op_assign
(paren
r_int
r_int
)paren
(paren
id|rval
op_plus
l_int|896
)paren
suffix:semicolon
op_star
(paren
id|rval
op_plus
l_int|896
)paren
op_assign
(paren
r_int
r_int
)paren
(paren
id|rval
op_plus
l_int|960
)paren
suffix:semicolon
op_star
(paren
id|rval
op_plus
l_int|960
)paren
op_assign
l_int|0
suffix:semicolon
id|lcwater
op_assign
l_int|15
suffix:semicolon
)brace
id|lcjiffies
op_assign
id|jiffies
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|memset
c_func
(paren
id|rval
comma
l_int|0
comma
l_int|256
)paren
suffix:semicolon
id|flush_chunk
c_func
(paren
(paren
r_int
r_int
)paren
id|rval
)paren
suffix:semicolon
r_return
id|rval
suffix:semicolon
)brace
DECL|function|free_small_chunk
r_static
r_inline
r_void
id|free_small_chunk
c_func
(paren
r_int
r_int
op_star
id|it
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
op_star
id|it
op_assign
(paren
r_int
r_int
)paren
id|lcnks
suffix:semicolon
id|lcnks
op_assign
id|it
suffix:semicolon
id|lcwater
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|lcwater
OG
id|LC_HIGH_WATER
)paren
op_logical_and
(paren
id|jiffies
OG
id|lcjiffies
op_plus
id|RELAX_JIFFIES
)paren
)paren
id|lcwater
op_assign
id|garbage_collect
c_func
(paren
op_amp
id|lcnks
comma
id|lcwater
comma
l_int|16
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|get_big_chunk
r_static
r_int
r_int
op_star
id|get_big_chunk
c_func
(paren
r_void
)paren
(brace
r_int
r_int
op_star
id|rval
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bcwater
)paren
(brace
id|bcwater
op_decrement
suffix:semicolon
id|rval
op_assign
id|bcnks
suffix:semicolon
id|bcnks
op_assign
(paren
r_int
r_int
op_star
)paren
op_star
id|rval
suffix:semicolon
)brace
r_else
(brace
id|rval
op_assign
(paren
r_int
r_int
op_star
)paren
id|__get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rval
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|chunk_pages
op_increment
suffix:semicolon
id|bcnks
op_assign
(paren
id|rval
op_plus
l_int|256
)paren
suffix:semicolon
multiline_comment|/* Cache stomping, I know... */
op_star
(paren
id|rval
op_plus
l_int|256
)paren
op_assign
(paren
r_int
r_int
)paren
(paren
id|rval
op_plus
l_int|512
)paren
suffix:semicolon
op_star
(paren
id|rval
op_plus
l_int|512
)paren
op_assign
(paren
r_int
r_int
)paren
(paren
id|rval
op_plus
l_int|768
)paren
suffix:semicolon
op_star
(paren
id|rval
op_plus
l_int|768
)paren
op_assign
l_int|0
suffix:semicolon
id|bcwater
op_assign
l_int|3
suffix:semicolon
)brace
id|bcjiffies
op_assign
id|jiffies
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|memset
c_func
(paren
id|rval
comma
l_int|0
comma
l_int|1024
)paren
suffix:semicolon
id|flush_chunk
c_func
(paren
(paren
r_int
r_int
)paren
id|rval
)paren
suffix:semicolon
r_return
id|rval
suffix:semicolon
)brace
DECL|function|free_big_chunk
r_static
r_inline
r_void
id|free_big_chunk
c_func
(paren
r_int
r_int
op_star
id|it
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
op_star
id|it
op_assign
(paren
r_int
r_int
)paren
id|bcnks
suffix:semicolon
id|bcnks
op_assign
id|it
suffix:semicolon
id|bcwater
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|bcwater
OG
id|BC_HIGH_WATER
)paren
op_logical_and
(paren
id|jiffies
OG
id|bcjiffies
op_plus
id|RELAX_JIFFIES
)paren
)paren
id|bcwater
op_assign
id|garbage_collect
c_func
(paren
op_amp
id|bcnks
comma
id|bcwater
comma
l_int|4
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|macro|NEW_PGD
mdefine_line|#define NEW_PGD() (pgd_t *) get_big_chunk()
DECL|macro|NEW_PMD
mdefine_line|#define NEW_PMD() (pmd_t *) get_small_chunk()
DECL|macro|NEW_PTE
mdefine_line|#define NEW_PTE() (pte_t *) get_small_chunk()
DECL|macro|FREE_PGD
mdefine_line|#define FREE_PGD(chunk) free_big_chunk((unsigned long *)(chunk))
DECL|macro|FREE_PMD
mdefine_line|#define FREE_PMD(chunk) free_small_chunk((unsigned long *)(chunk))
DECL|macro|FREE_PTE
mdefine_line|#define FREE_PTE(chunk) free_small_chunk((unsigned long *)(chunk))
multiline_comment|/*&n; * Allocate and free page tables. The xxx_kernel() versions are&n; * used to allocate a kernel page table - this turns on ASN bits&n; * if any, and marks the page tables reserved.&n; */
DECL|function|srmmu_pte_free_kernel
r_static
r_void
id|srmmu_pte_free_kernel
c_func
(paren
id|pte_t
op_star
id|pte
)paren
(brace
id|FREE_PTE
c_func
(paren
id|pte
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pte_alloc_kernel
r_static
id|pte_t
op_star
id|srmmu_pte_alloc_kernel
c_func
(paren
id|pmd_t
op_star
id|pmd
comma
r_int
r_int
id|address
)paren
(brace
id|address
op_assign
(paren
id|address
op_rshift
id|PAGE_SHIFT
)paren
op_amp
(paren
id|SRMMU_PTRS_PER_PTE
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_pmd_none
c_func
(paren
op_star
id|pmd
)paren
)paren
(brace
id|pte_t
op_star
id|page
op_assign
id|NEW_PTE
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_pmd_none
c_func
(paren
op_star
id|pmd
)paren
)paren
(brace
r_if
c_cond
(paren
id|page
)paren
(brace
id|pmd_set
c_func
(paren
id|pmd
comma
id|page
)paren
suffix:semicolon
r_return
id|page
op_plus
id|address
suffix:semicolon
)brace
id|pmd_set
c_func
(paren
id|pmd
comma
id|BAD_PAGETABLE
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|FREE_PTE
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|srmmu_pmd_bad
c_func
(paren
op_star
id|pmd
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Bad pmd in pte_alloc: %08lx&bslash;n&quot;
comma
id|pmd_val
c_func
(paren
op_star
id|pmd
)paren
)paren
suffix:semicolon
id|pmd_set
c_func
(paren
id|pmd
comma
id|BAD_PAGETABLE
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
(paren
id|pte_t
op_star
)paren
id|srmmu_pmd_page
c_func
(paren
op_star
id|pmd
)paren
op_plus
id|address
suffix:semicolon
)brace
DECL|function|srmmu_pmd_free_kernel
r_static
r_void
id|srmmu_pmd_free_kernel
c_func
(paren
id|pmd_t
op_star
id|pmd
)paren
(brace
id|FREE_PMD
c_func
(paren
id|pmd
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pmd_alloc_kernel
r_static
id|pmd_t
op_star
id|srmmu_pmd_alloc_kernel
c_func
(paren
id|pgd_t
op_star
id|pgd
comma
r_int
r_int
id|address
)paren
(brace
id|address
op_assign
(paren
id|address
op_rshift
id|SRMMU_PMD_SHIFT
)paren
op_amp
(paren
id|SRMMU_PTRS_PER_PMD
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_pgd_none
c_func
(paren
op_star
id|pgd
)paren
)paren
(brace
id|pmd_t
op_star
id|page
suffix:semicolon
id|page
op_assign
id|NEW_PMD
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_pgd_none
c_func
(paren
op_star
id|pgd
)paren
)paren
(brace
r_if
c_cond
(paren
id|page
)paren
(brace
id|pgd_set
c_func
(paren
id|pgd
comma
id|page
)paren
suffix:semicolon
r_return
id|page
op_plus
id|address
suffix:semicolon
)brace
id|pgd_set
c_func
(paren
id|pgd
comma
(paren
id|pmd_t
op_star
)paren
id|BAD_PAGETABLE
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|FREE_PMD
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|srmmu_pgd_bad
c_func
(paren
op_star
id|pgd
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Bad pgd in pmd_alloc: %08lx&bslash;n&quot;
comma
id|pgd_val
c_func
(paren
op_star
id|pgd
)paren
)paren
suffix:semicolon
id|pgd_set
c_func
(paren
id|pgd
comma
(paren
id|pmd_t
op_star
)paren
id|BAD_PAGETABLE
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
(paren
id|pmd_t
op_star
)paren
id|pgd_page
c_func
(paren
op_star
id|pgd
)paren
op_plus
id|address
suffix:semicolon
)brace
DECL|function|srmmu_pte_free
r_static
r_void
id|srmmu_pte_free
c_func
(paren
id|pte_t
op_star
id|pte
)paren
(brace
id|FREE_PTE
c_func
(paren
id|pte
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pte_alloc
r_static
id|pte_t
op_star
id|srmmu_pte_alloc
c_func
(paren
id|pmd_t
op_star
id|pmd
comma
r_int
r_int
id|address
)paren
(brace
id|address
op_assign
(paren
id|address
op_rshift
id|PAGE_SHIFT
)paren
op_amp
(paren
id|SRMMU_PTRS_PER_PTE
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_pmd_none
c_func
(paren
op_star
id|pmd
)paren
)paren
(brace
id|pte_t
op_star
id|page
op_assign
id|NEW_PTE
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_pmd_none
c_func
(paren
op_star
id|pmd
)paren
)paren
(brace
r_if
c_cond
(paren
id|page
)paren
(brace
id|pmd_set
c_func
(paren
id|pmd
comma
id|page
)paren
suffix:semicolon
r_return
id|page
op_plus
id|address
suffix:semicolon
)brace
id|pmd_set
c_func
(paren
id|pmd
comma
id|BAD_PAGETABLE
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|FREE_PTE
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|srmmu_pmd_bad
c_func
(paren
op_star
id|pmd
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Bad pmd in pte_alloc: %08lx&bslash;n&quot;
comma
id|pmd_val
c_func
(paren
op_star
id|pmd
)paren
)paren
suffix:semicolon
id|pmd_set
c_func
(paren
id|pmd
comma
id|BAD_PAGETABLE
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
(paren
(paren
id|pte_t
op_star
)paren
id|srmmu_pmd_page
c_func
(paren
op_star
id|pmd
)paren
)paren
op_plus
id|address
suffix:semicolon
)brace
multiline_comment|/* Real three-level page tables on SRMMU. */
DECL|function|srmmu_pmd_free
r_static
r_void
id|srmmu_pmd_free
c_func
(paren
id|pmd_t
op_star
id|pmd
)paren
(brace
id|FREE_PMD
c_func
(paren
id|pmd
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pmd_alloc
r_static
id|pmd_t
op_star
id|srmmu_pmd_alloc
c_func
(paren
id|pgd_t
op_star
id|pgd
comma
r_int
r_int
id|address
)paren
(brace
id|address
op_assign
(paren
id|address
op_rshift
id|SRMMU_PMD_SHIFT
)paren
op_amp
(paren
id|SRMMU_PTRS_PER_PMD
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_pgd_none
c_func
(paren
op_star
id|pgd
)paren
)paren
(brace
id|pmd_t
op_star
id|page
op_assign
id|NEW_PMD
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_pgd_none
c_func
(paren
op_star
id|pgd
)paren
)paren
(brace
r_if
c_cond
(paren
id|page
)paren
(brace
id|pgd_set
c_func
(paren
id|pgd
comma
id|page
)paren
suffix:semicolon
r_return
id|page
op_plus
id|address
suffix:semicolon
)brace
id|pgd_set
c_func
(paren
id|pgd
comma
(paren
id|pmd_t
op_star
)paren
id|BAD_PAGETABLE
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|FREE_PMD
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|srmmu_pgd_bad
c_func
(paren
op_star
id|pgd
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Bad pgd in pmd_alloc: %08lx&bslash;n&quot;
comma
id|pgd_val
c_func
(paren
op_star
id|pgd
)paren
)paren
suffix:semicolon
id|pgd_set
c_func
(paren
id|pgd
comma
(paren
id|pmd_t
op_star
)paren
id|BAD_PAGETABLE
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
(paren
id|pmd_t
op_star
)paren
id|srmmu_pgd_page
c_func
(paren
op_star
id|pgd
)paren
op_plus
id|address
suffix:semicolon
)brace
DECL|function|srmmu_pgd_free
r_static
r_void
id|srmmu_pgd_free
c_func
(paren
id|pgd_t
op_star
id|pgd
)paren
(brace
id|FREE_PGD
c_func
(paren
id|pgd
)paren
suffix:semicolon
)brace
DECL|function|srmmu_pgd_alloc
r_static
id|pgd_t
op_star
id|srmmu_pgd_alloc
c_func
(paren
r_void
)paren
(brace
r_return
id|NEW_PGD
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_set_pte_cacheable
r_static
r_void
id|srmmu_set_pte_cacheable
c_func
(paren
id|pte_t
op_star
id|ptep
comma
id|pte_t
id|pteval
)paren
(brace
id|srmmu_set_entry
c_func
(paren
id|ptep
comma
id|pte_val
c_func
(paren
id|pteval
)paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_set_pte_nocache_cypress
r_static
r_void
id|srmmu_set_pte_nocache_cypress
c_func
(paren
id|pte_t
op_star
id|ptep
comma
id|pte_t
id|pteval
)paren
(brace
r_register
r_int
r_int
id|a
comma
id|b
comma
id|c
comma
id|d
comma
id|e
comma
id|f
comma
id|g
suffix:semicolon
r_int
r_int
id|line
comma
id|page
suffix:semicolon
id|srmmu_set_entry
c_func
(paren
id|ptep
comma
id|pte_val
c_func
(paren
id|pteval
)paren
)paren
suffix:semicolon
id|page
op_assign
(paren
(paren
r_int
r_int
)paren
id|ptep
)paren
op_amp
id|PAGE_MASK
suffix:semicolon
id|line
op_assign
(paren
id|page
op_plus
id|PAGE_SIZE
)paren
op_minus
l_int|0x100
suffix:semicolon
id|a
op_assign
l_int|0x20
suffix:semicolon
id|b
op_assign
l_int|0x40
suffix:semicolon
id|c
op_assign
l_int|0x60
suffix:semicolon
id|d
op_assign
l_int|0x80
suffix:semicolon
id|e
op_assign
l_int|0xa0
suffix:semicolon
id|f
op_assign
l_int|0xc0
suffix:semicolon
id|g
op_assign
l_int|0xe0
suffix:semicolon
r_goto
id|inside
suffix:semicolon
r_do
(brace
id|line
op_sub_assign
l_int|0x100
suffix:semicolon
id|inside
suffix:colon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;sta %%g0, [%0] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %2] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %3] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %4] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %5] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %6] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %7] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %8] %1&bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|line
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_FLUSH_PAGE
)paren
comma
l_string|&quot;r&quot;
(paren
id|a
)paren
comma
l_string|&quot;r&quot;
(paren
id|b
)paren
comma
l_string|&quot;r&quot;
(paren
id|c
)paren
comma
l_string|&quot;r&quot;
(paren
id|d
)paren
comma
l_string|&quot;r&quot;
(paren
id|e
)paren
comma
l_string|&quot;r&quot;
(paren
id|f
)paren
comma
l_string|&quot;r&quot;
(paren
id|g
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|line
op_ne
id|page
)paren
(brace
suffix:semicolon
)brace
)brace
DECL|function|srmmu_set_pte_nocache_viking
r_static
r_void
id|srmmu_set_pte_nocache_viking
c_func
(paren
id|pte_t
op_star
id|ptep
comma
id|pte_t
id|pteval
)paren
(brace
r_int
r_int
id|vaddr
suffix:semicolon
r_int
id|set
suffix:semicolon
r_int
id|i
suffix:semicolon
id|set
op_assign
(paren
(paren
r_int
r_int
)paren
id|ptep
op_rshift
l_int|5
)paren
op_amp
l_int|0x7f
suffix:semicolon
id|vaddr
op_assign
(paren
id|KERNBASE
op_plus
id|PAGE_SIZE
)paren
op_or
(paren
id|set
op_lshift
l_int|5
)paren
suffix:semicolon
id|srmmu_set_entry
c_func
(paren
id|ptep
comma
id|pte_val
c_func
(paren
id|pteval
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|__asm__
id|__volatile__
(paren
l_string|&quot;ld [%0], %%g0&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|vaddr
)paren
)paren
suffix:semicolon
id|vaddr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
)brace
DECL|function|srmmu_quick_kernel_fault
r_static
r_void
id|srmmu_quick_kernel_fault
c_func
(paren
r_int
r_int
id|address
)paren
(brace
macro_line|#ifdef __SMP__
id|printk
c_func
(paren
l_string|&quot;CPU[%d]: Kernel faults at addr=0x%08lx&bslash;n&quot;
comma
id|smp_processor_id
c_func
(paren
)paren
comma
id|address
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
l_string|&quot;Kernel faults at addr=0x%08lx&bslash;n&quot;
comma
id|address
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PTE=%08lx&bslash;n&quot;
comma
id|srmmu_hwprobe
c_func
(paren
(paren
id|address
op_amp
id|PAGE_MASK
)paren
)paren
)paren
suffix:semicolon
id|die_if_kernel
c_func
(paren
l_string|&quot;SRMMU bolixed...&quot;
comma
id|current-&gt;tss.kregs
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|alloc_context
r_static
r_inline
r_void
id|alloc_context
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
r_struct
id|ctx_list
op_star
id|ctxp
suffix:semicolon
id|ctxp
op_assign
id|ctx_free.next
suffix:semicolon
r_if
c_cond
(paren
id|ctxp
op_ne
op_amp
id|ctx_free
)paren
(brace
id|remove_from_ctx_list
c_func
(paren
id|ctxp
)paren
suffix:semicolon
id|add_to_used_ctxlist
c_func
(paren
id|ctxp
)paren
suffix:semicolon
id|mm-&gt;context
op_assign
id|ctxp-&gt;ctx_number
suffix:semicolon
id|ctxp-&gt;ctx_mm
op_assign
id|mm
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ctxp
op_assign
id|ctx_used.next
suffix:semicolon
r_if
c_cond
(paren
id|ctxp-&gt;ctx_mm
op_eq
id|current-&gt;mm
)paren
(brace
id|ctxp
op_assign
id|ctxp-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ctxp
op_eq
op_amp
id|ctx_used
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;out of mmu contexts&quot;
)paren
suffix:semicolon
)brace
id|flush_cache_mm
c_func
(paren
id|ctxp-&gt;ctx_mm
)paren
suffix:semicolon
id|flush_tlb_mm
c_func
(paren
id|ctxp-&gt;ctx_mm
)paren
suffix:semicolon
id|remove_from_ctx_list
c_func
(paren
id|ctxp
)paren
suffix:semicolon
id|add_to_used_ctxlist
c_func
(paren
id|ctxp
)paren
suffix:semicolon
id|ctxp-&gt;ctx_mm-&gt;context
op_assign
id|NO_CONTEXT
suffix:semicolon
id|ctxp-&gt;ctx_mm
op_assign
id|mm
suffix:semicolon
id|mm-&gt;context
op_assign
id|ctxp-&gt;ctx_number
suffix:semicolon
)brace
DECL|function|free_context
r_static
r_inline
r_void
id|free_context
c_func
(paren
r_int
id|context
)paren
(brace
r_struct
id|ctx_list
op_star
id|ctx_old
suffix:semicolon
id|ctx_old
op_assign
id|ctx_list_pool
op_plus
id|context
suffix:semicolon
id|remove_from_ctx_list
c_func
(paren
id|ctx_old
)paren
suffix:semicolon
id|add_to_free_ctxlist
c_func
(paren
id|ctx_old
)paren
suffix:semicolon
)brace
DECL|function|srmmu_switch_to_context
r_static
r_void
id|srmmu_switch_to_context
c_func
(paren
r_struct
id|task_struct
op_star
id|tsk
)paren
(brace
r_if
c_cond
(paren
id|tsk-&gt;mm-&gt;context
op_eq
id|NO_CONTEXT
)paren
(brace
id|alloc_context
c_func
(paren
id|tsk-&gt;mm
)paren
suffix:semicolon
id|flush_cache_mm
c_func
(paren
id|tsk-&gt;mm
)paren
suffix:semicolon
id|ctxd_set
c_func
(paren
op_amp
id|srmmu_context_table
(braket
id|tsk-&gt;mm-&gt;context
)braket
comma
id|tsk-&gt;mm-&gt;pgd
)paren
suffix:semicolon
id|flush_tlb_mm
c_func
(paren
id|tsk-&gt;mm
)paren
suffix:semicolon
)brace
id|srmmu_set_context
c_func
(paren
id|tsk-&gt;mm-&gt;context
)paren
suffix:semicolon
)brace
DECL|function|srmmu_init_new_context
r_static
r_void
id|srmmu_init_new_context
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
id|alloc_context
c_func
(paren
id|mm
)paren
suffix:semicolon
id|flush_cache_mm
c_func
(paren
id|mm
)paren
suffix:semicolon
id|ctxd_set
c_func
(paren
op_amp
id|srmmu_context_table
(braket
id|mm-&gt;context
)braket
comma
id|mm-&gt;pgd
)paren
suffix:semicolon
id|flush_tlb_mm
c_func
(paren
id|mm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mm
op_eq
id|current-&gt;mm
)paren
(brace
id|srmmu_set_context
c_func
(paren
id|mm-&gt;context
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Low level IO area allocation on the SRMMU. */
DECL|function|srmmu_mapioaddr
r_void
id|srmmu_mapioaddr
c_func
(paren
r_int
r_int
id|physaddr
comma
r_int
r_int
id|virt_addr
comma
r_int
id|bus_type
comma
r_int
id|rdonly
)paren
(brace
id|pgd_t
op_star
id|pgdp
suffix:semicolon
id|pmd_t
op_star
id|pmdp
suffix:semicolon
id|pte_t
op_star
id|ptep
suffix:semicolon
r_int
r_int
id|tmp
suffix:semicolon
id|physaddr
op_and_assign
id|PAGE_MASK
suffix:semicolon
id|pgdp
op_assign
id|srmmu_pgd_offset
c_func
(paren
id|init_task.mm
comma
id|virt_addr
)paren
suffix:semicolon
id|pmdp
op_assign
id|srmmu_pmd_offset
c_func
(paren
id|pgdp
comma
id|virt_addr
)paren
suffix:semicolon
id|ptep
op_assign
id|srmmu_pte_offset
c_func
(paren
id|pmdp
comma
id|virt_addr
)paren
suffix:semicolon
id|tmp
op_assign
(paren
id|physaddr
op_rshift
l_int|4
)paren
op_or
id|SRMMU_ET_PTE
suffix:semicolon
multiline_comment|/* I need to test whether this is consistent over all&n;&t; * sun4m&squot;s.  The bus_type represents the upper 4 bits of&n;&t; * 36-bit physical address on the I/O space lines...&n;&t; */
id|tmp
op_or_assign
(paren
id|bus_type
op_lshift
l_int|28
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rdonly
)paren
(brace
id|tmp
op_or_assign
id|SRMMU_PRIV_RDONLY
suffix:semicolon
)brace
r_else
id|tmp
op_or_assign
id|SRMMU_PRIV
suffix:semicolon
id|flush_page_to_ram
c_func
(paren
id|virt_addr
)paren
suffix:semicolon
id|set_pte
c_func
(paren
id|ptep
comma
id|__pte
c_func
(paren
id|tmp
)paren
)paren
suffix:semicolon
id|flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_unmapioaddr
r_void
id|srmmu_unmapioaddr
c_func
(paren
r_int
r_int
id|virt_addr
)paren
(brace
id|pgd_t
op_star
id|pgdp
suffix:semicolon
id|pmd_t
op_star
id|pmdp
suffix:semicolon
id|pte_t
op_star
id|ptep
suffix:semicolon
id|pgdp
op_assign
id|srmmu_pgd_offset
c_func
(paren
id|init_task.mm
comma
id|virt_addr
)paren
suffix:semicolon
id|pmdp
op_assign
id|srmmu_pmd_offset
c_func
(paren
id|pgdp
comma
id|virt_addr
)paren
suffix:semicolon
id|ptep
op_assign
id|srmmu_pte_offset
c_func
(paren
id|pmdp
comma
id|virt_addr
)paren
suffix:semicolon
multiline_comment|/* No need to flush uncacheable page. */
id|set_pte
c_func
(paren
id|ptep
comma
id|srmmu_mk_pte
c_func
(paren
(paren
r_int
r_int
)paren
id|EMPTY_PGE
comma
id|PAGE_SHARED
)paren
)paren
suffix:semicolon
id|flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_lockarea
r_static
r_char
op_star
id|srmmu_lockarea
c_func
(paren
r_char
op_star
id|vaddr
comma
r_int
r_int
id|len
)paren
(brace
r_return
id|vaddr
suffix:semicolon
)brace
DECL|function|srmmu_unlockarea
r_static
r_void
id|srmmu_unlockarea
c_func
(paren
r_char
op_star
id|vaddr
comma
r_int
r_int
id|len
)paren
(brace
)brace
multiline_comment|/* This is used in many routines below. */
DECL|macro|UWINMASK_OFFSET
mdefine_line|#define UWINMASK_OFFSET (const unsigned long)(&amp;(((struct task_struct *)0)-&gt;tss.uwinmask))
multiline_comment|/* On the SRMMU we do not have the problems with limited tlb entries&n; * for mapping kernel pages, so we just take things from the free page&n; * pool.  As a side effect we are putting a little too much pressure&n; * on the gfp() subsystem.  This setup also makes the logic of the&n; * iommu mapping code a lot easier as we can transparently handle&n; * mappings on the kernel stack without any special code as we did&n; * need on the sun4c.&n; */
DECL|function|srmmu_alloc_task_struct
r_struct
id|task_struct
op_star
id|srmmu_alloc_task_struct
c_func
(paren
r_void
)paren
(brace
r_return
(paren
r_struct
id|task_struct
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|srmmu_free_task_struct
r_static
r_void
id|srmmu_free_task_struct
c_func
(paren
r_struct
id|task_struct
op_star
id|tsk
)paren
(brace
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|tsk
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* tsunami.S */
r_extern
r_void
id|tsunami_flush_cache_all
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|tsunami_flush_cache_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
suffix:semicolon
r_extern
r_void
id|tsunami_flush_cache_range
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
suffix:semicolon
r_extern
r_void
id|tsunami_flush_cache_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
suffix:semicolon
r_extern
r_void
id|tsunami_flush_page_to_ram
c_func
(paren
r_int
r_int
id|page
)paren
suffix:semicolon
r_extern
r_void
id|tsunami_flush_page_for_dma
c_func
(paren
r_int
r_int
id|page
)paren
suffix:semicolon
r_extern
r_void
id|tsunami_flush_sig_insns
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|insn_addr
)paren
suffix:semicolon
r_extern
r_void
id|tsunami_flush_chunk
c_func
(paren
r_int
r_int
id|chunk
)paren
suffix:semicolon
r_extern
r_void
id|tsunami_flush_tlb_all
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|tsunami_flush_tlb_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
suffix:semicolon
r_extern
r_void
id|tsunami_flush_tlb_range
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
suffix:semicolon
r_extern
r_void
id|tsunami_flush_tlb_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
suffix:semicolon
multiline_comment|/* Swift flushes.  It has the recommended SRMMU specification flushing&n; * facilities, so we can do things in a more fine grained fashion than we&n; * could on the tsunami.  Let&squot;s watch out for HARDWARE BUGS...&n; */
DECL|function|swift_flush_cache_all
r_static
r_void
id|swift_flush_cache_all
c_func
(paren
r_void
)paren
(brace
id|flush_user_windows
c_func
(paren
)paren
suffix:semicolon
id|swift_idflash_clear
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|swift_flush_cache_mm
r_static
r_void
id|swift_flush_cache_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
id|FLUSH_BEGIN
c_func
(paren
id|mm
)paren
id|flush_user_windows
c_func
(paren
)paren
suffix:semicolon
id|swift_idflash_clear
c_func
(paren
)paren
suffix:semicolon
id|FLUSH_END
)brace
DECL|function|swift_flush_cache_range
r_static
r_void
id|swift_flush_cache_range
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
id|FLUSH_BEGIN
c_func
(paren
id|mm
)paren
id|flush_user_windows
c_func
(paren
)paren
suffix:semicolon
id|swift_idflash_clear
c_func
(paren
)paren
suffix:semicolon
id|FLUSH_END
)brace
DECL|function|swift_flush_cache_page
r_static
r_void
id|swift_flush_cache_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
(brace
id|FLUSH_BEGIN
c_func
(paren
id|vma-&gt;vm_mm
)paren
id|flush_user_windows
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_EXEC
)paren
(brace
id|swift_flush_icache
c_func
(paren
)paren
suffix:semicolon
)brace
id|swift_flush_dcache
c_func
(paren
)paren
suffix:semicolon
id|FLUSH_END
)brace
multiline_comment|/* Not copy-back on swift. */
DECL|function|swift_flush_page_to_ram
r_static
r_void
id|swift_flush_page_to_ram
c_func
(paren
r_int
r_int
id|page
)paren
(brace
)brace
multiline_comment|/* But not IO coherent either. */
DECL|function|swift_flush_page_for_dma
r_static
r_void
id|swift_flush_page_for_dma
c_func
(paren
r_int
r_int
id|page
)paren
(brace
id|swift_flush_dcache
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Again, Swift is non-snooping split I/D cache&squot;d just like tsunami,&n; * so have to punt the icache for on-stack signal insns.  Only the&n; * icache need be flushed since the dcache is write-through.&n; */
DECL|function|swift_flush_sig_insns
r_static
r_void
id|swift_flush_sig_insns
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|insn_addr
)paren
(brace
id|swift_flush_icache
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|swift_flush_chunk
r_static
r_void
id|swift_flush_chunk
c_func
(paren
r_int
r_int
id|chunk
)paren
(brace
)brace
DECL|function|swift_flush_tlb_all
r_static
r_void
id|swift_flush_tlb_all
c_func
(paren
r_void
)paren
(brace
id|srmmu_flush_whole_tlb
c_func
(paren
)paren
suffix:semicolon
id|module_stats.invall
op_increment
suffix:semicolon
)brace
DECL|function|swift_flush_tlb_mm
r_static
r_void
id|swift_flush_tlb_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
id|FLUSH_BEGIN
c_func
(paren
id|mm
)paren
id|srmmu_flush_whole_tlb
c_func
(paren
)paren
suffix:semicolon
id|module_stats.invmm
op_increment
suffix:semicolon
id|FLUSH_END
)brace
DECL|function|swift_flush_tlb_range
r_static
r_void
id|swift_flush_tlb_range
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
id|FLUSH_BEGIN
c_func
(paren
id|mm
)paren
id|srmmu_flush_whole_tlb
c_func
(paren
)paren
suffix:semicolon
id|module_stats.invrnge
op_increment
suffix:semicolon
id|FLUSH_END
)brace
DECL|function|swift_flush_tlb_page
r_static
r_void
id|swift_flush_tlb_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
(brace
id|FLUSH_BEGIN
c_func
(paren
id|vma-&gt;vm_mm
)paren
id|srmmu_flush_whole_tlb
c_func
(paren
)paren
suffix:semicolon
id|module_stats.invpg
op_increment
suffix:semicolon
id|FLUSH_END
)brace
multiline_comment|/* The following are all MBUS based SRMMU modules, and therefore could&n; * be found in a multiprocessor configuration.  On the whole, these&n; * chips seems to be much more touchy about DVMA and page tables&n; * with respect to cache coherency.&n; */
multiline_comment|/* Cypress flushes. */
DECL|function|cypress_flush_cache_all
r_static
r_void
id|cypress_flush_cache_all
c_func
(paren
r_void
)paren
(brace
r_volatile
r_int
r_int
id|cypress_sucks
suffix:semicolon
r_int
r_int
id|faddr
comma
id|tagval
suffix:semicolon
id|flush_user_windows
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|faddr
op_assign
l_int|0
suffix:semicolon
id|faddr
OL
l_int|0x10000
suffix:semicolon
id|faddr
op_add_assign
l_int|0x20
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;lda [%1 + %2] %3, %0&bslash;n&bslash;t&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|tagval
)paren
suffix:colon
l_string|&quot;r&quot;
(paren
id|faddr
)paren
comma
l_string|&quot;r&quot;
(paren
l_int|0x40000
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_DATAC_TAG
)paren
)paren
suffix:semicolon
multiline_comment|/* If modified and valid, kick it. */
r_if
c_cond
(paren
(paren
id|tagval
op_amp
l_int|0x60
)paren
op_eq
l_int|0x60
)paren
(brace
id|cypress_sucks
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
(paren
l_int|0xf0020000
op_plus
id|faddr
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|cypress_flush_cache_mm
r_static
r_void
id|cypress_flush_cache_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
r_register
r_int
r_int
id|a
comma
id|b
comma
id|c
comma
id|d
comma
id|e
comma
id|f
comma
id|g
suffix:semicolon
r_int
r_int
id|flags
comma
id|faddr
suffix:semicolon
r_int
id|octx
suffix:semicolon
id|FLUSH_BEGIN
c_func
(paren
id|mm
)paren
id|flush_user_windows
c_func
(paren
)paren
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|octx
op_assign
id|srmmu_get_context
c_func
(paren
)paren
suffix:semicolon
id|srmmu_set_context
c_func
(paren
id|mm-&gt;context
)paren
suffix:semicolon
id|a
op_assign
l_int|0x20
suffix:semicolon
id|b
op_assign
l_int|0x40
suffix:semicolon
id|c
op_assign
l_int|0x60
suffix:semicolon
id|d
op_assign
l_int|0x80
suffix:semicolon
id|e
op_assign
l_int|0xa0
suffix:semicolon
id|f
op_assign
l_int|0xc0
suffix:semicolon
id|g
op_assign
l_int|0xe0
suffix:semicolon
id|faddr
op_assign
(paren
l_int|0x10000
op_minus
l_int|0x100
)paren
suffix:semicolon
r_goto
id|inside
suffix:semicolon
r_do
(brace
id|faddr
op_sub_assign
l_int|0x100
suffix:semicolon
id|inside
suffix:colon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;sta %%g0, [%0] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %2] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %3] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %4] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %5] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %6] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %7] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %8] %1&bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|faddr
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_FLUSH_CTX
)paren
comma
l_string|&quot;r&quot;
(paren
id|a
)paren
comma
l_string|&quot;r&quot;
(paren
id|b
)paren
comma
l_string|&quot;r&quot;
(paren
id|c
)paren
comma
l_string|&quot;r&quot;
(paren
id|d
)paren
comma
l_string|&quot;r&quot;
(paren
id|e
)paren
comma
l_string|&quot;r&quot;
(paren
id|f
)paren
comma
l_string|&quot;r&quot;
(paren
id|g
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|faddr
)paren
(brace
suffix:semicolon
)brace
id|srmmu_set_context
c_func
(paren
id|octx
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|FLUSH_END
)brace
DECL|function|cypress_flush_cache_range
r_static
r_void
id|cypress_flush_cache_range
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
r_register
r_int
r_int
id|a
comma
id|b
comma
id|c
comma
id|d
comma
id|e
comma
id|f
comma
id|g
suffix:semicolon
r_int
r_int
id|flags
comma
id|faddr
suffix:semicolon
r_int
id|octx
suffix:semicolon
id|FLUSH_BEGIN
c_func
(paren
id|mm
)paren
id|flush_user_windows
c_func
(paren
)paren
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|octx
op_assign
id|srmmu_get_context
c_func
(paren
)paren
suffix:semicolon
id|srmmu_set_context
c_func
(paren
id|mm-&gt;context
)paren
suffix:semicolon
id|a
op_assign
l_int|0x20
suffix:semicolon
id|b
op_assign
l_int|0x40
suffix:semicolon
id|c
op_assign
l_int|0x60
suffix:semicolon
id|d
op_assign
l_int|0x80
suffix:semicolon
id|e
op_assign
l_int|0xa0
suffix:semicolon
id|f
op_assign
l_int|0xc0
suffix:semicolon
id|g
op_assign
l_int|0xe0
suffix:semicolon
id|start
op_and_assign
id|SRMMU_PMD_MASK
suffix:semicolon
r_while
c_loop
(paren
id|start
OL
id|end
)paren
(brace
id|faddr
op_assign
(paren
id|start
op_plus
(paren
l_int|0x10000
op_minus
l_int|0x100
)paren
)paren
suffix:semicolon
r_goto
id|inside
suffix:semicolon
r_do
(brace
id|faddr
op_sub_assign
l_int|0x100
suffix:semicolon
id|inside
suffix:colon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;sta %%g0, [%0] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %2] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %3] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %4] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %5] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %6] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %7] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %8] %1&bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|faddr
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_FLUSH_SEG
)paren
comma
l_string|&quot;r&quot;
(paren
id|a
)paren
comma
l_string|&quot;r&quot;
(paren
id|b
)paren
comma
l_string|&quot;r&quot;
(paren
id|c
)paren
comma
l_string|&quot;r&quot;
(paren
id|d
)paren
comma
l_string|&quot;r&quot;
(paren
id|e
)paren
comma
l_string|&quot;r&quot;
(paren
id|f
)paren
comma
l_string|&quot;r&quot;
(paren
id|g
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|faddr
op_ne
id|start
)paren
suffix:semicolon
id|start
op_add_assign
id|SRMMU_PMD_SIZE
suffix:semicolon
)brace
id|srmmu_set_context
c_func
(paren
id|octx
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|FLUSH_END
)brace
DECL|function|cypress_flush_cache_page
r_static
r_void
id|cypress_flush_cache_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
(brace
r_register
r_int
r_int
id|a
comma
id|b
comma
id|c
comma
id|d
comma
id|e
comma
id|f
comma
id|g
suffix:semicolon
r_struct
id|mm_struct
op_star
id|mm
op_assign
id|vma-&gt;vm_mm
suffix:semicolon
r_int
r_int
id|flags
comma
id|line
suffix:semicolon
r_int
id|octx
suffix:semicolon
id|FLUSH_BEGIN
c_func
(paren
id|mm
)paren
id|flush_user_windows
c_func
(paren
)paren
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|octx
op_assign
id|srmmu_get_context
c_func
(paren
)paren
suffix:semicolon
id|srmmu_set_context
c_func
(paren
id|mm-&gt;context
)paren
suffix:semicolon
id|a
op_assign
l_int|0x20
suffix:semicolon
id|b
op_assign
l_int|0x40
suffix:semicolon
id|c
op_assign
l_int|0x60
suffix:semicolon
id|d
op_assign
l_int|0x80
suffix:semicolon
id|e
op_assign
l_int|0xa0
suffix:semicolon
id|f
op_assign
l_int|0xc0
suffix:semicolon
id|g
op_assign
l_int|0xe0
suffix:semicolon
id|page
op_and_assign
id|PAGE_MASK
suffix:semicolon
id|line
op_assign
(paren
id|page
op_plus
id|PAGE_SIZE
)paren
op_minus
l_int|0x100
suffix:semicolon
r_goto
id|inside
suffix:semicolon
r_do
(brace
id|line
op_sub_assign
l_int|0x100
suffix:semicolon
id|inside
suffix:colon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;sta %%g0, [%0] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %2] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %3] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %4] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %5] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %6] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %7] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %8] %1&bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|line
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_FLUSH_PAGE
)paren
comma
l_string|&quot;r&quot;
(paren
id|a
)paren
comma
l_string|&quot;r&quot;
(paren
id|b
)paren
comma
l_string|&quot;r&quot;
(paren
id|c
)paren
comma
l_string|&quot;r&quot;
(paren
id|d
)paren
comma
l_string|&quot;r&quot;
(paren
id|e
)paren
comma
l_string|&quot;r&quot;
(paren
id|f
)paren
comma
l_string|&quot;r&quot;
(paren
id|g
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|line
op_ne
id|page
)paren
(brace
suffix:semicolon
)brace
id|srmmu_set_context
c_func
(paren
id|octx
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|FLUSH_END
)brace
multiline_comment|/* Cypress is copy-back, at least that is how we configure it. */
DECL|function|cypress_flush_page_to_ram
r_static
r_void
id|cypress_flush_page_to_ram
c_func
(paren
r_int
r_int
id|page
)paren
(brace
r_register
r_int
r_int
id|a
comma
id|b
comma
id|c
comma
id|d
comma
id|e
comma
id|f
comma
id|g
suffix:semicolon
r_int
r_int
id|line
suffix:semicolon
id|a
op_assign
l_int|0x20
suffix:semicolon
id|b
op_assign
l_int|0x40
suffix:semicolon
id|c
op_assign
l_int|0x60
suffix:semicolon
id|d
op_assign
l_int|0x80
suffix:semicolon
id|e
op_assign
l_int|0xa0
suffix:semicolon
id|f
op_assign
l_int|0xc0
suffix:semicolon
id|g
op_assign
l_int|0xe0
suffix:semicolon
id|page
op_and_assign
id|PAGE_MASK
suffix:semicolon
id|line
op_assign
(paren
id|page
op_plus
id|PAGE_SIZE
)paren
op_minus
l_int|0x100
suffix:semicolon
r_goto
id|inside
suffix:semicolon
r_do
(brace
id|line
op_sub_assign
l_int|0x100
suffix:semicolon
id|inside
suffix:colon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;sta %%g0, [%0] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %2] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %3] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %4] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %5] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %6] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %7] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %8] %1&bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|line
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_FLUSH_PAGE
)paren
comma
l_string|&quot;r&quot;
(paren
id|a
)paren
comma
l_string|&quot;r&quot;
(paren
id|b
)paren
comma
l_string|&quot;r&quot;
(paren
id|c
)paren
comma
l_string|&quot;r&quot;
(paren
id|d
)paren
comma
l_string|&quot;r&quot;
(paren
id|e
)paren
comma
l_string|&quot;r&quot;
(paren
id|f
)paren
comma
l_string|&quot;r&quot;
(paren
id|g
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|line
op_ne
id|page
)paren
(brace
suffix:semicolon
)brace
)brace
DECL|function|cypress_flush_chunk
r_static
r_void
id|cypress_flush_chunk
c_func
(paren
r_int
r_int
id|chunk
)paren
(brace
id|cypress_flush_page_to_ram
c_func
(paren
id|chunk
)paren
suffix:semicolon
)brace
multiline_comment|/* Cypress is also IO cache coherent. */
DECL|function|cypress_flush_page_for_dma
r_static
r_void
id|cypress_flush_page_for_dma
c_func
(paren
r_int
r_int
id|page
)paren
(brace
)brace
multiline_comment|/* Cypress has unified L2 VIPT, from which both instructions and data&n; * are stored.  It does not have an onboard icache of any sort, therefore&n; * no flush is necessary.&n; */
DECL|function|cypress_flush_sig_insns
r_static
r_void
id|cypress_flush_sig_insns
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|insn_addr
)paren
(brace
)brace
DECL|function|cypress_flush_tlb_all
r_static
r_void
id|cypress_flush_tlb_all
c_func
(paren
r_void
)paren
(brace
id|srmmu_flush_whole_tlb
c_func
(paren
)paren
suffix:semicolon
id|module_stats.invall
op_increment
suffix:semicolon
)brace
DECL|function|cypress_flush_tlb_mm
r_static
r_void
id|cypress_flush_tlb_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
id|FLUSH_BEGIN
c_func
(paren
id|mm
)paren
id|__asm__
id|__volatile__
c_func
(paren
"&quot;"
id|lda
(braket
op_mod
l_int|0
)braket
op_mod
l_int|3
comma
op_mod
op_mod
id|g5
id|sta
op_mod
l_int|2
comma
(braket
op_mod
l_int|0
)braket
op_mod
l_int|3
id|sta
op_mod
op_mod
id|g0
comma
(braket
op_mod
l_int|1
)braket
op_mod
l_int|4
id|sta
op_mod
op_mod
id|g5
comma
(braket
op_mod
l_int|0
)braket
op_mod
l_int|3
"&quot;"
suffix:colon
multiline_comment|/* no outputs */
suffix:colon
l_string|&quot;r&quot;
(paren
id|SRMMU_CTX_REG
)paren
comma
l_string|&quot;r&quot;
(paren
l_int|0x300
)paren
comma
l_string|&quot;r&quot;
(paren
id|mm-&gt;context
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_MMUREGS
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_FLUSH_PROBE
)paren
suffix:colon
l_string|&quot;g5&quot;
)paren
suffix:semicolon
id|module_stats.invmm
op_increment
suffix:semicolon
id|FLUSH_END
)brace
DECL|function|cypress_flush_tlb_range
r_static
r_void
id|cypress_flush_tlb_range
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
r_int
r_int
id|size
suffix:semicolon
id|FLUSH_BEGIN
c_func
(paren
id|mm
)paren
id|start
op_and_assign
id|SRMMU_PGDIR_MASK
suffix:semicolon
id|size
op_assign
id|SRMMU_PGDIR_ALIGN
c_func
(paren
id|end
)paren
op_minus
id|start
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
"&quot;"
id|lda
(braket
op_mod
l_int|0
)braket
op_mod
l_int|5
comma
op_mod
op_mod
id|g5
id|sta
op_mod
l_int|1
comma
(braket
op_mod
l_int|0
)braket
op_mod
l_int|5
l_int|1
suffix:colon
id|subcc
op_mod
l_int|3
comma
op_mod
l_int|4
comma
op_mod
l_int|3
id|bne
l_int|1
id|b
id|sta
op_mod
op_mod
id|g0
comma
(braket
op_mod
l_int|2
op_plus
op_mod
l_int|3
)braket
op_mod
l_int|6
id|sta
op_mod
op_mod
id|g5
comma
(braket
op_mod
l_int|0
)braket
op_mod
l_int|5
"&quot;"
suffix:colon
multiline_comment|/* no outputs */
suffix:colon
l_string|&quot;r&quot;
(paren
id|SRMMU_CTX_REG
)paren
comma
l_string|&quot;r&quot;
(paren
id|mm-&gt;context
)paren
comma
l_string|&quot;r&quot;
(paren
id|start
op_or
l_int|0x200
)paren
comma
l_string|&quot;r&quot;
(paren
id|size
)paren
comma
l_string|&quot;r&quot;
(paren
id|SRMMU_PGDIR_SIZE
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_MMUREGS
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_FLUSH_PROBE
)paren
suffix:colon
l_string|&quot;g5&quot;
comma
l_string|&quot;cc&quot;
)paren
suffix:semicolon
id|module_stats.invrnge
op_increment
suffix:semicolon
id|FLUSH_END
)brace
DECL|function|cypress_flush_tlb_page
r_static
r_void
id|cypress_flush_tlb_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
(brace
r_struct
id|mm_struct
op_star
id|mm
op_assign
id|vma-&gt;vm_mm
suffix:semicolon
id|FLUSH_BEGIN
c_func
(paren
id|mm
)paren
id|__asm__
id|__volatile__
c_func
(paren
"&quot;"
id|lda
(braket
op_mod
l_int|0
)braket
op_mod
l_int|3
comma
op_mod
op_mod
id|g5
id|sta
op_mod
l_int|1
comma
(braket
op_mod
l_int|0
)braket
op_mod
l_int|3
id|sta
op_mod
op_mod
id|g0
comma
(braket
op_mod
l_int|2
)braket
op_mod
l_int|4
id|sta
op_mod
op_mod
id|g5
comma
(braket
op_mod
l_int|0
)braket
op_mod
l_int|3
"&quot;"
suffix:colon
multiline_comment|/* no outputs */
suffix:colon
l_string|&quot;r&quot;
(paren
id|SRMMU_CTX_REG
)paren
comma
l_string|&quot;r&quot;
(paren
id|mm-&gt;context
)paren
comma
l_string|&quot;r&quot;
(paren
id|page
op_amp
id|PAGE_MASK
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_MMUREGS
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_FLUSH_PROBE
)paren
suffix:colon
l_string|&quot;g5&quot;
)paren
suffix:semicolon
id|module_stats.invpg
op_increment
suffix:semicolon
id|FLUSH_END
)brace
multiline_comment|/* viking.S */
r_extern
r_void
id|viking_flush_cache_all
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|viking_flush_cache_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
suffix:semicolon
r_extern
r_void
id|viking_flush_cache_range
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
suffix:semicolon
r_extern
r_void
id|viking_flush_cache_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
suffix:semicolon
r_extern
r_void
id|viking_flush_page_to_ram
c_func
(paren
r_int
r_int
id|page
)paren
suffix:semicolon
r_extern
r_void
id|viking_flush_page_for_dma
c_func
(paren
r_int
r_int
id|page
)paren
suffix:semicolon
r_extern
r_void
id|viking_flush_sig_insns
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|addr
)paren
suffix:semicolon
r_extern
r_void
id|viking_flush_page
c_func
(paren
r_int
r_int
id|page
)paren
suffix:semicolon
r_extern
r_void
id|viking_mxcc_flush_page
c_func
(paren
r_int
r_int
id|page
)paren
suffix:semicolon
r_extern
r_void
id|viking_flush_chunk
c_func
(paren
r_int
r_int
id|chunk
)paren
suffix:semicolon
r_extern
r_void
id|viking_mxcc_flush_chunk
c_func
(paren
r_int
r_int
id|chunk
)paren
suffix:semicolon
r_extern
r_void
id|viking_flush_tlb_all
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|viking_flush_tlb_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
suffix:semicolon
r_extern
r_void
id|viking_flush_tlb_range
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
suffix:semicolon
r_extern
r_void
id|viking_flush_tlb_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
suffix:semicolon
multiline_comment|/* hypersparc.S */
r_extern
r_void
id|hypersparc_flush_cache_all
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|hypersparc_flush_cache_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
suffix:semicolon
r_extern
r_void
id|hypersparc_flush_cache_range
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
suffix:semicolon
r_extern
r_void
id|hypersparc_flush_cache_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
suffix:semicolon
r_extern
r_void
id|hypersparc_flush_page_to_ram
c_func
(paren
r_int
r_int
id|page
)paren
suffix:semicolon
r_extern
r_void
id|hypersparc_flush_chunk
c_func
(paren
r_int
r_int
id|chunk
)paren
suffix:semicolon
r_extern
r_void
id|hypersparc_flush_page_for_dma
c_func
(paren
r_int
r_int
id|page
)paren
suffix:semicolon
r_extern
r_void
id|hypersparc_flush_sig_insns
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|insn_addr
)paren
suffix:semicolon
r_extern
r_void
id|hypersparc_flush_tlb_all
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|hypersparc_flush_tlb_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
suffix:semicolon
r_extern
r_void
id|hypersparc_flush_tlb_range
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
suffix:semicolon
r_extern
r_void
id|hypersparc_flush_tlb_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
suffix:semicolon
r_extern
r_void
id|hypersparc_setup_blockops
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|function|srmmu_set_pte_nocache_hyper
r_static
r_void
id|srmmu_set_pte_nocache_hyper
c_func
(paren
id|pte_t
op_star
id|ptep
comma
id|pte_t
id|pteval
)paren
(brace
r_int
r_int
id|page
op_assign
(paren
(paren
r_int
r_int
)paren
id|ptep
)paren
op_amp
id|PAGE_MASK
suffix:semicolon
id|srmmu_set_entry
c_func
(paren
id|ptep
comma
id|pte_val
c_func
(paren
id|pteval
)paren
)paren
suffix:semicolon
id|hypersparc_flush_page_to_ram
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
DECL|function|hypersparc_ctxd_set
r_static
r_void
id|hypersparc_ctxd_set
c_func
(paren
id|ctxd_t
op_star
id|ctxp
comma
id|pgd_t
op_star
id|pgdp
)paren
(brace
id|srmmu_set_entry
c_func
(paren
(paren
id|pte_t
op_star
)paren
id|ctxp
comma
id|__pte
c_func
(paren
(paren
id|SRMMU_ET_PTD
op_or
(paren
id|srmmu_v2p
c_func
(paren
(paren
r_int
r_int
)paren
id|pgdp
)paren
op_rshift
l_int|4
)paren
)paren
)paren
)paren
suffix:semicolon
id|hypersparc_flush_page_to_ram
c_func
(paren
(paren
r_int
r_int
)paren
id|ctxp
)paren
suffix:semicolon
id|hyper_flush_whole_icache
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|hypersparc_update_rootmmu_dir
r_static
r_void
id|hypersparc_update_rootmmu_dir
c_func
(paren
r_struct
id|task_struct
op_star
id|tsk
comma
id|pgd_t
op_star
id|pgdp
)paren
(brace
r_int
r_int
id|page
op_assign
(paren
(paren
r_int
r_int
)paren
id|pgdp
)paren
op_amp
id|PAGE_MASK
suffix:semicolon
r_if
c_cond
(paren
id|pgdp
op_ne
id|swapper_pg_dir
)paren
(brace
id|hypersparc_flush_page_to_ram
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tsk-&gt;mm-&gt;context
op_ne
id|NO_CONTEXT
)paren
(brace
id|flush_cache_mm
c_func
(paren
id|tsk-&gt;mm
)paren
suffix:semicolon
id|ctxd_set
c_func
(paren
op_amp
id|srmmu_context_table
(braket
id|tsk-&gt;mm-&gt;context
)braket
comma
id|pgdp
)paren
suffix:semicolon
id|flush_tlb_mm
c_func
(paren
id|tsk-&gt;mm
)paren
suffix:semicolon
)brace
)brace
DECL|function|viking_update_rootmmu_dir
r_static
r_void
id|viking_update_rootmmu_dir
c_func
(paren
r_struct
id|task_struct
op_star
id|tsk
comma
id|pgd_t
op_star
id|pgdp
)paren
(brace
id|viking_flush_page
c_func
(paren
(paren
r_int
r_int
)paren
id|pgdp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tsk-&gt;mm-&gt;context
op_ne
id|NO_CONTEXT
)paren
(brace
id|flush_cache_mm
c_func
(paren
id|current-&gt;mm
)paren
suffix:semicolon
id|ctxd_set
c_func
(paren
op_amp
id|srmmu_context_table
(braket
id|tsk-&gt;mm-&gt;context
)braket
comma
id|pgdp
)paren
suffix:semicolon
id|flush_tlb_mm
c_func
(paren
id|current-&gt;mm
)paren
suffix:semicolon
)brace
)brace
DECL|function|cypress_update_rootmmu_dir
r_static
r_void
id|cypress_update_rootmmu_dir
c_func
(paren
r_struct
id|task_struct
op_star
id|tsk
comma
id|pgd_t
op_star
id|pgdp
)paren
(brace
r_register
r_int
r_int
id|a
comma
id|b
comma
id|c
comma
id|d
comma
id|e
comma
id|f
comma
id|g
suffix:semicolon
r_int
r_int
id|page
op_assign
(paren
(paren
r_int
r_int
)paren
id|pgdp
)paren
op_amp
id|PAGE_MASK
suffix:semicolon
r_int
r_int
id|line
suffix:semicolon
id|a
op_assign
l_int|0x20
suffix:semicolon
id|b
op_assign
l_int|0x40
suffix:semicolon
id|c
op_assign
l_int|0x60
suffix:semicolon
id|d
op_assign
l_int|0x80
suffix:semicolon
id|e
op_assign
l_int|0xa0
suffix:semicolon
id|f
op_assign
l_int|0xc0
suffix:semicolon
id|g
op_assign
l_int|0xe0
suffix:semicolon
id|page
op_and_assign
id|PAGE_MASK
suffix:semicolon
id|line
op_assign
(paren
id|page
op_plus
id|PAGE_SIZE
)paren
op_minus
l_int|0x100
suffix:semicolon
r_goto
id|inside
suffix:semicolon
r_do
(brace
id|line
op_sub_assign
l_int|0x100
suffix:semicolon
id|inside
suffix:colon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;sta %%g0, [%0] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %2] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %3] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %4] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %5] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %6] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %7] %1&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0 + %8] %1&bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|line
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_FLUSH_PAGE
)paren
comma
l_string|&quot;r&quot;
(paren
id|a
)paren
comma
l_string|&quot;r&quot;
(paren
id|b
)paren
comma
l_string|&quot;r&quot;
(paren
id|c
)paren
comma
l_string|&quot;r&quot;
(paren
id|d
)paren
comma
l_string|&quot;r&quot;
(paren
id|e
)paren
comma
l_string|&quot;r&quot;
(paren
id|f
)paren
comma
l_string|&quot;r&quot;
(paren
id|g
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|line
op_ne
id|page
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tsk-&gt;mm-&gt;context
op_ne
id|NO_CONTEXT
)paren
(brace
id|flush_cache_mm
c_func
(paren
id|current-&gt;mm
)paren
suffix:semicolon
id|ctxd_set
c_func
(paren
op_amp
id|srmmu_context_table
(braket
id|tsk-&gt;mm-&gt;context
)braket
comma
id|pgdp
)paren
suffix:semicolon
id|flush_tlb_mm
c_func
(paren
id|current-&gt;mm
)paren
suffix:semicolon
)brace
)brace
DECL|function|hypersparc_switch_to_context
r_static
r_void
id|hypersparc_switch_to_context
c_func
(paren
r_struct
id|task_struct
op_star
id|tsk
)paren
(brace
r_if
c_cond
(paren
id|tsk-&gt;mm-&gt;context
op_eq
id|NO_CONTEXT
)paren
(brace
id|ctxd_t
op_star
id|ctxp
suffix:semicolon
id|alloc_context
c_func
(paren
id|tsk-&gt;mm
)paren
suffix:semicolon
id|ctxp
op_assign
op_amp
id|srmmu_context_table
(braket
id|tsk-&gt;mm-&gt;context
)braket
suffix:semicolon
id|srmmu_set_entry
c_func
(paren
(paren
id|pte_t
op_star
)paren
id|ctxp
comma
id|__pte
c_func
(paren
(paren
id|SRMMU_ET_PTD
op_or
(paren
id|srmmu_v2p
c_func
(paren
(paren
r_int
r_int
)paren
id|tsk-&gt;mm-&gt;pgd
)paren
op_rshift
l_int|4
)paren
)paren
)paren
)paren
suffix:semicolon
id|hypersparc_flush_page_to_ram
c_func
(paren
(paren
r_int
r_int
)paren
id|ctxp
)paren
suffix:semicolon
)brace
id|hyper_flush_whole_icache
c_func
(paren
)paren
suffix:semicolon
id|srmmu_set_context
c_func
(paren
id|tsk-&gt;mm-&gt;context
)paren
suffix:semicolon
)brace
DECL|function|hypersparc_init_new_context
r_static
r_void
id|hypersparc_init_new_context
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
id|ctxd_t
op_star
id|ctxp
suffix:semicolon
id|alloc_context
c_func
(paren
id|mm
)paren
suffix:semicolon
id|ctxp
op_assign
op_amp
id|srmmu_context_table
(braket
id|mm-&gt;context
)braket
suffix:semicolon
id|srmmu_set_entry
c_func
(paren
(paren
id|pte_t
op_star
)paren
id|ctxp
comma
id|__pte
c_func
(paren
(paren
id|SRMMU_ET_PTD
op_or
(paren
id|srmmu_v2p
c_func
(paren
(paren
r_int
r_int
)paren
id|mm-&gt;pgd
)paren
op_rshift
l_int|4
)paren
)paren
)paren
)paren
suffix:semicolon
id|hypersparc_flush_page_to_ram
c_func
(paren
(paren
r_int
r_int
)paren
id|ctxp
)paren
suffix:semicolon
id|hyper_flush_whole_icache
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mm
op_eq
id|current-&gt;mm
)paren
(brace
id|srmmu_set_context
c_func
(paren
id|mm-&gt;context
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* IOMMU things go here. */
DECL|macro|LONG_ALIGN
mdefine_line|#define LONG_ALIGN(x) (((x)+(sizeof(long))-1)&amp;~((sizeof(long))-1))
DECL|macro|IOPERM
mdefine_line|#define IOPERM        (IOPTE_CACHE | IOPTE_WRITE | IOPTE_VALID)
DECL|macro|MKIOPTE
mdefine_line|#define MKIOPTE(phys) (((((phys)&gt;&gt;4) &amp; IOPTE_PAGE) | IOPERM) &amp; ~IOPTE_WAZ)
DECL|function|srmmu_map_dvma_pages_for_iommu
r_static
r_inline
r_void
id|srmmu_map_dvma_pages_for_iommu
c_func
(paren
r_struct
id|iommu_struct
op_star
id|iommu
comma
r_int
r_int
id|kern_end
)paren
(brace
r_int
r_int
id|first
op_assign
id|page_offset
suffix:semicolon
r_int
r_int
id|last
op_assign
id|kern_end
suffix:semicolon
id|iopte_t
op_star
id|iopte
op_assign
id|iommu-&gt;page_table
suffix:semicolon
id|iopte
op_add_assign
(paren
(paren
id|first
op_minus
id|iommu-&gt;start
)paren
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
r_while
c_loop
(paren
id|first
op_le
id|last
)paren
(brace
op_star
id|iopte
op_increment
op_assign
id|__iopte
c_func
(paren
id|MKIOPTE
c_func
(paren
id|srmmu_v2p
c_func
(paren
id|first
)paren
)paren
)paren
suffix:semicolon
id|first
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
)brace
DECL|function|iommu_init
r_int
r_int
id|iommu_init
c_func
(paren
r_int
id|iommund
comma
r_int
r_int
id|memory_start
comma
r_int
r_int
id|memory_end
comma
r_struct
id|linux_sbus
op_star
id|sbus
)paren
(brace
r_int
r_int
id|impl
comma
id|vers
comma
id|ptsize
suffix:semicolon
r_int
r_int
id|tmp
suffix:semicolon
r_struct
id|iommu_struct
op_star
id|iommu
suffix:semicolon
r_struct
id|linux_prom_registers
id|iommu_promregs
(braket
id|PROMREG_MAX
)braket
suffix:semicolon
id|memory_start
op_assign
id|LONG_ALIGN
c_func
(paren
id|memory_start
)paren
suffix:semicolon
id|iommu
op_assign
(paren
r_struct
id|iommu_struct
op_star
)paren
id|memory_start
suffix:semicolon
id|memory_start
op_add_assign
r_sizeof
(paren
r_struct
id|iommu_struct
)paren
suffix:semicolon
id|prom_getproperty
c_func
(paren
id|iommund
comma
l_string|&quot;reg&quot;
comma
(paren
r_void
op_star
)paren
id|iommu_promregs
comma
r_sizeof
(paren
id|iommu_promregs
)paren
)paren
suffix:semicolon
id|iommu-&gt;regs
op_assign
(paren
r_struct
id|iommu_regs
op_star
)paren
id|sparc_alloc_io
c_func
(paren
id|iommu_promregs
(braket
l_int|0
)braket
dot
id|phys_addr
comma
l_int|0
comma
(paren
id|PAGE_SIZE
op_star
l_int|3
)paren
comma
l_string|&quot;IOMMU registers&quot;
comma
id|iommu_promregs
(braket
l_int|0
)braket
dot
id|which_io
comma
l_int|0x0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iommu-&gt;regs
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Cannot map IOMMU registers.&quot;
)paren
suffix:semicolon
)brace
id|impl
op_assign
(paren
id|iommu-&gt;regs-&gt;control
op_amp
id|IOMMU_CTRL_IMPL
)paren
op_rshift
l_int|28
suffix:semicolon
id|vers
op_assign
(paren
id|iommu-&gt;regs-&gt;control
op_amp
id|IOMMU_CTRL_VERS
)paren
op_rshift
l_int|24
suffix:semicolon
id|tmp
op_assign
id|iommu-&gt;regs-&gt;control
suffix:semicolon
id|tmp
op_and_assign
op_complement
(paren
id|IOMMU_CTRL_RNGE
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|page_offset
op_amp
l_int|0xf0000000
)paren
(brace
r_case
l_int|0xf0000000
suffix:colon
id|tmp
op_or_assign
(paren
id|IOMMU_RNGE_256MB
op_or
id|IOMMU_CTRL_ENAB
)paren
suffix:semicolon
id|iommu-&gt;plow
op_assign
id|iommu-&gt;start
op_assign
l_int|0xf0000000
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xe0000000
suffix:colon
id|tmp
op_or_assign
(paren
id|IOMMU_RNGE_512MB
op_or
id|IOMMU_CTRL_ENAB
)paren
suffix:semicolon
id|iommu-&gt;plow
op_assign
id|iommu-&gt;start
op_assign
l_int|0xe0000000
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xd0000000
suffix:colon
r_case
l_int|0xc0000000
suffix:colon
id|tmp
op_or_assign
(paren
id|IOMMU_RNGE_1GB
op_or
id|IOMMU_CTRL_ENAB
)paren
suffix:semicolon
id|iommu-&gt;plow
op_assign
id|iommu-&gt;start
op_assign
l_int|0xc0000000
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xb0000000
suffix:colon
r_case
l_int|0xa0000000
suffix:colon
r_case
l_int|0x90000000
suffix:colon
r_case
l_int|0x80000000
suffix:colon
id|tmp
op_or_assign
(paren
id|IOMMU_RNGE_2GB
op_or
id|IOMMU_CTRL_ENAB
)paren
suffix:semicolon
id|iommu-&gt;plow
op_assign
id|iommu-&gt;start
op_assign
l_int|0x80000000
suffix:semicolon
r_break
suffix:semicolon
)brace
id|iommu-&gt;regs-&gt;control
op_assign
id|tmp
suffix:semicolon
id|iommu_invalidate
c_func
(paren
id|iommu-&gt;regs
)paren
suffix:semicolon
id|iommu-&gt;end
op_assign
l_int|0xffffffff
suffix:semicolon
multiline_comment|/* Allocate IOMMU page table */
id|ptsize
op_assign
id|iommu-&gt;end
op_minus
id|iommu-&gt;start
op_plus
l_int|1
suffix:semicolon
id|ptsize
op_assign
(paren
id|ptsize
op_rshift
id|PAGE_SHIFT
)paren
op_star
r_sizeof
(paren
id|iopte_t
)paren
suffix:semicolon
multiline_comment|/* Stupid alignment constraints give me a headache. */
id|memory_start
op_assign
id|PAGE_ALIGN
c_func
(paren
id|memory_start
)paren
suffix:semicolon
id|memory_start
op_assign
(paren
(paren
(paren
id|memory_start
)paren
op_plus
(paren
id|ptsize
op_minus
l_int|1
)paren
)paren
op_amp
op_complement
(paren
id|ptsize
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|iommu-&gt;lowest
op_assign
id|iommu-&gt;page_table
op_assign
(paren
id|iopte_t
op_star
)paren
id|memory_start
suffix:semicolon
id|memory_start
op_add_assign
id|ptsize
suffix:semicolon
multiline_comment|/* Initialize new table. */
id|flush_cache_all
c_func
(paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|iommu-&gt;page_table
comma
l_int|0
comma
id|ptsize
)paren
suffix:semicolon
id|srmmu_map_dvma_pages_for_iommu
c_func
(paren
id|iommu
comma
id|memory_end
)paren
suffix:semicolon
r_if
c_cond
(paren
id|viking_mxcc_present
)paren
(brace
r_int
r_int
id|start
op_assign
(paren
r_int
r_int
)paren
id|iommu-&gt;page_table
suffix:semicolon
r_int
r_int
id|end
op_assign
(paren
id|start
op_plus
id|ptsize
)paren
suffix:semicolon
r_while
c_loop
(paren
id|start
OL
id|end
)paren
(brace
id|viking_mxcc_flush_page
c_func
(paren
id|start
)paren
suffix:semicolon
id|start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|flush_page_for_dma
op_eq
id|viking_flush_page
)paren
(brace
r_int
r_int
id|start
op_assign
(paren
r_int
r_int
)paren
id|iommu-&gt;page_table
suffix:semicolon
r_int
r_int
id|end
op_assign
(paren
id|start
op_plus
id|ptsize
)paren
suffix:semicolon
r_while
c_loop
(paren
id|start
OL
id|end
)paren
(brace
id|viking_flush_page
c_func
(paren
id|start
)paren
suffix:semicolon
id|start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
)brace
id|flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
id|iommu-&gt;regs-&gt;base
op_assign
id|srmmu_v2p
c_func
(paren
(paren
r_int
r_int
)paren
id|iommu-&gt;page_table
)paren
op_rshift
l_int|4
suffix:semicolon
id|iommu_invalidate
c_func
(paren
id|iommu-&gt;regs
)paren
suffix:semicolon
id|sbus-&gt;iommu
op_assign
id|iommu
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;IOMMU: impl %d vers %d page table at %p of size %d bytes&bslash;n&quot;
comma
id|impl
comma
id|vers
comma
id|iommu-&gt;page_table
comma
id|ptsize
)paren
suffix:semicolon
r_return
id|memory_start
suffix:semicolon
)brace
DECL|function|iommu_sun4d_init
r_void
id|iommu_sun4d_init
c_func
(paren
r_int
id|sbi_node
comma
r_struct
id|linux_sbus
op_star
id|sbus
)paren
(brace
id|u32
op_star
id|iommu
suffix:semicolon
r_struct
id|linux_prom_registers
id|iommu_promregs
(braket
id|PROMREG_MAX
)braket
suffix:semicolon
id|prom_getproperty
c_func
(paren
id|sbi_node
comma
l_string|&quot;reg&quot;
comma
(paren
r_void
op_star
)paren
id|iommu_promregs
comma
r_sizeof
(paren
id|iommu_promregs
)paren
)paren
suffix:semicolon
id|iommu
op_assign
(paren
id|u32
op_star
)paren
id|sparc_alloc_io
c_func
(paren
id|iommu_promregs
(braket
l_int|2
)braket
dot
id|phys_addr
comma
l_int|0
comma
(paren
id|PAGE_SIZE
op_star
l_int|16
)paren
comma
l_string|&quot;XPT&quot;
comma
id|iommu_promregs
(braket
l_int|2
)braket
dot
id|which_io
comma
l_int|0x0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iommu
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Cannot map External Page Table.&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialize new table. */
id|flush_cache_all
c_func
(paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|iommu
comma
l_int|0
comma
l_int|16
op_star
id|PAGE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|viking_mxcc_present
)paren
(brace
r_int
r_int
id|start
op_assign
(paren
r_int
r_int
)paren
id|iommu
suffix:semicolon
r_int
r_int
id|end
op_assign
(paren
id|start
op_plus
l_int|16
op_star
id|PAGE_SIZE
)paren
suffix:semicolon
r_while
c_loop
(paren
id|start
OL
id|end
)paren
(brace
id|viking_mxcc_flush_page
c_func
(paren
id|start
)paren
suffix:semicolon
id|start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|flush_page_for_dma
op_eq
id|viking_flush_page
)paren
(brace
r_int
r_int
id|start
op_assign
(paren
r_int
r_int
)paren
id|iommu
suffix:semicolon
r_int
r_int
id|end
op_assign
(paren
id|start
op_plus
l_int|16
op_star
id|PAGE_SIZE
)paren
suffix:semicolon
r_while
c_loop
(paren
id|start
OL
id|end
)paren
(brace
id|viking_flush_page
c_func
(paren
id|start
)paren
suffix:semicolon
id|start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
)brace
id|flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
id|sbus-&gt;iommu
op_assign
(paren
r_struct
id|iommu_struct
op_star
)paren
id|iommu
suffix:semicolon
)brace
DECL|function|srmmu_get_scsi_one
r_static
id|__u32
id|srmmu_get_scsi_one
c_func
(paren
r_char
op_star
id|vaddr
comma
r_int
r_int
id|len
comma
r_struct
id|linux_sbus
op_star
id|sbus
)paren
(brace
r_int
r_int
id|page
op_assign
(paren
(paren
r_int
r_int
)paren
id|vaddr
)paren
op_amp
id|PAGE_MASK
suffix:semicolon
r_while
c_loop
(paren
id|page
OL
(paren
(paren
r_int
r_int
)paren
(paren
id|vaddr
op_plus
id|len
)paren
)paren
)paren
(brace
id|flush_page_for_dma
c_func
(paren
id|page
)paren
suffix:semicolon
id|page
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
r_return
(paren
id|__u32
)paren
id|vaddr
suffix:semicolon
)brace
DECL|function|srmmu_get_scsi_sgl
r_static
r_void
id|srmmu_get_scsi_sgl
c_func
(paren
r_struct
id|mmu_sglist
op_star
id|sg
comma
r_int
id|sz
comma
r_struct
id|linux_sbus
op_star
id|sbus
)paren
(brace
r_int
r_int
id|page
suffix:semicolon
r_while
c_loop
(paren
id|sz
op_ge
l_int|0
)paren
(brace
id|page
op_assign
(paren
(paren
r_int
r_int
)paren
id|sg
(braket
id|sz
)braket
dot
id|addr
)paren
op_amp
id|PAGE_MASK
suffix:semicolon
r_while
c_loop
(paren
id|page
OL
(paren
r_int
r_int
)paren
(paren
id|sg
(braket
id|sz
)braket
dot
id|addr
op_plus
id|sg
(braket
id|sz
)braket
dot
id|len
)paren
)paren
(brace
id|flush_page_for_dma
c_func
(paren
id|page
)paren
suffix:semicolon
id|page
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
id|sg
(braket
id|sz
)braket
dot
id|dvma_addr
op_assign
(paren
id|__u32
)paren
(paren
id|sg
(braket
id|sz
)braket
dot
id|addr
)paren
suffix:semicolon
id|sz
op_decrement
suffix:semicolon
)brace
)brace
DECL|function|srmmu_release_scsi_one
r_static
r_void
id|srmmu_release_scsi_one
c_func
(paren
id|__u32
id|vaddr
comma
r_int
r_int
id|len
comma
r_struct
id|linux_sbus
op_star
id|sbus
)paren
(brace
)brace
DECL|function|srmmu_release_scsi_sgl
r_static
r_void
id|srmmu_release_scsi_sgl
c_func
(paren
r_struct
id|mmu_sglist
op_star
id|sg
comma
r_int
id|sz
comma
r_struct
id|linux_sbus
op_star
id|sbus
)paren
(brace
)brace
DECL|variable|mempool
r_static
r_int
r_int
id|mempool
suffix:semicolon
multiline_comment|/* NOTE: All of this startup code assumes the low 16mb (approx.) of&n; *       kernel mappings are done with one single contiguous chunk of&n; *       ram.  On small ram machines (classics mainly) we only get&n; *       around 8mb mapped for us.&n; */
DECL|variable|kbpage
r_static
r_int
r_int
id|kbpage
suffix:semicolon
multiline_comment|/* Some dirty hacks to abstract away the painful boot up init. */
DECL|function|srmmu_early_paddr
r_static
r_inline
r_int
r_int
id|srmmu_early_paddr
c_func
(paren
r_int
r_int
id|vaddr
)paren
(brace
r_return
(paren
(paren
id|vaddr
op_minus
id|KERNBASE
)paren
op_plus
id|kbpage
)paren
suffix:semicolon
)brace
DECL|function|srmmu_early_pgd_set
r_static
r_inline
r_void
id|srmmu_early_pgd_set
c_func
(paren
id|pgd_t
op_star
id|pgdp
comma
id|pmd_t
op_star
id|pmdp
)paren
(brace
id|set_pte
c_func
(paren
(paren
id|pte_t
op_star
)paren
id|pgdp
comma
id|__pte
c_func
(paren
(paren
id|SRMMU_ET_PTD
op_or
(paren
id|srmmu_early_paddr
c_func
(paren
(paren
r_int
r_int
)paren
id|pmdp
)paren
op_rshift
l_int|4
)paren
)paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_early_pmd_set
r_static
r_inline
r_void
id|srmmu_early_pmd_set
c_func
(paren
id|pmd_t
op_star
id|pmdp
comma
id|pte_t
op_star
id|ptep
)paren
(brace
id|set_pte
c_func
(paren
(paren
id|pte_t
op_star
)paren
id|pmdp
comma
id|__pte
c_func
(paren
(paren
id|SRMMU_ET_PTD
op_or
(paren
id|srmmu_early_paddr
c_func
(paren
(paren
r_int
r_int
)paren
id|ptep
)paren
op_rshift
l_int|4
)paren
)paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_early_pgd_page
r_static
r_inline
r_int
r_int
id|srmmu_early_pgd_page
c_func
(paren
id|pgd_t
id|pgd
)paren
(brace
r_return
(paren
(paren
(paren
id|pgd_val
c_func
(paren
id|pgd
)paren
op_amp
id|SRMMU_PTD_PMASK
)paren
op_lshift
l_int|4
)paren
op_minus
id|kbpage
)paren
op_plus
id|KERNBASE
suffix:semicolon
)brace
DECL|function|srmmu_early_pmd_page
r_static
r_inline
r_int
r_int
id|srmmu_early_pmd_page
c_func
(paren
id|pmd_t
id|pmd
)paren
(brace
r_return
(paren
(paren
(paren
id|pmd_val
c_func
(paren
id|pmd
)paren
op_amp
id|SRMMU_PTD_PMASK
)paren
op_lshift
l_int|4
)paren
op_minus
id|kbpage
)paren
op_plus
id|KERNBASE
suffix:semicolon
)brace
DECL|function|srmmu_early_pmd_offset
r_static
r_inline
id|pmd_t
op_star
id|srmmu_early_pmd_offset
c_func
(paren
id|pgd_t
op_star
id|dir
comma
r_int
r_int
id|address
)paren
(brace
r_return
(paren
id|pmd_t
op_star
)paren
id|srmmu_early_pgd_page
c_func
(paren
op_star
id|dir
)paren
op_plus
(paren
(paren
id|address
op_rshift
id|SRMMU_PMD_SHIFT
)paren
op_amp
(paren
id|SRMMU_PTRS_PER_PMD
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_early_pte_offset
r_static
r_inline
id|pte_t
op_star
id|srmmu_early_pte_offset
c_func
(paren
id|pmd_t
op_star
id|dir
comma
r_int
r_int
id|address
)paren
(brace
r_return
(paren
id|pte_t
op_star
)paren
id|srmmu_early_pmd_page
c_func
(paren
op_star
id|dir
)paren
op_plus
(paren
(paren
id|address
op_rshift
id|PAGE_SHIFT
)paren
op_amp
(paren
id|SRMMU_PTRS_PER_PTE
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
DECL|function|srmmu_allocate_ptable_skeleton
r_static
r_inline
r_void
id|srmmu_allocate_ptable_skeleton
c_func
(paren
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
id|pgd_t
op_star
id|pgdp
suffix:semicolon
id|pmd_t
op_star
id|pmdp
suffix:semicolon
id|pte_t
op_star
id|ptep
suffix:semicolon
r_while
c_loop
(paren
id|start
OL
id|end
)paren
(brace
id|pgdp
op_assign
id|srmmu_pgd_offset
c_func
(paren
id|init_task.mm
comma
id|start
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_pgd_none
c_func
(paren
op_star
id|pgdp
)paren
)paren
(brace
id|pmdp
op_assign
id|sparc_init_alloc
c_func
(paren
op_amp
id|mempool
comma
id|SRMMU_PMD_TABLE_SIZE
)paren
suffix:semicolon
id|srmmu_early_pgd_set
c_func
(paren
id|pgdp
comma
id|pmdp
)paren
suffix:semicolon
)brace
id|pmdp
op_assign
id|srmmu_early_pmd_offset
c_func
(paren
id|pgdp
comma
id|start
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srmmu_pmd_none
c_func
(paren
op_star
id|pmdp
)paren
)paren
(brace
id|ptep
op_assign
id|sparc_init_alloc
c_func
(paren
op_amp
id|mempool
comma
id|SRMMU_PTE_TABLE_SIZE
)paren
suffix:semicolon
id|srmmu_early_pmd_set
c_func
(paren
id|pmdp
comma
id|ptep
)paren
suffix:semicolon
)brace
id|start
op_assign
(paren
id|start
op_plus
id|SRMMU_PMD_SIZE
)paren
op_amp
id|SRMMU_PMD_MASK
suffix:semicolon
)brace
)brace
multiline_comment|/* This is much cleaner than poking around physical address space&n; * looking at the prom&squot;s page table directly which is what most&n; * other OS&squot;s do.  Yuck... this is much better.&n; */
DECL|function|srmmu_inherit_prom_mappings
r_void
id|srmmu_inherit_prom_mappings
c_func
(paren
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
id|pgd_t
op_star
id|pgdp
suffix:semicolon
id|pmd_t
op_star
id|pmdp
suffix:semicolon
id|pte_t
op_star
id|ptep
suffix:semicolon
r_int
id|what
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 0 = normal-pte, 1 = pmd-level pte, 2 = pgd-level pte */
r_int
r_int
id|prompte
suffix:semicolon
r_while
c_loop
(paren
id|start
op_le
id|end
)paren
(brace
r_if
c_cond
(paren
id|start
op_eq
l_int|0
)paren
r_break
suffix:semicolon
multiline_comment|/* probably wrap around */
r_if
c_cond
(paren
id|start
op_eq
l_int|0xfef00000
)paren
(brace
id|start
op_assign
id|KADB_DEBUGGER_BEGVM
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|prompte
op_assign
id|srmmu_hwprobe
c_func
(paren
id|start
)paren
)paren
)paren
(brace
id|start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* A red snapper, see what it really is. */
id|what
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|start
op_amp
op_complement
(paren
id|SRMMU_PMD_MASK
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|srmmu_hwprobe
c_func
(paren
(paren
id|start
op_minus
id|PAGE_SIZE
)paren
op_plus
id|SRMMU_PMD_SIZE
)paren
op_eq
id|prompte
)paren
(brace
id|what
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|start
op_amp
op_complement
(paren
id|SRMMU_PGDIR_MASK
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|srmmu_hwprobe
c_func
(paren
(paren
id|start
op_minus
id|PAGE_SIZE
)paren
op_plus
id|SRMMU_PGDIR_SIZE
)paren
op_eq
id|prompte
)paren
(brace
id|what
op_assign
l_int|2
suffix:semicolon
)brace
)brace
id|pgdp
op_assign
id|srmmu_pgd_offset
c_func
(paren
id|init_task.mm
comma
id|start
)paren
suffix:semicolon
r_if
c_cond
(paren
id|what
op_eq
l_int|2
)paren
(brace
op_star
id|pgdp
op_assign
id|__pgd
c_func
(paren
id|prompte
)paren
suffix:semicolon
id|start
op_add_assign
id|SRMMU_PGDIR_SIZE
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|srmmu_pgd_none
c_func
(paren
op_star
id|pgdp
)paren
)paren
(brace
id|pmdp
op_assign
id|sparc_init_alloc
c_func
(paren
op_amp
id|mempool
comma
id|SRMMU_PMD_TABLE_SIZE
)paren
suffix:semicolon
id|srmmu_early_pgd_set
c_func
(paren
id|pgdp
comma
id|pmdp
)paren
suffix:semicolon
)brace
id|pmdp
op_assign
id|srmmu_early_pmd_offset
c_func
(paren
id|pgdp
comma
id|start
)paren
suffix:semicolon
r_if
c_cond
(paren
id|what
op_eq
l_int|1
)paren
(brace
op_star
id|pmdp
op_assign
id|__pmd
c_func
(paren
id|prompte
)paren
suffix:semicolon
id|start
op_add_assign
id|SRMMU_PMD_SIZE
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|srmmu_pmd_none
c_func
(paren
op_star
id|pmdp
)paren
)paren
(brace
id|ptep
op_assign
id|sparc_init_alloc
c_func
(paren
op_amp
id|mempool
comma
id|SRMMU_PTE_TABLE_SIZE
)paren
suffix:semicolon
id|srmmu_early_pmd_set
c_func
(paren
id|pmdp
comma
id|ptep
)paren
suffix:semicolon
)brace
id|ptep
op_assign
id|srmmu_early_pte_offset
c_func
(paren
id|pmdp
comma
id|start
)paren
suffix:semicolon
op_star
id|ptep
op_assign
id|__pte
c_func
(paren
id|prompte
)paren
suffix:semicolon
id|start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
)brace
macro_line|#ifdef CONFIG_SBUS
DECL|function|srmmu_map_dma_area
r_static
r_void
id|srmmu_map_dma_area
c_func
(paren
r_int
r_int
id|addr
comma
r_int
id|len
)paren
(brace
r_int
r_int
id|page
comma
id|end
suffix:semicolon
id|pgprot_t
id|dvma_prot
suffix:semicolon
r_struct
id|iommu_struct
op_star
id|iommu
op_assign
id|SBus_chain-&gt;iommu
suffix:semicolon
id|iopte_t
op_star
id|iopte
op_assign
id|iommu-&gt;page_table
suffix:semicolon
id|iopte_t
op_star
id|iopte_first
op_assign
id|iopte
suffix:semicolon
r_if
c_cond
(paren
id|viking_mxcc_present
)paren
(brace
id|dvma_prot
op_assign
id|__pgprot
c_func
(paren
id|SRMMU_CACHE
op_or
id|SRMMU_ET_PTE
op_or
id|SRMMU_PRIV
)paren
suffix:semicolon
)brace
r_else
id|dvma_prot
op_assign
id|__pgprot
c_func
(paren
id|SRMMU_ET_PTE
op_or
id|SRMMU_PRIV
)paren
suffix:semicolon
id|iopte
op_add_assign
(paren
(paren
id|addr
op_minus
id|iommu-&gt;start
)paren
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|end
op_assign
id|PAGE_ALIGN
c_func
(paren
(paren
id|addr
op_plus
id|len
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|addr
OL
id|end
)paren
(brace
id|page
op_assign
id|get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|page
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;alloc_dvma: Cannot get a dvma page&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|pgd_t
op_star
id|pgdp
suffix:semicolon
id|pmd_t
op_star
id|pmdp
suffix:semicolon
id|pte_t
op_star
id|ptep
suffix:semicolon
id|pgdp
op_assign
id|srmmu_pgd_offset
c_func
(paren
id|init_task.mm
comma
id|addr
)paren
suffix:semicolon
id|pmdp
op_assign
id|srmmu_pmd_offset
c_func
(paren
id|pgdp
comma
id|addr
)paren
suffix:semicolon
id|ptep
op_assign
id|srmmu_pte_offset
c_func
(paren
id|pmdp
comma
id|addr
)paren
suffix:semicolon
id|set_pte
c_func
(paren
id|ptep
comma
id|pte_val
c_func
(paren
id|srmmu_mk_pte
c_func
(paren
id|page
comma
id|dvma_prot
)paren
)paren
)paren
suffix:semicolon
id|iopte_val
c_func
(paren
op_star
id|iopte
op_increment
)paren
op_assign
id|MKIOPTE
c_func
(paren
id|srmmu_v2p
c_func
(paren
id|page
)paren
)paren
suffix:semicolon
)brace
id|addr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
id|flush_cache_all
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|viking_mxcc_present
)paren
(brace
r_int
r_int
id|start
op_assign
(paren
(paren
r_int
r_int
)paren
id|iopte_first
)paren
op_amp
id|PAGE_MASK
suffix:semicolon
r_int
r_int
id|end
op_assign
id|PAGE_ALIGN
c_func
(paren
(paren
(paren
r_int
r_int
)paren
id|iopte
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|start
OL
id|end
)paren
(brace
id|viking_mxcc_flush_page
c_func
(paren
id|start
)paren
suffix:semicolon
id|start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|flush_page_for_dma
op_eq
id|viking_flush_page
)paren
(brace
r_int
r_int
id|start
op_assign
(paren
(paren
r_int
r_int
)paren
id|iopte_first
)paren
op_amp
id|PAGE_MASK
suffix:semicolon
r_int
r_int
id|end
op_assign
id|PAGE_ALIGN
c_func
(paren
(paren
(paren
r_int
r_int
)paren
id|iopte
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|start
OL
id|end
)paren
(brace
id|viking_flush_page
c_func
(paren
id|start
)paren
suffix:semicolon
id|start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
)brace
id|flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
id|iommu_invalidate
c_func
(paren
id|iommu-&gt;regs
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* #define DEBUG_MAP_KERNEL */
macro_line|#ifdef DEBUG_MAP_KERNEL
DECL|macro|MKTRACE
mdefine_line|#define MKTRACE(foo) prom_printf foo
macro_line|#else
DECL|macro|MKTRACE
mdefine_line|#define MKTRACE(foo)
macro_line|#endif
DECL|variable|lots_of_ram
r_static
r_int
id|lots_of_ram
op_assign
l_int|0
suffix:semicolon
DECL|variable|large_pte_optimize
r_static
r_int
id|large_pte_optimize
op_assign
l_int|1
suffix:semicolon
DECL|macro|KERNEL_PTE
mdefine_line|#define KERNEL_PTE(page_shifted) ((page_shifted)|SRMMU_CACHE|SRMMU_PRIV|SRMMU_VALID)
multiline_comment|/* Create a third-level SRMMU 16MB page mapping. */
DECL|function|do_large_mapping
r_static
r_inline
r_void
id|do_large_mapping
c_func
(paren
r_int
r_int
id|vaddr
comma
r_int
r_int
id|phys_base
)paren
(brace
id|pgd_t
op_star
id|pgdp
op_assign
id|srmmu_pgd_offset
c_func
(paren
id|init_task.mm
comma
id|vaddr
)paren
suffix:semicolon
r_int
r_int
id|big_pte
suffix:semicolon
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;dlm[v&lt;%08lx&gt;--&gt;p&lt;%08lx&gt;]&quot;
comma
id|vaddr
comma
id|phys_base
)paren
)paren
suffix:semicolon
id|big_pte
op_assign
id|KERNEL_PTE
c_func
(paren
id|phys_base
op_rshift
l_int|4
)paren
suffix:semicolon
op_star
id|pgdp
op_assign
id|__pgd
c_func
(paren
id|big_pte
)paren
suffix:semicolon
)brace
multiline_comment|/* Create second-level SRMMU 256K medium sized page mappings. */
DECL|function|do_medium_mapping
r_static
r_inline
r_void
id|do_medium_mapping
c_func
(paren
r_int
r_int
id|vaddr
comma
r_int
r_int
id|vend
comma
r_int
r_int
id|phys_base
)paren
(brace
id|pgd_t
op_star
id|pgdp
suffix:semicolon
id|pmd_t
op_star
id|pmdp
suffix:semicolon
r_int
r_int
id|medium_pte
suffix:semicolon
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;dmm[v&lt;%08lx,%08lx&gt;--&gt;p&lt;%08lx&gt;]&quot;
comma
id|vaddr
comma
id|vend
comma
id|phys_base
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|vaddr
OL
id|vend
)paren
(brace
id|pgdp
op_assign
id|srmmu_pgd_offset
c_func
(paren
id|init_task.mm
comma
id|vaddr
)paren
suffix:semicolon
id|pmdp
op_assign
id|srmmu_early_pmd_offset
c_func
(paren
id|pgdp
comma
id|vaddr
)paren
suffix:semicolon
id|medium_pte
op_assign
id|KERNEL_PTE
c_func
(paren
id|phys_base
op_rshift
l_int|4
)paren
suffix:semicolon
op_star
id|pmdp
op_assign
id|__pmd
c_func
(paren
id|medium_pte
)paren
suffix:semicolon
id|phys_base
op_add_assign
id|SRMMU_PMD_SIZE
suffix:semicolon
id|vaddr
op_add_assign
id|SRMMU_PMD_SIZE
suffix:semicolon
)brace
)brace
multiline_comment|/* Create a normal set of SRMMU page mappings for the virtual range&n; * START to END, using physical pages beginning at PHYS_BASE.&n; */
DECL|function|do_small_mapping
r_static
r_inline
r_void
id|do_small_mapping
c_func
(paren
r_int
r_int
id|start
comma
r_int
r_int
id|end
comma
r_int
r_int
id|phys_base
)paren
(brace
id|pgd_t
op_star
id|pgdp
suffix:semicolon
id|pmd_t
op_star
id|pmdp
suffix:semicolon
id|pte_t
op_star
id|ptep
suffix:semicolon
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;dsm[v&lt;%08lx,%08lx&gt;--&gt;p&lt;%08lx&gt;]&quot;
comma
id|start
comma
id|end
comma
id|phys_base
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|start
OL
id|end
)paren
(brace
id|pgdp
op_assign
id|srmmu_pgd_offset
c_func
(paren
id|init_task.mm
comma
id|start
)paren
suffix:semicolon
id|pmdp
op_assign
id|srmmu_early_pmd_offset
c_func
(paren
id|pgdp
comma
id|start
)paren
suffix:semicolon
id|ptep
op_assign
id|srmmu_early_pte_offset
c_func
(paren
id|pmdp
comma
id|start
)paren
suffix:semicolon
op_star
id|ptep
op_assign
id|__pte
c_func
(paren
id|KERNEL_PTE
c_func
(paren
id|phys_base
op_rshift
l_int|4
)paren
)paren
suffix:semicolon
id|phys_base
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
)brace
multiline_comment|/* Look in the sp_bank for the given physical page, return the&n; * index number the entry was found in, or -1 for not found.&n; */
DECL|function|find_in_spbanks
r_static
r_inline
r_int
id|find_in_spbanks
c_func
(paren
r_int
r_int
id|phys_page
)paren
(brace
r_int
id|entry
suffix:semicolon
r_for
c_loop
(paren
id|entry
op_assign
l_int|0
suffix:semicolon
id|sp_banks
(braket
id|entry
)braket
dot
id|num_bytes
suffix:semicolon
id|entry
op_increment
)paren
(brace
r_int
r_int
id|start
op_assign
id|sp_banks
(braket
id|entry
)braket
dot
id|base_addr
suffix:semicolon
r_int
r_int
id|end
op_assign
id|start
op_plus
id|sp_banks
(braket
id|entry
)braket
dot
id|num_bytes
suffix:semicolon
r_if
c_cond
(paren
(paren
id|start
op_le
id|phys_page
)paren
op_logical_and
(paren
id|phys_page
OL
id|end
)paren
)paren
(brace
r_return
id|entry
suffix:semicolon
)brace
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Find an spbank entry not mapped as of yet, TAKEN_VECTOR is an&n; * array of char&squot;s, each member indicating if that spbank is mapped&n; * yet or not.&n; */
DECL|function|find_free_spbank
r_static
r_inline
r_int
id|find_free_spbank
c_func
(paren
r_char
op_star
id|taken_vector
)paren
(brace
r_int
id|entry
suffix:semicolon
r_for
c_loop
(paren
id|entry
op_assign
l_int|0
suffix:semicolon
id|sp_banks
(braket
id|entry
)braket
dot
id|num_bytes
suffix:semicolon
id|entry
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|taken_vector
(braket
id|entry
)braket
)paren
(brace
r_break
suffix:semicolon
)brace
r_return
id|entry
suffix:semicolon
)brace
multiline_comment|/* Same as above, but with a given bank size limit BLIMIT. */
DECL|function|find_free_spbank_limited
r_static
r_inline
r_int
id|find_free_spbank_limited
c_func
(paren
r_char
op_star
id|taken_vector
comma
r_int
r_int
id|limit
)paren
(brace
r_int
id|entry
suffix:semicolon
r_for
c_loop
(paren
id|entry
op_assign
l_int|0
suffix:semicolon
id|sp_banks
(braket
id|entry
)braket
dot
id|num_bytes
suffix:semicolon
id|entry
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|taken_vector
(braket
id|entry
)braket
op_logical_and
(paren
id|sp_banks
(braket
id|entry
)braket
dot
id|num_bytes
OL
id|limit
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
r_return
id|entry
suffix:semicolon
)brace
multiline_comment|/* Map sp_bank entry SP_ENTRY, starting at virtual address VBASE.&n; * This routine is expected to update the srmmu_map and try as&n; * hard as possible to use 16MB level-one SRMMU pte&squot;s when at all&n; * possible to get short termination and faster translations.&n; */
DECL|function|map_spbank
r_static
r_inline
r_int
r_int
id|map_spbank
c_func
(paren
r_int
r_int
id|vbase
comma
r_int
id|sp_entry
)paren
(brace
r_int
r_int
id|pstart
op_assign
id|sp_banks
(braket
id|sp_entry
)braket
dot
id|base_addr
suffix:semicolon
r_int
r_int
id|vstart
op_assign
id|vbase
suffix:semicolon
r_int
r_int
id|vend
op_assign
id|vbase
op_plus
id|sp_banks
(braket
id|sp_entry
)braket
dot
id|num_bytes
suffix:semicolon
r_static
r_int
id|srmmu_bank
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* If physically not aligned on 16MB boundry, just shortcut&n;&t; * right here by mapping them with 4k normal pages, and bumping&n;&t; * the next virtual address to the next 16MB boundry.  You can&n;&t; * get this with various RAM configurations due to the way in&n;&t; * which the PROM carves out it&squot;s own chunks of memory.&n;&t; */
r_if
c_cond
(paren
id|pstart
op_amp
op_complement
id|SRMMU_PGDIR_MASK
)paren
(brace
id|do_small_mapping
c_func
(paren
id|vstart
comma
id|vend
comma
id|pstart
)paren
suffix:semicolon
id|vstart
op_assign
id|SRMMU_PGDIR_ALIGN
c_func
(paren
id|vend
)paren
suffix:semicolon
r_goto
id|finish_up
suffix:semicolon
)brace
r_while
c_loop
(paren
id|vstart
OL
id|vend
)paren
(brace
r_int
r_int
id|coverage
comma
id|next_aligned
suffix:semicolon
r_if
c_cond
(paren
id|vstart
op_amp
op_complement
id|SRMMU_PMD_MASK
)paren
(brace
id|next_aligned
op_assign
id|SRMMU_PMD_ALIGN
c_func
(paren
id|vstart
)paren
suffix:semicolon
r_if
c_cond
(paren
id|next_aligned
op_le
id|vend
)paren
(brace
id|coverage
op_assign
(paren
id|next_aligned
op_minus
id|vstart
)paren
suffix:semicolon
id|do_small_mapping
c_func
(paren
id|vstart
comma
id|next_aligned
comma
id|pstart
)paren
suffix:semicolon
)brace
r_else
(brace
id|coverage
op_assign
(paren
id|vend
op_minus
id|vstart
)paren
suffix:semicolon
id|do_small_mapping
c_func
(paren
id|vstart
comma
id|vend
comma
id|pstart
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|vstart
op_amp
op_complement
id|SRMMU_PGDIR_MASK
)paren
(brace
id|next_aligned
op_assign
id|SRMMU_PGDIR_ALIGN
c_func
(paren
id|vstart
)paren
suffix:semicolon
r_if
c_cond
(paren
id|next_aligned
op_le
id|vend
)paren
(brace
id|coverage
op_assign
(paren
id|next_aligned
op_minus
id|vstart
)paren
suffix:semicolon
id|do_medium_mapping
c_func
(paren
id|vstart
comma
id|next_aligned
comma
id|pstart
)paren
suffix:semicolon
)brace
r_else
(brace
id|coverage
op_assign
(paren
id|vend
op_minus
id|vstart
)paren
suffix:semicolon
id|do_small_mapping
c_func
(paren
id|vstart
comma
id|vend
comma
id|pstart
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|coverage
op_assign
id|SRMMU_PGDIR_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|large_pte_optimize
op_logical_or
(paren
(paren
id|vstart
op_plus
id|coverage
)paren
op_le
id|vend
)paren
)paren
(brace
id|do_large_mapping
c_func
(paren
id|vstart
comma
id|pstart
)paren
suffix:semicolon
)brace
r_else
(brace
id|coverage
op_assign
(paren
id|vend
op_minus
id|vstart
)paren
suffix:semicolon
id|do_small_mapping
c_func
(paren
id|vstart
comma
id|vend
comma
id|pstart
)paren
suffix:semicolon
)brace
)brace
id|vstart
op_add_assign
id|coverage
suffix:semicolon
id|pstart
op_add_assign
id|coverage
suffix:semicolon
)brace
id|finish_up
suffix:colon
id|srmmu_map
(braket
id|srmmu_bank
)braket
dot
id|vbase
op_assign
id|vbase
suffix:semicolon
id|srmmu_map
(braket
id|srmmu_bank
)braket
dot
id|pbase
op_assign
id|sp_banks
(braket
id|sp_entry
)braket
dot
id|base_addr
suffix:semicolon
id|srmmu_map
(braket
id|srmmu_bank
)braket
dot
id|size
op_assign
id|sp_banks
(braket
id|sp_entry
)braket
dot
id|num_bytes
suffix:semicolon
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;SRMMUBANK[v&lt;%08lx&gt;p&lt;%08lx&gt;s&lt;%08lx&gt;]&quot;
comma
id|vbase
comma
id|sp_banks
(braket
id|sp_entry
)braket
dot
id|base_addr
comma
id|sp_banks
(braket
id|sp_entry
)braket
dot
id|num_bytes
)paren
)paren
suffix:semicolon
id|srmmu_bank
op_increment
suffix:semicolon
r_return
id|vstart
suffix:semicolon
)brace
DECL|function|memprobe_error
r_static
r_inline
r_void
id|memprobe_error
c_func
(paren
r_char
op_star
id|msg
)paren
(brace
id|prom_printf
c_func
(paren
id|msg
)paren
suffix:semicolon
id|prom_printf
c_func
(paren
l_string|&quot;Halting now...&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Assumptions: The bank given to the kernel from the prom/bootloader&n; * is part of a full bank which is at least 4MB in size and begins at&n; * 0xf0000000 (ie. KERNBASE).&n; */
DECL|function|map_kernel
r_static
r_void
id|map_kernel
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|raw_pte
comma
id|physpage
suffix:semicolon
r_int
r_int
id|vaddr
comma
id|tally
comma
id|low_base
suffix:semicolon
r_char
id|etaken
(braket
id|SPARC_PHYS_BANKS
)braket
suffix:semicolon
r_int
id|entry
suffix:semicolon
multiline_comment|/* Step 1: Clear out sp_banks taken map. */
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;map_kernel: clearing etaken vector... &quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|entry
op_assign
l_int|0
suffix:semicolon
id|entry
OL
id|SPARC_PHYS_BANKS
suffix:semicolon
id|entry
op_increment
)paren
(brace
id|etaken
(braket
id|entry
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|low_base
op_assign
id|KERNBASE
suffix:semicolon
multiline_comment|/* Step 2: Calculate &squot;lots_of_ram&squot;. */
id|tally
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|entry
op_assign
l_int|0
suffix:semicolon
id|sp_banks
(braket
id|entry
)braket
dot
id|num_bytes
suffix:semicolon
id|entry
op_increment
)paren
(brace
id|tally
op_add_assign
id|sp_banks
(braket
id|entry
)braket
dot
id|num_bytes
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tally
OG
(paren
l_int|0xfd000000
op_minus
id|KERNBASE
)paren
)paren
(brace
id|lots_of_ram
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|lots_of_ram
op_assign
l_int|0
suffix:semicolon
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;tally=%08lx lots_of_ram&lt;%d&gt;&bslash;n&quot;
comma
id|tally
comma
id|lots_of_ram
)paren
)paren
suffix:semicolon
multiline_comment|/* Step 3: Fill in KERNBASE base pgd.  Lots of sanity checking here. */
id|raw_pte
op_assign
id|srmmu_hwprobe
c_func
(paren
id|KERNBASE
op_plus
id|PAGE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|raw_pte
op_amp
id|SRMMU_ET_MASK
)paren
op_ne
id|SRMMU_ET_PTE
)paren
(brace
id|memprobe_error
c_func
(paren
l_string|&quot;Wheee, kernel not mapped at all by boot loader.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|physpage
op_assign
(paren
id|raw_pte
op_amp
id|SRMMU_PTE_PMASK
)paren
op_lshift
l_int|4
suffix:semicolon
id|physpage
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|physpage
op_amp
op_complement
(paren
id|SRMMU_PGDIR_MASK
)paren
)paren
(brace
id|memprobe_error
c_func
(paren
l_string|&quot;Wheee, kernel not mapped on 16MB physical boundry.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|entry
op_assign
id|find_in_spbanks
c_func
(paren
id|physpage
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry
op_eq
op_minus
l_int|1
op_logical_or
(paren
id|sp_banks
(braket
id|entry
)braket
dot
id|base_addr
op_ne
id|physpage
)paren
)paren
(brace
id|memprobe_error
c_func
(paren
l_string|&quot;Kernel mapped in non-existant memory.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;map_kernel: map_spbank(vbase=%08x, entry&lt;%d&gt;)[%08lx,%08lx]&bslash;n&quot;
comma
id|KERNBASE
comma
id|entry
comma
id|sp_banks
(braket
id|entry
)braket
dot
id|base_addr
comma
id|sp_banks
(braket
id|entry
)braket
dot
id|num_bytes
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|KERNBASE
op_plus
(paren
id|sp_banks
(braket
id|entry
)braket
dot
id|num_bytes
)paren
)paren
OG
l_int|0xfd000000
)paren
op_logical_or
(paren
(paren
id|KERNBASE
op_plus
(paren
id|sp_banks
(braket
id|entry
)braket
dot
id|num_bytes
)paren
)paren
OL
id|KERNBASE
)paren
)paren
(brace
r_int
r_int
id|orig_base
op_assign
id|sp_banks
(braket
id|entry
)braket
dot
id|base_addr
suffix:semicolon
r_int
r_int
id|orig_len
op_assign
id|sp_banks
(braket
id|entry
)braket
dot
id|num_bytes
suffix:semicolon
r_int
r_int
id|can_map
op_assign
(paren
l_int|0xfd000000
op_minus
id|KERNBASE
)paren
suffix:semicolon
multiline_comment|/* Map a partial bank in this case, adjust the base&n;&t;&t; * and the length, but don&squot;t mark it used.&n;&t;&t; */
id|sp_banks
(braket
id|entry
)braket
dot
id|num_bytes
op_assign
id|can_map
suffix:semicolon
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;wheee really big mapping [%08lx,%08lx]&quot;
comma
id|orig_base
comma
id|can_map
)paren
)paren
suffix:semicolon
id|vaddr
op_assign
id|map_spbank
c_func
(paren
id|KERNBASE
comma
id|entry
)paren
suffix:semicolon
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;vaddr now %08lx &quot;
comma
id|vaddr
)paren
)paren
suffix:semicolon
id|sp_banks
(braket
id|entry
)braket
dot
id|base_addr
op_assign
id|orig_base
op_plus
id|can_map
suffix:semicolon
id|sp_banks
(braket
id|entry
)braket
dot
id|num_bytes
op_assign
id|orig_len
op_minus
id|can_map
suffix:semicolon
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;adjust[%08lx,%08lx]&bslash;n&quot;
comma
(paren
id|orig_base
op_plus
id|can_map
)paren
comma
(paren
id|orig_len
op_minus
id|can_map
)paren
)paren
)paren
suffix:semicolon
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;map_kernel: skipping first loop&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_goto
id|loop_skip
suffix:semicolon
)brace
id|vaddr
op_assign
id|map_spbank
c_func
(paren
id|KERNBASE
comma
id|entry
)paren
suffix:semicolon
id|etaken
(braket
id|entry
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Step 4: Map what we can above KERNBASE. */
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;map_kernel: vaddr=%08lx, entering first loop&bslash;n&quot;
comma
id|vaddr
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_int
r_int
id|bank_size
suffix:semicolon
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;map_kernel: ffsp()&quot;
)paren
)paren
suffix:semicolon
id|entry
op_assign
id|find_free_spbank
c_func
(paren
op_amp
id|etaken
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|bank_size
op_assign
id|sp_banks
(braket
id|entry
)braket
dot
id|num_bytes
suffix:semicolon
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;&lt;%d&gt; base=%08lx bs=%08lx &quot;
comma
id|entry
comma
id|sp_banks
(braket
id|entry
)braket
dot
id|base_addr
comma
id|bank_size
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bank_size
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|vaddr
op_plus
id|bank_size
)paren
OG
l_int|0xfd000000
)paren
op_logical_or
(paren
(paren
id|vaddr
op_plus
id|bank_size
)paren
OL
id|KERNBASE
)paren
)paren
(brace
r_int
r_int
id|orig_base
op_assign
id|sp_banks
(braket
id|entry
)braket
dot
id|base_addr
suffix:semicolon
r_int
r_int
id|orig_len
op_assign
id|sp_banks
(braket
id|entry
)braket
dot
id|num_bytes
suffix:semicolon
r_int
r_int
id|can_map
op_assign
(paren
l_int|0xfd000000
op_minus
id|vaddr
)paren
suffix:semicolon
multiline_comment|/* Map a partial bank in this case, adjust the base&n;&t;&t;&t; * and the length, but don&squot;t mark it used.&n;&t;&t;&t; */
id|sp_banks
(braket
id|entry
)braket
dot
id|num_bytes
op_assign
id|can_map
suffix:semicolon
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;wheee really big mapping [%08lx,%08lx]&quot;
comma
id|orig_base
comma
id|can_map
)paren
)paren
suffix:semicolon
id|vaddr
op_assign
id|map_spbank
c_func
(paren
id|vaddr
comma
id|entry
)paren
suffix:semicolon
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;vaddr now %08lx &quot;
comma
id|vaddr
)paren
)paren
suffix:semicolon
id|sp_banks
(braket
id|entry
)braket
dot
id|base_addr
op_assign
id|orig_base
op_plus
id|can_map
suffix:semicolon
id|sp_banks
(braket
id|entry
)braket
dot
id|num_bytes
op_assign
id|orig_len
op_minus
id|can_map
suffix:semicolon
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;adjust[%08lx,%08lx]&bslash;n&quot;
comma
(paren
id|orig_base
op_plus
id|can_map
)paren
comma
(paren
id|orig_len
op_minus
id|can_map
)paren
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|bank_size
)paren
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/* Ok, we can map this one, do it. */
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;map_spbank(%08lx,entry&lt;%d&gt;) &quot;
comma
id|vaddr
comma
id|entry
)paren
)paren
suffix:semicolon
id|vaddr
op_assign
id|map_spbank
c_func
(paren
id|vaddr
comma
id|entry
)paren
suffix:semicolon
id|etaken
(braket
id|entry
)braket
op_assign
l_int|1
suffix:semicolon
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;vaddr now %08lx&bslash;n&quot;
comma
id|vaddr
)paren
)paren
suffix:semicolon
)brace
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* If not lots_of_ram, assume we did indeed map it all above. */
id|loop_skip
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|lots_of_ram
)paren
(brace
r_goto
id|check_and_return
suffix:semicolon
)brace
multiline_comment|/* Step 5: Map the rest (if any) right below KERNBASE. */
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;map_kernel: doing low mappings... &quot;
)paren
)paren
suffix:semicolon
id|tally
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|entry
op_assign
l_int|0
suffix:semicolon
id|sp_banks
(braket
id|entry
)braket
dot
id|num_bytes
suffix:semicolon
id|entry
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|etaken
(braket
id|entry
)braket
)paren
(brace
id|tally
op_add_assign
id|SRMMU_PGDIR_ALIGN
c_func
(paren
id|sp_banks
(braket
id|entry
)braket
dot
id|num_bytes
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|tally
)paren
(brace
id|memprobe_error
c_func
(paren
l_string|&quot;Whee, lots_of_ram yet no low pages to map.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|low_base
op_assign
(paren
id|KERNBASE
op_minus
id|tally
)paren
suffix:semicolon
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;tally=%08lx low_base=%08lx&bslash;n&quot;
comma
id|tally
comma
id|low_base
)paren
)paren
suffix:semicolon
multiline_comment|/* Ok, now map &squot;em. */
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;map_kernel: Allocate pt skeleton (%08lx, %08x)&bslash;n&quot;
comma
id|low_base
comma
id|KERNBASE
)paren
)paren
suffix:semicolon
id|srmmu_allocate_ptable_skeleton
c_func
(paren
id|low_base
comma
id|KERNBASE
)paren
suffix:semicolon
id|vaddr
op_assign
id|low_base
suffix:semicolon
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;map_kernel: vaddr=%08lx Entering second loop for low maps.&bslash;n&quot;
comma
id|vaddr
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_int
r_int
id|bank_size
suffix:semicolon
id|entry
op_assign
id|find_free_spbank
c_func
(paren
op_amp
id|etaken
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|bank_size
op_assign
id|sp_banks
(braket
id|entry
)braket
dot
id|num_bytes
suffix:semicolon
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;map_kernel: e&lt;%d&gt; base=%08lx bs=%08lx &quot;
comma
id|entry
comma
id|sp_banks
(braket
id|entry
)braket
dot
id|base_addr
comma
id|bank_size
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bank_size
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|vaddr
op_plus
id|bank_size
)paren
OG
id|KERNBASE
)paren
(brace
id|memprobe_error
c_func
(paren
l_string|&quot;Wheee, kernel low mapping overflow.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;map_spbank(%08lx, %d) &quot;
comma
id|vaddr
comma
id|entry
)paren
)paren
suffix:semicolon
id|vaddr
op_assign
id|map_spbank
c_func
(paren
id|vaddr
comma
id|entry
)paren
suffix:semicolon
id|etaken
(braket
id|entry
)braket
op_assign
l_int|1
suffix:semicolon
id|tally
op_sub_assign
id|SRMMU_PGDIR_ALIGN
c_func
(paren
id|bank_size
)paren
suffix:semicolon
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;Now, vaddr=%08lx tally=%08lx&bslash;n&quot;
comma
id|vaddr
comma
id|tally
)paren
)paren
suffix:semicolon
)brace
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tally
)paren
(brace
id|memprobe_error
c_func
(paren
l_string|&quot;Wheee, did not map all of low mappings.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|check_and_return
suffix:colon
multiline_comment|/* Step 6: Sanity check, make sure we did it all. */
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;check_and_return: &quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|entry
op_assign
l_int|0
suffix:semicolon
id|sp_banks
(braket
id|entry
)braket
dot
id|num_bytes
suffix:semicolon
id|entry
op_increment
)paren
(brace
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;e[%d]=%d &quot;
comma
id|entry
comma
id|etaken
(braket
id|entry
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|etaken
(braket
id|entry
)braket
)paren
(brace
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;oops&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|memprobe_error
c_func
(paren
l_string|&quot;Some bank did not get mapped.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
id|MKTRACE
c_func
(paren
(paren
l_string|&quot;success&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|init_task.mm-&gt;mmap-&gt;vm_start
op_assign
id|page_offset
op_assign
id|low_base
suffix:semicolon
id|stack_top
op_assign
id|page_offset
op_minus
id|PAGE_SIZE
suffix:semicolon
macro_line|#if 1
r_for
c_loop
(paren
id|entry
op_assign
l_int|0
suffix:semicolon
id|srmmu_map
(braket
id|entry
)braket
dot
id|size
suffix:semicolon
id|entry
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;[%d]: v[%08lx,%08lx](%lx) p[%08lx]&bslash;n&quot;
comma
id|entry
comma
id|srmmu_map
(braket
id|entry
)braket
dot
id|vbase
comma
id|srmmu_map
(braket
id|entry
)braket
dot
id|vbase
op_plus
id|srmmu_map
(braket
id|entry
)braket
dot
id|size
comma
id|srmmu_map
(braket
id|entry
)braket
dot
id|size
comma
id|srmmu_map
(braket
id|entry
)braket
dot
id|pbase
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Now setup the p2v/v2p hash tables. */
r_for
c_loop
(paren
id|entry
op_assign
l_int|0
suffix:semicolon
id|entry
OL
id|SRMMU_HASHSZ
suffix:semicolon
id|entry
op_increment
)paren
(brace
id|srmmu_v2p_hash
(braket
id|entry
)braket
op_assign
id|srmmu_p2v_hash
(braket
id|entry
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|entry
op_assign
l_int|0
suffix:semicolon
id|srmmu_map
(braket
id|entry
)braket
dot
id|size
suffix:semicolon
id|entry
op_increment
)paren
(brace
r_int
r_int
id|addr
suffix:semicolon
r_for
c_loop
(paren
id|addr
op_assign
id|srmmu_map
(braket
id|entry
)braket
dot
id|vbase
suffix:semicolon
id|addr
OL
(paren
id|srmmu_map
(braket
id|entry
)braket
dot
id|vbase
op_plus
id|srmmu_map
(braket
id|entry
)braket
dot
id|size
)paren
suffix:semicolon
id|addr
op_add_assign
(paren
l_int|1
op_lshift
l_int|24
)paren
)paren
(brace
id|srmmu_v2p_hash
(braket
id|srmmu_ahashfn
c_func
(paren
id|addr
)paren
)braket
op_assign
op_amp
id|srmmu_map
(braket
id|entry
)braket
suffix:semicolon
)brace
r_for
c_loop
(paren
id|addr
op_assign
id|srmmu_map
(braket
id|entry
)braket
dot
id|pbase
suffix:semicolon
id|addr
OL
(paren
id|srmmu_map
(braket
id|entry
)braket
dot
id|pbase
op_plus
id|srmmu_map
(braket
id|entry
)braket
dot
id|size
)paren
suffix:semicolon
id|addr
op_add_assign
(paren
l_int|1
op_lshift
l_int|24
)paren
)paren
(brace
id|srmmu_p2v_hash
(braket
id|srmmu_ahashfn
c_func
(paren
id|addr
)paren
)braket
op_assign
op_amp
id|srmmu_map
(braket
id|entry
)braket
suffix:semicolon
)brace
)brace
r_return
suffix:semicolon
multiline_comment|/* SUCCESS! */
)brace
DECL|function|srmmu_endmem_fixup
r_int
r_int
id|srmmu_endmem_fixup
c_func
(paren
r_int
r_int
id|mem_end_now
)paren
(brace
r_int
r_int
id|tally
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|sp_banks
(braket
id|i
)braket
dot
id|num_bytes
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tally
op_add_assign
id|SRMMU_PGDIR_ALIGN
c_func
(paren
id|sp_banks
(braket
id|i
)braket
dot
id|num_bytes
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tally
OL
(paren
l_int|0x0d000000UL
)paren
)paren
(brace
r_return
id|KERNBASE
op_plus
id|tally
suffix:semicolon
)brace
r_else
(brace
r_return
l_int|0xfd000000UL
suffix:semicolon
)brace
)brace
multiline_comment|/* Paging initialization on the Sparc Reference MMU. */
r_extern
r_int
r_int
id|free_area_init
c_func
(paren
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
r_extern
r_int
r_int
id|sparc_context_init
c_func
(paren
r_int
r_int
comma
r_int
)paren
suffix:semicolon
r_extern
r_int
id|physmem_mapped_contig
suffix:semicolon
r_extern
r_int
id|linux_num_cpus
suffix:semicolon
DECL|variable|poke_srmmu
r_void
(paren
op_star
id|poke_srmmu
)paren
(paren
r_void
)paren
suffix:semicolon
DECL|function|srmmu_paging_init
r_int
r_int
id|srmmu_paging_init
c_func
(paren
r_int
r_int
id|start_mem
comma
r_int
r_int
id|end_mem
)paren
(brace
r_int
r_int
id|ptables_start
suffix:semicolon
r_int
id|i
comma
id|cpunode
suffix:semicolon
r_char
id|node_str
(braket
l_int|128
)braket
suffix:semicolon
id|sparc_iobase_vaddr
op_assign
l_int|0xfd000000
suffix:semicolon
multiline_comment|/* 16MB of IOSPACE on all sun4m&squot;s. */
id|physmem_mapped_contig
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* for init.c:taint_real_pages()   */
multiline_comment|/* Find the number of contexts on the srmmu. */
id|cpunode
op_assign
id|prom_getchild
c_func
(paren
id|prom_root_node
)paren
suffix:semicolon
id|num_contexts
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|cpunode
op_assign
id|prom_getsibling
c_func
(paren
id|cpunode
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|prom_getstring
c_func
(paren
id|cpunode
comma
l_string|&quot;device_type&quot;
comma
id|node_str
comma
r_sizeof
(paren
id|node_str
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|node_str
comma
l_string|&quot;cpu&quot;
)paren
)paren
(brace
id|num_contexts
op_assign
id|prom_getintdefault
c_func
(paren
id|cpunode
comma
l_string|&quot;mmu-nctx&quot;
comma
l_int|0x8
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|num_contexts
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;Something wrong, can&squot;t find cpu node in paging_init.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|ptables_start
op_assign
id|mempool
op_assign
id|PAGE_ALIGN
c_func
(paren
id|start_mem
)paren
suffix:semicolon
id|memset
c_func
(paren
id|swapper_pg_dir
comma
l_int|0
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|kbpage
op_assign
id|srmmu_hwprobe
c_func
(paren
id|KERNBASE
op_plus
id|PAGE_SIZE
)paren
suffix:semicolon
id|kbpage
op_assign
(paren
id|kbpage
op_amp
id|SRMMU_PTE_PMASK
)paren
op_lshift
l_int|4
suffix:semicolon
id|kbpage
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
id|srmmu_allocate_ptable_skeleton
c_func
(paren
id|KERNBASE
comma
id|end_mem
)paren
suffix:semicolon
macro_line|#if CONFIG_SUN_IO
id|srmmu_allocate_ptable_skeleton
c_func
(paren
id|sparc_iobase_vaddr
comma
id|IOBASE_END
)paren
suffix:semicolon
id|srmmu_allocate_ptable_skeleton
c_func
(paren
id|DVMA_VADDR
comma
id|DVMA_END
)paren
suffix:semicolon
macro_line|#endif
id|mempool
op_assign
id|PAGE_ALIGN
c_func
(paren
id|mempool
)paren
suffix:semicolon
id|srmmu_inherit_prom_mappings
c_func
(paren
l_int|0xfe400000
comma
(paren
id|LINUX_OPPROM_ENDVM
op_minus
id|PAGE_SIZE
)paren
)paren
suffix:semicolon
id|map_kernel
c_func
(paren
)paren
suffix:semicolon
id|srmmu_context_table
op_assign
id|sparc_init_alloc
c_func
(paren
op_amp
id|mempool
comma
id|num_contexts
op_star
r_sizeof
(paren
id|ctxd_t
)paren
)paren
suffix:semicolon
id|srmmu_ctx_table_phys
op_assign
(paren
id|ctxd_t
op_star
)paren
id|srmmu_v2p
c_func
(paren
(paren
r_int
r_int
)paren
id|srmmu_context_table
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_contexts
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ctxd_set
c_func
(paren
op_amp
id|srmmu_context_table
(braket
id|i
)braket
comma
id|swapper_pg_dir
)paren
suffix:semicolon
)brace
id|start_mem
op_assign
id|PAGE_ALIGN
c_func
(paren
id|mempool
)paren
suffix:semicolon
id|flush_cache_all
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flush_page_for_dma
op_eq
id|viking_flush_page
)paren
(brace
r_int
r_int
id|start
op_assign
id|ptables_start
suffix:semicolon
r_int
r_int
id|end
op_assign
id|start_mem
suffix:semicolon
r_while
c_loop
(paren
id|start
OL
id|end
)paren
(brace
id|viking_flush_page
c_func
(paren
id|start
)paren
suffix:semicolon
id|start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
)brace
id|srmmu_set_ctable_ptr
c_func
(paren
(paren
r_int
r_int
)paren
id|srmmu_ctx_table_phys
)paren
suffix:semicolon
id|flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
id|poke_srmmu
c_func
(paren
)paren
suffix:semicolon
id|start_mem
op_assign
id|sparc_context_init
c_func
(paren
id|start_mem
comma
id|num_contexts
)paren
suffix:semicolon
id|start_mem
op_assign
id|free_area_init
c_func
(paren
id|start_mem
comma
id|end_mem
)paren
suffix:semicolon
r_return
id|PAGE_ALIGN
c_func
(paren
id|start_mem
)paren
suffix:semicolon
)brace
DECL|variable|srmmuinfo
r_static
r_char
id|srmmuinfo
(braket
l_int|512
)braket
suffix:semicolon
DECL|function|srmmu_mmu_info
r_static
r_char
op_star
id|srmmu_mmu_info
c_func
(paren
r_void
)paren
(brace
id|sprintf
c_func
(paren
id|srmmuinfo
comma
l_string|&quot;MMU type&bslash;t: %s&bslash;n&quot;
l_string|&quot;invall&bslash;t&bslash;t: %d&bslash;n&quot;
l_string|&quot;invmm&bslash;t&bslash;t: %d&bslash;n&quot;
l_string|&quot;invrnge&bslash;t&bslash;t: %d&bslash;n&quot;
l_string|&quot;invpg&bslash;t&bslash;t: %d&bslash;n&quot;
l_string|&quot;contexts&bslash;t: %d&bslash;n&quot;
macro_line|#ifdef USE_CHUNK_ALLOC
l_string|&quot;big chunks&bslash;t: %d&bslash;n&quot;
l_string|&quot;little chunks&bslash;t: %d&bslash;n&quot;
l_string|&quot;chunk pages&bslash;t: %d&bslash;n&quot;
l_string|&quot;garbage&bslash;t&bslash;t: %d&bslash;n&quot;
l_string|&quot;garbage hits&bslash;t: %d&bslash;n&quot;
macro_line|#endif
comma
id|srmmu_name
comma
id|module_stats.invall
comma
id|module_stats.invmm
comma
id|module_stats.invrnge
comma
id|module_stats.invpg
comma
id|num_contexts
macro_line|#ifdef USE_CHUNK_ALLOC
comma
id|bcwater
comma
id|lcwater
comma
id|chunk_pages
comma
id|garbage_calls
comma
id|clct_pages
macro_line|#endif
)paren
suffix:semicolon
r_return
id|srmmuinfo
suffix:semicolon
)brace
DECL|function|srmmu_update_mmu_cache
r_static
r_void
id|srmmu_update_mmu_cache
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|address
comma
id|pte_t
id|pte
)paren
(brace
)brace
DECL|function|srmmu_destroy_context
r_static
r_void
id|srmmu_destroy_context
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
r_if
c_cond
(paren
id|mm-&gt;context
op_ne
id|NO_CONTEXT
op_logical_and
id|mm-&gt;count
op_eq
l_int|1
)paren
(brace
id|flush_cache_mm
c_func
(paren
id|mm
)paren
suffix:semicolon
id|ctxd_set
c_func
(paren
op_amp
id|srmmu_context_table
(braket
id|mm-&gt;context
)braket
comma
id|swapper_pg_dir
)paren
suffix:semicolon
id|flush_tlb_mm
c_func
(paren
id|mm
)paren
suffix:semicolon
id|free_context
c_func
(paren
id|mm-&gt;context
)paren
suffix:semicolon
id|mm-&gt;context
op_assign
id|NO_CONTEXT
suffix:semicolon
)brace
)brace
DECL|function|srmmu_vac_update_mmu_cache
r_static
r_void
id|srmmu_vac_update_mmu_cache
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|address
comma
id|pte_t
id|pte
)paren
(brace
r_if
c_cond
(paren
(paren
id|vma-&gt;vm_flags
op_amp
(paren
id|VM_WRITE
op_or
id|VM_SHARED
)paren
)paren
op_eq
(paren
id|VM_WRITE
op_or
id|VM_SHARED
)paren
)paren
(brace
r_struct
id|vm_area_struct
op_star
id|vmaring
suffix:semicolon
r_struct
id|dentry
op_star
id|dentry
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|flags
comma
id|offset
comma
id|vaddr
comma
id|start
suffix:semicolon
r_int
id|alias_found
op_assign
l_int|0
suffix:semicolon
id|pgd_t
op_star
id|pgdp
suffix:semicolon
id|pmd_t
op_star
id|pmdp
suffix:semicolon
id|pte_t
op_star
id|ptep
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|dentry
op_assign
id|vma-&gt;vm_dentry
suffix:semicolon
r_if
c_cond
(paren
id|dentry
)paren
(brace
id|inode
op_assign
id|dentry-&gt;d_inode
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
r_goto
id|done
suffix:semicolon
id|offset
op_assign
(paren
id|address
op_amp
id|PAGE_MASK
)paren
op_minus
id|vma-&gt;vm_start
suffix:semicolon
id|vmaring
op_assign
id|inode-&gt;i_mmap
suffix:semicolon
r_do
(brace
id|vaddr
op_assign
id|vmaring-&gt;vm_start
op_plus
id|offset
suffix:semicolon
r_if
c_cond
(paren
(paren
id|vaddr
op_xor
id|address
)paren
op_amp
id|vac_badbits
)paren
(brace
id|alias_found
op_increment
suffix:semicolon
id|start
op_assign
id|vmaring-&gt;vm_start
suffix:semicolon
r_while
c_loop
(paren
id|start
OL
id|vmaring-&gt;vm_end
)paren
(brace
id|pgdp
op_assign
id|srmmu_pgd_offset
c_func
(paren
id|vmaring-&gt;vm_mm
comma
id|start
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pgdp
)paren
(brace
r_goto
id|next
suffix:semicolon
)brace
id|pmdp
op_assign
id|srmmu_pmd_offset
c_func
(paren
id|pgdp
comma
id|start
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pmdp
)paren
(brace
r_goto
id|next
suffix:semicolon
)brace
id|ptep
op_assign
id|srmmu_pte_offset
c_func
(paren
id|pmdp
comma
id|start
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ptep
)paren
(brace
r_goto
id|next
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pte_val
c_func
(paren
op_star
id|ptep
)paren
op_amp
id|SRMMU_ET_MASK
)paren
op_eq
id|SRMMU_VALID
)paren
(brace
macro_line|#if 1
id|printk
c_func
(paren
l_string|&quot;Fixing USER/USER alias [%ld:%08lx]&bslash;n&quot;
comma
id|vmaring-&gt;vm_mm-&gt;context
comma
id|start
)paren
suffix:semicolon
macro_line|#endif
id|flush_cache_page
c_func
(paren
id|vmaring
comma
id|start
)paren
suffix:semicolon
id|set_pte
c_func
(paren
id|ptep
comma
id|__pte
c_func
(paren
(paren
id|pte_val
c_func
(paren
op_star
id|ptep
)paren
op_amp
op_complement
id|SRMMU_CACHE
)paren
)paren
)paren
suffix:semicolon
id|flush_tlb_page
c_func
(paren
id|vmaring
comma
id|start
)paren
suffix:semicolon
)brace
id|next
suffix:colon
id|start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
)brace
)brace
r_while
c_loop
(paren
(paren
id|vmaring
op_assign
id|vmaring-&gt;vm_next_share
)paren
op_ne
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|alias_found
op_logical_and
op_logical_neg
(paren
id|pte_val
c_func
(paren
id|pte
)paren
op_amp
id|_SUN4C_PAGE_NOCACHE
)paren
)paren
(brace
id|pgdp
op_assign
id|srmmu_pgd_offset
c_func
(paren
id|vma-&gt;vm_mm
comma
id|address
)paren
suffix:semicolon
id|ptep
op_assign
id|srmmu_pte_offset
c_func
(paren
(paren
id|pmd_t
op_star
)paren
id|pgdp
comma
id|address
)paren
suffix:semicolon
id|flush_cache_page
c_func
(paren
id|vma
comma
id|address
)paren
suffix:semicolon
op_star
id|ptep
op_assign
id|__pte
c_func
(paren
id|pte_val
c_func
(paren
op_star
id|ptep
)paren
op_or
id|_SUN4C_PAGE_NOCACHE
)paren
suffix:semicolon
id|flush_tlb_page
c_func
(paren
id|vma
comma
id|address
)paren
suffix:semicolon
)brace
id|done
suffix:colon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
DECL|function|hypersparc_destroy_context
r_static
r_void
id|hypersparc_destroy_context
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
r_if
c_cond
(paren
id|mm-&gt;context
op_ne
id|NO_CONTEXT
op_logical_and
id|mm-&gt;count
op_eq
l_int|1
)paren
(brace
id|ctxd_t
op_star
id|ctxp
suffix:semicolon
multiline_comment|/* HyperSparc is copy-back, any data for this&n;&t;&t; * process in a modified cache line is stale&n;&t;&t; * and must be written back to main memory now&n;&t;&t; * else we eat shit later big time.&n;&t;&t; */
id|flush_cache_mm
c_func
(paren
id|mm
)paren
suffix:semicolon
id|ctxp
op_assign
op_amp
id|srmmu_context_table
(braket
id|mm-&gt;context
)braket
suffix:semicolon
id|srmmu_set_entry
c_func
(paren
(paren
id|pte_t
op_star
)paren
id|ctxp
comma
id|__pte
c_func
(paren
(paren
id|SRMMU_ET_PTD
op_or
(paren
id|srmmu_v2p
c_func
(paren
(paren
r_int
r_int
)paren
id|swapper_pg_dir
)paren
op_rshift
l_int|4
)paren
)paren
)paren
)paren
suffix:semicolon
id|hypersparc_flush_page_to_ram
c_func
(paren
(paren
r_int
r_int
)paren
id|ctxp
)paren
suffix:semicolon
id|flush_tlb_mm
c_func
(paren
id|mm
)paren
suffix:semicolon
id|free_context
c_func
(paren
id|mm-&gt;context
)paren
suffix:semicolon
id|mm-&gt;context
op_assign
id|NO_CONTEXT
suffix:semicolon
)brace
)brace
multiline_comment|/* Init various srmmu chip types. */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_void
id|srmmu_is_bad
c_func
(paren
r_void
)paren
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;Could not determine SRMMU chip type.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_void
id|init_vac_layout
c_func
(paren
r_void
)paren
)paren
(brace
r_int
id|nd
comma
id|cache_lines
suffix:semicolon
r_char
id|node_str
(braket
l_int|128
)braket
suffix:semicolon
macro_line|#ifdef __SMP__
r_int
id|cpu
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|max_size
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|min_line_size
op_assign
l_int|0x10000000
suffix:semicolon
macro_line|#endif
id|nd
op_assign
id|prom_getchild
c_func
(paren
id|prom_root_node
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|nd
op_assign
id|prom_getsibling
c_func
(paren
id|nd
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|prom_getstring
c_func
(paren
id|nd
comma
l_string|&quot;device_type&quot;
comma
id|node_str
comma
r_sizeof
(paren
id|node_str
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|node_str
comma
l_string|&quot;cpu&quot;
)paren
)paren
(brace
id|vac_line_size
op_assign
id|prom_getint
c_func
(paren
id|nd
comma
l_string|&quot;cache-line-size&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vac_line_size
op_eq
op_minus
l_int|1
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;can&squot;t determine cache-line-size, &quot;
l_string|&quot;halting.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|cache_lines
op_assign
id|prom_getint
c_func
(paren
id|nd
comma
l_string|&quot;cache-nlines&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cache_lines
op_eq
op_minus
l_int|1
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;can&squot;t determine cache-nlines, halting.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|vac_cache_size
op_assign
id|cache_lines
op_star
id|vac_line_size
suffix:semicolon
id|vac_badbits
op_assign
(paren
id|vac_cache_size
op_minus
l_int|1
)paren
op_amp
id|PAGE_MASK
suffix:semicolon
macro_line|#ifdef __SMP__
r_if
c_cond
(paren
id|vac_cache_size
OG
id|max_size
)paren
(brace
id|max_size
op_assign
id|vac_cache_size
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vac_line_size
OL
id|min_line_size
)paren
(brace
id|min_line_size
op_assign
id|vac_line_size
suffix:semicolon
)brace
id|cpu
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|cpu
op_eq
id|smp_num_cpus
)paren
(brace
r_break
suffix:semicolon
)brace
macro_line|#else
r_break
suffix:semicolon
macro_line|#endif
)brace
)brace
r_if
c_cond
(paren
id|nd
op_eq
l_int|0
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;No CPU nodes found, halting.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef __SMP__
id|vac_cache_size
op_assign
id|max_size
suffix:semicolon
id|vac_line_size
op_assign
id|min_line_size
suffix:semicolon
id|vac_badbits
op_assign
(paren
id|vac_cache_size
op_minus
l_int|1
)paren
op_amp
id|PAGE_MASK
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;SRMMU: Using VAC size of %d bytes, line size %d bytes.&bslash;n&quot;
comma
(paren
r_int
)paren
id|vac_cache_size
comma
(paren
r_int
)paren
id|vac_line_size
)paren
suffix:semicolon
)brace
DECL|function|poke_hypersparc
r_static
r_void
id|poke_hypersparc
c_func
(paren
r_void
)paren
(brace
r_volatile
r_int
r_int
id|clear
suffix:semicolon
r_int
r_int
id|mreg
op_assign
id|srmmu_get_mmureg
c_func
(paren
)paren
suffix:semicolon
id|hyper_flush_unconditional_combined
c_func
(paren
)paren
suffix:semicolon
id|mreg
op_and_assign
op_complement
(paren
id|HYPERSPARC_CWENABLE
)paren
suffix:semicolon
id|mreg
op_or_assign
(paren
id|HYPERSPARC_CENABLE
op_or
id|HYPERSPARC_WBENABLE
)paren
suffix:semicolon
id|mreg
op_or_assign
(paren
id|HYPERSPARC_CMODE
)paren
suffix:semicolon
id|srmmu_set_mmureg
c_func
(paren
id|mreg
)paren
suffix:semicolon
macro_line|#if 0 /* I think this is bad news... -DaveM */
id|hyper_clear_all_tags
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|put_ross_icr
c_func
(paren
id|HYPERSPARC_ICCR_FTD
op_or
id|HYPERSPARC_ICCR_ICE
)paren
suffix:semicolon
id|hyper_flush_whole_icache
c_func
(paren
)paren
suffix:semicolon
id|clear
op_assign
id|srmmu_get_faddr
c_func
(paren
)paren
suffix:semicolon
id|clear
op_assign
id|srmmu_get_fstatus
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef __SMP__
multiline_comment|/* Avoid unnecessary cross calls. */
id|flush_page_for_dma
op_assign
id|local_flush_page_for_dma
suffix:semicolon
macro_line|#endif
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_void
id|init_hypersparc
c_func
(paren
r_void
)paren
)paren
(brace
id|srmmu_name
op_assign
l_string|&quot;ROSS HyperSparc&quot;
suffix:semicolon
id|init_vac_layout
c_func
(paren
)paren
suffix:semicolon
id|set_pte
op_assign
id|srmmu_set_pte_nocache_hyper
suffix:semicolon
id|flush_cache_all
op_assign
id|hypersparc_flush_cache_all
suffix:semicolon
id|flush_cache_mm
op_assign
id|hypersparc_flush_cache_mm
suffix:semicolon
id|flush_cache_range
op_assign
id|hypersparc_flush_cache_range
suffix:semicolon
id|flush_cache_page
op_assign
id|hypersparc_flush_cache_page
suffix:semicolon
id|flush_tlb_all
op_assign
id|hypersparc_flush_tlb_all
suffix:semicolon
id|flush_tlb_mm
op_assign
id|hypersparc_flush_tlb_mm
suffix:semicolon
id|flush_tlb_range
op_assign
id|hypersparc_flush_tlb_range
suffix:semicolon
id|flush_tlb_page
op_assign
id|hypersparc_flush_tlb_page
suffix:semicolon
id|flush_page_to_ram
op_assign
id|hypersparc_flush_page_to_ram
suffix:semicolon
id|flush_sig_insns
op_assign
id|hypersparc_flush_sig_insns
suffix:semicolon
id|flush_page_for_dma
op_assign
id|hypersparc_flush_page_for_dma
suffix:semicolon
id|flush_chunk
op_assign
id|hypersparc_flush_chunk
suffix:semicolon
multiline_comment|/* local flush _only_ */
id|ctxd_set
op_assign
id|hypersparc_ctxd_set
suffix:semicolon
id|switch_to_context
op_assign
id|hypersparc_switch_to_context
suffix:semicolon
id|init_new_context
op_assign
id|hypersparc_init_new_context
suffix:semicolon
id|destroy_context
op_assign
id|hypersparc_destroy_context
suffix:semicolon
id|update_mmu_cache
op_assign
id|srmmu_vac_update_mmu_cache
suffix:semicolon
id|sparc_update_rootmmu_dir
op_assign
id|hypersparc_update_rootmmu_dir
suffix:semicolon
id|poke_srmmu
op_assign
id|poke_hypersparc
suffix:semicolon
id|hypersparc_setup_blockops
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|poke_cypress
r_static
r_void
id|poke_cypress
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|mreg
op_assign
id|srmmu_get_mmureg
c_func
(paren
)paren
suffix:semicolon
r_int
r_int
id|faddr
comma
id|tagval
suffix:semicolon
r_volatile
r_int
r_int
id|cypress_sucks
suffix:semicolon
r_volatile
r_int
r_int
id|clear
suffix:semicolon
id|clear
op_assign
id|srmmu_get_faddr
c_func
(paren
)paren
suffix:semicolon
id|clear
op_assign
id|srmmu_get_fstatus
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mreg
op_amp
id|CYPRESS_CENABLE
)paren
)paren
(brace
r_for
c_loop
(paren
id|faddr
op_assign
l_int|0x0
suffix:semicolon
id|faddr
OL
l_int|0x10000
suffix:semicolon
id|faddr
op_add_assign
l_int|20
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;sta %%g0, [%0 + %1] %2&bslash;n&bslash;t&quot;
l_string|&quot;sta %%g0, [%0] %2&bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|faddr
)paren
comma
l_string|&quot;r&quot;
(paren
l_int|0x40000
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_DATAC_TAG
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_for
c_loop
(paren
id|faddr
op_assign
l_int|0
suffix:semicolon
id|faddr
OL
l_int|0x10000
suffix:semicolon
id|faddr
op_add_assign
l_int|0x20
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;lda [%1 + %2] %3, %0&bslash;n&bslash;t&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|tagval
)paren
suffix:colon
l_string|&quot;r&quot;
(paren
id|faddr
)paren
comma
l_string|&quot;r&quot;
(paren
l_int|0x40000
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_DATAC_TAG
)paren
)paren
suffix:semicolon
multiline_comment|/* If modified and valid, kick it. */
r_if
c_cond
(paren
(paren
id|tagval
op_amp
l_int|0x60
)paren
op_eq
l_int|0x60
)paren
(brace
id|cypress_sucks
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
(paren
l_int|0xf0020000
op_plus
id|faddr
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* And one more, for our good neighbor, Mr. Broken Cypress. */
id|clear
op_assign
id|srmmu_get_faddr
c_func
(paren
)paren
suffix:semicolon
id|clear
op_assign
id|srmmu_get_fstatus
c_func
(paren
)paren
suffix:semicolon
id|mreg
op_or_assign
(paren
id|CYPRESS_CENABLE
op_or
id|CYPRESS_CMODE
)paren
suffix:semicolon
id|srmmu_set_mmureg
c_func
(paren
id|mreg
)paren
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_void
id|init_cypress_common
c_func
(paren
r_void
)paren
)paren
(brace
id|init_vac_layout
c_func
(paren
)paren
suffix:semicolon
id|set_pte
op_assign
id|srmmu_set_pte_nocache_cypress
suffix:semicolon
id|flush_cache_all
op_assign
id|cypress_flush_cache_all
suffix:semicolon
id|flush_cache_mm
op_assign
id|cypress_flush_cache_mm
suffix:semicolon
id|flush_cache_range
op_assign
id|cypress_flush_cache_range
suffix:semicolon
id|flush_cache_page
op_assign
id|cypress_flush_cache_page
suffix:semicolon
id|flush_tlb_all
op_assign
id|cypress_flush_tlb_all
suffix:semicolon
id|flush_tlb_mm
op_assign
id|cypress_flush_tlb_mm
suffix:semicolon
id|flush_tlb_page
op_assign
id|cypress_flush_tlb_page
suffix:semicolon
id|flush_tlb_range
op_assign
id|cypress_flush_tlb_range
suffix:semicolon
id|flush_chunk
op_assign
id|cypress_flush_chunk
suffix:semicolon
multiline_comment|/* local flush _only_ */
id|flush_page_to_ram
op_assign
id|cypress_flush_page_to_ram
suffix:semicolon
id|flush_sig_insns
op_assign
id|cypress_flush_sig_insns
suffix:semicolon
id|flush_page_for_dma
op_assign
id|cypress_flush_page_for_dma
suffix:semicolon
id|sparc_update_rootmmu_dir
op_assign
id|cypress_update_rootmmu_dir
suffix:semicolon
id|update_mmu_cache
op_assign
id|srmmu_vac_update_mmu_cache
suffix:semicolon
id|poke_srmmu
op_assign
id|poke_cypress
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_void
id|init_cypress_604
c_func
(paren
r_void
)paren
)paren
(brace
id|srmmu_name
op_assign
l_string|&quot;ROSS Cypress-604(UP)&quot;
suffix:semicolon
id|srmmu_modtype
op_assign
id|Cypress
suffix:semicolon
id|init_cypress_common
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_void
id|init_cypress_605
c_func
(paren
r_int
r_int
id|mrev
)paren
)paren
(brace
id|srmmu_name
op_assign
l_string|&quot;ROSS Cypress-605(MP)&quot;
suffix:semicolon
r_if
c_cond
(paren
id|mrev
op_eq
l_int|0xe
)paren
(brace
id|srmmu_modtype
op_assign
id|Cypress_vE
suffix:semicolon
id|hwbug_bitmask
op_or_assign
id|HWBUG_COPYBACK_BROKEN
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|mrev
op_eq
l_int|0xd
)paren
(brace
id|srmmu_modtype
op_assign
id|Cypress_vD
suffix:semicolon
id|hwbug_bitmask
op_or_assign
id|HWBUG_ASIFLUSH_BROKEN
suffix:semicolon
)brace
r_else
(brace
id|srmmu_modtype
op_assign
id|Cypress
suffix:semicolon
)brace
)brace
id|init_cypress_common
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|poke_swift
r_static
r_void
id|poke_swift
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|mreg
op_assign
id|srmmu_get_mmureg
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Clear any crap from the cache or else... */
id|swift_idflash_clear
c_func
(paren
)paren
suffix:semicolon
id|mreg
op_or_assign
(paren
id|SWIFT_IE
op_or
id|SWIFT_DE
)paren
suffix:semicolon
multiline_comment|/* I &amp; D caches on */
multiline_comment|/* The Swift branch folding logic is completely broken.  At&n;&t; * trap time, if things are just right, if can mistakenly&n;&t; * think that a trap is coming from kernel mode when in fact&n;&t; * it is coming from user mode (it mis-executes the branch in&n;&t; * the trap code).  So you see things like crashme completely&n;&t; * hosing your machine which is completely unacceptable.  Turn&n;&t; * this shit off... nice job Fujitsu.&n;&t; */
id|mreg
op_and_assign
op_complement
(paren
id|SWIFT_BF
)paren
suffix:semicolon
id|srmmu_set_mmureg
c_func
(paren
id|mreg
)paren
suffix:semicolon
)brace
DECL|macro|SWIFT_MASKID_ADDR
mdefine_line|#define SWIFT_MASKID_ADDR  0x10003018
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_void
id|init_swift
c_func
(paren
r_void
)paren
)paren
(brace
r_int
r_int
id|swift_rev
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;lda [%1] %2, %0&bslash;n&bslash;t&quot;
l_string|&quot;srl %0, 0x18, %0&bslash;n&bslash;t&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|swift_rev
)paren
suffix:colon
l_string|&quot;r&quot;
(paren
id|SWIFT_MASKID_ADDR
)paren
comma
l_string|&quot;i&quot;
(paren
id|ASI_M_BYPASS
)paren
)paren
suffix:semicolon
id|srmmu_name
op_assign
l_string|&quot;Fujitsu Swift&quot;
suffix:semicolon
r_switch
c_cond
(paren
id|swift_rev
)paren
(brace
r_case
l_int|0x11
suffix:colon
r_case
l_int|0x20
suffix:colon
r_case
l_int|0x23
suffix:colon
r_case
l_int|0x30
suffix:colon
id|srmmu_modtype
op_assign
id|Swift_lots_o_bugs
suffix:semicolon
id|hwbug_bitmask
op_or_assign
(paren
id|HWBUG_KERN_ACCBROKEN
op_or
id|HWBUG_KERN_CBITBROKEN
)paren
suffix:semicolon
multiline_comment|/* Gee george, I wonder why Sun is so hush hush about&n;&t;&t; * this hardware bug... really braindamage stuff going&n;&t;&t; * on here.  However I think we can find a way to avoid&n;&t;&t; * all of the workaround overhead under Linux.  Basically,&n;&t;&t; * any page fault can cause kernel pages to become user&n;&t;&t; * accessible (the mmu gets confused and clears some of&n;&t;&t; * the ACC bits in kernel ptes).  Aha, sounds pretty&n;&t;&t; * horrible eh?  But wait, after extensive testing it appears&n;&t;&t; * that if you use pgd_t level large kernel pte&squot;s (like the&n;&t;&t; * 4MB pages on the Pentium) the bug does not get tripped&n;&t;&t; * at all.  This avoids almost all of the major overhead.&n;&t;&t; * Welcome to a world where your vendor tells you to,&n;&t;&t; * &quot;apply this kernel patch&quot; instead of &quot;sorry for the&n;&t;&t; * broken hardware, send it back and we&squot;ll give you&n;&t;&t; * properly functioning parts&quot;&n;&t;&t; */
r_break
suffix:semicolon
r_case
l_int|0x25
suffix:colon
r_case
l_int|0x31
suffix:colon
id|srmmu_modtype
op_assign
id|Swift_bad_c
suffix:semicolon
id|hwbug_bitmask
op_or_assign
id|HWBUG_KERN_CBITBROKEN
suffix:semicolon
multiline_comment|/* You see Sun allude to this hardware bug but never&n;&t;&t; * admit things directly, they&squot;ll say things like,&n;&t;&t; * &quot;the Swift chip cache problems&quot; or similar.&n;&t;&t; */
r_break
suffix:semicolon
r_default
suffix:colon
id|srmmu_modtype
op_assign
id|Swift_ok
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
id|flush_cache_all
op_assign
id|swift_flush_cache_all
suffix:semicolon
id|flush_cache_mm
op_assign
id|swift_flush_cache_mm
suffix:semicolon
id|flush_cache_page
op_assign
id|swift_flush_cache_page
suffix:semicolon
id|flush_cache_range
op_assign
id|swift_flush_cache_range
suffix:semicolon
id|flush_chunk
op_assign
id|swift_flush_chunk
suffix:semicolon
multiline_comment|/* local flush _only_ */
id|flush_tlb_all
op_assign
id|swift_flush_tlb_all
suffix:semicolon
id|flush_tlb_mm
op_assign
id|swift_flush_tlb_mm
suffix:semicolon
id|flush_tlb_page
op_assign
id|swift_flush_tlb_page
suffix:semicolon
id|flush_tlb_range
op_assign
id|swift_flush_tlb_range
suffix:semicolon
id|flush_page_to_ram
op_assign
id|swift_flush_page_to_ram
suffix:semicolon
id|flush_sig_insns
op_assign
id|swift_flush_sig_insns
suffix:semicolon
id|flush_page_for_dma
op_assign
id|swift_flush_page_for_dma
suffix:semicolon
multiline_comment|/* Are you now convinced that the Swift is one of the&n;&t; * biggest VLSI abortions of all time?  Bravo Fujitsu!&n;&t; * Fujitsu, the !#?!%$&squot;d up processor people.  I bet if&n;&t; * you examined the microcode of the Swift you&squot;d find&n;&t; * XXX&squot;s all over the place.&n;&t; */
id|poke_srmmu
op_assign
id|poke_swift
suffix:semicolon
)brace
multiline_comment|/* turbosparc.S */
r_extern
r_void
id|turbosparc_flush_cache_all
c_func
(paren
)paren
suffix:semicolon
r_extern
r_void
id|turbosparc_flush_sig_insns
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|insn_addr
)paren
suffix:semicolon
DECL|function|poke_turbosparc
r_static
r_void
id|poke_turbosparc
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|mreg
op_assign
id|srmmu_get_mmureg
c_func
(paren
)paren
suffix:semicolon
r_int
r_int
id|ccreg
suffix:semicolon
multiline_comment|/* Clear any crap from the cache or else... */
id|turbosparc_flush_cache_all
c_func
(paren
)paren
suffix:semicolon
id|mreg
op_and_assign
op_complement
(paren
id|TURBOSPARC_ICENABLE
op_or
id|TURBOSPARC_DCENABLE
)paren
suffix:semicolon
multiline_comment|/* Temporarily disable I &amp; D caches */
id|mreg
op_and_assign
op_complement
(paren
id|TURBOSPARC_PCENABLE
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t check parity */
id|srmmu_set_mmureg
c_func
(paren
id|mreg
)paren
suffix:semicolon
id|ccreg
op_assign
id|turbosparc_get_ccreg
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef TURBOSPARC_WRITEBACK
id|ccreg
op_or_assign
(paren
id|TURBOSPARC_SNENABLE
)paren
suffix:semicolon
multiline_comment|/* Do DVMA snooping in Dcache */
id|ccreg
op_and_assign
op_complement
(paren
id|TURBOSPARC_uS2
op_or
id|TURBOSPARC_WTENABLE
)paren
suffix:semicolon
multiline_comment|/* Write-back D-cache, emulate VLSI &n;&t;&t;&t; * abortion number three, not number one */
macro_line|#else
multiline_comment|/* For now let&squot;s play safe, optimize later */
id|ccreg
op_or_assign
(paren
id|TURBOSPARC_SNENABLE
op_or
id|TURBOSPARC_WTENABLE
)paren
suffix:semicolon
multiline_comment|/* Do DVMA snooping in Dcache, Write-thru D-cache */
id|ccreg
op_and_assign
op_complement
(paren
id|TURBOSPARC_uS2
)paren
suffix:semicolon
multiline_comment|/* Emulate VLSI abortion number three, not number one */
macro_line|#endif&t;&t;&t; 
r_switch
c_cond
(paren
id|ccreg
op_amp
l_int|7
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* No SE cache */
r_case
l_int|7
suffix:colon
multiline_comment|/* Test mode */
r_break
suffix:semicolon
r_default
suffix:colon
id|ccreg
op_or_assign
(paren
id|TURBOSPARC_SCENABLE
)paren
suffix:semicolon
)brace
id|turbosparc_set_ccreg
(paren
id|ccreg
)paren
suffix:semicolon
id|mreg
op_or_assign
(paren
id|TURBOSPARC_ICENABLE
op_or
id|TURBOSPARC_DCENABLE
)paren
suffix:semicolon
multiline_comment|/* I &amp; D caches on */
id|mreg
op_or_assign
(paren
id|TURBOSPARC_ICSNOOP
)paren
suffix:semicolon
multiline_comment|/* Icache snooping on */
id|srmmu_set_mmureg
c_func
(paren
id|mreg
)paren
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_void
id|init_turbosparc
c_func
(paren
r_void
)paren
)paren
(brace
id|srmmu_name
op_assign
l_string|&quot;Fujitsu TurboSparc&quot;
suffix:semicolon
id|srmmu_modtype
op_assign
id|TurboSparc
suffix:semicolon
id|flush_cache_all
op_assign
id|turbosparc_flush_cache_all
suffix:semicolon
id|flush_cache_mm
op_assign
id|hypersparc_flush_cache_mm
suffix:semicolon
id|flush_cache_page
op_assign
id|hypersparc_flush_cache_page
suffix:semicolon
id|flush_cache_range
op_assign
id|hypersparc_flush_cache_range
suffix:semicolon
id|flush_tlb_all
op_assign
id|hypersparc_flush_tlb_all
suffix:semicolon
id|flush_tlb_mm
op_assign
id|hypersparc_flush_tlb_mm
suffix:semicolon
id|flush_tlb_page
op_assign
id|hypersparc_flush_tlb_page
suffix:semicolon
id|flush_tlb_range
op_assign
id|hypersparc_flush_tlb_range
suffix:semicolon
macro_line|#ifdef TURBOSPARC_WRITEBACK
id|flush_page_to_ram
op_assign
id|hypersparc_flush_page_to_ram
suffix:semicolon
id|flush_chunk
op_assign
id|hypersparc_flush_chunk
suffix:semicolon
macro_line|#else
id|flush_page_to_ram
op_assign
id|swift_flush_page_to_ram
suffix:semicolon
id|flush_chunk
op_assign
id|swift_flush_chunk
suffix:semicolon
macro_line|#endif
id|flush_sig_insns
op_assign
id|turbosparc_flush_sig_insns
suffix:semicolon
id|flush_page_for_dma
op_assign
id|hypersparc_flush_page_for_dma
suffix:semicolon
id|poke_srmmu
op_assign
id|poke_turbosparc
suffix:semicolon
)brace
DECL|function|poke_tsunami
r_static
r_void
id|poke_tsunami
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|mreg
op_assign
id|srmmu_get_mmureg
c_func
(paren
)paren
suffix:semicolon
id|tsunami_flush_icache
c_func
(paren
)paren
suffix:semicolon
id|tsunami_flush_dcache
c_func
(paren
)paren
suffix:semicolon
id|mreg
op_and_assign
op_complement
id|TSUNAMI_ITD
suffix:semicolon
id|mreg
op_or_assign
(paren
id|TSUNAMI_IENAB
op_or
id|TSUNAMI_DENAB
)paren
suffix:semicolon
id|srmmu_set_mmureg
c_func
(paren
id|mreg
)paren
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_void
id|init_tsunami
c_func
(paren
r_void
)paren
)paren
(brace
multiline_comment|/* Tsunami&squot;s pretty sane, Sun and TI actually got it&n;&t; * somewhat right this time.  Fujitsu should have&n;&t; * taken some lessons from them.&n;&t; */
id|srmmu_name
op_assign
l_string|&quot;TI Tsunami&quot;
suffix:semicolon
id|srmmu_modtype
op_assign
id|Tsunami
suffix:semicolon
id|flush_cache_all
op_assign
id|tsunami_flush_cache_all
suffix:semicolon
id|flush_cache_mm
op_assign
id|tsunami_flush_cache_mm
suffix:semicolon
id|flush_cache_page
op_assign
id|tsunami_flush_cache_page
suffix:semicolon
id|flush_cache_range
op_assign
id|tsunami_flush_cache_range
suffix:semicolon
id|flush_chunk
op_assign
id|tsunami_flush_chunk
suffix:semicolon
multiline_comment|/* local flush _only_ */
id|flush_tlb_all
op_assign
id|tsunami_flush_tlb_all
suffix:semicolon
id|flush_tlb_mm
op_assign
id|tsunami_flush_tlb_mm
suffix:semicolon
id|flush_tlb_page
op_assign
id|tsunami_flush_tlb_page
suffix:semicolon
id|flush_tlb_range
op_assign
id|tsunami_flush_tlb_range
suffix:semicolon
id|flush_page_to_ram
op_assign
id|tsunami_flush_page_to_ram
suffix:semicolon
id|flush_sig_insns
op_assign
id|tsunami_flush_sig_insns
suffix:semicolon
id|flush_page_for_dma
op_assign
id|tsunami_flush_page_for_dma
suffix:semicolon
id|poke_srmmu
op_assign
id|poke_tsunami
suffix:semicolon
)brace
DECL|function|poke_viking
r_static
r_void
id|poke_viking
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|mreg
op_assign
id|srmmu_get_mmureg
c_func
(paren
)paren
suffix:semicolon
r_static
r_int
id|smp_catch
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|viking_mxcc_present
)paren
(brace
r_int
r_int
id|mxcc_control
op_assign
id|mxcc_get_creg
c_func
(paren
)paren
suffix:semicolon
id|mxcc_control
op_or_assign
(paren
id|MXCC_CTL_ECE
op_or
id|MXCC_CTL_PRE
op_or
id|MXCC_CTL_MCE
)paren
suffix:semicolon
id|mxcc_control
op_and_assign
op_complement
(paren
id|MXCC_CTL_RRC
)paren
suffix:semicolon
id|mxcc_set_creg
c_func
(paren
id|mxcc_control
)paren
suffix:semicolon
multiline_comment|/* We don&squot;t need memory parity checks.&n;&t;&t; * XXX This is a mess, have to dig out later. ecd.&n;&t;&t;viking_mxcc_turn_off_parity(&amp;mreg, &amp;mxcc_control);&n;&t;&t; */
multiline_comment|/* We do cache ptables on MXCC. */
id|mreg
op_or_assign
id|VIKING_TCENABLE
suffix:semicolon
)brace
r_else
(brace
r_int
r_int
id|bpreg
suffix:semicolon
id|mreg
op_and_assign
op_complement
(paren
id|VIKING_TCENABLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smp_catch
op_increment
)paren
(brace
multiline_comment|/* Must disable mixed-cmd mode here for&n;&t;&t;&t; * other cpu&squot;s.&n;&t;&t;&t; */
id|bpreg
op_assign
id|viking_get_bpreg
c_func
(paren
)paren
suffix:semicolon
id|bpreg
op_and_assign
op_complement
(paren
id|VIKING_ACTION_MIX
)paren
suffix:semicolon
id|viking_set_bpreg
c_func
(paren
id|bpreg
)paren
suffix:semicolon
multiline_comment|/* Just in case PROM does something funny. */
id|msi_set_sync
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
id|mreg
op_or_assign
id|VIKING_SPENABLE
suffix:semicolon
id|mreg
op_or_assign
(paren
id|VIKING_ICENABLE
op_or
id|VIKING_DCENABLE
)paren
suffix:semicolon
id|mreg
op_or_assign
id|VIKING_SBENABLE
suffix:semicolon
id|mreg
op_and_assign
op_complement
(paren
id|VIKING_ACENABLE
)paren
suffix:semicolon
id|srmmu_set_mmureg
c_func
(paren
id|mreg
)paren
suffix:semicolon
macro_line|#ifdef __SMP__
multiline_comment|/* Avoid unnecessary cross calls. */
id|flush_cache_all
op_assign
id|local_flush_cache_all
suffix:semicolon
id|flush_page_to_ram
op_assign
id|local_flush_page_to_ram
suffix:semicolon
id|flush_sig_insns
op_assign
id|local_flush_sig_insns
suffix:semicolon
id|flush_page_for_dma
op_assign
id|local_flush_page_for_dma
suffix:semicolon
macro_line|#endif
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_void
id|init_viking
c_func
(paren
r_void
)paren
)paren
(brace
r_int
r_int
id|mreg
op_assign
id|srmmu_get_mmureg
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Ahhh, the viking.  SRMMU VLSI abortion number two... */
r_if
c_cond
(paren
id|mreg
op_amp
id|VIKING_MMODE
)paren
(brace
r_int
r_int
id|bpreg
suffix:semicolon
id|srmmu_name
op_assign
l_string|&quot;TI Viking&quot;
suffix:semicolon
id|viking_mxcc_present
op_assign
l_int|0
suffix:semicolon
id|bpreg
op_assign
id|viking_get_bpreg
c_func
(paren
)paren
suffix:semicolon
id|bpreg
op_and_assign
op_complement
(paren
id|VIKING_ACTION_MIX
)paren
suffix:semicolon
id|viking_set_bpreg
c_func
(paren
id|bpreg
)paren
suffix:semicolon
id|msi_set_sync
c_func
(paren
)paren
suffix:semicolon
id|set_pte
op_assign
id|srmmu_set_pte_nocache_viking
suffix:semicolon
id|sparc_update_rootmmu_dir
op_assign
id|viking_update_rootmmu_dir
suffix:semicolon
id|flush_chunk
op_assign
id|viking_flush_chunk
suffix:semicolon
multiline_comment|/* local flush _only_ */
multiline_comment|/* We need this to make sure old viking takes no hits&n;&t;&t; * on it&squot;s cache for dma snoops to workaround the&n;&t;&t; * &quot;load from non-cacheable memory&quot; interrupt bug.&n;&t;&t; * This is only necessary because of the new way in&n;&t;&t; * which we use the IOMMU.&n;&t;&t; */
id|flush_page_for_dma
op_assign
id|viking_flush_page
suffix:semicolon
)brace
r_else
(brace
id|srmmu_name
op_assign
l_string|&quot;TI Viking/MXCC&quot;
suffix:semicolon
id|viking_mxcc_present
op_assign
l_int|1
suffix:semicolon
id|flush_chunk
op_assign
id|viking_mxcc_flush_chunk
suffix:semicolon
multiline_comment|/* local flush _only_ */
multiline_comment|/* MXCC vikings lack the DMA snooping bug. */
id|flush_page_for_dma
op_assign
id|viking_flush_page_for_dma
suffix:semicolon
)brace
id|flush_cache_all
op_assign
id|viking_flush_cache_all
suffix:semicolon
id|flush_cache_mm
op_assign
id|viking_flush_cache_mm
suffix:semicolon
id|flush_cache_page
op_assign
id|viking_flush_cache_page
suffix:semicolon
id|flush_cache_range
op_assign
id|viking_flush_cache_range
suffix:semicolon
id|flush_tlb_all
op_assign
id|viking_flush_tlb_all
suffix:semicolon
id|flush_tlb_mm
op_assign
id|viking_flush_tlb_mm
suffix:semicolon
id|flush_tlb_page
op_assign
id|viking_flush_tlb_page
suffix:semicolon
id|flush_tlb_range
op_assign
id|viking_flush_tlb_range
suffix:semicolon
id|flush_page_to_ram
op_assign
id|viking_flush_page_to_ram
suffix:semicolon
id|flush_sig_insns
op_assign
id|viking_flush_sig_insns
suffix:semicolon
id|poke_srmmu
op_assign
id|poke_viking
suffix:semicolon
)brace
multiline_comment|/* Probe for the srmmu chip version. */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_void
id|get_srmmu_type
c_func
(paren
r_void
)paren
)paren
(brace
r_int
r_int
id|mreg
comma
id|psr
suffix:semicolon
r_int
r_int
id|mod_typ
comma
id|mod_rev
comma
id|psr_typ
comma
id|psr_vers
suffix:semicolon
id|srmmu_modtype
op_assign
id|SRMMU_INVAL_MOD
suffix:semicolon
id|hwbug_bitmask
op_assign
l_int|0
suffix:semicolon
id|mreg
op_assign
id|srmmu_get_mmureg
c_func
(paren
)paren
suffix:semicolon
id|psr
op_assign
id|get_psr
c_func
(paren
)paren
suffix:semicolon
id|mod_typ
op_assign
(paren
id|mreg
op_amp
l_int|0xf0000000
)paren
op_rshift
l_int|28
suffix:semicolon
id|mod_rev
op_assign
(paren
id|mreg
op_amp
l_int|0x0f000000
)paren
op_rshift
l_int|24
suffix:semicolon
id|psr_typ
op_assign
(paren
id|psr
op_rshift
l_int|28
)paren
op_amp
l_int|0xf
suffix:semicolon
id|psr_vers
op_assign
(paren
id|psr
op_rshift
l_int|24
)paren
op_amp
l_int|0xf
suffix:semicolon
multiline_comment|/* First, check for HyperSparc or Cypress. */
r_if
c_cond
(paren
id|mod_typ
op_eq
l_int|1
)paren
(brace
r_switch
c_cond
(paren
id|mod_rev
)paren
(brace
r_case
l_int|7
suffix:colon
multiline_comment|/* UP or MP Hypersparc */
id|init_hypersparc
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0
suffix:colon
r_case
l_int|2
suffix:colon
multiline_comment|/* Uniprocessor Cypress */
id|init_cypress_604
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|10
suffix:colon
r_case
l_int|11
suffix:colon
r_case
l_int|12
suffix:colon
multiline_comment|/* _REALLY OLD_ Cypress MP chips... */
r_case
l_int|13
suffix:colon
r_case
l_int|14
suffix:colon
r_case
l_int|15
suffix:colon
multiline_comment|/* MP Cypress mmu/cache-controller */
id|init_cypress_605
c_func
(paren
id|mod_rev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* Some other Cypress revision, assume a 605. */
id|init_cypress_605
c_func
(paren
id|mod_rev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Now Fujitsu TurboSparc. It might happen that it is&n;&t;   in Swift emulation mode, so we will check later... */
r_if
c_cond
(paren
id|psr_typ
op_eq
l_int|0
op_logical_and
id|psr_vers
op_eq
l_int|5
)paren
(brace
id|init_turbosparc
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Next check for Fujitsu Swift. */
r_if
c_cond
(paren
id|psr_typ
op_eq
l_int|0
op_logical_and
id|psr_vers
op_eq
l_int|4
)paren
(brace
r_int
id|cpunode
suffix:semicolon
r_char
id|node_str
(braket
l_int|128
)braket
suffix:semicolon
multiline_comment|/* Look if it is not a TurboSparc emulating Swift... */
id|cpunode
op_assign
id|prom_getchild
c_func
(paren
id|prom_root_node
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|cpunode
op_assign
id|prom_getsibling
c_func
(paren
id|cpunode
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|prom_getstring
c_func
(paren
id|cpunode
comma
l_string|&quot;device_type&quot;
comma
id|node_str
comma
r_sizeof
(paren
id|node_str
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|node_str
comma
l_string|&quot;cpu&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|prom_getintdefault
c_func
(paren
id|cpunode
comma
l_string|&quot;psr-implementation&quot;
comma
l_int|1
)paren
op_logical_and
id|prom_getintdefault
c_func
(paren
id|cpunode
comma
l_string|&quot;psr-version&quot;
comma
l_int|1
)paren
op_eq
l_int|5
)paren
(brace
id|init_turbosparc
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
id|init_swift
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Now the Viking family of srmmu. */
r_if
c_cond
(paren
id|psr_typ
op_eq
l_int|4
op_logical_and
(paren
(paren
id|psr_vers
op_eq
l_int|0
)paren
op_logical_or
(paren
(paren
id|psr_vers
op_eq
l_int|1
)paren
op_logical_and
(paren
id|mod_typ
op_eq
l_int|0
)paren
op_logical_and
(paren
id|mod_rev
op_eq
l_int|0
)paren
)paren
)paren
)paren
(brace
id|init_viking
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Finally the Tsunami. */
r_if
c_cond
(paren
id|psr_typ
op_eq
l_int|4
op_logical_and
id|psr_vers
op_eq
l_int|1
op_logical_and
(paren
id|mod_typ
op_logical_or
id|mod_rev
)paren
)paren
(brace
id|init_tsunami
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Oh well */
id|srmmu_is_bad
c_func
(paren
)paren
suffix:semicolon
)brace
r_extern
r_int
r_int
id|spwin_mmu_patchme
comma
id|fwin_mmu_patchme
comma
id|tsetup_mmu_patchme
comma
id|rtrap_mmu_patchme
suffix:semicolon
r_extern
r_int
r_int
id|spwin_srmmu_stackchk
comma
id|srmmu_fwin_stackchk
comma
id|tsetup_srmmu_stackchk
comma
id|srmmu_rett_stackchk
suffix:semicolon
r_extern
r_int
r_int
id|srmmu_fault
suffix:semicolon
DECL|macro|PATCH_BRANCH
mdefine_line|#define PATCH_BRANCH(insn, dest) do { &bslash;&n;&t;&t;iaddr = &amp;(insn); &bslash;&n;&t;&t;daddr = &amp;(dest); &bslash;&n;&t;&t;*iaddr = SPARC_BRANCH((unsigned long) daddr, (unsigned long) iaddr); &bslash;&n;        } while(0);
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_void
id|patch_window_trap_handlers
c_func
(paren
r_void
)paren
)paren
(brace
r_int
r_int
op_star
id|iaddr
comma
op_star
id|daddr
suffix:semicolon
id|PATCH_BRANCH
c_func
(paren
id|spwin_mmu_patchme
comma
id|spwin_srmmu_stackchk
)paren
suffix:semicolon
id|PATCH_BRANCH
c_func
(paren
id|fwin_mmu_patchme
comma
id|srmmu_fwin_stackchk
)paren
suffix:semicolon
id|PATCH_BRANCH
c_func
(paren
id|tsetup_mmu_patchme
comma
id|tsetup_srmmu_stackchk
)paren
suffix:semicolon
id|PATCH_BRANCH
c_func
(paren
id|rtrap_mmu_patchme
comma
id|srmmu_rett_stackchk
)paren
suffix:semicolon
id|PATCH_BRANCH
c_func
(paren
id|sparc_ttable
(braket
id|SP_TRAP_TFLT
)braket
dot
id|inst_three
comma
id|srmmu_fault
)paren
suffix:semicolon
id|PATCH_BRANCH
c_func
(paren
id|sparc_ttable
(braket
id|SP_TRAP_DFLT
)braket
dot
id|inst_three
comma
id|srmmu_fault
)paren
suffix:semicolon
id|PATCH_BRANCH
c_func
(paren
id|sparc_ttable
(braket
id|SP_TRAP_DACC
)braket
dot
id|inst_three
comma
id|srmmu_fault
)paren
suffix:semicolon
)brace
macro_line|#ifdef __SMP__
multiline_comment|/* Local cross-calls. */
DECL|function|smp_flush_page_for_dma
r_static
r_void
id|smp_flush_page_for_dma
c_func
(paren
r_int
r_int
id|page
)paren
(brace
id|xc1
c_func
(paren
(paren
id|smpfunc_t
)paren
id|local_flush_page_for_dma
comma
id|page
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Load up routines and constants for sun4m mmu */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|ld_mmu_srmmu
c_func
(paren
r_void
)paren
)paren
(brace
multiline_comment|/* First the constants */
id|pmd_shift
op_assign
id|SRMMU_PMD_SHIFT
suffix:semicolon
id|pmd_size
op_assign
id|SRMMU_PMD_SIZE
suffix:semicolon
id|pmd_mask
op_assign
id|SRMMU_PMD_MASK
suffix:semicolon
id|pgdir_shift
op_assign
id|SRMMU_PGDIR_SHIFT
suffix:semicolon
id|pgdir_size
op_assign
id|SRMMU_PGDIR_SIZE
suffix:semicolon
id|pgdir_mask
op_assign
id|SRMMU_PGDIR_MASK
suffix:semicolon
id|ptrs_per_pte
op_assign
id|SRMMU_PTRS_PER_PTE
suffix:semicolon
id|ptrs_per_pmd
op_assign
id|SRMMU_PTRS_PER_PMD
suffix:semicolon
id|ptrs_per_pgd
op_assign
id|SRMMU_PTRS_PER_PGD
suffix:semicolon
id|page_none
op_assign
id|SRMMU_PAGE_NONE
suffix:semicolon
id|page_shared
op_assign
id|SRMMU_PAGE_SHARED
suffix:semicolon
id|page_copy
op_assign
id|SRMMU_PAGE_COPY
suffix:semicolon
id|page_readonly
op_assign
id|SRMMU_PAGE_RDONLY
suffix:semicolon
id|page_kernel
op_assign
id|SRMMU_PAGE_KERNEL
suffix:semicolon
id|pg_iobits
op_assign
id|SRMMU_VALID
op_or
id|SRMMU_WRITE
op_or
id|SRMMU_REF
suffix:semicolon
multiline_comment|/* Functions */
id|set_pte
op_assign
id|srmmu_set_pte_cacheable
suffix:semicolon
id|init_new_context
op_assign
id|srmmu_init_new_context
suffix:semicolon
id|switch_to_context
op_assign
id|srmmu_switch_to_context
suffix:semicolon
id|pmd_align
op_assign
id|srmmu_pmd_align
suffix:semicolon
id|pgdir_align
op_assign
id|srmmu_pgdir_align
suffix:semicolon
id|vmalloc_start
op_assign
id|srmmu_vmalloc_start
suffix:semicolon
id|pte_page
op_assign
id|srmmu_pte_page
suffix:semicolon
id|pmd_page
op_assign
id|srmmu_pmd_page
suffix:semicolon
id|pgd_page
op_assign
id|srmmu_pgd_page
suffix:semicolon
id|sparc_update_rootmmu_dir
op_assign
id|srmmu_update_rootmmu_dir
suffix:semicolon
id|pte_none
op_assign
id|srmmu_pte_none
suffix:semicolon
id|pte_present
op_assign
id|srmmu_pte_present
suffix:semicolon
id|pte_clear
op_assign
id|srmmu_pte_clear
suffix:semicolon
id|pmd_none
op_assign
id|srmmu_pmd_none
suffix:semicolon
id|pmd_bad
op_assign
id|srmmu_pmd_bad
suffix:semicolon
id|pmd_present
op_assign
id|srmmu_pmd_present
suffix:semicolon
id|pmd_clear
op_assign
id|srmmu_pmd_clear
suffix:semicolon
id|pgd_none
op_assign
id|srmmu_pgd_none
suffix:semicolon
id|pgd_bad
op_assign
id|srmmu_pgd_bad
suffix:semicolon
id|pgd_present
op_assign
id|srmmu_pgd_present
suffix:semicolon
id|pgd_clear
op_assign
id|srmmu_pgd_clear
suffix:semicolon
id|mk_pte
op_assign
id|srmmu_mk_pte
suffix:semicolon
id|mk_pte_phys
op_assign
id|srmmu_mk_pte_phys
suffix:semicolon
id|pgd_set
op_assign
id|srmmu_pgd_set
suffix:semicolon
id|mk_pte_io
op_assign
id|srmmu_mk_pte_io
suffix:semicolon
id|pte_modify
op_assign
id|srmmu_pte_modify
suffix:semicolon
id|pgd_offset
op_assign
id|srmmu_pgd_offset
suffix:semicolon
id|pmd_offset
op_assign
id|srmmu_pmd_offset
suffix:semicolon
id|pte_offset
op_assign
id|srmmu_pte_offset
suffix:semicolon
id|pte_free_kernel
op_assign
id|srmmu_pte_free_kernel
suffix:semicolon
id|pmd_free_kernel
op_assign
id|srmmu_pmd_free_kernel
suffix:semicolon
id|pte_alloc_kernel
op_assign
id|srmmu_pte_alloc_kernel
suffix:semicolon
id|pmd_alloc_kernel
op_assign
id|srmmu_pmd_alloc_kernel
suffix:semicolon
id|pte_free
op_assign
id|srmmu_pte_free
suffix:semicolon
id|pte_alloc
op_assign
id|srmmu_pte_alloc
suffix:semicolon
id|pmd_free
op_assign
id|srmmu_pmd_free
suffix:semicolon
id|pmd_alloc
op_assign
id|srmmu_pmd_alloc
suffix:semicolon
id|pgd_free
op_assign
id|srmmu_pgd_free
suffix:semicolon
id|pgd_alloc
op_assign
id|srmmu_pgd_alloc
suffix:semicolon
id|pte_write
op_assign
id|srmmu_pte_write
suffix:semicolon
id|pte_dirty
op_assign
id|srmmu_pte_dirty
suffix:semicolon
id|pte_young
op_assign
id|srmmu_pte_young
suffix:semicolon
id|pte_wrprotect
op_assign
id|srmmu_pte_wrprotect
suffix:semicolon
id|pte_mkclean
op_assign
id|srmmu_pte_mkclean
suffix:semicolon
id|pte_mkold
op_assign
id|srmmu_pte_mkold
suffix:semicolon
id|pte_mkwrite
op_assign
id|srmmu_pte_mkwrite
suffix:semicolon
id|pte_mkdirty
op_assign
id|srmmu_pte_mkdirty
suffix:semicolon
id|pte_mkyoung
op_assign
id|srmmu_pte_mkyoung
suffix:semicolon
id|update_mmu_cache
op_assign
id|srmmu_update_mmu_cache
suffix:semicolon
id|destroy_context
op_assign
id|srmmu_destroy_context
suffix:semicolon
id|mmu_lockarea
op_assign
id|srmmu_lockarea
suffix:semicolon
id|mmu_unlockarea
op_assign
id|srmmu_unlockarea
suffix:semicolon
id|mmu_get_scsi_one
op_assign
id|srmmu_get_scsi_one
suffix:semicolon
id|mmu_get_scsi_sgl
op_assign
id|srmmu_get_scsi_sgl
suffix:semicolon
id|mmu_release_scsi_one
op_assign
id|srmmu_release_scsi_one
suffix:semicolon
id|mmu_release_scsi_sgl
op_assign
id|srmmu_release_scsi_sgl
suffix:semicolon
macro_line|#ifdef CONFIG_SBUS
id|mmu_map_dma_area
op_assign
id|srmmu_map_dma_area
suffix:semicolon
macro_line|#endif
id|mmu_info
op_assign
id|srmmu_mmu_info
suffix:semicolon
id|mmu_v2p
op_assign
id|srmmu_v2p
suffix:semicolon
id|mmu_p2v
op_assign
id|srmmu_p2v
suffix:semicolon
multiline_comment|/* Task struct and kernel stack allocating/freeing. */
id|alloc_task_struct
op_assign
id|srmmu_alloc_task_struct
suffix:semicolon
id|free_task_struct
op_assign
id|srmmu_free_task_struct
suffix:semicolon
id|quick_kernel_fault
op_assign
id|srmmu_quick_kernel_fault
suffix:semicolon
multiline_comment|/* SRMMU specific. */
id|ctxd_set
op_assign
id|srmmu_ctxd_set
suffix:semicolon
id|pmd_set
op_assign
id|srmmu_pmd_set
suffix:semicolon
id|get_srmmu_type
c_func
(paren
)paren
suffix:semicolon
id|patch_window_trap_handlers
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef __SMP__
multiline_comment|/* El switcheroo... */
id|local_flush_cache_all
op_assign
id|flush_cache_all
suffix:semicolon
id|local_flush_cache_mm
op_assign
id|flush_cache_mm
suffix:semicolon
id|local_flush_cache_range
op_assign
id|flush_cache_range
suffix:semicolon
id|local_flush_cache_page
op_assign
id|flush_cache_page
suffix:semicolon
id|local_flush_tlb_all
op_assign
id|flush_tlb_all
suffix:semicolon
id|local_flush_tlb_mm
op_assign
id|flush_tlb_mm
suffix:semicolon
id|local_flush_tlb_range
op_assign
id|flush_tlb_range
suffix:semicolon
id|local_flush_tlb_page
op_assign
id|flush_tlb_page
suffix:semicolon
id|local_flush_page_to_ram
op_assign
id|flush_page_to_ram
suffix:semicolon
id|local_flush_sig_insns
op_assign
id|flush_sig_insns
suffix:semicolon
id|local_flush_page_for_dma
op_assign
id|flush_page_for_dma
suffix:semicolon
id|flush_cache_all
op_assign
id|smp_flush_cache_all
suffix:semicolon
id|flush_cache_mm
op_assign
id|smp_flush_cache_mm
suffix:semicolon
id|flush_cache_range
op_assign
id|smp_flush_cache_range
suffix:semicolon
id|flush_cache_page
op_assign
id|smp_flush_cache_page
suffix:semicolon
id|flush_tlb_all
op_assign
id|smp_flush_tlb_all
suffix:semicolon
id|flush_tlb_mm
op_assign
id|smp_flush_tlb_mm
suffix:semicolon
id|flush_tlb_range
op_assign
id|smp_flush_tlb_range
suffix:semicolon
id|flush_tlb_page
op_assign
id|smp_flush_tlb_page
suffix:semicolon
id|flush_page_to_ram
op_assign
id|smp_flush_page_to_ram
suffix:semicolon
id|flush_sig_insns
op_assign
id|smp_flush_sig_insns
suffix:semicolon
id|flush_page_for_dma
op_assign
id|smp_flush_page_for_dma
suffix:semicolon
macro_line|#endif
)brace
eof
