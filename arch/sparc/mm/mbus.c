multiline_comment|/* $Id: mbus.c,v 1.9 1995/11/25 00:59:26 davem Exp $&n; * mbus.c: MBUS probing routines, called from kernel/probe.c&n; *&n; * Copyright (C) 1995 David S. Miller (davem@caip.rutgers.edu)&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/cache.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/asi.h&gt;
macro_line|#include &lt;asm/psr.h&gt;
macro_line|#include &lt;asm/vac-ops.h&gt;
macro_line|#include &lt;asm/mbus.h&gt;
multiline_comment|/* #define DEBUG_MBUS */
DECL|variable|viking_rev
DECL|variable|swift_rev
DECL|variable|cypress_rev
r_int
r_int
id|viking_rev
comma
id|swift_rev
comma
id|cypress_rev
suffix:semicolon
DECL|variable|srmmu_modtype
r_enum
id|mbus_module
id|srmmu_modtype
suffix:semicolon
DECL|variable|hwbug_bitmask
r_int
r_int
id|hwbug_bitmask
suffix:semicolon
r_void
DECL|function|probe_mbus
id|probe_mbus
c_func
(paren
r_void
)paren
(brace
r_register
r_int
r_int
id|mreg
comma
id|vaddr
suffix:semicolon
r_register
r_int
id|impl
comma
id|vers
comma
id|syscntrl
comma
id|pso
comma
id|resv
comma
id|nofault
comma
id|enable
suffix:semicolon
r_register
r_int
id|mod_typ
comma
id|mod_rev
suffix:semicolon
id|srmmu_modtype
op_assign
id|SRMMU_INVAL_MOD
suffix:semicolon
id|hwbug_bitmask
op_assign
l_int|0
suffix:semicolon
id|vaddr
op_assign
l_int|0
suffix:semicolon
id|mreg
op_assign
id|srmmu_get_mmureg
c_func
(paren
)paren
suffix:semicolon
id|impl
op_assign
(paren
id|mreg
op_amp
id|SRMMU_CTREG_IMPL_MASK
)paren
op_rshift
id|SRMMU_CTREG_IMPL_SHIFT
suffix:semicolon
id|vers
op_assign
(paren
id|mreg
op_amp
id|SRMMU_CTREG_VERS_MASK
)paren
op_rshift
id|SRMMU_CTREG_VERS_SHIFT
suffix:semicolon
id|syscntrl
op_assign
(paren
id|mreg
op_amp
id|SRMMU_CTREG_SYSCNTRL_MASK
)paren
op_rshift
id|SRMMU_CTREG_SYSCNTRL_SHIFT
suffix:semicolon
id|pso
op_assign
(paren
id|mreg
op_amp
id|SRMMU_CTREG_PSO_MASK
)paren
op_rshift
id|SRMMU_CTREG_PSO_SHIFT
suffix:semicolon
id|resv
op_assign
(paren
id|mreg
op_amp
id|SRMMU_CTREG_RESV_MASK
)paren
op_rshift
id|SRMMU_CTREG_RESV_SHIFT
suffix:semicolon
id|nofault
op_assign
(paren
id|mreg
op_amp
id|SRMMU_CTREG_NOFAULT_MASK
)paren
op_rshift
id|SRMMU_CTREG_NOFAULT_SHIFT
suffix:semicolon
id|enable
op_assign
(paren
id|mreg
op_amp
id|SRMMU_CTREG_ENABLE_MASK
)paren
op_rshift
id|SRMMU_CTREG_ENABLE_SHIFT
suffix:semicolon
macro_line|#ifdef DEBUG_MBUS
id|printk
c_func
(paren
l_string|&quot;MMU REGISTER&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;IMPL&lt;%01x&gt; VERS&lt;%01x&gt; SYSCNTRL&lt;%04x&gt; PSO&lt;%d&gt; RESV&lt;%02x&gt; NOFAULT&lt;%d&gt; ENABLE&lt;%d&gt;&bslash;n&quot;
comma
id|impl
comma
id|vers
comma
id|syscntrl
comma
(paren
r_int
)paren
id|pso
comma
id|resv
comma
(paren
r_int
)paren
id|nofault
comma
(paren
r_int
)paren
id|enable
)paren
suffix:semicolon
macro_line|#endif
id|mod_typ
op_assign
id|impl
suffix:semicolon
id|mod_rev
op_assign
id|vers
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;MBUS: &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mod_typ
op_eq
l_int|0x1
)paren
multiline_comment|/* Ross HyperSparc or Cypress */
r_if
c_cond
(paren
id|mod_rev
op_eq
l_int|0x7
)paren
(brace
id|srmmu_modtype
op_assign
id|HyperSparc
suffix:semicolon
id|hwbug_bitmask
op_or_assign
id|HWBUG_VACFLUSH_BITROT
suffix:semicolon
multiline_comment|/* Turn off Cache Wrapping and copyback caching, I don&squot;t&n;&t;&t;&t; * understand them completely yet... */
id|printk
c_func
(paren
l_string|&quot;Enabling HyperSparc features...&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* FUCK IT, I wanna see this baby chug! */
multiline_comment|/* First, flush the cache */
macro_line|#if 0
r_for
c_loop
(paren
id|vaddr
op_assign
l_int|0
suffix:semicolon
id|vaddr
op_ne
id|vac_size
suffix:semicolon
id|vaddr
op_add_assign
id|vac_linesize
)paren
(brace
id|flush_ei_ctx
c_func
(paren
id|vaddr
)paren
suffix:semicolon
)brace
macro_line|#endif
id|mreg
op_and_assign
(paren
op_complement
id|HYPERSPARC_CWENABLE
)paren
suffix:semicolon
id|mreg
op_and_assign
(paren
op_complement
id|HYPERSPARC_CMODE
)paren
suffix:semicolon
id|mreg
op_and_assign
(paren
op_complement
id|HYPERSPARC_WBENABLE
)paren
suffix:semicolon
id|mreg
op_or_assign
(paren
id|HYPERSPARC_CENABLE
)paren
suffix:semicolon
id|srmmu_set_mmureg
c_func
(paren
id|mreg
)paren
suffix:semicolon
multiline_comment|/* Clear all the cache tags */
macro_line|#if 0
r_for
c_loop
(paren
id|vaddr
op_assign
l_int|0
suffix:semicolon
id|vaddr
op_ne
id|vac_size
suffix:semicolon
id|vaddr
op_add_assign
id|vac_linesize
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;sta %%g0, [%0] %1&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|vaddr
)paren
comma
l_string|&quot;i&quot;
(paren
l_int|0xe
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Flush the ICACHE */
id|flush_whole_icache
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|cypress_rev
op_assign
id|mod_rev
suffix:semicolon
r_if
c_cond
(paren
id|mod_rev
op_eq
l_int|0xe
)paren
(brace
id|srmmu_modtype
op_assign
id|Cypress_vE
suffix:semicolon
id|hwbug_bitmask
op_or_assign
id|HWBUG_COPYBACK_BROKEN
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mod_rev
op_eq
l_int|0xd
)paren
(brace
id|srmmu_modtype
op_assign
id|Cypress_vD
suffix:semicolon
id|hwbug_bitmask
op_or_assign
id|HWBUG_ASIFLUSH_BROKEN
suffix:semicolon
)brace
r_else
id|srmmu_modtype
op_assign
id|Cypress
suffix:semicolon
multiline_comment|/* It is a Cypress module */
id|printk
c_func
(paren
l_string|&quot;ROSS Cypress Module %s&bslash;n&quot;
comma
(paren
id|srmmu_modtype
op_eq
id|Cypress_vE
ques
c_cond
l_string|&quot;Rev. E&quot;
suffix:colon
(paren
id|srmmu_modtype
op_eq
id|Cypress_vD
ques
c_cond
l_string|&quot;Rev. D&quot;
suffix:colon
l_string|&quot;&quot;
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* Enable Cypress features */
id|printk
c_func
(paren
l_string|&quot;Enabling Cypress features...&bslash;n&quot;
)paren
suffix:semicolon
id|mreg
op_and_assign
(paren
op_complement
id|CYPRESS_CMODE
)paren
suffix:semicolon
id|mreg
op_or_assign
(paren
id|CYPRESS_CENABLE
)paren
suffix:semicolon
id|srmmu_set_mmureg
c_func
(paren
id|mreg
)paren
suffix:semicolon
multiline_comment|/* Maybe play with Cypress 604/605 cache stuff here? */
)brace
r_if
c_cond
(paren
(paren
(paren
id|get_psr
c_func
(paren
)paren
op_rshift
l_int|0x18
)paren
op_amp
l_int|0xff
)paren
op_eq
l_int|0x04
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;lda [%1] %2, %0&bslash;n&bslash;t&quot;
l_string|&quot;srl %0, 0x18, %0&bslash;n&bslash;t&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|swift_rev
)paren
suffix:colon
l_string|&quot;r&quot;
(paren
l_int|0x10003000
)paren
comma
l_string|&quot;i&quot;
(paren
l_int|0x20
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Fujitsu MB86904 or higher Swift module&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* MB86905 etc. */
r_switch
c_cond
(paren
id|swift_rev
)paren
(brace
r_case
l_int|0x11
suffix:colon
r_case
l_int|0x20
suffix:colon
r_case
l_int|0x23
suffix:colon
r_case
l_int|0x30
suffix:colon
id|srmmu_modtype
op_assign
id|Swift_lots_o_bugs
suffix:semicolon
id|hwbug_bitmask
op_or_assign
id|HWBUG_KERN_ACCBROKEN
suffix:semicolon
id|hwbug_bitmask
op_or_assign
id|HWBUG_KERN_CBITBROKEN
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Detected Swift with Lots &squot;o&squot; Bugs&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x25
suffix:colon
r_case
l_int|0x31
suffix:colon
id|srmmu_modtype
op_assign
id|Swift_bad_c
suffix:semicolon
id|hwbug_bitmask
op_or_assign
id|HWBUG_KERN_CBITBROKEN
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Detected Swift with kernel pte C bit bug&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|srmmu_modtype
op_assign
id|Swift_ok
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Detected Swift with no bugs...&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Enable Fujitsu Swift specific features here... */
id|printk
c_func
(paren
l_string|&quot;Enabling Swift features...&bslash;n&quot;
)paren
suffix:semicolon
id|mreg
op_or_assign
l_int|0
suffix:semicolon
id|srmmu_set_mmureg
c_func
(paren
id|mreg
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
(paren
id|get_psr
c_func
(paren
)paren
op_rshift
l_int|0x18
)paren
op_amp
l_int|0xff
)paren
op_eq
l_int|0x40
op_logical_or
(paren
(paren
(paren
id|get_psr
c_func
(paren
)paren
op_rshift
l_int|0x18
)paren
op_amp
l_int|0xff
)paren
op_eq
l_int|0x41
op_logical_and
id|mod_typ
op_eq
l_int|0
op_logical_and
id|mod_rev
op_eq
l_int|0
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|get_psr
c_func
(paren
)paren
op_rshift
l_int|0x18
)paren
op_amp
l_int|0xf
)paren
op_eq
l_int|0
op_logical_and
id|mod_rev
op_eq
l_int|0
)paren
(brace
id|srmmu_modtype
op_assign
id|Viking_12
suffix:semicolon
id|hwbug_bitmask
op_or_assign
id|HWBUG_MODIFIED_BITROT
suffix:semicolon
id|hwbug_bitmask
op_or_assign
id|HWBUG_PC_BADFAULT_ADDR
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
(paren
id|get_psr
c_func
(paren
)paren
op_rshift
l_int|0x18
)paren
op_amp
l_int|0xf
)paren
op_ne
l_int|0
)paren
(brace
id|srmmu_modtype
op_assign
id|Viking_2x
suffix:semicolon
id|hwbug_bitmask
op_or_assign
id|HWBUG_PC_BADFAULT_ADDR
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mod_rev
op_eq
l_int|1
)paren
(brace
id|srmmu_modtype
op_assign
id|Viking_30
suffix:semicolon
id|hwbug_bitmask
op_or_assign
id|HWBUG_PACINIT_BITROT
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|mod_rev
OL
l_int|8
)paren
id|srmmu_modtype
op_assign
id|Viking_35
suffix:semicolon
r_else
id|srmmu_modtype
op_assign
id|Viking_new
suffix:semicolon
)brace
)brace
multiline_comment|/* SPARCclassic&squot;s STP1010 may be produced under other name */
id|printk
c_func
(paren
l_string|&quot;VIKING Module&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Enabling Viking features...&bslash;n&quot;
)paren
suffix:semicolon
id|mreg
op_or_assign
(paren
id|VIKING_DCENABLE
op_or
id|VIKING_ICENABLE
op_or
id|VIKING_SBENABLE
op_or
id|VIKING_TCENABLE
op_or
id|VIKING_DPENABLE
)paren
suffix:semicolon
id|srmmu_set_mmureg
c_func
(paren
id|mreg
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
(paren
id|get_psr
c_func
(paren
)paren
op_rshift
l_int|0x18
)paren
op_amp
l_int|0xff
)paren
op_eq
l_int|0x41
)paren
op_logical_and
(paren
id|mod_typ
op_logical_or
id|mod_rev
)paren
)paren
(brace
id|srmmu_modtype
op_assign
id|Tsunami
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Tsunami module&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Enable Tsunami features */
)brace
r_if
c_cond
(paren
id|srmmu_modtype
op_eq
id|SRMMU_INVAL_MOD
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Unknown SRMMU module type!&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;MMU_CREG: impl=%x vers=%x&bslash;n&quot;
comma
id|mod_typ
comma
id|mod_rev
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PSR: impl=%x vers=%x&bslash;n&quot;
comma
(paren
(paren
id|get_psr
c_func
(paren
)paren
op_rshift
l_int|28
)paren
op_amp
l_int|0xf
)paren
comma
(paren
(paren
id|get_psr
c_func
(paren
)paren
op_rshift
l_int|24
)paren
op_amp
l_int|0xf
)paren
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;probe_mbus()&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* AIEEE, should get this from the prom... */
id|printk
c_func
(paren
l_string|&quot;Boot processor ID %d Module ID %d (%s MBUS)&bslash;n&quot;
comma
id|get_cpuid
c_func
(paren
)paren
comma
id|get_modid
c_func
(paren
)paren
comma
(paren
id|get_modid
c_func
(paren
)paren
op_eq
l_int|0x8
ques
c_cond
l_string|&quot;Level 1&quot;
suffix:colon
l_string|&quot;Level 2&quot;
)paren
)paren
suffix:semicolon
)brace
eof
