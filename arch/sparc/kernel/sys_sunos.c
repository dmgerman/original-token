multiline_comment|/* $Id: sys_sunos.c,v 1.33 1996/03/01 07:16:00 davem Exp $&n; * sys_sunos.c: SunOS specific syscall compatibility support.&n; *&n; * Copyright (C) 1995 David S. Miller (davem@caip.rutgers.edu)&n; * Copyright (C) 1995 Miguel de Icaza (miguel@nuclecu.unam.mx)&n; *&n; * Based upon preliminary work which is:&n; *&n; * Copyright (C) 1995 Adrian M. Rodriguez (adrian@remus.rutgers.edu)&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/mman.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/swap.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/resource.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/uio.h&gt;
macro_line|#include &lt;linux/utsname.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/pconf.h&gt;
macro_line|#include &lt;asm/idprom.h&gt; /* for gethostid() */
macro_line|#include &lt;asm/unistd.h&gt;
multiline_comment|/* For the nfs mount emulation */
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/nfs.h&gt;
macro_line|#include &lt;linux/nfs_mount.h&gt;
multiline_comment|/* for sunos_select */
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/personality.h&gt;
DECL|function|get_sparc_unmapped_area
r_static
r_int
r_int
id|get_sparc_unmapped_area
c_func
(paren
r_int
r_int
id|len
)paren
(brace
r_int
r_int
id|addr
op_assign
l_int|0xE8000000UL
suffix:semicolon
r_struct
id|vm_area_struct
op_star
id|vmm
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|TASK_SIZE
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|vmm
op_assign
id|find_vma
c_func
(paren
id|current
comma
id|addr
)paren
suffix:semicolon
suffix:semicolon
id|vmm
op_assign
id|vmm-&gt;vm_next
)paren
(brace
multiline_comment|/* At this point:  (!vmm || addr &lt; vmm-&gt;vm_end). */
r_if
c_cond
(paren
id|TASK_SIZE
op_minus
id|len
OL
id|addr
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vmm
op_logical_or
id|addr
op_plus
id|len
op_le
id|vmm-&gt;vm_start
)paren
r_return
id|addr
suffix:semicolon
id|addr
op_assign
id|vmm-&gt;vm_end
suffix:semicolon
)brace
)brace
multiline_comment|/* We use the SunOS mmap() semantics. */
DECL|function|sunos_mmap
id|asmlinkage
r_int
r_int
id|sunos_mmap
c_func
(paren
r_int
r_int
id|addr
comma
r_int
r_int
id|len
comma
r_int
r_int
id|prot
comma
r_int
r_int
id|flags
comma
r_int
r_int
id|fd
comma
r_int
r_int
id|off
)paren
(brace
r_struct
id|file
op_star
id|file
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|retval
comma
id|ret_type
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|MAP_NORESERVE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: unimplemented SunOS MAP_NORESERVE mmap() flag&bslash;n&quot;
comma
id|current-&gt;comm
)paren
suffix:semicolon
id|flags
op_and_assign
op_complement
id|MAP_NORESERVE
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|flags
op_amp
id|MAP_ANONYMOUS
)paren
)paren
r_if
c_cond
(paren
id|fd
op_ge
id|NR_OPEN
op_logical_or
op_logical_neg
(paren
id|file
op_assign
id|current-&gt;files-&gt;fd
(braket
id|fd
)braket
)paren
)paren
r_return
op_minus
id|EBADF
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|flags
op_amp
id|MAP_FIXED
)paren
op_logical_and
op_logical_neg
id|addr
)paren
(brace
id|addr
op_assign
id|get_sparc_unmapped_area
c_func
(paren
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
multiline_comment|/* If this is ld.so or a shared library doing an mmap&n;&t; * of /dev/zero, transform it into an anonymous mapping.&n;&t; * SunOS is so stupid some times... hmph!&n;&t; */
r_if
c_cond
(paren
id|MAJOR
c_func
(paren
id|file-&gt;f_inode-&gt;i_rdev
)paren
op_eq
id|MEM_MAJOR
op_logical_and
id|MINOR
c_func
(paren
id|file-&gt;f_inode-&gt;i_rdev
)paren
op_eq
l_int|5
)paren
(brace
id|flags
op_or_assign
id|MAP_ANONYMOUS
suffix:semicolon
id|file
op_assign
l_int|0
suffix:semicolon
)brace
id|ret_type
op_assign
id|flags
op_amp
id|_MAP_NEW
suffix:semicolon
id|flags
op_and_assign
op_complement
id|_MAP_NEW
suffix:semicolon
id|retval
op_assign
id|do_mmap
c_func
(paren
id|file
comma
id|addr
comma
id|len
comma
id|prot
comma
id|flags
comma
id|off
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret_type
)paren
(brace
r_return
id|retval
suffix:semicolon
)brace
r_else
r_return
(paren
(paren
id|retval
OL
id|KERNBASE
)paren
ques
c_cond
l_int|0
suffix:colon
id|retval
)paren
suffix:semicolon
)brace
multiline_comment|/* lmbench calls this, just say &quot;yeah, ok&quot; */
DECL|function|sunos_mctl
id|asmlinkage
r_int
id|sunos_mctl
c_func
(paren
r_int
r_int
id|addr
comma
r_int
r_int
id|len
comma
r_int
id|function
comma
r_char
op_star
id|arg
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* SunOS is completely broken... it returns 0 on success, otherwise&n; * ENOMEM.  For sys_sbrk() it wants the new brk value as a return&n; * on success and ENOMEM as before on failure.&n; */
DECL|function|sunos_brk
id|asmlinkage
r_int
id|sunos_brk
c_func
(paren
r_int
r_int
id|brk
)paren
(brace
r_int
id|freepages
suffix:semicolon
r_int
r_int
id|rlim
suffix:semicolon
r_int
r_int
id|newbrk
comma
id|oldbrk
suffix:semicolon
r_if
c_cond
(paren
id|brk
OL
id|current-&gt;mm-&gt;end_code
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|newbrk
op_assign
id|PAGE_ALIGN
c_func
(paren
id|brk
)paren
suffix:semicolon
id|oldbrk
op_assign
id|PAGE_ALIGN
c_func
(paren
id|current-&gt;mm-&gt;brk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|oldbrk
op_eq
id|newbrk
)paren
(brace
id|current-&gt;mm-&gt;brk
op_assign
id|brk
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Always allow shrinking brk&n;&t; */
r_if
c_cond
(paren
id|brk
op_le
id|current-&gt;mm-&gt;brk
)paren
(brace
id|current-&gt;mm-&gt;brk
op_assign
id|brk
suffix:semicolon
id|do_munmap
c_func
(paren
id|newbrk
comma
id|oldbrk
op_minus
id|newbrk
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Check against rlimit and stack..&n;&t; */
id|rlim
op_assign
id|current-&gt;rlim
(braket
id|RLIMIT_DATA
)braket
dot
id|rlim_cur
suffix:semicolon
r_if
c_cond
(paren
id|rlim
op_ge
id|RLIM_INFINITY
)paren
id|rlim
op_assign
op_complement
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|brk
op_minus
id|current-&gt;mm-&gt;end_code
OG
id|rlim
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/*&n;&t; * Check against existing mmap mappings.&n;&t; */
r_if
c_cond
(paren
id|find_vma_intersection
c_func
(paren
id|current
comma
id|oldbrk
comma
id|newbrk
op_plus
id|PAGE_SIZE
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/*&n;&t; * stupid algorithm to decide if we have enough memory: while&n;&t; * simple, it hopefully works in most obvious cases.. Easy to&n;&t; * fool it, but this should catch most mistakes.&n;&t; */
id|freepages
op_assign
id|buffermem
op_rshift
l_int|12
suffix:semicolon
id|freepages
op_add_assign
id|nr_free_pages
suffix:semicolon
id|freepages
op_add_assign
id|nr_swap_pages
suffix:semicolon
id|freepages
op_sub_assign
id|MAP_NR
c_func
(paren
id|high_memory
)paren
op_rshift
l_int|4
suffix:semicolon
id|freepages
op_sub_assign
(paren
id|newbrk
op_minus
id|oldbrk
)paren
op_rshift
l_int|12
suffix:semicolon
r_if
c_cond
(paren
id|freepages
OL
l_int|0
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/*&n;&t; * Ok, we have probably got enough memory - let it rip.&n;&t; */
id|current-&gt;mm-&gt;brk
op_assign
id|brk
suffix:semicolon
id|do_mmap
c_func
(paren
l_int|NULL
comma
id|oldbrk
comma
id|newbrk
op_minus
id|oldbrk
comma
id|PROT_READ
op_or
id|PROT_WRITE
op_or
id|PROT_EXEC
comma
id|MAP_FIXED
op_or
id|MAP_PRIVATE
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sunos_sbrk
id|asmlinkage
r_int
r_int
id|sunos_sbrk
c_func
(paren
r_int
id|increment
)paren
(brace
r_int
id|error
suffix:semicolon
multiline_comment|/* This should do it hopefully... */
id|error
op_assign
id|sunos_brk
c_func
(paren
(paren
(paren
r_int
)paren
id|current-&gt;mm-&gt;brk
)paren
op_plus
id|increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
r_return
id|error
suffix:semicolon
)brace
r_else
r_return
id|current-&gt;mm-&gt;brk
suffix:semicolon
)brace
multiline_comment|/* XXX Completely undocumented, and completely magic...&n; * XXX I believe it is to increase the size of the stack by&n; * XXX argument &squot;increment&squot; and return the new end of stack&n; * XXX area.  Wheee...&n; */
DECL|function|sunos_sstk
id|asmlinkage
r_int
r_int
id|sunos_sstk
c_func
(paren
r_int
id|increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Call to sunos_sstk(increment&lt;%d&gt;) is unsupported&bslash;n&quot;
comma
id|current-&gt;comm
comma
id|increment
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Give hints to the kernel as to what paging strategy to use...&n; * Completely bogus, don&squot;t remind me.&n; */
DECL|macro|VA_NORMAL
mdefine_line|#define VA_NORMAL     0 /* Normal vm usage expected */
DECL|macro|VA_ABNORMAL
mdefine_line|#define VA_ABNORMAL   1 /* Abnormal/random vm usage probable */
DECL|macro|VA_SEQUENTIAL
mdefine_line|#define VA_SEQUENTIAL 2 /* Accesses will be of a sequential nature */
DECL|macro|VA_INVALIDATE
mdefine_line|#define VA_INVALIDATE 3 /* Page table entries should be flushed ??? */
DECL|variable|vstrings
r_static
r_char
op_star
id|vstrings
(braket
)braket
op_assign
(brace
l_string|&quot;VA_NORMAL&quot;
comma
l_string|&quot;VA_ABNORMAL&quot;
comma
l_string|&quot;VA_SEQUENTIAL&quot;
comma
l_string|&quot;VA_INVALIDATE&quot;
comma
)brace
suffix:semicolon
DECL|function|sunos_vadvise
id|asmlinkage
r_void
id|sunos_vadvise
c_func
(paren
r_int
r_int
id|strategy
)paren
(brace
multiline_comment|/* I wanna see who uses this... */
id|printk
c_func
(paren
l_string|&quot;%s: Advises us to use %s paging strategy&bslash;n&quot;
comma
id|current-&gt;comm
comma
id|strategy
op_le
l_int|3
ques
c_cond
id|vstrings
(braket
id|strategy
)braket
suffix:colon
l_string|&quot;BOGUS&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* We don&squot;t do diddly... */
)brace
multiline_comment|/* Same as vadvise, and just as bogus, but for a range of virtual&n; * process address space.&n; */
DECL|macro|MADV_NORMAL
mdefine_line|#define MADV_NORMAL      0 /* Nothing special... */
DECL|macro|MADV_RANDOM
mdefine_line|#define MADV_RANDOM      1 /* I am emacs... */
DECL|macro|MADV_SEQUENTIAL
mdefine_line|#define MADV_SEQUENTIAL  2 /* I am researcher code... */
DECL|macro|MADV_WILLNEED
mdefine_line|#define MADV_WILLNEED    3 /* Pages in this range will be needed */
DECL|macro|MADV_DONTNEED
mdefine_line|#define MADV_DONTNEED    4 /* Pages in this range won&squot;t be needed */
DECL|variable|mstrings
r_static
r_char
op_star
id|mstrings
(braket
)braket
op_assign
(brace
l_string|&quot;MADV_NORMAL&quot;
comma
l_string|&quot;MADV_RANDOM&quot;
comma
l_string|&quot;MADV_SEQUENTIAL&quot;
comma
l_string|&quot;MADV_WILLNEED&quot;
comma
l_string|&quot;MADV_DONTNEED&quot;
comma
)brace
suffix:semicolon
DECL|function|sunos_madvise
id|asmlinkage
r_void
id|sunos_madvise
c_func
(paren
r_int
r_int
id|address
comma
r_int
r_int
id|len
comma
r_int
r_int
id|strategy
)paren
(brace
multiline_comment|/* I wanna see who uses this... */
id|printk
c_func
(paren
l_string|&quot;%s: Advises us to use %s paging strategy for addr&lt;%08lx&gt; len&lt;%08lx&gt;&bslash;n&quot;
comma
id|current-&gt;comm
comma
id|strategy
op_le
l_int|4
ques
c_cond
id|mstrings
(braket
id|strategy
)braket
suffix:colon
l_string|&quot;BOGUS&quot;
comma
id|address
comma
id|len
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* We don&squot;t do diddly... */
)brace
multiline_comment|/* Places into character array, the status of all the pages in the passed&n; * range from &squot;addr&squot; to &squot;addr + len&squot;.  -1 on failure, 0 on success...&n; * The encoding in each character is:&n; * low-bit is zero == Page is not in physical ram right now&n; * low-bit is one  == Page is currently residing in core&n; * All other bits are undefined within the character so there...&n; * Also, if you try to get stats on an area outside of the user vm area&n; * *or* the passed base address is not aligned on a page boundary you&n; * get an error.&n; */
DECL|function|sunos_mincore
id|asmlinkage
r_int
id|sunos_mincore
c_func
(paren
r_int
r_int
id|addr
comma
r_int
r_int
id|len
comma
r_char
op_star
id|array
)paren
(brace
id|pgd_t
op_star
id|pgdp
suffix:semicolon
id|pmd_t
op_star
id|pmdp
suffix:semicolon
id|pte_t
op_star
id|ptep
suffix:semicolon
r_int
r_int
id|limit
suffix:semicolon
r_int
id|num_pages
comma
id|pnum
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|num_pages
op_assign
(paren
id|len
op_div
id|PAGE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|array
comma
id|num_pages
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* bum array, you lose... */
r_if
c_cond
(paren
(paren
id|addr
op_ge
id|KERNBASE
)paren
op_logical_or
(paren
(paren
id|addr
op_plus
id|len
)paren
OG
id|KERNBASE
)paren
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* I&squot;m sure you&squot;re curious about kernel mappings.. */
multiline_comment|/* Wheee, go through pte&squot;s */
id|pnum
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|limit
op_assign
id|addr
op_plus
id|len
suffix:semicolon
id|addr
OL
id|limit
suffix:semicolon
id|addr
op_add_assign
id|PAGE_SIZE
comma
id|pnum
op_increment
)paren
(brace
id|pgdp
op_assign
id|pgd_offset
c_func
(paren
id|current-&gt;mm
comma
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pgd_none
c_func
(paren
op_star
id|pgdp
)paren
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* As per SunOS manpage */
id|pmdp
op_assign
id|pmd_offset
c_func
(paren
id|pgdp
comma
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pmd_none
c_func
(paren
op_star
id|pmdp
)paren
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* As per SunOS manpage */
id|ptep
op_assign
id|pte_offset
c_func
(paren
id|pmdp
comma
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pte_none
c_func
(paren
op_star
id|ptep
)paren
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* As per SunOS manpage */
multiline_comment|/* Page in core or Swapped page? */
id|array
(braket
id|pnum
)braket
op_assign
id|pte_present
c_func
(paren
op_star
id|ptep
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Success... I think... */
)brace
multiline_comment|/* This just wants the soft limit (ie. rlim_cur element) of the RLIMIT_NOFILE&n; * resource limit and is for backwards compatibility with older sunos&n; * revs.&n; */
DECL|function|sunos_getdtablesize
id|asmlinkage
r_int
id|sunos_getdtablesize
c_func
(paren
r_void
)paren
(brace
r_return
id|NR_OPEN
suffix:semicolon
)brace
DECL|macro|_S
mdefine_line|#define _S(nr) (1&lt;&lt;((nr)-1))
DECL|macro|_BLOCKABLE
mdefine_line|#define _BLOCKABLE (~(_S(SIGKILL) | _S(SIGSTOP)))
DECL|function|sunos_sigblock
id|asmlinkage
r_int
r_int
id|sunos_sigblock
c_func
(paren
r_int
r_int
id|blk_mask
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|old
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|old
op_assign
id|current-&gt;blocked
suffix:semicolon
id|current-&gt;blocked
op_or_assign
(paren
id|blk_mask
op_amp
id|_BLOCKABLE
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|old
suffix:semicolon
)brace
DECL|function|sunos_sigsetmask
id|asmlinkage
r_int
r_int
id|sunos_sigsetmask
c_func
(paren
r_int
r_int
id|newmask
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|retval
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|retval
op_assign
id|current-&gt;blocked
suffix:semicolon
id|current-&gt;blocked
op_assign
id|newmask
op_amp
id|_BLOCKABLE
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* SunOS getdents is very similar to the newer Linux (iBCS2 compliant)    */
multiline_comment|/* getdents system call, the format of the structure just has a different */
multiline_comment|/* layout (d_off+d_ino instead of d_ino+d_off) */
DECL|struct|sunos_dirent
r_struct
id|sunos_dirent
(brace
DECL|member|d_off
r_int
id|d_off
suffix:semicolon
DECL|member|d_ino
r_int
r_int
id|d_ino
suffix:semicolon
DECL|member|d_reclen
r_int
r_int
id|d_reclen
suffix:semicolon
DECL|member|d_namlen
r_int
r_int
id|d_namlen
suffix:semicolon
DECL|member|d_name
r_char
id|d_name
(braket
l_int|1
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|sunos_dirent_callback
r_struct
id|sunos_dirent_callback
(brace
DECL|member|curr
r_struct
id|sunos_dirent
op_star
id|curr
suffix:semicolon
DECL|member|previous
r_struct
id|sunos_dirent
op_star
id|previous
suffix:semicolon
DECL|member|count
r_int
id|count
suffix:semicolon
DECL|member|error
r_int
id|error
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|NAME_OFFSET
mdefine_line|#define NAME_OFFSET(de) ((int) ((de)-&gt;d_name - (char *) (de)))
DECL|macro|ROUND_UP
mdefine_line|#define ROUND_UP(x) (((x)+sizeof(long)-1) &amp; ~(sizeof(long)-1))
DECL|function|sunos_filldir
r_static
r_int
id|sunos_filldir
c_func
(paren
r_void
op_star
id|__buf
comma
r_const
r_char
op_star
id|name
comma
r_int
id|namlen
comma
id|off_t
id|offset
comma
id|ino_t
id|ino
)paren
(brace
r_struct
id|sunos_dirent
op_star
id|dirent
suffix:semicolon
r_struct
id|sunos_dirent_callback
op_star
id|buf
op_assign
(paren
r_struct
id|sunos_dirent_callback
op_star
)paren
id|__buf
suffix:semicolon
r_int
id|reclen
op_assign
id|ROUND_UP
c_func
(paren
id|NAME_OFFSET
c_func
(paren
id|dirent
)paren
op_plus
id|namlen
op_plus
l_int|1
)paren
suffix:semicolon
id|buf-&gt;error
op_assign
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* only used if we fail.. */
r_if
c_cond
(paren
id|reclen
OG
id|buf-&gt;count
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dirent
op_assign
id|buf-&gt;previous
suffix:semicolon
r_if
c_cond
(paren
id|dirent
)paren
id|put_user
c_func
(paren
id|offset
comma
op_amp
id|dirent-&gt;d_off
)paren
suffix:semicolon
id|dirent
op_assign
id|buf-&gt;curr
suffix:semicolon
id|buf-&gt;previous
op_assign
id|dirent
suffix:semicolon
id|put_user
c_func
(paren
id|ino
comma
op_amp
id|dirent-&gt;d_ino
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|namlen
comma
op_amp
id|dirent-&gt;d_namlen
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|reclen
comma
op_amp
id|dirent-&gt;d_reclen
)paren
suffix:semicolon
id|memcpy_tofs
c_func
(paren
id|dirent-&gt;d_name
comma
id|name
comma
id|namlen
)paren
suffix:semicolon
id|put_user
c_func
(paren
l_int|0
comma
id|dirent-&gt;d_name
op_plus
id|namlen
)paren
suffix:semicolon
(paren
(paren
r_char
op_star
)paren
id|dirent
)paren
op_add_assign
id|reclen
suffix:semicolon
id|buf-&gt;curr
op_assign
id|dirent
suffix:semicolon
id|buf-&gt;count
op_sub_assign
id|reclen
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sunos_getdents
id|asmlinkage
r_int
id|sunos_getdents
c_func
(paren
r_int
r_int
id|fd
comma
r_void
op_star
id|dirent
comma
r_int
id|cnt
)paren
(brace
r_struct
id|file
op_star
id|file
suffix:semicolon
r_struct
id|sunos_dirent
op_star
id|lastdirent
suffix:semicolon
r_struct
id|sunos_dirent_callback
id|buf
suffix:semicolon
r_int
id|error
suffix:semicolon
r_if
c_cond
(paren
id|fd
op_ge
id|NR_OPEN
op_logical_or
op_logical_neg
(paren
id|file
op_assign
id|current-&gt;files-&gt;fd
(braket
id|fd
)braket
)paren
)paren
r_return
op_minus
id|EBADF
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|file-&gt;f_op
op_logical_or
op_logical_neg
id|file-&gt;f_op-&gt;readdir
)paren
r_return
op_minus
id|ENOTDIR
suffix:semicolon
r_if
c_cond
(paren
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|dirent
comma
id|cnt
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cnt
OL
(paren
r_sizeof
(paren
r_struct
id|sunos_dirent
)paren
op_plus
l_int|255
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|buf.curr
op_assign
(paren
r_struct
id|sunos_dirent
op_star
)paren
id|dirent
suffix:semicolon
id|buf.previous
op_assign
l_int|NULL
suffix:semicolon
id|buf.count
op_assign
id|cnt
suffix:semicolon
id|buf.error
op_assign
l_int|0
suffix:semicolon
id|error
op_assign
id|file-&gt;f_op
op_member_access_from_pointer
id|readdir
c_func
(paren
id|file-&gt;f_inode
comma
id|file
comma
op_amp
id|buf
comma
id|sunos_filldir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
r_return
id|error
suffix:semicolon
id|lastdirent
op_assign
id|buf.previous
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lastdirent
)paren
r_return
id|buf.error
suffix:semicolon
id|put_user
c_func
(paren
id|file-&gt;f_pos
comma
op_amp
id|lastdirent-&gt;d_off
)paren
suffix:semicolon
r_return
id|cnt
op_minus
id|buf.count
suffix:semicolon
)brace
multiline_comment|/* Old sunos getdirentries, severely broken compatibility stuff here. */
DECL|struct|sunos_direntry
r_struct
id|sunos_direntry
(brace
DECL|member|d_ino
r_int
r_int
id|d_ino
suffix:semicolon
DECL|member|d_reclen
r_int
r_int
id|d_reclen
suffix:semicolon
DECL|member|d_namlen
r_int
r_int
id|d_namlen
suffix:semicolon
DECL|member|d_name
r_char
id|d_name
(braket
l_int|1
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|sunos_direntry_callback
r_struct
id|sunos_direntry_callback
(brace
DECL|member|curr
r_struct
id|sunos_direntry
op_star
id|curr
suffix:semicolon
DECL|member|previous
r_struct
id|sunos_direntry
op_star
id|previous
suffix:semicolon
DECL|member|count
r_int
id|count
suffix:semicolon
DECL|member|error
r_int
id|error
suffix:semicolon
)brace
suffix:semicolon
DECL|function|sunos_filldirentry
r_static
r_int
id|sunos_filldirentry
c_func
(paren
r_void
op_star
id|__buf
comma
r_const
r_char
op_star
id|name
comma
r_int
id|namlen
comma
id|off_t
id|offset
comma
id|ino_t
id|ino
)paren
(brace
r_struct
id|sunos_direntry
op_star
id|dirent
suffix:semicolon
r_struct
id|sunos_direntry_callback
op_star
id|buf
op_assign
(paren
r_struct
id|sunos_direntry_callback
op_star
)paren
id|__buf
suffix:semicolon
r_int
id|reclen
op_assign
id|ROUND_UP
c_func
(paren
id|NAME_OFFSET
c_func
(paren
id|dirent
)paren
op_plus
id|namlen
op_plus
l_int|1
)paren
suffix:semicolon
id|buf-&gt;error
op_assign
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* only used if we fail.. */
r_if
c_cond
(paren
id|reclen
OG
id|buf-&gt;count
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dirent
op_assign
id|buf-&gt;previous
suffix:semicolon
id|dirent
op_assign
id|buf-&gt;curr
suffix:semicolon
id|buf-&gt;previous
op_assign
id|dirent
suffix:semicolon
id|put_user
c_func
(paren
id|ino
comma
op_amp
id|dirent-&gt;d_ino
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|namlen
comma
op_amp
id|dirent-&gt;d_namlen
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|reclen
comma
op_amp
id|dirent-&gt;d_reclen
)paren
suffix:semicolon
id|memcpy_tofs
c_func
(paren
id|dirent-&gt;d_name
comma
id|name
comma
id|namlen
)paren
suffix:semicolon
id|put_user
c_func
(paren
l_int|0
comma
id|dirent-&gt;d_name
op_plus
id|namlen
)paren
suffix:semicolon
(paren
(paren
r_char
op_star
)paren
id|dirent
)paren
op_add_assign
id|reclen
suffix:semicolon
id|buf-&gt;curr
op_assign
id|dirent
suffix:semicolon
id|buf-&gt;count
op_sub_assign
id|reclen
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sunos_getdirentries
id|asmlinkage
r_int
id|sunos_getdirentries
c_func
(paren
r_int
r_int
id|fd
comma
r_void
op_star
id|dirent
comma
r_int
id|cnt
comma
r_int
r_int
op_star
id|basep
)paren
(brace
r_struct
id|file
op_star
id|file
suffix:semicolon
r_struct
id|sunos_direntry
op_star
id|lastdirent
suffix:semicolon
r_struct
id|sunos_direntry_callback
id|buf
suffix:semicolon
r_int
id|error
suffix:semicolon
r_if
c_cond
(paren
id|fd
op_ge
id|NR_OPEN
op_logical_or
op_logical_neg
(paren
id|file
op_assign
id|current-&gt;files-&gt;fd
(braket
id|fd
)braket
)paren
)paren
r_return
op_minus
id|EBADF
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|file-&gt;f_op
op_logical_or
op_logical_neg
id|file-&gt;f_op-&gt;readdir
)paren
r_return
op_minus
id|ENOTDIR
suffix:semicolon
r_if
c_cond
(paren
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|dirent
comma
id|cnt
)paren
op_logical_or
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|basep
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cnt
OL
(paren
r_sizeof
(paren
r_struct
id|sunos_direntry
)paren
op_plus
l_int|255
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|buf.curr
op_assign
(paren
r_struct
id|sunos_direntry
op_star
)paren
id|dirent
suffix:semicolon
id|buf.previous
op_assign
l_int|NULL
suffix:semicolon
id|buf.count
op_assign
id|cnt
suffix:semicolon
id|buf.error
op_assign
l_int|0
suffix:semicolon
id|error
op_assign
id|file-&gt;f_op
op_member_access_from_pointer
id|readdir
c_func
(paren
id|file-&gt;f_inode
comma
id|file
comma
op_amp
id|buf
comma
id|sunos_filldirentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
r_return
id|error
suffix:semicolon
id|lastdirent
op_assign
id|buf.previous
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lastdirent
)paren
r_return
id|buf.error
suffix:semicolon
id|put_user
c_func
(paren
id|file-&gt;f_pos
comma
id|basep
)paren
suffix:semicolon
r_return
id|cnt
op_minus
id|buf.count
suffix:semicolon
)brace
DECL|function|sunos_getdomainname
id|asmlinkage
r_int
id|sunos_getdomainname
c_func
(paren
r_char
op_star
id|name
comma
r_int
id|len
)paren
(brace
r_int
id|error
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|__NEW_UTS_LEN
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|name
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|memcpy_tofs
c_func
(paren
id|name
comma
id|system_utsname.domainname
comma
id|len
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|struct|sunos_utsname
r_struct
id|sunos_utsname
(brace
DECL|member|sname
r_char
id|sname
(braket
l_int|9
)braket
suffix:semicolon
DECL|member|nname
r_char
id|nname
(braket
l_int|9
)braket
suffix:semicolon
DECL|member|nnext
r_char
id|nnext
(braket
l_int|56
)braket
suffix:semicolon
DECL|member|rel
r_char
id|rel
(braket
l_int|9
)braket
suffix:semicolon
DECL|member|ver
r_char
id|ver
(braket
l_int|9
)braket
suffix:semicolon
DECL|member|mach
r_char
id|mach
(braket
l_int|9
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|function|sunos_uname
id|asmlinkage
r_int
id|sunos_uname
c_func
(paren
r_struct
id|sunos_utsname
op_star
id|name
)paren
(brace
r_int
id|error
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|name
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|name
comma
r_sizeof
op_star
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
r_return
id|error
suffix:semicolon
)brace
id|memcpy_tofs
c_func
(paren
op_amp
id|name-&gt;sname
(braket
l_int|0
)braket
comma
op_amp
id|system_utsname.sysname
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|name-&gt;sname
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|memcpy_tofs
c_func
(paren
op_amp
id|name-&gt;nname
(braket
l_int|0
)braket
comma
op_amp
id|system_utsname.nodename
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|name-&gt;nname
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|name-&gt;nname
(braket
l_int|8
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|memcpy_tofs
c_func
(paren
op_amp
id|name-&gt;rel
(braket
l_int|0
)braket
comma
op_amp
id|system_utsname.release
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|name-&gt;rel
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|memcpy_tofs
c_func
(paren
op_amp
id|name-&gt;ver
(braket
l_int|0
)braket
comma
op_amp
id|system_utsname.version
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|name-&gt;ver
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|memcpy_tofs
c_func
(paren
op_amp
id|name-&gt;mach
(braket
l_int|0
)braket
comma
op_amp
id|system_utsname.machine
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|name-&gt;mach
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sunos_nosys
id|asmlinkage
r_int
id|sunos_nosys
c_func
(paren
r_void
)paren
(brace
r_struct
id|pt_regs
op_star
id|regs
suffix:semicolon
id|regs
op_assign
(paren
r_struct
id|pt_regs
op_star
)paren
(paren
id|current-&gt;saved_kernel_stack
op_plus
r_sizeof
(paren
r_struct
id|reg_window
)paren
)paren
suffix:semicolon
id|current-&gt;tss.sig_address
op_assign
id|regs-&gt;pc
suffix:semicolon
id|current-&gt;tss.sig_desc
op_assign
id|regs-&gt;u_regs
(braket
id|UREG_G1
)braket
suffix:semicolon
id|send_sig
c_func
(paren
id|SIGSYS
comma
id|current
comma
l_int|1
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Process makes ni_syscall number %d, register dump:&bslash;n&quot;
comma
(paren
r_int
)paren
id|regs-&gt;u_regs
(braket
id|UREG_G1
)braket
)paren
suffix:semicolon
id|show_regs
c_func
(paren
id|regs
)paren
suffix:semicolon
r_return
op_minus
id|ENOSYS
suffix:semicolon
)brace
multiline_comment|/* This is not a real and complete implementation yet, just to keep&n; * the easy SunOS binaries happy.&n; */
DECL|function|sunos_fpathconf
id|asmlinkage
r_int
id|sunos_fpathconf
c_func
(paren
r_int
id|fd
comma
r_int
id|name
)paren
(brace
r_switch
c_cond
(paren
id|name
)paren
(brace
r_case
id|_PCONF_LINK
suffix:colon
r_return
id|LINK_MAX
suffix:semicolon
r_case
id|_PCONF_CANON
suffix:colon
r_return
id|MAX_CANON
suffix:semicolon
r_case
id|_PCONF_INPUT
suffix:colon
r_return
id|MAX_INPUT
suffix:semicolon
r_case
id|_PCONF_NAME
suffix:colon
r_return
id|NAME_MAX
suffix:semicolon
r_case
id|_PCONF_PATH
suffix:colon
r_return
id|PATH_MAX
suffix:semicolon
r_case
id|_PCONF_PIPE
suffix:colon
r_return
id|PIPE_BUF
suffix:semicolon
r_case
id|_PCONF_CHRESTRICT
suffix:colon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* XXX Investigate XXX */
r_case
id|_PCONF_NOTRUNC
suffix:colon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* XXX Investigate XXX */
r_case
id|_PCONF_VDISABLE
suffix:colon
r_return
l_int|30
suffix:semicolon
multiline_comment|/* XXX Investigate XXX */
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
DECL|function|sunos_pathconf
id|asmlinkage
r_int
id|sunos_pathconf
c_func
(paren
r_char
op_star
id|path
comma
r_int
id|name
)paren
(brace
r_return
id|sunos_fpathconf
c_func
(paren
l_int|0
comma
id|name
)paren
suffix:semicolon
multiline_comment|/* XXX cheese XXX */
)brace
multiline_comment|/* SunOS mount system call emulation */
r_extern
id|asmlinkage
r_int
id|sys_select
c_func
(paren
r_int
id|n
comma
id|fd_set
op_star
id|inp
comma
id|fd_set
op_star
id|outp
comma
id|fd_set
op_star
id|exp
comma
r_struct
id|timeval
op_star
id|tvp
)paren
suffix:semicolon
DECL|function|sunos_select
id|asmlinkage
r_int
id|sunos_select
c_func
(paren
r_int
id|width
comma
id|fd_set
op_star
id|inp
comma
id|fd_set
op_star
id|outp
comma
id|fd_set
op_star
id|exp
comma
r_struct
id|timeval
op_star
id|tvp
)paren
(brace
multiline_comment|/* SunOS binaries expect that select won&squot;t change the tvp contents */
id|current-&gt;personality
op_or_assign
id|STICKY_TIMEOUTS
suffix:semicolon
r_return
id|sys_select
(paren
id|width
comma
id|inp
comma
id|outp
comma
id|exp
comma
id|tvp
)paren
suffix:semicolon
)brace
DECL|function|sunos_nop
id|asmlinkage
r_void
id|sunos_nop
c_func
(paren
r_void
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/* SunOS mount/umount. */
DECL|macro|SMNT_RDONLY
mdefine_line|#define SMNT_RDONLY       1
DECL|macro|SMNT_NOSUID
mdefine_line|#define SMNT_NOSUID       2
DECL|macro|SMNT_NEWTYPE
mdefine_line|#define SMNT_NEWTYPE      4
DECL|macro|SMNT_GRPID
mdefine_line|#define SMNT_GRPID        8
DECL|macro|SMNT_REMOUNT
mdefine_line|#define SMNT_REMOUNT      16
DECL|macro|SMNT_NOSUB
mdefine_line|#define SMNT_NOSUB        32
DECL|macro|SMNT_MULTI
mdefine_line|#define SMNT_MULTI        64
DECL|macro|SMNT_SYS5
mdefine_line|#define SMNT_SYS5         128
DECL|struct|sunos_fh_t
r_struct
id|sunos_fh_t
(brace
DECL|member|fh_data
r_char
id|fh_data
(braket
id|NFS_FHSIZE
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|sunos_nfs_mount_args
r_struct
id|sunos_nfs_mount_args
(brace
DECL|member|addr
r_struct
id|sockaddr_in
op_star
id|addr
suffix:semicolon
multiline_comment|/* file server address */
DECL|member|fh
r_struct
id|nfs_fh
op_star
id|fh
suffix:semicolon
multiline_comment|/* File handle to be mounted */
DECL|member|flags
r_int
id|flags
suffix:semicolon
multiline_comment|/* flags */
DECL|member|wsize
r_int
id|wsize
suffix:semicolon
multiline_comment|/* write size in bytes */
DECL|member|rsize
r_int
id|rsize
suffix:semicolon
multiline_comment|/* read size in bytes */
DECL|member|timeo
r_int
id|timeo
suffix:semicolon
multiline_comment|/* initial timeout in .1 secs */
DECL|member|retrans
r_int
id|retrans
suffix:semicolon
multiline_comment|/* times to retry send */
DECL|member|hostname
r_char
op_star
id|hostname
suffix:semicolon
multiline_comment|/* server&squot;s hostname */
DECL|member|acregmin
r_int
id|acregmin
suffix:semicolon
multiline_comment|/* attr cache file min secs */
DECL|member|acregmax
r_int
id|acregmax
suffix:semicolon
multiline_comment|/* attr cache file max secs */
DECL|member|acdirmin
r_int
id|acdirmin
suffix:semicolon
multiline_comment|/* attr cache dir min secs */
DECL|member|acdirmax
r_int
id|acdirmax
suffix:semicolon
multiline_comment|/* attr cache dir max secs */
DECL|member|netname
r_char
op_star
id|netname
suffix:semicolon
multiline_comment|/* server&squot;s netname */
)brace
suffix:semicolon
r_extern
r_int
id|do_mount
c_func
(paren
id|kdev_t
comma
r_const
r_char
op_star
comma
r_const
r_char
op_star
comma
r_char
op_star
comma
r_int
comma
r_void
op_star
)paren
suffix:semicolon
r_extern
id|dev_t
id|get_unnamed_dev
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|put_unnamed_dev
c_func
(paren
id|dev_t
)paren
suffix:semicolon
r_extern
id|asmlinkage
r_int
id|sys_mount
c_func
(paren
r_char
op_star
comma
r_char
op_star
comma
r_char
op_star
comma
r_int
r_int
comma
r_void
op_star
)paren
suffix:semicolon
r_extern
id|asmlinkage
r_int
id|sys_connect
c_func
(paren
r_int
id|fd
comma
r_struct
id|sockaddr
op_star
id|uservaddr
comma
r_int
id|addrlen
)paren
suffix:semicolon
r_extern
id|asmlinkage
r_int
id|sys_socket
c_func
(paren
r_int
id|family
comma
r_int
id|type
comma
r_int
id|protocol
)paren
suffix:semicolon
r_extern
id|asmlinkage
r_int
id|sys_bind
c_func
(paren
r_int
id|fd
comma
r_struct
id|sockaddr
op_star
id|umyaddr
comma
r_int
id|addrlen
)paren
suffix:semicolon
multiline_comment|/* Bind the socket on a local reserved port and connect it to the&n; * remote server.  This on Linux/i386 is done by the mount program,&n; * not by the kernel. &n; */
r_static
r_int
DECL|function|sunos_nfs_get_server_fd
id|sunos_nfs_get_server_fd
(paren
r_int
id|fd
comma
r_struct
id|sockaddr_in
op_star
id|addr
)paren
(brace
r_struct
id|sockaddr_in
id|local
suffix:semicolon
r_struct
id|sockaddr_in
id|server
suffix:semicolon
r_int
id|try_port
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_struct
id|socket
op_star
id|socket
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_struct
id|file
op_star
id|file
suffix:semicolon
id|file
op_assign
id|current-&gt;files-&gt;fd
(braket
id|fd
)braket
suffix:semicolon
id|inode
op_assign
id|file-&gt;f_inode
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
op_logical_or
op_logical_neg
id|inode-&gt;i_sock
)paren
r_return
l_int|0
suffix:semicolon
id|socket
op_assign
op_amp
id|inode-&gt;u.socket_i
suffix:semicolon
id|local.sin_family
op_assign
id|AF_INET
suffix:semicolon
id|local.sin_addr.s_addr
op_assign
id|INADDR_ANY
suffix:semicolon
multiline_comment|/* IPPORT_RESERVED = 1024, can&squot;t find the definition in the kernel */
id|try_port
op_assign
l_int|1024
suffix:semicolon
r_do
(brace
id|local.sin_port
op_assign
id|htons
(paren
op_decrement
id|try_port
)paren
suffix:semicolon
id|ret
op_assign
id|socket-&gt;ops
op_member_access_from_pointer
id|bind
c_func
(paren
id|socket
comma
(paren
r_struct
id|sockaddr
op_star
)paren
op_amp
id|local
comma
r_sizeof
(paren
id|local
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|ret
op_logical_and
id|try_port
OG
(paren
l_int|1024
op_div
l_int|2
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
l_int|0
suffix:semicolon
id|server.sin_family
op_assign
id|AF_INET
suffix:semicolon
id|server.sin_addr
op_assign
id|addr-&gt;sin_addr
suffix:semicolon
id|server.sin_port
op_assign
id|NFS_PORT
suffix:semicolon
multiline_comment|/* Call sys_connect */
id|ret
op_assign
id|socket-&gt;ops-&gt;connect
(paren
id|socket
comma
(paren
r_struct
id|sockaddr
op_star
)paren
op_amp
id|server
comma
r_sizeof
(paren
id|server
)paren
comma
id|file-&gt;f_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|get_default
r_static
r_int
id|get_default
(paren
r_int
id|value
comma
r_int
id|def_value
)paren
(brace
r_if
c_cond
(paren
id|value
)paren
r_return
id|value
suffix:semicolon
r_else
r_return
id|def_value
suffix:semicolon
)brace
DECL|function|sunos_nfs_mount
id|asmlinkage
r_int
id|sunos_nfs_mount
c_func
(paren
r_char
op_star
id|dir_name
comma
r_int
id|linux_flags
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|ret
op_assign
op_minus
id|ENODEV
comma
id|error
suffix:semicolon
r_int
id|server_fd
suffix:semicolon
r_char
op_star
id|the_name
suffix:semicolon
r_struct
id|nfs_mount_data
id|linux_nfs_mount
suffix:semicolon
r_struct
id|sunos_nfs_mount_args
op_star
id|sunos_mount
op_assign
id|data
suffix:semicolon
id|dev_t
id|dev
suffix:semicolon
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|data
comma
r_sizeof
(paren
r_struct
id|sunos_nfs_mount_args
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
multiline_comment|/* Ok, here comes the fun part: Linux&squot;s nfs mount needs a&n;&t; * socket connection to the server, but SunOS mount does not&n;&t; * require this, so we use the information on the destination&n;&t; * address to create a socket and bind it to a reserved&n;&t; * port on this system&n;&t; */
id|server_fd
op_assign
id|sys_socket
(paren
id|AF_INET
comma
id|SOCK_DGRAM
comma
id|IPPROTO_UDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|server_fd
OL
l_int|0
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sunos_nfs_get_server_fd
(paren
id|server_fd
comma
id|sunos_mount-&gt;addr
)paren
)paren
(brace
id|sys_close
(paren
id|server_fd
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
multiline_comment|/* Now, bind it to a locally reserved port */
id|linux_nfs_mount.version
op_assign
id|NFS_MOUNT_VERSION
suffix:semicolon
id|linux_nfs_mount.flags
op_assign
id|sunos_mount-&gt;flags
suffix:semicolon
id|linux_nfs_mount.addr
op_assign
op_star
id|sunos_mount-&gt;addr
suffix:semicolon
id|linux_nfs_mount.root
op_assign
op_star
id|sunos_mount-&gt;fh
suffix:semicolon
id|linux_nfs_mount.fd
op_assign
id|server_fd
suffix:semicolon
id|linux_nfs_mount.rsize
op_assign
id|get_default
(paren
id|sunos_mount-&gt;rsize
comma
l_int|8192
)paren
suffix:semicolon
id|linux_nfs_mount.wsize
op_assign
id|get_default
(paren
id|sunos_mount-&gt;wsize
comma
l_int|8192
)paren
suffix:semicolon
id|linux_nfs_mount.timeo
op_assign
id|get_default
(paren
id|sunos_mount-&gt;timeo
comma
l_int|10
)paren
suffix:semicolon
id|linux_nfs_mount.retrans
op_assign
id|sunos_mount-&gt;retrans
suffix:semicolon
id|linux_nfs_mount.acregmin
op_assign
id|sunos_mount-&gt;acregmin
suffix:semicolon
id|linux_nfs_mount.acregmax
op_assign
id|sunos_mount-&gt;acregmax
suffix:semicolon
id|linux_nfs_mount.acdirmin
op_assign
id|sunos_mount-&gt;acdirmin
suffix:semicolon
id|linux_nfs_mount.acdirmax
op_assign
id|sunos_mount-&gt;acdirmax
suffix:semicolon
r_if
c_cond
(paren
id|getname
(paren
id|sunos_mount-&gt;hostname
comma
op_amp
id|the_name
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|strncpy
(paren
id|linux_nfs_mount.hostname
comma
id|the_name
comma
l_int|254
)paren
suffix:semicolon
id|linux_nfs_mount.hostname
(braket
l_int|255
)braket
op_assign
l_int|0
suffix:semicolon
id|putname
(paren
id|the_name
)paren
suffix:semicolon
id|dev
op_assign
id|get_unnamed_dev
(paren
)paren
suffix:semicolon
id|ret
op_assign
id|do_mount
(paren
id|dev
comma
l_string|&quot;&quot;
comma
id|dir_name
comma
l_string|&quot;nfs&quot;
comma
id|linux_flags
comma
op_amp
id|linux_nfs_mount
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|put_unnamed_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|asmlinkage
r_int
DECL|function|sunos_mount
id|sunos_mount
c_func
(paren
r_char
op_star
id|type
comma
r_char
op_star
id|dir
comma
r_int
id|flags
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|linux_flags
op_assign
id|MS_MGC_MSK
suffix:semicolon
multiline_comment|/* new semantics */
r_int
id|error
suffix:semicolon
r_char
op_star
id|dev_fname
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* We don&squot;t handle the integer fs type */
r_if
c_cond
(paren
(paren
id|flags
op_amp
id|SMNT_NEWTYPE
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Do not allow for those flags we don&squot;t support */
r_if
c_cond
(paren
id|flags
op_amp
(paren
id|SMNT_GRPID
op_or
id|SMNT_NOSUB
op_or
id|SMNT_MULTI
op_or
id|SMNT_SYS5
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|SMNT_REMOUNT
)paren
(brace
id|linux_flags
op_or_assign
id|MS_REMOUNT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flags
op_amp
id|SMNT_RDONLY
)paren
(brace
id|linux_flags
op_or_assign
id|MS_RDONLY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flags
op_amp
id|SMNT_NOSUID
)paren
(brace
id|linux_flags
op_or_assign
id|MS_NOSUID
suffix:semicolon
)brace
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|type
comma
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
r_return
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|type
comma
l_string|&quot;ext2&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|dev_fname
op_assign
(paren
r_char
op_star
)paren
id|data
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|type
comma
l_string|&quot;iso9660&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|dev_fname
op_assign
(paren
r_char
op_star
)paren
id|data
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|type
comma
l_string|&quot;minix&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|dev_fname
op_assign
(paren
r_char
op_star
)paren
id|data
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|type
comma
l_string|&quot;ext&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|dev_fname
op_assign
(paren
r_char
op_star
)paren
id|data
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|type
comma
l_string|&quot;xiafs&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|dev_fname
op_assign
(paren
r_char
op_star
)paren
id|data
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|type
comma
l_string|&quot;nfs&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|error
op_assign
id|sunos_nfs_mount
(paren
id|dir
comma
id|flags
comma
id|data
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|type
comma
l_string|&quot;ufs&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Warning: UFS filesystem mounts unsupported.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|type
comma
l_string|&quot;proc&quot;
)paren
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|error
)paren
(brace
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|sys_mount
c_func
(paren
id|dev_fname
comma
id|dir
comma
id|type
comma
id|linux_flags
comma
l_int|NULL
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_extern
id|asmlinkage
r_int
id|sys_setsid
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
id|asmlinkage
r_int
id|sys_setpgid
c_func
(paren
id|pid_t
comma
id|pid_t
)paren
suffix:semicolon
DECL|function|sunos_setpgrp
id|asmlinkage
r_int
id|sunos_setpgrp
c_func
(paren
id|pid_t
id|pid
comma
id|pid_t
id|pgid
)paren
(brace
multiline_comment|/* So stupid... */
r_if
c_cond
(paren
(paren
op_logical_neg
id|pid
op_logical_or
id|pid
op_eq
id|current-&gt;pid
)paren
op_logical_and
op_logical_neg
id|pgid
)paren
(brace
id|sys_setsid
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_return
id|sys_setpgid
c_func
(paren
id|pid
comma
id|pgid
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* So stupid... */
r_extern
id|asmlinkage
r_int
id|sys_wait4
c_func
(paren
id|pid_t
comma
r_int
r_int
op_star
comma
r_int
comma
r_struct
id|rusage
op_star
)paren
suffix:semicolon
DECL|function|sunos_wait4
id|asmlinkage
r_int
id|sunos_wait4
c_func
(paren
id|pid_t
id|pid
comma
r_int
r_int
op_star
id|stat_addr
comma
r_int
id|options
comma
r_struct
id|rusage
op_star
id|ru
)paren
(brace
r_return
id|sys_wait4
c_func
(paren
(paren
id|pid
ques
c_cond
id|pid
suffix:colon
op_minus
l_int|1
)paren
comma
id|stat_addr
comma
id|options
comma
id|ru
)paren
suffix:semicolon
)brace
r_extern
r_int
id|kill_pg
c_func
(paren
r_int
comma
r_int
comma
r_int
)paren
suffix:semicolon
DECL|function|sunos_killpg
id|asmlinkage
r_int
id|sunos_killpg
c_func
(paren
r_int
id|pgrp
comma
r_int
id|sig
)paren
(brace
r_return
id|kill_pg
c_func
(paren
id|pgrp
comma
id|sig
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|sunos_audit
id|asmlinkage
r_int
id|sunos_audit
c_func
(paren
r_void
)paren
(brace
id|printk
(paren
l_string|&quot;sys_audit&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|sunos_gethostid
r_extern
id|asmlinkage
r_int
r_int
id|sunos_gethostid
c_func
(paren
r_void
)paren
(brace
r_return
(paren
r_int
r_int
)paren
id|idprom-&gt;id_sernum
suffix:semicolon
)brace
DECL|function|sunos_sysconf
r_extern
id|asmlinkage
r_int
id|sunos_sysconf
(paren
r_int
id|name
)paren
(brace
r_switch
c_cond
(paren
id|name
)paren
(brace
r_case
id|_SC_ARG_MAX
suffix:colon
r_return
id|ARG_MAX
suffix:semicolon
r_case
id|_SC_CHILD_MAX
suffix:colon
r_return
id|CHILD_MAX
suffix:semicolon
r_case
id|_SC_CLK_TCK
suffix:colon
r_return
id|HZ
suffix:semicolon
r_case
id|_SC_NGROUPS_MAX
suffix:colon
r_return
id|NGROUPS_MAX
suffix:semicolon
r_case
id|_SC_OPEN_MAX
suffix:colon
r_return
id|OPEN_MAX
suffix:semicolon
r_case
id|_SC_JOB_CONTROL
suffix:colon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* yes, we do support job control */
r_case
id|_SC_SAVED_IDS
suffix:colon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* yes, we do support saved uids  */
r_case
id|_SC_VERSION
suffix:colon
multiline_comment|/* mhm, POSIX_VERSION is in /usr/include/unistd.h&n;&t;&t; * should it go on /usr/include/linux?&n;&t;&t; */
r_return
l_int|199009L
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
eof
