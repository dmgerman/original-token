multiline_comment|/* $Id: sys_sunos.c,v 1.130 2000/08/12 13:25:41 davem Exp $&n; * sys_sunos.c: SunOS specific syscall compatibility support.&n; *&n; * Copyright (C) 1995 David S. Miller (davem@caip.rutgers.edu)&n; * Copyright (C) 1995 Miguel de Icaza (miguel@nuclecu.unam.mx)&n; *&n; * Based upon preliminary work which is:&n; *&n; * Copyright (C) 1995 Adrian M. Rodriguez (adrian@remus.rutgers.edu)&n; *&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/mman.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/swap.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/file.h&gt;
macro_line|#include &lt;linux/resource.h&gt;
macro_line|#include &lt;linux/ipc.h&gt;
macro_line|#include &lt;linux/shm.h&gt;
macro_line|#include &lt;linux/msg.h&gt;
macro_line|#include &lt;linux/sem.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/uio.h&gt;
macro_line|#include &lt;linux/utsname.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/pagemap.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#ifndef KERNEL_DS
macro_line|#include &lt;linux/segment.h&gt;
macro_line|#endif
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/pconf.h&gt;
macro_line|#include &lt;asm/idprom.h&gt; /* for gethostid() */
macro_line|#include &lt;asm/unistd.h&gt;
macro_line|#include &lt;asm/system.h&gt;
multiline_comment|/* For the nfs mount emulation */
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/nfs.h&gt;
macro_line|#include &lt;linux/nfs2.h&gt;
macro_line|#include &lt;linux/nfs_mount.h&gt;
multiline_comment|/* for sunos_select */
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/personality.h&gt;
multiline_comment|/* NR_OPEN is now larger and dynamic in recent kernels. */
DECL|macro|SUNOS_NR_OPEN
mdefine_line|#define SUNOS_NR_OPEN&t;256
multiline_comment|/* We use the SunOS mmap() semantics. */
DECL|function|sunos_mmap
id|asmlinkage
r_int
r_int
id|sunos_mmap
c_func
(paren
r_int
r_int
id|addr
comma
r_int
r_int
id|len
comma
r_int
r_int
id|prot
comma
r_int
r_int
id|flags
comma
r_int
r_int
id|fd
comma
r_int
r_int
id|off
)paren
(brace
r_struct
id|file
op_star
id|file
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|retval
comma
id|ret_type
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|MAP_NORESERVE
)paren
(brace
r_static
r_int
id|cnt
suffix:semicolon
r_if
c_cond
(paren
id|cnt
op_increment
OL
l_int|10
)paren
id|printk
c_func
(paren
l_string|&quot;%s: unimplemented SunOS MAP_NORESERVE mmap() flag&bslash;n&quot;
comma
id|current-&gt;comm
)paren
suffix:semicolon
id|flags
op_and_assign
op_complement
id|MAP_NORESERVE
suffix:semicolon
)brace
id|retval
op_assign
op_minus
id|EBADF
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|flags
op_amp
id|MAP_ANONYMOUS
)paren
)paren
(brace
r_if
c_cond
(paren
id|fd
op_ge
id|SUNOS_NR_OPEN
)paren
r_goto
id|out
suffix:semicolon
id|file
op_assign
id|fget
c_func
(paren
id|fd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|file
)paren
r_goto
id|out
suffix:semicolon
)brace
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* If this is ld.so or a shared library doing an mmap&n;&t; * of /dev/zero, transform it into an anonymous mapping.&n;&t; * SunOS is so stupid some times... hmph!&n;&t; */
r_if
c_cond
(paren
id|file
)paren
(brace
r_if
c_cond
(paren
id|MAJOR
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_rdev
)paren
op_eq
id|MEM_MAJOR
op_logical_and
id|MINOR
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_rdev
)paren
op_eq
l_int|5
)paren
(brace
id|flags
op_or_assign
id|MAP_ANONYMOUS
suffix:semicolon
id|fput
c_func
(paren
id|file
)paren
suffix:semicolon
id|file
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|ret_type
op_assign
id|flags
op_amp
id|_MAP_NEW
suffix:semicolon
id|flags
op_and_assign
op_complement
id|_MAP_NEW
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|flags
op_amp
id|MAP_FIXED
)paren
)paren
(brace
id|addr
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ARCH_SUN4C_SUN4
op_logical_and
(paren
id|len
OG
l_int|0x20000000
op_logical_or
(paren
(paren
id|flags
op_amp
id|MAP_FIXED
)paren
op_logical_and
id|addr
template_param
l_int|0x20000000
)paren
)paren
)paren
r_goto
id|out_putf
suffix:semicolon
multiline_comment|/* See asm-sparc/uaccess.h */
r_if
c_cond
(paren
id|len
OG
id|TASK_SIZE
op_minus
id|PAGE_SIZE
op_logical_or
id|addr
op_plus
id|len
OG
id|TASK_SIZE
op_minus
id|PAGE_SIZE
)paren
r_goto
id|out_putf
suffix:semicolon
)brace
id|flags
op_and_assign
op_complement
(paren
id|MAP_EXECUTABLE
op_or
id|MAP_DENYWRITE
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|current-&gt;mm-&gt;mmap_sem
)paren
suffix:semicolon
id|retval
op_assign
id|do_mmap
c_func
(paren
id|file
comma
id|addr
comma
id|len
comma
id|prot
comma
id|flags
comma
id|off
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|current-&gt;mm-&gt;mmap_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret_type
)paren
(brace
id|retval
op_assign
(paren
(paren
id|retval
OL
id|PAGE_OFFSET
)paren
ques
c_cond
l_int|0
suffix:colon
id|retval
)paren
suffix:semicolon
)brace
id|out_putf
suffix:colon
r_if
c_cond
(paren
id|file
)paren
id|fput
c_func
(paren
id|file
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* lmbench calls this, just say &quot;yeah, ok&quot; */
DECL|function|sunos_mctl
id|asmlinkage
r_int
id|sunos_mctl
c_func
(paren
r_int
r_int
id|addr
comma
r_int
r_int
id|len
comma
r_int
id|function
comma
r_char
op_star
id|arg
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* SunOS is completely broken... it returns 0 on success, otherwise&n; * ENOMEM.  For sys_sbrk() it wants the old brk value as a return&n; * on success and ENOMEM as before on failure.&n; */
DECL|function|sunos_brk
id|asmlinkage
r_int
id|sunos_brk
c_func
(paren
r_int
r_int
id|brk
)paren
(brace
r_int
id|freepages
comma
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_int
r_int
id|rlim
suffix:semicolon
r_int
r_int
id|newbrk
comma
id|oldbrk
suffix:semicolon
id|down
c_func
(paren
op_amp
id|current-&gt;mm-&gt;mmap_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ARCH_SUN4C_SUN4
)paren
(brace
r_if
c_cond
(paren
id|brk
op_ge
l_int|0x20000000
op_logical_and
id|brk
OL
l_int|0xe0000000
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|brk
OL
id|current-&gt;mm-&gt;end_code
)paren
r_goto
id|out
suffix:semicolon
id|newbrk
op_assign
id|PAGE_ALIGN
c_func
(paren
id|brk
)paren
suffix:semicolon
id|oldbrk
op_assign
id|PAGE_ALIGN
c_func
(paren
id|current-&gt;mm-&gt;brk
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|oldbrk
op_eq
id|newbrk
)paren
(brace
id|current-&gt;mm-&gt;brk
op_assign
id|brk
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Always allow shrinking brk&n;&t; */
r_if
c_cond
(paren
id|brk
op_le
id|current-&gt;mm-&gt;brk
)paren
(brace
id|current-&gt;mm-&gt;brk
op_assign
id|brk
suffix:semicolon
id|do_munmap
c_func
(paren
id|current-&gt;mm
comma
id|newbrk
comma
id|oldbrk
op_minus
id|newbrk
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Check against rlimit and stack..&n;&t; */
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|rlim
op_assign
id|current-&gt;rlim
(braket
id|RLIMIT_DATA
)braket
dot
id|rlim_cur
suffix:semicolon
r_if
c_cond
(paren
id|rlim
op_ge
id|RLIM_INFINITY
)paren
id|rlim
op_assign
op_complement
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|brk
op_minus
id|current-&gt;mm-&gt;end_code
OG
id|rlim
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/*&n;&t; * Check against existing mmap mappings.&n;&t; */
r_if
c_cond
(paren
id|find_vma_intersection
c_func
(paren
id|current-&gt;mm
comma
id|oldbrk
comma
id|newbrk
op_plus
id|PAGE_SIZE
)paren
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/*&n;&t; * stupid algorithm to decide if we have enough memory: while&n;&t; * simple, it hopefully works in most obvious cases.. Easy to&n;&t; * fool it, but this should catch most mistakes.&n;&t; */
id|freepages
op_assign
id|atomic_read
c_func
(paren
op_amp
id|buffermem_pages
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
id|freepages
op_add_assign
id|atomic_read
c_func
(paren
op_amp
id|page_cache_size
)paren
suffix:semicolon
id|freepages
op_rshift_assign
l_int|1
suffix:semicolon
id|freepages
op_add_assign
id|nr_free_pages
c_func
(paren
)paren
suffix:semicolon
id|freepages
op_add_assign
id|nr_swap_pages
suffix:semicolon
id|freepages
op_sub_assign
id|num_physpages
op_rshift
l_int|4
suffix:semicolon
id|freepages
op_sub_assign
(paren
id|newbrk
op_minus
id|oldbrk
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
r_if
c_cond
(paren
id|freepages
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/*&n;&t; * Ok, we have probably got enough memory - let it rip.&n;&t; */
id|current-&gt;mm-&gt;brk
op_assign
id|brk
suffix:semicolon
id|do_brk
c_func
(paren
id|oldbrk
comma
id|newbrk
op_minus
id|oldbrk
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|current-&gt;mm-&gt;mmap_sem
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|sunos_sbrk
id|asmlinkage
r_int
r_int
id|sunos_sbrk
c_func
(paren
r_int
id|increment
)paren
(brace
r_int
id|error
suffix:semicolon
r_int
r_int
id|oldbrk
suffix:semicolon
multiline_comment|/* This should do it hopefully... */
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|oldbrk
op_assign
id|current-&gt;mm-&gt;brk
suffix:semicolon
id|error
op_assign
id|sunos_brk
c_func
(paren
(paren
(paren
r_int
)paren
id|current-&gt;mm-&gt;brk
)paren
op_plus
id|increment
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
(brace
id|error
op_assign
id|oldbrk
suffix:semicolon
)brace
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* XXX Completely undocumented, and completely magic...&n; * XXX I believe it is to increase the size of the stack by&n; * XXX argument &squot;increment&squot; and return the new end of stack&n; * XXX area.  Wheee...&n; */
DECL|function|sunos_sstk
id|asmlinkage
r_int
r_int
id|sunos_sstk
c_func
(paren
r_int
id|increment
)paren
(brace
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Call to sunos_sstk(increment&lt;%d&gt;) is unsupported&bslash;n&quot;
comma
id|current-&gt;comm
comma
id|increment
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Give hints to the kernel as to what paging strategy to use...&n; * Completely bogus, don&squot;t remind me.&n; */
DECL|macro|VA_NORMAL
mdefine_line|#define VA_NORMAL     0 /* Normal vm usage expected */
DECL|macro|VA_ABNORMAL
mdefine_line|#define VA_ABNORMAL   1 /* Abnormal/random vm usage probable */
DECL|macro|VA_SEQUENTIAL
mdefine_line|#define VA_SEQUENTIAL 2 /* Accesses will be of a sequential nature */
DECL|macro|VA_INVALIDATE
mdefine_line|#define VA_INVALIDATE 3 /* Page table entries should be flushed ??? */
DECL|variable|vstrings
r_static
r_char
op_star
id|vstrings
(braket
)braket
op_assign
(brace
l_string|&quot;VA_NORMAL&quot;
comma
l_string|&quot;VA_ABNORMAL&quot;
comma
l_string|&quot;VA_SEQUENTIAL&quot;
comma
l_string|&quot;VA_INVALIDATE&quot;
comma
)brace
suffix:semicolon
DECL|function|sunos_vadvise
id|asmlinkage
r_void
id|sunos_vadvise
c_func
(paren
r_int
r_int
id|strategy
)paren
(brace
multiline_comment|/* I wanna see who uses this... */
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Advises us to use %s paging strategy&bslash;n&quot;
comma
id|current-&gt;comm
comma
id|strategy
op_le
l_int|3
ques
c_cond
id|vstrings
(braket
id|strategy
)braket
suffix:colon
l_string|&quot;BOGUS&quot;
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* This just wants the soft limit (ie. rlim_cur element) of the RLIMIT_NOFILE&n; * resource limit and is for backwards compatibility with older sunos&n; * revs.&n; */
DECL|function|sunos_getdtablesize
id|asmlinkage
r_int
id|sunos_getdtablesize
c_func
(paren
r_void
)paren
(brace
r_return
id|SUNOS_NR_OPEN
suffix:semicolon
)brace
DECL|macro|_BLOCKABLE
mdefine_line|#define _BLOCKABLE (~(sigmask(SIGKILL) | sigmask(SIGSTOP)))
DECL|function|sunos_sigblock
id|asmlinkage
r_int
r_int
id|sunos_sigblock
c_func
(paren
r_int
r_int
id|blk_mask
)paren
(brace
r_int
r_int
id|old
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|current-&gt;sigmask_lock
)paren
suffix:semicolon
id|old
op_assign
id|current-&gt;blocked.sig
(braket
l_int|0
)braket
suffix:semicolon
id|current-&gt;blocked.sig
(braket
l_int|0
)braket
op_or_assign
(paren
id|blk_mask
op_amp
id|_BLOCKABLE
)paren
suffix:semicolon
id|recalc_sigpending
c_func
(paren
id|current
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|current-&gt;sigmask_lock
)paren
suffix:semicolon
r_return
id|old
suffix:semicolon
)brace
DECL|function|sunos_sigsetmask
id|asmlinkage
r_int
r_int
id|sunos_sigsetmask
c_func
(paren
r_int
r_int
id|newmask
)paren
(brace
r_int
r_int
id|retval
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|current-&gt;sigmask_lock
)paren
suffix:semicolon
id|retval
op_assign
id|current-&gt;blocked.sig
(braket
l_int|0
)braket
suffix:semicolon
id|current-&gt;blocked.sig
(braket
l_int|0
)braket
op_assign
(paren
id|newmask
op_amp
id|_BLOCKABLE
)paren
suffix:semicolon
id|recalc_sigpending
c_func
(paren
id|current
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|current-&gt;sigmask_lock
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* SunOS getdents is very similar to the newer Linux (iBCS2 compliant)    */
multiline_comment|/* getdents system call, the format of the structure just has a different */
multiline_comment|/* layout (d_off+d_ino instead of d_ino+d_off) */
DECL|struct|sunos_dirent
r_struct
id|sunos_dirent
(brace
DECL|member|d_off
r_int
id|d_off
suffix:semicolon
DECL|member|d_ino
r_int
r_int
id|d_ino
suffix:semicolon
DECL|member|d_reclen
r_int
r_int
id|d_reclen
suffix:semicolon
DECL|member|d_namlen
r_int
r_int
id|d_namlen
suffix:semicolon
DECL|member|d_name
r_char
id|d_name
(braket
l_int|1
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|sunos_dirent_callback
r_struct
id|sunos_dirent_callback
(brace
DECL|member|curr
r_struct
id|sunos_dirent
op_star
id|curr
suffix:semicolon
DECL|member|previous
r_struct
id|sunos_dirent
op_star
id|previous
suffix:semicolon
DECL|member|count
r_int
id|count
suffix:semicolon
DECL|member|error
r_int
id|error
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|NAME_OFFSET
mdefine_line|#define NAME_OFFSET(de) ((int) ((de)-&gt;d_name - (char *) (de)))
DECL|macro|ROUND_UP
mdefine_line|#define ROUND_UP(x) (((x)+sizeof(long)-1) &amp; ~(sizeof(long)-1))
DECL|function|sunos_filldir
r_static
r_int
id|sunos_filldir
c_func
(paren
r_void
op_star
id|__buf
comma
r_const
r_char
op_star
id|name
comma
r_int
id|namlen
comma
id|off_t
id|offset
comma
id|ino_t
id|ino
comma
r_int
r_int
id|d_type
)paren
(brace
r_struct
id|sunos_dirent
op_star
id|dirent
suffix:semicolon
r_struct
id|sunos_dirent_callback
op_star
id|buf
op_assign
(paren
r_struct
id|sunos_dirent_callback
op_star
)paren
id|__buf
suffix:semicolon
r_int
id|reclen
op_assign
id|ROUND_UP
c_func
(paren
id|NAME_OFFSET
c_func
(paren
id|dirent
)paren
op_plus
id|namlen
op_plus
l_int|1
)paren
suffix:semicolon
id|buf-&gt;error
op_assign
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* only used if we fail.. */
r_if
c_cond
(paren
id|reclen
OG
id|buf-&gt;count
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dirent
op_assign
id|buf-&gt;previous
suffix:semicolon
r_if
c_cond
(paren
id|dirent
)paren
id|put_user
c_func
(paren
id|offset
comma
op_amp
id|dirent-&gt;d_off
)paren
suffix:semicolon
id|dirent
op_assign
id|buf-&gt;curr
suffix:semicolon
id|buf-&gt;previous
op_assign
id|dirent
suffix:semicolon
id|put_user
c_func
(paren
id|ino
comma
op_amp
id|dirent-&gt;d_ino
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|namlen
comma
op_amp
id|dirent-&gt;d_namlen
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|reclen
comma
op_amp
id|dirent-&gt;d_reclen
)paren
suffix:semicolon
id|copy_to_user
c_func
(paren
id|dirent-&gt;d_name
comma
id|name
comma
id|namlen
)paren
suffix:semicolon
id|put_user
c_func
(paren
l_int|0
comma
id|dirent-&gt;d_name
op_plus
id|namlen
)paren
suffix:semicolon
(paren
(paren
r_char
op_star
)paren
id|dirent
)paren
op_add_assign
id|reclen
suffix:semicolon
id|buf-&gt;curr
op_assign
id|dirent
suffix:semicolon
id|buf-&gt;count
op_sub_assign
id|reclen
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sunos_getdents
id|asmlinkage
r_int
id|sunos_getdents
c_func
(paren
r_int
r_int
id|fd
comma
r_void
op_star
id|dirent
comma
r_int
id|cnt
)paren
(brace
r_struct
id|file
op_star
id|file
suffix:semicolon
r_struct
id|sunos_dirent
op_star
id|lastdirent
suffix:semicolon
r_struct
id|sunos_dirent_callback
id|buf
suffix:semicolon
r_int
id|error
op_assign
op_minus
id|EBADF
suffix:semicolon
r_if
c_cond
(paren
id|fd
op_ge
id|SUNOS_NR_OPEN
)paren
r_goto
id|out
suffix:semicolon
id|file
op_assign
id|fget
c_func
(paren
id|fd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|file
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OL
(paren
r_sizeof
(paren
r_struct
id|sunos_dirent
)paren
op_plus
l_int|255
)paren
)paren
r_goto
id|out_putf
suffix:semicolon
id|buf.curr
op_assign
(paren
r_struct
id|sunos_dirent
op_star
)paren
id|dirent
suffix:semicolon
id|buf.previous
op_assign
l_int|NULL
suffix:semicolon
id|buf.count
op_assign
id|cnt
suffix:semicolon
id|buf.error
op_assign
l_int|0
suffix:semicolon
id|error
op_assign
id|vfs_readdir
c_func
(paren
id|file
comma
id|sunos_filldir
comma
op_amp
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
r_goto
id|out_putf
suffix:semicolon
id|lastdirent
op_assign
id|buf.previous
suffix:semicolon
id|error
op_assign
id|buf.error
suffix:semicolon
r_if
c_cond
(paren
id|lastdirent
)paren
(brace
id|put_user
c_func
(paren
id|file-&gt;f_pos
comma
op_amp
id|lastdirent-&gt;d_off
)paren
suffix:semicolon
id|error
op_assign
id|cnt
op_minus
id|buf.count
suffix:semicolon
)brace
id|out_putf
suffix:colon
id|fput
c_func
(paren
id|file
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* Old sunos getdirentries, severely broken compatibility stuff here. */
DECL|struct|sunos_direntry
r_struct
id|sunos_direntry
(brace
DECL|member|d_ino
r_int
r_int
id|d_ino
suffix:semicolon
DECL|member|d_reclen
r_int
r_int
id|d_reclen
suffix:semicolon
DECL|member|d_namlen
r_int
r_int
id|d_namlen
suffix:semicolon
DECL|member|d_name
r_char
id|d_name
(braket
l_int|1
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|sunos_direntry_callback
r_struct
id|sunos_direntry_callback
(brace
DECL|member|curr
r_struct
id|sunos_direntry
op_star
id|curr
suffix:semicolon
DECL|member|previous
r_struct
id|sunos_direntry
op_star
id|previous
suffix:semicolon
DECL|member|count
r_int
id|count
suffix:semicolon
DECL|member|error
r_int
id|error
suffix:semicolon
)brace
suffix:semicolon
DECL|function|sunos_filldirentry
r_static
r_int
id|sunos_filldirentry
c_func
(paren
r_void
op_star
id|__buf
comma
r_const
r_char
op_star
id|name
comma
r_int
id|namlen
comma
id|off_t
id|offset
comma
id|ino_t
id|ino
comma
r_int
r_int
id|d_type
)paren
(brace
r_struct
id|sunos_direntry
op_star
id|dirent
suffix:semicolon
r_struct
id|sunos_direntry_callback
op_star
id|buf
op_assign
(paren
r_struct
id|sunos_direntry_callback
op_star
)paren
id|__buf
suffix:semicolon
r_int
id|reclen
op_assign
id|ROUND_UP
c_func
(paren
id|NAME_OFFSET
c_func
(paren
id|dirent
)paren
op_plus
id|namlen
op_plus
l_int|1
)paren
suffix:semicolon
id|buf-&gt;error
op_assign
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* only used if we fail.. */
r_if
c_cond
(paren
id|reclen
OG
id|buf-&gt;count
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dirent
op_assign
id|buf-&gt;previous
suffix:semicolon
id|dirent
op_assign
id|buf-&gt;curr
suffix:semicolon
id|buf-&gt;previous
op_assign
id|dirent
suffix:semicolon
id|put_user
c_func
(paren
id|ino
comma
op_amp
id|dirent-&gt;d_ino
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|namlen
comma
op_amp
id|dirent-&gt;d_namlen
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|reclen
comma
op_amp
id|dirent-&gt;d_reclen
)paren
suffix:semicolon
id|copy_to_user
c_func
(paren
id|dirent-&gt;d_name
comma
id|name
comma
id|namlen
)paren
suffix:semicolon
id|put_user
c_func
(paren
l_int|0
comma
id|dirent-&gt;d_name
op_plus
id|namlen
)paren
suffix:semicolon
(paren
(paren
r_char
op_star
)paren
id|dirent
)paren
op_add_assign
id|reclen
suffix:semicolon
id|buf-&gt;curr
op_assign
id|dirent
suffix:semicolon
id|buf-&gt;count
op_sub_assign
id|reclen
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sunos_getdirentries
id|asmlinkage
r_int
id|sunos_getdirentries
c_func
(paren
r_int
r_int
id|fd
comma
r_void
op_star
id|dirent
comma
r_int
id|cnt
comma
r_int
r_int
op_star
id|basep
)paren
(brace
r_struct
id|file
op_star
id|file
suffix:semicolon
r_struct
id|sunos_direntry
op_star
id|lastdirent
suffix:semicolon
r_struct
id|sunos_direntry_callback
id|buf
suffix:semicolon
r_int
id|error
op_assign
op_minus
id|EBADF
suffix:semicolon
r_if
c_cond
(paren
id|fd
op_ge
id|SUNOS_NR_OPEN
)paren
r_goto
id|out
suffix:semicolon
id|file
op_assign
id|fget
c_func
(paren
id|fd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|file
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OL
(paren
r_sizeof
(paren
r_struct
id|sunos_direntry
)paren
op_plus
l_int|255
)paren
)paren
(brace
r_goto
id|out_putf
suffix:semicolon
)brace
id|buf.curr
op_assign
(paren
r_struct
id|sunos_direntry
op_star
)paren
id|dirent
suffix:semicolon
id|buf.previous
op_assign
l_int|NULL
suffix:semicolon
id|buf.count
op_assign
id|cnt
suffix:semicolon
id|buf.error
op_assign
l_int|0
suffix:semicolon
id|error
op_assign
id|vfs_readdir
c_func
(paren
id|file
comma
id|sunos_filldirentry
comma
op_amp
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
r_goto
id|out_putf
suffix:semicolon
id|lastdirent
op_assign
id|buf.previous
suffix:semicolon
id|error
op_assign
id|buf.error
suffix:semicolon
r_if
c_cond
(paren
id|lastdirent
)paren
(brace
id|put_user
c_func
(paren
id|file-&gt;f_pos
comma
id|basep
)paren
suffix:semicolon
id|error
op_assign
id|cnt
op_minus
id|buf.count
suffix:semicolon
)brace
id|out_putf
suffix:colon
id|fput
c_func
(paren
id|file
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|error
suffix:semicolon
)brace
DECL|struct|sunos_utsname
r_struct
id|sunos_utsname
(brace
DECL|member|sname
r_char
id|sname
(braket
l_int|9
)braket
suffix:semicolon
DECL|member|nname
r_char
id|nname
(braket
l_int|9
)braket
suffix:semicolon
DECL|member|nnext
r_char
id|nnext
(braket
l_int|56
)braket
suffix:semicolon
DECL|member|rel
r_char
id|rel
(braket
l_int|9
)braket
suffix:semicolon
DECL|member|ver
r_char
id|ver
(braket
l_int|9
)braket
suffix:semicolon
DECL|member|mach
r_char
id|mach
(braket
l_int|9
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|function|sunos_uname
id|asmlinkage
r_int
id|sunos_uname
c_func
(paren
r_struct
id|sunos_utsname
op_star
id|name
)paren
(brace
r_int
id|ret
suffix:semicolon
id|down_read
c_func
(paren
op_amp
id|uts_sem
)paren
suffix:semicolon
id|ret
op_assign
id|copy_to_user
c_func
(paren
op_amp
id|name-&gt;sname
(braket
l_int|0
)braket
comma
op_amp
id|system_utsname.sysname
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|name-&gt;sname
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
id|ret
op_or_assign
id|__copy_to_user
c_func
(paren
op_amp
id|name-&gt;nname
(braket
l_int|0
)braket
comma
op_amp
id|system_utsname.nodename
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|name-&gt;nname
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|ret
op_or_assign
id|__put_user
c_func
(paren
l_char|&squot;&bslash;0&squot;
comma
op_amp
id|name-&gt;nname
(braket
l_int|8
)braket
)paren
suffix:semicolon
id|ret
op_or_assign
id|__copy_to_user
c_func
(paren
op_amp
id|name-&gt;rel
(braket
l_int|0
)braket
comma
op_amp
id|system_utsname.release
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|name-&gt;rel
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|ret
op_or_assign
id|__copy_to_user
c_func
(paren
op_amp
id|name-&gt;ver
(braket
l_int|0
)braket
comma
op_amp
id|system_utsname.version
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|name-&gt;ver
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|ret
op_or_assign
id|__copy_to_user
c_func
(paren
op_amp
id|name-&gt;mach
(braket
l_int|0
)braket
comma
op_amp
id|system_utsname.machine
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|name-&gt;mach
)paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|up_read
c_func
(paren
op_amp
id|uts_sem
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sunos_nosys
id|asmlinkage
r_int
id|sunos_nosys
c_func
(paren
r_void
)paren
(brace
r_struct
id|pt_regs
op_star
id|regs
suffix:semicolon
id|siginfo_t
id|info
suffix:semicolon
r_static
r_int
id|cnt
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|regs
op_assign
id|current-&gt;thread.kregs
suffix:semicolon
id|info.si_signo
op_assign
id|SIGSYS
suffix:semicolon
id|info.si_errno
op_assign
l_int|0
suffix:semicolon
id|info.si_code
op_assign
id|__SI_FAULT
op_or
l_int|0x100
suffix:semicolon
id|info.si_addr
op_assign
(paren
r_void
op_star
)paren
id|regs-&gt;pc
suffix:semicolon
id|info.si_trapno
op_assign
id|regs-&gt;u_regs
(braket
id|UREG_G1
)braket
suffix:semicolon
id|send_sig_info
c_func
(paren
id|SIGSYS
comma
op_amp
id|info
comma
id|current
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnt
op_increment
OL
l_int|4
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Process makes ni_syscall number %d, register dump:&bslash;n&quot;
comma
(paren
r_int
)paren
id|regs-&gt;u_regs
(braket
id|UREG_G1
)braket
)paren
suffix:semicolon
id|show_regs
c_func
(paren
id|regs
)paren
suffix:semicolon
)brace
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOSYS
suffix:semicolon
)brace
multiline_comment|/* This is not a real and complete implementation yet, just to keep&n; * the easy SunOS binaries happy.&n; */
DECL|function|sunos_fpathconf
id|asmlinkage
r_int
id|sunos_fpathconf
c_func
(paren
r_int
id|fd
comma
r_int
id|name
)paren
(brace
r_int
id|ret
suffix:semicolon
r_switch
c_cond
(paren
id|name
)paren
(brace
r_case
id|_PCONF_LINK
suffix:colon
id|ret
op_assign
id|LINK_MAX
suffix:semicolon
r_break
suffix:semicolon
r_case
id|_PCONF_CANON
suffix:colon
id|ret
op_assign
id|MAX_CANON
suffix:semicolon
r_break
suffix:semicolon
r_case
id|_PCONF_INPUT
suffix:colon
id|ret
op_assign
id|MAX_INPUT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|_PCONF_NAME
suffix:colon
id|ret
op_assign
id|NAME_MAX
suffix:semicolon
r_break
suffix:semicolon
r_case
id|_PCONF_PATH
suffix:colon
id|ret
op_assign
id|PATH_MAX
suffix:semicolon
r_break
suffix:semicolon
r_case
id|_PCONF_PIPE
suffix:colon
id|ret
op_assign
id|PIPE_BUF
suffix:semicolon
r_break
suffix:semicolon
r_case
id|_PCONF_CHRESTRICT
suffix:colon
multiline_comment|/* XXX Investigate XXX */
id|ret
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|_PCONF_NOTRUNC
suffix:colon
multiline_comment|/* XXX Investigate XXX */
r_case
id|_PCONF_VDISABLE
suffix:colon
id|ret
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sunos_pathconf
id|asmlinkage
r_int
id|sunos_pathconf
c_func
(paren
r_char
op_star
id|path
comma
r_int
id|name
)paren
(brace
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|sunos_fpathconf
c_func
(paren
l_int|0
comma
id|name
)paren
suffix:semicolon
multiline_comment|/* XXX cheese XXX */
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* SunOS mount system call emulation */
r_extern
id|asmlinkage
r_int
id|sys_select
c_func
(paren
r_int
id|n
comma
id|fd_set
op_star
id|inp
comma
id|fd_set
op_star
id|outp
comma
id|fd_set
op_star
id|exp
comma
r_struct
id|timeval
op_star
id|tvp
)paren
suffix:semicolon
DECL|function|sunos_select
id|asmlinkage
r_int
id|sunos_select
c_func
(paren
r_int
id|width
comma
id|fd_set
op_star
id|inp
comma
id|fd_set
op_star
id|outp
comma
id|fd_set
op_star
id|exp
comma
r_struct
id|timeval
op_star
id|tvp
)paren
(brace
r_int
id|ret
suffix:semicolon
multiline_comment|/* SunOS binaries expect that select won&squot;t change the tvp contents */
id|ret
op_assign
id|sys_select
(paren
id|width
comma
id|inp
comma
id|outp
comma
id|exp
comma
id|tvp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|EINTR
op_logical_and
id|tvp
)paren
(brace
id|time_t
id|sec
comma
id|usec
suffix:semicolon
id|__get_user
c_func
(paren
id|sec
comma
op_amp
id|tvp-&gt;tv_sec
)paren
suffix:semicolon
id|__get_user
c_func
(paren
id|usec
comma
op_amp
id|tvp-&gt;tv_usec
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sec
op_eq
l_int|0
op_logical_and
id|usec
op_eq
l_int|0
)paren
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sunos_nop
id|asmlinkage
r_void
id|sunos_nop
c_func
(paren
r_void
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/* SunOS mount/umount. */
DECL|macro|SMNT_RDONLY
mdefine_line|#define SMNT_RDONLY       1
DECL|macro|SMNT_NOSUID
mdefine_line|#define SMNT_NOSUID       2
DECL|macro|SMNT_NEWTYPE
mdefine_line|#define SMNT_NEWTYPE      4
DECL|macro|SMNT_GRPID
mdefine_line|#define SMNT_GRPID        8
DECL|macro|SMNT_REMOUNT
mdefine_line|#define SMNT_REMOUNT      16
DECL|macro|SMNT_NOSUB
mdefine_line|#define SMNT_NOSUB        32
DECL|macro|SMNT_MULTI
mdefine_line|#define SMNT_MULTI        64
DECL|macro|SMNT_SYS5
mdefine_line|#define SMNT_SYS5         128
DECL|struct|sunos_fh_t
r_struct
id|sunos_fh_t
(brace
DECL|member|fh_data
r_char
id|fh_data
(braket
id|NFS_FHSIZE
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|sunos_nfs_mount_args
r_struct
id|sunos_nfs_mount_args
(brace
DECL|member|addr
r_struct
id|sockaddr_in
op_star
id|addr
suffix:semicolon
multiline_comment|/* file server address */
DECL|member|fh
r_struct
id|nfs_fh
op_star
id|fh
suffix:semicolon
multiline_comment|/* File handle to be mounted */
DECL|member|flags
r_int
id|flags
suffix:semicolon
multiline_comment|/* flags */
DECL|member|wsize
r_int
id|wsize
suffix:semicolon
multiline_comment|/* write size in bytes */
DECL|member|rsize
r_int
id|rsize
suffix:semicolon
multiline_comment|/* read size in bytes */
DECL|member|timeo
r_int
id|timeo
suffix:semicolon
multiline_comment|/* initial timeout in .1 secs */
DECL|member|retrans
r_int
id|retrans
suffix:semicolon
multiline_comment|/* times to retry send */
DECL|member|hostname
r_char
op_star
id|hostname
suffix:semicolon
multiline_comment|/* server&squot;s hostname */
DECL|member|acregmin
r_int
id|acregmin
suffix:semicolon
multiline_comment|/* attr cache file min secs */
DECL|member|acregmax
r_int
id|acregmax
suffix:semicolon
multiline_comment|/* attr cache file max secs */
DECL|member|acdirmin
r_int
id|acdirmin
suffix:semicolon
multiline_comment|/* attr cache dir min secs */
DECL|member|acdirmax
r_int
id|acdirmax
suffix:semicolon
multiline_comment|/* attr cache dir max secs */
DECL|member|netname
r_char
op_star
id|netname
suffix:semicolon
multiline_comment|/* server&squot;s netname */
)brace
suffix:semicolon
r_extern
id|dev_t
id|get_unnamed_dev
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|put_unnamed_dev
c_func
(paren
id|dev_t
)paren
suffix:semicolon
r_extern
id|asmlinkage
r_int
id|sys_connect
c_func
(paren
r_int
id|fd
comma
r_struct
id|sockaddr
op_star
id|uservaddr
comma
r_int
id|addrlen
)paren
suffix:semicolon
r_extern
id|asmlinkage
r_int
id|sys_socket
c_func
(paren
r_int
id|family
comma
r_int
id|type
comma
r_int
id|protocol
)paren
suffix:semicolon
r_extern
id|asmlinkage
r_int
id|sys_bind
c_func
(paren
r_int
id|fd
comma
r_struct
id|sockaddr
op_star
id|umyaddr
comma
r_int
id|addrlen
)paren
suffix:semicolon
multiline_comment|/* Bind the socket on a local reserved port and connect it to the&n; * remote server.  This on Linux/i386 is done by the mount program,&n; * not by the kernel.&n; */
r_static
r_int
DECL|function|sunos_nfs_get_server_fd
id|sunos_nfs_get_server_fd
(paren
r_int
id|fd
comma
r_struct
id|sockaddr_in
op_star
id|addr
)paren
(brace
r_struct
id|sockaddr_in
id|local
suffix:semicolon
r_struct
id|sockaddr_in
id|server
suffix:semicolon
r_int
id|try_port
suffix:semicolon
r_struct
id|socket
op_star
id|socket
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_struct
id|file
op_star
id|file
suffix:semicolon
r_int
id|ret
comma
id|result
op_assign
l_int|0
suffix:semicolon
id|file
op_assign
id|fget
c_func
(paren
id|fd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|file
)paren
r_goto
id|out
suffix:semicolon
id|inode
op_assign
id|file-&gt;f_dentry-&gt;d_inode
suffix:semicolon
id|socket
op_assign
op_amp
id|inode-&gt;u.socket_i
suffix:semicolon
id|local.sin_family
op_assign
id|AF_INET
suffix:semicolon
id|local.sin_addr.s_addr
op_assign
id|INADDR_ANY
suffix:semicolon
multiline_comment|/* IPPORT_RESERVED = 1024, can&squot;t find the definition in the kernel */
id|try_port
op_assign
l_int|1024
suffix:semicolon
r_do
(brace
id|local.sin_port
op_assign
id|htons
(paren
op_decrement
id|try_port
)paren
suffix:semicolon
id|ret
op_assign
id|socket-&gt;ops
op_member_access_from_pointer
id|bind
c_func
(paren
id|socket
comma
(paren
r_struct
id|sockaddr
op_star
)paren
op_amp
id|local
comma
r_sizeof
(paren
id|local
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|ret
op_logical_and
id|try_port
OG
(paren
l_int|1024
op_div
l_int|2
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|out_putf
suffix:semicolon
id|server.sin_family
op_assign
id|AF_INET
suffix:semicolon
id|server.sin_addr
op_assign
id|addr-&gt;sin_addr
suffix:semicolon
id|server.sin_port
op_assign
id|NFS_PORT
suffix:semicolon
multiline_comment|/* Call sys_connect */
id|ret
op_assign
id|socket-&gt;ops-&gt;connect
(paren
id|socket
comma
(paren
r_struct
id|sockaddr
op_star
)paren
op_amp
id|server
comma
r_sizeof
(paren
id|server
)paren
comma
id|file-&gt;f_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ge
l_int|0
)paren
id|result
op_assign
l_int|1
suffix:semicolon
id|out_putf
suffix:colon
id|fput
c_func
(paren
id|file
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
DECL|function|get_default
r_static
r_int
id|get_default
(paren
r_int
id|value
comma
r_int
id|def_value
)paren
(brace
r_if
c_cond
(paren
id|value
)paren
r_return
id|value
suffix:semicolon
r_else
r_return
id|def_value
suffix:semicolon
)brace
DECL|function|sunos_nfs_mount
r_static
r_int
id|sunos_nfs_mount
c_func
(paren
r_char
op_star
id|dir_name
comma
r_int
id|linux_flags
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|server_fd
suffix:semicolon
r_char
op_star
id|the_name
suffix:semicolon
r_struct
id|nfs_mount_data
id|linux_nfs_mount
suffix:semicolon
r_struct
id|sunos_nfs_mount_args
id|sunos_mount
suffix:semicolon
multiline_comment|/* Ok, here comes the fun part: Linux&squot;s nfs mount needs a&n;&t; * socket connection to the server, but SunOS mount does not&n;&t; * require this, so we use the information on the destination&n;&t; * address to create a socket and bind it to a reserved&n;&t; * port on this system&n;&t; */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|sunos_mount
comma
id|data
comma
r_sizeof
(paren
id|sunos_mount
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|server_fd
op_assign
id|sys_socket
(paren
id|AF_INET
comma
id|SOCK_DGRAM
comma
id|IPPROTO_UDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|server_fd
OL
l_int|0
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|linux_nfs_mount.addr
comma
id|sunos_mount.addr
comma
r_sizeof
(paren
op_star
id|sunos_mount.addr
)paren
)paren
op_logical_or
id|copy_from_user
c_func
(paren
op_amp
id|linux_nfs_mount.root
comma
id|sunos_mount.fh
comma
r_sizeof
(paren
op_star
id|sunos_mount.fh
)paren
)paren
)paren
(brace
id|sys_close
(paren
id|server_fd
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|sunos_nfs_get_server_fd
(paren
id|server_fd
comma
op_amp
id|linux_nfs_mount.addr
)paren
)paren
(brace
id|sys_close
(paren
id|server_fd
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
multiline_comment|/* Now, bind it to a locally reserved port */
id|linux_nfs_mount.version
op_assign
id|NFS_MOUNT_VERSION
suffix:semicolon
id|linux_nfs_mount.flags
op_assign
id|sunos_mount.flags
suffix:semicolon
id|linux_nfs_mount.fd
op_assign
id|server_fd
suffix:semicolon
id|linux_nfs_mount.rsize
op_assign
id|get_default
(paren
id|sunos_mount.rsize
comma
l_int|8192
)paren
suffix:semicolon
id|linux_nfs_mount.wsize
op_assign
id|get_default
(paren
id|sunos_mount.wsize
comma
l_int|8192
)paren
suffix:semicolon
id|linux_nfs_mount.timeo
op_assign
id|get_default
(paren
id|sunos_mount.timeo
comma
l_int|10
)paren
suffix:semicolon
id|linux_nfs_mount.retrans
op_assign
id|sunos_mount.retrans
suffix:semicolon
id|linux_nfs_mount.acregmin
op_assign
id|sunos_mount.acregmin
suffix:semicolon
id|linux_nfs_mount.acregmax
op_assign
id|sunos_mount.acregmax
suffix:semicolon
id|linux_nfs_mount.acdirmin
op_assign
id|sunos_mount.acdirmin
suffix:semicolon
id|linux_nfs_mount.acdirmax
op_assign
id|sunos_mount.acdirmax
suffix:semicolon
id|the_name
op_assign
id|getname
c_func
(paren
id|sunos_mount.hostname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|the_name
)paren
)paren
(brace
r_return
id|PTR_ERR
c_func
(paren
id|the_name
)paren
suffix:semicolon
)brace
id|strncpy
(paren
id|linux_nfs_mount.hostname
comma
id|the_name
comma
l_int|254
)paren
suffix:semicolon
id|linux_nfs_mount.hostname
(braket
l_int|255
)braket
op_assign
l_int|0
suffix:semicolon
id|putname
(paren
id|the_name
)paren
suffix:semicolon
r_return
id|do_mount
(paren
l_string|&quot;&quot;
comma
id|dir_name
comma
l_string|&quot;nfs&quot;
comma
id|linux_flags
comma
op_amp
id|linux_nfs_mount
)paren
suffix:semicolon
)brace
id|asmlinkage
r_int
DECL|function|sunos_mount
id|sunos_mount
c_func
(paren
r_char
op_star
id|type
comma
r_char
op_star
id|dir
comma
r_int
id|flags
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|linux_flags
op_assign
id|MS_MGC_MSK
suffix:semicolon
multiline_comment|/* new semantics */
r_int
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_char
op_star
id|dev_fname
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|dir_page
comma
op_star
id|type_page
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* We don&squot;t handle the integer fs type */
r_if
c_cond
(paren
(paren
id|flags
op_amp
id|SMNT_NEWTYPE
)paren
op_eq
l_int|0
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Do not allow for those flags we don&squot;t support */
r_if
c_cond
(paren
id|flags
op_amp
(paren
id|SMNT_GRPID
op_or
id|SMNT_NOSUB
op_or
id|SMNT_MULTI
op_or
id|SMNT_SYS5
)paren
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|SMNT_REMOUNT
)paren
(brace
id|linux_flags
op_or_assign
id|MS_REMOUNT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flags
op_amp
id|SMNT_RDONLY
)paren
(brace
id|linux_flags
op_or_assign
id|MS_RDONLY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flags
op_amp
id|SMNT_NOSUID
)paren
(brace
id|linux_flags
op_or_assign
id|MS_NOSUID
suffix:semicolon
)brace
id|dir_page
op_assign
id|getname
c_func
(paren
id|dir
)paren
suffix:semicolon
id|ret
op_assign
id|PTR_ERR
c_func
(paren
id|dir_page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|dir_page
)paren
)paren
r_goto
id|out
suffix:semicolon
id|type_page
op_assign
id|getname
c_func
(paren
id|type
)paren
suffix:semicolon
id|ret
op_assign
id|PTR_ERR
c_func
(paren
id|type_page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|type_page
)paren
)paren
r_goto
id|out1
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|type_page
comma
l_string|&quot;ext2&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|dev_fname
op_assign
id|getname
c_func
(paren
id|data
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|type_page
comma
l_string|&quot;iso9660&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|dev_fname
op_assign
id|getname
c_func
(paren
id|data
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|type_page
comma
l_string|&quot;minix&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|dev_fname
op_assign
id|getname
c_func
(paren
id|data
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|type_page
comma
l_string|&quot;nfs&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|ret
op_assign
id|sunos_nfs_mount
(paren
id|dir_page
comma
id|flags
comma
id|data
)paren
suffix:semicolon
r_goto
id|out2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|type_page
comma
l_string|&quot;ufs&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Warning: UFS filesystem mounts unsupported.&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|type_page
comma
l_string|&quot;proc&quot;
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out2
suffix:semicolon
)brace
id|ret
op_assign
id|PTR_ERR
c_func
(paren
id|dev_fname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|dev_fname
)paren
)paren
r_goto
id|out2
suffix:semicolon
id|ret
op_assign
id|do_mount
c_func
(paren
id|dev_fname
comma
id|dir_page
comma
id|type_page
comma
id|linux_flags
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_fname
)paren
id|putname
c_func
(paren
id|dev_fname
)paren
suffix:semicolon
id|out2
suffix:colon
id|putname
c_func
(paren
id|type_page
)paren
suffix:semicolon
id|out1
suffix:colon
id|putname
c_func
(paren
id|dir_page
)paren
suffix:semicolon
id|out
suffix:colon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_extern
id|asmlinkage
r_int
id|sys_setsid
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
id|asmlinkage
r_int
id|sys_setpgid
c_func
(paren
id|pid_t
comma
id|pid_t
)paren
suffix:semicolon
DECL|function|sunos_setpgrp
id|asmlinkage
r_int
id|sunos_setpgrp
c_func
(paren
id|pid_t
id|pid
comma
id|pid_t
id|pgid
)paren
(brace
r_int
id|ret
suffix:semicolon
multiline_comment|/* So stupid... */
r_if
c_cond
(paren
(paren
op_logical_neg
id|pid
op_logical_or
id|pid
op_eq
id|current-&gt;pid
)paren
op_logical_and
op_logical_neg
id|pgid
)paren
(brace
id|sys_setsid
c_func
(paren
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|ret
op_assign
id|sys_setpgid
c_func
(paren
id|pid
comma
id|pgid
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* So stupid... */
r_extern
id|asmlinkage
r_int
id|sys_wait4
c_func
(paren
id|pid_t
comma
r_int
r_int
op_star
comma
r_int
comma
r_struct
id|rusage
op_star
)paren
suffix:semicolon
DECL|function|sunos_wait4
id|asmlinkage
r_int
id|sunos_wait4
c_func
(paren
id|pid_t
id|pid
comma
r_int
r_int
op_star
id|stat_addr
comma
r_int
id|options
comma
r_struct
id|rusage
op_star
id|ru
)paren
(brace
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|sys_wait4
c_func
(paren
(paren
id|pid
ques
c_cond
id|pid
suffix:colon
op_minus
l_int|1
)paren
comma
id|stat_addr
comma
id|options
comma
id|ru
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_extern
r_int
id|kill_pg
c_func
(paren
r_int
comma
r_int
comma
r_int
)paren
suffix:semicolon
DECL|function|sunos_killpg
id|asmlinkage
r_int
id|sunos_killpg
c_func
(paren
r_int
id|pgrp
comma
r_int
id|sig
)paren
(brace
r_int
id|ret
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|ret
op_assign
id|kill_pg
c_func
(paren
id|pgrp
comma
id|sig
comma
l_int|0
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sunos_audit
id|asmlinkage
r_int
id|sunos_audit
c_func
(paren
r_void
)paren
(brace
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;sys_audit&bslash;n&quot;
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|sunos_gethostid
r_extern
id|asmlinkage
r_int
r_int
id|sunos_gethostid
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|ret
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|ret
op_assign
(paren
(paren
r_int
r_int
)paren
id|idprom-&gt;id_machtype
op_lshift
l_int|24
)paren
op_or
(paren
r_int
r_int
)paren
id|idprom-&gt;id_sernum
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* sysconf options, for SunOS compatibility */
DECL|macro|_SC_ARG_MAX
mdefine_line|#define   _SC_ARG_MAX             1
DECL|macro|_SC_CHILD_MAX
mdefine_line|#define   _SC_CHILD_MAX           2
DECL|macro|_SC_CLK_TCK
mdefine_line|#define   _SC_CLK_TCK             3
DECL|macro|_SC_NGROUPS_MAX
mdefine_line|#define   _SC_NGROUPS_MAX         4
DECL|macro|_SC_OPEN_MAX
mdefine_line|#define   _SC_OPEN_MAX            5
DECL|macro|_SC_JOB_CONTROL
mdefine_line|#define   _SC_JOB_CONTROL         6
DECL|macro|_SC_SAVED_IDS
mdefine_line|#define   _SC_SAVED_IDS           7
DECL|macro|_SC_VERSION
mdefine_line|#define   _SC_VERSION             8
DECL|function|sunos_sysconf
r_extern
id|asmlinkage
r_int
id|sunos_sysconf
(paren
r_int
id|name
)paren
(brace
r_int
id|ret
suffix:semicolon
r_switch
c_cond
(paren
id|name
)paren
(brace
r_case
id|_SC_ARG_MAX
suffix:colon
id|ret
op_assign
id|ARG_MAX
suffix:semicolon
r_break
suffix:semicolon
r_case
id|_SC_CHILD_MAX
suffix:colon
id|ret
op_assign
id|CHILD_MAX
suffix:semicolon
r_break
suffix:semicolon
r_case
id|_SC_CLK_TCK
suffix:colon
id|ret
op_assign
id|HZ
suffix:semicolon
r_break
suffix:semicolon
r_case
id|_SC_NGROUPS_MAX
suffix:colon
id|ret
op_assign
id|NGROUPS_MAX
suffix:semicolon
r_break
suffix:semicolon
r_case
id|_SC_OPEN_MAX
suffix:colon
id|ret
op_assign
id|OPEN_MAX
suffix:semicolon
r_break
suffix:semicolon
r_case
id|_SC_JOB_CONTROL
suffix:colon
id|ret
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* yes, we do support job control */
r_break
suffix:semicolon
r_case
id|_SC_SAVED_IDS
suffix:colon
id|ret
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* yes, we do support saved uids  */
r_break
suffix:semicolon
r_case
id|_SC_VERSION
suffix:colon
multiline_comment|/* mhm, POSIX_VERSION is in /usr/include/unistd.h&n;&t;&t; * should it go on /usr/include/linux?&n;&t;&t; */
id|ret
op_assign
l_int|199009L
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sunos_semsys
id|asmlinkage
r_int
id|sunos_semsys
c_func
(paren
r_int
id|op
comma
r_int
r_int
id|arg1
comma
r_int
r_int
id|arg2
comma
r_int
r_int
id|arg3
comma
r_void
op_star
id|ptr
)paren
(brace
r_union
id|semun
id|arg4
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_switch
c_cond
(paren
id|op
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* Most arguments match on a 1:1 basis but cmd doesn&squot;t */
r_switch
c_cond
(paren
id|arg3
)paren
(brace
r_case
l_int|4
suffix:colon
id|arg3
op_assign
id|GETPID
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|arg3
op_assign
id|GETVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|arg3
op_assign
id|GETALL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|arg3
op_assign
id|GETNCNT
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|arg3
op_assign
id|GETZCNT
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|arg3
op_assign
id|SETVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|9
suffix:colon
id|arg3
op_assign
id|SETALL
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* sys_semctl(): */
id|arg4.__pad
op_assign
id|ptr
suffix:semicolon
multiline_comment|/* value to modify semaphore to */
id|ret
op_assign
id|sys_semctl
c_func
(paren
(paren
r_int
)paren
id|arg1
comma
(paren
r_int
)paren
id|arg2
comma
(paren
r_int
)paren
id|arg3
comma
id|arg4
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* sys_semget(): */
id|ret
op_assign
id|sys_semget
c_func
(paren
(paren
id|key_t
)paren
id|arg1
comma
(paren
r_int
)paren
id|arg2
comma
(paren
r_int
)paren
id|arg3
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* sys_semop(): */
id|ret
op_assign
id|sys_semop
c_func
(paren
(paren
r_int
)paren
id|arg1
comma
(paren
r_struct
id|sembuf
op_star
)paren
id|arg2
comma
(paren
r_int
)paren
id|arg3
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sunos_msgsys
id|asmlinkage
r_int
id|sunos_msgsys
c_func
(paren
r_int
id|op
comma
r_int
r_int
id|arg1
comma
r_int
r_int
id|arg2
comma
r_int
r_int
id|arg3
comma
r_int
r_int
id|arg4
)paren
(brace
r_struct
id|sparc_stackf
op_star
id|sp
suffix:semicolon
r_int
r_int
id|arg5
suffix:semicolon
r_int
id|rval
suffix:semicolon
r_switch
c_cond
(paren
id|op
)paren
(brace
r_case
l_int|0
suffix:colon
id|rval
op_assign
id|sys_msgget
c_func
(paren
(paren
id|key_t
)paren
id|arg1
comma
(paren
r_int
)paren
id|arg2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|rval
op_assign
id|sys_msgctl
c_func
(paren
(paren
r_int
)paren
id|arg1
comma
(paren
r_int
)paren
id|arg2
comma
(paren
r_struct
id|msqid_ds
op_star
)paren
id|arg3
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|sp
op_assign
(paren
r_struct
id|sparc_stackf
op_star
)paren
id|current-&gt;thread.kregs-&gt;u_regs
(braket
id|UREG_FP
)braket
suffix:semicolon
id|arg5
op_assign
id|sp-&gt;xxargs
(braket
l_int|0
)braket
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
id|rval
op_assign
id|sys_msgrcv
c_func
(paren
(paren
r_int
)paren
id|arg1
comma
(paren
r_struct
id|msgbuf
op_star
)paren
id|arg2
comma
(paren
r_int
)paren
id|arg3
comma
(paren
r_int
)paren
id|arg4
comma
(paren
r_int
)paren
id|arg5
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|rval
op_assign
id|sys_msgsnd
c_func
(paren
(paren
r_int
)paren
id|arg1
comma
(paren
r_struct
id|msgbuf
op_star
)paren
id|arg2
comma
(paren
r_int
)paren
id|arg3
comma
(paren
r_int
)paren
id|arg4
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|rval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|rval
suffix:semicolon
)brace
DECL|function|sunos_shmsys
id|asmlinkage
r_int
id|sunos_shmsys
c_func
(paren
r_int
id|op
comma
r_int
r_int
id|arg1
comma
r_int
r_int
id|arg2
comma
r_int
r_int
id|arg3
)paren
(brace
r_int
r_int
id|raddr
suffix:semicolon
r_int
id|rval
suffix:semicolon
r_switch
c_cond
(paren
id|op
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* sys_shmat(): attach a shared memory area */
id|rval
op_assign
id|sys_shmat
c_func
(paren
(paren
r_int
)paren
id|arg1
comma
(paren
r_char
op_star
)paren
id|arg2
comma
(paren
r_int
)paren
id|arg3
comma
op_amp
id|raddr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rval
)paren
(brace
id|rval
op_assign
(paren
r_int
)paren
id|raddr
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* sys_shmctl(): modify shared memory area attr. */
id|rval
op_assign
id|sys_shmctl
c_func
(paren
(paren
r_int
)paren
id|arg1
comma
(paren
r_int
)paren
id|arg2
comma
(paren
r_struct
id|shmid_ds
op_star
)paren
id|arg3
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* sys_shmdt(): detach a shared memory area */
id|rval
op_assign
id|sys_shmdt
c_func
(paren
(paren
r_char
op_star
)paren
id|arg1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* sys_shmget(): get a shared memory area */
id|rval
op_assign
id|sys_shmget
c_func
(paren
(paren
id|key_t
)paren
id|arg1
comma
(paren
r_int
)paren
id|arg2
comma
(paren
r_int
)paren
id|arg3
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|rval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
r_return
id|rval
suffix:semicolon
)brace
DECL|macro|SUNOS_EWOULDBLOCK
mdefine_line|#define SUNOS_EWOULDBLOCK 35
multiline_comment|/* see the sunos man page read(2v) for an explanation&n;   of this garbage. We use O_NDELAY to mark&n;   file descriptors that have been set non-blocking &n;   using 4.2BSD style calls. (tridge) */
DECL|function|check_nonblock
r_static
r_inline
r_int
id|check_nonblock
c_func
(paren
r_int
id|ret
comma
r_int
id|fd
)paren
(brace
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|EAGAIN
)paren
(brace
r_struct
id|file
op_star
id|file
op_assign
id|fget
c_func
(paren
id|fd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file
)paren
(brace
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NDELAY
)paren
id|ret
op_assign
op_minus
id|SUNOS_EWOULDBLOCK
suffix:semicolon
id|fput
c_func
(paren
id|file
)paren
suffix:semicolon
)brace
)brace
r_return
id|ret
suffix:semicolon
)brace
r_extern
id|asmlinkage
r_int
id|sys_read
c_func
(paren
r_int
r_int
id|fd
comma
r_char
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
r_extern
id|asmlinkage
r_int
id|sys_write
c_func
(paren
r_int
r_int
id|fd
comma
r_char
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
r_extern
id|asmlinkage
r_int
id|sys_recv
c_func
(paren
r_int
id|fd
comma
r_void
op_star
id|ubuf
comma
r_int
id|size
comma
r_int
id|flags
)paren
suffix:semicolon
r_extern
id|asmlinkage
r_int
id|sys_send
c_func
(paren
r_int
id|fd
comma
r_void
op_star
id|buff
comma
r_int
id|len
comma
r_int
id|flags
)paren
suffix:semicolon
r_extern
id|asmlinkage
r_int
id|sys_accept
c_func
(paren
r_int
id|fd
comma
r_struct
id|sockaddr
op_star
id|sa
comma
r_int
op_star
id|addrlen
)paren
suffix:semicolon
r_extern
id|asmlinkage
r_int
id|sys_readv
c_func
(paren
r_int
r_int
id|fd
comma
r_const
r_struct
id|iovec
op_star
id|vector
comma
r_int
id|count
)paren
suffix:semicolon
r_extern
id|asmlinkage
r_int
id|sys_writev
c_func
(paren
r_int
r_int
id|fd
comma
r_const
r_struct
id|iovec
op_star
id|vector
comma
r_int
id|count
)paren
suffix:semicolon
DECL|function|sunos_read
id|asmlinkage
r_int
id|sunos_read
c_func
(paren
r_int
r_int
id|fd
comma
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|check_nonblock
c_func
(paren
id|sys_read
c_func
(paren
id|fd
comma
id|buf
comma
id|count
)paren
comma
id|fd
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sunos_readv
id|asmlinkage
r_int
id|sunos_readv
c_func
(paren
r_int
r_int
id|fd
comma
r_const
r_struct
id|iovec
op_star
id|vector
comma
r_int
id|count
)paren
(brace
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|check_nonblock
c_func
(paren
id|sys_readv
c_func
(paren
id|fd
comma
id|vector
comma
id|count
)paren
comma
id|fd
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sunos_write
id|asmlinkage
r_int
id|sunos_write
c_func
(paren
r_int
r_int
id|fd
comma
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|check_nonblock
c_func
(paren
id|sys_write
c_func
(paren
id|fd
comma
id|buf
comma
id|count
)paren
comma
id|fd
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sunos_writev
id|asmlinkage
r_int
id|sunos_writev
c_func
(paren
r_int
r_int
id|fd
comma
r_const
r_struct
id|iovec
op_star
id|vector
comma
r_int
id|count
)paren
(brace
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|check_nonblock
c_func
(paren
id|sys_writev
c_func
(paren
id|fd
comma
id|vector
comma
id|count
)paren
comma
id|fd
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sunos_recv
id|asmlinkage
r_int
id|sunos_recv
c_func
(paren
r_int
id|fd
comma
r_void
op_star
id|ubuf
comma
r_int
id|size
comma
r_int
id|flags
)paren
(brace
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|check_nonblock
c_func
(paren
id|sys_recv
c_func
(paren
id|fd
comma
id|ubuf
comma
id|size
comma
id|flags
)paren
comma
id|fd
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sunos_send
id|asmlinkage
r_int
id|sunos_send
c_func
(paren
r_int
id|fd
comma
r_void
op_star
id|buff
comma
r_int
id|len
comma
r_int
id|flags
)paren
(brace
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|check_nonblock
c_func
(paren
id|sys_send
c_func
(paren
id|fd
comma
id|buff
comma
id|len
comma
id|flags
)paren
comma
id|fd
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_extern
id|asmlinkage
r_int
id|sys_setsockopt
c_func
(paren
r_int
id|fd
comma
r_int
id|level
comma
r_int
id|optname
comma
r_char
op_star
id|optval
comma
r_int
id|optlen
)paren
suffix:semicolon
DECL|function|sunos_socket
id|asmlinkage
r_int
id|sunos_socket
c_func
(paren
r_int
id|family
comma
r_int
id|type
comma
r_int
id|protocol
)paren
(brace
r_int
id|ret
comma
id|one
op_assign
l_int|1
suffix:semicolon
id|ret
op_assign
id|sys_socket
c_func
(paren
id|family
comma
id|type
comma
id|protocol
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|sys_setsockopt
c_func
(paren
id|ret
comma
id|SOL_SOCKET
comma
id|SO_BSDCOMPAT
comma
(paren
r_char
op_star
)paren
op_amp
id|one
comma
r_sizeof
(paren
id|one
)paren
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sunos_accept
id|asmlinkage
r_int
id|sunos_accept
c_func
(paren
r_int
id|fd
comma
r_struct
id|sockaddr
op_star
id|sa
comma
r_int
op_star
id|addrlen
)paren
(brace
r_int
id|ret
comma
id|one
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|ret
op_assign
id|check_nonblock
c_func
(paren
id|sys_accept
c_func
(paren
id|fd
comma
id|sa
comma
id|addrlen
)paren
comma
id|fd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
op_minus
id|ENETUNREACH
op_logical_and
id|ret
op_ne
op_minus
id|EHOSTUNREACH
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|sys_setsockopt
c_func
(paren
id|ret
comma
id|SOL_SOCKET
comma
id|SO_BSDCOMPAT
comma
(paren
r_char
op_star
)paren
op_amp
id|one
comma
r_sizeof
(paren
id|one
)paren
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|macro|SUNOS_SV_INTERRUPT
mdefine_line|#define SUNOS_SV_INTERRUPT 2
id|asmlinkage
r_int
DECL|function|sunos_sigaction
id|sunos_sigaction
c_func
(paren
r_int
id|sig
comma
r_const
r_struct
id|old_sigaction
op_star
id|act
comma
r_struct
id|old_sigaction
op_star
id|oact
)paren
(brace
r_struct
id|k_sigaction
id|new_ka
comma
id|old_ka
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|act
)paren
(brace
id|old_sigset_t
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|act
comma
r_sizeof
(paren
op_star
id|act
)paren
)paren
op_logical_or
id|__get_user
c_func
(paren
id|new_ka.sa.sa_handler
comma
op_amp
id|act-&gt;sa_handler
)paren
op_logical_or
id|__get_user
c_func
(paren
id|new_ka.sa.sa_flags
comma
op_amp
id|act-&gt;sa_flags
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|__get_user
c_func
(paren
id|mask
comma
op_amp
id|act-&gt;sa_mask
)paren
suffix:semicolon
id|new_ka.sa.sa_restorer
op_assign
l_int|NULL
suffix:semicolon
id|new_ka.ka_restorer
op_assign
l_int|NULL
suffix:semicolon
id|siginitset
c_func
(paren
op_amp
id|new_ka.sa.sa_mask
comma
id|mask
)paren
suffix:semicolon
id|new_ka.sa.sa_flags
op_xor_assign
id|SUNOS_SV_INTERRUPT
suffix:semicolon
)brace
id|ret
op_assign
id|do_sigaction
c_func
(paren
id|sig
comma
id|act
ques
c_cond
op_amp
id|new_ka
suffix:colon
l_int|NULL
comma
id|oact
ques
c_cond
op_amp
id|old_ka
suffix:colon
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
op_logical_and
id|oact
)paren
(brace
multiline_comment|/* In the clone() case we could copy half consistant&n;&t;&t; * state to the user, however this could sleep and&n;&t;&t; * deadlock us if we held the signal lock on SMP.  So for&n;&t;&t; * now I take the easy way out and do no locking.&n;&t;&t; * But then again we don&squot;t support SunOS lwp&squot;s anyways ;-)&n;&t;&t; */
id|old_ka.sa.sa_flags
op_xor_assign
id|SUNOS_SV_INTERRUPT
suffix:semicolon
r_if
c_cond
(paren
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|oact
comma
r_sizeof
(paren
op_star
id|oact
)paren
)paren
op_logical_or
id|__put_user
c_func
(paren
id|old_ka.sa.sa_handler
comma
op_amp
id|oact-&gt;sa_handler
)paren
op_logical_or
id|__put_user
c_func
(paren
id|old_ka.sa.sa_flags
comma
op_amp
id|oact-&gt;sa_flags
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|__put_user
c_func
(paren
id|old_ka.sa.sa_mask.sig
(braket
l_int|0
)braket
comma
op_amp
id|oact-&gt;sa_mask
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
r_extern
id|asmlinkage
r_int
id|sys_setsockopt
c_func
(paren
r_int
id|fd
comma
r_int
id|level
comma
r_int
id|optname
comma
r_char
op_star
id|optval
comma
r_int
id|optlen
)paren
suffix:semicolon
r_extern
id|asmlinkage
r_int
id|sys_getsockopt
c_func
(paren
r_int
id|fd
comma
r_int
id|level
comma
r_int
id|optname
comma
r_char
op_star
id|optval
comma
r_int
op_star
id|optlen
)paren
suffix:semicolon
DECL|function|sunos_setsockopt
id|asmlinkage
r_int
id|sunos_setsockopt
c_func
(paren
r_int
id|fd
comma
r_int
id|level
comma
r_int
id|optname
comma
r_char
op_star
id|optval
comma
r_int
id|optlen
)paren
(brace
r_int
id|tr_opt
op_assign
id|optname
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|level
op_eq
id|SOL_IP
)paren
(brace
multiline_comment|/* Multicast socketopts (ttl, membership) */
r_if
c_cond
(paren
id|tr_opt
op_ge
l_int|2
op_logical_and
id|tr_opt
op_le
l_int|6
)paren
id|tr_opt
op_add_assign
l_int|30
suffix:semicolon
)brace
id|ret
op_assign
id|sys_setsockopt
c_func
(paren
id|fd
comma
id|level
comma
id|tr_opt
comma
id|optval
comma
id|optlen
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sunos_getsockopt
id|asmlinkage
r_int
id|sunos_getsockopt
c_func
(paren
r_int
id|fd
comma
r_int
id|level
comma
r_int
id|optname
comma
r_char
op_star
id|optval
comma
r_int
op_star
id|optlen
)paren
(brace
r_int
id|tr_opt
op_assign
id|optname
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|level
op_eq
id|SOL_IP
)paren
(brace
multiline_comment|/* Multicast socketopts (ttl, membership) */
r_if
c_cond
(paren
id|tr_opt
op_ge
l_int|2
op_logical_and
id|tr_opt
op_le
l_int|6
)paren
id|tr_opt
op_add_assign
l_int|30
suffix:semicolon
)brace
id|ret
op_assign
id|sys_getsockopt
c_func
(paren
id|fd
comma
id|level
comma
id|tr_opt
comma
id|optval
comma
id|optlen
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
eof
