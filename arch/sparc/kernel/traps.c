multiline_comment|/* $Id: traps.c,v 1.18 1995/11/25 00:58:47 davem Exp $&n; * arch/sparc/kernel/traps.c&n; *&n; * Copyright 1995 David S. Miller (davem@caip.rutgers.edu)&n; */
multiline_comment|/*&n; * I hate traps on the sparc, grrr...&n; */
macro_line|#include &lt;linux/sched.h&gt;  /* for jiffies */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;asm/delay.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/ptrace.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/mp.h&gt;
macro_line|#include &lt;asm/kdebug.h&gt;
r_void
DECL|function|syscall_trace_entry
id|syscall_trace_entry
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s[%d]: sys[%d](%d, %d, %d, %d) &quot;
comma
id|current-&gt;comm
comma
id|current-&gt;pid
comma
id|regs-&gt;u_regs
(braket
id|UREG_G1
)braket
comma
id|regs-&gt;u_regs
(braket
id|UREG_I0
)braket
comma
id|regs-&gt;u_regs
(braket
id|UREG_I1
)braket
comma
id|regs-&gt;u_regs
(braket
id|UREG_I2
)braket
comma
id|regs-&gt;u_regs
(braket
id|UREG_I3
)braket
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|syscall_trace_exit
id|syscall_trace_exit
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;retvals[%d,%d] at pc&lt;%08lx&gt;&bslash;n&quot;
comma
id|regs-&gt;u_regs
(braket
id|UREG_I0
)braket
comma
id|regs-&gt;u_regs
(braket
id|UREG_I1
)braket
comma
id|regs-&gt;pc
comma
id|regs-&gt;npc
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|do_cwp_assertion_failure
id|do_cwp_assertion_failure
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|psr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;CWP return from trap assertion fails:&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Current psr %08lx, new psr %08lx&bslash;n&quot;
comma
id|psr
comma
id|regs-&gt;psr
)paren
suffix:semicolon
id|show_regs
c_func
(paren
id|regs
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;bogus CWP&quot;
)paren
suffix:semicolon
)brace
r_void
DECL|function|do_hw_interrupt
id|do_hw_interrupt
c_func
(paren
r_int
r_int
id|type
comma
r_int
r_int
id|psr
comma
r_int
r_int
id|pc
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Unimplemented Sparc TRAP, type = %02lx psr = %08lx pc = %08lx&bslash;n&quot;
comma
id|type
comma
id|psr
comma
id|pc
)paren
suffix:semicolon
id|halt
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|do_illegal_instruction
id|do_illegal_instruction
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|pc
comma
r_int
r_int
id|npc
comma
r_int
r_int
id|psr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Illegal instruction at PC %08lx NPC %08lx PSR %08lx&bslash;n&quot;
comma
id|pc
comma
id|npc
comma
id|psr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|psr
op_amp
id|PSR_PS
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Kernel illegal instruction, how are ya!&quot;
)paren
suffix:semicolon
)brace
id|current-&gt;tss.sig_address
op_assign
id|pc
suffix:semicolon
id|current-&gt;tss.sig_desc
op_assign
id|SUBSIG_ILLINST
suffix:semicolon
id|send_sig
c_func
(paren
id|SIGILL
comma
id|current
comma
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|do_priv_instruction
id|do_priv_instruction
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|pc
comma
r_int
r_int
id|npc
comma
r_int
r_int
id|psr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Privileged instruction at PC %08lx NPC %08lx PSR %08lx&bslash;n&quot;
comma
id|pc
comma
id|npc
comma
id|psr
)paren
suffix:semicolon
id|current-&gt;tss.sig_address
op_assign
id|pc
suffix:semicolon
id|current-&gt;tss.sig_desc
op_assign
id|SUBSIG_PRIVINST
suffix:semicolon
id|send_sig
c_func
(paren
id|SIGILL
comma
id|current
comma
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* XXX User may want to be allowed to do this. XXX */
r_void
DECL|function|do_memaccess_unaligned
id|do_memaccess_unaligned
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|pc
comma
r_int
r_int
id|npc
comma
r_int
r_int
id|psr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Unaligned memory access at PC %08lx NPC %08lx PSR %08lx&bslash;n&quot;
comma
id|pc
comma
id|npc
comma
id|psr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|regs-&gt;psr
op_amp
id|PSR_PS
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Kernel does unaligned memory access, yuck!&quot;
)paren
suffix:semicolon
)brace
id|current-&gt;tss.sig_address
op_assign
id|pc
suffix:semicolon
id|current-&gt;tss.sig_desc
op_assign
id|SUBSIG_PRIVINST
suffix:semicolon
id|send_sig
c_func
(paren
id|SIGBUS
comma
id|current
comma
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|do_fpd_trap
id|do_fpd_trap
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|pc
comma
r_int
r_int
id|npc
comma
r_int
r_int
id|psr
)paren
(brace
multiline_comment|/* Sanity check... */
r_if
c_cond
(paren
id|psr
op_amp
id|PSR_PS
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;FPE disabled trap from kernel, die die die...&quot;
)paren
suffix:semicolon
)brace
id|put_psr
c_func
(paren
id|get_psr
c_func
(paren
)paren
op_or
id|PSR_EF
)paren
suffix:semicolon
multiline_comment|/* Allow FPU ops. */
r_if
c_cond
(paren
id|last_task_used_math
op_eq
id|current
)paren
(brace
multiline_comment|/* No state save necessary */
id|regs-&gt;psr
op_or_assign
id|PSR_EF
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|last_task_used_math
)paren
(brace
multiline_comment|/* Other processes fpu state, save away */
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;st %%fsr, [%0]&bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
op_amp
id|current-&gt;tss.fsr
)paren
suffix:colon
l_string|&quot;memory&quot;
)paren
suffix:semicolon
multiline_comment|/* Save away the floating point queue if necessary. */
r_if
c_cond
(paren
id|current-&gt;tss.fsr
op_amp
l_int|0x2000
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;mov 0x0, %%g2&bslash;n&bslash;t&quot;
l_string|&quot;1: std %%fq, [%2 + %%g2]&bslash;n&bslash;t&quot;
l_string|&quot;st %%fsr, [%0]&bslash;n&bslash;t&quot;
l_string|&quot;ld [%0], %%g3&bslash;n&bslash;t&quot;
l_string|&quot;andcc %%g3, %1, %%g0&bslash;n&bslash;t&quot;
l_string|&quot;bne 1b&bslash;n&bslash;t&quot;
l_string|&quot;add %%g2, 0x8, %%g2&bslash;n&bslash;t&quot;
l_string|&quot;srl %%g2, 0x3, %%g2&bslash;n&bslash;t&quot;
l_string|&quot;st %%g2, [%3]&bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
op_amp
id|current-&gt;tss.fsr
)paren
comma
l_string|&quot;r&quot;
(paren
l_int|0x2000
)paren
comma
l_string|&quot;r&quot;
(paren
op_amp
id|current-&gt;tss.fpqueue
(braket
l_int|0
)braket
)paren
comma
l_string|&quot;r&quot;
(paren
op_amp
id|current-&gt;tss.fpqdepth
)paren
suffix:colon
l_string|&quot;g2&quot;
comma
l_string|&quot;g3&quot;
comma
l_string|&quot;memory&quot;
)paren
suffix:semicolon
)brace
r_else
id|current-&gt;tss.fpqdepth
op_assign
l_int|0
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;std %%f0, [%0 + 0x00]&bslash;n&bslash;t&quot;
l_string|&quot;std %%f2, [%0 + 0x08]&bslash;n&bslash;t&quot;
l_string|&quot;std %%f4, [%0 + 0x10]&bslash;n&bslash;t&quot;
l_string|&quot;std %%f6, [%0 + 0x18]&bslash;n&bslash;t&quot;
l_string|&quot;std %%f8, [%0 + 0x20]&bslash;n&bslash;t&quot;
l_string|&quot;std %%f10, [%0 + 0x28]&bslash;n&bslash;t&quot;
l_string|&quot;std %%f12, [%0 + 0x30]&bslash;n&bslash;t&quot;
l_string|&quot;std %%f14, [%0 + 0x38]&bslash;n&bslash;t&quot;
l_string|&quot;std %%f16, [%0 + 0x40]&bslash;n&bslash;t&quot;
l_string|&quot;std %%f18, [%0 + 0x48]&bslash;n&bslash;t&quot;
l_string|&quot;std %%f20, [%0 + 0x50]&bslash;n&bslash;t&quot;
l_string|&quot;std %%f22, [%0 + 0x58]&bslash;n&bslash;t&quot;
l_string|&quot;std %%f24, [%0 + 0x60]&bslash;n&bslash;t&quot;
l_string|&quot;std %%f26, [%0 + 0x68]&bslash;n&bslash;t&quot;
l_string|&quot;std %%f28, [%0 + 0x70]&bslash;n&bslash;t&quot;
l_string|&quot;std %%f30, [%0 + 0x78]&bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
op_amp
id|current-&gt;tss.float_regs
(braket
l_int|0
)braket
)paren
suffix:colon
l_string|&quot;memory&quot;
)paren
suffix:semicolon
)brace
id|last_task_used_math
op_assign
id|current
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;used_math
)paren
(brace
multiline_comment|/* Restore the old state. */
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;ldd [%0 + 0x00], %%f0&bslash;n&bslash;t&quot;
l_string|&quot;ldd [%0 + 0x08], %%f2&bslash;n&bslash;t&quot;
l_string|&quot;ldd [%0 + 0x10], %%f4&bslash;n&bslash;t&quot;
l_string|&quot;ldd [%0 + 0x18], %%f6&bslash;n&bslash;t&quot;
l_string|&quot;ldd [%0 + 0x20], %%f8&bslash;n&bslash;t&quot;
l_string|&quot;ldd [%0 + 0x28], %%f10&bslash;n&bslash;t&quot;
l_string|&quot;ldd [%0 + 0x30], %%f12&bslash;n&bslash;t&quot;
l_string|&quot;ldd [%0 + 0x38], %%f14&bslash;n&bslash;t&quot;
l_string|&quot;ldd [%0 + 0x40], %%f16&bslash;n&bslash;t&quot;
l_string|&quot;ldd [%0 + 0x48], %%f18&bslash;n&bslash;t&quot;
l_string|&quot;ldd [%0 + 0x50], %%f20&bslash;n&bslash;t&quot;
l_string|&quot;ldd [%0 + 0x58], %%f22&bslash;n&bslash;t&quot;
l_string|&quot;ldd [%0 + 0x60], %%f24&bslash;n&bslash;t&quot;
l_string|&quot;ldd [%0 + 0x68], %%f26&bslash;n&bslash;t&quot;
l_string|&quot;ldd [%0 + 0x70], %%f28&bslash;n&bslash;t&quot;
l_string|&quot;ldd [%0 + 0x78], %%f30&bslash;n&bslash;t&quot;
l_string|&quot;ld  [%1], %%fsr&bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
op_amp
id|current-&gt;tss.float_regs
(braket
l_int|0
)braket
)paren
comma
l_string|&quot;r&quot;
(paren
op_amp
id|current-&gt;tss.fsr
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Set initial sane state. */
r_auto
r_int
r_int
id|init_fsr
op_assign
l_int|0x0UL
suffix:semicolon
r_auto
r_int
r_int
id|init_fregs
(braket
l_int|32
)braket
id|__attribute__
(paren
(paren
id|aligned
(paren
l_int|8
)paren
)paren
)paren
op_assign
(brace
op_complement
l_int|0UL
comma
op_complement
l_int|0UL
comma
op_complement
l_int|0UL
comma
op_complement
l_int|0UL
comma
op_complement
l_int|0UL
comma
op_complement
l_int|0UL
comma
op_complement
l_int|0UL
comma
op_complement
l_int|0UL
comma
op_complement
l_int|0UL
comma
op_complement
l_int|0UL
comma
op_complement
l_int|0UL
comma
op_complement
l_int|0UL
comma
op_complement
l_int|0UL
comma
op_complement
l_int|0UL
comma
op_complement
l_int|0UL
comma
op_complement
l_int|0UL
comma
op_complement
l_int|0UL
comma
op_complement
l_int|0UL
comma
op_complement
l_int|0UL
comma
op_complement
l_int|0UL
comma
op_complement
l_int|0UL
comma
op_complement
l_int|0UL
comma
op_complement
l_int|0UL
comma
op_complement
l_int|0UL
comma
op_complement
l_int|0UL
comma
op_complement
l_int|0UL
comma
op_complement
l_int|0UL
comma
op_complement
l_int|0UL
comma
op_complement
l_int|0UL
comma
op_complement
l_int|0UL
comma
op_complement
l_int|0UL
comma
op_complement
l_int|0UL
)brace
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;ldd [%0 + 0x00], %%f0&bslash;n&bslash;t&quot;
l_string|&quot;ldd [%0 + 0x08], %%f2&bslash;n&bslash;t&quot;
l_string|&quot;ldd [%0 + 0x10], %%f4&bslash;n&bslash;t&quot;
l_string|&quot;ldd [%0 + 0x18], %%f6&bslash;n&bslash;t&quot;
l_string|&quot;ldd [%0 + 0x20], %%f8&bslash;n&bslash;t&quot;
l_string|&quot;ldd [%0 + 0x28], %%f10&bslash;n&bslash;t&quot;
l_string|&quot;ldd [%0 + 0x30], %%f12&bslash;n&bslash;t&quot;
l_string|&quot;ldd [%0 + 0x38], %%f14&bslash;n&bslash;t&quot;
l_string|&quot;ldd [%0 + 0x40], %%f16&bslash;n&bslash;t&quot;
l_string|&quot;ldd [%0 + 0x48], %%f18&bslash;n&bslash;t&quot;
l_string|&quot;ldd [%0 + 0x50], %%f20&bslash;n&bslash;t&quot;
l_string|&quot;ldd [%0 + 0x58], %%f22&bslash;n&bslash;t&quot;
l_string|&quot;ldd [%0 + 0x60], %%f24&bslash;n&bslash;t&quot;
l_string|&quot;ldd [%0 + 0x68], %%f26&bslash;n&bslash;t&quot;
l_string|&quot;ldd [%0 + 0x70], %%f28&bslash;n&bslash;t&quot;
l_string|&quot;ldd [%0 + 0x78], %%f30&bslash;n&bslash;t&quot;
l_string|&quot;ld  [%1], %%fsr&bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
op_amp
id|init_fregs
(braket
l_int|0
)braket
)paren
comma
l_string|&quot;r&quot;
(paren
op_amp
id|init_fsr
)paren
suffix:colon
l_string|&quot;memory&quot;
)paren
suffix:semicolon
id|current-&gt;used_math
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_void
DECL|function|do_fpe_trap
id|do_fpe_trap
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|pc
comma
r_int
r_int
id|npc
comma
r_int
r_int
id|psr
)paren
(brace
r_if
c_cond
(paren
id|psr
op_amp
id|PSR_PS
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;FPE exception trap from kernel, die die die...&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* XXX Do something real... XXX */
id|regs-&gt;psr
op_and_assign
op_complement
id|PSR_EF
suffix:semicolon
id|last_task_used_math
op_assign
(paren
r_struct
id|task_struct
op_star
)paren
l_int|0
suffix:semicolon
id|current-&gt;tss.sig_address
op_assign
id|pc
suffix:semicolon
id|current-&gt;tss.sig_desc
op_assign
id|SUBSIG_FPERROR
suffix:semicolon
multiline_comment|/* as good as any */
id|send_sig
c_func
(paren
id|SIGFPE
comma
id|current
comma
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|handle_tag_overflow
id|handle_tag_overflow
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|pc
comma
r_int
r_int
id|npc
comma
r_int
r_int
id|psr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Tag overflow trap at PC %08lx NPC %08lx PSR %08lx&bslash;n&quot;
comma
id|pc
comma
id|npc
comma
id|psr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|psr
op_amp
id|PSR_PS
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;KERNEL tag overflow trap, wowza!&quot;
)paren
suffix:semicolon
)brace
id|current-&gt;tss.sig_address
op_assign
id|pc
suffix:semicolon
id|current-&gt;tss.sig_desc
op_assign
id|SUBSIG_TAG
suffix:semicolon
multiline_comment|/* as good as any */
id|send_sig
c_func
(paren
id|SIGEMT
comma
id|current
comma
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|handle_watchpoint
id|handle_watchpoint
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|pc
comma
r_int
r_int
id|npc
comma
r_int
r_int
id|psr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Watchpoint detected at PC %08lx NPC %08lx PSR %08lx&bslash;n&quot;
comma
id|pc
comma
id|npc
comma
id|psr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|psr
op_amp
id|PSR_PS
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Tell me what a watchpoint trap is, and I&squot;ll then deal &quot;
l_string|&quot;with such a beast...&quot;
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_void
DECL|function|handle_reg_access
id|handle_reg_access
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|pc
comma
r_int
r_int
id|npc
comma
r_int
r_int
id|psr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Register Access Exception at PC %08lx NPC %08lx PSR %08lx&bslash;n&quot;
comma
id|pc
comma
id|npc
comma
id|psr
)paren
suffix:semicolon
id|halt
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|handle_cp_disabled
id|handle_cp_disabled
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|pc
comma
r_int
r_int
id|npc
comma
r_int
r_int
id|psr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Co-Processor disabled trap at PC %08lx NPC %08lx PSR %08lx&bslash;n&quot;
comma
id|pc
comma
id|npc
comma
id|psr
)paren
suffix:semicolon
id|halt
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|handle_bad_flush
id|handle_bad_flush
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|pc
comma
r_int
r_int
id|npc
comma
r_int
r_int
id|psr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Unimplemented FLUSH Exception at PC %08lx NPC %08lx PSR %08lx&bslash;n&quot;
comma
id|pc
comma
id|npc
comma
id|psr
)paren
suffix:semicolon
id|halt
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|handle_cp_exception
id|handle_cp_exception
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|pc
comma
r_int
r_int
id|npc
comma
r_int
r_int
id|psr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Co-Processor Exception at PC %08lx NPC %08lx PSR %08lx&bslash;n&quot;
comma
id|pc
comma
id|npc
comma
id|psr
)paren
suffix:semicolon
id|halt
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|handle_hw_divzero
id|handle_hw_divzero
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|pc
comma
r_int
r_int
id|npc
comma
r_int
r_int
id|psr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Divide By Zero Exception at PC %08lx NPC %08lx PSR %08lx&bslash;n&quot;
comma
id|pc
comma
id|npc
comma
id|psr
)paren
suffix:semicolon
id|halt
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|do_ast
r_void
id|do_ast
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Don&squot;t know how to handle AST traps yet ;-(&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Since we have our mappings set up, on multiprocessors we can spin them&n; * up here so that timer interrupts work during initialization.&n; */
r_extern
r_void
id|sparc_cpu_startup
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_int
id|linux_num_cpus
suffix:semicolon
r_extern
id|pgd_t
op_star
id|lnx_root
suffix:semicolon
DECL|variable|linux_smp_still_initting
r_int
id|linux_smp_still_initting
suffix:semicolon
DECL|variable|thiscpus_tbr
r_int
r_int
id|thiscpus_tbr
suffix:semicolon
DECL|variable|thiscpus_mid
r_int
id|thiscpus_mid
suffix:semicolon
r_void
DECL|function|trap_init
id|trap_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|linux_prom_registers
id|ctx_reg
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|linux_num_cpus
op_eq
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;trap_init: Uniprocessor detected.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sparc_cpu_model
op_ne
id|sun4m
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;trap_init: Multiprocessor on a non-sun4m! Aieee...&bslash;n&quot;
)paren
suffix:semicolon
id|prom_printf
c_func
(paren
l_string|&quot;trap_init: Cannot continue, bailing out.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Ok, we are on a sun4m with multiple cpu&squot;s */
id|prom_printf
c_func
(paren
l_string|&quot;trap_init: Multiprocessor detected, initiating CPU-startup. cpus=%d&bslash;n&quot;
comma
id|linux_num_cpus
)paren
suffix:semicolon
id|linux_smp_still_initting
op_assign
l_int|1
suffix:semicolon
id|ctx_reg.which_io
op_assign
l_int|0x0
suffix:semicolon
multiline_comment|/* real ram */
id|ctx_reg.phys_addr
op_assign
(paren
r_char
op_star
)paren
(paren
(paren
(paren
r_int
r_int
)paren
id|lnx_root
)paren
op_minus
id|PAGE_OFFSET
)paren
suffix:semicolon
id|ctx_reg.reg_size
op_assign
l_int|0x0
suffix:semicolon
multiline_comment|/* This basically takes every cpu, loads up our Linux context table&n;&t; * into it&squot;s context table pointer register, inits it at the low level&n;&t; * and then makes it spin in an endless loop...&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|linux_num_cpus
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|linux_cpus
(braket
id|i
)braket
dot
id|mid
op_amp
(paren
op_complement
l_int|8
)paren
)paren
op_ne
l_int|0x0
)paren
(brace
r_static
r_int
id|cpuid
op_assign
l_int|0
suffix:semicolon
id|cpuid
op_assign
(paren
id|linux_cpus
(braket
id|i
)braket
dot
id|mid
op_amp
(paren
op_complement
l_int|8
)paren
)paren
suffix:semicolon
id|percpu_table
(braket
id|cpuid
)braket
dot
id|cpu_is_alive
op_assign
l_int|0
suffix:semicolon
id|thiscpus_mid
op_assign
id|linux_cpus
(braket
id|i
)braket
dot
id|mid
suffix:semicolon
id|thiscpus_tbr
op_assign
(paren
r_int
r_int
)paren
id|percpu_table
(braket
id|cpuid
)braket
dot
id|trap_table
suffix:semicolon
id|prom_startcpu
c_func
(paren
id|linux_cpus
(braket
id|i
)braket
dot
id|prom_node
comma
op_amp
id|ctx_reg
comma
l_int|0x0
comma
(paren
r_char
op_star
)paren
id|sparc_cpu_startup
)paren
suffix:semicolon
id|prom_printf
c_func
(paren
l_string|&quot;Waiting for cpu %d to start up...&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_while
c_loop
(paren
id|percpu_table
(braket
id|cpuid
)braket
dot
id|cpu_is_alive
op_eq
l_int|0
)paren
(brace
r_static
r_int
id|counter
op_assign
l_int|0
suffix:semicolon
id|counter
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|counter
OG
l_int|200
)paren
(brace
r_break
suffix:semicolon
)brace
id|__delay
c_func
(paren
l_int|200000
)paren
suffix:semicolon
)brace
)brace
)brace
id|linux_smp_still_initting
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|die_if_kernel
id|die_if_kernel
c_func
(paren
r_char
op_star
id|str
comma
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|err
)paren
(brace
r_return
suffix:semicolon
)brace
eof
