multiline_comment|/*&n; * arch/sparc/kernel/traps.c&n; *&n; * Copyright 1995 David S. Miller (davem@caip.rutgers.edu)&n; */
multiline_comment|/*&n; * I hate traps on the sparc, grrr...&n; */
macro_line|#include &lt;linux/sched.h&gt;  /* for jiffies */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;asm/delay.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/ptrace.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/mp.h&gt;
macro_line|#include &lt;asm/kdebug.h&gt;
r_void
DECL|function|do_hw_interrupt
id|do_hw_interrupt
c_func
(paren
r_int
r_int
id|type
comma
r_int
r_int
id|psr
comma
r_int
r_int
id|pc
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Unimplemented Sparc TRAP, type = %02lx psr = %08lx pc = %08lx&bslash;n&quot;
comma
id|type
comma
id|psr
comma
id|pc
)paren
suffix:semicolon
id|halt
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|do_illegal_instruction
id|do_illegal_instruction
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|pc
comma
r_int
r_int
id|npc
comma
r_int
r_int
id|psr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Illegal instruction at PC %08lx NPC %08lx PSR %08lx&bslash;n&quot;
comma
id|pc
comma
id|npc
comma
id|psr
)paren
suffix:semicolon
id|halt
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|do_priv_instruction
id|do_priv_instruction
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|pc
comma
r_int
r_int
id|npc
comma
r_int
r_int
id|psr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Privileged instruction at PC %08lx NPC %08lx PSR %08lx&bslash;n&quot;
comma
id|pc
comma
id|npc
comma
id|psr
)paren
suffix:semicolon
id|halt
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|do_memaccess_unaligned
id|do_memaccess_unaligned
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|pc
comma
r_int
r_int
id|npc
comma
r_int
r_int
id|psr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Unaligned memory access at PC %08lx NPC %08lx PSR %08lx&bslash;n&quot;
comma
id|pc
comma
id|npc
comma
id|psr
)paren
suffix:semicolon
id|halt
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|do_fpd_trap
id|do_fpd_trap
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|pc
comma
r_int
r_int
id|npc
comma
r_int
r_int
id|psr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Floating Point Disabled trap at PC %08lx NPC %08lx PSR %08lx&bslash;n&quot;
comma
id|pc
comma
id|npc
comma
id|psr
)paren
suffix:semicolon
id|halt
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|do_fpe_trap
id|do_fpe_trap
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|pc
comma
r_int
r_int
id|npc
comma
r_int
r_int
id|psr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Floating Point Exception at PC %08lx NPC %08lx PSR %08lx&bslash;n&quot;
comma
id|pc
comma
id|npc
comma
id|psr
)paren
suffix:semicolon
id|halt
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|handle_tag_overflow
id|handle_tag_overflow
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|pc
comma
r_int
r_int
id|npc
comma
r_int
r_int
id|psr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Tag overflow trap at PC %08lx NPC %08lx PSR %08lx&bslash;n&quot;
comma
id|pc
comma
id|npc
comma
id|psr
)paren
suffix:semicolon
id|halt
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|handle_watchpoint
id|handle_watchpoint
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|pc
comma
r_int
r_int
id|npc
comma
r_int
r_int
id|psr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Watchpoint detected at PC %08lx NPC %08lx PSR %08lx&bslash;n&quot;
comma
id|pc
comma
id|npc
comma
id|psr
)paren
suffix:semicolon
id|halt
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|handle_reg_access
id|handle_reg_access
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|pc
comma
r_int
r_int
id|npc
comma
r_int
r_int
id|psr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Register Access Exception at PC %08lx NPC %08lx PSR %08lx&bslash;n&quot;
comma
id|pc
comma
id|npc
comma
id|psr
)paren
suffix:semicolon
id|halt
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|handle_iacc_error
id|handle_iacc_error
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|pc
comma
r_int
r_int
id|npc
comma
r_int
r_int
id|psr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Instruction Access Error at PC %08lx NPC %08lx PSR %08lx&bslash;n&quot;
comma
id|pc
comma
id|npc
comma
id|psr
)paren
suffix:semicolon
id|halt
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|handle_cp_disabled
id|handle_cp_disabled
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|pc
comma
r_int
r_int
id|npc
comma
r_int
r_int
id|psr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Co-Processor disabled trap at PC %08lx NPC %08lx PSR %08lx&bslash;n&quot;
comma
id|pc
comma
id|npc
comma
id|psr
)paren
suffix:semicolon
id|halt
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|handle_bad_flush
id|handle_bad_flush
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|pc
comma
r_int
r_int
id|npc
comma
r_int
r_int
id|psr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Unimplemented FLUSH Exception at PC %08lx NPC %08lx PSR %08lx&bslash;n&quot;
comma
id|pc
comma
id|npc
comma
id|psr
)paren
suffix:semicolon
id|halt
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|handle_cp_exception
id|handle_cp_exception
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|pc
comma
r_int
r_int
id|npc
comma
r_int
r_int
id|psr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Co-Processor Exception at PC %08lx NPC %08lx PSR %08lx&bslash;n&quot;
comma
id|pc
comma
id|npc
comma
id|psr
)paren
suffix:semicolon
id|halt
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|handle_dacc_error
id|handle_dacc_error
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|pc
comma
r_int
r_int
id|npc
comma
r_int
r_int
id|psr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Data Access Error at PC %08lx NPC %08lx PSR %08lx&bslash;n&quot;
comma
id|pc
comma
id|npc
comma
id|psr
)paren
suffix:semicolon
id|halt
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|handle_hw_divzero
id|handle_hw_divzero
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|pc
comma
r_int
r_int
id|npc
comma
r_int
r_int
id|psr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Divide By Zero Exception at PC %08lx NPC %08lx PSR %08lx&bslash;n&quot;
comma
id|pc
comma
id|npc
comma
id|psr
)paren
suffix:semicolon
id|halt
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|handle_dstore_error
id|handle_dstore_error
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|pc
comma
r_int
r_int
id|npc
comma
r_int
r_int
id|psr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Data Store Error at PC %08lx NPC %08lx PSR %08lx&bslash;n&quot;
comma
id|pc
comma
id|npc
comma
id|psr
)paren
suffix:semicolon
id|halt
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|handle_dacc_mmu_miss
id|handle_dacc_mmu_miss
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|pc
comma
r_int
r_int
id|npc
comma
r_int
r_int
id|psr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Data Access MMU-Miss Exception at PC %08lx NPC %08lx PSR %08lx&bslash;n&quot;
comma
id|pc
comma
id|npc
comma
id|psr
)paren
suffix:semicolon
id|halt
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|handle_iacc_mmu_miss
id|handle_iacc_mmu_miss
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|pc
comma
r_int
r_int
id|npc
comma
r_int
r_int
id|psr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Instruction Access MMU-Miss Exception at PC %08lx NPC %08lx PSR %08lx&bslash;n&quot;
comma
id|pc
comma
id|npc
comma
id|psr
)paren
suffix:semicolon
id|halt
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Since we have our mappings set up, on multiprocessors we can spin them&n; * up here so that timer interrupts work during initialization.&n; */
r_extern
r_void
id|sparc_cpu_startup
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_int
id|linux_num_cpus
suffix:semicolon
r_extern
id|pgd_t
op_star
id|lnx_root
suffix:semicolon
DECL|variable|linux_smp_still_initting
r_int
id|linux_smp_still_initting
suffix:semicolon
DECL|variable|thiscpus_tbr
r_int
r_int
id|thiscpus_tbr
suffix:semicolon
DECL|variable|thiscpus_mid
r_int
id|thiscpus_mid
suffix:semicolon
multiline_comment|/* #define SMP_TESTING */
r_void
DECL|function|trap_init
id|trap_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|linux_prom_registers
id|ctx_reg
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|linux_num_cpus
op_eq
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;trap_init: Uniprocessor detected.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sparc_cpu_model
op_ne
id|sun4m
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;trap_init: Multiprocessor on a non-sun4m! Aieee...&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;trap_init: Cannot continue, bailing out.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Ok, we are on a sun4m with multiple cpu&squot;s */
id|printk
c_func
(paren
l_string|&quot;trap_init: Multiprocessor detected, initiating CPU-startup. cpus=%d&bslash;n&quot;
comma
id|linux_num_cpus
)paren
suffix:semicolon
id|linux_smp_still_initting
op_assign
l_int|1
suffix:semicolon
id|ctx_reg.which_io
op_assign
l_int|0x0
suffix:semicolon
multiline_comment|/* real ram */
id|ctx_reg.phys_addr
op_assign
(paren
r_char
op_star
)paren
(paren
(paren
(paren
r_int
r_int
)paren
id|lnx_root
)paren
op_minus
id|PAGE_OFFSET
)paren
suffix:semicolon
id|ctx_reg.reg_size
op_assign
l_int|0x0
suffix:semicolon
multiline_comment|/* This basically takes every cpu, loads up our Linux context table&n;&t; * into it&squot;s context table pointer register, inits it at the low level&n;&t; * and then makes it spin in an endless loop...&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|linux_num_cpus
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|linux_cpus
(braket
id|i
)braket
dot
id|mid
op_amp
(paren
op_complement
l_int|8
)paren
)paren
op_ne
l_int|0x0
)paren
(brace
r_static
r_int
id|cpuid
op_assign
l_int|0
suffix:semicolon
id|cpuid
op_assign
(paren
id|linux_cpus
(braket
id|i
)braket
dot
id|mid
op_amp
(paren
op_complement
l_int|8
)paren
)paren
suffix:semicolon
id|percpu_table
(braket
id|cpuid
)braket
dot
id|cpu_is_alive
op_assign
l_int|0
suffix:semicolon
id|thiscpus_mid
op_assign
id|linux_cpus
(braket
id|i
)braket
dot
id|mid
suffix:semicolon
id|thiscpus_tbr
op_assign
(paren
r_int
r_int
)paren
id|percpu_table
(braket
id|cpuid
)braket
dot
id|trap_table
suffix:semicolon
macro_line|#ifdef SMP_TESTING
id|printk
c_func
(paren
l_string|&quot;thiscpus_tbr = %08x&bslash;n&quot;
comma
id|thiscpus_tbr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;About to fire up cpu %d mid %d cpuid %d&bslash;n&quot;
comma
id|i
comma
id|linux_cpus
(braket
id|i
)braket
dot
id|mid
comma
id|cpuid
)paren
suffix:semicolon
macro_line|#endif
id|prom_startcpu
c_func
(paren
id|linux_cpus
(braket
id|i
)braket
dot
id|prom_node
comma
op_amp
id|ctx_reg
comma
l_int|0x0
comma
(paren
r_char
op_star
)paren
id|sparc_cpu_startup
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Waiting for cpu %d to start up...&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_while
c_loop
(paren
id|percpu_table
(braket
id|cpuid
)braket
dot
id|cpu_is_alive
op_eq
l_int|0
)paren
(brace
r_static
r_int
id|counter
op_assign
l_int|0
suffix:semicolon
id|counter
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|counter
OG
l_int|200
)paren
(brace
macro_line|#ifdef SMP_TESTING
id|printk
c_func
(paren
l_string|&quot;UGH, CPU would not start up ;-( &bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
)brace
id|__delay
c_func
(paren
l_int|200000
)paren
suffix:semicolon
)brace
)brace
)brace
id|linux_smp_still_initting
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|die_if_kernel
id|die_if_kernel
c_func
(paren
r_char
op_star
id|str
comma
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|err
)paren
(brace
r_return
suffix:semicolon
)brace
eof
