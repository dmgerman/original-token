multiline_comment|/* idprom.c: Routines to load the idprom into kernel addresses and&n; *           interpret the data contained within.&n; *&n; * Copyright (C) 1995 David S. Miller (davem@caip.rutgers.edu)&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;asm/types.h&gt;
macro_line|#include &lt;asm/openprom.h&gt;
macro_line|#include &lt;asm/idprom.h&gt;
DECL|variable|idprom
r_struct
id|idp_struct
id|idprom
suffix:semicolon
r_extern
r_int
id|num_segmaps
comma
id|num_contexts
suffix:semicolon
DECL|function|get_idprom
r_void
id|get_idprom
c_func
(paren
r_void
)paren
(brace
r_char
op_star
id|idp_addr
suffix:semicolon
r_char
op_star
id|knl_idp_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|idp_addr
op_assign
(paren
r_char
op_star
)paren
id|IDPROM_ADDR
suffix:semicolon
id|knl_idp_addr
op_assign
(paren
r_char
op_star
)paren
op_amp
id|idprom
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IDPROM_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|knl_idp_addr
op_increment
op_assign
op_star
id|idp_addr
op_increment
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* find_vac_size() returns the number of bytes in the VAC (virtual&n; * address cache) on this machine.&n; */
r_int
DECL|function|find_vac_size
id|find_vac_size
c_func
(paren
r_void
)paren
(brace
r_int
id|vac_prop_len
suffix:semicolon
r_int
id|vacsize
op_assign
l_int|0
suffix:semicolon
r_int
id|node_root
suffix:semicolon
id|node_root
op_assign
(paren
op_star
(paren
id|romvec-&gt;pv_nodeops-&gt;no_nextnode
)paren
)paren
(paren
l_int|0
)paren
suffix:semicolon
id|vac_prop_len
op_assign
(paren
op_star
(paren
id|romvec-&gt;pv_nodeops-&gt;no_proplen
)paren
)paren
(paren
id|node_root
comma
l_string|&quot;vac-size&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vac_prop_len
op_ne
op_minus
l_int|1
)paren
(brace
(paren
op_star
(paren
id|romvec-&gt;pv_nodeops-&gt;no_getprop
)paren
)paren
(paren
id|node_root
comma
l_string|&quot;vac-size&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|vacsize
)paren
suffix:semicolon
r_return
id|vacsize
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* The prom node functions can&squot;t help, do it via idprom struct */
r_switch
c_cond
(paren
id|idprom.id_machtype
)paren
(brace
r_case
l_int|0x51
suffix:colon
r_case
l_int|0x52
suffix:colon
r_case
l_int|0x53
suffix:colon
r_case
l_int|0x54
suffix:colon
r_case
l_int|0x55
suffix:colon
r_case
l_int|0x56
suffix:colon
r_case
l_int|0x57
suffix:colon
r_return
l_int|65536
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
suffix:semicolon
)brace
multiline_comment|/* find_vac_linesize() returns the size in bytes of the VAC linesize */
r_int
DECL|function|find_vac_linesize
id|find_vac_linesize
c_func
(paren
r_void
)paren
(brace
r_int
id|vac_prop_len
suffix:semicolon
r_int
id|vaclinesize
op_assign
l_int|0
suffix:semicolon
r_int
id|node_root
suffix:semicolon
id|node_root
op_assign
(paren
op_star
(paren
id|romvec-&gt;pv_nodeops-&gt;no_nextnode
)paren
)paren
(paren
l_int|0
)paren
suffix:semicolon
id|vac_prop_len
op_assign
(paren
op_star
(paren
id|romvec-&gt;pv_nodeops-&gt;no_proplen
)paren
)paren
(paren
id|node_root
comma
l_string|&quot;vac-linesize&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vac_prop_len
op_ne
op_minus
l_int|1
)paren
(brace
(paren
op_star
(paren
id|romvec-&gt;pv_nodeops-&gt;no_getprop
)paren
)paren
(paren
id|node_root
comma
l_string|&quot;vac-linesize&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|vaclinesize
)paren
suffix:semicolon
r_return
id|vaclinesize
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* The prom node functions can&squot;t help, do it via idprom struct */
r_switch
c_cond
(paren
id|idprom.id_machtype
)paren
(brace
r_case
l_int|0x51
suffix:colon
r_case
l_int|0x52
suffix:colon
r_case
l_int|0x53
suffix:colon
r_case
l_int|0x54
suffix:colon
r_return
l_int|16
suffix:semicolon
r_case
l_int|0x55
suffix:colon
r_case
l_int|0x56
suffix:colon
r_case
l_int|0x57
suffix:colon
r_return
l_int|32
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
suffix:semicolon
)brace
r_int
DECL|function|find_vac_hwflushes
id|find_vac_hwflushes
c_func
(paren
r_void
)paren
(brace
r_register
r_int
id|len
comma
id|node_root
suffix:semicolon
r_int
id|tmp1
comma
id|tmp2
suffix:semicolon
id|node_root
op_assign
(paren
op_star
(paren
id|romvec-&gt;pv_nodeops-&gt;no_nextnode
)paren
)paren
(paren
l_int|0
)paren
suffix:semicolon
id|len
op_assign
(paren
op_star
(paren
id|romvec-&gt;pv_nodeops-&gt;no_proplen
)paren
)paren
(paren
id|node_root
comma
l_string|&quot;vac_hwflush&quot;
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_IDPROM
id|printf
c_func
(paren
l_string|&quot;DEBUG: find_vac_hwflushes: proplen vac_hwflush=0x%x&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Sun 4/75 has typo in prom_node, it&squot;s a dash instead of an underscore&n;   * in the property name. :-(&n;   */
id|len
op_or_assign
(paren
op_star
(paren
id|romvec-&gt;pv_nodeops-&gt;no_proplen
)paren
)paren
(paren
id|node_root
comma
l_string|&quot;vac-hwflush&quot;
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_IDPROM
id|printf
c_func
(paren
l_string|&quot;DEBUG: find_vac_hwflushes: proplen vac-hwflush=0x%x&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
macro_line|#endif
id|len
op_assign
(paren
op_star
(paren
id|romvec-&gt;pv_nodeops-&gt;no_getprop
)paren
)paren
(paren
id|node_root
comma
l_string|&quot;vac_hwflush&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|tmp1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ne
l_int|4
)paren
(brace
id|tmp1
op_assign
l_int|0
suffix:semicolon
)brace
id|len
op_assign
(paren
op_star
(paren
id|romvec-&gt;pv_nodeops-&gt;no_getprop
)paren
)paren
(paren
id|node_root
comma
l_string|&quot;vac-hwflush&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|tmp2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ne
l_int|4
)paren
(brace
id|tmp2
op_assign
l_int|0
suffix:semicolon
)brace
r_return
(paren
id|tmp1
op_or
id|tmp2
)paren
suffix:semicolon
)brace
r_void
DECL|function|find_mmu_num_segmaps
id|find_mmu_num_segmaps
c_func
(paren
r_void
)paren
(brace
r_register
r_int
id|root_node
comma
id|len
suffix:semicolon
id|root_node
op_assign
(paren
op_star
(paren
id|romvec-&gt;pv_nodeops-&gt;no_nextnode
)paren
)paren
(paren
l_int|0
)paren
suffix:semicolon
id|len
op_assign
(paren
op_star
(paren
id|romvec-&gt;pv_nodeops-&gt;no_getprop
)paren
)paren
(paren
id|root_node
comma
l_string|&quot;mmu-npmg&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|num_segmaps
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_MMU
id|printf
c_func
(paren
l_string|&quot;find_mmu_num_segmaps: property length = %d&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|len
op_ne
l_int|4
)paren
(brace
id|num_segmaps
op_assign
l_int|128
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_void
DECL|function|find_mmu_num_contexts
id|find_mmu_num_contexts
c_func
(paren
r_void
)paren
(brace
r_register
r_int
id|root_node
comma
id|len
suffix:semicolon
id|root_node
op_assign
(paren
op_star
(paren
id|romvec-&gt;pv_nodeops-&gt;no_nextnode
)paren
)paren
(paren
l_int|0
)paren
suffix:semicolon
id|len
op_assign
(paren
op_star
(paren
id|romvec-&gt;pv_nodeops-&gt;no_getprop
)paren
)paren
(paren
id|root_node
comma
l_string|&quot;mmu-nctx&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|num_contexts
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_MMU
id|printf
c_func
(paren
l_string|&quot;find_mmu_num_contexts: property length = %d&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|len
op_ne
l_int|4
)paren
(brace
id|num_contexts
op_assign
l_int|8
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
eof
