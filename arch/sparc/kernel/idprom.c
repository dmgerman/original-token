multiline_comment|/* idprom.c: Routines to load the idprom into kernel addresses and&n; *           interpret the data contained within.&n; *&n; * Because they use the IDPROM&squot;s machine type field, some of the&n; * virtual address cache probings on the sun4c are done here.&n; *&n; * Copyright (C) 1995 David S. Miller (davem@caip.rutgers.edu)&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;asm/types.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/idprom.h&gt;
macro_line|#include &lt;asm/machines.h&gt;  /* Fun with Sun released architectures. */
macro_line|#include &lt;asm/system.h&gt;    /* For halt() macro */
DECL|variable|idprom
r_struct
id|idp_struct
op_star
id|idprom
suffix:semicolon
DECL|variable|idprom_buff
r_static
r_struct
id|idp_struct
id|idprom_buff
suffix:semicolon
multiline_comment|/* Here is the master table of Sun machines which use some implementation&n; * of the Sparc CPU and have a meaningful IDPROM machtype value that we&n; * know about.  See asm-sparc/machines.h for imperical constants.&n; */
DECL|variable|Sun_Machines
r_struct
id|Sun_Machine_Models
id|Sun_Machines
(braket
id|NUM_SUN_MACHINES
)braket
op_assign
(brace
multiline_comment|/* First, Sun4&squot;s */
(brace
l_string|&quot;Sun 4/100 Series&quot;
comma
(paren
id|SM_SUN4
op_or
id|SM_4_110
)paren
)brace
comma
(brace
l_string|&quot;Sun 4/200 Series&quot;
comma
(paren
id|SM_SUN4
op_or
id|SM_4_260
)paren
)brace
comma
(brace
l_string|&quot;Sun 4/300 Series&quot;
comma
(paren
id|SM_SUN4
op_or
id|SM_4_330
)paren
)brace
comma
(brace
l_string|&quot;Sun 4/400 Series&quot;
comma
(paren
id|SM_SUN4
op_or
id|SM_4_470
)paren
)brace
comma
multiline_comment|/* Now, Sun4c&squot;s */
(brace
l_string|&quot;Sun4c SparcStation 1&quot;
comma
(paren
id|SM_SUN4C
op_or
id|SM_4C_SS1
)paren
)brace
comma
(brace
l_string|&quot;Sun4c SparcStation IPC&quot;
comma
(paren
id|SM_SUN4C
op_or
id|SM_4C_IPC
)paren
)brace
comma
(brace
l_string|&quot;Sun4c SparcStation 1+&quot;
comma
(paren
id|SM_SUN4C
op_or
id|SM_4C_SS1PLUS
)paren
)brace
comma
(brace
l_string|&quot;Sun4c SparcStation SLC&quot;
comma
(paren
id|SM_SUN4C
op_or
id|SM_4C_SLC
)paren
)brace
comma
(brace
l_string|&quot;Sun4c SparcStation 2&quot;
comma
(paren
id|SM_SUN4C
op_or
id|SM_4C_SS2
)paren
)brace
comma
(brace
l_string|&quot;Sun4c SparcStation ELC&quot;
comma
(paren
id|SM_SUN4C
op_or
id|SM_4C_ELC
)paren
)brace
comma
(brace
l_string|&quot;Sun4c SparcStation IPX&quot;
comma
(paren
id|SM_SUN4C
op_or
id|SM_4C_IPX
)paren
)brace
comma
multiline_comment|/* Finally, early Sun4m&squot;s */
(brace
l_string|&quot;Sun4m SparcSystem600&quot;
comma
(paren
id|SM_SUN4M
op_or
id|SM_4M_SS60
)paren
)brace
comma
(brace
l_string|&quot;Sun4m SparcStation10&quot;
comma
(paren
id|SM_SUN4M
op_or
id|SM_4M_SS50
)paren
)brace
comma
(brace
l_string|&quot;Sun4m SparcStation5&quot;
comma
(paren
id|SM_SUN4M
op_or
id|SM_4M_SS40
)paren
)brace
comma
multiline_comment|/* One entry for the OBP arch&squot;s which are sun4d, sun4e, and newer sun4m&squot;s */
(brace
l_string|&quot;Sun4M OBP based system&quot;
comma
(paren
id|SM_SUN4M_OBP
op_or
l_int|0x0
)paren
)brace
)brace
suffix:semicolon
r_void
DECL|function|sparc_display_systype
id|sparc_display_systype
c_func
(paren
r_int
r_char
id|machtyp
)paren
(brace
r_char
id|system_name
(braket
l_int|128
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_SUN_MACHINES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|Sun_Machines
(braket
id|i
)braket
dot
id|id_machtype
op_eq
id|machtyp
)paren
(brace
r_if
c_cond
(paren
id|machtyp
op_ne
(paren
id|SM_SUN4M_OBP
op_or
l_int|0x0
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TYPE: %s&bslash;n&quot;
comma
id|Sun_Machines
(braket
id|i
)braket
dot
id|name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
id|prom_getproperty
c_func
(paren
id|prom_root_node
comma
l_string|&quot;banner-name&quot;
comma
id|system_name
comma
r_sizeof
(paren
id|system_name
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TYPE: %s&bslash;n&quot;
comma
id|system_name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|i
op_eq
id|NUM_SUN_MACHINES
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Uh oh, IDPROM had bogus id_machtype value &lt;%x&gt;&bslash;n&quot;
comma
id|machtyp
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_void
DECL|function|get_idprom
id|get_idprom
c_func
(paren
r_void
)paren
(brace
id|prom_getidp
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|idprom_buff
comma
r_sizeof
(paren
id|idprom_buff
)paren
)paren
suffix:semicolon
id|idprom
op_assign
op_amp
id|idprom_buff
suffix:semicolon
id|sparc_display_systype
c_func
(paren
id|idprom-&gt;id_machtype
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Ethernet address: %x:%x:%x:%x:%x:%x&bslash;n&quot;
comma
id|idprom-&gt;id_eaddr
(braket
l_int|0
)braket
comma
id|idprom-&gt;id_eaddr
(braket
l_int|1
)braket
comma
id|idprom-&gt;id_eaddr
(braket
l_int|2
)braket
comma
id|idprom-&gt;id_eaddr
(braket
l_int|3
)braket
comma
id|idprom-&gt;id_eaddr
(braket
l_int|4
)braket
comma
id|idprom-&gt;id_eaddr
(braket
l_int|5
)braket
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* find_vac_size() returns the number of bytes in the VAC (virtual&n; * address cache) on this machine.&n; */
r_int
DECL|function|find_vac_size
id|find_vac_size
c_func
(paren
r_void
)paren
(brace
r_int
id|vac_prop_len
suffix:semicolon
r_int
id|vacsize
op_assign
l_int|0
suffix:semicolon
id|vac_prop_len
op_assign
id|prom_getproplen
c_func
(paren
id|prom_root_node
comma
l_string|&quot;vac-size&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vac_prop_len
op_ne
op_minus
l_int|1
)paren
(brace
id|vacsize
op_assign
id|prom_getint
c_func
(paren
id|prom_root_node
comma
l_string|&quot;vac-size&quot;
)paren
suffix:semicolon
r_return
id|vacsize
suffix:semicolon
)brace
r_else
(brace
r_switch
c_cond
(paren
id|idprom-&gt;id_machtype
)paren
(brace
r_case
(paren
id|SM_SUN4C
op_or
id|SM_4C_SS1
)paren
suffix:colon
multiline_comment|/* SparcStation1 */
r_case
(paren
id|SM_SUN4C
op_or
id|SM_4C_IPC
)paren
suffix:colon
multiline_comment|/* SparcStation IPX */
r_case
(paren
id|SM_SUN4C
op_or
id|SM_4C_SS1PLUS
)paren
suffix:colon
multiline_comment|/* SparcStation1+ */
r_case
(paren
id|SM_SUN4C
op_or
id|SM_4C_SLC
)paren
suffix:colon
multiline_comment|/* SparcStation SLC */
r_case
(paren
id|SM_SUN4C
op_or
id|SM_4C_SS2
)paren
suffix:colon
multiline_comment|/* SparcStation2 Cache-Chip BUG! */
r_case
(paren
id|SM_SUN4C
op_or
id|SM_4C_ELC
)paren
suffix:colon
multiline_comment|/* SparcStation ELC */
r_case
(paren
id|SM_SUN4C
op_or
id|SM_4C_IPX
)paren
suffix:colon
multiline_comment|/* SparcStation IPX */
r_return
l_int|65536
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;find_vac_size: Can&squot;t determine size of VAC, bailing out...&bslash;n&quot;
)paren
suffix:semicolon
id|halt
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
)brace
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* find_vac_linesize() returns the size in bytes of the VAC linesize */
r_int
DECL|function|find_vac_linesize
id|find_vac_linesize
c_func
(paren
r_void
)paren
(brace
r_int
id|vac_prop_len
suffix:semicolon
id|vac_prop_len
op_assign
id|prom_getproplen
c_func
(paren
id|prom_root_node
comma
l_string|&quot;vac-linesize&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vac_prop_len
op_ne
op_minus
l_int|1
)paren
(brace
r_return
id|prom_getint
c_func
(paren
id|prom_root_node
comma
l_string|&quot;vac-linesize&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_switch
c_cond
(paren
id|idprom-&gt;id_machtype
)paren
(brace
r_case
(paren
id|SM_SUN4C
op_or
id|SM_4C_SS1
)paren
suffix:colon
multiline_comment|/* SparcStation1 */
r_case
(paren
id|SM_SUN4C
op_or
id|SM_4C_IPC
)paren
suffix:colon
multiline_comment|/* SparcStation IPC */
r_case
(paren
id|SM_SUN4C
op_or
id|SM_4C_SS1PLUS
)paren
suffix:colon
multiline_comment|/* SparcStation1+ */
r_case
(paren
id|SM_SUN4C
op_or
id|SM_4C_SLC
)paren
suffix:colon
multiline_comment|/* SparcStation SLC */
r_return
l_int|16
suffix:semicolon
r_case
(paren
id|SM_SUN4C
op_or
id|SM_4C_SS2
)paren
suffix:colon
multiline_comment|/* SparcStation2 Cache-Chip BUG! */
r_case
(paren
id|SM_SUN4C
op_or
id|SM_4C_ELC
)paren
suffix:colon
multiline_comment|/* SparcStation ELC */
r_case
(paren
id|SM_SUN4C
op_or
id|SM_4C_IPX
)paren
suffix:colon
multiline_comment|/* SparcStation IPX */
r_return
l_int|32
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;find_vac_linesize: Can&squot;t determine VAC linesize, bailing out...&bslash;n&quot;
)paren
suffix:semicolon
id|halt
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
)brace
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_int
DECL|function|find_vac_hwflushes
id|find_vac_hwflushes
c_func
(paren
r_void
)paren
(brace
r_register
r_int
id|len
suffix:semicolon
r_int
id|tmp1
comma
id|tmp2
suffix:semicolon
multiline_comment|/* Sun 4/75 has typo in prom_node, it&squot;s a dash instead of an underscore&n;&t; * in the property name. :-(&n;&t; */
id|len
op_assign
id|prom_getproperty
c_func
(paren
id|prom_root_node
comma
l_string|&quot;vac_hwflush&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|tmp1
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ne
l_int|4
)paren
(brace
id|tmp1
op_assign
l_int|0
suffix:semicolon
)brace
id|len
op_assign
id|prom_getproperty
c_func
(paren
id|prom_root_node
comma
l_string|&quot;vac-hwflush&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|tmp2
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ne
l_int|4
)paren
(brace
id|tmp2
op_assign
l_int|0
suffix:semicolon
)brace
r_return
(paren
id|tmp1
op_or
id|tmp2
)paren
suffix:semicolon
)brace
eof
