multiline_comment|/* devtree.c: Build a copy of the prom device tree in kernel&n; *            memory for easier access and cleaner interface.&n; *&n; * Copyright (C) 1996 David S. Miller (davem@caip.rutgers.edu)&n; */
macro_line|#include &lt;asm/openprom.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
multiline_comment|/* Add more as appropriate. */
DECL|enum|bus_t
r_enum
id|bus_t
(brace
DECL|enumerator|OBIO_BUS
id|OBIO_BUS
comma
DECL|enumerator|SBUS_BUS
id|SBUS_BUS
comma
DECL|enumerator|PCI_BUS
id|PCI_BUS
comma
DECL|enumerator|PMEM_BUS
id|PMEM_BUS
comma
DECL|enumerator|CPU_BUS
id|CPU_BUS
comma
)brace
suffix:semicolon
DECL|struct|sdevmapping
r_struct
id|sdevmapping
(brace
DECL|member|physpage
r_int
r_int
id|physpage
suffix:semicolon
DECL|member|mapsz
r_int
id|mapsz
suffix:semicolon
DECL|member|where
r_enum
id|bus_t
id|where
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* limitation of sparc arch. */
DECL|macro|NUM_SPARC_IRQS
mdefine_line|#define NUM_SPARC_IRQS    15
DECL|struct|sdev_irqs
r_struct
id|sdev_irqs
(brace
DECL|member|level
r_int
id|level
suffix:semicolon
DECL|member|vector
r_int
id|vector
suffix:semicolon
multiline_comment|/* For vme/sbus irq sharing methinks. */
)brace
suffix:semicolon
DECL|struct|sparcdev
r_struct
id|sparcdev
(brace
DECL|member|next
r_struct
id|sparcdev
op_star
id|next
suffix:semicolon
DECL|member|prev
r_struct
id|sparcdev
op_star
id|prev
suffix:semicolon
DECL|member|node
r_int
id|node
suffix:semicolon
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|num_mappings
r_int
id|num_mappings
suffix:semicolon
DECL|member|maps
r_struct
id|sdevmapping
op_star
id|maps
suffix:semicolon
DECL|member|num_irqs
r_int
id|num_irqs
suffix:semicolon
DECL|member|irqinfo
r_struct
id|sdev_irqs
id|irqinfo
(braket
id|NUM_SPARC_IRQS
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|sparcbus
r_struct
id|sparcbus
(brace
DECL|member|next
r_struct
id|sparcbus
op_star
id|next
suffix:semicolon
DECL|member|type
r_enum
id|bus_t
id|type
suffix:semicolon
DECL|member|device_list
r_struct
id|sparcdev
op_star
id|device_list
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Add more as appropriate. */
DECL|variable|obiobus_info
r_struct
id|sparcbus
id|obiobus_info
op_assign
(brace
l_int|0
comma
id|OBIO_BUS
comma
(brace
l_int|0
comma
l_int|0
)brace
comma
)brace
suffix:semicolon
DECL|variable|sbusbus_info
r_struct
id|sparcbus
id|sbusbus_info
op_assign
(brace
l_int|0
comma
id|SBUS_BUS
comma
(brace
l_int|0
comma
l_int|0
)brace
comma
)brace
suffix:semicolon
DECL|variable|pcibus_info
r_struct
id|sparcbus
id|pcibus_info
op_assign
(brace
l_int|0
comma
id|PCI_BUS
comma
(brace
l_int|0
comma
l_int|0
)brace
comma
)brace
suffix:semicolon
DECL|variable|pmembus_info
r_struct
id|sparcbus
id|pmembus_info
op_assign
(brace
l_int|0
comma
id|PMEM_BUS
comma
(brace
l_int|0
comma
l_int|0
)brace
comma
)brace
suffix:semicolon
DECL|variable|cpubus_info
r_struct
id|sparcbus
id|cpubus_info
op_assign
(brace
l_int|0
comma
id|CPU_BUS
comma
(brace
l_int|0
comma
l_int|0
)brace
comma
)brace
suffix:semicolon
DECL|variable|sparcbus_list
r_struct
id|sparcbus
op_star
id|sparcbus_list
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* This is called at boot time to build the prom device tree. */
DECL|function|prom_build_devtree
r_int
id|prom_build_devtree
c_func
(paren
r_int
r_int
id|start_mem
comma
r_int
r_int
id|end_mem
)paren
(brace
)brace
multiline_comment|/* Search the bus device list for a device which matches one of the&n; * names in NAME_VECTOR which is an array or NUM_NAMES strings, given&n; * the passed BUSTYPE.  Return ptr to the matching sparcdev structure&n; * or NULL if no matches found.&n; */
DECL|function|prom_find_dev_on_bus
r_struct
id|sparcdev
op_star
id|prom_find_dev_on_bus
c_func
(paren
id|bus_t
id|bustype
comma
r_char
op_star
op_star
id|name_vector
comma
r_int
id|num_names
)paren
(brace
r_struct
id|sparcdev
op_star
id|sdp
suffix:semicolon
r_struct
id|sparcbus
op_star
id|thebus
suffix:semicolon
r_int
id|niter
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|num_names
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|sparcbus_list
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;prom_find_dev_on_bus: Device list not initted yet!&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|thebus
op_assign
id|sparcbus_list
suffix:semicolon
id|thebus
suffix:semicolon
id|thebus
op_assign
id|thebus-&gt;next
)paren
r_if
c_cond
(paren
id|thebus-&gt;type
op_eq
id|bustype
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|thebus
op_logical_or
op_logical_neg
id|thebus-&gt;device_list
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|sdp
op_assign
id|thebus-&gt;device_list
suffix:semicolon
id|sdp
suffix:semicolon
id|sdp
op_assign
id|sdp-&gt;next
)paren
(brace
r_for
c_loop
(paren
id|niter
op_assign
l_int|0
suffix:semicolon
id|niter
OL
id|num_names
suffix:semicolon
id|niter
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|sdp-&gt;name
comma
id|name_vector
(braket
id|niter
)braket
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
r_return
id|sdp
suffix:semicolon
)brace
multiline_comment|/* Continue searching on a device list, starting at START_DEV for the next&n; * instance whose name matches one of the elements of NAME_VECTOR which is&n; * of length NUM_NAMES.&n; */
DECL|function|prom_find_next_dev
r_struct
id|sparcdev
op_star
id|prom_find_next_dev
c_func
(paren
r_struct
id|sparcdev
op_star
id|start_dev
comma
r_char
op_star
op_star
id|name_vector
comma
r_int
id|num_names
)paren
(brace
r_struct
id|sparcdev
op_star
id|sdp
suffix:semicolon
r_int
id|niter
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|start_dev-&gt;next
op_logical_or
op_logical_neg
id|num_names
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|sdp
op_assign
id|start_dev-&gt;next
suffix:semicolon
id|sdp
suffix:semicolon
id|sdp
op_assign
id|sdp-&gt;next
)paren
(brace
r_for
c_loop
(paren
id|niter
op_assign
l_int|0
suffix:semicolon
id|niter
OL
id|num_names
suffix:semicolon
id|niter
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|sdp-&gt;name
comma
id|name_vector
(braket
id|niter
)braket
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
r_return
id|sdp
suffix:semicolon
)brace
eof
