multiline_comment|/*&n; * setup.c: SGI specific setup, including init of the feature struct.&n; *&n; * Copyright (C) 1996 David S. Miller (dm@engr.sgi.com)&n; * Copyright (C) 1997, 1998 Ralf Baechle (ralf@gnu.org)&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kbd_ll.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/kdev_t.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/mc146818rtc.h&gt;
macro_line|#include &lt;linux/pc_keyb.h&gt;
macro_line|#include &lt;asm/addrspace.h&gt;
macro_line|#include &lt;asm/bcache.h&gt;
macro_line|#include &lt;asm/keyboard.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/reboot.h&gt;
macro_line|#include &lt;asm/sgialib.h&gt;
macro_line|#include &lt;asm/sgi/sgimc.h&gt;
macro_line|#include &lt;asm/sgi/sgihpc.h&gt;
macro_line|#include &lt;asm/sgi/sgint23.h&gt;
macro_line|#include &lt;asm/gdb-stub.h&gt;
macro_line|#ifdef CONFIG_REMOTE_DEBUG
r_extern
r_void
id|rs_kgdb_hook
c_func
(paren
r_int
)paren
suffix:semicolon
r_extern
r_void
id|breakpoint
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|variable|remote_debug
r_static
r_int
id|remote_debug
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#if defined(CONFIG_SERIAL_CONSOLE) || defined(CONFIG_SGI_PROM_CONSOLE)
r_extern
r_void
id|console_setup
c_func
(paren
r_char
op_star
)paren
suffix:semicolon
macro_line|#endif
r_extern
r_int
r_int
id|r4k_interval
suffix:semicolon
multiline_comment|/* Cycle counter ticks per 1/HZ seconds */
r_extern
r_struct
id|rtc_ops
id|indy_rtc_ops
suffix:semicolon
r_void
id|indy_reboot_setup
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|sgi_volume_set
c_func
(paren
r_int
r_char
)paren
suffix:semicolon
DECL|macro|sgi_kh
mdefine_line|#define sgi_kh ((struct hpc_keyb *) (KSEG1 + 0x1fbd9800 + 64))
DECL|macro|KBD_STAT_IBF
mdefine_line|#define KBD_STAT_IBF&t;&t;0x02&t;/* Keyboard input buffer full */
DECL|function|sgi_request_region
r_static
r_void
id|sgi_request_region
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* No I/O ports are being used on the Indy.  */
)brace
DECL|function|sgi_request_irq
r_static
r_int
id|sgi_request_irq
c_func
(paren
r_void
(paren
op_star
id|handler
)paren
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
)paren
(brace
multiline_comment|/* Dirty hack, this get&squot;s called as a callback from the keyboard&n;&t;   driver.  We piggyback the initialization of the front panel&n;&t;   button handling on it even though they&squot;re technically not&n;&t;   related with the keyboard driver in any way.  Doing it from&n;&t;   indy_setup wouldn&squot;t work since kmalloc isn&squot;t initialized yet.  */
id|indy_reboot_setup
c_func
(paren
)paren
suffix:semicolon
r_return
id|request_irq
c_func
(paren
id|SGI_KEYBOARD_IRQ
comma
id|handler
comma
l_int|0
comma
l_string|&quot;keyboard&quot;
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|sgi_aux_request_irq
r_static
r_int
id|sgi_aux_request_irq
c_func
(paren
r_void
(paren
op_star
id|handler
)paren
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
)paren
(brace
multiline_comment|/* Nothing to do, interrupt is shared with the keyboard hw  */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sgi_aux_free_irq
r_static
r_void
id|sgi_aux_free_irq
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Nothing to do, interrupt is shared with the keyboard hw  */
)brace
DECL|function|sgi_read_input
r_static
r_int
r_char
id|sgi_read_input
c_func
(paren
r_void
)paren
(brace
r_return
id|sgi_kh-&gt;data
suffix:semicolon
)brace
DECL|function|sgi_write_output
r_static
r_void
id|sgi_write_output
c_func
(paren
r_int
r_char
id|val
)paren
(brace
r_int
id|status
suffix:semicolon
r_do
(brace
id|status
op_assign
id|sgi_kh-&gt;command
suffix:semicolon
)brace
r_while
c_loop
(paren
id|status
op_amp
id|KBD_STAT_IBF
)paren
suffix:semicolon
id|sgi_kh-&gt;data
op_assign
id|val
suffix:semicolon
)brace
DECL|function|sgi_write_command
r_static
r_void
id|sgi_write_command
c_func
(paren
r_int
r_char
id|val
)paren
(brace
r_int
id|status
suffix:semicolon
r_do
(brace
id|status
op_assign
id|sgi_kh-&gt;command
suffix:semicolon
)brace
r_while
c_loop
(paren
id|status
op_amp
id|KBD_STAT_IBF
)paren
suffix:semicolon
id|sgi_kh-&gt;command
op_assign
id|val
suffix:semicolon
)brace
DECL|function|sgi_read_status
r_static
r_int
r_char
id|sgi_read_status
c_func
(paren
r_void
)paren
(brace
r_return
id|sgi_kh-&gt;command
suffix:semicolon
)brace
DECL|variable|sgi_kbd_ops
r_struct
id|kbd_ops
id|sgi_kbd_ops
op_assign
(brace
id|sgi_request_region
comma
id|sgi_request_irq
comma
id|sgi_aux_request_irq
comma
id|sgi_aux_free_irq
comma
id|sgi_read_input
comma
id|sgi_write_output
comma
id|sgi_write_command
comma
id|sgi_read_status
)brace
suffix:semicolon
DECL|function|sgi_irq_setup
r_static
r_void
id|__init
id|sgi_irq_setup
c_func
(paren
r_void
)paren
(brace
id|sgint_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_REMOTE_DEBUG
r_if
c_cond
(paren
id|remote_debug
)paren
id|set_debug_traps
c_func
(paren
)paren
suffix:semicolon
id|breakpoint
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* you may move this line to whereever you want :-) */
macro_line|#endif
)brace
DECL|function|page_is_ram
r_int
id|__init
id|page_is_ram
c_func
(paren
r_int
r_int
id|pagenr
)paren
(brace
r_if
c_cond
(paren
(paren
id|pagenr
op_lshift
id|PAGE_SHIFT
)paren
OL
l_int|0x2000UL
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pagenr
op_lshift
id|PAGE_SHIFT
)paren
OG
l_int|0x08002000
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|board_time_init
r_void
(paren
op_star
id|board_time_init
)paren
(paren
r_struct
id|irqaction
op_star
id|irq
)paren
suffix:semicolon
DECL|function|dosample
r_static
r_int
r_int
id|dosample
c_func
(paren
r_volatile
r_int
r_char
op_star
id|tcwp
comma
r_volatile
r_int
r_char
op_star
id|tc2p
)paren
(brace
r_int
r_int
id|ct0
comma
id|ct1
suffix:semicolon
r_int
r_char
id|msb
comma
id|lsb
suffix:semicolon
multiline_comment|/* Start the counter. */
op_star
id|tcwp
op_assign
(paren
id|SGINT_TCWORD_CNT2
op_or
id|SGINT_TCWORD_CALL
op_or
id|SGINT_TCWORD_MRGEN
)paren
suffix:semicolon
op_star
id|tc2p
op_assign
(paren
id|SGINT_TCSAMP_COUNTER
op_amp
l_int|0xff
)paren
suffix:semicolon
op_star
id|tc2p
op_assign
(paren
id|SGINT_TCSAMP_COUNTER
op_rshift
l_int|8
)paren
suffix:semicolon
multiline_comment|/* Get initial counter invariant */
id|ct0
op_assign
id|read_32bit_cp0_register
c_func
(paren
id|CP0_COUNT
)paren
suffix:semicolon
multiline_comment|/* Latch and spin until top byte of counter2 is zero */
r_do
(brace
op_star
id|tcwp
op_assign
(paren
id|SGINT_TCWORD_CNT2
op_or
id|SGINT_TCWORD_CLAT
)paren
suffix:semicolon
id|lsb
op_assign
op_star
id|tc2p
suffix:semicolon
id|msb
op_assign
op_star
id|tc2p
suffix:semicolon
id|ct1
op_assign
id|read_32bit_cp0_register
c_func
(paren
id|CP0_COUNT
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|msb
)paren
(brace
suffix:semicolon
)brace
multiline_comment|/* Stop the counter. */
op_star
id|tcwp
op_assign
(paren
id|SGINT_TCWORD_CNT2
op_or
id|SGINT_TCWORD_CALL
op_or
id|SGINT_TCWORD_MSWST
)paren
suffix:semicolon
multiline_comment|/* Return the difference, this is how far the r4k counter increments&n;         * for every 1/HZ seconds. We round off the the nearest 1 MHz of&n;&t; * master clock (= 1000000 / 100 / 2 = 5000 count).&n;         */
r_return
(paren
(paren
id|ct1
op_minus
id|ct0
)paren
op_div
l_int|5000
)paren
op_star
l_int|5000
suffix:semicolon
)brace
DECL|macro|ALLINTS
mdefine_line|#define ALLINTS (IE_IRQ0 | IE_IRQ1 | IE_IRQ2 | IE_IRQ3 | IE_IRQ4 | IE_IRQ5)
DECL|function|sgi_time_init
r_void
id|sgi_time_init
(paren
r_struct
id|irqaction
op_star
id|irq
)paren
(brace
multiline_comment|/* Here we need to calibrate the cycle counter to at least be close.&n;&t; * We don&squot;t need to actually register the irq handler because that&squot;s&n;&t; * all done in indyIRQ.S.&n;&t; */
r_struct
id|sgi_ioc_timers
op_star
id|p
suffix:semicolon
r_volatile
r_int
r_char
op_star
id|tcwp
comma
op_star
id|tc2p
suffix:semicolon
r_int
r_int
id|r4k_ticks
(braket
l_int|3
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
r_int
r_int
id|r4k_next
suffix:semicolon
multiline_comment|/* Figure out the r4k offset, the algorithm is very simple&n;         * and works in _all_ cases as long as the 8254 counter&n;         * register itself works ok (as an interrupt driving timer&n;         * it does not because of bug, this is why we are using&n;         * the onchip r4k counter/compare register to serve this&n;         * purpose, but for r4k_offset calculation it will work&n;         * ok for us).  There are other very complicated ways&n;         * of performing this calculation but this one works just&n;         * fine so I am not going to futz around. ;-)&n;         */
id|p
op_assign
id|ioc_timers
suffix:semicolon
id|tcwp
op_assign
op_amp
id|p-&gt;tcword
suffix:semicolon
id|tc2p
op_assign
op_amp
id|p-&gt;tcnt2
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Calibrating system timer... &quot;
)paren
suffix:semicolon
id|dosample
c_func
(paren
id|tcwp
comma
id|tc2p
)paren
suffix:semicolon
multiline_comment|/* Prime cache. */
id|dosample
c_func
(paren
id|tcwp
comma
id|tc2p
)paren
suffix:semicolon
multiline_comment|/* Prime cache. */
multiline_comment|/* Zero is NOT an option. */
r_while
c_loop
(paren
op_logical_neg
id|r4k_ticks
(braket
l_int|0
)braket
)paren
id|r4k_ticks
(braket
l_int|0
)braket
op_assign
id|dosample
(paren
id|tcwp
comma
id|tc2p
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|r4k_ticks
(braket
l_int|1
)braket
)paren
id|r4k_ticks
(braket
l_int|1
)braket
op_assign
id|dosample
(paren
id|tcwp
comma
id|tc2p
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r4k_ticks
(braket
l_int|0
)braket
op_ne
id|r4k_ticks
(braket
l_int|1
)braket
)paren
(brace
id|printk
(paren
l_string|&quot;warning: timer counts differ, retrying...&quot;
)paren
suffix:semicolon
id|r4k_ticks
(braket
l_int|2
)braket
op_assign
id|dosample
(paren
id|tcwp
comma
id|tc2p
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r4k_ticks
(braket
l_int|2
)braket
op_eq
id|r4k_ticks
(braket
l_int|0
)braket
op_logical_or
id|r4k_ticks
(braket
l_int|2
)braket
op_eq
id|r4k_ticks
(braket
l_int|1
)braket
)paren
id|r4k_interval
op_assign
id|r4k_ticks
(braket
l_int|2
)braket
suffix:semicolon
r_else
(brace
id|printk
(paren
l_string|&quot;disagreement, using average...&quot;
)paren
suffix:semicolon
id|r4k_interval
op_assign
(paren
id|r4k_ticks
(braket
l_int|0
)braket
op_plus
id|r4k_ticks
(braket
l_int|1
)braket
op_plus
id|r4k_ticks
(braket
l_int|2
)braket
)paren
op_div
l_int|3
suffix:semicolon
)brace
)brace
r_else
id|r4k_interval
op_assign
id|r4k_ticks
(braket
l_int|0
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%d [%d.%02d MHz CPU]&bslash;n&quot;
comma
(paren
r_int
)paren
id|r4k_interval
comma
(paren
r_int
)paren
(paren
id|r4k_interval
op_div
l_int|5000
)paren
comma
(paren
r_int
)paren
(paren
id|r4k_interval
op_mod
l_int|5000
)paren
op_div
l_int|50
)paren
suffix:semicolon
multiline_comment|/* Set ourselves up for future interrupts */
id|r4k_next
op_assign
(paren
id|read_32bit_cp0_register
c_func
(paren
id|CP0_COUNT
)paren
op_plus
id|r4k_interval
)paren
suffix:semicolon
id|write_32bit_cp0_register
c_func
(paren
id|CP0_COMPARE
comma
id|r4k_next
)paren
suffix:semicolon
id|set_cp0_status
c_func
(paren
id|ST0_IM
comma
id|ALLINTS
)paren
suffix:semicolon
id|sti
(paren
)paren
suffix:semicolon
)brace
DECL|function|sgi_setup
r_void
id|__init
id|sgi_setup
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_SERIAL_CONSOLE
r_char
op_star
id|ctype
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_REMOTE_DEBUG
r_char
op_star
id|kgdb_ttyd
suffix:semicolon
macro_line|#endif
id|irq_setup
op_assign
id|sgi_irq_setup
suffix:semicolon
id|board_time_init
op_assign
id|sgi_time_init
suffix:semicolon
multiline_comment|/* Init the INDY HPC I/O controller.  Need to call this before&n;&t; * fucking with the memory controller because it needs to know the&n;&t; * boardID and whether this is a Guiness or a FullHouse machine.&n;&t; */
id|sgihpc_init
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Init INDY memory controller. */
id|sgimc_init
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Now enable boardcaches, if any. */
id|indy_sc_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SERIAL_CONSOLE
multiline_comment|/* ARCS console environment variable is set to &quot;g?&quot; for&n;&t; * graphics console, it is set to &quot;d&quot; for the first serial&n;&t; * line and &quot;d2&quot; for the second serial line.&n;&t; */
id|ctype
op_assign
id|ArcGetEnvironmentVariable
c_func
(paren
l_string|&quot;console&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|ctype
op_eq
l_char|&squot;d&squot;
)paren
(brace
r_if
c_cond
(paren
op_star
(paren
id|ctype
op_plus
l_int|1
)paren
op_eq
l_char|&squot;2&squot;
)paren
(brace
id|console_setup
(paren
l_string|&quot;ttyS1&quot;
)paren
suffix:semicolon
)brace
r_else
id|console_setup
(paren
l_string|&quot;ttyS0&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_REMOTE_DEBUG
id|kgdb_ttyd
op_assign
id|prom_getcmdline
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|kgdb_ttyd
op_assign
id|strstr
c_func
(paren
id|kgdb_ttyd
comma
l_string|&quot;kgdb=ttyd&quot;
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_int
id|line
suffix:semicolon
id|kgdb_ttyd
op_add_assign
id|strlen
c_func
(paren
l_string|&quot;kgdb=ttyd&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|kgdb_ttyd
op_ne
l_char|&squot;1&squot;
op_logical_and
op_star
id|kgdb_ttyd
op_ne
l_char|&squot;2&squot;
)paren
id|printk
c_func
(paren
l_string|&quot;KGDB: Uknown serial line /dev/ttyd%c, &quot;
l_string|&quot;falling back to /dev/ttyd1&bslash;n&quot;
comma
op_star
id|kgdb_ttyd
)paren
suffix:semicolon
id|line
op_assign
op_star
id|kgdb_ttyd
op_eq
l_char|&squot;2&squot;
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;KGDB: Using serial line /dev/ttyd%d for session&bslash;n&quot;
comma
id|line
ques
c_cond
l_int|1
suffix:colon
l_int|2
)paren
suffix:semicolon
id|rs_kgdb_hook
c_func
(paren
id|line
)paren
suffix:semicolon
id|prom_printf
c_func
(paren
l_string|&quot;KGDB: Using serial line /dev/ttyd%d for session, &quot;
l_string|&quot;please connect your debugger&bslash;n&quot;
comma
id|line
ques
c_cond
l_int|1
suffix:colon
l_int|2
)paren
suffix:semicolon
id|remote_debug
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Breakpoints and stuff are in sgi_irq_setup() */
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_SGI_PROM_CONSOLE
id|console_setup
c_func
(paren
l_string|&quot;ttyS0&quot;
)paren
suffix:semicolon
macro_line|#endif
id|sgi_volume_set
c_func
(paren
id|simple_strtoul
c_func
(paren
id|ArcGetEnvironmentVariable
c_func
(paren
l_string|&quot;volume&quot;
)paren
comma
l_int|NULL
comma
l_int|10
)paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_VT
macro_line|#ifdef CONFIG_SGI_NEWPORT_CONSOLE
id|conswitchp
op_assign
op_amp
id|newport_con
suffix:semicolon
id|screen_info
op_assign
(paren
r_struct
id|screen_info
)paren
(brace
l_int|0
comma
l_int|0
comma
multiline_comment|/* orig-x, orig-y */
l_int|0
comma
multiline_comment|/* unused */
l_int|0
comma
multiline_comment|/* orig_video_page */
l_int|0
comma
multiline_comment|/* orig_video_mode */
l_int|160
comma
multiline_comment|/* orig_video_cols */
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* unused, ega_bx, unused */
l_int|64
comma
multiline_comment|/* orig_video_lines */
l_int|0
comma
multiline_comment|/* orig_video_isVGA */
l_int|16
multiline_comment|/* orig_video_points */
)brace
suffix:semicolon
macro_line|#else
id|conswitchp
op_assign
op_amp
id|dummy_con
suffix:semicolon
macro_line|#endif
macro_line|#endif
id|rtc_ops
op_assign
op_amp
id|indy_rtc_ops
suffix:semicolon
id|kbd_ops
op_assign
op_amp
id|sgi_kbd_ops
suffix:semicolon
macro_line|#ifdef CONFIG_PSMOUSE
id|aux_device_present
op_assign
l_int|0xaa
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_VIDEO_VINO
id|init_vino
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
)brace
eof
