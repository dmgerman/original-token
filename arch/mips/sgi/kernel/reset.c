multiline_comment|/* $Id: reset.c,v 1.7 1999/08/11 20:26:51 andrewb Exp $&n; *&n; * Reset a SGI.&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; * Copyright (C) 1997, 1998 by Ralf Baechle&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/notifier.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/reboot.h&gt;
macro_line|#include &lt;asm/sgialib.h&gt;
macro_line|#include &lt;asm/sgi/sgihpc.h&gt;
macro_line|#include &lt;asm/sgi/sgint23.h&gt;
multiline_comment|/*&n; * Just powerdown if init hasn&squot;t done after POWERDOWN_TIMEOUT seconds.&n; * I&squot;m not shure if this feature is a good idea, for now it&squot;s here just to&n; * make the power button make behave just like under IRIX.&n; */
DECL|macro|POWERDOWN_TIMEOUT
mdefine_line|#define POWERDOWN_TIMEOUT&t;120
multiline_comment|/*&n; * Blink frequency during reboot grace period and when paniced.&n; */
DECL|macro|POWERDOWN_FREQ
mdefine_line|#define POWERDOWN_FREQ&t;&t;(HZ / 4)
DECL|macro|PANIC_FREQ
mdefine_line|#define PANIC_FREQ&t;&t;(HZ / 8)
DECL|variable|sgi_volume
r_static
r_int
r_char
id|sgi_volume
suffix:semicolon
DECL|variable|power_timer
DECL|variable|blink_timer
DECL|variable|debounce_timer
DECL|variable|volume_timer
r_static
r_struct
id|timer_list
id|power_timer
comma
id|blink_timer
comma
id|debounce_timer
comma
id|volume_timer
suffix:semicolon
DECL|variable|shuting_down
DECL|variable|has_paniced
r_static
r_int
id|shuting_down
comma
id|has_paniced
suffix:semicolon
r_static
r_void
id|sgi_machine_restart
c_func
(paren
r_char
op_star
id|command
)paren
id|__attribute__
c_func
(paren
(paren
id|noreturn
)paren
)paren
suffix:semicolon
r_static
r_void
id|sgi_machine_halt
c_func
(paren
r_void
)paren
id|__attribute__
c_func
(paren
(paren
id|noreturn
)paren
)paren
suffix:semicolon
r_static
r_void
id|sgi_machine_power_off
c_func
(paren
r_void
)paren
id|__attribute__
c_func
(paren
(paren
id|noreturn
)paren
)paren
suffix:semicolon
multiline_comment|/* XXX How to pass the reboot command to the firmware??? */
DECL|function|sgi_machine_restart
r_static
r_void
id|sgi_machine_restart
c_func
(paren
r_char
op_star
id|command
)paren
(brace
r_if
c_cond
(paren
id|shuting_down
)paren
id|sgi_machine_power_off
c_func
(paren
)paren
suffix:semicolon
id|prom_reboot
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|sgi_machine_halt
r_static
r_void
id|sgi_machine_halt
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|shuting_down
)paren
id|sgi_machine_power_off
c_func
(paren
)paren
suffix:semicolon
id|prom_imode
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|sgi_machine_power_off
r_static
r_void
id|sgi_machine_power_off
c_func
(paren
r_void
)paren
(brace
r_struct
id|indy_clock
op_star
id|clock
op_assign
(paren
r_struct
id|indy_clock
op_star
)paren
id|INDY_CLOCK_REGS
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|clock-&gt;cmd
op_or_assign
l_int|0x08
suffix:semicolon
multiline_comment|/* Disable watchdog */
id|clock-&gt;whsec
op_assign
l_int|0
suffix:semicolon
id|clock-&gt;wsec
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|hpc3mregs-&gt;panel
op_assign
l_int|0xfe
suffix:semicolon
multiline_comment|/* Good bye cruel world ...  */
multiline_comment|/* If we&squot;re still running, we probably got sent an alarm&n;&t;&t;   interrupt.  Read the flag to clear it.  */
id|clock-&gt;halarm
suffix:semicolon
)brace
)brace
DECL|function|power_timeout
r_static
r_void
id|power_timeout
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|sgi_machine_power_off
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|blink_timeout
r_static
r_void
id|blink_timeout
c_func
(paren
r_int
r_int
id|data
)paren
(brace
multiline_comment|/* XXX fix this for fullhouse  */
id|sgi_hpc_write1
op_xor_assign
(paren
id|HPC3_WRITE1_LC0OFF
op_or
id|HPC3_WRITE1_LC1OFF
)paren
suffix:semicolon
id|hpc3mregs-&gt;write1
op_assign
id|sgi_hpc_write1
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|blink_timer
comma
id|jiffies
op_plus
id|data
)paren
suffix:semicolon
)brace
DECL|function|debounce
r_static
r_void
id|debounce
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|debounce_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc_icontrol-&gt;istat1
op_amp
l_int|2
)paren
(brace
multiline_comment|/* Interrupt still being sent.  */
id|debounce_timer.expires
op_assign
id|jiffies
op_plus
l_int|5
suffix:semicolon
multiline_comment|/* 0.05s  */
id|add_timer
c_func
(paren
op_amp
id|debounce_timer
)paren
suffix:semicolon
id|hpc3mregs-&gt;panel
op_assign
l_int|0xf3
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|has_paniced
)paren
id|prom_reboot
c_func
(paren
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|SGI_PANEL_IRQ
)paren
suffix:semicolon
)brace
DECL|function|power_button
r_static
r_inline
r_void
id|power_button
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|has_paniced
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|shuting_down
op_logical_or
id|kill_proc
c_func
(paren
l_int|1
comma
id|SIGINT
comma
l_int|1
)paren
)paren
(brace
multiline_comment|/* No init process or button pressed twice.  */
id|sgi_machine_power_off
c_func
(paren
)paren
suffix:semicolon
)brace
id|shuting_down
op_assign
l_int|1
suffix:semicolon
id|blink_timer.data
op_assign
id|POWERDOWN_FREQ
suffix:semicolon
id|blink_timeout
c_func
(paren
id|POWERDOWN_FREQ
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|power_timer
)paren
suffix:semicolon
id|power_timer.function
op_assign
id|power_timeout
suffix:semicolon
id|power_timer.expires
op_assign
id|jiffies
op_plus
id|POWERDOWN_TIMEOUT
op_star
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|power_timer
)paren
suffix:semicolon
)brace
DECL|function|sgi_volume_set
r_void
r_inline
id|sgi_volume_set
c_func
(paren
r_int
r_char
id|volume
)paren
(brace
id|sgi_volume
op_assign
id|volume
suffix:semicolon
id|hpc3c0-&gt;pbus_extregs
(braket
l_int|2
)braket
(braket
l_int|0
)braket
op_assign
id|sgi_volume
suffix:semicolon
id|hpc3c0-&gt;pbus_extregs
(braket
l_int|2
)braket
(braket
l_int|1
)braket
op_assign
id|sgi_volume
suffix:semicolon
)brace
DECL|function|sgi_volume_get
r_void
r_inline
id|sgi_volume_get
c_func
(paren
r_int
r_char
op_star
id|volume
)paren
(brace
op_star
id|volume
op_assign
id|sgi_volume
suffix:semicolon
)brace
DECL|function|volume_up_button
r_static
r_inline
r_void
id|volume_up_button
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|volume_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sgi_volume
OL
l_int|0xff
)paren
id|sgi_volume
op_increment
suffix:semicolon
id|hpc3c0-&gt;pbus_extregs
(braket
l_int|2
)braket
(braket
l_int|0
)braket
op_assign
id|sgi_volume
suffix:semicolon
id|hpc3c0-&gt;pbus_extregs
(braket
l_int|2
)braket
(braket
l_int|1
)braket
op_assign
id|sgi_volume
suffix:semicolon
r_if
c_cond
(paren
id|ioc_icontrol-&gt;istat1
op_amp
l_int|2
)paren
(brace
id|volume_timer.expires
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|volume_timer
)paren
suffix:semicolon
)brace
)brace
DECL|function|volume_down_button
r_static
r_inline
r_void
id|volume_down_button
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|volume_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sgi_volume
OG
l_int|0
)paren
id|sgi_volume
op_decrement
suffix:semicolon
id|hpc3c0-&gt;pbus_extregs
(braket
l_int|2
)braket
(braket
l_int|0
)braket
op_assign
id|sgi_volume
suffix:semicolon
id|hpc3c0-&gt;pbus_extregs
(braket
l_int|2
)braket
(braket
l_int|1
)braket
op_assign
id|sgi_volume
suffix:semicolon
r_if
c_cond
(paren
id|ioc_icontrol-&gt;istat1
op_amp
l_int|2
)paren
(brace
id|volume_timer.expires
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|volume_timer
)paren
suffix:semicolon
)brace
)brace
DECL|function|panel_int
r_static
r_void
id|panel_int
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|buttons
suffix:semicolon
id|buttons
op_assign
id|hpc3mregs-&gt;panel
suffix:semicolon
id|hpc3mregs-&gt;panel
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* power_interrupt | power_supply_on */
r_if
c_cond
(paren
id|ioc_icontrol-&gt;istat1
op_amp
l_int|2
)paren
(brace
multiline_comment|/* Wait until interrupt goes away */
id|disable_irq
c_func
(paren
id|SGI_PANEL_IRQ
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|debounce_timer
)paren
suffix:semicolon
id|debounce_timer.function
op_assign
id|debounce
suffix:semicolon
id|debounce_timer.expires
op_assign
id|jiffies
op_plus
l_int|5
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|debounce_timer
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|buttons
op_amp
l_int|2
)paren
)paren
multiline_comment|/* Power button was pressed */
id|power_button
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|buttons
op_amp
l_int|0x40
)paren
)paren
(brace
multiline_comment|/* Volume up button was pressed */
id|init_timer
c_func
(paren
op_amp
id|volume_timer
)paren
suffix:semicolon
id|volume_timer.function
op_assign
id|volume_up_button
suffix:semicolon
id|volume_timer.expires
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|volume_timer
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|buttons
op_amp
l_int|0x10
)paren
)paren
(brace
multiline_comment|/* Volume down button was pressed */
id|init_timer
c_func
(paren
op_amp
id|volume_timer
)paren
suffix:semicolon
id|volume_timer.function
op_assign
id|volume_down_button
suffix:semicolon
id|volume_timer.expires
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|volume_timer
)paren
suffix:semicolon
)brace
)brace
DECL|function|panic_event
r_static
r_int
id|panic_event
c_func
(paren
r_struct
id|notifier_block
op_star
id|this
comma
r_int
r_int
id|event
comma
r_void
op_star
id|ptr
)paren
(brace
r_if
c_cond
(paren
id|has_paniced
)paren
r_return
id|NOTIFY_DONE
suffix:semicolon
id|has_paniced
op_assign
l_int|1
suffix:semicolon
id|blink_timer.data
op_assign
id|PANIC_FREQ
suffix:semicolon
id|blink_timeout
c_func
(paren
id|PANIC_FREQ
)paren
suffix:semicolon
r_return
id|NOTIFY_DONE
suffix:semicolon
)brace
DECL|variable|panic_block
r_static
r_struct
id|notifier_block
id|panic_block
op_assign
(brace
id|panic_event
comma
l_int|NULL
comma
l_int|0
)brace
suffix:semicolon
DECL|function|indy_reboot_setup
r_void
id|indy_reboot_setup
c_func
(paren
r_void
)paren
(brace
r_static
r_int
id|setup_done
suffix:semicolon
r_if
c_cond
(paren
id|setup_done
)paren
r_return
suffix:semicolon
id|setup_done
op_assign
l_int|1
suffix:semicolon
id|_machine_restart
op_assign
id|sgi_machine_restart
suffix:semicolon
id|_machine_halt
op_assign
id|sgi_machine_halt
suffix:semicolon
id|_machine_power_off
op_assign
id|sgi_machine_power_off
suffix:semicolon
id|request_irq
c_func
(paren
id|SGI_PANEL_IRQ
comma
id|panel_int
comma
l_int|0
comma
l_string|&quot;Front Panel&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|blink_timer
)paren
suffix:semicolon
id|blink_timer.function
op_assign
id|blink_timeout
suffix:semicolon
id|notifier_chain_register
c_func
(paren
op_amp
id|panic_notifier_list
comma
op_amp
id|panic_block
)paren
suffix:semicolon
)brace
eof
