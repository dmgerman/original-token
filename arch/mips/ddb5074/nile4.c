multiline_comment|/*&n; *  arch/mips/ddb5074/nile4.c -- NEC Vrc-5074 Nile 4 support routines&n; *&n; *  Copyright (C) 2000 Geert Uytterhoeven &lt;geert@sonycom.com&gt;&n; *                     Sony Software Development Center Europe (SDCE), Brussels&n; *&n; *  $Id$&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;asm/nile4.h&gt;
multiline_comment|/*&n;     *  Physical Device Address Registers&n;     *&n;     *  Note: 32 bit addressing only!&n;     */
DECL|function|nile4_set_pdar
r_void
id|nile4_set_pdar
c_func
(paren
id|u32
id|pdar
comma
id|u32
id|phys
comma
id|u32
id|size
comma
r_int
id|width
comma
r_int
id|on_memory_bus
comma
r_int
id|visible
)paren
(brace
id|u32
id|maskbits
suffix:semicolon
id|u32
id|widthbits
suffix:semicolon
r_if
c_cond
(paren
id|pdar
OG
id|NILE4_BOOTCS
op_logical_or
(paren
id|pdar
op_amp
l_int|7
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nile4_set_pdar: invalid pdar %d&bslash;n&quot;
comma
id|pdar
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pdar
op_eq
id|NILE4_INTCS
op_logical_and
id|size
op_ne
l_int|0x00200000
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nile4_set_pdar: INTCS size must be 2 MB&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|size
)paren
(brace
macro_line|#if 0&t;/* We don&squot;t support 4 GB yet */
r_case
l_int|0x100000000
suffix:colon
multiline_comment|/* 4 GB */
id|maskbits
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
l_int|0x80000000
suffix:colon
multiline_comment|/* 2 GB */
id|maskbits
op_assign
l_int|5
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x40000000
suffix:colon
multiline_comment|/* 1 GB */
id|maskbits
op_assign
l_int|6
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x20000000
suffix:colon
multiline_comment|/* 512 MB */
id|maskbits
op_assign
l_int|7
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x10000000
suffix:colon
multiline_comment|/* 256 MB */
id|maskbits
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x08000000
suffix:colon
multiline_comment|/* 128 MB */
id|maskbits
op_assign
l_int|9
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x04000000
suffix:colon
multiline_comment|/* 64 MB */
id|maskbits
op_assign
l_int|10
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02000000
suffix:colon
multiline_comment|/* 32 MB */
id|maskbits
op_assign
l_int|11
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x01000000
suffix:colon
multiline_comment|/* 16 MB */
id|maskbits
op_assign
l_int|12
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x00800000
suffix:colon
multiline_comment|/* 8 MB */
id|maskbits
op_assign
l_int|13
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x00400000
suffix:colon
multiline_comment|/* 4 MB */
id|maskbits
op_assign
l_int|14
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x00200000
suffix:colon
multiline_comment|/* 2 MB */
id|maskbits
op_assign
l_int|15
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0
suffix:colon
multiline_comment|/* OFF */
id|maskbits
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;nile4_set_pdar: unsupported size %p&bslash;n&quot;
comma
(paren
r_void
op_star
)paren
id|size
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|width
)paren
(brace
r_case
l_int|8
suffix:colon
id|widthbits
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|widthbits
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|widthbits
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|64
suffix:colon
id|widthbits
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;nile4_set_pdar: unsupported width %d&bslash;n&quot;
comma
id|width
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|nile4_out32
c_func
(paren
id|pdar
comma
id|maskbits
op_or
(paren
id|on_memory_bus
ques
c_cond
l_int|0x10
suffix:colon
l_int|0
)paren
op_or
(paren
id|visible
ques
c_cond
l_int|0x20
suffix:colon
l_int|0
)paren
op_or
(paren
id|widthbits
op_lshift
l_int|6
)paren
op_or
(paren
id|phys
op_amp
l_int|0xffe00000
)paren
)paren
suffix:semicolon
id|nile4_out32
c_func
(paren
id|pdar
op_plus
l_int|4
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;     *  When programming a PDAR, the register should be read immediately after&n;     *  writing it. This ensures that address decoders are properly configured.&n;     */
(paren
r_void
)paren
id|nile4_in32
c_func
(paren
id|pdar
)paren
suffix:semicolon
(paren
r_void
)paren
id|nile4_in32
c_func
(paren
id|pdar
op_plus
l_int|4
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;     *  PCI Master Registers&n;     *&n;     *  Note: 32 bit addressing only!&n;     */
DECL|function|nile4_set_pmr
r_void
id|nile4_set_pmr
c_func
(paren
id|u32
id|pmr
comma
id|u32
id|type
comma
id|u32
id|addr
)paren
(brace
r_if
c_cond
(paren
id|pmr
op_ne
id|NILE4_PCIINIT0
op_logical_and
id|pmr
op_ne
id|NILE4_PCIINIT1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nile4_set_pmr: invalid pmr %d&bslash;n&quot;
comma
id|pmr
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|NILE4_PCICMD_IACK
suffix:colon
multiline_comment|/* PCI Interrupt Acknowledge */
r_case
id|NILE4_PCICMD_IO
suffix:colon
multiline_comment|/* PCI I/O Space */
r_case
id|NILE4_PCICMD_MEM
suffix:colon
multiline_comment|/* PCI Memory Space */
r_case
id|NILE4_PCICMD_CFG
suffix:colon
multiline_comment|/* PCI Configuration Space */
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;nile4_set_pmr: invalid type %d&bslash;n&quot;
comma
id|type
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|nile4_out32
c_func
(paren
id|pmr
comma
(paren
id|type
op_lshift
l_int|1
)paren
op_or
l_int|0x10
op_or
(paren
id|addr
op_amp
l_int|0xffe00000
)paren
)paren
suffix:semicolon
id|nile4_out32
c_func
(paren
id|pmr
op_plus
l_int|4
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Interrupt Programming&n;     */
DECL|function|nile4_map_irq
r_void
id|nile4_map_irq
c_func
(paren
r_int
id|nile4_irq
comma
r_int
id|cpu_irq
)paren
(brace
id|u32
id|offset
comma
id|t
suffix:semicolon
id|offset
op_assign
id|NILE4_INTCTRL
suffix:semicolon
r_if
c_cond
(paren
id|nile4_irq
op_ge
l_int|8
)paren
(brace
id|offset
op_add_assign
l_int|4
suffix:semicolon
id|nile4_irq
op_sub_assign
l_int|8
suffix:semicolon
)brace
id|t
op_assign
id|nile4_in32
c_func
(paren
id|offset
)paren
suffix:semicolon
id|t
op_and_assign
op_complement
(paren
l_int|7
op_lshift
(paren
id|nile4_irq
op_star
l_int|4
)paren
)paren
suffix:semicolon
id|t
op_or_assign
id|cpu_irq
op_lshift
(paren
id|nile4_irq
op_star
l_int|4
)paren
suffix:semicolon
id|nile4_out32
c_func
(paren
id|offset
comma
id|t
)paren
suffix:semicolon
)brace
DECL|function|nile4_map_irq_all
r_void
id|nile4_map_irq_all
c_func
(paren
r_int
id|cpu_irq
)paren
(brace
id|u32
id|all
comma
id|t
suffix:semicolon
id|all
op_assign
id|cpu_irq
suffix:semicolon
id|all
op_or_assign
id|all
op_lshift
l_int|4
suffix:semicolon
id|all
op_or_assign
id|all
op_lshift
l_int|8
suffix:semicolon
id|all
op_or_assign
id|all
op_lshift
l_int|16
suffix:semicolon
id|t
op_assign
id|nile4_in32
c_func
(paren
id|NILE4_INTCTRL
)paren
suffix:semicolon
id|t
op_and_assign
l_int|0x88888888
suffix:semicolon
id|t
op_or_assign
id|all
suffix:semicolon
id|nile4_out32
c_func
(paren
id|NILE4_INTCTRL
comma
id|t
)paren
suffix:semicolon
id|t
op_assign
id|nile4_in32
c_func
(paren
id|NILE4_INTCTRL
op_plus
l_int|4
)paren
suffix:semicolon
id|t
op_and_assign
l_int|0x88888888
suffix:semicolon
id|t
op_or_assign
id|all
suffix:semicolon
id|nile4_out32
c_func
(paren
id|NILE4_INTCTRL
op_plus
l_int|4
comma
id|t
)paren
suffix:semicolon
)brace
DECL|function|nile4_enable_irq
r_void
id|nile4_enable_irq
c_func
(paren
r_int
id|nile4_irq
)paren
(brace
id|u32
id|offset
comma
id|t
suffix:semicolon
id|offset
op_assign
id|NILE4_INTCTRL
suffix:semicolon
r_if
c_cond
(paren
id|nile4_irq
op_ge
l_int|8
)paren
(brace
id|offset
op_add_assign
l_int|4
suffix:semicolon
id|nile4_irq
op_sub_assign
l_int|8
suffix:semicolon
)brace
id|t
op_assign
id|nile4_in32
c_func
(paren
id|offset
)paren
suffix:semicolon
id|t
op_or_assign
l_int|8
op_lshift
(paren
id|nile4_irq
op_star
l_int|4
)paren
suffix:semicolon
id|nile4_out32
c_func
(paren
id|offset
comma
id|t
)paren
suffix:semicolon
)brace
DECL|function|nile4_disable_irq
r_void
id|nile4_disable_irq
c_func
(paren
r_int
id|nile4_irq
)paren
(brace
id|u32
id|offset
comma
id|t
suffix:semicolon
id|offset
op_assign
id|NILE4_INTCTRL
suffix:semicolon
r_if
c_cond
(paren
id|nile4_irq
op_ge
l_int|8
)paren
(brace
id|offset
op_add_assign
l_int|4
suffix:semicolon
id|nile4_irq
op_sub_assign
l_int|8
suffix:semicolon
)brace
id|t
op_assign
id|nile4_in32
c_func
(paren
id|offset
)paren
suffix:semicolon
id|t
op_and_assign
op_complement
(paren
l_int|8
op_lshift
(paren
id|nile4_irq
op_star
l_int|4
)paren
)paren
suffix:semicolon
id|nile4_out32
c_func
(paren
id|offset
comma
id|t
)paren
suffix:semicolon
)brace
DECL|function|nile4_disable_irq_all
r_void
id|nile4_disable_irq_all
c_func
(paren
r_void
)paren
(brace
id|nile4_out32
c_func
(paren
id|NILE4_INTCTRL
comma
l_int|0
)paren
suffix:semicolon
id|nile4_out32
c_func
(paren
id|NILE4_INTCTRL
op_plus
l_int|4
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|nile4_get_irq_stat
id|u16
id|nile4_get_irq_stat
c_func
(paren
r_int
id|cpu_irq
)paren
(brace
r_return
id|nile4_in16
c_func
(paren
id|NILE4_INTSTAT0
op_plus
id|cpu_irq
op_star
l_int|2
)paren
suffix:semicolon
)brace
DECL|function|nile4_enable_irq_output
r_void
id|nile4_enable_irq_output
c_func
(paren
r_int
id|cpu_irq
)paren
(brace
id|u32
id|t
suffix:semicolon
id|t
op_assign
id|nile4_in32
c_func
(paren
id|NILE4_INTSTAT1
op_plus
l_int|4
)paren
suffix:semicolon
id|t
op_or_assign
l_int|1
op_lshift
(paren
l_int|16
op_plus
id|cpu_irq
)paren
suffix:semicolon
id|nile4_out32
c_func
(paren
id|NILE4_INTSTAT1
comma
id|t
)paren
suffix:semicolon
)brace
DECL|function|nile4_disable_irq_output
r_void
id|nile4_disable_irq_output
c_func
(paren
r_int
id|cpu_irq
)paren
(brace
id|u32
id|t
suffix:semicolon
id|t
op_assign
id|nile4_in32
c_func
(paren
id|NILE4_INTSTAT1
op_plus
l_int|4
)paren
suffix:semicolon
id|t
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
l_int|16
op_plus
id|cpu_irq
)paren
)paren
suffix:semicolon
id|nile4_out32
c_func
(paren
id|NILE4_INTSTAT1
comma
id|t
)paren
suffix:semicolon
)brace
DECL|function|nile4_set_pci_irq_polarity
r_void
id|nile4_set_pci_irq_polarity
c_func
(paren
r_int
id|pci_irq
comma
r_int
id|high
)paren
(brace
id|u32
id|t
suffix:semicolon
id|t
op_assign
id|nile4_in32
c_func
(paren
id|NILE4_INTPPES
)paren
suffix:semicolon
r_if
c_cond
(paren
id|high
)paren
id|t
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|pci_irq
op_star
l_int|2
)paren
)paren
suffix:semicolon
r_else
id|t
op_or_assign
l_int|1
op_lshift
(paren
id|pci_irq
op_star
l_int|2
)paren
suffix:semicolon
id|nile4_out32
c_func
(paren
id|NILE4_INTPPES
comma
id|t
)paren
suffix:semicolon
)brace
DECL|function|nile4_set_pci_irq_level_or_edge
r_void
id|nile4_set_pci_irq_level_or_edge
c_func
(paren
r_int
id|pci_irq
comma
r_int
id|level
)paren
(brace
id|u32
id|t
suffix:semicolon
id|t
op_assign
id|nile4_in32
c_func
(paren
id|NILE4_INTPPES
)paren
suffix:semicolon
r_if
c_cond
(paren
id|level
)paren
id|t
op_or_assign
l_int|2
op_lshift
(paren
id|pci_irq
op_star
l_int|2
)paren
suffix:semicolon
r_else
id|t
op_and_assign
op_complement
(paren
l_int|2
op_lshift
(paren
id|pci_irq
op_star
l_int|2
)paren
)paren
suffix:semicolon
id|nile4_out32
c_func
(paren
id|NILE4_INTPPES
comma
id|t
)paren
suffix:semicolon
)brace
DECL|function|nile4_clear_irq
r_void
id|nile4_clear_irq
c_func
(paren
r_int
id|nile4_irq
)paren
(brace
id|nile4_out32
c_func
(paren
id|NILE4_INTCLR
comma
l_int|1
op_lshift
id|nile4_irq
)paren
suffix:semicolon
)brace
DECL|function|nile4_clear_irq_mask
r_void
id|nile4_clear_irq_mask
c_func
(paren
id|u32
id|mask
)paren
(brace
id|nile4_out32
c_func
(paren
id|NILE4_INTCLR
comma
id|mask
)paren
suffix:semicolon
)brace
DECL|function|nile4_i8259_iack
id|u8
id|nile4_i8259_iack
c_func
(paren
r_void
)paren
(brace
id|u8
id|irq
suffix:semicolon
multiline_comment|/* Set window 0 for interrupt acknowledge */
id|nile4_set_pmr
c_func
(paren
id|NILE4_PCIINIT0
comma
id|NILE4_PCICMD_IACK
comma
l_int|0
)paren
suffix:semicolon
id|irq
op_assign
op_star
(paren
r_volatile
id|u8
op_star
)paren
id|NILE4_PCI_IACK_BASE
suffix:semicolon
multiline_comment|/* Set window 0 for PCI I/O space */
id|nile4_set_pmr
c_func
(paren
id|NILE4_PCIINIT0
comma
id|NILE4_PCICMD_IO
comma
l_int|0
)paren
suffix:semicolon
r_return
id|irq
suffix:semicolon
)brace
macro_line|#if 0
r_void
id|nile4_dump_irq_status
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;CPUSTAT = %p:%p&bslash;n&quot;
comma
(paren
r_void
op_star
)paren
id|nile4_in32
c_func
(paren
id|NILE4_CPUSTAT
op_plus
l_int|4
)paren
comma
(paren
r_void
op_star
)paren
id|nile4_in32
c_func
(paren
id|NILE4_CPUSTAT
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;INTCTRL = %p:%p&bslash;n&quot;
comma
(paren
r_void
op_star
)paren
id|nile4_in32
c_func
(paren
id|NILE4_INTCTRL
op_plus
l_int|4
)paren
comma
(paren
r_void
op_star
)paren
id|nile4_in32
c_func
(paren
id|NILE4_INTCTRL
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;INTSTAT0 = %p:%p&bslash;n&quot;
comma
(paren
r_void
op_star
)paren
id|nile4_in32
c_func
(paren
id|NILE4_INTSTAT0
op_plus
l_int|4
)paren
comma
(paren
r_void
op_star
)paren
id|nile4_in32
c_func
(paren
id|NILE4_INTSTAT0
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;INTSTAT1 = %p:%p&bslash;n&quot;
comma
(paren
r_void
op_star
)paren
id|nile4_in32
c_func
(paren
id|NILE4_INTSTAT1
op_plus
l_int|4
)paren
comma
(paren
r_void
op_star
)paren
id|nile4_in32
c_func
(paren
id|NILE4_INTSTAT1
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;INTCLR = %p:%p&bslash;n&quot;
comma
(paren
r_void
op_star
)paren
id|nile4_in32
c_func
(paren
id|NILE4_INTCLR
op_plus
l_int|4
)paren
comma
(paren
r_void
op_star
)paren
id|nile4_in32
c_func
(paren
id|NILE4_INTCLR
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;INTPPES = %p:%p&bslash;n&quot;
comma
(paren
r_void
op_star
)paren
id|nile4_in32
c_func
(paren
id|NILE4_INTPPES
op_plus
l_int|4
)paren
comma
(paren
r_void
op_star
)paren
id|nile4_in32
c_func
(paren
id|NILE4_INTPPES
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
