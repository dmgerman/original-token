multiline_comment|/*&n; *  arch/mips/ddb5074/irq.c -- NEC DDB Vrc-5074 interrupt routines&n; *&n; *  Copyright (C) 2000 Geert Uytterhoeven &lt;geert@sonycom.com&gt;&n; *                     Sony Software Development Center Europe (SDCE), Brussels&n; *&n; *  $Id: irq.c,v 1.1 2000/01/26 00:07:44 ralf Exp $&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/ptrace.h&gt;
macro_line|#include &lt;asm/nile4.h&gt;
macro_line|#include &lt;asm/ddb5074.h&gt;
r_extern
r_void
id|__init
id|i8259_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|i8259_disable_irq
c_func
(paren
r_int
r_int
id|irq_nr
)paren
suffix:semicolon
r_extern
r_void
id|i8259_enable_irq
c_func
(paren
r_int
r_int
id|irq_nr
)paren
suffix:semicolon
r_extern
id|asmlinkage
r_void
id|ddbIRQ
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
id|asmlinkage
r_void
id|i8259_do_irq
c_func
(paren
r_int
id|irq
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_extern
id|asmlinkage
r_void
id|do_IRQ
c_func
(paren
r_int
id|irq
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
DECL|function|no_action
r_void
id|no_action
c_func
(paren
r_int
id|cpl
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
)brace
DECL|macro|M1543_PNP_CONFIG
mdefine_line|#define M1543_PNP_CONFIG&t;0x03f0&t;/* PnP Config Port */
DECL|macro|M1543_PNP_INDEX
mdefine_line|#define M1543_PNP_INDEX&t;&t;0x03f0&t;/* PnP Index Port */
DECL|macro|M1543_PNP_DATA
mdefine_line|#define M1543_PNP_DATA&t;&t;0x03f1&t;/* PnP Data Port */
DECL|macro|M1543_PNP_ALT_CONFIG
mdefine_line|#define M1543_PNP_ALT_CONFIG&t;0x0370&t;/* Alternative PnP Config Port */
DECL|macro|M1543_PNP_ALT_INDEX
mdefine_line|#define M1543_PNP_ALT_INDEX&t;0x0370&t;/* Alternative PnP Index Port */
DECL|macro|M1543_PNP_ALT_DATA
mdefine_line|#define M1543_PNP_ALT_DATA&t;0x0371&t;/* Alternative PnP Data Port */
DECL|macro|M1543_INT1_MASTER_CTRL
mdefine_line|#define M1543_INT1_MASTER_CTRL&t;0x0020&t;/* INT_1 (master) Control Register */
DECL|macro|M1543_INT1_MASTER_MASK
mdefine_line|#define M1543_INT1_MASTER_MASK&t;0x0021&t;/* INT_1 (master) Mask Register */
DECL|macro|M1543_INT1_SLAVE_CTRL
mdefine_line|#define M1543_INT1_SLAVE_CTRL&t;0x00a0&t;/* INT_1 (slave) Control Register */
DECL|macro|M1543_INT1_SLAVE_MASK
mdefine_line|#define M1543_INT1_SLAVE_MASK&t;0x00a1&t;/* INT_1 (slave) Mask Register */
DECL|macro|M1543_INT1_MASTER_ELCR
mdefine_line|#define M1543_INT1_MASTER_ELCR&t;0x04d0&t;/* INT_1 (master) Edge/Level Control */
DECL|macro|M1543_INT1_SLAVE_ELCR
mdefine_line|#define M1543_INT1_SLAVE_ELCR&t;0x04d1&t;/* INT_1 (slave) Edge/Level Control */
DECL|function|m1543_irq_setup
r_static
r_void
id|m1543_irq_setup
c_func
(paren
r_void
)paren
(brace
multiline_comment|/*&n;     *  The ALI M1543 has 13 interrupt inputs, IRQ1..IRQ13.  Not all&n;     *  the possible IO sources in the M1543 are in use by us.  We will&n;     *  use the following mapping:&n;     *&n;     *&t;    IRQ1  - keyboard (default set by M1543)&n;     *&t;    IRQ3  - reserved for UART B (default set by M1543) (note that&n;     *&t;&t;    the schematics for the DDB Vrc-5074 board seem to &n;     *&t;&t;    indicate that IRQ3 is connected to the DS1386 &n;     *&t;&t;    watchdog timer interrupt output so we might have &n;     *&t;&t;    a conflict)&n;     *&t;    IRQ4  - reserved for UART A (default set by M1543)&n;     *&t;    IRQ5  - parallel (default set by M1543)&n;     *&t;    IRQ8  - DS1386 time of day (RTC) interrupt&n;     *&t;    IRQ12 - mouse&n;     */
multiline_comment|/*&n;     *  Assing mouse interrupt to IRQ12 &n;     */
multiline_comment|/* Enter configuration mode */
id|outb
c_func
(paren
l_int|0x51
comma
id|M1543_PNP_CONFIG
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x23
comma
id|M1543_PNP_CONFIG
)paren
suffix:semicolon
multiline_comment|/* Select logical device 7 (Keyboard) */
id|outb
c_func
(paren
l_int|0x07
comma
id|M1543_PNP_INDEX
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x07
comma
id|M1543_PNP_DATA
)paren
suffix:semicolon
multiline_comment|/* Select IRQ12 */
id|outb
c_func
(paren
l_int|0x72
comma
id|M1543_PNP_INDEX
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x0c
comma
id|M1543_PNP_DATA
)paren
suffix:semicolon
multiline_comment|/* Leave configration mode */
id|outb
c_func
(paren
l_int|0xbb
comma
id|M1543_PNP_CONFIG
)paren
suffix:semicolon
multiline_comment|/* Initialize the 8259 PIC in the M1543 */
id|i8259_init
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Enable the interrupt cascade */
id|nile4_enable_irq
c_func
(paren
id|NILE4_INT_INTE
)paren
suffix:semicolon
id|request_region
c_func
(paren
id|M1543_PNP_CONFIG
comma
l_int|2
comma
l_string|&quot;M1543 config&quot;
)paren
suffix:semicolon
id|request_region
c_func
(paren
id|M1543_INT1_MASTER_ELCR
comma
l_int|2
comma
l_string|&quot;pic ELCR&quot;
)paren
suffix:semicolon
)brace
DECL|function|nile4_irq_setup
r_static
r_void
id|nile4_irq_setup
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* Map all interrupts to CPU int #0 */
id|nile4_map_irq_all
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* PCI INTA#-E# must be level triggered */
id|nile4_set_pci_irq_level_or_edge
c_func
(paren
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|nile4_set_pci_irq_level_or_edge
c_func
(paren
l_int|1
comma
l_int|1
)paren
suffix:semicolon
id|nile4_set_pci_irq_level_or_edge
c_func
(paren
l_int|2
comma
l_int|1
)paren
suffix:semicolon
id|nile4_set_pci_irq_level_or_edge
c_func
(paren
l_int|3
comma
l_int|1
)paren
suffix:semicolon
id|nile4_set_pci_irq_level_or_edge
c_func
(paren
l_int|4
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* PCI INTA#-D# must be active low, INTE# must be active high */
id|nile4_set_pci_irq_polarity
c_func
(paren
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|nile4_set_pci_irq_polarity
c_func
(paren
l_int|1
comma
l_int|0
)paren
suffix:semicolon
id|nile4_set_pci_irq_polarity
c_func
(paren
l_int|2
comma
l_int|0
)paren
suffix:semicolon
id|nile4_set_pci_irq_polarity
c_func
(paren
l_int|3
comma
l_int|0
)paren
suffix:semicolon
id|nile4_set_pci_irq_polarity
c_func
(paren
l_int|4
comma
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
id|nile4_clear_irq
c_func
(paren
id|i
)paren
suffix:semicolon
multiline_comment|/* Enable CPU int #0 */
id|nile4_enable_irq_output
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|request_mem_region
c_func
(paren
id|NILE4_BASE
comma
id|NILE4_SIZE
comma
l_string|&quot;Nile 4&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * IRQ2 is cascade interrupt to second interrupt controller&n; */
DECL|variable|irq2
r_static
r_struct
id|irqaction
id|irq2
op_assign
(brace
id|no_action
comma
l_int|0
comma
l_int|0
comma
l_string|&quot;cascade&quot;
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
DECL|function|disable_irq
r_void
id|disable_irq
c_func
(paren
r_int
r_int
id|irq_nr
)paren
(brace
r_if
c_cond
(paren
id|is_i8259_irq
c_func
(paren
id|irq_nr
)paren
)paren
id|i8259_disable_irq
c_func
(paren
id|irq_nr
)paren
suffix:semicolon
r_else
id|nile4_disable_irq
c_func
(paren
id|irq_to_nile4
c_func
(paren
id|irq_nr
)paren
)paren
suffix:semicolon
)brace
DECL|function|enable_irq
r_void
id|enable_irq
c_func
(paren
r_int
r_int
id|irq_nr
)paren
(brace
r_if
c_cond
(paren
id|is_i8259_irq
c_func
(paren
id|irq_nr
)paren
)paren
id|i8259_enable_irq
c_func
(paren
id|irq_nr
)paren
suffix:semicolon
r_else
id|nile4_enable_irq
c_func
(paren
id|irq_to_nile4
c_func
(paren
id|irq_nr
)paren
)paren
suffix:semicolon
)brace
DECL|variable|table
r_int
id|table
(braket
l_int|16
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
DECL|function|ddb_local0_irqdispatch
r_void
id|ddb_local0_irqdispatch
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|u32
id|mask
suffix:semicolon
r_int
id|nile4_irq
suffix:semicolon
macro_line|#if 1
r_volatile
r_static
r_int
id|nesting
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|nesting
op_increment
op_eq
l_int|0
)paren
id|ddb5074_led_d3
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|ddb5074_led_hex
c_func
(paren
id|nesting
OL
l_int|16
ques
c_cond
id|nesting
suffix:colon
l_int|15
)paren
suffix:semicolon
macro_line|#endif
id|mask
op_assign
id|nile4_get_irq_stat
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|nile4_clear_irq_mask
c_func
(paren
id|mask
)paren
suffix:semicolon
multiline_comment|/* Handle the timer interrupt first */
r_if
c_cond
(paren
id|mask
op_amp
(paren
l_int|1
op_lshift
id|NILE4_INT_GPT
)paren
)paren
(brace
id|nile4_disable_irq
c_func
(paren
id|NILE4_INT_GPT
)paren
suffix:semicolon
id|do_IRQ
c_func
(paren
id|nile4_to_irq
c_func
(paren
id|NILE4_INT_GPT
)paren
comma
id|regs
)paren
suffix:semicolon
id|nile4_enable_irq
c_func
(paren
id|NILE4_INT_GPT
)paren
suffix:semicolon
id|mask
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|NILE4_INT_GPT
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|nile4_irq
op_assign
l_int|0
suffix:semicolon
id|mask
suffix:semicolon
id|nile4_irq
op_increment
comma
id|mask
op_rshift_assign
l_int|1
)paren
r_if
c_cond
(paren
id|mask
op_amp
l_int|1
)paren
(brace
id|nile4_disable_irq
c_func
(paren
id|nile4_irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nile4_irq
op_eq
id|NILE4_INT_INTE
)paren
(brace
r_int
id|i8259_irq
op_assign
id|nile4_i8259_iack
c_func
(paren
)paren
suffix:semicolon
id|i8259_do_irq
c_func
(paren
id|i8259_irq
comma
id|regs
)paren
suffix:semicolon
)brace
r_else
id|do_IRQ
c_func
(paren
id|nile4_to_irq
c_func
(paren
id|nile4_irq
)paren
comma
id|regs
)paren
suffix:semicolon
id|nile4_enable_irq
c_func
(paren
id|nile4_irq
)paren
suffix:semicolon
)brace
macro_line|#if 1
r_if
c_cond
(paren
op_decrement
id|nesting
op_eq
l_int|0
)paren
id|ddb5074_led_d3
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|ddb5074_led_hex
c_func
(paren
id|nesting
OL
l_int|16
ques
c_cond
id|nesting
suffix:colon
l_int|15
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|ddb_local1_irqdispatch
r_void
id|ddb_local1_irqdispatch
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ddb_local1_irqdispatch called&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|ddb_buserror_irq
r_void
id|ddb_buserror_irq
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ddb_buserror_irq called&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|ddb_8254timer_irq
r_void
id|ddb_8254timer_irq
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ddb_8254timer_irq called&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|ddb_irq_setup
r_void
id|__init
id|ddb_irq_setup
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_REMOTE_DEBUG
r_if
c_cond
(paren
id|remote_debug
)paren
id|set_debug_traps
c_func
(paren
)paren
suffix:semicolon
id|breakpoint
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* you may move this line to whereever you want :-) */
macro_line|#endif
id|request_region
c_func
(paren
l_int|0x20
comma
l_int|0x20
comma
l_string|&quot;pic1&quot;
)paren
suffix:semicolon
id|request_region
c_func
(paren
l_int|0xa0
comma
l_int|0x20
comma
l_string|&quot;pic2&quot;
)paren
suffix:semicolon
id|i8259_setup_irq
c_func
(paren
l_int|2
comma
op_amp
id|irq2
)paren
suffix:semicolon
id|nile4_irq_setup
c_func
(paren
)paren
suffix:semicolon
id|m1543_irq_setup
c_func
(paren
)paren
suffix:semicolon
id|set_except_vector
c_func
(paren
l_int|0
comma
id|ddbIRQ
)paren
suffix:semicolon
)brace
eof
