multiline_comment|/*&n; * arch/mips/dec/decstation.c&n; *&n; * Copyright (C) 1996 Paul M. Antoine&n; *&n; * Written by Paul Antoine.&n; *&n; * FIXME: still plenty to do in this file, as we don&squot;t yet fully fill&n; *        the boot info structure with DEC-specific tags.  Also still&n; *&t;  too specific to the Person Decstattion 5000/2x!!&n; */
macro_line|#include &lt;asm/dec/decstation.h&gt;
macro_line|#include &lt;asm/dec/maxine.h&gt;&t;/* FIXME: what about other decstations? */
macro_line|#include &lt;asm/bootinfo.h&gt;
multiline_comment|/*&n; * dec_setup: Called at boot from dec_entry() in boot.S to do &n; *            DECStation-specific setup, and to fill in the kernel argument&n; *            tags.&n; *&n; * FIXME: I&squot;m not sure all DEC workstations are correctly supported.  This&n; *        code may not need to be here when booting off floppy or HD??&n; */
DECL|variable|mach_mem_upper
r_int
r_int
id|mach_mem_upper
op_assign
l_int|0
suffix:semicolon
DECL|variable|mach_mem_lower
r_int
r_int
id|mach_mem_lower
op_assign
l_int|0
suffix:semicolon
DECL|variable|mips_dcache_size
r_int
r_int
id|mips_dcache_size
op_assign
l_int|0
suffix:semicolon
DECL|variable|mips_icache_size
r_int
r_int
id|mips_icache_size
op_assign
l_int|0
suffix:semicolon
DECL|variable|rex_prom_magic
r_int
r_int
id|rex_prom_magic
suffix:semicolon
multiline_comment|/* from boot.S */
r_int
r_int
id|dec_get_memory_size
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|function|dec_setup
r_void
id|dec_setup
c_func
(paren
r_void
)paren
(brace
r_int
r_int
r_int
id|mem_mask
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|tag_data_dummy
comma
id|dec_sysid
suffix:semicolon
r_int
r_char
id|dec_cpunum
comma
id|dec_systype
comma
id|dec_firmrev
comma
id|dec_etc
suffix:semicolon
r_extern
r_const
r_char
op_star
id|linux_banner
suffix:semicolon
id|pmax_printf
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|linux_banner
)paren
suffix:semicolon
multiline_comment|/* First we need the memory upper bound before we can add tag entries... */
id|mach_mem_lower
op_assign
l_int|0x80000000L
suffix:semicolon
id|mach_mem_upper
op_assign
id|mach_mem_lower
op_plus
id|dec_get_memory_size
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* First tag is always memory upper limit, right Stoned?? */
(paren
r_void
)paren
id|bi_TagAdd
c_func
(paren
id|tag_memupper
comma
id|ULONGSIZE
comma
op_amp
id|mach_mem_upper
)paren
suffix:semicolon
multiline_comment|/* We&squot;re obviously one of the DEC machines */
id|tag_data_dummy
op_assign
id|MACH_GROUP_DEC
suffix:semicolon
(paren
r_void
)paren
id|bi_TagAdd
c_func
(paren
id|tag_machgroup
comma
id|ULONGSIZE
comma
op_amp
id|tag_data_dummy
)paren
suffix:semicolon
multiline_comment|/* Now let&squot;s try to figure out what type of DECStation we are */
id|pmax_printf
c_func
(paren
l_string|&quot;System id is: &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dec_sysid
op_assign
id|pmax_getsysid
c_func
(paren
)paren
)paren
op_ne
l_int|0
)paren
id|pmax_printf
c_func
(paren
l_string|&quot;%x&bslash;n&quot;
comma
id|dec_sysid
)paren
suffix:semicolon
r_else
id|pmax_printf
c_func
(paren
l_string|&quot;unknown&bslash;n&quot;
)paren
suffix:semicolon
id|dec_cpunum
op_assign
(paren
id|dec_sysid
op_amp
l_int|0xff000000
)paren
op_rshift
l_int|24
suffix:semicolon
id|dec_systype
op_assign
(paren
id|dec_sysid
op_amp
l_int|0xff0000
)paren
op_rshift
l_int|16
suffix:semicolon
id|dec_firmrev
op_assign
(paren
id|dec_sysid
op_amp
l_int|0xff00
)paren
op_rshift
l_int|8
suffix:semicolon
id|dec_etc
op_assign
id|dec_sysid
op_amp
l_int|0xff
suffix:semicolon
multiline_comment|/*&n;     * FIXME: for now use the PROM to determine the CPU type - should&n;     *        probably just get the CPU to tell us.&n;     */
id|pmax_printf
c_func
(paren
l_string|&quot;System has an &quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dec_cpunum
)paren
(brace
r_case
l_int|0x82
suffix:colon
(brace
id|pmax_printf
c_func
(paren
l_string|&quot;R3000 CPU&bslash;n&quot;
)paren
suffix:semicolon
id|tag_data_dummy
op_assign
id|CPU_R3000A
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x84
suffix:colon
(brace
id|pmax_printf
c_func
(paren
l_string|&quot;R4000 CPU&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* FIXME: assume a plain R4000PC for now */
id|tag_data_dummy
op_assign
id|CPU_R4000PC
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
(brace
)brace
(brace
id|pmax_printf
c_func
(paren
l_string|&quot;unknown CPU, code is %x&bslash;n&quot;
comma
id|dec_cpunum
)paren
suffix:semicolon
multiline_comment|/* FIXME: assume an R2000 for now */
id|tag_data_dummy
op_assign
id|CPU_R2000
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Add the CPU type */
(paren
r_void
)paren
id|bi_TagAdd
c_func
(paren
id|tag_cputype
comma
id|ULONGSIZE
comma
op_amp
id|tag_data_dummy
)paren
suffix:semicolon
id|pmax_printf
c_func
(paren
l_string|&quot;System has firmware type: &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dec_firmrev
op_eq
l_int|2
)paren
id|pmax_printf
c_func
(paren
l_string|&quot;TCF0&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|pmax_printf
c_func
(paren
l_string|&quot;TCF1&bslash;n&quot;
)paren
suffix:semicolon
id|pmax_printf
c_func
(paren
l_string|&quot;This DECStation is a: &quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dec_systype
)paren
(brace
r_case
l_int|1
suffix:colon
multiline_comment|/* DS2100/3100 Pmax */
id|pmax_printf
c_func
(paren
l_string|&quot;DS2100/3100&bslash;n&quot;
)paren
suffix:semicolon
id|tag_data_dummy
op_assign
id|MACH_DECSTATION
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* DS5000 3max */
id|pmax_printf
c_func
(paren
l_string|&quot;DS5000&bslash;n&quot;
)paren
suffix:semicolon
id|tag_data_dummy
op_assign
id|MACH_DECSTATION
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* DS5000/100 3min */
id|pmax_printf
c_func
(paren
l_string|&quot;DS5000/1x0&bslash;n&quot;
)paren
suffix:semicolon
id|tag_data_dummy
op_assign
id|MACH_DECSTATION
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
multiline_comment|/* Personal DS5000/2x */
id|pmax_printf
c_func
(paren
l_string|&quot;Personal DS5000/2x&bslash;n&quot;
)paren
suffix:semicolon
id|tag_data_dummy
op_assign
id|MACH_DECSTATION
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|pmax_printf
c_func
(paren
l_string|&quot;unknown, id is: %x&bslash;n&quot;
comma
id|dec_systype
)paren
suffix:semicolon
id|tag_data_dummy
op_assign
id|MACH_UNKNOWN
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Add the machine type */
(paren
r_void
)paren
id|bi_TagAdd
c_func
(paren
id|tag_machtype
comma
id|ULONGSIZE
comma
op_amp
id|tag_data_dummy
)paren
suffix:semicolon
multiline_comment|/* Add the number of tlb entries */
id|tag_data_dummy
op_assign
l_int|64
suffix:semicolon
(paren
r_void
)paren
id|bi_TagAdd
c_func
(paren
id|tag_tlb_entries
comma
id|ULONGSIZE
comma
op_amp
id|tag_data_dummy
)paren
suffix:semicolon
multiline_comment|/*&n;     * Add the instruction cache size&n;     * FIXME: should determine this somehow&n;     */
id|tag_data_dummy
op_assign
l_int|0x100000
suffix:semicolon
multiline_comment|/* set it to 64K for now */
(paren
r_void
)paren
id|bi_TagAdd
c_func
(paren
id|tag_icache_size
comma
id|ULONGSIZE
comma
op_amp
id|tag_data_dummy
)paren
suffix:semicolon
id|mips_icache_size
op_assign
id|tag_data_dummy
suffix:semicolon
multiline_comment|/*&n;     * Add the data cache size&n;     * FIXME: should determine this somehow&n;     */
id|tag_data_dummy
op_assign
l_int|0x100000
suffix:semicolon
multiline_comment|/* set it to 64K for now */
(paren
r_void
)paren
id|bi_TagAdd
c_func
(paren
id|tag_dcache_size
comma
id|ULONGSIZE
comma
op_amp
id|tag_data_dummy
)paren
suffix:semicolon
id|mips_dcache_size
op_assign
id|tag_data_dummy
suffix:semicolon
multiline_comment|/* FIXME: should determine vram_base properly */
id|tag_data_dummy
op_assign
l_int|0xa8000000
suffix:semicolon
(paren
r_void
)paren
id|bi_TagAdd
c_func
(paren
id|tag_vram_base
comma
id|ULONGSIZE
comma
op_amp
id|tag_data_dummy
)paren
suffix:semicolon
multiline_comment|/* FIXME: dummy drive info tag */
id|tag_data_dummy
op_assign
l_int|0
suffix:semicolon
(paren
r_void
)paren
id|bi_TagAdd
c_func
(paren
id|tag_drive_info
comma
id|ULONGSIZE
comma
op_amp
id|tag_data_dummy
)paren
suffix:semicolon
multiline_comment|/* FIXME: do we need a dummy tag at the end? */
id|tag_data_dummy
op_assign
l_int|0
suffix:semicolon
(paren
r_void
)paren
id|bi_TagAdd
c_func
(paren
id|tag_dummy
comma
l_int|0
comma
op_amp
id|tag_data_dummy
)paren
suffix:semicolon
id|pmax_printf
c_func
(paren
l_string|&quot;Added tags&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* dec_setup */
DECL|function|dec_get_memory_size
r_int
r_int
id|dec_get_memory_size
c_func
(paren
)paren
(brace
r_int
id|i
comma
id|bitmap_size
suffix:semicolon
r_int
r_int
id|mem_size
op_assign
l_int|0
suffix:semicolon
r_struct
id|pmax_bitmap
(brace
r_int
id|pagesize
suffix:semicolon
r_int
r_char
id|bitmap
(braket
l_int|64
op_star
l_int|1024
op_star
l_int|1024
op_minus
l_int|4
)braket
suffix:semicolon
)brace
op_star
id|bm
suffix:semicolon
multiline_comment|/* some free 64k */
id|bm
op_assign
(paren
r_struct
id|pmax_bitmap
op_star
)paren
l_int|0x8002f000
suffix:semicolon
id|bitmap_size
op_assign
id|pmax_getbitmap
c_func
(paren
id|bm
)paren
suffix:semicolon
id|pmax_printf
c_func
(paren
l_string|&quot;Page size is: %x&bslash;n&quot;
comma
id|bm-&gt;pagesize
)paren
suffix:semicolon
id|pmax_printf
c_func
(paren
l_string|&quot;Bitmap size is: %d bytes&bslash;n&quot;
comma
id|bitmap_size
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|bitmap_size
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* FIXME: very simplistically only add full sets of pages */
r_if
c_cond
(paren
id|bm-&gt;bitmap
(braket
id|i
)braket
op_eq
l_int|0xff
)paren
id|mem_size
op_add_assign
(paren
l_int|8
op_star
id|bm-&gt;pagesize
)paren
suffix:semicolon
)brace
id|pmax_printf
c_func
(paren
l_string|&quot;Main memory size is: %d KB&bslash;n&quot;
comma
(paren
id|mem_size
op_div
l_int|1024
)paren
)paren
suffix:semicolon
r_return
id|mem_size
suffix:semicolon
)brace
multiline_comment|/* dec_get_memory_size */
DECL|function|maxine_rtc_read_data
r_int
r_char
id|maxine_rtc_read_data
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_char
op_star
id|rtc
op_assign
(paren
r_char
op_star
)paren
(paren
id|PMAX_RTC_BASE
)paren
suffix:semicolon
r_return
id|rtc
(braket
id|addr
op_star
l_int|4
)braket
suffix:semicolon
)brace
multiline_comment|/* maxine_rtc_read_data */
DECL|function|maxine_rtc_write_data
r_void
id|maxine_rtc_write_data
c_func
(paren
r_int
r_char
id|data
comma
r_int
r_int
id|addr
)paren
(brace
r_char
op_star
id|rtc
op_assign
(paren
r_char
op_star
)paren
(paren
id|PMAX_RTC_BASE
)paren
suffix:semicolon
id|rtc
(braket
id|addr
op_star
l_int|4
)braket
op_assign
id|data
suffix:semicolon
)brace
multiline_comment|/* maxine_rtc_read_data */
eof
