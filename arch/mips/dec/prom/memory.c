multiline_comment|/*&n; * memory.c: memory initialisation code.&n; *&n; * Copyright (C) 1998 Harald Koerfgen, Frieder Streffer and Paul M. Antoine&n; *&n; * $Id: memory.c,v 1.3 1999/10/09 00:00:58 ralf Exp $&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;asm/addrspace.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/dec/machtype.h&gt;
macro_line|#include &quot;prom.h&quot;
r_typedef
r_struct
(brace
DECL|member|pagesize
r_int
id|pagesize
suffix:semicolon
DECL|member|bitmap
r_int
r_char
id|bitmap
(braket
l_int|0
)braket
suffix:semicolon
DECL|typedef|memmap
)brace
id|memmap
suffix:semicolon
r_extern
r_int
(paren
op_star
id|rex_getbitmap
)paren
(paren
id|memmap
op_star
)paren
suffix:semicolon
DECL|macro|PROM_DEBUG
macro_line|#undef PROM_DEBUG
macro_line|#ifdef PROM_DEBUG
r_extern
r_int
(paren
op_star
id|prom_printf
)paren
(paren
r_char
op_star
comma
dot
dot
dot
)paren
suffix:semicolon
macro_line|#endif
DECL|variable|mem_err
r_volatile
r_int
r_int
id|mem_err
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* So we know an error occured */
r_extern
r_char
id|_end
suffix:semicolon
DECL|macro|PFN_UP
mdefine_line|#define PFN_UP(x)&t;(((x) + PAGE_SIZE-1) &gt;&gt; PAGE_SHIFT)
DECL|macro|PFN_ALIGN
mdefine_line|#define PFN_ALIGN(x)&t;(((unsigned long)(x) + (PAGE_SIZE - 1)) &amp; PAGE_MASK)
multiline_comment|/*&n; * Probe memory in 4MB chunks, waiting for an error to tell us we&squot;ve fallen&n; * off the end of real memory.  Only suitable for the 2100/3100&squot;s (PMAX).&n; */
DECL|macro|CHUNK_SIZE
mdefine_line|#define CHUNK_SIZE 0x400000
DECL|function|pmax_get_memory_size
r_int
r_int
id|__init
id|pmax_get_memory_size
c_func
(paren
r_void
)paren
(brace
r_volatile
r_int
r_char
op_star
id|memory_page
comma
id|dummy
suffix:semicolon
r_char
id|old_handler
(braket
l_int|0x80
)braket
suffix:semicolon
r_extern
r_char
id|genexcept_early
suffix:semicolon
multiline_comment|/* Install exception handler */
id|memcpy
c_func
(paren
op_amp
id|old_handler
comma
(paren
r_void
op_star
)paren
(paren
id|KSEG0
op_plus
l_int|0x80
)paren
comma
l_int|0x80
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|KSEG0
op_plus
l_int|0x80
)paren
comma
op_amp
id|genexcept_early
comma
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/* read unmapped and uncached (KSEG1)&n;&t; * DECstations have at least 4MB RAM&n;&t; * Assume less than 480MB of RAM, as this is max for 5000/2xx&n;&t; * FIXME this should be replaced by the first free page!&n;&t; */
r_for
c_loop
(paren
id|memory_page
op_assign
(paren
r_int
r_char
op_star
)paren
id|KSEG1
op_plus
id|CHUNK_SIZE
suffix:semicolon
(paren
id|mem_err
op_eq
l_int|0
)paren
op_logical_and
(paren
id|memory_page
OL
(paren
(paren
r_int
r_char
op_star
)paren
id|KSEG1
op_plus
l_int|0x1E000000
)paren
)paren
suffix:semicolon
id|memory_page
op_add_assign
id|CHUNK_SIZE
)paren
(brace
id|dummy
op_assign
op_star
id|memory_page
suffix:semicolon
)brace
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|KSEG0
op_plus
l_int|0x80
)paren
comma
op_amp
id|old_handler
comma
l_int|0x80
)paren
suffix:semicolon
r_return
(paren
r_int
r_int
)paren
id|memory_page
op_minus
id|KSEG1
op_minus
id|CHUNK_SIZE
suffix:semicolon
)brace
multiline_comment|/*&n; * Use the REX prom calls to get hold of the memory bitmap, and thence&n; * determine memory size.&n; */
DECL|function|rex_get_memory_size
r_int
r_int
id|__init
id|rex_get_memory_size
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|bitmap_size
suffix:semicolon
r_int
r_int
id|mem_size
op_assign
l_int|0
suffix:semicolon
id|memmap
op_star
id|bm
suffix:semicolon
multiline_comment|/* some free 64k */
id|bm
op_assign
(paren
id|memmap
op_star
)paren
l_int|0x80028000
suffix:semicolon
id|bitmap_size
op_assign
id|rex_getbitmap
c_func
(paren
id|bm
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|bitmap_size
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* FIXME: very simplistically only add full sets of pages */
r_if
c_cond
(paren
id|bm-&gt;bitmap
(braket
id|i
)braket
op_eq
l_int|0xff
)paren
id|mem_size
op_add_assign
(paren
l_int|8
op_star
id|bm-&gt;pagesize
)paren
suffix:semicolon
)brace
r_return
(paren
id|mem_size
)paren
suffix:semicolon
)brace
DECL|function|prom_meminit
r_void
id|__init
id|prom_meminit
c_func
(paren
r_int
r_int
id|magic
)paren
(brace
r_int
r_int
id|free_start
comma
id|free_end
comma
id|start_pfn
comma
id|bootmap_size
suffix:semicolon
r_int
r_int
id|mem_size
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|magic
op_ne
id|REX_PROM_MAGIC
)paren
id|mem_size
op_assign
id|pmax_get_memory_size
c_func
(paren
)paren
suffix:semicolon
r_else
id|mem_size
op_assign
id|rex_get_memory_size
c_func
(paren
)paren
suffix:semicolon
id|free_start
op_assign
id|PHYSADDR
c_func
(paren
id|PFN_ALIGN
c_func
(paren
op_amp
id|_end
)paren
)paren
suffix:semicolon
id|free_end
op_assign
id|mem_size
suffix:semicolon
id|start_pfn
op_assign
id|PFN_UP
c_func
(paren
(paren
r_int
r_int
)paren
op_amp
id|_end
)paren
suffix:semicolon
macro_line|#ifdef PROM_DEBUG
id|prom_printf
c_func
(paren
l_string|&quot;free_start: 0x%08x&bslash;n&quot;
comma
id|free_start
)paren
suffix:semicolon
id|prom_printf
c_func
(paren
l_string|&quot;free_end: 0x%08x&bslash;n&quot;
comma
id|free_end
)paren
suffix:semicolon
id|prom_printf
c_func
(paren
l_string|&quot;start_pfn: 0x%08x&bslash;n&quot;
comma
id|start_pfn
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Register all the contiguous memory with the bootmem allocator&n;&t;   and free it.  Be careful about the bootmem freemap.  */
id|bootmap_size
op_assign
id|init_bootmem
c_func
(paren
id|start_pfn
comma
id|mem_size
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|free_bootmem
c_func
(paren
id|free_start
op_plus
id|bootmap_size
comma
id|free_end
op_minus
id|free_start
op_minus
id|bootmap_size
)paren
suffix:semicolon
)brace
DECL|function|page_is_ram
r_int
id|__init
id|page_is_ram
c_func
(paren
r_int
r_int
id|pagenr
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|prom_free_prom_memory
r_void
id|prom_free_prom_memory
(paren
r_void
)paren
(brace
r_int
r_int
id|addr
comma
id|end
suffix:semicolon
r_extern
r_char
id|_ftext
suffix:semicolon
multiline_comment|/*&n;&t; * Free everything below the kernel itself but leave&n;&t; * the first page reserved for the exception handlers.&n;&t; */
macro_line|#ifdef CONFIG_DECLANCE
multiline_comment|/*&n;&t; * Leave 128 KB reserved for Lance memory for&n;&t; * IOASIC DECstations.&n;&t; *&n;&t; * XXX: save this address for use in dec_lance.c?&n;&t; */
r_if
c_cond
(paren
id|IOASIC
)paren
id|end
op_assign
id|PHYSADDR
c_func
(paren
op_amp
id|_ftext
)paren
op_minus
l_int|0x00020000
suffix:semicolon
r_else
macro_line|#endif
id|end
op_assign
id|PHYSADDR
c_func
(paren
op_amp
id|_ftext
)paren
suffix:semicolon
id|addr
op_assign
id|PAGE_SIZE
suffix:semicolon
r_while
c_loop
(paren
id|addr
OL
id|end
)paren
(brace
id|ClearPageReserved
c_func
(paren
id|virt_to_page
c_func
(paren
id|addr
)paren
)paren
suffix:semicolon
id|set_page_count
c_func
(paren
id|virt_to_page
c_func
(paren
id|addr
)paren
comma
l_int|1
)paren
suffix:semicolon
id|free_page
c_func
(paren
id|addr
)paren
suffix:semicolon
id|addr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;Freeing unused PROM memory: %ldk freed&bslash;n&quot;
comma
(paren
id|end
op_minus
id|PAGE_SIZE
)paren
op_rshift
l_int|10
)paren
suffix:semicolon
)brace
eof
