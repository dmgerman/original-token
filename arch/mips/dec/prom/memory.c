multiline_comment|/*&n; * memory.c: memory initialisation code.&n; *&n; * Copyright (C) 1998 Harald Koerfgen, Frieder Streffer and Paul M. Antoine&n; *&n; * $Id: $&n; */
macro_line|#include &lt;asm/addrspace.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &quot;prom.h&quot;
r_typedef
r_struct
(brace
DECL|member|pagesize
r_int
id|pagesize
suffix:semicolon
DECL|member|bitmap
r_int
r_char
id|bitmap
(braket
l_int|0
)braket
suffix:semicolon
DECL|typedef|memmap
)brace
id|memmap
suffix:semicolon
r_extern
r_int
(paren
op_star
id|rex_getbitmap
)paren
(paren
id|memmap
op_star
)paren
suffix:semicolon
DECL|macro|PROM_DEBUG
macro_line|#undef PROM_DEBUG
macro_line|#ifdef PROM_DEBUG
r_extern
r_int
(paren
op_star
id|prom_printf
)paren
(paren
r_char
op_star
comma
dot
dot
dot
)paren
suffix:semicolon
macro_line|#endif
r_extern
r_int
r_int
id|mips_memory_upper
suffix:semicolon
DECL|variable|mem_err
r_volatile
r_int
r_int
id|mem_err
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* So we know an error occured */
multiline_comment|/*&n; * Probe memory in 4MB chunks, waiting for an error to tell us we&squot;ve fallen&n; * off the end of real memory.  Only suitable for the 2100/3100&squot;s (PMAX).&n; */
DECL|macro|CHUNK_SIZE
mdefine_line|#define CHUNK_SIZE 0x400000
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
r_int
id|pmax_get_memory_size
c_func
(paren
r_void
)paren
)paren
(brace
r_volatile
r_int
r_char
op_star
id|memory_page
comma
id|dummy
suffix:semicolon
r_char
id|old_handler
(braket
l_int|0x80
)braket
suffix:semicolon
r_extern
r_char
id|genexcept_early
suffix:semicolon
multiline_comment|/* Install exception handler */
id|memcpy
c_func
(paren
op_amp
id|old_handler
comma
(paren
r_void
op_star
)paren
(paren
id|KSEG0
op_plus
l_int|0x80
)paren
comma
l_int|0x80
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|KSEG0
op_plus
l_int|0x80
)paren
comma
op_amp
id|genexcept_early
comma
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/* read unmapped and uncached (KSEG1)&n;&t; * DECstations have at least 4MB RAM&n;&t; * Assume less than 480MB of RAM, as this is max for 5000/2xx&n;&t; * FIXME this should be replaced by the first free page!&n;&t; */
r_for
c_loop
(paren
id|memory_page
op_assign
(paren
r_int
r_char
op_star
)paren
id|KSEG1
op_plus
id|CHUNK_SIZE
suffix:semicolon
(paren
id|mem_err
op_eq
l_int|0
)paren
op_logical_and
(paren
id|memory_page
OL
(paren
(paren
r_int
r_char
op_star
)paren
id|KSEG1
op_plus
l_int|0x1E000000
)paren
)paren
suffix:semicolon
id|memory_page
op_add_assign
id|CHUNK_SIZE
)paren
(brace
id|dummy
op_assign
op_star
id|memory_page
suffix:semicolon
)brace
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|KSEG0
op_plus
l_int|0x80
)paren
comma
op_amp
id|old_handler
comma
l_int|0x80
)paren
suffix:semicolon
r_return
(paren
r_int
r_int
)paren
id|memory_page
op_minus
id|KSEG1
op_minus
id|CHUNK_SIZE
suffix:semicolon
)brace
multiline_comment|/*&n; * Use the REX prom calls to get hold of the memory bitmap, and thence&n; * determine memory size.&n; */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
r_int
id|rex_get_memory_size
c_func
(paren
r_void
)paren
)paren
(brace
r_int
id|i
comma
id|bitmap_size
suffix:semicolon
r_int
r_int
id|mem_size
op_assign
l_int|0
suffix:semicolon
id|memmap
op_star
id|bm
suffix:semicolon
multiline_comment|/* some free 64k */
id|bm
op_assign
(paren
id|memmap
op_star
)paren
l_int|0x80028000
suffix:semicolon
id|bitmap_size
op_assign
id|rex_getbitmap
c_func
(paren
id|bm
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|bitmap_size
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* FIXME: very simplistically only add full sets of pages */
r_if
c_cond
(paren
id|bm-&gt;bitmap
(braket
id|i
)braket
op_eq
l_int|0xff
)paren
id|mem_size
op_add_assign
(paren
l_int|8
op_star
id|bm-&gt;pagesize
)paren
suffix:semicolon
)brace
r_return
(paren
id|mem_size
)paren
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|prom_meminit
c_func
(paren
r_int
r_int
id|magic
)paren
)paren
(brace
r_if
c_cond
(paren
id|magic
op_ne
id|REX_PROM_MAGIC
)paren
id|mips_memory_upper
op_assign
id|KSEG0
op_plus
id|pmax_get_memory_size
c_func
(paren
)paren
suffix:semicolon
r_else
id|mips_memory_upper
op_assign
id|KSEG0
op_plus
id|rex_get_memory_size
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef PROM_DEBUG
id|prom_printf
c_func
(paren
l_string|&quot;mips_memory_upper: 0x%08x&bslash;n&quot;
comma
id|mips_memory_upper
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Called from mem_init() to fixup the mem_map page settings. */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|prom_fixup_mem_map
c_func
(paren
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
)paren
(brace
)brace
DECL|function|prom_free_prom_memory
r_void
id|prom_free_prom_memory
(paren
r_void
)paren
(brace
)brace
eof
