multiline_comment|/* $Id$&n; *&n; * balo.c: BAget LOader&n; *&n; * Copyright (C) 1998 Gleb Raiko &amp; Vladimir Roganov&n; *&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/ptrace.h&gt;
macro_line|#include &lt;asm/addrspace.h&gt;
macro_line|#include &lt;asm/baget/baget.h&gt;
macro_line|#include &quot;balo.h&quot;  /* Includes some kernel symbol values */
DECL|variable|banner
r_static
r_char
op_star
id|banner
op_assign
l_string|&quot;&bslash;nBaget Linux Loader v0.2&bslash;n&quot;
suffix:semicolon
DECL|function|mem_move
r_static
r_void
id|mem_move
(paren
r_int
op_star
id|to
comma
r_int
op_star
id|from
comma
r_int
id|size
)paren
(brace
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
op_star
id|to
op_increment
op_assign
op_star
id|from
op_increment
suffix:semicolon
id|size
op_sub_assign
r_sizeof
(paren
r_int
)paren
suffix:semicolon
)brace
)brace
DECL|variable|mem_limit
r_static
r_volatile
r_int
op_star
id|mem_limit
op_assign
(paren
r_volatile
r_int
op_star
)paren
id|KSEG1
suffix:semicolon
DECL|variable|mem_limit_dbe
r_static
r_volatile
r_int
op_star
id|mem_limit_dbe
op_assign
(paren
r_volatile
r_int
op_star
)paren
id|KSEG1
suffix:semicolon
DECL|function|can_write
r_static
r_int
id|can_write
(paren
r_volatile
r_int
op_star
id|p
)paren
(brace
r_return
id|p
OL
(paren
r_int
op_star
)paren
(paren
id|KSEG1
op_plus
id|BALO_OFFSET
)paren
op_logical_or
id|p
op_ge
(paren
r_int
op_star
)paren
(paren
id|KSEG1
op_plus
id|BALO_OFFSET
op_plus
id|BALO_SIZE
)paren
suffix:semicolon
)brace
DECL|enum|balo_state_enum
r_static
r_volatile
r_enum
id|balo_state_enum
(brace
DECL|enumerator|BALO_INIT
id|BALO_INIT
comma
DECL|enumerator|MEM_INIT
id|MEM_INIT
comma
DECL|enumerator|MEM_PROBE
id|MEM_PROBE
comma
DECL|enumerator|START_KERNEL
id|START_KERNEL
DECL|variable|balo_state
)brace
id|balo_state
op_assign
id|BALO_INIT
suffix:semicolon
DECL|function|reset_and_jump
r_static
id|__inline__
r_void
id|reset_and_jump
c_func
(paren
r_int
id|start
comma
r_int
id|mem_upper
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;.set&bslash;tnoreorder&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;tnoat&bslash;n&bslash;t&quot;
l_string|&quot;mfc0&bslash;t$1,$12&bslash;n&bslash;t&quot;
l_string|&quot;nop&bslash;n&bslash;t&quot;
l_string|&quot;nop&bslash;n&bslash;t&quot;
l_string|&quot;nop&bslash;n&bslash;t&quot;
l_string|&quot;ori&bslash;t$1,$1,0xff00&bslash;n&bslash;t&quot;
l_string|&quot;xori&bslash;t$1,$1,0xff00&bslash;n&bslash;t&quot;
l_string|&quot;mtc0&bslash;t$1,$12&bslash;n&bslash;t&quot;
l_string|&quot;nop&bslash;n&bslash;t&quot;
l_string|&quot;nop&bslash;n&bslash;t&quot;
l_string|&quot;nop&bslash;n&bslash;t&quot;
l_string|&quot;move&bslash;t$4,%1&bslash;n&bslash;t&quot;
l_string|&quot;jr&bslash;t%0&bslash;n&bslash;t&quot;
l_string|&quot;nop&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;tat&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;treorder&quot;
suffix:colon
multiline_comment|/* no outputs */
suffix:colon
l_string|&quot;Ir&quot;
(paren
id|start
)paren
comma
l_string|&quot;Ir&quot;
(paren
id|mem_upper
)paren
suffix:colon
l_string|&quot;$1&quot;
comma
l_string|&quot;$4&quot;
comma
l_string|&quot;memory&quot;
)paren
suffix:semicolon
)brace
DECL|function|start_kernel
r_static
r_void
id|start_kernel
c_func
(paren
r_void
)paren
(brace
r_extern
r_char
id|_vmlinux_start
comma
id|_vmlinux_end
suffix:semicolon
r_extern
r_char
id|_ramdisk_start
comma
id|_ramdisk_end
suffix:semicolon
id|outs
c_func
(paren
l_string|&quot;Relocating Linux... &quot;
)paren
suffix:semicolon
id|mem_move
c_func
(paren
(paren
r_int
op_star
)paren
id|KSEG0
comma
(paren
r_int
op_star
)paren
op_amp
id|_vmlinux_start
comma
op_amp
id|_vmlinux_end
op_minus
op_amp
id|_vmlinux_start
)paren
suffix:semicolon
id|outs
c_func
(paren
l_string|&quot;done.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_amp
id|_ramdisk_start
op_ne
op_amp
id|_ramdisk_end
)paren
(brace
id|outs
c_func
(paren
l_string|&quot;Setting up RAMDISK... &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|RAMDISK_BASE
op_ne
l_int|0xBA
)paren
(brace
id|outs
c_func
(paren
l_string|&quot;Bad RAMDISK_BASE signature in system image.&bslash;n&quot;
)paren
suffix:semicolon
id|balo_hungup
c_func
(paren
)paren
suffix:semicolon
)brace
op_star
(paren
r_int
r_int
op_star
)paren
id|RAMDISK_BASE
op_assign
(paren
r_int
r_int
)paren
op_amp
id|_ramdisk_start
suffix:semicolon
op_star
(paren
r_int
r_int
op_star
)paren
id|RAMDISK_SIZE
op_assign
op_amp
id|_ramdisk_end
op_minus
op_amp
id|_ramdisk_start
suffix:semicolon
id|outs
c_func
(paren
l_string|&quot;done.&bslash;n&quot;
)paren
suffix:semicolon
)brace
(brace
r_extern
r_void
id|flush_cache_low
c_func
(paren
r_int
id|isize
comma
r_int
id|dsize
)paren
suffix:semicolon
id|flush_cache_low
c_func
(paren
l_int|256
op_star
l_int|1024
comma
l_int|256
op_star
l_int|1024
)paren
suffix:semicolon
)brace
id|balo_printf
c_func
(paren
l_string|&quot;Kernel entry: %x&bslash;n&bslash;n&quot;
comma
id|START
)paren
suffix:semicolon
id|balo_state
op_assign
id|START_KERNEL
suffix:semicolon
id|reset_and_jump
c_func
(paren
id|START
comma
(paren
r_int
)paren
id|mem_limit
op_minus
id|KSEG1
op_plus
id|KSEG0
)paren
suffix:semicolon
)brace
DECL|function|mem_probe
r_static
r_void
id|mem_probe
c_func
(paren
r_void
)paren
(brace
id|balo_state
op_assign
id|MEM_PROBE
suffix:semicolon
id|outs
c_func
(paren
l_string|&quot;RAM: &lt;&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|mem_limit
OL
id|mem_limit_dbe
)paren
(brace
r_if
c_cond
(paren
id|can_write
c_func
(paren
id|mem_limit
)paren
op_logical_and
op_star
id|mem_limit
op_ne
l_int|0
)paren
r_break
suffix:semicolon
multiline_comment|/* cycle found */
id|outc
c_func
(paren
l_char|&squot;.&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|can_write
c_func
(paren
id|mem_limit
)paren
)paren
op_star
id|mem_limit
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* mark */
id|mem_limit
op_add_assign
l_int|0x40000
suffix:semicolon
)brace
id|outs
c_func
(paren
l_string|&quot;&gt;&bslash;n&quot;
)paren
suffix:semicolon
id|start_kernel
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|variable|int_cause
r_volatile
r_int
r_int
id|int_cause
suffix:semicolon
DECL|variable|epc
r_volatile
r_int
r_int
id|epc
suffix:semicolon
DECL|variable|badvaddr
r_volatile
r_int
r_int
id|badvaddr
suffix:semicolon
DECL|function|print_regs
r_static
r_void
id|print_regs
c_func
(paren
r_void
)paren
(brace
id|balo_printf
c_func
(paren
l_string|&quot;CAUSE=%x EPC=%x BADVADDR=%x&bslash;n&quot;
comma
id|int_cause
comma
id|epc
comma
id|badvaddr
)paren
suffix:semicolon
)brace
DECL|function|int_handler
r_void
id|int_handler
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_switch
c_cond
(paren
id|balo_state
)paren
(brace
r_case
id|BALO_INIT
suffix:colon
id|balo_printf
c_func
(paren
l_string|&quot;&bslash;nBALO: trap in balo itself.&bslash;n&quot;
)paren
suffix:semicolon
id|print_regs
c_func
(paren
)paren
suffix:semicolon
id|balo_hungup
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MEM_INIT
suffix:colon
r_if
c_cond
(paren
(paren
id|int_cause
op_amp
id|CAUSE_MASK
)paren
op_ne
id|CAUSE_DBE
)paren
(brace
id|balo_printf
c_func
(paren
l_string|&quot;&bslash;nBALO: unexpected trap during memory init.&bslash;n&quot;
)paren
suffix:semicolon
id|print_regs
c_func
(paren
)paren
suffix:semicolon
id|balo_hungup
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|mem_probe
c_func
(paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|MEM_PROBE
suffix:colon
id|balo_printf
c_func
(paren
l_string|&quot;&bslash;nBALO: unexpected trap during memory probe.&bslash;n&quot;
)paren
suffix:semicolon
id|print_regs
c_func
(paren
)paren
suffix:semicolon
id|balo_hungup
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|START_KERNEL
suffix:colon
id|balo_printf
c_func
(paren
l_string|&quot;&bslash;nBALO: unexpected kernel trap.&bslash;n&quot;
)paren
suffix:semicolon
id|print_regs
c_func
(paren
)paren
suffix:semicolon
id|balo_hungup
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|balo_printf
c_func
(paren
l_string|&quot;&bslash;nBALO: unexpected return from handler.&bslash;n&quot;
)paren
suffix:semicolon
id|print_regs
c_func
(paren
)paren
suffix:semicolon
id|balo_hungup
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|mem_init
r_static
r_void
id|mem_init
c_func
(paren
r_void
)paren
(brace
id|balo_state
op_assign
id|MEM_INIT
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
op_star
id|mem_limit_dbe
suffix:semicolon
r_if
c_cond
(paren
id|can_write
c_func
(paren
id|mem_limit_dbe
)paren
)paren
op_star
id|mem_limit_dbe
op_assign
l_int|0
suffix:semicolon
id|mem_limit_dbe
op_add_assign
l_int|0x40000
suffix:semicolon
multiline_comment|/* +1M */
)brace
multiline_comment|/*  no return: must go to int_handler */
)brace
DECL|function|balo_entry
r_void
id|balo_entry
c_func
(paren
r_void
)paren
(brace
r_extern
r_void
id|except_vec3_generic
c_func
(paren
r_void
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outs
c_func
(paren
id|banner
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|KSEG0
op_plus
l_int|0x80
)paren
comma
op_amp
id|except_vec3_generic
comma
l_int|0x80
)paren
suffix:semicolon
id|mem_init
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Needed for linking */
DECL|function|vsprintf
r_int
id|vsprintf
c_func
(paren
r_char
op_star
id|buf
comma
r_const
r_char
op_star
id|fmt
comma
id|va_list
id|arg
)paren
(brace
id|outs
c_func
(paren
l_string|&quot;BALO: vsprintf called.&bslash;n&quot;
)paren
suffix:semicolon
id|balo_hungup
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
