multiline_comment|/* $Id: baget.c,v 1.1 1999/01/17 03:49:37 ralf Exp $&n; *&n; * baget.c: Baget low level stuff&n; *&n; * Copyright (C) 1998 Gleb Raiko &amp; Vladimir Roganov&n; *&n; */
macro_line|#include &lt;stdarg.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bootinfo.h&gt;
macro_line|#include &lt;asm/mipsregs.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/pgalloc.h&gt;
macro_line|#include &lt;asm/baget/baget.h&gt;
multiline_comment|/*&n; *  Following code is based on routines from &squot;mm/vmalloc.c&squot;&n; *  Additional parameters  ioaddr  is needed to iterate across real I/O address.&n; */
DECL|function|alloc_area_pte
r_static
r_inline
r_int
id|alloc_area_pte
c_func
(paren
id|pte_t
op_star
id|pte
comma
r_int
r_int
id|address
comma
r_int
r_int
id|size
comma
r_int
r_int
id|ioaddr
)paren
(brace
r_int
r_int
id|end
suffix:semicolon
id|address
op_and_assign
op_complement
id|PMD_MASK
suffix:semicolon
id|end
op_assign
id|address
op_plus
id|size
suffix:semicolon
r_if
c_cond
(paren
id|end
OG
id|PMD_SIZE
)paren
id|end
op_assign
id|PMD_SIZE
suffix:semicolon
r_while
c_loop
(paren
id|address
OL
id|end
)paren
(brace
r_int
r_int
id|page
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pte_none
c_func
(paren
op_star
id|pte
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;kseg2_alloc_io: page already exists&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *  For MIPS looks pretty to have transparent mapping&n;&t;&t; *  for KSEG2 areas  -- user can&squot;t access one, and no &n;&t;&t; *  problems with  virtual &lt;--&gt; physical  translation.&n;&t;&t; */
id|page
op_assign
id|ioaddr
op_amp
id|PAGE_MASK
suffix:semicolon
id|set_pte
c_func
(paren
id|pte
comma
id|__pte
c_func
(paren
id|page
op_or
id|pgprot_val
c_func
(paren
id|PAGE_USERIO
)paren
op_or
id|_PAGE_GLOBAL
op_or
id|__READABLE
op_or
id|__WRITEABLE
)paren
)paren
suffix:semicolon
id|address
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|ioaddr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|pte
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|alloc_area_pmd
r_static
r_inline
r_int
id|alloc_area_pmd
c_func
(paren
id|pmd_t
op_star
id|pmd
comma
r_int
r_int
id|address
comma
r_int
r_int
id|size
comma
r_int
r_int
id|ioaddr
)paren
(brace
r_int
r_int
id|end
suffix:semicolon
id|address
op_and_assign
op_complement
id|PGDIR_MASK
suffix:semicolon
id|end
op_assign
id|address
op_plus
id|size
suffix:semicolon
r_if
c_cond
(paren
id|end
OG
id|PGDIR_SIZE
)paren
id|end
op_assign
id|PGDIR_SIZE
suffix:semicolon
r_while
c_loop
(paren
id|address
OL
id|end
)paren
(brace
id|pte_t
op_star
id|pte
op_assign
id|pte_alloc_kernel
c_func
(paren
id|pmd
comma
id|address
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pte
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|alloc_area_pte
c_func
(paren
id|pte
comma
id|address
comma
id|end
op_minus
id|address
comma
id|ioaddr
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|address
op_assign
(paren
id|address
op_plus
id|PMD_SIZE
)paren
op_amp
id|PMD_MASK
suffix:semicolon
id|ioaddr
op_add_assign
id|PMD_SIZE
suffix:semicolon
id|pmd
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|kseg2_alloc_io
r_int
id|kseg2_alloc_io
(paren
r_int
r_int
id|address
comma
r_int
r_int
id|size
)paren
(brace
id|pgd_t
op_star
id|dir
suffix:semicolon
r_int
r_int
id|end
op_assign
id|address
op_plus
id|size
suffix:semicolon
id|dir
op_assign
id|pgd_offset_k
c_func
(paren
id|address
)paren
suffix:semicolon
id|flush_cache_all
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|address
OL
id|end
)paren
(brace
id|pmd_t
op_star
id|pmd
suffix:semicolon
id|pgd_t
id|olddir
op_assign
op_star
id|dir
suffix:semicolon
id|pmd
op_assign
id|pmd_alloc_kernel
c_func
(paren
id|dir
comma
id|address
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pmd
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|alloc_area_pmd
c_func
(paren
id|pmd
comma
id|address
comma
id|end
op_minus
id|address
comma
id|address
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|pgd_val
c_func
(paren
id|olddir
)paren
op_ne
id|pgd_val
c_func
(paren
op_star
id|dir
)paren
)paren
id|set_pgdir
c_func
(paren
id|address
comma
op_star
id|dir
)paren
suffix:semicolon
id|address
op_assign
(paren
id|address
op_plus
id|PGDIR_SIZE
)paren
op_amp
id|PGDIR_MASK
suffix:semicolon
id|dir
op_increment
suffix:semicolon
)brace
id|flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
