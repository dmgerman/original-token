multiline_comment|/*&n; * r2300.c: R2000 and R3000 specific mmu/cache code.&n; *&n; * Copyright (C) 1996 David S. Miller (dm@engr.sgi.com)&n; *&n; * $Id: r2300.c,v 1.3 1997/08/08 18:13:06 miguel Exp $&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/sgialib.h&gt;
r_extern
r_int
r_int
id|mips_tlb_entries
suffix:semicolon
multiline_comment|/* page functions */
DECL|function|r2300_clear_page
r_void
id|r2300_clear_page
c_func
(paren
r_int
r_int
id|page
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;.set&bslash;tnoreorder&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;tnoat&bslash;n&bslash;t&quot;
l_string|&quot;addiu&bslash;t$1,%0,%2&bslash;n&quot;
l_string|&quot;1:&bslash;tsw&bslash;t$0,(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t$0,4(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t$0,8(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t$0,12(%0)&bslash;n&bslash;t&quot;
l_string|&quot;addiu&bslash;t%0,32&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t$0,-16(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t$0,-12(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t$0,-8(%0)&bslash;n&bslash;t&quot;
l_string|&quot;bne&bslash;t$1,%0,1b&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t$0,-4(%0)&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;tat&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;treorder&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|page
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|page
)paren
comma
l_string|&quot;I&quot;
(paren
id|PAGE_SIZE
)paren
suffix:colon
l_string|&quot;$1&quot;
comma
l_string|&quot;memory&quot;
)paren
suffix:semicolon
)brace
DECL|function|r2300_copy_page
r_static
r_void
id|r2300_copy_page
c_func
(paren
r_int
r_int
id|to
comma
r_int
r_int
id|from
)paren
(brace
r_int
r_int
id|dummy1
comma
id|dummy2
suffix:semicolon
r_int
r_int
id|reg1
comma
id|reg2
comma
id|reg3
comma
id|reg4
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;.set&bslash;tnoreorder&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;tnoat&bslash;n&bslash;t&quot;
l_string|&quot;addiu&bslash;t$1,%0,%8&bslash;n&quot;
l_string|&quot;1:&bslash;tlw&bslash;t%2,(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%3,4(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%4,8(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%5,12(%1)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%2,(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%3,4(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%4,8(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%5,12(%0)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%2,16(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%3,20(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%4,24(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%5,28(%1)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%2,16(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%3,20(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%4,24(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%5,28(%0)&bslash;n&bslash;t&quot;
l_string|&quot;addiu&bslash;t%0,64&bslash;n&bslash;t&quot;
l_string|&quot;addiu&bslash;t%1,64&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%2,-32(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%3,-28(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%4,-24(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%5,-20(%1)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%2,-32(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%3,-28(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%4,-24(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%5,-20(%0)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%2,-16(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%3,-12(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%4,-8(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%5,-4(%1)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%2,-16(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%3,-12(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%4,-8(%0)&bslash;n&bslash;t&quot;
l_string|&quot;bne&bslash;t$1,%0,1b&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%5,-4(%0)&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;tat&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;treorder&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|dummy1
)paren
comma
l_string|&quot;=r&quot;
(paren
id|dummy2
)paren
comma
l_string|&quot;=&amp;r&quot;
(paren
id|reg1
)paren
comma
l_string|&quot;=&amp;r&quot;
(paren
id|reg2
)paren
comma
l_string|&quot;=&amp;r&quot;
(paren
id|reg3
)paren
comma
l_string|&quot;=&amp;r&quot;
(paren
id|reg4
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|to
)paren
comma
l_string|&quot;1&quot;
(paren
id|from
)paren
comma
l_string|&quot;I&quot;
(paren
id|PAGE_SIZE
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Cache operations. */
DECL|function|r2300_flush_cache_all
r_static
r_inline
r_void
id|r2300_flush_cache_all
c_func
(paren
r_void
)paren
(brace
)brace
DECL|function|r2300_flush_cache_mm
r_static
r_void
id|r2300_flush_cache_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
)brace
DECL|function|r2300_flush_cache_range
r_static
r_void
id|r2300_flush_cache_range
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
)brace
DECL|function|r2300_flush_cache_page
r_static
r_void
id|r2300_flush_cache_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
(brace
)brace
DECL|function|r2300_flush_page_to_ram
r_static
r_void
id|r2300_flush_page_to_ram
c_func
(paren
r_int
r_int
id|page
)paren
(brace
multiline_comment|/* XXX What we want to do here is perform a displacement&n;&t; * XXX flush because there are circumstances where you do&n;&t; * XXX indeed want to remove stale data from the cache.&n;&t; * XXX (DMA operations for example, where the cache cannot&n;&t; * XXX  &quot;see&quot; this data get changed.)&n;&t; */
)brace
DECL|function|r2300_flush_cache_sigtramp
r_static
r_void
id|r2300_flush_cache_sigtramp
c_func
(paren
r_int
r_int
id|page
)paren
(brace
)brace
multiline_comment|/* TLB operations. */
DECL|function|r2300_flush_tlb_all
r_static
r_inline
r_void
id|r2300_flush_tlb_all
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|entry
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|write_32bit_cp0_register
c_func
(paren
id|CP0_ENTRYLO0
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|entry
op_assign
l_int|0
suffix:semicolon
id|entry
OL
id|mips_tlb_entries
suffix:semicolon
id|entry
op_increment
)paren
(brace
id|write_32bit_cp0_register
c_func
(paren
id|CP0_INDEX
comma
id|entry
)paren
suffix:semicolon
id|write_32bit_cp0_register
c_func
(paren
id|CP0_ENTRYHI
comma
(paren
(paren
id|entry
op_or
l_int|0x8
)paren
op_lshift
l_int|12
)paren
)paren
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;tlbwi&quot;
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|r2300_flush_tlb_mm
r_static
r_void
id|r2300_flush_tlb_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
r_if
c_cond
(paren
id|mm
op_eq
id|current-&gt;mm
)paren
(brace
id|r2300_flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|r2300_flush_tlb_range
r_static
r_void
id|r2300_flush_tlb_range
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
r_if
c_cond
(paren
id|mm
op_eq
id|current-&gt;mm
)paren
(brace
id|r2300_flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|r2300_flush_tlb_page
r_static
r_void
id|r2300_flush_tlb_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
(brace
r_if
c_cond
(paren
id|vma-&gt;vm_mm
op_eq
id|current-&gt;mm
)paren
(brace
id|r2300_flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Load a new root pointer into the TLB. */
DECL|function|r2300_load_pgd
r_static
r_void
id|r2300_load_pgd
c_func
(paren
r_int
r_int
id|pg_dir
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|write_32bit_cp0_register
c_func
(paren
id|CP0_ENTRYHI
comma
id|TLB_ROOT
)paren
suffix:semicolon
id|write_32bit_cp0_register
c_func
(paren
id|CP0_INDEX
comma
l_int|0
)paren
suffix:semicolon
id|write_32bit_cp0_register
c_func
(paren
id|CP0_ENTRYLO0
comma
(paren
(paren
id|pg_dir
op_rshift
l_int|6
)paren
op_or
l_int|0x00e0
)paren
)paren
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;tlbwi&quot;
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Initialize new page directory with pointers to invalid ptes&n; */
DECL|function|r2300_pgd_init
r_static
r_void
id|r2300_pgd_init
c_func
(paren
r_int
r_int
id|page
)paren
(brace
r_int
r_int
id|dummy1
comma
id|dummy2
suffix:semicolon
multiline_comment|/*&n;&t; * The plain and boring version for the R3000.  No cache flushing&n;&t; * stuff is implemented since the R3000 has physical caches.&n;&t; */
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;.set&bslash;tnoreorder&bslash;n&quot;
l_string|&quot;1:&bslash;tsw&bslash;t%2,(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%2,4(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%2,8(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%2,12(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%2,16(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%2,20(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%2,24(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%2,28(%0)&bslash;n&bslash;t&quot;
l_string|&quot;subu&bslash;t%1,1&bslash;n&bslash;t&quot;
l_string|&quot;bnez&bslash;t%1,1b&bslash;n&bslash;t&quot;
l_string|&quot;addiu&bslash;t%0,32&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;treorder&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|dummy1
)paren
comma
l_string|&quot;=r&quot;
(paren
id|dummy2
)paren
suffix:colon
l_string|&quot;r&quot;
(paren
(paren
r_int
r_int
)paren
id|invalid_pte_table
)paren
comma
l_string|&quot;0&quot;
(paren
id|page
)paren
comma
l_string|&quot;1&quot;
(paren
id|PAGE_SIZE
op_div
(paren
r_sizeof
(paren
id|pmd_t
)paren
op_star
l_int|8
)paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|r2300_update_mmu_cache
r_static
r_void
id|r2300_update_mmu_cache
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|address
comma
id|pte_t
id|pte
)paren
(brace
id|r2300_flush_tlb_page
c_func
(paren
id|vma
comma
id|address
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * FIXME: We should also reload a new entry into the TLB to&n;&t; * avoid unnecessary exceptions.&n;&t; */
)brace
DECL|function|r2300_show_regs
r_static
r_void
id|r2300_show_regs
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
multiline_comment|/*&n;&t; * Saved main processor registers&n;&t; */
id|printk
c_func
(paren
l_string|&quot;$0 : %08x %08lx %08lx %08lx %08lx %08lx %08lx %08lx&bslash;n&quot;
comma
l_int|0
comma
(paren
r_int
r_int
)paren
id|regs-&gt;regs
(braket
l_int|1
)braket
comma
(paren
r_int
r_int
)paren
id|regs-&gt;regs
(braket
l_int|2
)braket
comma
(paren
r_int
r_int
)paren
id|regs-&gt;regs
(braket
l_int|3
)braket
comma
(paren
r_int
r_int
)paren
id|regs-&gt;regs
(braket
l_int|4
)braket
comma
(paren
r_int
r_int
)paren
id|regs-&gt;regs
(braket
l_int|5
)braket
comma
(paren
r_int
r_int
)paren
id|regs-&gt;regs
(braket
l_int|6
)braket
comma
(paren
r_int
r_int
)paren
id|regs-&gt;regs
(braket
l_int|7
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;$8 : %08lx %08lx %08lx %08lx %08lx %08lx %08lx %08lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|regs-&gt;regs
(braket
l_int|8
)braket
comma
(paren
r_int
r_int
)paren
id|regs-&gt;regs
(braket
l_int|9
)braket
comma
(paren
r_int
r_int
)paren
id|regs-&gt;regs
(braket
l_int|10
)braket
comma
(paren
r_int
r_int
)paren
id|regs-&gt;regs
(braket
l_int|11
)braket
comma
(paren
r_int
r_int
)paren
id|regs-&gt;regs
(braket
l_int|12
)braket
comma
(paren
r_int
r_int
)paren
id|regs-&gt;regs
(braket
l_int|13
)braket
comma
(paren
r_int
r_int
)paren
id|regs-&gt;regs
(braket
l_int|14
)braket
comma
(paren
r_int
r_int
)paren
id|regs-&gt;regs
(braket
l_int|15
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;$16: %08lx %08lx %08lx %08lx %08lx %08lx %08lx %08lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|regs-&gt;regs
(braket
l_int|16
)braket
comma
(paren
r_int
r_int
)paren
id|regs-&gt;regs
(braket
l_int|17
)braket
comma
(paren
r_int
r_int
)paren
id|regs-&gt;regs
(braket
l_int|18
)braket
comma
(paren
r_int
r_int
)paren
id|regs-&gt;regs
(braket
l_int|19
)braket
comma
(paren
r_int
r_int
)paren
id|regs-&gt;regs
(braket
l_int|20
)braket
comma
(paren
r_int
r_int
)paren
id|regs-&gt;regs
(braket
l_int|21
)braket
comma
(paren
r_int
r_int
)paren
id|regs-&gt;regs
(braket
l_int|22
)braket
comma
(paren
r_int
r_int
)paren
id|regs-&gt;regs
(braket
l_int|23
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;$24: %08lx %08lx                   %08lx %08lx %08lx %08lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|regs-&gt;regs
(braket
l_int|24
)braket
comma
(paren
r_int
r_int
)paren
id|regs-&gt;regs
(braket
l_int|25
)braket
comma
(paren
r_int
r_int
)paren
id|regs-&gt;regs
(braket
l_int|28
)braket
comma
(paren
r_int
r_int
)paren
id|regs-&gt;regs
(braket
l_int|29
)braket
comma
(paren
r_int
r_int
)paren
id|regs-&gt;regs
(braket
l_int|30
)braket
comma
(paren
r_int
r_int
)paren
id|regs-&gt;regs
(braket
l_int|31
)braket
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Saved cp0 registers&n;&t; */
id|printk
c_func
(paren
l_string|&quot;epc  : %08lx&bslash;nStatus: %08x&bslash;nCause : %08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|regs-&gt;cp0_epc
comma
(paren
r_int
r_int
)paren
id|regs-&gt;cp0_status
comma
(paren
r_int
r_int
)paren
id|regs-&gt;cp0_cause
)paren
suffix:semicolon
)brace
DECL|function|r2300_add_wired_entry
r_static
r_void
id|r2300_add_wired_entry
c_func
(paren
r_int
r_int
id|entrylo0
comma
r_int
r_int
id|entrylo1
comma
r_int
r_int
id|entryhi
comma
r_int
r_int
id|pagemask
)paren
(brace
multiline_comment|/*&n;&t; * FIXME, to be done&n;&t; */
)brace
DECL|function|ld_mmu_r2300
r_void
id|ld_mmu_r2300
c_func
(paren
r_void
)paren
(brace
id|clear_page
op_assign
id|r2300_clear_page
suffix:semicolon
id|copy_page
op_assign
id|r2300_copy_page
suffix:semicolon
id|flush_cache_all
op_assign
id|r2300_flush_cache_all
suffix:semicolon
id|flush_cache_mm
op_assign
id|r2300_flush_cache_mm
suffix:semicolon
id|flush_cache_range
op_assign
id|r2300_flush_cache_range
suffix:semicolon
id|flush_cache_page
op_assign
id|r2300_flush_cache_page
suffix:semicolon
id|flush_cache_sigtramp
op_assign
id|r2300_flush_cache_sigtramp
suffix:semicolon
id|flush_page_to_ram
op_assign
id|r2300_flush_page_to_ram
suffix:semicolon
id|flush_tlb_all
op_assign
id|r2300_flush_tlb_all
suffix:semicolon
id|flush_tlb_mm
op_assign
id|r2300_flush_tlb_mm
suffix:semicolon
id|flush_tlb_range
op_assign
id|r2300_flush_tlb_range
suffix:semicolon
id|flush_tlb_page
op_assign
id|r2300_flush_tlb_page
suffix:semicolon
id|load_pgd
op_assign
id|r2300_load_pgd
suffix:semicolon
id|pgd_init
op_assign
id|r2300_pgd_init
suffix:semicolon
id|update_mmu_cache
op_assign
id|r2300_update_mmu_cache
suffix:semicolon
id|show_regs
op_assign
id|r2300_show_regs
suffix:semicolon
id|add_wired_entry
op_assign
id|r2300_add_wired_entry
suffix:semicolon
id|flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
)brace
eof
