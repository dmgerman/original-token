multiline_comment|/*&n; * MIPS specific syscall handling functions and syscalls&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; * Copyright (C) 1995 by Ralf Baechle&n; */
macro_line|#include &lt;linux/linkage.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/mman.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &lt;asm/ptrace.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/signal.h&gt;
r_extern
id|asmlinkage
r_void
id|syscall_trace
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|typedef|syscall_t
r_typedef
id|asmlinkage
r_int
(paren
op_star
id|syscall_t
)paren
(paren
r_void
op_star
id|a0
comma
dot
dot
dot
)paren
suffix:semicolon
r_extern
id|asmlinkage
r_int
id|do_syscalls
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
id|syscall_t
id|fun
comma
r_int
id|narg
)paren
suffix:semicolon
r_extern
id|syscall_t
id|sys_call_table
(braket
)braket
suffix:semicolon
r_extern
r_int
r_char
id|sys_narg_table
(braket
)braket
suffix:semicolon
DECL|function|sys_pipe
id|asmlinkage
r_int
id|sys_pipe
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|fd
(braket
l_int|2
)braket
suffix:semicolon
r_int
id|error
suffix:semicolon
id|error
op_assign
id|do_pipe
c_func
(paren
id|fd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|regs-&gt;reg2
op_assign
id|fd
(braket
l_int|0
)braket
suffix:semicolon
id|regs-&gt;reg3
op_assign
id|fd
(braket
l_int|1
)braket
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sys_mmap
id|asmlinkage
r_int
r_int
id|sys_mmap
c_func
(paren
r_int
r_int
id|addr
comma
r_int
id|len
comma
r_int
id|prot
comma
r_int
id|flags
comma
r_int
id|fd
comma
id|off_t
id|offset
)paren
(brace
r_struct
id|file
op_star
id|file
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|MAP_RENAME
)paren
(brace
r_if
c_cond
(paren
id|fd
op_ge
id|NR_OPEN
op_logical_or
op_logical_neg
(paren
id|file
op_assign
id|current-&gt;files-&gt;fd
(braket
id|fd
)braket
)paren
)paren
r_return
op_minus
id|EBADF
suffix:semicolon
)brace
id|flags
op_and_assign
op_complement
(paren
id|MAP_EXECUTABLE
op_or
id|MAP_DENYWRITE
)paren
suffix:semicolon
r_return
id|do_mmap
c_func
(paren
id|file
comma
id|addr
comma
id|len
comma
id|prot
comma
id|flags
comma
id|offset
)paren
suffix:semicolon
)brace
DECL|function|sys_idle
id|asmlinkage
r_int
id|sys_idle
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|current-&gt;pid
op_ne
l_int|0
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
multiline_comment|/* endless idle loop with no priority at all */
id|current-&gt;counter
op_assign
op_minus
l_int|100
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
multiline_comment|/*&n;&t;&t; * R4[26]00 have wait, R4[04]00 don&squot;t.&n;&t;&t; */
r_if
c_cond
(paren
id|wait_available
op_logical_and
op_logical_neg
id|need_resched
)paren
id|__asm__
c_func
(paren
l_string|&quot;.set&bslash;tmips3&bslash;n&bslash;t&quot;
l_string|&quot;wait&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;tmips0&bslash;n&bslash;t&quot;
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|sys_fork
id|asmlinkage
r_int
id|sys_fork
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_return
id|do_fork
c_func
(paren
id|SIGCHLD
comma
id|regs-&gt;reg29
comma
id|regs
)paren
suffix:semicolon
)brace
DECL|function|sys_clone
id|asmlinkage
r_int
id|sys_clone
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|clone_flags
suffix:semicolon
r_int
r_int
id|newsp
suffix:semicolon
id|clone_flags
op_assign
id|regs-&gt;reg4
suffix:semicolon
id|newsp
op_assign
id|regs-&gt;reg5
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|newsp
)paren
id|newsp
op_assign
id|regs-&gt;reg29
suffix:semicolon
r_return
id|do_fork
c_func
(paren
id|clone_flags
comma
id|newsp
comma
id|regs
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * sys_execve() executes a new program.&n; */
DECL|function|sys_execve
id|asmlinkage
r_int
id|sys_execve
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|error
suffix:semicolon
r_char
op_star
id|filename
suffix:semicolon
id|error
op_assign
id|getname
c_func
(paren
(paren
r_char
op_star
)paren
id|regs-&gt;reg4
comma
op_amp
id|filename
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|error
op_assign
id|do_execve
c_func
(paren
id|filename
comma
(paren
r_char
op_star
op_star
)paren
id|regs-&gt;reg5
comma
(paren
r_char
op_star
op_star
)paren
id|regs-&gt;reg6
comma
id|regs
)paren
suffix:semicolon
id|putname
c_func
(paren
id|filename
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/*&n; * Do the indirect syscall syscall.&n; */
DECL|function|sys_syscall
id|asmlinkage
r_int
id|sys_syscall
c_func
(paren
r_int
r_int
id|a0
comma
r_int
r_int
id|a1
comma
r_int
r_int
id|a2
comma
r_int
r_int
id|a3
comma
r_int
r_int
id|a4
comma
r_int
r_int
id|a5
comma
r_int
r_int
id|a6
)paren
(brace
id|syscall_t
id|syscall
suffix:semicolon
r_if
c_cond
(paren
id|a0
OG
id|__NR_Linux
op_plus
id|__NR_Linux_syscalls
)paren
r_return
op_minus
id|ENOSYS
suffix:semicolon
id|syscall
op_assign
id|sys_call_table
(braket
id|a0
)braket
suffix:semicolon
multiline_comment|/*&n;&t; * Prevent stack overflow by recursive&n;&t; * syscall(__NR_syscall, __NR_syscall,...);&n;&t; */
r_if
c_cond
(paren
id|syscall
op_eq
(paren
id|syscall_t
)paren
id|sys_syscall
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|syscall
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOSYS
suffix:semicolon
r_return
id|syscall
c_func
(paren
(paren
r_void
op_star
)paren
id|a0
comma
id|a1
comma
id|a2
comma
id|a3
comma
id|a4
comma
id|a5
comma
id|a6
)paren
suffix:semicolon
)brace
DECL|function|do_sys
r_void
id|do_sys
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|syscallnr
comma
id|usp
suffix:semicolon
id|syscall_t
id|syscall
suffix:semicolon
r_int
id|errno
comma
id|narg
suffix:semicolon
multiline_comment|/*&n;&t; * Compute the return address;&n;&t; */
r_if
c_cond
(paren
id|regs-&gt;cp0_cause
op_amp
id|CAUSEF_BD
)paren
(brace
multiline_comment|/*&n;&t;&t; * This syscall is in a branch delay slot.  Since we don&squot;t do&n;&t;&t; * branch delay slot handling we would get a process trying&n;&t;&t; * to do syscalls ever and ever again.  So better zap it.&n;&t;&t; */
id|printk
c_func
(paren
l_string|&quot;%s: syscall in branch delay slot.&bslash;n&quot;
comma
id|current-&gt;comm
)paren
suffix:semicolon
id|current-&gt;sig-&gt;action
(braket
id|SIGILL
op_minus
l_int|1
)braket
dot
id|sa_handler
op_assign
l_int|NULL
suffix:semicolon
id|current-&gt;blocked
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|SIGILL
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|send_sig
c_func
(paren
id|SIGILL
comma
id|current
comma
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|regs-&gt;cp0_epc
op_add_assign
l_int|4
suffix:semicolon
id|syscallnr
op_assign
id|regs-&gt;reg2
suffix:semicolon
r_if
c_cond
(paren
id|syscallnr
OG
(paren
id|__NR_Linux
op_plus
id|__NR_Linux_syscalls
)paren
)paren
r_goto
id|illegal_syscall
suffix:semicolon
id|syscall
op_assign
id|sys_call_table
(braket
id|syscallnr
)braket
suffix:semicolon
r_if
c_cond
(paren
id|syscall
op_eq
l_int|NULL
)paren
r_goto
id|illegal_syscall
suffix:semicolon
id|narg
op_assign
id|sys_narg_table
(braket
id|syscallnr
)braket
suffix:semicolon
r_if
c_cond
(paren
id|narg
OG
l_int|4
)paren
(brace
multiline_comment|/*&n;&t;&t; * Verify that we can safely get the additional parameters&n;&t;&t; * from the user stack.  Of course I could read the params&n;&t;&t; * from unaligned addresses ...  Consider this a programming&n;&t;&t; * course caliber .45.&n;&t;&t; */
id|usp
op_assign
id|regs-&gt;reg29
suffix:semicolon
r_if
c_cond
(paren
id|usp
op_amp
l_int|3
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;unaligned usp&bslash;n&quot;
)paren
suffix:semicolon
id|send_sig
c_func
(paren
id|SIGSEGV
comma
id|current
comma
l_int|1
)paren
suffix:semicolon
id|regs-&gt;reg2
op_assign
id|EFAULT
suffix:semicolon
id|regs-&gt;reg7
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
id|errno
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
(paren
id|usp
op_plus
l_int|16
)paren
comma
(paren
id|narg
op_minus
l_int|4
)paren
op_star
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errno
OL
l_int|0
)paren
r_goto
id|bad_syscall
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|current-&gt;flags
op_amp
id|PF_TRACESYS
)paren
op_eq
l_int|0
)paren
(brace
id|errno
op_assign
id|do_syscalls
c_func
(paren
id|regs
comma
id|syscall
comma
id|narg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errno
OL
l_int|0
op_logical_or
id|current-&gt;errno
)paren
r_goto
id|bad_syscall
suffix:semicolon
id|regs-&gt;reg2
op_assign
id|errno
suffix:semicolon
id|regs-&gt;reg7
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|syscall_trace
c_func
(paren
)paren
suffix:semicolon
id|errno
op_assign
id|do_syscalls
c_func
(paren
id|regs
comma
id|syscall
comma
id|narg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errno
OL
l_int|0
op_logical_or
id|current-&gt;errno
)paren
(brace
id|regs-&gt;reg2
op_assign
op_minus
id|errno
suffix:semicolon
id|regs-&gt;reg7
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|regs-&gt;reg2
op_assign
id|errno
suffix:semicolon
id|regs-&gt;reg7
op_assign
l_int|0
suffix:semicolon
)brace
id|syscall_trace
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
id|bad_syscall
suffix:colon
id|regs-&gt;reg2
op_assign
op_minus
id|errno
suffix:semicolon
id|regs-&gt;reg7
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
id|illegal_syscall
suffix:colon
id|regs-&gt;reg2
op_assign
id|ENOSYS
suffix:semicolon
id|regs-&gt;reg7
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
eof
