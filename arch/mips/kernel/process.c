multiline_comment|/*&n; *  linux/arch/mips/kernel/process.c&n; *&n; *  Copyright (C) 1995  Waldorf Electronics,&n; *  written by Ralf Baechle&n; */
multiline_comment|/*&n; * This file handles the architecture-dependent parts of process handling..&n; */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/ldt.h&gt;
macro_line|#include &lt;linux/user.h&gt;
macro_line|#include &lt;linux/a.out.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/mipsregs.h&gt;
macro_line|#include &lt;asm/mipsconfig.h&gt;
macro_line|#include &lt;asm/stackframe.h&gt;
id|asmlinkage
r_void
id|ret_from_sys_call
c_func
(paren
r_void
)paren
id|__asm__
c_func
(paren
l_string|&quot;ret_from_sys_call&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * The idle loop on a MIPS..&n; */
DECL|function|sys_idle
id|asmlinkage
r_int
id|sys_idle
c_func
(paren
r_void
)paren
(brace
macro_line|#if 0
r_int
id|i
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|current-&gt;pid
op_ne
l_int|0
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
macro_line|#if 0
multiline_comment|/* Map out the low memory: it&squot;s no longer needed */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|512
suffix:semicolon
id|i
op_increment
)paren
id|pgd_clear
c_func
(paren
id|swapper_pg_dir
op_plus
id|i
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* endless idle loop with no priority at all */
id|current-&gt;counter
op_assign
op_minus
l_int|100
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
multiline_comment|/*&n;&t;&t; * R4[26]00 have wait, R4[04]00 don&squot;t.&n;&t;&t; */
r_if
c_cond
(paren
id|wait_available
op_logical_and
op_logical_neg
id|need_resched
)paren
id|__asm__
c_func
(paren
l_string|&quot;wait&quot;
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Do necessary setup to start up a newly executed thread.&n; */
DECL|function|start_thread
r_void
id|start_thread
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|eip
comma
r_int
r_int
id|esp
)paren
(brace
id|regs-&gt;cp0_epc
op_assign
id|eip
suffix:semicolon
id|regs-&gt;reg29
op_assign
id|esp
suffix:semicolon
)brace
multiline_comment|/*&n; * Free current thread data structures etc..&n; */
DECL|function|exit_thread
r_void
id|exit_thread
c_func
(paren
r_void
)paren
(brace
multiline_comment|/*&n;&t; * Nothing to do&n;&t; */
)brace
DECL|function|flush_thread
r_void
id|flush_thread
c_func
(paren
r_void
)paren
(brace
multiline_comment|/*&n;&t; * Nothing to do&n;&t; */
)brace
DECL|macro|IS_CLONE
mdefine_line|#define IS_CLONE (regs-&gt;orig_reg2 == __NR_clone)
DECL|function|copy_thread
r_int
r_int
id|copy_thread
c_func
(paren
r_int
id|nr
comma
r_int
r_int
id|clone_flags
comma
r_struct
id|task_struct
op_star
id|p
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|pt_regs
op_star
id|childregs
suffix:semicolon
multiline_comment|/*&n;&t; * set up new TSS&n;&t; */
id|p-&gt;tss.fs
op_assign
id|KERNEL_DS
suffix:semicolon
id|p-&gt;tss.ksp
op_assign
(paren
id|p-&gt;kernel_stack_page
op_plus
id|PAGE_SIZE
op_minus
l_int|4
)paren
op_or
id|KSEG0
suffix:semicolon
id|childregs
op_assign
(paren
(paren
r_struct
id|pt_regs
op_star
)paren
(paren
id|p-&gt;kernel_stack_page
op_plus
id|PAGE_SIZE
)paren
)paren
op_minus
l_int|1
suffix:semicolon
id|p-&gt;tss.reg29
op_assign
(paren
(paren
r_int
r_int
)paren
id|childregs
)paren
op_or
id|KSEG0
suffix:semicolon
multiline_comment|/* new sp */
id|p-&gt;tss.reg31
op_assign
(paren
r_int
r_int
)paren
id|ret_from_sys_call
suffix:semicolon
op_star
id|childregs
op_assign
op_star
id|regs
suffix:semicolon
id|childregs-&gt;reg2
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * New tasks loose permission to use the fpu. This accelerates context&n;&t; * switching for non fp programs, which true for the most programs.&n;&t; */
id|p-&gt;tss.cp0_status
op_assign
id|regs-&gt;cp0_status
op_amp
op_complement
(paren
id|ST0_CU1
op_or
id|ST0_CU0
op_or
id|ST0_KSU
op_or
id|ST0_ERL
op_or
id|ST0_EXL
)paren
suffix:semicolon
id|childregs-&gt;cp0_status
op_and_assign
op_complement
(paren
id|ST0_CU1
op_or
id|ST0_CU0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_CLONE
)paren
(brace
r_if
c_cond
(paren
id|regs-&gt;reg4
)paren
id|childregs-&gt;reg29
op_assign
id|regs-&gt;reg4
suffix:semicolon
id|clone_flags
op_assign
id|regs-&gt;reg5
suffix:semicolon
r_if
c_cond
(paren
id|childregs-&gt;reg29
op_eq
id|regs-&gt;reg29
)paren
id|clone_flags
op_or_assign
id|COPYVM
suffix:semicolon
)brace
r_return
id|clone_flags
suffix:semicolon
)brace
multiline_comment|/*&n; * fill in the user structure for a core dump..&n; */
DECL|function|dump_thread
r_void
id|dump_thread
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_struct
id|user
op_star
id|dump
)paren
(brace
multiline_comment|/*&n;&t; * Not ready yet&n;&t; */
macro_line|#if 0
r_int
id|i
suffix:semicolon
multiline_comment|/* changed the size calculations - should hopefully work better. lbt */
id|dump-&gt;magic
op_assign
id|CMAGIC
suffix:semicolon
id|dump-&gt;start_code
op_assign
l_int|0
suffix:semicolon
id|dump-&gt;start_stack
op_assign
id|regs-&gt;esp
op_amp
op_complement
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|dump-&gt;u_tsize
op_assign
(paren
(paren
r_int
r_int
)paren
id|current-&gt;mm-&gt;end_code
)paren
op_rshift
l_int|12
suffix:semicolon
id|dump-&gt;u_dsize
op_assign
(paren
(paren
r_int
r_int
)paren
(paren
id|current-&gt;mm-&gt;brk
op_plus
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
)paren
op_rshift
l_int|12
suffix:semicolon
id|dump-&gt;u_dsize
op_sub_assign
id|dump-&gt;u_tsize
suffix:semicolon
id|dump-&gt;u_ssize
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|dump-&gt;u_debugreg
(braket
id|i
)braket
op_assign
id|current-&gt;debugreg
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dump-&gt;start_stack
OL
id|TASK_SIZE
)paren
id|dump-&gt;u_ssize
op_assign
(paren
(paren
r_int
r_int
)paren
(paren
id|TASK_SIZE
op_minus
id|dump-&gt;start_stack
)paren
)paren
op_rshift
l_int|12
suffix:semicolon
id|dump-&gt;regs
op_assign
op_star
id|regs
suffix:semicolon
multiline_comment|/* Flag indicating the math stuff is valid. We don&squot;t support this for the&n;   soft-float routines yet */
r_if
c_cond
(paren
id|hard_math
)paren
(brace
r_if
c_cond
(paren
(paren
id|dump-&gt;u_fpvalid
op_assign
id|current-&gt;used_math
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|last_task_used_math
op_eq
id|current
)paren
id|__asm__
c_func
(paren
l_string|&quot;clts ; fnsave %0&quot;
suffix:colon
suffix:colon
l_string|&quot;m&quot;
(paren
id|dump-&gt;i387
)paren
)paren
suffix:semicolon
r_else
id|memcpy
c_func
(paren
op_amp
id|dump-&gt;i387
comma
op_amp
id|current-&gt;tss.i387.hard
comma
r_sizeof
(paren
id|dump-&gt;i387
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* we should dump the emulator state here, but we need to&n;&t;&t;   convert it into standard 387 format first.. */
id|dump-&gt;u_fpvalid
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
)brace
multiline_comment|/*&n; * sys_execve() executes a new program.&n; */
DECL|function|sys_execve
id|asmlinkage
r_int
id|sys_execve
c_func
(paren
r_struct
id|pt_regs
id|regs
)paren
(brace
r_int
id|error
suffix:semicolon
r_char
op_star
id|filename
suffix:semicolon
id|error
op_assign
id|getname
c_func
(paren
(paren
r_char
op_star
)paren
id|regs.reg4
comma
op_amp
id|filename
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|error
op_assign
id|do_execve
c_func
(paren
id|filename
comma
(paren
r_char
op_star
op_star
)paren
id|regs.reg5
comma
(paren
r_char
op_star
op_star
)paren
id|regs.reg6
comma
op_amp
id|regs
)paren
suffix:semicolon
id|putname
c_func
(paren
id|filename
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
eof
