multiline_comment|/*&n; *  linux/arch/mips/kernel/process.c&n; *&n; *  Copyright (C) 1995 Ralf Baechle&n; *  written by Ralf Baechle&n; *&n; * This file handles the architecture-dependent parts of initialization&n; */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/ldt.h&gt;
macro_line|#include &lt;linux/mman.h&gt;
macro_line|#include &lt;linux/sys.h&gt;
macro_line|#include &lt;linux/user.h&gt;
macro_line|#include &lt;linux/a.out.h&gt;
macro_line|#include &lt;asm/bootinfo.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/mipsregs.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/stackframe.h&gt;
macro_line|#include &lt;asm/io.h&gt;
id|asmlinkage
r_void
id|ret_from_sys_call
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/*&n; * This routine reboots the machine by asking the keyboard&n; * controller to pulse the reset-line low. We try that for a while,&n; * and if it doesn&squot;t work, we do some other stupid things.&n; * Should be ok for Deskstation Tynes. Reseting others needs to be&n; * investigated...&n; */
DECL|function|kb_wait
r_static
r_inline
r_void
id|kb_wait
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x10000
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
id|inb_p
c_func
(paren
l_int|0x64
)paren
op_amp
l_int|0x02
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/*&n; * Hard reset for Deskstation Tyne&n; * No hint how this works on Pica boards.&n; */
DECL|function|hard_reset_now
r_void
id|hard_reset_now
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|100
suffix:semicolon
id|i
op_increment
)paren
(brace
id|kb_wait
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|100000
suffix:semicolon
id|j
op_increment
)paren
(brace
multiline_comment|/* nothing */
suffix:semicolon
)brace
id|outb
c_func
(paren
l_int|0xfe
comma
l_int|0x64
)paren
suffix:semicolon
multiline_comment|/* pulse reset low */
)brace
)brace
)brace
DECL|function|show_regs
r_void
id|show_regs
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
multiline_comment|/*&n;&t; * Saved main processor registers&n;&t; */
id|printk
c_func
(paren
l_string|&quot;$0 : %08x %08lx %08lx %08lx %08lx %08lx %08lx %08lx&bslash;n&quot;
comma
l_int|0
comma
id|regs-&gt;reg1
comma
id|regs-&gt;reg2
comma
id|regs-&gt;reg3
comma
id|regs-&gt;reg4
comma
id|regs-&gt;reg5
comma
id|regs-&gt;reg6
comma
id|regs-&gt;reg7
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;$8 : %08lx %08lx %08lx %08lx %08lx %08lx %08lx %08lx&bslash;n&quot;
comma
id|regs-&gt;reg8
comma
id|regs-&gt;reg9
comma
id|regs-&gt;reg10
comma
id|regs-&gt;reg11
comma
id|regs-&gt;reg12
comma
id|regs-&gt;reg13
comma
id|regs-&gt;reg14
comma
id|regs-&gt;reg15
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;$16: %08lx %08lx %08lx %08lx %08lx %08lx %08lx %08lx&bslash;n&quot;
comma
id|regs-&gt;reg16
comma
id|regs-&gt;reg17
comma
id|regs-&gt;reg18
comma
id|regs-&gt;reg19
comma
id|regs-&gt;reg20
comma
id|regs-&gt;reg21
comma
id|regs-&gt;reg22
comma
id|regs-&gt;reg23
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;$24: %08lx %08lx                   %08lx %08lx %08lx %08lx&bslash;n&quot;
comma
id|regs-&gt;reg24
comma
id|regs-&gt;reg25
comma
id|regs-&gt;reg28
comma
id|regs-&gt;reg29
comma
id|regs-&gt;reg30
comma
id|regs-&gt;reg31
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Saved cp0 registers&n;&t; */
id|printk
c_func
(paren
l_string|&quot;epc  : %08lx&bslash;nStatus: %08lx&bslash;nCause : %08lx&bslash;n&quot;
comma
id|regs-&gt;cp0_epc
comma
id|regs-&gt;cp0_status
comma
id|regs-&gt;cp0_cause
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Free current thread data structures etc..&n; */
DECL|function|exit_thread
r_void
id|exit_thread
c_func
(paren
r_void
)paren
(brace
multiline_comment|/*&n;&t; * Nothing to do&n;&t; */
)brace
DECL|function|flush_thread
r_void
id|flush_thread
c_func
(paren
r_void
)paren
(brace
multiline_comment|/*&n;&t; * Nothing to do&n;&t; */
)brace
DECL|function|release_thread
r_void
id|release_thread
c_func
(paren
r_struct
id|task_struct
op_star
id|dead_task
)paren
(brace
multiline_comment|/*&n;&t; * Nothing to do&n;&t; */
)brace
DECL|function|copy_thread
r_int
id|copy_thread
c_func
(paren
r_int
id|nr
comma
r_int
r_int
id|clone_flags
comma
r_int
r_int
id|usp
comma
r_struct
id|task_struct
op_star
id|p
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|pt_regs
op_star
id|childregs
suffix:semicolon
r_int
r_int
id|childksp
suffix:semicolon
id|childksp
op_assign
id|p-&gt;kernel_stack_page
op_plus
id|PAGE_SIZE
op_minus
l_int|8
suffix:semicolon
multiline_comment|/*&n;&t; * set up new TSS&n;&t; */
id|childregs
op_assign
(paren
(paren
r_struct
id|pt_regs
op_star
)paren
(paren
id|p-&gt;kernel_stack_page
op_plus
id|PAGE_SIZE
)paren
)paren
op_minus
l_int|1
suffix:semicolon
op_star
id|childregs
op_assign
op_star
id|regs
suffix:semicolon
id|childregs-&gt;reg2
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Child gets zero as return value */
id|childregs-&gt;reg7
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear error flag */
id|regs-&gt;reg2
op_assign
id|p-&gt;pid
suffix:semicolon
r_if
c_cond
(paren
id|childregs-&gt;cp0_status
op_amp
id|ST0_CU0
)paren
id|childregs-&gt;reg29
op_assign
id|childksp
suffix:semicolon
r_else
id|childregs-&gt;reg29
op_assign
id|usp
suffix:semicolon
id|p-&gt;tss.ksp
op_assign
id|childksp
suffix:semicolon
id|p-&gt;tss.reg29
op_assign
(paren
r_int
r_int
)paren
id|childregs
suffix:semicolon
multiline_comment|/* new sp */
id|p-&gt;tss.reg31
op_assign
(paren
r_int
r_int
)paren
id|ret_from_sys_call
suffix:semicolon
multiline_comment|/*&n;&t; * New tasks loose permission to use the fpu. This accelerates context&n;&t; * switching for most programs since they don&squot;t use the fpu.&n;&t; */
id|p-&gt;tss.cp0_status
op_assign
id|read_32bit_cp0_register
c_func
(paren
id|CP0_STATUS
)paren
op_amp
op_complement
(paren
id|ST0_CU3
op_or
id|ST0_CU2
op_or
id|ST0_CU1
op_or
id|ST0_KSU
op_or
id|ST0_ERL
op_or
id|ST0_EXL
)paren
suffix:semicolon
id|childregs-&gt;cp0_status
op_and_assign
op_complement
(paren
id|ST0_CU3
op_or
id|ST0_CU2
op_or
id|ST0_CU1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * fill in the fpu structure for a core dump..&n; *&n; * Actually this is &quot;int dump_fpu (struct elf_fpregset_t *fpu)&quot;&n; */
DECL|function|dump_fpu
r_int
id|dump_fpu
(paren
r_int
id|shutup_the_gcc_warning_about_elf_fpregset_t
)paren
(brace
r_int
id|fpvalid
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * To do...&n;&t; */
r_return
id|fpvalid
suffix:semicolon
)brace
multiline_comment|/*&n; * fill in the user structure for a core dump..&n; */
DECL|function|dump_thread
r_void
id|dump_thread
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_struct
id|user
op_star
id|dump
)paren
(brace
multiline_comment|/*&n;&t; * To do...&n;&t; */
)brace
eof
