multiline_comment|/*&n;    NetWinder Floating Point Emulator&n;    (c) Rebel.com, 1998-1999&n;&n;    Direct questions, comments to Scott Bambrough &lt;scottb@netwinder.org&gt;&n;&n;    This program is free software; you can redistribute it and/or modify&n;    it under the terms of the GNU General Public License as published by&n;    the Free Software Foundation; either version 2 of the License, or&n;    (at your option) any later version.&n;&n;    This program is distributed in the hope that it will be useful,&n;    but WITHOUT ANY WARRANTY; without even the implied warranty of&n;    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;    GNU General Public License for more details.&n;&n;    You should have received a copy of the GNU General Public License&n;    along with this program; if not, write to the Free Software&n;    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n;*/
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &quot;fpa11.h&quot;
macro_line|#include &quot;fpopcode.h&quot;
macro_line|#include &quot;fpmodule.h&quot;
macro_line|#include &quot;fpmodule.inl&quot;
multiline_comment|/* forward declarations */
r_int
r_int
id|EmulateCPDO
c_func
(paren
r_const
r_int
r_int
)paren
suffix:semicolon
r_int
r_int
id|EmulateCPDT
c_func
(paren
r_const
r_int
r_int
)paren
suffix:semicolon
r_int
r_int
id|EmulateCPRT
c_func
(paren
r_const
r_int
r_int
)paren
suffix:semicolon
multiline_comment|/* Emulator registers */
DECL|variable|fpa11
id|FPA11
op_star
id|fpa11
suffix:semicolon
multiline_comment|/* Reset the FPA11 chip.  Called to initialize and reset the emulator. */
DECL|function|resetFPA11
r_void
id|resetFPA11
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* initialize the register type array */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
l_int|7
suffix:semicolon
id|i
op_increment
)paren
(brace
id|fpa11-&gt;fType
(braket
id|i
)braket
op_assign
id|typeNone
suffix:semicolon
)brace
multiline_comment|/* FPSR: set system id to FP_EMULATOR, clear all other bits */
id|fpa11-&gt;fpsr
op_assign
id|FP_EMULATOR
suffix:semicolon
multiline_comment|/* FPCR: set SB, AB and DA bits, clear all others */
macro_line|#if MAINTAIN_FPCR
id|fpa11-&gt;fpcr
op_assign
id|MASK_RESET
suffix:semicolon
macro_line|#endif
)brace
DECL|function|SetRoundingMode
r_void
id|SetRoundingMode
c_func
(paren
r_const
r_int
r_int
id|opcode
)paren
(brace
macro_line|#if MAINTAIN_FPCR
id|fpa11-&gt;fpcr
op_and_assign
op_complement
id|MASK_ROUNDING_MODE
suffix:semicolon
macro_line|#endif   
r_switch
c_cond
(paren
id|opcode
op_amp
id|MASK_ROUNDING_MODE
)paren
(brace
r_default
suffix:colon
r_case
id|ROUND_TO_NEAREST
suffix:colon
id|float_rounding_mode
op_assign
id|float_round_nearest_even
suffix:semicolon
macro_line|#if MAINTAIN_FPCR         
id|fpa11-&gt;fpcr
op_or_assign
id|ROUND_TO_NEAREST
suffix:semicolon
macro_line|#endif         
r_break
suffix:semicolon
r_case
id|ROUND_TO_PLUS_INFINITY
suffix:colon
id|float_rounding_mode
op_assign
id|float_round_up
suffix:semicolon
macro_line|#if MAINTAIN_FPCR         
id|fpa11-&gt;fpcr
op_or_assign
id|ROUND_TO_PLUS_INFINITY
suffix:semicolon
macro_line|#endif         
r_break
suffix:semicolon
r_case
id|ROUND_TO_MINUS_INFINITY
suffix:colon
id|float_rounding_mode
op_assign
id|float_round_down
suffix:semicolon
macro_line|#if MAINTAIN_FPCR         
id|fpa11-&gt;fpcr
op_or_assign
id|ROUND_TO_MINUS_INFINITY
suffix:semicolon
macro_line|#endif         
r_break
suffix:semicolon
r_case
id|ROUND_TO_ZERO
suffix:colon
id|float_rounding_mode
op_assign
id|float_round_to_zero
suffix:semicolon
macro_line|#if MAINTAIN_FPCR         
id|fpa11-&gt;fpcr
op_or_assign
id|ROUND_TO_ZERO
suffix:semicolon
macro_line|#endif         
r_break
suffix:semicolon
)brace
)brace
DECL|function|SetRoundingPrecision
r_void
id|SetRoundingPrecision
c_func
(paren
r_const
r_int
r_int
id|opcode
)paren
(brace
macro_line|#if MAINTAIN_FPCR
id|fpa11-&gt;fpcr
op_and_assign
op_complement
id|MASK_ROUNDING_PRECISION
suffix:semicolon
macro_line|#endif   
r_switch
c_cond
(paren
id|opcode
op_amp
id|MASK_ROUNDING_PRECISION
)paren
(brace
r_case
id|ROUND_SINGLE
suffix:colon
id|floatx80_rounding_precision
op_assign
l_int|32
suffix:semicolon
macro_line|#if MAINTAIN_FPCR         
id|fpa11-&gt;fpcr
op_or_assign
id|ROUND_SINGLE
suffix:semicolon
macro_line|#endif         
r_break
suffix:semicolon
r_case
id|ROUND_DOUBLE
suffix:colon
id|floatx80_rounding_precision
op_assign
l_int|64
suffix:semicolon
macro_line|#if MAINTAIN_FPCR         
id|fpa11-&gt;fpcr
op_or_assign
id|ROUND_DOUBLE
suffix:semicolon
macro_line|#endif         
r_break
suffix:semicolon
r_case
id|ROUND_EXTENDED
suffix:colon
id|floatx80_rounding_precision
op_assign
l_int|80
suffix:semicolon
macro_line|#if MAINTAIN_FPCR         
id|fpa11-&gt;fpcr
op_or_assign
id|ROUND_EXTENDED
suffix:semicolon
macro_line|#endif         
r_break
suffix:semicolon
r_default
suffix:colon
id|floatx80_rounding_precision
op_assign
l_int|80
suffix:semicolon
)brace
)brace
multiline_comment|/* Emulate the instruction in the opcode. */
DECL|function|EmulateAll
r_int
r_int
id|EmulateAll
c_func
(paren
r_int
r_int
id|opcode
)paren
(brace
r_int
r_int
id|nRc
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fpa11-&gt;initflag
op_eq
l_int|0
)paren
multiline_comment|/* good place for __builtin_expect */
(brace
id|resetFPA11
c_func
(paren
)paren
suffix:semicolon
id|SetRoundingMode
c_func
(paren
id|ROUND_TO_NEAREST
)paren
suffix:semicolon
id|SetRoundingPrecision
c_func
(paren
id|ROUND_EXTENDED
)paren
suffix:semicolon
id|fpa11-&gt;initflag
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|TEST_OPCODE
c_func
(paren
id|opcode
comma
id|MASK_CPRT
)paren
)paren
(brace
multiline_comment|/* Emulate conversion opcodes. */
multiline_comment|/* Emulate register transfer opcodes. */
multiline_comment|/* Emulate comparison opcodes. */
id|nRc
op_assign
id|EmulateCPRT
c_func
(paren
id|opcode
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|TEST_OPCODE
c_func
(paren
id|opcode
comma
id|MASK_CPDO
)paren
)paren
(brace
multiline_comment|/* Emulate monadic arithmetic opcodes. */
multiline_comment|/* Emulate dyadic arithmetic opcodes. */
id|nRc
op_assign
id|EmulateCPDO
c_func
(paren
id|opcode
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|TEST_OPCODE
c_func
(paren
id|opcode
comma
id|MASK_CPDT
)paren
)paren
(brace
multiline_comment|/* Emulate load/store opcodes. */
multiline_comment|/* Emulate load/store multiple opcodes. */
id|nRc
op_assign
id|EmulateCPDT
c_func
(paren
id|opcode
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Invalid instruction detected.  Return FALSE. */
id|nRc
op_assign
l_int|0
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|nRc
suffix:semicolon
)brace
macro_line|#if 0
r_int
r_int
id|EmulateAll1
c_func
(paren
r_int
r_int
id|opcode
)paren
(brace
r_switch
c_cond
(paren
(paren
id|opcode
op_rshift
l_int|24
)paren
op_amp
l_int|0xf
)paren
(brace
r_case
l_int|0xc
suffix:colon
r_case
l_int|0xd
suffix:colon
r_if
c_cond
(paren
(paren
id|opcode
op_rshift
l_int|20
)paren
op_amp
l_int|0x1
)paren
(brace
r_switch
c_cond
(paren
(paren
id|opcode
op_rshift
l_int|8
)paren
op_amp
l_int|0xf
)paren
(brace
r_case
l_int|0x1
suffix:colon
r_return
id|PerformLDF
c_func
(paren
id|opcode
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x2
suffix:colon
r_return
id|PerformLFM
c_func
(paren
id|opcode
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
r_switch
c_cond
(paren
(paren
id|opcode
op_rshift
l_int|8
)paren
op_amp
l_int|0xf
)paren
(brace
r_case
l_int|0x1
suffix:colon
r_return
id|PerformSTF
c_func
(paren
id|opcode
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x2
suffix:colon
r_return
id|PerformSFM
c_func
(paren
id|opcode
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
l_int|0xe
suffix:colon
r_if
c_cond
(paren
id|opcode
op_amp
l_int|0x10
)paren
r_return
id|EmulateCPDO
c_func
(paren
id|opcode
)paren
suffix:semicolon
r_else
r_return
id|EmulateCPRT
c_func
(paren
id|opcode
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
)brace
macro_line|#endif
eof
