multiline_comment|/*&n; * arch/arm/kernel/hw-sa1100.c&n; *&n; * SA1100-dependent machine specifics&n; *&n; * Copyright (C) 2000 Nicolas Pitre &lt;nico@cam.org&gt;&n; *&n; * This will certainly contain more stuff with time... like power management,&n; * special hardware autodetection, etc.&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/delay.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/mach-types.h&gt;
multiline_comment|/*&n; * SA1100 GPIO edge detection for IRQs:&n; * IRQs are generated on Falling-Edge, Rising-Edge, or both.&n; * This must be called *before* the appropriate IRQ is registered.&n; * Use this instead of directly setting GRER/GFER.&n; */
DECL|variable|GPIO_IRQ_rising_edge
r_int
id|GPIO_IRQ_rising_edge
suffix:semicolon
DECL|variable|GPIO_IRQ_falling_edge
r_int
id|GPIO_IRQ_falling_edge
suffix:semicolon
DECL|function|set_GPIO_IRQ_edge
r_void
id|set_GPIO_IRQ_edge
c_func
(paren
r_int
id|gpio_mask
comma
r_int
id|edge
)paren
(brace
r_if
c_cond
(paren
id|edge
op_amp
id|GPIO_FALLING_EDGE
)paren
(brace
id|GPIO_IRQ_falling_edge
op_or_assign
id|gpio_mask
suffix:semicolon
)brace
r_else
id|GPIO_IRQ_falling_edge
op_and_assign
op_complement
id|gpio_mask
suffix:semicolon
r_if
c_cond
(paren
id|edge
op_amp
id|GPIO_RISING_EDGE
)paren
(brace
id|GPIO_IRQ_rising_edge
op_or_assign
id|gpio_mask
suffix:semicolon
)brace
r_else
id|GPIO_IRQ_rising_edge
op_and_assign
op_complement
id|gpio_mask
suffix:semicolon
)brace
DECL|variable|set_GPIO_IRQ_edge
id|EXPORT_SYMBOL
c_func
(paren
id|set_GPIO_IRQ_edge
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SA1100_ASSABET
DECL|variable|BCR_value
r_int
r_int
id|BCR_value
op_assign
id|BCR_DB1110
suffix:semicolon
DECL|variable|SCR_value
r_int
r_int
id|SCR_value
op_assign
id|SCR_INIT
suffix:semicolon
DECL|variable|BCR_value
id|EXPORT_SYMBOL
c_func
(paren
id|BCR_value
)paren
suffix:semicolon
DECL|variable|SCR_value
id|EXPORT_SYMBOL
c_func
(paren
id|SCR_value
)paren
suffix:semicolon
multiline_comment|/*&n; * Read System Configuration &quot;Register&quot;&n; * (taken from &quot;Intel StrongARM SA-1110 Microprocessor Development Board&n; * User&squot;s Guide&quot;, section 4.4.1)&n; *&n; * This same scan is performed in arch/arm/boot/compressed/head-sa1100.S&n; * to set up the serial port for decompression status messages. We &n; * repeat it here because the kernel may not be loaded as a zImage, and&n; * also because it&squot;s a hassle to communicate the SCR value to the kernel&n; * from the decompressor.&n; */
DECL|function|get_assabet_scr
r_void
id|__init
id|get_assabet_scr
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
comma
id|scr
comma
id|i
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|GPDR
op_or_assign
l_int|0x3fc
suffix:semicolon
multiline_comment|/* Configure GPIO 9:2 as outputs */
id|GPSR
op_assign
l_int|0x3fc
suffix:semicolon
multiline_comment|/* Write 0xFF to GPIO 9:2 */
id|GPDR
op_and_assign
op_complement
(paren
l_int|0x3fc
)paren
suffix:semicolon
multiline_comment|/* Configure GPIO 9:2 as inputs */
r_for
c_loop
(paren
id|i
op_assign
l_int|100
suffix:semicolon
id|i
op_decrement
suffix:semicolon
id|scr
op_assign
id|GPLR
)paren
(brace
suffix:semicolon
)brace
multiline_comment|/* Read GPIO 9:2 */
id|GPDR
op_or_assign
l_int|0x3fc
suffix:semicolon
multiline_comment|/*  restore correct pin direction */
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
id|scr
op_and_assign
l_int|0x3fc
suffix:semicolon
multiline_comment|/* save as system configuration byte. */
id|SCR_value
op_assign
id|scr
suffix:semicolon
)brace
macro_line|#endif  /* CONFIG_SA1100_ASSABET */
macro_line|#if defined(CONFIG_SA1100_BITSY)
multiline_comment|/*&n; * Bitsy has extended, write-only memory-mapped GPIO&squot;s&n; */
DECL|variable|bitsy_egpio
r_static
r_int
id|bitsy_egpio
op_assign
id|EGPIO_BITSY_RS232_ON
suffix:semicolon
DECL|function|clr_bitsy_egpio
r_void
id|clr_bitsy_egpio
c_func
(paren
r_int
r_int
id|x
)paren
(brace
id|bitsy_egpio
op_and_assign
op_complement
id|x
suffix:semicolon
op_star
(paren
r_volatile
r_int
op_star
)paren
l_int|0xdc000000
op_assign
id|bitsy_egpio
suffix:semicolon
)brace
DECL|function|set_bitsy_egpio
r_void
id|set_bitsy_egpio
c_func
(paren
r_int
r_int
id|x
)paren
(brace
id|bitsy_egpio
op_or_assign
id|x
suffix:semicolon
op_star
(paren
r_volatile
r_int
op_star
)paren
l_int|0xdc000000
op_assign
id|bitsy_egpio
suffix:semicolon
)brace
DECL|variable|clr_bitsy_egpio
id|EXPORT_SYMBOL
c_func
(paren
id|clr_bitsy_egpio
)paren
suffix:semicolon
DECL|variable|set_bitsy_egpio
id|EXPORT_SYMBOL
c_func
(paren
id|set_bitsy_egpio
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_SA1111
DECL|function|sa1111_init
r_static
r_void
id|__init
(def_block
id|sa1111_init
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|id
op_assign
id|SKID
suffix:semicolon
r_if
c_cond
(paren
(paren
id|id
op_amp
id|SKID_ID_MASK
)paren
op_eq
id|SKID_SA1111_ID
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;SA-1111 Microprocessor Companion Chip: &quot;
l_string|&quot;silicon revision %x, metal revision %x&bslash;n&quot;
comma
(paren
id|id
op_amp
id|SKID_SIREV_MASK
)paren
op_rshift
l_int|4
comma
(paren
id|id
op_amp
id|SKID_MTREV_MASK
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Could not detect SA-1111!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* First, set up the 3.6864MHz clock on GPIO 27 for the SA-1111:&n;   * (SA-1110 Developer&squot;s Manual, section 9.1.2.1)&n;   */
id|GAFR
op_or_assign
id|GPIO_GPIO27
suffix:semicolon
id|GPDR
op_or_assign
id|GPIO_GPIO27
suffix:semicolon
id|TUCR
op_assign
id|TUCR_3_6864MHz
suffix:semicolon
multiline_comment|/* Now, set up the PLL and RCLK in the SA-1111: */
id|SKCR
op_assign
id|SKCR_PLL_BYPASS
op_or
id|SKCR_RDYEN
op_or
id|SKCR_OE_EN
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|SKCR
op_assign
id|SKCR_PLL_BYPASS
op_or
id|SKCR_RCLKEN
op_or
id|SKCR_RDYEN
op_or
id|SKCR_OE_EN
suffix:semicolon
multiline_comment|/* SA-1111 Register Access Bus should now be available. Clocks for&n;   * any other SA-1111 functional blocks must be enabled separately&n;   * using the SKPCR.&n;   */
(brace
multiline_comment|/*&n;   * SA1111 DMA bus master setup &n;   */
r_int
id|cas
suffix:semicolon
multiline_comment|/* SA1111 side */
r_switch
c_cond
(paren
(paren
id|MDCNFG
op_rshift
l_int|12
)paren
op_amp
l_int|0x03
)paren
(brace
r_case
l_int|0x02
suffix:colon
id|cas
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x03
suffix:colon
id|cas
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|cas
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|SMCR
op_assign
l_int|1
multiline_comment|/* 1: memory is SDRAM */
op_or
(paren
l_int|1
op_lshift
l_int|1
)paren
multiline_comment|/* 1:MBGNT is enable */
op_or
(paren
(paren
(paren
id|MDCNFG
op_rshift
l_int|4
)paren
op_amp
l_int|0x07
)paren
op_lshift
l_int|2
)paren
multiline_comment|/* row address lines */
op_or
(paren
id|cas
op_lshift
l_int|5
)paren
suffix:semicolon
multiline_comment|/* CAS latency */
multiline_comment|/* SA1110 side */
id|GPDR
op_or_assign
l_int|1
op_lshift
l_int|21
suffix:semicolon
id|GPDR
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|22
)paren
suffix:semicolon
id|GAFR
op_or_assign
(paren
(paren
l_int|1
op_lshift
l_int|21
)paren
op_or
(paren
l_int|1
op_lshift
l_int|22
)paren
)paren
suffix:semicolon
id|TUCR
op_or_assign
(paren
l_int|1
op_lshift
l_int|10
)paren
suffix:semicolon
)brace
)brace
)def_block
macro_line|#else
DECL|macro|sa1111_init
mdefine_line|#define sa1111_init()  printk( &quot;Warning: missing SA1111 support&bslash;n&quot; )
macro_line|#endif
DECL|function|hw_sa1100_init
r_static
r_int
id|__init
id|hw_sa1100_init
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|machine_is_assabet
c_func
(paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|machine_has_neponset
c_func
(paren
)paren
)paren
(brace
macro_line|#ifdef CONFIG_ASSABET_NEPONSET
id|LEDS
op_assign
id|WHOAMI
suffix:semicolon
id|sa1111_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
l_string|&quot;Warning: Neponset detected but full support &quot;
l_string|&quot;hasn&squot;t been configured in the kernel&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
r_else
r_if
c_cond
(paren
id|machine_is_xp860
c_func
(paren
)paren
)paren
(brace
id|sa1111_init
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|hw_sa1100_init
id|module_init
c_func
(paren
id|hw_sa1100_init
)paren
suffix:semicolon
eof
