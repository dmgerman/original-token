macro_line|#include &lt;stdio.h&gt;
macro_line|#include &lt;string.h&gt;
macro_line|#include &lt;stdlib.h&gt;
macro_line|#include &lt;stdarg.h&gt;
macro_line|#include &lt;a.out.h&gt;
DECL|typedef|byte
r_typedef
r_int
r_char
id|byte
suffix:semicolon
DECL|typedef|word
r_typedef
r_int
r_int
id|word
suffix:semicolon
DECL|typedef|u32
r_typedef
r_int
r_int
id|u32
suffix:semicolon
DECL|function|die
r_void
id|die
c_func
(paren
r_const
r_char
op_star
id|str
comma
dot
dot
dot
)paren
(brace
id|va_list
id|args
suffix:semicolon
id|va_start
c_func
(paren
id|args
comma
id|str
)paren
suffix:semicolon
id|vfprintf
c_func
(paren
id|stderr
comma
id|str
comma
id|args
)paren
suffix:semicolon
id|fputc
c_func
(paren
l_char|&squot;&bslash;n&squot;
comma
id|stderr
)paren
suffix:semicolon
m_exit
(paren
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|main
r_int
id|main
c_func
(paren
r_int
id|argc
comma
r_char
op_star
op_star
id|argv
)paren
(brace
r_void
op_star
id|data
suffix:semicolon
r_struct
id|exec
id|ex
suffix:semicolon
id|FILE
op_star
id|f
suffix:semicolon
r_int
id|totlen
suffix:semicolon
r_if
c_cond
(paren
id|argc
OL
l_int|2
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Usage: build kernel-name&bslash;n&quot;
)paren
suffix:semicolon
m_exit
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|f
op_assign
id|fopen
c_func
(paren
id|argv
(braket
l_int|1
)braket
comma
l_string|&quot;rb&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|f
)paren
id|die
c_func
(paren
l_string|&quot;Unable to open `%s&squot;: %m&quot;
comma
id|argv
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|fread
c_func
(paren
op_amp
id|ex
comma
l_int|1
comma
r_sizeof
(paren
id|ex
)paren
comma
id|f
)paren
suffix:semicolon
r_if
c_cond
(paren
id|N_MAGIC
c_func
(paren
id|ex
)paren
op_eq
id|ZMAGIC
)paren
(brace
id|fseek
c_func
(paren
id|f
comma
l_int|4096
comma
id|SEEK_SET
)paren
suffix:semicolon
id|totlen
op_assign
id|ex.a_text
op_plus
id|ex.a_data
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|N_MAGIC
c_func
(paren
id|ex
)paren
op_eq
id|QMAGIC
)paren
(brace
r_int
r_int
id|my_header
suffix:semicolon
id|fseek
c_func
(paren
id|f
comma
l_int|4
comma
id|SEEK_SET
)paren
suffix:semicolon
id|my_header
op_assign
l_int|0xea000006
suffix:semicolon
id|fwrite
c_func
(paren
op_amp
id|my_header
comma
l_int|4
comma
l_int|1
comma
id|stdout
)paren
suffix:semicolon
id|totlen
op_assign
id|ex.a_text
op_plus
id|ex.a_data
op_minus
l_int|4
suffix:semicolon
)brace
r_else
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Unacceptable a.out header on kernel&bslash;n&quot;
)paren
suffix:semicolon
id|fclose
c_func
(paren
id|f
)paren
suffix:semicolon
m_exit
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Kernel is %dk (%dk text, %dk data, %dk bss)&bslash;n&quot;
comma
(paren
id|ex.a_text
op_plus
id|ex.a_data
op_plus
id|ex.a_bss
)paren
op_div
l_int|1024
comma
id|ex.a_text
op_div
l_int|1024
comma
id|ex.a_data
op_div
l_int|1024
comma
id|ex.a_bss
op_div
l_int|1024
)paren
suffix:semicolon
id|data
op_assign
id|malloc
c_func
(paren
id|totlen
)paren
suffix:semicolon
id|fread
c_func
(paren
id|data
comma
l_int|1
comma
id|totlen
comma
id|f
)paren
suffix:semicolon
id|fwrite
c_func
(paren
id|data
comma
l_int|1
comma
id|totlen
comma
id|stdout
)paren
suffix:semicolon
id|free
c_func
(paren
id|data
)paren
suffix:semicolon
id|fclose
c_func
(paren
id|f
)paren
suffix:semicolon
id|fflush
c_func
(paren
id|stdout
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
