multiline_comment|/*&n; * arch/arm/kernel/dma-rpc.c&n; *&n; * Copyright (C) 1998 Russell King&n; *&n; * DMA functions specific to RiscPC architecture&n; */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/mman.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &quot;dma.h&quot;
macro_line|#if 0
r_typedef
r_enum
(brace
id|dma_size_8
op_assign
l_int|1
comma
id|dma_size_16
op_assign
l_int|2
comma
id|dma_size_32
op_assign
l_int|4
comma
id|dma_size_128
op_assign
l_int|16
)brace
id|dma_size_t
suffix:semicolon
r_typedef
r_struct
(brace
id|dma_size_t
id|transfersize
suffix:semicolon
)brace
id|dma_t
suffix:semicolon
macro_line|#endif
DECL|macro|TRANSFER_SIZE
mdefine_line|#define TRANSFER_SIZE&t;2
DECL|macro|CURA
mdefine_line|#define CURA&t;(0)
DECL|macro|ENDA
mdefine_line|#define ENDA&t;((IOMD_IO0ENDA - IOMD_IO0CURA) &lt;&lt; 2)
DECL|macro|CURB
mdefine_line|#define CURB&t;((IOMD_IO0CURB - IOMD_IO0CURA) &lt;&lt; 2)
DECL|macro|ENDB
mdefine_line|#define ENDB&t;((IOMD_IO0ENDB - IOMD_IO0CURA) &lt;&lt; 2)
DECL|macro|CR
mdefine_line|#define CR&t;((IOMD_IO0CR - IOMD_IO0CURA) &lt;&lt; 2)
DECL|macro|ST
mdefine_line|#define ST&t;((IOMD_IO0ST - IOMD_IO0CURA) &lt;&lt; 2)
DECL|macro|state_prog_a
mdefine_line|#define state_prog_a&t;0
DECL|macro|state_wait_a
mdefine_line|#define state_wait_a&t;1
DECL|macro|state_wait_b
mdefine_line|#define state_wait_b&t;2
DECL|function|arch_get_next_sg
r_static
r_void
id|arch_get_next_sg
c_func
(paren
id|dmasg_t
op_star
id|sg
comma
id|dma_t
op_star
id|dma
)paren
(brace
r_int
r_int
id|end
comma
id|offset
comma
id|flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dma-&gt;sg
)paren
(brace
id|sg-&gt;address
op_assign
id|dma-&gt;sg-&gt;address
suffix:semicolon
id|offset
op_assign
id|sg-&gt;address
op_amp
op_complement
id|PAGE_MASK
suffix:semicolon
id|end
op_assign
id|offset
op_plus
id|dma-&gt;sg-&gt;length
suffix:semicolon
r_if
c_cond
(paren
id|end
OG
id|PAGE_SIZE
)paren
id|end
op_assign
id|PAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_plus
(paren
r_int
)paren
id|TRANSFER_SIZE
OG
id|end
)paren
id|flags
op_or_assign
id|DMA_END_L
suffix:semicolon
id|sg-&gt;length
op_assign
id|end
op_minus
id|TRANSFER_SIZE
suffix:semicolon
id|dma-&gt;sg-&gt;length
op_sub_assign
id|end
op_minus
id|offset
suffix:semicolon
id|dma-&gt;sg-&gt;address
op_add_assign
id|end
op_minus
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|dma-&gt;sg-&gt;length
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|dma-&gt;sgcount
OG
l_int|1
)paren
(brace
id|dma-&gt;sg
op_increment
suffix:semicolon
id|dma-&gt;sgcount
op_decrement
suffix:semicolon
)brace
r_else
(brace
id|dma-&gt;sg
op_assign
l_int|NULL
suffix:semicolon
id|flags
op_or_assign
id|DMA_END_S
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|flags
op_assign
id|DMA_END_S
op_or
id|DMA_END_L
suffix:semicolon
id|sg-&gt;address
op_assign
l_int|0
suffix:semicolon
id|sg-&gt;length
op_assign
l_int|0
suffix:semicolon
)brace
id|sg-&gt;length
op_or_assign
id|flags
suffix:semicolon
)brace
DECL|function|arch_setup_dma_a
r_static
r_inline
r_void
id|arch_setup_dma_a
c_func
(paren
id|dmasg_t
op_star
id|sg
comma
id|dma_t
op_star
id|dma
)paren
(brace
id|outl_t
c_func
(paren
id|sg-&gt;address
comma
id|dma-&gt;dma_base
op_plus
id|CURA
)paren
suffix:semicolon
id|outl_t
c_func
(paren
id|sg-&gt;length
comma
id|dma-&gt;dma_base
op_plus
id|ENDA
)paren
suffix:semicolon
)brace
DECL|function|arch_setup_dma_b
r_static
r_inline
r_void
id|arch_setup_dma_b
c_func
(paren
id|dmasg_t
op_star
id|sg
comma
id|dma_t
op_star
id|dma
)paren
(brace
id|outl_t
c_func
(paren
id|sg-&gt;address
comma
id|dma-&gt;dma_base
op_plus
id|CURB
)paren
suffix:semicolon
id|outl_t
c_func
(paren
id|sg-&gt;length
comma
id|dma-&gt;dma_base
op_plus
id|ENDB
)paren
suffix:semicolon
)brace
DECL|function|arch_dma_handle
r_static
r_void
id|arch_dma_handle
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|dma_t
op_star
id|dma
op_assign
(paren
id|dma_t
op_star
)paren
id|dev_id
suffix:semicolon
r_int
r_int
id|status
op_assign
l_int|0
comma
id|no_buffer
op_assign
id|dma-&gt;sg
op_eq
l_int|NULL
suffix:semicolon
r_do
(brace
r_switch
c_cond
(paren
id|dma-&gt;state
)paren
(brace
r_case
id|state_prog_a
suffix:colon
id|arch_get_next_sg
c_func
(paren
op_amp
id|dma-&gt;cur_sg
comma
id|dma
)paren
suffix:semicolon
id|arch_setup_dma_a
c_func
(paren
op_amp
id|dma-&gt;cur_sg
comma
id|dma
)paren
suffix:semicolon
id|dma-&gt;state
op_assign
id|state_wait_a
suffix:semicolon
r_case
id|state_wait_a
suffix:colon
id|status
op_assign
id|inb_t
c_func
(paren
id|dma-&gt;dma_base
op_plus
id|ST
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|status
op_amp
(paren
id|DMA_ST_OFL
op_or
id|DMA_ST_INT
op_or
id|DMA_ST_AB
)paren
)paren
(brace
r_case
id|DMA_ST_OFL
op_or
id|DMA_ST_INT
suffix:colon
id|arch_get_next_sg
c_func
(paren
op_amp
id|dma-&gt;cur_sg
comma
id|dma
)paren
suffix:semicolon
id|arch_setup_dma_a
c_func
(paren
op_amp
id|dma-&gt;cur_sg
comma
id|dma
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DMA_ST_INT
suffix:colon
id|arch_get_next_sg
c_func
(paren
op_amp
id|dma-&gt;cur_sg
comma
id|dma
)paren
suffix:semicolon
id|arch_setup_dma_b
c_func
(paren
op_amp
id|dma-&gt;cur_sg
comma
id|dma
)paren
suffix:semicolon
id|dma-&gt;state
op_assign
id|state_wait_b
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DMA_ST_OFL
op_or
id|DMA_ST_INT
op_or
id|DMA_ST_AB
suffix:colon
id|arch_setup_dma_b
c_func
(paren
op_amp
id|dma-&gt;cur_sg
comma
id|dma
)paren
suffix:semicolon
id|dma-&gt;state
op_assign
id|state_wait_b
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|state_wait_b
suffix:colon
id|status
op_assign
id|inb_t
c_func
(paren
id|dma-&gt;dma_base
op_plus
id|ST
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|status
op_amp
(paren
id|DMA_ST_OFL
op_or
id|DMA_ST_INT
op_or
id|DMA_ST_AB
)paren
)paren
(brace
r_case
id|DMA_ST_OFL
op_or
id|DMA_ST_INT
op_or
id|DMA_ST_AB
suffix:colon
id|arch_get_next_sg
c_func
(paren
op_amp
id|dma-&gt;cur_sg
comma
id|dma
)paren
suffix:semicolon
id|arch_setup_dma_b
c_func
(paren
op_amp
id|dma-&gt;cur_sg
comma
id|dma
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DMA_ST_INT
op_or
id|DMA_ST_AB
suffix:colon
id|arch_get_next_sg
c_func
(paren
op_amp
id|dma-&gt;cur_sg
comma
id|dma
)paren
suffix:semicolon
id|arch_setup_dma_a
c_func
(paren
op_amp
id|dma-&gt;cur_sg
comma
id|dma
)paren
suffix:semicolon
id|dma-&gt;state
op_assign
id|state_wait_a
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DMA_ST_OFL
op_or
id|DMA_ST_INT
suffix:colon
id|arch_setup_dma_a
c_func
(paren
op_amp
id|dma-&gt;cur_sg
comma
id|dma
)paren
suffix:semicolon
id|dma-&gt;state
op_assign
id|state_wait_a
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|dma-&gt;sg
op_logical_and
(paren
id|status
op_amp
id|DMA_ST_INT
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|no_buffer
)paren
id|enable_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|function|arch_request_dma
r_int
id|arch_request_dma
c_func
(paren
id|dmach_t
id|channel
comma
id|dma_t
op_star
id|dma
comma
r_const
r_char
op_star
id|dev_name
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_switch
c_cond
(paren
id|channel
)paren
(brace
r_case
id|DMA_0
suffix:colon
r_case
id|DMA_1
suffix:colon
r_case
id|DMA_2
suffix:colon
r_case
id|DMA_3
suffix:colon
r_case
id|DMA_S0
suffix:colon
r_case
id|DMA_S1
suffix:colon
id|save_flags_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|ret
op_assign
id|request_irq
c_func
(paren
id|dma-&gt;dma_irq
comma
id|arch_dma_handle
comma
id|SA_INTERRUPT
comma
id|dev_name
comma
id|dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|disable_irq
c_func
(paren
id|dma-&gt;dma_irq
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DMA_VIRTUAL_FLOPPY
suffix:colon
r_case
id|DMA_VIRTUAL_SOUND
suffix:colon
id|ret
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|arch_free_dma
r_void
id|arch_free_dma
c_func
(paren
id|dmach_t
id|channel
comma
id|dma_t
op_star
id|dma
)paren
(brace
r_switch
c_cond
(paren
id|channel
)paren
(brace
r_case
id|DMA_0
suffix:colon
r_case
id|DMA_1
suffix:colon
r_case
id|DMA_2
suffix:colon
r_case
id|DMA_3
suffix:colon
r_case
id|DMA_S0
suffix:colon
r_case
id|DMA_S1
suffix:colon
id|free_irq
c_func
(paren
id|dma-&gt;dma_irq
comma
id|dma
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
DECL|function|arch_get_dma_residue
r_int
id|arch_get_dma_residue
c_func
(paren
id|dmach_t
id|channel
comma
id|dma_t
op_star
id|dma
)paren
(brace
r_int
id|residue
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|channel
)paren
(brace
r_case
id|DMA_0
suffix:colon
multiline_comment|/* Physical DMA channels */
r_case
id|DMA_1
suffix:colon
r_case
id|DMA_2
suffix:colon
r_case
id|DMA_3
suffix:colon
r_case
id|DMA_S0
suffix:colon
r_case
id|DMA_S1
suffix:colon
r_break
suffix:semicolon
r_case
id|DMA_VIRTUAL_FLOPPY
suffix:colon
(brace
r_extern
r_int
id|floppy_fiqresidual
c_func
(paren
r_void
)paren
suffix:semicolon
id|residue
op_assign
id|floppy_fiqresidual
c_func
(paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_return
id|residue
suffix:semicolon
)brace
DECL|function|arch_enable_dma
r_void
id|arch_enable_dma
c_func
(paren
id|dmach_t
id|channel
comma
id|dma_t
op_star
id|dma
)paren
(brace
r_int
r_int
id|dma_base
op_assign
id|dma-&gt;dma_base
suffix:semicolon
r_int
r_int
id|ctrl
suffix:semicolon
r_switch
c_cond
(paren
id|channel
)paren
(brace
r_case
id|DMA_0
suffix:colon
multiline_comment|/* Physical DMA channels */
r_case
id|DMA_1
suffix:colon
r_case
id|DMA_2
suffix:colon
r_case
id|DMA_3
suffix:colon
r_case
id|DMA_S0
suffix:colon
r_case
id|DMA_S1
suffix:colon
id|ctrl
op_assign
id|TRANSFER_SIZE
op_or
id|DMA_CR_E
suffix:semicolon
r_if
c_cond
(paren
id|dma-&gt;invalid
)paren
(brace
id|dma-&gt;invalid
op_assign
l_int|0
suffix:semicolon
id|outb_t
c_func
(paren
id|DMA_CR_C
comma
id|dma_base
op_plus
id|CR
)paren
suffix:semicolon
id|dma-&gt;state
op_assign
id|state_prog_a
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dma-&gt;dma_mode
op_eq
id|DMA_MODE_READ
)paren
id|ctrl
op_or_assign
id|DMA_CR_D
suffix:semicolon
id|outb_t
c_func
(paren
id|ctrl
comma
id|dma_base
op_plus
id|CR
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|dma-&gt;dma_irq
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DMA_VIRTUAL_FLOPPY
suffix:colon
(brace
r_void
op_star
id|fiqhandler_start
suffix:semicolon
r_int
r_int
id|fiqhandler_length
suffix:semicolon
r_extern
r_void
id|floppy_fiqsetup
c_func
(paren
r_int
r_int
id|len
comma
r_int
r_int
id|addr
comma
r_int
r_int
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma-&gt;dma_mode
op_eq
id|DMA_MODE_READ
)paren
(brace
r_extern
r_int
r_char
id|floppy_fiqin_start
comma
id|floppy_fiqin_end
suffix:semicolon
id|fiqhandler_start
op_assign
op_amp
id|floppy_fiqin_start
suffix:semicolon
id|fiqhandler_length
op_assign
op_amp
id|floppy_fiqin_end
op_minus
op_amp
id|floppy_fiqin_start
suffix:semicolon
)brace
r_else
(brace
r_extern
r_int
r_char
id|floppy_fiqout_start
comma
id|floppy_fiqout_end
suffix:semicolon
id|fiqhandler_start
op_assign
op_amp
id|floppy_fiqout_start
suffix:semicolon
id|fiqhandler_length
op_assign
op_amp
id|floppy_fiqout_end
op_minus
op_amp
id|floppy_fiqout_start
suffix:semicolon
)brace
multiline_comment|/* Allow access to page 0 via domains */
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;mcr&t;p15, 0, %0, c3, c0&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|DOMAIN_USER_MANAGER
op_or
id|DOMAIN_KERNEL_CLIENT
op_or
id|DOMAIN_IO_CLIENT
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
l_int|0x1c
comma
id|fiqhandler_start
comma
id|fiqhandler_length
)paren
suffix:semicolon
multiline_comment|/* set domain register to normal */
id|set_fs
c_func
(paren
id|get_fs
c_func
(paren
)paren
)paren
suffix:semicolon
id|flush_page_to_ram
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|floppy_fiqsetup
c_func
(paren
id|dma-&gt;buf.length
comma
id|__bus_to_virt
c_func
(paren
id|dma-&gt;buf.address
)paren
comma
(paren
r_int
)paren
id|PCIO_FLOPPYDMABASE
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|dma-&gt;dma_irq
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
DECL|function|arch_disable_dma
r_void
id|arch_disable_dma
c_func
(paren
id|dmach_t
id|channel
comma
id|dma_t
op_star
id|dma
)paren
(brace
r_int
r_int
id|dma_base
op_assign
id|dma-&gt;dma_base
suffix:semicolon
r_int
r_int
id|ctrl
suffix:semicolon
r_switch
c_cond
(paren
id|channel
)paren
(brace
r_case
id|DMA_0
suffix:colon
multiline_comment|/* Physical DMA channels */
r_case
id|DMA_1
suffix:colon
r_case
id|DMA_2
suffix:colon
r_case
id|DMA_3
suffix:colon
r_case
id|DMA_S0
suffix:colon
r_case
id|DMA_S1
suffix:colon
id|disable_irq
c_func
(paren
id|dma-&gt;dma_irq
)paren
suffix:semicolon
id|ctrl
op_assign
id|inb_t
c_func
(paren
id|dma_base
op_plus
id|CR
)paren
suffix:semicolon
id|outb_t
c_func
(paren
id|ctrl
op_amp
op_complement
id|DMA_CR_E
comma
id|dma_base
op_plus
id|CR
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DMA_VIRTUAL_FLOPPY
suffix:colon
id|disable_irq
c_func
(paren
id|dma-&gt;dma_irq
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|arch_dma_init
c_func
(paren
id|dma_t
op_star
id|dma
)paren
)paren
(brace
id|outb
c_func
(paren
l_int|0
comma
id|IOMD_IO0CR
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|IOMD_IO1CR
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|IOMD_IO2CR
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|IOMD_IO3CR
)paren
suffix:semicolon
singleline_comment|//&t;outb(0xf0, IOMD_DMATCR);
id|dma
(braket
l_int|0
)braket
dot
id|dma_base
op_assign
id|ioaddr
c_func
(paren
id|IOMD_IO0CURA
)paren
suffix:semicolon
id|dma
(braket
l_int|0
)braket
dot
id|dma_irq
op_assign
id|IRQ_DMA0
suffix:semicolon
id|dma
(braket
l_int|1
)braket
dot
id|dma_base
op_assign
id|ioaddr
c_func
(paren
id|IOMD_IO1CURA
)paren
suffix:semicolon
id|dma
(braket
l_int|1
)braket
dot
id|dma_irq
op_assign
id|IRQ_DMA1
suffix:semicolon
id|dma
(braket
l_int|2
)braket
dot
id|dma_base
op_assign
id|ioaddr
c_func
(paren
id|IOMD_IO2CURA
)paren
suffix:semicolon
id|dma
(braket
l_int|2
)braket
dot
id|dma_irq
op_assign
id|IRQ_DMA2
suffix:semicolon
id|dma
(braket
l_int|3
)braket
dot
id|dma_base
op_assign
id|ioaddr
c_func
(paren
id|IOMD_IO3CURA
)paren
suffix:semicolon
id|dma
(braket
l_int|3
)braket
dot
id|dma_irq
op_assign
id|IRQ_DMA3
suffix:semicolon
id|dma
(braket
l_int|4
)braket
dot
id|dma_base
op_assign
id|ioaddr
c_func
(paren
id|IOMD_SD0CURA
)paren
suffix:semicolon
id|dma
(braket
l_int|4
)braket
dot
id|dma_irq
op_assign
id|IRQ_DMAS0
suffix:semicolon
id|dma
(braket
l_int|5
)braket
dot
id|dma_base
op_assign
id|ioaddr
c_func
(paren
id|IOMD_SD1CURA
)paren
suffix:semicolon
id|dma
(braket
l_int|5
)braket
dot
id|dma_irq
op_assign
id|IRQ_DMAS1
suffix:semicolon
id|dma
(braket
l_int|6
)braket
dot
id|dma_irq
op_assign
l_int|64
suffix:semicolon
multiline_comment|/* Setup DMA channels 2,3 to be for podules&n;&t; * and channels 0,1 for internal devices&n;&t; */
id|outb
c_func
(paren
id|DMA_EXT_IO3
op_or
id|DMA_EXT_IO2
comma
id|IOMD_DMAEXT
)paren
suffix:semicolon
)brace
eof
