multiline_comment|/*&n; *  linux/arch/arm/kernel/process.c&n; *&n; *  Copyright (C) 1996 Russell King - Converted to ARM.&n; *  Origional Copyright (C) 1995  Linus Torvalds&n; */
multiline_comment|/*&n; * This file handles the architecture-dependent parts of process handling..&n; */
DECL|macro|__KERNEL_SYSCALLS__
mdefine_line|#define __KERNEL_SYSCALLS__
macro_line|#include &lt;stdarg.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/user.h&gt;
macro_line|#include &lt;linux/a.out.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/reboot.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
DECL|variable|last_task_used_math
r_struct
id|task_struct
op_star
id|last_task_used_math
suffix:semicolon
r_extern
r_void
id|fpe_save
c_func
(paren
r_struct
id|fp_soft_struct
op_star
)paren
suffix:semicolon
r_extern
r_char
op_star
id|processor_modes
(braket
)braket
suffix:semicolon
id|asmlinkage
r_void
id|ret_from_sys_call
c_func
(paren
r_void
)paren
id|__asm__
c_func
(paren
l_string|&quot;ret_from_sys_call&quot;
)paren
suffix:semicolon
DECL|variable|hlt_counter
r_static
r_int
id|hlt_counter
op_assign
l_int|0
suffix:semicolon
DECL|function|disable_hlt
r_void
id|disable_hlt
c_func
(paren
r_void
)paren
(brace
id|hlt_counter
op_increment
suffix:semicolon
)brace
DECL|function|enable_hlt
r_void
id|enable_hlt
c_func
(paren
r_void
)paren
(brace
id|hlt_counter
op_decrement
suffix:semicolon
)brace
multiline_comment|/*&n; * The idle loop on an arm..&n; */
DECL|function|sys_idle
id|asmlinkage
r_int
id|sys_idle
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
op_assign
op_minus
id|EPERM
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;pid
op_ne
l_int|0
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* endless idle loop with no priority at all */
id|current-&gt;priority
op_assign
op_minus
l_int|100
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|check_pgt_cache
c_func
(paren
)paren
suffix:semicolon
macro_line|#if 0 
singleline_comment|//def ARCH_IDLE_OK
r_if
c_cond
(paren
op_logical_neg
id|hlt_counter
op_logical_and
op_logical_neg
id|need_resched
)paren
id|proc_idle
(paren
)paren
suffix:semicolon
macro_line|#endif
id|run_task_queue
c_func
(paren
op_amp
id|tq_scheduler
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
id|ret
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|reboot_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
)paren
(brace
)brace
multiline_comment|/*&n; * This routine reboots the machine by resetting the expansion cards via&n; * their loaders, turning off the processor cache (if ARM3), copying the&n; * first instruction of the ROM to 0, and executing it there.&n; */
DECL|function|machine_restart
r_void
id|machine_restart
c_func
(paren
r_char
op_star
id|__unused
)paren
(brace
id|proc_hard_reset
(paren
)paren
suffix:semicolon
id|arch_hard_reset
(paren
)paren
suffix:semicolon
)brace
DECL|function|machine_halt
r_void
id|machine_halt
c_func
(paren
r_void
)paren
(brace
)brace
DECL|function|machine_power_off
r_void
id|machine_power_off
c_func
(paren
r_void
)paren
(brace
)brace
DECL|function|show_regs
r_void
id|show_regs
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|flags
op_assign
id|condition_codes
c_func
(paren
id|regs
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;pc : [&lt;%08lx&gt;]    lr : [&lt;%08lx&gt;]&bslash;n&quot;
l_string|&quot;sp : %08lx  ip : %08lx  fp : %08lx&bslash;n&quot;
comma
id|instruction_pointer
c_func
(paren
id|regs
)paren
comma
id|regs-&gt;ARM_lr
comma
id|regs-&gt;ARM_sp
comma
id|regs-&gt;ARM_ip
comma
id|regs-&gt;ARM_fp
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;r10: %08lx  r9 : %08lx  r8 : %08lx&bslash;n&quot;
comma
id|regs-&gt;ARM_r10
comma
id|regs-&gt;ARM_r9
comma
id|regs-&gt;ARM_r8
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;r7 : %08lx  r6 : %08lx  r5 : %08lx  r4 : %08lx&bslash;n&quot;
comma
id|regs-&gt;ARM_r7
comma
id|regs-&gt;ARM_r6
comma
id|regs-&gt;ARM_r5
comma
id|regs-&gt;ARM_r4
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;r3 : %08lx  r2 : %08lx  r1 : %08lx  r0 : %08lx&bslash;n&quot;
comma
id|regs-&gt;ARM_r3
comma
id|regs-&gt;ARM_r2
comma
id|regs-&gt;ARM_r1
comma
id|regs-&gt;ARM_r0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Flags: %c%c%c%c&quot;
comma
id|flags
op_amp
id|CC_N_BIT
ques
c_cond
l_char|&squot;N&squot;
suffix:colon
l_char|&squot;n&squot;
comma
id|flags
op_amp
id|CC_Z_BIT
ques
c_cond
l_char|&squot;Z&squot;
suffix:colon
l_char|&squot;z&squot;
comma
id|flags
op_amp
id|CC_C_BIT
ques
c_cond
l_char|&squot;C&squot;
suffix:colon
l_char|&squot;c&squot;
comma
id|flags
op_amp
id|CC_V_BIT
ques
c_cond
l_char|&squot;V&squot;
suffix:colon
l_char|&squot;v&squot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  IRQs %s  FIQs %s  Mode %s  Segment %s&bslash;n&quot;
comma
id|interrupts_enabled
c_func
(paren
id|regs
)paren
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
comma
id|fast_interrupts_enabled
c_func
(paren
id|regs
)paren
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
comma
id|processor_modes
(braket
id|processor_mode
c_func
(paren
id|regs
)paren
)braket
comma
id|get_fs
c_func
(paren
)paren
op_eq
id|get_ds
c_func
(paren
)paren
ques
c_cond
l_string|&quot;kernel&quot;
suffix:colon
l_string|&quot;user&quot;
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_CPU_32)
(brace
r_int
id|ctrl
comma
id|transbase
comma
id|dac
suffix:semicolon
id|__asm__
(paren
l_string|&quot;&t;mrc p15, 0, %0, c1, c0&bslash;n&quot;
l_string|&quot;&t;mrc p15, 0, %1, c2, c0&bslash;n&quot;
l_string|&quot;&t;mrc p15, 0, %2, c3, c0&bslash;n&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|ctrl
)paren
comma
l_string|&quot;=r&quot;
(paren
id|transbase
)paren
comma
l_string|&quot;=r&quot;
(paren
id|dac
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Control: %04X  Table: %08X  DAC: %08X&bslash;n&quot;
comma
id|ctrl
comma
id|transbase
comma
id|dac
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
multiline_comment|/*&n; * Free current thread data structures etc..&n; */
DECL|function|exit_thread
r_void
id|exit_thread
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|last_task_used_math
op_eq
id|current
)paren
id|last_task_used_math
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|flush_thread
r_void
id|flush_thread
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|current-&gt;debugreg
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|last_task_used_math
op_eq
id|current
)paren
id|last_task_used_math
op_assign
l_int|NULL
suffix:semicolon
id|current-&gt;used_math
op_assign
l_int|0
suffix:semicolon
id|current-&gt;flags
op_and_assign
op_complement
id|PF_USEDFPU
suffix:semicolon
)brace
DECL|function|release_thread
r_void
id|release_thread
c_func
(paren
r_struct
id|task_struct
op_star
id|dead_task
)paren
(brace
)brace
DECL|function|copy_thread
r_int
id|copy_thread
c_func
(paren
r_int
id|nr
comma
r_int
r_int
id|clone_flags
comma
r_int
r_int
id|esp
comma
r_struct
id|task_struct
op_star
id|p
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|pt_regs
op_star
id|childregs
suffix:semicolon
r_struct
id|context_save_struct
op_star
id|save
suffix:semicolon
id|childregs
op_assign
(paren
(paren
r_struct
id|pt_regs
op_star
)paren
(paren
(paren
r_int
r_int
)paren
id|p
op_plus
l_int|8192
)paren
)paren
op_minus
l_int|1
suffix:semicolon
op_star
id|childregs
op_assign
op_star
id|regs
suffix:semicolon
id|childregs-&gt;ARM_r0
op_assign
l_int|0
suffix:semicolon
id|save
op_assign
(paren
(paren
r_struct
id|context_save_struct
op_star
)paren
(paren
id|childregs
)paren
)paren
op_minus
l_int|1
suffix:semicolon
id|copy_thread_css
(paren
id|save
)paren
suffix:semicolon
id|p-&gt;tss.save
op_assign
id|save
suffix:semicolon
multiline_comment|/*&n;&t; * Save current math state in p-&gt;tss.fpe_save if not already there.&n;&t; */
r_if
c_cond
(paren
id|last_task_used_math
op_eq
id|current
)paren
id|fpe_save
(paren
op_amp
id|p-&gt;tss.fpstate.soft
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * fill in the fpe structure for a core dump...&n; */
DECL|function|dump_fpu
r_int
id|dump_fpu
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_struct
id|user_fp
op_star
id|fp
)paren
(brace
r_int
id|fpvalid
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;used_math
)paren
(brace
r_if
c_cond
(paren
id|last_task_used_math
op_eq
id|current
)paren
id|fpe_save
(paren
op_amp
id|current-&gt;tss.fpstate.soft
)paren
suffix:semicolon
id|memcpy
(paren
id|fp
comma
op_amp
id|current-&gt;tss.fpstate.soft
comma
r_sizeof
(paren
id|fp
)paren
)paren
suffix:semicolon
)brace
r_return
id|fpvalid
suffix:semicolon
)brace
multiline_comment|/*&n; * fill in the user structure for a core dump..&n; */
DECL|function|dump_thread
r_void
id|dump_thread
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_struct
id|user
op_star
id|dump
)paren
(brace
r_int
id|i
suffix:semicolon
id|dump-&gt;magic
op_assign
id|CMAGIC
suffix:semicolon
id|dump-&gt;start_code
op_assign
id|current-&gt;mm-&gt;start_code
suffix:semicolon
id|dump-&gt;start_stack
op_assign
id|regs-&gt;ARM_sp
op_amp
op_complement
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|dump-&gt;u_tsize
op_assign
(paren
id|current-&gt;mm-&gt;end_code
op_minus
id|current-&gt;mm-&gt;start_code
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
id|dump-&gt;u_dsize
op_assign
(paren
id|current-&gt;mm-&gt;brk
op_minus
id|current-&gt;mm-&gt;start_data
op_plus
id|PAGE_SIZE
op_minus
l_int|1
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
id|dump-&gt;u_ssize
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|dump-&gt;u_debugreg
(braket
id|i
)braket
op_assign
id|current-&gt;debugreg
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dump-&gt;start_stack
OL
l_int|0x04000000
)paren
id|dump-&gt;u_ssize
op_assign
(paren
l_int|0x04000000
op_minus
id|dump-&gt;start_stack
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
id|dump-&gt;regs
op_assign
op_star
id|regs
suffix:semicolon
id|dump-&gt;u_fpvalid
op_assign
id|dump_fpu
(paren
id|regs
comma
op_amp
id|dump-&gt;u_fp
)paren
suffix:semicolon
)brace
eof
