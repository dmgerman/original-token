multiline_comment|/*&n; * arch/arm/kernel/dma-ebsa285.c&n; *&n; * Copyright (C) 1998 Phil Blundell&n; *&n; * DMA functions specific to EBSA-285/CATS architectures&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/mman.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &quot;dma.h&quot;
multiline_comment|/* 8237 DMA controllers */
DECL|macro|IO_DMA1_BASE
mdefine_line|#define IO_DMA1_BASE&t;0x00&t;/* 8 bit slave DMA, channels 0..3 */
DECL|macro|IO_DMA2_BASE
mdefine_line|#define IO_DMA2_BASE&t;0xC0&t;/* 16 bit master DMA, ch 4(=slave input)..7 */
multiline_comment|/* 8237 DMA controller registers */
DECL|macro|DMA1_CMD_REG
mdefine_line|#define DMA1_CMD_REG&t;&t;0x08&t;/* command register (w) */
DECL|macro|DMA1_STAT_REG
mdefine_line|#define DMA1_STAT_REG&t;&t;0x08&t;/* status register (r) */
DECL|macro|DMA1_REQ_REG
mdefine_line|#define DMA1_REQ_REG            0x09    /* request register (w) */
DECL|macro|DMA1_MASK_REG
mdefine_line|#define DMA1_MASK_REG&t;&t;0x0A&t;/* single-channel mask (w) */
DECL|macro|DMA1_MODE_REG
mdefine_line|#define DMA1_MODE_REG&t;&t;0x0B&t;/* mode register (w) */
DECL|macro|DMA1_CLEAR_FF_REG
mdefine_line|#define DMA1_CLEAR_FF_REG&t;0x0C&t;/* clear pointer flip-flop (w) */
DECL|macro|DMA1_TEMP_REG
mdefine_line|#define DMA1_TEMP_REG           0x0D    /* Temporary Register (r) */
DECL|macro|DMA1_RESET_REG
mdefine_line|#define DMA1_RESET_REG&t;&t;0x0D&t;/* Master Clear (w) */
DECL|macro|DMA1_CLR_MASK_REG
mdefine_line|#define DMA1_CLR_MASK_REG       0x0E    /* Clear Mask */
DECL|macro|DMA1_MASK_ALL_REG
mdefine_line|#define DMA1_MASK_ALL_REG       0x0F    /* all-channels mask (w) */
DECL|macro|DMA2_CMD_REG
mdefine_line|#define DMA2_CMD_REG&t;&t;0xD0&t;/* command register (w) */
DECL|macro|DMA2_STAT_REG
mdefine_line|#define DMA2_STAT_REG&t;&t;0xD0&t;/* status register (r) */
DECL|macro|DMA2_REQ_REG
mdefine_line|#define DMA2_REQ_REG            0xD2    /* request register (w) */
DECL|macro|DMA2_MASK_REG
mdefine_line|#define DMA2_MASK_REG&t;&t;0xD4&t;/* single-channel mask (w) */
DECL|macro|DMA2_MODE_REG
mdefine_line|#define DMA2_MODE_REG&t;&t;0xD6&t;/* mode register (w) */
DECL|macro|DMA2_CLEAR_FF_REG
mdefine_line|#define DMA2_CLEAR_FF_REG&t;0xD8&t;/* clear pointer flip-flop (w) */
DECL|macro|DMA2_TEMP_REG
mdefine_line|#define DMA2_TEMP_REG           0xDA    /* Temporary Register (r) */
DECL|macro|DMA2_RESET_REG
mdefine_line|#define DMA2_RESET_REG&t;&t;0xDA&t;/* Master Clear (w) */
DECL|macro|DMA2_CLR_MASK_REG
mdefine_line|#define DMA2_CLR_MASK_REG       0xDC    /* Clear Mask */
DECL|macro|DMA2_MASK_ALL_REG
mdefine_line|#define DMA2_MASK_ALL_REG       0xDE    /* all-channels mask (w) */
DECL|function|arch_request_dma
r_int
id|arch_request_dma
c_func
(paren
id|dmach_t
id|channel
comma
id|dma_t
op_star
id|dma
comma
r_const
r_char
op_star
id|dev_name
)paren
(brace
multiline_comment|/* 21285 internal channels */
r_if
c_cond
(paren
id|channel
op_eq
l_int|0
op_logical_or
id|channel
op_eq
l_int|1
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* ISA channels */
singleline_comment|//&t;if (machine_is_cats() &amp;&amp; ((channel &gt;= 2 &amp;&amp; channel &lt;= 5) ||
singleline_comment|//&t;&t;(channel &gt;= 7 &amp;&amp; channel &lt;= 9)))
singleline_comment|//&t;&t;return 0;
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|arch_free_dma
r_void
id|arch_free_dma
c_func
(paren
id|dmach_t
id|channel
comma
id|dma_t
op_star
id|dma
)paren
(brace
multiline_comment|/* nothing to do */
)brace
DECL|function|arch_get_dma_residue
r_int
id|arch_get_dma_residue
c_func
(paren
id|dmach_t
id|channel
comma
id|dma_t
op_star
id|dma
)paren
(brace
r_int
id|residue
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|channel
)paren
(brace
r_case
l_int|0
suffix:colon
r_case
l_int|1
suffix:colon
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_CATS
r_case
l_int|2
suffix:colon
r_case
l_int|3
suffix:colon
r_case
l_int|4
suffix:colon
r_case
l_int|5
suffix:colon
r_case
l_int|6
suffix:colon
r_case
l_int|7
suffix:colon
r_case
l_int|8
suffix:colon
r_case
l_int|9
suffix:colon
macro_line|#endif
)brace
r_return
id|residue
suffix:semicolon
)brace
DECL|function|arch_enable_dma
r_void
id|arch_enable_dma
c_func
(paren
id|dmach_t
id|channel
comma
id|dma_t
op_star
id|dma
)paren
(brace
r_switch
c_cond
(paren
id|channel
)paren
(brace
r_case
l_int|0
suffix:colon
r_case
l_int|1
suffix:colon
multiline_comment|/*&n;&t;&t; * Not yet implemented&n;&t;&t; */
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_CATS
r_case
l_int|2
suffix:colon
r_case
l_int|3
suffix:colon
r_case
l_int|4
suffix:colon
r_case
l_int|5
suffix:colon
r_case
l_int|7
suffix:colon
r_case
l_int|8
suffix:colon
r_case
l_int|9
suffix:colon
r_if
c_cond
(paren
id|dma-&gt;invalid
)paren
(brace
r_static
r_int
r_char
id|dma_page
(braket
)braket
op_assign
(brace
l_int|0x87
comma
l_int|0x83
comma
l_int|0x81
comma
l_int|0x82
comma
l_int|0x00
comma
l_int|0x8b
comma
l_int|0x89
comma
l_int|0x8a
)brace
suffix:semicolon
r_int
r_int
r_int
id|address
op_assign
id|dma-&gt;buf.address
comma
id|length
op_assign
id|dma-&gt;buf.length
op_minus
l_int|1
suffix:semicolon
id|outb
c_func
(paren
id|address
op_rshift
l_int|24
comma
id|dma_page
(braket
id|channel
op_minus
id|DMA_ISA_BASE
)braket
op_or
l_int|0x400
)paren
suffix:semicolon
id|outb
c_func
(paren
id|address
op_rshift
l_int|16
comma
id|dma_page
(braket
id|channel
op_minus
id|DMA_ISA_BASE
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|channel
op_ge
id|DMA_ISA_BASE
op_plus
l_int|5
)paren
(brace
id|outb
c_func
(paren
l_int|0
comma
id|DMA2_CLEAR_FF_REG
)paren
suffix:semicolon
id|outb
c_func
(paren
id|address
op_rshift
l_int|1
comma
id|IO_DMA2_BASE
op_plus
(paren
(paren
id|channel
op_minus
id|DMA_ISA_BASE
op_minus
l_int|4
)paren
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|address
op_rshift
l_int|9
comma
id|IO_DMA2_BASE
op_plus
(paren
(paren
id|channel
op_minus
id|DMA_ISA_BASE
op_minus
l_int|4
)paren
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|length
op_rshift
l_int|1
)paren
op_amp
l_int|0xfe
comma
id|IO_DMA2_BASE
op_plus
l_int|1
op_plus
(paren
(paren
id|channel
op_minus
id|DMA_ISA_BASE
op_minus
l_int|4
)paren
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|length
op_rshift
l_int|9
comma
id|IO_DMA2_BASE
op_plus
l_int|1
op_plus
(paren
(paren
id|channel
op_minus
id|DMA_ISA_BASE
op_minus
l_int|4
)paren
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|dma-&gt;dma_mode
op_or
(paren
id|channel
op_minus
id|DMA_ISA_BASE
op_minus
l_int|4
)paren
comma
id|DMA2_MODE_REG
)paren
suffix:semicolon
)brace
r_else
(brace
id|outb
c_func
(paren
l_int|0
comma
id|DMA1_CLEAR_FF_REG
)paren
suffix:semicolon
id|outb
c_func
(paren
id|address
op_rshift
l_int|0
comma
id|IO_DMA1_BASE
op_plus
(paren
(paren
id|channel
op_minus
id|DMA_ISA_BASE
)paren
op_lshift
l_int|1
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|address
op_rshift
l_int|8
comma
id|IO_DMA1_BASE
op_plus
(paren
(paren
id|channel
op_minus
id|DMA_ISA_BASE
)paren
op_lshift
l_int|1
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|length
op_rshift
l_int|0
comma
id|IO_DMA1_BASE
op_plus
l_int|1
op_plus
(paren
(paren
id|channel
op_minus
id|DMA_ISA_BASE
)paren
op_lshift
l_int|1
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|length
op_rshift
l_int|8
comma
id|IO_DMA1_BASE
op_plus
l_int|1
op_plus
(paren
(paren
id|channel
op_minus
id|DMA_ISA_BASE
)paren
op_lshift
l_int|1
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|dma-&gt;dma_mode
op_or
(paren
id|channel
op_minus
id|DMA_ISA_BASE
)paren
comma
id|DMA1_MODE_REG
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|dma-&gt;dma_mode
)paren
(brace
r_case
id|DMA_MODE_READ
suffix:colon
id|dma_cache_inv
c_func
(paren
id|__bus_to_virt
c_func
(paren
id|address
)paren
comma
id|length
op_plus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DMA_MODE_WRITE
suffix:colon
id|dma_cache_wback
c_func
(paren
id|__bus_to_virt
c_func
(paren
id|address
)paren
comma
id|length
op_plus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dma-&gt;invalid
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|channel
op_ge
id|DMA_ISA_BASE
op_plus
l_int|5
)paren
id|outb
c_func
(paren
id|channel
op_minus
id|DMA_ISA_BASE
op_minus
l_int|4
comma
id|DMA2_MASK_REG
)paren
suffix:semicolon
r_else
id|outb
c_func
(paren
id|channel
op_minus
id|DMA_ISA_BASE
comma
id|DMA1_MASK_REG
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
DECL|function|arch_disable_dma
r_void
id|arch_disable_dma
c_func
(paren
id|dmach_t
id|channel
comma
id|dma_t
op_star
id|dma
)paren
(brace
r_switch
c_cond
(paren
id|channel
)paren
(brace
r_case
l_int|0
suffix:colon
r_case
l_int|1
suffix:colon
multiline_comment|/*&n;&t;&t; * Not yet implemented&n;&t;&t; */
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_CATS
r_case
l_int|2
suffix:colon
r_case
l_int|3
suffix:colon
r_case
l_int|4
suffix:colon
r_case
l_int|5
suffix:colon
r_case
l_int|6
suffix:colon
r_case
l_int|7
suffix:colon
r_case
l_int|8
suffix:colon
r_case
l_int|9
suffix:colon
r_if
c_cond
(paren
id|channel
op_ge
id|DMA_ISA_BASE
op_plus
l_int|5
)paren
id|outb
c_func
(paren
id|channel
op_minus
id|DMA_ISA_BASE
comma
id|DMA2_MASK_REG
)paren
suffix:semicolon
r_else
id|outb
c_func
(paren
(paren
id|channel
op_minus
id|DMA_ISA_BASE
)paren
op_or
l_int|4
comma
id|DMA1_MASK_REG
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|arch_dma_init
c_func
(paren
id|dma_t
op_star
id|dma
)paren
)paren
(brace
multiline_comment|/* Nothing to do */
)brace
eof
