multiline_comment|/* &n; * Driver for PLX Technology PCI9000-series host bridge.&n; *&n; * Copyright (C) 1997, 1998, 1999, 2000 FutureTV Labs Ltd&n; */
multiline_comment|/*&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/ptrace.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/mach/pci.h&gt;
multiline_comment|/*&n; * Since the following functions are all very similar, the common parts&n; * are pulled out into these macros.&n; */
DECL|macro|PLX_CLEAR_CONFIG
mdefine_line|#define PLX_CLEAR_CONFIG&t;&t;&t;&t;&t;&t;&bslash;&n;&t;__raw_writel(0, PLX_BASE + 0xac);&t;&t;&t;&t;&bslash;&n;&t;local_irq_restore(flags); }
DECL|macro|PLX_SET_CONFIG
mdefine_line|#define PLX_SET_CONFIG&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;{ unsigned long flags;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;local_irq_save(flags);&t;&t;&t;&t;&t;&t;&bslash;&n;&t;__raw_writel((1&lt;&lt;31 | (dev-&gt;bus-&gt;number &lt;&lt; 16)&t;&t;&t;&bslash;&n;&t;&t;| (dev-&gt;devfn &lt;&lt; 8) | (where &amp; ~3)&t;&t;&t;&bslash;&n;&t;&t;| ((dev-&gt;bus-&gt;number == 0)?0:1)), PLX_BASE + 0xac);&t;&bslash;&n;
DECL|macro|PLX_CONFIG_WRITE
mdefine_line|#define PLX_CONFIG_WRITE(size)&t;&t;&t;&t;&t;&t;&bslash;&n;&t;PLX_SET_CONFIG&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;__raw_write##size(value, PCIO_BASE + (where &amp; 3));&t;&t;&bslash;&n;&t;if (__raw_readw(PLX_BASE + 0x6) &amp; 0x2000)&t;&t;&t;&bslash;&n;&t;&t;__raw_writew(0x2000, PLX_BASE + 0x6);&t;&t;&t;&bslash;&n;&t;PLX_CLEAR_CONFIG&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return PCIBIOS_SUCCESSFUL;
DECL|macro|PLX_CONFIG_READ
mdefine_line|#define PLX_CONFIG_READ(size)&t;&t;&t;&t;&t;&t;&bslash;&n;&t;PLX_SET_CONFIG&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;*value = __raw_read##size(PCIO_BASE + (where &amp; 3));&t;&t;&bslash;&n;&t;if (__raw_readw(PLX_BASE + 0x6) &amp; 0x2000) {&t;&t;&t;&bslash;&n;&t;&t;__raw_writew(0x2000, PLX_BASE + 0x6);&t;&t;&t;&bslash;&n;&t;&t;*value = 0xffffffffUL;&t;&t;&t;&t;&t;&bslash;&n;&t;}&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;PLX_CLEAR_CONFIG&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return PCIBIOS_SUCCESSFUL;
multiline_comment|/* Configuration space access routines */
r_static
r_int
DECL|function|plx90x0_read_config_byte
id|plx90x0_read_config_byte
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u8
op_star
id|value
)paren
(brace
id|PLX_CONFIG_READ
c_func
(paren
id|b
)paren
)brace
r_static
r_int
DECL|function|plx90x0_read_config_word
id|plx90x0_read_config_word
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u16
op_star
id|value
)paren
(brace
id|PLX_CONFIG_READ
c_func
(paren
id|w
)paren
)brace
r_static
r_int
DECL|function|plx90x0_read_config_dword
id|plx90x0_read_config_dword
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u32
op_star
id|value
)paren
(brace
id|PLX_CONFIG_READ
c_func
(paren
id|l
)paren
)brace
r_static
r_int
DECL|function|plx90x0_write_config_byte
id|plx90x0_write_config_byte
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u8
id|value
)paren
(brace
id|PLX_CONFIG_WRITE
c_func
(paren
id|b
)paren
)brace
r_static
r_int
DECL|function|plx90x0_write_config_word
id|plx90x0_write_config_word
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u16
id|value
)paren
(brace
id|PLX_CONFIG_WRITE
c_func
(paren
id|w
)paren
)brace
r_static
r_int
DECL|function|plx90x0_write_config_dword
id|plx90x0_write_config_dword
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u32
id|value
)paren
(brace
id|PLX_CONFIG_WRITE
c_func
(paren
id|l
)paren
)brace
r_static
r_void
DECL|function|plx_syserr_handler
id|plx_syserr_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|handle
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PLX90x0: machine check %04x (pc=%08lx)&bslash;n&quot;
comma
id|readw
c_func
(paren
id|PLX_BASE
op_plus
l_int|6
)paren
comma
id|regs-&gt;ARM_pc
)paren
suffix:semicolon
id|__raw_writew
c_func
(paren
l_int|0xf000
comma
id|PLX_BASE
op_plus
l_int|6
)paren
suffix:semicolon
)brace
r_static
r_struct
id|pci_ops
DECL|variable|plx90x0_ops
id|plx90x0_ops
op_assign
(brace
id|plx90x0_read_config_byte
comma
id|plx90x0_read_config_word
comma
id|plx90x0_read_config_dword
comma
id|plx90x0_write_config_byte
comma
id|plx90x0_write_config_word
comma
id|plx90x0_write_config_dword
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * Initialise the PCI system.&n; */
r_void
id|__init
DECL|function|plx90x0_init
id|plx90x0_init
c_func
(paren
r_struct
id|arm_sysdata
op_star
id|sysdata
)paren
(brace
r_static
r_const
r_int
r_int
r_int
id|base
op_assign
id|PLX_BASE
suffix:semicolon
r_char
op_star
id|what
suffix:semicolon
r_int
r_int
id|bar
op_assign
(paren
r_int
r_int
)paren
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|PAGE_OFFSET
)paren
suffix:semicolon
r_int
r_int
id|pci_cmd
op_assign
id|PCI_COMMAND_IO
op_or
id|PCI_COMMAND_MEMORY
op_or
id|PCI_COMMAND_MASTER
op_or
id|PCI_COMMAND_INVALIDATE
suffix:semicolon
multiline_comment|/* Have a sniff around and see which PLX device is present. */
r_int
r_int
id|id
op_assign
id|__raw_readl
c_func
(paren
id|base
op_plus
l_int|0xf0
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* This check was a good idea, but can fail.  The PLX9060 puts no&n;&t;   default value in these registers unless NB# is asserted (which it&n;&t;   isn&squot;t on these cards).  */
r_if
c_cond
(paren
(paren
id|id
op_amp
l_int|0xffff
)paren
op_ne
id|PCI_VENDOR_ID_PLX
)paren
r_return
suffix:semicolon
multiline_comment|/* Nothing found */
macro_line|#endif
multiline_comment|/* Found one - now work out what it is. */
r_switch
c_cond
(paren
id|id
op_rshift
l_int|16
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* PCI_DEVICE_ID_PLX_9060 */
id|what
op_assign
l_string|&quot;PCI9060&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_PLX_9060ES
suffix:colon
id|what
op_assign
l_string|&quot;PCI9060ES&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_PLX_9060SD
suffix:colon
id|what
op_assign
l_string|&quot;PCI9060SD&quot;
suffix:semicolon
multiline_comment|/* uhuhh.. */
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_PLX_9080
suffix:colon
id|what
op_assign
l_string|&quot;PCI9080&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;PCI: Unknown PLX device %04lx found -- ignored.&bslash;n&quot;
comma
id|id
op_rshift
l_int|16
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;PCI: PLX Technology %s host bridge found.&bslash;n&quot;
comma
id|what
)paren
suffix:semicolon
multiline_comment|/* Now set it up for both master and slave accesses. */
id|__raw_writel
c_func
(paren
l_int|0xffff0147
comma
id|base
op_plus
l_int|0x4
)paren
suffix:semicolon
id|__raw_writeb
c_func
(paren
l_int|32
comma
id|base
op_plus
l_int|0xd
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
l_int|0x8
op_or
id|bar
comma
id|base
op_plus
l_int|0x18
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
l_int|0xf8000008
comma
id|base
op_plus
l_int|0x80
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
l_int|0x40000001
comma
id|base
op_plus
l_int|0x84
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
l_int|0
comma
id|base
op_plus
l_int|0x88
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
l_int|0
comma
id|base
op_plus
l_int|0x8c
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
l_int|0x11
comma
id|base
op_plus
l_int|0x94
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
l_int|0xC3
op_plus
(paren
l_int|4
op_lshift
l_int|28
)paren
op_plus
(paren
l_int|8
op_lshift
l_int|11
)paren
op_plus
(paren
l_int|1
op_lshift
l_int|10
)paren
op_plus
(paren
l_int|1
op_lshift
l_int|24
)paren
comma
id|base
op_plus
l_int|0x98
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
l_int|0xC0000000
comma
id|base
op_plus
l_int|0x9c
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
id|PLX_MEM_START
comma
id|base
op_plus
l_int|0xa0
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
id|PLX_IO_START
comma
id|base
op_plus
l_int|0xa4
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
l_int|0x3
comma
id|base
op_plus
l_int|0xa8
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
l_int|0
comma
id|base
op_plus
l_int|0xac
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
l_int|0x10001
comma
id|base
op_plus
l_int|0xe8
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
l_int|0x8000767e
comma
id|base
op_plus
l_int|0xec
)paren
suffix:semicolon
id|request_irq
c_func
(paren
id|IRQ_SYSERR
comma
id|plx_syserr_handler
comma
l_int|0
comma
l_string|&quot;system error&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|pci_scan_bus
c_func
(paren
l_int|0
comma
op_amp
id|plx90x0_ops
comma
id|sysdata
)paren
suffix:semicolon
id|pci_cmd
op_or_assign
id|sysdata-&gt;bus
(braket
l_int|0
)braket
dot
id|features
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI: Fast back to back transfers %sabled&bslash;n&quot;
comma
(paren
id|sysdata-&gt;bus
(braket
l_int|0
)braket
dot
id|features
op_amp
id|PCI_COMMAND_FAST_BACK
)paren
ques
c_cond
l_string|&quot;en&quot;
suffix:colon
l_string|&quot;dis&quot;
)paren
suffix:semicolon
)brace
eof
