multiline_comment|/*&n; *  linux/arch/arm/kernel/dma-arc.c&n; *&n; *  Copyright (C) 1998-1999 Dave Gilbert / Russell King&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; *&n; *  DMA functions specific to Archimedes and A5000 architecture&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/fiq.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/mach-types.h&gt;
macro_line|#include &lt;asm/mach/dma.h&gt;
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(x...) printk(KERN_DEBUG x)
macro_line|#if defined(CONFIG_BLK_DEV_FD1772) || defined(CONFIG_BLK_DEV_FD1772_MODULE)
DECL|function|arc_floppy_data_enable_dma
r_static
r_void
id|arc_floppy_data_enable_dma
c_func
(paren
id|dmach_t
id|channel
comma
id|dma_t
op_star
id|dma
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;arc_floppy_data_enable_dma&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dma-&gt;dma_mode
)paren
(brace
r_case
id|DMA_MODE_READ
suffix:colon
(brace
multiline_comment|/* read */
r_extern
r_int
r_char
id|fdc1772_dma_read
comma
id|fdc1772_dma_read_end
suffix:semicolon
r_extern
r_void
id|fdc1772_setupdma
c_func
(paren
r_int
r_int
id|count
comma
r_int
r_int
id|addr
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;enable_dma fdc1772 data read&bslash;n&quot;
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|clf
c_func
(paren
)paren
suffix:semicolon
id|memcpy
(paren
(paren
r_void
op_star
)paren
l_int|0x1c
comma
(paren
r_void
op_star
)paren
op_amp
id|fdc1772_dma_read
comma
op_amp
id|fdc1772_dma_read_end
op_minus
op_amp
id|fdc1772_dma_read
)paren
suffix:semicolon
id|fdc1772_setupdma
c_func
(paren
id|dma-&gt;buf.length
comma
id|dma-&gt;buf.address
)paren
suffix:semicolon
multiline_comment|/* Sets data pointer up */
id|enable_irq
(paren
l_int|64
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DMA_MODE_WRITE
suffix:colon
(brace
multiline_comment|/* write */
r_extern
r_int
r_char
id|fdc1772_dma_write
comma
id|fdc1772_dma_write_end
suffix:semicolon
r_extern
r_void
id|fdc1772_setupdma
c_func
(paren
r_int
r_int
id|count
comma
r_int
r_int
id|addr
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;enable_dma fdc1772 data write&bslash;n&quot;
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|clf
c_func
(paren
)paren
suffix:semicolon
id|memcpy
(paren
(paren
r_void
op_star
)paren
l_int|0x1c
comma
(paren
r_void
op_star
)paren
op_amp
id|fdc1772_dma_write
comma
op_amp
id|fdc1772_dma_write_end
op_minus
op_amp
id|fdc1772_dma_write
)paren
suffix:semicolon
id|fdc1772_setupdma
c_func
(paren
id|dma-&gt;buf.length
comma
id|dma-&gt;buf.address
)paren
suffix:semicolon
multiline_comment|/* Sets data pointer up */
id|enable_irq
(paren
l_int|64
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
l_string|&quot;enable_dma: dma%d not initialised&bslash;n&quot;
comma
id|channel
)paren
suffix:semicolon
)brace
)brace
DECL|function|arc_floppy_data_get_dma_residue
r_static
r_int
id|arc_floppy_data_get_dma_residue
c_func
(paren
id|dmach_t
id|channel
comma
id|dma_t
op_star
id|dma
)paren
(brace
r_extern
r_int
r_int
id|fdc1772_bytestogo
suffix:semicolon
multiline_comment|/* 10/1/1999 DAG - I presume its the number of bytes left? */
r_return
id|fdc1772_bytestogo
suffix:semicolon
)brace
DECL|function|arc_floppy_cmdend_enable_dma
r_static
r_void
id|arc_floppy_cmdend_enable_dma
c_func
(paren
id|dmach_t
id|channel
comma
id|dma_t
op_star
id|dma
)paren
(brace
multiline_comment|/* Need to build a branch at the FIQ address */
r_extern
r_void
id|fdc1772_comendhandler
c_func
(paren
r_void
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;arc_floppy_cmdend_enable_dma&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*printk(&quot;enable_dma fdc1772 command end FIQ&bslash;n&quot;);*/
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|clf
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* B fdc1772_comendhandler */
op_star
(paren
(paren
r_int
r_int
op_star
)paren
l_int|0x1c
)paren
op_assign
l_int|0xea000000
op_or
(paren
(paren
(paren
r_int
r_int
)paren
id|fdc1772_comendhandler
op_minus
(paren
l_int|0x1c
op_plus
l_int|8
)paren
)paren
op_div
l_int|4
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|arc_floppy_cmdend_get_dma_residue
r_static
r_int
id|arc_floppy_cmdend_get_dma_residue
c_func
(paren
id|dmach_t
id|channel
comma
id|dma_t
op_star
id|dma
)paren
(brace
multiline_comment|/* 10/1/1999 DAG - Presume whether there is an outstanding command? */
r_extern
r_int
r_int
id|fdc1772_fdc_int_done
suffix:semicolon
op_star
id|Explicit
op_logical_neg
id|If
id|the
r_int
id|done
id|is
l_int|0
id|then
l_int|1
r_int
id|to
id|go
op_star
op_div
r_return
(paren
id|fdc1772_fdc_int_done
op_eq
l_int|0
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|function|arc_disable_dma
r_static
r_void
id|arc_disable_dma
c_func
(paren
id|dmach_t
id|channel
comma
id|dma_t
op_star
id|dma
)paren
(brace
id|disable_irq
c_func
(paren
id|dma-&gt;dma_irq
)paren
suffix:semicolon
)brace
DECL|variable|arc_floppy_data_dma_ops
r_static
r_struct
id|dma_ops
id|arc_floppy_data_dma_ops
op_assign
(brace
id|type
suffix:colon
l_string|&quot;FIQDMA&quot;
comma
id|enable
suffix:colon
id|arc_floppy_data_enable_dma
comma
id|disable
suffix:colon
id|arc_disable_dma
comma
id|residue
suffix:colon
id|arc_floppy_data_get_dma_residue
comma
)brace
suffix:semicolon
DECL|variable|arc_floppy_cmdend_dma_ops
r_static
r_struct
id|dma_ops
id|arc_floppy_cmdend_dma_ops
op_assign
(brace
id|type
suffix:colon
l_string|&quot;FIQCMD&quot;
comma
id|enable
suffix:colon
id|arc_floppy_cmdend_enable_dma
comma
id|disable
suffix:colon
id|arc_disable_dma
comma
id|residue
suffix:colon
id|arc_floppy_cmdend_get_dma_residue
comma
)brace
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ARCH_A5K
DECL|variable|fh
r_static
r_struct
id|fiq_handler
id|fh
op_assign
(brace
id|name
suffix:colon
l_string|&quot;floppydata&quot;
)brace
suffix:semicolon
DECL|function|a5k_floppy_get_dma_residue
r_static
r_int
id|a5k_floppy_get_dma_residue
c_func
(paren
id|dmach_t
id|channel
comma
id|dma_t
op_star
id|dma
)paren
(brace
r_struct
id|pt_regs
id|regs
suffix:semicolon
id|get_fiq_regs
c_func
(paren
op_amp
id|regs
)paren
suffix:semicolon
r_return
id|regs.ARM_r9
suffix:semicolon
)brace
DECL|function|a5k_floppy_enable_dma
r_static
r_void
id|a5k_floppy_enable_dma
c_func
(paren
id|dmach_t
id|channel
comma
id|dma_t
op_star
id|dma
)paren
(brace
r_struct
id|pt_regs
id|regs
suffix:semicolon
r_void
op_star
id|fiqhandler_start
suffix:semicolon
r_int
r_int
id|fiqhandler_length
suffix:semicolon
r_extern
r_void
id|floppy_fiqsetup
c_func
(paren
r_int
r_int
id|len
comma
r_int
r_int
id|addr
comma
r_int
r_int
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma-&gt;dma_mode
op_eq
id|DMA_MODE_READ
)paren
(brace
r_extern
r_int
r_char
id|floppy_fiqin_start
comma
id|floppy_fiqin_end
suffix:semicolon
id|fiqhandler_start
op_assign
op_amp
id|floppy_fiqin_start
suffix:semicolon
id|fiqhandler_length
op_assign
op_amp
id|floppy_fiqin_end
op_minus
op_amp
id|floppy_fiqin_start
suffix:semicolon
)brace
r_else
(brace
r_extern
r_int
r_char
id|floppy_fiqout_start
comma
id|floppy_fiqout_end
suffix:semicolon
id|fiqhandler_start
op_assign
op_amp
id|floppy_fiqout_start
suffix:semicolon
id|fiqhandler_length
op_assign
op_amp
id|floppy_fiqout_end
op_minus
op_amp
id|floppy_fiqout_start
suffix:semicolon
)brace
r_if
c_cond
(paren
id|claim_fiq
c_func
(paren
op_amp
id|fh
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;floppydma: couldn&squot;t claim FIQ.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
l_int|0x1c
comma
id|fiqhandler_start
comma
id|fiqhandler_length
)paren
suffix:semicolon
id|regs.ARM_r9
op_assign
id|dma-&gt;buf.length
suffix:semicolon
id|regs.ARM_r10
op_assign
id|dma-&gt;buf.address
suffix:semicolon
id|regs.ARM_fp
op_assign
id|FLOPPYDMA_BASE
suffix:semicolon
id|set_fiq_regs
c_func
(paren
op_amp
id|regs
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|dma-&gt;dma_irq
)paren
suffix:semicolon
)brace
DECL|function|a5k_floppy_disable_dma
r_static
r_void
id|a5k_floppy_disable_dma
c_func
(paren
id|dmach_t
id|channel
comma
id|dma_t
op_star
id|dma
)paren
(brace
id|disable_irq
c_func
(paren
id|dma-&gt;dma_irq
)paren
suffix:semicolon
id|release_fiq
c_func
(paren
op_amp
id|fh
)paren
suffix:semicolon
)brace
DECL|variable|a5k_floppy_dma_ops
r_static
r_struct
id|dma_ops
id|a5k_floppy_dma_ops
op_assign
(brace
id|type
suffix:colon
l_string|&quot;FIQDMA&quot;
comma
id|enable
suffix:colon
id|a5k_floppy_enable_dma
comma
id|disable
suffix:colon
id|a5k_floppy_disable_dma
comma
id|residue
suffix:colon
id|a5k_floppy_get_dma_residue
comma
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * This is virtual DMA - we don&squot;t need anything here&n; */
DECL|function|sound_enable_disable_dma
r_static
r_void
id|sound_enable_disable_dma
c_func
(paren
id|dmach_t
id|channel
comma
id|dma_t
op_star
id|dma
)paren
(brace
)brace
DECL|variable|sound_dma_ops
r_static
r_struct
id|dma_ops
id|sound_dma_ops
op_assign
(brace
id|type
suffix:colon
l_string|&quot;VIRTUAL&quot;
comma
id|enable
suffix:colon
id|sound_enable_disable_dma
comma
id|disable
suffix:colon
id|sound_enable_disable_dma
comma
)brace
suffix:semicolon
DECL|function|arch_dma_init
r_void
id|__init
id|arch_dma_init
c_func
(paren
id|dma_t
op_star
id|dma
)paren
(brace
macro_line|#if defined(CONFIG_BLK_DEV_FD1772) || defined(CONFIG_BLK_DEV_FD1772_MODULE)
r_if
c_cond
(paren
id|machine_is_archimedes
c_func
(paren
)paren
)paren
(brace
id|dma
(braket
id|DMA_VIRTUAL_FLOPPY0
)braket
dot
id|dma_irq
op_assign
l_int|64
suffix:semicolon
id|dma
(braket
id|DMA_VIRTUAL_FLOPPY0
)braket
dot
id|d_ops
op_assign
op_amp
id|arc_floppy_data_dma_ops
suffix:semicolon
id|dma
(braket
id|DMA_VIRTUAL_FLOPPY1
)braket
dot
id|dma_irq
op_assign
l_int|65
suffix:semicolon
id|dma
(braket
id|DMA_VIRTUAL_FLOPPY1
)braket
dot
id|d_ops
op_assign
op_amp
id|arc_floppy_cmdend_dma_ops
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_ARCH_A5K
r_if
c_cond
(paren
id|machine_is_a5k
c_func
(paren
)paren
)paren
(brace
id|dma
(braket
id|DMA_VIRTUAL_FLOPPY0
)braket
dot
id|dma_irq
op_assign
l_int|64
suffix:semicolon
id|dma
(braket
id|DMA_VIRTUAL_FLOPPY0
)braket
dot
id|d_ops
op_assign
op_amp
id|a5k_floppy_dma_ops
suffix:semicolon
)brace
macro_line|#endif
id|dma
(braket
id|DMA_VIRTUAL_SOUND
)braket
dot
id|d_ops
op_assign
op_amp
id|sound_dma_ops
suffix:semicolon
)brace
eof
