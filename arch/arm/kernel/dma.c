multiline_comment|/*&n; *  linux/arch/arm/kernel/dma.c&n; *&n; *  Copyright (C) 1995-2000 Russell King&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; *&n; *  Front-end to the DMA handling.  This handles the allocation/freeing&n; *  of DMA channels, and provides a unified interface to the machines&n; *  DMA facilities.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/mman.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/mach/dma.h&gt;
DECL|variable|dma_spin_lock
id|spinlock_t
id|dma_spin_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
macro_line|#if MAX_DMA_CHANNELS &gt; 0
DECL|variable|dma_chan
r_static
id|dma_t
id|dma_chan
(braket
id|MAX_DMA_CHANNELS
)braket
suffix:semicolon
multiline_comment|/*&n; * Get dma list for /proc/dma&n; */
DECL|function|get_dma_list
r_int
id|get_dma_list
c_func
(paren
r_char
op_star
id|buf
)paren
(brace
id|dma_t
op_star
id|dma
suffix:semicolon
r_char
op_star
id|p
op_assign
id|buf
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|dma
op_assign
id|dma_chan
suffix:semicolon
id|i
OL
id|MAX_DMA_CHANNELS
suffix:semicolon
id|i
op_increment
comma
id|dma
op_increment
)paren
r_if
c_cond
(paren
id|dma-&gt;lock
)paren
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;%2d: %14s %s&bslash;n&quot;
comma
id|i
comma
id|dma-&gt;d_ops-&gt;type
comma
id|dma-&gt;device_id
)paren
suffix:semicolon
r_return
id|p
op_minus
id|buf
suffix:semicolon
)brace
multiline_comment|/*&n; * Request DMA channel&n; *&n; * On certain platforms, we have to allocate an interrupt as well...&n; */
DECL|function|request_dma
r_int
id|request_dma
c_func
(paren
id|dmach_t
id|channel
comma
r_const
r_char
op_star
id|device_id
)paren
(brace
id|dma_t
op_star
id|dma
op_assign
id|dma_chan
op_plus
id|channel
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|channel
op_ge
id|MAX_DMA_CHANNELS
op_logical_or
op_logical_neg
id|dma-&gt;d_ops
)paren
r_goto
id|bad_dma
suffix:semicolon
r_if
c_cond
(paren
id|xchg
c_func
(paren
op_amp
id|dma-&gt;lock
comma
l_int|1
)paren
op_ne
l_int|0
)paren
r_goto
id|busy
suffix:semicolon
id|dma-&gt;device_id
op_assign
id|device_id
suffix:semicolon
id|dma-&gt;active
op_assign
l_int|0
suffix:semicolon
id|dma-&gt;invalid
op_assign
l_int|1
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dma-&gt;d_ops-&gt;request
)paren
id|ret
op_assign
id|dma-&gt;d_ops
op_member_access_from_pointer
id|request
c_func
(paren
id|channel
comma
id|dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|xchg
c_func
(paren
op_amp
id|dma-&gt;lock
comma
l_int|0
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
id|bad_dma
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dma: trying to allocate DMA%d&bslash;n&quot;
comma
id|channel
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
id|busy
suffix:colon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/*&n; * Free DMA channel&n; *&n; * On certain platforms, we have to free interrupt as well...&n; */
DECL|function|free_dma
r_void
id|free_dma
c_func
(paren
id|dmach_t
id|channel
)paren
(brace
id|dma_t
op_star
id|dma
op_assign
id|dma_chan
op_plus
id|channel
suffix:semicolon
r_if
c_cond
(paren
id|channel
op_ge
id|MAX_DMA_CHANNELS
op_logical_or
op_logical_neg
id|dma-&gt;d_ops
)paren
r_goto
id|bad_dma
suffix:semicolon
r_if
c_cond
(paren
id|dma-&gt;active
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dma%d: freeing active DMA&bslash;n&quot;
comma
id|channel
)paren
suffix:semicolon
id|dma-&gt;d_ops
op_member_access_from_pointer
id|disable
c_func
(paren
id|channel
comma
id|dma
)paren
suffix:semicolon
id|dma-&gt;active
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|xchg
c_func
(paren
op_amp
id|dma-&gt;lock
comma
l_int|0
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|dma-&gt;d_ops-&gt;free
)paren
id|dma-&gt;d_ops
op_member_access_from_pointer
id|free
c_func
(paren
id|channel
comma
id|dma
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dma%d: trying to free free DMA&bslash;n&quot;
comma
id|channel
)paren
suffix:semicolon
r_return
suffix:semicolon
id|bad_dma
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dma: trying to free DMA%d&bslash;n&quot;
comma
id|channel
)paren
suffix:semicolon
)brace
multiline_comment|/* Set DMA Scatter-Gather list&n; */
DECL|function|set_dma_sg
r_void
id|set_dma_sg
(paren
id|dmach_t
id|channel
comma
r_struct
id|scatterlist
op_star
id|sg
comma
r_int
id|nr_sg
)paren
(brace
id|dma_t
op_star
id|dma
op_assign
id|dma_chan
op_plus
id|channel
suffix:semicolon
id|dma-&gt;sg
op_assign
id|sg
suffix:semicolon
id|dma-&gt;sgcount
op_assign
id|nr_sg
suffix:semicolon
id|dma-&gt;using_sg
op_assign
l_int|1
suffix:semicolon
id|dma-&gt;invalid
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Set DMA address&n; *&n; * Copy address to the structure, and set the invalid bit&n; */
DECL|function|set_dma_addr
r_void
id|set_dma_addr
(paren
id|dmach_t
id|channel
comma
r_int
r_int
id|physaddr
)paren
(brace
id|dma_t
op_star
id|dma
op_assign
id|dma_chan
op_plus
id|channel
suffix:semicolon
r_if
c_cond
(paren
id|dma-&gt;active
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dma%d: altering DMA address while &quot;
l_string|&quot;DMA active&bslash;n&quot;
comma
id|channel
)paren
suffix:semicolon
id|dma-&gt;sg
op_assign
op_amp
id|dma-&gt;buf
suffix:semicolon
id|dma-&gt;sgcount
op_assign
l_int|1
suffix:semicolon
id|dma-&gt;buf.address
op_assign
id|bus_to_virt
c_func
(paren
id|physaddr
)paren
suffix:semicolon
id|dma-&gt;using_sg
op_assign
l_int|0
suffix:semicolon
id|dma-&gt;invalid
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Set DMA byte count&n; *&n; * Copy address to the structure, and set the invalid bit&n; */
DECL|function|set_dma_count
r_void
id|set_dma_count
(paren
id|dmach_t
id|channel
comma
r_int
r_int
id|count
)paren
(brace
id|dma_t
op_star
id|dma
op_assign
id|dma_chan
op_plus
id|channel
suffix:semicolon
r_if
c_cond
(paren
id|dma-&gt;active
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dma%d: altering DMA count while &quot;
l_string|&quot;DMA active&bslash;n&quot;
comma
id|channel
)paren
suffix:semicolon
id|dma-&gt;sg
op_assign
op_amp
id|dma-&gt;buf
suffix:semicolon
id|dma-&gt;sgcount
op_assign
l_int|1
suffix:semicolon
id|dma-&gt;buf.length
op_assign
id|count
suffix:semicolon
id|dma-&gt;using_sg
op_assign
l_int|0
suffix:semicolon
id|dma-&gt;invalid
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Set DMA direction mode&n; */
DECL|function|set_dma_mode
r_void
id|set_dma_mode
(paren
id|dmach_t
id|channel
comma
id|dmamode_t
id|mode
)paren
(brace
id|dma_t
op_star
id|dma
op_assign
id|dma_chan
op_plus
id|channel
suffix:semicolon
r_if
c_cond
(paren
id|dma-&gt;active
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dma%d: altering DMA mode while &quot;
l_string|&quot;DMA active&bslash;n&quot;
comma
id|channel
)paren
suffix:semicolon
id|dma-&gt;dma_mode
op_assign
id|mode
suffix:semicolon
id|dma-&gt;invalid
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Enable DMA channel&n; */
DECL|function|enable_dma
r_void
id|enable_dma
(paren
id|dmach_t
id|channel
)paren
(brace
id|dma_t
op_star
id|dma
op_assign
id|dma_chan
op_plus
id|channel
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dma-&gt;lock
)paren
r_goto
id|free_dma
suffix:semicolon
r_if
c_cond
(paren
id|dma-&gt;active
op_eq
l_int|0
)paren
(brace
id|dma-&gt;active
op_assign
l_int|1
suffix:semicolon
id|dma-&gt;d_ops
op_member_access_from_pointer
id|enable
c_func
(paren
id|channel
comma
id|dma
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
id|free_dma
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dma%d: trying to enable free DMA&bslash;n&quot;
comma
id|channel
)paren
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Disable DMA channel&n; */
DECL|function|disable_dma
r_void
id|disable_dma
(paren
id|dmach_t
id|channel
)paren
(brace
id|dma_t
op_star
id|dma
op_assign
id|dma_chan
op_plus
id|channel
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dma-&gt;lock
)paren
r_goto
id|free_dma
suffix:semicolon
r_if
c_cond
(paren
id|dma-&gt;active
op_eq
l_int|1
)paren
(brace
id|dma-&gt;active
op_assign
l_int|0
suffix:semicolon
id|dma-&gt;d_ops
op_member_access_from_pointer
id|disable
c_func
(paren
id|channel
comma
id|dma
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
id|free_dma
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dma%d: trying to disable free DMA&bslash;n&quot;
comma
id|channel
)paren
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|set_dma_page
r_void
id|set_dma_page
c_func
(paren
id|dmach_t
id|channel
comma
r_char
id|pagenr
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dma%d: trying to set_dma_page&bslash;n&quot;
comma
id|channel
)paren
suffix:semicolon
)brace
DECL|function|set_dma_speed
r_void
id|set_dma_speed
c_func
(paren
id|dmach_t
id|channel
comma
r_int
id|cycle_ns
)paren
(brace
id|dma_t
op_star
id|dma
op_assign
id|dma_chan
op_plus
id|channel
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dma-&gt;d_ops-&gt;setspeed
)paren
id|ret
op_assign
id|dma-&gt;d_ops
op_member_access_from_pointer
id|setspeed
c_func
(paren
id|channel
comma
id|dma
comma
id|cycle_ns
)paren
suffix:semicolon
id|dma-&gt;speed
op_assign
id|ret
suffix:semicolon
)brace
DECL|function|get_dma_residue
r_int
id|get_dma_residue
c_func
(paren
id|dmach_t
id|channel
)paren
(brace
id|dma_t
op_star
id|dma
op_assign
id|dma_chan
op_plus
id|channel
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dma-&gt;d_ops-&gt;residue
)paren
id|ret
op_assign
id|dma-&gt;d_ops
op_member_access_from_pointer
id|residue
c_func
(paren
id|channel
comma
id|dma
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|init_dma
r_void
id|__init
id|init_dma
c_func
(paren
r_void
)paren
(brace
id|arch_dma_init
c_func
(paren
id|dma_chan
)paren
suffix:semicolon
)brace
macro_line|#else
DECL|function|request_dma
r_int
id|request_dma
c_func
(paren
id|dmach_t
id|channel
comma
r_const
r_char
op_star
id|device_id
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|get_dma_residue
r_int
id|get_dma_residue
c_func
(paren
id|dmach_t
id|channel
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|GLOBAL_ALIAS
mdefine_line|#define GLOBAL_ALIAS(_a,_b) asm (&quot;.set &quot; #_a &quot;,&quot; #_b &quot;; .globl &quot; #_a)
id|GLOBAL_ALIAS
c_func
(paren
id|disable_dma
comma
id|get_dma_residue
)paren
suffix:semicolon
id|GLOBAL_ALIAS
c_func
(paren
id|enable_dma
comma
id|get_dma_residue
)paren
suffix:semicolon
id|GLOBAL_ALIAS
c_func
(paren
id|free_dma
comma
id|get_dma_residue
)paren
suffix:semicolon
id|GLOBAL_ALIAS
c_func
(paren
id|get_dma_list
comma
id|get_dma_residue
)paren
suffix:semicolon
id|GLOBAL_ALIAS
c_func
(paren
id|set_dma_mode
comma
id|get_dma_residue
)paren
suffix:semicolon
id|GLOBAL_ALIAS
c_func
(paren
id|set_dma_page
comma
id|get_dma_residue
)paren
suffix:semicolon
id|GLOBAL_ALIAS
c_func
(paren
id|set_dma_count
comma
id|get_dma_residue
)paren
suffix:semicolon
id|GLOBAL_ALIAS
c_func
(paren
id|set_dma_addr
comma
id|get_dma_residue
)paren
suffix:semicolon
id|GLOBAL_ALIAS
c_func
(paren
id|set_dma_sg
comma
id|get_dma_residue
)paren
suffix:semicolon
id|GLOBAL_ALIAS
c_func
(paren
id|set_dma_speed
comma
id|get_dma_residue
)paren
suffix:semicolon
id|GLOBAL_ALIAS
c_func
(paren
id|init_dma
comma
id|get_dma_residue
)paren
suffix:semicolon
macro_line|#endif
DECL|variable|enable_dma
id|EXPORT_SYMBOL
c_func
(paren
id|enable_dma
)paren
suffix:semicolon
DECL|variable|disable_dma
id|EXPORT_SYMBOL
c_func
(paren
id|disable_dma
)paren
suffix:semicolon
DECL|variable|set_dma_addr
id|EXPORT_SYMBOL
c_func
(paren
id|set_dma_addr
)paren
suffix:semicolon
DECL|variable|set_dma_count
id|EXPORT_SYMBOL
c_func
(paren
id|set_dma_count
)paren
suffix:semicolon
DECL|variable|set_dma_mode
id|EXPORT_SYMBOL
c_func
(paren
id|set_dma_mode
)paren
suffix:semicolon
DECL|variable|set_dma_page
id|EXPORT_SYMBOL
c_func
(paren
id|set_dma_page
)paren
suffix:semicolon
DECL|variable|get_dma_residue
id|EXPORT_SYMBOL
c_func
(paren
id|get_dma_residue
)paren
suffix:semicolon
DECL|variable|set_dma_sg
id|EXPORT_SYMBOL
c_func
(paren
id|set_dma_sg
)paren
suffix:semicolon
DECL|variable|set_dma_speed
id|EXPORT_SYMBOL
c_func
(paren
id|set_dma_speed
)paren
suffix:semicolon
eof
