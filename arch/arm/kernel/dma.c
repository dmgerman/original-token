multiline_comment|/*&n; * linux/arch/arm/kernel/dma.c&n; *&n; * Copyright (C) 1995-1998 Russell King&n; *&n; * Front-end to the DMA handling.  You must provide the following&n; * architecture-specific routines:&n; *&n; *  int arch_request_dma(dmach_t channel, dma_t *dma, const char *dev_id);&n; *  void arch_free_dma(dmach_t channel, dma_t *dma);&n; *  void arch_enable_dma(dmach_t channel, dma_t *dma);&n; *  void arch_disable_dma(dmach_t channel, dma_t *dma);&n; *  int arch_get_dma_residue(dmach_t channel, dma_t *dma);&n; *&n; * Moved DMA resource allocation here...&n; */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/mman.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &quot;dma.h&quot;
DECL|variable|dma_str
r_const
r_char
id|dma_str
(braket
)braket
op_assign
l_string|&quot;%s: dma %d not supported&bslash;n&quot;
suffix:semicolon
DECL|variable|dma_chan
r_static
id|dma_t
id|dma_chan
(braket
id|MAX_DMA_CHANNELS
)braket
suffix:semicolon
multiline_comment|/* Get dma list&n; * for /proc/dma&n; */
DECL|function|get_dma_list
r_int
id|get_dma_list
c_func
(paren
r_char
op_star
id|buf
)paren
(brace
r_int
id|i
comma
id|len
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_DMA_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|dma_chan
(braket
id|i
)braket
dot
id|lock
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;%2d: %s&bslash;n&quot;
comma
id|i
comma
id|dma_chan
(braket
id|i
)braket
dot
id|device_id
)paren
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/* Request DMA channel&n; *&n; * On certain platforms, we have to allocate an interrupt as well...&n; */
DECL|function|request_dma
r_int
id|request_dma
c_func
(paren
id|dmach_t
id|channel
comma
r_const
r_char
op_star
id|device_id
)paren
(brace
r_if
c_cond
(paren
id|channel
OL
id|MAX_DMA_CHANNELS
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|xchg
c_func
(paren
op_amp
id|dma_chan
(braket
id|channel
)braket
dot
id|lock
comma
l_int|1
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|ret
op_assign
id|arch_request_dma
c_func
(paren
id|channel
comma
op_amp
id|dma_chan
(braket
id|channel
)braket
comma
id|device_id
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
id|dma_chan
(braket
id|channel
)braket
dot
id|device_id
op_assign
id|device_id
suffix:semicolon
id|dma_chan
(braket
id|channel
)braket
dot
id|active
op_assign
l_int|0
suffix:semicolon
id|dma_chan
(braket
id|channel
)braket
dot
id|invalid
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|xchg
c_func
(paren
op_amp
id|dma_chan
(braket
id|channel
)braket
dot
id|lock
comma
l_int|0
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_else
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;Trying to allocate DMA%d&bslash;n&quot;
comma
id|channel
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
multiline_comment|/* Free DMA channel&n; *&n; * On certain platforms, we have to free interrupt as well...&n; */
DECL|function|free_dma
r_void
id|free_dma
c_func
(paren
id|dmach_t
id|channel
)paren
(brace
r_if
c_cond
(paren
id|channel
op_ge
id|MAX_DMA_CHANNELS
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;Trying to free DMA%d&bslash;n&quot;
comma
id|channel
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|xchg
c_func
(paren
op_amp
id|dma_chan
(braket
id|channel
)braket
dot
id|lock
comma
l_int|0
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|dma_chan
(braket
id|channel
)braket
dot
id|active
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;Freeing active DMA%d&bslash;n&quot;
comma
id|channel
)paren
suffix:semicolon
id|arch_disable_dma
c_func
(paren
id|channel
comma
op_amp
id|dma_chan
(braket
id|channel
)braket
)paren
suffix:semicolon
id|dma_chan
(braket
id|channel
)braket
dot
id|active
op_assign
l_int|0
suffix:semicolon
)brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;Trying to free free DMA%d&bslash;n&quot;
comma
id|channel
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|arch_free_dma
c_func
(paren
id|channel
comma
op_amp
id|dma_chan
(braket
id|channel
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* Set DMA Scatter-Gather list&n; */
DECL|function|set_dma_sg
r_void
id|set_dma_sg
(paren
id|dmach_t
id|channel
comma
id|dmasg_t
op_star
id|sg
comma
r_int
id|nr_sg
)paren
(brace
id|dma_chan
(braket
id|channel
)braket
dot
id|sg
op_assign
id|sg
suffix:semicolon
id|dma_chan
(braket
id|channel
)braket
dot
id|sgcount
op_assign
id|nr_sg
suffix:semicolon
id|dma_chan
(braket
id|channel
)braket
dot
id|invalid
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Set DMA address&n; *&n; * Copy address to the structure, and set the invalid bit&n; */
DECL|function|set_dma_addr
r_void
id|set_dma_addr
(paren
id|dmach_t
id|channel
comma
r_int
r_int
id|physaddr
)paren
(brace
r_if
c_cond
(paren
id|dma_chan
(braket
id|channel
)braket
dot
id|active
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;set_dma_addr: altering DMA%d&quot;
l_string|&quot; address while DMA active&bslash;n&quot;
comma
id|channel
)paren
suffix:semicolon
id|dma_chan
(braket
id|channel
)braket
dot
id|sg
op_assign
op_amp
id|dma_chan
(braket
id|channel
)braket
dot
id|buf
suffix:semicolon
id|dma_chan
(braket
id|channel
)braket
dot
id|sgcount
op_assign
l_int|1
suffix:semicolon
id|dma_chan
(braket
id|channel
)braket
dot
id|buf.address
op_assign
id|physaddr
suffix:semicolon
id|dma_chan
(braket
id|channel
)braket
dot
id|invalid
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Set DMA byte count&n; *&n; * Copy address to the structure, and set the invalid bit&n; */
DECL|function|set_dma_count
r_void
id|set_dma_count
(paren
id|dmach_t
id|channel
comma
r_int
r_int
id|count
)paren
(brace
r_if
c_cond
(paren
id|dma_chan
(braket
id|channel
)braket
dot
id|active
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;set_dma_count: altering DMA%d&quot;
l_string|&quot; count while DMA active&bslash;n&quot;
comma
id|channel
)paren
suffix:semicolon
id|dma_chan
(braket
id|channel
)braket
dot
id|sg
op_assign
op_amp
id|dma_chan
(braket
id|channel
)braket
dot
id|buf
suffix:semicolon
id|dma_chan
(braket
id|channel
)braket
dot
id|sgcount
op_assign
l_int|1
suffix:semicolon
id|dma_chan
(braket
id|channel
)braket
dot
id|buf.length
op_assign
id|count
suffix:semicolon
id|dma_chan
(braket
id|channel
)braket
dot
id|invalid
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Set DMA direction mode&n; */
DECL|function|set_dma_mode
r_void
id|set_dma_mode
(paren
id|dmach_t
id|channel
comma
id|dmamode_t
id|mode
)paren
(brace
r_if
c_cond
(paren
id|dma_chan
(braket
id|channel
)braket
dot
id|active
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;set_dma_mode: altering DMA%d&quot;
l_string|&quot; mode while DMA active&bslash;n&quot;
comma
id|channel
)paren
suffix:semicolon
id|dma_chan
(braket
id|channel
)braket
dot
id|dma_mode
op_assign
id|mode
suffix:semicolon
id|dma_chan
(braket
id|channel
)braket
dot
id|invalid
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Enable DMA channel&n; */
DECL|function|enable_dma
r_void
id|enable_dma
(paren
id|dmach_t
id|channel
)paren
(brace
r_if
c_cond
(paren
id|dma_chan
(braket
id|channel
)braket
dot
id|lock
)paren
(brace
r_if
c_cond
(paren
id|dma_chan
(braket
id|channel
)braket
dot
id|active
op_eq
l_int|0
)paren
(brace
id|dma_chan
(braket
id|channel
)braket
dot
id|active
op_assign
l_int|1
suffix:semicolon
id|arch_enable_dma
c_func
(paren
id|channel
comma
op_amp
id|dma_chan
(braket
id|channel
)braket
)paren
suffix:semicolon
)brace
)brace
r_else
id|printk
(paren
id|KERN_ERR
l_string|&quot;Trying to enable free DMA%d&bslash;n&quot;
comma
id|channel
)paren
suffix:semicolon
)brace
multiline_comment|/* Disable DMA channel&n; */
DECL|function|disable_dma
r_void
id|disable_dma
(paren
id|dmach_t
id|channel
)paren
(brace
r_if
c_cond
(paren
id|dma_chan
(braket
id|channel
)braket
dot
id|lock
)paren
(brace
r_if
c_cond
(paren
id|dma_chan
(braket
id|channel
)braket
dot
id|active
op_eq
l_int|1
)paren
(brace
id|dma_chan
(braket
id|channel
)braket
dot
id|active
op_assign
l_int|0
suffix:semicolon
id|arch_disable_dma
c_func
(paren
id|channel
comma
op_amp
id|dma_chan
(braket
id|channel
)braket
)paren
suffix:semicolon
)brace
)brace
r_else
id|printk
(paren
id|KERN_ERR
l_string|&quot;Trying to disable free DMA%d&bslash;n&quot;
comma
id|channel
)paren
suffix:semicolon
)brace
DECL|function|get_dma_residue
r_int
id|get_dma_residue
c_func
(paren
id|dmach_t
id|channel
)paren
(brace
r_return
id|arch_get_dma_residue
c_func
(paren
id|channel
comma
op_amp
id|dma_chan
(braket
id|channel
)braket
)paren
suffix:semicolon
)brace
DECL|variable|dma_str
id|EXPORT_SYMBOL
c_func
(paren
id|dma_str
)paren
suffix:semicolon
DECL|variable|enable_dma
id|EXPORT_SYMBOL
c_func
(paren
id|enable_dma
)paren
suffix:semicolon
DECL|variable|disable_dma
id|EXPORT_SYMBOL
c_func
(paren
id|disable_dma
)paren
suffix:semicolon
DECL|variable|set_dma_addr
id|EXPORT_SYMBOL
c_func
(paren
id|set_dma_addr
)paren
suffix:semicolon
DECL|variable|set_dma_count
id|EXPORT_SYMBOL
c_func
(paren
id|set_dma_count
)paren
suffix:semicolon
DECL|variable|set_dma_mode
id|EXPORT_SYMBOL
c_func
(paren
id|set_dma_mode
)paren
suffix:semicolon
DECL|variable|get_dma_residue
id|EXPORT_SYMBOL
c_func
(paren
id|get_dma_residue
)paren
suffix:semicolon
DECL|variable|set_dma_sg
id|EXPORT_SYMBOL
c_func
(paren
id|set_dma_sg
)paren
suffix:semicolon
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|init_dma
c_func
(paren
r_void
)paren
)paren
(brace
id|arch_dma_init
c_func
(paren
id|dma_chan
)paren
suffix:semicolon
)brace
eof
