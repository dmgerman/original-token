multiline_comment|/*&n; * linux/arch/arm/kernel/iic.c&n; *&n; * Copyright (C) 1995, 1996 Russell King&n; *&n; * IIC is used to get the current time from the CMOS rtc.&n; */
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
multiline_comment|/*&n; * if delay loop has been calibrated then us that,&n; * else use IOC timer 1.&n; */
DECL|function|iic_delay
r_static
r_void
id|iic_delay
(paren
r_void
)paren
(brace
r_extern
r_int
r_int
id|loops_per_sec
suffix:semicolon
r_if
c_cond
(paren
id|loops_per_sec
op_ne
(paren
l_int|1
op_lshift
l_int|12
)paren
)paren
(brace
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|254
comma
id|IOC_T1LTCHL
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|255
comma
id|IOC_T1LTCHH
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|IOC_T1GO
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|1
op_lshift
l_int|6
comma
id|IOC_IRQCLRA
)paren
suffix:semicolon
multiline_comment|/* clear T1 irq */
id|outb
c_func
(paren
l_int|4
comma
id|IOC_T1LTCHL
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|IOC_T1LTCHH
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|IOC_T1GO
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|IOC_IRQSTATA
)paren
op_amp
(paren
l_int|1
op_lshift
l_int|6
)paren
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
DECL|function|iic_start
r_static
r_inline
r_void
id|iic_start
(paren
r_void
)paren
(brace
r_int
r_char
id|out
suffix:semicolon
id|out
op_assign
id|inb
c_func
(paren
id|IOC_CONTROL
)paren
op_or
l_int|0xc2
suffix:semicolon
id|outb
c_func
(paren
id|out
comma
id|IOC_CONTROL
)paren
suffix:semicolon
id|iic_delay
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|out
op_xor
l_int|1
comma
id|IOC_CONTROL
)paren
suffix:semicolon
id|iic_delay
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|iic_stop
r_static
r_inline
r_void
id|iic_stop
(paren
r_void
)paren
(brace
r_int
r_char
id|out
suffix:semicolon
id|out
op_assign
id|inb
c_func
(paren
id|IOC_CONTROL
)paren
op_or
l_int|0xc3
suffix:semicolon
id|iic_delay
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|out
op_xor
l_int|1
comma
id|IOC_CONTROL
)paren
suffix:semicolon
id|iic_delay
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|out
comma
id|IOC_CONTROL
)paren
suffix:semicolon
)brace
DECL|function|iic_sendbyte
r_static
r_int
id|iic_sendbyte
(paren
r_int
r_char
id|b
)paren
(brace
r_int
r_char
id|out
comma
id|in
suffix:semicolon
r_int
id|i
suffix:semicolon
id|out
op_assign
(paren
id|inb
c_func
(paren
id|IOC_CONTROL
)paren
op_amp
l_int|0xfc
)paren
op_or
l_int|0xc0
suffix:semicolon
id|outb
c_func
(paren
id|out
comma
id|IOC_CONTROL
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|7
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_int
r_char
id|c
suffix:semicolon
id|c
op_assign
id|out
op_or
(paren
(paren
id|b
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|c
comma
id|IOC_CONTROL
)paren
suffix:semicolon
id|iic_delay
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|c
op_or
l_int|2
comma
id|IOC_CONTROL
)paren
suffix:semicolon
id|iic_delay
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|c
comma
id|IOC_CONTROL
)paren
suffix:semicolon
)brace
id|outb
c_func
(paren
id|out
op_or
l_int|1
comma
id|IOC_CONTROL
)paren
suffix:semicolon
id|iic_delay
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|out
op_or
l_int|3
comma
id|IOC_CONTROL
)paren
suffix:semicolon
id|iic_delay
c_func
(paren
)paren
suffix:semicolon
id|in
op_assign
id|inb
c_func
(paren
id|IOC_CONTROL
)paren
op_amp
l_int|1
suffix:semicolon
id|outb
c_func
(paren
id|out
op_or
l_int|1
comma
id|IOC_CONTROL
)paren
suffix:semicolon
id|iic_delay
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|out
comma
id|IOC_CONTROL
)paren
suffix:semicolon
id|iic_delay
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;No acknowledge from RTC&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|iic_recvbyte
r_static
r_int
r_char
id|iic_recvbyte
(paren
r_void
)paren
(brace
r_int
r_char
id|out
comma
id|in
suffix:semicolon
r_int
id|i
suffix:semicolon
id|out
op_assign
(paren
id|inb
c_func
(paren
id|IOC_CONTROL
)paren
op_amp
l_int|0xfc
)paren
op_or
l_int|0xc0
suffix:semicolon
id|outb
c_func
(paren
id|out
comma
id|IOC_CONTROL
)paren
suffix:semicolon
id|in
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|7
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|outb
c_func
(paren
id|out
op_or
l_int|1
comma
id|IOC_CONTROL
)paren
suffix:semicolon
id|iic_delay
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|out
op_or
l_int|3
comma
id|IOC_CONTROL
)paren
suffix:semicolon
id|iic_delay
c_func
(paren
)paren
suffix:semicolon
id|in
op_assign
(paren
id|in
op_lshift
l_int|1
)paren
op_or
(paren
id|inb
c_func
(paren
id|IOC_CONTROL
)paren
op_amp
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
id|out
op_or
l_int|1
comma
id|IOC_CONTROL
)paren
suffix:semicolon
id|iic_delay
c_func
(paren
)paren
suffix:semicolon
)brace
id|outb
c_func
(paren
id|out
comma
id|IOC_CONTROL
)paren
suffix:semicolon
id|iic_delay
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|out
op_or
l_int|2
comma
id|IOC_CONTROL
)paren
suffix:semicolon
id|iic_delay
c_func
(paren
)paren
suffix:semicolon
r_return
id|in
suffix:semicolon
)brace
DECL|function|iic_control
r_void
id|iic_control
(paren
r_int
r_char
id|addr
comma
r_int
r_char
id|loc
comma
r_int
r_char
op_star
id|buf
comma
r_int
id|len
)paren
(brace
id|iic_start
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iic_sendbyte
c_func
(paren
id|addr
op_amp
l_int|0xfe
)paren
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
id|iic_sendbyte
c_func
(paren
id|loc
)paren
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_amp
l_int|1
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|iic_sendbyte
(paren
id|buf
(braket
id|i
)braket
)paren
)paren
r_break
suffix:semicolon
)brace
r_else
(brace
r_int
id|i
suffix:semicolon
id|iic_stop
c_func
(paren
)paren
suffix:semicolon
id|iic_start
c_func
(paren
)paren
suffix:semicolon
id|iic_sendbyte
c_func
(paren
id|addr
op_or
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
id|buf
(braket
id|i
)braket
op_assign
id|iic_recvbyte
(paren
)paren
suffix:semicolon
)brace
id|error
suffix:colon
id|iic_stop
c_func
(paren
)paren
suffix:semicolon
)brace
eof
