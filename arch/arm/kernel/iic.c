multiline_comment|/*&n; * linux/arch/arm/kernel/iic.c&n; *&n; * Copyright (C) 1995, 1996 Russell King&n; *&n; * IIC is used to get the current time from the CMOS rtc.&n; */
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/ioc.h&gt;
DECL|macro|FORCE_ONES
mdefine_line|#define FORCE_ONES&t;0xdc
multiline_comment|/*&n; * if delay loop has been calibrated then us that,&n; * else use IOC timer 1.&n; */
DECL|function|iic_delay
r_static
r_void
id|iic_delay
c_func
(paren
r_void
)paren
(brace
r_extern
r_int
r_int
id|loops_per_sec
suffix:semicolon
r_if
c_cond
(paren
id|loops_per_sec
op_ne
(paren
l_int|1
op_lshift
l_int|12
)paren
)paren
(brace
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
multiline_comment|/* was 10 */
r_return
suffix:semicolon
)brace
r_else
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|254
comma
id|IOC_T1LTCHL
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|255
comma
id|IOC_T1LTCHH
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|IOC_T1GO
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|1
op_lshift
l_int|6
comma
id|IOC_IRQCLRA
)paren
suffix:semicolon
multiline_comment|/* clear T1 irq */
id|outb
c_func
(paren
l_int|10
comma
id|IOC_T1LTCHL
)paren
suffix:semicolon
multiline_comment|/* was 4 */
id|outb
c_func
(paren
l_int|0
comma
id|IOC_T1LTCHH
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|IOC_T1GO
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|IOC_IRQSTATA
)paren
op_amp
(paren
l_int|1
op_lshift
l_int|6
)paren
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
DECL|macro|IIC_INIT
mdefine_line|#define IIC_INIT()&t;&t;dat = (inb(IOC_CONTROL) | FORCE_ONES) &amp; ~3
DECL|macro|IIC_SET_DAT
mdefine_line|#define IIC_SET_DAT&t;&t;outb(dat|=1, IOC_CONTROL);
DECL|macro|IIC_CLR_DAT
mdefine_line|#define IIC_CLR_DAT&t;&t;outb(dat&amp;=~1, IOC_CONTROL);
DECL|macro|IIC_SET_CLK
mdefine_line|#define IIC_SET_CLK&t;&t;outb(dat|=2, IOC_CONTROL);
DECL|macro|IIC_CLR_CLK
mdefine_line|#define IIC_CLR_CLK&t;&t;outb(dat&amp;=~2, IOC_CONTROL);
DECL|macro|IIC_DELAY
mdefine_line|#define IIC_DELAY&t;&t;iic_delay();
DECL|macro|IIC_READ_DATA
mdefine_line|#define IIC_READ_DATA()&t;&t;(inb(IOC_CONTROL) &amp; 1)
DECL|function|iic_set_lines
r_static
r_inline
r_void
id|iic_set_lines
c_func
(paren
r_int
id|clk
comma
r_int
id|dat
)paren
(brace
r_int
id|old
suffix:semicolon
id|old
op_assign
id|inb
c_func
(paren
id|IOC_CONTROL
)paren
op_or
id|FORCE_ONES
suffix:semicolon
id|old
op_and_assign
op_complement
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|clk
)paren
id|old
op_or_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|dat
)paren
id|old
op_or_assign
l_int|1
suffix:semicolon
id|outb
c_func
(paren
id|old
comma
id|IOC_CONTROL
)paren
suffix:semicolon
id|iic_delay
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|iic_read_data
r_static
r_inline
r_int
r_int
id|iic_read_data
c_func
(paren
r_void
)paren
(brace
r_return
id|inb
c_func
(paren
id|IOC_CONTROL
)paren
op_amp
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * C: ==~~_&n; * D: =~~__&n; */
DECL|function|iic_start
r_static
r_inline
r_void
id|iic_start
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|dat
suffix:semicolon
id|IIC_INIT
c_func
(paren
)paren
suffix:semicolon
id|IIC_SET_DAT
id|IIC_DELAY
id|IIC_SET_CLK
id|IIC_DELAY
id|IIC_CLR_DAT
id|IIC_DELAY
id|IIC_CLR_CLK
id|IIC_DELAY
)brace
multiline_comment|/*&n; * C: __~~&n; * D: =__~&n; */
DECL|function|iic_stop
r_static
r_inline
r_void
id|iic_stop
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|dat
suffix:semicolon
id|IIC_INIT
c_func
(paren
)paren
suffix:semicolon
id|IIC_CLR_DAT
id|IIC_DELAY
id|IIC_SET_CLK
id|IIC_DELAY
id|IIC_SET_DAT
id|IIC_DELAY
)brace
multiline_comment|/*&n; * C: __~_&n; * D: =___&n; */
DECL|function|iic_acknowledge
r_static
r_inline
r_void
id|iic_acknowledge
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|dat
suffix:semicolon
id|IIC_INIT
c_func
(paren
)paren
suffix:semicolon
id|IIC_CLR_DAT
id|IIC_DELAY
id|IIC_SET_CLK
id|IIC_DELAY
id|IIC_CLR_CLK
id|IIC_DELAY
)brace
multiline_comment|/*&n; * C: __~_&n; * D: =~H~&n; */
DECL|function|iic_is_acknowledged
r_static
r_inline
r_int
id|iic_is_acknowledged
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|dat
comma
id|ack_bit
suffix:semicolon
id|IIC_INIT
c_func
(paren
)paren
suffix:semicolon
id|IIC_SET_DAT
id|IIC_DELAY
id|IIC_SET_CLK
id|IIC_DELAY
id|ack_bit
op_assign
id|IIC_READ_DATA
c_func
(paren
)paren
suffix:semicolon
id|IIC_CLR_CLK
id|IIC_DELAY
r_return
id|ack_bit
op_eq
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * C: _~__~__~__~__~__~__~__~_&n; * D: =DDXDDXDDXDDXDDXDDXDDXDD&n; */
DECL|function|iic_sendbyte
r_static
r_void
id|iic_sendbyte
c_func
(paren
r_int
r_int
id|b
)paren
(brace
r_int
r_int
id|dat
comma
id|i
suffix:semicolon
id|IIC_INIT
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|b
op_amp
l_int|128
)paren
id|IIC_SET_DAT
r_else
id|IIC_CLR_DAT
id|IIC_DELAY
id|IIC_SET_CLK
id|IIC_DELAY
id|IIC_CLR_CLK
id|IIC_DELAY
id|b
op_lshift_assign
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * C: __~_~_~_~_~_~_~_~_&n; * D: =~HHHHHHHHHHHHHHHH&n; */
DECL|function|iic_recvbyte
r_static
r_int
r_char
id|iic_recvbyte
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|dat
comma
id|i
comma
id|in
suffix:semicolon
id|IIC_INIT
c_func
(paren
)paren
suffix:semicolon
id|IIC_SET_DAT
id|IIC_DELAY
id|in
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|IIC_SET_CLK
id|IIC_DELAY
id|in
op_assign
(paren
id|in
op_lshift
l_int|1
)paren
op_or
id|IIC_READ_DATA
c_func
(paren
)paren
suffix:semicolon
id|IIC_CLR_CLK
id|IIC_DELAY
)brace
r_return
id|in
suffix:semicolon
)brace
DECL|function|iic_control
r_int
id|iic_control
(paren
r_int
r_char
id|addr
comma
r_int
r_char
id|loc
comma
r_int
r_char
op_star
id|buf
comma
r_int
id|len
)paren
(brace
r_int
id|i
comma
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
id|iic_start
c_func
(paren
)paren
suffix:semicolon
id|iic_sendbyte
c_func
(paren
id|addr
op_amp
l_int|0xfe
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iic_is_acknowledged
c_func
(paren
)paren
)paren
r_goto
id|error
suffix:semicolon
id|iic_sendbyte
c_func
(paren
id|loc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iic_is_acknowledged
c_func
(paren
)paren
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_amp
l_int|1
)paren
(brace
id|iic_stop
c_func
(paren
)paren
suffix:semicolon
id|iic_start
c_func
(paren
)paren
suffix:semicolon
id|iic_sendbyte
c_func
(paren
id|addr
op_or
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iic_is_acknowledged
c_func
(paren
)paren
)paren
r_goto
id|error
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
(brace
id|buf
(braket
id|i
)braket
op_assign
id|iic_recvbyte
c_func
(paren
)paren
suffix:semicolon
id|iic_acknowledge
c_func
(paren
)paren
suffix:semicolon
)brace
id|buf
(braket
id|i
)braket
op_assign
id|iic_recvbyte
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|iic_sendbyte
c_func
(paren
id|buf
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iic_is_acknowledged
c_func
(paren
)paren
)paren
r_goto
id|error
suffix:semicolon
)brace
)brace
id|err
op_assign
l_int|0
suffix:semicolon
id|error
suffix:colon
id|iic_stop
c_func
(paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
eof
