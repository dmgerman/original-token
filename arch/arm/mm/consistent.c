multiline_comment|/*&n; * Dynamic DMA mapping support.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgalloc.h&gt;
multiline_comment|/*&n; * This allocates one page of cache-coherent memory space and returns&n; * both the virtual and a &quot;dma&quot; address to that space.  It is not clear&n; * whether this could be called from an interrupt context or not.  For&n; * now, we expressly forbid it, especially as some of the stuff we do&n; * here is not interrupt context safe.&n; */
DECL|function|consistent_alloc
r_void
op_star
id|consistent_alloc
c_func
(paren
r_int
id|gfp
comma
r_int
id|size
comma
id|dma_addr_t
op_star
id|dma_handle
)paren
(brace
r_int
id|order
suffix:semicolon
r_int
r_int
id|page
suffix:semicolon
r_void
op_star
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|in_interrupt
c_func
(paren
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|order
op_assign
id|get_order
c_func
(paren
id|size
)paren
suffix:semicolon
id|page
op_assign
id|__get_free_pages
c_func
(paren
id|gfp
comma
id|order
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|page
)paren
r_goto
id|no_page
suffix:semicolon
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|page
comma
l_int|0
comma
id|PAGE_SIZE
op_lshift
id|order
)paren
suffix:semicolon
id|clean_cache_area
c_func
(paren
id|page
comma
id|PAGE_SIZE
op_lshift
id|order
)paren
suffix:semicolon
op_star
id|dma_handle
op_assign
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|page
)paren
suffix:semicolon
id|ret
op_assign
id|__ioremap
c_func
(paren
id|virt_to_phys
c_func
(paren
(paren
r_void
op_star
)paren
id|page
)paren
comma
id|PAGE_SIZE
op_lshift
id|order
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
id|free_pages
c_func
(paren
id|page
comma
id|order
)paren
suffix:semicolon
id|no_page
suffix:colon
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|pci_alloc_consistent
r_void
op_star
id|pci_alloc_consistent
c_func
(paren
r_struct
id|pci_dev
op_star
id|hwdev
comma
r_int
id|size
comma
id|dma_addr_t
op_star
id|handle
)paren
(brace
r_void
op_star
id|__ret
suffix:semicolon
r_int
id|__gfp
op_assign
id|GFP_KERNEL
suffix:semicolon
macro_line|#ifdef CONFIG_PCI
r_if
c_cond
(paren
(paren
id|hwdev
)paren
op_eq
l_int|NULL
op_logical_or
(paren
id|hwdev
)paren
op_member_access_from_pointer
id|dma_mask
op_ne
l_int|0xffffffff
)paren
macro_line|#endif
id|__gfp
op_or_assign
id|GFP_DMA
suffix:semicolon
id|__ret
op_assign
id|consistent_alloc
c_func
(paren
id|__gfp
comma
(paren
id|size
)paren
comma
(paren
id|handle
)paren
)paren
suffix:semicolon
r_return
id|__ret
suffix:semicolon
)brace
multiline_comment|/*&n; * free a page as defined by the above mapping.  We expressly forbid&n; * calling this from interrupt context.&n; */
DECL|function|consistent_free
r_void
id|consistent_free
c_func
(paren
r_void
op_star
id|vaddr
)paren
(brace
r_if
c_cond
(paren
id|in_interrupt
c_func
(paren
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|__iounmap
c_func
(paren
id|vaddr
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * make an area consistent.&n; */
DECL|function|consistent_sync
r_void
id|consistent_sync
c_func
(paren
r_void
op_star
id|vaddr
comma
r_int
id|size
comma
r_int
id|rw
)paren
(brace
r_switch
c_cond
(paren
id|rw
)paren
(brace
r_case
l_int|0
suffix:colon
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* invalidate only */
id|dma_cache_inv
c_func
(paren
id|vaddr
comma
id|size
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* writeback only */
id|dma_cache_wback
c_func
(paren
id|vaddr
comma
id|size
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* writeback and invalidate */
id|dma_cache_wback_inv
c_func
(paren
id|vaddr
comma
id|size
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
eof
