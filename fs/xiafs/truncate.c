multiline_comment|/*&n; *  linux/fs/xiafs/truncate.c&n; *&n; *  Copyright (C) Q. Frank Xia, 1993.&n; *  &n; *  Based on Linus&squot; minix/truncate.c&n; *  Copyright (C) Linus Torvalds, 1991, 1992.&n; *&n; *  This software may be redistributed per Linux Copyright.&n; */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/xia_fs.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &quot;xiafs_mac.h&quot;
multiline_comment|/*&n; * Linus&squot; comment:&n; *&n; * Truncate has the most races in the whole filesystem: coding it is&n; * a pain in the a**. Especially as I don&squot;t do any locking...&n; *&n; * The code may look a bit weird, but that&squot;s just because I&squot;ve tried to&n; * handle things like file-size changes in a somewhat graceful manner.&n; * Anyway, truncating a file at the same time somebody else writes to it&n; * is likely to result in pretty weird behaviour...&n; *&n; * The new code handles normal truncates (size = 0) as well as the more&n; * general case (size = XXX). I hope.&n; */
DECL|macro|DT_ZONE
mdefine_line|#define DT_ZONE&t;&t;((inode-&gt;i_size + XIAFS_ZSIZE(inode-&gt;i_sb) - 1) &bslash;&n;&t;&t;&t; &gt;&gt; XIAFS_ZSIZE_BITS(inode-&gt;i_sb) )
DECL|function|trunc_direct
r_static
r_int
id|trunc_direct
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
id|u_long
op_star
id|lp
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_int
id|i
comma
id|tmp
suffix:semicolon
r_int
id|retry
op_assign
l_int|0
suffix:semicolon
id|repeat
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
id|DT_ZONE
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OL
id|DT_ZONE
)paren
r_goto
id|repeat
suffix:semicolon
id|lp
op_assign
id|i
op_plus
id|inode-&gt;u.xiafs_i.i_zone
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|tmp
op_assign
op_star
id|lp
)paren
)paren
r_continue
suffix:semicolon
id|bh
op_assign
id|getblk
c_func
(paren
id|inode-&gt;i_dev
comma
id|tmp
comma
id|XIAFS_ZSIZE
c_func
(paren
id|inode-&gt;i_sb
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
id|DT_ZONE
)paren
(brace
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
r_goto
id|repeat
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|bh
op_logical_and
id|bh-&gt;b_count
op_ne
l_int|1
)paren
op_logical_or
id|tmp
op_ne
op_star
id|lp
)paren
id|retry
op_assign
l_int|1
suffix:semicolon
r_else
(brace
op_star
id|lp
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;i_dirt
op_assign
l_int|1
suffix:semicolon
id|inode-&gt;i_blocks
op_sub_assign
l_int|2
op_lshift
id|XIAFS_ZSHIFT
c_func
(paren
id|inode-&gt;i_sb
)paren
suffix:semicolon
id|xiafs_free_zone
c_func
(paren
id|inode-&gt;i_sb
comma
id|tmp
)paren
suffix:semicolon
)brace
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
)brace
r_return
id|retry
suffix:semicolon
)brace
DECL|function|trunc_indirect
r_static
r_int
id|trunc_indirect
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_int
id|addr_off
comma
id|u_long
op_star
id|lp
)paren
(brace
DECL|macro|INDT_ZONE
mdefine_line|#define INDT_ZONE &t;(DT_ZONE - addr_off)
r_struct
id|buffer_head
op_star
id|bh
comma
op_star
id|ind_bh
suffix:semicolon
r_int
id|i
comma
id|tmp
suffix:semicolon
id|u_long
op_star
id|indp
suffix:semicolon
r_int
id|retry
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|tmp
op_assign
op_star
id|lp
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|ind_bh
op_assign
id|bread
c_func
(paren
id|inode-&gt;i_dev
comma
id|tmp
comma
id|XIAFS_ZSIZE
c_func
(paren
id|inode-&gt;i_sb
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_ne
op_star
id|lp
)paren
(brace
id|brelse
c_func
(paren
id|ind_bh
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ind_bh
)paren
(brace
op_star
id|lp
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|repeat
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
id|INDT_ZONE
OL
l_int|0
ques
c_cond
l_int|0
suffix:colon
id|INDT_ZONE
suffix:semicolon
id|i
OL
id|XIAFS_ADDRS_PER_Z
c_func
(paren
id|inode-&gt;i_sb
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OL
id|INDT_ZONE
)paren
r_goto
id|repeat
suffix:semicolon
id|indp
op_assign
id|i
op_plus
(paren
id|u_long
op_star
)paren
id|ind_bh-&gt;b_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|tmp
op_assign
op_star
id|indp
)paren
)paren
r_continue
suffix:semicolon
id|bh
op_assign
id|getblk
c_func
(paren
id|inode-&gt;i_dev
comma
id|tmp
comma
id|XIAFS_ZSIZE
c_func
(paren
id|inode-&gt;i_sb
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
id|INDT_ZONE
)paren
(brace
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
r_goto
id|repeat
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|bh
op_logical_and
id|bh-&gt;b_count
op_ne
l_int|1
)paren
op_logical_or
id|tmp
op_ne
op_star
id|indp
)paren
id|retry
op_assign
l_int|1
suffix:semicolon
r_else
(brace
op_star
id|indp
op_assign
l_int|0
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|ind_bh
comma
l_int|1
)paren
suffix:semicolon
id|inode-&gt;i_blocks
op_sub_assign
l_int|2
op_lshift
id|XIAFS_ZSHIFT
c_func
(paren
id|inode-&gt;i_sb
)paren
suffix:semicolon
id|xiafs_free_zone
c_func
(paren
id|inode-&gt;i_sb
comma
id|tmp
)paren
suffix:semicolon
)brace
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
)brace
id|indp
op_assign
(paren
id|u_long
op_star
)paren
id|ind_bh-&gt;b_data
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|XIAFS_ADDRS_PER_Z
c_func
(paren
id|inode-&gt;i_sb
)paren
op_logical_and
op_logical_neg
(paren
op_star
id|indp
op_increment
)paren
suffix:semicolon
id|i
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|XIAFS_ADDRS_PER_Z
c_func
(paren
id|inode-&gt;i_sb
)paren
)paren
(brace
r_if
c_cond
(paren
id|ind_bh-&gt;b_count
op_ne
l_int|1
)paren
id|retry
op_assign
l_int|1
suffix:semicolon
r_else
(brace
id|tmp
op_assign
op_star
id|lp
suffix:semicolon
op_star
id|lp
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;i_blocks
op_sub_assign
l_int|2
op_lshift
id|XIAFS_ZSHIFT
c_func
(paren
id|inode-&gt;i_sb
)paren
suffix:semicolon
id|xiafs_free_zone
c_func
(paren
id|inode-&gt;i_sb
comma
id|tmp
)paren
suffix:semicolon
)brace
)brace
id|brelse
c_func
(paren
id|ind_bh
)paren
suffix:semicolon
r_return
id|retry
suffix:semicolon
)brace
DECL|function|trunc_dindirect
r_static
r_int
id|trunc_dindirect
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
DECL|macro|DINDT_ZONE
mdefine_line|#define DINDT_ZONE &bslash;&n;    ((DT_ZONE-XIAFS_ADDRS_PER_Z(inode-&gt;i_sb)-8)&gt;&gt;XIAFS_ADDRS_PER_Z_BITS(inode-&gt;i_sb))
r_int
id|i
comma
id|tmp
suffix:semicolon
r_struct
id|buffer_head
op_star
id|dind_bh
suffix:semicolon
id|u_long
op_star
id|dindp
comma
op_star
id|lp
suffix:semicolon
r_int
id|retry
op_assign
l_int|0
suffix:semicolon
id|lp
op_assign
op_amp
(paren
id|inode-&gt;u.xiafs_i.i_dind_zone
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|tmp
op_assign
op_star
id|lp
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|dind_bh
op_assign
id|bread
c_func
(paren
id|inode-&gt;i_dev
comma
id|tmp
comma
id|XIAFS_ZSIZE
c_func
(paren
id|inode-&gt;i_sb
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_ne
op_star
id|lp
)paren
(brace
id|brelse
c_func
(paren
id|dind_bh
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dind_bh
)paren
(brace
op_star
id|lp
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|repeat
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
id|DINDT_ZONE
OL
l_int|0
ques
c_cond
l_int|0
suffix:colon
id|DINDT_ZONE
suffix:semicolon
id|i
OL
id|XIAFS_ADDRS_PER_Z
c_func
(paren
id|inode-&gt;i_sb
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OL
id|DINDT_ZONE
)paren
r_goto
id|repeat
suffix:semicolon
id|dindp
op_assign
id|i
op_plus
(paren
id|u_long
op_star
)paren
id|dind_bh-&gt;b_data
suffix:semicolon
id|retry
op_or_assign
id|trunc_indirect
c_func
(paren
id|inode
comma
l_int|8
op_plus
(paren
(paren
l_int|1
op_plus
id|i
)paren
op_lshift
id|XIAFS_ADDRS_PER_Z_BITS
c_func
(paren
id|inode-&gt;i_sb
)paren
)paren
comma
id|dindp
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|dind_bh
comma
l_int|1
)paren
suffix:semicolon
)brace
id|dindp
op_assign
(paren
id|u_long
op_star
)paren
id|dind_bh-&gt;b_data
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|XIAFS_ADDRS_PER_Z
c_func
(paren
id|inode-&gt;i_sb
)paren
op_logical_and
op_logical_neg
(paren
op_star
id|dindp
op_increment
)paren
suffix:semicolon
id|i
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|XIAFS_ADDRS_PER_Z
c_func
(paren
id|inode-&gt;i_sb
)paren
)paren
(brace
r_if
c_cond
(paren
id|dind_bh-&gt;b_count
op_ne
l_int|1
)paren
id|retry
op_assign
l_int|1
suffix:semicolon
r_else
(brace
id|tmp
op_assign
op_star
id|lp
suffix:semicolon
op_star
id|lp
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;i_dirt
op_assign
l_int|1
suffix:semicolon
id|inode-&gt;i_blocks
op_sub_assign
l_int|2
op_lshift
id|XIAFS_ZSHIFT
c_func
(paren
id|inode-&gt;i_sb
)paren
suffix:semicolon
id|xiafs_free_zone
c_func
(paren
id|inode-&gt;i_sb
comma
id|tmp
)paren
suffix:semicolon
)brace
)brace
id|brelse
c_func
(paren
id|dind_bh
)paren
suffix:semicolon
r_return
id|retry
suffix:semicolon
)brace
DECL|function|xiafs_truncate
r_void
id|xiafs_truncate
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
r_int
id|retry
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|S_ISREG
c_func
(paren
id|inode-&gt;i_mode
)paren
op_logical_or
id|S_ISDIR
c_func
(paren
id|inode-&gt;i_mode
)paren
op_logical_or
id|S_ISLNK
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
)paren
r_return
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|retry
op_assign
id|trunc_direct
c_func
(paren
id|inode
)paren
suffix:semicolon
id|retry
op_or_assign
id|trunc_indirect
c_func
(paren
id|inode
comma
l_int|8
comma
op_amp
(paren
id|inode-&gt;u.xiafs_i.i_ind_zone
)paren
)paren
suffix:semicolon
id|retry
op_or_assign
id|trunc_dindirect
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retry
)paren
r_break
suffix:semicolon
id|current-&gt;counter
op_assign
l_int|0
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
id|inode-&gt;i_ctime
op_assign
id|inode-&gt;i_mtime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|inode-&gt;i_dirt
op_assign
l_int|1
suffix:semicolon
)brace
eof
