multiline_comment|/*&n; *  linux/fs/umsdos/rdir.c&n; *&n; *  Written 1994 by Jacques Gelinas&n; *&n; *  Extended MS-DOS directory pure MS-DOS handling functions&n; *  (For directory without EMD file).&n; */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/msdos_fs.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/limits.h&gt;
macro_line|#include &lt;linux/umsdos_fs.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
DECL|macro|PRINTK
mdefine_line|#define PRINTK(x)
DECL|macro|Printk
mdefine_line|#define Printk(x) printk x
r_extern
r_struct
id|inode
op_star
id|pseudo_root
suffix:semicolon
DECL|struct|RDIR_FILLDIR
r_struct
id|RDIR_FILLDIR
(brace
DECL|member|dirbuf
r_void
op_star
id|dirbuf
suffix:semicolon
DECL|member|filldir
id|filldir_t
id|filldir
suffix:semicolon
DECL|member|real_root
r_int
id|real_root
suffix:semicolon
)brace
suffix:semicolon
DECL|function|rdir_filldir
r_static
r_int
id|rdir_filldir
c_func
(paren
r_void
op_star
id|buf
comma
r_const
r_char
op_star
id|name
comma
r_int
id|name_len
comma
id|off_t
id|offset
comma
id|ino_t
id|ino
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_struct
id|RDIR_FILLDIR
op_star
id|d
op_assign
(paren
r_struct
id|RDIR_FILLDIR
op_star
)paren
id|buf
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;real_root
)paren
(brace
multiline_comment|/* real root of a pseudo_rooted partition */
r_if
c_cond
(paren
id|name_len
op_ne
id|UMSDOS_PSDROOT_LEN
op_logical_or
id|memcmp
c_func
(paren
id|name
comma
id|UMSDOS_PSDROOT_NAME
comma
id|UMSDOS_PSDROOT_LEN
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* So it is not the /linux directory */
r_if
c_cond
(paren
id|name_len
op_eq
l_int|2
op_logical_and
id|name
(braket
l_int|0
)braket
op_eq
l_char|&squot;.&squot;
op_logical_and
id|name
(braket
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
)paren
(brace
multiline_comment|/* Make sure the .. entry points back to the pseudo_root */
id|ino
op_assign
id|pseudo_root-&gt;i_ino
suffix:semicolon
)brace
id|ret
op_assign
id|d-&gt;filldir
(paren
id|d-&gt;dirbuf
comma
id|name
comma
id|name_len
comma
id|offset
comma
id|ino
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Any DOS directory */
id|ret
op_assign
id|d-&gt;filldir
(paren
id|d-&gt;dirbuf
comma
id|name
comma
id|name_len
comma
id|offset
comma
id|ino
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|UMSDOS_rreaddir
r_static
r_int
id|UMSDOS_rreaddir
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|file
op_star
id|filp
comma
r_void
op_star
id|dirbuf
comma
id|filldir_t
id|filldir
)paren
(brace
r_struct
id|RDIR_FILLDIR
id|bufk
suffix:semicolon
id|bufk.filldir
op_assign
id|filldir
suffix:semicolon
id|bufk.dirbuf
op_assign
id|dirbuf
suffix:semicolon
id|bufk.real_root
op_assign
id|pseudo_root
op_ne
l_int|NULL
op_logical_and
id|dir
op_eq
id|dir-&gt;i_sb-&gt;s_mounted
op_logical_and
id|dir
op_eq
id|pseudo_root-&gt;i_sb-&gt;s_mounted
suffix:semicolon
r_return
id|msdos_readdir
c_func
(paren
id|dir
comma
id|filp
comma
op_amp
id|bufk
comma
id|rdir_filldir
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;Lookup into a non promoted directory.&n;&t;If the result is a directory, make sure we find out if it is&n;&t;a promoted one or not (calling umsdos_setup_dir_inode(inode)).&n;*/
DECL|function|umsdos_rlookup_x
r_int
id|umsdos_rlookup_x
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
comma
r_struct
id|inode
op_star
op_star
id|result
comma
multiline_comment|/* Will hold inode of the file, if successful */
r_int
id|nopseudo
)paren
multiline_comment|/* Don&squot;t care about pseudo root mode */
multiline_comment|/* so locating &quot;linux&quot; will work */
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|pseudo_root
op_ne
l_int|NULL
op_logical_and
id|len
op_eq
l_int|2
op_logical_and
id|name
(braket
l_int|0
)braket
op_eq
l_char|&squot;.&squot;
op_logical_and
id|name
(braket
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
op_logical_and
id|dir
op_eq
id|dir-&gt;i_sb-&gt;s_mounted
op_logical_and
id|dir
op_eq
id|pseudo_root-&gt;i_sb-&gt;s_mounted
)paren
(brace
op_star
id|result
op_assign
id|pseudo_root
suffix:semicolon
id|pseudo_root-&gt;i_count
op_increment
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* #Specification: pseudo root / DOS/..&n;&t;&t;&t;In the real root directory (c:&bslash;), the directory ..&n;&t;&t;&t;is the pseudo root (c:&bslash;linux).&n;&t;&t;*/
)brace
r_else
(brace
id|ret
op_assign
id|umsdos_real_lookup
(paren
id|dir
comma
id|name
comma
id|len
comma
id|result
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
op_star
id|result
suffix:semicolon
r_if
c_cond
(paren
id|inode
op_eq
id|pseudo_root
op_logical_and
op_logical_neg
id|nopseudo
)paren
(brace
multiline_comment|/* #Specification: pseudo root / DOS/linux&n;&t;&t;&t;&t;&t;Even in the real root directory (c:&bslash;), the directory&n;&t;&t;&t;&t;&t;/linux won&squot;t show&n;&t;&t;&t;&t;*/
id|ret
op_assign
op_minus
id|ENOENT
suffix:semicolon
id|iput
(paren
id|pseudo_root
)paren
suffix:semicolon
op_star
id|result
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
(brace
multiline_comment|/* We must place the proper function table */
multiline_comment|/* depending if this is a MsDOS directory or an UMSDOS directory */
id|umsdos_setup_dir_inode
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
)brace
)brace
id|iput
(paren
id|dir
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|UMSDOS_rlookup
r_int
id|UMSDOS_rlookup
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
comma
r_struct
id|inode
op_star
op_star
id|result
)paren
multiline_comment|/* Will hold inode of the file, if successful */
(brace
r_return
id|umsdos_rlookup_x
c_func
(paren
id|dir
comma
id|name
comma
id|len
comma
id|result
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|UMSDOS_rrmdir
r_static
r_int
id|UMSDOS_rrmdir
(paren
r_struct
id|inode
op_star
id|dir
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
)paren
(brace
multiline_comment|/* #Specification: dual mode / rmdir in a DOS directory&n;&t;&t;In a DOS (not EMD in it) directory, we use a reverse strategy&n;&t;&t;compared with an Umsdos directory. We assume that a subdirectory&n;&t;&t;of a DOS directory is also a DOS directory. This is not always&n;&t;&t;true (umssync may be used anywhere), but make sense.&n;&n;&t;&t;So we call msdos_rmdir() directly. If it failed with a -ENOTEMPTY&n;&t;&t;then we check if it is a Umsdos directory. We check if it is&n;&t;&t;really empty (only . .. and --linux-.--- in it). If it is true&n;&t;&t;we remove the EMD and do a msdos_rmdir() again.&n;&n;&t;&t;In a Umsdos directory, we assume all subdirectory are also&n;&t;&t;Umsdos directory, so we check the EMD file first.&n;&t;*/
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|umsdos_is_pseudodos
c_func
(paren
id|dir
comma
id|name
comma
id|len
)paren
)paren
(brace
multiline_comment|/* #Specification: pseudo root / rmdir /DOS&n;&t;&t;&t;The pseudo sub-directory /DOS can&squot;t be removed!&n;&t;&t;&t;This is done even if the pseudo root is not a Umsdos&n;&t;&t;&t;directory anymore (very unlikely), but an accident (under&n;&t;&t;&t;MsDOS) is always possible.&n;&n;&t;&t;&t;EPERM is returned.&n;&t;&t;*/
id|ret
op_assign
op_minus
id|EPERM
suffix:semicolon
)brace
r_else
(brace
id|umsdos_lockcreate
(paren
id|dir
)paren
suffix:semicolon
id|dir-&gt;i_count
op_increment
suffix:semicolon
id|ret
op_assign
id|msdos_rmdir
(paren
id|dir
comma
id|name
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|ENOTEMPTY
)paren
(brace
r_struct
id|inode
op_star
id|sdir
suffix:semicolon
id|dir-&gt;i_count
op_increment
suffix:semicolon
id|ret
op_assign
id|UMSDOS_rlookup
(paren
id|dir
comma
id|name
comma
id|len
comma
op_amp
id|sdir
)paren
suffix:semicolon
id|PRINTK
(paren
(paren
l_string|&quot;rrmdir lookup %d &quot;
comma
id|ret
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
(brace
r_int
id|empty
suffix:semicolon
r_if
c_cond
(paren
(paren
id|empty
op_assign
id|umsdos_isempty
(paren
id|sdir
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|PRINTK
(paren
(paren
l_string|&quot;isempty %d i_count %d &quot;
comma
id|empty
comma
id|sdir-&gt;i_count
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|empty
op_eq
l_int|2
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t;&t;Not a Umsdos directory, so the previous msdos_rmdir&n;&t;&t;&t;&t;&t;&t;&t;was not lying :-)&n;&t;&t;&t;&t;&t;&t;*/
id|ret
op_assign
op_minus
id|ENOTEMPTY
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|empty
op_eq
l_int|1
)paren
(brace
multiline_comment|/* We have to removed the EMD file */
id|ret
op_assign
id|msdos_unlink
c_func
(paren
id|sdir
comma
id|UMSDOS_EMD_FILE
comma
id|UMSDOS_EMD_NAMELEN
)paren
suffix:semicolon
id|sdir
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
(brace
id|dir-&gt;i_count
op_increment
suffix:semicolon
id|ret
op_assign
id|msdos_rmdir
(paren
id|dir
comma
id|name
comma
id|len
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|ret
op_assign
op_minus
id|ENOTEMPTY
suffix:semicolon
)brace
id|iput
(paren
id|sdir
)paren
suffix:semicolon
)brace
)brace
id|umsdos_unlockcreate
(paren
id|dir
)paren
suffix:semicolon
)brace
id|iput
(paren
id|dir
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* #Specification: dual mode / introduction&n;&t;One goal of UMSDOS is to allow a practical and simple coexistence&n;&t;between MsDOS and Linux in a single partition. Using the EMD file&n;&t;in each directory, UMSDOS add Unix semantics and capabilities to&n;&t;normal DOS file system. To help and simplify coexistence, here is&n;&t;the logic related to the EMD file.&n;&n;&t;If it is missing, then the directory is managed by the MsDOS driver.&n;&t;The names are limited to DOS limits (8.3). No links, no device special&n;&t;and pipe and so on.&n;&n;&t;If it is there, it is the directory. If it is there but empty, then&n;&t;the directory looks empty. The utility umssync allows synchronisation&n;&t;of the real DOS directory and the EMD.&n;&n;&t;Whenever umssync is applied to a directory without EMD, one is&n;&t;created on the fly. The directory is promoted to full unix semantic.&n;&t;Of course, the ls command will show exactly the same content as before&n;&t;the umssync session.&n;&n;&t;It is believed that the user/admin will promote directories to unix&n;&t;semantic as needed.&n;&n;&t;The strategy to implement this is to use two function table (struct&n;&t;inode_operations). One for true UMSDOS directory and one for directory&n;&t;with missing EMD.&n;&n;&t;Functions related to the DOS semantic (but aware of UMSDOS) generally&n;&t;have a &quot;r&quot; prefix (r for real) such as UMSDOS_rlookup, to differentiate&n;&t;from the one with full UMSDOS semantic.&n;*/
DECL|variable|umsdos_rdir_operations
r_static
r_struct
id|file_operations
id|umsdos_rdir_operations
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* lseek - default */
id|UMSDOS_dir_read
comma
multiline_comment|/* read */
l_int|NULL
comma
multiline_comment|/* write - bad */
id|UMSDOS_rreaddir
comma
multiline_comment|/* readdir */
l_int|NULL
comma
multiline_comment|/* select - default */
id|UMSDOS_ioctl_dir
comma
multiline_comment|/* ioctl - default */
l_int|NULL
comma
multiline_comment|/* mmap */
l_int|NULL
comma
multiline_comment|/* no special open code */
l_int|NULL
comma
multiline_comment|/* no special release code */
l_int|NULL
multiline_comment|/* fsync */
)brace
suffix:semicolon
DECL|variable|umsdos_rdir_inode_operations
r_struct
id|inode_operations
id|umsdos_rdir_inode_operations
op_assign
(brace
op_amp
id|umsdos_rdir_operations
comma
multiline_comment|/* default directory file-ops */
id|msdos_create
comma
multiline_comment|/* create */
id|UMSDOS_rlookup
comma
multiline_comment|/* lookup */
l_int|NULL
comma
multiline_comment|/* link */
id|msdos_unlink
comma
multiline_comment|/* unlink */
l_int|NULL
comma
multiline_comment|/* symlink */
id|msdos_mkdir
comma
multiline_comment|/* mkdir */
id|UMSDOS_rrmdir
comma
multiline_comment|/* rmdir */
l_int|NULL
comma
multiline_comment|/* mknod */
id|msdos_rename
comma
multiline_comment|/* rename */
l_int|NULL
comma
multiline_comment|/* readlink */
l_int|NULL
comma
multiline_comment|/* follow_link */
l_int|NULL
comma
multiline_comment|/* readpage */
l_int|NULL
comma
multiline_comment|/* writepage */
l_int|NULL
comma
multiline_comment|/* bmap */
l_int|NULL
comma
multiline_comment|/* truncate */
l_int|NULL
multiline_comment|/* permission */
)brace
suffix:semicolon
eof
