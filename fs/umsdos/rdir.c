multiline_comment|/*&n; *  linux/fs/umsdos/rdir.c&n; *&n; *  Written 1994 by Jacques Gelinas&n; *&n; *  Extended MS-DOS directory pure MS-DOS handling functions&n; *  (For directory without EMD file).&n; */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/msdos_fs.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/limits.h&gt;
macro_line|#include &lt;linux/umsdos_fs.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
DECL|macro|PRINTK
mdefine_line|#define PRINTK(x)
DECL|macro|Printk
mdefine_line|#define Printk(x) printk x
r_extern
r_struct
id|inode
op_star
id|pseudo_root
suffix:semicolon
DECL|struct|RDIR_FILLDIR
r_struct
id|RDIR_FILLDIR
(brace
DECL|member|dirbuf
r_void
op_star
id|dirbuf
suffix:semicolon
DECL|member|filldir
id|filldir_t
id|filldir
suffix:semicolon
DECL|member|real_root
r_int
id|real_root
suffix:semicolon
)brace
suffix:semicolon
DECL|function|rdir_filldir
r_static
r_int
id|rdir_filldir
c_func
(paren
r_void
op_star
id|buf
comma
r_const
r_char
op_star
id|name
comma
r_int
id|name_len
comma
id|off_t
id|offset
comma
id|ino_t
id|ino
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_struct
id|RDIR_FILLDIR
op_star
id|d
op_assign
(paren
r_struct
id|RDIR_FILLDIR
op_star
)paren
id|buf
suffix:semicolon
id|PRINTK
(paren
(paren
id|KERN_DEBUG
l_string|&quot;rdir_filldir /mn/: entering&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;real_root
)paren
(brace
id|PRINTK
(paren
(paren
id|KERN_DEBUG
l_string|&quot;rdir_filldir /mn/: real root!&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* real root of a pseudo_rooted partition */
r_if
c_cond
(paren
id|name_len
op_ne
id|UMSDOS_PSDROOT_LEN
op_logical_or
id|memcmp
c_func
(paren
id|name
comma
id|UMSDOS_PSDROOT_NAME
comma
id|UMSDOS_PSDROOT_LEN
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* So it is not the /linux directory */
r_if
c_cond
(paren
id|name_len
op_eq
l_int|2
op_logical_and
id|name
(braket
l_int|0
)braket
op_eq
l_char|&squot;.&squot;
op_logical_and
id|name
(braket
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
)paren
(brace
multiline_comment|/* Make sure the .. entry points back to the pseudo_root */
id|ino
op_assign
id|pseudo_root-&gt;i_ino
suffix:semicolon
)brace
id|ret
op_assign
id|d-&gt;filldir
(paren
id|d-&gt;dirbuf
comma
id|name
comma
id|name_len
comma
id|offset
comma
id|ino
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Any DOS directory */
id|PRINTK
(paren
(paren
id|KERN_DEBUG
l_string|&quot;rdir_filldir /mn/: calling d-&gt;filldir (%p) for %.*s (%lu)&bslash;n&quot;
comma
id|d-&gt;filldir
comma
id|name_len
comma
id|name
comma
id|ino
)paren
)paren
suffix:semicolon
id|ret
op_assign
id|d-&gt;filldir
(paren
id|d-&gt;dirbuf
comma
id|name
comma
id|name_len
comma
id|offset
comma
id|ino
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|UMSDOS_rreaddir
r_static
r_int
id|UMSDOS_rreaddir
(paren
r_struct
id|file
op_star
id|filp
comma
r_void
op_star
id|dirbuf
comma
id|filldir_t
id|filldir
)paren
(brace
r_struct
id|RDIR_FILLDIR
id|bufk
suffix:semicolon
r_struct
id|inode
op_star
id|dir
op_assign
id|filp-&gt;f_dentry-&gt;d_inode
suffix:semicolon
id|PRINTK
(paren
(paren
id|KERN_DEBUG
l_string|&quot;UMSDOS_rreaddir /mn/: entering %p %p&bslash;n&quot;
comma
id|filldir
comma
id|dirbuf
)paren
)paren
suffix:semicolon
id|bufk.filldir
op_assign
id|filldir
suffix:semicolon
id|bufk.dirbuf
op_assign
id|dirbuf
suffix:semicolon
id|bufk.real_root
op_assign
id|pseudo_root
op_logical_and
id|dir
op_eq
id|iget
c_func
(paren
id|dir-&gt;i_sb
comma
id|UMSDOS_ROOT_INO
)paren
op_logical_and
id|dir
op_eq
id|iget
c_func
(paren
id|pseudo_root-&gt;i_sb
comma
id|UMSDOS_ROOT_INO
)paren
suffix:semicolon
id|PRINTK
(paren
(paren
id|KERN_DEBUG
l_string|&quot;UMSDOS_rreaddir /mn/: calling fat_readdir with filldir=%p and exiting&bslash;n&quot;
comma
id|filldir
)paren
)paren
suffix:semicolon
r_return
id|fat_readdir
c_func
(paren
id|filp
comma
op_amp
id|bufk
comma
id|rdir_filldir
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;  Lookup into a non promoted directory.&n;  If the result is a directory, make sure we find out if it is&n;  a promoted one or not (calling umsdos_setup_dir_inode(inode)).&n;*/
DECL|function|umsdos_rlookup_x
r_int
id|umsdos_rlookup_x
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|nopseudo
)paren
multiline_comment|/* Don&squot;t care about pseudo root mode */
multiline_comment|/* so locating &quot;linux&quot; will work */
(brace
r_int
id|len
op_assign
id|dentry-&gt;d_name.len
suffix:semicolon
r_const
r_char
op_star
id|name
op_assign
id|dentry-&gt;d_name.name
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|pseudo_root
op_logical_and
id|len
op_eq
l_int|2
op_logical_and
id|name
(braket
l_int|0
)braket
op_eq
l_char|&squot;.&squot;
op_logical_and
id|name
(braket
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
op_logical_and
id|dir
op_eq
id|iget
c_func
(paren
id|dir-&gt;i_sb
comma
id|UMSDOS_ROOT_INO
)paren
op_logical_and
id|dir
op_eq
id|iget
c_func
(paren
id|pseudo_root-&gt;i_sb
comma
id|UMSDOS_ROOT_INO
)paren
)paren
(brace
multiline_comment|/*    *result = pseudo_root;*/
id|Printk
(paren
(paren
id|KERN_WARNING
l_string|&quot;umsdos_rlookup_x: we are at pseudo-root thingy?&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|pseudo_root-&gt;i_count
op_increment
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* #Specification: pseudo root / DOS/..&n;       In the real root directory (c:&bslash;), the directory ..&n;       is the pseudo root (c:&bslash;linux).&n;    */
)brace
r_else
(brace
id|ret
op_assign
id|umsdos_real_lookup
(paren
id|dir
comma
id|dentry
)paren
suffix:semicolon
id|inode
op_assign
id|dentry-&gt;d_inode
suffix:semicolon
macro_line|#if 0
id|Printk
(paren
(paren
id|KERN_DEBUG
l_string|&quot;umsdos_rlookup_x: umsdos_real_lookup for %.*s in %lu returned %d&bslash;n&quot;
comma
id|len
comma
id|name
comma
id|dir-&gt;i_ino
comma
id|ret
)paren
)paren
suffix:semicolon
id|Printk
(paren
(paren
id|KERN_DEBUG
l_string|&quot;umsdos_rlookup_x: umsdos_real_lookup: inode is %p resolving to &quot;
comma
id|inode
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inode
)paren
(brace
multiline_comment|/* /mn/ FIXME: DEL_ME */
id|Printk
(paren
(paren
id|KERN_DEBUG
l_string|&quot;i_ino=%lu&bslash;n&quot;
comma
id|inode-&gt;i_ino
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|Printk
(paren
(paren
id|KERN_DEBUG
l_string|&quot;NONE!&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
(paren
id|ret
op_eq
l_int|0
)paren
op_logical_and
id|inode
)paren
(brace
r_if
c_cond
(paren
id|pseudo_root
op_logical_and
id|inode
op_eq
id|pseudo_root
op_logical_and
op_logical_neg
id|nopseudo
)paren
(brace
multiline_comment|/* #Specification: pseudo root / DOS/linux&n;&t; Even in the real root directory (c:&bslash;), the directory&n;&t; /linux won&squot;t show&n;      */
id|Printk
(paren
(paren
id|KERN_WARNING
l_string|&quot;umsdos_rlookup_x: do the pseudo-thingy...&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOENT
suffix:semicolon
id|iput
(paren
id|pseudo_root
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
(brace
multiline_comment|/* We must place the proper function table */
multiline_comment|/* depending if this is a MsDOS directory or an UMSDOS directory */
id|Printk
(paren
(paren
id|KERN_DEBUG
l_string|&quot;umsdos_rlookup_x: setting up setup_dir_inode %lu...&bslash;n&quot;
comma
id|inode-&gt;i_ino
)paren
)paren
suffix:semicolon
id|umsdos_setup_dir_inode
(paren
id|inode
)paren
suffix:semicolon
)brace
)brace
)brace
id|iput
(paren
id|dir
)paren
suffix:semicolon
id|PRINTK
(paren
(paren
id|KERN_DEBUG
l_string|&quot;umsdos_rlookup_x: returning %d&bslash;n&quot;
comma
id|ret
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|UMSDOS_rlookup
r_int
id|UMSDOS_rlookup
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
id|PRINTK
(paren
(paren
id|KERN_DEBUG
l_string|&quot;UMSDOS_rlookup /mn/: executing umsdos_rlookup_x for ino=%lu in %.*s&bslash;n&quot;
comma
id|dir-&gt;i_ino
comma
(paren
r_int
)paren
id|dentry-&gt;d_name.len
comma
id|dentry-&gt;d_name.name
)paren
)paren
suffix:semicolon
r_return
id|umsdos_rlookup_x
c_func
(paren
id|dir
comma
id|dentry
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|UMSDOS_rrmdir
r_static
r_int
id|UMSDOS_rrmdir
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
multiline_comment|/* #Specification: dual mode / rmdir in a DOS directory&n;     In a DOS (not EMD in it) directory, we use a reverse strategy&n;     compared with an Umsdos directory. We assume that a subdirectory&n;     of a DOS directory is also a DOS directory. This is not always&n;     true (umssync may be used anywhere), but make sense.&n;     &n;     So we call msdos_rmdir() directly. If it failed with a -ENOTEMPTY&n;     then we check if it is a Umsdos directory. We check if it is&n;     really empty (only . .. and --linux-.--- in it). If it is true&n;     we remove the EMD and do a msdos_rmdir() again.&n;&n;     In a Umsdos directory, we assume all subdirectory are also&n;     Umsdos directory, so we check the EMD file first.&n;  */
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|umsdos_is_pseudodos
c_func
(paren
id|dir
comma
id|dentry
)paren
)paren
(brace
multiline_comment|/* #Specification: pseudo root / rmdir /DOS&n;       The pseudo sub-directory /DOS can&squot;t be removed!&n;       This is done even if the pseudo root is not a Umsdos&n;       directory anymore (very unlikely), but an accident (under&n;       MsDOS) is always possible.&n;       &n;       EPERM is returned.&n;    */
id|ret
op_assign
op_minus
id|EPERM
suffix:semicolon
)brace
r_else
(brace
id|umsdos_lockcreate
(paren
id|dir
)paren
suffix:semicolon
id|dir-&gt;i_count
op_increment
suffix:semicolon
id|ret
op_assign
id|msdos_rmdir
(paren
id|dir
comma
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|ENOTEMPTY
)paren
(brace
r_struct
id|inode
op_star
id|sdir
suffix:semicolon
id|dir-&gt;i_count
op_increment
suffix:semicolon
id|ret
op_assign
id|UMSDOS_rlookup
(paren
id|dir
comma
id|dentry
)paren
suffix:semicolon
id|sdir
op_assign
id|dentry-&gt;d_inode
suffix:semicolon
id|PRINTK
(paren
(paren
l_string|&quot;rrmdir lookup %d &quot;
comma
id|ret
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
(brace
r_int
id|empty
suffix:semicolon
r_if
c_cond
(paren
(paren
id|empty
op_assign
id|umsdos_isempty
(paren
id|sdir
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|PRINTK
(paren
(paren
l_string|&quot;isempty %d i_count %d &quot;
comma
id|empty
comma
id|atomic_read
c_func
(paren
op_amp
id|sdir-&gt;i_count
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|empty
op_eq
l_int|2
)paren
(brace
multiline_comment|/*&n;&t;      Not a Umsdos directory, so the previous msdos_rmdir&n;&t;      was not lying :-)&n;&t;    */
id|ret
op_assign
op_minus
id|ENOTEMPTY
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|empty
op_eq
l_int|1
)paren
(brace
multiline_comment|/* We have to removed the EMD file */
r_struct
id|dentry
op_star
id|temp
suffix:semicolon
id|temp
op_assign
id|creat_dentry
(paren
id|UMSDOS_EMD_FILE
comma
id|UMSDOS_EMD_NAMELEN
comma
l_int|NULL
)paren
suffix:semicolon
id|ret
op_assign
id|msdos_unlink
c_func
(paren
id|sdir
comma
id|temp
)paren
suffix:semicolon
id|sdir
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
(brace
id|dir-&gt;i_count
op_increment
suffix:semicolon
id|ret
op_assign
id|msdos_rmdir
(paren
id|dir
comma
id|dentry
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|ret
op_assign
op_minus
id|ENOTEMPTY
suffix:semicolon
)brace
id|iput
(paren
id|sdir
)paren
suffix:semicolon
)brace
)brace
id|umsdos_unlockcreate
(paren
id|dir
)paren
suffix:semicolon
)brace
id|iput
(paren
id|dir
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* #Specification: dual mode / introduction&n;   One goal of UMSDOS is to allow a practical and simple coexistence&n;   between MsDOS and Linux in a single partition. Using the EMD file&n;   in each directory, UMSDOS add Unix semantics and capabilities to&n;   normal DOS file system. To help and simplify coexistence, here is&n;   the logic related to the EMD file.&n;   &n;   If it is missing, then the directory is managed by the MsDOS driver.&n;   The names are limited to DOS limits (8.3). No links, no device special&n;   and pipe and so on.&n;&n;   If it is there, it is the directory. If it is there but empty, then&n;   the directory looks empty. The utility umssync allows synchronisation&n;   of the real DOS directory and the EMD.&n;&n;   Whenever umssync is applied to a directory without EMD, one is&n;   created on the fly. The directory is promoted to full unix semantic.&n;   Of course, the ls command will show exactly the same content as before&n;   the umssync session.&n;&n;   It is believed that the user/admin will promote directories to unix&n;   semantic as needed.&n;&n;   The strategy to implement this is to use two function table (struct&n;   inode_operations). One for true UMSDOS directory and one for directory&n;   with missing EMD.&n;&n;   Functions related to the DOS semantic (but aware of UMSDOS) generally&n;   have a &quot;r&quot; prefix (r for real) such as UMSDOS_rlookup, to differentiate&n;   from the one with full UMSDOS semantic.&n;*/
DECL|variable|umsdos_rdir_operations
r_static
r_struct
id|file_operations
id|umsdos_rdir_operations
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* lseek - default */
id|UMSDOS_dir_read
comma
multiline_comment|/* read */
l_int|NULL
comma
multiline_comment|/* write - bad */
id|UMSDOS_rreaddir
comma
multiline_comment|/* readdir */
l_int|NULL
comma
multiline_comment|/* poll - default */
id|UMSDOS_ioctl_dir
comma
multiline_comment|/* ioctl - default */
l_int|NULL
comma
multiline_comment|/* mmap */
l_int|NULL
comma
multiline_comment|/* no special open code */
l_int|NULL
comma
multiline_comment|/* no special release code */
l_int|NULL
multiline_comment|/* fsync */
)brace
suffix:semicolon
DECL|variable|umsdos_rdir_inode_operations
r_struct
id|inode_operations
id|umsdos_rdir_inode_operations
op_assign
(brace
op_amp
id|umsdos_rdir_operations
comma
multiline_comment|/* default directory file-ops */
id|msdos_create
comma
multiline_comment|/* create */
id|UMSDOS_rlookup
comma
multiline_comment|/* lookup */
l_int|NULL
comma
multiline_comment|/* link */
id|msdos_unlink
comma
multiline_comment|/* unlink */
l_int|NULL
comma
multiline_comment|/* symlink */
id|msdos_mkdir
comma
multiline_comment|/* mkdir */
id|UMSDOS_rrmdir
comma
multiline_comment|/* rmdir */
l_int|NULL
comma
multiline_comment|/* mknod */
id|msdos_rename
comma
multiline_comment|/* rename */
l_int|NULL
comma
multiline_comment|/* readlink */
l_int|NULL
comma
multiline_comment|/* followlink */
l_int|NULL
comma
multiline_comment|/* readpage */
l_int|NULL
comma
multiline_comment|/* writepage */
l_int|NULL
comma
multiline_comment|/* bmap */
l_int|NULL
comma
multiline_comment|/* truncate */
l_int|NULL
comma
multiline_comment|/* permission */
l_int|NULL
comma
multiline_comment|/* smap */
l_int|NULL
comma
multiline_comment|/* updatepage */
l_int|NULL
comma
multiline_comment|/* revalidate */
)brace
suffix:semicolon
eof
