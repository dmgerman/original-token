multiline_comment|/*&n; *  linux/fs/ext2/super.c&n; *&n; *  Copyright (C) 1992, 1993  Remy Card (card@masi.ibp.fr)&n; *&n; *  from&n; *&n; *  linux/fs/minix/inode.c&n; *&n; *  Copyright (C) 1991, 1992  Linus Torvalds&n; */
macro_line|#include &lt;stdarg.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/ext2_fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/locks.h&gt;
r_extern
r_int
id|vsprintf
(paren
r_char
op_star
comma
r_const
r_char
op_star
comma
id|va_list
)paren
suffix:semicolon
DECL|function|ext2_error
r_void
id|ext2_error
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_const
r_char
op_star
id|function
comma
r_const
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
r_char
id|buf
(braket
l_int|1024
)braket
suffix:semicolon
id|va_list
id|args
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
)paren
(brace
id|sb-&gt;u.ext2_sb.s_mount_state
op_or_assign
id|EXT2_ERROR_FS
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_es-&gt;s_state
op_or_assign
id|EXT2_ERROR_FS
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_sbh-&gt;b_dirt
op_assign
l_int|1
suffix:semicolon
id|sb-&gt;s_dirt
op_assign
l_int|1
suffix:semicolon
)brace
id|va_start
(paren
id|args
comma
id|fmt
)paren
suffix:semicolon
id|vsprintf
(paren
id|buf
comma
id|fmt
comma
id|args
)paren
suffix:semicolon
id|va_end
(paren
id|args
)paren
suffix:semicolon
id|printk
(paren
macro_line|#ifdef KERN_ERR
id|KERN_ERR
macro_line|#endif
l_string|&quot;EXT2-fs error (device %d/%d): %s: %s&bslash;n&quot;
comma
id|MAJOR
c_func
(paren
id|sb-&gt;s_dev
)paren
comma
id|MINOR
c_func
(paren
id|sb-&gt;s_dev
)paren
comma
id|function
comma
id|buf
)paren
suffix:semicolon
)brace
DECL|function|ext2_panic
r_volatile
r_void
id|ext2_panic
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_const
r_char
op_star
id|function
comma
r_const
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
r_char
id|buf
(braket
l_int|1024
)braket
suffix:semicolon
id|va_list
id|args
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
)paren
(brace
id|sb-&gt;u.ext2_sb.s_mount_state
op_or_assign
id|EXT2_ERROR_FS
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_es-&gt;s_state
op_or_assign
id|EXT2_ERROR_FS
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_sbh-&gt;b_dirt
op_assign
l_int|1
suffix:semicolon
id|sb-&gt;s_dirt
op_assign
l_int|1
suffix:semicolon
)brace
id|va_start
(paren
id|args
comma
id|fmt
)paren
suffix:semicolon
id|vsprintf
(paren
id|buf
comma
id|fmt
comma
id|args
)paren
suffix:semicolon
id|va_end
(paren
id|args
)paren
suffix:semicolon
id|panic
(paren
l_string|&quot;EXT2-fs panic (device %d/%d): %s: %s&bslash;n&quot;
comma
id|MAJOR
c_func
(paren
id|sb-&gt;s_dev
)paren
comma
id|MINOR
c_func
(paren
id|sb-&gt;s_dev
)paren
comma
id|function
comma
id|buf
)paren
suffix:semicolon
)brace
DECL|function|ext2_warning
r_void
id|ext2_warning
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_const
r_char
op_star
id|function
comma
r_const
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
r_char
id|buf
(braket
l_int|1024
)braket
suffix:semicolon
id|va_list
id|args
suffix:semicolon
id|va_start
(paren
id|args
comma
id|fmt
)paren
suffix:semicolon
id|vsprintf
(paren
id|buf
comma
id|fmt
comma
id|args
)paren
suffix:semicolon
id|va_end
(paren
id|args
)paren
suffix:semicolon
id|printk
(paren
macro_line|#ifdef KERN_WARNING
id|KERN_WARNING
macro_line|#endif
l_string|&quot;EXT2-fs warning (device %d/%d): %s: %s&bslash;n&quot;
comma
id|MAJOR
c_func
(paren
id|sb-&gt;s_dev
)paren
comma
id|MINOR
c_func
(paren
id|sb-&gt;s_dev
)paren
comma
id|function
comma
id|buf
)paren
suffix:semicolon
)brace
DECL|function|ext2_put_super
r_void
id|ext2_put_super
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_int
id|i
suffix:semicolon
id|lock_super
(paren
id|sb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
)paren
(brace
id|sb-&gt;u.ext2_sb.s_es-&gt;s_state
op_assign
id|sb-&gt;u.ext2_sb.s_mount_state
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_sbh-&gt;b_dirt
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#ifndef DONT_USE_DCACHE
id|ext2_dcache_invalidate
(paren
id|sb-&gt;s_dev
)paren
suffix:semicolon
macro_line|#endif
id|sb-&gt;s_dev
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|EXT2_MAX_GROUP_DESC
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|sb-&gt;u.ext2_sb.s_group_desc
(braket
id|i
)braket
)paren
id|brelse
(paren
id|sb-&gt;u.ext2_sb.s_group_desc
(braket
id|i
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|EXT2_MAX_GROUP_LOADED
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|sb-&gt;u.ext2_sb.s_inode_bitmap
(braket
id|i
)braket
)paren
id|brelse
(paren
id|sb-&gt;u.ext2_sb.s_inode_bitmap
(braket
id|i
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|EXT2_MAX_GROUP_LOADED
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|sb-&gt;u.ext2_sb.s_block_bitmap
(braket
id|i
)braket
)paren
id|brelse
(paren
id|sb-&gt;u.ext2_sb.s_block_bitmap
(braket
id|i
)braket
)paren
suffix:semicolon
id|brelse
(paren
id|sb-&gt;u.ext2_sb.s_sbh
)paren
suffix:semicolon
id|unlock_super
(paren
id|sb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|variable|ext2_sops
r_static
r_struct
id|super_operations
id|ext2_sops
op_assign
(brace
id|ext2_read_inode
comma
l_int|NULL
comma
id|ext2_write_inode
comma
id|ext2_put_inode
comma
id|ext2_put_super
comma
id|ext2_write_super
comma
id|ext2_statfs
comma
id|ext2_remount
)brace
suffix:semicolon
macro_line|#ifdef EXT2FS_PRE_02B_COMPAT
DECL|function|convert_pre_02b_fs
r_static
r_int
id|convert_pre_02b_fs
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|buffer_head
op_star
id|bh
)paren
(brace
r_struct
id|ext2_super_block
op_star
id|es
suffix:semicolon
r_struct
id|ext2_old_group_desc
id|old_group_desc
(braket
id|BLOCK_SIZE
op_div
r_sizeof
(paren
r_struct
id|ext2_old_group_desc
)paren
)braket
suffix:semicolon
r_struct
id|ext2_group_desc
op_star
id|gdp
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh2
suffix:semicolon
r_int
id|groups_count
suffix:semicolon
r_int
id|i
suffix:semicolon
id|es
op_assign
(paren
r_struct
id|ext2_super_block
op_star
)paren
id|bh-&gt;b_data
suffix:semicolon
id|bh2
op_assign
id|bread
(paren
id|sb-&gt;s_dev
comma
l_int|2
comma
id|BLOCK_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bh2
)paren
(brace
id|printk
(paren
l_string|&quot;Cannot read descriptor blocks while converting !&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|memcpy
(paren
id|old_group_desc
comma
id|bh2-&gt;b_data
comma
id|BLOCK_SIZE
)paren
suffix:semicolon
id|groups_count
op_assign
(paren
id|sb-&gt;u.ext2_sb.s_blocks_count
op_minus
id|sb-&gt;u.ext2_sb.s_first_data_block
op_plus
(paren
id|EXT2_BLOCK_SIZE
c_func
(paren
id|sb
)paren
op_star
l_int|8
)paren
op_minus
l_int|1
)paren
op_div
(paren
id|EXT2_BLOCK_SIZE
c_func
(paren
id|sb
)paren
op_star
l_int|8
)paren
suffix:semicolon
id|memset
(paren
id|bh2-&gt;b_data
comma
l_int|0
comma
id|BLOCK_SIZE
)paren
suffix:semicolon
id|gdp
op_assign
(paren
r_struct
id|ext2_group_desc
op_star
)paren
id|bh2-&gt;b_data
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|groups_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|gdp
(braket
id|i
)braket
dot
id|bg_block_bitmap
op_assign
id|old_group_desc
(braket
id|i
)braket
dot
id|bg_block_bitmap
suffix:semicolon
id|gdp
(braket
id|i
)braket
dot
id|bg_inode_bitmap
op_assign
id|old_group_desc
(braket
id|i
)braket
dot
id|bg_inode_bitmap
suffix:semicolon
id|gdp
(braket
id|i
)braket
dot
id|bg_inode_table
op_assign
id|old_group_desc
(braket
id|i
)braket
dot
id|bg_inode_table
suffix:semicolon
id|gdp
(braket
id|i
)braket
dot
id|bg_free_blocks_count
op_assign
id|old_group_desc
(braket
id|i
)braket
dot
id|bg_free_blocks_count
suffix:semicolon
id|gdp
(braket
id|i
)braket
dot
id|bg_free_inodes_count
op_assign
id|old_group_desc
(braket
id|i
)braket
dot
id|bg_free_inodes_count
suffix:semicolon
)brace
id|bh2-&gt;b_dirt
op_assign
l_int|1
suffix:semicolon
id|brelse
(paren
id|bh2
)paren
suffix:semicolon
id|es-&gt;s_magic
op_assign
id|EXT2_SUPER_MAGIC
suffix:semicolon
id|bh-&gt;b_dirt
op_assign
l_int|1
suffix:semicolon
id|sb-&gt;s_magic
op_assign
id|EXT2_SUPER_MAGIC
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * This function has been shamelessly adapted from the msdos fs&n; */
DECL|function|parse_options
r_static
r_int
id|parse_options
(paren
r_char
op_star
id|options
comma
r_int
r_int
op_star
id|sb_block
comma
r_int
r_int
op_star
id|mount_options
)paren
(brace
r_char
op_star
id|this_char
suffix:semicolon
r_char
op_star
id|value
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
)paren
r_return
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|this_char
op_assign
id|strtok
(paren
id|options
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
id|this_char
op_ne
l_int|NULL
suffix:semicolon
id|this_char
op_assign
id|strtok
(paren
l_int|NULL
comma
l_string|&quot;,&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|value
op_assign
id|strchr
(paren
id|this_char
comma
l_char|&squot;=&squot;
)paren
)paren
op_ne
l_int|NULL
)paren
op_star
id|value
op_increment
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
(paren
id|this_char
comma
l_string|&quot;check&quot;
)paren
)paren
op_star
id|mount_options
op_or_assign
id|EXT2_MOUNT_CHECK
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
(paren
id|this_char
comma
l_string|&quot;sb&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
op_logical_or
op_logical_neg
op_star
id|value
)paren
r_return
l_int|0
suffix:semicolon
op_star
id|sb_block
op_assign
id|simple_strtoul
(paren
id|value
comma
op_amp
id|value
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|value
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|printk
(paren
l_string|&quot;EXT2-fs: Unrecognized mount option %s&bslash;n&quot;
comma
id|this_char
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|ext2_read_super
r_struct
id|super_block
op_star
id|ext2_read_super
(paren
r_struct
id|super_block
op_star
id|s
comma
r_void
op_star
id|data
comma
r_int
id|silent
)paren
(brace
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_struct
id|ext2_super_block
op_star
id|es
suffix:semicolon
r_int
r_int
id|sb_block
op_assign
l_int|1
suffix:semicolon
r_int
r_int
id|logic_sb_block
op_assign
l_int|1
suffix:semicolon
r_int
id|dev
op_assign
id|s-&gt;s_dev
suffix:semicolon
r_int
id|bh_count
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
macro_line|#ifdef EXT2FS_PRE_02B_COMPAT
r_int
id|fs_converted
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|s-&gt;u.ext2_sb.s_mount_opt
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|parse_options
(paren
(paren
r_char
op_star
)paren
id|data
comma
op_amp
id|sb_block
comma
op_amp
id|s-&gt;u.ext2_sb.s_mount_opt
)paren
)paren
(brace
id|s-&gt;s_dev
op_assign
l_int|0
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|lock_super
(paren
id|s
)paren
suffix:semicolon
id|set_blocksize
(paren
id|dev
comma
id|BLOCK_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bh
op_assign
id|bread
(paren
id|dev
comma
id|sb_block
comma
id|BLOCK_SIZE
)paren
)paren
)paren
(brace
id|s-&gt;s_dev
op_assign
l_int|0
suffix:semicolon
id|unlock_super
(paren
id|s
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;EXT2-fs: unable to read superblock&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|es
op_assign
(paren
r_struct
id|ext2_super_block
op_star
)paren
id|bh-&gt;b_data
suffix:semicolon
multiline_comment|/* Note: s_es must be initialized s_es as soon as possible because&n;&t;   some ext2 macro-instructions depend on its value */
id|s-&gt;u.ext2_sb.s_es
op_assign
id|es
suffix:semicolon
id|s-&gt;s_magic
op_assign
id|es-&gt;s_magic
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;s_magic
op_ne
id|EXT2_SUPER_MAGIC
macro_line|#ifdef EXT2FS_PRE_02B_COMPAT
op_logical_and
id|s-&gt;s_magic
op_ne
id|EXT2_PRE_02B_MAGIC
macro_line|#endif
)paren
(brace
id|s-&gt;s_dev
op_assign
l_int|0
suffix:semicolon
id|unlock_super
(paren
id|s
)paren
suffix:semicolon
id|brelse
(paren
id|bh
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|silent
)paren
id|printk
(paren
l_string|&quot;VFS: Can&squot;t find an ext2 filesystem on dev 0x%04x.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|s-&gt;s_blocksize
op_assign
id|EXT2_MIN_BLOCK_SIZE
op_lshift
id|es-&gt;s_log_block_size
suffix:semicolon
id|s-&gt;s_blocksize_bits
op_assign
id|EXT2_BLOCK_SIZE_BITS
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;s_blocksize
op_ne
id|BLOCK_SIZE
op_logical_and
(paren
id|s-&gt;s_blocksize
op_eq
l_int|1024
op_logical_or
id|s-&gt;s_blocksize
op_eq
l_int|2048
op_logical_or
id|s-&gt;s_blocksize
op_eq
l_int|4096
)paren
)paren
(brace
r_int
r_int
id|offset
suffix:semicolon
id|brelse
(paren
id|bh
)paren
suffix:semicolon
id|set_blocksize
(paren
id|dev
comma
id|s-&gt;s_blocksize
)paren
suffix:semicolon
id|logic_sb_block
op_assign
id|sb_block
op_div
id|s-&gt;s_blocksize
suffix:semicolon
id|offset
op_assign
id|sb_block
op_mod
id|s-&gt;s_blocksize
suffix:semicolon
id|bh
op_assign
id|bread
(paren
id|dev
comma
id|logic_sb_block
comma
id|s-&gt;s_blocksize
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bh
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
id|es
op_assign
(paren
r_struct
id|ext2_super_block
op_star
)paren
(paren
(paren
(paren
r_char
op_star
)paren
id|bh-&gt;b_data
)paren
op_plus
id|offset
)paren
suffix:semicolon
id|s-&gt;u.ext2_sb.s_es
op_assign
id|es
suffix:semicolon
r_if
c_cond
(paren
id|es-&gt;s_magic
op_ne
id|EXT2_SUPER_MAGIC
)paren
(brace
id|s-&gt;s_dev
op_assign
l_int|0
suffix:semicolon
id|unlock_super
(paren
id|s
)paren
suffix:semicolon
id|brelse
(paren
id|bh
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;EXT2-fs: Magic mismatch, very weird !&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
id|s-&gt;u.ext2_sb.s_frag_size
op_assign
id|EXT2_MIN_FRAG_SIZE
op_lshift
id|es-&gt;s_log_frag_size
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;u.ext2_sb.s_frag_size
)paren
id|s-&gt;u.ext2_sb.s_frags_per_block
op_assign
id|s-&gt;s_blocksize
op_div
id|s-&gt;u.ext2_sb.s_frag_size
suffix:semicolon
r_else
id|s-&gt;s_magic
op_assign
l_int|0
suffix:semicolon
id|s-&gt;u.ext2_sb.s_blocks_per_group
op_assign
id|es-&gt;s_blocks_per_group
suffix:semicolon
id|s-&gt;u.ext2_sb.s_frags_per_group
op_assign
id|es-&gt;s_frags_per_group
suffix:semicolon
id|s-&gt;u.ext2_sb.s_inodes_per_group
op_assign
id|es-&gt;s_inodes_per_group
suffix:semicolon
id|s-&gt;u.ext2_sb.s_inodes_per_block
op_assign
id|s-&gt;s_blocksize
op_div
r_sizeof
(paren
r_struct
id|ext2_inode
)paren
suffix:semicolon
id|s-&gt;u.ext2_sb.s_desc_per_block
op_assign
id|s-&gt;s_blocksize
op_div
r_sizeof
(paren
r_struct
id|ext2_group_desc
)paren
suffix:semicolon
id|s-&gt;u.ext2_sb.s_sbh
op_assign
id|bh
suffix:semicolon
id|s-&gt;u.ext2_sb.s_es
op_assign
id|es
suffix:semicolon
id|s-&gt;u.ext2_sb.s_mount_state
op_assign
id|es-&gt;s_state
suffix:semicolon
id|s-&gt;u.ext2_sb.s_rename_lock
op_assign
l_int|0
suffix:semicolon
id|s-&gt;u.ext2_sb.s_rename_wait
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef EXT2FS_PRE_02B_COMPAT
r_if
c_cond
(paren
id|s-&gt;s_magic
op_eq
id|EXT2_PRE_02B_MAGIC
)paren
(brace
r_if
c_cond
(paren
id|es-&gt;s_blocks_count
OG
l_int|262144
)paren
(brace
multiline_comment|/* fs &gt; 256 MB can&squot;t be converted */
id|s-&gt;s_dev
op_assign
l_int|0
suffix:semicolon
id|unlock_super
(paren
id|s
)paren
suffix:semicolon
id|brelse
(paren
id|bh
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;EXT2-fs: trying to mount a pre-0.2b file&quot;
l_string|&quot;system which cannot be converted&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot;EXT2-fs: mounting a pre 0.2b file system, &quot;
l_string|&quot;will try to convert the structure&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|s-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
)paren
(brace
id|s-&gt;s_dev
op_assign
l_int|0
suffix:semicolon
id|unlock_super
(paren
id|s
)paren
suffix:semicolon
id|brelse
(paren
id|bh
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;EXT2-fs: cannot convert a read-only fs&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|convert_pre_02b_fs
(paren
id|s
comma
id|bh
)paren
)paren
(brace
id|s-&gt;s_dev
op_assign
l_int|0
suffix:semicolon
id|unlock_super
(paren
id|s
)paren
suffix:semicolon
id|brelse
(paren
id|bh
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;EXT2-fs: conversion failed !!!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot;EXT2-fs: conversion succeeded !!!&bslash;n&quot;
)paren
suffix:semicolon
id|fs_converted
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|s-&gt;s_magic
op_ne
id|EXT2_SUPER_MAGIC
)paren
(brace
id|s-&gt;s_dev
op_assign
l_int|0
suffix:semicolon
id|unlock_super
(paren
id|s
)paren
suffix:semicolon
id|brelse
(paren
id|bh
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|silent
)paren
id|printk
(paren
l_string|&quot;VFS: Can&squot;t find an ext2 filesystem on dev 0x%04x.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s-&gt;s_blocksize
op_ne
id|bh-&gt;b_size
)paren
(brace
id|s-&gt;s_dev
op_assign
l_int|0
suffix:semicolon
id|unlock_super
(paren
id|s
)paren
suffix:semicolon
id|brelse
(paren
id|bh
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|silent
)paren
id|printk
(paren
l_string|&quot;VFS: Unsupported blocksize on dev 0x%04x.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s-&gt;s_blocksize
op_ne
id|s-&gt;u.ext2_sb.s_frag_size
)paren
(brace
id|s-&gt;s_dev
op_assign
l_int|0
suffix:semicolon
id|unlock_super
(paren
id|s
)paren
suffix:semicolon
id|brelse
(paren
id|bh
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;EXT2-fs: fragsize %lu != blocksize %lu (not supported yet)&bslash;n&quot;
comma
id|s-&gt;u.ext2_sb.s_frag_size
comma
id|s-&gt;s_blocksize
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|s-&gt;u.ext2_sb.s_groups_count
op_assign
(paren
id|es-&gt;s_blocks_count
op_minus
id|es-&gt;s_first_data_block
op_plus
id|EXT2_BLOCKS_PER_GROUP
c_func
(paren
id|s
)paren
op_minus
l_int|1
)paren
op_div
id|EXT2_BLOCKS_PER_GROUP
c_func
(paren
id|s
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|EXT2_MAX_GROUP_DESC
suffix:semicolon
id|i
op_increment
)paren
id|s-&gt;u.ext2_sb.s_group_desc
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|bh_count
op_assign
(paren
id|s-&gt;u.ext2_sb.s_groups_count
op_plus
id|EXT2_DESC_PER_BLOCK
c_func
(paren
id|s
)paren
op_minus
l_int|1
)paren
op_div
id|EXT2_DESC_PER_BLOCK
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bh_count
OG
id|EXT2_MAX_GROUP_DESC
)paren
(brace
id|s-&gt;s_dev
op_assign
l_int|0
suffix:semicolon
id|unlock_super
(paren
id|s
)paren
suffix:semicolon
id|brelse
(paren
id|bh
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;EXT2-fs: file system is too big&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|bh_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|s-&gt;u.ext2_sb.s_group_desc
(braket
id|i
)braket
op_assign
id|bread
(paren
id|dev
comma
id|logic_sb_block
op_plus
id|i
op_plus
l_int|1
comma
id|s-&gt;s_blocksize
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;u.ext2_sb.s_group_desc
(braket
id|i
)braket
)paren
(brace
id|s-&gt;s_dev
op_assign
l_int|0
suffix:semicolon
id|unlock_super
(paren
id|s
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|i
suffix:semicolon
id|j
op_increment
)paren
id|brelse
(paren
id|s-&gt;u.ext2_sb.s_group_desc
(braket
id|i
)braket
)paren
suffix:semicolon
id|brelse
(paren
id|bh
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;EXT2-fs: unable to read group descriptors&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|EXT2_MAX_GROUP_LOADED
suffix:semicolon
id|i
op_increment
)paren
(brace
id|s-&gt;u.ext2_sb.s_inode_bitmap_number
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|s-&gt;u.ext2_sb.s_inode_bitmap
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|s-&gt;u.ext2_sb.s_block_bitmap_number
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|s-&gt;u.ext2_sb.s_block_bitmap
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|s-&gt;u.ext2_sb.s_loaded_inode_bitmaps
op_assign
l_int|0
suffix:semicolon
id|s-&gt;u.ext2_sb.s_loaded_block_bitmaps
op_assign
l_int|0
suffix:semicolon
id|unlock_super
(paren
id|s
)paren
suffix:semicolon
multiline_comment|/* set up enough so that it can read an inode */
id|s-&gt;s_dev
op_assign
id|dev
suffix:semicolon
id|s-&gt;s_op
op_assign
op_amp
id|ext2_sops
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|s-&gt;s_mounted
op_assign
id|iget
(paren
id|s
comma
id|EXT2_ROOT_INO
)paren
)paren
)paren
(brace
id|s-&gt;s_dev
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|EXT2_MAX_GROUP_DESC
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|s-&gt;u.ext2_sb.s_group_desc
(braket
id|i
)braket
)paren
id|brelse
(paren
id|s-&gt;u.ext2_sb.s_group_desc
(braket
id|i
)braket
)paren
suffix:semicolon
id|brelse
(paren
id|bh
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;EXT2-fs: get root inode failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|s-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
)paren
(brace
id|es-&gt;s_state
op_and_assign
op_complement
id|EXT2_VALID_FS
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|es-&gt;s_max_mnt_count
)paren
id|es-&gt;s_max_mnt_count
op_assign
id|EXT2_DFL_MAX_MNT_COUNT
suffix:semicolon
id|es-&gt;s_mnt_count
op_increment
suffix:semicolon
id|es-&gt;s_mtime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|bh-&gt;b_dirt
op_assign
l_int|1
suffix:semicolon
id|s-&gt;s_dirt
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef EXT2FS_PRE_02B_COMPAT
r_if
c_cond
(paren
id|fs_converted
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|bh_count
suffix:semicolon
id|i
op_increment
)paren
id|s-&gt;u.ext2_sb.s_group_desc
(braket
id|i
)braket
op_member_access_from_pointer
id|b_dirt
op_assign
l_int|1
suffix:semicolon
id|s-&gt;s_dirt
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
(paren
id|s-&gt;u.ext2_sb.s_mount_state
op_amp
id|EXT2_VALID_FS
)paren
)paren
id|printk
(paren
l_string|&quot;EXT2-fs warning: mounting unchecked file system, &quot;
l_string|&quot;running e2fsck is recommended&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|s-&gt;u.ext2_sb.s_mount_state
op_amp
id|EXT2_ERROR_FS
)paren
id|printk
(paren
l_string|&quot;EXT2-fs warning: mounting file system with errors, &quot;
l_string|&quot;running e2fsck is recommended&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|es-&gt;s_mnt_count
op_ge
id|es-&gt;s_max_mnt_count
)paren
id|printk
(paren
l_string|&quot;EXT2-fs warning: maximal mount count reached, &quot;
l_string|&quot;running e2fsck is recommended&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;u.ext2_sb.s_mount_opt
op_amp
id|EXT2_MOUNT_CHECK
)paren
(brace
id|printk
(paren
l_string|&quot;[EXT II FS %s, %s, bs=%lu, fs=%lu, gc=%lu, bpg=%lu, ipg=%lu]&bslash;n&quot;
comma
id|EXT2FS_VERSION
comma
id|EXT2FS_DATE
comma
id|s-&gt;s_blocksize
comma
id|s-&gt;u.ext2_sb.s_frag_size
comma
id|s-&gt;u.ext2_sb.s_groups_count
comma
id|EXT2_BLOCKS_PER_GROUP
c_func
(paren
id|s
)paren
comma
id|EXT2_INODES_PER_GROUP
c_func
(paren
id|s
)paren
)paren
suffix:semicolon
id|ext2_check_blocks_bitmap
(paren
id|s
)paren
suffix:semicolon
id|ext2_check_inodes_bitmap
(paren
id|s
)paren
suffix:semicolon
)brace
r_return
id|s
suffix:semicolon
)brace
DECL|function|ext2_commit_super
r_static
r_void
id|ext2_commit_super
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ext2_super_block
op_star
id|es
)paren
(brace
id|es-&gt;s_wtime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_sbh-&gt;b_dirt
op_assign
l_int|1
suffix:semicolon
id|sb-&gt;s_dirt
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * In the second extended file system, it is not necessary to&n; * write the super block since we use a mapping of the&n; * disk super block in a buffer.&n; *&n; * However, this function is still used to set the fs valid&n; * flags to 0.  We need to set this flag to 0 since the fs&n; * may have been checked while mounted and e2fsck may have&n; * set s_state to EXT2_VALID_FS after some corrections.&n; */
DECL|function|ext2_write_super
r_void
id|ext2_write_super
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_struct
id|ext2_super_block
op_star
id|es
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
)paren
(brace
id|es
op_assign
id|sb-&gt;u.ext2_sb.s_es
suffix:semicolon
id|ext2_debug
(paren
l_string|&quot;setting valid to 0&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|es-&gt;s_state
op_amp
id|EXT2_VALID_FS
)paren
(brace
id|es-&gt;s_state
op_and_assign
op_complement
id|EXT2_VALID_FS
suffix:semicolon
id|es-&gt;s_mtime
op_assign
id|CURRENT_TIME
suffix:semicolon
)brace
id|ext2_commit_super
(paren
id|sb
comma
id|es
)paren
suffix:semicolon
)brace
id|sb-&gt;s_dirt
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|ext2_remount
r_int
id|ext2_remount
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_int
op_star
id|flags
)paren
(brace
r_struct
id|ext2_super_block
op_star
id|es
suffix:semicolon
id|es
op_assign
id|sb-&gt;u.ext2_sb.s_es
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|flags
op_amp
id|MS_RDONLY
)paren
op_eq
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_star
id|flags
op_amp
id|MS_RDONLY
)paren
(brace
r_if
c_cond
(paren
id|es-&gt;s_state
op_amp
id|EXT2_VALID_FS
op_logical_or
op_logical_neg
(paren
id|sb-&gt;u.ext2_sb.s_mount_state
op_amp
id|EXT2_VALID_FS
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* OK, we are remounting a valid rw partition rdonly, so set&n;&t;&t;   the rdonly flag and then mark the partition as valid&n;&t;&t;   again. */
id|es-&gt;s_state
op_assign
id|sb-&gt;u.ext2_sb.s_mount_state
suffix:semicolon
id|es-&gt;s_mtime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_sbh-&gt;b_dirt
op_assign
l_int|1
suffix:semicolon
id|sb-&gt;s_dirt
op_assign
l_int|1
suffix:semicolon
id|ext2_commit_super
(paren
id|sb
comma
id|es
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Mounting a RDONLY partition read-write, so reread and&n;&t;&t;   store the current valid flag.  (It may have been changed &n;&t;&t;   by e2fsck since we originally mounted the partition.)  */
id|sb-&gt;u.ext2_sb.s_mount_state
op_assign
id|es-&gt;s_state
suffix:semicolon
id|es-&gt;s_state
op_and_assign
op_complement
id|EXT2_VALID_FS
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|es-&gt;s_max_mnt_count
)paren
id|es-&gt;s_max_mnt_count
op_assign
id|EXT2_DFL_MAX_MNT_COUNT
suffix:semicolon
id|es-&gt;s_mnt_count
op_increment
suffix:semicolon
id|es-&gt;s_mtime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_sbh-&gt;b_dirt
op_assign
l_int|1
suffix:semicolon
id|sb-&gt;s_dirt
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb-&gt;u.ext2_sb.s_mount_state
op_amp
id|EXT2_VALID_FS
)paren
)paren
id|printk
(paren
l_string|&quot;EXT2-fs warning: remounting unchecked fs, &quot;
l_string|&quot;running e2fsck is recommended&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|sb-&gt;u.ext2_sb.s_mount_state
op_amp
id|EXT2_ERROR_FS
)paren
)paren
id|printk
(paren
l_string|&quot;EXT2-fs warning: remounting fs with errors, &quot;
l_string|&quot;running e2fsck is recommended&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|es-&gt;s_mnt_count
op_ge
id|es-&gt;s_max_mnt_count
)paren
id|printk
(paren
l_string|&quot;EXT2-fs warning: maximal mount count reached, &quot;
l_string|&quot;running e2fsck is recommended&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ext2_statfs
r_void
id|ext2_statfs
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|statfs
op_star
id|buf
)paren
(brace
r_int
id|tmp
suffix:semicolon
id|put_fs_long
(paren
id|EXT2_SUPER_MAGIC
comma
op_amp
id|buf-&gt;f_type
)paren
suffix:semicolon
id|put_fs_long
(paren
id|sb-&gt;s_blocksize
comma
op_amp
id|buf-&gt;f_bsize
)paren
suffix:semicolon
id|put_fs_long
(paren
id|sb-&gt;u.ext2_sb.s_es-&gt;s_blocks_count
comma
op_amp
id|buf-&gt;f_blocks
)paren
suffix:semicolon
id|tmp
op_assign
id|ext2_count_free_blocks
(paren
id|sb
)paren
suffix:semicolon
id|put_fs_long
(paren
id|tmp
comma
op_amp
id|buf-&gt;f_bfree
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_ge
id|sb-&gt;u.ext2_sb.s_es-&gt;s_r_blocks_count
)paren
id|put_fs_long
(paren
id|tmp
op_minus
id|sb-&gt;u.ext2_sb.s_es-&gt;s_r_blocks_count
comma
op_amp
id|buf-&gt;f_bavail
)paren
suffix:semicolon
r_else
id|put_fs_long
(paren
l_int|0
comma
op_amp
id|buf-&gt;f_bavail
)paren
suffix:semicolon
id|put_fs_long
(paren
id|sb-&gt;u.ext2_sb.s_es-&gt;s_inodes_count
comma
op_amp
id|buf-&gt;f_files
)paren
suffix:semicolon
id|put_fs_long
(paren
id|ext2_count_free_inodes
(paren
id|sb
)paren
comma
op_amp
id|buf-&gt;f_ffree
)paren
suffix:semicolon
id|put_fs_long
(paren
id|EXT2_NAME_LEN
comma
op_amp
id|buf-&gt;f_namelen
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t know what value to put in buf-&gt;f_fsid */
)brace
eof
