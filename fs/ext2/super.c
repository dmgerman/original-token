multiline_comment|/*&n; *  linux/fs/ext2/super.c&n; *&n; * Copyright (C) 1992, 1993, 1994, 1995&n; * Remy Card (card@masi.ibp.fr)&n; * Laboratoire MASI - Institut Blaise Pascal&n; * Universite Pierre et Marie Curie (Paris VI)&n; *&n; *  from&n; *&n; *  linux/fs/minix/inode.c&n; *&n; *  Copyright (C) 1991, 1992  Linus Torvalds&n; *&n; *  Big-endian to little-endian byte-swapping/bitmaps by&n; *        David S. Miller (davem@caip.rutgers.edu), 1995&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/ext2_fs.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/locks.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
DECL|variable|error_buf
r_static
r_char
id|error_buf
(braket
l_int|1024
)braket
suffix:semicolon
DECL|function|ext2_error
r_void
id|ext2_error
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_const
r_char
op_star
id|function
comma
r_const
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
id|va_list
id|args
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
)paren
(brace
id|sb-&gt;u.ext2_sb.s_mount_state
op_or_assign
id|EXT2_ERROR_FS
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_es-&gt;s_state
op_assign
id|cpu_to_le16
c_func
(paren
id|le16_to_cpu
c_func
(paren
id|sb-&gt;u.ext2_sb.s_es-&gt;s_state
)paren
op_or
id|EXT2_ERROR_FS
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|sb-&gt;u.ext2_sb.s_sbh
)paren
suffix:semicolon
id|sb-&gt;s_dirt
op_assign
l_int|1
suffix:semicolon
)brace
id|va_start
(paren
id|args
comma
id|fmt
)paren
suffix:semicolon
id|vsprintf
(paren
id|error_buf
comma
id|fmt
comma
id|args
)paren
suffix:semicolon
id|va_end
(paren
id|args
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_opt
(paren
id|sb
comma
id|ERRORS_PANIC
)paren
op_logical_or
(paren
id|le16_to_cpu
c_func
(paren
id|sb-&gt;u.ext2_sb.s_es-&gt;s_errors
)paren
op_eq
id|EXT2_ERRORS_PANIC
op_logical_and
op_logical_neg
id|test_opt
(paren
id|sb
comma
id|ERRORS_CONT
)paren
op_logical_and
op_logical_neg
id|test_opt
(paren
id|sb
comma
id|ERRORS_RO
)paren
)paren
)paren
id|panic
(paren
l_string|&quot;EXT2-fs panic (device %s): %s: %s&bslash;n&quot;
comma
id|bdevname
c_func
(paren
id|sb-&gt;s_dev
)paren
comma
id|function
comma
id|error_buf
)paren
suffix:semicolon
id|printk
(paren
id|KERN_CRIT
l_string|&quot;EXT2-fs error (device %s): %s: %s&bslash;n&quot;
comma
id|bdevname
c_func
(paren
id|sb-&gt;s_dev
)paren
comma
id|function
comma
id|error_buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_opt
(paren
id|sb
comma
id|ERRORS_RO
)paren
op_logical_or
(paren
id|le16_to_cpu
c_func
(paren
id|sb-&gt;u.ext2_sb.s_es-&gt;s_errors
)paren
op_eq
id|EXT2_ERRORS_RO
op_logical_and
op_logical_neg
id|test_opt
(paren
id|sb
comma
id|ERRORS_CONT
)paren
op_logical_and
op_logical_neg
id|test_opt
(paren
id|sb
comma
id|ERRORS_PANIC
)paren
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;Remounting filesystem read-only&bslash;n&quot;
)paren
suffix:semicolon
id|sb-&gt;s_flags
op_or_assign
id|MS_RDONLY
suffix:semicolon
)brace
)brace
DECL|function|ext2_panic
id|NORET_TYPE
r_void
id|ext2_panic
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_const
r_char
op_star
id|function
comma
r_const
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
id|va_list
id|args
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
)paren
(brace
id|sb-&gt;u.ext2_sb.s_mount_state
op_or_assign
id|EXT2_ERROR_FS
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_es-&gt;s_state
op_assign
id|cpu_to_le16
c_func
(paren
id|le16_to_cpu
c_func
(paren
id|sb-&gt;u.ext2_sb.s_es-&gt;s_state
)paren
op_or
id|EXT2_ERROR_FS
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|sb-&gt;u.ext2_sb.s_sbh
)paren
suffix:semicolon
id|sb-&gt;s_dirt
op_assign
l_int|1
suffix:semicolon
)brace
id|va_start
(paren
id|args
comma
id|fmt
)paren
suffix:semicolon
id|vsprintf
(paren
id|error_buf
comma
id|fmt
comma
id|args
)paren
suffix:semicolon
id|va_end
(paren
id|args
)paren
suffix:semicolon
multiline_comment|/* this is to prevent panic from syncing this filesystem */
r_if
c_cond
(paren
id|sb-&gt;s_lock
)paren
id|sb-&gt;s_lock
op_assign
l_int|0
suffix:semicolon
id|sb-&gt;s_flags
op_or_assign
id|MS_RDONLY
suffix:semicolon
id|panic
(paren
l_string|&quot;EXT2-fs panic (device %s): %s: %s&bslash;n&quot;
comma
id|bdevname
c_func
(paren
id|sb-&gt;s_dev
)paren
comma
id|function
comma
id|error_buf
)paren
suffix:semicolon
)brace
DECL|function|ext2_warning
r_void
id|ext2_warning
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_const
r_char
op_star
id|function
comma
r_const
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
id|va_list
id|args
suffix:semicolon
id|va_start
(paren
id|args
comma
id|fmt
)paren
suffix:semicolon
id|vsprintf
(paren
id|error_buf
comma
id|fmt
comma
id|args
)paren
suffix:semicolon
id|va_end
(paren
id|args
)paren
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;EXT2-fs warning (device %s): %s: %s&bslash;n&quot;
comma
id|bdevname
c_func
(paren
id|sb-&gt;s_dev
)paren
comma
id|function
comma
id|error_buf
)paren
suffix:semicolon
)brace
DECL|function|ext2_update_dynamic_rev
r_void
id|ext2_update_dynamic_rev
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_struct
id|ext2_super_block
op_star
id|es
op_assign
id|EXT2_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_es
suffix:semicolon
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_rev_level
)paren
OG
id|EXT2_GOOD_OLD_REV
)paren
r_return
suffix:semicolon
id|ext2_warning
c_func
(paren
id|sb
comma
id|__FUNCTION__
comma
l_string|&quot;updating to rev %d because of new feature flag, &quot;
l_string|&quot;running e2fsck is recommended&quot;
comma
id|EXT2_DYNAMIC_REV
)paren
suffix:semicolon
id|es-&gt;s_first_ino
op_assign
id|cpu_to_le32
c_func
(paren
id|EXT2_GOOD_OLD_FIRST_INO
)paren
suffix:semicolon
id|es-&gt;s_inode_size
op_assign
id|cpu_to_le16
c_func
(paren
id|EXT2_GOOD_OLD_INODE_SIZE
)paren
suffix:semicolon
id|es-&gt;s_rev_level
op_assign
id|cpu_to_le32
c_func
(paren
id|EXT2_DYNAMIC_REV
)paren
suffix:semicolon
multiline_comment|/* leave es-&gt;s_feature_*compat flags alone */
multiline_comment|/* es-&gt;s_uuid will be set by e2fsck if empty */
multiline_comment|/*&n;&t; * The rest of the superblock fields should be zero, and if not it&n;&t; * means they are likely already in use, so leave them alone.  We&n;&t; * can leave it up to e2fsck to clean up any inconsistencies there.&n;&t; */
)brace
DECL|function|ext2_put_super
r_void
id|ext2_put_super
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_int
id|db_count
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
)paren
(brace
id|sb-&gt;u.ext2_sb.s_es-&gt;s_state
op_assign
id|le16_to_cpu
c_func
(paren
id|sb-&gt;u.ext2_sb.s_mount_state
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|sb-&gt;u.ext2_sb.s_sbh
)paren
suffix:semicolon
)brace
id|db_count
op_assign
id|EXT2_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_gdb_count
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|db_count
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|sb-&gt;u.ext2_sb.s_group_desc
(braket
id|i
)braket
)paren
id|brelse
(paren
id|sb-&gt;u.ext2_sb.s_group_desc
(braket
id|i
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sb-&gt;u.ext2_sb.s_group_desc
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|EXT2_MAX_GROUP_LOADED
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|sb-&gt;u.ext2_sb.s_inode_bitmap
(braket
id|i
)braket
)paren
id|brelse
(paren
id|sb-&gt;u.ext2_sb.s_inode_bitmap
(braket
id|i
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|EXT2_MAX_GROUP_LOADED
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|sb-&gt;u.ext2_sb.s_block_bitmap
(braket
id|i
)braket
)paren
id|brelse
(paren
id|sb-&gt;u.ext2_sb.s_block_bitmap
(braket
id|i
)braket
)paren
suffix:semicolon
id|brelse
(paren
id|sb-&gt;u.ext2_sb.s_sbh
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|variable|ext2_sops
r_static
r_struct
id|super_operations
id|ext2_sops
op_assign
(brace
id|read_inode
suffix:colon
id|ext2_read_inode
comma
id|write_inode
suffix:colon
id|ext2_write_inode
comma
id|put_inode
suffix:colon
id|ext2_put_inode
comma
id|delete_inode
suffix:colon
id|ext2_delete_inode
comma
id|put_super
suffix:colon
id|ext2_put_super
comma
id|write_super
suffix:colon
id|ext2_write_super
comma
id|statfs
suffix:colon
id|ext2_statfs
comma
id|remount_fs
suffix:colon
id|ext2_remount
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * This function has been shamelessly adapted from the msdos fs&n; */
DECL|function|parse_options
r_static
r_int
id|parse_options
(paren
r_char
op_star
id|options
comma
r_int
r_int
op_star
id|sb_block
comma
r_int
r_int
op_star
id|resuid
comma
r_int
r_int
op_star
id|resgid
comma
r_int
r_int
op_star
id|mount_options
)paren
(brace
r_char
op_star
id|this_char
suffix:semicolon
r_char
op_star
id|value
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
)paren
r_return
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|this_char
op_assign
id|strtok
(paren
id|options
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
id|this_char
op_ne
l_int|NULL
suffix:semicolon
id|this_char
op_assign
id|strtok
(paren
l_int|NULL
comma
l_string|&quot;,&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|value
op_assign
id|strchr
(paren
id|this_char
comma
l_char|&squot;=&squot;
)paren
)paren
op_ne
l_int|NULL
)paren
op_star
id|value
op_increment
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
(paren
id|this_char
comma
l_string|&quot;bsddf&quot;
)paren
)paren
id|clear_opt
(paren
op_star
id|mount_options
comma
id|MINIX_DF
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
(paren
id|this_char
comma
l_string|&quot;nouid32&quot;
)paren
)paren
(brace
id|set_opt
(paren
op_star
id|mount_options
comma
id|NO_UID32
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
(paren
id|this_char
comma
l_string|&quot;check&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
op_logical_or
op_logical_neg
op_star
id|value
op_logical_or
op_logical_neg
id|strcmp
(paren
id|value
comma
l_string|&quot;none&quot;
)paren
)paren
id|clear_opt
(paren
op_star
id|mount_options
comma
id|CHECK
)paren
suffix:semicolon
r_else
macro_line|#ifdef CONFIG_EXT2_CHECK
id|set_opt
(paren
op_star
id|mount_options
comma
id|CHECK
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
l_string|&quot;EXT2 Check option not supported&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
(paren
id|this_char
comma
l_string|&quot;debug&quot;
)paren
)paren
id|set_opt
(paren
op_star
id|mount_options
comma
id|DEBUG
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
(paren
id|this_char
comma
l_string|&quot;errors&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
op_logical_or
op_logical_neg
op_star
id|value
)paren
(brace
id|printk
(paren
l_string|&quot;EXT2-fs: the errors option requires &quot;
l_string|&quot;an argument&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
(paren
id|value
comma
l_string|&quot;continue&quot;
)paren
)paren
(brace
id|clear_opt
(paren
op_star
id|mount_options
comma
id|ERRORS_RO
)paren
suffix:semicolon
id|clear_opt
(paren
op_star
id|mount_options
comma
id|ERRORS_PANIC
)paren
suffix:semicolon
id|set_opt
(paren
op_star
id|mount_options
comma
id|ERRORS_CONT
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
(paren
id|value
comma
l_string|&quot;remount-ro&quot;
)paren
)paren
(brace
id|clear_opt
(paren
op_star
id|mount_options
comma
id|ERRORS_CONT
)paren
suffix:semicolon
id|clear_opt
(paren
op_star
id|mount_options
comma
id|ERRORS_PANIC
)paren
suffix:semicolon
id|set_opt
(paren
op_star
id|mount_options
comma
id|ERRORS_RO
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
(paren
id|value
comma
l_string|&quot;panic&quot;
)paren
)paren
(brace
id|clear_opt
(paren
op_star
id|mount_options
comma
id|ERRORS_CONT
)paren
suffix:semicolon
id|clear_opt
(paren
op_star
id|mount_options
comma
id|ERRORS_RO
)paren
suffix:semicolon
id|set_opt
(paren
op_star
id|mount_options
comma
id|ERRORS_PANIC
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
(paren
l_string|&quot;EXT2-fs: Invalid errors option: %s&bslash;n&quot;
comma
id|value
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
(paren
id|this_char
comma
l_string|&quot;grpid&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
(paren
id|this_char
comma
l_string|&quot;bsdgroups&quot;
)paren
)paren
id|set_opt
(paren
op_star
id|mount_options
comma
id|GRPID
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
(paren
id|this_char
comma
l_string|&quot;minixdf&quot;
)paren
)paren
id|set_opt
(paren
op_star
id|mount_options
comma
id|MINIX_DF
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
(paren
id|this_char
comma
l_string|&quot;nocheck&quot;
)paren
)paren
id|clear_opt
(paren
op_star
id|mount_options
comma
id|CHECK
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
(paren
id|this_char
comma
l_string|&quot;nogrpid&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
(paren
id|this_char
comma
l_string|&quot;sysvgroups&quot;
)paren
)paren
id|clear_opt
(paren
op_star
id|mount_options
comma
id|GRPID
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
(paren
id|this_char
comma
l_string|&quot;resgid&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
op_logical_or
op_logical_neg
op_star
id|value
)paren
(brace
id|printk
(paren
l_string|&quot;EXT2-fs: the resgid option requires &quot;
l_string|&quot;an argument&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
op_star
id|resgid
op_assign
id|simple_strtoul
(paren
id|value
comma
op_amp
id|value
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|value
)paren
(brace
id|printk
(paren
l_string|&quot;EXT2-fs: Invalid resgid option: %s&bslash;n&quot;
comma
id|value
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
(paren
id|this_char
comma
l_string|&quot;resuid&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
op_logical_or
op_logical_neg
op_star
id|value
)paren
(brace
id|printk
(paren
l_string|&quot;EXT2-fs: the resuid option requires &quot;
l_string|&quot;an argument&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
op_star
id|resuid
op_assign
id|simple_strtoul
(paren
id|value
comma
op_amp
id|value
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|value
)paren
(brace
id|printk
(paren
l_string|&quot;EXT2-fs: Invalid resuid option: %s&bslash;n&quot;
comma
id|value
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
(paren
id|this_char
comma
l_string|&quot;sb&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
op_logical_or
op_logical_neg
op_star
id|value
)paren
(brace
id|printk
(paren
l_string|&quot;EXT2-fs: the sb option requires &quot;
l_string|&quot;an argument&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
op_star
id|sb_block
op_assign
id|simple_strtoul
(paren
id|value
comma
op_amp
id|value
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|value
)paren
(brace
id|printk
(paren
l_string|&quot;EXT2-fs: Invalid sb option: %s&bslash;n&quot;
comma
id|value
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* Silently ignore the quota options */
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
(paren
id|this_char
comma
l_string|&quot;grpquota&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
(paren
id|this_char
comma
l_string|&quot;noquota&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
(paren
id|this_char
comma
l_string|&quot;quota&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
(paren
id|this_char
comma
l_string|&quot;usrquota&quot;
)paren
)paren
multiline_comment|/* Don&squot;t do anything ;-) */
suffix:semicolon
r_else
(brace
id|printk
(paren
l_string|&quot;EXT2-fs: Unrecognized mount option %s&bslash;n&quot;
comma
id|this_char
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|ext2_setup_super
r_static
r_int
id|ext2_setup_super
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ext2_super_block
op_star
id|es
comma
r_int
id|read_only
)paren
(brace
r_int
id|res
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_rev_level
)paren
OG
id|EXT2_MAX_SUPP_REV
)paren
(brace
id|printk
(paren
l_string|&quot;EXT2-fs warning: revision level too high, &quot;
l_string|&quot;forcing read-only mode&bslash;n&quot;
)paren
suffix:semicolon
id|res
op_assign
id|MS_RDONLY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|read_only
)paren
r_return
id|res
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb-&gt;u.ext2_sb.s_mount_state
op_amp
id|EXT2_VALID_FS
)paren
)paren
id|printk
(paren
l_string|&quot;EXT2-fs warning: mounting unchecked fs, &quot;
l_string|&quot;running e2fsck is recommended&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|sb-&gt;u.ext2_sb.s_mount_state
op_amp
id|EXT2_ERROR_FS
)paren
)paren
id|printk
(paren
l_string|&quot;EXT2-fs warning: mounting fs with errors, &quot;
l_string|&quot;running e2fsck is recommended&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|__s16
)paren
id|le16_to_cpu
c_func
(paren
id|es-&gt;s_max_mnt_count
)paren
op_ge
l_int|0
op_logical_and
id|le16_to_cpu
c_func
(paren
id|es-&gt;s_mnt_count
)paren
op_ge
(paren
r_int
r_int
)paren
(paren
id|__s16
)paren
id|le16_to_cpu
c_func
(paren
id|es-&gt;s_max_mnt_count
)paren
)paren
id|printk
(paren
l_string|&quot;EXT2-fs warning: maximal mount count reached, &quot;
l_string|&quot;running e2fsck is recommended&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_checkinterval
)paren
op_logical_and
(paren
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_lastcheck
)paren
op_plus
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_checkinterval
)paren
op_le
id|CURRENT_TIME
)paren
)paren
id|printk
(paren
l_string|&quot;EXT2-fs warning: checktime reached, &quot;
l_string|&quot;running e2fsck is recommended&bslash;n&quot;
)paren
suffix:semicolon
id|es-&gt;s_state
op_assign
id|cpu_to_le16
c_func
(paren
id|le16_to_cpu
c_func
(paren
id|es-&gt;s_state
)paren
op_amp
op_complement
id|EXT2_VALID_FS
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|__s16
)paren
id|le16_to_cpu
c_func
(paren
id|es-&gt;s_max_mnt_count
)paren
)paren
id|es-&gt;s_max_mnt_count
op_assign
(paren
id|__s16
)paren
id|cpu_to_le16
c_func
(paren
id|EXT2_DFL_MAX_MNT_COUNT
)paren
suffix:semicolon
id|es-&gt;s_mnt_count
op_assign
id|cpu_to_le16
c_func
(paren
id|le16_to_cpu
c_func
(paren
id|es-&gt;s_mnt_count
)paren
op_plus
l_int|1
)paren
suffix:semicolon
id|es-&gt;s_mtime
op_assign
id|cpu_to_le32
c_func
(paren
id|CURRENT_TIME
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|sb-&gt;u.ext2_sb.s_sbh
)paren
suffix:semicolon
id|sb-&gt;s_dirt
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|test_opt
(paren
id|sb
comma
id|DEBUG
)paren
)paren
id|printk
(paren
l_string|&quot;[EXT II FS %s, %s, bs=%lu, fs=%lu, gc=%lu, &quot;
l_string|&quot;bpg=%lu, ipg=%lu, mo=%04lx]&bslash;n&quot;
comma
id|EXT2FS_VERSION
comma
id|EXT2FS_DATE
comma
id|sb-&gt;s_blocksize
comma
id|sb-&gt;u.ext2_sb.s_frag_size
comma
id|sb-&gt;u.ext2_sb.s_groups_count
comma
id|EXT2_BLOCKS_PER_GROUP
c_func
(paren
id|sb
)paren
comma
id|EXT2_INODES_PER_GROUP
c_func
(paren
id|sb
)paren
comma
id|sb-&gt;u.ext2_sb.s_mount_opt
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_EXT2_CHECK
r_if
c_cond
(paren
id|test_opt
(paren
id|sb
comma
id|CHECK
)paren
)paren
(brace
id|ext2_check_blocks_bitmap
(paren
id|sb
)paren
suffix:semicolon
id|ext2_check_inodes_bitmap
(paren
id|sb
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
id|res
suffix:semicolon
)brace
DECL|function|ext2_check_descriptors
r_static
r_int
id|ext2_check_descriptors
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|desc_block
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|block
op_assign
id|le32_to_cpu
c_func
(paren
id|sb-&gt;u.ext2_sb.s_es-&gt;s_first_data_block
)paren
suffix:semicolon
r_struct
id|ext2_group_desc
op_star
id|gdp
op_assign
l_int|NULL
suffix:semicolon
id|ext2_debug
(paren
l_string|&quot;Checking group descriptors&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sb-&gt;u.ext2_sb.s_groups_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|i
op_mod
id|EXT2_DESC_PER_BLOCK
c_func
(paren
id|sb
)paren
)paren
op_eq
l_int|0
)paren
id|gdp
op_assign
(paren
r_struct
id|ext2_group_desc
op_star
)paren
id|sb-&gt;u.ext2_sb.s_group_desc
(braket
id|desc_block
op_increment
)braket
op_member_access_from_pointer
id|b_data
suffix:semicolon
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|gdp-&gt;bg_block_bitmap
)paren
OL
id|block
op_logical_or
id|le32_to_cpu
c_func
(paren
id|gdp-&gt;bg_block_bitmap
)paren
op_ge
id|block
op_plus
id|EXT2_BLOCKS_PER_GROUP
c_func
(paren
id|sb
)paren
)paren
(brace
id|ext2_error
(paren
id|sb
comma
l_string|&quot;ext2_check_descriptors&quot;
comma
l_string|&quot;Block bitmap for group %d&quot;
l_string|&quot; not in group (block %lu)!&quot;
comma
id|i
comma
(paren
r_int
r_int
)paren
id|le32_to_cpu
c_func
(paren
id|gdp-&gt;bg_block_bitmap
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|gdp-&gt;bg_inode_bitmap
)paren
OL
id|block
op_logical_or
id|le32_to_cpu
c_func
(paren
id|gdp-&gt;bg_inode_bitmap
)paren
op_ge
id|block
op_plus
id|EXT2_BLOCKS_PER_GROUP
c_func
(paren
id|sb
)paren
)paren
(brace
id|ext2_error
(paren
id|sb
comma
l_string|&quot;ext2_check_descriptors&quot;
comma
l_string|&quot;Inode bitmap for group %d&quot;
l_string|&quot; not in group (block %lu)!&quot;
comma
id|i
comma
(paren
r_int
r_int
)paren
id|le32_to_cpu
c_func
(paren
id|gdp-&gt;bg_inode_bitmap
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|gdp-&gt;bg_inode_table
)paren
OL
id|block
op_logical_or
id|le32_to_cpu
c_func
(paren
id|gdp-&gt;bg_inode_table
)paren
op_plus
id|sb-&gt;u.ext2_sb.s_itb_per_group
op_ge
id|block
op_plus
id|EXT2_BLOCKS_PER_GROUP
c_func
(paren
id|sb
)paren
)paren
(brace
id|ext2_error
(paren
id|sb
comma
l_string|&quot;ext2_check_descriptors&quot;
comma
l_string|&quot;Inode table for group %d&quot;
l_string|&quot; not in group (block %lu)!&quot;
comma
id|i
comma
(paren
r_int
r_int
)paren
id|le32_to_cpu
c_func
(paren
id|gdp-&gt;bg_inode_table
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|block
op_add_assign
id|EXT2_BLOCKS_PER_GROUP
c_func
(paren
id|sb
)paren
suffix:semicolon
id|gdp
op_increment
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|macro|log2
mdefine_line|#define log2(n) ffz(~(n))
DECL|function|ext2_read_super
r_struct
id|super_block
op_star
id|ext2_read_super
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_void
op_star
id|data
comma
r_int
id|silent
)paren
(brace
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_struct
id|ext2_super_block
op_star
id|es
suffix:semicolon
r_int
r_int
id|sb_block
op_assign
l_int|1
suffix:semicolon
r_int
r_int
id|resuid
op_assign
id|EXT2_DEF_RESUID
suffix:semicolon
r_int
r_int
id|resgid
op_assign
id|EXT2_DEF_RESGID
suffix:semicolon
r_int
r_int
id|logic_sb_block
op_assign
l_int|1
suffix:semicolon
r_int
r_int
id|offset
op_assign
l_int|0
suffix:semicolon
id|kdev_t
id|dev
op_assign
id|sb-&gt;s_dev
suffix:semicolon
r_int
id|blocksize
op_assign
id|BLOCK_SIZE
suffix:semicolon
r_int
id|hblock
suffix:semicolon
r_int
id|db_count
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
multiline_comment|/*&n;&t; * See what the current blocksize for the device is, and&n;&t; * use that as the blocksize.  Otherwise (or if the blocksize&n;&t; * is smaller than the default) use the default.&n;&t; * This is important for devices that have a hardware&n;&t; * sectorsize that is larger than the default.&n;&t; */
id|blocksize
op_assign
id|get_hardblocksize
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|blocksize
op_eq
l_int|0
op_logical_or
id|blocksize
OL
id|BLOCK_SIZE
)paren
(brace
id|blocksize
op_assign
id|BLOCK_SIZE
suffix:semicolon
)brace
id|sb-&gt;u.ext2_sb.s_mount_opt
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|parse_options
(paren
(paren
r_char
op_star
)paren
id|data
comma
op_amp
id|sb_block
comma
op_amp
id|resuid
comma
op_amp
id|resgid
comma
op_amp
id|sb-&gt;u.ext2_sb.s_mount_opt
)paren
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
id|set_blocksize
(paren
id|dev
comma
id|blocksize
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If the superblock doesn&squot;t start on a sector boundary,&n;&t; * calculate the offset.  FIXME(eric) this doesn&squot;t make sense&n;&t; * that we would have to do this.&n;&t; */
r_if
c_cond
(paren
id|blocksize
op_ne
id|BLOCK_SIZE
)paren
(brace
id|logic_sb_block
op_assign
(paren
id|sb_block
op_star
id|BLOCK_SIZE
)paren
op_div
id|blocksize
suffix:semicolon
id|offset
op_assign
(paren
id|sb_block
op_star
id|BLOCK_SIZE
)paren
op_mod
id|blocksize
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|bh
op_assign
id|bread
(paren
id|dev
comma
id|logic_sb_block
comma
id|blocksize
)paren
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;EXT2-fs: unable to read superblock&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Note: s_es must be initialized s_es as soon as possible because&n;&t; * some ext2 macro-instructions depend on its value&n;&t; */
id|es
op_assign
(paren
r_struct
id|ext2_super_block
op_star
)paren
(paren
(paren
(paren
r_char
op_star
)paren
id|bh-&gt;b_data
)paren
op_plus
id|offset
)paren
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_es
op_assign
id|es
suffix:semicolon
id|sb-&gt;s_magic
op_assign
id|le16_to_cpu
c_func
(paren
id|es-&gt;s_magic
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb-&gt;s_magic
op_ne
id|EXT2_SUPER_MAGIC
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|silent
)paren
id|printk
(paren
l_string|&quot;VFS: Can&squot;t find an ext2 filesystem on dev &quot;
l_string|&quot;%s.&bslash;n&quot;
comma
id|bdevname
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|failed_mount
suffix:colon
r_if
c_cond
(paren
id|bh
)paren
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_rev_level
)paren
op_eq
id|EXT2_GOOD_OLD_REV
op_logical_and
(paren
id|EXT2_HAS_COMPAT_FEATURE
c_func
(paren
id|sb
comma
op_complement
l_int|0U
)paren
op_logical_or
id|EXT2_HAS_RO_COMPAT_FEATURE
c_func
(paren
id|sb
comma
op_complement
l_int|0U
)paren
op_logical_or
id|EXT2_HAS_INCOMPAT_FEATURE
c_func
(paren
id|sb
comma
op_complement
l_int|0U
)paren
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;EXT2-fs warning: feature flags set on rev 0 fs, &quot;
l_string|&quot;running e2fsck is recommended&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Check feature flags regardless of the revision level, since we&n;&t; * previously didn&squot;t change the revision level when setting the flags,&n;&t; * so there is a chance incompat flags are set on a rev 0 filesystem.&n;&t; */
r_if
c_cond
(paren
(paren
id|i
op_assign
id|EXT2_HAS_INCOMPAT_FEATURE
c_func
(paren
id|sb
comma
op_complement
id|EXT2_FEATURE_INCOMPAT_SUPP
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;EXT2-fs: %s: couldn&squot;t mount because of &quot;
l_string|&quot;unsupported optional features (%x).&bslash;n&quot;
comma
id|bdevname
c_func
(paren
id|dev
)paren
comma
id|i
)paren
suffix:semicolon
r_goto
id|failed_mount
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
op_logical_and
(paren
id|i
op_assign
id|EXT2_HAS_RO_COMPAT_FEATURE
c_func
(paren
id|sb
comma
op_complement
id|EXT2_FEATURE_RO_COMPAT_SUPP
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;EXT2-fs: %s: couldn&squot;t mount RDWR because of &quot;
l_string|&quot;unsupported optional features (%x).&bslash;n&quot;
comma
id|bdevname
c_func
(paren
id|dev
)paren
comma
id|i
)paren
suffix:semicolon
r_goto
id|failed_mount
suffix:semicolon
)brace
id|sb-&gt;s_blocksize_bits
op_assign
id|le32_to_cpu
c_func
(paren
id|EXT2_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_es-&gt;s_log_block_size
)paren
op_plus
l_int|10
suffix:semicolon
id|sb-&gt;s_blocksize
op_assign
l_int|1
op_lshift
id|sb-&gt;s_blocksize_bits
suffix:semicolon
r_if
c_cond
(paren
id|sb-&gt;s_blocksize
op_ne
id|BLOCK_SIZE
op_logical_and
(paren
id|sb-&gt;s_blocksize
op_eq
l_int|1024
op_logical_or
id|sb-&gt;s_blocksize
op_eq
l_int|2048
op_logical_or
id|sb-&gt;s_blocksize
op_eq
l_int|4096
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * Make sure the blocksize for the filesystem is larger&n;&t;&t; * than the hardware sectorsize for the machine.&n;&t;&t; */
id|hblock
op_assign
id|get_hardblocksize
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hblock
op_ne
l_int|0
)paren
op_logical_and
(paren
id|sb-&gt;s_blocksize
OL
id|hblock
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;EXT2-fs: blocksize too small for device.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed_mount
suffix:semicolon
)brace
id|brelse
(paren
id|bh
)paren
suffix:semicolon
id|set_blocksize
(paren
id|dev
comma
id|sb-&gt;s_blocksize
)paren
suffix:semicolon
id|logic_sb_block
op_assign
(paren
id|sb_block
op_star
id|BLOCK_SIZE
)paren
op_div
id|sb-&gt;s_blocksize
suffix:semicolon
id|offset
op_assign
(paren
id|sb_block
op_star
id|BLOCK_SIZE
)paren
op_mod
id|sb-&gt;s_blocksize
suffix:semicolon
id|bh
op_assign
id|bread
(paren
id|dev
comma
id|logic_sb_block
comma
id|sb-&gt;s_blocksize
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bh
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;EXT2-fs: Couldn&squot;t read superblock on &quot;
l_string|&quot;2nd try.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed_mount
suffix:semicolon
)brace
id|es
op_assign
(paren
r_struct
id|ext2_super_block
op_star
)paren
(paren
(paren
(paren
r_char
op_star
)paren
id|bh-&gt;b_data
)paren
op_plus
id|offset
)paren
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_es
op_assign
id|es
suffix:semicolon
r_if
c_cond
(paren
id|es-&gt;s_magic
op_ne
id|le16_to_cpu
c_func
(paren
id|EXT2_SUPER_MAGIC
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;EXT2-fs: Magic mismatch, very weird !&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed_mount
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_rev_level
)paren
op_eq
id|EXT2_GOOD_OLD_REV
)paren
(brace
id|sb-&gt;u.ext2_sb.s_inode_size
op_assign
id|EXT2_GOOD_OLD_INODE_SIZE
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_first_ino
op_assign
id|EXT2_GOOD_OLD_FIRST_INO
suffix:semicolon
)brace
r_else
(brace
id|sb-&gt;u.ext2_sb.s_inode_size
op_assign
id|le16_to_cpu
c_func
(paren
id|es-&gt;s_inode_size
)paren
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_first_ino
op_assign
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_first_ino
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb-&gt;u.ext2_sb.s_inode_size
op_ne
id|EXT2_GOOD_OLD_INODE_SIZE
)paren
(brace
id|printk
(paren
l_string|&quot;EXT2-fs: unsupported inode size: %d&bslash;n&quot;
comma
id|sb-&gt;u.ext2_sb.s_inode_size
)paren
suffix:semicolon
r_goto
id|failed_mount
suffix:semicolon
)brace
)brace
id|sb-&gt;u.ext2_sb.s_frag_size
op_assign
id|EXT2_MIN_FRAG_SIZE
op_lshift
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_log_frag_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb-&gt;u.ext2_sb.s_frag_size
)paren
id|sb-&gt;u.ext2_sb.s_frags_per_block
op_assign
id|sb-&gt;s_blocksize
op_div
id|sb-&gt;u.ext2_sb.s_frag_size
suffix:semicolon
r_else
id|sb-&gt;s_magic
op_assign
l_int|0
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_blocks_per_group
op_assign
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_blocks_per_group
)paren
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_frags_per_group
op_assign
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_frags_per_group
)paren
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_inodes_per_group
op_assign
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_inodes_per_group
)paren
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_inodes_per_block
op_assign
id|sb-&gt;s_blocksize
op_div
id|EXT2_INODE_SIZE
c_func
(paren
id|sb
)paren
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_itb_per_group
op_assign
id|sb-&gt;u.ext2_sb.s_inodes_per_group
op_div
id|sb-&gt;u.ext2_sb.s_inodes_per_block
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_desc_per_block
op_assign
id|sb-&gt;s_blocksize
op_div
r_sizeof
(paren
r_struct
id|ext2_group_desc
)paren
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_sbh
op_assign
id|bh
suffix:semicolon
r_if
c_cond
(paren
id|resuid
op_ne
id|EXT2_DEF_RESUID
)paren
id|sb-&gt;u.ext2_sb.s_resuid
op_assign
id|resuid
suffix:semicolon
r_else
id|sb-&gt;u.ext2_sb.s_resuid
op_assign
id|le16_to_cpu
c_func
(paren
id|es-&gt;s_def_resuid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|resgid
op_ne
id|EXT2_DEF_RESGID
)paren
id|sb-&gt;u.ext2_sb.s_resgid
op_assign
id|resgid
suffix:semicolon
r_else
id|sb-&gt;u.ext2_sb.s_resgid
op_assign
id|le16_to_cpu
c_func
(paren
id|es-&gt;s_def_resgid
)paren
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_mount_state
op_assign
id|le16_to_cpu
c_func
(paren
id|es-&gt;s_state
)paren
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_addr_per_block_bits
op_assign
id|log2
(paren
id|EXT2_ADDR_PER_BLOCK
c_func
(paren
id|sb
)paren
)paren
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_desc_per_block_bits
op_assign
id|log2
(paren
id|EXT2_DESC_PER_BLOCK
c_func
(paren
id|sb
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb-&gt;s_magic
op_ne
id|EXT2_SUPER_MAGIC
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|silent
)paren
id|printk
(paren
l_string|&quot;VFS: Can&squot;t find an ext2 filesystem on dev &quot;
l_string|&quot;%s.&bslash;n&quot;
comma
id|bdevname
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
r_goto
id|failed_mount
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sb-&gt;s_blocksize
op_ne
id|bh-&gt;b_size
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|silent
)paren
id|printk
(paren
l_string|&quot;VFS: Unsupported blocksize on dev &quot;
l_string|&quot;%s.&bslash;n&quot;
comma
id|bdevname
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
r_goto
id|failed_mount
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sb-&gt;s_blocksize
op_ne
id|sb-&gt;u.ext2_sb.s_frag_size
)paren
(brace
id|printk
(paren
l_string|&quot;EXT2-fs: fragsize %lu != blocksize %lu (not supported yet)&bslash;n&quot;
comma
id|sb-&gt;u.ext2_sb.s_frag_size
comma
id|sb-&gt;s_blocksize
)paren
suffix:semicolon
r_goto
id|failed_mount
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sb-&gt;u.ext2_sb.s_blocks_per_group
OG
id|sb-&gt;s_blocksize
op_star
l_int|8
)paren
(brace
id|printk
(paren
l_string|&quot;EXT2-fs: #blocks per group too big: %lu&bslash;n&quot;
comma
id|sb-&gt;u.ext2_sb.s_blocks_per_group
)paren
suffix:semicolon
r_goto
id|failed_mount
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sb-&gt;u.ext2_sb.s_frags_per_group
OG
id|sb-&gt;s_blocksize
op_star
l_int|8
)paren
(brace
id|printk
(paren
l_string|&quot;EXT2-fs: #fragments per group too big: %lu&bslash;n&quot;
comma
id|sb-&gt;u.ext2_sb.s_frags_per_group
)paren
suffix:semicolon
r_goto
id|failed_mount
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sb-&gt;u.ext2_sb.s_inodes_per_group
OG
id|sb-&gt;s_blocksize
op_star
l_int|8
)paren
(brace
id|printk
(paren
l_string|&quot;EXT2-fs: #inodes per group too big: %lu&bslash;n&quot;
comma
id|sb-&gt;u.ext2_sb.s_inodes_per_group
)paren
suffix:semicolon
r_goto
id|failed_mount
suffix:semicolon
)brace
id|sb-&gt;u.ext2_sb.s_groups_count
op_assign
(paren
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_blocks_count
)paren
op_minus
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_first_data_block
)paren
op_plus
id|EXT2_BLOCKS_PER_GROUP
c_func
(paren
id|sb
)paren
op_minus
l_int|1
)paren
op_div
id|EXT2_BLOCKS_PER_GROUP
c_func
(paren
id|sb
)paren
suffix:semicolon
id|db_count
op_assign
(paren
id|sb-&gt;u.ext2_sb.s_groups_count
op_plus
id|EXT2_DESC_PER_BLOCK
c_func
(paren
id|sb
)paren
op_minus
l_int|1
)paren
op_div
id|EXT2_DESC_PER_BLOCK
c_func
(paren
id|sb
)paren
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_group_desc
op_assign
id|kmalloc
(paren
id|db_count
op_star
r_sizeof
(paren
r_struct
id|buffer_head
op_star
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb-&gt;u.ext2_sb.s_group_desc
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;EXT2-fs: not enough memory&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed_mount
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|db_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sb-&gt;u.ext2_sb.s_group_desc
(braket
id|i
)braket
op_assign
id|bread
(paren
id|dev
comma
id|logic_sb_block
op_plus
id|i
op_plus
l_int|1
comma
id|sb-&gt;s_blocksize
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb-&gt;u.ext2_sb.s_group_desc
(braket
id|i
)braket
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|i
suffix:semicolon
id|j
op_increment
)paren
id|brelse
(paren
id|sb-&gt;u.ext2_sb.s_group_desc
(braket
id|j
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sb-&gt;u.ext2_sb.s_group_desc
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;EXT2-fs: unable to read group descriptors&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed_mount
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|ext2_check_descriptors
(paren
id|sb
)paren
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|db_count
suffix:semicolon
id|j
op_increment
)paren
id|brelse
(paren
id|sb-&gt;u.ext2_sb.s_group_desc
(braket
id|j
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sb-&gt;u.ext2_sb.s_group_desc
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;EXT2-fs: group descriptors corrupted !&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed_mount
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|EXT2_MAX_GROUP_LOADED
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sb-&gt;u.ext2_sb.s_inode_bitmap_number
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_inode_bitmap
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_block_bitmap_number
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_block_bitmap
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|sb-&gt;u.ext2_sb.s_loaded_inode_bitmaps
op_assign
l_int|0
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_loaded_block_bitmaps
op_assign
l_int|0
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_gdb_count
op_assign
id|db_count
suffix:semicolon
multiline_comment|/*&n;&t; * set up enough so that it can read an inode&n;&t; */
id|sb-&gt;s_op
op_assign
op_amp
id|ext2_sops
suffix:semicolon
id|sb-&gt;s_root
op_assign
id|d_alloc_root
c_func
(paren
id|iget
c_func
(paren
id|sb
comma
id|EXT2_ROOT_INO
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb-&gt;s_root
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|db_count
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|sb-&gt;u.ext2_sb.s_group_desc
(braket
id|i
)braket
)paren
id|brelse
(paren
id|sb-&gt;u.ext2_sb.s_group_desc
(braket
id|i
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sb-&gt;u.ext2_sb.s_group_desc
)paren
suffix:semicolon
id|brelse
(paren
id|bh
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;EXT2-fs: get root inode failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|ext2_setup_super
(paren
id|sb
comma
id|es
comma
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
suffix:semicolon
r_return
id|sb
suffix:semicolon
)brace
DECL|function|ext2_commit_super
r_static
r_void
id|ext2_commit_super
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ext2_super_block
op_star
id|es
)paren
(brace
id|es-&gt;s_wtime
op_assign
id|cpu_to_le32
c_func
(paren
id|CURRENT_TIME
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|sb-&gt;u.ext2_sb.s_sbh
)paren
suffix:semicolon
id|sb-&gt;s_dirt
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * In the second extended file system, it is not necessary to&n; * write the super block since we use a mapping of the&n; * disk super block in a buffer.&n; *&n; * However, this function is still used to set the fs valid&n; * flags to 0.  We need to set this flag to 0 since the fs&n; * may have been checked while mounted and e2fsck may have&n; * set s_state to EXT2_VALID_FS after some corrections.&n; */
DECL|function|ext2_write_super
r_void
id|ext2_write_super
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_struct
id|ext2_super_block
op_star
id|es
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
)paren
(brace
id|es
op_assign
id|sb-&gt;u.ext2_sb.s_es
suffix:semicolon
id|ext2_debug
(paren
l_string|&quot;setting valid to 0&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|le16_to_cpu
c_func
(paren
id|es-&gt;s_state
)paren
op_amp
id|EXT2_VALID_FS
)paren
(brace
id|es-&gt;s_state
op_assign
id|cpu_to_le16
c_func
(paren
id|le16_to_cpu
c_func
(paren
id|es-&gt;s_state
)paren
op_amp
op_complement
id|EXT2_VALID_FS
)paren
suffix:semicolon
id|es-&gt;s_mtime
op_assign
id|cpu_to_le32
c_func
(paren
id|CURRENT_TIME
)paren
suffix:semicolon
)brace
id|ext2_commit_super
(paren
id|sb
comma
id|es
)paren
suffix:semicolon
)brace
id|sb-&gt;s_dirt
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|ext2_remount
r_int
id|ext2_remount
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_int
op_star
id|flags
comma
r_char
op_star
id|data
)paren
(brace
r_struct
id|ext2_super_block
op_star
id|es
suffix:semicolon
r_int
r_int
id|resuid
op_assign
id|sb-&gt;u.ext2_sb.s_resuid
suffix:semicolon
r_int
r_int
id|resgid
op_assign
id|sb-&gt;u.ext2_sb.s_resgid
suffix:semicolon
r_int
r_int
id|new_mount_opt
suffix:semicolon
r_int
r_int
id|tmp
suffix:semicolon
multiline_comment|/*&n;&t; * Allow the &quot;check&quot; option to be passed as a remount option.&n;&t; */
id|new_mount_opt
op_assign
id|sb-&gt;u.ext2_sb.s_mount_opt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|parse_options
(paren
id|data
comma
op_amp
id|tmp
comma
op_amp
id|resuid
comma
op_amp
id|resgid
comma
op_amp
id|new_mount_opt
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_mount_opt
op_assign
id|new_mount_opt
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_resuid
op_assign
id|resuid
suffix:semicolon
id|sb-&gt;u.ext2_sb.s_resgid
op_assign
id|resgid
suffix:semicolon
id|es
op_assign
id|sb-&gt;u.ext2_sb.s_es
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|flags
op_amp
id|MS_RDONLY
)paren
op_eq
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_star
id|flags
op_amp
id|MS_RDONLY
)paren
(brace
r_if
c_cond
(paren
id|le16_to_cpu
c_func
(paren
id|es-&gt;s_state
)paren
op_amp
id|EXT2_VALID_FS
op_logical_or
op_logical_neg
(paren
id|sb-&gt;u.ext2_sb.s_mount_state
op_amp
id|EXT2_VALID_FS
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t; * OK, we are remounting a valid rw partition rdonly, so set&n;&t;&t; * the rdonly flag and then mark the partition as valid again.&n;&t;&t; */
id|es-&gt;s_state
op_assign
id|cpu_to_le16
c_func
(paren
id|sb-&gt;u.ext2_sb.s_mount_state
)paren
suffix:semicolon
id|es-&gt;s_mtime
op_assign
id|cpu_to_le32
c_func
(paren
id|CURRENT_TIME
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|sb-&gt;u.ext2_sb.s_sbh
)paren
suffix:semicolon
id|sb-&gt;s_dirt
op_assign
l_int|1
suffix:semicolon
id|ext2_commit_super
(paren
id|sb
comma
id|es
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|EXT2_HAS_RO_COMPAT_FEATURE
c_func
(paren
id|sb
comma
op_complement
id|EXT2_FEATURE_RO_COMPAT_SUPP
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;EXT2-fs: %s: couldn&squot;t remount RDWR because of &quot;
l_string|&quot;unsupported optional features (%x).&bslash;n&quot;
comma
id|bdevname
c_func
(paren
id|sb-&gt;s_dev
)paren
comma
id|ret
)paren
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Mounting a RDONLY partition read-write, so reread and&n;&t;&t; * store the current valid flag.  (It may have been changed&n;&t;&t; * by e2fsck since we originally mounted the partition.)&n;&t;&t; */
id|sb-&gt;u.ext2_sb.s_mount_state
op_assign
id|le16_to_cpu
c_func
(paren
id|es-&gt;s_state
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ext2_setup_super
(paren
id|sb
comma
id|es
comma
l_int|0
)paren
)paren
id|sb-&gt;s_flags
op_and_assign
op_complement
id|MS_RDONLY
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ext2_statfs
r_int
id|ext2_statfs
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|statfs
op_star
id|buf
)paren
(brace
r_int
r_int
id|overhead
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|test_opt
(paren
id|sb
comma
id|MINIX_DF
)paren
)paren
id|overhead
op_assign
l_int|0
suffix:semicolon
r_else
(brace
multiline_comment|/*&n;&t;&t; * Compute the overhead (FS structures)&n;&t;&t; */
multiline_comment|/*&n;&t;&t; * All of the blocks before first_data_block are&n;&t;&t; * overhead&n;&t;&t; */
id|overhead
op_assign
id|le32_to_cpu
c_func
(paren
id|sb-&gt;u.ext2_sb.s_es-&gt;s_first_data_block
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Add the overhead attributed to the superblock and&n;&t;&t; * block group descriptors.  If the sparse superblocks&n;&t;&t; * feature is turned on, then not all groups have this.&n;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|EXT2_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_groups_count
suffix:semicolon
id|i
op_increment
)paren
id|overhead
op_add_assign
id|ext2_bg_has_super
c_func
(paren
id|sb
comma
id|i
)paren
op_plus
id|ext2_bg_num_gdb
c_func
(paren
id|sb
comma
id|i
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Every block group has an inode bitmap, a block&n;&t;&t; * bitmap, and an inode table.&n;&t;&t; */
id|overhead
op_add_assign
(paren
id|sb-&gt;u.ext2_sb.s_groups_count
op_star
(paren
l_int|2
op_plus
id|sb-&gt;u.ext2_sb.s_itb_per_group
)paren
)paren
suffix:semicolon
)brace
id|buf-&gt;f_type
op_assign
id|EXT2_SUPER_MAGIC
suffix:semicolon
id|buf-&gt;f_bsize
op_assign
id|sb-&gt;s_blocksize
suffix:semicolon
id|buf-&gt;f_blocks
op_assign
id|le32_to_cpu
c_func
(paren
id|sb-&gt;u.ext2_sb.s_es-&gt;s_blocks_count
)paren
op_minus
id|overhead
suffix:semicolon
id|buf-&gt;f_bfree
op_assign
id|ext2_count_free_blocks
(paren
id|sb
)paren
suffix:semicolon
id|buf-&gt;f_bavail
op_assign
id|buf-&gt;f_bfree
op_minus
id|le32_to_cpu
c_func
(paren
id|sb-&gt;u.ext2_sb.s_es-&gt;s_r_blocks_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf-&gt;f_bfree
OL
id|le32_to_cpu
c_func
(paren
id|sb-&gt;u.ext2_sb.s_es-&gt;s_r_blocks_count
)paren
)paren
id|buf-&gt;f_bavail
op_assign
l_int|0
suffix:semicolon
id|buf-&gt;f_files
op_assign
id|le32_to_cpu
c_func
(paren
id|sb-&gt;u.ext2_sb.s_es-&gt;s_inodes_count
)paren
suffix:semicolon
id|buf-&gt;f_ffree
op_assign
id|ext2_count_free_inodes
(paren
id|sb
)paren
suffix:semicolon
id|buf-&gt;f_namelen
op_assign
id|EXT2_NAME_LEN
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
id|DECLARE_FSTYPE_DEV
c_func
(paren
id|ext2_fs_type
comma
l_string|&quot;ext2&quot;
comma
id|ext2_read_super
)paren
suffix:semicolon
DECL|function|init_ext2_fs
r_static
r_int
id|__init
id|init_ext2_fs
c_func
(paren
r_void
)paren
(brace
r_return
id|register_filesystem
c_func
(paren
op_amp
id|ext2_fs_type
)paren
suffix:semicolon
)brace
DECL|function|exit_ext2_fs
r_static
r_void
id|__exit
id|exit_ext2_fs
c_func
(paren
r_void
)paren
(brace
id|unregister_filesystem
c_func
(paren
op_amp
id|ext2_fs_type
)paren
suffix:semicolon
)brace
id|EXPORT_NO_SYMBOLS
suffix:semicolon
id|module_init
c_func
(paren
id|init_ext2_fs
)paren
id|module_exit
c_func
(paren
id|exit_ext2_fs
)paren
eof
