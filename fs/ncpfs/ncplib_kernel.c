multiline_comment|/*&n; *  ncplib_kernel.c&n; *&n; *  Copyright (C) 1995, 1996 by Volker Lendecke&n; *  Modified for big endian by J.F. Chadima and David S. Miller&n; *&n; */
macro_line|#include &quot;ncplib_kernel.h&quot;
DECL|function|min
r_static
r_inline
r_int
id|min
c_func
(paren
r_int
id|a
comma
r_int
id|b
)paren
(brace
r_return
id|a
OL
id|b
ques
c_cond
id|a
suffix:colon
id|b
suffix:semicolon
)brace
DECL|function|assert_server_locked
r_static
r_void
id|assert_server_locked
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
)paren
(brace
r_if
c_cond
(paren
id|server-&gt;lock
op_eq
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;ncpfs: server not locked!&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|function|ncp_add_byte
r_static
r_void
id|ncp_add_byte
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
id|__u8
id|x
)paren
(brace
id|assert_server_locked
c_func
(paren
id|server
)paren
suffix:semicolon
op_star
(paren
id|__u8
op_star
)paren
(paren
op_amp
(paren
id|server-&gt;packet
(braket
id|server-&gt;current_size
)braket
)paren
)paren
op_assign
id|x
suffix:semicolon
id|server-&gt;current_size
op_add_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|ncp_add_word
r_static
r_void
id|ncp_add_word
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
id|__u16
id|x
)paren
(brace
id|assert_server_locked
c_func
(paren
id|server
)paren
suffix:semicolon
id|put_unaligned
c_func
(paren
id|x
comma
(paren
id|__u16
op_star
)paren
(paren
op_amp
(paren
id|server-&gt;packet
(braket
id|server-&gt;current_size
)braket
)paren
)paren
)paren
suffix:semicolon
id|server-&gt;current_size
op_add_assign
l_int|2
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|ncp_add_dword
r_static
r_void
id|ncp_add_dword
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
id|__u32
id|x
)paren
(brace
id|assert_server_locked
c_func
(paren
id|server
)paren
suffix:semicolon
id|put_unaligned
c_func
(paren
id|x
comma
(paren
id|__u32
op_star
)paren
(paren
op_amp
(paren
id|server-&gt;packet
(braket
id|server-&gt;current_size
)braket
)paren
)paren
)paren
suffix:semicolon
id|server-&gt;current_size
op_add_assign
l_int|4
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|ncp_add_mem
r_static
r_void
id|ncp_add_mem
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_const
r_void
op_star
id|source
comma
r_int
id|size
)paren
(brace
id|assert_server_locked
c_func
(paren
id|server
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
(paren
id|server-&gt;packet
(braket
id|server-&gt;current_size
)braket
)paren
comma
id|source
comma
id|size
)paren
suffix:semicolon
id|server-&gt;current_size
op_add_assign
id|size
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|ncp_add_mem_fromfs
r_static
r_void
id|ncp_add_mem_fromfs
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_const
r_char
op_star
id|source
comma
r_int
id|size
)paren
(brace
id|assert_server_locked
c_func
(paren
id|server
)paren
suffix:semicolon
id|copy_from_user
c_func
(paren
op_amp
(paren
id|server-&gt;packet
(braket
id|server-&gt;current_size
)braket
)paren
comma
id|source
comma
id|size
)paren
suffix:semicolon
id|server-&gt;current_size
op_add_assign
id|size
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|ncp_add_pstring
r_static
r_void
id|ncp_add_pstring
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_const
r_char
op_star
id|s
)paren
(brace
r_int
id|len
op_assign
id|strlen
c_func
(paren
id|s
)paren
suffix:semicolon
id|assert_server_locked
c_func
(paren
id|server
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|255
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;ncpfs: string too long: %s&bslash;n&quot;
comma
id|s
)paren
suffix:semicolon
id|len
op_assign
l_int|255
suffix:semicolon
)brace
id|ncp_add_byte
c_func
(paren
id|server
comma
id|len
)paren
suffix:semicolon
id|ncp_add_mem
c_func
(paren
id|server
comma
id|s
comma
id|len
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|ncp_init_request
r_static
r_void
id|ncp_init_request
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
)paren
(brace
id|ncp_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|server-&gt;current_size
op_assign
r_sizeof
(paren
r_struct
id|ncp_request_header
)paren
suffix:semicolon
id|server-&gt;has_subfunction
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|ncp_init_request_s
r_static
r_void
id|ncp_init_request_s
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_int
id|subfunction
)paren
(brace
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_word
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* preliminary size */
id|ncp_add_byte
c_func
(paren
id|server
comma
id|subfunction
)paren
suffix:semicolon
id|server-&gt;has_subfunction
op_assign
l_int|1
suffix:semicolon
)brace
r_static
r_char
op_star
DECL|function|ncp_reply_data
id|ncp_reply_data
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_int
id|offset
)paren
(brace
r_return
op_amp
(paren
id|server-&gt;packet
(braket
r_sizeof
(paren
r_struct
id|ncp_reply_header
)paren
op_plus
id|offset
)braket
)paren
suffix:semicolon
)brace
r_static
id|__u8
DECL|function|ncp_reply_byte
id|ncp_reply_byte
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_int
id|offset
)paren
(brace
r_return
id|get_unaligned
c_func
(paren
(paren
id|__u8
op_star
)paren
id|ncp_reply_data
c_func
(paren
id|server
comma
id|offset
)paren
)paren
suffix:semicolon
)brace
r_static
id|__u16
DECL|function|ncp_reply_word
id|ncp_reply_word
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_int
id|offset
)paren
(brace
r_return
id|get_unaligned
c_func
(paren
(paren
id|__u16
op_star
)paren
id|ncp_reply_data
c_func
(paren
id|server
comma
id|offset
)paren
)paren
suffix:semicolon
)brace
r_static
id|__u32
DECL|function|ncp_reply_dword
id|ncp_reply_dword
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_int
id|offset
)paren
(brace
r_return
id|get_unaligned
c_func
(paren
(paren
id|__u32
op_star
)paren
id|ncp_reply_data
c_func
(paren
id|server
comma
id|offset
)paren
)paren
suffix:semicolon
)brace
DECL|function|ncp_negotiate_buffersize
r_int
id|ncp_negotiate_buffersize
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_int
id|size
comma
r_int
op_star
id|target
)paren
(brace
r_int
id|result
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_word
c_func
(paren
id|server
comma
id|htons
c_func
(paren
id|size
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|33
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
op_star
id|target
op_assign
id|min
c_func
(paren
id|ntohs
c_func
(paren
id|ncp_reply_word
c_func
(paren
id|server
comma
l_int|0
)paren
)paren
comma
id|size
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ncp_get_volume_info_with_number
r_int
id|ncp_get_volume_info_with_number
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_int
id|n
comma
r_struct
id|ncp_volume_info
op_star
id|target
)paren
(brace
r_int
id|result
suffix:semicolon
r_int
id|len
suffix:semicolon
id|ncp_init_request_s
c_func
(paren
id|server
comma
l_int|44
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
id|n
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|22
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|target-&gt;total_blocks
op_assign
id|ncp_reply_dword
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
id|target-&gt;free_blocks
op_assign
id|ncp_reply_dword
c_func
(paren
id|server
comma
l_int|4
)paren
suffix:semicolon
id|target-&gt;purgeable_blocks
op_assign
id|ncp_reply_dword
c_func
(paren
id|server
comma
l_int|8
)paren
suffix:semicolon
id|target-&gt;not_yet_purgeable_blocks
op_assign
id|ncp_reply_dword
c_func
(paren
id|server
comma
l_int|12
)paren
suffix:semicolon
id|target-&gt;total_dir_entries
op_assign
id|ncp_reply_dword
c_func
(paren
id|server
comma
l_int|16
)paren
suffix:semicolon
id|target-&gt;available_dir_entries
op_assign
id|ncp_reply_dword
c_func
(paren
id|server
comma
l_int|20
)paren
suffix:semicolon
id|target-&gt;sectors_per_block
op_assign
id|ncp_reply_byte
c_func
(paren
id|server
comma
l_int|28
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
(paren
id|target-&gt;volume_name
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|target-&gt;volume_name
)paren
)paren
suffix:semicolon
id|len
op_assign
id|ncp_reply_byte
c_func
(paren
id|server
comma
l_int|29
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|NCP_VOLNAME_LEN
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;ncpfs: volume name too long: %d&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|memcpy
c_func
(paren
op_amp
(paren
id|target-&gt;volume_name
)paren
comma
id|ncp_reply_data
c_func
(paren
id|server
comma
l_int|30
)paren
comma
id|len
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ncp_close_file
r_int
id|ncp_close_file
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_const
r_char
op_star
id|file_id
)paren
(brace
r_int
id|result
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
id|ncp_add_mem
c_func
(paren
id|server
comma
id|file_id
comma
l_int|6
)paren
suffix:semicolon
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|66
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|ncp_add_handle_path
r_static
r_void
id|ncp_add_handle_path
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
id|__u8
id|vol_num
comma
id|__u32
id|dir_base
comma
r_int
id|have_dir_base
comma
r_char
op_star
id|path
)paren
(brace
id|ncp_add_byte
c_func
(paren
id|server
comma
id|vol_num
)paren
suffix:semicolon
id|ncp_add_dword
c_func
(paren
id|server
comma
id|dir_base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|have_dir_base
op_ne
l_int|0
)paren
(brace
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* dir_base */
)brace
r_else
(brace
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* no handle */
)brace
r_if
c_cond
(paren
id|path
op_ne
l_int|NULL
)paren
(brace
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* 1 component */
id|ncp_add_pstring
c_func
(paren
id|server
comma
id|path
)paren
suffix:semicolon
)brace
r_else
(brace
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
DECL|function|ncp_extract_file_info
r_static
r_void
id|ncp_extract_file_info
c_func
(paren
r_void
op_star
id|structure
comma
r_struct
id|nw_info_struct
op_star
id|target
)paren
(brace
id|__u8
op_star
id|name_len
suffix:semicolon
r_const
r_int
id|info_struct_size
op_assign
r_sizeof
(paren
r_struct
id|nw_info_struct
)paren
op_minus
l_int|257
suffix:semicolon
id|memcpy
c_func
(paren
id|target
comma
id|structure
comma
id|info_struct_size
)paren
suffix:semicolon
id|name_len
op_assign
id|structure
op_plus
id|info_struct_size
suffix:semicolon
id|target-&gt;nameLen
op_assign
op_star
id|name_len
suffix:semicolon
id|strncpy
c_func
(paren
id|target-&gt;entryName
comma
id|name_len
op_plus
l_int|1
comma
op_star
id|name_len
)paren
suffix:semicolon
id|target-&gt;entryName
(braket
op_star
id|name_len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|ncp_obtain_info
r_int
id|ncp_obtain_info
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
id|__u8
id|vol_num
comma
id|__u32
id|dir_base
comma
r_char
op_star
id|path
comma
multiline_comment|/* At most 1 component */
r_struct
id|nw_info_struct
op_star
id|target
)paren
(brace
r_int
id|result
suffix:semicolon
r_if
c_cond
(paren
id|target
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|6
)paren
suffix:semicolon
multiline_comment|/* subfunction */
id|ncp_add_byte
c_func
(paren
id|server
comma
id|server-&gt;name_space
(braket
id|vol_num
)braket
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
id|server-&gt;name_space
(braket
id|vol_num
)braket
)paren
suffix:semicolon
id|ncp_add_word
c_func
(paren
id|server
comma
id|htons
c_func
(paren
l_int|0xff00
)paren
)paren
suffix:semicolon
multiline_comment|/* get all */
id|ncp_add_dword
c_func
(paren
id|server
comma
id|RIM_ALL
)paren
suffix:semicolon
id|ncp_add_handle_path
c_func
(paren
id|server
comma
id|vol_num
comma
id|dir_base
comma
l_int|1
comma
id|path
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|87
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|ncp_extract_file_info
c_func
(paren
id|ncp_reply_data
c_func
(paren
id|server
comma
l_int|0
)paren
comma
id|target
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ncp_has_os2_namespace
r_static
r_inline
r_int
id|ncp_has_os2_namespace
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
id|__u8
id|volume
)paren
(brace
r_int
id|result
suffix:semicolon
id|__u8
op_star
r_namespace
suffix:semicolon
id|__u16
id|no_namespaces
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|24
)paren
suffix:semicolon
multiline_comment|/* Subfunction: Get Name Spaces Loaded */
id|ncp_add_word
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
id|volume
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|87
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|no_namespaces
op_assign
id|ncp_reply_word
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
r_namespace
op_assign
id|ncp_reply_data
c_func
(paren
id|server
comma
l_int|2
)paren
suffix:semicolon
r_while
c_loop
(paren
id|no_namespaces
OG
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;get_namespaces: found %d on %d&bslash;n&quot;
comma
op_star
r_namespace
comma
id|volume
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
r_namespace
op_eq
l_int|4
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;get_namespaces: found OS2&bslash;n&quot;
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_namespace
op_add_assign
l_int|1
suffix:semicolon
id|no_namespaces
op_sub_assign
l_int|1
suffix:semicolon
)brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ncp_lookup_volume
r_int
id|ncp_lookup_volume
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_char
op_star
id|volname
comma
r_struct
id|nw_info_struct
op_star
id|target
)paren
(brace
r_int
id|result
suffix:semicolon
r_int
id|volnum
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ncp_lookup_volume: looking up vol %s&bslash;n&quot;
comma
id|volname
)paren
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|22
)paren
suffix:semicolon
multiline_comment|/* Subfunction: Generate dir handle */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* DOS namespace */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* reserved */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* reserved */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* reserved */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* faked volume number */
id|ncp_add_dword
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* faked dir_base */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t have a dir_base */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* 1 path component */
id|ncp_add_pstring
c_func
(paren
id|server
comma
id|volname
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|87
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|memset
c_func
(paren
id|target
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|target
)paren
)paren
suffix:semicolon
id|target-&gt;DosDirNum
op_assign
id|target-&gt;dirEntNum
op_assign
id|ncp_reply_dword
c_func
(paren
id|server
comma
l_int|4
)paren
suffix:semicolon
id|target-&gt;volNumber
op_assign
id|volnum
op_assign
id|ncp_reply_byte
c_func
(paren
id|server
comma
l_int|8
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|server-&gt;name_space
(braket
id|volnum
)braket
op_assign
id|ncp_has_os2_namespace
c_func
(paren
id|server
comma
id|volnum
)paren
ques
c_cond
l_int|4
suffix:colon
l_int|0
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;lookup_vol: namespace[%d] = %d&bslash;n&quot;
comma
id|volnum
comma
id|server-&gt;name_space
(braket
id|volnum
)braket
)paren
suffix:semicolon
id|target-&gt;nameLen
op_assign
id|strlen
c_func
(paren
id|volname
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|target-&gt;entryName
comma
id|volname
)paren
suffix:semicolon
id|target-&gt;attributes
op_assign
id|aDIR
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ncp_modify_file_or_subdir_dos_info
r_int
id|ncp_modify_file_or_subdir_dos_info
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_struct
id|nw_info_struct
op_star
id|file
comma
id|__u32
id|info_mask
comma
r_struct
id|nw_modify_dos_info
op_star
id|info
)paren
(brace
r_int
id|result
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|7
)paren
suffix:semicolon
multiline_comment|/* subfunction */
id|ncp_add_byte
c_func
(paren
id|server
comma
id|server-&gt;name_space
(braket
id|file-&gt;volNumber
)braket
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* reserved */
id|ncp_add_word
c_func
(paren
id|server
comma
id|htons
c_func
(paren
l_int|0x0680
)paren
)paren
suffix:semicolon
multiline_comment|/* search attribs: all */
id|ncp_add_dword
c_func
(paren
id|server
comma
id|info_mask
)paren
suffix:semicolon
id|ncp_add_mem
c_func
(paren
id|server
comma
id|info
comma
r_sizeof
(paren
op_star
id|info
)paren
)paren
suffix:semicolon
id|ncp_add_handle_path
c_func
(paren
id|server
comma
id|file-&gt;volNumber
comma
id|file-&gt;dirEntNum
comma
l_int|1
comma
l_int|NULL
)paren
suffix:semicolon
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|87
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|ncp_del_file_or_subdir
r_int
id|ncp_del_file_or_subdir
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_struct
id|nw_info_struct
op_star
id|dir
comma
r_char
op_star
id|name
)paren
(brace
r_int
id|result
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|8
)paren
suffix:semicolon
multiline_comment|/* subfunction */
id|ncp_add_byte
c_func
(paren
id|server
comma
id|server-&gt;name_space
(braket
id|dir-&gt;volNumber
)braket
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* reserved */
id|ncp_add_word
c_func
(paren
id|server
comma
id|ntohs
c_func
(paren
l_int|0x0680
)paren
)paren
suffix:semicolon
multiline_comment|/* search attribs: all */
id|ncp_add_handle_path
c_func
(paren
id|server
comma
id|dir-&gt;volNumber
comma
id|dir-&gt;dirEntNum
comma
l_int|1
comma
id|name
)paren
suffix:semicolon
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|87
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|ConvertToNWfromDWORD
r_static
r_inline
r_void
id|ConvertToNWfromDWORD
c_func
(paren
id|__u32
id|sfd
comma
id|__u8
id|ret
(braket
l_int|6
)braket
)paren
(brace
id|__u16
op_star
id|dest
op_assign
(paren
id|__u16
op_star
)paren
id|ret
suffix:semicolon
id|memcpy
c_func
(paren
id|ret
op_plus
l_int|2
comma
op_amp
id|sfd
comma
l_int|4
)paren
suffix:semicolon
id|dest
(braket
l_int|0
)braket
op_assign
id|cpu_to_le16
c_func
(paren
(paren
id|le16_to_cpu
c_func
(paren
id|dest
(braket
l_int|1
)braket
)paren
op_plus
id|le16_to_cpu
c_func
(paren
l_int|1
)paren
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* If both dir and name are NULL, then in target there&squot;s already a&n;   looked-up entry that wants to be opened. */
DECL|function|ncp_open_create_file_or_subdir
r_int
id|ncp_open_create_file_or_subdir
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_struct
id|nw_info_struct
op_star
id|dir
comma
r_char
op_star
id|name
comma
r_int
id|open_create_mode
comma
id|__u32
id|create_attributes
comma
r_int
id|desired_acc_rights
comma
r_struct
id|nw_file_info
op_star
id|target
)paren
(brace
r_int
id|result
suffix:semicolon
id|__u16
id|search_attribs
op_assign
id|ntohs
c_func
(paren
l_int|0x0600
)paren
suffix:semicolon
id|__u8
id|volume
op_assign
(paren
id|dir
op_ne
l_int|NULL
)paren
ques
c_cond
id|dir-&gt;volNumber
suffix:colon
id|target-&gt;i.volNumber
suffix:semicolon
r_if
c_cond
(paren
(paren
id|create_attributes
op_amp
id|aDIR
)paren
op_ne
l_int|0
)paren
(brace
id|search_attribs
op_or_assign
id|ntohs
c_func
(paren
l_int|0x0080
)paren
suffix:semicolon
)brace
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* subfunction */
id|ncp_add_byte
c_func
(paren
id|server
comma
id|server-&gt;name_space
(braket
id|volume
)braket
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
id|open_create_mode
)paren
suffix:semicolon
id|ncp_add_word
c_func
(paren
id|server
comma
id|search_attribs
)paren
suffix:semicolon
id|ncp_add_dword
c_func
(paren
id|server
comma
id|RIM_ALL
)paren
suffix:semicolon
id|ncp_add_dword
c_func
(paren
id|server
comma
id|create_attributes
)paren
suffix:semicolon
multiline_comment|/* The desired acc rights seem to be the inherited rights mask&n;&t;   for directories */
id|ncp_add_word
c_func
(paren
id|server
comma
id|desired_acc_rights
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dir
op_ne
l_int|NULL
)paren
(brace
id|ncp_add_handle_path
c_func
(paren
id|server
comma
id|volume
comma
id|dir-&gt;dirEntNum
comma
l_int|1
comma
id|name
)paren
suffix:semicolon
)brace
r_else
(brace
id|ncp_add_handle_path
c_func
(paren
id|server
comma
id|volume
comma
id|target-&gt;i.dirEntNum
comma
l_int|1
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|87
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|target-&gt;opened
op_assign
l_int|1
suffix:semicolon
id|target-&gt;server_file_handle
op_assign
id|ncp_reply_dword
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
id|target-&gt;open_create_action
op_assign
id|ncp_reply_byte
c_func
(paren
id|server
comma
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dir
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* in target there&squot;s a new finfo to fill */
id|ncp_extract_file_info
c_func
(paren
id|ncp_reply_data
c_func
(paren
id|server
comma
l_int|5
)paren
comma
op_amp
(paren
id|target-&gt;i
)paren
)paren
suffix:semicolon
)brace
id|ConvertToNWfromDWORD
c_func
(paren
id|target-&gt;server_file_handle
comma
id|target-&gt;file_handle
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ncp_initialize_search
r_int
id|ncp_initialize_search
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_struct
id|nw_info_struct
op_star
id|dir
comma
r_struct
id|nw_search_sequence
op_star
id|target
)paren
(brace
r_int
id|result
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* subfunction */
id|ncp_add_byte
c_func
(paren
id|server
comma
id|server-&gt;name_space
(braket
id|dir-&gt;volNumber
)braket
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* reserved */
id|ncp_add_handle_path
c_func
(paren
id|server
comma
id|dir-&gt;volNumber
comma
id|dir-&gt;dirEntNum
comma
l_int|1
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|87
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|target
comma
id|ncp_reply_data
c_func
(paren
id|server
comma
l_int|0
)paren
comma
r_sizeof
(paren
op_star
id|target
)paren
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Search for everything */
DECL|function|ncp_search_for_file_or_subdir
r_int
id|ncp_search_for_file_or_subdir
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_struct
id|nw_search_sequence
op_star
id|seq
comma
r_struct
id|nw_info_struct
op_star
id|target
)paren
(brace
r_int
id|result
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|3
)paren
suffix:semicolon
multiline_comment|/* subfunction */
id|ncp_add_byte
c_func
(paren
id|server
comma
id|server-&gt;name_space
(braket
id|seq-&gt;volNumber
)braket
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* data stream (???) */
id|ncp_add_word
c_func
(paren
id|server
comma
l_int|0xffff
)paren
suffix:semicolon
multiline_comment|/* Search attribs */
id|ncp_add_dword
c_func
(paren
id|server
comma
id|RIM_ALL
)paren
suffix:semicolon
multiline_comment|/* return info mask */
id|ncp_add_mem
c_func
(paren
id|server
comma
id|seq
comma
l_int|9
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 2 byte pattern */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* following is a wildcard */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_char|&squot;*&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|87
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|seq
comma
id|ncp_reply_data
c_func
(paren
id|server
comma
l_int|0
)paren
comma
r_sizeof
(paren
op_star
id|seq
)paren
)paren
suffix:semicolon
id|ncp_extract_file_info
c_func
(paren
id|ncp_reply_data
c_func
(paren
id|server
comma
l_int|10
)paren
comma
id|target
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ncp_ren_or_mov_file_or_subdir
r_int
id|ncp_ren_or_mov_file_or_subdir
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_struct
id|nw_info_struct
op_star
id|old_dir
comma
r_char
op_star
id|old_name
comma
r_struct
id|nw_info_struct
op_star
id|new_dir
comma
r_char
op_star
id|new_name
)paren
(brace
r_int
id|result
suffix:semicolon
r_if
c_cond
(paren
(paren
id|old_dir
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|old_name
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|new_dir
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|new_name
op_eq
l_int|NULL
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* subfunction */
id|ncp_add_byte
c_func
(paren
id|server
comma
id|server-&gt;name_space
(braket
id|old_dir-&gt;volNumber
)braket
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* rename flag */
id|ncp_add_word
c_func
(paren
id|server
comma
id|ntohs
c_func
(paren
l_int|0x0680
)paren
)paren
suffix:semicolon
multiline_comment|/* search attributes */
multiline_comment|/* source Handle Path */
id|ncp_add_byte
c_func
(paren
id|server
comma
id|old_dir-&gt;volNumber
)paren
suffix:semicolon
id|ncp_add_dword
c_func
(paren
id|server
comma
id|old_dir-&gt;dirEntNum
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|1
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* 1 source component */
multiline_comment|/* dest Handle Path */
id|ncp_add_byte
c_func
(paren
id|server
comma
id|new_dir-&gt;volNumber
)paren
suffix:semicolon
id|ncp_add_dword
c_func
(paren
id|server
comma
id|new_dir-&gt;dirEntNum
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|1
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* 1 destination component */
multiline_comment|/* source path string */
id|ncp_add_pstring
c_func
(paren
id|server
comma
id|old_name
)paren
suffix:semicolon
multiline_comment|/* dest path string */
id|ncp_add_pstring
c_func
(paren
id|server
comma
id|new_name
)paren
suffix:semicolon
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|87
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* We have to transfer to/from user space */
DECL|function|ncp_read
r_int
id|ncp_read
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_const
r_char
op_star
id|file_id
comma
id|__u32
id|offset
comma
id|__u16
id|to_read
comma
r_char
op_star
id|target
comma
r_int
op_star
id|bytes_read
)paren
(brace
r_int
id|result
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
id|ncp_add_mem
c_func
(paren
id|server
comma
id|file_id
comma
l_int|6
)paren
suffix:semicolon
id|ncp_add_dword
c_func
(paren
id|server
comma
id|htonl
c_func
(paren
id|offset
)paren
)paren
suffix:semicolon
id|ncp_add_word
c_func
(paren
id|server
comma
id|htons
c_func
(paren
id|to_read
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|72
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
op_star
id|bytes_read
op_assign
id|ntohs
c_func
(paren
id|ncp_reply_word
c_func
(paren
id|server
comma
l_int|0
)paren
)paren
suffix:semicolon
id|copy_to_user
c_func
(paren
id|target
comma
id|ncp_reply_data
c_func
(paren
id|server
comma
l_int|2
op_plus
(paren
id|offset
op_amp
l_int|1
)paren
)paren
comma
op_star
id|bytes_read
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ncp_write
r_int
id|ncp_write
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_const
r_char
op_star
id|file_id
comma
id|__u32
id|offset
comma
id|__u16
id|to_write
comma
r_const
r_char
op_star
id|source
comma
r_int
op_star
id|bytes_written
)paren
(brace
r_int
id|result
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
id|ncp_add_mem
c_func
(paren
id|server
comma
id|file_id
comma
l_int|6
)paren
suffix:semicolon
id|ncp_add_dword
c_func
(paren
id|server
comma
id|htonl
c_func
(paren
id|offset
)paren
)paren
suffix:semicolon
id|ncp_add_word
c_func
(paren
id|server
comma
id|htons
c_func
(paren
id|to_write
)paren
)paren
suffix:semicolon
id|ncp_add_mem_fromfs
c_func
(paren
id|server
comma
id|source
comma
id|to_write
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|73
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
op_star
id|bytes_written
op_assign
id|to_write
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
