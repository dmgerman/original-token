macro_line|#include &quot;ncplib_kernel.h&quot;
DECL|typedef|byte
r_typedef
id|__u8
id|byte
suffix:semicolon
DECL|typedef|word
r_typedef
id|__u16
id|word
suffix:semicolon
DECL|typedef|dword
r_typedef
id|__u32
id|dword
suffix:semicolon
DECL|function|min
r_static
r_inline
r_int
id|min
c_func
(paren
r_int
id|a
comma
r_int
id|b
)paren
(brace
r_return
id|a
OL
id|b
ques
c_cond
id|a
suffix:colon
id|b
suffix:semicolon
)brace
r_static
r_void
DECL|function|assert_server_locked
id|assert_server_locked
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
)paren
(brace
r_if
c_cond
(paren
id|server-&gt;lock
op_eq
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;ncpfs: server not locked!&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|ncp_add_byte
id|ncp_add_byte
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
id|byte
id|x
)paren
(brace
id|assert_server_locked
c_func
(paren
id|server
)paren
suffix:semicolon
op_star
(paren
id|byte
op_star
)paren
(paren
op_amp
(paren
id|server-&gt;packet
(braket
id|server-&gt;current_size
)braket
)paren
)paren
op_assign
id|x
suffix:semicolon
id|server-&gt;current_size
op_add_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
r_static
r_void
DECL|function|ncp_add_word
id|ncp_add_word
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
id|word
id|x
)paren
(brace
id|assert_server_locked
c_func
(paren
id|server
)paren
suffix:semicolon
op_star
(paren
id|word
op_star
)paren
(paren
op_amp
(paren
id|server-&gt;packet
(braket
id|server-&gt;current_size
)braket
)paren
)paren
op_assign
id|x
suffix:semicolon
id|server-&gt;current_size
op_add_assign
l_int|2
suffix:semicolon
r_return
suffix:semicolon
)brace
r_static
r_void
DECL|function|ncp_add_dword
id|ncp_add_dword
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
id|dword
id|x
)paren
(brace
id|assert_server_locked
c_func
(paren
id|server
)paren
suffix:semicolon
op_star
(paren
id|dword
op_star
)paren
(paren
op_amp
(paren
id|server-&gt;packet
(braket
id|server-&gt;current_size
)braket
)paren
)paren
op_assign
id|x
suffix:semicolon
id|server-&gt;current_size
op_add_assign
l_int|4
suffix:semicolon
r_return
suffix:semicolon
)brace
r_static
r_void
DECL|function|ncp_add_mem
id|ncp_add_mem
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_const
r_void
op_star
id|source
comma
r_int
id|size
)paren
(brace
id|assert_server_locked
c_func
(paren
id|server
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
(paren
id|server-&gt;packet
(braket
id|server-&gt;current_size
)braket
)paren
comma
id|source
comma
id|size
)paren
suffix:semicolon
id|server-&gt;current_size
op_add_assign
id|size
suffix:semicolon
r_return
suffix:semicolon
)brace
r_static
r_void
DECL|function|ncp_add_mem_fromfs
id|ncp_add_mem_fromfs
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_const
r_char
op_star
id|source
comma
r_int
id|size
)paren
(brace
id|assert_server_locked
c_func
(paren
id|server
)paren
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
op_amp
(paren
id|server-&gt;packet
(braket
id|server-&gt;current_size
)braket
)paren
comma
id|source
comma
id|size
)paren
suffix:semicolon
id|server-&gt;current_size
op_add_assign
id|size
suffix:semicolon
r_return
suffix:semicolon
)brace
r_static
r_void
DECL|function|ncp_add_pstring
id|ncp_add_pstring
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_const
r_char
op_star
id|s
)paren
(brace
r_int
id|len
op_assign
id|strlen
c_func
(paren
id|s
)paren
suffix:semicolon
id|assert_server_locked
c_func
(paren
id|server
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|255
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;ncpfs: string too long: %s&bslash;n&quot;
comma
id|s
)paren
suffix:semicolon
id|len
op_assign
l_int|255
suffix:semicolon
)brace
id|ncp_add_byte
c_func
(paren
id|server
comma
id|len
)paren
suffix:semicolon
id|ncp_add_mem
c_func
(paren
id|server
comma
id|s
comma
id|len
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_static
r_void
DECL|function|ncp_init_request
id|ncp_init_request
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
)paren
(brace
id|ncp_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|server-&gt;current_size
op_assign
r_sizeof
(paren
r_struct
id|ncp_request_header
)paren
suffix:semicolon
id|server-&gt;has_subfunction
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|ncp_init_request_s
id|ncp_init_request_s
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_int
id|subfunction
)paren
(brace
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_word
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* preliminary size */
id|ncp_add_byte
c_func
(paren
id|server
comma
id|subfunction
)paren
suffix:semicolon
id|server-&gt;has_subfunction
op_assign
l_int|1
suffix:semicolon
)brace
r_static
r_char
op_star
DECL|function|ncp_reply_data
id|ncp_reply_data
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_int
id|offset
)paren
(brace
r_return
op_amp
(paren
id|server-&gt;packet
(braket
r_sizeof
(paren
r_struct
id|ncp_reply_header
)paren
op_plus
id|offset
)braket
)paren
suffix:semicolon
)brace
r_static
id|byte
DECL|function|ncp_reply_byte
id|ncp_reply_byte
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_int
id|offset
)paren
(brace
r_return
op_star
(paren
id|byte
op_star
)paren
(paren
id|ncp_reply_data
c_func
(paren
id|server
comma
id|offset
)paren
)paren
suffix:semicolon
)brace
r_static
id|word
DECL|function|ncp_reply_word
id|ncp_reply_word
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_int
id|offset
)paren
(brace
r_return
op_star
(paren
id|word
op_star
)paren
(paren
id|ncp_reply_data
c_func
(paren
id|server
comma
id|offset
)paren
)paren
suffix:semicolon
)brace
r_static
id|dword
DECL|function|ncp_reply_dword
id|ncp_reply_dword
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_int
id|offset
)paren
(brace
r_return
op_star
(paren
id|dword
op_star
)paren
(paren
id|ncp_reply_data
c_func
(paren
id|server
comma
id|offset
)paren
)paren
suffix:semicolon
)brace
r_int
DECL|function|ncp_negotiate_buffersize
id|ncp_negotiate_buffersize
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_int
id|size
comma
r_int
op_star
id|target
)paren
(brace
r_int
id|result
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_word
c_func
(paren
id|server
comma
id|htons
c_func
(paren
id|size
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|33
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
op_star
id|target
op_assign
id|min
c_func
(paren
id|ntohs
c_func
(paren
id|ncp_reply_word
c_func
(paren
id|server
comma
l_int|0
)paren
)paren
comma
id|size
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|ncp_get_volume_info_with_number
id|ncp_get_volume_info_with_number
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_int
id|n
comma
r_struct
id|ncp_volume_info
op_star
id|target
)paren
(brace
r_int
id|result
suffix:semicolon
r_int
id|len
suffix:semicolon
id|ncp_init_request_s
c_func
(paren
id|server
comma
l_int|44
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
id|n
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|22
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|target-&gt;total_blocks
op_assign
id|ncp_reply_dword
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
id|target-&gt;free_blocks
op_assign
id|ncp_reply_dword
c_func
(paren
id|server
comma
l_int|4
)paren
suffix:semicolon
id|target-&gt;purgeable_blocks
op_assign
id|ncp_reply_dword
c_func
(paren
id|server
comma
l_int|8
)paren
suffix:semicolon
id|target-&gt;not_yet_purgeable_blocks
op_assign
id|ncp_reply_dword
c_func
(paren
id|server
comma
l_int|12
)paren
suffix:semicolon
id|target-&gt;total_dir_entries
op_assign
id|ncp_reply_dword
c_func
(paren
id|server
comma
l_int|16
)paren
suffix:semicolon
id|target-&gt;available_dir_entries
op_assign
id|ncp_reply_dword
c_func
(paren
id|server
comma
l_int|20
)paren
suffix:semicolon
id|target-&gt;sectors_per_block
op_assign
id|ncp_reply_byte
c_func
(paren
id|server
comma
l_int|28
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
(paren
id|target-&gt;volume_name
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|target-&gt;volume_name
)paren
)paren
suffix:semicolon
id|len
op_assign
id|ncp_reply_byte
c_func
(paren
id|server
comma
l_int|29
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|NCP_VOLNAME_LEN
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;ncpfs: volume name too long: %d&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|memcpy
c_func
(paren
op_amp
(paren
id|target-&gt;volume_name
)paren
comma
id|ncp_reply_data
c_func
(paren
id|server
comma
l_int|30
)paren
comma
id|len
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|ncp_get_volume_number
id|ncp_get_volume_number
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_const
r_char
op_star
id|name
comma
r_int
op_star
id|target
)paren
(brace
r_int
id|result
suffix:semicolon
id|ncp_init_request_s
c_func
(paren
id|server
comma
l_int|5
)paren
suffix:semicolon
id|ncp_add_pstring
c_func
(paren
id|server
comma
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|22
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
op_star
id|target
op_assign
id|ncp_reply_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|ncp_close_file
id|ncp_close_file
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_const
r_char
op_star
id|file_id
)paren
(brace
r_int
id|result
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
id|ncp_add_mem
c_func
(paren
id|server
comma
id|file_id
comma
l_int|6
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|66
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|ncp_add_handle_path
id|ncp_add_handle_path
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
id|__u8
id|vol_num
comma
id|__u32
id|dir_base
comma
r_int
id|have_dir_base
comma
r_char
op_star
id|path
)paren
(brace
id|ncp_add_byte
c_func
(paren
id|server
comma
id|vol_num
)paren
suffix:semicolon
id|ncp_add_dword
c_func
(paren
id|server
comma
id|dir_base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|have_dir_base
op_ne
l_int|0
)paren
(brace
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* dir_base */
)brace
r_else
(brace
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* no handle */
)brace
r_if
c_cond
(paren
id|path
op_ne
l_int|NULL
)paren
(brace
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* 1 component */
id|ncp_add_pstring
c_func
(paren
id|server
comma
id|path
)paren
suffix:semicolon
)brace
r_else
(brace
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|ncp_extract_file_info
id|ncp_extract_file_info
c_func
(paren
r_void
op_star
id|structure
comma
r_struct
id|nw_info_struct
op_star
id|target
)paren
(brace
id|__u8
op_star
id|name_len
suffix:semicolon
r_const
r_int
id|info_struct_size
op_assign
r_sizeof
(paren
r_struct
id|nw_info_struct
)paren
op_minus
l_int|257
suffix:semicolon
id|memcpy
c_func
(paren
id|target
comma
id|structure
comma
id|info_struct_size
)paren
suffix:semicolon
id|name_len
op_assign
id|structure
op_plus
id|info_struct_size
suffix:semicolon
id|target-&gt;nameLen
op_assign
op_star
id|name_len
suffix:semicolon
id|strncpy
c_func
(paren
id|target-&gt;entryName
comma
id|name_len
op_plus
l_int|1
comma
op_star
id|name_len
)paren
suffix:semicolon
id|target-&gt;entryName
(braket
op_star
id|name_len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
suffix:semicolon
)brace
r_int
DECL|function|ncp_do_lookup
id|ncp_do_lookup
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_struct
id|nw_info_struct
op_star
id|dir
comma
r_char
op_star
id|path
comma
multiline_comment|/* may only be one component */
r_struct
id|nw_info_struct
op_star
id|target
)paren
(brace
id|__u8
id|vol_num
suffix:semicolon
id|__u32
id|dir_base
suffix:semicolon
r_int
id|result
suffix:semicolon
r_char
op_star
id|volname
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|target
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dir
op_eq
l_int|NULL
)paren
(brace
id|DDPRINTK
c_func
(paren
l_string|&quot;ncp_do_lookup: looking up vol %s&bslash;n&quot;
comma
id|path
)paren
suffix:semicolon
multiline_comment|/* Access a volume&squot;s root directory */
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|22
)paren
suffix:semicolon
multiline_comment|/* subfunction */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* dos name space */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* reserved */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* reserved */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* reserved */
id|ncp_add_handle_path
c_func
(paren
id|server
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* no handle */
id|path
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|87
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|dir_base
op_assign
id|ncp_reply_dword
c_func
(paren
id|server
comma
l_int|4
)paren
suffix:semicolon
id|vol_num
op_assign
id|ncp_reply_byte
(paren
id|server
comma
l_int|8
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|volname
op_assign
id|path
suffix:semicolon
id|path
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|vol_num
op_assign
id|dir-&gt;volNumber
suffix:semicolon
id|dir_base
op_assign
id|dir-&gt;DosDirNum
suffix:semicolon
)brace
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|6
)paren
suffix:semicolon
multiline_comment|/* subfunction */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* dos name space */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* dos name space as dest */
id|ncp_add_word
c_func
(paren
id|server
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* get all */
id|ncp_add_dword
c_func
(paren
id|server
comma
id|RIM_ALL
)paren
suffix:semicolon
id|ncp_add_handle_path
c_func
(paren
id|server
comma
id|vol_num
comma
id|dir_base
comma
l_int|1
comma
id|path
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|87
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|ncp_extract_file_info
c_func
(paren
id|ncp_reply_data
c_func
(paren
id|server
comma
l_int|0
)paren
comma
id|target
)paren
suffix:semicolon
r_if
c_cond
(paren
id|volname
op_ne
l_int|NULL
)paren
(brace
id|target-&gt;nameLen
op_assign
id|strlen
c_func
(paren
id|volname
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|target-&gt;entryName
comma
id|volname
)paren
suffix:semicolon
)brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|ncp_modify_file_or_subdir_dos_info
id|ncp_modify_file_or_subdir_dos_info
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_struct
id|nw_info_struct
op_star
id|file
comma
id|__u32
id|info_mask
comma
r_struct
id|nw_modify_dos_info
op_star
id|info
)paren
(brace
r_int
id|result
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|7
)paren
suffix:semicolon
multiline_comment|/* subfunction */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* dos name space */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* reserved */
id|ncp_add_word
c_func
(paren
id|server
comma
l_int|0x8006
)paren
suffix:semicolon
multiline_comment|/* search attribs: all */
id|ncp_add_dword
c_func
(paren
id|server
comma
id|info_mask
)paren
suffix:semicolon
id|ncp_add_mem
c_func
(paren
id|server
comma
id|info
comma
r_sizeof
(paren
op_star
id|info
)paren
)paren
suffix:semicolon
id|ncp_add_handle_path
c_func
(paren
id|server
comma
id|file-&gt;volNumber
comma
id|file-&gt;DosDirNum
comma
l_int|1
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|87
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|ncp_del_file_or_subdir
id|ncp_del_file_or_subdir
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_struct
id|nw_info_struct
op_star
id|dir
comma
r_char
op_star
id|name
)paren
(brace
r_int
id|result
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|8
)paren
suffix:semicolon
multiline_comment|/* subfunction */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* dos name space */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* reserved */
id|ncp_add_word
c_func
(paren
id|server
comma
l_int|0x8006
)paren
suffix:semicolon
multiline_comment|/* search attribs: all */
id|ncp_add_handle_path
c_func
(paren
id|server
comma
id|dir-&gt;volNumber
comma
id|dir-&gt;DosDirNum
comma
l_int|1
comma
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|87
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|ConvertToNWfromDWORD
id|ConvertToNWfromDWORD
(paren
id|__u32
id|sfd
comma
id|__u8
id|ret
(braket
l_int|6
)braket
)paren
(brace
id|__u16
op_star
id|dest
op_assign
(paren
id|__u16
op_star
)paren
id|ret
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
(paren
id|dest
(braket
l_int|1
)braket
)paren
comma
op_amp
id|sfd
comma
l_int|4
)paren
suffix:semicolon
id|dest
(braket
l_int|0
)braket
op_assign
id|dest
(braket
l_int|1
)braket
op_plus
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* If both dir and name are NULL, then in target there&squot;s already a&n;   looked-up entry that wants to be opened. */
r_int
DECL|function|ncp_open_create_file_or_subdir
id|ncp_open_create_file_or_subdir
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_struct
id|nw_info_struct
op_star
id|dir
comma
r_char
op_star
id|name
comma
r_int
id|open_create_mode
comma
id|__u32
id|create_attributes
comma
r_int
id|desired_acc_rights
comma
r_struct
id|nw_file_info
op_star
id|target
)paren
(brace
r_int
id|result
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* subfunction */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* dos name space */
id|ncp_add_byte
c_func
(paren
id|server
comma
id|open_create_mode
)paren
suffix:semicolon
id|ncp_add_word
c_func
(paren
id|server
comma
l_int|0x8006
)paren
suffix:semicolon
id|ncp_add_dword
c_func
(paren
id|server
comma
id|RIM_ALL
)paren
suffix:semicolon
id|ncp_add_dword
c_func
(paren
id|server
comma
id|create_attributes
)paren
suffix:semicolon
multiline_comment|/* The desired acc rights seem to be the inherited rights mask&n;&t;   for directories */
id|ncp_add_word
c_func
(paren
id|server
comma
id|desired_acc_rights
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dir
op_ne
l_int|NULL
)paren
(brace
id|ncp_add_handle_path
c_func
(paren
id|server
comma
id|dir-&gt;volNumber
comma
id|dir-&gt;DosDirNum
comma
l_int|1
comma
id|name
)paren
suffix:semicolon
)brace
r_else
(brace
id|ncp_add_handle_path
c_func
(paren
id|server
comma
id|target-&gt;i.volNumber
comma
id|target-&gt;i.DosDirNum
comma
l_int|1
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|87
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|target-&gt;opened
op_assign
l_int|1
suffix:semicolon
id|target-&gt;server_file_handle
op_assign
id|ncp_reply_dword
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
id|target-&gt;open_create_action
op_assign
id|ncp_reply_byte
c_func
(paren
id|server
comma
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dir
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* in target there&squot;s a new finfo to fill */
id|ncp_extract_file_info
c_func
(paren
id|ncp_reply_data
c_func
(paren
id|server
comma
l_int|5
)paren
comma
op_amp
(paren
id|target-&gt;i
)paren
)paren
suffix:semicolon
)brace
id|ConvertToNWfromDWORD
c_func
(paren
id|target-&gt;server_file_handle
comma
id|target-&gt;file_handle
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|ncp_initialize_search
id|ncp_initialize_search
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_struct
id|nw_info_struct
op_star
id|dir
comma
r_struct
id|nw_search_sequence
op_star
id|target
)paren
(brace
r_int
id|result
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* subfunction */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* dos name space */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* reserved */
id|ncp_add_handle_path
c_func
(paren
id|server
comma
id|dir-&gt;volNumber
comma
id|dir-&gt;DosDirNum
comma
l_int|1
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|87
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|target
comma
id|ncp_reply_data
c_func
(paren
id|server
comma
l_int|0
)paren
comma
r_sizeof
(paren
op_star
id|target
)paren
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Search for everything */
r_int
DECL|function|ncp_search_for_file_or_subdir
id|ncp_search_for_file_or_subdir
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_struct
id|nw_search_sequence
op_star
id|seq
comma
r_struct
id|nw_info_struct
op_star
id|target
)paren
(brace
r_int
id|result
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|3
)paren
suffix:semicolon
multiline_comment|/* subfunction */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* dos name space */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* data stream (???) */
id|ncp_add_word
c_func
(paren
id|server
comma
l_int|0xffff
)paren
suffix:semicolon
multiline_comment|/* Search attribs */
id|ncp_add_dword
c_func
(paren
id|server
comma
id|RIM_ALL
)paren
suffix:semicolon
multiline_comment|/* return info mask */
id|ncp_add_mem
c_func
(paren
id|server
comma
id|seq
comma
l_int|9
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 2 byte pattern */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* following is a wildcard */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_char|&squot;*&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|87
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|seq
comma
id|ncp_reply_data
c_func
(paren
id|server
comma
l_int|0
)paren
comma
r_sizeof
(paren
op_star
id|seq
)paren
)paren
suffix:semicolon
id|ncp_extract_file_info
c_func
(paren
id|ncp_reply_data
c_func
(paren
id|server
comma
l_int|10
)paren
comma
id|target
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|ncp_ren_or_mov_file_or_subdir
id|ncp_ren_or_mov_file_or_subdir
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_struct
id|nw_info_struct
op_star
id|old_dir
comma
r_char
op_star
id|old_name
comma
r_struct
id|nw_info_struct
op_star
id|new_dir
comma
r_char
op_star
id|new_name
)paren
(brace
r_int
id|result
suffix:semicolon
r_if
c_cond
(paren
(paren
id|old_dir
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|old_name
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|new_dir
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|new_name
op_eq
l_int|NULL
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* subfunction */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* dos name space */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* rename flag */
id|ncp_add_word
c_func
(paren
id|server
comma
l_int|0x8006
)paren
suffix:semicolon
multiline_comment|/* search attributes */
multiline_comment|/* source Handle Path */
id|ncp_add_byte
c_func
(paren
id|server
comma
id|old_dir-&gt;volNumber
)paren
suffix:semicolon
id|ncp_add_dword
c_func
(paren
id|server
comma
id|old_dir-&gt;DosDirNum
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|1
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* 1 source component */
multiline_comment|/* dest Handle Path */
id|ncp_add_byte
c_func
(paren
id|server
comma
id|new_dir-&gt;volNumber
)paren
suffix:semicolon
id|ncp_add_dword
c_func
(paren
id|server
comma
id|new_dir-&gt;DosDirNum
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|1
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* 1 destination component */
multiline_comment|/* source path string */
id|ncp_add_pstring
c_func
(paren
id|server
comma
id|old_name
)paren
suffix:semicolon
multiline_comment|/* dest path string */
id|ncp_add_pstring
c_func
(paren
id|server
comma
id|new_name
)paren
suffix:semicolon
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|87
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* We have to transfer to/from user space */
r_int
DECL|function|ncp_read
id|ncp_read
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_const
r_char
op_star
id|file_id
comma
id|__u32
id|offset
comma
id|__u16
id|to_read
comma
r_char
op_star
id|target
comma
r_int
op_star
id|bytes_read
)paren
(brace
r_int
id|result
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
id|ncp_add_mem
c_func
(paren
id|server
comma
id|file_id
comma
l_int|6
)paren
suffix:semicolon
id|ncp_add_dword
c_func
(paren
id|server
comma
id|htonl
c_func
(paren
id|offset
)paren
)paren
suffix:semicolon
id|ncp_add_word
c_func
(paren
id|server
comma
id|htons
c_func
(paren
id|to_read
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|72
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
op_star
id|bytes_read
op_assign
id|ntohs
c_func
(paren
id|ncp_reply_word
c_func
(paren
id|server
comma
l_int|0
)paren
)paren
suffix:semicolon
id|memcpy_tofs
c_func
(paren
id|target
comma
id|ncp_reply_data
c_func
(paren
id|server
comma
l_int|2
op_plus
(paren
id|offset
op_amp
l_int|1
)paren
)paren
comma
op_star
id|bytes_read
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|ncp_write
id|ncp_write
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_const
r_char
op_star
id|file_id
comma
id|__u32
id|offset
comma
id|__u16
id|to_write
comma
r_const
r_char
op_star
id|source
comma
r_int
op_star
id|bytes_written
)paren
(brace
r_int
id|result
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
id|ncp_add_mem
c_func
(paren
id|server
comma
id|file_id
comma
l_int|6
)paren
suffix:semicolon
id|ncp_add_dword
c_func
(paren
id|server
comma
id|htonl
c_func
(paren
id|offset
)paren
)paren
suffix:semicolon
id|ncp_add_word
c_func
(paren
id|server
comma
id|htons
c_func
(paren
id|to_write
)paren
)paren
suffix:semicolon
id|ncp_add_mem_fromfs
c_func
(paren
id|server
comma
id|source
comma
id|to_write
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|73
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
op_star
id|bytes_written
op_assign
id|to_write
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
