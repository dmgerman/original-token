multiline_comment|/*&n; *  ncplib_kernel.c&n; *&n; *  Copyright (C) 1995, 1996 by Volker Lendecke&n; *  Modified for big endian by J.F. Chadima and David S. Miller&n; *  Modified 1997 Peter Waltenberg, Bill Hawes, David Woodhouse for 2.1 dcache&n; *  Modified 1999 Wolfram Pienkoss for NLS&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &quot;ncplib_kernel.h&quot;
DECL|function|min
r_static
r_inline
r_int
id|min
c_func
(paren
r_int
id|a
comma
r_int
id|b
)paren
(brace
r_return
id|a
OL
id|b
ques
c_cond
id|a
suffix:colon
id|b
suffix:semicolon
)brace
DECL|function|assert_server_locked
r_static
r_inline
r_void
id|assert_server_locked
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
)paren
(brace
r_if
c_cond
(paren
id|server-&gt;lock
op_eq
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;ncpfs: server not locked!&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|function|ncp_add_byte
r_static
r_void
id|ncp_add_byte
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
id|__u8
id|x
)paren
(brace
id|assert_server_locked
c_func
(paren
id|server
)paren
suffix:semicolon
op_star
(paren
id|__u8
op_star
)paren
(paren
op_amp
(paren
id|server-&gt;packet
(braket
id|server-&gt;current_size
)braket
)paren
)paren
op_assign
id|x
suffix:semicolon
id|server-&gt;current_size
op_add_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|ncp_add_word
r_static
r_void
id|ncp_add_word
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
id|__u16
id|x
)paren
(brace
id|assert_server_locked
c_func
(paren
id|server
)paren
suffix:semicolon
id|put_unaligned
c_func
(paren
id|x
comma
(paren
id|__u16
op_star
)paren
(paren
op_amp
(paren
id|server-&gt;packet
(braket
id|server-&gt;current_size
)braket
)paren
)paren
)paren
suffix:semicolon
id|server-&gt;current_size
op_add_assign
l_int|2
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|ncp_add_dword
r_static
r_void
id|ncp_add_dword
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
id|__u32
id|x
)paren
(brace
id|assert_server_locked
c_func
(paren
id|server
)paren
suffix:semicolon
id|put_unaligned
c_func
(paren
id|x
comma
(paren
id|__u32
op_star
)paren
(paren
op_amp
(paren
id|server-&gt;packet
(braket
id|server-&gt;current_size
)braket
)paren
)paren
)paren
suffix:semicolon
id|server-&gt;current_size
op_add_assign
l_int|4
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|ncp_add_mem
r_static
r_void
id|ncp_add_mem
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_const
r_void
op_star
id|source
comma
r_int
id|size
)paren
(brace
id|assert_server_locked
c_func
(paren
id|server
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
(paren
id|server-&gt;packet
(braket
id|server-&gt;current_size
)braket
)paren
comma
id|source
comma
id|size
)paren
suffix:semicolon
id|server-&gt;current_size
op_add_assign
id|size
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|ncp_add_mem_fromfs
r_static
r_void
id|ncp_add_mem_fromfs
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_const
r_char
op_star
id|source
comma
r_int
id|size
)paren
(brace
id|assert_server_locked
c_func
(paren
id|server
)paren
suffix:semicolon
id|copy_from_user
c_func
(paren
op_amp
(paren
id|server-&gt;packet
(braket
id|server-&gt;current_size
)braket
)paren
comma
id|source
comma
id|size
)paren
suffix:semicolon
id|server-&gt;current_size
op_add_assign
id|size
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|ncp_add_pstring
r_static
r_void
id|ncp_add_pstring
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_const
r_char
op_star
id|s
)paren
(brace
r_int
id|len
op_assign
id|strlen
c_func
(paren
id|s
)paren
suffix:semicolon
id|assert_server_locked
c_func
(paren
id|server
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|255
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;ncpfs: string too long: %s&bslash;n&quot;
comma
id|s
)paren
suffix:semicolon
id|len
op_assign
l_int|255
suffix:semicolon
)brace
id|ncp_add_byte
c_func
(paren
id|server
comma
id|len
)paren
suffix:semicolon
id|ncp_add_mem
c_func
(paren
id|server
comma
id|s
comma
id|len
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|ncp_init_request
r_static
r_inline
r_void
id|ncp_init_request
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
)paren
(brace
id|ncp_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|server-&gt;current_size
op_assign
r_sizeof
(paren
r_struct
id|ncp_request_header
)paren
suffix:semicolon
id|server-&gt;has_subfunction
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|ncp_init_request_s
r_static
r_inline
r_void
id|ncp_init_request_s
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_int
id|subfunction
)paren
(brace
id|ncp_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|server-&gt;current_size
op_assign
r_sizeof
(paren
r_struct
id|ncp_request_header
)paren
op_plus
l_int|2
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
id|subfunction
)paren
suffix:semicolon
id|server-&gt;has_subfunction
op_assign
l_int|1
suffix:semicolon
)brace
r_static
r_inline
r_char
op_star
DECL|function|ncp_reply_data
id|ncp_reply_data
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_int
id|offset
)paren
(brace
r_return
op_amp
(paren
id|server-&gt;packet
(braket
r_sizeof
(paren
r_struct
id|ncp_reply_header
)paren
op_plus
id|offset
)braket
)paren
suffix:semicolon
)brace
r_static
id|__u8
DECL|function|ncp_reply_byte
id|ncp_reply_byte
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_int
id|offset
)paren
(brace
r_return
id|get_unaligned
c_func
(paren
(paren
id|__u8
op_star
)paren
id|ncp_reply_data
c_func
(paren
id|server
comma
id|offset
)paren
)paren
suffix:semicolon
)brace
r_static
id|__u16
DECL|function|ncp_reply_word
id|ncp_reply_word
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_int
id|offset
)paren
(brace
r_return
id|get_unaligned
c_func
(paren
(paren
id|__u16
op_star
)paren
id|ncp_reply_data
c_func
(paren
id|server
comma
id|offset
)paren
)paren
suffix:semicolon
)brace
r_static
id|__u32
DECL|function|ncp_reply_dword
id|ncp_reply_dword
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_int
id|offset
)paren
(brace
r_return
id|get_unaligned
c_func
(paren
(paren
id|__u32
op_star
)paren
id|ncp_reply_data
c_func
(paren
id|server
comma
id|offset
)paren
)paren
suffix:semicolon
)brace
r_int
DECL|function|ncp_negotiate_buffersize
id|ncp_negotiate_buffersize
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_int
id|size
comma
r_int
op_star
id|target
)paren
(brace
r_int
id|result
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_word
c_func
(paren
id|server
comma
id|htons
c_func
(paren
id|size
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|33
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
op_star
id|target
op_assign
id|min
c_func
(paren
id|ntohs
c_func
(paren
id|ncp_reply_word
c_func
(paren
id|server
comma
l_int|0
)paren
)paren
comma
id|size
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* options: &n; *&t;bit 0&t;ipx checksum&n; *&t;bit 1&t;packet signing&n; */
r_int
DECL|function|ncp_negotiate_size_and_options
id|ncp_negotiate_size_and_options
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_int
id|size
comma
r_int
id|options
comma
r_int
op_star
id|ret_size
comma
r_int
op_star
id|ret_options
)paren
(brace
r_int
id|result
suffix:semicolon
multiline_comment|/* there is minimum */
r_if
c_cond
(paren
id|size
OL
id|NCP_BLOCK_SIZE
)paren
id|size
op_assign
id|NCP_BLOCK_SIZE
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_word
c_func
(paren
id|server
comma
id|htons
c_func
(paren
id|size
)paren
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
id|options
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|0x61
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* NCP over UDP returns 0 (!!!) */
id|result
op_assign
id|ntohs
c_func
(paren
id|ncp_reply_word
c_func
(paren
id|server
comma
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ge
id|NCP_BLOCK_SIZE
)paren
id|size
op_assign
id|min
c_func
(paren
id|result
comma
id|size
)paren
suffix:semicolon
op_star
id|ret_size
op_assign
id|size
suffix:semicolon
op_star
id|ret_options
op_assign
id|ncp_reply_byte
c_func
(paren
id|server
comma
l_int|4
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|ncp_get_volume_info_with_number
id|ncp_get_volume_info_with_number
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_int
id|n
comma
r_struct
id|ncp_volume_info
op_star
id|target
)paren
(brace
r_int
id|result
suffix:semicolon
r_int
id|len
suffix:semicolon
id|ncp_init_request_s
c_func
(paren
id|server
comma
l_int|44
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
id|n
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|22
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|target-&gt;total_blocks
op_assign
id|ncp_reply_dword
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
id|target-&gt;free_blocks
op_assign
id|ncp_reply_dword
c_func
(paren
id|server
comma
l_int|4
)paren
suffix:semicolon
id|target-&gt;purgeable_blocks
op_assign
id|ncp_reply_dword
c_func
(paren
id|server
comma
l_int|8
)paren
suffix:semicolon
id|target-&gt;not_yet_purgeable_blocks
op_assign
id|ncp_reply_dword
c_func
(paren
id|server
comma
l_int|12
)paren
suffix:semicolon
id|target-&gt;total_dir_entries
op_assign
id|ncp_reply_dword
c_func
(paren
id|server
comma
l_int|16
)paren
suffix:semicolon
id|target-&gt;available_dir_entries
op_assign
id|ncp_reply_dword
c_func
(paren
id|server
comma
l_int|20
)paren
suffix:semicolon
id|target-&gt;sectors_per_block
op_assign
id|ncp_reply_byte
c_func
(paren
id|server
comma
l_int|28
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
(paren
id|target-&gt;volume_name
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|target-&gt;volume_name
)paren
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
id|len
op_assign
id|ncp_reply_byte
c_func
(paren
id|server
comma
l_int|29
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|NCP_VOLNAME_LEN
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;ncpfs: volume name too long: %d&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|memcpy
c_func
(paren
op_amp
(paren
id|target-&gt;volume_name
)paren
comma
id|ncp_reply_data
c_func
(paren
id|server
comma
l_int|30
)paren
comma
id|len
)paren
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|ncp_close_file
id|ncp_close_file
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_const
r_char
op_star
id|file_id
)paren
(brace
r_int
id|result
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
id|ncp_add_mem
c_func
(paren
id|server
comma
id|file_id
comma
l_int|6
)paren
suffix:semicolon
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|66
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|ncp_make_closed
id|ncp_make_closed
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
r_int
id|err
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
id|down
c_func
(paren
op_amp
id|NCP_FINFO
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|open_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|NCP_FINFO
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|opened
)paren
op_eq
l_int|1
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|NCP_FINFO
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|opened
comma
l_int|0
)paren
suffix:semicolon
id|err
op_assign
id|ncp_close_file
c_func
(paren
id|NCP_SERVER
c_func
(paren
id|inode
)paren
comma
id|NCP_FINFO
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|file_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
id|PPRINTK
c_func
(paren
l_string|&quot;ncp_make_closed: volnum=%d, dirent=%u, error=%d&bslash;n&quot;
comma
id|NCP_FINFO
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|volNumber
comma
id|NCP_FINFO
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|dirEntNum
comma
id|err
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|NCP_FINFO
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|open_sem
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|ncp_add_handle_path
r_static
r_void
id|ncp_add_handle_path
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
id|__u8
id|vol_num
comma
id|__u32
id|dir_base
comma
r_int
id|have_dir_base
comma
r_const
r_char
op_star
id|path
)paren
(brace
id|ncp_add_byte
c_func
(paren
id|server
comma
id|vol_num
)paren
suffix:semicolon
id|ncp_add_dword
c_func
(paren
id|server
comma
id|dir_base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|have_dir_base
op_ne
l_int|0
)paren
(brace
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* dir_base */
)brace
r_else
(brace
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* no handle */
)brace
r_if
c_cond
(paren
id|path
op_ne
l_int|NULL
)paren
(brace
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* 1 component */
id|ncp_add_pstring
c_func
(paren
id|server
comma
id|path
)paren
suffix:semicolon
)brace
r_else
(brace
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
DECL|function|ncp_extract_file_info
r_static
r_void
id|ncp_extract_file_info
c_func
(paren
r_void
op_star
id|structure
comma
r_struct
id|nw_info_struct
op_star
id|target
)paren
(brace
id|__u8
op_star
id|name_len
suffix:semicolon
r_const
r_int
id|info_struct_size
op_assign
r_sizeof
(paren
r_struct
id|nw_info_struct
)paren
op_minus
l_int|257
suffix:semicolon
id|memcpy
c_func
(paren
id|target
comma
id|structure
comma
id|info_struct_size
)paren
suffix:semicolon
id|name_len
op_assign
id|structure
op_plus
id|info_struct_size
suffix:semicolon
id|target-&gt;nameLen
op_assign
op_star
id|name_len
suffix:semicolon
id|memcpy
c_func
(paren
id|target-&gt;entryName
comma
id|name_len
op_plus
l_int|1
comma
op_star
id|name_len
)paren
suffix:semicolon
id|target-&gt;entryName
(braket
op_star
id|name_len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Returns information for a (one-component) name relative to&n; * the specified directory.&n; */
DECL|function|ncp_obtain_info
r_int
id|ncp_obtain_info
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_struct
id|inode
op_star
id|dir
comma
r_char
op_star
id|path
comma
r_struct
id|nw_info_struct
op_star
id|target
)paren
(brace
id|__u8
id|volnum
op_assign
id|NCP_FINFO
c_func
(paren
id|dir
)paren
op_member_access_from_pointer
id|volNumber
suffix:semicolon
id|__u32
id|dirent
op_assign
id|NCP_FINFO
c_func
(paren
id|dir
)paren
op_member_access_from_pointer
id|dirEntNum
suffix:semicolon
r_int
id|result
suffix:semicolon
r_if
c_cond
(paren
id|target
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ncp_obtain_info: invalid call&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|6
)paren
suffix:semicolon
multiline_comment|/* subfunction */
id|ncp_add_byte
c_func
(paren
id|server
comma
id|server-&gt;name_space
(braket
id|volnum
)braket
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
id|server-&gt;name_space
(braket
id|volnum
)braket
)paren
suffix:semicolon
multiline_comment|/* N.B. twice ?? */
id|ncp_add_word
c_func
(paren
id|server
comma
id|htons
c_func
(paren
l_int|0x0680
)paren
)paren
suffix:semicolon
multiline_comment|/* get all */
id|ncp_add_dword
c_func
(paren
id|server
comma
id|RIM_ALL
)paren
suffix:semicolon
id|ncp_add_handle_path
c_func
(paren
id|server
comma
id|volnum
comma
id|dirent
comma
l_int|1
comma
id|path
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|87
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|ncp_extract_file_info
c_func
(paren
id|ncp_reply_data
c_func
(paren
id|server
comma
l_int|0
)paren
comma
id|target
)paren
suffix:semicolon
id|out
suffix:colon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_NCPFS_NFS_NS
r_static
r_int
DECL|function|ncp_obtain_DOS_dir_base
id|ncp_obtain_DOS_dir_base
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
id|__u8
id|volnum
comma
id|__u32
id|dirent
comma
r_char
op_star
id|path
comma
multiline_comment|/* At most 1 component */
id|__u32
op_star
id|DOS_dir_base
)paren
(brace
r_int
id|result
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|6
)paren
suffix:semicolon
multiline_comment|/* subfunction */
id|ncp_add_byte
c_func
(paren
id|server
comma
id|server-&gt;name_space
(braket
id|volnum
)braket
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
id|server-&gt;name_space
(braket
id|volnum
)braket
)paren
suffix:semicolon
id|ncp_add_word
c_func
(paren
id|server
comma
id|htons
c_func
(paren
l_int|0x0680
)paren
)paren
suffix:semicolon
multiline_comment|/* get all */
id|ncp_add_dword
c_func
(paren
id|server
comma
id|RIM_DIRECTORY
)paren
suffix:semicolon
id|ncp_add_handle_path
c_func
(paren
id|server
comma
id|volnum
comma
id|dirent
comma
l_int|1
comma
id|path
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|87
)paren
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|DOS_dir_base
)paren
op_star
id|DOS_dir_base
op_assign
id|ncp_reply_dword
c_func
(paren
id|server
comma
l_int|0x34
)paren
suffix:semicolon
)brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_NCPFS_NFS_NS */
r_static
r_inline
r_int
DECL|function|ncp_get_known_namespace
id|ncp_get_known_namespace
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
id|__u8
id|volume
)paren
(brace
macro_line|#if defined(CONFIG_NCPFS_OS2_NS) || defined(CONFIG_NCPFS_NFS_NS)
r_int
id|result
suffix:semicolon
id|__u8
op_star
r_namespace
suffix:semicolon
id|__u16
id|no_namespaces
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|24
)paren
suffix:semicolon
multiline_comment|/* Subfunction: Get Name Spaces Loaded */
id|ncp_add_word
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
id|volume
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|87
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|NW_NS_DOS
suffix:semicolon
multiline_comment|/* not result ?? */
)brace
id|result
op_assign
id|NW_NS_DOS
suffix:semicolon
id|no_namespaces
op_assign
id|ncp_reply_word
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
r_namespace
op_assign
id|ncp_reply_data
c_func
(paren
id|server
comma
l_int|2
)paren
suffix:semicolon
r_while
c_loop
(paren
id|no_namespaces
OG
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;get_namespaces: found %d on %d&bslash;n&quot;
comma
op_star
r_namespace
comma
id|volume
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_NCPFS_NFS_NS
r_if
c_cond
(paren
(paren
op_star
r_namespace
op_eq
id|NW_NS_NFS
)paren
op_logical_and
op_logical_neg
(paren
id|server-&gt;m.flags
op_amp
id|NCP_MOUNT_NO_NFS
)paren
)paren
(brace
id|result
op_assign
id|NW_NS_NFS
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#endif&t;/* CONFIG_NCPFS_NFS_NS */
macro_line|#ifdef CONFIG_NCPFS_OS2_NS
r_if
c_cond
(paren
(paren
op_star
r_namespace
op_eq
id|NW_NS_OS2
)paren
op_logical_and
op_logical_neg
(paren
id|server-&gt;m.flags
op_amp
id|NCP_MOUNT_NO_OS2
)paren
)paren
(brace
id|result
op_assign
id|NW_NS_OS2
suffix:semicolon
)brace
macro_line|#endif&t;/* CONFIG_NCPFS_OS2_NS */
r_namespace
op_add_assign
l_int|1
suffix:semicolon
id|no_namespaces
op_sub_assign
l_int|1
suffix:semicolon
)brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
macro_line|#else&t;/* neither OS2 nor NFS - only DOS */
r_return
id|NW_NS_DOS
suffix:semicolon
macro_line|#endif&t;/* defined(CONFIG_NCPFS_OS2_NS) || defined(CONFIG_NCPFS_NFS_NS) */
)brace
r_static
r_int
DECL|function|ncp_ObtainSpecificDirBase
id|ncp_ObtainSpecificDirBase
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
id|__u8
id|nsSrc
comma
id|__u8
id|nsDst
comma
id|__u8
id|vol_num
comma
id|__u32
id|dir_base
comma
r_char
op_star
id|path
comma
multiline_comment|/* At most 1 component */
id|__u32
op_star
id|dirEntNum
comma
id|__u32
op_star
id|DosDirNum
)paren
(brace
r_int
id|result
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|6
)paren
suffix:semicolon
multiline_comment|/* subfunction */
id|ncp_add_byte
c_func
(paren
id|server
comma
id|nsSrc
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
id|nsDst
)paren
suffix:semicolon
id|ncp_add_word
c_func
(paren
id|server
comma
id|htons
c_func
(paren
l_int|0x0680
)paren
)paren
suffix:semicolon
multiline_comment|/* get all */
id|ncp_add_dword
c_func
(paren
id|server
comma
id|RIM_ALL
)paren
suffix:semicolon
id|ncp_add_handle_path
c_func
(paren
id|server
comma
id|vol_num
comma
id|dir_base
comma
l_int|1
comma
id|path
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|87
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dirEntNum
)paren
op_star
id|dirEntNum
op_assign
id|ncp_reply_dword
c_func
(paren
id|server
comma
l_int|0x30
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DosDirNum
)paren
op_star
id|DosDirNum
op_assign
id|ncp_reply_dword
c_func
(paren
id|server
comma
l_int|0x34
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|ncp_mount_subdir
id|ncp_mount_subdir
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_struct
id|nw_info_struct
op_star
id|i
comma
id|__u8
id|volNumber
comma
id|__u8
id|srcNS
comma
id|__u32
id|dirEntNum
)paren
(brace
r_int
id|dstNS
suffix:semicolon
r_int
id|result
suffix:semicolon
id|__u32
id|newDirEnt
suffix:semicolon
id|__u32
id|newDosEnt
suffix:semicolon
id|dstNS
op_assign
id|ncp_get_known_namespace
c_func
(paren
id|server
comma
id|volNumber
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_ObtainSpecificDirBase
c_func
(paren
id|server
comma
id|srcNS
comma
id|dstNS
comma
id|volNumber
comma
id|dirEntNum
comma
l_int|NULL
comma
op_amp
id|newDirEnt
comma
op_amp
id|newDosEnt
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_return
id|result
suffix:semicolon
)brace
id|server-&gt;name_space
(braket
id|volNumber
)braket
op_assign
id|dstNS
suffix:semicolon
id|i-&gt;volNumber
op_assign
id|volNumber
suffix:semicolon
id|i-&gt;dirEntNum
op_assign
id|newDirEnt
suffix:semicolon
id|i-&gt;DosDirNum
op_assign
id|newDosEnt
suffix:semicolon
id|server-&gt;m.mounted_vol
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|server-&gt;m.mounted_vol
(braket
l_int|0
)braket
op_assign
l_char|&squot;X&squot;
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|ncp_lookup_volume
id|ncp_lookup_volume
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_char
op_star
id|volname
comma
r_struct
id|nw_info_struct
op_star
id|target
)paren
(brace
r_int
id|result
suffix:semicolon
r_int
id|volnum
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ncp_lookup_volume: looking up vol %s&bslash;n&quot;
comma
id|volname
)paren
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|22
)paren
suffix:semicolon
multiline_comment|/* Subfunction: Generate dir handle */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* DOS namespace */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* reserved */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* reserved */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* reserved */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* faked volume number */
id|ncp_add_dword
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* faked dir_base */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t have a dir_base */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* 1 path component */
id|ncp_add_pstring
c_func
(paren
id|server
comma
id|volname
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|87
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|memset
c_func
(paren
id|target
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|target
)paren
)paren
suffix:semicolon
id|target-&gt;DosDirNum
op_assign
id|target-&gt;dirEntNum
op_assign
id|ncp_reply_dword
c_func
(paren
id|server
comma
l_int|4
)paren
suffix:semicolon
id|target-&gt;volNumber
op_assign
id|volnum
op_assign
id|ncp_reply_byte
c_func
(paren
id|server
comma
l_int|8
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|server-&gt;name_space
(braket
id|volnum
)braket
op_assign
id|ncp_get_known_namespace
c_func
(paren
id|server
comma
id|volnum
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;lookup_vol: namespace[%d] = %d&bslash;n&quot;
comma
id|volnum
comma
id|server-&gt;name_space
(braket
id|volnum
)braket
)paren
suffix:semicolon
id|target-&gt;nameLen
op_assign
id|strlen
c_func
(paren
id|volname
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|target-&gt;entryName
comma
id|volname
comma
id|target-&gt;nameLen
op_plus
l_int|1
)paren
suffix:semicolon
id|target-&gt;attributes
op_assign
id|aDIR
suffix:semicolon
multiline_comment|/* set dates to Jan 1, 1986  00:00 */
id|target-&gt;creationTime
op_assign
id|target-&gt;modifyTime
op_assign
id|cpu_to_le16
c_func
(paren
l_int|0x0000
)paren
suffix:semicolon
id|target-&gt;creationDate
op_assign
id|target-&gt;modifyDate
op_assign
id|target-&gt;lastAccessDate
op_assign
id|cpu_to_le16
c_func
(paren
l_int|0x0C21
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ncp_modify_file_or_subdir_dos_info_path
r_int
id|ncp_modify_file_or_subdir_dos_info_path
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_struct
id|inode
op_star
id|dir
comma
r_const
r_char
op_star
id|path
comma
id|__u32
id|info_mask
comma
r_const
r_struct
id|nw_modify_dos_info
op_star
id|info
)paren
(brace
id|__u8
id|volnum
op_assign
id|NCP_FINFO
c_func
(paren
id|dir
)paren
op_member_access_from_pointer
id|volNumber
suffix:semicolon
id|__u32
id|dirent
op_assign
id|NCP_FINFO
c_func
(paren
id|dir
)paren
op_member_access_from_pointer
id|dirEntNum
suffix:semicolon
r_int
id|result
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|7
)paren
suffix:semicolon
multiline_comment|/* subfunction */
id|ncp_add_byte
c_func
(paren
id|server
comma
id|server-&gt;name_space
(braket
id|volnum
)braket
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* reserved */
id|ncp_add_word
c_func
(paren
id|server
comma
id|htons
c_func
(paren
l_int|0x0680
)paren
)paren
suffix:semicolon
multiline_comment|/* search attribs: all */
id|ncp_add_dword
c_func
(paren
id|server
comma
id|info_mask
)paren
suffix:semicolon
id|ncp_add_mem
c_func
(paren
id|server
comma
id|info
comma
r_sizeof
(paren
op_star
id|info
)paren
)paren
suffix:semicolon
id|ncp_add_handle_path
c_func
(paren
id|server
comma
id|volnum
comma
id|dirent
comma
l_int|1
comma
id|path
)paren
suffix:semicolon
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|87
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|ncp_modify_file_or_subdir_dos_info
r_int
id|ncp_modify_file_or_subdir_dos_info
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_struct
id|inode
op_star
id|dir
comma
id|__u32
id|info_mask
comma
r_const
r_struct
id|nw_modify_dos_info
op_star
id|info
)paren
(brace
r_return
id|ncp_modify_file_or_subdir_dos_info_path
c_func
(paren
id|server
comma
id|dir
comma
l_int|NULL
comma
id|info_mask
comma
id|info
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ncp_DeleteNSEntry
id|ncp_DeleteNSEntry
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
id|__u8
id|have_dir_base
comma
id|__u8
id|volnum
comma
id|__u32
id|dirent
comma
r_char
op_star
id|name
comma
id|__u8
id|ns
comma
r_int
id|attr
)paren
(brace
r_int
id|result
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|8
)paren
suffix:semicolon
multiline_comment|/* subfunction */
id|ncp_add_byte
c_func
(paren
id|server
comma
id|ns
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* reserved */
id|ncp_add_word
c_func
(paren
id|server
comma
id|attr
)paren
suffix:semicolon
multiline_comment|/* search attribs: all */
id|ncp_add_handle_path
c_func
(paren
id|server
comma
id|volnum
comma
id|dirent
comma
id|have_dir_base
comma
id|name
)paren
suffix:semicolon
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|87
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|ncp_del_file_or_subdir2
id|ncp_del_file_or_subdir2
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|dentry-&gt;d_inode
suffix:semicolon
id|__u8
id|volnum
suffix:semicolon
id|__u32
id|dirent
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
(brace
macro_line|#if CONFIG_NCPFS_DEBUGDENTRY
id|PRINTK
c_func
(paren
l_string|&quot;ncpfs: ncpdel2: dentry-&gt;d_inode == NULL&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0xFF
suffix:semicolon
multiline_comment|/* Any error */
)brace
id|volnum
op_assign
id|NCP_FINFO
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|volNumber
suffix:semicolon
id|dirent
op_assign
id|NCP_FINFO
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|DosDirNum
suffix:semicolon
r_return
id|ncp_DeleteNSEntry
c_func
(paren
id|server
comma
l_int|1
comma
id|volnum
comma
id|dirent
comma
l_int|NULL
comma
id|NW_NS_DOS
comma
id|htons
c_func
(paren
l_int|0x0680
)paren
)paren
suffix:semicolon
)brace
r_int
DECL|function|ncp_del_file_or_subdir
id|ncp_del_file_or_subdir
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_struct
id|inode
op_star
id|dir
comma
r_char
op_star
id|name
)paren
(brace
id|__u8
id|volnum
op_assign
id|NCP_FINFO
c_func
(paren
id|dir
)paren
op_member_access_from_pointer
id|volNumber
suffix:semicolon
id|__u32
id|dirent
op_assign
id|NCP_FINFO
c_func
(paren
id|dir
)paren
op_member_access_from_pointer
id|dirEntNum
suffix:semicolon
macro_line|#ifdef CONFIG_NCPFS_NFS_NS
r_if
c_cond
(paren
id|server-&gt;name_space
(braket
id|volnum
)braket
op_eq
id|NW_NS_NFS
)paren
(brace
r_int
id|result
suffix:semicolon
id|result
op_assign
id|ncp_obtain_DOS_dir_base
c_func
(paren
id|server
comma
id|volnum
comma
id|dirent
comma
id|name
comma
op_amp
id|dirent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
r_return
id|ncp_DeleteNSEntry
c_func
(paren
id|server
comma
l_int|1
comma
id|volnum
comma
id|dirent
comma
l_int|NULL
comma
id|NW_NS_DOS
comma
id|htons
c_func
(paren
l_int|0x0680
)paren
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif&t;/* CONFIG_NCPFS_NFS_NS */
r_return
id|ncp_DeleteNSEntry
c_func
(paren
id|server
comma
l_int|1
comma
id|volnum
comma
id|dirent
comma
id|name
comma
id|server-&gt;name_space
(braket
id|volnum
)braket
comma
id|htons
c_func
(paren
l_int|0x0680
)paren
)paren
suffix:semicolon
)brace
DECL|function|ConvertToNWfromDWORD
r_static
r_inline
r_void
id|ConvertToNWfromDWORD
c_func
(paren
id|__u32
id|sfd
comma
id|__u8
id|ret
(braket
l_int|6
)braket
)paren
(brace
id|__u16
op_star
id|dest
op_assign
(paren
id|__u16
op_star
)paren
id|ret
suffix:semicolon
id|memcpy
c_func
(paren
id|ret
op_plus
l_int|2
comma
op_amp
id|sfd
comma
l_int|4
)paren
suffix:semicolon
id|dest
(braket
l_int|0
)braket
op_assign
id|cpu_to_le16
c_func
(paren
(paren
id|le16_to_cpu
c_func
(paren
id|dest
(braket
l_int|1
)braket
)paren
op_plus
id|le16_to_cpu
c_func
(paren
l_int|1
)paren
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* If both dir and name are NULL, then in target there&squot;s already a&n;   looked-up entry that wants to be opened. */
DECL|function|ncp_open_create_file_or_subdir
r_int
id|ncp_open_create_file_or_subdir
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_struct
id|inode
op_star
id|dir
comma
r_char
op_star
id|name
comma
r_int
id|open_create_mode
comma
id|__u32
id|create_attributes
comma
r_int
id|desired_acc_rights
comma
r_struct
id|ncp_entry_info
op_star
id|target
)paren
(brace
id|__u16
id|search_attribs
op_assign
id|ntohs
c_func
(paren
l_int|0x0600
)paren
suffix:semicolon
id|__u8
id|volnum
op_assign
id|target-&gt;i.volNumber
suffix:semicolon
id|__u32
id|dirent
op_assign
id|target-&gt;i.dirEntNum
suffix:semicolon
r_int
id|result
suffix:semicolon
r_if
c_cond
(paren
id|dir
)paren
(brace
id|volnum
op_assign
id|NCP_FINFO
c_func
(paren
id|dir
)paren
op_member_access_from_pointer
id|volNumber
suffix:semicolon
id|dirent
op_assign
id|NCP_FINFO
c_func
(paren
id|dir
)paren
op_member_access_from_pointer
id|dirEntNum
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|create_attributes
op_amp
id|aDIR
)paren
op_ne
l_int|0
)paren
(brace
id|search_attribs
op_or_assign
id|ntohs
c_func
(paren
l_int|0x0080
)paren
suffix:semicolon
)brace
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* subfunction */
id|ncp_add_byte
c_func
(paren
id|server
comma
id|server-&gt;name_space
(braket
id|volnum
)braket
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
id|open_create_mode
)paren
suffix:semicolon
id|ncp_add_word
c_func
(paren
id|server
comma
id|search_attribs
)paren
suffix:semicolon
id|ncp_add_dword
c_func
(paren
id|server
comma
id|RIM_ALL
)paren
suffix:semicolon
id|ncp_add_dword
c_func
(paren
id|server
comma
id|create_attributes
)paren
suffix:semicolon
multiline_comment|/* The desired acc rights seem to be the inherited rights mask&n;&t;   for directories */
id|ncp_add_word
c_func
(paren
id|server
comma
id|desired_acc_rights
)paren
suffix:semicolon
id|ncp_add_handle_path
c_func
(paren
id|server
comma
id|volnum
comma
id|dirent
comma
l_int|1
comma
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|87
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|create_attributes
op_amp
id|aDIR
)paren
)paren
id|target-&gt;opened
op_assign
l_int|1
suffix:semicolon
id|target-&gt;server_file_handle
op_assign
id|ncp_reply_dword
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
id|target-&gt;open_create_action
op_assign
id|ncp_reply_byte
c_func
(paren
id|server
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* in target there&squot;s a new finfo to fill */
id|ncp_extract_file_info
c_func
(paren
id|ncp_reply_data
c_func
(paren
id|server
comma
l_int|6
)paren
comma
op_amp
(paren
id|target-&gt;i
)paren
)paren
suffix:semicolon
id|ConvertToNWfromDWORD
c_func
(paren
id|target-&gt;server_file_handle
comma
id|target-&gt;file_handle
)paren
suffix:semicolon
id|out
suffix:colon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|ncp_initialize_search
id|ncp_initialize_search
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|nw_search_sequence
op_star
id|target
)paren
(brace
id|__u8
id|volnum
op_assign
id|NCP_FINFO
c_func
(paren
id|dir
)paren
op_member_access_from_pointer
id|volNumber
suffix:semicolon
id|__u32
id|dirent
op_assign
id|NCP_FINFO
c_func
(paren
id|dir
)paren
op_member_access_from_pointer
id|dirEntNum
suffix:semicolon
r_int
id|result
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* subfunction */
id|ncp_add_byte
c_func
(paren
id|server
comma
id|server-&gt;name_space
(braket
id|volnum
)braket
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* reserved */
id|ncp_add_handle_path
c_func
(paren
id|server
comma
id|volnum
comma
id|dirent
comma
l_int|1
comma
l_int|NULL
)paren
suffix:semicolon
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|87
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_goto
id|out
suffix:semicolon
id|memcpy
c_func
(paren
id|target
comma
id|ncp_reply_data
c_func
(paren
id|server
comma
l_int|0
)paren
comma
r_sizeof
(paren
op_star
id|target
)paren
)paren
suffix:semicolon
id|out
suffix:colon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* Search for everything */
DECL|function|ncp_search_for_file_or_subdir
r_int
id|ncp_search_for_file_or_subdir
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_struct
id|nw_search_sequence
op_star
id|seq
comma
r_struct
id|nw_info_struct
op_star
id|target
)paren
(brace
r_int
id|result
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|3
)paren
suffix:semicolon
multiline_comment|/* subfunction */
id|ncp_add_byte
c_func
(paren
id|server
comma
id|server-&gt;name_space
(braket
id|seq-&gt;volNumber
)braket
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* data stream (???) */
id|ncp_add_word
c_func
(paren
id|server
comma
id|htons
c_func
(paren
l_int|0x0680
)paren
)paren
suffix:semicolon
multiline_comment|/* Search attribs */
id|ncp_add_dword
c_func
(paren
id|server
comma
id|RIM_ALL
)paren
suffix:semicolon
multiline_comment|/* return info mask */
id|ncp_add_mem
c_func
(paren
id|server
comma
id|seq
comma
l_int|9
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_NCPFS_NFS_NS
r_if
c_cond
(paren
id|server-&gt;name_space
(braket
id|seq-&gt;volNumber
)braket
op_eq
id|NW_NS_NFS
)paren
(brace
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* 0 byte pattern */
)brace
r_else
macro_line|#endif
(brace
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 2 byte pattern */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* following is a wildcard */
id|ncp_add_byte
c_func
(paren
id|server
comma
l_char|&squot;*&squot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|87
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|memcpy
c_func
(paren
id|seq
comma
id|ncp_reply_data
c_func
(paren
id|server
comma
l_int|0
)paren
comma
r_sizeof
(paren
op_star
id|seq
)paren
)paren
suffix:semicolon
id|ncp_extract_file_info
c_func
(paren
id|ncp_reply_data
c_func
(paren
id|server
comma
l_int|10
)paren
comma
id|target
)paren
suffix:semicolon
id|out
suffix:colon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|ncp_RenameNSEntry
id|ncp_RenameNSEntry
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_struct
id|inode
op_star
id|old_dir
comma
r_char
op_star
id|old_name
comma
r_int
id|old_type
comma
r_struct
id|inode
op_star
id|new_dir
comma
r_char
op_star
id|new_name
)paren
(brace
r_int
id|result
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|old_dir
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|old_name
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|new_dir
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|new_name
op_eq
l_int|NULL
)paren
)paren
r_goto
id|out
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* subfunction */
id|ncp_add_byte
c_func
(paren
id|server
comma
id|server-&gt;name_space
(braket
id|NCP_FINFO
c_func
(paren
id|old_dir
)paren
op_member_access_from_pointer
id|volNumber
)braket
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* rename flag */
id|ncp_add_word
c_func
(paren
id|server
comma
id|old_type
)paren
suffix:semicolon
multiline_comment|/* search attributes */
multiline_comment|/* source Handle Path */
id|ncp_add_byte
c_func
(paren
id|server
comma
id|NCP_FINFO
c_func
(paren
id|old_dir
)paren
op_member_access_from_pointer
id|volNumber
)paren
suffix:semicolon
id|ncp_add_dword
c_func
(paren
id|server
comma
id|NCP_FINFO
c_func
(paren
id|old_dir
)paren
op_member_access_from_pointer
id|dirEntNum
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|1
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* 1 source component */
multiline_comment|/* dest Handle Path */
id|ncp_add_byte
c_func
(paren
id|server
comma
id|NCP_FINFO
c_func
(paren
id|new_dir
)paren
op_member_access_from_pointer
id|volNumber
)paren
suffix:semicolon
id|ncp_add_dword
c_func
(paren
id|server
comma
id|NCP_FINFO
c_func
(paren
id|new_dir
)paren
op_member_access_from_pointer
id|dirEntNum
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|1
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* 1 destination component */
multiline_comment|/* source path string */
id|ncp_add_pstring
c_func
(paren
id|server
comma
id|old_name
)paren
suffix:semicolon
multiline_comment|/* dest path string */
id|ncp_add_pstring
c_func
(paren
id|server
comma
id|new_name
)paren
suffix:semicolon
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|87
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
DECL|function|ncp_ren_or_mov_file_or_subdir
r_int
id|ncp_ren_or_mov_file_or_subdir
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_struct
id|inode
op_star
id|old_dir
comma
r_char
op_star
id|old_name
comma
r_struct
id|inode
op_star
id|new_dir
comma
r_char
op_star
id|new_name
)paren
(brace
r_int
id|result
suffix:semicolon
r_int
id|old_type
op_assign
id|htons
c_func
(paren
l_int|0x0600
)paren
suffix:semicolon
multiline_comment|/* If somebody can do it atomic, call me... vandrove@vc.cvut.cz */
id|result
op_assign
id|ncp_RenameNSEntry
c_func
(paren
id|server
comma
id|old_dir
comma
id|old_name
comma
id|old_type
comma
id|new_dir
comma
id|new_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
l_int|0xFF
)paren
multiline_comment|/* File Not Found, try directory */
(brace
id|old_type
op_assign
id|htons
c_func
(paren
l_int|0x1600
)paren
suffix:semicolon
id|result
op_assign
id|ncp_RenameNSEntry
c_func
(paren
id|server
comma
id|old_dir
comma
id|old_name
comma
id|old_type
comma
id|new_dir
comma
id|new_name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|result
op_ne
l_int|0x92
)paren
r_return
id|result
suffix:semicolon
multiline_comment|/* All except NO_FILES_RENAMED */
id|result
op_assign
id|ncp_del_file_or_subdir
c_func
(paren
id|server
comma
id|new_dir
comma
id|new_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
l_int|0
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|result
op_assign
id|ncp_RenameNSEntry
c_func
(paren
id|server
comma
id|old_dir
comma
id|old_name
comma
id|old_type
comma
id|new_dir
comma
id|new_name
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* We have to transfer to/from user space */
r_int
DECL|function|ncp_read_kernel
id|ncp_read_kernel
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_const
r_char
op_star
id|file_id
comma
id|__u32
id|offset
comma
id|__u16
id|to_read
comma
r_char
op_star
id|target
comma
r_int
op_star
id|bytes_read
)paren
(brace
r_char
op_star
id|source
suffix:semicolon
r_int
id|result
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
id|ncp_add_mem
c_func
(paren
id|server
comma
id|file_id
comma
l_int|6
)paren
suffix:semicolon
id|ncp_add_dword
c_func
(paren
id|server
comma
id|htonl
c_func
(paren
id|offset
)paren
)paren
suffix:semicolon
id|ncp_add_word
c_func
(paren
id|server
comma
id|htons
c_func
(paren
id|to_read
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|72
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
op_star
id|bytes_read
op_assign
id|ntohs
c_func
(paren
id|ncp_reply_word
c_func
(paren
id|server
comma
l_int|0
)paren
)paren
suffix:semicolon
id|source
op_assign
id|ncp_reply_data
c_func
(paren
id|server
comma
l_int|2
op_plus
(paren
id|offset
op_amp
l_int|1
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|target
comma
id|source
comma
op_star
id|bytes_read
)paren
suffix:semicolon
id|out
suffix:colon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* There is a problem... egrep and some other silly tools do:&n;&t;x = mmap(NULL, MAP_PRIVATE, PROT_READ|PROT_WRITE, &lt;ncpfs fd&gt;, 32768);&n;&t;read(&lt;ncpfs fd&gt;, x, 32768);&n;   Now copying read result by copy_to_user causes pagefault. This pagefault&n;   could not be handled because of server was locked due to read. So we have&n;   to use temporary buffer. So ncp_unlock_server must be done before&n;   copy_to_user (and for write, copy_from_user must be done before &n;   ncp_init_request... same applies for send raw packet ioctl). Because of&n;   file is normally read in bigger chunks, caller provides kmalloced &n;   (vmalloced) chunk of memory with size &gt;= to_read...&n; */
r_int
DECL|function|ncp_read_bounce
id|ncp_read_bounce
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_const
r_char
op_star
id|file_id
comma
id|__u32
id|offset
comma
id|__u16
id|to_read
comma
r_char
op_star
id|target
comma
r_int
op_star
id|bytes_read
comma
r_void
op_star
id|bounce
comma
id|__u32
id|bufsize
)paren
(brace
r_int
id|result
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
id|ncp_add_mem
c_func
(paren
id|server
comma
id|file_id
comma
l_int|6
)paren
suffix:semicolon
id|ncp_add_dword
c_func
(paren
id|server
comma
id|htonl
c_func
(paren
id|offset
)paren
)paren
suffix:semicolon
id|ncp_add_word
c_func
(paren
id|server
comma
id|htons
c_func
(paren
id|to_read
)paren
)paren
suffix:semicolon
id|result
op_assign
id|ncp_request2
c_func
(paren
id|server
comma
l_int|72
comma
id|bounce
comma
id|bufsize
)paren
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|result
)paren
(brace
r_int
id|len
op_assign
id|be16_to_cpu
c_func
(paren
id|get_unaligned
c_func
(paren
(paren
id|__u16
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|bounce
op_plus
r_sizeof
(paren
r_struct
id|ncp_reply_header
)paren
)paren
)paren
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
id|to_read
)paren
(brace
r_char
op_star
id|source
suffix:semicolon
id|source
op_assign
(paren
r_char
op_star
)paren
id|bounce
op_plus
r_sizeof
(paren
r_struct
id|ncp_reply_header
)paren
op_plus
l_int|2
op_plus
(paren
id|offset
op_amp
l_int|1
)paren
suffix:semicolon
op_star
id|bytes_read
op_assign
id|len
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|target
comma
id|source
comma
id|len
)paren
)paren
id|result
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
)brace
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|ncp_write_kernel
id|ncp_write_kernel
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_const
r_char
op_star
id|file_id
comma
id|__u32
id|offset
comma
id|__u16
id|to_write
comma
r_const
r_char
op_star
id|source
comma
r_int
op_star
id|bytes_written
)paren
(brace
r_int
id|result
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
id|ncp_add_mem
c_func
(paren
id|server
comma
id|file_id
comma
l_int|6
)paren
suffix:semicolon
id|ncp_add_dword
c_func
(paren
id|server
comma
id|htonl
c_func
(paren
id|offset
)paren
)paren
suffix:semicolon
id|ncp_add_word
c_func
(paren
id|server
comma
id|htons
c_func
(paren
id|to_write
)paren
)paren
suffix:semicolon
id|ncp_add_mem
c_func
(paren
id|server
comma
id|source
comma
id|to_write
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|73
)paren
)paren
op_eq
l_int|0
)paren
op_star
id|bytes_written
op_assign
id|to_write
suffix:semicolon
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_NCPFS_IOCTL_LOCKING
r_int
DECL|function|ncp_LogPhysicalRecord
id|ncp_LogPhysicalRecord
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_const
r_char
op_star
id|file_id
comma
id|__u8
id|locktype
comma
id|__u32
id|offset
comma
id|__u32
id|length
comma
id|__u16
id|timeout
)paren
(brace
r_int
id|result
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
id|locktype
)paren
suffix:semicolon
id|ncp_add_mem
c_func
(paren
id|server
comma
id|file_id
comma
l_int|6
)paren
suffix:semicolon
id|ncp_add_dword
c_func
(paren
id|server
comma
id|htonl
c_func
(paren
id|offset
)paren
)paren
suffix:semicolon
id|ncp_add_dword
c_func
(paren
id|server
comma
id|htonl
c_func
(paren
id|length
)paren
)paren
suffix:semicolon
id|ncp_add_word
c_func
(paren
id|server
comma
id|htons
c_func
(paren
id|timeout
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|0x1A
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|ncp_ClearPhysicalRecord
id|ncp_ClearPhysicalRecord
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_const
r_char
op_star
id|file_id
comma
id|__u32
id|offset
comma
id|__u32
id|length
)paren
(brace
r_int
id|result
suffix:semicolon
id|ncp_init_request
c_func
(paren
id|server
)paren
suffix:semicolon
id|ncp_add_byte
c_func
(paren
id|server
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* who knows... lanalyzer says that */
id|ncp_add_mem
c_func
(paren
id|server
comma
id|file_id
comma
l_int|6
)paren
suffix:semicolon
id|ncp_add_dword
c_func
(paren
id|server
comma
id|htonl
c_func
(paren
id|offset
)paren
)paren
suffix:semicolon
id|ncp_add_dword
c_func
(paren
id|server
comma
id|htonl
c_func
(paren
id|length
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_request
c_func
(paren
id|server
comma
l_int|0x1E
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|ncp_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif&t;/* CONFIG_NCPFS_IOCTL_LOCKING */
macro_line|#ifdef CONFIG_NCPFS_NLS
multiline_comment|/* This are the NLS conversion routines with inspirations and code parts&n; * from the vfat file system and hints from Petr Vandrovec.&n; */
r_inline
r_int
r_char
DECL|function|ncp__tolower
id|ncp__tolower
c_func
(paren
r_struct
id|nls_table
op_star
id|t
comma
r_int
r_char
id|c
)paren
(brace
r_int
r_char
id|nc
op_assign
id|t-&gt;charset2lower
(braket
id|c
)braket
suffix:semicolon
r_return
id|nc
ques
c_cond
id|nc
suffix:colon
id|c
suffix:semicolon
)brace
r_inline
r_int
r_char
DECL|function|ncp__toupper
id|ncp__toupper
c_func
(paren
r_struct
id|nls_table
op_star
id|t
comma
r_int
r_char
id|c
)paren
(brace
r_int
r_char
id|nc
op_assign
id|t-&gt;charset2upper
(braket
id|c
)braket
suffix:semicolon
r_return
id|nc
ques
c_cond
id|nc
suffix:colon
id|c
suffix:semicolon
)brace
r_int
DECL|function|ncp__io2vol
id|ncp__io2vol
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_int
r_char
op_star
id|vname
comma
r_int
r_int
op_star
id|vlen
comma
r_const
r_int
r_char
op_star
id|iname
comma
r_int
r_int
id|ilen
comma
r_int
id|cc
)paren
(brace
r_struct
id|nls_table
op_star
id|in
op_assign
id|server-&gt;nls_io
suffix:semicolon
r_struct
id|nls_table
op_star
id|out
op_assign
id|server-&gt;nls_vol
suffix:semicolon
r_int
r_char
op_star
id|vname_start
suffix:semicolon
r_int
r_char
op_star
id|vname_end
suffix:semicolon
r_const
r_int
r_char
op_star
id|iname_end
suffix:semicolon
id|iname_end
op_assign
id|iname
op_plus
id|ilen
suffix:semicolon
id|vname_start
op_assign
id|vname
suffix:semicolon
id|vname_end
op_assign
id|vname
op_plus
op_star
id|vlen
op_minus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|iname
OL
id|iname_end
)paren
(brace
r_int
id|chl
suffix:semicolon
m_wchar_t
id|ec
suffix:semicolon
r_if
c_cond
(paren
id|NCP_IS_FLAG
c_func
(paren
id|server
comma
id|NCP_FLAG_UTF8
)paren
)paren
(brace
r_int
id|k
suffix:semicolon
id|k
op_assign
id|utf8_mbtowc
c_func
(paren
op_amp
id|ec
comma
id|iname
comma
id|iname_end
op_minus
id|iname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|k
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|iname
op_add_assign
id|k
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_star
id|iname
op_eq
id|NCP_ESC
)paren
(brace
r_int
id|k
suffix:semicolon
r_if
c_cond
(paren
id|iname_end
op_minus
id|iname
OL
l_int|5
)paren
r_goto
id|nospec
suffix:semicolon
id|ec
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|1
suffix:semicolon
id|k
OL
l_int|5
suffix:semicolon
id|k
op_increment
)paren
(brace
r_int
r_char
id|nc
suffix:semicolon
id|nc
op_assign
id|iname
(braket
id|k
)braket
op_minus
l_char|&squot;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|nc
op_ge
l_int|10
)paren
(brace
id|nc
op_sub_assign
l_char|&squot;A&squot;
op_minus
l_char|&squot;0&squot;
op_minus
l_int|10
suffix:semicolon
r_if
c_cond
(paren
(paren
id|nc
OL
l_int|10
)paren
op_logical_or
(paren
id|nc
OG
l_int|15
)paren
)paren
(brace
r_goto
id|nospec
suffix:semicolon
)brace
)brace
id|ec
op_assign
(paren
id|ec
op_lshift
l_int|4
)paren
op_or
id|nc
suffix:semicolon
)brace
id|iname
op_add_assign
l_int|5
suffix:semicolon
)brace
r_else
(brace
id|nospec
suffix:colon
suffix:semicolon
r_if
c_cond
(paren
(paren
id|chl
op_assign
id|in
op_member_access_from_pointer
id|char2uni
c_func
(paren
id|iname
comma
id|iname_end
op_minus
id|iname
comma
op_amp
id|ec
)paren
)paren
OL
l_int|0
)paren
r_return
id|chl
suffix:semicolon
id|iname
op_add_assign
id|chl
suffix:semicolon
)brace
)brace
multiline_comment|/* unitoupper should be here! */
id|chl
op_assign
id|out
op_member_access_from_pointer
id|uni2char
c_func
(paren
id|ec
comma
id|vname
comma
id|vname_end
op_minus
id|vname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chl
OL
l_int|0
)paren
r_return
id|chl
suffix:semicolon
multiline_comment|/* this is wrong... */
r_if
c_cond
(paren
id|cc
)paren
(brace
r_int
id|chi
suffix:semicolon
r_for
c_loop
(paren
id|chi
op_assign
l_int|0
suffix:semicolon
id|chi
OL
id|chl
suffix:semicolon
id|chi
op_increment
)paren
(brace
id|vname
(braket
id|chi
)braket
op_assign
id|ncp_toupper
c_func
(paren
id|out
comma
id|vname
(braket
id|chi
)braket
)paren
suffix:semicolon
)brace
)brace
id|vname
op_add_assign
id|chl
suffix:semicolon
)brace
op_star
id|vname
op_assign
l_int|0
suffix:semicolon
op_star
id|vlen
op_assign
id|vname
op_minus
id|vname_start
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|ncp__vol2io
id|ncp__vol2io
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_int
r_char
op_star
id|iname
comma
r_int
r_int
op_star
id|ilen
comma
r_const
r_int
r_char
op_star
id|vname
comma
r_int
r_int
id|vlen
comma
r_int
id|cc
)paren
(brace
r_struct
id|nls_table
op_star
id|in
op_assign
id|server-&gt;nls_vol
suffix:semicolon
r_struct
id|nls_table
op_star
id|out
op_assign
id|server-&gt;nls_io
suffix:semicolon
r_const
r_int
r_char
op_star
id|vname_end
suffix:semicolon
r_int
r_char
op_star
id|iname_start
suffix:semicolon
r_int
r_char
op_star
id|iname_end
suffix:semicolon
r_int
r_char
op_star
id|vname_cc
suffix:semicolon
r_int
id|err
suffix:semicolon
id|vname_cc
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|cc
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* this is wrong! */
id|vname_cc
op_assign
id|kmalloc
c_func
(paren
id|vlen
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vname_cc
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|vlen
suffix:semicolon
id|i
op_increment
)paren
id|vname_cc
(braket
id|i
)braket
op_assign
id|ncp_tolower
c_func
(paren
id|in
comma
id|vname
(braket
id|i
)braket
)paren
suffix:semicolon
id|vname
op_assign
id|vname_cc
suffix:semicolon
)brace
id|iname_start
op_assign
id|iname
suffix:semicolon
id|iname_end
op_assign
id|iname
op_plus
op_star
id|ilen
op_minus
l_int|1
suffix:semicolon
id|vname_end
op_assign
id|vname
op_plus
id|vlen
suffix:semicolon
r_while
c_loop
(paren
id|vname
OL
id|vname_end
)paren
(brace
m_wchar_t
id|ec
suffix:semicolon
r_int
id|chl
suffix:semicolon
r_if
c_cond
(paren
(paren
id|chl
op_assign
id|in
op_member_access_from_pointer
id|char2uni
c_func
(paren
id|vname
comma
id|vname_end
op_minus
id|vname
comma
op_amp
id|ec
)paren
)paren
OL
l_int|0
)paren
(brace
id|err
op_assign
id|chl
suffix:semicolon
r_goto
id|quit
suffix:semicolon
)brace
id|vname
op_add_assign
id|chl
suffix:semicolon
multiline_comment|/* unitolower should be here! */
r_if
c_cond
(paren
id|NCP_IS_FLAG
c_func
(paren
id|server
comma
id|NCP_FLAG_UTF8
)paren
)paren
(brace
r_int
id|k
suffix:semicolon
id|k
op_assign
id|utf8_wctomb
c_func
(paren
id|iname
comma
id|ec
comma
id|iname_end
op_minus
id|iname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|k
OL
l_int|0
)paren
(brace
id|err
op_assign
op_minus
id|ENAMETOOLONG
suffix:semicolon
r_goto
id|quit
suffix:semicolon
)brace
id|iname
op_add_assign
id|k
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|chl
op_assign
id|out
op_member_access_from_pointer
id|uni2char
c_func
(paren
id|ec
comma
id|iname
comma
id|iname_end
op_minus
id|iname
)paren
)paren
op_ge
l_int|0
)paren
(brace
id|iname
op_add_assign
id|chl
suffix:semicolon
)brace
r_else
(brace
r_int
id|k
suffix:semicolon
r_if
c_cond
(paren
id|iname_end
op_minus
id|iname
OL
l_int|5
)paren
(brace
id|err
op_assign
op_minus
id|ENAMETOOLONG
suffix:semicolon
r_goto
id|quit
suffix:semicolon
)brace
op_star
id|iname
op_assign
id|NCP_ESC
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|4
suffix:semicolon
id|k
OG
l_int|0
suffix:semicolon
id|k
op_decrement
)paren
(brace
r_int
r_char
id|v
suffix:semicolon
id|v
op_assign
(paren
id|ec
op_amp
l_int|0xF
)paren
op_plus
l_char|&squot;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|v
OG
l_char|&squot;9&squot;
)paren
(brace
id|v
op_add_assign
l_char|&squot;A&squot;
op_minus
l_char|&squot;9&squot;
op_minus
l_int|1
suffix:semicolon
)brace
id|iname
(braket
id|k
)braket
op_assign
id|v
suffix:semicolon
id|ec
op_rshift_assign
l_int|4
suffix:semicolon
)brace
id|iname
op_add_assign
l_int|5
suffix:semicolon
)brace
)brace
)brace
op_star
id|iname
op_assign
l_int|0
suffix:semicolon
op_star
id|ilen
op_assign
id|iname
op_minus
id|iname_start
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
id|quit
suffix:colon
suffix:semicolon
r_if
c_cond
(paren
id|cc
)paren
id|kfree
c_func
(paren
id|vname_cc
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
macro_line|#else
r_int
DECL|function|ncp__io2vol
id|ncp__io2vol
c_func
(paren
r_int
r_char
op_star
id|vname
comma
r_int
r_int
op_star
id|vlen
comma
r_const
r_int
r_char
op_star
id|iname
comma
r_int
r_int
id|ilen
comma
r_int
id|cc
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_star
id|vlen
op_le
id|ilen
)paren
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
r_if
c_cond
(paren
id|cc
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ilen
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|vname
op_assign
id|toupper
c_func
(paren
op_star
id|iname
)paren
suffix:semicolon
id|vname
op_increment
suffix:semicolon
id|iname
op_increment
suffix:semicolon
)brace
r_else
(brace
id|memmove
c_func
(paren
id|vname
comma
id|iname
comma
id|ilen
)paren
suffix:semicolon
id|vname
op_add_assign
id|ilen
suffix:semicolon
)brace
op_star
id|vlen
op_assign
id|ilen
suffix:semicolon
op_star
id|vname
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|ncp__vol2io
id|ncp__vol2io
c_func
(paren
r_int
r_char
op_star
id|iname
comma
r_int
r_int
op_star
id|ilen
comma
r_const
r_int
r_char
op_star
id|vname
comma
r_int
r_int
id|vlen
comma
r_int
id|cc
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_star
id|ilen
op_le
id|vlen
)paren
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
r_if
c_cond
(paren
id|cc
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|vlen
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|iname
op_assign
id|tolower
c_func
(paren
op_star
id|vname
)paren
suffix:semicolon
id|iname
op_increment
suffix:semicolon
id|vname
op_increment
suffix:semicolon
)brace
r_else
(brace
id|memmove
c_func
(paren
id|iname
comma
id|vname
comma
id|vlen
)paren
suffix:semicolon
id|iname
op_add_assign
id|vlen
suffix:semicolon
)brace
op_star
id|ilen
op_assign
id|vlen
suffix:semicolon
op_star
id|iname
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_inline
r_int
DECL|function|ncp_strnicmp
id|ncp_strnicmp
c_func
(paren
r_struct
id|nls_table
op_star
id|t
comma
r_const
r_int
r_char
op_star
id|s1
comma
r_const
r_int
r_char
op_star
id|s2
comma
r_int
id|n
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|ncp_tolower
c_func
(paren
id|t
comma
id|s1
(braket
id|i
)braket
)paren
op_ne
id|ncp_tolower
c_func
(paren
id|t
comma
id|s2
(braket
id|i
)braket
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
