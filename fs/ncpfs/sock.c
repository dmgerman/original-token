multiline_comment|/*&n; *  linux/fs/ncpfs/sock.c&n; *&n; *  Copyright (C) 1992, 1993  Rick Sladkey&n; *&n; *  Modified 1995, 1996 by Volker Lendecke to be usable for ncp&n; *&n; */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/ncp_fs.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/ipx.h&gt;
macro_line|#include &lt;linux/ncp.h&gt;
macro_line|#include &lt;linux/ncp_fs.h&gt;
macro_line|#include &lt;linux/ncp_fs_sb.h&gt;
macro_line|#include &lt;net/sock.h&gt;
DECL|macro|_S
mdefine_line|#define _S(nr) (1&lt;&lt;((nr)-1))
DECL|function|_recvfrom
r_static
r_int
id|_recvfrom
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
r_char
op_star
id|ubuf
comma
r_int
id|size
comma
r_int
id|noblock
comma
r_int
id|flags
comma
r_struct
id|sockaddr_ipx
op_star
id|sa
comma
r_int
op_star
id|addr_len
)paren
(brace
r_struct
id|iovec
id|iov
suffix:semicolon
r_struct
id|msghdr
id|msg
suffix:semicolon
id|iov.iov_base
op_assign
id|ubuf
suffix:semicolon
id|iov.iov_len
op_assign
id|size
suffix:semicolon
id|msg.msg_name
op_assign
(paren
r_void
op_star
)paren
id|sa
suffix:semicolon
id|msg.msg_namelen
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|addr_len
)paren
id|msg.msg_namelen
op_assign
op_star
id|addr_len
suffix:semicolon
id|msg.msg_control
op_assign
l_int|NULL
suffix:semicolon
id|msg.msg_iov
op_assign
op_amp
id|iov
suffix:semicolon
id|msg.msg_iovlen
op_assign
l_int|1
suffix:semicolon
r_return
id|sock-&gt;ops
op_member_access_from_pointer
id|recvmsg
c_func
(paren
id|sock
comma
op_amp
id|msg
comma
id|size
comma
id|noblock
comma
id|flags
comma
id|addr_len
)paren
suffix:semicolon
)brace
DECL|function|_sendto
r_static
r_int
id|_sendto
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_const
r_void
op_star
id|buff
comma
r_int
id|len
comma
r_int
id|nonblock
comma
r_int
id|flags
comma
r_struct
id|sockaddr_ipx
op_star
id|sa
comma
r_int
id|addr_len
)paren
(brace
r_struct
id|iovec
id|iov
suffix:semicolon
r_struct
id|msghdr
id|msg
suffix:semicolon
id|iov.iov_base
op_assign
(paren
r_void
op_star
)paren
id|buff
suffix:semicolon
id|iov.iov_len
op_assign
id|len
suffix:semicolon
id|msg.msg_name
op_assign
(paren
r_void
op_star
)paren
id|sa
suffix:semicolon
id|msg.msg_namelen
op_assign
id|addr_len
suffix:semicolon
id|msg.msg_control
op_assign
l_int|NULL
suffix:semicolon
id|msg.msg_iov
op_assign
op_amp
id|iov
suffix:semicolon
id|msg.msg_iovlen
op_assign
l_int|1
suffix:semicolon
r_return
id|sock-&gt;ops
op_member_access_from_pointer
id|sendmsg
c_func
(paren
id|sock
comma
op_amp
id|msg
comma
id|len
comma
id|nonblock
comma
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ncp_wdog_data_ready
id|ncp_wdog_data_ready
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
id|len
)paren
(brace
r_struct
id|socket
op_star
id|sock
op_assign
id|sk-&gt;socket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;dead
)paren
(brace
r_int
r_char
id|packet_buf
(braket
l_int|2
)braket
suffix:semicolon
r_struct
id|sockaddr_ipx
id|sender
suffix:semicolon
r_int
id|addr_len
op_assign
r_sizeof
(paren
r_struct
id|sockaddr_ipx
)paren
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
r_int
id|fs
suffix:semicolon
id|fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
id|result
op_assign
id|_recvfrom
c_func
(paren
id|sock
comma
(paren
r_void
op_star
)paren
id|packet_buf
comma
l_int|2
comma
l_int|1
comma
l_int|0
comma
op_amp
id|sender
comma
op_amp
id|addr_len
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_ne
l_int|2
)paren
op_logical_or
(paren
id|packet_buf
(braket
l_int|1
)braket
op_ne
l_char|&squot;?&squot;
)paren
multiline_comment|/* How to check connection number here? */
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ncpfs: got strange packet on watchdog &quot;
l_string|&quot;socket&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
id|result
suffix:semicolon
id|DDPRINTK
c_func
(paren
l_string|&quot;ncpfs: got watchdog from:&bslash;n&quot;
)paren
suffix:semicolon
id|DDPRINTK
c_func
(paren
l_string|&quot;ncpfs: %08lX:%02X%02X%02X%02X%02X%02X:%04X,&quot;
l_string|&quot; conn:%02X,type:%c&bslash;n&quot;
comma
id|htonl
c_func
(paren
id|sender.sipx_network
)paren
comma
id|sender.sipx_node
(braket
l_int|0
)braket
comma
id|sender.sipx_node
(braket
l_int|1
)braket
comma
id|sender.sipx_node
(braket
l_int|2
)braket
comma
id|sender.sipx_node
(braket
l_int|3
)braket
comma
id|sender.sipx_node
(braket
l_int|4
)braket
comma
id|sender.sipx_node
(braket
l_int|5
)braket
comma
id|ntohs
c_func
(paren
id|sender.sipx_port
)paren
comma
id|packet_buf
(braket
l_int|0
)braket
comma
id|packet_buf
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|packet_buf
(braket
l_int|1
)braket
op_assign
l_char|&squot;Y&squot;
suffix:semicolon
id|result
op_assign
id|_sendto
c_func
(paren
id|sock
comma
(paren
r_void
op_star
)paren
id|packet_buf
comma
l_int|2
comma
l_int|1
comma
l_int|0
comma
op_amp
id|sender
comma
r_sizeof
(paren
id|sender
)paren
)paren
suffix:semicolon
id|DDPRINTK
c_func
(paren
l_string|&quot;send result: %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
)brace
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
)brace
)brace
r_int
DECL|function|ncp_catch_watchdog
id|ncp_catch_watchdog
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
)paren
(brace
r_struct
id|file
op_star
id|file
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_struct
id|socket
op_star
id|sock
suffix:semicolon
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_if
c_cond
(paren
(paren
id|server
op_eq
l_int|NULL
)paren
op_logical_or
(paren
(paren
id|file
op_assign
id|server-&gt;wdog_filp
)paren
op_eq
l_int|NULL
)paren
op_logical_or
(paren
(paren
id|inode
op_assign
id|file-&gt;f_inode
)paren
op_eq
l_int|NULL
)paren
op_logical_or
(paren
op_logical_neg
id|S_ISSOCK
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ncp_catch_watchdog: did not get valid server!&bslash;n&quot;
)paren
suffix:semicolon
id|server-&gt;data_ready
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|sock
op_assign
op_amp
(paren
id|inode-&gt;u.socket_i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;type
op_ne
id|SOCK_DGRAM
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ncp_catch_watchdog: did not get SOCK_DGRAM&bslash;n&quot;
)paren
suffix:semicolon
id|server-&gt;data_ready
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|sk
op_assign
(paren
r_struct
id|sock
op_star
)paren
(paren
id|sock-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ncp_catch_watchdog: sk == NULL&quot;
)paren
suffix:semicolon
id|server-&gt;data_ready
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|DDPRINTK
c_func
(paren
l_string|&quot;ncp_catch_watchdog: sk-&gt;d_r = %x, server-&gt;d_r = %x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
(paren
id|sk-&gt;data_ready
)paren
comma
(paren
r_int
r_int
)paren
(paren
id|server-&gt;data_ready
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;data_ready
op_eq
id|ncp_wdog_data_ready
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ncp_catch_watchdog: already done&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|server-&gt;data_ready
op_assign
id|sk-&gt;data_ready
suffix:semicolon
id|sk-&gt;data_ready
op_assign
id|ncp_wdog_data_ready
suffix:semicolon
id|sk-&gt;allocation
op_assign
id|GFP_ATOMIC
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|ncp_dont_catch_watchdog
id|ncp_dont_catch_watchdog
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
)paren
(brace
r_struct
id|file
op_star
id|file
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_struct
id|socket
op_star
id|sock
suffix:semicolon
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_if
c_cond
(paren
(paren
id|server
op_eq
l_int|NULL
)paren
op_logical_or
(paren
(paren
id|file
op_assign
id|server-&gt;wdog_filp
)paren
op_eq
l_int|NULL
)paren
op_logical_or
(paren
(paren
id|inode
op_assign
id|file-&gt;f_inode
)paren
op_eq
l_int|NULL
)paren
op_logical_or
(paren
op_logical_neg
id|S_ISSOCK
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ncp_dont_catch_watchdog: &quot;
l_string|&quot;did not get valid server!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|sock
op_assign
op_amp
(paren
id|inode-&gt;u.socket_i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;type
op_ne
id|SOCK_DGRAM
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ncp_dont_catch_watchdog: did not get SOCK_DGRAM&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|sk
op_assign
(paren
r_struct
id|sock
op_star
)paren
(paren
id|sock-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ncp_dont_catch_watchdog: sk == NULL&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|server-&gt;data_ready
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ncp_dont_catch_watchdog: &quot;
l_string|&quot;server-&gt;data_ready == NULL&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sk-&gt;data_ready
op_ne
id|ncp_wdog_data_ready
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ncp_dont_catch_watchdog: &quot;
l_string|&quot;sk-&gt;data_callback != ncp_data_callback&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|DDPRINTK
c_func
(paren
l_string|&quot;ncp_dont_catch_watchdog: sk-&gt;d_r = %x, server-&gt;d_r = %x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
(paren
id|sk-&gt;data_ready
)paren
comma
(paren
r_int
r_int
)paren
(paren
id|server-&gt;data_ready
)paren
)paren
suffix:semicolon
id|sk-&gt;data_ready
op_assign
id|server-&gt;data_ready
suffix:semicolon
id|sk-&gt;allocation
op_assign
id|GFP_KERNEL
suffix:semicolon
id|server-&gt;data_ready
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|ncp_msg_data_ready
id|ncp_msg_data_ready
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
id|len
)paren
(brace
r_struct
id|socket
op_star
id|sock
op_assign
id|sk-&gt;socket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;dead
)paren
(brace
r_int
r_char
id|packet_buf
(braket
l_int|2
)braket
suffix:semicolon
r_struct
id|sockaddr_ipx
id|sender
suffix:semicolon
r_int
id|addr_len
op_assign
r_sizeof
(paren
r_struct
id|sockaddr_ipx
)paren
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
r_int
id|fs
suffix:semicolon
id|fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
id|result
op_assign
id|_recvfrom
c_func
(paren
id|sock
comma
(paren
r_void
op_star
)paren
id|packet_buf
comma
l_int|2
comma
l_int|1
comma
l_int|0
comma
op_amp
id|sender
comma
op_amp
id|addr_len
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ncpfs: got message of size %d from:&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ncpfs: %08lX:%02X%02X%02X%02X%02X%02X:%04X,&quot;
l_string|&quot; conn:%02X,type:%c&bslash;n&quot;
comma
id|htonl
c_func
(paren
id|sender.sipx_network
)paren
comma
id|sender.sipx_node
(braket
l_int|0
)braket
comma
id|sender.sipx_node
(braket
l_int|1
)braket
comma
id|sender.sipx_node
(braket
l_int|2
)braket
comma
id|sender.sipx_node
(braket
l_int|3
)braket
comma
id|sender.sipx_node
(braket
l_int|4
)braket
comma
id|sender.sipx_node
(braket
l_int|5
)braket
comma
id|ntohs
c_func
(paren
id|sender.sipx_port
)paren
comma
id|packet_buf
(braket
l_int|0
)braket
comma
id|packet_buf
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|ncp_trigger_message
c_func
(paren
id|sk-&gt;protinfo.af_ipx.ncp_server
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
)brace
)brace
r_int
DECL|function|ncp_catch_message
id|ncp_catch_message
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
)paren
(brace
r_struct
id|file
op_star
id|file
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_struct
id|socket
op_star
id|sock
suffix:semicolon
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_if
c_cond
(paren
(paren
id|server
op_eq
l_int|NULL
)paren
op_logical_or
(paren
(paren
id|file
op_assign
id|server-&gt;msg_filp
)paren
op_eq
l_int|NULL
)paren
op_logical_or
(paren
(paren
id|inode
op_assign
id|file-&gt;f_inode
)paren
op_eq
l_int|NULL
)paren
op_logical_or
(paren
op_logical_neg
id|S_ISSOCK
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ncp_catch_message: did not get valid server!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|sock
op_assign
op_amp
(paren
id|inode-&gt;u.socket_i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;type
op_ne
id|SOCK_DGRAM
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ncp_catch_message: did not get SOCK_DGRAM&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|sk
op_assign
(paren
r_struct
id|sock
op_star
)paren
(paren
id|sock-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ncp_catch_message: sk == NULL&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|DDPRINTK
c_func
(paren
l_string|&quot;ncp_catch_message: sk-&gt;d_r = %x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
(paren
id|sk-&gt;data_ready
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;data_ready
op_eq
id|ncp_msg_data_ready
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ncp_catch_message: already done&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|sk-&gt;data_ready
op_assign
id|ncp_msg_data_ready
suffix:semicolon
id|sk-&gt;protinfo.af_ipx.ncp_server
op_assign
id|server
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|NCP_SLACK_SPACE
mdefine_line|#define NCP_SLACK_SPACE 1024
DECL|macro|_S
mdefine_line|#define _S(nr) (1&lt;&lt;((nr)-1))
r_static
r_int
DECL|function|do_ncp_rpc_call
id|do_ncp_rpc_call
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_int
id|size
)paren
(brace
r_struct
id|file
op_star
id|file
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_struct
id|socket
op_star
id|sock
suffix:semicolon
r_int
r_int
id|fs
suffix:semicolon
r_int
id|result
suffix:semicolon
r_char
op_star
id|start
op_assign
id|server-&gt;packet
suffix:semicolon
id|select_table
id|wait_table
suffix:semicolon
r_struct
id|select_table_entry
id|entry
suffix:semicolon
r_int
(paren
op_star
id|select
)paren
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
comma
r_int
comma
id|select_table
op_star
)paren
suffix:semicolon
r_int
id|init_timeout
comma
id|max_timeout
suffix:semicolon
r_int
id|timeout
suffix:semicolon
r_int
id|retrans
suffix:semicolon
r_int
id|major_timeout_seen
suffix:semicolon
r_int
id|acknowledge_seen
suffix:semicolon
r_char
op_star
id|server_name
suffix:semicolon
r_int
id|n
suffix:semicolon
r_int
id|addrlen
suffix:semicolon
r_int
r_int
id|old_mask
suffix:semicolon
multiline_comment|/* We have to check the result, so store the complete header */
r_struct
id|ncp_request_header
id|request
op_assign
op_star
(paren
(paren
r_struct
id|ncp_request_header
op_star
)paren
(paren
id|server-&gt;packet
)paren
)paren
suffix:semicolon
r_struct
id|ncp_reply_header
id|reply
suffix:semicolon
id|file
op_assign
id|server-&gt;ncp_filp
suffix:semicolon
id|inode
op_assign
id|file-&gt;f_inode
suffix:semicolon
id|select
op_assign
id|file-&gt;f_op-&gt;select
suffix:semicolon
id|sock
op_assign
op_amp
id|inode-&gt;u.socket_i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sock
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ncp_rpc_call: socki_lookup failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBADF
suffix:semicolon
)brace
id|init_timeout
op_assign
id|server-&gt;m.time_out
suffix:semicolon
id|max_timeout
op_assign
id|NCP_MAX_RPC_TIMEOUT
suffix:semicolon
id|retrans
op_assign
id|server-&gt;m.retry_count
suffix:semicolon
id|major_timeout_seen
op_assign
l_int|0
suffix:semicolon
id|acknowledge_seen
op_assign
l_int|0
suffix:semicolon
id|server_name
op_assign
id|server-&gt;m.server_name
suffix:semicolon
id|old_mask
op_assign
id|current-&gt;blocked
suffix:semicolon
id|current-&gt;blocked
op_or_assign
op_complement
(paren
id|_S
c_func
(paren
id|SIGKILL
)paren
macro_line|#if 0
op_or
id|_S
c_func
(paren
id|SIGSTOP
)paren
macro_line|#endif
op_or
(paren
(paren
id|server-&gt;m.flags
op_amp
id|NCP_MOUNT_INTR
)paren
ques
c_cond
(paren
(paren
id|current-&gt;sig-&gt;action
(braket
id|SIGINT
op_minus
l_int|1
)braket
dot
id|sa_handler
op_eq
id|SIG_DFL
ques
c_cond
id|_S
c_func
(paren
id|SIGINT
)paren
suffix:colon
l_int|0
)paren
op_or
(paren
id|current-&gt;sig-&gt;action
(braket
id|SIGQUIT
op_minus
l_int|1
)braket
dot
id|sa_handler
op_eq
id|SIG_DFL
ques
c_cond
id|_S
c_func
(paren
id|SIGQUIT
)paren
suffix:colon
l_int|0
)paren
)paren
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
id|fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|0
comma
id|timeout
op_assign
id|init_timeout
suffix:semicolon
suffix:semicolon
id|n
op_increment
comma
id|timeout
op_lshift_assign
l_int|1
)paren
(brace
id|DDPRINTK
c_func
(paren
l_string|&quot;ncpfs: %08lX:%02X%02X%02X%02X%02X%02X:%04X&bslash;n&quot;
comma
id|htonl
c_func
(paren
id|server-&gt;m.serv_addr.sipx_network
)paren
comma
id|server-&gt;m.serv_addr.sipx_node
(braket
l_int|0
)braket
comma
id|server-&gt;m.serv_addr.sipx_node
(braket
l_int|1
)braket
comma
id|server-&gt;m.serv_addr.sipx_node
(braket
l_int|2
)braket
comma
id|server-&gt;m.serv_addr.sipx_node
(braket
l_int|3
)braket
comma
id|server-&gt;m.serv_addr.sipx_node
(braket
l_int|4
)braket
comma
id|server-&gt;m.serv_addr.sipx_node
(braket
l_int|5
)braket
comma
id|ntohs
c_func
(paren
id|server-&gt;m.serv_addr.sipx_port
)paren
)paren
suffix:semicolon
id|DDPRINTK
c_func
(paren
l_string|&quot;ncpfs: req.typ: %04X, con: %d, &quot;
l_string|&quot;seq: %d&quot;
comma
id|request.type
comma
(paren
id|request.conn_high
op_lshift
l_int|8
)paren
op_plus
id|request.conn_low
comma
id|request.sequence
)paren
suffix:semicolon
id|DDPRINTK
c_func
(paren
l_string|&quot; func: %d&bslash;n&quot;
comma
id|request.function
)paren
suffix:semicolon
id|result
op_assign
id|_sendto
c_func
(paren
id|sock
comma
(paren
r_void
op_star
)paren
id|start
comma
id|size
comma
l_int|0
comma
l_int|0
comma
op_amp
(paren
id|server-&gt;m.serv_addr
)paren
comma
r_sizeof
(paren
id|server-&gt;m.serv_addr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ncp_rpc_call: send error = %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|re_select
suffix:colon
id|wait_table.nr
op_assign
l_int|0
suffix:semicolon
id|wait_table.entry
op_assign
op_amp
id|entry
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|select
c_func
(paren
id|inode
comma
id|file
comma
id|SEL_IN
comma
op_amp
id|wait_table
)paren
op_logical_and
op_logical_neg
id|select
c_func
(paren
id|inode
comma
id|file
comma
id|SEL_IN
comma
l_int|NULL
)paren
)paren
(brace
r_if
c_cond
(paren
id|timeout
OG
id|max_timeout
)paren
(brace
multiline_comment|/* JEJB/JSP 2/7/94&n;&t;&t;&t;&t; * This is useful to see if the system is&n;&t;&t;&t;&t; * hanging */
r_if
c_cond
(paren
id|acknowledge_seen
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;NCP max timeout reached on &quot;
l_string|&quot;%s&bslash;n&quot;
comma
id|server_name
)paren
suffix:semicolon
)brace
id|timeout
op_assign
id|max_timeout
suffix:semicolon
)brace
id|current-&gt;timeout
op_assign
id|jiffies
op_plus
id|timeout
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
id|entry.wait_address
comma
op_amp
id|entry.wait
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;signal
op_amp
op_complement
id|current-&gt;blocked
)paren
(brace
id|current-&gt;timeout
op_assign
l_int|0
suffix:semicolon
id|result
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|current-&gt;timeout
)paren
(brace
r_if
c_cond
(paren
id|n
OL
id|retrans
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;m.flags
op_amp
id|NCP_MOUNT_SOFT
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;NCP server %s not responding, &quot;
l_string|&quot;timed out&bslash;n&quot;
comma
id|server_name
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
id|n
op_assign
l_int|0
suffix:semicolon
id|timeout
op_assign
id|init_timeout
suffix:semicolon
id|init_timeout
op_lshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|major_timeout_seen
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;NCP server %s not responding, &quot;
l_string|&quot;still trying&bslash;n&quot;
comma
id|server_name
)paren
suffix:semicolon
)brace
id|major_timeout_seen
op_assign
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
id|current-&gt;timeout
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|wait_table.nr
)paren
id|remove_wait_queue
c_func
(paren
id|entry.wait_address
comma
op_amp
id|entry.wait
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|addrlen
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Get the header from the next packet using a peek, so keep it&n;&t;&t; * on the recv queue.  If it is wrong, it will be some reply&n;&t;&t; * we don&squot;t now need, so discard it */
id|result
op_assign
id|_recvfrom
c_func
(paren
id|sock
comma
(paren
r_void
op_star
)paren
op_amp
id|reply
comma
r_sizeof
(paren
id|reply
)paren
comma
l_int|1
comma
id|MSG_PEEK
comma
l_int|NULL
comma
op_amp
id|addrlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|result
op_eq
op_minus
id|EAGAIN
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;ncp_rpc_call: bad select ready&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|re_select
suffix:semicolon
)brace
r_if
c_cond
(paren
id|result
op_eq
op_minus
id|ECONNREFUSED
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;ncp_rpc_call: server playing coy&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|re_select
suffix:semicolon
)brace
r_if
c_cond
(paren
id|result
op_ne
op_minus
id|ERESTARTSYS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ncp_rpc_call: recv error = %d&bslash;n&quot;
comma
op_minus
id|result
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|result
op_eq
r_sizeof
(paren
id|reply
)paren
)paren
op_logical_and
(paren
id|reply.type
op_eq
id|NCP_POSITIVE_ACK
)paren
)paren
(brace
multiline_comment|/* Throw away the packet */
id|DPRINTK
c_func
(paren
l_string|&quot;ncp_rpc_call: got positive acknowledge&bslash;n&quot;
)paren
suffix:semicolon
id|_recvfrom
c_func
(paren
id|sock
comma
(paren
r_void
op_star
)paren
op_amp
id|reply
comma
r_sizeof
(paren
id|reply
)paren
comma
l_int|1
comma
l_int|0
comma
l_int|NULL
comma
op_amp
id|addrlen
)paren
suffix:semicolon
id|n
op_assign
l_int|0
suffix:semicolon
id|timeout
op_assign
id|max_timeout
suffix:semicolon
id|acknowledge_seen
op_assign
l_int|1
suffix:semicolon
r_goto
id|re_select
suffix:semicolon
)brace
id|DDPRINTK
c_func
(paren
l_string|&quot;ncpfs: rep.typ: %04X, con: %d, tsk: %d,&quot;
l_string|&quot;seq: %d&bslash;n&quot;
comma
id|reply.type
comma
(paren
id|reply.conn_high
op_lshift
l_int|8
)paren
op_plus
id|reply.conn_low
comma
id|reply.task
comma
id|reply.sequence
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_ge
r_sizeof
(paren
id|reply
)paren
)paren
op_logical_and
(paren
id|reply.type
op_eq
id|NCP_REPLY
)paren
op_logical_and
(paren
(paren
id|request.type
op_eq
id|NCP_ALLOC_SLOT_REQUEST
)paren
op_logical_or
(paren
(paren
id|reply.sequence
op_eq
id|request.sequence
)paren
op_logical_and
(paren
id|reply.conn_low
op_eq
id|request.conn_low
)paren
multiline_comment|/* seem to get wrong task from NW311 &amp;&amp; (reply.task      == request.task)*/
op_logical_and
(paren
id|reply.conn_high
op_eq
id|request.conn_high
)paren
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|major_timeout_seen
)paren
id|printk
c_func
(paren
l_string|&quot;NCP server %s OK&bslash;n&quot;
comma
id|server_name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* JEJB/JSP 2/7/94&n;&t;&t; * we have xid mismatch, so discard the packet and start&n;&t;&t; * again.  What a hack! but I can&squot;t call recvfrom with&n;&t;&t; * a null buffer yet. */
id|_recvfrom
c_func
(paren
id|sock
comma
(paren
r_void
op_star
)paren
op_amp
id|reply
comma
r_sizeof
(paren
id|reply
)paren
comma
l_int|1
comma
l_int|0
comma
l_int|NULL
comma
op_amp
id|addrlen
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ncp_rpc_call: reply mismatch&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|re_select
suffix:semicolon
)brace
multiline_comment|/* &n;&t; * we have the correct reply, so read into the correct place and&n;&t; * return it&n;&t; */
id|result
op_assign
id|_recvfrom
c_func
(paren
id|sock
comma
(paren
r_void
op_star
)paren
id|start
comma
id|server-&gt;packet_size
comma
l_int|1
comma
l_int|0
comma
l_int|NULL
comma
op_amp
id|addrlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;NCP: notice message: result=%d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|result
OL
r_sizeof
(paren
r_struct
id|ncp_reply_header
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;NCP: just caught a too small read memory size..., &quot;
l_string|&quot;email to NET channel&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;NCP: result=%d,addrlen=%d&bslash;n&quot;
comma
id|result
comma
id|addrlen
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
id|current-&gt;blocked
op_assign
id|old_mask
suffix:semicolon
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * We need the server to be locked here, so check!&n; */
r_static
r_int
DECL|function|ncp_do_request
id|ncp_do_request
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_int
id|size
)paren
(brace
r_int
id|result
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;lock
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ncpfs: Server not locked!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ncp_conn_valid
c_func
(paren
id|server
)paren
)paren
(brace
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|result
op_assign
id|do_ncp_rpc_call
c_func
(paren
id|server
comma
id|size
)paren
suffix:semicolon
id|DDPRINTK
c_func
(paren
l_string|&quot;do_ncp_rpc_call returned %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
multiline_comment|/* There was a problem with I/O, so the connections is&n;                 * no longer usable. */
id|ncp_invalidate_conn
c_func
(paren
id|server
)paren
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* ncp_do_request assures that at least a complete reply header is&n; * received. It assumes that server-&gt;current_size contains the ncp&n; * request size */
r_int
DECL|function|ncp_request
id|ncp_request
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
comma
r_int
id|function
)paren
(brace
r_struct
id|ncp_request_header
op_star
id|h
op_assign
(paren
r_struct
id|ncp_request_header
op_star
)paren
(paren
id|server-&gt;packet
)paren
suffix:semicolon
r_struct
id|ncp_reply_header
op_star
id|reply
op_assign
(paren
r_struct
id|ncp_reply_header
op_star
)paren
(paren
id|server-&gt;packet
)paren
suffix:semicolon
r_int
id|request_size
op_assign
id|server-&gt;current_size
op_minus
r_sizeof
(paren
r_struct
id|ncp_request_header
)paren
suffix:semicolon
r_int
id|result
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;has_subfunction
op_ne
l_int|0
)paren
(brace
op_star
(paren
id|__u16
op_star
)paren
op_amp
(paren
id|h-&gt;data
(braket
l_int|0
)braket
)paren
op_assign
id|htons
c_func
(paren
id|request_size
op_minus
l_int|2
)paren
suffix:semicolon
)brace
id|h-&gt;type
op_assign
id|NCP_REQUEST
suffix:semicolon
id|server-&gt;sequence
op_add_assign
l_int|1
suffix:semicolon
id|h-&gt;sequence
op_assign
id|server-&gt;sequence
suffix:semicolon
id|h-&gt;conn_low
op_assign
(paren
id|server-&gt;connection
)paren
op_amp
l_int|0xff
suffix:semicolon
id|h-&gt;conn_high
op_assign
(paren
(paren
id|server-&gt;connection
)paren
op_amp
l_int|0xff00
)paren
op_rshift
l_int|8
suffix:semicolon
id|h-&gt;task
op_assign
(paren
id|current-&gt;pid
)paren
op_amp
l_int|0xff
suffix:semicolon
id|h-&gt;function
op_assign
id|function
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_do_request
c_func
(paren
id|server
comma
id|request_size
op_plus
r_sizeof
(paren
op_star
id|h
)paren
)paren
)paren
OL
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;ncp_request_error: %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|server-&gt;completion
op_assign
id|reply-&gt;completion_code
suffix:semicolon
id|server-&gt;conn_status
op_assign
id|reply-&gt;connection_state
suffix:semicolon
id|server-&gt;reply_size
op_assign
id|result
suffix:semicolon
id|server-&gt;ncp_reply_size
op_assign
id|result
op_minus
r_sizeof
(paren
r_struct
id|ncp_reply_header
)paren
suffix:semicolon
id|result
op_assign
id|reply-&gt;completion_code
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;ncp_completion_code: %x&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|ncp_connect
id|ncp_connect
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
)paren
(brace
r_struct
id|ncp_request_header
op_star
id|h
op_assign
(paren
r_struct
id|ncp_request_header
op_star
)paren
(paren
id|server-&gt;packet
)paren
suffix:semicolon
r_int
id|result
suffix:semicolon
id|h-&gt;type
op_assign
id|NCP_ALLOC_SLOT_REQUEST
suffix:semicolon
id|server-&gt;sequence
op_assign
l_int|0
suffix:semicolon
id|h-&gt;sequence
op_assign
id|server-&gt;sequence
suffix:semicolon
id|h-&gt;conn_low
op_assign
l_int|0xff
suffix:semicolon
id|h-&gt;conn_high
op_assign
l_int|0xff
suffix:semicolon
id|h-&gt;task
op_assign
(paren
id|current-&gt;pid
)paren
op_amp
l_int|0xff
suffix:semicolon
id|h-&gt;function
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|ncp_do_request
c_func
(paren
id|server
comma
r_sizeof
(paren
op_star
id|h
)paren
)paren
)paren
OL
l_int|0
)paren
(brace
r_return
id|result
suffix:semicolon
)brace
id|server-&gt;sequence
op_assign
l_int|0
suffix:semicolon
id|server-&gt;connection
op_assign
id|h-&gt;conn_low
op_plus
(paren
id|h-&gt;conn_high
op_star
l_int|256
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|ncp_disconnect
id|ncp_disconnect
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
)paren
(brace
r_struct
id|ncp_request_header
op_star
id|h
op_assign
(paren
r_struct
id|ncp_request_header
op_star
)paren
(paren
id|server-&gt;packet
)paren
suffix:semicolon
id|h-&gt;type
op_assign
id|NCP_DEALLOC_SLOT_REQUEST
suffix:semicolon
id|server-&gt;sequence
op_add_assign
l_int|1
suffix:semicolon
id|h-&gt;sequence
op_assign
id|server-&gt;sequence
suffix:semicolon
id|h-&gt;conn_low
op_assign
(paren
id|server-&gt;connection
)paren
op_amp
l_int|0xff
suffix:semicolon
id|h-&gt;conn_high
op_assign
(paren
(paren
id|server-&gt;connection
)paren
op_amp
l_int|0xff00
)paren
op_rshift
l_int|8
suffix:semicolon
id|h-&gt;task
op_assign
(paren
id|current-&gt;pid
)paren
op_amp
l_int|0xff
suffix:semicolon
id|h-&gt;function
op_assign
l_int|0
suffix:semicolon
r_return
id|ncp_do_request
c_func
(paren
id|server
comma
r_sizeof
(paren
op_star
id|h
)paren
)paren
suffix:semicolon
)brace
r_void
DECL|function|ncp_lock_server
id|ncp_lock_server
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
)paren
(brace
macro_line|#if 0
multiline_comment|/* For testing, only 1 process */
r_if
c_cond
(paren
id|server-&gt;lock
op_ne
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;ncpfs: server locked!!!&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_while
c_loop
(paren
id|server-&gt;lock
)paren
id|sleep_on
c_func
(paren
op_amp
id|server-&gt;wait
)paren
suffix:semicolon
id|server-&gt;lock
op_assign
l_int|1
suffix:semicolon
)brace
r_void
DECL|function|ncp_unlock_server
id|ncp_unlock_server
c_func
(paren
r_struct
id|ncp_server
op_star
id|server
)paren
(brace
r_if
c_cond
(paren
id|server-&gt;lock
op_ne
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ncp_unlock_server: was not locked!&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|server-&gt;lock
op_assign
l_int|0
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|server-&gt;wait
)paren
suffix:semicolon
)brace
eof
