multiline_comment|/*&n; *  linux/fs/isofs/util.c&n; *&n; *  The special functions in the file are numbered according to the section&n; *  of the iso 9660 standard in which they are described.  isonum_733 will&n; *  convert numbers according to section 7.3.3, etc.&n; *&n; *  isofs special functions.  This file was lifted in its entirety from&n; *  the 386BSD iso9660 filesystem, by Pace Willisson &lt;pace@blitz.com&gt;.&n; */
macro_line|#include &lt;linux/time.h&gt;
r_int
DECL|function|isonum_711
id|isonum_711
(paren
r_char
op_star
id|p
)paren
(brace
r_return
(paren
op_star
id|p
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
r_int
DECL|function|isonum_712
id|isonum_712
(paren
r_char
op_star
id|p
)paren
(brace
r_int
id|val
suffix:semicolon
id|val
op_assign
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
l_int|0x80
)paren
id|val
op_or_assign
l_int|0xffffff00
suffix:semicolon
r_return
(paren
id|val
)paren
suffix:semicolon
)brace
r_int
DECL|function|isonum_721
id|isonum_721
(paren
r_char
op_star
id|p
)paren
(brace
r_return
(paren
(paren
id|p
(braket
l_int|0
)braket
op_amp
l_int|0xff
)paren
op_or
(paren
(paren
id|p
(braket
l_int|1
)braket
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
)brace
r_int
DECL|function|isonum_722
id|isonum_722
(paren
r_char
op_star
id|p
)paren
(brace
r_return
(paren
(paren
(paren
id|p
(braket
l_int|0
)braket
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
op_or
(paren
id|p
(braket
l_int|1
)braket
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
)brace
r_int
DECL|function|isonum_723
id|isonum_723
(paren
r_char
op_star
id|p
)paren
(brace
macro_line|#if 0
r_if
c_cond
(paren
id|p
(braket
l_int|0
)braket
op_ne
id|p
(braket
l_int|3
)braket
op_logical_or
id|p
(braket
l_int|1
)braket
op_ne
id|p
(braket
l_int|2
)braket
)paren
(brace
id|fprintf
(paren
id|stderr
comma
l_string|&quot;invalid format 7.2.3 number&bslash;n&quot;
)paren
suffix:semicolon
m_exit
(paren
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
(paren
id|isonum_721
(paren
id|p
)paren
)paren
suffix:semicolon
)brace
r_int
DECL|function|isonum_731
id|isonum_731
(paren
r_char
op_star
id|p
)paren
(brace
r_return
(paren
(paren
id|p
(braket
l_int|0
)braket
op_amp
l_int|0xff
)paren
op_or
(paren
(paren
id|p
(braket
l_int|1
)braket
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|p
(braket
l_int|2
)braket
op_amp
l_int|0xff
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|p
(braket
l_int|3
)braket
op_amp
l_int|0xff
)paren
op_lshift
l_int|24
)paren
)paren
suffix:semicolon
)brace
r_int
DECL|function|isonum_732
id|isonum_732
(paren
r_char
op_star
id|p
)paren
(brace
r_return
(paren
(paren
(paren
id|p
(braket
l_int|0
)braket
op_amp
l_int|0xff
)paren
op_lshift
l_int|24
)paren
op_or
(paren
(paren
id|p
(braket
l_int|1
)braket
op_amp
l_int|0xff
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|p
(braket
l_int|2
)braket
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
op_or
(paren
id|p
(braket
l_int|3
)braket
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
)brace
r_int
DECL|function|isonum_733
id|isonum_733
(paren
r_char
op_star
id|p
)paren
(brace
macro_line|#if 0
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|p
(braket
id|i
)braket
op_ne
id|p
(braket
l_int|7
op_minus
id|i
)braket
)paren
(brace
id|fprintf
(paren
id|stderr
comma
l_string|&quot;bad format 7.3.3 number&bslash;n&quot;
)paren
suffix:semicolon
m_exit
(paren
l_int|1
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
r_return
(paren
id|isonum_731
(paren
id|p
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * We have to convert from a MM/DD/YY format to the Unix ctime format.&n; * We have to take into account leap years and all of that good stuff.&n; * Unfortunately, the kernel does not have the information on hand to&n; * take into account daylight savings time, but it shouldn&squot;t matter.&n; * The time stored should be localtime (with or without DST in effect),&n; * and the timezone offset should hold the offset required to get back&n; * to GMT.  Thus  we should always be correct.&n; */
DECL|function|iso_date
r_int
id|iso_date
c_func
(paren
r_char
op_star
id|p
comma
r_int
id|flag
)paren
(brace
r_int
id|year
comma
id|month
comma
id|day
comma
id|hour
comma
id|minute
comma
id|second
comma
id|tz
suffix:semicolon
r_int
id|crtime
comma
id|days
comma
id|i
suffix:semicolon
id|year
op_assign
id|p
(braket
l_int|0
)braket
op_minus
l_int|70
suffix:semicolon
id|month
op_assign
id|p
(braket
l_int|1
)braket
suffix:semicolon
id|day
op_assign
id|p
(braket
l_int|2
)braket
suffix:semicolon
id|hour
op_assign
id|p
(braket
l_int|3
)braket
suffix:semicolon
id|minute
op_assign
id|p
(braket
l_int|4
)braket
suffix:semicolon
id|second
op_assign
id|p
(braket
l_int|5
)braket
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_eq
l_int|0
)paren
id|tz
op_assign
id|p
(braket
l_int|6
)braket
suffix:semicolon
multiline_comment|/* High sierra has no time zone */
r_else
id|tz
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|year
OL
l_int|0
)paren
(brace
id|crtime
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_int
id|monlen
(braket
l_int|12
)braket
op_assign
(brace
l_int|31
comma
l_int|28
comma
l_int|31
comma
l_int|30
comma
l_int|31
comma
l_int|30
comma
l_int|31
comma
l_int|31
comma
l_int|30
comma
l_int|31
comma
l_int|30
comma
l_int|31
)brace
suffix:semicolon
id|days
op_assign
id|year
op_star
l_int|365
suffix:semicolon
r_if
c_cond
(paren
id|year
OG
l_int|2
)paren
id|days
op_add_assign
(paren
id|year
op_plus
l_int|1
)paren
op_div
l_int|4
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|month
suffix:semicolon
id|i
op_increment
)paren
id|days
op_add_assign
id|monlen
(braket
id|i
op_minus
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|year
op_plus
l_int|2
)paren
op_mod
l_int|4
)paren
op_eq
l_int|0
op_logical_and
id|month
OG
l_int|2
)paren
id|days
op_increment
suffix:semicolon
id|days
op_add_assign
id|day
op_minus
l_int|1
suffix:semicolon
id|crtime
op_assign
(paren
(paren
(paren
(paren
id|days
op_star
l_int|24
)paren
op_plus
id|hour
)paren
op_star
l_int|60
op_plus
id|minute
)paren
op_star
l_int|60
)paren
op_plus
id|second
suffix:semicolon
multiline_comment|/* sign extend */
r_if
c_cond
(paren
id|tz
op_amp
l_int|0x80
)paren
id|tz
op_or_assign
(paren
op_minus
l_int|1
op_lshift
l_int|8
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t; * The timezone offset is unreliable on some disks,&n;&t;&t; * so we make a sanity check.  In no case is it ever&n;&t;&t; * more than 13 hours from GMT, which is 52*15min.&n;&t;&t; * The time is always stored in localtime with the&n;&t;&t; * timezone offset being what get added to GMT to&n;&t;&t; * get to localtime.  Thus we need to subtract the offset&n;&t;&t; * to get to true GMT, which is what we store the time&n;&t;&t; * as internally.  On the local system, the user may set&n;&t;&t; * their timezone any way they wish, of course, so GMT&n;&t;&t; * gets converted back to localtime on the receiving&n;&t;&t; * system.&n;&t;&t; *&n;&t;&t; * NOTE: mkisofs in versions prior to mkisofs-1.10 had&n;&t;&t; * the sign wrong on the timezone offset.  This has now&n;&t;&t; * been corrected there too, but if you are getting screwy&n;&t;&t; * results this may be the explanation.  If enough people&n;&t;&t; * complain, a user configuration option could be added&n;&t;&t; * to add the timezone offset in with the wrong sign&n;&t;&t; * for &squot;compatibility&squot; with older discs, but I cannot see how&n;&t;&t; * it will matter that much.&n;&t;&t; *&n;&t;&t; * Thanks to kuhlmav@elec.canterbury.ac.nz (Volker Kuhlmann)&n;&t;&t; * for pointing out the sign error.&n;&t;&t; */
r_if
c_cond
(paren
op_minus
l_int|52
op_le
id|tz
op_logical_and
id|tz
op_le
l_int|52
)paren
id|crtime
op_sub_assign
id|tz
op_star
l_int|15
op_star
l_int|60
suffix:semicolon
)brace
r_return
id|crtime
suffix:semicolon
)brace
eof
