multiline_comment|/*&n; *  linux/fs/binfmt_script.c&n; *&n; *  Copyright (C) 1996  Martin von L&#xfffd;wis&n; *  original #!-checking implemented by tytso.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/binfmts.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/file.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
DECL|function|load_script
r_static
r_int
id|load_script
c_func
(paren
r_struct
id|linux_binprm
op_star
id|bprm
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_char
op_star
id|cp
comma
op_star
id|i_name
comma
op_star
id|i_arg
suffix:semicolon
r_struct
id|file
op_star
id|file
suffix:semicolon
r_char
id|interp
(braket
id|BINPRM_BUF_SIZE
)braket
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_if
c_cond
(paren
(paren
id|bprm-&gt;buf
(braket
l_int|0
)braket
op_ne
l_char|&squot;#&squot;
)paren
op_logical_or
(paren
id|bprm-&gt;buf
(braket
l_int|1
)braket
op_ne
l_char|&squot;!&squot;
)paren
op_logical_or
(paren
id|bprm-&gt;sh_bang
)paren
)paren
r_return
op_minus
id|ENOEXEC
suffix:semicolon
multiline_comment|/*&n;&t; * This section does the #! interpretation.&n;&t; * Sorta complicated, but hopefully it will work.  -TYT&n;&t; */
id|bprm-&gt;sh_bang
op_increment
suffix:semicolon
id|allow_write_access
c_func
(paren
id|bprm-&gt;file
)paren
suffix:semicolon
id|fput
c_func
(paren
id|bprm-&gt;file
)paren
suffix:semicolon
id|bprm-&gt;file
op_assign
l_int|NULL
suffix:semicolon
id|bprm-&gt;buf
(braket
id|BINPRM_BUF_SIZE
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cp
op_assign
id|strchr
c_func
(paren
id|bprm-&gt;buf
comma
l_char|&squot;&bslash;n&squot;
)paren
)paren
op_eq
l_int|NULL
)paren
id|cp
op_assign
id|bprm-&gt;buf
op_plus
id|BINPRM_BUF_SIZE
op_minus
l_int|1
suffix:semicolon
op_star
id|cp
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_while
c_loop
(paren
id|cp
OG
id|bprm-&gt;buf
)paren
(brace
id|cp
op_decrement
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|cp
op_eq
l_char|&squot; &squot;
)paren
op_logical_or
(paren
op_star
id|cp
op_eq
l_char|&squot;&bslash;t&squot;
)paren
)paren
op_star
id|cp
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_else
r_break
suffix:semicolon
)brace
r_for
c_loop
(paren
id|cp
op_assign
id|bprm-&gt;buf
op_plus
l_int|2
suffix:semicolon
(paren
op_star
id|cp
op_eq
l_char|&squot; &squot;
)paren
op_logical_or
(paren
op_star
id|cp
op_eq
l_char|&squot;&bslash;t&squot;
)paren
suffix:semicolon
id|cp
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|cp
op_eq
l_char|&squot;&bslash;0&squot;
)paren
r_return
op_minus
id|ENOEXEC
suffix:semicolon
multiline_comment|/* No interpreter name found */
id|i_name
op_assign
id|cp
suffix:semicolon
id|i_arg
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
op_star
id|cp
op_logical_and
(paren
op_star
id|cp
op_ne
l_char|&squot; &squot;
)paren
op_logical_and
(paren
op_star
id|cp
op_ne
l_char|&squot;&bslash;t&squot;
)paren
suffix:semicolon
id|cp
op_increment
)paren
multiline_comment|/* nothing */
suffix:semicolon
r_while
c_loop
(paren
(paren
op_star
id|cp
op_eq
l_char|&squot; &squot;
)paren
op_logical_or
(paren
op_star
id|cp
op_eq
l_char|&squot;&bslash;t&squot;
)paren
)paren
op_star
id|cp
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
op_star
id|cp
)paren
id|i_arg
op_assign
id|cp
suffix:semicolon
id|strcpy
(paren
id|interp
comma
id|i_name
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * OK, we&squot;ve parsed out the interpreter name and&n;&t; * (optional) argument.&n;&t; * Splice in (1) the interpreter&squot;s name for argv[0]&n;&t; *           (2) (optional) argument to interpreter&n;&t; *           (3) filename of shell script (replace argv[0])&n;&t; *&n;&t; * This is done in reverse order, because of how the&n;&t; * user environment and arguments are stored.&n;&t; */
id|remove_arg_zero
c_func
(paren
id|bprm
)paren
suffix:semicolon
id|retval
op_assign
id|copy_strings_kernel
c_func
(paren
l_int|1
comma
op_amp
id|bprm-&gt;filename
comma
id|bprm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
r_return
id|retval
suffix:semicolon
id|bprm-&gt;argc
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i_arg
)paren
(brace
id|retval
op_assign
id|copy_strings_kernel
c_func
(paren
l_int|1
comma
op_amp
id|i_arg
comma
id|bprm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
r_return
id|retval
suffix:semicolon
id|bprm-&gt;argc
op_increment
suffix:semicolon
)brace
id|retval
op_assign
id|copy_strings_kernel
c_func
(paren
l_int|1
comma
op_amp
id|i_name
comma
id|bprm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
id|retval
suffix:semicolon
id|bprm-&gt;argc
op_increment
suffix:semicolon
multiline_comment|/*&n;&t; * OK, now restart the process with the interpreter&squot;s dentry.&n;&t; */
id|file
op_assign
id|open_exec
c_func
(paren
id|interp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|file
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|file
)paren
suffix:semicolon
id|bprm-&gt;file
op_assign
id|file
suffix:semicolon
id|retval
op_assign
id|prepare_binprm
c_func
(paren
id|bprm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
r_return
id|retval
suffix:semicolon
r_return
id|search_binary_handler
c_func
(paren
id|bprm
comma
id|regs
)paren
suffix:semicolon
)brace
DECL|variable|script_format
r_struct
id|linux_binfmt
id|script_format
op_assign
(brace
l_int|NULL
comma
id|THIS_MODULE
comma
id|load_script
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|0
)brace
suffix:semicolon
DECL|function|init_script_binfmt
r_static
r_int
id|__init
id|init_script_binfmt
c_func
(paren
r_void
)paren
(brace
r_return
id|register_binfmt
c_func
(paren
op_amp
id|script_format
)paren
suffix:semicolon
)brace
DECL|function|exit_script_binfmt
r_static
r_void
id|__exit
id|exit_script_binfmt
c_func
(paren
r_void
)paren
(brace
id|unregister_binfmt
c_func
(paren
op_amp
id|script_format
)paren
suffix:semicolon
)brace
id|module_init
c_func
(paren
id|init_script_binfmt
)paren
id|module_exit
c_func
(paren
id|exit_script_binfmt
)paren
eof
