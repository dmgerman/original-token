multiline_comment|/*&n; *  linux/fs/read_write.c&n; *&n; *  (C) 1991  Linus Torvalds&n; */
macro_line|#include &lt;sys/stat.h&gt;
macro_line|#include &lt;errno.h&gt;
macro_line|#include &lt;sys/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
r_extern
r_int
id|rw_char
c_func
(paren
r_int
id|rw
comma
r_int
id|dev
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|off_t
op_star
id|pos
)paren
suffix:semicolon
r_extern
r_int
id|read_pipe
c_func
(paren
r_struct
id|m_inode
op_star
id|inode
comma
r_char
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
r_extern
r_int
id|write_pipe
c_func
(paren
r_struct
id|m_inode
op_star
id|inode
comma
r_char
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
r_extern
r_int
id|block_read
c_func
(paren
r_int
id|dev
comma
id|off_t
op_star
id|pos
comma
r_char
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
r_extern
r_int
id|block_write
c_func
(paren
r_int
id|dev
comma
id|off_t
op_star
id|pos
comma
r_char
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
r_extern
r_int
id|file_read
c_func
(paren
r_struct
id|m_inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_char
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
r_extern
r_int
id|file_write
c_func
(paren
r_struct
id|m_inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_char
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
DECL|function|sys_lseek
r_int
id|sys_lseek
c_func
(paren
r_int
r_int
id|fd
comma
id|off_t
id|offset
comma
r_int
id|origin
)paren
(brace
r_struct
id|file
op_star
id|file
suffix:semicolon
r_int
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|fd
op_ge
id|NR_OPEN
op_logical_or
op_logical_neg
(paren
id|file
op_assign
id|current-&gt;filp
(braket
id|fd
)braket
)paren
op_logical_or
op_logical_neg
(paren
id|file-&gt;f_inode
)paren
op_logical_or
op_logical_neg
id|IS_SEEKABLE
c_func
(paren
id|MAJOR
c_func
(paren
id|file-&gt;f_inode-&gt;i_dev
)paren
)paren
)paren
r_return
op_minus
id|EBADF
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_inode-&gt;i_pipe
)paren
r_return
op_minus
id|ESPIPE
suffix:semicolon
r_switch
c_cond
(paren
id|origin
)paren
(brace
r_case
l_int|0
suffix:colon
r_if
c_cond
(paren
id|offset
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|file-&gt;f_pos
op_assign
id|offset
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
r_if
c_cond
(paren
id|file-&gt;f_pos
op_plus
id|offset
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|file-&gt;f_pos
op_add_assign
id|offset
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
r_if
c_cond
(paren
(paren
id|tmp
op_assign
id|file-&gt;f_inode-&gt;i_size
op_plus
id|offset
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|file-&gt;f_pos
op_assign
id|tmp
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|file-&gt;f_pos
suffix:semicolon
)brace
DECL|function|sys_read
r_int
id|sys_read
c_func
(paren
r_int
r_int
id|fd
comma
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|file
op_star
id|file
suffix:semicolon
r_struct
id|m_inode
op_star
id|inode
suffix:semicolon
r_if
c_cond
(paren
id|fd
op_ge
id|NR_OPEN
op_logical_or
id|count
OL
l_int|0
op_logical_or
op_logical_neg
(paren
id|file
op_assign
id|current-&gt;filp
(braket
id|fd
)braket
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|count
)paren
r_return
l_int|0
suffix:semicolon
id|verify_area
c_func
(paren
id|buf
comma
id|count
)paren
suffix:semicolon
id|inode
op_assign
id|file-&gt;f_inode
suffix:semicolon
r_if
c_cond
(paren
id|inode-&gt;i_pipe
)paren
r_return
(paren
id|file-&gt;f_mode
op_amp
l_int|1
)paren
ques
c_cond
id|read_pipe
c_func
(paren
id|inode
comma
id|buf
comma
id|count
)paren
suffix:colon
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|S_ISCHR
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
r_return
id|rw_char
c_func
(paren
id|READ
comma
id|inode-&gt;i_zone
(braket
l_int|0
)braket
comma
id|buf
comma
id|count
comma
op_amp
id|file-&gt;f_pos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|S_ISBLK
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
r_return
id|block_read
c_func
(paren
id|inode-&gt;i_zone
(braket
l_int|0
)braket
comma
op_amp
id|file-&gt;f_pos
comma
id|buf
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|inode-&gt;i_mode
)paren
op_logical_or
id|S_ISREG
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
(brace
r_if
c_cond
(paren
id|count
op_plus
id|file-&gt;f_pos
OG
id|inode-&gt;i_size
)paren
id|count
op_assign
id|inode-&gt;i_size
op_minus
id|file-&gt;f_pos
suffix:semicolon
r_if
c_cond
(paren
id|count
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_return
id|file_read
c_func
(paren
id|inode
comma
id|file
comma
id|buf
comma
id|count
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;(Read)inode-&gt;i_mode=%06o&bslash;n&bslash;r&quot;
comma
id|inode-&gt;i_mode
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|sys_write
r_int
id|sys_write
c_func
(paren
r_int
r_int
id|fd
comma
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|file
op_star
id|file
suffix:semicolon
r_struct
id|m_inode
op_star
id|inode
suffix:semicolon
r_if
c_cond
(paren
id|fd
op_ge
id|NR_OPEN
op_logical_or
id|count
OL
l_int|0
op_logical_or
op_logical_neg
(paren
id|file
op_assign
id|current-&gt;filp
(braket
id|fd
)braket
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|count
)paren
r_return
l_int|0
suffix:semicolon
id|inode
op_assign
id|file-&gt;f_inode
suffix:semicolon
r_if
c_cond
(paren
id|inode-&gt;i_pipe
)paren
r_return
(paren
id|file-&gt;f_mode
op_amp
l_int|2
)paren
ques
c_cond
id|write_pipe
c_func
(paren
id|inode
comma
id|buf
comma
id|count
)paren
suffix:colon
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|S_ISCHR
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
r_return
id|rw_char
c_func
(paren
id|WRITE
comma
id|inode-&gt;i_zone
(braket
l_int|0
)braket
comma
id|buf
comma
id|count
comma
op_amp
id|file-&gt;f_pos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|S_ISBLK
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
r_return
id|block_write
c_func
(paren
id|inode-&gt;i_zone
(braket
l_int|0
)braket
comma
op_amp
id|file-&gt;f_pos
comma
id|buf
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|S_ISREG
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
r_return
id|file_write
c_func
(paren
id|inode
comma
id|file
comma
id|buf
comma
id|count
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(Write)inode-&gt;i_mode=%06o&bslash;n&bslash;r&quot;
comma
id|inode-&gt;i_mode
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
eof
