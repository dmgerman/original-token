multiline_comment|/*&n; *  linux/fs/read_write.c&n; *&n; *  Copyright (C) 1991, 1992  Linus Torvalds&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
multiline_comment|/*&n; * Count is not yet used: but we&squot;ll probably support reading several entries&n; * at once in the future. Use count=1 in the library for future expansions.&n; */
DECL|function|sys_readdir
id|asmlinkage
r_int
id|sys_readdir
c_func
(paren
r_int
r_int
id|fd
comma
r_struct
id|dirent
op_star
id|dirent
comma
r_int
r_int
id|count
)paren
(brace
r_int
id|error
suffix:semicolon
r_struct
id|file
op_star
id|file
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_if
c_cond
(paren
id|fd
op_ge
id|NR_OPEN
op_logical_or
op_logical_neg
(paren
id|file
op_assign
id|current-&gt;files-&gt;fd
(braket
id|fd
)braket
)paren
op_logical_or
op_logical_neg
(paren
id|inode
op_assign
id|file-&gt;f_inode
)paren
)paren
r_return
op_minus
id|EBADF
suffix:semicolon
id|error
op_assign
op_minus
id|ENOTDIR
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_op
op_logical_and
id|file-&gt;f_op-&gt;readdir
)paren
(brace
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|dirent
comma
r_sizeof
(paren
op_star
id|dirent
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
id|error
op_assign
id|file-&gt;f_op
op_member_access_from_pointer
id|readdir
c_func
(paren
id|inode
comma
id|file
comma
id|dirent
comma
id|count
)paren
suffix:semicolon
)brace
r_return
id|error
suffix:semicolon
)brace
DECL|function|sys_lseek
id|asmlinkage
r_int
id|sys_lseek
c_func
(paren
r_int
r_int
id|fd
comma
id|off_t
id|offset
comma
r_int
r_int
id|origin
)paren
(brace
r_struct
id|file
op_star
id|file
suffix:semicolon
r_int
id|tmp
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|fd
op_ge
id|NR_OPEN
op_logical_or
op_logical_neg
(paren
id|file
op_assign
id|current-&gt;files-&gt;fd
(braket
id|fd
)braket
)paren
op_logical_or
op_logical_neg
(paren
id|file-&gt;f_inode
)paren
)paren
r_return
op_minus
id|EBADF
suffix:semicolon
r_if
c_cond
(paren
id|origin
OG
l_int|2
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_op
op_logical_and
id|file-&gt;f_op-&gt;lseek
)paren
r_return
id|file-&gt;f_op
op_member_access_from_pointer
id|lseek
c_func
(paren
id|file-&gt;f_inode
comma
id|file
comma
id|offset
comma
id|origin
)paren
suffix:semicolon
multiline_comment|/* this is the default handler if no lseek handler is present */
r_switch
c_cond
(paren
id|origin
)paren
(brace
r_case
l_int|0
suffix:colon
id|tmp
op_assign
id|offset
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|tmp
op_assign
id|file-&gt;f_pos
op_plus
id|offset
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|file-&gt;f_inode
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|tmp
op_assign
id|file-&gt;f_inode-&gt;i_size
op_plus
id|offset
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tmp
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|file-&gt;f_pos
op_assign
id|tmp
suffix:semicolon
id|file-&gt;f_reada
op_assign
l_int|0
suffix:semicolon
r_return
id|file-&gt;f_pos
suffix:semicolon
)brace
DECL|function|sys_llseek
id|asmlinkage
r_int
id|sys_llseek
c_func
(paren
r_int
r_int
id|fd
comma
r_int
r_int
id|offset_high
comma
r_int
r_int
id|offset_low
comma
id|loff_t
op_star
id|result
comma
r_int
r_int
id|origin
)paren
(brace
r_struct
id|file
op_star
id|file
suffix:semicolon
id|loff_t
id|tmp
op_assign
op_minus
l_int|1
suffix:semicolon
id|loff_t
id|offset
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|fd
op_ge
id|NR_OPEN
op_logical_or
op_logical_neg
(paren
id|file
op_assign
id|current-&gt;files-&gt;fd
(braket
id|fd
)braket
)paren
op_logical_or
op_logical_neg
(paren
id|file-&gt;f_inode
)paren
)paren
r_return
op_minus
id|EBADF
suffix:semicolon
r_if
c_cond
(paren
id|origin
OG
l_int|2
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|result
comma
r_sizeof
(paren
id|loff_t
)paren
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
id|offset
op_assign
(paren
id|loff_t
)paren
(paren
(paren
(paren
r_int
r_int
r_int
)paren
id|offset_high
op_lshift
l_int|32
)paren
op_or
id|offset_low
)paren
suffix:semicolon
multiline_comment|/* there is no fs specific llseek handler */
r_switch
c_cond
(paren
id|origin
)paren
(brace
r_case
l_int|0
suffix:colon
id|tmp
op_assign
id|offset
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|tmp
op_assign
id|file-&gt;f_pos
op_plus
id|offset
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|file-&gt;f_inode
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|tmp
op_assign
id|file-&gt;f_inode-&gt;i_size
op_plus
id|offset
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tmp
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|file-&gt;f_pos
op_assign
id|tmp
suffix:semicolon
id|file-&gt;f_reada
op_assign
l_int|0
suffix:semicolon
id|memcpy_tofs
c_func
(paren
id|result
comma
op_amp
id|file-&gt;f_pos
comma
r_sizeof
(paren
id|loff_t
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sys_read
id|asmlinkage
r_int
id|sys_read
c_func
(paren
r_int
r_int
id|fd
comma
r_char
op_star
id|buf
comma
r_int
r_int
id|count
)paren
(brace
r_int
id|error
suffix:semicolon
r_struct
id|file
op_star
id|file
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_if
c_cond
(paren
id|fd
op_ge
id|NR_OPEN
op_logical_or
op_logical_neg
(paren
id|file
op_assign
id|current-&gt;files-&gt;fd
(braket
id|fd
)braket
)paren
op_logical_or
op_logical_neg
(paren
id|inode
op_assign
id|file-&gt;f_inode
)paren
)paren
r_return
op_minus
id|EBADF
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
l_int|1
)paren
)paren
r_return
op_minus
id|EBADF
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|file-&gt;f_op
op_logical_or
op_logical_neg
id|file-&gt;f_op-&gt;read
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|count
)paren
r_return
l_int|0
suffix:semicolon
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|buf
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
r_return
id|file-&gt;f_op
op_member_access_from_pointer
id|read
c_func
(paren
id|inode
comma
id|file
comma
id|buf
comma
id|count
)paren
suffix:semicolon
)brace
DECL|function|sys_write
id|asmlinkage
r_int
id|sys_write
c_func
(paren
r_int
r_int
id|fd
comma
r_char
op_star
id|buf
comma
r_int
r_int
id|count
)paren
(brace
r_int
id|error
suffix:semicolon
r_struct
id|file
op_star
id|file
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_int
id|written
suffix:semicolon
r_if
c_cond
(paren
id|fd
op_ge
id|NR_OPEN
op_logical_or
op_logical_neg
(paren
id|file
op_assign
id|current-&gt;files-&gt;fd
(braket
id|fd
)braket
)paren
op_logical_or
op_logical_neg
(paren
id|inode
op_assign
id|file-&gt;f_inode
)paren
)paren
r_return
op_minus
id|EBADF
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
l_int|2
)paren
)paren
r_return
op_minus
id|EBADF
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|file-&gt;f_op
op_logical_or
op_logical_neg
id|file-&gt;f_op-&gt;write
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|count
)paren
r_return
l_int|0
suffix:semicolon
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|buf
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|written
op_assign
id|file-&gt;f_op
op_member_access_from_pointer
id|write
c_func
(paren
id|inode
comma
id|file
comma
id|buf
comma
id|count
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If data has been written to the file, remove the setuid and&n;&t; * the setgid bits&n;&t; */
r_if
c_cond
(paren
id|written
OG
l_int|0
op_logical_and
op_logical_neg
id|suser
c_func
(paren
)paren
op_logical_and
(paren
id|inode-&gt;i_mode
op_amp
(paren
id|S_ISUID
op_or
id|S_ISGID
)paren
)paren
)paren
(brace
id|inode-&gt;i_mode
op_and_assign
op_complement
(paren
id|S_ISUID
op_or
id|S_ISGID
)paren
suffix:semicolon
id|notify_change
(paren
id|NOTIFY_MODE
comma
id|inode
)paren
suffix:semicolon
)brace
r_return
id|written
suffix:semicolon
)brace
eof
