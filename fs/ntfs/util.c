multiline_comment|/*&n; *  util.c&n; *  Miscellaneous support&n; *&n; *  Copyright (C) 1997,1999 Martin von L&#xfffd;wis&n; *  Copyright (C) 1997 R&#xfffd;gis Duchesne&n; *&n; *  The utf8 routines are copied from Python wstrop module.&n; */
macro_line|#include &quot;ntfstypes.h&quot;
macro_line|#include &quot;struct.h&quot;
macro_line|#include &quot;util.h&quot;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
multiline_comment|/* FreeBSD doesn&squot;t seem to have EILSEQ in errno.h */
macro_line|#ifndef EILSEQ
DECL|macro|EILSEQ
macro_line|# define EILSEQ&t;EINVAL
macro_line|#endif
macro_line|#include &quot;support.h&quot;
multiline_comment|/* Converts a single wide character to a sequence of utf8 bytes.&n; * The character is represented in host byte order.&n; * Returns the number of bytes, or 0 on error.&n; */
r_static
r_int
DECL|function|to_utf8
id|to_utf8
c_func
(paren
id|ntfs_u16
id|c
comma
r_int
r_char
op_star
id|buf
)paren
(brace
r_if
c_cond
(paren
id|c
op_eq
l_int|0
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* No support for embedded 0 runes */
r_if
c_cond
(paren
id|c
OL
l_int|0x80
)paren
(brace
r_if
c_cond
(paren
id|buf
)paren
(brace
id|buf
(braket
l_int|0
)braket
op_assign
(paren
r_int
r_char
)paren
id|c
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|c
OL
l_int|0x800
)paren
(brace
r_if
c_cond
(paren
id|buf
)paren
(brace
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0xc0
op_or
(paren
id|c
op_rshift
l_int|6
)paren
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0x80
op_or
(paren
id|c
op_amp
l_int|0x3f
)paren
suffix:semicolon
)brace
r_return
l_int|2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|c
OL
l_int|0x10000
)paren
(brace
r_if
c_cond
(paren
id|buf
)paren
(brace
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0xe0
op_or
(paren
id|c
op_rshift
l_int|12
)paren
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0x80
op_or
(paren
(paren
id|c
op_rshift
l_int|6
)paren
op_amp
l_int|0x3f
)paren
suffix:semicolon
id|buf
(braket
l_int|2
)braket
op_assign
l_int|0x80
op_or
(paren
id|c
op_amp
l_int|0x3f
)paren
suffix:semicolon
)brace
r_return
l_int|3
suffix:semicolon
)brace
multiline_comment|/* We don&squot;t support characters above 0xFFFF in NTFS */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Decodes a sequence of utf8 bytes into a single wide character.&n; * The character is returned in host byte order.&n; * Returns the number of bytes consumed, or 0 on error.&n; */
r_static
r_int
DECL|function|from_utf8
id|from_utf8
c_func
(paren
r_const
r_int
r_char
op_star
id|str
comma
id|ntfs_u16
op_star
id|c
)paren
(brace
r_int
id|l
op_assign
l_int|0
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
op_star
id|str
OL
l_int|0x80
)paren
(brace
op_star
id|c
op_assign
op_star
id|str
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|str
OL
l_int|0xc0
)paren
(brace
multiline_comment|/* lead byte must not be 10xxxxxx */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* is c0 a possible lead byte? */
r_if
c_cond
(paren
op_star
id|str
OL
l_int|0xe0
)paren
(brace
multiline_comment|/* 110xxxxx */
op_star
id|c
op_assign
op_star
id|str
op_amp
l_int|0x1f
suffix:semicolon
id|l
op_assign
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_star
id|str
OL
l_int|0xf0
)paren
(brace
multiline_comment|/* 1110xxxx */
op_star
id|c
op_assign
op_star
id|str
op_amp
l_int|0xf
suffix:semicolon
id|l
op_assign
l_int|3
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_star
id|str
OL
l_int|0xf8
)paren
(brace
multiline_comment|/* 11110xxx */
op_star
id|c
op_assign
op_star
id|str
op_amp
l_int|7
suffix:semicolon
id|l
op_assign
l_int|4
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* We don&squot;t support characters above 0xFFFF in NTFS */
r_return
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|l
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* all other bytes must be 10xxxxxx */
r_if
c_cond
(paren
(paren
id|str
(braket
id|i
)braket
op_amp
l_int|0xc0
)paren
op_ne
l_int|0x80
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
op_star
id|c
op_lshift_assign
l_int|6
suffix:semicolon
op_star
id|c
op_or_assign
id|str
(braket
id|i
)braket
op_amp
l_int|0x3f
suffix:semicolon
)brace
r_return
id|l
suffix:semicolon
)brace
multiline_comment|/* Converts wide string to UTF-8. Expects two in- and two out-parameters.&n; * Returns 0 on success, or error code. &n; * The caller has to free the result string.&n; * There is no support for UTF-16, yet&n; */
DECL|function|ntfs_dupuni2utf8
r_static
r_int
id|ntfs_dupuni2utf8
c_func
(paren
id|ntfs_u16
op_star
id|in
comma
r_int
id|in_len
comma
r_char
op_star
op_star
id|out
comma
r_int
op_star
id|out_len
)paren
(brace
r_int
id|i
comma
id|tmp
suffix:semicolon
r_int
id|len8
suffix:semicolon
r_int
r_char
op_star
id|result
suffix:semicolon
id|ntfs_debug
c_func
(paren
id|DEBUG_NAME1
comma
l_string|&quot;converting l=%d&bslash;n&quot;
comma
id|in_len
)paren
suffix:semicolon
multiline_comment|/* count the length of the resulting UTF-8 */
r_for
c_loop
(paren
id|i
op_assign
id|len8
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|in_len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tmp
op_assign
id|to_utf8
c_func
(paren
id|NTFS_GETU16
c_func
(paren
id|in
op_plus
id|i
)paren
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tmp
)paren
(brace
multiline_comment|/* invalid character */
r_return
id|EILSEQ
suffix:semicolon
)brace
id|len8
op_add_assign
id|tmp
suffix:semicolon
)brace
op_star
id|out
op_assign
id|result
op_assign
id|ntfs_malloc
c_func
(paren
id|len8
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* allow for zero-termination */
r_if
c_cond
(paren
op_logical_neg
id|result
)paren
(brace
r_return
id|ENOMEM
suffix:semicolon
)brace
id|result
(braket
id|len8
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
op_star
id|out_len
op_assign
id|len8
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|len8
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|in_len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|len8
op_add_assign
id|to_utf8
c_func
(paren
id|NTFS_GETU16
c_func
(paren
id|in
op_plus
id|i
)paren
comma
id|result
op_plus
id|len8
)paren
suffix:semicolon
)brace
id|ntfs_debug
c_func
(paren
id|DEBUG_NAME1
comma
l_string|&quot;result %p:%s&bslash;n&quot;
comma
id|result
comma
id|result
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Converts an UTF-8 sequence to a wide string. Same conventions as the&n; * previous function&n; */
DECL|function|ntfs_duputf82uni
r_static
r_int
id|ntfs_duputf82uni
c_func
(paren
r_int
r_char
op_star
id|in
comma
r_int
id|in_len
comma
id|ntfs_u16
op_star
op_star
id|out
comma
r_int
op_star
id|out_len
)paren
(brace
r_int
id|i
comma
id|tmp
suffix:semicolon
r_int
id|len16
suffix:semicolon
id|ntfs_u16
op_star
id|result
suffix:semicolon
id|ntfs_u16
id|wtmp
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|len16
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|in_len
suffix:semicolon
id|i
op_add_assign
id|tmp
comma
id|len16
op_increment
)paren
(brace
id|tmp
op_assign
id|from_utf8
c_func
(paren
id|in
op_plus
id|i
comma
op_amp
id|wtmp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tmp
)paren
(brace
r_return
id|EILSEQ
suffix:semicolon
)brace
)brace
op_star
id|out
op_assign
id|result
op_assign
id|ntfs_malloc
c_func
(paren
l_int|2
op_star
(paren
id|len16
op_plus
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|result
)paren
(brace
r_return
id|ENOMEM
suffix:semicolon
)brace
id|result
(braket
id|len16
)braket
op_assign
l_int|0
suffix:semicolon
op_star
id|out_len
op_assign
id|len16
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|len16
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|in_len
suffix:semicolon
id|i
op_add_assign
id|tmp
comma
id|len16
op_increment
)paren
(brace
id|tmp
op_assign
id|from_utf8
c_func
(paren
id|in
op_plus
id|i
comma
op_amp
id|wtmp
)paren
suffix:semicolon
id|NTFS_PUTU16
c_func
(paren
id|result
op_plus
id|len16
comma
id|wtmp
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* See above. Produces ISO-8859-1 from wide strings */
DECL|function|ntfs_dupuni288591
r_static
r_int
id|ntfs_dupuni288591
c_func
(paren
id|ntfs_u16
op_star
id|in
comma
r_int
id|in_len
comma
r_char
op_star
op_star
id|out
comma
r_int
op_star
id|out_len
)paren
(brace
r_int
id|i
suffix:semicolon
r_char
op_star
id|result
suffix:semicolon
multiline_comment|/* check for characters out of range */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|in_len
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|NTFS_GETU16
c_func
(paren
id|in
op_plus
id|i
)paren
op_ge
l_int|256
)paren
(brace
r_return
id|EILSEQ
suffix:semicolon
)brace
op_star
id|out
op_assign
id|result
op_assign
id|ntfs_malloc
c_func
(paren
id|in_len
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|result
)paren
(brace
r_return
id|ENOMEM
suffix:semicolon
)brace
id|result
(braket
id|in_len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
op_star
id|out_len
op_assign
id|in_len
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|in_len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|result
(braket
id|i
)braket
op_assign
(paren
r_int
r_char
)paren
id|NTFS_GETU16
c_func
(paren
id|in
op_plus
id|i
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* See above */
DECL|function|ntfs_dup885912uni
r_static
r_int
id|ntfs_dup885912uni
c_func
(paren
r_int
r_char
op_star
id|in
comma
r_int
id|in_len
comma
id|ntfs_u16
op_star
op_star
id|out
comma
r_int
op_star
id|out_len
)paren
(brace
r_int
id|i
suffix:semicolon
id|ntfs_u16
op_star
id|result
suffix:semicolon
op_star
id|out
op_assign
id|result
op_assign
id|ntfs_malloc
c_func
(paren
l_int|2
op_star
id|in_len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|result
)paren
(brace
r_return
id|ENOMEM
suffix:semicolon
)brace
op_star
id|out_len
op_assign
id|in_len
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|in_len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|NTFS_PUTU16
c_func
(paren
id|result
op_plus
id|i
comma
id|in
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Encodings dispatcher */
DECL|function|ntfs_encodeuni
r_int
id|ntfs_encodeuni
c_func
(paren
id|ntfs_volume
op_star
id|vol
comma
id|ntfs_u16
op_star
id|in
comma
r_int
id|in_len
comma
r_char
op_star
op_star
id|out
comma
r_int
op_star
id|out_len
)paren
(brace
r_if
c_cond
(paren
id|vol-&gt;nct
op_amp
id|nct_utf8
)paren
(brace
r_return
id|ntfs_dupuni2utf8
c_func
(paren
id|in
comma
id|in_len
comma
id|out
comma
id|out_len
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vol-&gt;nct
op_amp
id|nct_iso8859_1
)paren
(brace
r_return
id|ntfs_dupuni288591
c_func
(paren
id|in
comma
id|in_len
comma
id|out
comma
id|out_len
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vol-&gt;nct
op_amp
(paren
id|nct_map
op_or
id|nct_uni_xlate
)paren
)paren
(brace
multiline_comment|/* uni_xlate is handled inside map */
r_return
id|ntfs_dupuni2map
c_func
(paren
id|vol
comma
id|in
comma
id|in_len
comma
id|out
comma
id|out_len
)paren
suffix:semicolon
)brace
r_else
r_return
id|EINVAL
suffix:semicolon
multiline_comment|/* unknown encoding */
)brace
DECL|function|ntfs_decodeuni
r_int
id|ntfs_decodeuni
c_func
(paren
id|ntfs_volume
op_star
id|vol
comma
r_char
op_star
id|in
comma
r_int
id|in_len
comma
id|ntfs_u16
op_star
op_star
id|out
comma
r_int
op_star
id|out_len
)paren
(brace
r_if
c_cond
(paren
id|vol-&gt;nct
op_amp
id|nct_utf8
)paren
(brace
r_return
id|ntfs_duputf82uni
c_func
(paren
id|in
comma
id|in_len
comma
id|out
comma
id|out_len
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vol-&gt;nct
op_amp
id|nct_iso8859_1
)paren
(brace
r_return
id|ntfs_dup885912uni
c_func
(paren
id|in
comma
id|in_len
comma
id|out
comma
id|out_len
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vol-&gt;nct
op_amp
(paren
id|nct_map
op_or
id|nct_uni_xlate
)paren
)paren
(brace
r_return
id|ntfs_dupmap2uni
c_func
(paren
id|vol
comma
id|in
comma
id|in_len
comma
id|out
comma
id|out_len
)paren
suffix:semicolon
)brace
r_else
r_return
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Same address space copies */
DECL|function|ntfs_put
r_void
id|ntfs_put
c_func
(paren
id|ntfs_io
op_star
id|dest
comma
r_void
op_star
id|src
comma
id|ntfs_size_t
id|n
)paren
(brace
id|ntfs_memcpy
c_func
(paren
id|dest-&gt;param
comma
id|src
comma
id|n
)paren
suffix:semicolon
(paren
(paren
r_char
op_star
)paren
id|dest-&gt;param
)paren
op_add_assign
id|n
suffix:semicolon
)brace
DECL|function|ntfs_get
r_void
id|ntfs_get
c_func
(paren
r_void
op_star
id|dest
comma
id|ntfs_io
op_star
id|src
comma
id|ntfs_size_t
id|n
)paren
(brace
id|ntfs_memcpy
c_func
(paren
id|dest
comma
id|src-&gt;param
comma
id|n
)paren
suffix:semicolon
(paren
(paren
r_char
op_star
)paren
id|src-&gt;param
)paren
op_add_assign
id|n
suffix:semicolon
)brace
DECL|function|ntfs_calloc
r_void
op_star
id|ntfs_calloc
c_func
(paren
r_int
id|size
)paren
(brace
r_void
op_star
id|result
op_assign
id|ntfs_malloc
c_func
(paren
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|ntfs_bzero
c_func
(paren
id|result
comma
id|size
)paren
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/* copy len unicode characters from from to to :) */
r_void
id|ntfs_uni2ascii
c_func
(paren
r_char
op_star
id|to
comma
r_char
op_star
id|from
comma
r_int
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|to
(braket
id|i
)braket
op_assign
id|from
(braket
l_int|2
op_star
id|i
)braket
suffix:semicolon
)brace
id|to
(braket
id|i
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* copy len asci characters from from to to :) */
DECL|function|ntfs_ascii2uni
r_void
id|ntfs_ascii2uni
c_func
(paren
r_int
r_int
op_star
id|to
comma
r_char
op_star
id|from
comma
r_int
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|to
(braket
id|i
)braket
op_assign
id|from
(braket
id|i
)braket
suffix:semicolon
)brace
id|to
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* strncmp for Unicode strings */
DECL|function|ntfs_uni_strncmp
r_int
id|ntfs_uni_strncmp
c_func
(paren
r_int
r_int
op_star
id|a
comma
r_int
r_int
op_star
id|b
comma
r_int
id|n
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|a
(braket
id|i
)braket
OL
id|b
(braket
id|i
)braket
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|b
(braket
id|i
)braket
OL
id|a
(braket
id|i
)braket
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|a
(braket
id|i
)braket
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* strncmp between Unicode and ASCII strings */
DECL|function|ntfs_ua_strncmp
r_int
id|ntfs_ua_strncmp
c_func
(paren
r_int
r_int
op_star
id|a
comma
r_char
op_star
id|b
comma
r_int
id|n
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|NTFS_GETU16
c_func
(paren
id|a
op_plus
id|i
)paren
OL
id|b
(braket
id|i
)braket
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|b
(braket
id|i
)braket
OL
id|NTFS_GETU16
c_func
(paren
id|a
op_plus
id|i
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|b
(braket
id|i
)braket
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Convert the NT UTC (based 1.1.1601, in hundred nanosecond units)&n; * into Unix UTC (based 1.1.1970, in seconds)&n; */
DECL|function|ntfs_ntutc2unixutc
id|ntfs_time_t
id|ntfs_ntutc2unixutc
c_func
(paren
id|ntfs_time64_t
id|ntutc
)paren
(brace
multiline_comment|/*&n; * This is very gross because&n; * 1: We must do 64-bit division on a 32-bit machine&n; * 2: We can&squot;t use libgcc for long long operations in the kernel&n; * 3: Floating point math in the kernel would corrupt user data&n; */
r_const
r_int
r_int
id|D
op_assign
l_int|10000000
suffix:semicolon
r_int
r_int
id|H
op_assign
(paren
r_int
r_int
)paren
(paren
id|ntutc
op_rshift
l_int|32
)paren
suffix:semicolon
r_int
r_int
id|L
op_assign
(paren
r_int
r_int
)paren
id|ntutc
suffix:semicolon
r_int
r_int
id|numerator2
suffix:semicolon
r_int
r_int
id|lowseconds
suffix:semicolon
r_int
r_int
id|result
suffix:semicolon
multiline_comment|/* It is best to subtract 0x019db1ded53e8000 first. */
multiline_comment|/* Then the 1601-based date becomes a 1970-based date. */
r_if
c_cond
(paren
id|L
OL
(paren
r_int
)paren
l_int|0xd53e8000
)paren
(brace
id|H
op_decrement
suffix:semicolon
)brace
id|L
op_sub_assign
(paren
r_int
)paren
l_int|0xd53e8000
suffix:semicolon
id|H
op_sub_assign
(paren
r_int
)paren
l_int|0x019db1de
suffix:semicolon
multiline_comment|/*&n;&t; * Now divide 64-bit numbers on a 32-bit machine :-)&n;&t; * With the subtraction already done, the result fits in 32 bits.&n;&t; * The numerator fits in 56 bits and the denominator fits&n;&t; * in 24 bits, so we can shift by 8 bits to make this work.&n;&t; */
id|numerator2
op_assign
(paren
id|H
op_lshift
l_int|8
)paren
op_or
(paren
id|L
op_rshift
l_int|24
)paren
suffix:semicolon
id|result
op_assign
(paren
id|numerator2
op_div
id|D
)paren
suffix:semicolon
multiline_comment|/* shifted 24 right!! */
id|lowseconds
op_assign
id|result
op_lshift
l_int|24
suffix:semicolon
id|numerator2
op_assign
(paren
(paren
id|numerator2
op_minus
id|result
op_star
id|D
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|L
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|result
op_assign
(paren
id|numerator2
op_div
id|D
)paren
suffix:semicolon
multiline_comment|/* shifted 16 right!! */
id|lowseconds
op_or_assign
id|result
op_lshift
l_int|16
suffix:semicolon
id|numerator2
op_assign
(paren
(paren
id|numerator2
op_minus
id|result
op_star
id|D
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|L
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|result
op_assign
(paren
id|numerator2
op_div
id|D
)paren
suffix:semicolon
multiline_comment|/* shifted 8 right!! */
id|lowseconds
op_or_assign
id|result
op_lshift
l_int|8
suffix:semicolon
id|numerator2
op_assign
(paren
(paren
id|numerator2
op_minus
id|result
op_star
id|D
)paren
op_lshift
l_int|8
)paren
op_or
(paren
id|L
op_amp
l_int|0xff
)paren
suffix:semicolon
id|result
op_assign
(paren
id|numerator2
op_div
id|D
)paren
suffix:semicolon
multiline_comment|/* not shifted */
id|lowseconds
op_or_assign
id|result
suffix:semicolon
r_return
id|lowseconds
suffix:semicolon
)brace
multiline_comment|/* Convert the Unix UTC into NT UTC */
DECL|function|ntfs_unixutc2ntutc
id|ntfs_time64_t
id|ntfs_unixutc2ntutc
c_func
(paren
id|ntfs_time_t
id|t
)paren
(brace
r_return
(paren
(paren
id|t
op_plus
(paren
id|ntfs_time64_t
)paren
(paren
l_int|369
op_star
l_int|365
op_plus
l_int|89
)paren
op_star
l_int|24
op_star
l_int|3600
)paren
op_star
l_int|10000000
)paren
suffix:semicolon
)brace
multiline_comment|/* Fill index name. */
r_void
DECL|function|ntfs_indexname
id|ntfs_indexname
c_func
(paren
r_char
op_star
id|buf
comma
r_int
id|type
)paren
(brace
r_char
id|hex
(braket
)braket
op_assign
l_string|&quot;0123456789ABCDEF&quot;
suffix:semicolon
r_int
id|index
suffix:semicolon
op_star
id|buf
op_increment
op_assign
l_char|&squot;$&squot;
suffix:semicolon
op_star
id|buf
op_increment
op_assign
l_char|&squot;I&squot;
suffix:semicolon
r_for
c_loop
(paren
id|index
op_assign
l_int|24
suffix:semicolon
id|index
OG
l_int|0
suffix:semicolon
id|index
op_sub_assign
l_int|4
)paren
r_if
c_cond
(paren
(paren
l_int|0xF
op_lshift
id|index
)paren
op_amp
id|type
)paren
(brace
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|index
op_ge
l_int|0
)paren
(brace
op_star
id|buf
op_increment
op_assign
id|hex
(braket
(paren
id|type
op_rshift
id|index
)paren
op_amp
l_int|0xF
)braket
suffix:semicolon
id|index
op_sub_assign
l_int|4
suffix:semicolon
)brace
op_star
id|buf
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
multiline_comment|/*&n; * Local variables:&n; * c-file-style: &quot;linux&quot;&n; * End:&n; */
eof
