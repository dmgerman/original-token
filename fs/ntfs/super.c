multiline_comment|/*&n; *  super.c&n; *&n; *  Copyright (C) 1995-1997, 1999 Martin von L&#xfffd;wis&n; *  Copyright (C) 1996-1997 R&#xfffd;gis Duchesne&n; *  Copyright (C) 1999 Steve Dodd&n; *  Copyright (C) 2000 Anton Altparmakov&n; */
macro_line|#include &quot;ntfstypes.h&quot;
macro_line|#include &quot;struct.h&quot;
macro_line|#include &quot;super.h&quot;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &quot;macros.h&quot;
macro_line|#include &quot;inode.h&quot;
macro_line|#include &quot;support.h&quot;
macro_line|#include &quot;util.h&quot;
multiline_comment|/*&n; * All important structures in NTFS use 2 consistency checks :&n; * . a magic structure identifier (FILE, INDX, RSTR, RCRD...)&n; * . a fixup technique : the last word of each sector (called a fixup) of a&n; *   structure&squot;s record should end with the word at offset &lt;n&gt; of the first&n; *   sector, and if it is the case, must be replaced with the words following&n; *   &lt;n&gt;. The value of &lt;n&gt; and the number of fixups is taken from the fields&n; *   at the offsets 4 and 6.&n; *&n; * This function perform these 2 checks, and _fails_ if :&n; * . the magic identifier is wrong&n; * . the size is given and does not match the number of sectors&n; * . a fixup is invalid&n; */
DECL|function|ntfs_fixup_record
r_int
id|ntfs_fixup_record
c_func
(paren
id|ntfs_volume
op_star
id|vol
comma
r_char
op_star
id|record
comma
r_char
op_star
id|magic
comma
r_int
id|size
)paren
(brace
r_int
id|start
comma
id|count
comma
id|offset
suffix:semicolon
id|ntfs_u16
id|fixup
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_MAGIC
c_func
(paren
id|record
comma
id|magic
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|start
op_assign
id|NTFS_GETU16
c_func
(paren
id|record
op_plus
l_int|4
)paren
suffix:semicolon
id|count
op_assign
id|NTFS_GETU16
c_func
(paren
id|record
op_plus
l_int|6
)paren
suffix:semicolon
id|count
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|size
op_logical_and
id|vol-&gt;blocksize
op_star
id|count
op_ne
id|size
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|fixup
op_assign
id|NTFS_GETU16
c_func
(paren
id|record
op_plus
id|start
)paren
suffix:semicolon
id|start
op_add_assign
l_int|2
suffix:semicolon
id|offset
op_assign
id|vol-&gt;blocksize
op_minus
l_int|2
suffix:semicolon
r_while
c_loop
(paren
id|count
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|NTFS_GETU16
c_func
(paren
id|record
op_plus
id|offset
)paren
op_ne
id|fixup
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|NTFS_PUTU16
c_func
(paren
id|record
op_plus
id|offset
comma
id|NTFS_GETU16
c_func
(paren
id|record
op_plus
id|start
)paren
)paren
suffix:semicolon
id|start
op_add_assign
l_int|2
suffix:semicolon
id|offset
op_add_assign
id|vol-&gt;blocksize
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Get vital informations about the ntfs partition from the boot sector */
DECL|function|ntfs_init_volume
r_int
id|ntfs_init_volume
c_func
(paren
id|ntfs_volume
op_star
id|vol
comma
r_char
op_star
id|boot
)paren
(brace
multiline_comment|/* Historical default values, in case we don&squot;t load $AttrDef */
id|vol-&gt;at_standard_information
op_assign
l_int|0x10
suffix:semicolon
id|vol-&gt;at_attribute_list
op_assign
l_int|0x20
suffix:semicolon
id|vol-&gt;at_file_name
op_assign
l_int|0x30
suffix:semicolon
id|vol-&gt;at_volume_version
op_assign
l_int|0x40
suffix:semicolon
id|vol-&gt;at_security_descriptor
op_assign
l_int|0x50
suffix:semicolon
id|vol-&gt;at_volume_name
op_assign
l_int|0x60
suffix:semicolon
id|vol-&gt;at_volume_information
op_assign
l_int|0x70
suffix:semicolon
id|vol-&gt;at_data
op_assign
l_int|0x80
suffix:semicolon
id|vol-&gt;at_index_root
op_assign
l_int|0x90
suffix:semicolon
id|vol-&gt;at_index_allocation
op_assign
l_int|0xA0
suffix:semicolon
id|vol-&gt;at_bitmap
op_assign
l_int|0xB0
suffix:semicolon
id|vol-&gt;at_symlink
op_assign
l_int|0xC0
suffix:semicolon
multiline_comment|/* Sector size */
id|vol-&gt;blocksize
op_assign
id|NTFS_GETU16
c_func
(paren
id|boot
op_plus
l_int|0xB
)paren
suffix:semicolon
id|vol-&gt;clusterfactor
op_assign
id|NTFS_GETU8
c_func
(paren
id|boot
op_plus
l_int|0xD
)paren
suffix:semicolon
id|vol-&gt;mft_clusters_per_record
op_assign
id|NTFS_GETS8
c_func
(paren
id|boot
op_plus
l_int|0x40
)paren
suffix:semicolon
id|vol-&gt;index_clusters_per_record
op_assign
id|NTFS_GETS8
c_func
(paren
id|boot
op_plus
l_int|0x44
)paren
suffix:semicolon
multiline_comment|/* Just some consistency checks */
r_if
c_cond
(paren
id|NTFS_GETU32
c_func
(paren
id|boot
op_plus
l_int|0x40
)paren
OG
l_int|256
)paren
(brace
id|ntfs_error
c_func
(paren
l_string|&quot;Unexpected data #1 in boot block&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|NTFS_GETU32
c_func
(paren
id|boot
op_plus
l_int|0x44
)paren
OG
l_int|256
)paren
(brace
id|ntfs_error
c_func
(paren
l_string|&quot;Unexpected data #2 in boot block&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vol-&gt;index_clusters_per_record
OL
l_int|0
)paren
(brace
id|ntfs_error
c_func
(paren
l_string|&quot;Unexpected data #3 in boot block&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* If this really means a fraction, setting it to 1&n;&t;&t;   should be safe. */
id|vol-&gt;index_clusters_per_record
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* in some cases, 0xF6 meant 1024 bytes. Other strange values have not&n;&t;   been observed */
r_if
c_cond
(paren
id|vol-&gt;mft_clusters_per_record
OL
l_int|0
op_logical_and
id|vol-&gt;mft_clusters_per_record
op_ne
op_minus
l_int|10
)paren
(brace
id|ntfs_error
c_func
(paren
l_string|&quot;Unexpected data #4 in boot block&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|vol-&gt;clustersize
op_assign
id|vol-&gt;blocksize
op_star
id|vol-&gt;clusterfactor
suffix:semicolon
r_if
c_cond
(paren
id|vol-&gt;mft_clusters_per_record
OG
l_int|0
)paren
(brace
id|vol-&gt;mft_recordsize
op_assign
id|vol-&gt;clustersize
op_star
id|vol-&gt;mft_clusters_per_record
suffix:semicolon
)brace
r_else
id|vol-&gt;mft_recordsize
op_assign
l_int|1
op_lshift
(paren
op_minus
id|vol-&gt;mft_clusters_per_record
)paren
suffix:semicolon
id|vol-&gt;index_recordsize
op_assign
id|vol-&gt;clustersize
op_star
id|vol-&gt;index_clusters_per_record
suffix:semicolon
multiline_comment|/* FIXME: long long value */
id|vol-&gt;mft_cluster
op_assign
id|NTFS_GETU64
c_func
(paren
id|boot
op_plus
l_int|0x30
)paren
suffix:semicolon
multiline_comment|/* This will be initialized later */
id|vol-&gt;upcase
op_assign
l_int|0
suffix:semicolon
id|vol-&gt;upcase_length
op_assign
l_int|0
suffix:semicolon
id|vol-&gt;mft_ino
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|ntfs_init_upcase
id|ntfs_init_upcase
c_func
(paren
id|ntfs_inode
op_star
id|upcase
)paren
(brace
id|ntfs_io
id|io
suffix:semicolon
DECL|macro|UPCASE_LENGTH
mdefine_line|#define UPCASE_LENGTH  256
id|upcase-&gt;vol-&gt;upcase
op_assign
id|ntfs_malloc
c_func
(paren
l_int|2
op_star
id|UPCASE_LENGTH
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|upcase-&gt;vol-&gt;upcase
)paren
(brace
r_return
suffix:semicolon
)brace
id|io.fn_put
op_assign
id|ntfs_put
suffix:semicolon
id|io.fn_get
op_assign
l_int|0
suffix:semicolon
id|io.param
op_assign
(paren
r_char
op_star
)paren
id|upcase-&gt;vol-&gt;upcase
suffix:semicolon
id|io.size
op_assign
l_int|2
op_star
id|UPCASE_LENGTH
suffix:semicolon
id|ntfs_read_attr
c_func
(paren
id|upcase
comma
id|upcase-&gt;vol-&gt;at_data
comma
l_int|0
comma
l_int|0
comma
op_amp
id|io
)paren
suffix:semicolon
id|upcase-&gt;vol-&gt;upcase_length
op_assign
id|io.size
op_div
l_int|2
suffix:semicolon
)brace
r_static
r_int
DECL|function|process_attrdef
id|process_attrdef
c_func
(paren
id|ntfs_inode
op_star
id|attrdef
comma
id|ntfs_u8
op_star
id|def
)paren
(brace
r_int
id|type
op_assign
id|NTFS_GETU32
c_func
(paren
id|def
op_plus
l_int|0x80
)paren
suffix:semicolon
r_int
id|check_type
op_assign
l_int|0
suffix:semicolon
id|ntfs_volume
op_star
id|vol
op_assign
id|attrdef-&gt;vol
suffix:semicolon
id|ntfs_u16
op_star
id|name
op_assign
(paren
id|ntfs_u16
op_star
)paren
id|def
suffix:semicolon
r_if
c_cond
(paren
id|ntfs_ua_strncmp
c_func
(paren
id|name
comma
l_string|&quot;$STANDARD_INFORMATION&quot;
comma
l_int|64
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;at_standard_information
op_assign
id|type
suffix:semicolon
id|check_type
op_assign
l_int|0x10
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ntfs_ua_strncmp
c_func
(paren
id|name
comma
l_string|&quot;$ATTRIBUTE_LIST&quot;
comma
l_int|64
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;at_attribute_list
op_assign
id|type
suffix:semicolon
id|check_type
op_assign
l_int|0x20
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ntfs_ua_strncmp
c_func
(paren
id|name
comma
l_string|&quot;$FILE_NAME&quot;
comma
l_int|64
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;at_file_name
op_assign
id|type
suffix:semicolon
id|check_type
op_assign
l_int|0x30
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ntfs_ua_strncmp
c_func
(paren
id|name
comma
l_string|&quot;$VOLUME_VERSION&quot;
comma
l_int|64
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;at_volume_version
op_assign
id|type
suffix:semicolon
id|check_type
op_assign
l_int|0x40
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ntfs_ua_strncmp
c_func
(paren
id|name
comma
l_string|&quot;$SECURITY_DESCRIPTOR&quot;
comma
l_int|64
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;at_security_descriptor
op_assign
id|type
suffix:semicolon
id|check_type
op_assign
l_int|0x50
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ntfs_ua_strncmp
c_func
(paren
id|name
comma
l_string|&quot;$VOLUME_NAME&quot;
comma
l_int|64
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;at_volume_name
op_assign
id|type
suffix:semicolon
id|check_type
op_assign
l_int|0x60
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ntfs_ua_strncmp
c_func
(paren
id|name
comma
l_string|&quot;$VOLUME_INFORMATION&quot;
comma
l_int|64
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;at_volume_information
op_assign
id|type
suffix:semicolon
id|check_type
op_assign
l_int|0x70
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ntfs_ua_strncmp
c_func
(paren
id|name
comma
l_string|&quot;$DATA&quot;
comma
l_int|64
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;at_data
op_assign
id|type
suffix:semicolon
id|check_type
op_assign
l_int|0x80
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ntfs_ua_strncmp
c_func
(paren
id|name
comma
l_string|&quot;$INDEX_ROOT&quot;
comma
l_int|64
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;at_index_root
op_assign
id|type
suffix:semicolon
id|check_type
op_assign
l_int|0x90
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ntfs_ua_strncmp
c_func
(paren
id|name
comma
l_string|&quot;$INDEX_ALLOCATION&quot;
comma
l_int|64
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;at_index_allocation
op_assign
id|type
suffix:semicolon
id|check_type
op_assign
l_int|0xA0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ntfs_ua_strncmp
c_func
(paren
id|name
comma
l_string|&quot;$BITMAP&quot;
comma
l_int|64
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;at_bitmap
op_assign
id|type
suffix:semicolon
id|check_type
op_assign
l_int|0xB0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ntfs_ua_strncmp
c_func
(paren
id|name
comma
l_string|&quot;$SYMBOLIC_LINK&quot;
comma
l_int|64
)paren
op_eq
l_int|0
op_logical_or
id|ntfs_ua_strncmp
c_func
(paren
id|name
comma
l_string|&quot;$REPARSE_POINT&quot;
comma
l_int|64
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;at_symlink
op_assign
id|type
suffix:semicolon
id|check_type
op_assign
l_int|0xC0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|check_type
op_logical_and
id|check_type
op_ne
id|type
)paren
(brace
id|ntfs_error
c_func
(paren
l_string|&quot;Unexpected type %x for %x&bslash;n&quot;
comma
id|type
comma
id|check_type
)paren
suffix:semicolon
r_return
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|ntfs_init_attrdef
id|ntfs_init_attrdef
c_func
(paren
id|ntfs_inode
op_star
id|attrdef
)paren
(brace
id|ntfs_u8
op_star
id|buf
suffix:semicolon
id|ntfs_io
id|io
suffix:semicolon
r_int
id|offset
comma
id|error
comma
id|i
suffix:semicolon
id|ntfs_attribute
op_star
id|data
suffix:semicolon
id|buf
op_assign
id|ntfs_malloc
c_func
(paren
l_int|4050
)paren
suffix:semicolon
multiline_comment|/* 90*45 */
r_if
c_cond
(paren
op_logical_neg
id|buf
)paren
(brace
r_return
id|ENOMEM
suffix:semicolon
)brace
id|io.fn_put
op_assign
id|ntfs_put
suffix:semicolon
id|io.fn_get
op_assign
id|ntfs_get
suffix:semicolon
id|io.do_read
op_assign
l_int|1
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
id|data
op_assign
id|ntfs_find_attr
c_func
(paren
id|attrdef
comma
id|attrdef-&gt;vol-&gt;at_data
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|data
)paren
(brace
id|ntfs_free
c_func
(paren
id|buf
)paren
suffix:semicolon
r_return
id|EINVAL
suffix:semicolon
)brace
r_do
(brace
id|io.param
op_assign
id|buf
suffix:semicolon
id|io.size
op_assign
l_int|4050
suffix:semicolon
id|error
op_assign
id|ntfs_readwrite_attr
c_func
(paren
id|attrdef
comma
id|data
comma
id|offset
comma
op_amp
id|io
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
op_logical_neg
id|error
op_logical_and
id|i
OL
id|io.size
op_minus
l_int|0xA0
suffix:semicolon
id|i
op_add_assign
l_int|0xA0
)paren
id|error
op_assign
id|process_attrdef
c_func
(paren
id|attrdef
comma
id|buf
op_plus
id|i
)paren
suffix:semicolon
id|offset
op_add_assign
l_int|4096
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|error
op_logical_and
id|io.size
)paren
suffix:semicolon
id|ntfs_free
c_func
(paren
id|buf
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* ntfs_get_version will determine the NTFS version of the &n;   volume and will return the version in a BCD format, with&n;   the MSB being the major version number and the LSB the&n;   minor one. Otherwise return &lt;0 on error. &n;   Example: version 3.1 will be returned as 0x0301.&n;   This has the obvious limitation of not coping with version&n;   numbers above 0x80 but that shouldn&squot;t be a problem... */
DECL|function|ntfs_get_version
r_int
id|ntfs_get_version
c_func
(paren
id|ntfs_inode
op_star
id|volume
)paren
(brace
id|ntfs_attribute
op_star
id|volinfo
suffix:semicolon
id|volinfo
op_assign
id|ntfs_find_attr
c_func
(paren
id|volume
comma
id|volume-&gt;vol-&gt;at_volume_information
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|volinfo
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|volinfo-&gt;resident
)paren
(brace
id|ntfs_error
c_func
(paren
l_string|&quot;Volume information attribute is not resident!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
(paren
(paren
id|ntfs_u8
op_star
)paren
id|volinfo-&gt;d.data
)paren
(braket
l_int|8
)braket
op_lshift
l_int|8
op_or
(paren
(paren
id|ntfs_u8
op_star
)paren
id|volinfo-&gt;d.data
)paren
(braket
l_int|9
)braket
suffix:semicolon
)brace
DECL|function|ntfs_load_special_files
r_int
id|ntfs_load_special_files
c_func
(paren
id|ntfs_volume
op_star
id|vol
)paren
(brace
r_int
id|error
suffix:semicolon
id|ntfs_inode
id|upcase
comma
id|attrdef
comma
id|volume
suffix:semicolon
id|vol-&gt;mft_ino
op_assign
(paren
id|ntfs_inode
op_star
)paren
id|ntfs_calloc
c_func
(paren
l_int|3
op_star
r_sizeof
(paren
id|ntfs_inode
)paren
)paren
suffix:semicolon
id|error
op_assign
id|ENOMEM
suffix:semicolon
id|ntfs_debug
c_func
(paren
id|DEBUG_BSD
comma
l_string|&quot;Going to load MFT&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vol-&gt;mft_ino
op_logical_or
(paren
id|error
op_assign
id|ntfs_init_inode
c_func
(paren
id|vol-&gt;mft_ino
comma
id|vol
comma
id|FILE_MFT
)paren
)paren
)paren
(brace
id|ntfs_error
c_func
(paren
l_string|&quot;Problem loading MFT&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|ntfs_debug
c_func
(paren
id|DEBUG_BSD
comma
l_string|&quot;Going to load MIRR&bslash;n&quot;
)paren
suffix:semicolon
id|vol-&gt;mftmirr
op_assign
id|vol-&gt;mft_ino
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_assign
id|ntfs_init_inode
c_func
(paren
id|vol-&gt;mftmirr
comma
id|vol
comma
id|FILE_MFTMIRR
)paren
)paren
)paren
(brace
id|ntfs_error
c_func
(paren
l_string|&quot;Problem %d loading MFTMirr&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|ntfs_debug
c_func
(paren
id|DEBUG_BSD
comma
l_string|&quot;Going to load BITMAP&bslash;n&quot;
)paren
suffix:semicolon
id|vol-&gt;bitmap
op_assign
id|vol-&gt;mft_ino
op_plus
l_int|2
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_assign
id|ntfs_init_inode
c_func
(paren
id|vol-&gt;bitmap
comma
id|vol
comma
id|FILE_BITMAP
)paren
)paren
)paren
(brace
id|ntfs_error
c_func
(paren
l_string|&quot;Problem loading Bitmap&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|ntfs_debug
c_func
(paren
id|DEBUG_BSD
comma
l_string|&quot;Going to load UPCASE&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
id|ntfs_init_inode
c_func
(paren
op_amp
id|upcase
comma
id|vol
comma
id|FILE_UPCASE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
r_return
id|error
suffix:semicolon
)brace
id|ntfs_init_upcase
c_func
(paren
op_amp
id|upcase
)paren
suffix:semicolon
id|ntfs_clear_inode
c_func
(paren
op_amp
id|upcase
)paren
suffix:semicolon
id|ntfs_debug
c_func
(paren
id|DEBUG_BSD
comma
l_string|&quot;Going to load ATTRDEF&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
id|ntfs_init_inode
c_func
(paren
op_amp
id|attrdef
comma
id|vol
comma
id|FILE_ATTRDEF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|ntfs_init_attrdef
c_func
(paren
op_amp
id|attrdef
)paren
suffix:semicolon
id|ntfs_clear_inode
c_func
(paren
op_amp
id|attrdef
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* Check for NTFS version and if Win2k version (ie. 3.0+)&n;&t;   do not allow write access since the driver write support&n;&t;   is broken, especially for Win2k. */
id|ntfs_debug
c_func
(paren
id|DEBUG_BSD
comma
l_string|&quot;Going to load VOLUME&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
id|ntfs_init_inode
c_func
(paren
op_amp
id|volume
comma
id|vol
comma
id|FILE_VOLUME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_assign
id|ntfs_get_version
c_func
(paren
op_amp
id|volume
)paren
)paren
op_ge
l_int|0x0300
)paren
(brace
id|NTFS_SB
c_func
(paren
id|vol
)paren
op_member_access_from_pointer
id|s_flags
op_or_assign
id|MS_RDONLY
suffix:semicolon
id|ntfs_error
c_func
(paren
l_string|&quot;Warning! NTFS volume version is Win2k+: Mounting read-only&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|ntfs_clear_inode
c_func
(paren
op_amp
id|volume
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
r_return
id|error
suffix:semicolon
id|ntfs_debug
c_func
(paren
id|DEBUG_BSD
comma
l_string|&quot;NTFS volume is version %d.%d&bslash;n&quot;
comma
id|error
op_rshift
l_int|8
comma
id|error
op_amp
l_int|0xff
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ntfs_release_volume
r_int
id|ntfs_release_volume
c_func
(paren
id|ntfs_volume
op_star
id|vol
)paren
(brace
r_if
c_cond
(paren
id|vol-&gt;mft_ino
)paren
(brace
id|ntfs_clear_inode
c_func
(paren
id|vol-&gt;mft_ino
)paren
suffix:semicolon
id|ntfs_clear_inode
c_func
(paren
id|vol-&gt;mftmirr
)paren
suffix:semicolon
id|ntfs_clear_inode
c_func
(paren
id|vol-&gt;bitmap
)paren
suffix:semicolon
id|ntfs_free
c_func
(paren
id|vol-&gt;mft_ino
)paren
suffix:semicolon
id|vol-&gt;mft_ino
op_assign
l_int|0
suffix:semicolon
)brace
id|ntfs_free
c_func
(paren
id|vol-&gt;mft
)paren
suffix:semicolon
id|ntfs_free
c_func
(paren
id|vol-&gt;upcase
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Writes the volume size into vol_size. Returns 0 if successful&n; * or error.&n; */
DECL|function|ntfs_get_volumesize
r_int
id|ntfs_get_volumesize
c_func
(paren
id|ntfs_volume
op_star
id|vol
comma
id|ntfs_u64
op_star
id|vol_size
)paren
(brace
id|ntfs_io
id|io
suffix:semicolon
r_char
op_star
id|cluster0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vol_size
)paren
(brace
r_return
id|EFAULT
suffix:semicolon
)brace
id|cluster0
op_assign
id|ntfs_malloc
c_func
(paren
id|vol-&gt;clustersize
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cluster0
)paren
(brace
r_return
id|ENOMEM
suffix:semicolon
)brace
id|io.fn_put
op_assign
id|ntfs_put
suffix:semicolon
id|io.fn_get
op_assign
id|ntfs_get
suffix:semicolon
id|io.param
op_assign
id|cluster0
suffix:semicolon
id|io.do_read
op_assign
l_int|1
suffix:semicolon
id|io.size
op_assign
id|vol-&gt;clustersize
suffix:semicolon
id|ntfs_getput_clusters
c_func
(paren
id|vol
comma
l_int|0
comma
l_int|0
comma
op_amp
id|io
)paren
suffix:semicolon
op_star
id|vol_size
op_assign
id|NTFS_GETU64
c_func
(paren
id|cluster0
op_plus
l_int|0x28
)paren
suffix:semicolon
id|ntfs_free
c_func
(paren
id|cluster0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|nc
r_static
r_int
id|nc
(braket
l_int|16
)braket
op_assign
initialization_block
suffix:semicolon
r_int
DECL|function|ntfs_get_free_cluster_count
id|ntfs_get_free_cluster_count
c_func
(paren
id|ntfs_inode
op_star
id|bitmap
)paren
(brace
r_int
r_char
id|bits
(braket
l_int|2048
)braket
suffix:semicolon
r_int
id|offset
comma
id|error
suffix:semicolon
r_int
id|clusters
op_assign
l_int|0
suffix:semicolon
id|ntfs_io
id|io
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
id|io.fn_put
op_assign
id|ntfs_put
suffix:semicolon
id|io.fn_get
op_assign
id|ntfs_get
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_register
r_int
id|i
suffix:semicolon
id|io.param
op_assign
id|bits
suffix:semicolon
id|io.size
op_assign
l_int|2048
suffix:semicolon
id|error
op_assign
id|ntfs_read_attr
c_func
(paren
id|bitmap
comma
id|bitmap-&gt;vol-&gt;at_data
comma
l_int|0
comma
id|offset
comma
op_amp
id|io
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_logical_or
id|io.size
op_eq
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/* I never thought I would do loop unrolling some day */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|io.size
op_minus
l_int|8
suffix:semicolon
)paren
(brace
id|clusters
op_add_assign
id|nc
(braket
id|bits
(braket
id|i
)braket
op_rshift
l_int|4
)braket
suffix:semicolon
id|clusters
op_add_assign
id|nc
(braket
id|bits
(braket
id|i
op_increment
)braket
op_amp
l_int|0xF
)braket
suffix:semicolon
id|clusters
op_add_assign
id|nc
(braket
id|bits
(braket
id|i
)braket
op_rshift
l_int|4
)braket
suffix:semicolon
id|clusters
op_add_assign
id|nc
(braket
id|bits
(braket
id|i
op_increment
)braket
op_amp
l_int|0xF
)braket
suffix:semicolon
id|clusters
op_add_assign
id|nc
(braket
id|bits
(braket
id|i
)braket
op_rshift
l_int|4
)braket
suffix:semicolon
id|clusters
op_add_assign
id|nc
(braket
id|bits
(braket
id|i
op_increment
)braket
op_amp
l_int|0xF
)braket
suffix:semicolon
id|clusters
op_add_assign
id|nc
(braket
id|bits
(braket
id|i
)braket
op_rshift
l_int|4
)braket
suffix:semicolon
id|clusters
op_add_assign
id|nc
(braket
id|bits
(braket
id|i
op_increment
)braket
op_amp
l_int|0xF
)braket
suffix:semicolon
id|clusters
op_add_assign
id|nc
(braket
id|bits
(braket
id|i
)braket
op_rshift
l_int|4
)braket
suffix:semicolon
id|clusters
op_add_assign
id|nc
(braket
id|bits
(braket
id|i
op_increment
)braket
op_amp
l_int|0xF
)braket
suffix:semicolon
id|clusters
op_add_assign
id|nc
(braket
id|bits
(braket
id|i
)braket
op_rshift
l_int|4
)braket
suffix:semicolon
id|clusters
op_add_assign
id|nc
(braket
id|bits
(braket
id|i
op_increment
)braket
op_amp
l_int|0xF
)braket
suffix:semicolon
id|clusters
op_add_assign
id|nc
(braket
id|bits
(braket
id|i
)braket
op_rshift
l_int|4
)braket
suffix:semicolon
id|clusters
op_add_assign
id|nc
(braket
id|bits
(braket
id|i
op_increment
)braket
op_amp
l_int|0xF
)braket
suffix:semicolon
id|clusters
op_add_assign
id|nc
(braket
id|bits
(braket
id|i
)braket
op_rshift
l_int|4
)braket
suffix:semicolon
id|clusters
op_add_assign
id|nc
(braket
id|bits
(braket
id|i
op_increment
)braket
op_amp
l_int|0xF
)braket
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
id|io.size
suffix:semicolon
)paren
(brace
id|clusters
op_add_assign
id|nc
(braket
id|bits
(braket
id|i
)braket
op_rshift
l_int|4
)braket
suffix:semicolon
id|clusters
op_add_assign
id|nc
(braket
id|bits
(braket
id|i
op_increment
)braket
op_amp
l_int|0xF
)braket
suffix:semicolon
)brace
id|offset
op_add_assign
id|io.size
suffix:semicolon
)brace
r_return
id|clusters
suffix:semicolon
)brace
multiline_comment|/* Insert the fixups for the record. The number and location of the fixes &n;   is obtained from the record header */
DECL|function|ntfs_insert_fixups
r_void
id|ntfs_insert_fixups
c_func
(paren
r_int
r_char
op_star
id|rec
comma
r_int
id|secsize
)paren
(brace
r_int
id|first
op_assign
id|NTFS_GETU16
c_func
(paren
id|rec
op_plus
l_int|4
)paren
suffix:semicolon
r_int
id|count
op_assign
id|NTFS_GETU16
c_func
(paren
id|rec
op_plus
l_int|6
)paren
suffix:semicolon
r_int
id|offset
op_assign
op_minus
l_int|2
suffix:semicolon
id|ntfs_u16
id|fix
op_assign
id|NTFS_GETU16
c_func
(paren
id|rec
op_plus
id|first
)paren
suffix:semicolon
id|fix
op_assign
id|fix
op_plus
l_int|1
suffix:semicolon
id|NTFS_PUTU16
c_func
(paren
id|rec
op_plus
id|first
comma
id|fix
)paren
suffix:semicolon
id|count
op_decrement
suffix:semicolon
r_while
c_loop
(paren
id|count
op_decrement
)paren
(brace
id|first
op_add_assign
l_int|2
suffix:semicolon
id|offset
op_add_assign
id|secsize
suffix:semicolon
id|NTFS_PUTU16
c_func
(paren
id|rec
op_plus
id|first
comma
id|NTFS_GETU16
c_func
(paren
id|rec
op_plus
id|offset
)paren
)paren
suffix:semicolon
id|NTFS_PUTU16
c_func
(paren
id|rec
op_plus
id|offset
comma
id|fix
)paren
suffix:semicolon
)brace
suffix:semicolon
)brace
multiline_comment|/* search the bitmap bits of l bytes for *cnt zero bits. Return the bit&n;   number in *loc, which is initially set to the number of the first bit.&n;   Return the largest block found in *cnt. Return 0 on success, ENOSPC if&n;   all bits are used */
r_static
r_int
DECL|function|search_bits
id|search_bits
c_func
(paren
r_int
r_char
op_star
id|bits
comma
id|ntfs_cluster_t
op_star
id|loc
comma
r_int
op_star
id|cnt
comma
r_int
id|l
)paren
(brace
r_int
r_char
id|c
op_assign
l_int|0
suffix:semicolon
r_int
id|bc
op_assign
l_int|0
suffix:semicolon
r_int
id|bstart
op_assign
l_int|0
comma
id|bstop
op_assign
l_int|0
comma
id|found
op_assign
l_int|0
suffix:semicolon
r_int
id|start
comma
id|stop
op_assign
l_int|0
comma
id|in
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* special case searching for a single block */
r_if
c_cond
(paren
op_star
id|cnt
op_eq
l_int|1
)paren
(brace
r_while
c_loop
(paren
id|l
op_logical_and
op_star
id|bits
op_eq
l_int|0xFF
)paren
(brace
id|bits
op_increment
suffix:semicolon
op_star
id|loc
op_add_assign
l_int|8
suffix:semicolon
id|l
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|l
)paren
(brace
r_return
id|ENOSPC
suffix:semicolon
)brace
r_for
c_loop
(paren
id|c
op_assign
op_star
id|bits
suffix:semicolon
id|c
op_amp
l_int|1
suffix:semicolon
id|c
op_rshift_assign
l_int|1
)paren
(brace
(paren
op_star
id|loc
)paren
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
id|start
op_assign
op_star
id|loc
suffix:semicolon
r_while
c_loop
(paren
id|l
op_logical_or
id|bc
)paren
(brace
r_if
c_cond
(paren
id|bc
op_eq
l_int|0
)paren
(brace
id|c
op_assign
op_star
id|bits
suffix:semicolon
r_if
c_cond
(paren
id|l
)paren
(brace
id|l
op_decrement
suffix:semicolon
id|bits
op_increment
suffix:semicolon
)brace
id|bc
op_assign
l_int|8
suffix:semicolon
)brace
r_if
c_cond
(paren
id|in
)paren
(brace
r_if
c_cond
(paren
(paren
id|c
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
(brace
id|stop
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* end of sequence of zeroes */
id|in
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|found
op_logical_or
id|bstop
op_minus
id|bstart
OL
id|stop
op_minus
id|start
)paren
(brace
id|bstop
op_assign
id|stop
suffix:semicolon
id|bstart
op_assign
id|start
suffix:semicolon
id|found
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|bstop
op_minus
id|bstart
OG
op_star
id|cnt
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
id|start
op_assign
id|stop
op_plus
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|c
op_amp
l_int|1
)paren
(brace
id|start
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*start of sequence*/
id|in
op_assign
l_int|1
suffix:semicolon
id|stop
op_assign
id|start
op_plus
l_int|1
suffix:semicolon
)brace
)brace
id|bc
op_decrement
suffix:semicolon
id|c
op_rshift_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|in
op_logical_and
(paren
op_logical_neg
id|found
op_logical_or
id|bstop
op_minus
id|bstart
OL
id|stop
op_minus
id|start
)paren
)paren
(brace
id|bstop
op_assign
id|stop
suffix:semicolon
id|bstart
op_assign
id|start
suffix:semicolon
id|found
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|found
)paren
(brace
r_return
id|ENOSPC
suffix:semicolon
)brace
op_star
id|loc
op_assign
id|bstart
suffix:semicolon
r_if
c_cond
(paren
op_star
id|cnt
OG
id|bstop
op_minus
id|bstart
)paren
(brace
op_star
id|cnt
op_assign
id|bstop
op_minus
id|bstart
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|ntfs_set_bitrange
id|ntfs_set_bitrange
c_func
(paren
id|ntfs_inode
op_star
id|bitmap
comma
id|ntfs_cluster_t
id|loc
comma
r_int
id|cnt
comma
r_int
id|bit
)paren
(brace
r_int
id|bsize
comma
id|locit
comma
id|error
suffix:semicolon
r_int
r_char
op_star
id|bits
comma
op_star
id|it
suffix:semicolon
id|ntfs_io
id|io
suffix:semicolon
id|io.fn_put
op_assign
id|ntfs_put
suffix:semicolon
id|io.fn_get
op_assign
id|ntfs_get
suffix:semicolon
id|bsize
op_assign
(paren
id|cnt
op_plus
(paren
id|loc
op_amp
l_int|7
)paren
op_plus
l_int|7
)paren
op_rshift
l_int|3
suffix:semicolon
multiline_comment|/* round up to multiple of 8*/
id|bits
op_assign
id|ntfs_malloc
c_func
(paren
id|bsize
)paren
suffix:semicolon
id|io.param
op_assign
id|bits
suffix:semicolon
id|io.size
op_assign
id|bsize
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bits
)paren
(brace
r_return
id|ENOMEM
suffix:semicolon
)brace
id|error
op_assign
id|ntfs_read_attr
c_func
(paren
id|bitmap
comma
id|bitmap-&gt;vol-&gt;at_data
comma
l_int|0
comma
id|loc
op_rshift
l_int|3
comma
op_amp
id|io
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_logical_or
id|io.size
op_ne
id|bsize
)paren
(brace
id|ntfs_free
c_func
(paren
id|bits
)paren
suffix:semicolon
r_return
id|error
ques
c_cond
id|error
suffix:colon
id|EIO
suffix:semicolon
)brace
multiline_comment|/* now set the bits */
id|it
op_assign
id|bits
suffix:semicolon
id|locit
op_assign
id|loc
suffix:semicolon
r_while
c_loop
(paren
id|locit
op_mod
l_int|8
op_logical_and
id|cnt
)paren
(brace
multiline_comment|/* process first byte */
r_if
c_cond
(paren
id|bit
)paren
(brace
op_star
id|it
op_or_assign
l_int|1
op_lshift
(paren
id|locit
op_mod
l_int|8
)paren
suffix:semicolon
)brace
r_else
op_star
id|it
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|locit
op_mod
l_int|8
)paren
)paren
suffix:semicolon
id|cnt
op_decrement
suffix:semicolon
id|locit
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|locit
op_mod
l_int|8
op_eq
l_int|0
)paren
(brace
id|it
op_increment
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|cnt
OG
l_int|8
)paren
(brace
multiline_comment|/*process full bytes */
op_star
id|it
op_assign
id|bit
ques
c_cond
l_int|0xFF
suffix:colon
l_int|0
suffix:semicolon
id|cnt
op_sub_assign
l_int|8
suffix:semicolon
id|locit
op_add_assign
l_int|8
suffix:semicolon
id|it
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|cnt
)paren
(brace
multiline_comment|/*process last byte */
r_if
c_cond
(paren
id|bit
)paren
(brace
op_star
id|it
op_or_assign
l_int|1
op_lshift
(paren
id|locit
op_mod
l_int|8
)paren
suffix:semicolon
)brace
r_else
op_star
id|it
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|locit
op_mod
l_int|8
)paren
)paren
suffix:semicolon
id|cnt
op_decrement
suffix:semicolon
id|locit
op_increment
suffix:semicolon
)brace
multiline_comment|/* reset to start */
id|io.param
op_assign
id|bits
suffix:semicolon
id|io.size
op_assign
id|bsize
suffix:semicolon
id|error
op_assign
id|ntfs_write_attr
c_func
(paren
id|bitmap
comma
id|bitmap-&gt;vol-&gt;at_data
comma
l_int|0
comma
id|loc
op_rshift
l_int|3
comma
op_amp
id|io
)paren
suffix:semicolon
id|ntfs_free
c_func
(paren
id|bits
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
r_return
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|io.size
op_ne
id|bsize
)paren
(brace
r_return
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* allocate count clusters around location. If location is -1,&n;   it does not matter where the clusters are. Result is 0 if&n;   success, in which case location and count says what they really got */
r_int
DECL|function|ntfs_search_bits
id|ntfs_search_bits
c_func
(paren
id|ntfs_inode
op_star
id|bitmap
comma
id|ntfs_cluster_t
op_star
id|location
comma
r_int
op_star
id|count
comma
r_int
id|flags
)paren
(brace
r_int
r_char
op_star
id|bits
suffix:semicolon
id|ntfs_io
id|io
suffix:semicolon
r_int
id|error
op_assign
l_int|0
comma
id|found
op_assign
l_int|0
suffix:semicolon
r_int
id|cnt
comma
id|bloc
op_assign
op_minus
l_int|1
comma
id|bcnt
op_assign
l_int|0
suffix:semicolon
r_int
id|start
suffix:semicolon
id|ntfs_cluster_t
id|loc
suffix:semicolon
id|bits
op_assign
id|ntfs_malloc
c_func
(paren
l_int|2048
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bits
)paren
(brace
r_return
id|ENOMEM
suffix:semicolon
)brace
id|io.fn_put
op_assign
id|ntfs_put
suffix:semicolon
id|io.fn_get
op_assign
id|ntfs_get
suffix:semicolon
id|io.param
op_assign
id|bits
suffix:semicolon
multiline_comment|/* first search within +/- 8192 clusters */
id|start
op_assign
op_star
id|location
op_rshift
l_int|3
suffix:semicolon
id|start
op_assign
id|start
OG
l_int|1024
ques
c_cond
id|start
op_minus
l_int|1024
suffix:colon
l_int|0
suffix:semicolon
id|io.size
op_assign
l_int|2048
suffix:semicolon
id|error
op_assign
id|ntfs_read_attr
c_func
(paren
id|bitmap
comma
id|bitmap-&gt;vol-&gt;at_data
comma
l_int|0
comma
id|start
comma
op_amp
id|io
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
r_goto
id|fail
suffix:semicolon
)brace
id|loc
op_assign
id|start
op_star
l_int|8
suffix:semicolon
id|cnt
op_assign
op_star
id|count
suffix:semicolon
id|error
op_assign
id|search_bits
c_func
(paren
id|bits
comma
op_amp
id|loc
comma
op_amp
id|cnt
comma
id|io.size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
r_goto
id|fail
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|count
op_eq
id|cnt
)paren
(brace
id|bloc
op_assign
id|loc
suffix:semicolon
id|bcnt
op_assign
id|cnt
suffix:semicolon
r_goto
id|success
suffix:semicolon
)brace
multiline_comment|/* now search from the beginning */
r_for
c_loop
(paren
id|start
op_assign
l_int|0
suffix:semicolon
l_int|1
suffix:semicolon
id|start
op_add_assign
l_int|2048
)paren
(brace
id|io.param
op_assign
id|bits
suffix:semicolon
id|io.size
op_assign
l_int|2048
suffix:semicolon
id|error
op_assign
id|ntfs_read_attr
c_func
(paren
id|bitmap
comma
id|bitmap-&gt;vol-&gt;at_data
comma
l_int|0
comma
id|start
comma
op_amp
id|io
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
r_goto
id|fail
suffix:semicolon
)brace
r_if
c_cond
(paren
id|io.size
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|found
)paren
(brace
r_goto
id|success
suffix:semicolon
)brace
r_else
(brace
id|error
op_assign
id|ENOSPC
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
)brace
id|loc
op_assign
id|start
op_star
l_int|8
suffix:semicolon
id|cnt
op_assign
op_star
id|count
suffix:semicolon
id|error
op_assign
id|search_bits
c_func
(paren
id|bits
comma
op_amp
id|loc
comma
op_amp
id|cnt
comma
id|io.size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
r_goto
id|fail
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|count
op_eq
id|cnt
)paren
(brace
r_goto
id|success
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bcnt
OL
id|cnt
)paren
(brace
id|bcnt
op_assign
id|cnt
suffix:semicolon
id|bloc
op_assign
id|loc
suffix:semicolon
id|found
op_assign
l_int|1
suffix:semicolon
)brace
)brace
id|success
suffix:colon
id|ntfs_free
c_func
(paren
id|bits
)paren
suffix:semicolon
multiline_comment|/* check flags */
r_if
c_cond
(paren
(paren
id|flags
op_amp
id|ALLOC_REQUIRE_LOCATION
)paren
op_logical_and
op_star
id|location
op_ne
id|bloc
)paren
(brace
id|error
op_assign
id|ENOSPC
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|flags
op_amp
id|ALLOC_REQUIRE_SIZE
)paren
op_logical_and
op_star
id|count
op_ne
id|bcnt
)paren
(brace
id|error
op_assign
id|ENOSPC
suffix:semicolon
)brace
r_else
id|ntfs_set_bitrange
c_func
(paren
id|bitmap
comma
id|bloc
comma
id|bcnt
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* If allocation failed due to the flags, tell the caller what he&n;&t;   could have gotten */
op_star
id|location
op_assign
id|bloc
suffix:semicolon
op_star
id|count
op_assign
id|bcnt
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|fail
suffix:colon
op_star
id|location
op_assign
op_minus
l_int|1
suffix:semicolon
op_star
id|count
op_assign
l_int|0
suffix:semicolon
id|ntfs_free
c_func
(paren
id|bits
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|ntfs_allocate_clusters
r_int
id|ntfs_allocate_clusters
c_func
(paren
id|ntfs_volume
op_star
id|vol
comma
id|ntfs_cluster_t
op_star
id|location
comma
r_int
op_star
id|count
comma
r_int
id|flags
)paren
(brace
r_int
id|error
suffix:semicolon
id|error
op_assign
id|ntfs_search_bits
c_func
(paren
id|vol-&gt;bitmap
comma
id|location
comma
id|count
comma
id|flags
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|ntfs_deallocate_clusters
r_int
id|ntfs_deallocate_clusters
c_func
(paren
id|ntfs_volume
op_star
id|vol
comma
id|ntfs_cluster_t
id|location
comma
r_int
id|count
)paren
(brace
r_int
id|error
suffix:semicolon
id|error
op_assign
id|ntfs_set_bitrange
c_func
(paren
id|vol-&gt;bitmap
comma
id|location
comma
id|count
comma
l_int|0
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/*&n; * Local variables:&n; * c-file-style: &quot;linux&quot;&n; * End:&n; */
eof
