multiline_comment|/* inffast.c -- process literals and length/distance pairs fast&n; * Copyright (C) 1995-1998 Mark Adler&n; * For conditions of distribution and use, see copyright notice in zlib.h &n; */
macro_line|#include &quot;zutil.h&quot;
macro_line|#include &quot;inftrees.h&quot;
macro_line|#include &quot;infblock.h&quot;
macro_line|#include &quot;infcodes.h&quot;
macro_line|#include &quot;infutil.h&quot;
macro_line|#include &quot;inffast.h&quot;
DECL|struct|inflate_codes_state
DECL|member|dummy
r_struct
id|inflate_codes_state
(brace
r_int
id|dummy
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* for buggy compilers */
multiline_comment|/* simplify the use of the inflate_huft type with some defines */
DECL|macro|exop
mdefine_line|#define exop word.what.Exop
DECL|macro|bits
mdefine_line|#define bits word.what.Bits
multiline_comment|/* macros for bit input with no checking and for returning unused bytes */
DECL|macro|GRABBITS
mdefine_line|#define GRABBITS(j) {while(k&lt;(j)){b|=((uLong)NEXTBYTE)&lt;&lt;k;k+=8;}}
DECL|macro|UNGRAB
mdefine_line|#define UNGRAB {c=z-&gt;avail_in-n;c=(k&gt;&gt;3)&lt;c?k&gt;&gt;3:c;n+=c;p-=c;k-=c&lt;&lt;3;}
multiline_comment|/* Called with number of bytes left to write in window at least 258&n;   (the maximum string length) and number of input bytes available&n;   at least ten.  The ten bytes are six bytes for the longest length/&n;   distance pair plus four bytes for overloading the bit buffer. */
DECL|function|cramfs_inflate_fast
r_int
id|cramfs_inflate_fast
c_func
(paren
id|bl
comma
id|bd
comma
id|tl
comma
id|td
comma
id|s
comma
id|z
)paren
id|uInt
id|bl
comma
id|bd
suffix:semicolon
id|inflate_huft
op_star
id|tl
suffix:semicolon
id|inflate_huft
op_star
id|td
suffix:semicolon
multiline_comment|/* need separate declaration for Borland C++ */
id|inflate_blocks_statef
op_star
id|s
suffix:semicolon
id|z_streamp
id|z
suffix:semicolon
(brace
id|inflate_huft
op_star
id|t
suffix:semicolon
multiline_comment|/* temporary pointer */
id|uInt
id|e
suffix:semicolon
multiline_comment|/* extra bits or operation */
id|uLong
id|b
suffix:semicolon
multiline_comment|/* bit buffer */
id|uInt
id|k
suffix:semicolon
multiline_comment|/* bits in bit buffer */
id|Bytef
op_star
id|p
suffix:semicolon
multiline_comment|/* input data pointer */
id|uInt
id|n
suffix:semicolon
multiline_comment|/* bytes available there */
id|Bytef
op_star
id|q
suffix:semicolon
multiline_comment|/* output window write pointer */
id|uInt
id|m
suffix:semicolon
multiline_comment|/* bytes to end of window or read pointer */
id|uInt
id|ml
suffix:semicolon
multiline_comment|/* mask for literal/length tree */
id|uInt
id|md
suffix:semicolon
multiline_comment|/* mask for distance tree */
id|uInt
id|c
suffix:semicolon
multiline_comment|/* bytes to copy */
id|uInt
id|d
suffix:semicolon
multiline_comment|/* distance back to copy from */
id|Bytef
op_star
id|r
suffix:semicolon
multiline_comment|/* copy source pointer */
multiline_comment|/* load input, output, bit values */
id|LOAD
multiline_comment|/* initialize masks */
id|ml
op_assign
id|cramfs_inflate_mask
(braket
id|bl
)braket
suffix:semicolon
id|md
op_assign
id|cramfs_inflate_mask
(braket
id|bd
)braket
suffix:semicolon
multiline_comment|/* do until not enough input or output space for fast loop */
r_do
(brace
multiline_comment|/* assume called with m &gt;= 258 &amp;&amp; n &gt;= 10 */
multiline_comment|/* get literal/length code */
id|GRABBITS
c_func
(paren
l_int|20
)paren
multiline_comment|/* max bits for literal/length code */
r_if
c_cond
(paren
(paren
id|e
op_assign
(paren
id|t
op_assign
id|tl
op_plus
(paren
(paren
id|uInt
)paren
id|b
op_amp
id|ml
)paren
)paren
op_member_access_from_pointer
id|exop
)paren
op_eq
l_int|0
)paren
(brace
id|DUMPBITS
c_func
(paren
id|t-&gt;bits
)paren
op_star
id|q
op_increment
op_assign
(paren
id|Byte
)paren
id|t-&gt;base
suffix:semicolon
id|m
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_do
(brace
id|DUMPBITS
c_func
(paren
id|t-&gt;bits
)paren
r_if
c_cond
(paren
id|e
op_amp
l_int|16
)paren
(brace
multiline_comment|/* get extra bits for length */
id|e
op_and_assign
l_int|15
suffix:semicolon
id|c
op_assign
id|t-&gt;base
op_plus
(paren
(paren
id|uInt
)paren
id|b
op_amp
id|cramfs_inflate_mask
(braket
id|e
)braket
)paren
suffix:semicolon
id|DUMPBITS
c_func
(paren
id|e
)paren
multiline_comment|/* decode distance base of block to copy */
id|GRABBITS
c_func
(paren
l_int|15
)paren
suffix:semicolon
multiline_comment|/* max bits for distance code */
id|e
op_assign
(paren
id|t
op_assign
id|td
op_plus
(paren
(paren
id|uInt
)paren
id|b
op_amp
id|md
)paren
)paren
op_member_access_from_pointer
id|exop
suffix:semicolon
r_do
(brace
id|DUMPBITS
c_func
(paren
id|t-&gt;bits
)paren
r_if
c_cond
(paren
id|e
op_amp
l_int|16
)paren
(brace
multiline_comment|/* get extra bits to add to distance base */
id|e
op_and_assign
l_int|15
suffix:semicolon
id|GRABBITS
c_func
(paren
id|e
)paren
multiline_comment|/* get extra bits (up to 13) */
id|d
op_assign
id|t-&gt;base
op_plus
(paren
(paren
id|uInt
)paren
id|b
op_amp
id|cramfs_inflate_mask
(braket
id|e
)braket
)paren
suffix:semicolon
id|DUMPBITS
c_func
(paren
id|e
)paren
multiline_comment|/* do the copy */
id|m
op_sub_assign
id|c
suffix:semicolon
r_if
c_cond
(paren
(paren
id|uInt
)paren
(paren
id|q
op_minus
id|s-&gt;window
)paren
op_ge
id|d
)paren
multiline_comment|/* offset before dest */
(brace
multiline_comment|/*  just copy */
id|r
op_assign
id|q
op_minus
id|d
suffix:semicolon
op_star
id|q
op_increment
op_assign
op_star
id|r
op_increment
suffix:semicolon
id|c
op_decrement
suffix:semicolon
multiline_comment|/* minimum count is three, */
op_star
id|q
op_increment
op_assign
op_star
id|r
op_increment
suffix:semicolon
id|c
op_decrement
suffix:semicolon
multiline_comment|/*  so unroll loop a little */
)brace
r_else
multiline_comment|/* else offset after destination */
(brace
id|e
op_assign
id|d
op_minus
(paren
id|uInt
)paren
(paren
id|q
op_minus
id|s-&gt;window
)paren
suffix:semicolon
multiline_comment|/* bytes from offset to end */
id|r
op_assign
id|s-&gt;end
op_minus
id|e
suffix:semicolon
multiline_comment|/* pointer to offset */
r_if
c_cond
(paren
id|c
OG
id|e
)paren
multiline_comment|/* if source crosses, */
(brace
id|c
op_sub_assign
id|e
suffix:semicolon
multiline_comment|/* copy to end of window */
r_do
(brace
op_star
id|q
op_increment
op_assign
op_star
id|r
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|e
)paren
suffix:semicolon
id|r
op_assign
id|s-&gt;window
suffix:semicolon
multiline_comment|/* copy rest from start of window */
)brace
)brace
r_do
(brace
multiline_comment|/* copy all or what&squot;s left */
op_star
id|q
op_increment
op_assign
op_star
id|r
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|c
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|e
op_amp
l_int|64
)paren
op_eq
l_int|0
)paren
(brace
id|t
op_add_assign
id|t-&gt;base
suffix:semicolon
id|e
op_assign
(paren
id|t
op_add_assign
(paren
(paren
id|uInt
)paren
id|b
op_amp
id|cramfs_inflate_mask
(braket
id|e
)braket
)paren
)paren
op_member_access_from_pointer
id|exop
suffix:semicolon
)brace
r_else
(brace
id|z-&gt;msg
op_assign
(paren
r_char
op_star
)paren
l_string|&quot;invalid distance code&quot;
suffix:semicolon
id|UNGRAB
id|UPDATE
r_return
id|Z_DATA_ERROR
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|e
op_amp
l_int|64
)paren
op_eq
l_int|0
)paren
(brace
id|t
op_add_assign
id|t-&gt;base
suffix:semicolon
r_if
c_cond
(paren
(paren
id|e
op_assign
(paren
id|t
op_add_assign
(paren
(paren
id|uInt
)paren
id|b
op_amp
id|cramfs_inflate_mask
(braket
id|e
)braket
)paren
)paren
op_member_access_from_pointer
id|exop
)paren
op_eq
l_int|0
)paren
(brace
id|DUMPBITS
c_func
(paren
id|t-&gt;bits
)paren
op_star
id|q
op_increment
op_assign
(paren
id|Byte
)paren
id|t-&gt;base
suffix:semicolon
id|m
op_decrement
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|e
op_amp
l_int|32
)paren
(brace
id|UNGRAB
id|UPDATE
r_return
id|Z_STREAM_END
suffix:semicolon
)brace
r_else
(brace
id|z-&gt;msg
op_assign
(paren
r_char
op_star
)paren
l_string|&quot;invalid literal/length code&quot;
suffix:semicolon
id|UNGRAB
id|UPDATE
r_return
id|Z_DATA_ERROR
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|m
op_ge
l_int|258
op_logical_and
id|n
op_ge
l_int|10
)paren
suffix:semicolon
multiline_comment|/* not enough input or output--restore pointers and return */
id|UNGRAB
id|UPDATE
r_return
id|Z_OK
suffix:semicolon
)brace
eof
