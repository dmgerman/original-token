multiline_comment|/*&n; * Compressed rom filesystem for Linux.&n; *&n; * Copyright (C) 1999 Linus Torvalds.&n; *&n; * This file is released under the GPL.&n; */
multiline_comment|/*&n; * These are the VFS interfaces to the compressed rom filesystem.&n; * The actual compression is based on zlib, see the other files.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/pagemap.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/locks.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &quot;cramfs.h&quot;
DECL|variable|cramfs_ops
r_static
r_struct
id|super_operations
id|cramfs_ops
suffix:semicolon
DECL|variable|cramfs_file_inode_operations
r_static
r_struct
id|inode_operations
id|cramfs_file_inode_operations
suffix:semicolon
DECL|variable|cramfs_dir_inode_operations
r_static
r_struct
id|inode_operations
id|cramfs_dir_inode_operations
suffix:semicolon
DECL|variable|cramfs_symlink_inode_operations
r_static
r_struct
id|inode_operations
id|cramfs_symlink_inode_operations
suffix:semicolon
DECL|macro|CRAMINO
mdefine_line|#define CRAMINO(x)&t;((x)-&gt;offset?(x)-&gt;offset&lt;&lt;2:1)
DECL|function|get_cramfs_inode
r_static
r_struct
id|inode
op_star
id|get_cramfs_inode
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|cramfs_inode
op_star
id|cramfs_inode
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|get_empty_inode
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inode
)paren
(brace
id|inode-&gt;i_mode
op_assign
id|cramfs_inode-&gt;mode
suffix:semicolon
id|inode-&gt;i_uid
op_assign
id|cramfs_inode-&gt;uid
suffix:semicolon
id|inode-&gt;i_size
op_assign
id|cramfs_inode-&gt;size
suffix:semicolon
id|inode-&gt;i_gid
op_assign
id|cramfs_inode-&gt;gid
suffix:semicolon
id|inode-&gt;i_ino
op_assign
id|CRAMINO
c_func
(paren
id|cramfs_inode
)paren
suffix:semicolon
id|inode-&gt;i_sb
op_assign
id|sb
suffix:semicolon
id|inode-&gt;i_dev
op_assign
id|sb-&gt;s_dev
suffix:semicolon
id|insert_inode_hash
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|S_ISREG
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
id|inode-&gt;i_op
op_assign
op_amp
id|cramfs_file_inode_operations
suffix:semicolon
r_else
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
id|inode-&gt;i_op
op_assign
op_amp
id|cramfs_dir_inode_operations
suffix:semicolon
r_else
r_if
c_cond
(paren
id|S_ISLNK
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
id|inode-&gt;i_op
op_assign
op_amp
id|cramfs_symlink_inode_operations
suffix:semicolon
r_else
(brace
id|inode-&gt;i_size
op_assign
l_int|0
suffix:semicolon
id|init_special_inode
c_func
(paren
id|inode
comma
id|inode-&gt;i_mode
comma
id|cramfs_inode-&gt;size
)paren
suffix:semicolon
)brace
)brace
r_return
id|inode
suffix:semicolon
)brace
multiline_comment|/*&n; * We have our own block cache: don&squot;t fill up the buffer cache&n; * with the rom-image, because the way the filesystem is set&n; * up the accesses should be fairly regular and cached in the&n; * page cache and dentry tree anyway..&n; *&n; * This also acts as a way to guarantee contiguous areas of&n; * up to 2*PAGE_CACHE_SIZE, so that the caller doesn&squot;t need&n; * to worry about end-of-buffer issues even when decompressing&n; * a full page cache.&n; */
DECL|macro|READ_BUFFERS
mdefine_line|#define READ_BUFFERS (2)
DECL|variable|read_buffers
r_static
r_int
r_char
id|read_buffers
(braket
id|READ_BUFFERS
)braket
(braket
id|PAGE_CACHE_SIZE
op_star
l_int|4
)braket
suffix:semicolon
DECL|variable|buffer_blocknr
r_static
r_int
id|buffer_blocknr
(braket
id|READ_BUFFERS
)braket
suffix:semicolon
DECL|variable|last_buffer
r_static
r_int
id|last_buffer
op_assign
l_int|0
suffix:semicolon
DECL|function|cramfs_read
r_static
r_void
op_star
id|cramfs_read
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_int
r_int
id|offset
)paren
(brace
r_struct
id|buffer_head
op_star
id|bh_array
(braket
l_int|4
)braket
suffix:semicolon
r_int
id|i
comma
id|blocknr
comma
id|buffer
suffix:semicolon
id|blocknr
op_assign
id|offset
op_rshift
id|PAGE_CACHE_SHIFT
suffix:semicolon
id|offset
op_and_assign
id|PAGE_CACHE_SIZE
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|READ_BUFFERS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|blocknr
op_eq
id|buffer_blocknr
(braket
id|i
)braket
)paren
r_return
id|read_buffers
(braket
id|i
)braket
op_plus
id|offset
suffix:semicolon
)brace
multiline_comment|/* Ok, read in four buffers completely first */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|bh_array
(braket
id|i
)braket
op_assign
id|bread
c_func
(paren
id|sb-&gt;s_dev
comma
id|blocknr
op_plus
id|i
comma
id|PAGE_CACHE_SIZE
)paren
suffix:semicolon
multiline_comment|/* Ok, copy them to the staging area without sleeping.. */
id|buffer
op_assign
id|last_buffer
suffix:semicolon
id|last_buffer
op_assign
id|buffer
op_xor
l_int|1
suffix:semicolon
id|buffer_blocknr
(braket
id|buffer
)braket
op_assign
id|blocknr
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|buffer_head
op_star
id|bh
op_assign
id|bh_array
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|bh
)paren
(brace
id|memcpy
c_func
(paren
id|read_buffers
(braket
id|buffer
)braket
op_plus
id|i
op_star
id|PAGE_CACHE_SIZE
comma
id|bh-&gt;b_data
comma
id|PAGE_CACHE_SIZE
)paren
suffix:semicolon
id|bforget
c_func
(paren
id|bh
)paren
suffix:semicolon
)brace
id|blocknr
op_increment
suffix:semicolon
)brace
r_return
id|read_buffers
(braket
id|buffer
)braket
op_plus
id|offset
suffix:semicolon
)brace
DECL|function|cramfs_read_super
r_static
r_struct
id|super_block
op_star
id|cramfs_read_super
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_void
op_star
id|data
comma
r_int
id|silent
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|cramfs_super
id|super
suffix:semicolon
r_int
r_int
id|root_offset
suffix:semicolon
r_struct
id|super_block
op_star
id|retval
op_assign
l_int|NULL
suffix:semicolon
id|lock_super
c_func
(paren
id|sb
)paren
suffix:semicolon
id|set_blocksize
c_func
(paren
id|sb-&gt;s_dev
comma
id|PAGE_CACHE_SIZE
)paren
suffix:semicolon
id|sb-&gt;s_blocksize
op_assign
id|PAGE_CACHE_SIZE
suffix:semicolon
id|sb-&gt;s_blocksize_bits
op_assign
id|PAGE_CACHE_SHIFT
suffix:semicolon
multiline_comment|/* Invalidate the read buffers on mount: think disk change.. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|READ_BUFFERS
suffix:semicolon
id|i
op_increment
)paren
id|buffer_blocknr
(braket
id|i
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Read the first block and get the superblock from it */
id|memcpy
c_func
(paren
op_amp
id|super
comma
id|cramfs_read
c_func
(paren
id|sb
comma
l_int|0
)paren
comma
r_sizeof
(paren
id|super
)paren
)paren
suffix:semicolon
multiline_comment|/* Do sanity checks on the superblock */
r_if
c_cond
(paren
id|super.magic
op_ne
id|CRAMFS_MAGIC
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;wrong magic&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|super.signature
comma
id|CRAMFS_SIGNATURE
comma
r_sizeof
(paren
id|super.signature
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;wrong signature&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Check that the root inode is in a sane state */
id|root_offset
op_assign
id|super.root.offset
op_lshift
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|root_offset
OL
r_sizeof
(paren
r_struct
id|cramfs_super
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;root offset too small&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|root_offset
op_ge
id|super.size
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;root offset too large (%lu %u)&bslash;n&quot;
comma
id|root_offset
comma
id|super.size
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|S_ISDIR
c_func
(paren
id|super.root.mode
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;root is not a directory&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Set it all up.. */
id|sb-&gt;s_op
op_assign
op_amp
id|cramfs_ops
suffix:semicolon
id|sb-&gt;s_root
op_assign
id|d_alloc_root
c_func
(paren
id|get_cramfs_inode
c_func
(paren
id|sb
comma
op_amp
id|super.root
)paren
)paren
suffix:semicolon
id|retval
op_assign
id|sb
suffix:semicolon
id|out
suffix:colon
id|unlock_super
c_func
(paren
id|sb
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Nothing to do.. */
DECL|function|cramfs_put_super
r_static
r_void
id|cramfs_put_super
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_return
suffix:semicolon
)brace
DECL|function|cramfs_statfs
r_static
r_int
id|cramfs_statfs
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|statfs
op_star
id|buf
comma
r_int
id|bufsize
)paren
(brace
r_struct
id|statfs
id|tmp
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|tmp
comma
l_int|0
comma
r_sizeof
(paren
id|tmp
)paren
)paren
suffix:semicolon
id|tmp.f_type
op_assign
id|CRAMFS_MAGIC
suffix:semicolon
id|tmp.f_bsize
op_assign
id|PAGE_CACHE_SIZE
suffix:semicolon
id|tmp.f_blocks
op_assign
l_int|0
suffix:semicolon
id|tmp.f_namelen
op_assign
l_int|255
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
id|buf
comma
op_amp
id|tmp
comma
id|bufsize
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Read a cramfs directory entry..&n; *&n; * Remember: the inode number is the byte offset of the start&n; * of the directory..&n; */
DECL|function|cramfs_readdir
r_static
r_int
id|cramfs_readdir
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_void
op_star
id|dirent
comma
id|filldir_t
id|filldir
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|filp-&gt;f_dentry-&gt;d_inode
suffix:semicolon
r_struct
id|super_block
op_star
id|sb
op_assign
id|inode-&gt;i_sb
suffix:semicolon
r_int
r_int
id|offset
suffix:semicolon
r_int
id|copied
suffix:semicolon
multiline_comment|/* Offset within the thing.. */
id|offset
op_assign
id|filp-&gt;f_pos
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_ge
id|inode-&gt;i_size
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Directory entries are always 4-byte aligned */
r_if
c_cond
(paren
id|offset
op_amp
l_int|3
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|copied
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|offset
OL
id|inode-&gt;i_size
)paren
(brace
r_struct
id|cramfs_inode
op_star
id|de
suffix:semicolon
r_int
r_int
id|nextoffset
suffix:semicolon
r_char
op_star
id|name
suffix:semicolon
r_int
id|namelen
comma
id|error
suffix:semicolon
id|de
op_assign
id|cramfs_read
c_func
(paren
id|sb
comma
id|offset
op_plus
id|inode-&gt;i_ino
)paren
suffix:semicolon
id|name
op_assign
(paren
r_char
op_star
)paren
(paren
id|de
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Namelengths on disk are shifted by two&n;&t;&t; * and the name padded out to 4-byte boundaries&n;&t;&t; * with zeroes.&n;&t;&t; */
id|namelen
op_assign
id|de-&gt;namelen
op_lshift
l_int|2
suffix:semicolon
id|nextoffset
op_assign
id|offset
op_plus
r_sizeof
(paren
op_star
id|de
)paren
op_plus
id|namelen
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|namelen
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|name
(braket
id|namelen
op_minus
l_int|1
)braket
)paren
r_break
suffix:semicolon
id|namelen
op_decrement
suffix:semicolon
)brace
id|error
op_assign
id|filldir
c_func
(paren
id|dirent
comma
id|name
comma
id|namelen
comma
id|offset
comma
id|CRAMINO
c_func
(paren
id|de
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_break
suffix:semicolon
id|offset
op_assign
id|nextoffset
suffix:semicolon
id|filp-&gt;f_pos
op_assign
id|offset
suffix:semicolon
id|copied
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Lookup and fill in the inode data..&n; */
DECL|function|cramfs_lookup
r_static
r_struct
id|dentry
op_star
id|cramfs_lookup
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_int
r_int
id|offset
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|offset
OL
id|dir-&gt;i_size
)paren
(brace
r_struct
id|cramfs_inode
op_star
id|de
suffix:semicolon
r_char
op_star
id|name
suffix:semicolon
r_int
id|namelen
suffix:semicolon
id|de
op_assign
id|cramfs_read
c_func
(paren
id|dir-&gt;i_sb
comma
id|offset
op_plus
id|dir-&gt;i_ino
)paren
suffix:semicolon
id|name
op_assign
(paren
r_char
op_star
)paren
(paren
id|de
op_plus
l_int|1
)paren
suffix:semicolon
id|namelen
op_assign
id|de-&gt;namelen
op_lshift
l_int|2
suffix:semicolon
id|offset
op_add_assign
r_sizeof
(paren
op_star
id|de
)paren
op_plus
id|namelen
suffix:semicolon
multiline_comment|/* Quick check that the name is roughly the right length */
r_if
c_cond
(paren
(paren
(paren
id|dentry-&gt;d_name.len
op_plus
l_int|3
)paren
op_amp
op_complement
l_int|3
)paren
op_ne
id|namelen
)paren
r_continue
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|namelen
)paren
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|name
(braket
id|namelen
op_minus
l_int|1
)braket
)paren
r_break
suffix:semicolon
id|namelen
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|namelen
op_ne
id|dentry-&gt;d_name.len
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|dentry-&gt;d_name.name
comma
id|name
comma
id|namelen
)paren
)paren
r_continue
suffix:semicolon
id|d_add
c_func
(paren
id|dentry
comma
id|get_cramfs_inode
c_func
(paren
id|dir-&gt;i_sb
comma
id|de
)paren
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|d_add
c_func
(paren
id|dentry
comma
l_int|NULL
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|cramfs_readpage
r_static
r_int
id|cramfs_readpage
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|page
op_star
id|page
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|dentry-&gt;d_inode
suffix:semicolon
r_int
r_int
id|maxblock
comma
id|bytes
suffix:semicolon
id|maxblock
op_assign
(paren
id|inode-&gt;i_size
op_plus
id|PAGE_CACHE_SIZE
op_minus
l_int|1
)paren
op_rshift
id|PAGE_CACHE_SHIFT
suffix:semicolon
id|bytes
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|page-&gt;index
OL
id|maxblock
)paren
(brace
r_struct
id|super_block
op_star
id|sb
op_assign
id|inode-&gt;i_sb
suffix:semicolon
r_int
r_int
id|block_offset
op_assign
id|inode-&gt;i_ino
op_plus
id|page-&gt;index
op_star
l_int|4
suffix:semicolon
r_int
r_int
id|start_offset
op_assign
id|inode-&gt;i_ino
op_plus
id|maxblock
op_star
l_int|4
suffix:semicolon
r_int
r_int
id|end_offset
suffix:semicolon
id|end_offset
op_assign
op_star
(paren
id|u32
op_star
)paren
id|cramfs_read
c_func
(paren
id|sb
comma
id|block_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|page-&gt;index
)paren
id|start_offset
op_assign
op_star
(paren
id|u32
op_star
)paren
id|cramfs_read
c_func
(paren
id|sb
comma
id|block_offset
op_minus
l_int|4
)paren
suffix:semicolon
id|bytes
op_assign
id|inode-&gt;i_size
op_amp
(paren
id|PAGE_CACHE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|page-&gt;index
OL
id|maxblock
)paren
id|bytes
op_assign
id|PAGE_CACHE_SIZE
suffix:semicolon
id|cramfs_uncompress_block
c_func
(paren
(paren
r_void
op_star
)paren
id|page_address
c_func
(paren
id|page
)paren
comma
id|PAGE_CACHE_SIZE
comma
id|cramfs_read
c_func
(paren
id|sb
comma
id|start_offset
)paren
comma
id|end_offset
op_minus
id|start_offset
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|page_address
c_func
(paren
id|page
)paren
op_plus
id|bytes
)paren
comma
l_int|0
comma
id|PAGE_CACHE_SIZE
op_minus
id|bytes
)paren
suffix:semicolon
id|SetPageUptodate
c_func
(paren
id|page
)paren
suffix:semicolon
id|UnlockPage
c_func
(paren
id|page
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|get_symlink_page
r_static
r_struct
id|page
op_star
id|get_symlink_page
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_return
id|read_cache_page
c_func
(paren
op_amp
id|dentry-&gt;d_inode-&gt;i_data
comma
l_int|0
comma
(paren
id|filler_t
op_star
)paren
id|cramfs_readpage
comma
id|dentry
)paren
suffix:semicolon
)brace
DECL|function|cramfs_readlink
r_static
r_int
id|cramfs_readlink
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_char
op_star
id|buffer
comma
r_int
id|len
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|dentry-&gt;d_inode
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
op_logical_or
op_logical_neg
id|S_ISLNK
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
r_return
op_minus
id|EBADF
suffix:semicolon
id|retval
op_assign
id|inode-&gt;i_size
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
r_int
id|len
suffix:semicolon
r_struct
id|page
op_star
id|page
op_assign
id|get_symlink_page
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|page
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|page
)paren
suffix:semicolon
id|wait_on_page
c_func
(paren
id|page
)paren
suffix:semicolon
id|len
op_assign
id|retval
suffix:semicolon
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|Page_Uptodate
c_func
(paren
id|page
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|copy_to_user
c_func
(paren
id|buffer
comma
(paren
r_void
op_star
)paren
id|page_address
c_func
(paren
id|page
)paren
comma
id|len
)paren
)paren
id|retval
op_assign
id|len
suffix:semicolon
)brace
id|page_cache_release
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
DECL|function|cramfs_follow_link
r_static
r_struct
id|dentry
op_star
id|cramfs_follow_link
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|dentry
op_star
id|base
comma
r_int
r_int
id|follow
)paren
(brace
r_struct
id|page
op_star
id|page
op_assign
id|get_symlink_page
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_struct
id|dentry
op_star
id|result
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|page
)paren
)paren
(brace
id|dput
c_func
(paren
id|base
)paren
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
id|PTR_ERR
c_func
(paren
id|page
)paren
)paren
suffix:semicolon
)brace
id|result
op_assign
id|lookup_dentry
c_func
(paren
(paren
r_void
op_star
)paren
id|page_address
c_func
(paren
id|page
)paren
comma
id|base
comma
id|follow
)paren
suffix:semicolon
id|page_cache_release
c_func
(paren
id|page
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * Our operations:&n; *&n; * A regular file can be read and mmap&squot;ed.&n; */
DECL|variable|cramfs_file_operations
r_static
r_struct
id|file_operations
id|cramfs_file_operations
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* lseek - default */
id|generic_file_read
comma
multiline_comment|/* read */
l_int|NULL
comma
multiline_comment|/* write - bad */
l_int|NULL
comma
multiline_comment|/* readdir */
l_int|NULL
comma
multiline_comment|/* poll - default */
l_int|NULL
comma
multiline_comment|/* ioctl */
id|generic_file_mmap
comma
multiline_comment|/* mmap */
l_int|NULL
comma
multiline_comment|/* open */
l_int|NULL
comma
multiline_comment|/* flush */
l_int|NULL
comma
multiline_comment|/* release */
l_int|NULL
comma
multiline_comment|/* fsync */
l_int|NULL
comma
multiline_comment|/* fasync */
l_int|NULL
comma
multiline_comment|/* check_media_change */
l_int|NULL
multiline_comment|/* revalidate */
)brace
suffix:semicolon
multiline_comment|/*&n; * A directory can only readdir&n; */
DECL|variable|cramfs_directory_operations
r_static
r_struct
id|file_operations
id|cramfs_directory_operations
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* lseek - default */
l_int|NULL
comma
multiline_comment|/* read */
l_int|NULL
comma
multiline_comment|/* write - bad */
id|cramfs_readdir
comma
multiline_comment|/* readdir */
l_int|NULL
comma
multiline_comment|/* poll - default */
l_int|NULL
comma
multiline_comment|/* ioctl */
l_int|NULL
comma
multiline_comment|/* mmap */
l_int|NULL
comma
multiline_comment|/* open */
l_int|NULL
comma
multiline_comment|/* flush */
l_int|NULL
comma
multiline_comment|/* release */
l_int|NULL
comma
multiline_comment|/* fsync */
l_int|NULL
comma
multiline_comment|/* fasync */
l_int|NULL
comma
multiline_comment|/* check_media_change */
l_int|NULL
multiline_comment|/* revalidate */
)brace
suffix:semicolon
DECL|variable|cramfs_file_inode_operations
r_static
r_struct
id|inode_operations
id|cramfs_file_inode_operations
op_assign
(brace
op_amp
id|cramfs_file_operations
comma
l_int|NULL
comma
multiline_comment|/* create */
l_int|NULL
comma
multiline_comment|/* lookup */
l_int|NULL
comma
multiline_comment|/* link */
l_int|NULL
comma
multiline_comment|/* unlink */
l_int|NULL
comma
multiline_comment|/* symlink */
l_int|NULL
comma
multiline_comment|/* mkdir */
l_int|NULL
comma
multiline_comment|/* rmdir */
l_int|NULL
comma
multiline_comment|/* mknod */
l_int|NULL
comma
multiline_comment|/* rename */
l_int|NULL
comma
multiline_comment|/* readlink */
l_int|NULL
comma
multiline_comment|/* follow_link */
l_int|NULL
comma
multiline_comment|/* get_block */
id|cramfs_readpage
comma
multiline_comment|/* readpage */
l_int|NULL
comma
multiline_comment|/* writepage */
l_int|NULL
comma
multiline_comment|/* truncate */
l_int|NULL
comma
multiline_comment|/* permission */
l_int|NULL
multiline_comment|/* revalidate */
)brace
suffix:semicolon
DECL|variable|cramfs_dir_inode_operations
r_static
r_struct
id|inode_operations
id|cramfs_dir_inode_operations
op_assign
(brace
op_amp
id|cramfs_directory_operations
comma
l_int|NULL
comma
multiline_comment|/* create */
id|cramfs_lookup
comma
multiline_comment|/* lookup */
l_int|NULL
comma
multiline_comment|/* link */
l_int|NULL
comma
multiline_comment|/* unlink */
l_int|NULL
comma
multiline_comment|/* symlink */
l_int|NULL
comma
multiline_comment|/* mkdir */
l_int|NULL
comma
multiline_comment|/* rmdir */
l_int|NULL
comma
multiline_comment|/* mknod */
l_int|NULL
comma
multiline_comment|/* rename */
l_int|NULL
comma
multiline_comment|/* readlink */
l_int|NULL
comma
multiline_comment|/* follow_link */
l_int|NULL
comma
multiline_comment|/* get_block */
l_int|NULL
comma
multiline_comment|/* readpage */
l_int|NULL
comma
multiline_comment|/* writepage */
l_int|NULL
comma
multiline_comment|/* truncate */
l_int|NULL
comma
multiline_comment|/* permission */
l_int|NULL
multiline_comment|/* revalidate */
)brace
suffix:semicolon
DECL|variable|cramfs_symlink_inode_operations
r_static
r_struct
id|inode_operations
id|cramfs_symlink_inode_operations
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* symlinks do not have files */
l_int|NULL
comma
multiline_comment|/* create */
l_int|NULL
comma
multiline_comment|/* lookup */
l_int|NULL
comma
multiline_comment|/* link */
l_int|NULL
comma
multiline_comment|/* unlink */
l_int|NULL
comma
multiline_comment|/* symlink */
l_int|NULL
comma
multiline_comment|/* mkdir */
l_int|NULL
comma
multiline_comment|/* rmdir */
l_int|NULL
comma
multiline_comment|/* mknod */
l_int|NULL
comma
multiline_comment|/* rename */
id|cramfs_readlink
comma
multiline_comment|/* readlink */
id|cramfs_follow_link
comma
multiline_comment|/* follow_link */
l_int|NULL
comma
multiline_comment|/* get_block */
l_int|NULL
comma
multiline_comment|/* readpage */
l_int|NULL
comma
multiline_comment|/* writepage */
l_int|NULL
comma
multiline_comment|/* truncate */
l_int|NULL
comma
multiline_comment|/* permission */
l_int|NULL
multiline_comment|/* revalidate */
)brace
suffix:semicolon
DECL|variable|cramfs_ops
r_static
r_struct
id|super_operations
id|cramfs_ops
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* read inode */
l_int|NULL
comma
multiline_comment|/* write inode */
l_int|NULL
comma
multiline_comment|/* put inode */
l_int|NULL
comma
multiline_comment|/* delete inode */
l_int|NULL
comma
multiline_comment|/* notify change */
id|cramfs_put_super
comma
multiline_comment|/* put super */
l_int|NULL
comma
multiline_comment|/* write super */
id|cramfs_statfs
comma
multiline_comment|/* statfs */
l_int|NULL
multiline_comment|/* remount */
)brace
suffix:semicolon
DECL|variable|cramfs_fs_type
r_static
r_struct
id|file_system_type
id|cramfs_fs_type
op_assign
(brace
l_string|&quot;cramfs&quot;
comma
id|FS_REQUIRES_DEV
comma
id|cramfs_read_super
comma
l_int|NULL
)brace
suffix:semicolon
DECL|function|init_cramfs_fs
r_static
r_int
id|__init
id|init_cramfs_fs
c_func
(paren
r_void
)paren
(brace
id|cramfs_uncompress_init
c_func
(paren
)paren
suffix:semicolon
r_return
id|register_filesystem
c_func
(paren
op_amp
id|cramfs_fs_type
)paren
suffix:semicolon
)brace
DECL|function|exit_cramfs_fs
r_static
r_void
id|__exit
id|exit_cramfs_fs
c_func
(paren
r_void
)paren
(brace
id|cramfs_uncompress_exit
c_func
(paren
)paren
suffix:semicolon
id|unregister_filesystem
c_func
(paren
op_amp
id|cramfs_fs_type
)paren
suffix:semicolon
)brace
id|module_init
c_func
(paren
id|init_cramfs_fs
)paren
id|module_exit
c_func
(paren
id|exit_cramfs_fs
)paren
eof
