multiline_comment|/*&n; *  linux/fs/binfmt_java.c&n; *&n; *  Copyright (C) 1996  Brian A. Lantz&n; *  derived from binfmt_script.c&n; *&n; *  Simplified and modified to support binary java interpreters&n; *  by Tom May &lt;ftom@netcom.com&gt;.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/binfmts.h&gt;
DECL|macro|_PATH_JAVA
mdefine_line|#define _PATH_JAVA&t;&quot;/usr/bin/java&quot;
DECL|macro|_PATH_APPLET
mdefine_line|#define _PATH_APPLET&t;&quot;/usr/bin/appletviewer&quot;
multiline_comment|/*  These paths can be modified with sysctl().  */
DECL|variable|binfmt_java_interpreter
r_char
id|binfmt_java_interpreter
(braket
l_int|65
)braket
op_assign
id|_PATH_JAVA
suffix:semicolon
DECL|variable|binfmt_java_appletviewer
r_char
id|binfmt_java_appletviewer
(braket
l_int|65
)braket
op_assign
id|_PATH_APPLET
suffix:semicolon
DECL|function|do_load_java
r_static
r_int
id|do_load_java
c_func
(paren
r_struct
id|linux_binprm
op_star
id|bprm
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_char
op_star
id|i_name
suffix:semicolon
r_int
id|len
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_int
r_char
op_star
id|ucp
op_assign
(paren
r_int
r_char
op_star
)paren
id|bprm-&gt;buf
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ucp
(braket
l_int|0
)braket
op_ne
l_int|0xca
)paren
op_logical_or
(paren
id|ucp
(braket
l_int|1
)braket
op_ne
l_int|0xfe
)paren
op_logical_or
(paren
id|ucp
(braket
l_int|2
)braket
op_ne
l_int|0xba
)paren
op_logical_or
(paren
id|ucp
(braket
l_int|3
)braket
op_ne
l_int|0xbe
)paren
)paren
r_return
op_minus
id|ENOEXEC
suffix:semicolon
multiline_comment|/*&n;&t; * Fail if we&squot;re called recursively, e.g., the Java interpreter&n;&t; * is a java binary.&n;&t; */
r_if
c_cond
(paren
id|bprm-&gt;java
)paren
r_return
op_minus
id|ENOEXEC
suffix:semicolon
id|bprm-&gt;java
op_assign
l_int|1
suffix:semicolon
id|iput
c_func
(paren
id|bprm-&gt;inode
)paren
suffix:semicolon
id|bprm-&gt;dont_iput
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * Set args: [0] the name of the java interpreter&n;&t; *           [1] name of java class to execute, which is the&n;&t; *&t;&t; filename without the path and without trailing&n;&t; *&t;&t; &quot;.class&quot;.  Note that the interpreter will use&n;&t; *&t;&t; its own way to found the class file (typically using&n;&t; *&t;&t; environment variable CLASSPATH), and may in fact&n;&t; *&t;&t; execute a different file from the one we want.&n;&t; *&n;&t; * This is done in reverse order, because of how the&n;&t; * user environment and arguments are stored.&n;&t; */
id|remove_arg_zero
c_func
(paren
id|bprm
)paren
suffix:semicolon
id|len
op_assign
id|strlen
(paren
id|bprm-&gt;filename
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ge
l_int|6
op_logical_and
op_logical_neg
id|strcmp
(paren
id|bprm-&gt;filename
op_plus
id|len
op_minus
l_int|6
comma
l_string|&quot;.class&quot;
)paren
)paren
id|bprm-&gt;filename
(braket
id|len
op_minus
l_int|6
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i_name
op_assign
id|strrchr
(paren
id|bprm-&gt;filename
comma
l_char|&squot;/&squot;
)paren
)paren
op_ne
l_int|NULL
)paren
id|i_name
op_increment
suffix:semicolon
r_else
id|i_name
op_assign
id|bprm-&gt;filename
suffix:semicolon
id|bprm-&gt;p
op_assign
id|copy_strings
c_func
(paren
l_int|1
comma
op_amp
id|i_name
comma
id|bprm-&gt;page
comma
id|bprm-&gt;p
comma
l_int|2
)paren
suffix:semicolon
id|bprm-&gt;argc
op_increment
suffix:semicolon
id|i_name
op_assign
id|binfmt_java_interpreter
suffix:semicolon
id|bprm-&gt;p
op_assign
id|copy_strings
c_func
(paren
l_int|1
comma
op_amp
id|i_name
comma
id|bprm-&gt;page
comma
id|bprm-&gt;p
comma
l_int|2
)paren
suffix:semicolon
id|bprm-&gt;argc
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bprm-&gt;p
)paren
r_return
op_minus
id|E2BIG
suffix:semicolon
multiline_comment|/*&n;&t; * OK, now restart the process with the interpreter&squot;s inode.&n;&t; */
id|bprm-&gt;filename
op_assign
id|binfmt_java_interpreter
suffix:semicolon
id|retval
op_assign
id|open_namei
c_func
(paren
id|binfmt_java_interpreter
comma
l_int|0
comma
l_int|0
comma
op_amp
id|bprm-&gt;inode
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
id|retval
suffix:semicolon
id|bprm-&gt;dont_iput
op_assign
l_int|0
suffix:semicolon
id|retval
op_assign
id|prepare_binprm
c_func
(paren
id|bprm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
r_return
id|retval
suffix:semicolon
)brace
r_return
id|search_binary_handler
c_func
(paren
id|bprm
comma
id|regs
)paren
suffix:semicolon
)brace
DECL|function|do_load_applet
r_static
r_int
id|do_load_applet
c_func
(paren
r_struct
id|linux_binprm
op_star
id|bprm
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_char
op_star
id|i_name
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
(paren
id|bprm-&gt;buf
comma
l_string|&quot;&lt;!--applet&quot;
comma
l_int|10
)paren
)paren
r_return
op_minus
id|ENOEXEC
suffix:semicolon
id|iput
c_func
(paren
id|bprm-&gt;inode
)paren
suffix:semicolon
id|bprm-&gt;dont_iput
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * Set args: [0] the name of the appletviewer&n;&t; *           [1] filename of html file&n;&t; *&n;&t; * This is done in reverse order, because of how the&n;&t; * user environment and arguments are stored.&n;&t; */
id|remove_arg_zero
c_func
(paren
id|bprm
)paren
suffix:semicolon
id|i_name
op_assign
id|bprm-&gt;filename
suffix:semicolon
id|bprm-&gt;p
op_assign
id|copy_strings
c_func
(paren
l_int|1
comma
op_amp
id|i_name
comma
id|bprm-&gt;page
comma
id|bprm-&gt;p
comma
l_int|2
)paren
suffix:semicolon
id|bprm-&gt;argc
op_increment
suffix:semicolon
id|i_name
op_assign
id|binfmt_java_appletviewer
suffix:semicolon
id|bprm-&gt;p
op_assign
id|copy_strings
c_func
(paren
l_int|1
comma
op_amp
id|i_name
comma
id|bprm-&gt;page
comma
id|bprm-&gt;p
comma
l_int|2
)paren
suffix:semicolon
id|bprm-&gt;argc
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bprm-&gt;p
)paren
r_return
op_minus
id|E2BIG
suffix:semicolon
multiline_comment|/*&n;&t; * OK, now restart the process with the interpreter&squot;s inode.&n;&t; */
id|bprm-&gt;filename
op_assign
id|binfmt_java_appletviewer
suffix:semicolon
id|retval
op_assign
id|open_namei
c_func
(paren
id|binfmt_java_appletviewer
comma
l_int|0
comma
l_int|0
comma
op_amp
id|bprm-&gt;inode
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
id|retval
suffix:semicolon
id|bprm-&gt;dont_iput
op_assign
l_int|0
suffix:semicolon
id|retval
op_assign
id|prepare_binprm
c_func
(paren
id|bprm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
r_return
id|retval
suffix:semicolon
)brace
r_return
id|search_binary_handler
c_func
(paren
id|bprm
comma
id|regs
)paren
suffix:semicolon
)brace
DECL|function|load_java
r_static
r_int
id|load_java
c_func
(paren
r_struct
id|linux_binprm
op_star
id|bprm
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|retval
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|retval
op_assign
id|do_load_java
c_func
(paren
id|bprm
comma
id|regs
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|variable|java_format
r_static
r_struct
id|linux_binfmt
id|java_format
op_assign
(brace
macro_line|#ifndef MODULE
l_int|NULL
comma
l_int|0
comma
id|load_java
comma
l_int|NULL
comma
l_int|NULL
macro_line|#else
l_int|NULL
comma
op_amp
id|mod_use_count_
comma
id|load_java
comma
l_int|NULL
comma
l_int|NULL
macro_line|#endif
)brace
suffix:semicolon
DECL|function|load_applet
r_static
r_int
id|load_applet
c_func
(paren
r_struct
id|linux_binprm
op_star
id|bprm
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|retval
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|retval
op_assign
id|do_load_applet
c_func
(paren
id|bprm
comma
id|regs
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|variable|applet_format
r_static
r_struct
id|linux_binfmt
id|applet_format
op_assign
(brace
macro_line|#ifndef MODULE
l_int|NULL
comma
l_int|0
comma
id|load_applet
comma
l_int|NULL
comma
l_int|NULL
macro_line|#else
l_int|NULL
comma
op_amp
id|mod_use_count_
comma
id|load_applet
comma
l_int|NULL
comma
l_int|NULL
macro_line|#endif
)brace
suffix:semicolon
DECL|function|init_java_binfmt
r_int
id|init_java_binfmt
c_func
(paren
r_void
)paren
(brace
id|register_binfmt
c_func
(paren
op_amp
id|java_format
)paren
suffix:semicolon
r_return
id|register_binfmt
c_func
(paren
op_amp
id|applet_format
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|init_java_binfmt
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|unregister_binfmt
c_func
(paren
op_amp
id|java_format
)paren
suffix:semicolon
id|unregister_binfmt
c_func
(paren
op_amp
id|applet_format
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
