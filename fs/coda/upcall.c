multiline_comment|/*&n; * Mostly platform independent upcall operations to Venus:&n; *  -- upcalls&n; *  -- upcall routines&n; *&n; * Linux 2.0 version&n; * Copyright (C) 1996 Peter J. Braam &lt;braam@maths.ox.ac.uk&gt;, &n; * Michael Callahan &lt;callahan@maths.ox.ac.uk&gt; &n; * &n; * Redone for Linux 2.1&n; * Copyright (C) 1997 Carnegie Mellon University&n; *&n; * Carnegie Mellon University encourages users of this code to contribute&n; * improvements to the Coda project. Contact Peter Braam &lt;coda@cs.cmu.edu&gt;.&n; */
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/signal.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/file.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/locks.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/coda.h&gt;
macro_line|#include &lt;linux/coda_linux.h&gt;
macro_line|#include &lt;linux/coda_psdev.h&gt;
macro_line|#include &lt;linux/coda_fs_i.h&gt;
macro_line|#include &lt;linux/coda_cache.h&gt;
macro_line|#include &lt;linux/coda_proc.h&gt; 
r_static
r_int
id|coda_upcall
c_func
(paren
r_struct
id|coda_sb_info
op_star
id|mntinfo
comma
r_int
id|inSize
comma
r_int
op_star
id|outSize
comma
r_union
id|inputArgs
op_star
id|buffer
)paren
suffix:semicolon
DECL|function|alloc_upcall
r_static
r_void
op_star
id|alloc_upcall
c_func
(paren
r_int
id|opcode
comma
r_int
id|size
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
id|CODA_ALLOC
c_func
(paren
id|inp
comma
r_union
id|inputArgs
op_star
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inp
)paren
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
id|inp-&gt;ih.opcode
op_assign
id|opcode
suffix:semicolon
id|inp-&gt;ih.pid
op_assign
id|current-&gt;pid
suffix:semicolon
id|inp-&gt;ih.pgid
op_assign
id|current-&gt;pgrp
suffix:semicolon
id|coda_load_creds
c_func
(paren
op_amp
(paren
id|inp-&gt;ih.cred
)paren
)paren
suffix:semicolon
r_return
(paren
r_void
op_star
)paren
id|inp
suffix:semicolon
)brace
DECL|macro|UPARG
mdefine_line|#define UPARG(op)&bslash;&n;do {&bslash;&n;&t;inp = (union inputArgs *)alloc_upcall(op, insize); &bslash;&n;        if (IS_ERR(inp)) { return PTR_ERR(inp); }&bslash;&n;        outp = (union outputArgs *)(inp); &bslash;&n;        outsize = insize; &bslash;&n;} while (0)
DECL|function|max
r_static
r_inline
r_int
id|max
c_func
(paren
r_int
id|a
comma
r_int
id|b
)paren
(brace
r_if
c_cond
(paren
id|a
OG
id|b
)paren
r_return
id|a
suffix:semicolon
r_else
r_return
id|b
suffix:semicolon
)brace
DECL|macro|INSIZE
mdefine_line|#define INSIZE(tag) sizeof(struct coda_ ## tag ## _in)
DECL|macro|OUTSIZE
mdefine_line|#define OUTSIZE(tag) sizeof(struct coda_ ## tag ## _out)
DECL|macro|SIZE
mdefine_line|#define SIZE(tag)  max(INSIZE(tag), OUTSIZE(tag))
multiline_comment|/* the upcalls */
DECL|function|venus_rootfid
r_int
id|venus_rootfid
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
id|ViceFid
op_star
id|fidp
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
id|insize
op_assign
id|SIZE
c_func
(paren
id|root
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CODA_ROOT
)paren
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;coda_get_rootfid: error %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
)brace
r_else
(brace
op_star
id|fidp
op_assign
(paren
id|ViceFid
)paren
id|outp-&gt;coda_root.VFid
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_SUPER
comma
l_string|&quot;VolumeId: %lx, VnodeId: %lx.&bslash;n&quot;
comma
id|fidp-&gt;Volume
comma
id|fidp-&gt;Vnode
)paren
suffix:semicolon
)brace
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|venus_getattr
r_int
id|venus_getattr
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
comma
r_struct
id|coda_vattr
op_star
id|attr
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
id|insize
op_assign
id|SIZE
c_func
(paren
id|getattr
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CODA_GETATTR
)paren
suffix:semicolon
id|inp-&gt;coda_getattr.VFid
op_assign
op_star
id|fid
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
op_star
id|attr
op_assign
id|outp-&gt;coda_getattr.attr
suffix:semicolon
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|venus_setattr
r_int
id|venus_setattr
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
comma
r_struct
id|coda_vattr
op_star
id|vattr
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
id|insize
op_assign
id|SIZE
c_func
(paren
id|setattr
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CODA_SETATTR
)paren
suffix:semicolon
id|inp-&gt;coda_setattr.VFid
op_assign
op_star
id|fid
suffix:semicolon
id|inp-&gt;coda_setattr.attr
op_assign
op_star
id|vattr
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_SUPER
comma
l_string|&quot; result %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|venus_lookup
r_int
id|venus_lookup
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
comma
r_const
r_char
op_star
id|name
comma
r_int
id|length
comma
r_int
op_star
id|type
comma
r_struct
id|ViceFid
op_star
id|resfid
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
r_int
id|offset
suffix:semicolon
id|offset
op_assign
id|INSIZE
c_func
(paren
id|lookup
)paren
suffix:semicolon
id|insize
op_assign
id|max
c_func
(paren
id|offset
op_plus
id|length
op_plus
l_int|1
comma
id|OUTSIZE
c_func
(paren
id|lookup
)paren
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CODA_LOOKUP
)paren
suffix:semicolon
id|inp-&gt;coda_lookup.VFid
op_assign
op_star
id|fid
suffix:semicolon
id|inp-&gt;coda_lookup.name
op_assign
id|offset
suffix:semicolon
id|inp-&gt;coda_lookup.flags
op_assign
id|CLU_CASE_SENSITIVE
suffix:semicolon
multiline_comment|/* send Venus a null terminated string */
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|inp
)paren
op_plus
id|offset
comma
id|name
comma
id|length
)paren
suffix:semicolon
op_star
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|offset
op_plus
id|length
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
op_star
id|resfid
op_assign
id|outp-&gt;coda_lookup.VFid
suffix:semicolon
op_star
id|type
op_assign
id|outp-&gt;coda_lookup.vtype
suffix:semicolon
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|venus_release
r_int
id|venus_release
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
comma
r_int
id|flags
comma
r_struct
id|coda_cred
op_star
id|cred
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
id|insize
op_assign
id|SIZE
c_func
(paren
id|close
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CODA_CLOSE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cred
)paren
(brace
id|memcpy
c_func
(paren
op_amp
(paren
id|inp-&gt;ih.cred
)paren
comma
id|cred
comma
r_sizeof
(paren
op_star
id|cred
)paren
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;CODA: close without valid file creds.&bslash;n&quot;
)paren
suffix:semicolon
id|inp-&gt;coda_close.VFid
op_assign
op_star
id|fid
suffix:semicolon
id|inp-&gt;coda_close.flags
op_assign
id|flags
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|venus_open
r_int
id|venus_open
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
comma
r_int
id|flags
comma
id|ino_t
op_star
id|ino
comma
id|dev_t
op_star
id|dev
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
id|insize
op_assign
id|SIZE
c_func
(paren
id|open
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CODA_OPEN
)paren
suffix:semicolon
id|inp-&gt;coda_open.VFid
op_assign
op_star
id|fid
suffix:semicolon
id|inp-&gt;coda_open.flags
op_assign
id|flags
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
op_star
id|ino
op_assign
id|outp-&gt;coda_open.inode
suffix:semicolon
op_star
id|dev
op_assign
id|outp-&gt;coda_open.dev
suffix:semicolon
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|venus_mkdir
r_int
id|venus_mkdir
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|dirfid
comma
r_const
r_char
op_star
id|name
comma
r_int
id|length
comma
r_struct
id|ViceFid
op_star
id|newfid
comma
r_struct
id|coda_vattr
op_star
id|attrs
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
r_int
id|offset
suffix:semicolon
id|offset
op_assign
id|INSIZE
c_func
(paren
id|mkdir
)paren
suffix:semicolon
id|insize
op_assign
id|max
c_func
(paren
id|offset
op_plus
id|length
op_plus
l_int|1
comma
id|OUTSIZE
c_func
(paren
id|mkdir
)paren
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CODA_MKDIR
)paren
suffix:semicolon
id|inp-&gt;coda_mkdir.VFid
op_assign
op_star
id|dirfid
suffix:semicolon
id|inp-&gt;coda_mkdir.attr
op_assign
op_star
id|attrs
suffix:semicolon
id|inp-&gt;coda_mkdir.name
op_assign
id|offset
suffix:semicolon
multiline_comment|/* Venus must get null terminated string */
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|inp
)paren
op_plus
id|offset
comma
id|name
comma
id|length
)paren
suffix:semicolon
op_star
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|offset
op_plus
id|length
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
op_star
id|attrs
op_assign
id|outp-&gt;coda_mkdir.attr
suffix:semicolon
op_star
id|newfid
op_assign
id|outp-&gt;coda_mkdir.VFid
suffix:semicolon
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|venus_rename
r_int
id|venus_rename
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|old_fid
comma
r_struct
id|ViceFid
op_star
id|new_fid
comma
r_int
id|old_length
comma
r_int
id|new_length
comma
r_const
r_char
op_star
id|old_name
comma
r_const
r_char
op_star
id|new_name
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
r_int
id|offset
comma
id|s
suffix:semicolon
id|offset
op_assign
id|INSIZE
c_func
(paren
id|rename
)paren
suffix:semicolon
id|insize
op_assign
id|max
c_func
(paren
id|offset
op_plus
id|new_length
op_plus
id|old_length
op_plus
l_int|8
comma
id|OUTSIZE
c_func
(paren
id|rename
)paren
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CODA_RENAME
)paren
suffix:semicolon
id|inp-&gt;coda_rename.sourceFid
op_assign
op_star
id|old_fid
suffix:semicolon
id|inp-&gt;coda_rename.destFid
op_assign
op_star
id|new_fid
suffix:semicolon
id|inp-&gt;coda_rename.srcname
op_assign
id|offset
suffix:semicolon
multiline_comment|/* Venus must receive an null terminated string */
id|s
op_assign
(paren
id|old_length
op_amp
op_complement
l_int|0x3
)paren
op_plus
l_int|4
suffix:semicolon
multiline_comment|/* round up to word boundary */
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|inp
)paren
op_plus
id|offset
comma
id|old_name
comma
id|old_length
)paren
suffix:semicolon
op_star
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|offset
op_plus
id|old_length
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
multiline_comment|/* another null terminated string for Venus */
id|offset
op_add_assign
id|s
suffix:semicolon
id|inp-&gt;coda_rename.destname
op_assign
id|offset
suffix:semicolon
id|s
op_assign
(paren
id|new_length
op_amp
op_complement
l_int|0x3
)paren
op_plus
l_int|4
suffix:semicolon
multiline_comment|/* round up to word boundary */
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|inp
)paren
op_plus
id|offset
comma
id|new_name
comma
id|new_length
)paren
suffix:semicolon
op_star
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|offset
op_plus
id|new_length
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;destname in packet: %s&bslash;n&quot;
comma
(paren
r_char
op_star
)paren
id|inp
op_plus
(paren
r_int
)paren
id|inp-&gt;coda_rename.destname
)paren
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|venus_create
r_int
id|venus_create
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|dirfid
comma
r_const
r_char
op_star
id|name
comma
r_int
id|length
comma
r_int
id|excl
comma
r_int
id|mode
comma
r_int
id|rdev
comma
r_struct
id|ViceFid
op_star
id|newfid
comma
r_struct
id|coda_vattr
op_star
id|attrs
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
r_int
id|offset
suffix:semicolon
id|offset
op_assign
id|INSIZE
c_func
(paren
id|create
)paren
suffix:semicolon
id|insize
op_assign
id|max
c_func
(paren
id|offset
op_plus
id|length
op_plus
l_int|1
comma
id|OUTSIZE
c_func
(paren
id|create
)paren
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CODA_CREATE
)paren
suffix:semicolon
id|inp-&gt;coda_create.VFid
op_assign
op_star
id|dirfid
suffix:semicolon
id|inp-&gt;coda_create.attr.va_mode
op_assign
id|mode
suffix:semicolon
id|inp-&gt;coda_create.attr.va_rdev
op_assign
id|rdev
suffix:semicolon
id|inp-&gt;coda_create.excl
op_assign
id|excl
suffix:semicolon
id|inp-&gt;coda_create.mode
op_assign
id|mode
suffix:semicolon
id|inp-&gt;coda_create.name
op_assign
id|offset
suffix:semicolon
multiline_comment|/* Venus must get null terminated string */
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|inp
)paren
op_plus
id|offset
comma
id|name
comma
id|length
)paren
suffix:semicolon
op_star
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|offset
op_plus
id|length
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
op_star
id|attrs
op_assign
id|outp-&gt;coda_create.attr
suffix:semicolon
op_star
id|newfid
op_assign
id|outp-&gt;coda_create.VFid
suffix:semicolon
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|venus_rmdir
r_int
id|venus_rmdir
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|dirfid
comma
r_const
r_char
op_star
id|name
comma
r_int
id|length
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
r_int
id|offset
suffix:semicolon
id|offset
op_assign
id|INSIZE
c_func
(paren
id|rmdir
)paren
suffix:semicolon
id|insize
op_assign
id|max
c_func
(paren
id|offset
op_plus
id|length
op_plus
l_int|1
comma
id|OUTSIZE
c_func
(paren
id|rmdir
)paren
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CODA_RMDIR
)paren
suffix:semicolon
id|inp-&gt;coda_rmdir.VFid
op_assign
op_star
id|dirfid
suffix:semicolon
id|inp-&gt;coda_rmdir.name
op_assign
id|offset
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|inp
)paren
op_plus
id|offset
comma
id|name
comma
id|length
)paren
suffix:semicolon
op_star
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|offset
op_plus
id|length
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|venus_remove
r_int
id|venus_remove
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|dirfid
comma
r_const
r_char
op_star
id|name
comma
r_int
id|length
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|error
op_assign
l_int|0
comma
id|insize
comma
id|outsize
comma
id|offset
suffix:semicolon
id|offset
op_assign
id|INSIZE
c_func
(paren
id|remove
)paren
suffix:semicolon
id|insize
op_assign
id|max
c_func
(paren
id|offset
op_plus
id|length
op_plus
l_int|1
comma
id|OUTSIZE
c_func
(paren
id|remove
)paren
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CODA_REMOVE
)paren
suffix:semicolon
id|inp-&gt;coda_remove.VFid
op_assign
op_star
id|dirfid
suffix:semicolon
id|inp-&gt;coda_remove.name
op_assign
id|offset
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|inp
)paren
op_plus
id|offset
comma
id|name
comma
id|length
)paren
suffix:semicolon
op_star
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|offset
op_plus
id|length
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|venus_readlink
r_int
id|venus_readlink
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
comma
r_char
op_star
id|buffer
comma
r_int
op_star
id|length
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
r_int
id|retlen
suffix:semicolon
r_char
op_star
id|result
suffix:semicolon
id|insize
op_assign
id|max
c_func
(paren
id|INSIZE
c_func
(paren
id|readlink
)paren
comma
id|OUTSIZE
c_func
(paren
id|readlink
)paren
op_plus
op_star
id|length
op_plus
l_int|1
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CODA_READLINK
)paren
suffix:semicolon
id|inp-&gt;coda_readlink.VFid
op_assign
op_star
id|fid
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
(brace
id|retlen
op_assign
id|outp-&gt;coda_readlink.count
suffix:semicolon
r_if
c_cond
(paren
id|retlen
OG
op_star
id|length
)paren
id|retlen
op_assign
op_star
id|length
suffix:semicolon
op_star
id|length
op_assign
id|retlen
suffix:semicolon
id|result
op_assign
(paren
r_char
op_star
)paren
id|outp
op_plus
(paren
r_int
)paren
id|outp-&gt;coda_readlink.data
suffix:semicolon
id|memcpy
c_func
(paren
id|buffer
comma
id|result
comma
id|retlen
)paren
suffix:semicolon
op_star
(paren
id|buffer
op_plus
id|retlen
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot; result %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|venus_link
r_int
id|venus_link
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
comma
r_struct
id|ViceFid
op_star
id|dirfid
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
r_int
id|offset
suffix:semicolon
id|offset
op_assign
id|INSIZE
c_func
(paren
id|link
)paren
suffix:semicolon
id|insize
op_assign
id|max
c_func
(paren
id|offset
op_plus
id|len
op_plus
l_int|1
comma
id|OUTSIZE
c_func
(paren
id|link
)paren
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CODA_LINK
)paren
suffix:semicolon
id|inp-&gt;coda_link.sourceFid
op_assign
op_star
id|fid
suffix:semicolon
id|inp-&gt;coda_link.destFid
op_assign
op_star
id|dirfid
suffix:semicolon
id|inp-&gt;coda_link.tname
op_assign
id|offset
suffix:semicolon
multiline_comment|/* make sure strings are null terminated */
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|inp
)paren
op_plus
id|offset
comma
id|name
comma
id|len
)paren
suffix:semicolon
op_star
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|offset
op_plus
id|len
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot; result %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|venus_symlink
r_int
id|venus_symlink
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
comma
r_const
r_char
op_star
id|symname
comma
r_int
id|symlen
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
r_int
id|offset
comma
id|s
suffix:semicolon
id|offset
op_assign
id|INSIZE
c_func
(paren
id|symlink
)paren
suffix:semicolon
id|insize
op_assign
id|max
c_func
(paren
id|offset
op_plus
id|len
op_plus
id|symlen
op_plus
l_int|8
comma
id|OUTSIZE
c_func
(paren
id|symlink
)paren
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CODA_SYMLINK
)paren
suffix:semicolon
multiline_comment|/*        inp-&gt;coda_symlink.attr = *tva; XXXXXX */
id|inp-&gt;coda_symlink.VFid
op_assign
op_star
id|fid
suffix:semicolon
multiline_comment|/* Round up to word boundary and null terminate */
id|inp-&gt;coda_symlink.srcname
op_assign
id|offset
suffix:semicolon
id|s
op_assign
(paren
id|symlen
op_amp
op_complement
l_int|0x3
)paren
op_plus
l_int|4
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|inp
)paren
op_plus
id|offset
comma
id|symname
comma
id|symlen
)paren
suffix:semicolon
op_star
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|offset
op_plus
id|symlen
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
multiline_comment|/* Round up to word boundary and null terminate */
id|offset
op_add_assign
id|s
suffix:semicolon
id|inp-&gt;coda_symlink.tname
op_assign
id|offset
suffix:semicolon
id|s
op_assign
(paren
id|len
op_amp
op_complement
l_int|0x3
)paren
op_plus
l_int|4
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|inp
)paren
op_plus
id|offset
comma
id|name
comma
id|len
)paren
suffix:semicolon
op_star
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|offset
op_plus
id|len
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot; result %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|venus_fsync
r_int
id|venus_fsync
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
id|insize
op_assign
id|SIZE
c_func
(paren
id|fsync
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CODA_FSYNC
)paren
suffix:semicolon
id|inp-&gt;coda_fsync.VFid
op_assign
op_star
id|fid
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
r_sizeof
(paren
r_union
id|inputArgs
)paren
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|venus_access
r_int
id|venus_access
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
comma
r_int
id|mask
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
id|insize
op_assign
id|SIZE
c_func
(paren
id|access
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CODA_ACCESS
)paren
suffix:semicolon
id|inp-&gt;coda_access.VFid
op_assign
op_star
id|fid
suffix:semicolon
id|inp-&gt;coda_access.flags
op_assign
id|mask
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|venus_pioctl
r_int
id|venus_pioctl
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
comma
r_int
r_int
id|cmd
comma
r_struct
id|PioctlData
op_star
id|data
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
r_int
id|iocsize
suffix:semicolon
id|insize
op_assign
id|VC_MAXMSGSIZE
suffix:semicolon
id|UPARG
c_func
(paren
id|CODA_IOCTL
)paren
suffix:semicolon
multiline_comment|/* build packet for Venus */
r_if
c_cond
(paren
id|data-&gt;vi.in_size
OG
id|VC_MAXDATASIZE
)paren
(brace
id|error
op_assign
id|EINVAL
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|inp-&gt;coda_ioctl.VFid
op_assign
op_star
id|fid
suffix:semicolon
multiline_comment|/* the cmd field was mutated by increasing its size field to&n;         * reflect the path and follow args. We need to subtract that&n;         * out before sending the command to Venus.  */
id|inp-&gt;coda_ioctl.cmd
op_assign
(paren
id|cmd
op_amp
op_complement
(paren
id|PIOCPARM_MASK
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
id|iocsize
op_assign
(paren
(paren
id|cmd
op_rshift
l_int|16
)paren
op_amp
id|PIOCPARM_MASK
)paren
op_minus
r_sizeof
(paren
r_char
op_star
)paren
op_minus
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|inp-&gt;coda_ioctl.cmd
op_or_assign
(paren
id|iocsize
op_amp
id|PIOCPARM_MASK
)paren
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/* in-&gt;coda_ioctl.rwflag = flag; */
id|inp-&gt;coda_ioctl.len
op_assign
id|data-&gt;vi.in_size
suffix:semicolon
id|inp-&gt;coda_ioctl.data
op_assign
(paren
r_char
op_star
)paren
(paren
id|INSIZE
c_func
(paren
id|ioctl
)paren
)paren
suffix:semicolon
multiline_comment|/* get the data out of user space */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
(paren
r_int
)paren
id|inp-&gt;coda_ioctl.data
comma
id|data-&gt;vi.in
comma
id|data-&gt;vi.in_size
)paren
)paren
(brace
id|error
op_assign
id|EINVAL
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|SIZE
c_func
(paren
id|ioctl
)paren
op_plus
id|data-&gt;vi.in_size
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;coda_pioctl: Venus returns: %d for %s&bslash;n&quot;
comma
id|error
comma
id|coda_f2s
c_func
(paren
id|fid
)paren
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
multiline_comment|/* Copy out the OUT buffer. */
r_if
c_cond
(paren
id|outp-&gt;coda_ioctl.len
OG
id|data-&gt;vi.out_size
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_FILE
comma
l_string|&quot;return len %d &lt;= request len %d&bslash;n&quot;
comma
id|outp-&gt;coda_ioctl.len
comma
id|data-&gt;vi.out_size
)paren
suffix:semicolon
id|error
op_assign
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|data-&gt;vi.out
comma
id|data-&gt;vi.out_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_goto
m_exit
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|data-&gt;vi.out
comma
(paren
r_char
op_star
)paren
id|outp
op_plus
(paren
r_int
)paren
id|outp-&gt;coda_ioctl.data
comma
id|data-&gt;vi.out_size
)paren
)paren
(brace
id|error
op_assign
id|EINVAL
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
)brace
m_exit
suffix:colon
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|venus_statfs
r_int
id|venus_statfs
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|statfs
op_star
id|sfs
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
id|insize
op_assign
id|max
c_func
(paren
id|INSIZE
c_func
(paren
id|statfs
)paren
comma
id|OUTSIZE
c_func
(paren
id|statfs
)paren
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CODA_STATFS
)paren
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
(brace
id|sfs-&gt;f_blocks
op_assign
id|outp-&gt;coda_statfs.stat.f_blocks
suffix:semicolon
id|sfs-&gt;f_bfree
op_assign
id|outp-&gt;coda_statfs.stat.f_bfree
suffix:semicolon
id|sfs-&gt;f_bavail
op_assign
id|outp-&gt;coda_statfs.stat.f_bavail
suffix:semicolon
id|sfs-&gt;f_files
op_assign
id|outp-&gt;coda_statfs.stat.f_files
suffix:semicolon
id|sfs-&gt;f_ffree
op_assign
id|outp-&gt;coda_statfs.stat.f_ffree
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;coda_statfs: Venus returns: %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot; result %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/*&n; * coda_upcall and coda_downcall routines.&n; * &n; */
DECL|function|coda_waitfor_upcall
r_static
r_inline
r_int
r_int
id|coda_waitfor_upcall
c_func
(paren
r_struct
id|upc_req
op_star
id|vmp
comma
r_struct
id|venus_comm
op_star
id|vcommp
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_struct
id|timeval
id|begin
op_assign
(brace
l_int|0
comma
l_int|0
)brace
comma
id|end
op_assign
(brace
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|vmp-&gt;uc_posttime
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|coda_upcall_timestamping
)paren
id|do_gettimeofday
c_func
(paren
op_amp
id|begin
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|vmp-&gt;uc_sleep
comma
op_amp
id|wait
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|coda_hard
op_logical_and
id|vmp-&gt;uc_opcode
op_ne
id|CODA_CLOSE
)paren
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
r_else
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
multiline_comment|/* venus died */
r_if
c_cond
(paren
op_logical_neg
id|vcommp-&gt;vc_inuse
)paren
r_break
suffix:semicolon
multiline_comment|/* got a reply */
r_if
c_cond
(paren
id|vmp-&gt;uc_flags
op_amp
(paren
id|REQ_WRITE
op_or
id|REQ_ABORT
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|coda_hard
op_logical_and
id|vmp-&gt;uc_opcode
op_ne
id|CODA_CLOSE
op_logical_and
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
multiline_comment|/* if this process really wants to die, let it go */
r_if
c_cond
(paren
id|sigismember
c_func
(paren
op_amp
(paren
id|current-&gt;pending.signal
)paren
comma
id|SIGKILL
)paren
op_logical_or
id|sigismember
c_func
(paren
op_amp
(paren
id|current-&gt;pending.signal
)paren
comma
id|SIGINT
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* signal is present: after timeout always return &n;&t;&t;&t;   really smart idea, probably useless ... */
r_if
c_cond
(paren
id|jiffies
op_minus
id|vmp-&gt;uc_posttime
OG
id|coda_timeout
op_star
id|HZ
)paren
r_break
suffix:semicolon
)brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
id|remove_wait_queue
c_func
(paren
op_amp
id|vmp-&gt;uc_sleep
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
r_if
c_cond
(paren
id|coda_upcall_timestamping
op_logical_and
id|begin.tv_sec
op_ne
l_int|0
)paren
(brace
id|do_gettimeofday
c_func
(paren
op_amp
id|end
)paren
suffix:semicolon
r_if
c_cond
(paren
id|end.tv_usec
OL
id|begin.tv_usec
)paren
(brace
id|end.tv_usec
op_add_assign
l_int|1000000
suffix:semicolon
id|end.tv_sec
op_decrement
suffix:semicolon
)brace
id|end.tv_sec
op_sub_assign
id|begin.tv_sec
suffix:semicolon
id|end.tv_usec
op_sub_assign
id|begin.tv_usec
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_SPECIAL
comma
l_string|&quot;begin: %ld.%06ld, elapsed: %ld.%06ld&bslash;n&quot;
comma
id|begin.tv_sec
comma
(paren
r_int
r_int
)paren
id|begin.tv_usec
comma
id|end.tv_sec
comma
(paren
r_int
r_int
)paren
id|end.tv_usec
)paren
suffix:semicolon
r_return
(paren
(paren
id|end.tv_sec
op_star
l_int|1000000
)paren
op_plus
id|end.tv_usec
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * coda_upcall will return an error in the case of &n; * failed communication with Venus _or_ will peek at Venus&n; * reply and return Venus&squot; error.&n; *&n; * As venus has 2 types of errors, normal errors (positive) and internal&n; * errors (negative), normal errors are negated, while internal errors&n; * are all mapped to -EINTR, while showing a nice warning message. (jh)&n; * &n; */
DECL|function|coda_upcall
r_static
r_int
id|coda_upcall
c_func
(paren
r_struct
id|coda_sb_info
op_star
id|sbi
comma
r_int
id|inSize
comma
r_int
op_star
id|outSize
comma
r_union
id|inputArgs
op_star
id|buffer
)paren
(brace
r_int
r_int
id|runtime
suffix:semicolon
r_struct
id|venus_comm
op_star
id|vcommp
suffix:semicolon
r_union
id|outputArgs
op_star
id|out
suffix:semicolon
r_struct
id|upc_req
op_star
id|req
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
id|ENTRY
suffix:semicolon
id|vcommp
op_assign
id|sbi-&gt;sbi_vcomm
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vcommp-&gt;vc_inuse
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;No pseudo device in upcall comms at %p&bslash;n&quot;
comma
id|vcommp
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
multiline_comment|/* Format the request message. */
id|CODA_ALLOC
c_func
(paren
id|req
comma
r_struct
id|upc_req
op_star
comma
r_sizeof
(paren
r_struct
id|upc_req
)paren
)paren
suffix:semicolon
id|req-&gt;uc_data
op_assign
(paren
r_void
op_star
)paren
id|buffer
suffix:semicolon
id|req-&gt;uc_flags
op_assign
l_int|0
suffix:semicolon
id|req-&gt;uc_inSize
op_assign
id|inSize
suffix:semicolon
id|req-&gt;uc_outSize
op_assign
op_star
id|outSize
ques
c_cond
op_star
id|outSize
suffix:colon
id|inSize
suffix:semicolon
id|req-&gt;uc_opcode
op_assign
(paren
(paren
r_union
id|inputArgs
op_star
)paren
id|buffer
)paren
op_member_access_from_pointer
id|ih.opcode
suffix:semicolon
id|req-&gt;uc_unique
op_assign
op_increment
id|vcommp-&gt;vc_seq
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|req-&gt;uc_sleep
)paren
suffix:semicolon
multiline_comment|/* Fill in the common input args. */
(paren
(paren
r_union
id|inputArgs
op_star
)paren
id|buffer
)paren
op_member_access_from_pointer
id|ih.unique
op_assign
id|req-&gt;uc_unique
suffix:semicolon
multiline_comment|/* Append msg to pending queue and poke Venus. */
id|list_add
c_func
(paren
op_amp
(paren
id|req-&gt;uc_chain
)paren
comma
id|vcommp-&gt;vc_pending.prev
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_UPCALL
comma
l_string|&quot;Proc %d wake Venus for(opc,uniq) =(%d,%d) msg at %p.zzz.&bslash;n&quot;
comma
id|current-&gt;pid
comma
id|req-&gt;uc_opcode
comma
id|req-&gt;uc_unique
comma
id|req
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|vcommp-&gt;vc_waitq
)paren
suffix:semicolon
multiline_comment|/* We can be interrupted while we wait for Venus to process&n;&t; * our request.  If the interrupt occurs before Venus has read&n;&t; * the request, we dequeue and return. If it occurs after the&n;&t; * read but before the reply, we dequeue, send a signal&n;&t; * message, and return. If it occurs after the reply we ignore&n;&t; * it. In no case do we want to restart the syscall.  If it&n;&t; * was interrupted by a venus shutdown (psdev_close), return&n;&t; * ENODEV.  */
multiline_comment|/* Go to sleep.  Wake up on signals only after the timeout. */
id|runtime
op_assign
id|coda_waitfor_upcall
c_func
(paren
id|req
comma
id|vcommp
)paren
suffix:semicolon
id|coda_upcall_stats
c_func
(paren
(paren
(paren
r_union
id|inputArgs
op_star
)paren
id|buffer
)paren
op_member_access_from_pointer
id|ih.opcode
comma
id|runtime
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_TIMING
comma
l_string|&quot;opc: %d time: %ld uniq: %d size: %d&bslash;n&quot;
comma
id|req-&gt;uc_opcode
comma
id|jiffies
op_minus
id|req-&gt;uc_posttime
comma
id|req-&gt;uc_unique
comma
id|req-&gt;uc_outSize
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_UPCALL
comma
l_string|&quot;..process %d woken up by Venus for req at %p, data at %p&bslash;n&quot;
comma
id|current-&gt;pid
comma
id|req
comma
id|req-&gt;uc_data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vcommp-&gt;vc_inuse
)paren
(brace
multiline_comment|/* i.e. Venus is still alive */
multiline_comment|/* Op went through, interrupt or not... */
r_if
c_cond
(paren
id|req-&gt;uc_flags
op_amp
id|REQ_WRITE
)paren
(brace
id|out
op_assign
(paren
r_union
id|outputArgs
op_star
)paren
id|req-&gt;uc_data
suffix:semicolon
multiline_comment|/* here we map positive Venus errors to kernel errors */
id|error
op_assign
op_minus
id|out-&gt;oh.result
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_UPCALL
comma
l_string|&quot;upcall: (u,o,r) (%ld, %ld, %ld) out at %p&bslash;n&quot;
comma
id|out-&gt;oh.unique
comma
id|out-&gt;oh.opcode
comma
id|out-&gt;oh.result
comma
id|out
)paren
suffix:semicolon
op_star
id|outSize
op_assign
id|req-&gt;uc_outSize
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|req-&gt;uc_flags
op_amp
id|REQ_READ
)paren
op_logical_and
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
multiline_comment|/* Interrupted before venus read it. */
id|CDEBUG
c_func
(paren
id|D_UPCALL
comma
l_string|&quot;Interrupted before read:(op,un) (%d.%d), flags = %x&bslash;n&quot;
comma
id|req-&gt;uc_opcode
comma
id|req-&gt;uc_unique
comma
id|req-&gt;uc_flags
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
(paren
id|req-&gt;uc_chain
)paren
)paren
suffix:semicolon
multiline_comment|/* perhaps the best way to convince the app to&n;&t;&t;   give up? */
id|error
op_assign
op_minus
id|EINTR
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|req-&gt;uc_flags
op_amp
id|REQ_READ
)paren
op_logical_and
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
multiline_comment|/* interrupted after Venus did its read, send signal */
r_union
id|inputArgs
op_star
id|sig_inputArgs
suffix:semicolon
r_struct
id|upc_req
op_star
id|sig_req
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_UPCALL
comma
l_string|&quot;Sending Venus a signal: op = %d.%d, flags = %x&bslash;n&quot;
comma
id|req-&gt;uc_opcode
comma
id|req-&gt;uc_unique
comma
id|req-&gt;uc_flags
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
(paren
id|req-&gt;uc_chain
)paren
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EINTR
suffix:semicolon
id|CODA_ALLOC
c_func
(paren
id|sig_req
comma
r_struct
id|upc_req
op_star
comma
r_sizeof
(paren
r_struct
id|upc_req
)paren
)paren
suffix:semicolon
id|CODA_ALLOC
c_func
(paren
(paren
id|sig_req-&gt;uc_data
)paren
comma
r_char
op_star
comma
r_sizeof
(paren
r_struct
id|coda_in_hdr
)paren
)paren
suffix:semicolon
id|sig_inputArgs
op_assign
(paren
r_union
id|inputArgs
op_star
)paren
id|sig_req-&gt;uc_data
suffix:semicolon
id|sig_inputArgs-&gt;ih.opcode
op_assign
id|CODA_SIGNAL
suffix:semicolon
id|sig_inputArgs-&gt;ih.unique
op_assign
id|req-&gt;uc_unique
suffix:semicolon
id|sig_req-&gt;uc_flags
op_assign
id|REQ_ASYNC
suffix:semicolon
id|sig_req-&gt;uc_opcode
op_assign
id|sig_inputArgs-&gt;ih.opcode
suffix:semicolon
id|sig_req-&gt;uc_unique
op_assign
id|sig_inputArgs-&gt;ih.unique
suffix:semicolon
id|sig_req-&gt;uc_inSize
op_assign
r_sizeof
(paren
r_struct
id|coda_in_hdr
)paren
suffix:semicolon
id|sig_req-&gt;uc_outSize
op_assign
r_sizeof
(paren
r_struct
id|coda_in_hdr
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_UPCALL
comma
l_string|&quot;coda_upcall: enqueing signal msg (%d, %d)&bslash;n&quot;
comma
id|sig_req-&gt;uc_opcode
comma
id|sig_req-&gt;uc_unique
)paren
suffix:semicolon
multiline_comment|/* insert at head of queue! */
id|list_add
c_func
(paren
op_amp
(paren
id|sig_req-&gt;uc_chain
)paren
comma
op_amp
id|vcommp-&gt;vc_pending
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|vcommp-&gt;vc_waitq
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;Coda: Strange interruption..&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EINTR
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* If venus died i.e. !VC_OPEN(vcommp) */
id|printk
c_func
(paren
l_string|&quot;coda_upcall: Venus dead on (op,un) (%d.%d) flags %d&bslash;n&quot;
comma
id|req-&gt;uc_opcode
comma
id|req-&gt;uc_unique
comma
id|req-&gt;uc_flags
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|ENODEV
suffix:semicolon
)brace
m_exit
suffix:colon
id|CODA_FREE
c_func
(paren
id|req
comma
r_sizeof
(paren
r_struct
id|upc_req
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
id|badclstats
c_func
(paren
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/*  &n;    The statements below are part of the Coda opportunistic&n;    programming -- taken from the Mach/BSD kernel code for Coda. &n;    You don&squot;t get correct semantics by stating what needs to be&n;    done without guaranteeing the invariants needed for it to happen.&n;    When will be have time to find out what exactly is going on?  (pjb)&n;*/
multiline_comment|/* &n; * There are 7 cases where cache invalidations occur.  The semantics&n; *  of each is listed here:&n; *&n; * CODA_FLUSH     -- flush all entries from the name cache and the cnode cache.&n; * CODA_PURGEUSER -- flush all entries from the name cache for a specific user&n; *                  This call is a result of token expiration.&n; *&n; * The next arise as the result of callbacks on a file or directory.&n; * CODA_ZAPFILE   -- flush the cached attributes for a file.&n;&n; * CODA_ZAPDIR    -- flush the attributes for the dir and&n; *                  force a new lookup for all the children&n;                    of this dir.&n;&n; *&n; * The next is a result of Venus detecting an inconsistent file.&n; * CODA_PURGEFID  -- flush the attribute for the file&n; *                  purge it and its children from the dcache&n; *&n; * The last  allows Venus to replace local fids with global ones&n; * during reintegration.&n; *&n; * CODA_REPLACE -- replace one ViceFid with another throughout the name cache */
DECL|function|coda_downcall
r_int
id|coda_downcall
c_func
(paren
r_int
id|opcode
comma
r_union
id|outputArgs
op_star
id|out
comma
r_struct
id|super_block
op_star
id|sb
)paren
(brace
multiline_comment|/* Handle invalidation requests. */
r_if
c_cond
(paren
op_logical_neg
id|sb
op_logical_or
op_logical_neg
id|sb-&gt;s_root
op_logical_or
op_logical_neg
id|sb-&gt;s_root-&gt;d_inode
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;coda_downcall: opcode %d, no sb!&bslash;n&quot;
comma
id|opcode
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|opcode
)paren
(brace
r_case
id|CODA_FLUSH
suffix:colon
(brace
id|clstats
c_func
(paren
id|CODA_FLUSH
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;CODA_FLUSH&bslash;n&quot;
)paren
suffix:semicolon
id|coda_cache_clear_all
c_func
(paren
id|sb
comma
l_int|NULL
)paren
suffix:semicolon
id|shrink_dcache_sb
c_func
(paren
id|sb
)paren
suffix:semicolon
id|coda_flag_inode
c_func
(paren
id|sb-&gt;s_root-&gt;d_inode
comma
id|C_FLUSH
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|CODA_PURGEUSER
suffix:colon
(brace
r_struct
id|coda_cred
op_star
id|cred
op_assign
op_amp
id|out-&gt;coda_purgeuser.cred
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;CODA_PURGEUSER&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cred
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PURGEUSER: null cred!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|clstats
c_func
(paren
id|CODA_PURGEUSER
)paren
suffix:semicolon
id|coda_cache_clear_all
c_func
(paren
id|sb
comma
id|cred
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|CODA_ZAPDIR
suffix:colon
(brace
r_struct
id|inode
op_star
id|inode
suffix:semicolon
id|ViceFid
op_star
id|fid
op_assign
op_amp
id|out-&gt;coda_zapdir.CodaFid
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;zapdir: fid = %s...&bslash;n&quot;
comma
id|coda_f2s
c_func
(paren
id|fid
)paren
)paren
suffix:semicolon
id|clstats
c_func
(paren
id|CODA_ZAPDIR
)paren
suffix:semicolon
id|inode
op_assign
id|coda_fid_to_inode
c_func
(paren
id|fid
comma
id|sb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inode
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;zapdir: inode = %ld children flagged&bslash;n&quot;
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
id|coda_flag_inode_children
c_func
(paren
id|inode
comma
id|C_PURGE
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;zapdir: inode = %ld cache cleared&bslash;n&quot;
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
id|coda_flag_inode
c_func
(paren
id|inode
comma
id|C_VATTR
)paren
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
r_else
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;zapdir: no inode&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|CODA_ZAPFILE
suffix:colon
(brace
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_struct
id|ViceFid
op_star
id|fid
op_assign
op_amp
id|out-&gt;coda_zapfile.CodaFid
suffix:semicolon
id|clstats
c_func
(paren
id|CODA_ZAPFILE
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;zapfile: fid = %s&bslash;n&quot;
comma
id|coda_f2s
c_func
(paren
id|fid
)paren
)paren
suffix:semicolon
id|inode
op_assign
id|coda_fid_to_inode
c_func
(paren
id|fid
comma
id|sb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inode
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;zapfile: inode = %ld&bslash;n&quot;
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
id|coda_flag_inode
c_func
(paren
id|inode
comma
id|C_VATTR
)paren
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
r_else
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;zapfile: no inode&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|CODA_PURGEFID
suffix:colon
(brace
r_struct
id|inode
op_star
id|inode
suffix:semicolon
id|ViceFid
op_star
id|fid
op_assign
op_amp
id|out-&gt;coda_purgefid.CodaFid
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;purgefid: fid = %s&bslash;n&quot;
comma
id|coda_f2s
c_func
(paren
id|fid
)paren
)paren
suffix:semicolon
id|clstats
c_func
(paren
id|CODA_PURGEFID
)paren
suffix:semicolon
id|inode
op_assign
id|coda_fid_to_inode
c_func
(paren
id|fid
comma
id|sb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inode
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;purgefid: inode = %ld&bslash;n&quot;
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
id|coda_flag_inode_children
c_func
(paren
id|inode
comma
id|C_PURGE
)paren
suffix:semicolon
id|coda_purge_dentries
c_func
(paren
id|inode
)paren
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
r_else
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;purgefid: no inode&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|CODA_REPLACE
suffix:colon
(brace
r_struct
id|inode
op_star
id|inode
suffix:semicolon
id|ViceFid
op_star
id|oldfid
op_assign
op_amp
id|out-&gt;coda_replace.OldFid
suffix:semicolon
id|ViceFid
op_star
id|newfid
op_assign
op_amp
id|out-&gt;coda_replace.NewFid
suffix:semicolon
id|clstats
c_func
(paren
id|CODA_REPLACE
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;CODA_REPLACE&bslash;n&quot;
)paren
suffix:semicolon
id|inode
op_assign
id|coda_fid_to_inode
c_func
(paren
id|oldfid
comma
id|sb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inode
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;replacefid: inode = %ld&bslash;n&quot;
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
id|coda_replace_fid
c_func
(paren
id|inode
comma
id|oldfid
comma
id|newfid
)paren
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
r_else
(brace
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;purgefid: no inode&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
eof
