multiline_comment|/*&n; * Mostly platform independent upcall operations to Venus:&n; *  -- upcalls&n; *  -- upcall routines&n; *&n; * Linux 2.0 version&n; * Copyright (C) 1996 Peter J. Braam &lt;braam@maths.ox.ac.uk&gt;, &n; * Michael Callahan &lt;callahan@maths.ox.ac.uk&gt; &n; * &n; * Redone for Linux 2.1&n; * Copyright (C) 1997 Carnegie Mellon University&n; *&n; * Carnegie Mellon University encourages users of this code to contribute&n; * improvements to the Coda project. Contact Peter Braam &lt;coda@cs.cmu.edu&gt;.&n; */
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/locks.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;linux/coda.h&gt;
macro_line|#include &lt;linux/coda_linux.h&gt;
macro_line|#include &lt;linux/coda_psdev.h&gt;
macro_line|#include &lt;linux/coda_cnode.h&gt;
macro_line|#include &lt;linux/coda_namecache.h&gt;
DECL|variable|vcsize
r_static
id|vcsize
op_assign
(paren
r_sizeof
(paren
r_struct
id|inputArgs
)paren
OG
r_sizeof
(paren
r_struct
id|outputArgs
)paren
)paren
ques
c_cond
r_sizeof
(paren
r_struct
id|inputArgs
)paren
suffix:colon
r_sizeof
(paren
r_struct
id|outputArgs
)paren
suffix:semicolon
multiline_comment|/* the upcalls */
DECL|function|venus_rootfid
r_int
id|venus_rootfid
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
id|ViceFid
op_star
id|fidp
)paren
(brace
r_struct
id|inputArgs
op_star
id|inp
suffix:semicolon
r_struct
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_int
id|size
suffix:semicolon
id|ENTRY
suffix:semicolon
id|UPARG
c_func
(paren
id|vcsize
comma
id|CFS_ROOT
)paren
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|VC_IN_NO_DATA
comma
op_amp
id|size
comma
id|inp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;coda_get_rootfid: error %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
)brace
r_else
(brace
op_star
id|fidp
op_assign
(paren
id|ViceFid
)paren
id|outp-&gt;d.cfs_root.VFid
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_SUPER
comma
l_string|&quot;VolumeId: %lx, VnodeId: %lx.&bslash;n&quot;
comma
id|fidp-&gt;Volume
comma
id|fidp-&gt;Vnode
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
id|VC_IN_NO_DATA
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
DECL|function|venus_getattr
r_int
id|venus_getattr
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
comma
r_struct
id|coda_vattr
op_star
id|attr
)paren
(brace
r_struct
id|inputArgs
op_star
id|inp
suffix:semicolon
r_struct
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|size
comma
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
id|UPARG
c_func
(paren
id|vcsize
comma
id|CFS_GETATTR
)paren
suffix:semicolon
id|inp-&gt;d.cfs_getattr.VFid
op_assign
op_star
id|fid
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|vcsize
comma
op_amp
id|size
comma
id|inp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
op_star
id|attr
op_assign
(paren
r_struct
id|coda_vattr
)paren
id|outp-&gt;d.cfs_getattr.attr
suffix:semicolon
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
r_sizeof
(paren
r_struct
id|inputArgs
)paren
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
DECL|function|venus_setattr
r_int
id|venus_setattr
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
comma
r_struct
id|coda_vattr
op_star
id|vattr
)paren
(brace
r_struct
id|inputArgs
op_star
id|inp
suffix:semicolon
r_struct
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|error
comma
id|size
suffix:semicolon
id|UPARG
c_func
(paren
id|vcsize
comma
id|CFS_SETATTR
)paren
suffix:semicolon
id|inp-&gt;d.cfs_setattr.VFid
op_assign
op_star
id|fid
suffix:semicolon
id|inp-&gt;d.cfs_setattr.attr
op_assign
op_star
id|vattr
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|vcsize
comma
op_amp
id|size
comma
id|inp
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_SUPER
comma
l_string|&quot; result %ld&bslash;n&quot;
comma
id|outp-&gt;result
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
id|vcsize
)paren
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
DECL|function|venus_lookup
r_int
id|venus_lookup
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
comma
r_const
r_char
op_star
id|name
comma
r_int
id|length
comma
r_int
op_star
id|type
comma
r_struct
id|ViceFid
op_star
id|resfid
)paren
(brace
r_struct
id|inputArgs
op_star
id|inp
suffix:semicolon
r_struct
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|size
comma
id|error
op_assign
l_int|0
comma
id|payload_offset
suffix:semicolon
id|insize
op_assign
id|VC_INSIZE
c_func
(paren
id|cfs_lookup_in
)paren
op_plus
id|CFS_MAXNAMLEN
op_plus
l_int|1
suffix:semicolon
id|UPARG
c_func
(paren
id|insize
comma
id|CFS_LOOKUP
)paren
suffix:semicolon
id|inp-&gt;d.cfs_lookup.VFid
op_assign
op_star
id|fid
suffix:semicolon
multiline_comment|/* send Venus a null terminated string */
id|payload_offset
op_assign
id|VC_INSIZE
c_func
(paren
id|cfs_lookup_in
)paren
suffix:semicolon
id|inp-&gt;d.cfs_lookup.name
op_assign
(paren
r_char
op_star
)paren
id|payload_offset
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|payload_offset
comma
id|name
comma
id|length
)paren
suffix:semicolon
op_star
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|payload_offset
op_plus
id|length
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|size
op_assign
id|payload_offset
op_plus
id|length
op_plus
l_int|1
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|size
comma
op_amp
id|size
comma
id|inp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
(brace
op_star
id|resfid
op_assign
id|outp-&gt;d.cfs_lookup.VFid
suffix:semicolon
op_star
id|type
op_assign
id|outp-&gt;d.cfs_lookup.vtype
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
DECL|function|venus_release
r_int
id|venus_release
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
comma
r_int
id|flags
)paren
(brace
r_struct
id|inputArgs
op_star
id|inp
suffix:semicolon
r_struct
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|size
op_assign
r_sizeof
(paren
r_struct
id|outputArgs
)paren
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
id|CODA_ALLOC
c_func
(paren
id|inp
comma
r_struct
id|inputArgs
op_star
comma
r_sizeof
(paren
r_struct
id|inputArgs
)paren
)paren
suffix:semicolon
id|outp
op_assign
(paren
r_struct
id|outputArgs
op_star
)paren
id|inp
suffix:semicolon
id|INIT_IN
c_func
(paren
id|inp
comma
id|CFS_CLOSE
)paren
suffix:semicolon
id|coda_load_creds
c_func
(paren
op_amp
(paren
id|inp-&gt;cred
)paren
)paren
suffix:semicolon
id|inp-&gt;d.cfs_close.VFid
op_assign
op_star
id|fid
suffix:semicolon
id|inp-&gt;d.cfs_close.flags
op_assign
id|flags
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|size
comma
op_amp
id|size
comma
id|inp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
r_sizeof
(paren
r_struct
id|inputArgs
)paren
)paren
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
DECL|function|venus_open
r_int
id|venus_open
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
comma
r_int
id|flags
comma
id|ino_t
op_star
id|ino
comma
id|dev_t
op_star
id|dev
)paren
(brace
r_struct
id|inputArgs
op_star
id|inp
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|outputArgs
op_star
id|outp
op_assign
l_int|NULL
suffix:semicolon
r_int
id|size
op_assign
r_sizeof
(paren
r_struct
id|inputArgs
)paren
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
id|CODA_ALLOC
c_func
(paren
id|inp
comma
r_struct
id|inputArgs
op_star
comma
r_sizeof
(paren
r_struct
id|inputArgs
)paren
)paren
suffix:semicolon
id|outp
op_assign
(paren
r_struct
id|outputArgs
op_star
)paren
id|inp
suffix:semicolon
id|INIT_IN
c_func
(paren
id|inp
comma
id|CFS_OPEN
)paren
suffix:semicolon
id|coda_load_creds
c_func
(paren
op_amp
(paren
id|inp-&gt;cred
)paren
)paren
suffix:semicolon
id|inp-&gt;d.cfs_open.VFid
op_assign
op_star
id|fid
suffix:semicolon
id|inp-&gt;d.cfs_open.flags
op_assign
id|flags
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|size
comma
op_amp
id|size
comma
id|inp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
(brace
op_star
id|ino
op_assign
id|outp-&gt;d.cfs_open.inode
suffix:semicolon
op_star
id|dev
op_assign
id|outp-&gt;d.cfs_open.dev
suffix:semicolon
)brace
r_else
(brace
op_star
id|ino
op_assign
l_int|0
suffix:semicolon
op_star
id|dev
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
r_sizeof
(paren
r_struct
id|inputArgs
)paren
)paren
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
DECL|function|venus_mkdir
r_int
id|venus_mkdir
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|dirfid
comma
r_const
r_char
op_star
id|name
comma
r_int
id|length
comma
r_struct
id|ViceFid
op_star
id|newfid
comma
r_struct
id|coda_vattr
op_star
id|attrs
)paren
(brace
r_struct
id|inputArgs
op_star
id|inp
suffix:semicolon
r_struct
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|error
op_assign
l_int|0
comma
id|size
comma
id|payload_offset
suffix:semicolon
id|payload_offset
op_assign
id|VC_INSIZE
c_func
(paren
id|cfs_mkdir_in
)paren
suffix:semicolon
id|size
op_assign
id|CFS_MAXNAMLEN
op_plus
id|payload_offset
suffix:semicolon
id|UPARG
c_func
(paren
id|size
comma
id|CFS_MKDIR
)paren
suffix:semicolon
id|inp-&gt;d.cfs_mkdir.VFid
op_assign
op_star
id|dirfid
suffix:semicolon
id|inp-&gt;d.cfs_mkdir.attr
op_assign
op_star
id|attrs
suffix:semicolon
id|inp-&gt;d.cfs_mkdir.name
op_assign
(paren
r_char
op_star
)paren
id|payload_offset
suffix:semicolon
multiline_comment|/* Venus must get null terminated string */
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|payload_offset
comma
id|name
comma
id|length
)paren
suffix:semicolon
op_star
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|payload_offset
op_plus
id|length
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|size
op_assign
id|payload_offset
op_plus
id|length
op_plus
l_int|1
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|size
comma
op_amp
id|size
comma
id|inp
)paren
suffix:semicolon
op_star
id|attrs
op_assign
id|outp-&gt;d.cfs_mkdir.attr
suffix:semicolon
op_star
id|newfid
op_assign
id|outp-&gt;d.cfs_mkdir.VFid
suffix:semicolon
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
id|size
)paren
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
DECL|function|venus_rename
r_int
id|venus_rename
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|old_fid
comma
r_struct
id|ViceFid
op_star
id|new_fid
comma
r_int
id|old_length
comma
r_int
id|new_length
comma
r_const
r_char
op_star
id|old_name
comma
r_const
r_char
op_star
id|new_name
)paren
(brace
r_struct
id|inputArgs
op_star
id|inp
suffix:semicolon
r_struct
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|error
comma
id|offset
comma
id|size
comma
id|s
suffix:semicolon
id|size
op_assign
l_int|2
op_star
id|CFS_MAXNAMLEN
op_plus
id|VC_INSIZE
c_func
(paren
id|cfs_rename_in
)paren
op_plus
l_int|8
suffix:semicolon
id|UPARG
c_func
(paren
id|size
comma
id|CFS_RENAME
)paren
suffix:semicolon
id|inp-&gt;d.cfs_rename.sourceFid
op_assign
op_star
id|old_fid
suffix:semicolon
id|inp-&gt;d.cfs_rename.destFid
op_assign
op_star
id|new_fid
suffix:semicolon
id|offset
op_assign
id|VC_INSIZE
c_func
(paren
id|cfs_rename_in
)paren
suffix:semicolon
multiline_comment|/* Venus must receive an null terminated string */
id|inp-&gt;d.cfs_rename.srcname
op_assign
(paren
r_char
op_star
)paren
id|offset
suffix:semicolon
id|s
op_assign
(paren
id|old_length
op_amp
op_complement
l_int|0x3
)paren
op_plus
l_int|4
suffix:semicolon
multiline_comment|/* round up to word boundary */
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|offset
comma
id|old_name
comma
id|old_length
)paren
suffix:semicolon
op_star
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|offset
op_plus
id|old_length
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
multiline_comment|/* another null terminated string for Venus */
id|offset
op_add_assign
id|s
suffix:semicolon
id|inp-&gt;d.cfs_rename.destname
op_assign
(paren
r_char
op_star
)paren
id|offset
suffix:semicolon
id|s
op_assign
(paren
id|new_length
op_amp
op_complement
l_int|0x3
)paren
op_plus
l_int|4
suffix:semicolon
multiline_comment|/* round up to word boundary */
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|offset
comma
id|new_name
comma
id|new_length
)paren
suffix:semicolon
op_star
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|offset
op_plus
id|new_length
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|size
op_add_assign
id|s
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;destname in packet: %s&bslash;n&quot;
comma
(paren
r_char
op_star
)paren
id|inp
op_plus
(paren
r_int
)paren
id|inp-&gt;d.cfs_rename.destname
)paren
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|size
comma
op_amp
id|size
comma
id|inp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
id|size
)paren
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
DECL|function|venus_create
r_int
id|venus_create
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|dirfid
comma
r_const
r_char
op_star
id|name
comma
r_int
id|length
comma
r_int
id|excl
comma
r_int
id|mode
comma
r_struct
id|ViceFid
op_star
id|newfid
comma
r_struct
id|coda_vattr
op_star
id|attrs
)paren
(brace
r_struct
id|inputArgs
op_star
id|inp
suffix:semicolon
r_struct
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|error
op_assign
l_int|0
comma
id|size
comma
id|payload_offset
suffix:semicolon
id|payload_offset
op_assign
id|VC_INSIZE
c_func
(paren
id|cfs_create_in
)paren
suffix:semicolon
id|size
op_assign
id|CFS_MAXNAMLEN
op_plus
id|payload_offset
suffix:semicolon
id|UPARG
c_func
(paren
id|size
comma
id|CFS_CREATE
)paren
suffix:semicolon
id|inp-&gt;d.cfs_create.VFid
op_assign
op_star
id|dirfid
suffix:semicolon
id|inp-&gt;d.cfs_create.attr.va_mode
op_assign
id|mode
suffix:semicolon
id|inp-&gt;d.cfs_create.excl
op_assign
id|excl
suffix:semicolon
id|inp-&gt;d.cfs_create.mode
op_assign
id|mode
suffix:semicolon
id|inp-&gt;d.cfs_create.name
op_assign
(paren
r_char
op_star
)paren
id|payload_offset
suffix:semicolon
multiline_comment|/* Venus must get null terminated string */
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|payload_offset
comma
id|name
comma
id|length
)paren
suffix:semicolon
op_star
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|payload_offset
op_plus
id|length
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|size
op_assign
id|payload_offset
op_plus
id|length
op_plus
l_int|1
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|size
comma
op_amp
id|size
comma
id|inp
)paren
suffix:semicolon
op_star
id|attrs
op_assign
id|outp-&gt;d.cfs_create.attr
suffix:semicolon
op_star
id|newfid
op_assign
id|outp-&gt;d.cfs_create.VFid
suffix:semicolon
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
id|size
)paren
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
DECL|function|venus_rmdir
r_int
id|venus_rmdir
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|dirfid
comma
r_const
r_char
op_star
id|name
comma
r_int
id|length
)paren
(brace
r_struct
id|inputArgs
op_star
id|inp
suffix:semicolon
r_struct
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|error
op_assign
l_int|0
comma
id|size
comma
id|payload_offset
suffix:semicolon
id|payload_offset
op_assign
id|VC_INSIZE
c_func
(paren
id|cfs_rmdir_in
)paren
suffix:semicolon
id|size
op_assign
id|CFS_MAXNAMLEN
op_plus
id|payload_offset
suffix:semicolon
id|UPARG
c_func
(paren
id|size
comma
id|CFS_RMDIR
)paren
suffix:semicolon
id|inp-&gt;d.cfs_rmdir.VFid
op_assign
op_star
id|dirfid
suffix:semicolon
id|inp-&gt;d.cfs_rmdir.name
op_assign
(paren
r_char
op_star
)paren
id|payload_offset
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|payload_offset
comma
id|name
comma
id|size
)paren
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|size
comma
op_amp
id|size
comma
id|inp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
id|size
)paren
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
DECL|function|venus_remove
r_int
id|venus_remove
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|dirfid
comma
r_const
r_char
op_star
id|name
comma
r_int
id|length
)paren
(brace
r_struct
id|inputArgs
op_star
id|inp
suffix:semicolon
r_struct
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|error
op_assign
l_int|0
comma
id|size
comma
id|payload_offset
suffix:semicolon
id|payload_offset
op_assign
id|VC_INSIZE
c_func
(paren
id|cfs_remove_in
)paren
suffix:semicolon
id|size
op_assign
id|CFS_MAXNAMLEN
op_plus
id|payload_offset
suffix:semicolon
id|UPARG
c_func
(paren
id|size
comma
id|CFS_REMOVE
)paren
suffix:semicolon
id|inp-&gt;d.cfs_remove.VFid
op_assign
op_star
id|dirfid
suffix:semicolon
id|inp-&gt;d.cfs_remove.name
op_assign
(paren
r_char
op_star
)paren
id|payload_offset
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|payload_offset
comma
id|name
comma
id|size
)paren
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|size
comma
op_amp
id|size
comma
id|inp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
id|size
)paren
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
DECL|function|venus_readlink
r_int
id|venus_readlink
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
comma
r_char
op_star
id|buffer
comma
r_int
op_star
id|length
)paren
(brace
r_int
id|error
comma
id|size
comma
id|retlen
suffix:semicolon
r_char
op_star
id|result
suffix:semicolon
r_struct
id|inputArgs
op_star
id|inp
suffix:semicolon
r_struct
id|outputArgs
op_star
id|outp
suffix:semicolon
r_char
op_star
id|buf
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*[CFS_MAXNAMLEN + VC_INSIZE(cfs_readlink_in)];*/
id|size
op_assign
id|CFS_MAXPATHLEN
op_plus
id|VC_INSIZE
c_func
(paren
id|cfs_readlink_in
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|size
comma
id|CFS_READLINK
)paren
suffix:semicolon
id|inp-&gt;d.cfs_readlink.VFid
op_assign
op_star
id|fid
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|size
comma
op_amp
id|size
comma
id|inp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
(brace
id|retlen
op_assign
id|outp-&gt;d.cfs_readlink.count
suffix:semicolon
r_if
c_cond
(paren
id|retlen
OG
op_star
id|length
)paren
id|retlen
op_assign
op_star
id|length
suffix:semicolon
op_star
id|length
op_assign
id|retlen
suffix:semicolon
id|result
op_assign
(paren
r_char
op_star
)paren
id|outp
op_plus
(paren
r_int
)paren
id|outp-&gt;d.cfs_readlink.data
suffix:semicolon
id|memcpy
c_func
(paren
id|buffer
comma
id|result
comma
id|retlen
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|buf
comma
id|size
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot; result %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
DECL|function|venus_link
r_int
id|venus_link
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
comma
r_struct
id|ViceFid
op_star
id|dirfid
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
)paren
(brace
r_int
id|error
comma
id|payload_offset
comma
id|size
suffix:semicolon
r_struct
id|inputArgs
op_star
id|inp
suffix:semicolon
r_struct
id|outputArgs
op_star
id|outp
suffix:semicolon
id|size
op_assign
id|CFS_MAXNAMLEN
op_plus
r_sizeof
(paren
r_struct
id|inputArgs
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|size
comma
id|CFS_LINK
)paren
suffix:semicolon
id|payload_offset
op_assign
(paren
id|VC_INSIZE
c_func
(paren
id|cfs_link_in
)paren
)paren
suffix:semicolon
id|inp-&gt;d.cfs_link.sourceFid
op_assign
op_star
id|fid
suffix:semicolon
id|inp-&gt;d.cfs_link.destFid
op_assign
op_star
id|dirfid
suffix:semicolon
id|inp-&gt;d.cfs_link.tname
op_assign
(paren
r_char
op_star
)paren
id|payload_offset
suffix:semicolon
multiline_comment|/* make sure strings are null terminated */
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|payload_offset
comma
id|name
comma
id|len
)paren
suffix:semicolon
op_star
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|payload_offset
op_plus
id|len
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|size
op_assign
id|payload_offset
op_plus
id|len
op_plus
l_int|1
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|size
comma
op_amp
id|size
comma
id|inp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
id|size
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot; result %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
DECL|function|venus_symlink
r_int
id|venus_symlink
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
comma
r_const
r_char
op_star
id|symname
comma
r_int
id|symlen
)paren
(brace
r_int
id|error
comma
id|payload_offset
comma
id|size
comma
id|s
suffix:semicolon
r_struct
id|inputArgs
op_star
id|inp
suffix:semicolon
r_struct
id|outputArgs
op_star
id|outp
suffix:semicolon
multiline_comment|/* &n;         * allocate space for regular input, &n;         * plus 1 path and 1 name, plus padding &n;         */
id|size
op_assign
r_sizeof
(paren
r_struct
id|inputArgs
)paren
op_plus
id|CFS_MAXNAMLEN
op_plus
id|CFS_MAXNAMLEN
op_plus
l_int|8
suffix:semicolon
id|UPARG
c_func
(paren
id|size
comma
id|CFS_SYMLINK
)paren
suffix:semicolon
multiline_comment|/*        inp-&gt;d.cfs_symlink.attr = *tva; XXXXXX */
id|inp-&gt;d.cfs_symlink.VFid
op_assign
op_star
id|fid
suffix:semicolon
id|payload_offset
op_assign
id|VC_INSIZE
c_func
(paren
id|cfs_symlink_in
)paren
suffix:semicolon
id|inp-&gt;d.cfs_symlink.srcname
op_assign
(paren
r_char
op_star
)paren
id|payload_offset
suffix:semicolon
id|s
op_assign
(paren
id|symlen
op_amp
op_complement
l_int|0x3
)paren
op_plus
l_int|4
suffix:semicolon
multiline_comment|/* Round up to word boundary. */
multiline_comment|/* don&squot;t forget to copy out the null termination */
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|payload_offset
comma
id|symname
comma
id|symlen
)paren
suffix:semicolon
op_star
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|payload_offset
op_plus
id|symlen
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|payload_offset
op_add_assign
id|s
suffix:semicolon
id|inp-&gt;d.cfs_symlink.tname
op_assign
(paren
r_char
op_star
)paren
id|payload_offset
suffix:semicolon
id|s
op_assign
(paren
id|len
op_amp
op_complement
l_int|0x3
)paren
op_plus
l_int|4
suffix:semicolon
multiline_comment|/* Round up to word boundary. */
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|payload_offset
comma
id|name
comma
id|len
)paren
suffix:semicolon
op_star
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|payload_offset
op_plus
id|len
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|size
op_assign
id|payload_offset
op_plus
id|s
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|size
comma
op_amp
id|size
comma
id|inp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
id|size
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot; result %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
DECL|function|venus_access
r_int
id|venus_access
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
comma
r_int
id|mask
)paren
(brace
r_struct
id|inputArgs
op_star
id|inp
suffix:semicolon
r_struct
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|size
suffix:semicolon
r_int
id|error
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
r_struct
id|inputArgs
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|size
comma
id|CFS_ACCESS
)paren
suffix:semicolon
id|inp-&gt;d.cfs_access.VFid
op_assign
op_star
id|fid
suffix:semicolon
id|inp-&gt;d.cfs_access.flags
op_assign
id|mask
op_lshift
l_int|6
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|size
comma
op_amp
id|size
comma
id|inp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
r_sizeof
(paren
r_struct
id|inputArgs
)paren
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
DECL|function|venus_pioctl
r_int
id|venus_pioctl
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
comma
r_int
r_int
id|cmd
comma
r_struct
id|PioctlData
op_star
id|data
)paren
(brace
r_struct
id|inputArgs
op_star
id|inp
suffix:semicolon
r_struct
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|size
comma
id|error
op_assign
l_int|0
suffix:semicolon
r_int
id|iocsize
suffix:semicolon
r_char
id|str
(braket
l_int|50
)braket
suffix:semicolon
id|size
op_assign
id|VC_MAXMSGSIZE
suffix:semicolon
id|UPARG
c_func
(paren
id|size
comma
id|CFS_IOCTL
)paren
suffix:semicolon
multiline_comment|/* build packet for Venus */
r_if
c_cond
(paren
id|data-&gt;vi.in_size
OG
id|VC_DATASIZE
)paren
(brace
id|error
op_assign
id|EINVAL
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|inp-&gt;d.cfs_ioctl.VFid
op_assign
op_star
id|fid
suffix:semicolon
multiline_comment|/* the cmd field was mutated by increasing its size field to&n;         * reflect the path and follow args. We need to subtract that&n;         * out before sending the command to Venus.  */
id|inp-&gt;d.cfs_ioctl.cmd
op_assign
(paren
id|cmd
op_amp
op_complement
(paren
id|IOCPARM_MASK
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
id|iocsize
op_assign
(paren
(paren
id|cmd
op_rshift
l_int|16
)paren
op_amp
id|IOCPARM_MASK
)paren
op_minus
r_sizeof
(paren
r_char
op_star
)paren
op_minus
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|inp-&gt;d.cfs_ioctl.cmd
op_or_assign
(paren
id|iocsize
op_amp
id|IOCPARM_MASK
)paren
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/* in-&gt;d.cfs_ioctl.rwflag = flag; */
id|inp-&gt;d.cfs_ioctl.len
op_assign
id|data-&gt;vi.in_size
suffix:semicolon
id|inp-&gt;d.cfs_ioctl.data
op_assign
(paren
r_char
op_star
)paren
(paren
id|VC_INSIZE
c_func
(paren
id|cfs_ioctl_in
)paren
)paren
suffix:semicolon
multiline_comment|/* get the data out of user space */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
(paren
r_int
)paren
id|inp-&gt;d.cfs_ioctl.data
comma
id|data-&gt;vi.in
comma
id|data-&gt;vi.in_size
)paren
)paren
(brace
id|error
op_assign
id|EINVAL
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|size
comma
op_amp
id|size
comma
id|inp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;coda_pioctl: Venus returns: %d for %s&bslash;n&quot;
comma
id|error
comma
id|coda_f2s
c_func
(paren
id|fid
comma
id|str
)paren
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
multiline_comment|/* Copy out the OUT buffer. */
r_if
c_cond
(paren
id|outp-&gt;d.cfs_ioctl.len
OG
id|data-&gt;vi.out_size
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_FILE
comma
l_string|&quot;return len %d &lt;= request len %d&bslash;n&quot;
comma
id|outp-&gt;d.cfs_ioctl.len
comma
id|data-&gt;vi.out_size
)paren
suffix:semicolon
id|error
op_assign
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|data-&gt;vi.out
comma
(paren
r_char
op_star
)paren
id|outp
op_plus
(paren
r_int
)paren
id|outp-&gt;d.cfs_ioctl.data
comma
id|data-&gt;vi.out_size
)paren
)paren
(brace
id|error
op_assign
id|EINVAL
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
)brace
m_exit
suffix:colon
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
id|VC_MAXMSGSIZE
)paren
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
multiline_comment|/*&n; * coda_upcall and coda_downcall routines.&n; * &n; */
multiline_comment|/* &n; * coda_upcall will return a POSITIVE error in the case of &n; * failed communication with Venus _or_ will peek at Venus&n; * reply and return Venus&squot; error, also POSITIVE. &n; * &n; */
DECL|function|coda_upcall
r_int
id|coda_upcall
c_func
(paren
r_struct
id|coda_sb_info
op_star
id|sbi
comma
r_int
id|inSize
comma
r_int
op_star
id|outSize
comma
r_struct
id|inputArgs
op_star
id|buffer
)paren
(brace
r_struct
id|vcomm
op_star
id|vcommp
suffix:semicolon
r_struct
id|outputArgs
op_star
id|out
suffix:semicolon
r_struct
id|vmsg
op_star
id|vmp
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
id|sbi-&gt;sbi_vcomm
op_eq
l_int|NULL
)paren
(brace
r_return
id|ENODEV
suffix:semicolon
)brace
id|vcommp
op_assign
id|sbi-&gt;sbi_vcomm
suffix:semicolon
id|clstats
c_func
(paren
(paren
(paren
r_struct
id|inputArgs
op_star
)paren
id|buffer
)paren
op_member_access_from_pointer
id|opcode
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vcomm_open
c_func
(paren
id|vcommp
)paren
)paren
r_return
id|ENODEV
suffix:semicolon
multiline_comment|/* Format the request message. */
id|CODA_ALLOC
c_func
(paren
id|vmp
comma
r_struct
id|vmsg
op_star
comma
r_sizeof
(paren
r_struct
id|vmsg
)paren
)paren
suffix:semicolon
id|vmp-&gt;vm_data
op_assign
(paren
r_void
op_star
)paren
id|buffer
suffix:semicolon
id|vmp-&gt;vm_flags
op_assign
l_int|0
suffix:semicolon
id|vmp-&gt;vm_inSize
op_assign
id|inSize
suffix:semicolon
id|vmp-&gt;vm_outSize
op_assign
op_star
id|outSize
ques
c_cond
op_star
id|outSize
suffix:colon
id|inSize
suffix:semicolon
id|vmp-&gt;vm_opcode
op_assign
(paren
(paren
r_struct
id|inputArgs
op_star
)paren
id|buffer
)paren
op_member_access_from_pointer
id|opcode
suffix:semicolon
id|vmp-&gt;vm_unique
op_assign
op_increment
id|vcommp-&gt;vc_seq
suffix:semicolon
id|vmp-&gt;vm_sleep
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Fill in the common input args. */
(paren
(paren
r_struct
id|inputArgs
op_star
)paren
id|buffer
)paren
op_member_access_from_pointer
id|unique
op_assign
id|vmp-&gt;vm_unique
suffix:semicolon
multiline_comment|/* Append msg to pending queue and poke Venus. */
id|INSQUE
c_func
(paren
id|vmp-&gt;vm_chain
comma
id|vcommp-&gt;vc_pending
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_UPCALL
comma
l_string|&quot;Proc %d wake Venus for(opc,uniq) =(%d,%d) msg at %x.zzz.&bslash;n&quot;
comma
id|current-&gt;pid
comma
id|vmp-&gt;vm_opcode
comma
id|vmp-&gt;vm_unique
comma
(paren
r_int
)paren
id|vmp
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|vcommp-&gt;vc_waitq
)paren
suffix:semicolon
multiline_comment|/* We can be interrupted while we wait for Venus to process&n;&t; * our request.  If the interrupt occurs before Venus has read&n;&t; * the request, we dequeue and return. If it occurs after the&n;&t; * read but before the reply, we dequeue, send a signal&n;&t; * message, and return. If it occurs after the reply we ignore&n;&t; * it. In no case do we want to restart the syscall.  If it&n;&t; * was interrupted by a venus shutdown (vcclose), return&n;&t; * ENODEV.  */
multiline_comment|/* Ignore return, We have to check anyway */
id|interruptible_sleep_on
c_func
(paren
op_amp
id|vmp-&gt;vm_sleep
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_UPCALL
comma
l_string|&quot;..process %d woken up by Venus for vmp at 0x%x, data at %x&bslash;n&quot;
comma
id|current-&gt;pid
comma
(paren
r_int
)paren
id|vmp
comma
(paren
r_int
)paren
id|vmp-&gt;vm_data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vcomm_open
c_func
(paren
id|vcommp
)paren
)paren
(brace
multiline_comment|/* i.e. Venus is still alive */
multiline_comment|/* Op went through, interrupt or not... */
r_if
c_cond
(paren
id|vmp-&gt;vm_flags
op_amp
id|VM_WRITE
)paren
(brace
id|error
op_assign
l_int|0
suffix:semicolon
id|out
op_assign
(paren
r_struct
id|outputArgs
op_star
)paren
id|vmp-&gt;vm_data
suffix:semicolon
id|error
op_assign
id|out-&gt;result
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_UPCALL
comma
l_string|&quot;upcall: (u,o,r) (%ld, %ld, %ld) out at %x&bslash;n&quot;
comma
id|out-&gt;unique
comma
id|out-&gt;opcode
comma
id|out-&gt;result
comma
(paren
r_int
)paren
id|out
)paren
suffix:semicolon
op_star
id|outSize
op_assign
id|vmp-&gt;vm_outSize
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|vmp-&gt;vm_flags
op_amp
id|VM_READ
)paren
)paren
(brace
multiline_comment|/* Interrupted before venus read it. */
id|CDEBUG
c_func
(paren
id|D_UPCALL
comma
l_string|&quot;Interrupted before read:(op,un) (%d.%d), flags = %x&bslash;n&quot;
comma
id|vmp-&gt;vm_opcode
comma
id|vmp-&gt;vm_unique
comma
id|vmp-&gt;vm_flags
)paren
suffix:semicolon
id|REMQUE
c_func
(paren
id|vmp-&gt;vm_chain
)paren
suffix:semicolon
id|error
op_assign
id|ERESTARTSYS
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vmp-&gt;vm_flags
op_amp
id|VM_READ
)paren
(brace
multiline_comment|/* interrupted after Venus did its read, send signal */
r_struct
id|inputArgs
op_star
id|dog
suffix:semicolon
r_struct
id|vmsg
op_star
id|svmp
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_UPCALL
comma
l_string|&quot;Sending Venus a signal: op = %d.%d, flags = %x&bslash;n&quot;
comma
id|vmp-&gt;vm_opcode
comma
id|vmp-&gt;vm_unique
comma
id|vmp-&gt;vm_flags
)paren
suffix:semicolon
id|REMQUE
c_func
(paren
id|vmp-&gt;vm_chain
)paren
suffix:semicolon
id|error
op_assign
id|ERESTARTSYS
suffix:semicolon
id|CODA_ALLOC
c_func
(paren
id|svmp
comma
r_struct
id|vmsg
op_star
comma
r_sizeof
(paren
r_struct
id|vmsg
)paren
)paren
suffix:semicolon
id|CODA_ALLOC
c_func
(paren
(paren
id|svmp-&gt;vm_data
)paren
comma
r_char
op_star
comma
id|VC_IN_NO_DATA
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_UPCALL
comma
l_string|&quot;coda_upcall: enqueing signal msg (%d, %d)&bslash;n&quot;
comma
id|svmp-&gt;vm_opcode
comma
id|svmp-&gt;vm_unique
)paren
suffix:semicolon
id|dog
op_assign
(paren
r_struct
id|inputArgs
op_star
)paren
id|svmp-&gt;vm_data
suffix:semicolon
id|dog-&gt;opcode
op_assign
id|CFS_SIGNAL
suffix:semicolon
id|dog-&gt;unique
op_assign
id|vmp-&gt;vm_unique
suffix:semicolon
id|svmp-&gt;vm_flags
op_assign
l_int|0
suffix:semicolon
id|svmp-&gt;vm_opcode
op_assign
id|dog-&gt;opcode
suffix:semicolon
id|svmp-&gt;vm_unique
op_assign
id|dog-&gt;unique
suffix:semicolon
id|svmp-&gt;vm_inSize
op_assign
id|VC_IN_NO_DATA
suffix:semicolon
id|svmp-&gt;vm_outSize
op_assign
id|VC_IN_NO_DATA
suffix:semicolon
multiline_comment|/* insert at head of queue! */
id|INSQUE
c_func
(paren
id|svmp-&gt;vm_chain
comma
id|vcommp-&gt;vc_pending
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|vcommp-&gt;vc_waitq
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* If venus died i.e. !VC_OPEN(vcommp) */
id|printk
c_func
(paren
l_string|&quot;coda_upcall: Venus dead upon (op,un) (%d.%d) flags %d&bslash;n&quot;
comma
id|vmp-&gt;vm_opcode
comma
id|vmp-&gt;vm_unique
comma
id|vmp-&gt;vm_flags
)paren
suffix:semicolon
multiline_comment|/* if (! (vmp-&gt;vm_flags &amp; VM_WRITE) ) */
id|error
op_assign
id|ENODEV
suffix:semicolon
)brace
m_exit
suffix:colon
id|CODA_FREE
c_func
(paren
id|vmp
comma
r_sizeof
(paren
r_struct
id|vmsg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
id|badclstats
c_func
(paren
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* &n; * There are 7 cases where cache invalidations occur.  The semantics&n; *  of each is listed here:&n; *&n; * CFS_FLUSH     -- flush all entries from the name cache and the cnode cache.&n; * CFS_PURGEUSER -- flush all entries from the name cache for a specific user&n; *                  This call is a result of token expiration.&n; *                  Linux does a cfsnc_flush since cred&squot;s are not maintained.&n; *&n; * The next arise as the result of callbacks on a file or directory.&n; * CFS_ZAPDIR    -- flush the attributes for the dir from its cnode.&n; *                  Zap all children of this directory from the namecache.&n; * CFS_ZAPFILE   -- flush the cached attributes for a file.&n; * CFS_ZAPVNODE  -- in linux the same as zap file (no creds).&n; *&n; * The next is a result of Venus detecting an inconsistent file.&n; * CFS_PURGEFID  -- flush the attribute for the file&n; *                  If it is a dir (odd vnode), purge its &n; *                  children from the namecache&n; *                  remove the file from the namecache.&n; *&n; * The last  allows Venus to replace local fids with global ones&n; * during reintegration.&n; *&n; * CFS_REPLACE -- replace one ViceFid with another throughout the name cache */
DECL|function|coda_downcall
r_int
id|coda_downcall
c_func
(paren
r_int
id|opcode
comma
r_struct
id|outputArgs
op_star
id|out
)paren
(brace
multiline_comment|/* Handle invalidate requests. */
r_switch
c_cond
(paren
id|opcode
)paren
(brace
r_case
id|CFS_FLUSH
suffix:colon
(brace
id|clstats
c_func
(paren
id|CFS_FLUSH
)paren
suffix:semicolon
id|cfsnc_flush
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|CFS_PURGEUSER
suffix:colon
(brace
id|clstats
c_func
(paren
id|CFS_PURGEUSER
)paren
suffix:semicolon
id|cfsnc_flush
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|CFS_ZAPDIR
suffix:colon
(brace
id|ViceFid
op_star
id|fid
op_assign
op_amp
id|out-&gt;d.cfs_zapdir.CodaFid
suffix:semicolon
id|clstats
c_func
(paren
id|CFS_ZAPDIR
)paren
suffix:semicolon
id|cfsnc_zapfid
c_func
(paren
id|fid
)paren
suffix:semicolon
id|cfsnc_zapParentfid
c_func
(paren
id|fid
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_UPCALL
comma
l_string|&quot;zapdir: fid = (%lx.%lx.%lx), &bslash;n&quot;
comma
id|fid-&gt;Volume
comma
id|fid-&gt;Vnode
comma
id|fid-&gt;Unique
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|CFS_ZAPVNODE
suffix:colon
(brace
id|clstats
c_func
(paren
id|CFS_ZAPVNODE
)paren
suffix:semicolon
id|cfsnc_zapfid
c_func
(paren
op_amp
id|out-&gt;d.cfs_zapvnode.VFid
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|CFS_ZAPFILE
suffix:colon
(brace
id|clstats
c_func
(paren
id|CFS_ZAPFILE
)paren
suffix:semicolon
id|cfsnc_zapfid
c_func
(paren
op_amp
id|out-&gt;d.cfs_zapfile.CodaFid
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|CFS_PURGEFID
suffix:colon
(brace
id|ViceFid
op_star
id|fid
op_assign
op_amp
id|out-&gt;d.cfs_purgefid.CodaFid
suffix:semicolon
id|clstats
c_func
(paren
id|CFS_PURGEFID
)paren
suffix:semicolon
id|cfsnc_zapfid
c_func
(paren
id|fid
)paren
suffix:semicolon
id|cfsnc_zapParentfid
c_func
(paren
id|fid
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_UPCALL
comma
l_string|&quot;purgefid: fid = (%lx.%lx.%lx)&bslash;n&quot;
comma
id|fid-&gt;Volume
comma
id|fid-&gt;Vnode
comma
id|fid-&gt;Unique
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|CFS_REPLACE
suffix:colon
(brace
id|clstats
c_func
(paren
id|CFS_REPLACE
)paren
suffix:semicolon
id|cfsnc_replace
c_func
(paren
op_amp
id|out-&gt;d.cfs_replace.OldFid
comma
op_amp
id|out-&gt;d.cfs_replace.NewFid
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
eof
