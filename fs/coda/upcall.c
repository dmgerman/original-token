multiline_comment|/*&n; * Mostly platform independent upcall operations to Venus:&n; *  -- upcalls&n; *  -- upcall routines&n; *&n; * Linux 2.0 version&n; * Copyright (C) 1996 Peter J. Braam &lt;braam@maths.ox.ac.uk&gt;, &n; * Michael Callahan &lt;callahan@maths.ox.ac.uk&gt; &n; * &n; * Redone for Linux 2.1&n; * Copyright (C) 1997 Carnegie Mellon University&n; *&n; * Carnegie Mellon University encourages users of this code to contribute&n; * improvements to the Coda project. Contact Peter Braam &lt;coda@cs.cmu.edu&gt;.&n; */
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/signal.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/locks.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;linux/coda.h&gt;
macro_line|#include &lt;linux/coda_linux.h&gt;
macro_line|#include &lt;linux/coda_psdev.h&gt;
macro_line|#include &lt;linux/coda_fs_i.h&gt;
macro_line|#include &lt;linux/coda_cache.h&gt;
DECL|macro|UPARG
mdefine_line|#define UPARG(op)&bslash;&n;do {&bslash;&n;  &t;CODA_ALLOC(inp, union inputArgs *, insize);&bslash;&n;&t;outp = (union outputArgs *) (inp);&bslash;&n;        inp-&gt;ih.opcode = (op);&bslash;&n;&t;inp-&gt;ih.pid = current-&gt;pid;&bslash;&n;&t;inp-&gt;ih.pgid = current-&gt;pgrp;&bslash;&n;&t;coda_load_creds(&amp;(inp-&gt;ih.cred));&bslash;&n;        outsize = insize;&bslash;&n;} while (0)
DECL|function|max
r_static
r_inline
r_int
id|max
c_func
(paren
r_int
id|a
comma
r_int
id|b
)paren
(brace
r_if
c_cond
(paren
id|a
OG
id|b
)paren
r_return
id|a
suffix:semicolon
r_else
r_return
id|b
suffix:semicolon
)brace
DECL|macro|INSIZE
mdefine_line|#define INSIZE(tag) sizeof(struct cfs_ ## tag ## _in)
DECL|macro|OUTSIZE
mdefine_line|#define OUTSIZE(tag) sizeof(struct cfs_ ## tag ## _out)
DECL|macro|SIZE
mdefine_line|#define SIZE(tag)  max(INSIZE(tag), OUTSIZE(tag))
multiline_comment|/* the upcalls */
DECL|function|venus_rootfid
r_int
id|venus_rootfid
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
id|ViceFid
op_star
id|fidp
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
id|insize
op_assign
id|SIZE
c_func
(paren
id|root
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CFS_ROOT
)paren
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;coda_get_rootfid: error %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
)brace
r_else
(brace
op_star
id|fidp
op_assign
(paren
id|ViceFid
)paren
id|outp-&gt;cfs_root.VFid
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_SUPER
comma
l_string|&quot;VolumeId: %lx, VnodeId: %lx.&bslash;n&quot;
comma
id|fidp-&gt;Volume
comma
id|fidp-&gt;Vnode
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
DECL|function|venus_getattr
r_int
id|venus_getattr
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
comma
r_struct
id|coda_vattr
op_star
id|attr
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
id|insize
op_assign
id|SIZE
c_func
(paren
id|getattr
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CFS_GETATTR
)paren
suffix:semicolon
id|inp-&gt;cfs_getattr.VFid
op_assign
op_star
id|fid
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
op_star
id|attr
op_assign
id|outp-&gt;cfs_getattr.attr
suffix:semicolon
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
DECL|function|venus_setattr
r_int
id|venus_setattr
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
comma
r_struct
id|coda_vattr
op_star
id|vattr
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
id|insize
op_assign
id|SIZE
c_func
(paren
id|setattr
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CFS_SETATTR
)paren
suffix:semicolon
id|inp-&gt;cfs_setattr.VFid
op_assign
op_star
id|fid
suffix:semicolon
id|inp-&gt;cfs_setattr.attr
op_assign
op_star
id|vattr
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_SUPER
comma
l_string|&quot; result %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
DECL|function|venus_lookup
r_int
id|venus_lookup
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
comma
r_const
r_char
op_star
id|name
comma
r_int
id|length
comma
r_int
op_star
id|type
comma
r_struct
id|ViceFid
op_star
id|resfid
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
r_int
id|offset
suffix:semicolon
id|offset
op_assign
id|INSIZE
c_func
(paren
id|lookup
)paren
suffix:semicolon
id|insize
op_assign
id|max
c_func
(paren
id|offset
op_plus
id|length
op_plus
l_int|1
comma
id|OUTSIZE
c_func
(paren
id|lookup
)paren
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CFS_LOOKUP
)paren
suffix:semicolon
id|inp-&gt;cfs_lookup.VFid
op_assign
op_star
id|fid
suffix:semicolon
id|inp-&gt;cfs_lookup.name
op_assign
id|offset
suffix:semicolon
multiline_comment|/* send Venus a null terminated string */
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|inp
)paren
op_plus
id|offset
comma
id|name
comma
id|length
)paren
suffix:semicolon
op_star
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|offset
op_plus
id|length
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
(brace
op_star
id|resfid
op_assign
id|outp-&gt;cfs_lookup.VFid
suffix:semicolon
op_star
id|type
op_assign
id|outp-&gt;cfs_lookup.vtype
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
DECL|function|venus_release
r_int
id|venus_release
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
comma
r_int
id|flags
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
id|insize
op_assign
id|SIZE
c_func
(paren
id|close
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CFS_CLOSE
)paren
suffix:semicolon
id|inp-&gt;cfs_close.VFid
op_assign
op_star
id|fid
suffix:semicolon
id|inp-&gt;cfs_close.flags
op_assign
id|flags
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
DECL|function|venus_open
r_int
id|venus_open
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
comma
r_int
id|flags
comma
id|ino_t
op_star
id|ino
comma
id|dev_t
op_star
id|dev
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
id|insize
op_assign
id|SIZE
c_func
(paren
id|open
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CFS_OPEN
)paren
suffix:semicolon
id|inp-&gt;cfs_open.VFid
op_assign
op_star
id|fid
suffix:semicolon
id|inp-&gt;cfs_open.flags
op_assign
id|flags
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
(brace
op_star
id|ino
op_assign
id|outp-&gt;cfs_open.inode
suffix:semicolon
op_star
id|dev
op_assign
id|outp-&gt;cfs_open.dev
suffix:semicolon
)brace
r_else
(brace
op_star
id|ino
op_assign
l_int|0
suffix:semicolon
op_star
id|dev
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
DECL|function|venus_mkdir
r_int
id|venus_mkdir
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|dirfid
comma
r_const
r_char
op_star
id|name
comma
r_int
id|length
comma
r_struct
id|ViceFid
op_star
id|newfid
comma
r_struct
id|coda_vattr
op_star
id|attrs
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
r_int
id|offset
suffix:semicolon
id|offset
op_assign
id|INSIZE
c_func
(paren
id|mkdir
)paren
suffix:semicolon
id|insize
op_assign
id|max
c_func
(paren
id|offset
op_plus
id|length
op_plus
l_int|1
comma
id|OUTSIZE
c_func
(paren
id|mkdir
)paren
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CFS_MKDIR
)paren
suffix:semicolon
id|inp-&gt;cfs_mkdir.VFid
op_assign
op_star
id|dirfid
suffix:semicolon
id|inp-&gt;cfs_mkdir.attr
op_assign
op_star
id|attrs
suffix:semicolon
id|inp-&gt;cfs_mkdir.name
op_assign
id|offset
suffix:semicolon
multiline_comment|/* Venus must get null terminated string */
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|inp
)paren
op_plus
id|offset
comma
id|name
comma
id|length
)paren
suffix:semicolon
op_star
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|offset
op_plus
id|length
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
op_star
id|attrs
op_assign
id|outp-&gt;cfs_mkdir.attr
suffix:semicolon
op_star
id|newfid
op_assign
id|outp-&gt;cfs_mkdir.VFid
suffix:semicolon
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
DECL|function|venus_rename
r_int
id|venus_rename
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|old_fid
comma
r_struct
id|ViceFid
op_star
id|new_fid
comma
r_int
id|old_length
comma
r_int
id|new_length
comma
r_const
r_char
op_star
id|old_name
comma
r_const
r_char
op_star
id|new_name
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
r_int
id|offset
comma
id|s
suffix:semicolon
id|offset
op_assign
id|INSIZE
c_func
(paren
id|rename
)paren
suffix:semicolon
id|insize
op_assign
id|max
c_func
(paren
id|offset
op_plus
id|new_length
op_plus
id|old_length
op_plus
l_int|8
comma
id|OUTSIZE
c_func
(paren
id|rename
)paren
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CFS_RENAME
)paren
suffix:semicolon
id|inp-&gt;cfs_rename.sourceFid
op_assign
op_star
id|old_fid
suffix:semicolon
id|inp-&gt;cfs_rename.destFid
op_assign
op_star
id|new_fid
suffix:semicolon
id|inp-&gt;cfs_rename.srcname
op_assign
id|offset
suffix:semicolon
multiline_comment|/* Venus must receive an null terminated string */
id|s
op_assign
(paren
id|old_length
op_amp
op_complement
l_int|0x3
)paren
op_plus
l_int|4
suffix:semicolon
multiline_comment|/* round up to word boundary */
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|inp
)paren
op_plus
id|offset
comma
id|old_name
comma
id|old_length
)paren
suffix:semicolon
op_star
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|offset
op_plus
id|old_length
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
multiline_comment|/* another null terminated string for Venus */
id|offset
op_add_assign
id|s
suffix:semicolon
id|inp-&gt;cfs_rename.destname
op_assign
id|offset
suffix:semicolon
id|s
op_assign
(paren
id|new_length
op_amp
op_complement
l_int|0x3
)paren
op_plus
l_int|4
suffix:semicolon
multiline_comment|/* round up to word boundary */
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|inp
)paren
op_plus
id|offset
comma
id|new_name
comma
id|new_length
)paren
suffix:semicolon
op_star
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|offset
op_plus
id|new_length
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;destname in packet: %s&bslash;n&quot;
comma
(paren
r_char
op_star
)paren
id|inp
op_plus
(paren
r_int
)paren
id|inp-&gt;cfs_rename.destname
)paren
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
DECL|function|venus_create
r_int
id|venus_create
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|dirfid
comma
r_const
r_char
op_star
id|name
comma
r_int
id|length
comma
r_int
id|excl
comma
r_int
id|mode
comma
r_struct
id|ViceFid
op_star
id|newfid
comma
r_struct
id|coda_vattr
op_star
id|attrs
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
r_int
id|offset
suffix:semicolon
id|offset
op_assign
id|INSIZE
c_func
(paren
id|create
)paren
suffix:semicolon
id|insize
op_assign
id|max
c_func
(paren
id|offset
op_plus
id|length
op_plus
l_int|1
comma
id|OUTSIZE
c_func
(paren
id|create
)paren
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CFS_CREATE
)paren
suffix:semicolon
id|inp-&gt;cfs_create.VFid
op_assign
op_star
id|dirfid
suffix:semicolon
id|inp-&gt;cfs_create.attr.va_mode
op_assign
id|mode
suffix:semicolon
id|inp-&gt;cfs_create.excl
op_assign
id|excl
suffix:semicolon
id|inp-&gt;cfs_create.mode
op_assign
id|mode
suffix:semicolon
id|inp-&gt;cfs_create.name
op_assign
id|offset
suffix:semicolon
multiline_comment|/* Venus must get null terminated string */
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|inp
)paren
op_plus
id|offset
comma
id|name
comma
id|length
)paren
suffix:semicolon
op_star
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|offset
op_plus
id|length
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
op_star
id|attrs
op_assign
id|outp-&gt;cfs_create.attr
suffix:semicolon
op_star
id|newfid
op_assign
id|outp-&gt;cfs_create.VFid
suffix:semicolon
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
DECL|function|venus_rmdir
r_int
id|venus_rmdir
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|dirfid
comma
r_const
r_char
op_star
id|name
comma
r_int
id|length
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
r_int
id|offset
suffix:semicolon
id|offset
op_assign
id|INSIZE
c_func
(paren
id|rmdir
)paren
suffix:semicolon
id|insize
op_assign
id|max
c_func
(paren
id|offset
op_plus
id|length
op_plus
l_int|1
comma
id|OUTSIZE
c_func
(paren
id|rmdir
)paren
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CFS_RMDIR
)paren
suffix:semicolon
id|inp-&gt;cfs_rmdir.VFid
op_assign
op_star
id|dirfid
suffix:semicolon
id|inp-&gt;cfs_rmdir.name
op_assign
id|offset
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|inp
)paren
op_plus
id|offset
comma
id|name
comma
id|length
)paren
suffix:semicolon
op_star
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|offset
op_plus
id|length
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
DECL|function|venus_remove
r_int
id|venus_remove
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|dirfid
comma
r_const
r_char
op_star
id|name
comma
r_int
id|length
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|error
op_assign
l_int|0
comma
id|insize
comma
id|outsize
comma
id|offset
suffix:semicolon
id|offset
op_assign
id|INSIZE
c_func
(paren
id|remove
)paren
suffix:semicolon
id|insize
op_assign
id|max
c_func
(paren
id|offset
op_plus
id|length
op_plus
l_int|1
comma
id|OUTSIZE
c_func
(paren
id|remove
)paren
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CFS_REMOVE
)paren
suffix:semicolon
id|inp-&gt;cfs_remove.VFid
op_assign
op_star
id|dirfid
suffix:semicolon
id|inp-&gt;cfs_remove.name
op_assign
id|offset
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|inp
)paren
op_plus
id|offset
comma
id|name
comma
id|length
)paren
suffix:semicolon
op_star
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|offset
op_plus
id|length
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
DECL|function|venus_readlink
r_int
id|venus_readlink
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
comma
r_char
op_star
id|buffer
comma
r_int
op_star
id|length
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
r_int
id|retlen
suffix:semicolon
r_char
op_star
id|result
suffix:semicolon
id|insize
op_assign
id|max
c_func
(paren
id|INSIZE
c_func
(paren
id|readlink
)paren
comma
id|OUTSIZE
c_func
(paren
id|readlink
)paren
op_plus
op_star
id|length
op_plus
l_int|1
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CFS_READLINK
)paren
suffix:semicolon
id|inp-&gt;cfs_readlink.VFid
op_assign
op_star
id|fid
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
(brace
id|retlen
op_assign
id|outp-&gt;cfs_readlink.count
suffix:semicolon
r_if
c_cond
(paren
id|retlen
OG
op_star
id|length
)paren
id|retlen
op_assign
op_star
id|length
suffix:semicolon
op_star
id|length
op_assign
id|retlen
suffix:semicolon
id|result
op_assign
(paren
r_char
op_star
)paren
id|outp
op_plus
(paren
r_int
)paren
id|outp-&gt;cfs_readlink.data
suffix:semicolon
id|memcpy
c_func
(paren
id|buffer
comma
id|result
comma
id|retlen
)paren
suffix:semicolon
op_star
(paren
id|buffer
op_plus
id|retlen
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot; result %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
DECL|function|venus_link
r_int
id|venus_link
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
comma
r_struct
id|ViceFid
op_star
id|dirfid
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
r_int
id|offset
suffix:semicolon
id|offset
op_assign
id|INSIZE
c_func
(paren
id|link
)paren
suffix:semicolon
id|insize
op_assign
id|max
c_func
(paren
id|offset
op_plus
id|len
op_plus
l_int|1
comma
id|OUTSIZE
c_func
(paren
id|link
)paren
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CFS_LINK
)paren
suffix:semicolon
id|inp-&gt;cfs_link.sourceFid
op_assign
op_star
id|fid
suffix:semicolon
id|inp-&gt;cfs_link.destFid
op_assign
op_star
id|dirfid
suffix:semicolon
id|inp-&gt;cfs_link.tname
op_assign
id|offset
suffix:semicolon
multiline_comment|/* make sure strings are null terminated */
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|inp
)paren
op_plus
id|offset
comma
id|name
comma
id|len
)paren
suffix:semicolon
op_star
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|offset
op_plus
id|len
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot; result %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
DECL|function|venus_symlink
r_int
id|venus_symlink
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
comma
r_const
r_char
op_star
id|symname
comma
r_int
id|symlen
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
r_int
id|offset
comma
id|s
suffix:semicolon
id|offset
op_assign
id|INSIZE
c_func
(paren
id|symlink
)paren
suffix:semicolon
id|insize
op_assign
id|max
c_func
(paren
id|offset
op_plus
id|len
op_plus
id|symlen
op_plus
l_int|8
comma
id|OUTSIZE
c_func
(paren
id|symlink
)paren
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CFS_SYMLINK
)paren
suffix:semicolon
multiline_comment|/*        inp-&gt;cfs_symlink.attr = *tva; XXXXXX */
id|inp-&gt;cfs_symlink.VFid
op_assign
op_star
id|fid
suffix:semicolon
multiline_comment|/* Round up to word boundary and null terminate */
id|inp-&gt;cfs_symlink.srcname
op_assign
id|offset
suffix:semicolon
id|s
op_assign
(paren
id|symlen
op_amp
op_complement
l_int|0x3
)paren
op_plus
l_int|4
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|inp
)paren
op_plus
id|offset
comma
id|symname
comma
id|symlen
)paren
suffix:semicolon
op_star
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|offset
op_plus
id|symlen
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
multiline_comment|/* Round up to word boundary and null terminate */
id|offset
op_add_assign
id|s
suffix:semicolon
id|inp-&gt;cfs_symlink.tname
op_assign
id|offset
suffix:semicolon
id|s
op_assign
(paren
id|len
op_amp
op_complement
l_int|0x3
)paren
op_plus
l_int|4
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|inp
)paren
op_plus
id|offset
comma
id|name
comma
id|len
)paren
suffix:semicolon
op_star
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
id|offset
op_plus
id|len
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot; result %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
DECL|function|venus_fsync
r_int
id|venus_fsync
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
id|insize
op_assign
id|SIZE
c_func
(paren
id|fsync
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CFS_FSYNC
)paren
suffix:semicolon
id|inp-&gt;cfs_fsync.VFid
op_assign
op_star
id|fid
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
r_sizeof
(paren
r_union
id|inputArgs
)paren
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
DECL|function|venus_access
r_int
id|venus_access
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
comma
r_int
id|mask
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
id|insize
op_assign
id|SIZE
c_func
(paren
id|access
)paren
suffix:semicolon
id|UPARG
c_func
(paren
id|CFS_ACCESS
)paren
suffix:semicolon
id|inp-&gt;cfs_access.VFid
op_assign
op_star
id|fid
suffix:semicolon
id|inp-&gt;cfs_access.flags
op_assign
id|mask
suffix:semicolon
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
DECL|function|venus_pioctl
r_int
id|venus_pioctl
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ViceFid
op_star
id|fid
comma
r_int
r_int
id|cmd
comma
r_struct
id|PioctlData
op_star
id|data
)paren
(brace
r_union
id|inputArgs
op_star
id|inp
suffix:semicolon
r_union
id|outputArgs
op_star
id|outp
suffix:semicolon
r_int
id|insize
comma
id|outsize
comma
id|error
suffix:semicolon
r_int
id|iocsize
suffix:semicolon
r_char
id|str
(braket
l_int|50
)braket
suffix:semicolon
id|insize
op_assign
id|VC_MAXMSGSIZE
suffix:semicolon
id|UPARG
c_func
(paren
id|CFS_IOCTL
)paren
suffix:semicolon
multiline_comment|/* build packet for Venus */
r_if
c_cond
(paren
id|data-&gt;vi.in_size
OG
id|VC_MAXDATASIZE
)paren
(brace
id|error
op_assign
id|EINVAL
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|inp-&gt;cfs_ioctl.VFid
op_assign
op_star
id|fid
suffix:semicolon
multiline_comment|/* the cmd field was mutated by increasing its size field to&n;         * reflect the path and follow args. We need to subtract that&n;         * out before sending the command to Venus.  */
id|inp-&gt;cfs_ioctl.cmd
op_assign
(paren
id|cmd
op_amp
op_complement
(paren
id|PIOCPARM_MASK
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
id|iocsize
op_assign
(paren
(paren
id|cmd
op_rshift
l_int|16
)paren
op_amp
id|PIOCPARM_MASK
)paren
op_minus
r_sizeof
(paren
r_char
op_star
)paren
op_minus
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|inp-&gt;cfs_ioctl.cmd
op_or_assign
(paren
id|iocsize
op_amp
id|PIOCPARM_MASK
)paren
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/* in-&gt;cfs_ioctl.rwflag = flag; */
id|inp-&gt;cfs_ioctl.len
op_assign
id|data-&gt;vi.in_size
suffix:semicolon
id|inp-&gt;cfs_ioctl.data
op_assign
(paren
r_char
op_star
)paren
(paren
id|INSIZE
c_func
(paren
id|ioctl
)paren
)paren
suffix:semicolon
multiline_comment|/* get the data out of user space */
macro_line|#ifdef L20
id|memcpy_fromfs
c_func
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
(paren
r_int
)paren
id|inp-&gt;cfs_ioctl.data
comma
id|data-&gt;vi.in
comma
id|data-&gt;vi.in_size
)paren
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_char
op_star
)paren
id|inp
op_plus
(paren
r_int
)paren
id|inp-&gt;cfs_ioctl.data
comma
id|data-&gt;vi.in
comma
id|data-&gt;vi.in_size
)paren
)paren
(brace
id|error
op_assign
id|EINVAL
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
macro_line|#endif
id|error
op_assign
id|coda_upcall
c_func
(paren
id|coda_sbp
c_func
(paren
id|sb
)paren
comma
id|insize
comma
op_amp
id|outsize
comma
id|inp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;coda_pioctl: Venus returns: %d for %s&bslash;n&quot;
comma
id|error
comma
id|coda_f2s
c_func
(paren
id|fid
)paren
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
multiline_comment|/* Copy out the OUT buffer. */
r_if
c_cond
(paren
id|outp-&gt;cfs_ioctl.len
OG
id|data-&gt;vi.out_size
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_FILE
comma
l_string|&quot;return len %d &lt;= request len %d&bslash;n&quot;
comma
id|outp-&gt;cfs_ioctl.len
comma
id|data-&gt;vi.out_size
)paren
suffix:semicolon
id|error
op_assign
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|data-&gt;vi.out
comma
id|data-&gt;vi.out_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_goto
m_exit
suffix:semicolon
macro_line|#ifdef L20
id|memcpy_tofs
c_func
(paren
id|data-&gt;vi.out
comma
(paren
r_char
op_star
)paren
id|outp
op_plus
(paren
r_int
)paren
id|outp-&gt;cfs_ioctl.data
comma
id|data-&gt;vi.out_size
)paren
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|data-&gt;vi.out
comma
(paren
r_char
op_star
)paren
id|outp
op_plus
(paren
r_int
)paren
id|outp-&gt;cfs_ioctl.data
comma
id|data-&gt;vi.out_size
)paren
)paren
(brace
id|error
op_assign
id|EINVAL
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
macro_line|#endif
)brace
m_exit
suffix:colon
r_if
c_cond
(paren
id|inp
)paren
id|CODA_FREE
c_func
(paren
id|inp
comma
id|insize
)paren
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
multiline_comment|/*&n; * coda_upcall and coda_downcall routines.&n; * &n; */
multiline_comment|/* &n; * coda_upcall will return a POSITIVE error in the case of &n; * failed communication with Venus _or_ will peek at Venus&n; * reply and return Venus&squot; error, also POSITIVE. &n; * &n; */
DECL|function|coda_waitfor_upcall
r_static
r_inline
r_void
id|coda_waitfor_upcall
c_func
(paren
r_struct
id|vmsg
op_star
id|vmp
)paren
(brace
r_struct
id|wait_queue
id|wait
op_assign
(brace
id|current
comma
l_int|NULL
)brace
suffix:semicolon
id|old_sigset_t
id|pending
suffix:semicolon
id|vmp-&gt;vm_posttime
op_assign
id|jiffies
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|vmp-&gt;vm_sleep
comma
op_amp
id|wait
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|coda_hard
op_eq
l_int|0
)paren
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
r_else
id|current-&gt;state
op_assign
id|TASK_UNINTERRUPTIBLE
suffix:semicolon
multiline_comment|/* got a reply */
r_if
c_cond
(paren
id|vmp-&gt;vm_flags
op_amp
id|VM_WRITE
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|signal_pending
c_func
(paren
id|current
)paren
)paren
id|schedule
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* signal is present: after timeout always return */
r_if
c_cond
(paren
id|jiffies
OG
id|vmp-&gt;vm_posttime
op_plus
id|coda_timeout
op_star
id|HZ
)paren
r_break
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|current-&gt;sigmask_lock
)paren
suffix:semicolon
id|pending
op_assign
id|current-&gt;blocked.sig
(braket
l_int|0
)braket
op_amp
id|current-&gt;signal.sig
(braket
l_int|0
)braket
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|current-&gt;sigmask_lock
)paren
suffix:semicolon
multiline_comment|/* if this process really wants to die, let it go */
r_if
c_cond
(paren
id|sigismember
c_func
(paren
op_amp
id|pending
comma
id|SIGKILL
)paren
op_logical_or
id|sigismember
c_func
(paren
op_amp
id|pending
comma
id|SIGINT
)paren
)paren
r_break
suffix:semicolon
r_else
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
id|remove_wait_queue
c_func
(paren
op_amp
id|vmp-&gt;vm_sleep
comma
op_amp
id|wait
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|coda_upcall
r_int
id|coda_upcall
c_func
(paren
r_struct
id|coda_sb_info
op_star
id|sbi
comma
r_int
id|inSize
comma
r_int
op_star
id|outSize
comma
r_union
id|inputArgs
op_star
id|buffer
)paren
(brace
r_struct
id|vcomm
op_star
id|vcommp
suffix:semicolon
r_union
id|outputArgs
op_star
id|out
suffix:semicolon
r_struct
id|vmsg
op_star
id|vmp
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
id|sbi-&gt;sbi_vcomm
op_eq
l_int|NULL
)paren
(brace
r_return
id|ENODEV
suffix:semicolon
)brace
id|vcommp
op_assign
id|sbi-&gt;sbi_vcomm
suffix:semicolon
id|clstats
c_func
(paren
(paren
(paren
r_union
id|inputArgs
op_star
)paren
id|buffer
)paren
op_member_access_from_pointer
id|ih.opcode
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vcomm_open
c_func
(paren
id|vcommp
)paren
)paren
r_return
id|ENODEV
suffix:semicolon
multiline_comment|/* Format the request message. */
id|CODA_ALLOC
c_func
(paren
id|vmp
comma
r_struct
id|vmsg
op_star
comma
r_sizeof
(paren
r_struct
id|vmsg
)paren
)paren
suffix:semicolon
id|vmp-&gt;vm_data
op_assign
(paren
r_void
op_star
)paren
id|buffer
suffix:semicolon
id|vmp-&gt;vm_flags
op_assign
l_int|0
suffix:semicolon
id|vmp-&gt;vm_inSize
op_assign
id|inSize
suffix:semicolon
id|vmp-&gt;vm_outSize
op_assign
op_star
id|outSize
ques
c_cond
op_star
id|outSize
suffix:colon
id|inSize
suffix:semicolon
id|vmp-&gt;vm_opcode
op_assign
(paren
(paren
r_union
id|inputArgs
op_star
)paren
id|buffer
)paren
op_member_access_from_pointer
id|ih.opcode
suffix:semicolon
id|vmp-&gt;vm_unique
op_assign
op_increment
id|vcommp-&gt;vc_seq
suffix:semicolon
id|vmp-&gt;vm_sleep
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Fill in the common input args. */
(paren
(paren
r_union
id|inputArgs
op_star
)paren
id|buffer
)paren
op_member_access_from_pointer
id|ih.unique
op_assign
id|vmp-&gt;vm_unique
suffix:semicolon
multiline_comment|/* Append msg to pending queue and poke Venus. */
id|coda_q_insert
c_func
(paren
op_amp
(paren
id|vmp-&gt;vm_chain
)paren
comma
op_amp
(paren
id|vcommp-&gt;vc_pending
)paren
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_UPCALL
comma
l_string|&quot;Proc %d wake Venus for(opc,uniq) =(%d,%d) msg at %x.zzz.&bslash;n&quot;
comma
id|current-&gt;pid
comma
id|vmp-&gt;vm_opcode
comma
id|vmp-&gt;vm_unique
comma
(paren
r_int
)paren
id|vmp
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|vcommp-&gt;vc_waitq
)paren
suffix:semicolon
multiline_comment|/* We can be interrupted while we wait for Venus to process&n;&t; * our request.  If the interrupt occurs before Venus has read&n;&t; * the request, we dequeue and return. If it occurs after the&n;&t; * read but before the reply, we dequeue, send a signal&n;&t; * message, and return. If it occurs after the reply we ignore&n;&t; * it. In no case do we want to restart the syscall.  If it&n;&t; * was interrupted by a venus shutdown (psdev_close), return&n;&t; * ENODEV.  */
multiline_comment|/* Go to sleep.  Wake up on signals only after the timeout. */
id|coda_waitfor_upcall
c_func
(paren
id|vmp
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_TIMING
comma
l_string|&quot;opc: %d time: %ld uniq: %d size: %d&bslash;n&quot;
comma
id|vmp-&gt;vm_opcode
comma
id|jiffies
op_minus
id|vmp-&gt;vm_posttime
comma
id|vmp-&gt;vm_unique
comma
id|vmp-&gt;vm_outSize
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_UPCALL
comma
l_string|&quot;..process %d woken up by Venus for vmp at 0x%x, data at %x&bslash;n&quot;
comma
id|current-&gt;pid
comma
(paren
r_int
)paren
id|vmp
comma
(paren
r_int
)paren
id|vmp-&gt;vm_data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vcomm_open
c_func
(paren
id|vcommp
)paren
)paren
(brace
multiline_comment|/* i.e. Venus is still alive */
multiline_comment|/* Op went through, interrupt or not... */
r_if
c_cond
(paren
id|vmp-&gt;vm_flags
op_amp
id|VM_WRITE
)paren
(brace
id|error
op_assign
l_int|0
suffix:semicolon
id|out
op_assign
(paren
r_union
id|outputArgs
op_star
)paren
id|vmp-&gt;vm_data
suffix:semicolon
id|error
op_assign
id|out-&gt;oh.result
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_UPCALL
comma
l_string|&quot;upcall: (u,o,r) (%ld, %ld, %ld) out at %p&bslash;n&quot;
comma
id|out-&gt;oh.unique
comma
id|out-&gt;oh.opcode
comma
id|out-&gt;oh.result
comma
id|out
)paren
suffix:semicolon
op_star
id|outSize
op_assign
id|vmp-&gt;vm_outSize
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|vmp-&gt;vm_flags
op_amp
id|VM_READ
)paren
op_logical_and
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
multiline_comment|/* Interrupted before venus read it. */
id|CDEBUG
c_func
(paren
id|D_UPCALL
comma
l_string|&quot;Interrupted before read:(op,un) (%d.%d), flags = %x&bslash;n&quot;
comma
id|vmp-&gt;vm_opcode
comma
id|vmp-&gt;vm_unique
comma
id|vmp-&gt;vm_flags
)paren
suffix:semicolon
id|coda_q_remove
c_func
(paren
op_amp
(paren
id|vmp-&gt;vm_chain
)paren
)paren
suffix:semicolon
id|error
op_assign
id|ERESTARTNOHAND
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|vmp-&gt;vm_flags
op_amp
id|VM_READ
)paren
op_logical_and
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
multiline_comment|/* interrupted after Venus did its read, send signal */
r_union
id|inputArgs
op_star
id|dog
suffix:semicolon
r_struct
id|vmsg
op_star
id|svmp
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_UPCALL
comma
l_string|&quot;Sending Venus a signal: op = %d.%d, flags = %x&bslash;n&quot;
comma
id|vmp-&gt;vm_opcode
comma
id|vmp-&gt;vm_unique
comma
id|vmp-&gt;vm_flags
)paren
suffix:semicolon
id|coda_q_remove
c_func
(paren
op_amp
(paren
id|vmp-&gt;vm_chain
)paren
)paren
suffix:semicolon
id|error
op_assign
id|ERESTARTNOHAND
suffix:semicolon
id|CODA_ALLOC
c_func
(paren
id|svmp
comma
r_struct
id|vmsg
op_star
comma
r_sizeof
(paren
r_struct
id|vmsg
)paren
)paren
suffix:semicolon
id|CODA_ALLOC
c_func
(paren
(paren
id|svmp-&gt;vm_data
)paren
comma
r_char
op_star
comma
r_sizeof
(paren
r_struct
id|cfs_in_hdr
)paren
)paren
suffix:semicolon
id|dog
op_assign
(paren
r_union
id|inputArgs
op_star
)paren
id|svmp-&gt;vm_data
suffix:semicolon
id|dog-&gt;ih.opcode
op_assign
id|CFS_SIGNAL
suffix:semicolon
id|dog-&gt;ih.unique
op_assign
id|vmp-&gt;vm_unique
suffix:semicolon
id|svmp-&gt;vm_flags
op_assign
l_int|0
suffix:semicolon
id|svmp-&gt;vm_opcode
op_assign
id|dog-&gt;ih.opcode
suffix:semicolon
id|svmp-&gt;vm_unique
op_assign
id|dog-&gt;ih.unique
suffix:semicolon
id|svmp-&gt;vm_inSize
op_assign
r_sizeof
(paren
r_struct
id|cfs_in_hdr
)paren
suffix:semicolon
id|svmp-&gt;vm_outSize
op_assign
r_sizeof
(paren
r_struct
id|cfs_in_hdr
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_UPCALL
comma
l_string|&quot;coda_upcall: enqueing signal msg (%d, %d)&bslash;n&quot;
comma
id|svmp-&gt;vm_opcode
comma
id|svmp-&gt;vm_unique
)paren
suffix:semicolon
multiline_comment|/* insert at head of queue! */
id|coda_q_insert
c_func
(paren
op_amp
(paren
id|svmp-&gt;vm_chain
)paren
comma
id|vcommp-&gt;vc_pending.forw
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|vcommp-&gt;vc_waitq
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;Coda: Strange interruption..&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
id|EINTR
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* If venus died i.e. !VC_OPEN(vcommp) */
id|printk
c_func
(paren
l_string|&quot;coda_upcall: Venus dead on (op,un) (%d.%d) flags %d&bslash;n&quot;
comma
id|vmp-&gt;vm_opcode
comma
id|vmp-&gt;vm_unique
comma
id|vmp-&gt;vm_flags
)paren
suffix:semicolon
id|error
op_assign
id|ENODEV
suffix:semicolon
)brace
m_exit
suffix:colon
id|CODA_FREE
c_func
(paren
id|vmp
comma
r_sizeof
(paren
r_struct
id|vmsg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
id|badclstats
c_func
(paren
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* &n; * There are 7 cases where cache invalidations occur.  The semantics&n; *  of each is listed here:&n; *&n; * CFS_FLUSH     -- flush all entries from the name cache and the cnode cache.&n; * CFS_PURGEUSER -- flush all entries from the name cache for a specific user&n; *                  This call is a result of token expiration.&n; *&n; * The next arise as the result of callbacks on a file or directory.&n; * CFS_ZAPDIR    -- flush the attributes for the dir from its cnode.&n; *                  Zap all children of this directory from the namecache.&n; * CFS_ZAPFILE   -- flush the cached attributes for a file.&n; * CFS_ZAPVNODE  -- intended to be a zapfile for just one cred. Not used?&n; *&n; * The next is a result of Venus detecting an inconsistent file.&n; * CFS_PURGEFID  -- flush the attribute for the file&n; *                  purge it and its children from the dcache&n; *&n; * The last  allows Venus to replace local fids with global ones&n; * during reintegration.&n; *&n; * CFS_REPLACE -- replace one ViceFid with another throughout the name cache */
DECL|function|coda_downcall
r_int
id|coda_downcall
c_func
(paren
r_int
id|opcode
comma
r_union
id|outputArgs
op_star
id|out
comma
r_struct
id|super_block
op_star
id|sb
)paren
(brace
multiline_comment|/* Handle invalidate requests. */
r_switch
c_cond
(paren
id|opcode
)paren
(brace
r_case
id|CFS_FLUSH
suffix:colon
(brace
id|clstats
c_func
(paren
id|CFS_FLUSH
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;CFS_FLUSH&bslash;n&quot;
)paren
suffix:semicolon
id|coda_cache_clear_all
c_func
(paren
id|sb
)paren
suffix:semicolon
id|shrink_dcache_sb
c_func
(paren
id|sb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|CFS_PURGEUSER
suffix:colon
(brace
r_struct
id|coda_cred
op_star
id|cred
op_assign
op_amp
id|out-&gt;cfs_purgeuser.cred
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;CFS_PURGEUSER&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cred
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PURGEUSER: null cred!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|clstats
c_func
(paren
id|CFS_PURGEUSER
)paren
suffix:semicolon
id|coda_cache_clear_cred
c_func
(paren
id|sb
comma
id|cred
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|CFS_ZAPDIR
suffix:colon
(brace
id|ViceFid
op_star
id|fid
op_assign
op_amp
id|out-&gt;cfs_zapdir.CodaFid
suffix:semicolon
r_char
id|str
(braket
l_int|50
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fid
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ZAPDIR: Null fid&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;zapdir: fid = %s&bslash;n&quot;
comma
id|coda_f2s
c_func
(paren
id|fid
)paren
)paren
suffix:semicolon
id|clstats
c_func
(paren
id|CFS_ZAPDIR
)paren
suffix:semicolon
id|coda_zapfid
c_func
(paren
id|fid
comma
id|sb
comma
id|C_ZAPDIR
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|CFS_ZAPVNODE
suffix:colon
(brace
id|ViceFid
op_star
id|fid
op_assign
op_amp
id|out-&gt;cfs_zapvnode.VFid
suffix:semicolon
r_char
id|str
(braket
l_int|50
)braket
suffix:semicolon
r_struct
id|coda_cred
op_star
id|cred
op_assign
op_amp
id|out-&gt;cfs_zapvnode.cred
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fid
op_logical_or
op_logical_neg
id|cred
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ZAPVNODE: Null fid or cred&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;zapvnode: fid = %s&bslash;n&quot;
comma
id|coda_f2s
c_func
(paren
id|fid
)paren
)paren
suffix:semicolon
id|coda_zapfid
c_func
(paren
id|fid
comma
id|sb
comma
id|C_ZAPFID
)paren
suffix:semicolon
id|coda_cache_clear_cred
c_func
(paren
id|sb
comma
id|cred
)paren
suffix:semicolon
id|clstats
c_func
(paren
id|CFS_ZAPVNODE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|CFS_ZAPFILE
suffix:colon
(brace
r_struct
id|ViceFid
op_star
id|fid
op_assign
op_amp
id|out-&gt;cfs_zapfile.CodaFid
suffix:semicolon
r_char
id|str
(braket
l_int|50
)braket
suffix:semicolon
id|clstats
c_func
(paren
id|CFS_ZAPFILE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fid
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ZAPFILE: Null fid&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;zapfile: fid = %s&bslash;n&quot;
comma
id|coda_f2s
c_func
(paren
id|fid
)paren
)paren
suffix:semicolon
id|coda_zapfid
c_func
(paren
id|fid
comma
id|sb
comma
id|C_ZAPFID
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|CFS_PURGEFID
suffix:colon
(brace
id|ViceFid
op_star
id|fid
op_assign
op_amp
id|out-&gt;cfs_purgefid.CodaFid
suffix:semicolon
r_char
id|str
(braket
l_int|50
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fid
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PURGEFID: Null fid&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;purgefid: fid = %s&bslash;n&quot;
comma
id|coda_f2s
c_func
(paren
id|fid
)paren
)paren
suffix:semicolon
id|clstats
c_func
(paren
id|CFS_PURGEFID
)paren
suffix:semicolon
id|coda_zapfid
c_func
(paren
id|fid
comma
id|sb
comma
id|C_ZAPDIR
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|CFS_REPLACE
suffix:colon
(brace
id|printk
c_func
(paren
l_string|&quot;CFS_REPLACCE&bslash;n&quot;
)paren
suffix:semicolon
id|clstats
c_func
(paren
id|CFS_REPLACE
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;CFS_REPLACE&bslash;n&quot;
)paren
suffix:semicolon
id|coda_cache_clear_all
c_func
(paren
id|sb
)paren
suffix:semicolon
id|shrink_dcache_sb
c_func
(paren
id|sb
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
eof
