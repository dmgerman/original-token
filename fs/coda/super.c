multiline_comment|/*&n; * Super block/filesystem wide operations&n; *&n; * Peter J. Braam &lt;braam@maths.ox.ac.uk&gt;, &n; * Michael Callahan &lt;callahan@maths.ox.ac.uk&gt; Aug 1996&n; * Rewritten for Linux 2.1.57 Peter Braam &lt;braam@cs.cmu.edu&gt;&n; */
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/locks.h&gt;
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/locks.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;linux/coda.h&gt;
macro_line|#include &lt;linux/coda_linux.h&gt;
macro_line|#include &lt;linux/coda_psdev.h&gt;
macro_line|#include &lt;linux/coda_cnode.h&gt;
macro_line|#include &lt;linux/coda_namecache.h&gt;
multiline_comment|/* VFS super_block ops */
r_static
r_struct
id|super_block
op_star
id|coda_read_super
c_func
(paren
r_struct
id|super_block
op_star
comma
r_void
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|coda_read_inode
c_func
(paren
r_struct
id|inode
op_star
)paren
suffix:semicolon
r_static
r_int
id|coda_notify_change
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|iattr
op_star
id|attr
)paren
suffix:semicolon
r_static
r_void
id|coda_put_inode
c_func
(paren
r_struct
id|inode
op_star
)paren
suffix:semicolon
r_static
r_void
id|coda_delete_inode
c_func
(paren
r_struct
id|inode
op_star
)paren
suffix:semicolon
r_static
r_void
id|coda_put_super
c_func
(paren
r_struct
id|super_block
op_star
)paren
suffix:semicolon
r_static
r_int
id|coda_statfs
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|statfs
op_star
id|buf
comma
r_int
id|bufsiz
)paren
suffix:semicolon
multiline_comment|/* helper functions */
r_void
id|print_vattr
c_func
(paren
r_struct
id|coda_vattr
op_star
id|attr
)paren
suffix:semicolon
r_static
r_inline
r_struct
id|coda_sb_info
op_star
id|coda_psinode2sb
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
suffix:semicolon
r_static
r_inline
r_struct
id|vcomm
op_star
id|coda_psinode2vcomm
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
suffix:semicolon
r_static
r_int
id|coda_get_psdev
c_func
(paren
r_void
op_star
comma
r_struct
id|inode
op_star
op_star
)paren
suffix:semicolon
r_static
r_void
id|coda_vattr_to_iattr
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|coda_vattr
op_star
)paren
suffix:semicolon
r_static
r_void
id|coda_iattr_to_vattr
c_func
(paren
r_struct
id|iattr
op_star
comma
r_struct
id|coda_vattr
op_star
)paren
suffix:semicolon
r_int
id|coda_fetch_inode
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|coda_vattr
op_star
)paren
suffix:semicolon
r_extern
r_inline
r_struct
id|vcomm
op_star
id|coda_psdev_vcomm
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
suffix:semicolon
r_extern
r_int
id|coda_cnode_make
c_func
(paren
r_struct
id|inode
op_star
op_star
id|inode
comma
id|ViceFid
op_star
id|fid
comma
r_struct
id|super_block
op_star
id|sb
)paren
suffix:semicolon
r_extern
r_struct
id|cnode
op_star
id|coda_cnode_alloc
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|coda_cnode_free
c_func
(paren
r_struct
id|cnode
op_star
)paren
suffix:semicolon
r_char
op_star
id|coda_f2s
c_func
(paren
r_struct
id|ViceFid
op_star
comma
r_char
op_star
)paren
suffix:semicolon
r_extern
r_int
id|cfsnc_initialized
suffix:semicolon
r_extern
r_int
id|coda_debug
suffix:semicolon
r_extern
r_int
id|coda_print_entry
suffix:semicolon
r_extern
r_struct
id|inode_operations
id|coda_file_inode_operations
suffix:semicolon
r_extern
r_struct
id|inode_operations
id|coda_dir_inode_operations
suffix:semicolon
r_extern
r_struct
id|inode_operations
id|coda_ioctl_inode_operations
suffix:semicolon
r_extern
r_struct
id|inode_operations
id|coda_symlink_inode_operations
suffix:semicolon
multiline_comment|/* exported operations */
DECL|variable|coda_super_operations
r_struct
id|super_operations
id|coda_super_operations
op_assign
(brace
id|coda_read_inode
comma
multiline_comment|/* read_inode */
l_int|NULL
comma
multiline_comment|/* write_inode */
id|coda_put_inode
comma
multiline_comment|/* put_inode */
id|coda_delete_inode
comma
multiline_comment|/* delete_inode */
id|coda_notify_change
comma
multiline_comment|/* notify_change */
id|coda_put_super
comma
multiline_comment|/* put_super */
l_int|NULL
comma
multiline_comment|/* write_super */
id|coda_statfs
comma
multiline_comment|/* statfs */
l_int|NULL
multiline_comment|/* remount_fs */
)brace
suffix:semicolon
multiline_comment|/*&n; * globals&n; */
DECL|variable|coda_super_info
r_struct
id|coda_sb_info
id|coda_super_info
(braket
id|MAX_CODADEVS
)braket
suffix:semicolon
DECL|function|coda_read_super
r_static
r_struct
id|super_block
op_star
id|coda_read_super
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_void
op_star
id|data
comma
r_int
id|silent
)paren
(brace
r_struct
id|inode
op_star
id|psdev
op_assign
l_int|0
comma
op_star
id|root
op_assign
l_int|0
suffix:semicolon
r_struct
id|coda_sb_info
op_star
id|sbi
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|vcomm
op_star
id|vc
suffix:semicolon
id|ViceFid
id|fid
suffix:semicolon
id|kdev_t
id|dev
op_assign
id|sb-&gt;s_dev
suffix:semicolon
r_int
id|error
suffix:semicolon
r_char
id|str
(braket
l_int|50
)braket
suffix:semicolon
id|ENTRY
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
id|coda_get_psdev
c_func
(paren
id|data
comma
op_amp
id|psdev
)paren
)paren
r_goto
m_exit
suffix:semicolon
id|vc
op_assign
id|coda_psinode2vcomm
c_func
(paren
id|psdev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vc
)paren
r_goto
m_exit
suffix:semicolon
id|sbi
op_assign
id|coda_psinode2sb
c_func
(paren
id|psdev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sbi
)paren
r_goto
m_exit
suffix:semicolon
id|sbi-&gt;sbi_psdev
op_assign
id|psdev
suffix:semicolon
id|sbi-&gt;sbi_vcomm
op_assign
id|vc
suffix:semicolon
id|lock_super
c_func
(paren
id|sb
)paren
suffix:semicolon
id|sb-&gt;u.generic_sbp
op_assign
id|sbi
suffix:semicolon
id|sb-&gt;s_blocksize
op_assign
l_int|1024
suffix:semicolon
multiline_comment|/* XXXXX */
id|sb-&gt;s_blocksize_bits
op_assign
l_int|10
suffix:semicolon
id|sb-&gt;s_magic
op_assign
id|CODA_SUPER_MAGIC
suffix:semicolon
id|sb-&gt;s_dev
op_assign
id|dev
suffix:semicolon
id|sb-&gt;s_op
op_assign
op_amp
id|coda_super_operations
suffix:semicolon
multiline_comment|/* get root fid from Venus: this needs the root inode */
id|error
op_assign
id|venus_rootfid
c_func
(paren
id|sb
comma
op_amp
id|fid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|unlock_super
c_func
(paren
id|sb
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;coda_read_super: coda_get_rootfid failed with %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;coda_read_super: rootfid is %s&bslash;n&quot;
comma
id|coda_f2s
c_func
(paren
op_amp
id|fid
comma
id|str
)paren
)paren
suffix:semicolon
id|error
op_assign
id|coda_cnode_make
c_func
(paren
op_amp
id|root
comma
op_amp
id|fid
comma
id|sb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_logical_or
op_logical_neg
id|root
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Failure of coda_cnode_make for root: error %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
id|unlock_super
c_func
(paren
id|sb
)paren
suffix:semicolon
id|sb-&gt;s_dev
op_assign
l_int|0
suffix:semicolon
id|root
op_assign
l_int|NULL
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;coda_read_super: rootinode is %ld dev %d&bslash;n&quot;
comma
id|root-&gt;i_ino
comma
id|root-&gt;i_dev
)paren
suffix:semicolon
id|sbi-&gt;sbi_root
op_assign
id|root
suffix:semicolon
id|sb-&gt;s_root
op_assign
id|d_alloc_root
c_func
(paren
id|root
comma
l_int|NULL
)paren
suffix:semicolon
id|unlock_super
c_func
(paren
id|sb
)paren
suffix:semicolon
r_return
id|sb
suffix:semicolon
id|EXIT
suffix:semicolon
m_exit
suffix:colon
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|sbi-&gt;sbi_vcomm
op_assign
l_int|NULL
suffix:semicolon
id|sbi-&gt;sbi_root
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|root
)paren
(brace
id|iput
c_func
(paren
id|root
)paren
suffix:semicolon
id|coda_cnode_free
c_func
(paren
id|ITOC
c_func
(paren
id|root
)paren
)paren
suffix:semicolon
)brace
id|sb-&gt;s_dev
op_assign
l_int|0
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|coda_put_super
r_static
r_void
id|coda_put_super
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_struct
id|coda_sb_info
op_star
id|sb_info
suffix:semicolon
id|ENTRY
suffix:semicolon
id|lock_super
c_func
(paren
id|sb
)paren
suffix:semicolon
id|sb-&gt;s_dev
op_assign
l_int|0
suffix:semicolon
id|sb_info
op_assign
id|coda_sbp
c_func
(paren
id|sb
)paren
suffix:semicolon
id|memset
c_func
(paren
id|sb_info
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|sb_info
)paren
)paren
suffix:semicolon
id|unlock_super
c_func
(paren
id|sb
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|EXIT
suffix:semicolon
)brace
multiline_comment|/* all filling in of inodes postponed until lookup */
DECL|function|coda_read_inode
r_static
r_void
id|coda_read_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
id|inode-&gt;u.generic_ip
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&t;inode-&gt;i_blksize = inode-&gt;i_sb-&gt;s_blocksize;&n;&t;inode-&gt;i_mode = 0;&n;&t;inode-&gt;i_op = NULL;&n;&t;NFS_CACHEINV(inode); */
)brace
DECL|function|coda_put_inode
r_static
r_void
id|coda_put_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;ino: %ld, cnp: %x&bslash;n&quot;
comma
id|inode-&gt;i_ino
comma
(paren
r_int
)paren
id|inode-&gt;u.generic_ip
)paren
suffix:semicolon
)brace
DECL|function|coda_delete_inode
r_static
r_void
id|coda_delete_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
r_struct
id|cnode
op_star
id|cnp
suffix:semicolon
r_struct
id|inode
op_star
id|open_inode
suffix:semicolon
id|ENTRY
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_SUPER
comma
l_string|&quot; inode-&gt;ino: %ld, count: %d&bslash;n&quot;
comma
id|inode-&gt;i_ino
comma
id|inode-&gt;i_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inode-&gt;i_ino
op_eq
id|CTL_INO
)paren
(brace
id|clear_inode
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|cnp
op_assign
id|ITOC
c_func
(paren
id|inode
)paren
suffix:semicolon
id|open_inode
op_assign
id|cnp-&gt;c_ovp
suffix:semicolon
r_if
c_cond
(paren
id|open_inode
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_SUPER
comma
l_string|&quot;DELINO cached file: ino %ld count %d.&bslash;n&quot;
comma
id|open_inode-&gt;i_ino
comma
id|open_inode-&gt;i_count
)paren
suffix:semicolon
id|cnp-&gt;c_ovp
op_assign
l_int|NULL
suffix:semicolon
id|cnp-&gt;c_odentry.d_inode
op_assign
l_int|NULL
suffix:semicolon
id|iput
c_func
(paren
id|open_inode
)paren
suffix:semicolon
)brace
id|inode-&gt;u.generic_ip
op_assign
l_int|NULL
suffix:semicolon
id|coda_cnode_free
c_func
(paren
id|cnp
)paren
suffix:semicolon
id|clear_inode
c_func
(paren
id|inode
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
)brace
DECL|function|coda_notify_change
r_static
r_int
id|coda_notify_change
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|iattr
op_star
id|iattr
)paren
(brace
r_struct
id|cnode
op_star
id|cnp
suffix:semicolon
r_struct
id|coda_vattr
id|vattr
suffix:semicolon
r_int
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|vattr
comma
l_int|0
comma
r_sizeof
(paren
id|vattr
)paren
)paren
suffix:semicolon
id|cnp
op_assign
id|ITOC
c_func
(paren
id|inode
)paren
suffix:semicolon
id|CHECK_CNODE
c_func
(paren
id|cnp
)paren
suffix:semicolon
id|coda_iattr_to_vattr
c_func
(paren
id|iattr
comma
op_amp
id|vattr
)paren
suffix:semicolon
id|vattr.va_type
op_assign
id|VNON
suffix:semicolon
multiline_comment|/* cannot set type */
id|CDEBUG
c_func
(paren
id|D_SUPER
comma
l_string|&quot;vattr.va_mode %o&bslash;n&quot;
comma
id|vattr.va_mode
)paren
suffix:semicolon
id|error
op_assign
id|venus_setattr
c_func
(paren
id|inode-&gt;i_sb
comma
op_amp
id|cnp-&gt;c_fid
comma
op_amp
id|vattr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
(brace
id|coda_vattr_to_iattr
c_func
(paren
id|inode
comma
op_amp
id|vattr
)paren
suffix:semicolon
id|cfsnc_zapfid
c_func
(paren
op_amp
(paren
id|cnp-&gt;c_fid
)paren
)paren
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_SUPER
comma
l_string|&quot;inode.i_mode %o, error %d&bslash;n&quot;
comma
id|inode-&gt;i_mode
comma
id|error
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/*  we need _something_ */
DECL|function|coda_statfs
r_static
r_int
id|coda_statfs
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|statfs
op_star
id|buf
comma
r_int
id|bufsiz
)paren
(brace
r_struct
id|statfs
id|tmp
suffix:semicolon
DECL|macro|NB_SFS_SIZ
mdefine_line|#define NB_SFS_SIZ 0x895440
id|tmp.f_type
op_assign
id|CODA_SUPER_MAGIC
suffix:semicolon
id|tmp.f_bsize
op_assign
l_int|1024
suffix:semicolon
id|tmp.f_blocks
op_assign
l_int|9000000
suffix:semicolon
id|tmp.f_bfree
op_assign
l_int|9000000
suffix:semicolon
id|tmp.f_bavail
op_assign
l_int|9000000
suffix:semicolon
id|tmp.f_files
op_assign
l_int|9000000
suffix:semicolon
id|tmp.f_ffree
op_assign
l_int|9000000
suffix:semicolon
id|tmp.f_namelen
op_assign
l_int|0
suffix:semicolon
id|copy_to_user
c_func
(paren
id|buf
comma
op_amp
id|tmp
comma
id|bufsiz
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* init_coda: used by filesystems.c to register coda */
DECL|variable|coda_fs_type
r_struct
id|file_system_type
id|coda_fs_type
op_assign
(brace
l_string|&quot;coda&quot;
comma
l_int|0
comma
id|coda_read_super
comma
l_int|NULL
)brace
suffix:semicolon
DECL|function|init_coda_fs
r_int
id|init_coda_fs
c_func
(paren
r_void
)paren
(brace
r_return
id|register_filesystem
c_func
(paren
op_amp
id|coda_fs_type
)paren
suffix:semicolon
)brace
multiline_comment|/* utility functions below */
DECL|function|coda_vattr_to_iattr
r_static
r_void
id|coda_vattr_to_iattr
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|coda_vattr
op_star
id|attr
)paren
(brace
r_int
id|inode_type
suffix:semicolon
multiline_comment|/* inode&squot;s i_dev, i_flags, i_ino are set by iget &n;           XXX: is this all we need ??&n;           */
r_switch
c_cond
(paren
id|attr-&gt;va_type
)paren
(brace
r_case
id|VNON
suffix:colon
id|inode_type
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VREG
suffix:colon
id|inode_type
op_assign
id|S_IFREG
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VDIR
suffix:colon
id|inode_type
op_assign
id|S_IFDIR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VLNK
suffix:colon
id|inode_type
op_assign
id|S_IFLNK
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|inode_type
op_assign
l_int|0
suffix:semicolon
)brace
id|inode-&gt;i_mode
op_or_assign
id|inode_type
suffix:semicolon
r_if
c_cond
(paren
id|attr-&gt;va_mode
op_ne
(paren
id|u_short
)paren
op_minus
l_int|1
)paren
id|inode-&gt;i_mode
op_assign
id|attr-&gt;va_mode
op_or
id|inode_type
suffix:semicolon
r_if
c_cond
(paren
id|attr-&gt;va_uid
op_ne
op_minus
l_int|1
)paren
id|inode-&gt;i_uid
op_assign
(paren
id|uid_t
)paren
id|attr-&gt;va_uid
suffix:semicolon
r_if
c_cond
(paren
id|attr-&gt;va_gid
op_ne
op_minus
l_int|1
)paren
id|inode-&gt;i_gid
op_assign
(paren
id|gid_t
)paren
id|attr-&gt;va_gid
suffix:semicolon
r_if
c_cond
(paren
id|attr-&gt;va_nlink
op_ne
op_minus
l_int|1
)paren
id|inode-&gt;i_nlink
op_assign
id|attr-&gt;va_nlink
suffix:semicolon
r_if
c_cond
(paren
id|attr-&gt;va_size
op_ne
op_minus
l_int|1
)paren
id|inode-&gt;i_size
op_assign
id|attr-&gt;va_size
suffix:semicolon
multiline_comment|/*  XXX This needs further study */
multiline_comment|/*&n;        inode-&gt;i_blksize = attr-&gt;va_blocksize;&n;&t;inode-&gt;i_blocks = attr-&gt;va_size/attr-&gt;va_blocksize &n;&t;  + (attr-&gt;va_size % attr-&gt;va_blocksize ? 1 : 0); &n;&t;  */
r_if
c_cond
(paren
id|attr-&gt;va_atime.tv_sec
op_ne
op_minus
l_int|1
)paren
id|inode-&gt;i_atime
op_assign
id|attr-&gt;va_atime.tv_sec
suffix:semicolon
r_if
c_cond
(paren
id|attr-&gt;va_mtime.tv_sec
op_ne
op_minus
l_int|1
)paren
id|inode-&gt;i_mtime
op_assign
id|attr-&gt;va_mtime.tv_sec
suffix:semicolon
r_if
c_cond
(paren
id|attr-&gt;va_ctime.tv_sec
op_ne
op_minus
l_int|1
)paren
id|inode-&gt;i_ctime
op_assign
id|attr-&gt;va_ctime.tv_sec
suffix:semicolon
)brace
multiline_comment|/* &n; * BSD sets attributes that need not be modified to -1. &n; * Linux uses the valid field to indicate what should be&n; * looked at.  The BSD type field needs to be deduced from linux &n; * mode.&n; * So we have to do some translations here.&n; */
DECL|function|coda_iattr_to_vattr
r_void
id|coda_iattr_to_vattr
c_func
(paren
r_struct
id|iattr
op_star
id|iattr
comma
r_struct
id|coda_vattr
op_star
id|vattr
)paren
(brace
id|umode_t
id|mode
suffix:semicolon
r_int
r_int
id|valid
suffix:semicolon
multiline_comment|/* clean out */
id|vattr-&gt;va_mode
op_assign
(paren
id|umode_t
)paren
op_minus
l_int|1
suffix:semicolon
id|vattr-&gt;va_uid
op_assign
(paren
id|vuid_t
)paren
op_minus
l_int|1
suffix:semicolon
id|vattr-&gt;va_gid
op_assign
(paren
id|vgid_t
)paren
op_minus
l_int|1
suffix:semicolon
id|vattr-&gt;va_size
op_assign
(paren
id|off_t
)paren
op_minus
l_int|1
suffix:semicolon
id|vattr-&gt;va_atime.tv_sec
op_assign
(paren
id|time_t
)paren
op_minus
l_int|1
suffix:semicolon
id|vattr-&gt;va_mtime.tv_sec
op_assign
(paren
id|time_t
)paren
op_minus
l_int|1
suffix:semicolon
id|vattr-&gt;va_ctime.tv_sec
op_assign
(paren
id|time_t
)paren
op_minus
l_int|1
suffix:semicolon
id|vattr-&gt;va_atime.tv_nsec
op_assign
(paren
id|time_t
)paren
op_minus
l_int|1
suffix:semicolon
id|vattr-&gt;va_mtime.tv_nsec
op_assign
(paren
id|time_t
)paren
op_minus
l_int|1
suffix:semicolon
id|vattr-&gt;va_ctime.tv_nsec
op_assign
(paren
id|time_t
)paren
op_minus
l_int|1
suffix:semicolon
id|vattr-&gt;va_type
op_assign
id|VNON
suffix:semicolon
id|vattr-&gt;va_fileid
op_assign
(paren
r_int
)paren
op_minus
l_int|1
suffix:semicolon
id|vattr-&gt;va_gen
op_assign
(paren
r_int
)paren
op_minus
l_int|1
suffix:semicolon
id|vattr-&gt;va_bytes
op_assign
(paren
r_int
)paren
op_minus
l_int|1
suffix:semicolon
id|vattr-&gt;va_fsid
op_assign
(paren
r_int
)paren
op_minus
l_int|1
suffix:semicolon
id|vattr-&gt;va_nlink
op_assign
(paren
r_int
)paren
op_minus
l_int|1
suffix:semicolon
id|vattr-&gt;va_blocksize
op_assign
(paren
r_int
)paren
op_minus
l_int|1
suffix:semicolon
id|vattr-&gt;va_rdev
op_assign
(paren
id|dev_t
)paren
op_minus
l_int|1
suffix:semicolon
id|vattr-&gt;va_flags
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* determine the type */
id|mode
op_assign
id|iattr-&gt;ia_mode
suffix:semicolon
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|mode
)paren
)paren
(brace
id|vattr-&gt;va_type
op_assign
id|VDIR
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|S_ISREG
c_func
(paren
id|mode
)paren
)paren
(brace
id|vattr-&gt;va_type
op_assign
id|VREG
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|S_ISLNK
c_func
(paren
id|mode
)paren
)paren
(brace
id|vattr-&gt;va_type
op_assign
id|VLNK
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* don&squot;t do others */
id|vattr-&gt;va_type
op_assign
id|VNON
suffix:semicolon
)brace
multiline_comment|/* set those vattrs that need change */
id|valid
op_assign
id|iattr-&gt;ia_valid
suffix:semicolon
r_if
c_cond
(paren
id|valid
op_amp
id|ATTR_MODE
)paren
(brace
id|vattr-&gt;va_mode
op_assign
id|iattr-&gt;ia_mode
suffix:semicolon
)brace
r_if
c_cond
(paren
id|valid
op_amp
id|ATTR_UID
)paren
(brace
id|vattr-&gt;va_uid
op_assign
(paren
id|vuid_t
)paren
id|iattr-&gt;ia_uid
suffix:semicolon
)brace
r_if
c_cond
(paren
id|valid
op_amp
id|ATTR_GID
)paren
(brace
id|vattr-&gt;va_gid
op_assign
(paren
id|vgid_t
)paren
id|iattr-&gt;ia_gid
suffix:semicolon
)brace
r_if
c_cond
(paren
id|valid
op_amp
id|ATTR_SIZE
)paren
(brace
id|vattr-&gt;va_size
op_assign
id|iattr-&gt;ia_size
suffix:semicolon
)brace
r_if
c_cond
(paren
id|valid
op_amp
id|ATTR_ATIME
)paren
(brace
id|vattr-&gt;va_atime.tv_sec
op_assign
id|iattr-&gt;ia_atime
suffix:semicolon
id|vattr-&gt;va_atime.tv_nsec
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|valid
op_amp
id|ATTR_MTIME
)paren
(brace
id|vattr-&gt;va_mtime.tv_sec
op_assign
id|iattr-&gt;ia_mtime
suffix:semicolon
id|vattr-&gt;va_mtime.tv_nsec
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|valid
op_amp
id|ATTR_CTIME
)paren
(brace
id|vattr-&gt;va_ctime.tv_sec
op_assign
id|iattr-&gt;ia_ctime
suffix:semicolon
id|vattr-&gt;va_ctime.tv_nsec
op_assign
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|print_vattr
r_void
id|print_vattr
c_func
(paren
r_struct
id|coda_vattr
op_star
id|attr
)paren
(brace
r_char
op_star
id|typestr
suffix:semicolon
r_switch
c_cond
(paren
id|attr-&gt;va_type
)paren
(brace
r_case
id|VNON
suffix:colon
id|typestr
op_assign
l_string|&quot;VNON&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VREG
suffix:colon
id|typestr
op_assign
l_string|&quot;VREG&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VDIR
suffix:colon
id|typestr
op_assign
l_string|&quot;VDIR&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VBLK
suffix:colon
id|typestr
op_assign
l_string|&quot;VBLK&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VCHR
suffix:colon
id|typestr
op_assign
l_string|&quot;VCHR&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VLNK
suffix:colon
id|typestr
op_assign
l_string|&quot;VLNK&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VSOCK
suffix:colon
id|typestr
op_assign
l_string|&quot;VSCK&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VFIFO
suffix:colon
id|typestr
op_assign
l_string|&quot;VFFO&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VBAD
suffix:colon
id|typestr
op_assign
l_string|&quot;VBAD&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|typestr
op_assign
l_string|&quot;????&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;attr: type %s (%o)  mode %o uid %d gid %d fsid %d rdev %d&bslash;n&quot;
comma
id|typestr
comma
(paren
r_int
)paren
id|attr-&gt;va_type
comma
(paren
r_int
)paren
id|attr-&gt;va_mode
comma
(paren
r_int
)paren
id|attr-&gt;va_uid
comma
(paren
r_int
)paren
id|attr-&gt;va_gid
comma
(paren
r_int
)paren
id|attr-&gt;va_fsid
comma
(paren
r_int
)paren
id|attr-&gt;va_rdev
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;      fileid %d nlink %d size %d blocksize %d bytes %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|attr-&gt;va_fileid
comma
(paren
r_int
)paren
id|attr-&gt;va_nlink
comma
(paren
r_int
)paren
id|attr-&gt;va_size
comma
(paren
r_int
)paren
id|attr-&gt;va_blocksize
comma
(paren
r_int
)paren
id|attr-&gt;va_bytes
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;      gen %ld flags %ld vaflags %d&bslash;n&quot;
comma
id|attr-&gt;va_gen
comma
id|attr-&gt;va_flags
comma
id|attr-&gt;va_vaflags
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;      atime sec %d nsec %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|attr-&gt;va_atime.tv_sec
comma
(paren
r_int
)paren
id|attr-&gt;va_atime.tv_nsec
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;      mtime sec %d nsec %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|attr-&gt;va_mtime.tv_sec
comma
(paren
r_int
)paren
id|attr-&gt;va_mtime.tv_nsec
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;      ctime sec %d nsec %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|attr-&gt;va_ctime.tv_sec
comma
(paren
r_int
)paren
id|attr-&gt;va_ctime.tv_nsec
)paren
suffix:semicolon
)brace
multiline_comment|/*   */
DECL|function|coda_fetch_inode
r_int
id|coda_fetch_inode
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|coda_vattr
op_star
id|attr
)paren
(brace
r_struct
id|cnode
op_star
id|cp
suffix:semicolon
r_int
id|ino
comma
id|error
op_assign
l_int|0
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_SUPER
comma
l_string|&quot;fetch for ino: %ld&bslash;n&quot;
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
id|ino
op_assign
id|inode-&gt;i_ino
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ino
)paren
id|printk
c_func
(paren
l_string|&quot;coda_fetch_inode: inode called with i_ino = 0 (don&squot;t worry)&bslash;n&quot;
)paren
suffix:semicolon
id|inode-&gt;i_op
op_assign
l_int|NULL
suffix:semicolon
id|inode-&gt;i_mode
op_assign
l_int|0
suffix:semicolon
id|cp
op_assign
id|ITOC
c_func
(paren
id|inode
)paren
suffix:semicolon
id|CHECK_CNODE
c_func
(paren
id|cp
)paren
suffix:semicolon
multiline_comment|/* root inode  */
r_if
c_cond
(paren
id|cp-&gt;c_fid.Volume
op_eq
l_int|0
op_logical_and
id|cp-&gt;c_fid.Vnode
op_eq
l_int|0
op_logical_and
id|cp-&gt;c_fid.Unique
op_eq
l_int|0
)paren
(brace
id|inode-&gt;i_ino
op_assign
l_int|1
suffix:semicolon
id|inode-&gt;i_op
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|IS_CTL_FID
c_func
(paren
op_amp
(paren
id|cp-&gt;c_fid
)paren
)paren
)paren
(brace
multiline_comment|/* This is the special magic control file.  &n;&t;&t;   Venus doesn&squot;t want&n;                   to hear a GETATTR about this! */
id|inode-&gt;i_op
op_assign
op_amp
id|coda_ioctl_inode_operations
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|attr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;coda_fetch_inode: called with NULL vattr, ino %ld&bslash;n&quot;
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* XXX */
)brace
r_if
c_cond
(paren
id|coda_debug
op_amp
id|D_SUPER
)paren
id|print_vattr
c_func
(paren
id|attr
)paren
suffix:semicolon
id|coda_vattr_to_iattr
c_func
(paren
id|inode
comma
id|attr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|S_ISREG
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
id|inode-&gt;i_op
op_assign
op_amp
id|coda_file_inode_operations
suffix:semicolon
r_else
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
id|inode-&gt;i_op
op_assign
op_amp
id|coda_dir_inode_operations
suffix:semicolon
r_else
r_if
c_cond
(paren
id|S_ISLNK
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
id|inode-&gt;i_op
op_assign
op_amp
id|coda_symlink_inode_operations
suffix:semicolon
r_else
(brace
id|printk
(paren
l_string|&quot;coda_read_inode: what kind of inode is this? i_mode = %o&bslash;n&quot;
comma
id|inode-&gt;i_mode
)paren
suffix:semicolon
id|inode-&gt;i_op
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
id|error
suffix:semicolon
)brace
r_static
r_inline
r_struct
id|vcomm
op_star
DECL|function|coda_psinode2vcomm
id|coda_psinode2vcomm
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
r_int
r_int
id|minor
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;minor %d&bslash;n&quot;
comma
id|minor
)paren
suffix:semicolon
r_if
c_cond
(paren
id|minor
OL
id|MAX_CODADEVS
)paren
r_return
op_amp
(paren
id|psdev_vcomm
(braket
id|minor
)braket
)paren
suffix:semicolon
r_else
r_return
l_int|NULL
suffix:semicolon
)brace
r_static
r_inline
r_struct
id|coda_sb_info
op_star
DECL|function|coda_psinode2sb
id|coda_psinode2sb
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
r_int
r_int
id|minor
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;minor %d&bslash;n&quot;
comma
id|minor
)paren
suffix:semicolon
r_if
c_cond
(paren
id|minor
OL
id|MAX_CODADEVS
)paren
r_return
op_amp
(paren
id|coda_super_info
(braket
id|minor
)braket
)paren
suffix:semicolon
r_else
r_return
l_int|NULL
suffix:semicolon
)brace
r_static
r_int
DECL|function|coda_get_psdev
id|coda_get_psdev
c_func
(paren
r_void
op_star
id|data
comma
r_struct
id|inode
op_star
op_star
id|res_dev
)paren
(brace
r_char
op_star
op_star
id|psdev_path
suffix:semicolon
r_struct
id|inode
op_star
id|psdev
op_assign
l_int|0
suffix:semicolon
r_struct
id|dentry
op_star
id|ent
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|data
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;coda_read_super: no data!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_else
(brace
id|psdev_path
op_assign
id|data
suffix:semicolon
)brace
id|ent
op_assign
id|namei
c_func
(paren
(paren
r_char
op_star
)paren
op_star
id|psdev_path
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|ent
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;namei error %ld for %d&bslash;n&quot;
comma
id|PTR_ERR
c_func
(paren
id|ent
)paren
comma
(paren
r_int
)paren
id|psdev_path
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|psdev
op_assign
id|ent-&gt;d_inode
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|S_ISCHR
c_func
(paren
id|psdev-&gt;i_mode
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;not a character device&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;major %d, minor %d, count %d&bslash;n&quot;
comma
id|MAJOR
c_func
(paren
id|psdev-&gt;i_rdev
)paren
comma
id|MINOR
c_func
(paren
id|psdev-&gt;i_rdev
)paren
comma
id|psdev-&gt;i_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|MAJOR
c_func
(paren
id|psdev-&gt;i_rdev
)paren
op_ne
id|CODA_PSDEV_MAJOR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;device %d not a Coda PSDEV device&bslash;n&quot;
comma
id|MAJOR
c_func
(paren
id|psdev-&gt;i_rdev
)paren
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|MINOR
c_func
(paren
id|psdev-&gt;i_rdev
)paren
op_ge
id|MAX_CODADEVS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;minor %d not an allocated Coda PSDEV&bslash;n&quot;
comma
id|psdev-&gt;i_rdev
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|psdev-&gt;i_count
OL
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;coda device minor %d not open (i_count = %d)&bslash;n&quot;
comma
id|MINOR
c_func
(paren
id|psdev-&gt;i_rdev
)paren
comma
id|psdev-&gt;i_count
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
op_star
id|res_dev
op_assign
id|psdev
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|EXIT
suffix:semicolon
id|error
suffix:colon
r_return
l_int|1
suffix:semicolon
)brace
eof
