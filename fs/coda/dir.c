multiline_comment|/*&n; * Directory operations for Coda filesystem&n; * Original version: (C) 1996 P. Braam and M. Callahan&n; * Rewritten for Linux 2.1. (C) 1997 Carnegie Mellon University&n; * &n; * Carnegie Mellon encourages users to contribute improvements to&n; * the Coda project. Contact Peter Braam (coda@cs.cmu.edu).&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/locks.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/coda.h&gt;
macro_line|#include &lt;linux/coda_linux.h&gt;
macro_line|#include &lt;linux/coda_psdev.h&gt;
macro_line|#include &lt;linux/coda_fs_i.h&gt;
macro_line|#include &lt;linux/coda_cache.h&gt;
macro_line|#include &lt;linux/coda_proc.h&gt;
multiline_comment|/* dir inode-ops */
r_static
r_int
id|coda_create
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
r_new
comma
r_int
id|mode
)paren
suffix:semicolon
r_static
r_int
id|coda_mknod
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
r_new
comma
r_int
id|mode
comma
r_int
id|rdev
)paren
suffix:semicolon
r_static
r_int
id|coda_lookup
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|target
)paren
suffix:semicolon
r_static
r_int
id|coda_link
c_func
(paren
r_struct
id|dentry
op_star
id|old_dentry
comma
r_struct
id|inode
op_star
id|dir_inode
comma
r_struct
id|dentry
op_star
id|entry
)paren
suffix:semicolon
r_static
r_int
id|coda_unlink
c_func
(paren
r_struct
id|inode
op_star
id|dir_inode
comma
r_struct
id|dentry
op_star
id|entry
)paren
suffix:semicolon
r_static
r_int
id|coda_symlink
c_func
(paren
r_struct
id|inode
op_star
id|dir_inode
comma
r_struct
id|dentry
op_star
id|entry
comma
r_const
r_char
op_star
id|symname
)paren
suffix:semicolon
r_static
r_int
id|coda_mkdir
c_func
(paren
r_struct
id|inode
op_star
id|dir_inode
comma
r_struct
id|dentry
op_star
id|entry
comma
r_int
id|mode
)paren
suffix:semicolon
r_static
r_int
id|coda_rmdir
c_func
(paren
r_struct
id|inode
op_star
id|dir_inode
comma
r_struct
id|dentry
op_star
id|entry
)paren
suffix:semicolon
r_static
r_int
id|coda_rename
c_func
(paren
r_struct
id|inode
op_star
id|old_inode
comma
r_struct
id|dentry
op_star
id|old_dentry
comma
r_struct
id|inode
op_star
id|new_inode
comma
r_struct
id|dentry
op_star
id|new_dentry
)paren
suffix:semicolon
multiline_comment|/* dir file-ops */
r_static
r_int
id|coda_readdir
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_void
op_star
id|dirent
comma
id|filldir_t
id|filldir
)paren
suffix:semicolon
multiline_comment|/* dentry ops */
r_static
r_int
id|coda_dentry_revalidate
c_func
(paren
r_struct
id|dentry
op_star
id|de
)paren
suffix:semicolon
r_static
r_void
id|coda_dentry_delete
c_func
(paren
r_struct
id|dentry
op_star
)paren
suffix:semicolon
multiline_comment|/* support routines */
r_static
r_int
id|coda_venus_readdir
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_void
op_star
id|dirent
comma
id|filldir_t
id|filldir
)paren
suffix:semicolon
r_int
id|coda_fsync
c_func
(paren
r_struct
id|file
op_star
comma
r_struct
id|dentry
op_star
id|dentry
)paren
suffix:semicolon
r_static
r_int
id|coda_refresh_inode
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
)paren
suffix:semicolon
DECL|variable|coda_crossvol_rename
r_int
id|coda_crossvol_rename
op_assign
l_int|0
suffix:semicolon
DECL|variable|coda_hasmknod
r_int
id|coda_hasmknod
op_assign
l_int|0
suffix:semicolon
DECL|variable|coda_dentry_operations
r_struct
id|dentry_operations
id|coda_dentry_operations
op_assign
(brace
id|coda_dentry_revalidate
comma
multiline_comment|/* revalidate */
l_int|NULL
comma
multiline_comment|/* hash */
l_int|NULL
comma
multiline_comment|/* compare */
id|coda_dentry_delete
multiline_comment|/* delete */
)brace
suffix:semicolon
DECL|variable|coda_dir_inode_operations
r_struct
id|inode_operations
id|coda_dir_inode_operations
op_assign
(brace
op_amp
id|coda_dir_operations
comma
id|coda_create
comma
multiline_comment|/* create */
id|coda_lookup
comma
multiline_comment|/* lookup */
id|coda_link
comma
multiline_comment|/* link */
id|coda_unlink
comma
multiline_comment|/* unlink */
id|coda_symlink
comma
multiline_comment|/* symlink */
id|coda_mkdir
comma
multiline_comment|/* mkdir */
id|coda_rmdir
comma
multiline_comment|/* rmdir */
id|coda_mknod
comma
multiline_comment|/* mknod */
id|coda_rename
comma
multiline_comment|/* rename */
l_int|NULL
comma
multiline_comment|/* readlink */
l_int|NULL
comma
multiline_comment|/* follow_link */
l_int|NULL
comma
multiline_comment|/* readpage */
l_int|NULL
comma
multiline_comment|/* writepage */
l_int|NULL
comma
multiline_comment|/* bmap */
l_int|NULL
comma
multiline_comment|/* truncate */
id|coda_permission
comma
multiline_comment|/* permission */
l_int|NULL
comma
multiline_comment|/* smap */
l_int|NULL
comma
multiline_comment|/* update page */
id|coda_revalidate_inode
multiline_comment|/* revalidate */
)brace
suffix:semicolon
DECL|variable|coda_dir_operations
r_struct
id|file_operations
id|coda_dir_operations
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* lseek */
l_int|NULL
comma
multiline_comment|/* read -- bad  */
l_int|NULL
comma
multiline_comment|/* write */
id|coda_readdir
comma
multiline_comment|/* readdir */
l_int|NULL
comma
multiline_comment|/* select */
l_int|NULL
comma
multiline_comment|/* ioctl */
l_int|NULL
comma
multiline_comment|/* mmap */
id|coda_open
comma
multiline_comment|/* open */
l_int|NULL
comma
id|coda_release
comma
multiline_comment|/* release */
id|coda_fsync
comma
multiline_comment|/* fsync */
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/* inode operations for directories */
multiline_comment|/* acces routines: lookup, readlink, permission */
DECL|function|coda_lookup
r_static
r_int
id|coda_lookup
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|entry
)paren
(brace
r_struct
id|coda_inode_info
op_star
id|dircnp
suffix:semicolon
r_struct
id|inode
op_star
id|res_inode
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|ViceFid
id|resfid
suffix:semicolon
r_int
id|dropme
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* to indicate entry should not be cached */
r_int
id|type
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_const
r_char
op_star
id|name
op_assign
id|entry-&gt;d_name.name
suffix:semicolon
r_int
id|length
op_assign
id|entry-&gt;d_name.len
suffix:semicolon
id|ENTRY
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;name %s, len %d in ino %ld&bslash;n&quot;
comma
id|name
comma
id|length
comma
id|dir-&gt;i_ino
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dir
op_logical_or
op_logical_neg
id|S_ISDIR
c_func
(paren
id|dir-&gt;i_mode
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;coda_lookup: inode is NULL or not a directory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOTDIR
suffix:semicolon
)brace
id|dircnp
op_assign
id|ITOC
c_func
(paren
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OG
id|CFS_MAXNAMLEN
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;name too long: lookup, %s (%*s)&bslash;n&quot;
comma
id|coda_f2s
c_func
(paren
op_amp
id|dircnp-&gt;c_fid
)paren
comma
id|length
comma
id|name
)paren
suffix:semicolon
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;lookup: %*s in %s&bslash;n&quot;
comma
id|length
comma
id|name
comma
id|coda_f2s
c_func
(paren
op_amp
id|dircnp-&gt;c_fid
)paren
)paren
suffix:semicolon
multiline_comment|/* control object, create inode on the fly */
r_if
c_cond
(paren
id|coda_isroot
c_func
(paren
id|dir
)paren
op_logical_and
id|coda_iscontrol
c_func
(paren
id|name
comma
id|length
)paren
)paren
(brace
id|error
op_assign
id|coda_cnode_makectl
c_func
(paren
op_amp
id|res_inode
comma
id|dir-&gt;i_sb
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_SPECIAL
comma
l_string|&quot;Lookup on CTL object; dir ino %ld, count %d&bslash;n&quot;
comma
id|dir-&gt;i_ino
comma
id|dir-&gt;i_count
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|error
op_assign
id|venus_lookup
c_func
(paren
id|dir-&gt;i_sb
comma
op_amp
(paren
id|dircnp-&gt;c_fid
)paren
comma
(paren
r_const
r_char
op_star
)paren
id|name
comma
id|length
comma
op_amp
id|type
comma
op_amp
id|resfid
)paren
suffix:semicolon
id|res_inode
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
(brace
r_if
c_cond
(paren
id|type
op_amp
id|CFS_NOCACHE
)paren
(brace
id|type
op_and_assign
(paren
op_complement
id|CFS_NOCACHE
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;dropme set for %s&bslash;n&quot;
comma
id|coda_f2s
c_func
(paren
op_amp
id|resfid
)paren
)paren
suffix:semicolon
id|dropme
op_assign
l_int|1
suffix:semicolon
)brace
id|error
op_assign
id|coda_cnode_make
c_func
(paren
op_amp
id|res_inode
comma
op_amp
id|resfid
comma
id|dir-&gt;i_sb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|error
op_ne
op_minus
id|ENOENT
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;error for %s(%*s)%d&bslash;n&quot;
comma
id|coda_f2s
c_func
(paren
op_amp
id|dircnp-&gt;c_fid
)paren
comma
id|length
comma
id|name
comma
id|error
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;lookup: %s is (%s), type %d result %d, dropme %d&bslash;n&quot;
comma
id|name
comma
id|coda_f2s
c_func
(paren
op_amp
id|resfid
)paren
comma
id|type
comma
id|error
comma
id|dropme
)paren
suffix:semicolon
m_exit
suffix:colon
id|entry-&gt;d_time
op_assign
l_int|0
suffix:semicolon
id|entry-&gt;d_op
op_assign
op_amp
id|coda_dentry_operations
suffix:semicolon
id|d_add
c_func
(paren
id|entry
comma
id|res_inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dropme
)paren
(brace
id|d_drop
c_func
(paren
id|entry
)paren
suffix:semicolon
id|ITOC
c_func
(paren
id|res_inode
)paren
op_member_access_from_pointer
id|c_flags
op_or_assign
id|C_VATTR
suffix:semicolon
)brace
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|coda_permission
r_int
id|coda_permission
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_int
id|mask
)paren
(brace
r_struct
id|coda_inode_info
op_star
id|cp
suffix:semicolon
r_int
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
id|coda_vfs_stat.permission
op_increment
suffix:semicolon
id|coda_permission_stat.count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|mask
op_eq
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|coda_access_cache
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|coda_cache_check
c_func
(paren
id|inode
comma
id|mask
)paren
)paren
(brace
id|coda_permission_stat.hit_count
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|cp
op_assign
id|ITOC
c_func
(paren
id|inode
)paren
suffix:semicolon
id|CHECK_CNODE
c_func
(paren
id|cp
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;mask is %o&bslash;n&quot;
comma
id|mask
)paren
suffix:semicolon
id|error
op_assign
id|venus_access
c_func
(paren
id|inode-&gt;i_sb
comma
op_amp
(paren
id|cp-&gt;c_fid
)paren
comma
id|mask
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;fid: %s, ino: %ld (mask: %o) error: %d&bslash;n&quot;
comma
id|coda_f2s
c_func
(paren
op_amp
(paren
id|cp-&gt;c_fid
)paren
)paren
comma
id|inode-&gt;i_ino
comma
id|mask
comma
id|error
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_eq
l_int|0
)paren
(brace
id|coda_cache_enter
c_func
(paren
id|inode
comma
id|mask
)paren
suffix:semicolon
)brace
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* creation routines: create, mknod, mkdir, link, symlink */
DECL|function|coda_create
r_static
r_int
id|coda_create
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|de
comma
r_int
id|mode
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_struct
id|coda_inode_info
op_star
id|dircnp
suffix:semicolon
r_const
r_char
op_star
id|name
op_assign
id|de-&gt;d_name.name
suffix:semicolon
r_int
id|length
op_assign
id|de-&gt;d_name.len
suffix:semicolon
r_struct
id|inode
op_star
id|result
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|ViceFid
id|newfid
suffix:semicolon
r_struct
id|coda_vattr
id|attrs
suffix:semicolon
id|ENTRY
suffix:semicolon
id|coda_vfs_stat.create
op_increment
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;name: %s, length %d, mode %o&bslash;n&quot;
comma
id|name
comma
id|length
comma
id|mode
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dir
op_logical_or
op_logical_neg
id|S_ISDIR
c_func
(paren
id|dir-&gt;i_mode
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;coda_create: inode is null or not a directory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|coda_isroot
c_func
(paren
id|dir
)paren
op_logical_and
id|coda_iscontrol
c_func
(paren
id|name
comma
id|length
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|dircnp
op_assign
id|ITOC
c_func
(paren
id|dir
)paren
suffix:semicolon
id|CHECK_CNODE
c_func
(paren
id|dircnp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OG
id|CFS_MAXNAMLEN
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;name too long: create, %s(%s)&bslash;n&quot;
comma
id|coda_f2s
c_func
(paren
op_amp
id|dircnp-&gt;c_fid
)paren
comma
id|name
)paren
suffix:semicolon
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
)brace
id|error
op_assign
id|venus_create
c_func
(paren
id|dir-&gt;i_sb
comma
op_amp
(paren
id|dircnp-&gt;c_fid
)paren
comma
id|name
comma
id|length
comma
l_int|0
comma
id|mode
comma
l_int|0
comma
op_amp
id|newfid
comma
op_amp
id|attrs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;create: %s, result %d&bslash;n&quot;
comma
id|coda_f2s
c_func
(paren
op_amp
id|newfid
)paren
comma
id|error
)paren
suffix:semicolon
id|d_drop
c_func
(paren
id|de
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|coda_cnode_make
c_func
(paren
op_amp
id|result
comma
op_amp
id|newfid
comma
id|dir-&gt;i_sb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|d_drop
c_func
(paren
id|de
)paren
suffix:semicolon
id|result
op_assign
l_int|NULL
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* invalidate the directory cnode&squot;s attributes */
id|dircnp-&gt;c_flags
op_or_assign
id|C_VATTR
suffix:semicolon
id|d_instantiate
c_func
(paren
id|de
comma
id|result
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|coda_mknod
r_static
r_int
id|coda_mknod
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|de
comma
r_int
id|mode
comma
r_int
id|rdev
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_struct
id|coda_inode_info
op_star
id|dircnp
suffix:semicolon
r_const
r_char
op_star
id|name
op_assign
id|de-&gt;d_name.name
suffix:semicolon
r_int
id|length
op_assign
id|de-&gt;d_name.len
suffix:semicolon
r_struct
id|inode
op_star
id|result
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|ViceFid
id|newfid
suffix:semicolon
r_struct
id|coda_vattr
id|attrs
suffix:semicolon
r_if
c_cond
(paren
id|coda_hasmknod
op_eq
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|coda_vfs_stat.create
op_increment
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;name: %s, length %d, mode %o, rdev %x&bslash;n&quot;
comma
id|name
comma
id|length
comma
id|mode
comma
id|rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dir
op_logical_or
op_logical_neg
id|S_ISDIR
c_func
(paren
id|dir-&gt;i_mode
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;coda_mknod: inode is null or not a directory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|coda_isroot
c_func
(paren
id|dir
)paren
op_logical_and
id|coda_iscontrol
c_func
(paren
id|name
comma
id|length
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|dircnp
op_assign
id|ITOC
c_func
(paren
id|dir
)paren
suffix:semicolon
id|CHECK_CNODE
c_func
(paren
id|dircnp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OG
id|CFS_MAXNAMLEN
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;name too long: mknod, %s(%s)&bslash;n&quot;
comma
id|coda_f2s
c_func
(paren
op_amp
id|dircnp-&gt;c_fid
)paren
comma
id|name
)paren
suffix:semicolon
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
)brace
id|error
op_assign
id|venus_create
c_func
(paren
id|dir-&gt;i_sb
comma
op_amp
(paren
id|dircnp-&gt;c_fid
)paren
comma
id|name
comma
id|length
comma
l_int|0
comma
id|mode
comma
id|rdev
comma
op_amp
id|newfid
comma
op_amp
id|attrs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;mknod: %s, result %d&bslash;n&quot;
comma
id|coda_f2s
c_func
(paren
op_amp
id|newfid
)paren
comma
id|error
)paren
suffix:semicolon
id|d_drop
c_func
(paren
id|de
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|coda_cnode_make
c_func
(paren
op_amp
id|result
comma
op_amp
id|newfid
comma
id|dir-&gt;i_sb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|d_drop
c_func
(paren
id|de
)paren
suffix:semicolon
id|result
op_assign
l_int|NULL
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* invalidate the directory cnode&squot;s attributes */
id|dircnp-&gt;c_flags
op_or_assign
id|C_VATTR
suffix:semicolon
id|d_instantiate
c_func
(paren
id|de
comma
id|result
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|coda_mkdir
r_static
r_int
id|coda_mkdir
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|de
comma
r_int
id|mode
)paren
(brace
r_struct
id|coda_inode_info
op_star
id|dircnp
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_struct
id|coda_vattr
id|attr
suffix:semicolon
r_const
r_char
op_star
id|name
op_assign
id|de-&gt;d_name.name
suffix:semicolon
r_int
id|len
op_assign
id|de-&gt;d_name.len
suffix:semicolon
r_int
id|error
suffix:semicolon
r_struct
id|ViceFid
id|newfid
suffix:semicolon
id|ENTRY
suffix:semicolon
id|coda_vfs_stat.mkdir
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dir
op_logical_or
op_logical_neg
id|S_ISDIR
c_func
(paren
id|dir-&gt;i_mode
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;coda_mkdir: inode is NULL or not a directory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OG
id|CFS_MAXNAMLEN
)paren
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
r_if
c_cond
(paren
id|coda_isroot
c_func
(paren
id|dir
)paren
op_logical_and
id|coda_iscontrol
c_func
(paren
id|name
comma
id|len
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|dircnp
op_assign
id|ITOC
c_func
(paren
id|dir
)paren
suffix:semicolon
id|CHECK_CNODE
c_func
(paren
id|dircnp
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;mkdir %s (len %d) in %s, mode %o.&bslash;n&quot;
comma
id|name
comma
id|len
comma
id|coda_f2s
c_func
(paren
op_amp
(paren
id|dircnp-&gt;c_fid
)paren
)paren
comma
id|mode
)paren
suffix:semicolon
id|attr.va_mode
op_assign
id|mode
suffix:semicolon
id|error
op_assign
id|venus_mkdir
c_func
(paren
id|dir-&gt;i_sb
comma
op_amp
(paren
id|dircnp-&gt;c_fid
)paren
comma
id|name
comma
id|len
comma
op_amp
id|newfid
comma
op_amp
id|attr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;mkdir error: %s result %d&bslash;n&quot;
comma
id|coda_f2s
c_func
(paren
op_amp
id|newfid
)paren
comma
id|error
)paren
suffix:semicolon
id|d_drop
c_func
(paren
id|de
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;mkdir: new dir has fid %s.&bslash;n&quot;
comma
id|coda_f2s
c_func
(paren
op_amp
id|newfid
)paren
)paren
suffix:semicolon
id|error
op_assign
id|coda_cnode_make
c_func
(paren
op_amp
id|inode
comma
op_amp
id|newfid
comma
id|dir-&gt;i_sb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|d_drop
c_func
(paren
id|de
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* invalidate the directory cnode&squot;s attributes */
id|dircnp-&gt;c_flags
op_or_assign
id|C_VATTR
suffix:semicolon
id|dir-&gt;i_nlink
op_increment
suffix:semicolon
id|d_instantiate
c_func
(paren
id|de
comma
id|inode
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* try to make de an entry in dir_inodde linked to source_de */
DECL|function|coda_link
r_static
r_int
id|coda_link
c_func
(paren
r_struct
id|dentry
op_star
id|source_de
comma
r_struct
id|inode
op_star
id|dir_inode
comma
r_struct
id|dentry
op_star
id|de
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|source_de-&gt;d_inode
suffix:semicolon
r_const
r_char
op_star
id|name
op_assign
id|de-&gt;d_name.name
suffix:semicolon
r_int
id|len
op_assign
id|de-&gt;d_name.len
suffix:semicolon
r_struct
id|coda_inode_info
op_star
id|dir_cnp
comma
op_star
id|cnp
suffix:semicolon
r_int
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
id|coda_vfs_stat.link
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|coda_isroot
c_func
(paren
id|dir_inode
)paren
op_logical_and
id|coda_iscontrol
c_func
(paren
id|name
comma
id|len
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|dir_cnp
op_assign
id|ITOC
c_func
(paren
id|dir_inode
)paren
suffix:semicolon
id|cnp
op_assign
id|ITOC
c_func
(paren
id|inode
)paren
suffix:semicolon
id|CHECK_CNODE
c_func
(paren
id|cnp
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;old: fid: %s&bslash;n&quot;
comma
id|coda_f2s
c_func
(paren
op_amp
(paren
id|cnp-&gt;c_fid
)paren
)paren
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;directory: %s&bslash;n&quot;
comma
id|coda_f2s
c_func
(paren
op_amp
(paren
id|dir_cnp-&gt;c_fid
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|CFS_MAXNAMLEN
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;coda_link: name too long. &bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
)brace
id|error
op_assign
id|venus_link
c_func
(paren
id|dir_inode-&gt;i_sb
comma
op_amp
(paren
id|cnp-&gt;c_fid
)paren
comma
op_amp
(paren
id|dir_cnp-&gt;c_fid
)paren
comma
(paren
r_const
r_char
op_star
)paren
id|name
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
(brace
id|dir_cnp-&gt;c_flags
op_or_assign
id|C_VATTR
suffix:semicolon
op_increment
id|inode-&gt;i_count
suffix:semicolon
id|d_instantiate
c_func
(paren
id|de
comma
id|inode
)paren
suffix:semicolon
id|inode-&gt;i_nlink
op_increment
suffix:semicolon
)brace
r_else
(brace
id|d_drop
c_func
(paren
id|de
)paren
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;link result %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|coda_symlink
r_static
r_int
id|coda_symlink
c_func
(paren
r_struct
id|inode
op_star
id|dir_inode
comma
r_struct
id|dentry
op_star
id|de
comma
r_const
r_char
op_star
id|symname
)paren
(brace
r_const
r_char
op_star
id|name
op_assign
id|de-&gt;d_name.name
suffix:semicolon
r_int
id|len
op_assign
id|de-&gt;d_name.len
suffix:semicolon
r_struct
id|coda_inode_info
op_star
id|dir_cnp
op_assign
id|ITOC
c_func
(paren
id|dir_inode
)paren
suffix:semicolon
r_int
id|symlen
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
id|ENTRY
suffix:semicolon
id|coda_vfs_stat.symlink
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|coda_isroot
c_func
(paren
id|dir_inode
)paren
op_logical_and
id|coda_iscontrol
c_func
(paren
id|name
comma
id|len
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|CFS_MAXNAMLEN
)paren
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
id|symlen
op_assign
id|strlen
c_func
(paren
id|symname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|symlen
OG
id|CFS_MAXPATHLEN
)paren
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;symname: %s, length: %d&bslash;n&quot;
comma
id|symname
comma
id|symlen
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * This entry is now negative. Since we do not create&n;&t; * an inode for the entry we have to drop it. &n;&t; */
id|d_drop
c_func
(paren
id|de
)paren
suffix:semicolon
id|error
op_assign
id|venus_symlink
c_func
(paren
id|dir_inode-&gt;i_sb
comma
op_amp
(paren
id|dir_cnp-&gt;c_fid
)paren
comma
id|name
comma
id|len
comma
id|symname
comma
id|symlen
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
(brace
id|dir_cnp-&gt;c_flags
op_or_assign
id|C_VATTR
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;in symlink result %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* destruction routines: unlink, rmdir */
DECL|function|coda_unlink
r_int
id|coda_unlink
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|de
)paren
(brace
r_struct
id|coda_inode_info
op_star
id|dircnp
suffix:semicolon
r_int
id|error
suffix:semicolon
r_const
r_char
op_star
id|name
op_assign
id|de-&gt;d_name.name
suffix:semicolon
r_int
id|len
op_assign
id|de-&gt;d_name.len
suffix:semicolon
id|ENTRY
suffix:semicolon
id|coda_vfs_stat.unlink
op_increment
suffix:semicolon
id|dircnp
op_assign
id|ITOC
c_func
(paren
id|dir
)paren
suffix:semicolon
id|CHECK_CNODE
c_func
(paren
id|dircnp
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot; %s in %s, ino %ld&bslash;n&quot;
comma
id|name
comma
id|coda_f2s
c_func
(paren
op_amp
(paren
id|dircnp-&gt;c_fid
)paren
)paren
comma
id|dir-&gt;i_ino
)paren
suffix:semicolon
multiline_comment|/* this file should no longer be in the namecache! */
id|error
op_assign
id|venus_remove
c_func
(paren
id|dir-&gt;i_sb
comma
op_amp
(paren
id|dircnp-&gt;c_fid
)paren
comma
id|name
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;upc returned error %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* cache management */
id|dircnp-&gt;c_flags
op_or_assign
id|C_VATTR
suffix:semicolon
id|de-&gt;d_inode-&gt;i_nlink
op_decrement
suffix:semicolon
id|d_delete
c_func
(paren
id|de
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|coda_rmdir
r_int
id|coda_rmdir
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|de
)paren
(brace
r_struct
id|coda_inode_info
op_star
id|dircnp
suffix:semicolon
r_const
r_char
op_star
id|name
op_assign
id|de-&gt;d_name.name
suffix:semicolon
r_int
id|len
op_assign
id|de-&gt;d_name.len
suffix:semicolon
r_int
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
id|coda_vfs_stat.rmdir
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dir
op_logical_or
op_logical_neg
id|S_ISDIR
c_func
(paren
id|dir-&gt;i_mode
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;coda_rmdir: inode is NULL or not a directory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
id|dircnp
op_assign
id|ITOC
c_func
(paren
id|dir
)paren
suffix:semicolon
id|CHECK_CNODE
c_func
(paren
id|dircnp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|CFS_MAXNAMLEN
)paren
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|de-&gt;d_hash
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* update i_nlink and free the inode before unlinking;&n;&t;   if rmdir fails a new lookup set i_nlink right.*/
r_if
c_cond
(paren
id|de-&gt;d_inode-&gt;i_nlink
)paren
id|de-&gt;d_inode-&gt;i_nlink
op_decrement
suffix:semicolon
id|error
op_assign
id|venus_rmdir
c_func
(paren
id|dir-&gt;i_sb
comma
op_amp
(paren
id|dircnp-&gt;c_fid
)paren
comma
id|name
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;upc returned error %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* rename */
DECL|function|coda_rename
r_static
r_int
id|coda_rename
c_func
(paren
r_struct
id|inode
op_star
id|old_dir
comma
r_struct
id|dentry
op_star
id|old_dentry
comma
r_struct
id|inode
op_star
id|new_dir
comma
r_struct
id|dentry
op_star
id|new_dentry
)paren
(brace
r_const
r_char
op_star
id|old_name
op_assign
id|old_dentry-&gt;d_name.name
suffix:semicolon
r_const
r_char
op_star
id|new_name
op_assign
id|new_dentry-&gt;d_name.name
suffix:semicolon
r_int
id|old_length
op_assign
id|old_dentry-&gt;d_name.len
suffix:semicolon
r_int
id|new_length
op_assign
id|new_dentry-&gt;d_name.len
suffix:semicolon
r_struct
id|inode
op_star
id|old_inode
op_assign
id|old_dentry-&gt;d_inode
suffix:semicolon
r_struct
id|inode
op_star
id|new_inode
op_assign
id|new_dentry-&gt;d_inode
suffix:semicolon
r_struct
id|coda_inode_info
op_star
id|new_cnp
comma
op_star
id|old_cnp
suffix:semicolon
r_int
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
id|coda_vfs_stat.rename
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|old_length
OG
id|CFS_MAXNAMLEN
)paren
op_logical_or
id|new_length
OG
id|CFS_MAXNAMLEN
)paren
(brace
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
)brace
id|old_cnp
op_assign
id|ITOC
c_func
(paren
id|old_dir
)paren
suffix:semicolon
id|new_cnp
op_assign
id|ITOC
c_func
(paren
id|new_dir
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;old: %s, (%d length, %d strlen), new: %s&quot;
l_string|&quot;(%d length, %d strlen).old:d_count: %d, new:d_count: %d&bslash;n&quot;
comma
id|old_name
comma
id|old_length
comma
id|strlen
c_func
(paren
id|old_name
)paren
comma
id|new_name
comma
id|new_length
comma
id|strlen
c_func
(paren
id|new_name
)paren
comma
id|old_dentry-&gt;d_count
comma
id|new_dentry-&gt;d_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_inode
op_eq
id|old_inode
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* make sure target is not in use */
r_if
c_cond
(paren
id|new_inode
op_logical_and
id|S_ISDIR
c_func
(paren
id|new_inode-&gt;i_mode
)paren
)paren
(brace
multiline_comment|/*&n;                 * Prune any children before testing for busy.&n;                 */
r_if
c_cond
(paren
id|new_dentry-&gt;d_count
OG
l_int|1
)paren
id|shrink_dcache_parent
c_func
(paren
id|new_dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_dentry-&gt;d_count
OG
l_int|1
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* the C library will do unlink/create etc */
r_if
c_cond
(paren
id|coda_crossvol_rename
op_eq
l_int|0
op_logical_and
id|old_cnp-&gt;c_fid.Volume
op_ne
id|new_cnp-&gt;c_fid.Volume
)paren
r_return
op_minus
id|EXDEV
suffix:semicolon
id|error
op_assign
id|venus_rename
c_func
(paren
id|old_dir-&gt;i_sb
comma
op_amp
(paren
id|old_cnp-&gt;c_fid
)paren
comma
op_amp
(paren
id|new_cnp-&gt;c_fid
)paren
comma
id|old_length
comma
id|new_length
comma
(paren
r_const
r_char
op_star
)paren
id|old_name
comma
(paren
r_const
r_char
op_star
)paren
id|new_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;returned error %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|coda_flag_inode
c_func
(paren
id|new_inode
comma
id|C_VATTR
)paren
suffix:semicolon
id|coda_flag_inode
c_func
(paren
id|old_dir
comma
id|C_VATTR
)paren
suffix:semicolon
id|coda_flag_inode
c_func
(paren
id|new_dir
comma
id|C_VATTR
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;result %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
id|d_move
c_func
(paren
id|old_dentry
comma
id|new_dentry
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* file operations for directories */
DECL|function|coda_readdir
r_int
id|coda_readdir
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_void
op_star
id|dirent
comma
id|filldir_t
id|filldir
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_struct
id|coda_inode_info
op_star
id|cnp
suffix:semicolon
r_struct
id|file
id|open_file
suffix:semicolon
r_struct
id|dentry
id|open_dentry
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
id|file-&gt;f_dentry-&gt;d_inode
suffix:semicolon
id|ENTRY
suffix:semicolon
id|coda_vfs_stat.readdir
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
op_logical_or
op_logical_neg
id|inode-&gt;i_sb
op_logical_or
op_logical_neg
id|S_ISDIR
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;coda_readdir: inode is NULL or not a directory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBADF
suffix:semicolon
)brace
id|cnp
op_assign
id|ITOC
c_func
(paren
id|inode
)paren
suffix:semicolon
id|CHECK_CNODE
c_func
(paren
id|cnp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cnp-&gt;c_ovp
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_FILE
comma
l_string|&quot;open inode pointer = NULL.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|coda_prepare_openfile
c_func
(paren
id|inode
comma
id|file
comma
id|cnp-&gt;c_ovp
comma
op_amp
id|open_file
comma
op_amp
id|open_dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|S_ISREG
c_func
(paren
id|cnp-&gt;c_ovp-&gt;i_mode
)paren
)paren
(brace
multiline_comment|/* Venus: we must read Venus dirents from the file */
id|result
op_assign
id|coda_venus_readdir
c_func
(paren
op_amp
id|open_file
comma
id|dirent
comma
id|filldir
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* potemkin case: we are handed a directory inode */
id|result
op_assign
id|open_file.f_op
op_member_access_from_pointer
id|readdir
c_func
(paren
op_amp
id|open_file
comma
id|dirent
comma
id|filldir
)paren
suffix:semicolon
)brace
id|coda_restore_codafile
c_func
(paren
id|inode
comma
id|file
comma
id|cnp-&gt;c_ovp
comma
op_amp
id|open_file
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
id|EXIT
suffix:semicolon
)brace
multiline_comment|/* ask venus to cache the file and return the inode of the container file,&n;   put this inode pointer in the cnode for future read/writes */
DECL|function|coda_open
r_int
id|coda_open
c_func
(paren
r_struct
id|inode
op_star
id|i
comma
r_struct
id|file
op_star
id|f
)paren
(brace
id|ino_t
id|ino
suffix:semicolon
id|dev_t
id|dev
suffix:semicolon
r_struct
id|coda_inode_info
op_star
id|cnp
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_struct
id|inode
op_star
id|cont_inode
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|flags
op_assign
id|f-&gt;f_flags
op_amp
(paren
op_complement
id|O_EXCL
)paren
suffix:semicolon
r_int
r_int
id|coda_flags
op_assign
id|coda_flags_to_cflags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|ENTRY
suffix:semicolon
id|coda_vfs_stat.open
op_increment
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_SPECIAL
comma
l_string|&quot;OPEN inode number: %ld, count %d, flags %o.&bslash;n&quot;
comma
id|f-&gt;f_dentry-&gt;d_inode-&gt;i_ino
comma
id|f-&gt;f_dentry-&gt;d_count
comma
id|flags
)paren
suffix:semicolon
id|cnp
op_assign
id|ITOC
c_func
(paren
id|i
)paren
suffix:semicolon
id|error
op_assign
id|venus_open
c_func
(paren
id|i-&gt;i_sb
comma
op_amp
(paren
id|cnp-&gt;c_fid
)paren
comma
id|coda_flags
comma
op_amp
id|ino
comma
op_amp
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_FILE
comma
l_string|&quot;venus: dev %d, inode %ld, out-&gt;result %d&bslash;n&quot;
comma
id|dev
comma
id|ino
comma
id|error
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* coda_upcall returns ino number of cached object, get inode */
id|CDEBUG
c_func
(paren
id|D_FILE
comma
l_string|&quot;cache file dev %d, ino %ld&bslash;n&quot;
comma
id|dev
comma
id|ino
)paren
suffix:semicolon
id|error
op_assign
id|coda_inode_grab
c_func
(paren
id|dev
comma
id|ino
comma
op_amp
id|cont_inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_logical_or
op_logical_neg
id|cont_inode
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;coda_open: coda_inode_grab error %d.&quot;
comma
id|error
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cont_inode
)paren
id|iput
c_func
(paren
id|cont_inode
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cnp-&gt;c_ovp
)paren
(brace
id|iput
c_func
(paren
id|cnp-&gt;c_ovp
)paren
suffix:semicolon
id|cnp-&gt;c_ovp
op_assign
l_int|NULL
suffix:semicolon
)brace
id|cnp-&gt;c_ovp
op_assign
id|cont_inode
suffix:semicolon
id|cnp-&gt;c_ocount
op_increment
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_FILE
comma
l_string|&quot;result %d, coda i-&gt;i_count is %d for ino %ld&bslash;n&quot;
comma
id|error
comma
id|i-&gt;i_count
comma
id|i-&gt;i_ino
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_FILE
comma
l_string|&quot;cache ino: %ld, count %d, ops %x&bslash;n&quot;
comma
id|cnp-&gt;c_ovp-&gt;i_ino
comma
id|cnp-&gt;c_ovp-&gt;i_count
comma
(paren
r_int
)paren
(paren
id|cnp-&gt;c_ovp-&gt;i_op
)paren
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|coda_release
r_int
id|coda_release
c_func
(paren
r_struct
id|inode
op_star
id|i
comma
r_struct
id|file
op_star
id|f
)paren
(brace
r_struct
id|coda_inode_info
op_star
id|cnp
suffix:semicolon
r_int
id|error
suffix:semicolon
r_int
r_int
id|flags
op_assign
(paren
id|f-&gt;f_flags
)paren
op_amp
(paren
op_complement
id|O_EXCL
)paren
suffix:semicolon
r_int
r_int
id|cflags
op_assign
id|coda_flags_to_cflags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|ENTRY
suffix:semicolon
id|coda_vfs_stat.release
op_increment
suffix:semicolon
id|cnp
op_assign
id|ITOC
c_func
(paren
id|i
)paren
suffix:semicolon
id|CHECK_CNODE
c_func
(paren
id|cnp
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_FILE
comma
l_string|&quot;RELEASE coda (ino %ld, ct %d) cache (ino %ld, ct %d)&bslash;n&quot;
comma
id|i-&gt;i_ino
comma
id|i-&gt;i_count
comma
(paren
id|cnp-&gt;c_ovp
ques
c_cond
id|cnp-&gt;c_ovp-&gt;i_ino
suffix:colon
l_int|0
)paren
comma
(paren
id|cnp-&gt;c_ovp
ques
c_cond
id|cnp-&gt;c_ovp-&gt;i_count
suffix:colon
op_minus
l_int|99
)paren
)paren
suffix:semicolon
multiline_comment|/* even when c_ocount=0 we cannot put c_ovp to&n;         * NULL since the file may be mmapped.&n;&t; * See code in inode.c (coda_put_inode) for&n;&t; * further handling of close.&n;&t; */
op_decrement
id|cnp-&gt;c_ocount
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
(paren
id|O_WRONLY
op_or
id|O_RDWR
)paren
)paren
(brace
op_decrement
id|cnp-&gt;c_owrite
suffix:semicolon
)brace
id|error
op_assign
id|venus_release
c_func
(paren
id|i-&gt;i_sb
comma
op_amp
(paren
id|cnp-&gt;c_fid
)paren
comma
id|cflags
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_FILE
comma
l_string|&quot;coda_release: result: %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* support routines */
multiline_comment|/* &n; * this structure is manipulated by filldir in vfs layer.&n; * the count holds the remaining amount of space in the getdents buffer,&n; * beyond the current_dir pointer.&n; */
DECL|struct|getdents_callback
r_struct
id|getdents_callback
(brace
DECL|member|current_dir
r_struct
id|linux_dirent
op_star
id|current_dir
suffix:semicolon
DECL|member|previous
r_struct
id|linux_dirent
op_star
id|previous
suffix:semicolon
DECL|member|count
r_int
id|count
suffix:semicolon
DECL|member|error
r_int
id|error
suffix:semicolon
)brace
suffix:semicolon
DECL|function|coda_venus_readdir
r_static
r_int
id|coda_venus_readdir
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_void
op_star
id|getdent
comma
id|filldir_t
id|filldir
)paren
(brace
r_int
id|result
op_assign
l_int|0
comma
id|offset
comma
id|count
comma
id|pos
comma
id|error
op_assign
l_int|0
suffix:semicolon
r_int
id|errfill
suffix:semicolon
id|caddr_t
id|buff
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|venus_dirent
op_star
id|vdirent
suffix:semicolon
r_struct
id|getdents_callback
op_star
id|dents_callback
suffix:semicolon
r_int
id|string_offset
suffix:semicolon
r_int
id|size
suffix:semicolon
r_char
id|debug
(braket
l_int|255
)braket
suffix:semicolon
id|ENTRY
suffix:semicolon
multiline_comment|/* we also need the ofset of the string in the dirent struct */
id|string_offset
op_assign
r_sizeof
(paren
r_char
)paren
op_star
l_int|2
op_plus
r_sizeof
(paren
r_int
r_int
)paren
op_plus
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
id|dents_callback
op_assign
(paren
r_struct
id|getdents_callback
op_star
)paren
id|getdent
suffix:semicolon
id|size
op_assign
id|count
op_assign
id|dents_callback-&gt;count
suffix:semicolon
id|CODA_ALLOC
c_func
(paren
id|buff
comma
r_void
op_star
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buff
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;coda_venus_readdir: out of memory.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* we use this routine to read the file into our buffer */
id|result
op_assign
id|read_exec
c_func
(paren
id|filp-&gt;f_dentry
comma
id|filp-&gt;f_pos
comma
id|buff
comma
id|count
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;coda_venus_readdir: cannot read directory %d.&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
id|error
op_assign
id|result
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
r_if
c_cond
(paren
id|result
op_eq
l_int|0
)paren
(brace
id|error
op_assign
id|result
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
multiline_comment|/* Parse and write into user space. Filldir tells us when done! */
id|offset
op_assign
id|filp-&gt;f_pos
suffix:semicolon
id|pos
op_assign
l_int|0
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_FILE
comma
l_string|&quot;offset %d, count %d.&bslash;n&quot;
comma
id|offset
comma
id|count
)paren
suffix:semicolon
r_while
c_loop
(paren
id|pos
op_plus
id|string_offset
OL
id|result
)paren
(brace
id|vdirent
op_assign
(paren
r_struct
id|venus_dirent
op_star
)paren
(paren
id|buff
op_plus
id|pos
)paren
suffix:semicolon
multiline_comment|/* test if the name is fully in the buffer */
r_if
c_cond
(paren
id|pos
op_plus
id|string_offset
op_plus
(paren
r_int
)paren
id|vdirent-&gt;d_namlen
op_ge
id|result
)paren
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/* now we are certain that we can read the entry from buff */
multiline_comment|/* for debugging, get the string out */
id|memcpy
c_func
(paren
id|debug
comma
id|vdirent-&gt;d_name
comma
id|vdirent-&gt;d_namlen
)paren
suffix:semicolon
op_star
(paren
id|debug
op_plus
id|vdirent-&gt;d_namlen
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
multiline_comment|/* if we don&squot;t have a null entry, copy it */
r_if
c_cond
(paren
id|vdirent-&gt;d_fileno
)paren
(brace
r_int
id|namlen
op_assign
id|vdirent-&gt;d_namlen
suffix:semicolon
id|off_t
id|offs
op_assign
id|filp-&gt;f_pos
suffix:semicolon
id|ino_t
id|ino
op_assign
id|vdirent-&gt;d_fileno
suffix:semicolon
r_char
op_star
id|name
op_assign
id|vdirent-&gt;d_name
suffix:semicolon
multiline_comment|/* adjust count */
id|count
op_assign
id|dents_callback-&gt;count
suffix:semicolon
id|errfill
op_assign
id|filldir
c_func
(paren
id|dents_callback
comma
id|name
comma
id|namlen
comma
id|offs
comma
id|ino
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_FILE
comma
l_string|&quot;ino %ld, namlen %d, reclen %d, type %d, pos %d, string_offs %d, name %s, offset %d, count %d.&bslash;n&quot;
comma
id|vdirent-&gt;d_fileno
comma
id|vdirent-&gt;d_namlen
comma
id|vdirent-&gt;d_reclen
comma
id|vdirent-&gt;d_type
comma
id|pos
comma
id|string_offset
comma
id|debug
comma
(paren
id|u_int
)paren
id|offs
comma
id|dents_callback-&gt;count
)paren
suffix:semicolon
multiline_comment|/* errfill means no space for filling in this round */
r_if
c_cond
(paren
id|errfill
OL
l_int|0
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/* next one */
id|filp-&gt;f_pos
op_add_assign
(paren
r_int
r_int
)paren
id|vdirent-&gt;d_reclen
suffix:semicolon
id|pos
op_add_assign
(paren
r_int
r_int
)paren
id|vdirent-&gt;d_reclen
suffix:semicolon
)brace
m_exit
suffix:colon
id|CODA_FREE
c_func
(paren
id|buff
comma
id|size
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* called when a cache lookup succeeds */
DECL|function|coda_dentry_revalidate
r_static
r_int
id|coda_dentry_revalidate
c_func
(paren
r_struct
id|dentry
op_star
id|de
)paren
(brace
r_int
id|valid
op_assign
l_int|1
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
id|de-&gt;d_inode
suffix:semicolon
r_struct
id|coda_inode_info
op_star
id|cii
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
id|inode
)paren
(brace
r_if
c_cond
(paren
id|is_bad_inode
c_func
(paren
id|inode
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|cii
op_assign
id|ITOC
c_func
(paren
id|de-&gt;d_inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cii-&gt;c_flags
op_amp
id|C_PURGE
)paren
id|valid
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|valid
op_logical_or
id|coda_isroot
c_func
(paren
id|de-&gt;d_inode
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This is the callback from dput() when d_count is going to 0.&n; * We use this to unhash dentries with bad inodes.&n; */
DECL|function|coda_dentry_delete
r_static
r_void
id|coda_dentry_delete
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dentry-&gt;d_inode
)paren
r_return
suffix:semicolon
id|flags
op_assign
(paren
id|ITOC
c_func
(paren
id|dentry-&gt;d_inode
)paren
op_member_access_from_pointer
id|c_flags
)paren
op_amp
id|C_PURGE
suffix:semicolon
r_if
c_cond
(paren
id|is_bad_inode
c_func
(paren
id|dentry-&gt;d_inode
)paren
op_logical_or
id|flags
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;bad inode, unhashing %s/%s, %ld&bslash;n&quot;
comma
id|dentry-&gt;d_parent-&gt;d_name.name
comma
id|dentry-&gt;d_name.name
comma
id|dentry-&gt;d_inode-&gt;i_ino
)paren
suffix:semicolon
id|d_drop
c_func
(paren
id|dentry
)paren
suffix:semicolon
)brace
)brace
DECL|function|coda_refresh_inode
r_static
r_int
id|coda_refresh_inode
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_struct
id|coda_vattr
id|attr
suffix:semicolon
r_int
id|error
suffix:semicolon
r_int
id|old_mode
suffix:semicolon
id|ino_t
id|old_ino
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
id|dentry-&gt;d_inode
suffix:semicolon
r_struct
id|coda_inode_info
op_star
id|cii
op_assign
id|ITOC
c_func
(paren
id|inode
)paren
suffix:semicolon
id|ENTRY
suffix:semicolon
id|error
op_assign
id|venus_getattr
c_func
(paren
id|inode-&gt;i_sb
comma
op_amp
(paren
id|cii-&gt;c_fid
)paren
comma
op_amp
id|attr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|make_bad_inode
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* this inode may be lost if:&n;            - it&squot;s type changed&n;            - it&squot;s ino changed &n;&t;*/
id|old_mode
op_assign
id|inode-&gt;i_mode
suffix:semicolon
id|old_ino
op_assign
id|inode-&gt;i_ino
suffix:semicolon
id|coda_vattr_to_iattr
c_func
(paren
id|inode
comma
op_amp
id|attr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inode-&gt;i_ino
op_ne
id|old_ino
)paren
op_logical_or
(paren
(paren
id|old_mode
op_amp
id|S_IFMT
)paren
op_ne
(paren
id|inode-&gt;i_mode
op_amp
id|S_IFMT
)paren
)paren
)paren
(brace
id|make_bad_inode
c_func
(paren
id|inode
)paren
suffix:semicolon
id|inode-&gt;i_mode
op_assign
id|old_mode
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|cii-&gt;c_flags
op_and_assign
op_complement
id|C_VATTR
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This is called when we want to check if the inode has&n; * changed on the server.  Coda makes this easy since the&n; * cache manager Venus issues a downcall to the kernel when this &n; * happens &n; */
DECL|function|coda_revalidate_inode
r_int
id|coda_revalidate_inode
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_struct
id|coda_inode_info
op_star
id|cii
op_assign
id|ITOC
c_func
(paren
id|dentry-&gt;d_inode
)paren
suffix:semicolon
id|ENTRY
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;revalidating: %*s/%*s&bslash;n&quot;
comma
id|dentry-&gt;d_name.len
comma
id|dentry-&gt;d_name.name
comma
id|dentry-&gt;d_parent-&gt;d_name.len
comma
id|dentry-&gt;d_parent-&gt;d_name.name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cii-&gt;c_flags
op_amp
(paren
id|C_VATTR
op_or
id|C_PURGE
)paren
)paren
(brace
id|error
op_assign
id|coda_refresh_inode
c_func
(paren
id|dentry
)paren
suffix:semicolon
)brace
r_return
id|error
suffix:semicolon
)brace
eof
