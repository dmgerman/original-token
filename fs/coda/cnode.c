multiline_comment|/* cnode related routines for the coda kernel code&n;   Peter Braam, Sep 1996.&n;   */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/coda.h&gt;
macro_line|#include &lt;linux/coda_linux.h&gt;
macro_line|#include &lt;linux/coda_psdev.h&gt;
macro_line|#include &lt;linux/coda_cnode.h&gt;
r_extern
r_int
id|coda_debug
suffix:semicolon
r_extern
r_int
id|coda_print_entry
suffix:semicolon
r_extern
r_int
id|coda_fetch_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|coda_vattr
op_star
id|attr
)paren
suffix:semicolon
multiline_comment|/* cnode.c */
r_struct
id|cnode
op_star
id|coda_cnode_alloc
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|coda_cnode_free
c_func
(paren
r_struct
id|cnode
op_star
)paren
suffix:semicolon
r_int
id|coda_cnode_make
c_func
(paren
r_struct
id|inode
op_star
op_star
id|inode
comma
id|ViceFid
op_star
id|fid
comma
r_struct
id|super_block
op_star
id|sb
)paren
suffix:semicolon
multiline_comment|/* return pointer to new empty cnode */
DECL|function|coda_cnode_alloc
r_struct
id|cnode
op_star
id|coda_cnode_alloc
c_func
(paren
r_void
)paren
(brace
r_struct
id|cnode
op_star
id|result
op_assign
l_int|NULL
suffix:semicolon
id|CODA_ALLOC
c_func
(paren
id|result
comma
r_struct
id|cnode
op_star
comma
r_sizeof
(paren
r_struct
id|cnode
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|result
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;coda_cnode_alloc: kmalloc returned NULL.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|memset
c_func
(paren
id|result
comma
l_int|0
comma
(paren
r_int
)paren
r_sizeof
(paren
r_struct
id|cnode
)paren
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* release cnode memory */
DECL|function|coda_cnode_free
r_void
id|coda_cnode_free
c_func
(paren
r_struct
id|cnode
op_star
id|cinode
)paren
(brace
id|CODA_FREE
c_func
(paren
id|cinode
comma
r_sizeof
(paren
r_struct
id|cnode
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* this is effectively coda_iget:&n;   - get attributes (might be cached)&n;   - get the inode for the fid using vfs iget&n;   - link the two up if this is needed&n;   - fill in the attributes&n;*/
DECL|function|coda_cnode_make
r_int
id|coda_cnode_make
c_func
(paren
r_struct
id|inode
op_star
op_star
id|inode
comma
id|ViceFid
op_star
id|fid
comma
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_struct
id|cnode
op_star
id|cnp
suffix:semicolon
r_struct
id|coda_vattr
id|attr
suffix:semicolon
r_int
id|error
suffix:semicolon
id|ino_t
id|ino
suffix:semicolon
r_char
id|str
(braket
l_int|50
)braket
suffix:semicolon
id|ENTRY
suffix:semicolon
multiline_comment|/* &n;         * We get inode numbers from Venus -- see venus source&n;         */
id|error
op_assign
id|venus_getattr
c_func
(paren
id|sb
comma
id|fid
comma
op_amp
id|attr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;coda_cnode_make: coda_getvattr returned %d for %s.&bslash;n&quot;
comma
id|error
comma
id|coda_f2s
c_func
(paren
id|fid
comma
id|str
)paren
)paren
suffix:semicolon
op_star
id|inode
op_assign
l_int|NULL
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|ino
op_assign
id|attr.va_fileid
suffix:semicolon
op_star
id|inode
op_assign
id|iget
c_func
(paren
id|sb
comma
id|ino
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|inode
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;coda_cnode_make: iget failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* link the cnode and the vfs inode &n;&t;   if this inode is not linked yet&n;&t;*/
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|inode
)paren
op_member_access_from_pointer
id|u.generic_ip
)paren
(brace
id|cnp
op_assign
id|coda_cnode_alloc
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cnp
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;coda_cnode_make: coda_cnode_alloc failed.&bslash;n&quot;
)paren
suffix:semicolon
id|clear_inode
c_func
(paren
op_star
id|inode
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|cnp-&gt;c_fid
op_assign
op_star
id|fid
suffix:semicolon
id|cnp-&gt;c_magic
op_assign
id|CODA_CNODE_MAGIC
suffix:semicolon
id|cnp-&gt;c_flags
op_assign
id|C_VATTR
suffix:semicolon
id|cnp-&gt;c_vnode
op_assign
op_star
id|inode
suffix:semicolon
(paren
op_star
id|inode
)paren
op_member_access_from_pointer
id|u.generic_ip
op_assign
(paren
r_void
op_star
)paren
id|cnp
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_CNODE
comma
l_string|&quot;LINKING: ino %ld, count %d  at 0x%x with cnp 0x%x, cnp-&gt;c_vnode 0x%x, in-&gt;u.generic_ip 0x%x&bslash;n&quot;
comma
(paren
op_star
id|inode
)paren
op_member_access_from_pointer
id|i_ino
comma
(paren
op_star
id|inode
)paren
op_member_access_from_pointer
id|i_count
comma
(paren
r_int
)paren
(paren
op_star
id|inode
)paren
comma
(paren
r_int
)paren
id|cnp
comma
(paren
r_int
)paren
id|cnp-&gt;c_vnode
comma
(paren
r_int
)paren
(paren
op_star
id|inode
)paren
op_member_access_from_pointer
id|u.generic_ip
)paren
suffix:semicolon
)brace
r_else
(brace
id|cnp
op_assign
(paren
r_struct
id|cnode
op_star
)paren
(paren
op_star
id|inode
)paren
op_member_access_from_pointer
id|u.generic_ip
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_CNODE
comma
l_string|&quot;FOUND linked: ino %ld, count %d, at 0x%x with cnp 0x%x, cnp-&gt;c_vnode 0x%x&bslash;n&quot;
comma
(paren
op_star
id|inode
)paren
op_member_access_from_pointer
id|i_ino
comma
(paren
op_star
id|inode
)paren
op_member_access_from_pointer
id|i_count
comma
(paren
r_int
)paren
(paren
op_star
id|inode
)paren
comma
(paren
r_int
)paren
id|cnp
comma
(paren
r_int
)paren
id|cnp-&gt;c_vnode
)paren
suffix:semicolon
)brace
id|CHECK_CNODE
c_func
(paren
id|cnp
)paren
suffix:semicolon
multiline_comment|/* refresh the attributes */
id|error
op_assign
id|coda_fetch_inode
c_func
(paren
op_star
id|inode
comma
op_amp
id|attr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;coda_cnode_make: fetch_inode returned %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
id|clear_inode
c_func
(paren
op_star
id|inode
)paren
suffix:semicolon
id|coda_cnode_free
c_func
(paren
id|cnp
)paren
suffix:semicolon
r_return
op_minus
id|error
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_CNODE
comma
l_string|&quot;Done linking: ino %ld,  at 0x%x with cnp 0x%x, cnp-&gt;c_vnode 0x%x&bslash;n&quot;
comma
(paren
op_star
id|inode
)paren
op_member_access_from_pointer
id|i_ino
comma
(paren
r_int
)paren
(paren
op_star
id|inode
)paren
comma
(paren
r_int
)paren
id|cnp
comma
(paren
r_int
)paren
id|cnp-&gt;c_vnode
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|coda_fideq
r_inline
r_int
id|coda_fideq
c_func
(paren
id|ViceFid
op_star
id|fid1
comma
id|ViceFid
op_star
id|fid2
)paren
(brace
r_int
id|eq
suffix:semicolon
id|eq
op_assign
(paren
(paren
id|fid1-&gt;Vnode
op_eq
id|fid2-&gt;Vnode
)paren
op_logical_and
(paren
id|fid1-&gt;Volume
op_eq
id|fid2-&gt;Volume
)paren
op_logical_and
(paren
id|fid1-&gt;Unique
op_eq
id|fid2-&gt;Unique
)paren
)paren
suffix:semicolon
r_return
id|eq
suffix:semicolon
)brace
multiline_comment|/* compute the inode number from the FID&n;   same routine as in vproc.cc (venus)&n;   XXX look at the exceptional case of root fids etc&n;*/
r_static
id|ino_t
DECL|function|coda_fid2ino
id|coda_fid2ino
c_func
(paren
id|ViceFid
op_star
id|fid
)paren
(brace
id|u_long
id|ROOT_VNODE
op_assign
l_int|1
suffix:semicolon
id|u_long
id|ROOT_UNIQUE
op_assign
l_int|1
suffix:semicolon
id|ViceFid
id|nullfid
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
r_if
c_cond
(paren
id|coda_fideq
c_func
(paren
id|fid
comma
op_amp
id|nullfid
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;coda_fid2ino: called with NULL Fid!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* what do we return for the root fid */
multiline_comment|/* Other volume root.  We need the relevant mount point&squot;s &n;&t;fid, but we don&squot;t know what that is! */
r_if
c_cond
(paren
id|fid-&gt;Vnode
op_eq
id|ROOT_VNODE
op_logical_and
id|fid-&gt;Unique
op_eq
id|ROOT_UNIQUE
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Non volume root. */
r_return
id|fid-&gt;Unique
op_plus
(paren
id|fid-&gt;Vnode
op_lshift
l_int|10
)paren
op_plus
(paren
id|fid-&gt;Volume
op_lshift
l_int|20
)paren
suffix:semicolon
)brace
multiline_comment|/* convert a fid to an inode. Avoids having a hash table&n;   such as present in the Mach minicache */
r_struct
id|inode
op_star
DECL|function|coda_fid2inode
id|coda_fid2inode
c_func
(paren
id|ViceFid
op_star
id|fid
comma
r_struct
id|super_block
op_star
id|sb
)paren
(brace
id|ino_t
id|nr
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_struct
id|cnode
op_star
id|cnp
suffix:semicolon
id|nr
op_assign
id|coda_fid2ino
c_func
(paren
id|fid
)paren
suffix:semicolon
id|inode
op_assign
id|iget
c_func
(paren
id|sb
comma
id|nr
)paren
suffix:semicolon
multiline_comment|/* check if this inode is linked to a cnode */
id|cnp
op_assign
(paren
r_struct
id|cnode
op_star
)paren
id|inode-&gt;u.generic_ip
suffix:semicolon
r_if
c_cond
(paren
id|cnp
op_eq
l_int|NULL
)paren
(brace
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* make sure fid is the one we want */
r_if
c_cond
(paren
op_logical_neg
id|coda_fideq
c_func
(paren
id|fid
comma
op_amp
(paren
id|cnp-&gt;c_fid
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;coda_fid2inode: bad cnode! Tell Peter.&bslash;n&quot;
)paren
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
id|inode
suffix:semicolon
)brace
multiline_comment|/* the CONTROL inode is made without asking attributes from Venus */
DECL|function|coda_cnode_makectl
r_int
id|coda_cnode_makectl
c_func
(paren
r_struct
id|inode
op_star
op_star
id|inode
comma
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
op_star
id|inode
op_assign
id|iget
c_func
(paren
id|sb
comma
id|CTL_INO
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|inode
)paren
(brace
(paren
op_star
id|inode
)paren
op_member_access_from_pointer
id|i_op
op_assign
op_amp
id|coda_ioctl_inode_operations
suffix:semicolon
(paren
op_star
id|inode
)paren
op_member_access_from_pointer
id|i_mode
op_assign
l_int|00444
suffix:semicolon
id|error
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_return
id|error
suffix:semicolon
)brace
eof
