multiline_comment|/* cnode related routines for the coda kernel code&n;   (C) 1996 Peter Braam&n;   */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/coda.h&gt;
macro_line|#include &lt;linux/coda_linux.h&gt;
macro_line|#include &lt;linux/coda_fs_i.h&gt;
macro_line|#include &lt;linux/coda_psdev.h&gt;
r_extern
r_int
id|coda_debug
suffix:semicolon
r_extern
r_int
id|coda_print_entry
suffix:semicolon
DECL|function|coda_fideq
r_inline
r_int
id|coda_fideq
c_func
(paren
id|ViceFid
op_star
id|fid1
comma
id|ViceFid
op_star
id|fid2
)paren
(brace
r_if
c_cond
(paren
id|fid1-&gt;Vnode
op_ne
id|fid2-&gt;Vnode
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|fid1-&gt;Volume
op_ne
id|fid2-&gt;Volume
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|fid1-&gt;Unique
op_ne
id|fid2-&gt;Unique
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* cnode.c */
DECL|function|coda_fill_inode
r_static
r_void
id|coda_fill_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|coda_vattr
op_star
id|attr
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_SUPER
comma
l_string|&quot;ino: %ld&bslash;n&quot;
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
r_if
c_cond
(paren
id|coda_debug
op_amp
id|D_SUPER
)paren
id|print_vattr
c_func
(paren
id|attr
)paren
suffix:semicolon
id|coda_vattr_to_iattr
c_func
(paren
id|inode
comma
id|attr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|S_ISREG
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
id|inode-&gt;i_op
op_assign
op_amp
id|coda_file_inode_operations
suffix:semicolon
r_else
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
id|inode-&gt;i_op
op_assign
op_amp
id|coda_dir_inode_operations
suffix:semicolon
r_else
r_if
c_cond
(paren
id|S_ISLNK
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
id|inode-&gt;i_op
op_assign
op_amp
id|coda_symlink_inode_operations
suffix:semicolon
r_else
id|init_special_inode
c_func
(paren
id|inode
comma
id|inode-&gt;i_mode
comma
id|attr-&gt;va_rdev
)paren
suffix:semicolon
)brace
multiline_comment|/* this is effectively coda_iget:&n;   - get attributes (might be cached)&n;   - get the inode for the fid using vfs iget&n;   - link the two up if this is needed&n;   - fill in the attributes&n;*/
DECL|function|coda_cnode_make
r_int
id|coda_cnode_make
c_func
(paren
r_struct
id|inode
op_star
op_star
id|inode
comma
id|ViceFid
op_star
id|fid
comma
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_struct
id|coda_inode_info
op_star
id|cnp
suffix:semicolon
r_struct
id|coda_sb_info
op_star
id|sbi
op_assign
id|coda_sbp
c_func
(paren
id|sb
)paren
suffix:semicolon
r_struct
id|coda_vattr
id|attr
suffix:semicolon
r_int
id|error
suffix:semicolon
id|ino_t
id|ino
suffix:semicolon
id|ENTRY
suffix:semicolon
multiline_comment|/* &n;&t; * We get inode numbers from Venus -- see venus source&n;&t; */
id|error
op_assign
id|venus_getattr
c_func
(paren
id|sb
comma
id|fid
comma
op_amp
id|attr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_CNODE
comma
l_string|&quot;coda_cnode_make: coda_getvattr returned %d for %s.&bslash;n&quot;
comma
id|error
comma
id|coda_f2s
c_func
(paren
id|fid
)paren
)paren
suffix:semicolon
op_star
id|inode
op_assign
l_int|NULL
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|ino
op_assign
id|attr.va_fileid
suffix:semicolon
op_star
id|inode
op_assign
id|iget
c_func
(paren
id|sb
comma
id|ino
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|inode
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;coda_cnode_make: iget failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|cnp
op_assign
id|ITOC
c_func
(paren
op_star
id|inode
)paren
suffix:semicolon
multiline_comment|/* see if we&squot;ve got it already */
r_if
c_cond
(paren
id|cnp-&gt;c_magic
op_ne
l_int|0
op_logical_and
id|coda_fideq
c_func
(paren
id|fid
comma
op_amp
id|cnp-&gt;c_fid
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* not fresh: collision */
r_if
c_cond
(paren
id|cnp-&gt;c_magic
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
"&quot;"
id|coda_cnode_make
id|on
id|initialized
id|inode
op_mod
id|ld
comma
id|old
op_mod
id|s
r_new
op_mod
id|s
op_logical_neg
"&bslash;"
id|n
"&quot;"
comma
(paren
op_star
id|inode
)paren
op_member_access_from_pointer
id|i_ino
comma
id|coda_f2s
c_func
(paren
op_amp
id|cnp-&gt;c_fid
)paren
comma
id|coda_f2s2
c_func
(paren
id|fid
)paren
)paren
suffix:semicolon
id|iput
c_func
(paren
op_star
id|inode
)paren
suffix:semicolon
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
id|memset
c_func
(paren
id|cnp
comma
l_int|0
comma
(paren
r_int
)paren
r_sizeof
(paren
r_struct
id|coda_inode_info
)paren
)paren
suffix:semicolon
id|cnp-&gt;c_fid
op_assign
op_star
id|fid
suffix:semicolon
id|cnp-&gt;c_magic
op_assign
id|CODA_CNODE_MAGIC
suffix:semicolon
id|cnp-&gt;c_flags
op_assign
l_int|0
suffix:semicolon
id|cnp-&gt;c_vnode
op_assign
op_star
id|inode
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
(paren
id|cnp-&gt;c_cnhead
)paren
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
(paren
id|cnp-&gt;c_volrootlist
)paren
)paren
suffix:semicolon
multiline_comment|/* fill in the inode attributes */
r_if
c_cond
(paren
id|coda_f2i
c_func
(paren
id|fid
)paren
op_ne
id|ino
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|coda_fid_is_weird
c_func
(paren
id|fid
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;Coda: unknown weird fid: ino %ld, fid %s.&quot;
l_string|&quot;Tell Peter.&bslash;n&quot;
comma
id|ino
comma
id|coda_f2s
c_func
(paren
op_amp
id|cnp-&gt;c_fid
)paren
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|cnp-&gt;c_volrootlist
comma
op_amp
id|sbi-&gt;sbi_volroothead
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_UPCALL
comma
l_string|&quot;Added %ld ,%s to volroothead&bslash;n&quot;
comma
id|ino
comma
id|coda_f2s
c_func
(paren
op_amp
id|cnp-&gt;c_fid
)paren
)paren
suffix:semicolon
)brace
id|coda_fill_inode
c_func
(paren
op_star
id|inode
comma
op_amp
id|attr
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;Done making inode: ino %ld,  count %d with %s&bslash;n&quot;
comma
(paren
op_star
id|inode
)paren
op_member_access_from_pointer
id|i_ino
comma
(paren
op_star
id|inode
)paren
op_member_access_from_pointer
id|i_count
comma
id|coda_f2s
c_func
(paren
op_amp
id|cnp-&gt;c_fid
)paren
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|coda_replace_fid
r_void
id|coda_replace_fid
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|ViceFid
op_star
id|oldfid
comma
r_struct
id|ViceFid
op_star
id|newfid
)paren
(brace
r_struct
id|coda_inode_info
op_star
id|cnp
suffix:semicolon
r_struct
id|coda_sb_info
op_star
id|sbi
op_assign
id|coda_sbp
c_func
(paren
id|inode-&gt;i_sb
)paren
suffix:semicolon
id|cnp
op_assign
id|ITOC
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|coda_fideq
c_func
(paren
op_amp
id|cnp-&gt;c_fid
comma
id|oldfid
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;What? oldfid != cnp-&gt;c_fid. Call 911.&bslash;n&quot;
)paren
suffix:semicolon
id|cnp-&gt;c_fid
op_assign
op_star
id|newfid
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|cnp-&gt;c_volrootlist
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|coda_fid_is_weird
c_func
(paren
id|newfid
)paren
)paren
id|list_add
c_func
(paren
op_amp
id|cnp-&gt;c_volrootlist
comma
op_amp
id|sbi-&gt;sbi_volroothead
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* convert a fid to an inode. Mostly we can compute&n;   the inode number from the FID, but not for volume&n;   mount points: those are in a list */
DECL|function|coda_fid_to_inode
r_struct
id|inode
op_star
id|coda_fid_to_inode
c_func
(paren
id|ViceFid
op_star
id|fid
comma
r_struct
id|super_block
op_star
id|sb
)paren
(brace
id|ino_t
id|nr
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_struct
id|coda_inode_info
op_star
id|cnp
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;coda_fid_to_inode: no sb!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|fid
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;coda_fid_to_inode: no fid!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|coda_f2s
c_func
(paren
id|fid
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|coda_fid_is_weird
c_func
(paren
id|fid
)paren
)paren
(brace
r_struct
id|coda_inode_info
op_star
id|cii
suffix:semicolon
r_struct
id|list_head
op_star
id|lh
comma
op_star
id|le
suffix:semicolon
r_struct
id|coda_sb_info
op_star
id|sbi
op_assign
id|coda_sbp
c_func
(paren
id|sb
)paren
suffix:semicolon
id|le
op_assign
id|lh
op_assign
op_amp
id|sbi-&gt;sbi_volroothead
suffix:semicolon
r_while
c_loop
(paren
(paren
id|le
op_assign
id|le-&gt;next
)paren
op_ne
id|lh
)paren
(brace
id|cii
op_assign
id|list_entry
c_func
(paren
id|le
comma
r_struct
id|coda_inode_info
comma
id|c_volrootlist
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;iterating, now doing %s, ino %ld&bslash;n&quot;
comma
id|coda_f2s
c_func
(paren
op_amp
id|cii-&gt;c_fid
)paren
comma
id|cii-&gt;c_vnode-&gt;i_ino
)paren
suffix:semicolon
r_if
c_cond
(paren
id|coda_fideq
c_func
(paren
op_amp
id|cii-&gt;c_fid
comma
id|fid
)paren
)paren
(brace
id|inode
op_assign
id|cii-&gt;c_vnode
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;volume root, found %ld&bslash;n&quot;
comma
id|cii-&gt;c_vnode-&gt;i_ino
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cii-&gt;c_magic
op_ne
id|CODA_CNODE_MAGIC
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Bad magic in inode, tell Peter.&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|cii-&gt;c_vnode
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* fid is not weird: ino should be computable */
id|nr
op_assign
id|coda_f2i
c_func
(paren
id|fid
)paren
suffix:semicolon
id|inode
op_assign
id|iget
c_func
(paren
id|sb
comma
id|nr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;coda_fid_to_inode: null from iget, sb %p, nr %ld.&bslash;n&quot;
comma
id|sb
comma
id|nr
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* check if this inode is linked to a cnode */
id|cnp
op_assign
id|ITOC
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnp-&gt;c_magic
op_ne
id|CODA_CNODE_MAGIC
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;uninitialized inode. Return.&bslash;n&quot;
)paren
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* make sure fid is the one we want; &n;&t;   unfortunately Venus will shamelessly send us mount-symlinks.&n;&t;   These have the same inode as the root of the volume they&n;&t;   mount, but the fid will be wrong. &n;&t;*/
r_if
c_cond
(paren
op_logical_neg
id|coda_fideq
c_func
(paren
id|fid
comma
op_amp
(paren
id|cnp-&gt;c_fid
)paren
)paren
)paren
(brace
multiline_comment|/* printk(&quot;coda_fid2inode: bad cnode (ino %ld, fid %s)&quot;&n;&t;&t;   &quot;Tell Peter.&bslash;n&quot;, nr, coda_f2s(fid)); */
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;found %ld&bslash;n&quot;
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
id|inode
suffix:semicolon
)brace
multiline_comment|/* the CONTROL inode is made without asking attributes from Venus */
DECL|function|coda_cnode_makectl
r_int
id|coda_cnode_makectl
c_func
(paren
r_struct
id|inode
op_star
op_star
id|inode
comma
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
op_star
id|inode
op_assign
id|iget
c_func
(paren
id|sb
comma
id|CTL_INO
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|inode
)paren
(brace
(paren
op_star
id|inode
)paren
op_member_access_from_pointer
id|i_op
op_assign
op_amp
id|coda_ioctl_inode_operations
suffix:semicolon
(paren
op_star
id|inode
)paren
op_member_access_from_pointer
id|i_mode
op_assign
l_int|00444
suffix:semicolon
id|error
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_return
id|error
suffix:semicolon
)brace
eof
