multiline_comment|/*&n; * linux/fs/nfsd/lockd.c&n; *&n; * This file contains all the stubs needed when communicating with lockd.&n; * This level of indirection is necessary so we can run nfsd+lockd without&n; * requiring the nfs client to be compiled in/loaded, and vice versa.&n; *&n; * Copyright (C) 1996, Olaf Kirch &lt;okir@monad.swb.de&gt;&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/sunrpc/clnt.h&gt;
macro_line|#include &lt;linux/sunrpc/svc.h&gt;
macro_line|#include &lt;linux/nfsd/nfsd.h&gt;
macro_line|#include &lt;linux/lockd/bind.h&gt;
DECL|macro|NFSDDBG_FACILITY
mdefine_line|#define NFSDDBG_FACILITY&t;&t;NFSDDBG_LOCKD
multiline_comment|/*&n; * Note: we hold the dentry use count while the file is open.&n; */
r_static
id|u32
DECL|function|nlm_fopen
id|nlm_fopen
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
comma
r_struct
id|nfs_fh
op_star
id|f
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|u32
id|nfserr
suffix:semicolon
r_struct
id|svc_fh
id|fh
suffix:semicolon
multiline_comment|/* must initialize before using! but maxsize doesn&squot;t matter */
id|fh_init
c_func
(paren
op_amp
id|fh
comma
l_int|0
)paren
suffix:semicolon
id|fh.fh_handle.fh_size
op_assign
id|f-&gt;size
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|fh.fh_handle.fh_base
comma
id|f-&gt;data
comma
id|f-&gt;size
)paren
suffix:semicolon
id|fh.fh_export
op_assign
l_int|NULL
suffix:semicolon
id|nfserr
op_assign
id|nfsd_open
c_func
(paren
id|rqstp
comma
op_amp
id|fh
comma
id|S_IFREG
comma
id|MAY_LOCK
comma
id|filp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nfserr
)paren
id|dget
c_func
(paren
id|filp-&gt;f_dentry
)paren
suffix:semicolon
id|fh_put
c_func
(paren
op_amp
id|fh
)paren
suffix:semicolon
multiline_comment|/* nlm and nfsd don&squot;t share error codes.&n;&t; * we invent: 0 = no error&n;&t; *            1 = stale file handle&n;&t; *&t;      2 = other error&n;&t; */
r_switch
c_cond
(paren
id|nfserr
)paren
(brace
r_case
id|nfs_ok
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|nfserr_stale
suffix:colon
r_return
l_int|1
suffix:semicolon
r_default
suffix:colon
r_return
l_int|2
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|nlm_fclose
id|nlm_fclose
c_func
(paren
r_struct
id|file
op_star
id|filp
)paren
(brace
id|nfsd_close
c_func
(paren
id|filp
)paren
suffix:semicolon
id|dput
c_func
(paren
id|filp-&gt;f_dentry
)paren
suffix:semicolon
)brace
DECL|variable|nfsd_nlm_ops
r_struct
id|nlmsvc_binding
id|nfsd_nlm_ops
op_assign
(brace
id|exp_readlock
comma
multiline_comment|/* lock export table for reading */
id|exp_unlock
comma
multiline_comment|/* unlock export table */
id|exp_getclient
comma
multiline_comment|/* look up NFS client */
id|nlm_fopen
comma
multiline_comment|/* open file for locking */
id|nlm_fclose
comma
multiline_comment|/* close file */
id|exp_nlmdetach
comma
multiline_comment|/* lockd shutdown notification */
)brace
suffix:semicolon
multiline_comment|/*&n; * When removing an NFS client entry, notify lockd that it is gone.&n; * FIXME: We should do the same when unexporting an NFS volume.&n; */
r_void
DECL|function|nfsd_lockd_unexport
id|nfsd_lockd_unexport
c_func
(paren
r_struct
id|svc_client
op_star
id|clnt
)paren
(brace
id|nlmsvc_invalidate_client
c_func
(paren
id|clnt
)paren
suffix:semicolon
)brace
r_void
DECL|function|nfsd_lockd_init
id|nfsd_lockd_init
c_func
(paren
r_void
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;nfsd: initializing lockd&bslash;n&quot;
)paren
suffix:semicolon
id|nlmsvc_ops
op_assign
op_amp
id|nfsd_nlm_ops
suffix:semicolon
)brace
r_void
DECL|function|nfsd_lockd_shutdown
id|nfsd_lockd_shutdown
c_func
(paren
r_void
)paren
(brace
id|nlmsvc_ops
op_assign
l_int|NULL
suffix:semicolon
)brace
eof
