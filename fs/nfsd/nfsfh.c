multiline_comment|/*&n; * linux/fs/nfsd/nfsfh.c&n; *&n; * NFS server filehandle treatment.&n; *&n; * Copyright (C) 1995, 1996 Olaf Kirch &lt;okir@monad.swb.de&gt;&n; */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/sunrpc/svc.h&gt;
macro_line|#include &lt;linux/nfsd/nfsd.h&gt;
DECL|macro|NFSDDBG_FACILITY
mdefine_line|#define NFSDDBG_FACILITY&t;&t;NFSDDBG_FH
multiline_comment|/*&n; * Get the inode version number&n; */
r_static
r_inline
r_int
DECL|function|nfsd_iversion
id|nfsd_iversion
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
r_if
c_cond
(paren
id|inode-&gt;i_sb-&gt;s_magic
op_eq
id|EXT2_SUPER_MAGIC
)paren
r_return
id|inode-&gt;u.ext2_i.i_version
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Get the inode given a file handle.&n; */
id|u32
DECL|function|fh_lookup
id|fh_lookup
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
comma
r_struct
id|svc_fh
op_star
id|fhp
comma
r_int
id|type
comma
r_int
id|access
)paren
(brace
r_struct
id|svc_export
op_star
id|exp
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_struct
id|knfs_fh
op_star
id|fh
op_assign
op_amp
id|fhp-&gt;fh_handle
suffix:semicolon
multiline_comment|/* Already checked */
r_if
c_cond
(paren
id|fhp-&gt;fh_inode
)paren
r_return
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;nfsd: fh_lookup(exp %x/%ld fh %x/%ld)&bslash;n&quot;
comma
id|fh-&gt;fh_xdev
comma
id|fh-&gt;fh_xino
comma
id|fh-&gt;fh_dev
comma
id|fh-&gt;fh_ino
)paren
suffix:semicolon
multiline_comment|/* Make sure that clients don&squot;t cheat */
r_if
c_cond
(paren
id|fh-&gt;fh_dev
op_ne
id|fh-&gt;fh_xdev
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;nfsd: fh with bad dev fields &quot;
l_string|&quot;(%x != %x) from %08lx:%d&bslash;n&quot;
comma
id|fh-&gt;fh_dev
comma
id|fh-&gt;fh_xdev
comma
id|ntohl
c_func
(paren
id|rqstp-&gt;rq_addr.sin_addr.s_addr
)paren
comma
id|ntohs
c_func
(paren
id|rqstp-&gt;rq_addr.sin_port
)paren
)paren
suffix:semicolon
r_return
id|nfserr_perm
suffix:semicolon
)brace
multiline_comment|/* Look up the export entry */
id|exp
op_assign
id|exp_get
c_func
(paren
id|rqstp-&gt;rq_client
comma
id|fh-&gt;fh_xdev
comma
id|fh-&gt;fh_xino
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|exp
)paren
(brace
multiline_comment|/* nfsdstats.fhstale++; */
r_return
id|nfserr_stale
suffix:semicolon
multiline_comment|/* export entry revoked */
)brace
multiline_comment|/* Check if the request originated from a secure port. */
r_if
c_cond
(paren
op_logical_neg
id|rqstp-&gt;rq_secure
op_logical_and
id|EX_SECURE
c_func
(paren
id|exp
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;nfsd: request from insecure port (%08lx:%d)!&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|rqstp-&gt;rq_addr.sin_addr.s_addr
)paren
comma
id|ntohs
c_func
(paren
id|rqstp-&gt;rq_addr.sin_port
)paren
)paren
suffix:semicolon
r_return
id|nfserr_perm
suffix:semicolon
)brace
multiline_comment|/* Set user creds if we haven&squot;t done so already */
id|nfsd_setuser
c_func
(paren
id|rqstp
comma
id|exp
)paren
suffix:semicolon
multiline_comment|/* Get the inode */
r_if
c_cond
(paren
op_logical_neg
(paren
id|inode
op_assign
id|nfsd_iget
c_func
(paren
id|fh-&gt;fh_dev
comma
id|fh-&gt;fh_ino
)paren
)paren
op_logical_or
op_logical_neg
id|inode-&gt;i_nlink
op_logical_or
id|fh-&gt;fh_version
op_ne
id|nfsd_iversion
c_func
(paren
id|inode
)paren
)paren
(brace
r_if
c_cond
(paren
id|inode
)paren
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
multiline_comment|/* nfsdstats.fhstale++; */
r_return
id|nfserr_stale
suffix:semicolon
multiline_comment|/* unlinked in the meanwhile */
)brace
multiline_comment|/* This is basically what wait_on_inode does */
r_while
c_loop
(paren
id|inode-&gt;i_lock
)paren
id|sleep_on
c_func
(paren
op_amp
id|inode-&gt;i_wait
)paren
suffix:semicolon
id|fhp-&gt;fh_inode
op_assign
id|inode
suffix:semicolon
id|fhp-&gt;fh_export
op_assign
id|exp
suffix:semicolon
multiline_comment|/* Type check. The correct error return for type mismatches&n;&t; * does not seem to be generally agreed upon. SunOS seems to&n;&t; * use EISDIR if file isn&squot;t S_IFREG; a comment in the NFSv3&n;&t; * spec says this is incorrect (implementation notes for the&n;&t; * write call).&n;&t; */
r_if
c_cond
(paren
id|type
OG
l_int|0
op_logical_and
(paren
id|inode-&gt;i_mode
op_amp
id|S_IFMT
)paren
op_ne
id|type
)paren
r_return
(paren
id|type
op_eq
id|S_IFDIR
)paren
ques
c_cond
id|nfserr_notdir
suffix:colon
id|nfserr_isdir
suffix:semicolon
r_if
c_cond
(paren
id|type
OL
l_int|0
op_logical_and
(paren
id|inode-&gt;i_mode
op_amp
id|S_IFMT
)paren
op_eq
op_minus
id|type
)paren
r_return
(paren
id|type
op_eq
op_minus
id|S_IFDIR
)paren
ques
c_cond
id|nfserr_notdir
suffix:colon
id|nfserr_isdir
suffix:semicolon
multiline_comment|/* Finally, check access permissions */
r_return
id|nfsd_permission
c_func
(paren
id|fhp-&gt;fh_export
comma
id|inode
comma
id|access
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Compose file handle for NFS reply.&n; */
r_void
DECL|function|fh_compose
id|fh_compose
c_func
(paren
r_struct
id|svc_fh
op_star
id|fhp
comma
r_struct
id|svc_export
op_star
id|exp
comma
r_struct
id|inode
op_star
id|inode
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;nfsd: fh_compose(exp %x/%ld fh %x/%ld)&bslash;n&quot;
comma
id|exp-&gt;ex_dev
comma
id|exp-&gt;ex_ino
comma
id|inode-&gt;i_dev
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
id|fh_init
c_func
(paren
id|fhp
)paren
suffix:semicolon
multiline_comment|/* initialize empty fh */
id|fhp-&gt;fh_inode
op_assign
id|inode
suffix:semicolon
id|fhp-&gt;fh_export
op_assign
id|exp
suffix:semicolon
id|fhp-&gt;fh_handle.fh_dev
op_assign
id|inode-&gt;i_dev
suffix:semicolon
id|fhp-&gt;fh_handle.fh_ino
op_assign
id|inode-&gt;i_ino
suffix:semicolon
id|fhp-&gt;fh_handle.fh_xdev
op_assign
id|exp-&gt;ex_dev
suffix:semicolon
id|fhp-&gt;fh_handle.fh_xino
op_assign
id|exp-&gt;ex_ino
suffix:semicolon
id|fhp-&gt;fh_handle.fh_version
op_assign
id|nfsd_iversion
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
eof
