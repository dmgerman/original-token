multiline_comment|/* -*- linux-c -*- --------------------------------------------------------- *&n; *&n; * linux/fs/autofs/root.c&n; *&n; *  Copyright 1997 Transmeta Corporation -- All Rights Reserved&n; *&n; * This file is part of the Linux kernel and is made available under&n; * the terms of the GNU General Public License, version 2, or at your&n; * option, any later version, incorporated herein by reference.&n; *&n; * ------------------------------------------------------------------------- */
macro_line|#include &lt;linux/modversions.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/ioctl.h&gt;
macro_line|#include &lt;linux/auto_fs.h&gt;
r_static
r_int
id|autofs_root_readdir
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
comma
r_void
op_star
comma
id|filldir_t
)paren
suffix:semicolon
r_static
r_int
id|autofs_root_lookup
c_func
(paren
r_struct
id|inode
op_star
comma
r_const
r_char
op_star
comma
r_int
comma
r_struct
id|inode
op_star
op_star
)paren
suffix:semicolon
r_static
r_int
id|autofs_root_symlink
c_func
(paren
r_struct
id|inode
op_star
comma
r_const
r_char
op_star
comma
r_int
comma
r_const
r_char
op_star
)paren
suffix:semicolon
r_static
r_int
id|autofs_root_unlink
c_func
(paren
r_struct
id|inode
op_star
comma
r_const
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|autofs_root_rmdir
c_func
(paren
r_struct
id|inode
op_star
comma
r_const
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|autofs_root_mkdir
c_func
(paren
r_struct
id|inode
op_star
comma
r_const
r_char
op_star
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|autofs_root_ioctl
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
comma
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
DECL|variable|autofs_root_operations
r_static
r_struct
id|file_operations
id|autofs_root_operations
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* lseek */
l_int|NULL
comma
multiline_comment|/* read */
l_int|NULL
comma
multiline_comment|/* write */
id|autofs_root_readdir
comma
multiline_comment|/* readdir */
l_int|NULL
comma
multiline_comment|/* select */
id|autofs_root_ioctl
comma
multiline_comment|/* ioctl */
l_int|NULL
comma
multiline_comment|/* mmap */
l_int|NULL
comma
multiline_comment|/* open */
l_int|NULL
comma
multiline_comment|/* release */
l_int|NULL
multiline_comment|/* fsync */
)brace
suffix:semicolon
DECL|variable|autofs_root_inode_operations
r_struct
id|inode_operations
id|autofs_root_inode_operations
op_assign
(brace
op_amp
id|autofs_root_operations
comma
multiline_comment|/* file operations */
l_int|NULL
comma
multiline_comment|/* create */
id|autofs_root_lookup
comma
multiline_comment|/* lookup */
l_int|NULL
comma
multiline_comment|/* link */
id|autofs_root_unlink
comma
multiline_comment|/* unlink */
id|autofs_root_symlink
comma
multiline_comment|/* symlink */
id|autofs_root_mkdir
comma
multiline_comment|/* mkdir */
id|autofs_root_rmdir
comma
multiline_comment|/* rmdir */
l_int|NULL
comma
multiline_comment|/* mknod */
l_int|NULL
comma
multiline_comment|/* rename */
l_int|NULL
comma
multiline_comment|/* readlink */
l_int|NULL
comma
multiline_comment|/* follow_link */
l_int|NULL
comma
multiline_comment|/* readpage */
l_int|NULL
comma
multiline_comment|/* writepage */
l_int|NULL
comma
multiline_comment|/* bmap */
l_int|NULL
comma
multiline_comment|/* truncate */
l_int|NULL
multiline_comment|/* permission */
)brace
suffix:semicolon
DECL|function|autofs_root_readdir
r_static
r_int
id|autofs_root_readdir
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_void
op_star
id|dirent
comma
id|filldir_t
id|filldir
)paren
(brace
r_struct
id|autofs_dir_ent
op_star
id|ent
suffix:semicolon
r_struct
id|autofs_dirhash
op_star
id|dirhash
suffix:semicolon
id|off_t
id|onr
comma
id|nr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
op_logical_or
op_logical_neg
id|S_ISDIR
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
r_return
op_minus
id|ENOTDIR
suffix:semicolon
id|dirhash
op_assign
op_amp
(paren
(paren
r_struct
id|autofs_sb_info
op_star
)paren
id|inode-&gt;i_sb-&gt;u.generic_sbp
)paren
op_member_access_from_pointer
id|dirhash
suffix:semicolon
id|nr
op_assign
id|filp-&gt;f_pos
suffix:semicolon
r_switch
c_cond
(paren
id|nr
)paren
(brace
r_case
l_int|0
suffix:colon
r_if
c_cond
(paren
id|filldir
c_func
(paren
id|dirent
comma
l_string|&quot;.&quot;
comma
l_int|1
comma
id|nr
comma
id|inode-&gt;i_ino
)paren
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|filp-&gt;f_pos
op_assign
op_increment
id|nr
suffix:semicolon
multiline_comment|/* fall through */
r_case
l_int|1
suffix:colon
r_if
c_cond
(paren
id|filldir
c_func
(paren
id|dirent
comma
l_string|&quot;..&quot;
comma
l_int|2
comma
id|nr
comma
id|inode-&gt;i_ino
)paren
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|filp-&gt;f_pos
op_assign
op_increment
id|nr
suffix:semicolon
multiline_comment|/* fall through */
r_default
suffix:colon
(brace
)brace
r_while
c_loop
(paren
id|onr
op_assign
id|nr
comma
id|ent
op_assign
id|autofs_hash_enum
c_func
(paren
id|dirhash
comma
op_amp
id|nr
)paren
)paren
(brace
r_if
c_cond
(paren
id|filldir
c_func
(paren
id|dirent
comma
id|ent-&gt;name
comma
id|ent-&gt;len
comma
id|onr
comma
id|ent-&gt;ino
)paren
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|filp-&gt;f_pos
op_assign
id|nr
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|autofs_root_lookup
r_static
r_int
id|autofs_root_lookup
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
comma
r_struct
id|inode
op_star
op_star
id|result
)paren
(brace
r_struct
id|autofs_sb_info
op_star
id|sbi
suffix:semicolon
r_struct
id|autofs_dir_ent
op_star
id|ent
suffix:semicolon
r_struct
id|inode
op_star
id|res
suffix:semicolon
id|autofs_hash_t
id|hash
suffix:semicolon
r_int
id|status
comma
id|oz_mode
suffix:semicolon
id|DPRINTK
c_func
(paren
(paren
l_string|&quot;autofs_root_lookup: name = &quot;
)paren
)paren
suffix:semicolon
id|autofs_say
c_func
(paren
id|name
comma
id|len
)paren
suffix:semicolon
op_star
id|result
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dir
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|S_ISDIR
c_func
(paren
id|dir-&gt;i_mode
)paren
)paren
(brace
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|ENOTDIR
suffix:semicolon
)brace
multiline_comment|/* Handle special cases: . and ..; since this is a root directory,&n;&t;   they both point to the inode itself */
op_star
id|result
op_assign
id|dir
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|name
(braket
l_int|0
)braket
op_eq
l_char|&squot;.&squot;
)paren
(brace
r_if
c_cond
(paren
id|len
op_eq
l_int|1
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|name
(braket
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
op_logical_and
id|len
op_eq
l_int|2
)paren
r_return
l_int|0
suffix:semicolon
)brace
op_star
id|result
op_assign
id|res
op_assign
l_int|NULL
suffix:semicolon
id|sbi
op_assign
(paren
r_struct
id|autofs_sb_info
op_star
)paren
id|dir-&gt;i_sb-&gt;u.generic_sbp
suffix:semicolon
id|hash
op_assign
id|autofs_hash
c_func
(paren
id|name
comma
id|len
)paren
suffix:semicolon
id|oz_mode
op_assign
id|autofs_oz_mode
c_func
(paren
id|sbi
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
(paren
l_string|&quot;autofs_lookup: pid = %u, pgrp = %u, catatonic = %d, oz_mode = %d&bslash;n&quot;
comma
id|current-&gt;pid
comma
id|current-&gt;pgrp
comma
id|sbi-&gt;catatonic
comma
id|oz_mode
)paren
)paren
suffix:semicolon
r_do
(brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|ent
op_assign
id|autofs_hash_lookup
c_func
(paren
op_amp
id|sbi-&gt;dirhash
comma
id|hash
comma
id|name
comma
id|len
)paren
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
(paren
l_string|&quot;lookup failed, pid = %u, pgrp = %u&bslash;n&quot;
comma
id|current-&gt;pid
comma
id|current-&gt;pgrp
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|oz_mode
)paren
(brace
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
r_else
(brace
id|status
op_assign
id|autofs_wait
c_func
(paren
id|sbi
comma
id|hash
comma
id|name
comma
id|len
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
(paren
l_string|&quot;autofs_wait returned %d&bslash;n&quot;
comma
id|status
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
)brace
)brace
id|DPRINTK
c_func
(paren
(paren
l_string|&quot;lookup successful, inode = %08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|ent-&gt;ino
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|res
op_assign
id|iget
c_func
(paren
id|dir-&gt;i_sb
comma
id|ent-&gt;ino
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;autofs: iget returned null!&bslash;n&quot;
)paren
suffix:semicolon
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|EACCES
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|oz_mode
op_logical_and
id|S_ISDIR
c_func
(paren
id|res-&gt;i_mode
)paren
op_logical_and
id|res-&gt;i_sb
op_eq
id|dir-&gt;i_sb
)paren
(brace
multiline_comment|/* Not a mount point yet, call 1-800-DAEMON */
id|DPRINTK
c_func
(paren
(paren
l_string|&quot;autofs: waiting on non-mountpoint dir, inode = %lu, pid = %u, pgrp = %u&bslash;n&quot;
comma
id|res-&gt;i_ino
comma
id|current-&gt;pid
comma
id|current-&gt;pgrp
)paren
)paren
suffix:semicolon
id|iput
c_func
(paren
id|res
)paren
suffix:semicolon
id|res
op_assign
l_int|NULL
suffix:semicolon
id|status
op_assign
id|autofs_wait
c_func
(paren
id|sbi
comma
id|hash
comma
id|name
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
)brace
)brace
r_while
c_loop
(paren
op_logical_neg
id|res
)paren
(brace
suffix:semicolon
)brace
op_star
id|result
op_assign
id|res
suffix:semicolon
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|autofs_root_symlink
r_static
r_int
id|autofs_root_symlink
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
comma
r_const
r_char
op_star
id|symname
)paren
(brace
r_struct
id|autofs_sb_info
op_star
id|sbi
op_assign
(paren
r_struct
id|autofs_sb_info
op_star
)paren
id|dir-&gt;i_sb-&gt;u.generic_sbp
suffix:semicolon
r_struct
id|autofs_dirhash
op_star
id|dh
op_assign
op_amp
id|sbi-&gt;dirhash
suffix:semicolon
id|autofs_hash_t
id|hash
op_assign
id|autofs_hash
c_func
(paren
id|name
comma
id|len
)paren
suffix:semicolon
r_struct
id|autofs_dir_ent
op_star
id|ent
suffix:semicolon
r_int
r_int
id|n
suffix:semicolon
r_int
id|slsize
suffix:semicolon
r_struct
id|autofs_symlink
op_star
id|sl
suffix:semicolon
id|DPRINTK
c_func
(paren
(paren
l_string|&quot;autofs_root_symlink: %s &lt;- &quot;
comma
id|symname
)paren
)paren
suffix:semicolon
id|autofs_say
c_func
(paren
id|name
comma
id|len
)paren
suffix:semicolon
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|autofs_oz_mode
c_func
(paren
id|sbi
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|autofs_hash_lookup
c_func
(paren
id|dh
comma
id|hash
comma
id|name
comma
id|len
)paren
)paren
r_return
op_minus
id|EEXIST
suffix:semicolon
id|n
op_assign
id|find_first_zero_bit
c_func
(paren
id|sbi-&gt;symlink_bitmap
comma
id|AUTOFS_MAX_SYMLINKS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ge
id|AUTOFS_MAX_SYMLINKS
)paren
r_return
op_minus
id|ENOSPC
suffix:semicolon
id|set_bit
c_func
(paren
id|n
comma
id|sbi-&gt;symlink_bitmap
)paren
suffix:semicolon
id|sl
op_assign
op_amp
id|sbi-&gt;symlink
(braket
id|n
)braket
suffix:semicolon
id|sl-&gt;len
op_assign
id|strlen
c_func
(paren
id|symname
)paren
suffix:semicolon
id|sl-&gt;data
op_assign
id|kmalloc
c_func
(paren
id|slsize
op_assign
id|sl-&gt;len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sl-&gt;data
)paren
(brace
id|clear_bit
c_func
(paren
id|n
comma
id|sbi-&gt;symlink_bitmap
)paren
suffix:semicolon
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
id|ent
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|autofs_dir_ent
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ent
)paren
(brace
id|kfree
c_func
(paren
id|sl-&gt;data
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|n
comma
id|sbi-&gt;symlink_bitmap
)paren
suffix:semicolon
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
id|ent-&gt;name
op_assign
id|kmalloc
c_func
(paren
id|len
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ent-&gt;name
)paren
(brace
id|kfree
c_func
(paren
id|sl-&gt;data
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ent
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|n
comma
id|sbi-&gt;symlink_bitmap
)paren
suffix:semicolon
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|sl-&gt;data
comma
id|symname
comma
id|slsize
)paren
suffix:semicolon
id|sl-&gt;mtime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|ent-&gt;ino
op_assign
id|AUTOFS_FIRST_SYMLINK
op_plus
id|n
suffix:semicolon
id|ent-&gt;hash
op_assign
id|hash
suffix:semicolon
id|memcpy
c_func
(paren
id|ent-&gt;name
comma
id|name
comma
id|ent-&gt;len
op_assign
id|len
)paren
suffix:semicolon
id|ent-&gt;expiry
op_assign
id|END_OF_TIME
suffix:semicolon
id|autofs_hash_insert
c_func
(paren
id|dh
comma
id|ent
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|autofs_root_unlink
r_static
r_int
id|autofs_root_unlink
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
)paren
(brace
r_struct
id|autofs_sb_info
op_star
id|sbi
op_assign
(paren
r_struct
id|autofs_sb_info
op_star
)paren
id|dir-&gt;i_sb-&gt;u.generic_sbp
suffix:semicolon
r_struct
id|autofs_dirhash
op_star
id|dh
op_assign
op_amp
id|sbi-&gt;dirhash
suffix:semicolon
id|autofs_hash_t
id|hash
op_assign
id|autofs_hash
c_func
(paren
id|name
comma
id|len
)paren
suffix:semicolon
r_struct
id|autofs_dir_ent
op_star
id|ent
suffix:semicolon
r_int
r_int
id|n
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|autofs_oz_mode
c_func
(paren
id|sbi
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|ent
op_assign
id|autofs_hash_lookup
c_func
(paren
id|dh
comma
id|hash
comma
id|name
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ent
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
id|n
op_assign
id|ent-&gt;ino
op_minus
id|AUTOFS_FIRST_SYMLINK
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ge
id|AUTOFS_MAX_SYMLINKS
op_logical_or
op_logical_neg
id|test_bit
c_func
(paren
id|n
comma
id|sbi-&gt;symlink_bitmap
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Not a symlink inode, can&squot;t unlink */
id|autofs_hash_delete
c_func
(paren
id|ent
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|n
comma
id|sbi-&gt;symlink_bitmap
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sbi-&gt;symlink
(braket
id|n
)braket
dot
id|data
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|autofs_root_rmdir
r_static
r_int
id|autofs_root_rmdir
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
)paren
(brace
r_struct
id|autofs_sb_info
op_star
id|sbi
op_assign
(paren
r_struct
id|autofs_sb_info
op_star
)paren
id|dir-&gt;i_sb-&gt;u.generic_sbp
suffix:semicolon
r_struct
id|autofs_dirhash
op_star
id|dh
op_assign
op_amp
id|sbi-&gt;dirhash
suffix:semicolon
id|autofs_hash_t
id|hash
op_assign
id|autofs_hash
c_func
(paren
id|name
comma
id|len
)paren
suffix:semicolon
r_struct
id|autofs_dir_ent
op_star
id|ent
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|autofs_oz_mode
c_func
(paren
id|sbi
)paren
)paren
(brace
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
id|ent
op_assign
id|autofs_hash_lookup
c_func
(paren
id|dh
comma
id|hash
comma
id|name
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ent
)paren
(brace
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|ent-&gt;ino
OL
id|AUTOFS_FIRST_DIR_INO
)paren
(brace
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|ENOTDIR
suffix:semicolon
multiline_comment|/* Not a directory */
)brace
id|autofs_hash_delete
c_func
(paren
id|ent
)paren
suffix:semicolon
id|dir-&gt;i_nlink
op_decrement
suffix:semicolon
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|autofs_root_mkdir
r_static
r_int
id|autofs_root_mkdir
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
comma
r_int
id|mode
)paren
(brace
r_struct
id|autofs_sb_info
op_star
id|sbi
op_assign
(paren
r_struct
id|autofs_sb_info
op_star
)paren
id|dir-&gt;i_sb-&gt;u.generic_sbp
suffix:semicolon
r_struct
id|autofs_dirhash
op_star
id|dh
op_assign
op_amp
id|sbi-&gt;dirhash
suffix:semicolon
id|autofs_hash_t
id|hash
op_assign
id|autofs_hash
c_func
(paren
id|name
comma
id|len
)paren
suffix:semicolon
r_struct
id|autofs_dir_ent
op_star
id|ent
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|autofs_oz_mode
c_func
(paren
id|sbi
)paren
)paren
(brace
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
id|ent
op_assign
id|autofs_hash_lookup
c_func
(paren
id|dh
comma
id|hash
comma
id|name
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ent
)paren
(brace
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|EEXIST
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sbi-&gt;next_dir_ino
OL
id|AUTOFS_FIRST_DIR_INO
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;autofs: Out of inode numbers -- what the heck did you do??&bslash;n&quot;
)paren
suffix:semicolon
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
id|ent
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|autofs_dir_ent
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ent
)paren
(brace
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
id|ent-&gt;name
op_assign
id|kmalloc
c_func
(paren
id|len
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ent-&gt;name
)paren
(brace
id|kfree
c_func
(paren
id|ent
)paren
suffix:semicolon
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
id|ent-&gt;hash
op_assign
id|hash
suffix:semicolon
id|memcpy
c_func
(paren
id|ent-&gt;name
comma
id|name
comma
id|ent-&gt;len
op_assign
id|len
)paren
suffix:semicolon
id|ent-&gt;ino
op_assign
id|sbi-&gt;next_dir_ino
op_increment
suffix:semicolon
id|ent-&gt;expiry
op_assign
id|END_OF_TIME
suffix:semicolon
id|autofs_hash_insert
c_func
(paren
id|dh
comma
id|ent
)paren
suffix:semicolon
id|dir-&gt;i_nlink
op_increment
suffix:semicolon
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * ioctl()&squot;s on the root directory is the chief method for the daemon to&n; * generate kernel reactions&n; */
DECL|function|autofs_root_ioctl
r_static
r_int
id|autofs_root_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|autofs_sb_info
op_star
id|sbi
op_assign
(paren
r_struct
id|autofs_sb_info
op_star
)paren
id|inode-&gt;i_sb-&gt;u.generic_sbp
suffix:semicolon
id|DPRINTK
c_func
(paren
(paren
l_string|&quot;autofs_ioctl: cmd = %04x, arg = 0x%08lx, sbi = %p, pgrp = %u&bslash;n&quot;
comma
id|cmd
comma
id|arg
comma
id|sbi
comma
id|current-&gt;pgrp
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|AUTOFS_IOC_READY
suffix:colon
multiline_comment|/* Wait queue: go ahead and retry */
r_if
c_cond
(paren
op_logical_neg
id|autofs_oz_mode
c_func
(paren
id|sbi
)paren
op_logical_and
op_logical_neg
id|fsuser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_return
id|autofs_wait_release
c_func
(paren
id|sbi
comma
id|arg
comma
l_int|0
)paren
suffix:semicolon
r_case
id|AUTOFS_IOC_FAIL
suffix:colon
multiline_comment|/* Wait queue: fail with ENOENT */
multiline_comment|/* Optional: add to failure cache */
r_if
c_cond
(paren
op_logical_neg
id|autofs_oz_mode
c_func
(paren
id|sbi
)paren
op_logical_and
op_logical_neg
id|fsuser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_return
id|autofs_wait_release
c_func
(paren
id|sbi
comma
id|arg
comma
op_minus
id|ENOENT
)paren
suffix:semicolon
r_case
id|AUTOFS_IOC_CATATONIC
suffix:colon
multiline_comment|/* Enter catatonic mode (daemon shutdown) */
r_if
c_cond
(paren
op_logical_neg
id|autofs_oz_mode
c_func
(paren
id|sbi
)paren
op_logical_and
op_logical_neg
id|fsuser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|autofs_catatonic_mode
c_func
(paren
id|sbi
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOTTY
suffix:semicolon
multiline_comment|/* Should this be ENOSYS? */
)brace
)brace
eof
