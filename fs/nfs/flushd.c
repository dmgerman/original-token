multiline_comment|/*&n; * linux/fs/nfs/flushd.c&n; *&n; * For each NFS mount, there is a separate cache object that contains&n; * a hash table of all clusters. With this cache, an async RPC task&n; * (`flushd&squot;) is associated, which wakes up occasionally to inspect&n; * its list of dirty buffers.&n; * (Note that RPC tasks aren&squot;t kernel threads. Take a look at the&n; * rpciod code to understand what they are).&n; *&n; * Inside the cache object, we also maintain a count of the current number&n; * of dirty pages, which may not exceed a certain threshold.&n; * (FIXME: This threshold should be configurable).&n; *&n; * The code is streamlined for what I think is the prevalent case for&n; * NFS traffic, which is sequential write access without concurrent&n; * access by different processes.&n; *&n; * Copyright (C) 1996, 1997, Olaf Kirch &lt;okir@monad.swb.de&gt;&n; *&n; * Rewritten 6/3/2000 by Trond Myklebust&n; * Copyright (C) 1999, 2000, Trond Myklebust &lt;trond.myklebust@fys.uio.no&gt;&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/pagemap.h&gt;
macro_line|#include &lt;linux/file.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/sunrpc/auth.h&gt;
macro_line|#include &lt;linux/sunrpc/clnt.h&gt;
macro_line|#include &lt;linux/sunrpc/sched.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/nfs.h&gt;
macro_line|#include &lt;linux/nfs_fs.h&gt;
macro_line|#include &lt;linux/nfs_fs_sb.h&gt;
macro_line|#include &lt;linux/nfs_flushd.h&gt;
macro_line|#include &lt;linux/nfs_mount.h&gt;
multiline_comment|/*&n; * Various constants&n; */
DECL|macro|NFSDBG_FACILITY
mdefine_line|#define NFSDBG_FACILITY         NFSDBG_PAGECACHE
multiline_comment|/*&n; * This is the wait queue all cluster daemons sleep on&n; */
DECL|variable|flushd_queue
r_static
r_struct
id|rpc_wait_queue
id|flushd_queue
op_assign
id|RPC_INIT_WAITQ
c_func
(paren
l_string|&quot;nfs_flushd&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * Spinlock&n; */
DECL|variable|nfs_flushd_lock
id|spinlock_t
id|nfs_flushd_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/*&n; * Local function declarations.&n; */
r_static
r_void
id|nfs_flushd
c_func
(paren
r_struct
id|rpc_task
op_star
)paren
suffix:semicolon
r_static
r_void
id|nfs_flushd_exit
c_func
(paren
r_struct
id|rpc_task
op_star
)paren
suffix:semicolon
DECL|function|nfs_reqlist_init
r_int
id|nfs_reqlist_init
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
)paren
(brace
r_struct
id|nfs_reqlist
op_star
id|cache
suffix:semicolon
r_struct
id|rpc_task
op_star
id|task
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;NFS: writecache_init&bslash;n&quot;
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|nfs_flushd_lock
)paren
suffix:semicolon
id|cache
op_assign
id|server-&gt;rw_requests
suffix:semicolon
r_if
c_cond
(paren
id|cache-&gt;task
)paren
r_goto
id|out_unlock
suffix:semicolon
multiline_comment|/* Create the RPC task */
id|status
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|task
op_assign
id|rpc_new_task
c_func
(paren
id|server-&gt;client
comma
l_int|NULL
comma
id|RPC_TASK_ASYNC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|task
)paren
r_goto
id|out_unlock
suffix:semicolon
id|task-&gt;tk_calldata
op_assign
id|server
suffix:semicolon
id|cache-&gt;task
op_assign
id|task
suffix:semicolon
multiline_comment|/* Run the task */
id|cache-&gt;runat
op_assign
id|jiffies
suffix:semicolon
id|cache-&gt;auth
op_assign
id|server-&gt;client-&gt;cl_auth
suffix:semicolon
id|task-&gt;tk_action
op_assign
id|nfs_flushd
suffix:semicolon
id|task-&gt;tk_exit
op_assign
id|nfs_flushd_exit
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|nfs_flushd_lock
)paren
suffix:semicolon
id|rpc_execute
c_func
(paren
id|task
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_unlock
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|nfs_flushd_lock
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|nfs_reqlist_exit
r_void
id|nfs_reqlist_exit
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
)paren
(brace
r_struct
id|nfs_reqlist
op_star
id|cache
suffix:semicolon
id|cache
op_assign
id|server-&gt;rw_requests
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cache
)paren
r_return
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;NFS: reqlist_exit (ptr %p rpc %p)&bslash;n&quot;
comma
id|cache
comma
id|cache-&gt;task
)paren
suffix:semicolon
r_while
c_loop
(paren
id|cache-&gt;task
op_logical_or
id|cache-&gt;inodes
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|nfs_flushd_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cache-&gt;task
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|nfs_flushd_lock
)paren
suffix:semicolon
id|nfs_reqlist_init
c_func
(paren
id|server
)paren
suffix:semicolon
)brace
r_else
(brace
id|cache-&gt;task-&gt;tk_status
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|rpc_wake_up_task
c_func
(paren
id|cache-&gt;task
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|nfs_flushd_lock
)paren
suffix:semicolon
)brace
id|interruptible_sleep_on_timeout
c_func
(paren
op_amp
id|cache-&gt;request_wait
comma
l_int|1
op_star
id|HZ
)paren
suffix:semicolon
)brace
)brace
DECL|function|nfs_reqlist_alloc
r_int
id|nfs_reqlist_alloc
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
)paren
(brace
r_struct
id|nfs_reqlist
op_star
id|cache
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;rw_requests
)paren
r_return
l_int|0
suffix:semicolon
id|cache
op_assign
(paren
r_struct
id|nfs_reqlist
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|cache
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cache
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|cache
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|cache
)paren
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|cache-&gt;nr_requests
comma
l_int|0
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|cache-&gt;request_wait
)paren
suffix:semicolon
id|server-&gt;rw_requests
op_assign
id|cache
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|nfs_reqlist_free
r_void
id|nfs_reqlist_free
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
)paren
(brace
r_if
c_cond
(paren
id|server-&gt;rw_requests
)paren
(brace
id|kfree
c_func
(paren
id|server-&gt;rw_requests
)paren
suffix:semicolon
id|server-&gt;rw_requests
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
DECL|function|nfs_wake_flushd
r_void
id|nfs_wake_flushd
c_func
(paren
)paren
(brace
id|rpc_wake_up_status
c_func
(paren
op_amp
id|flushd_queue
comma
op_minus
id|ENOMEM
)paren
suffix:semicolon
)brace
DECL|function|inode_append_flushd
r_static
r_void
id|inode_append_flushd
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
r_struct
id|nfs_reqlist
op_star
id|cache
op_assign
id|NFS_REQUESTLIST
c_func
(paren
id|inode
)paren
suffix:semicolon
r_struct
id|inode
op_star
op_star
id|q
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|nfs_flushd_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|NFS_FLAGS
c_func
(paren
id|inode
)paren
op_amp
id|NFS_INO_FLUSH
)paren
r_goto
id|out
suffix:semicolon
id|inode-&gt;u.nfs_i.hash_next
op_assign
l_int|NULL
suffix:semicolon
id|q
op_assign
op_amp
id|cache-&gt;inodes
suffix:semicolon
r_while
c_loop
(paren
op_star
id|q
)paren
id|q
op_assign
op_amp
(paren
op_star
id|q
)paren
op_member_access_from_pointer
id|u.nfs_i.hash_next
suffix:semicolon
op_star
id|q
op_assign
id|inode
suffix:semicolon
multiline_comment|/* Note: we increase the inode i_count in order to prevent&n;&t; *&t; it from disappearing when on the flush list&n;&t; */
id|NFS_FLAGS
c_func
(paren
id|inode
)paren
op_or_assign
id|NFS_INO_FLUSH
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|inode-&gt;i_count
)paren
suffix:semicolon
id|out
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|nfs_flushd_lock
)paren
suffix:semicolon
)brace
DECL|function|inode_remove_flushd
r_void
id|inode_remove_flushd
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
r_struct
id|nfs_reqlist
op_star
id|cache
op_assign
id|NFS_REQUESTLIST
c_func
(paren
id|inode
)paren
suffix:semicolon
r_struct
id|inode
op_star
op_star
id|q
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|nfs_flushd_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|NFS_FLAGS
c_func
(paren
id|inode
)paren
op_amp
id|NFS_INO_FLUSH
)paren
)paren
r_goto
id|out
suffix:semicolon
id|q
op_assign
op_amp
id|cache-&gt;inodes
suffix:semicolon
r_while
c_loop
(paren
op_star
id|q
op_logical_and
op_star
id|q
op_ne
id|inode
)paren
id|q
op_assign
op_amp
(paren
op_star
id|q
)paren
op_member_access_from_pointer
id|u.nfs_i.hash_next
suffix:semicolon
r_if
c_cond
(paren
op_star
id|q
)paren
(brace
op_star
id|q
op_assign
id|inode-&gt;u.nfs_i.hash_next
suffix:semicolon
id|NFS_FLAGS
c_func
(paren
id|inode
)paren
op_and_assign
op_complement
id|NFS_INO_FLUSH
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
id|out
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|nfs_flushd_lock
)paren
suffix:semicolon
)brace
DECL|function|inode_schedule_scan
r_void
id|inode_schedule_scan
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_int
r_int
id|time
)paren
(brace
r_struct
id|nfs_reqlist
op_star
id|cache
op_assign
id|NFS_REQUESTLIST
c_func
(paren
id|inode
)paren
suffix:semicolon
r_struct
id|rpc_task
op_star
id|task
suffix:semicolon
r_int
r_int
id|mintimeout
suffix:semicolon
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|NFS_NEXTSCAN
c_func
(paren
id|inode
)paren
comma
id|time
)paren
)paren
id|NFS_NEXTSCAN
c_func
(paren
id|inode
)paren
op_assign
id|time
suffix:semicolon
id|mintimeout
op_assign
id|jiffies
op_plus
l_int|1
op_star
id|HZ
suffix:semicolon
r_if
c_cond
(paren
id|time_before
c_func
(paren
id|mintimeout
comma
id|NFS_NEXTSCAN
c_func
(paren
id|inode
)paren
)paren
)paren
id|mintimeout
op_assign
id|NFS_NEXTSCAN
c_func
(paren
id|inode
)paren
suffix:semicolon
id|inode_append_flushd
c_func
(paren
id|inode
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|nfs_flushd_lock
)paren
suffix:semicolon
id|task
op_assign
id|cache-&gt;task
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|task
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|nfs_flushd_lock
)paren
suffix:semicolon
id|nfs_reqlist_init
c_func
(paren
id|NFS_SERVER
c_func
(paren
id|inode
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|cache-&gt;runat
comma
id|mintimeout
)paren
)paren
id|rpc_wake_up_task
c_func
(paren
id|task
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|nfs_flushd_lock
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|nfs_flushd
id|nfs_flushd
c_func
(paren
r_struct
id|rpc_task
op_star
id|task
)paren
(brace
r_struct
id|nfs_server
op_star
id|server
suffix:semicolon
r_struct
id|nfs_reqlist
op_star
id|cache
suffix:semicolon
r_struct
id|inode
op_star
id|inode
comma
op_star
id|next
suffix:semicolon
r_int
r_int
id|delay
op_assign
id|jiffies
op_plus
id|NFS_WRITEBACK_LOCKDELAY
suffix:semicolon
r_int
id|flush
op_assign
(paren
id|task-&gt;tk_status
op_eq
op_minus
id|ENOMEM
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;NFS: %4d flushd starting&bslash;n&quot;
comma
id|task-&gt;tk_pid
)paren
suffix:semicolon
id|server
op_assign
(paren
r_struct
id|nfs_server
op_star
)paren
id|task-&gt;tk_calldata
suffix:semicolon
id|cache
op_assign
id|server-&gt;rw_requests
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|nfs_flushd_lock
)paren
suffix:semicolon
id|next
op_assign
id|cache-&gt;inodes
suffix:semicolon
id|cache-&gt;inodes
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|nfs_flushd_lock
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inode
op_assign
id|next
)paren
op_ne
l_int|NULL
)paren
(brace
id|next
op_assign
id|next-&gt;u.nfs_i.hash_next
suffix:semicolon
id|inode-&gt;u.nfs_i.hash_next
op_assign
l_int|NULL
suffix:semicolon
id|NFS_FLAGS
c_func
(paren
id|inode
)paren
op_and_assign
op_complement
id|NFS_INO_FLUSH
suffix:semicolon
r_if
c_cond
(paren
id|flush
)paren
(brace
id|nfs_pagein_inode
c_func
(paren
id|inode
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|nfs_sync_file
c_func
(paren
id|inode
comma
l_int|NULL
comma
l_int|0
comma
l_int|0
comma
id|FLUSH_AGING
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|NFS_NEXTSCAN
c_func
(paren
id|inode
)paren
)paren
)paren
(brace
id|NFS_NEXTSCAN
c_func
(paren
id|inode
)paren
op_assign
id|jiffies
op_plus
id|NFS_WRITEBACK_LOCKDELAY
suffix:semicolon
id|nfs_pagein_timeout
c_func
(paren
id|inode
)paren
suffix:semicolon
id|nfs_flush_timeout
c_func
(paren
id|inode
comma
id|FLUSH_AGING
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_NFS_V3
id|nfs_commit_timeout
c_func
(paren
id|inode
comma
id|FLUSH_AGING
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|nfs_have_writebacks
c_func
(paren
id|inode
)paren
op_logical_or
id|nfs_have_read
c_func
(paren
id|inode
)paren
)paren
(brace
id|inode_append_flushd
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|delay
comma
id|NFS_NEXTSCAN
c_func
(paren
id|inode
)paren
)paren
)paren
id|delay
op_assign
id|NFS_NEXTSCAN
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_string|&quot;NFS: %4d flushd back to sleep&bslash;n&quot;
comma
id|task-&gt;tk_pid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
op_plus
l_int|1
op_star
id|HZ
comma
id|delay
)paren
)paren
id|delay
op_assign
l_int|1
op_star
id|HZ
suffix:semicolon
r_else
id|delay
op_assign
id|delay
op_minus
id|jiffies
suffix:semicolon
id|task-&gt;tk_status
op_assign
l_int|0
suffix:semicolon
id|task-&gt;tk_action
op_assign
id|nfs_flushd
suffix:semicolon
id|task-&gt;tk_timeout
op_assign
id|delay
suffix:semicolon
id|cache-&gt;runat
op_assign
id|jiffies
op_plus
id|task-&gt;tk_timeout
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|nfs_flushd_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atomic_read
c_func
(paren
op_amp
id|cache-&gt;nr_requests
)paren
op_logical_and
op_logical_neg
id|cache-&gt;inodes
)paren
(brace
id|cache-&gt;task
op_assign
l_int|NULL
suffix:semicolon
id|task-&gt;tk_action
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
id|rpc_sleep_on
c_func
(paren
op_amp
id|flushd_queue
comma
id|task
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|nfs_flushd_lock
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|nfs_flushd_exit
id|nfs_flushd_exit
c_func
(paren
r_struct
id|rpc_task
op_star
id|task
)paren
(brace
r_struct
id|nfs_server
op_star
id|server
suffix:semicolon
r_struct
id|nfs_reqlist
op_star
id|cache
suffix:semicolon
id|server
op_assign
(paren
r_struct
id|nfs_server
op_star
)paren
id|task-&gt;tk_calldata
suffix:semicolon
id|cache
op_assign
id|server-&gt;rw_requests
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|nfs_flushd_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cache-&gt;task
op_eq
id|task
)paren
id|cache-&gt;task
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|nfs_flushd_lock
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|cache-&gt;request_wait
)paren
suffix:semicolon
)brace
eof
