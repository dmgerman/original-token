multiline_comment|/*&n; * linux/fs/nfs/bio.c&n; *&n; * Block I/O for NFS&n; *&n; * Partial copy of Linus&squot; read cache modifications to fs/nfs/file.c&n; * modified for async RPC by okir@monad.swb.de&n; *&n; * We do an ugly hack here in order to return proper error codes to the&n; * user program when a read request failed. This is a huge problem because&n; * generic_file_read only checks the return value of inode-&gt;i_op-&gt;readpage()&n; * which is usually 0 for async RPC. To overcome this obstacle, we set&n; * the error bit of the page to 1 when an error occurs, and make nfs_readpage&n; * transmit requests synchronously when encountering this.&n; *&n; * Another possible solution to this problem may be to have a cache of recent&n; * RPC call results indexed by page pointer, or even a result code field&n; * in struct page.&n; *&n; * June 96: Added retries of RPCs that seem to have failed for a transient&n; * reason.&n; */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/nfs_fs.h&gt;
macro_line|#include &lt;linux/nfsiod.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/pagemap.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/system.h&gt;
DECL|macro|DEBUG_BIO
macro_line|#undef DEBUG_BIO
macro_line|#ifdef DEBUG_BIO
DECL|macro|dprintk
mdefine_line|#define dprintk(args...)&t;printk(## args)
macro_line|#else
DECL|macro|dprintk
mdefine_line|#define dprintk(args...)&t;/* nothing */
macro_line|#endif
r_static
r_inline
r_int
DECL|function|do_read_nfs_sync
id|do_read_nfs_sync
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|page
op_star
id|page
)paren
(brace
r_struct
id|nfs_fattr
id|fattr
suffix:semicolon
r_int
id|result
comma
id|refresh
op_assign
l_int|0
suffix:semicolon
r_int
id|count
op_assign
id|PAGE_SIZE
suffix:semicolon
r_int
id|rsize
op_assign
id|NFS_SERVER
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|rsize
suffix:semicolon
r_char
op_star
id|buf
op_assign
(paren
r_char
op_star
)paren
id|page_address
c_func
(paren
id|page
)paren
suffix:semicolon
r_int
r_int
id|pos
op_assign
id|page-&gt;offset
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;NFS: do_read_nfs_sync(%p)&bslash;n&quot;
comma
id|page
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|PG_locked
comma
op_amp
id|page-&gt;flags
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|PG_error
comma
op_amp
id|page-&gt;flags
)paren
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|count
OL
id|rsize
)paren
id|rsize
op_assign
id|count
suffix:semicolon
id|result
op_assign
id|nfs_proc_read
c_func
(paren
id|NFS_SERVER
c_func
(paren
id|inode
)paren
comma
id|NFS_FH
c_func
(paren
id|inode
)paren
comma
id|pos
comma
id|rsize
comma
id|buf
comma
op_amp
id|fattr
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;nfs_proc_read(%s, (%x,%lx), %ld, %d, %p) = %d&bslash;n&quot;
comma
id|NFS_SERVER
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|hostname
comma
id|inode-&gt;i_dev
comma
id|inode-&gt;i_ino
comma
id|pos
comma
id|rsize
comma
id|buf
comma
id|result
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Even if we had a partial success we can&squot;t mark the page&n;&t;&t; * cache valid.&n;&t;&t; */
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|io_error
suffix:semicolon
id|refresh
op_assign
l_int|1
suffix:semicolon
id|count
op_sub_assign
id|result
suffix:semicolon
id|pos
op_add_assign
id|result
suffix:semicolon
id|buf
op_add_assign
id|result
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
id|rsize
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|count
)paren
suffix:semicolon
id|memset
c_func
(paren
id|buf
comma
l_int|0
comma
id|count
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|PG_uptodate
comma
op_amp
id|page-&gt;flags
)paren
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
id|io_error
suffix:colon
r_if
c_cond
(paren
id|refresh
)paren
id|nfs_refresh_inode
c_func
(paren
id|inode
comma
op_amp
id|fattr
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|PG_locked
comma
op_amp
id|page-&gt;flags
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|page-&gt;wait
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * This is the function to (re-) transmit an NFS readahead request&n; */
r_static
r_int
DECL|function|nfsiod_read_setup
id|nfsiod_read_setup
c_func
(paren
r_struct
id|nfsiod_req
op_star
id|req
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|req-&gt;rq_inode
suffix:semicolon
r_struct
id|page
op_star
id|page
op_assign
id|req-&gt;rq_page
suffix:semicolon
r_return
id|nfs_proc_read_request
c_func
(paren
op_amp
id|req-&gt;rq_rpcreq
comma
id|NFS_SERVER
c_func
(paren
id|inode
)paren
comma
id|NFS_FH
c_func
(paren
id|inode
)paren
comma
id|page-&gt;offset
comma
id|PAGE_SIZE
comma
(paren
id|__u32
op_star
)paren
id|page_address
c_func
(paren
id|page
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This is the callback from nfsiod telling us whether a reply was&n; * received or some error occurred (timeout or socket shutdown).&n; */
r_static
r_int
DECL|function|nfsiod_read_result
id|nfsiod_read_result
c_func
(paren
r_int
id|result
comma
r_struct
id|nfsiod_req
op_star
id|req
)paren
(brace
r_struct
id|nfs_server
op_star
id|server
op_assign
id|NFS_SERVER
c_func
(paren
id|req-&gt;rq_inode
)paren
suffix:semicolon
r_struct
id|page
op_star
id|page
op_assign
id|req-&gt;rq_page
suffix:semicolon
r_static
r_int
id|succ
op_assign
l_int|0
comma
id|fail
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;BIO: received callback for page %p, result %d&bslash;n&quot;
comma
id|page
comma
id|result
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ge
l_int|0
)paren
(brace
r_struct
id|nfs_fattr
id|fattr
suffix:semicolon
id|result
op_assign
id|nfs_proc_read_reply
c_func
(paren
op_amp
id|req-&gt;rq_rpcreq
comma
op_amp
id|fattr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ge
l_int|0
)paren
(brace
id|nfs_refresh_inode
c_func
(paren
id|req-&gt;rq_inode
comma
op_amp
id|fattr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
id|PAGE_SIZE
)paren
id|memset
c_func
(paren
(paren
id|u8
op_star
)paren
id|page_address
c_func
(paren
id|page
)paren
op_plus
id|result
comma
l_int|0
comma
id|PAGE_SIZE
op_minus
id|result
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|result
op_eq
op_minus
id|ETIMEDOUT
op_logical_and
op_logical_neg
(paren
id|server-&gt;flags
op_amp
id|NFS_MOUNT_SOFT
)paren
)paren
(brace
multiline_comment|/* XXX: Theoretically, we&squot;d have to increment the initial&n;&t;&t; * timeo here; but I&squot;m not going to bother with this now&n;&t;&t; * because this old nfsiod stuff will soon die anyway.&n;&t;&t; */
id|result
op_assign
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|result
op_eq
op_minus
id|EAGAIN
op_logical_and
id|req-&gt;rq_retries
op_decrement
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;BIO: retransmitting request.&bslash;n&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|req-&gt;rq_rpcreq
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|rpc_ioreq
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|rpc_reserve
c_func
(paren
id|server-&gt;rsock
comma
op_amp
id|req-&gt;rq_rpcreq
comma
l_int|1
)paren
OL
l_int|0
)paren
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|current-&gt;fsuid
op_assign
id|req-&gt;rq_fsuid
suffix:semicolon
id|current-&gt;fsgid
op_assign
id|req-&gt;rq_fsgid
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NGROUPS
suffix:semicolon
id|i
op_increment
)paren
id|current-&gt;groups
(braket
id|i
)braket
op_assign
id|req-&gt;rq_groups
(braket
id|i
)braket
suffix:semicolon
id|nfsiod_read_setup
c_func
(paren
id|req
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|result
op_ge
l_int|0
)paren
(brace
id|set_bit
c_func
(paren
id|PG_uptodate
comma
op_amp
id|page-&gt;flags
)paren
suffix:semicolon
id|succ
op_increment
suffix:semicolon
)brace
r_else
(brace
id|dprintk
c_func
(paren
l_string|&quot;BIO: %d successful reads, %d failures&bslash;n&quot;
comma
id|succ
comma
id|fail
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|PG_error
comma
op_amp
id|page-&gt;flags
)paren
suffix:semicolon
id|fail
op_increment
suffix:semicolon
)brace
id|clear_bit
c_func
(paren
id|PG_locked
comma
op_amp
id|page-&gt;flags
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|page-&gt;wait
)paren
suffix:semicolon
id|free_page
c_func
(paren
id|page_address
c_func
(paren
id|page
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|do_read_nfs_async
id|do_read_nfs_async
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|page
op_star
id|page
)paren
(brace
r_struct
id|nfsiod_req
op_star
id|req
suffix:semicolon
r_int
id|result
comma
id|i
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;NFS: do_read_nfs_async(%p)&bslash;n&quot;
comma
id|page
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|PG_locked
comma
op_amp
id|page-&gt;flags
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|PG_error
comma
op_amp
id|page-&gt;flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|nfsiod_reserve
c_func
(paren
id|NFS_SERVER
c_func
(paren
id|inode
)paren
)paren
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|req-&gt;rq_retries
op_assign
l_int|5
suffix:semicolon
id|req-&gt;rq_callback
op_assign
id|nfsiod_read_result
suffix:semicolon
id|req-&gt;rq_inode
op_assign
id|inode
suffix:semicolon
id|req-&gt;rq_page
op_assign
id|page
suffix:semicolon
id|req-&gt;rq_fsuid
op_assign
id|current-&gt;fsuid
suffix:semicolon
id|req-&gt;rq_fsgid
op_assign
id|current-&gt;fsgid
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NGROUPS
suffix:semicolon
id|i
op_increment
)paren
id|req-&gt;rq_groups
(braket
id|i
)braket
op_assign
id|current-&gt;groups
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|nfsiod_read_setup
c_func
(paren
id|req
)paren
)paren
op_ge
l_int|0
)paren
(brace
id|page-&gt;count
op_increment
suffix:semicolon
id|nfsiod_enqueue
c_func
(paren
id|req
)paren
suffix:semicolon
)brace
r_else
(brace
id|dprintk
c_func
(paren
l_string|&quot;NFS: deferring async READ request.&bslash;n&quot;
)paren
suffix:semicolon
id|nfsiod_release
c_func
(paren
id|req
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|PG_locked
comma
op_amp
id|page-&gt;flags
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|page-&gt;wait
)paren
suffix:semicolon
)brace
r_return
id|result
OL
l_int|0
ques
c_cond
id|result
suffix:colon
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|nfs_readpage
id|nfs_readpage
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|page
op_star
id|page
)paren
(brace
r_int
r_int
id|address
suffix:semicolon
r_int
id|error
op_assign
op_minus
l_int|1
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;NFS: nfs_readpage %08lx&bslash;n&quot;
comma
id|page_address
c_func
(paren
id|page
)paren
)paren
suffix:semicolon
id|address
op_assign
id|page_address
c_func
(paren
id|page
)paren
suffix:semicolon
id|page-&gt;count
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|PageError
c_func
(paren
id|page
)paren
op_logical_and
id|NFS_SERVER
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|rsize
op_ge
id|PAGE_SIZE
)paren
id|error
op_assign
id|do_read_nfs_async
c_func
(paren
id|inode
comma
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
multiline_comment|/* couldn&squot;t enqueue */
id|error
op_assign
id|do_read_nfs_sync
c_func
(paren
id|inode
comma
id|page
)paren
suffix:semicolon
id|free_page
c_func
(paren
id|address
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
eof
