multiline_comment|/*&n; *  linux/fs/nfs/rpcsock.c&n; *&n; *  This is a generic RPC call interface for datagram sockets that is able&n; *  to place several concurrent RPC requests at the same time. It works like&n; *  this:&n; *&n; *  -&t;When a process places a call, it allocates a request slot if&n; *&t;one is available. Otherwise, it sleeps on the backlog queue&n; *&t;(rpc_reserve).&n; *  -&t;Then, the message is transmitted via rpc_send (exported by name of&n; *&t;rpc_transmit).&n; *  -&t;Finally, the process waits for the call to complete (rpc_doio):&n; *&t;The first process on the receive queue waits for the next RPC packet,&n; *&t;and peeks at the XID. If it finds a matching request, it receives&n; *&t;the datagram on behalf of that process and wakes it up. Otherwise,&n; *&t;the datagram is discarded.&n; *  -&t;If the process having received the datagram was the first one on&n; *&t;the receive queue, it wakes up the next one to listen for replies.&n; *  -&t;It then removes itself from the request queue (rpc_release).&n; *&t;If there are more callers waiting on the backlog queue, they are&n; *&t;woken up, too.&n; *&n; * Mar 1996:&n; *  -&t;Split up large functions into smaller chunks as per Linus&squot; coding&n; *&t;style. Found an interesting bug this way, too.&n; *  -&t;Added entry points for nfsiod.&n; *&n; *  Copyright (C) 1995, 1996, Olaf Kirch &lt;okir@monad.swb.de&gt;&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/nfs_fs.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/rpcsock.h&gt;
macro_line|#include &lt;linux/udp.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
DECL|macro|msleep
mdefine_line|#define msleep(sec)&t;{ current-&gt;timeout = sec * HZ / 1000; &bslash;&n;&t;&t;&t;  current-&gt;state = TASK_INTERRUPTIBLE; &bslash;&n;&t;&t;&t;  schedule(); &bslash;&n;&t;&t;&t;}
DECL|macro|DEBUG_RPC
macro_line|#undef DEBUG_RPC
macro_line|#ifdef DEBUG_RPC&t;&t;&t;
DECL|macro|dprintk
mdefine_line|#define dprintk(args...)&t;printk(## args)
macro_line|#else
DECL|macro|dprintk
mdefine_line|#define&t;dprintk(args...)
macro_line|#endif
multiline_comment|/*&n; * Insert new request into wait list. We make sure list is sorted by&n; * increasing timeout value.&n; */
r_static
r_inline
r_void
DECL|function|rpc_insque
id|rpc_insque
c_func
(paren
r_struct
id|rpc_sock
op_star
id|rsock
comma
r_struct
id|rpc_wait
op_star
id|slot
)paren
(brace
r_struct
id|rpc_wait
op_star
id|next
op_assign
id|rsock-&gt;pending
suffix:semicolon
id|slot-&gt;w_next
op_assign
id|next
suffix:semicolon
id|slot-&gt;w_prev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|next
)paren
id|next-&gt;w_prev
op_assign
id|slot
suffix:semicolon
id|rsock-&gt;pending
op_assign
id|slot
suffix:semicolon
id|slot-&gt;w_queued
op_assign
l_int|1
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;RPC: inserted %p into queue&bslash;n&quot;
comma
id|slot
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Remove request from request queue&n; */
r_static
r_inline
r_void
DECL|function|rpc_remque
id|rpc_remque
c_func
(paren
r_struct
id|rpc_sock
op_star
id|rsock
comma
r_struct
id|rpc_wait
op_star
id|slot
)paren
(brace
r_struct
id|rpc_wait
op_star
id|prev
op_assign
id|slot-&gt;w_prev
comma
op_star
id|next
op_assign
id|slot-&gt;w_next
suffix:semicolon
r_if
c_cond
(paren
id|prev
op_ne
l_int|NULL
)paren
id|prev-&gt;w_next
op_assign
id|next
suffix:semicolon
r_else
id|rsock-&gt;pending
op_assign
id|next
suffix:semicolon
r_if
c_cond
(paren
id|next
op_ne
l_int|NULL
)paren
id|next-&gt;w_prev
op_assign
id|prev
suffix:semicolon
id|slot-&gt;w_queued
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;RPC: removed %p from queue, head now %p.&bslash;n&quot;
comma
id|slot
comma
id|rsock-&gt;pending
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Write data to socket.&n; */
r_static
r_inline
r_int
DECL|function|rpc_sendmsg
id|rpc_sendmsg
c_func
(paren
r_struct
id|rpc_sock
op_star
id|rsock
comma
r_struct
id|iovec
op_star
id|iov
comma
r_int
id|nr
comma
r_int
id|len
comma
r_struct
id|sockaddr
op_star
id|sap
comma
r_int
id|salen
)paren
(brace
r_struct
id|socket
op_star
id|sock
op_assign
id|rsock-&gt;sock
suffix:semicolon
r_struct
id|msghdr
id|msg
suffix:semicolon
r_int
r_int
id|oldfs
suffix:semicolon
r_int
id|result
suffix:semicolon
id|msg.msg_iov
op_assign
id|iov
suffix:semicolon
id|msg.msg_iovlen
op_assign
id|nr
suffix:semicolon
id|msg.msg_name
op_assign
id|sap
suffix:semicolon
id|msg.msg_namelen
op_assign
id|salen
suffix:semicolon
id|msg.msg_accrights
op_assign
l_int|NULL
suffix:semicolon
id|oldfs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
id|result
op_assign
id|sock-&gt;ops
op_member_access_from_pointer
id|sendmsg
c_func
(paren
id|sock
comma
op_amp
id|msg
comma
id|len
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|oldfs
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;RPC: rpc_sendmsg(iov %p, len %d) = %d&bslash;n&quot;
comma
id|iov
comma
id|len
comma
id|result
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * Read data from socket&n; */
r_static
r_inline
r_int
DECL|function|rpc_recvmsg
id|rpc_recvmsg
c_func
(paren
r_struct
id|rpc_sock
op_star
id|rsock
comma
r_struct
id|iovec
op_star
id|iov
comma
r_int
id|nr
comma
r_int
id|len
comma
r_int
id|flags
)paren
(brace
r_struct
id|socket
op_star
id|sock
op_assign
id|rsock-&gt;sock
suffix:semicolon
r_struct
id|sockaddr
id|sa
suffix:semicolon
r_struct
id|msghdr
id|msg
suffix:semicolon
r_int
r_int
id|oldfs
suffix:semicolon
r_int
id|result
comma
id|alen
suffix:semicolon
id|msg.msg_iov
op_assign
id|iov
suffix:semicolon
id|msg.msg_iovlen
op_assign
id|nr
suffix:semicolon
id|msg.msg_name
op_assign
op_amp
id|sa
suffix:semicolon
id|msg.msg_namelen
op_assign
r_sizeof
(paren
id|sa
)paren
suffix:semicolon
id|msg.msg_accrights
op_assign
l_int|NULL
suffix:semicolon
id|oldfs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
id|result
op_assign
id|sock-&gt;ops
op_member_access_from_pointer
id|recvmsg
c_func
(paren
id|sock
comma
op_amp
id|msg
comma
id|len
comma
l_int|1
comma
id|flags
comma
op_amp
id|alen
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|oldfs
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;RPC: rpc_recvmsg(iov %p, len %d) = %d&bslash;n&quot;
comma
id|iov
comma
id|len
comma
id|result
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * This code is slightly complicated. Since the networking code does not&n; * honor the current-&gt;timeout value, we have to select on the socket.&n; */
r_static
r_inline
r_int
DECL|function|rpc_select
id|rpc_select
c_func
(paren
r_struct
id|rpc_sock
op_star
id|rsock
)paren
(brace
r_struct
id|select_table_entry
id|entry
suffix:semicolon
r_struct
id|file
op_star
id|file
op_assign
id|rsock-&gt;file
suffix:semicolon
id|select_table
id|wait_table
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;RPC: selecting on socket...&bslash;n&quot;
)paren
suffix:semicolon
id|wait_table.nr
op_assign
l_int|0
suffix:semicolon
id|wait_table.entry
op_assign
op_amp
id|entry
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|file-&gt;f_op
op_member_access_from_pointer
id|select
c_func
(paren
id|file-&gt;f_inode
comma
id|file
comma
id|SEL_IN
comma
op_amp
id|wait_table
)paren
op_logical_and
op_logical_neg
id|file-&gt;f_op
op_member_access_from_pointer
id|select
c_func
(paren
id|file-&gt;f_inode
comma
id|file
comma
id|SEL_IN
comma
l_int|NULL
)paren
)paren
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
id|entry.wait_address
comma
op_amp
id|entry.wait
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;signal
op_amp
op_complement
id|current-&gt;blocked
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;timeout
op_eq
l_int|0
)paren
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|wait_table.nr
)paren
id|remove_wait_queue
c_func
(paren
id|entry.wait_address
comma
op_amp
id|entry.wait
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;RPC: ...Okay, there appears to be some data.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Reserve an RPC call slot. nocwait determines whether we wait in case&n; * of congestion or not.&n; */
r_int
DECL|function|rpc_reserve
id|rpc_reserve
c_func
(paren
r_struct
id|rpc_sock
op_star
id|rsock
comma
r_struct
id|rpc_ioreq
op_star
id|req
comma
r_int
id|nocwait
)paren
(brace
r_struct
id|rpc_wait
op_star
id|slot
suffix:semicolon
id|req-&gt;rq_slot
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|slot
op_assign
id|rsock-&gt;free
)paren
op_logical_or
id|rsock-&gt;cong
op_ge
id|rsock-&gt;cwnd
)paren
(brace
r_if
c_cond
(paren
id|nocwait
)paren
(brace
id|current-&gt;timeout
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_string|&quot;RPC: rpc_reserve waiting on backlog&bslash;n&quot;
)paren
suffix:semicolon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|rsock-&gt;backlog
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;timeout
op_eq
l_int|0
)paren
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;signal
op_amp
op_complement
id|current-&gt;blocked
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
r_if
c_cond
(paren
id|rsock-&gt;shutdown
)paren
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|rsock-&gt;free
op_assign
id|slot-&gt;w_next
suffix:semicolon
id|rsock-&gt;cong
op_add_assign
id|RPC_CWNDSCALE
suffix:semicolon
multiline_comment|/* bump congestion value */
id|slot-&gt;w_queued
op_assign
l_int|0
suffix:semicolon
id|slot-&gt;w_gotit
op_assign
l_int|0
suffix:semicolon
id|slot-&gt;w_req
op_assign
id|req
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;RPC: reserved slot %p&bslash;n&quot;
comma
id|slot
)paren
suffix:semicolon
id|req-&gt;rq_slot
op_assign
id|slot
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Release an RPC call slot&n; */
r_void
DECL|function|rpc_release
id|rpc_release
c_func
(paren
r_struct
id|rpc_sock
op_star
id|rsock
comma
r_struct
id|rpc_ioreq
op_star
id|req
)paren
(brace
r_struct
id|rpc_wait
op_star
id|slot
op_assign
id|req-&gt;rq_slot
suffix:semicolon
r_if
c_cond
(paren
id|slot
op_ne
l_int|NULL
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;RPC: release slot %p&bslash;n&quot;
comma
id|slot
)paren
suffix:semicolon
multiline_comment|/* Wake up the next receiver */
r_if
c_cond
(paren
id|slot
op_eq
id|rsock-&gt;pending
op_logical_and
id|slot-&gt;w_next
op_ne
l_int|NULL
)paren
id|wake_up
c_func
(paren
op_amp
id|slot-&gt;w_next-&gt;w_wait
)paren
suffix:semicolon
multiline_comment|/* remove slot from queue of pending */
r_if
c_cond
(paren
id|slot-&gt;w_queued
)paren
id|rpc_remque
c_func
(paren
id|rsock
comma
id|slot
)paren
suffix:semicolon
id|slot-&gt;w_next
op_assign
id|rsock-&gt;free
suffix:semicolon
id|rsock-&gt;free
op_assign
id|slot
suffix:semicolon
multiline_comment|/* decrease congestion value */
id|rsock-&gt;cong
op_sub_assign
id|RPC_CWNDSCALE
suffix:semicolon
r_if
c_cond
(paren
id|rsock-&gt;cong
OL
id|rsock-&gt;cwnd
op_logical_and
id|rsock-&gt;backlog
)paren
id|wake_up
c_func
(paren
op_amp
id|rsock-&gt;backlog
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rsock-&gt;shutdown
)paren
id|wake_up
c_func
(paren
op_amp
id|rsock-&gt;shutwait
)paren
suffix:semicolon
id|req-&gt;rq_slot
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Adjust RPC congestion window&n; */
r_static
r_void
DECL|function|rpc_cwnd_adjust
id|rpc_cwnd_adjust
c_func
(paren
r_struct
id|rpc_sock
op_star
id|rsock
comma
r_int
id|timeout
)paren
(brace
r_int
r_int
id|cwnd
op_assign
id|rsock-&gt;cwnd
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timeout
)paren
(brace
r_if
c_cond
(paren
id|rsock-&gt;cong
op_ge
id|cwnd
)paren
(brace
multiline_comment|/* The (cwnd &gt;&gt; 1) term makes sure&n;&t;&t;&t; * the result gets rounded properly. */
id|cwnd
op_add_assign
(paren
id|RPC_CWNDSCALE
op_star
id|RPC_CWNDSCALE
op_plus
(paren
id|cwnd
op_rshift
l_int|1
)paren
)paren
op_div
id|cwnd
suffix:semicolon
r_if
c_cond
(paren
id|cwnd
OG
id|RPC_MAXCWND
)paren
id|cwnd
op_assign
id|RPC_MAXCWND
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|cwnd
op_rshift_assign
l_int|1
)paren
OL
id|RPC_CWNDSCALE
)paren
id|cwnd
op_assign
id|RPC_CWNDSCALE
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;RPC: cwnd decrease %08lx&bslash;n&quot;
comma
id|cwnd
)paren
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_string|&quot;RPC: cong %08lx, cwnd was %08lx, now %08lx&bslash;n&quot;
comma
id|rsock-&gt;cong
comma
id|rsock-&gt;cwnd
comma
id|cwnd
)paren
suffix:semicolon
id|rsock-&gt;cwnd
op_assign
id|cwnd
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|rpc_send_check
id|rpc_send_check
c_func
(paren
r_char
op_star
id|where
comma
id|u32
op_star
id|ptr
)paren
(brace
r_if
c_cond
(paren
id|ptr
(braket
l_int|1
)braket
op_ne
l_int|0
op_logical_or
id|ptr
(braket
l_int|2
)braket
op_ne
id|htonl
c_func
(paren
l_int|2
)paren
op_logical_or
id|ptr
(braket
l_int|3
)braket
op_ne
id|htonl
c_func
(paren
l_int|100003
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;RPC: %s sending evil packet:&bslash;n&quot;
l_string|&quot;     %08x %08x %08x %08x %08x %08x %08x %08x&bslash;n&quot;
comma
id|where
comma
id|ptr
(braket
l_int|0
)braket
comma
id|ptr
(braket
l_int|1
)braket
comma
id|ptr
(braket
l_int|2
)braket
comma
id|ptr
(braket
l_int|3
)braket
comma
id|ptr
(braket
l_int|4
)braket
comma
id|ptr
(braket
l_int|5
)braket
comma
id|ptr
(braket
l_int|6
)braket
comma
id|ptr
(braket
l_int|7
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Place the actual RPC call.&n; * We have to copy the iovec because sendmsg fiddles with its contents.&n; */
r_static
r_inline
r_int
DECL|function|rpc_send
id|rpc_send
c_func
(paren
r_struct
id|rpc_sock
op_star
id|rsock
comma
r_struct
id|rpc_wait
op_star
id|slot
)paren
(brace
r_struct
id|rpc_ioreq
op_star
id|req
op_assign
id|slot-&gt;w_req
suffix:semicolon
r_struct
id|iovec
id|iov
(braket
id|MAX_IOVEC
)braket
suffix:semicolon
r_if
c_cond
(paren
id|rsock-&gt;shutdown
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|memcpy
c_func
(paren
id|iov
comma
id|req-&gt;rq_svec
comma
id|req-&gt;rq_snr
op_star
r_sizeof
(paren
id|iov
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|slot-&gt;w_xid
op_assign
op_star
(paren
id|u32
op_star
)paren
(paren
id|iov
(braket
l_int|0
)braket
dot
id|iov_base
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slot-&gt;w_queued
)paren
id|rpc_insque
c_func
(paren
id|rsock
comma
id|slot
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;rpc_send(%p, %x)&bslash;n&quot;
comma
id|slot
comma
id|slot-&gt;w_xid
)paren
suffix:semicolon
id|rpc_send_check
c_func
(paren
l_string|&quot;rpc_send&quot;
comma
(paren
id|u32
op_star
)paren
id|req-&gt;rq_svec
(braket
l_int|0
)braket
dot
id|iov_base
)paren
suffix:semicolon
r_return
id|rpc_sendmsg
c_func
(paren
id|rsock
comma
id|iov
comma
id|req-&gt;rq_snr
comma
id|req-&gt;rq_slen
comma
id|req-&gt;rq_addr
comma
id|req-&gt;rq_alen
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This is the same as rpc_send but for the functions exported to nfsiod&n; */
r_int
DECL|function|rpc_transmit
id|rpc_transmit
c_func
(paren
r_struct
id|rpc_sock
op_star
id|rsock
comma
r_struct
id|rpc_ioreq
op_star
id|req
)paren
(brace
id|rpc_send_check
c_func
(paren
l_string|&quot;rpc_transmit&quot;
comma
(paren
id|u32
op_star
)paren
id|req-&gt;rq_svec
(braket
l_int|0
)braket
dot
id|iov_base
)paren
suffix:semicolon
r_return
id|rpc_send
c_func
(paren
id|rsock
comma
id|req-&gt;rq_slot
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Receive and dispatch a single reply&n; */
r_static
r_inline
r_int
DECL|function|rpc_grok
id|rpc_grok
c_func
(paren
r_struct
id|rpc_sock
op_star
id|rsock
)paren
(brace
r_struct
id|rpc_wait
op_star
id|rovr
suffix:semicolon
r_struct
id|rpc_ioreq
op_star
id|req
suffix:semicolon
r_struct
id|iovec
id|iov
(braket
id|MAX_IOVEC
)braket
suffix:semicolon
id|u32
id|xid
suffix:semicolon
r_int
id|safe
comma
id|result
suffix:semicolon
id|iov
(braket
l_int|0
)braket
dot
id|iov_base
op_assign
(paren
r_void
op_star
)paren
op_amp
id|xid
suffix:semicolon
id|iov
(braket
l_int|0
)braket
dot
id|iov_len
op_assign
r_sizeof
(paren
id|xid
)paren
suffix:semicolon
id|result
op_assign
id|rpc_recvmsg
c_func
(paren
id|rsock
comma
id|iov
comma
l_int|1
comma
r_sizeof
(paren
id|xid
)paren
comma
id|MSG_PEEK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
r_switch
c_cond
(paren
op_minus
id|result
)paren
(brace
r_case
id|EAGAIN
suffix:colon
r_case
id|ECONNREFUSED
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|ERESTARTSYS
suffix:colon
r_return
id|result
suffix:semicolon
r_default
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;rpc_grok: recv error = %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|result
OL
l_int|4
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;RPC: impossible RPC reply size %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_string|&quot;RPC: rpc_grok: got xid %08lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|xid
)paren
suffix:semicolon
multiline_comment|/* Look for the caller */
id|safe
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|rovr
op_assign
id|rsock-&gt;pending
suffix:semicolon
id|rovr
suffix:semicolon
id|rovr
op_assign
id|rovr-&gt;w_next
)paren
(brace
r_if
c_cond
(paren
id|rovr-&gt;w_xid
op_eq
id|xid
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|safe
op_increment
OG
id|RPC_MAXREQS
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;RPC: loop in request Q!!&bslash;n&quot;
)paren
suffix:semicolon
id|rovr
op_assign
l_int|NULL
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|rovr
op_logical_or
id|rovr-&gt;w_gotit
)paren
(brace
multiline_comment|/* discard dgram */
id|dprintk
c_func
(paren
l_string|&quot;RPC: rpc_grok: %s.&bslash;n&quot;
comma
id|rovr
ques
c_cond
l_string|&quot;duplicate reply&quot;
suffix:colon
l_string|&quot;bad XID&quot;
)paren
suffix:semicolon
id|iov
(braket
l_int|0
)braket
dot
id|iov_base
op_assign
(paren
r_void
op_star
)paren
op_amp
id|xid
suffix:semicolon
id|iov
(braket
l_int|0
)braket
dot
id|iov_len
op_assign
r_sizeof
(paren
id|xid
)paren
suffix:semicolon
id|rpc_recvmsg
c_func
(paren
id|rsock
comma
id|iov
comma
l_int|1
comma
r_sizeof
(paren
id|xid
)paren
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|req
op_assign
id|rovr-&gt;w_req
suffix:semicolon
multiline_comment|/* Now receive the reply... Copy the iovec first because of &n;&t; * memcpy_fromiovec fiddling. */
id|memcpy
c_func
(paren
id|iov
comma
id|req-&gt;rq_rvec
comma
id|req-&gt;rq_rnr
op_star
r_sizeof
(paren
id|iov
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|result
op_assign
id|rpc_recvmsg
c_func
(paren
id|rsock
comma
id|iov
comma
id|req-&gt;rq_rnr
comma
id|req-&gt;rq_rlen
comma
l_int|0
)paren
suffix:semicolon
id|rovr-&gt;w_result
op_assign
id|result
suffix:semicolon
id|rovr-&gt;w_gotit
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* ... and wake up the process */
id|wake_up
c_func
(paren
op_amp
id|rovr-&gt;w_wait
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * Wait for the reply to our call.&n; */
r_static
r_int
DECL|function|rpc_recv
id|rpc_recv
c_func
(paren
r_struct
id|rpc_sock
op_star
id|rsock
comma
r_struct
id|rpc_wait
op_star
id|slot
)paren
(brace
r_int
id|result
suffix:semicolon
r_do
(brace
multiline_comment|/* If we are not the receiver, wait on the sidelines */
id|dprintk
c_func
(paren
l_string|&quot;RPC: rpc_recv TP1&bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|rsock-&gt;pending
op_ne
id|slot
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|slot-&gt;w_gotit
)paren
id|interruptible_sleep_on
c_func
(paren
op_amp
id|slot-&gt;w_wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot-&gt;w_gotit
)paren
(brace
id|result
op_assign
id|slot-&gt;w_result
suffix:semicolon
multiline_comment|/* quite important */
r_return
id|result
suffix:semicolon
)brace
r_if
c_cond
(paren
id|current-&gt;signal
op_amp
op_complement
id|current-&gt;blocked
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
r_if
c_cond
(paren
id|rsock-&gt;shutdown
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;timeout
op_eq
l_int|0
)paren
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
multiline_comment|/* Wait for data to arrive */
r_if
c_cond
(paren
(paren
id|result
op_assign
id|rpc_select
c_func
(paren
id|rsock
)paren
)paren
OL
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;RPC: select error = %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Receive and dispatch */
r_if
c_cond
(paren
(paren
id|result
op_assign
id|rpc_grok
c_func
(paren
id|rsock
)paren
)paren
OL
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|current-&gt;timeout
op_logical_and
op_logical_neg
id|slot-&gt;w_gotit
)paren
suffix:semicolon
r_return
id|slot-&gt;w_gotit
ques
c_cond
id|result
suffix:colon
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
multiline_comment|/*&n; * Generic RPC call routine. This handles retries and timeouts etc pp.&n; *&n; * If sent is non-null, it assumes the called has already sent out the&n; * message, so it won&squot;t need to do so unless a timeout occurs.&n; */
r_int
DECL|function|rpc_doio
id|rpc_doio
c_func
(paren
r_struct
id|rpc_sock
op_star
id|rsock
comma
r_struct
id|rpc_ioreq
op_star
id|req
comma
r_struct
id|rpc_timeout
op_star
id|strategy
comma
r_int
id|sent
)paren
(brace
r_struct
id|rpc_wait
op_star
id|slot
suffix:semicolon
r_int
id|result
comma
id|retries
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
id|timeout
op_assign
id|strategy-&gt;to_initval
suffix:semicolon
id|retries
op_assign
l_int|0
suffix:semicolon
id|slot
op_assign
id|req-&gt;rq_slot
suffix:semicolon
r_do
(brace
id|dprintk
c_func
(paren
l_string|&quot;RPC: rpc_doio: TP1 (req %p)&bslash;n&quot;
comma
id|req
)paren
suffix:semicolon
id|current-&gt;timeout
op_assign
id|jiffies
op_plus
id|timeout
suffix:semicolon
r_if
c_cond
(paren
id|slot
op_eq
l_int|NULL
)paren
(brace
id|result
op_assign
id|rpc_reserve
c_func
(paren
id|rsock
comma
id|req
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
op_minus
id|ETIMEDOUT
)paren
r_goto
id|timedout
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_break
suffix:semicolon
id|slot
op_assign
id|req-&gt;rq_slot
suffix:semicolon
id|rpc_send_check
c_func
(paren
l_string|&quot;rpc_doio&quot;
comma
(paren
id|u32
op_star
)paren
id|req-&gt;rq_svec
(braket
l_int|0
)braket
dot
id|iov_base
)paren
suffix:semicolon
id|rpc_insque
c_func
(paren
id|rsock
comma
id|slot
)paren
suffix:semicolon
)brace
multiline_comment|/* This check is for loopback NFS. Sometimes replies come&n;&t;&t; * in before biod has called rpc_doio... */
r_if
c_cond
(paren
id|slot-&gt;w_gotit
)paren
(brace
id|result
op_assign
id|slot-&gt;w_result
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_string|&quot;RPC: rpc_doio: TP2&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sent
op_logical_or
(paren
id|result
op_assign
id|rpc_send
c_func
(paren
id|rsock
comma
id|slot
)paren
)paren
op_ge
l_int|0
)paren
(brace
id|result
op_assign
id|rpc_recv
c_func
(paren
id|rsock
comma
id|slot
)paren
suffix:semicolon
id|sent
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|result
op_ne
op_minus
id|ETIMEDOUT
)paren
(brace
multiline_comment|/* dprintk(&quot;RPC: rpc_recv returned %d&bslash;n&quot;, result); */
id|rpc_cwnd_adjust
c_func
(paren
id|rsock
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|rpc_cwnd_adjust
c_func
(paren
id|rsock
comma
l_int|1
)paren
suffix:semicolon
id|timedout
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;RPC: rpc_recv returned timeout.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strategy-&gt;to_exponential
)paren
id|timeout
op_lshift_assign
l_int|1
suffix:semicolon
r_else
id|timeout
op_add_assign
id|strategy-&gt;to_increment
suffix:semicolon
r_if
c_cond
(paren
id|strategy-&gt;to_maxval
op_logical_and
id|timeout
op_ge
id|strategy-&gt;to_maxval
)paren
id|timeout
op_assign
id|strategy-&gt;to_maxval
suffix:semicolon
r_if
c_cond
(paren
id|strategy-&gt;to_retries
op_logical_and
op_increment
id|retries
op_ge
id|strategy-&gt;to_retries
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;RPC: rpc_doio: TP3&bslash;n&quot;
)paren
suffix:semicolon
id|current-&gt;timeout
op_assign
l_int|0
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; */
r_int
DECL|function|rpc_call
id|rpc_call
c_func
(paren
r_struct
id|rpc_sock
op_star
id|rsock
comma
r_struct
id|rpc_ioreq
op_star
id|req
comma
r_struct
id|rpc_timeout
op_star
id|strategy
)paren
(brace
r_int
id|result
suffix:semicolon
id|result
op_assign
id|rpc_doio
c_func
(paren
id|rsock
comma
id|req
comma
id|strategy
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;rq_slot
op_eq
l_int|NULL
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;RPC: bad: rq_slot == NULL&bslash;n&quot;
)paren
suffix:semicolon
id|rpc_release
c_func
(paren
id|rsock
comma
id|req
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_struct
id|rpc_sock
op_star
DECL|function|rpc_makesock
id|rpc_makesock
c_func
(paren
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|rpc_sock
op_star
id|rsock
suffix:semicolon
r_struct
id|socket
op_star
id|sock
suffix:semicolon
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_struct
id|rpc_wait
op_star
id|slot
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;RPC: make RPC socket...&bslash;n&quot;
)paren
suffix:semicolon
id|sock
op_assign
op_amp
id|file-&gt;f_inode-&gt;u.socket_i
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;type
op_ne
id|SOCK_DGRAM
op_logical_or
id|sock-&gt;ops-&gt;family
op_ne
id|AF_INET
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;RPC: only UDP sockets supported&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|sk
op_assign
(paren
r_struct
id|sock
op_star
)paren
id|sock-&gt;data
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rsock
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|rpc_sock
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|rsock
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|rsock
)paren
)paren
suffix:semicolon
multiline_comment|/* Nnnngh! */
id|rsock-&gt;sock
op_assign
id|sock
suffix:semicolon
id|rsock-&gt;inet
op_assign
id|sk
suffix:semicolon
id|rsock-&gt;file
op_assign
id|file
suffix:semicolon
id|rsock-&gt;cwnd
op_assign
id|RPC_INITCWND
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;RPC: slots %p, %p, ...&bslash;n&quot;
comma
id|rsock-&gt;waiting
comma
id|rsock-&gt;waiting
op_plus
l_int|1
)paren
suffix:semicolon
id|rsock-&gt;free
op_assign
id|rsock-&gt;waiting
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|slot
op_assign
id|rsock-&gt;waiting
suffix:semicolon
id|i
OL
id|RPC_MAXREQS
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
comma
id|slot
op_increment
)paren
id|slot-&gt;w_next
op_assign
id|slot
op_plus
l_int|1
suffix:semicolon
id|slot-&gt;w_next
op_assign
l_int|NULL
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;RPC: made socket %p&bslash;n&quot;
comma
id|rsock
)paren
suffix:semicolon
r_return
id|rsock
suffix:semicolon
)brace
r_int
DECL|function|rpc_closesock
id|rpc_closesock
c_func
(paren
r_struct
id|rpc_sock
op_star
id|rsock
)paren
(brace
r_int
r_int
id|t0
op_assign
id|jiffies
suffix:semicolon
id|rsock-&gt;shutdown
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|rsock-&gt;pending
op_logical_or
id|rsock-&gt;backlog
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|rsock-&gt;shutwait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;signal
op_amp
op_complement
id|current-&gt;blocked
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
macro_line|#if 1
r_if
c_cond
(paren
id|t0
op_logical_and
id|t0
op_minus
id|jiffies
OG
l_int|60
op_star
id|HZ
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;RPC: hanging in rpc_closesock.&bslash;n&quot;
)paren
suffix:semicolon
id|t0
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
)brace
id|kfree
c_func
(paren
id|rsock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
