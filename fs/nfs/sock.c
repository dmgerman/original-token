multiline_comment|/*&n; *  linux/fs/nfs/sock.c&n; *&n; *  Copyright (C) 1992, 1993  Rick Sladkey&n; *&n; *  low-level nfs remote procedure call interface&n; *&n; * FIXES&n; *&n; * 2/7/94 James Bottomley and Jon Peatfield DAMTP, Cambridge University&n; *&n; * An xid mismatch no longer causes the request to be trashed.&n; *&n; * Peter Eriksson - incorrect XID used to confuse Linux&n; * Florian La Roche - use the correct max size, if reading a packet and&n; *                    also verify, if the whole packet has been read...&n; *                    more checks should be done in proc.c...&n; *&n; */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/nfs_fs.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/rpcsock.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
multiline_comment|/* JEJB/JSP 2/7/94&n; * this must match the value of NFS_SLACK_SPACE in linux/fs/nfs/proc.c &n; * ***FIXME*** should probably put this in nfs_fs.h */
DECL|macro|NFS_SLACK_SPACE
mdefine_line|#define NFS_SLACK_SPACE 1024
DECL|macro|_S
mdefine_line|#define _S(nr) (1&lt;&lt;((nr)-1))
multiline_comment|/*&n; * We violate some modularity principles here by poking around&n; * in some socket internals.  Besides having to call socket&n; * functions from kernel-space instead of user space, the socket&n; * interface does not lend itself well to being cleanly called&n; * without a file descriptor.  Since the nfs calls can run on&n; * behalf of any process, the superblock maintains a file pointer&n; * to the server socket.&n; */
r_int
DECL|function|nfs_rpc_call
id|nfs_rpc_call
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
comma
r_int
op_star
id|start
comma
r_int
op_star
id|end
comma
r_int
id|size
)paren
(brace
r_struct
id|rpc_timeout
id|timeout
suffix:semicolon
r_int
r_int
id|maxtimeo
suffix:semicolon
r_int
r_int
id|oldmask
suffix:semicolon
r_int
id|major_timeout_seen
comma
id|result
suffix:semicolon
id|timeout.init_timeout
op_assign
id|server-&gt;timeo
suffix:semicolon
id|timeout.max_timeout
op_assign
id|maxtimeo
op_assign
id|NFS_MAX_RPC_TIMEOUT
op_star
id|HZ
op_div
l_int|10
suffix:semicolon
id|timeout.retries
op_assign
id|server-&gt;retrans
suffix:semicolon
id|timeout.exponential
op_assign
l_int|1
suffix:semicolon
id|oldmask
op_assign
id|current-&gt;blocked
suffix:semicolon
id|current-&gt;blocked
op_or_assign
op_complement
(paren
id|_S
c_func
(paren
id|SIGKILL
)paren
op_or
(paren
(paren
id|server-&gt;flags
op_amp
id|NFS_MOUNT_INTR
)paren
ques
c_cond
(paren
(paren
id|current-&gt;sig-&gt;action
(braket
id|SIGINT
op_minus
l_int|1
)braket
dot
id|sa_handler
op_eq
id|SIG_DFL
ques
c_cond
id|_S
c_func
(paren
id|SIGINT
)paren
suffix:colon
l_int|0
)paren
op_or
(paren
id|current-&gt;sig-&gt;action
(braket
id|SIGQUIT
op_minus
l_int|1
)braket
dot
id|sa_handler
op_eq
id|SIG_DFL
ques
c_cond
id|_S
c_func
(paren
id|SIGQUIT
)paren
suffix:colon
l_int|0
)paren
)paren
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
id|major_timeout_seen
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|result
op_assign
id|rpc_call
c_func
(paren
id|server-&gt;rsock
comma
op_amp
id|server-&gt;toaddr
comma
r_sizeof
(paren
id|server-&gt;toaddr
)paren
comma
id|start
comma
(paren
(paren
r_char
op_star
)paren
id|end
)paren
op_minus
(paren
(paren
r_char
op_star
)paren
id|start
)paren
comma
id|start
comma
id|size
op_plus
l_int|1024
comma
op_amp
id|timeout
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;signal
op_amp
op_complement
id|current-&gt;blocked
)paren
id|result
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
op_minus
id|ETIMEDOUT
)paren
(brace
r_if
c_cond
(paren
id|server-&gt;flags
op_amp
id|NFS_MOUNT_SOFT
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;NFS server %s not responding, &quot;
l_string|&quot;still trying.&bslash;n&quot;
comma
id|server-&gt;hostname
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|major_timeout_seen
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;NFS server %s not responding, &quot;
l_string|&quot;timed out.&bslash;n&quot;
comma
id|server-&gt;hostname
)paren
suffix:semicolon
id|major_timeout_seen
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|timeout.init_timeout
op_lshift_assign
l_int|1
)paren
op_ge
id|maxtimeo
)paren
id|timeout.init_timeout
op_assign
id|maxtimeo
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|result
OL
l_int|0
op_logical_and
id|result
op_ne
id|ERESTARTSYS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;NFS: notice message: result = %d.&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|result
op_eq
op_minus
id|ETIMEDOUT
op_logical_and
op_logical_neg
(paren
id|server-&gt;flags
op_amp
id|NFS_MOUNT_SOFT
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ge
l_int|0
op_logical_and
id|major_timeout_seen
)paren
id|printk
c_func
(paren
l_string|&quot;NFS server %s OK.&bslash;n&quot;
comma
id|server-&gt;hostname
)paren
suffix:semicolon
multiline_comment|/* 20 is the minimum RPC reply header size */
r_if
c_cond
(paren
id|result
op_ge
l_int|0
op_logical_and
id|result
OL
l_int|20
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;NFS: too small read memory size (%d bytes)&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
id|current-&gt;blocked
op_assign
id|oldmask
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
eof
