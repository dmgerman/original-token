multiline_comment|/*&n; *  linux/fs/nfs/sock.c&n; *&n; *  Copyright (C) 1992, 1993  Rick Sladkey&n; *&n; *  low-level nfs remote procedure call interface&n; *&n; * FIXES&n; *&n; * 2/7/94 James Bottomley and Jon Peatfield DAMTP, Cambridge University&n; *&n; * An xid mismatch no longer causes the request to be trashed.&n; *&n; * Peter Eriksson - incorrect XID used to confuse Linux&n; * Florian La Roche - use the correct max size, if reading a packet and&n; *                    also verify, if the whole packet has been read...&n; *                    more checks should be done in proc.c...&n; *&n; */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/nfs_fs.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/rpcsock.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
DECL|macro|_S
mdefine_line|#define _S(nr) (1&lt;&lt;((nr)-1))
multiline_comment|/*&n; * Place a synchronous call to the NFS server, meaning that the process&n; * sleeps in rpc_call until it either receives a reply or a major timeout&n; * occurs.&n; * This is now merely a front-end to nfs_rpc_doio.&n; */
r_int
DECL|function|nfs_rpc_call
id|nfs_rpc_call
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
comma
r_int
op_star
id|start
comma
r_int
op_star
id|end
comma
r_int
id|size
)paren
(brace
r_struct
id|rpc_ioreq
id|req
suffix:semicolon
id|size
op_add_assign
l_int|1024
suffix:semicolon
multiline_comment|/* account for NFS slack space. ugly */
id|req.rq_addr
op_assign
op_amp
id|server-&gt;toaddr
suffix:semicolon
id|req.rq_alen
op_assign
r_sizeof
(paren
id|server-&gt;toaddr
)paren
suffix:semicolon
id|req.rq_slot
op_assign
l_int|NULL
suffix:semicolon
id|req.rq_svec
(braket
l_int|0
)braket
dot
id|iov_base
op_assign
id|start
suffix:semicolon
id|req.rq_svec
(braket
l_int|0
)braket
dot
id|iov_len
op_assign
(paren
id|end
op_minus
id|start
)paren
op_lshift
l_int|2
suffix:semicolon
id|req.rq_slen
op_assign
(paren
id|end
op_minus
id|start
)paren
op_lshift
l_int|2
suffix:semicolon
id|req.rq_snr
op_assign
l_int|1
suffix:semicolon
id|req.rq_rvec
(braket
l_int|0
)braket
dot
id|iov_base
op_assign
id|start
suffix:semicolon
id|req.rq_rvec
(braket
l_int|0
)braket
dot
id|iov_len
op_assign
id|size
suffix:semicolon
id|req.rq_rlen
op_assign
id|size
suffix:semicolon
id|req.rq_rnr
op_assign
l_int|1
suffix:semicolon
r_return
id|nfs_rpc_doio
c_func
(paren
id|server
comma
op_amp
id|req
comma
l_int|0
)paren
suffix:semicolon
)brace
r_int
DECL|function|nfs_rpc_doio
id|nfs_rpc_doio
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
comma
r_struct
id|rpc_ioreq
op_star
id|req
comma
r_int
id|async
)paren
(brace
r_struct
id|rpc_timeout
id|timeout
suffix:semicolon
r_int
r_int
id|maxtimeo
suffix:semicolon
r_int
r_int
id|oldmask
suffix:semicolon
r_int
id|major_timeout_seen
comma
id|result
suffix:semicolon
id|timeout.to_initval
op_assign
id|server-&gt;timeo
suffix:semicolon
id|timeout.to_maxval
op_assign
id|NFS_MAX_RPC_TIMEOUT
op_star
id|HZ
op_div
l_int|10
suffix:semicolon
id|timeout.to_retries
op_assign
id|server-&gt;retrans
suffix:semicolon
id|timeout.to_exponential
op_assign
l_int|1
suffix:semicolon
id|oldmask
op_assign
id|current-&gt;blocked
suffix:semicolon
id|current-&gt;blocked
op_or_assign
op_complement
(paren
id|_S
c_func
(paren
id|SIGKILL
)paren
op_or
(paren
(paren
id|server-&gt;flags
op_amp
id|NFS_MOUNT_INTR
)paren
ques
c_cond
(paren
(paren
id|current-&gt;sig-&gt;action
(braket
id|SIGINT
op_minus
l_int|1
)braket
dot
id|sa_handler
op_eq
id|SIG_DFL
ques
c_cond
id|_S
c_func
(paren
id|SIGINT
)paren
suffix:colon
l_int|0
)paren
op_or
(paren
id|current-&gt;sig-&gt;action
(braket
id|SIGQUIT
op_minus
l_int|1
)braket
dot
id|sa_handler
op_eq
id|SIG_DFL
ques
c_cond
id|_S
c_func
(paren
id|SIGQUIT
)paren
suffix:colon
l_int|0
)paren
)paren
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
id|major_timeout_seen
op_assign
l_int|0
suffix:semicolon
id|maxtimeo
op_assign
id|timeout.to_maxval
suffix:semicolon
r_do
(brace
id|result
op_assign
id|rpc_doio
c_func
(paren
id|server-&gt;rsock
comma
id|req
comma
op_amp
id|timeout
comma
id|async
)paren
suffix:semicolon
id|rpc_release
c_func
(paren
id|server-&gt;rsock
comma
id|req
)paren
suffix:semicolon
multiline_comment|/* Release slot */
r_if
c_cond
(paren
id|current-&gt;signal
op_amp
op_complement
id|current-&gt;blocked
)paren
id|result
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
op_minus
id|ETIMEDOUT
)paren
(brace
r_if
c_cond
(paren
id|async
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;flags
op_amp
id|NFS_MOUNT_SOFT
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;NFS server %s not responding, &quot;
l_string|&quot;timed out.&bslash;n&quot;
comma
id|server-&gt;hostname
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|major_timeout_seen
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;NFS server %s not responding, &quot;
l_string|&quot;still trying.&bslash;n&quot;
comma
id|server-&gt;hostname
)paren
suffix:semicolon
id|major_timeout_seen
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|timeout.to_initval
op_lshift_assign
l_int|1
)paren
op_ge
id|maxtimeo
)paren
(brace
id|timeout.to_initval
op_assign
id|maxtimeo
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|result
OL
l_int|0
op_logical_and
id|result
op_ne
op_minus
id|ERESTARTSYS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;NFS: notice message: result = %d.&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|result
op_eq
op_minus
id|ETIMEDOUT
op_logical_and
op_logical_neg
(paren
id|server-&gt;flags
op_amp
id|NFS_MOUNT_SOFT
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ge
l_int|0
op_logical_and
id|major_timeout_seen
)paren
id|printk
c_func
(paren
l_string|&quot;NFS server %s OK.&bslash;n&quot;
comma
id|server-&gt;hostname
)paren
suffix:semicolon
multiline_comment|/* 20 is the minimum RPC reply header size */
r_if
c_cond
(paren
id|result
op_ge
l_int|0
op_logical_and
id|result
OL
l_int|20
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;NFS: too small read memory size (%d bytes)&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
id|current-&gt;blocked
op_assign
id|oldmask
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
eof
