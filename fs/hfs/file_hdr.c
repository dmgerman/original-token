multiline_comment|/*&n; * linux/fs/hfs/file_hdr.c&n; *&n; * Copyright (C) 1995-1997  Paul H. Hargrove&n; * This file may be distributed under the terms of the GNU Public License.&n; *&n; * This file contains the file_ops and inode_ops for the metadata&n; * files under the AppleDouble and Netatalk representations.&n; *&n; * The source code distributions of Netatalk, versions 1.3.3b2 and&n; * 1.4b2, were used as a specification of the location and format of&n; * files used by Netatalk&squot;s afpd.  No code from Netatalk appears in&n; * hfs_fs.  hfs_fs is not a work ``derived&squot;&squot; from Netatalk in the&n; * sense of intellectual property law.&n; *&n; * &quot;XXX&quot; in a comment is a note to myself to consider changing something.&n; *&n; * In function preconditions the term &quot;valid&quot; applied to a pointer to&n; * a structure means that the pointer is non-NULL and the structure it&n; * points to has all fields initialized to consistent values.&n; *&n; * XXX: Note the reason that there is not bmap() for AppleDouble&n; * header files is that dynamic nature of their structure make it&n; * very difficult to safely mmap them.  Maybe in the distant future&n; * I&squot;ll get bored enough to implement it.&n; */
macro_line|#include &quot;hfs.h&quot;
macro_line|#include &lt;linux/hfs_fs_sb.h&gt;
macro_line|#include &lt;linux/hfs_fs_i.h&gt;
macro_line|#include &lt;linux/hfs_fs.h&gt;
multiline_comment|/* prodos types */
DECL|macro|PRODOSI_FTYPE_DIR
mdefine_line|#define PRODOSI_FTYPE_DIR   0x0F
DECL|macro|PRODOSI_FTYPE_TEXT
mdefine_line|#define PRODOSI_FTYPE_TEXT  0x04
DECL|macro|PRODOSI_FTYPE_8BIT
mdefine_line|#define PRODOSI_FTYPE_8BIT  0xFF
DECL|macro|PRODOSI_FTYPE_16BIT
mdefine_line|#define PRODOSI_FTYPE_16BIT 0xB3
DECL|macro|PRODOSI_AUXTYPE_DIR
mdefine_line|#define PRODOSI_AUXTYPE_DIR 0x0200
multiline_comment|/*================ Forward declarations ================*/
r_static
id|hfs_rwret_t
id|hdr_read
c_func
(paren
r_struct
id|file
op_star
comma
r_char
op_star
comma
id|hfs_rwarg_t
comma
id|loff_t
op_star
)paren
suffix:semicolon
r_static
id|hfs_rwret_t
id|hdr_write
c_func
(paren
r_struct
id|file
op_star
comma
r_const
r_char
op_star
comma
id|hfs_rwarg_t
comma
id|loff_t
op_star
)paren
suffix:semicolon
multiline_comment|/*================ Global variables ================*/
DECL|variable|hfs_hdr_operations
r_struct
id|file_operations
id|hfs_hdr_operations
op_assign
(brace
id|read
suffix:colon
id|hdr_read
comma
id|write
suffix:colon
id|hdr_write
comma
id|fsync
suffix:colon
id|file_fsync
comma
)brace
suffix:semicolon
DECL|variable|hfs_hdr_inode_operations
r_struct
id|inode_operations
id|hfs_hdr_inode_operations
op_assign
(brace
id|setattr
suffix:colon
id|hfs_notify_change_hdr
comma
)brace
suffix:semicolon
DECL|variable|hfs_dbl_fil_hdr_layout
r_const
r_struct
id|hfs_hdr_layout
id|hfs_dbl_fil_hdr_layout
op_assign
(brace
id|__constant_htonl
c_func
(paren
id|HFS_DBL_MAGIC
)paren
comma
multiline_comment|/* magic   */
id|__constant_htonl
c_func
(paren
id|HFS_HDR_VERSION_2
)paren
comma
multiline_comment|/* version */
l_int|6
comma
multiline_comment|/* entries */
(brace
multiline_comment|/* descr[] */
(brace
id|HFS_HDR_FNAME
comma
m_offsetof
(paren
r_struct
id|hfs_dbl_hdr
comma
id|real_name
)paren
comma
op_complement
l_int|0
)brace
comma
(brace
id|HFS_HDR_DATES
comma
m_offsetof
(paren
r_struct
id|hfs_dbl_hdr
comma
id|create_time
)paren
comma
l_int|16
)brace
comma
(brace
id|HFS_HDR_FINFO
comma
m_offsetof
(paren
r_struct
id|hfs_dbl_hdr
comma
id|finderinfo
)paren
comma
l_int|32
)brace
comma
(brace
id|HFS_HDR_MACI
comma
m_offsetof
(paren
r_struct
id|hfs_dbl_hdr
comma
id|fileinfo
)paren
comma
l_int|4
)brace
comma
(brace
id|HFS_HDR_DID
comma
m_offsetof
(paren
r_struct
id|hfs_dbl_hdr
comma
id|cnid
)paren
comma
l_int|4
)brace
comma
(brace
id|HFS_HDR_RSRC
comma
id|HFS_DBL_HDR_LEN
comma
op_complement
l_int|0
)brace
)brace
comma
(brace
multiline_comment|/* order[] */
(paren
r_struct
id|hfs_hdr_descr
op_star
)paren
op_amp
id|hfs_dbl_fil_hdr_layout.descr
(braket
l_int|0
)braket
comma
(paren
r_struct
id|hfs_hdr_descr
op_star
)paren
op_amp
id|hfs_dbl_fil_hdr_layout.descr
(braket
l_int|1
)braket
comma
(paren
r_struct
id|hfs_hdr_descr
op_star
)paren
op_amp
id|hfs_dbl_fil_hdr_layout.descr
(braket
l_int|2
)braket
comma
(paren
r_struct
id|hfs_hdr_descr
op_star
)paren
op_amp
id|hfs_dbl_fil_hdr_layout.descr
(braket
l_int|3
)braket
comma
(paren
r_struct
id|hfs_hdr_descr
op_star
)paren
op_amp
id|hfs_dbl_fil_hdr_layout.descr
(braket
l_int|4
)braket
comma
(paren
r_struct
id|hfs_hdr_descr
op_star
)paren
op_amp
id|hfs_dbl_fil_hdr_layout.descr
(braket
l_int|5
)braket
)brace
)brace
suffix:semicolon
DECL|variable|hfs_dbl_dir_hdr_layout
r_const
r_struct
id|hfs_hdr_layout
id|hfs_dbl_dir_hdr_layout
op_assign
(brace
id|__constant_htonl
c_func
(paren
id|HFS_DBL_MAGIC
)paren
comma
multiline_comment|/* magic   */
id|__constant_htonl
c_func
(paren
id|HFS_HDR_VERSION_2
)paren
comma
multiline_comment|/* version */
l_int|5
comma
multiline_comment|/* entries */
(brace
multiline_comment|/* descr[] */
(brace
id|HFS_HDR_FNAME
comma
m_offsetof
(paren
r_struct
id|hfs_dbl_hdr
comma
id|real_name
)paren
comma
op_complement
l_int|0
)brace
comma
(brace
id|HFS_HDR_DATES
comma
m_offsetof
(paren
r_struct
id|hfs_dbl_hdr
comma
id|create_time
)paren
comma
l_int|16
)brace
comma
(brace
id|HFS_HDR_FINFO
comma
m_offsetof
(paren
r_struct
id|hfs_dbl_hdr
comma
id|finderinfo
)paren
comma
l_int|32
)brace
comma
(brace
id|HFS_HDR_MACI
comma
m_offsetof
(paren
r_struct
id|hfs_dbl_hdr
comma
id|fileinfo
)paren
comma
l_int|4
)brace
comma
(brace
id|HFS_HDR_DID
comma
m_offsetof
(paren
r_struct
id|hfs_dbl_hdr
comma
id|cnid
)paren
comma
l_int|4
)brace
)brace
comma
(brace
multiline_comment|/* order[] */
(paren
r_struct
id|hfs_hdr_descr
op_star
)paren
op_amp
id|hfs_dbl_dir_hdr_layout.descr
(braket
l_int|0
)braket
comma
(paren
r_struct
id|hfs_hdr_descr
op_star
)paren
op_amp
id|hfs_dbl_dir_hdr_layout.descr
(braket
l_int|1
)braket
comma
(paren
r_struct
id|hfs_hdr_descr
op_star
)paren
op_amp
id|hfs_dbl_dir_hdr_layout.descr
(braket
l_int|2
)braket
comma
(paren
r_struct
id|hfs_hdr_descr
op_star
)paren
op_amp
id|hfs_dbl_dir_hdr_layout.descr
(braket
l_int|3
)braket
comma
(paren
r_struct
id|hfs_hdr_descr
op_star
)paren
op_amp
id|hfs_dbl_dir_hdr_layout.descr
(braket
l_int|4
)braket
)brace
)brace
suffix:semicolon
DECL|variable|hfs_nat2_hdr_layout
r_const
r_struct
id|hfs_hdr_layout
id|hfs_nat2_hdr_layout
op_assign
(brace
id|__constant_htonl
c_func
(paren
id|HFS_DBL_MAGIC
)paren
comma
multiline_comment|/* magic   */
id|__constant_htonl
c_func
(paren
id|HFS_HDR_VERSION_2
)paren
comma
multiline_comment|/* version */
l_int|9
comma
multiline_comment|/* entries */
(brace
multiline_comment|/* descr[] */
(brace
id|HFS_HDR_FNAME
comma
m_offsetof
(paren
r_struct
id|hfs_dbl_hdr
comma
id|real_name
)paren
comma
op_complement
l_int|0
)brace
comma
(brace
id|HFS_HDR_COMNT
comma
m_offsetof
(paren
r_struct
id|hfs_dbl_hdr
comma
id|comment
)paren
comma
l_int|0
)brace
comma
(brace
id|HFS_HDR_DATES
comma
m_offsetof
(paren
r_struct
id|hfs_dbl_hdr
comma
id|create_time
)paren
comma
l_int|16
)brace
comma
(brace
id|HFS_HDR_FINFO
comma
m_offsetof
(paren
r_struct
id|hfs_dbl_hdr
comma
id|finderinfo
)paren
comma
l_int|32
)brace
comma
(brace
id|HFS_HDR_AFPI
comma
m_offsetof
(paren
r_struct
id|hfs_dbl_hdr
comma
id|fileinfo
)paren
comma
l_int|4
)brace
comma
(brace
id|HFS_HDR_DID
comma
m_offsetof
(paren
r_struct
id|hfs_dbl_hdr
comma
id|cnid
)paren
comma
l_int|4
)brace
comma
(brace
id|HFS_HDR_SNAME
comma
m_offsetof
(paren
r_struct
id|hfs_dbl_hdr
comma
id|short_name
)paren
comma
op_complement
l_int|0
)brace
comma
(brace
id|HFS_HDR_PRODOSI
comma
m_offsetof
(paren
r_struct
id|hfs_dbl_hdr
comma
id|prodosi
)paren
comma
l_int|8
)brace
comma
(brace
id|HFS_HDR_RSRC
comma
id|HFS_NAT_HDR_LEN
comma
op_complement
l_int|0
)brace
)brace
comma
(brace
multiline_comment|/* order[] */
(paren
r_struct
id|hfs_hdr_descr
op_star
)paren
op_amp
id|hfs_nat_hdr_layout.descr
(braket
l_int|0
)braket
comma
(paren
r_struct
id|hfs_hdr_descr
op_star
)paren
op_amp
id|hfs_nat_hdr_layout.descr
(braket
l_int|1
)braket
comma
(paren
r_struct
id|hfs_hdr_descr
op_star
)paren
op_amp
id|hfs_nat_hdr_layout.descr
(braket
l_int|2
)braket
comma
(paren
r_struct
id|hfs_hdr_descr
op_star
)paren
op_amp
id|hfs_nat_hdr_layout.descr
(braket
l_int|3
)braket
comma
(paren
r_struct
id|hfs_hdr_descr
op_star
)paren
op_amp
id|hfs_nat_hdr_layout.descr
(braket
l_int|4
)braket
comma
(paren
r_struct
id|hfs_hdr_descr
op_star
)paren
op_amp
id|hfs_nat_hdr_layout.descr
(braket
l_int|5
)braket
comma
(paren
r_struct
id|hfs_hdr_descr
op_star
)paren
op_amp
id|hfs_nat_hdr_layout.descr
(braket
l_int|6
)braket
comma
(paren
r_struct
id|hfs_hdr_descr
op_star
)paren
op_amp
id|hfs_nat_hdr_layout.descr
(braket
l_int|7
)braket
comma
(paren
r_struct
id|hfs_hdr_descr
op_star
)paren
op_amp
id|hfs_nat_hdr_layout.descr
(braket
l_int|8
)braket
)brace
)brace
suffix:semicolon
DECL|variable|hfs_nat_hdr_layout
r_const
r_struct
id|hfs_hdr_layout
id|hfs_nat_hdr_layout
op_assign
(brace
id|__constant_htonl
c_func
(paren
id|HFS_DBL_MAGIC
)paren
comma
multiline_comment|/* magic   */
id|__constant_htonl
c_func
(paren
id|HFS_HDR_VERSION_1
)paren
comma
multiline_comment|/* version */
l_int|5
comma
multiline_comment|/* entries */
(brace
multiline_comment|/* descr[] */
(brace
id|HFS_HDR_FNAME
comma
m_offsetof
(paren
r_struct
id|hfs_dbl_hdr
comma
id|real_name
)paren
comma
op_complement
l_int|0
)brace
comma
(brace
id|HFS_HDR_COMNT
comma
m_offsetof
(paren
r_struct
id|hfs_dbl_hdr
comma
id|comment
)paren
comma
l_int|0
)brace
comma
(brace
id|HFS_HDR_OLDI
comma
m_offsetof
(paren
r_struct
id|hfs_dbl_hdr
comma
id|create_time
)paren
comma
l_int|16
)brace
comma
(brace
id|HFS_HDR_FINFO
comma
m_offsetof
(paren
r_struct
id|hfs_dbl_hdr
comma
id|finderinfo
)paren
comma
l_int|32
)brace
comma
(brace
id|HFS_HDR_RSRC
comma
id|HFS_NAT_HDR_LEN
comma
op_complement
l_int|0
)brace
comma
)brace
comma
(brace
multiline_comment|/* order[] */
(paren
r_struct
id|hfs_hdr_descr
op_star
)paren
op_amp
id|hfs_nat_hdr_layout.descr
(braket
l_int|0
)braket
comma
(paren
r_struct
id|hfs_hdr_descr
op_star
)paren
op_amp
id|hfs_nat_hdr_layout.descr
(braket
l_int|1
)braket
comma
(paren
r_struct
id|hfs_hdr_descr
op_star
)paren
op_amp
id|hfs_nat_hdr_layout.descr
(braket
l_int|2
)braket
comma
(paren
r_struct
id|hfs_hdr_descr
op_star
)paren
op_amp
id|hfs_nat_hdr_layout.descr
(braket
l_int|3
)braket
comma
(paren
r_struct
id|hfs_hdr_descr
op_star
)paren
op_amp
id|hfs_nat_hdr_layout.descr
(braket
l_int|4
)braket
)brace
)brace
suffix:semicolon
multiline_comment|/*================ File-local variables ================*/
DECL|variable|fstype
r_static
r_const
r_char
id|fstype
(braket
l_int|16
)braket
op_assign
(brace
l_char|&squot;M&squot;
comma
l_char|&squot;a&squot;
comma
l_char|&squot;c&squot;
comma
l_char|&squot;i&squot;
comma
l_char|&squot;n&squot;
comma
l_char|&squot;t&squot;
comma
l_char|&squot;o&squot;
comma
l_char|&squot;s&squot;
comma
l_char|&squot;h&squot;
comma
l_char|&squot; &squot;
comma
l_char|&squot; &squot;
comma
l_char|&squot; &squot;
comma
l_char|&squot; &squot;
comma
l_char|&squot; &squot;
comma
l_char|&squot; &squot;
comma
l_char|&squot; &squot;
)brace
suffix:semicolon
multiline_comment|/*================ File-local data types ================*/
DECL|struct|hdr_hdr
r_struct
id|hdr_hdr
(brace
DECL|member|magic
id|hfs_lword_t
id|magic
suffix:semicolon
DECL|member|version
id|hfs_lword_t
id|version
suffix:semicolon
DECL|member|filler
id|hfs_byte_t
id|filler
(braket
l_int|16
)braket
suffix:semicolon
DECL|member|entries
id|hfs_word_t
id|entries
suffix:semicolon
DECL|member|descrs
id|hfs_byte_t
id|descrs
(braket
l_int|12
op_star
id|HFS_HDR_MAX
)braket
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
multiline_comment|/*================ File-local functions ================*/
multiline_comment|/*&n; * dlength()&n; */
DECL|function|dlength
r_static
r_int
id|dlength
c_func
(paren
r_const
r_struct
id|hfs_hdr_descr
op_star
id|descr
comma
r_const
r_struct
id|hfs_cat_entry
op_star
id|entry
)paren
(brace
id|hfs_u32
id|length
op_assign
id|descr-&gt;length
suffix:semicolon
multiline_comment|/* handle auto-sized entries */
r_if
c_cond
(paren
id|length
op_eq
op_complement
l_int|0
)paren
(brace
r_switch
c_cond
(paren
id|descr-&gt;id
)paren
(brace
r_case
id|HFS_HDR_DATA
suffix:colon
r_if
c_cond
(paren
id|entry-&gt;type
op_eq
id|HFS_CDR_FIL
)paren
(brace
id|length
op_assign
id|entry-&gt;u.file.data_fork.lsize
suffix:semicolon
)brace
r_else
(brace
id|length
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|HFS_HDR_RSRC
suffix:colon
r_if
c_cond
(paren
id|entry-&gt;type
op_eq
id|HFS_CDR_FIL
)paren
(brace
id|length
op_assign
id|entry-&gt;u.file.rsrc_fork.lsize
suffix:semicolon
)brace
r_else
(brace
id|length
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|HFS_HDR_FNAME
suffix:colon
id|length
op_assign
id|entry-&gt;key.CName.Len
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HFS_HDR_SNAME
suffix:colon
r_default
suffix:colon
id|length
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_return
id|length
suffix:semicolon
)brace
multiline_comment|/*&n; * hdr_build_meta()&n; */
DECL|function|hdr_build_meta
r_static
r_void
id|hdr_build_meta
c_func
(paren
r_struct
id|hdr_hdr
op_star
id|meta
comma
r_const
r_struct
id|hfs_hdr_layout
op_star
id|layout
comma
r_const
r_struct
id|hfs_cat_entry
op_star
id|entry
)paren
(brace
r_const
r_struct
id|hfs_hdr_descr
op_star
id|descr
suffix:semicolon
id|hfs_byte_t
op_star
id|ptr
suffix:semicolon
r_int
id|lcv
suffix:semicolon
id|hfs_put_nl
c_func
(paren
id|layout-&gt;magic
comma
id|meta-&gt;magic
)paren
suffix:semicolon
id|hfs_put_nl
c_func
(paren
id|layout-&gt;version
comma
id|meta-&gt;version
)paren
suffix:semicolon
r_if
c_cond
(paren
id|layout-&gt;version
op_eq
id|htonl
c_func
(paren
id|HFS_HDR_VERSION_1
)paren
)paren
(brace
id|memcpy
c_func
(paren
id|meta-&gt;filler
comma
id|fstype
comma
l_int|16
)paren
suffix:semicolon
)brace
r_else
(brace
id|memset
c_func
(paren
id|meta-&gt;filler
comma
l_int|0
comma
l_int|16
)paren
suffix:semicolon
)brace
id|hfs_put_hs
c_func
(paren
id|layout-&gt;entries
comma
id|meta-&gt;entries
)paren
suffix:semicolon
id|memset
c_func
(paren
id|meta-&gt;descrs
comma
l_int|0
comma
r_sizeof
(paren
id|meta-&gt;descrs
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|lcv
op_assign
l_int|0
comma
id|descr
op_assign
id|layout-&gt;descr
comma
id|ptr
op_assign
id|meta-&gt;descrs
suffix:semicolon
id|lcv
OL
id|layout-&gt;entries
suffix:semicolon
op_increment
id|lcv
comma
op_increment
id|descr
comma
id|ptr
op_add_assign
l_int|12
)paren
(brace
id|hfs_put_hl
c_func
(paren
id|descr-&gt;id
comma
id|ptr
)paren
suffix:semicolon
id|hfs_put_hl
c_func
(paren
id|descr-&gt;offset
comma
id|ptr
op_plus
l_int|4
)paren
suffix:semicolon
id|hfs_put_hl
c_func
(paren
id|dlength
c_func
(paren
id|descr
comma
id|entry
)paren
comma
id|ptr
op_plus
l_int|8
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * dup_layout ()&n; */
DECL|function|dup_layout
r_static
r_struct
id|hfs_hdr_layout
op_star
id|dup_layout
c_func
(paren
r_const
r_struct
id|hfs_hdr_layout
op_star
id|old
)paren
(brace
r_struct
id|hfs_hdr_layout
op_star
r_new
suffix:semicolon
r_int
id|lcv
suffix:semicolon
r_if
c_cond
(paren
id|HFS_NEW
c_func
(paren
r_new
)paren
)paren
(brace
id|memcpy
c_func
(paren
r_new
comma
id|old
comma
r_sizeof
(paren
op_star
r_new
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|lcv
op_assign
l_int|0
suffix:semicolon
id|lcv
OL
r_new
op_member_access_from_pointer
id|entries
suffix:semicolon
op_increment
id|lcv
)paren
(brace
(paren
r_char
op_star
)paren
(paren
r_new
op_member_access_from_pointer
id|order
(braket
id|lcv
)braket
)paren
op_add_assign
(paren
r_char
op_star
)paren
r_new
op_minus
(paren
r_char
op_star
)paren
id|old
suffix:semicolon
)brace
)brace
r_return
r_new
suffix:semicolon
)brace
multiline_comment|/*&n; * init_layout()&n; */
DECL|function|init_layout
r_static
r_inline
r_void
id|init_layout
c_func
(paren
r_struct
id|hfs_hdr_layout
op_star
id|layout
comma
r_const
id|hfs_byte_t
op_star
id|descrs
)paren
(brace
r_struct
id|hfs_hdr_descr
op_star
op_star
id|base
comma
op_star
op_star
id|p
comma
op_star
op_star
id|q
comma
op_star
id|tmp
suffix:semicolon
r_int
id|lcv
comma
id|entries
op_assign
id|layout-&gt;entries
suffix:semicolon
r_for
c_loop
(paren
id|lcv
op_assign
l_int|0
suffix:semicolon
id|lcv
OL
id|entries
suffix:semicolon
op_increment
id|lcv
comma
id|descrs
op_add_assign
l_int|12
)paren
(brace
id|layout-&gt;order
(braket
id|lcv
)braket
op_assign
op_amp
id|layout-&gt;descr
(braket
id|lcv
)braket
suffix:semicolon
id|layout-&gt;descr
(braket
id|lcv
)braket
dot
id|id
op_assign
id|hfs_get_hl
c_func
(paren
id|descrs
)paren
suffix:semicolon
id|layout-&gt;descr
(braket
id|lcv
)braket
dot
id|offset
op_assign
id|hfs_get_hl
c_func
(paren
id|descrs
op_plus
l_int|4
)paren
suffix:semicolon
id|layout-&gt;descr
(braket
id|lcv
)braket
dot
id|length
op_assign
id|hfs_get_hl
c_func
(paren
id|descrs
op_plus
l_int|8
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|lcv
op_assign
id|layout-&gt;entries
suffix:semicolon
id|lcv
OL
id|HFS_HDR_MAX
suffix:semicolon
op_increment
id|lcv
)paren
(brace
id|layout-&gt;order
(braket
id|lcv
)braket
op_assign
l_int|NULL
suffix:semicolon
id|layout-&gt;descr
(braket
id|lcv
)braket
dot
id|id
op_assign
l_int|0
suffix:semicolon
id|layout-&gt;descr
(braket
id|lcv
)braket
dot
id|offset
op_assign
l_int|0
suffix:semicolon
id|layout-&gt;descr
(braket
id|lcv
)braket
dot
id|length
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Sort the &squot;order&squot; array using an insertion sort */
id|base
op_assign
op_amp
id|layout-&gt;order
(braket
l_int|0
)braket
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
(paren
id|base
op_plus
l_int|1
)paren
suffix:semicolon
id|p
OL
(paren
id|base
op_plus
id|entries
)paren
suffix:semicolon
op_increment
id|p
)paren
(brace
id|q
op_assign
id|p
suffix:semicolon
r_while
c_loop
(paren
(paren
op_star
id|q
)paren
op_member_access_from_pointer
id|offset
OL
(paren
op_star
(paren
id|q
op_minus
l_int|1
)paren
)paren
op_member_access_from_pointer
id|offset
)paren
(brace
id|tmp
op_assign
op_star
id|q
suffix:semicolon
op_star
id|q
op_assign
op_star
(paren
id|q
op_minus
l_int|1
)paren
suffix:semicolon
op_star
(paren
op_decrement
id|q
)paren
op_assign
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|q
op_eq
id|base
)paren
r_break
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * adjust_forks()&n; */
DECL|function|adjust_forks
r_static
r_inline
r_void
id|adjust_forks
c_func
(paren
r_struct
id|hfs_cat_entry
op_star
id|entry
comma
r_const
r_struct
id|hfs_hdr_layout
op_star
id|layout
)paren
(brace
r_int
id|lcv
suffix:semicolon
r_for
c_loop
(paren
id|lcv
op_assign
l_int|0
suffix:semicolon
id|lcv
OL
id|layout-&gt;entries
suffix:semicolon
op_increment
id|lcv
)paren
(brace
r_const
r_struct
id|hfs_hdr_descr
op_star
id|descr
op_assign
op_amp
id|layout-&gt;descr
(braket
id|lcv
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|descr-&gt;id
op_eq
id|HFS_HDR_DATA
)paren
op_logical_and
(paren
id|descr-&gt;length
op_ne
id|entry-&gt;u.file.data_fork.lsize
)paren
)paren
(brace
id|entry-&gt;u.file.data_fork.lsize
op_assign
id|descr-&gt;length
suffix:semicolon
id|hfs_extent_adj
c_func
(paren
op_amp
id|entry-&gt;u.file.data_fork
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|descr-&gt;id
op_eq
id|HFS_HDR_RSRC
)paren
op_logical_and
(paren
id|descr-&gt;length
op_ne
id|entry-&gt;u.file.rsrc_fork.lsize
)paren
)paren
(brace
id|entry-&gt;u.file.rsrc_fork.lsize
op_assign
id|descr-&gt;length
suffix:semicolon
id|hfs_extent_adj
c_func
(paren
op_amp
id|entry-&gt;u.file.rsrc_fork
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * get_dates()&n; */
DECL|function|get_dates
r_static
r_void
id|get_dates
c_func
(paren
r_const
r_struct
id|hfs_cat_entry
op_star
id|entry
comma
r_const
r_struct
id|inode
op_star
id|inode
comma
id|hfs_u32
id|dates
(braket
l_int|3
)braket
)paren
(brace
id|dates
(braket
l_int|0
)braket
op_assign
id|hfs_m_to_htime
c_func
(paren
id|entry-&gt;create_date
)paren
suffix:semicolon
id|dates
(braket
l_int|1
)braket
op_assign
id|hfs_m_to_htime
c_func
(paren
id|entry-&gt;modify_date
)paren
suffix:semicolon
id|dates
(braket
l_int|2
)braket
op_assign
id|hfs_m_to_htime
c_func
(paren
id|entry-&gt;backup_date
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * set_dates()&n; */
DECL|function|set_dates
r_static
r_void
id|set_dates
c_func
(paren
r_struct
id|hfs_cat_entry
op_star
id|entry
comma
r_struct
id|inode
op_star
id|inode
comma
r_const
id|hfs_u32
op_star
id|dates
)paren
(brace
id|hfs_u32
id|tmp
suffix:semicolon
id|tmp
op_assign
id|hfs_h_to_mtime
c_func
(paren
id|dates
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry-&gt;create_date
op_ne
id|tmp
)paren
(brace
id|entry-&gt;create_date
op_assign
id|tmp
suffix:semicolon
id|hfs_cat_mark_dirty
c_func
(paren
id|entry
)paren
suffix:semicolon
)brace
id|tmp
op_assign
id|hfs_h_to_mtime
c_func
(paren
id|dates
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry-&gt;modify_date
op_ne
id|tmp
)paren
(brace
id|entry-&gt;modify_date
op_assign
id|tmp
suffix:semicolon
id|inode-&gt;i_ctime
op_assign
id|inode-&gt;i_atime
op_assign
id|inode-&gt;i_mtime
op_assign
id|hfs_h_to_utime
c_func
(paren
id|dates
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|hfs_cat_mark_dirty
c_func
(paren
id|entry
)paren
suffix:semicolon
)brace
id|tmp
op_assign
id|hfs_h_to_mtime
c_func
(paren
id|dates
(braket
l_int|2
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry-&gt;backup_date
op_ne
id|tmp
)paren
(brace
id|entry-&gt;backup_date
op_assign
id|tmp
suffix:semicolon
id|hfs_cat_mark_dirty
c_func
(paren
id|entry
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * hdr_read()&n; *&n; * This is the read field in the inode_operations structure for&n; * header files.  The purpose is to transfer up to &squot;count&squot; bytes&n; * from the file corresponding to &squot;inode&squot;, beginning at&n; * &squot;filp-&gt;offset&squot; bytes into the file.&t;The data is transfered to&n; * user-space at the address &squot;buf&squot;.  Returns the number of bytes&n; * successfully transfered.&n; */
multiline_comment|/* XXX: what about the entry count changing on us? */
DECL|function|hdr_read
r_static
id|hfs_rwret_t
id|hdr_read
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_char
op_star
id|buf
comma
id|hfs_rwarg_t
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|filp-&gt;f_dentry-&gt;d_inode
suffix:semicolon
r_struct
id|hfs_cat_entry
op_star
id|entry
op_assign
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|entry
suffix:semicolon
r_const
r_struct
id|hfs_hdr_layout
op_star
id|layout
suffix:semicolon
id|off_t
id|start
comma
id|length
comma
id|offset
suffix:semicolon
id|off_t
id|pos
op_assign
op_star
id|ppos
suffix:semicolon
r_int
id|left
comma
id|lcv
comma
id|read
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|S_ISREG
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
(brace
id|hfs_warn
c_func
(paren
l_string|&quot;hfs_hdr_read: mode = %07o&bslash;n&quot;
comma
id|inode-&gt;i_mode
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|layout
)paren
(brace
id|layout
op_assign
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|layout
suffix:semicolon
)brace
r_else
(brace
id|layout
op_assign
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|default_layout
suffix:semicolon
)brace
multiline_comment|/* Adjust count to fit within the bounds of the file */
r_if
c_cond
(paren
(paren
id|pos
op_ge
id|inode-&gt;i_size
)paren
op_logical_or
(paren
id|count
op_le
l_int|0
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|count
OG
id|inode-&gt;i_size
op_minus
id|pos
)paren
(brace
id|count
op_assign
id|inode-&gt;i_size
op_minus
id|pos
suffix:semicolon
)brace
multiline_comment|/* Handle the fixed-location portion */
id|length
op_assign
r_sizeof
(paren
id|hfs_u32
)paren
op_plus
r_sizeof
(paren
id|hfs_u32
)paren
op_plus
l_int|16
op_plus
r_sizeof
(paren
id|hfs_u16
)paren
op_plus
id|layout-&gt;entries
op_star
(paren
l_int|3
op_star
r_sizeof
(paren
id|hfs_u32
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pos
OL
id|length
)paren
(brace
r_struct
id|hdr_hdr
id|meta
suffix:semicolon
id|left
op_assign
id|length
op_minus
id|pos
suffix:semicolon
r_if
c_cond
(paren
id|left
OG
id|count
)paren
(brace
id|left
op_assign
id|count
suffix:semicolon
)brace
id|hdr_build_meta
c_func
(paren
op_amp
id|meta
comma
id|layout
comma
id|entry
)paren
suffix:semicolon
id|left
op_sub_assign
id|copy_to_user
c_func
(paren
id|buf
comma
(paren
(paren
r_char
op_star
)paren
op_amp
id|meta
)paren
op_plus
id|pos
comma
id|left
)paren
suffix:semicolon
id|count
op_sub_assign
id|left
suffix:semicolon
id|read
op_add_assign
id|left
suffix:semicolon
id|pos
op_add_assign
id|left
suffix:semicolon
id|buf
op_add_assign
id|left
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|count
)paren
(brace
r_goto
id|done
suffix:semicolon
)brace
multiline_comment|/* Handle the actual data */
r_for
c_loop
(paren
id|lcv
op_assign
l_int|0
suffix:semicolon
id|count
op_logical_and
(paren
id|lcv
OL
id|layout-&gt;entries
)paren
suffix:semicolon
op_increment
id|lcv
)paren
(brace
r_const
r_struct
id|hfs_hdr_descr
op_star
id|descr
op_assign
id|layout-&gt;order
(braket
id|lcv
)braket
suffix:semicolon
r_struct
id|hfs_fork
op_star
id|fork
suffix:semicolon
r_char
id|tmp
(braket
l_int|16
)braket
comma
op_star
id|p
suffix:semicolon
id|off_t
id|limit
suffix:semicolon
multiline_comment|/* stop reading if we run out of descriptors early */
r_if
c_cond
(paren
op_logical_neg
id|descr
)paren
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/* find start and length of this entry */
id|start
op_assign
id|descr-&gt;offset
suffix:semicolon
id|length
op_assign
id|dlength
c_func
(paren
id|descr
comma
id|entry
)paren
suffix:semicolon
multiline_comment|/* Skip to next entry if this one is empty or isn&squot;t needed */
r_if
c_cond
(paren
op_logical_neg
id|length
op_logical_or
(paren
id|pos
op_ge
id|start
op_plus
id|length
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
multiline_comment|/* Pad with zeros to the start of this entry if needed */
r_if
c_cond
(paren
id|pos
OL
id|start
)paren
(brace
id|left
op_assign
id|start
op_minus
id|pos
suffix:semicolon
r_if
c_cond
(paren
id|left
OG
id|count
)paren
(brace
id|left
op_assign
id|count
suffix:semicolon
)brace
id|clear_user
c_func
(paren
id|buf
comma
id|left
)paren
suffix:semicolon
id|count
op_sub_assign
id|left
suffix:semicolon
id|read
op_add_assign
id|left
suffix:semicolon
id|pos
op_add_assign
id|left
suffix:semicolon
id|buf
op_add_assign
id|left
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|count
)paren
(brace
r_goto
id|done
suffix:semicolon
)brace
multiline_comment|/* locate and/or construct the data for this entry */
id|fork
op_assign
l_int|NULL
suffix:semicolon
id|p
op_assign
l_int|NULL
suffix:semicolon
r_switch
c_cond
(paren
id|descr-&gt;id
)paren
(brace
r_case
id|HFS_HDR_DATA
suffix:colon
id|fork
op_assign
op_amp
id|entry-&gt;u.file.data_fork
suffix:semicolon
id|limit
op_assign
id|fork-&gt;lsize
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HFS_HDR_RSRC
suffix:colon
id|fork
op_assign
op_amp
id|entry-&gt;u.file.rsrc_fork
suffix:semicolon
id|limit
op_assign
id|fork-&gt;lsize
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HFS_HDR_FNAME
suffix:colon
id|p
op_assign
id|entry-&gt;key.CName.Name
suffix:semicolon
id|limit
op_assign
id|entry-&gt;key.CName.Len
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HFS_HDR_OLDI
suffix:colon
r_case
id|HFS_HDR_DATES
suffix:colon
id|get_dates
c_func
(paren
id|entry
comma
id|inode
comma
(paren
id|hfs_u32
op_star
)paren
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|descr-&gt;id
op_eq
id|HFS_HDR_DATES
)paren
(brace
multiline_comment|/* XXX: access date. hfsplus actually&n;                                   has this. */
id|memcpy
c_func
(paren
id|tmp
op_plus
l_int|12
comma
id|tmp
op_plus
l_int|4
comma
l_int|4
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|entry-&gt;type
op_eq
id|HFS_CDR_FIL
)paren
op_logical_and
(paren
id|entry-&gt;u.file.flags
op_amp
id|HFS_FIL_LOCK
)paren
)paren
(brace
id|hfs_put_hl
c_func
(paren
id|HFS_AFP_RDONLY
comma
id|tmp
op_plus
l_int|12
)paren
suffix:semicolon
)brace
r_else
(brace
id|hfs_put_nl
c_func
(paren
l_int|0
comma
id|tmp
op_plus
l_int|12
)paren
suffix:semicolon
)brace
id|p
op_assign
id|tmp
suffix:semicolon
id|limit
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HFS_HDR_FINFO
suffix:colon
id|p
op_assign
(paren
r_char
op_star
)paren
op_amp
id|entry-&gt;info
suffix:semicolon
id|limit
op_assign
l_int|32
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HFS_HDR_AFPI
suffix:colon
multiline_comment|/* XXX: this needs to do more mac-&gt;afp mappings */
id|hfs_put_ns
c_func
(paren
l_int|0
comma
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|entry-&gt;type
op_eq
id|HFS_CDR_FIL
)paren
op_logical_and
(paren
id|entry-&gt;u.file.flags
op_amp
id|HFS_FIL_LOCK
)paren
)paren
(brace
id|hfs_put_hs
c_func
(paren
id|HFS_AFP_RDONLY
comma
id|tmp
op_plus
l_int|2
)paren
suffix:semicolon
)brace
r_else
(brace
id|hfs_put_ns
c_func
(paren
l_int|0
comma
id|tmp
op_plus
l_int|2
)paren
suffix:semicolon
)brace
id|p
op_assign
id|tmp
suffix:semicolon
id|limit
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HFS_HDR_PRODOSI
suffix:colon
multiline_comment|/* XXX: this needs to do mac-&gt;prodos translations */
id|memset
c_func
(paren
id|tmp
comma
l_int|0
comma
l_int|8
)paren
suffix:semicolon
macro_line|#if 0
id|hfs_put_ns
c_func
(paren
l_int|0
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* access */
id|hfs_put_ns
c_func
(paren
l_int|0
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* type */
id|hfs_put_nl
c_func
(paren
l_int|0
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* aux type */
macro_line|#endif
id|p
op_assign
id|tmp
suffix:semicolon
id|limit
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HFS_HDR_MACI
suffix:colon
id|hfs_put_ns
c_func
(paren
l_int|0
comma
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry-&gt;type
op_eq
id|HFS_CDR_FIL
)paren
(brace
id|hfs_put_hs
c_func
(paren
id|entry-&gt;u.file.flags
comma
id|tmp
op_plus
l_int|2
)paren
suffix:semicolon
)brace
r_else
(brace
id|hfs_put_ns
c_func
(paren
id|entry-&gt;u.dir.flags
comma
id|tmp
op_plus
l_int|2
)paren
suffix:semicolon
)brace
id|p
op_assign
id|tmp
suffix:semicolon
id|limit
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HFS_HDR_DID
suffix:colon
multiline_comment|/* if it&squot;s rootinfo, stick the next available did in&n;&t;&t;&t; * the did slot. */
id|limit
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|entry-&gt;cnid
op_eq
id|htonl
c_func
(paren
id|HFS_ROOT_CNID
)paren
)paren
(brace
r_struct
id|hfs_mdb
op_star
id|mdb
op_assign
id|entry-&gt;mdb
suffix:semicolon
r_const
r_struct
id|hfs_name
op_star
id|reserved
op_assign
id|HFS_SB
c_func
(paren
id|mdb-&gt;sys_mdb
)paren
op_member_access_from_pointer
id|s_reserved2
suffix:semicolon
r_while
c_loop
(paren
id|reserved-&gt;Len
)paren
(brace
r_if
c_cond
(paren
id|hfs_streq
c_func
(paren
id|reserved-&gt;Name
comma
id|reserved-&gt;Len
comma
id|entry-&gt;key.CName.Name
comma
id|entry-&gt;key.CName.Len
)paren
)paren
(brace
id|hfs_put_hl
c_func
(paren
id|mdb-&gt;next_id
comma
id|tmp
)paren
suffix:semicolon
id|p
op_assign
id|tmp
suffix:semicolon
r_goto
id|hfs_did_done
suffix:semicolon
)brace
id|reserved
op_increment
suffix:semicolon
)brace
)brace
id|p
op_assign
(paren
r_char
op_star
)paren
op_amp
id|entry-&gt;cnid
suffix:semicolon
id|hfs_did_done
suffix:colon
r_break
suffix:semicolon
r_case
id|HFS_HDR_SNAME
suffix:colon
r_default
suffix:colon
id|limit
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* limit the transfer to the available data&n;&t;&t;   of to the stated length of the entry. */
r_if
c_cond
(paren
id|length
OG
id|limit
)paren
(brace
id|length
op_assign
id|limit
suffix:semicolon
)brace
id|offset
op_assign
id|pos
op_minus
id|start
suffix:semicolon
id|left
op_assign
id|length
op_minus
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|left
OG
id|count
)paren
(brace
id|left
op_assign
id|count
suffix:semicolon
)brace
r_if
c_cond
(paren
id|left
op_le
l_int|0
)paren
(brace
r_continue
suffix:semicolon
)brace
multiline_comment|/* transfer the data */
r_if
c_cond
(paren
id|p
)paren
(brace
id|left
op_sub_assign
id|copy_to_user
c_func
(paren
id|buf
comma
id|p
op_plus
id|offset
comma
id|left
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fork
)paren
(brace
id|left
op_assign
id|hfs_do_read
c_func
(paren
id|inode
comma
id|fork
comma
id|offset
comma
id|buf
comma
id|left
comma
id|filp-&gt;f_reada
op_ne
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|left
OG
l_int|0
)paren
(brace
id|filp-&gt;f_reada
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|read
)paren
(brace
r_return
id|left
suffix:semicolon
)brace
r_else
(brace
r_goto
id|done
suffix:semicolon
)brace
)brace
id|count
op_sub_assign
id|left
suffix:semicolon
id|read
op_add_assign
id|left
suffix:semicolon
id|pos
op_add_assign
id|left
suffix:semicolon
id|buf
op_add_assign
id|left
suffix:semicolon
)brace
multiline_comment|/* Pad the file out with zeros */
r_if
c_cond
(paren
id|count
)paren
(brace
id|clear_user
c_func
(paren
id|buf
comma
id|count
)paren
suffix:semicolon
id|read
op_add_assign
id|count
suffix:semicolon
id|pos
op_add_assign
id|count
suffix:semicolon
)brace
id|done
suffix:colon
r_if
c_cond
(paren
id|read
)paren
(brace
id|inode-&gt;i_atime
op_assign
id|CURRENT_TIME
suffix:semicolon
op_star
id|ppos
op_assign
id|pos
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
r_return
id|read
suffix:semicolon
)brace
multiline_comment|/*&n; * hdr_write()&n; *&n; * This is the write() entry in the file_operations structure for&n; * header files.  The purpose is to transfer up to &squot;count&squot; bytes&n; * to the file corresponding to &squot;inode&squot; beginning at offset&n; * &squot;*ppos&squot; from user-space at the address &squot;buf&squot;.&n; * The return value is the number of bytes actually transferred.&n; */
DECL|function|hdr_write
r_static
id|hfs_rwret_t
id|hdr_write
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_const
r_char
op_star
id|buf
comma
id|hfs_rwarg_t
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|filp-&gt;f_dentry-&gt;d_inode
suffix:semicolon
r_struct
id|hfs_cat_entry
op_star
id|entry
op_assign
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|entry
suffix:semicolon
r_struct
id|hfs_hdr_layout
op_star
id|layout
suffix:semicolon
id|off_t
id|start
comma
id|length
comma
id|offset
suffix:semicolon
r_int
id|left
comma
id|lcv
comma
id|written
op_assign
l_int|0
suffix:semicolon
r_struct
id|hdr_hdr
id|meta
suffix:semicolon
r_int
id|built_meta
op_assign
l_int|0
suffix:semicolon
id|off_t
id|pos
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|S_ISREG
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
(brace
id|hfs_warn
c_func
(paren
l_string|&quot;hfs_hdr_write: mode = %07o&bslash;n&quot;
comma
id|inode-&gt;i_mode
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
op_le
l_int|0
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|pos
op_assign
(paren
id|filp-&gt;f_flags
op_amp
id|O_APPEND
)paren
ques
c_cond
id|inode-&gt;i_size
suffix:colon
op_star
id|ppos
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|layout
)paren
(brace
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|layout
op_assign
id|dup_layout
c_func
(paren
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|default_layout
)paren
suffix:semicolon
)brace
id|layout
op_assign
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|layout
suffix:semicolon
multiline_comment|/* Handle the &squot;magic&squot;, &squot;version&squot;, &squot;filler&squot; and &squot;entries&squot; fields */
id|length
op_assign
r_sizeof
(paren
id|hfs_u32
)paren
op_plus
r_sizeof
(paren
id|hfs_u32
)paren
op_plus
l_int|16
op_plus
r_sizeof
(paren
id|hfs_u16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pos
OL
id|length
)paren
(brace
id|hdr_build_meta
c_func
(paren
op_amp
id|meta
comma
id|layout
comma
id|entry
)paren
suffix:semicolon
id|built_meta
op_assign
l_int|1
suffix:semicolon
id|left
op_assign
id|length
op_minus
id|pos
suffix:semicolon
r_if
c_cond
(paren
id|left
OG
id|count
)paren
(brace
id|left
op_assign
id|count
suffix:semicolon
)brace
id|left
op_sub_assign
id|copy_from_user
c_func
(paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|meta
)paren
op_plus
id|pos
comma
id|buf
comma
id|left
)paren
suffix:semicolon
id|layout-&gt;magic
op_assign
id|hfs_get_nl
c_func
(paren
id|meta.magic
)paren
suffix:semicolon
id|layout-&gt;version
op_assign
id|hfs_get_nl
c_func
(paren
id|meta.version
)paren
suffix:semicolon
id|layout-&gt;entries
op_assign
id|hfs_get_hs
c_func
(paren
id|meta.entries
)paren
suffix:semicolon
r_if
c_cond
(paren
id|layout-&gt;entries
OG
id|HFS_HDR_MAX
)paren
(brace
multiline_comment|/* XXX: should allocate slots dynamically */
id|hfs_warn
c_func
(paren
l_string|&quot;hfs_hdr_write: TRUNCATING TO %d &quot;
l_string|&quot;DESCRIPTORS&bslash;n&quot;
comma
id|HFS_HDR_MAX
)paren
suffix:semicolon
id|layout-&gt;entries
op_assign
id|HFS_HDR_MAX
suffix:semicolon
)brace
id|count
op_sub_assign
id|left
suffix:semicolon
id|written
op_add_assign
id|left
suffix:semicolon
id|pos
op_add_assign
id|left
suffix:semicolon
id|buf
op_add_assign
id|left
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|count
)paren
(brace
r_goto
id|done
suffix:semicolon
)brace
multiline_comment|/* We know for certain how many entries we have, so process them */
id|length
op_add_assign
id|layout-&gt;entries
op_star
l_int|3
op_star
r_sizeof
(paren
id|hfs_u32
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pos
OL
id|length
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|built_meta
)paren
(brace
id|hdr_build_meta
c_func
(paren
op_amp
id|meta
comma
id|layout
comma
id|entry
)paren
suffix:semicolon
)brace
id|left
op_assign
id|length
op_minus
id|pos
suffix:semicolon
r_if
c_cond
(paren
id|left
OG
id|count
)paren
(brace
id|left
op_assign
id|count
suffix:semicolon
)brace
id|left
op_sub_assign
id|copy_from_user
c_func
(paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|meta
)paren
op_plus
id|pos
comma
id|buf
comma
id|left
)paren
suffix:semicolon
id|init_layout
c_func
(paren
id|layout
comma
id|meta.descrs
)paren
suffix:semicolon
id|count
op_sub_assign
id|left
suffix:semicolon
id|written
op_add_assign
id|left
suffix:semicolon
id|pos
op_add_assign
id|left
suffix:semicolon
id|buf
op_add_assign
id|left
suffix:semicolon
multiline_comment|/* Handle possible size changes for the forks */
r_if
c_cond
(paren
id|entry-&gt;type
op_eq
id|HFS_CDR_FIL
)paren
(brace
id|adjust_forks
c_func
(paren
id|entry
comma
id|layout
)paren
suffix:semicolon
id|hfs_cat_mark_dirty
c_func
(paren
id|entry
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Handle the actual data */
r_for
c_loop
(paren
id|lcv
op_assign
l_int|0
suffix:semicolon
id|count
op_logical_and
(paren
id|lcv
OL
id|layout-&gt;entries
)paren
suffix:semicolon
op_increment
id|lcv
)paren
(brace
r_struct
id|hfs_hdr_descr
op_star
id|descr
op_assign
id|layout-&gt;order
(braket
id|lcv
)braket
suffix:semicolon
r_struct
id|hfs_fork
op_star
id|fork
suffix:semicolon
r_char
id|tmp
(braket
l_int|16
)braket
comma
op_star
id|p
suffix:semicolon
id|off_t
id|limit
suffix:semicolon
multiline_comment|/* stop writing if we run out of descriptors early */
r_if
c_cond
(paren
op_logical_neg
id|descr
)paren
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/* find start and length of this entry */
id|start
op_assign
id|descr-&gt;offset
suffix:semicolon
r_if
c_cond
(paren
(paren
id|descr-&gt;id
op_eq
id|HFS_HDR_DATA
)paren
op_logical_or
(paren
id|descr-&gt;id
op_eq
id|HFS_HDR_RSRC
)paren
)paren
(brace
r_if
c_cond
(paren
id|entry-&gt;type
op_eq
id|HFS_CDR_FIL
)paren
(brace
id|length
op_assign
l_int|0x7fffffff
op_minus
id|start
suffix:semicolon
)brace
r_else
(brace
r_continue
suffix:semicolon
)brace
)brace
r_else
(brace
id|length
op_assign
id|dlength
c_func
(paren
id|descr
comma
id|entry
)paren
suffix:semicolon
)brace
multiline_comment|/* Trim length to avoid overlap with the next entry */
r_if
c_cond
(paren
id|layout-&gt;order
(braket
id|lcv
op_plus
l_int|1
)braket
op_logical_and
(paren
(paren
id|start
op_plus
id|length
)paren
OG
id|layout-&gt;order
(braket
id|lcv
op_plus
l_int|1
)braket
op_member_access_from_pointer
id|offset
)paren
)paren
(brace
id|length
op_assign
id|layout-&gt;order
(braket
id|lcv
op_plus
l_int|1
)braket
op_member_access_from_pointer
id|offset
op_minus
id|start
suffix:semicolon
)brace
multiline_comment|/* Skip to next entry if this one is empty or isn&squot;t needed */
r_if
c_cond
(paren
op_logical_neg
id|length
op_logical_or
(paren
id|pos
op_ge
id|start
op_plus
id|length
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
multiline_comment|/* Skip any padding that may exist between entries */
r_if
c_cond
(paren
id|pos
OL
id|start
)paren
(brace
id|left
op_assign
id|start
op_minus
id|pos
suffix:semicolon
r_if
c_cond
(paren
id|left
OG
id|count
)paren
(brace
id|left
op_assign
id|count
suffix:semicolon
)brace
id|count
op_sub_assign
id|left
suffix:semicolon
id|written
op_add_assign
id|left
suffix:semicolon
id|pos
op_add_assign
id|left
suffix:semicolon
id|buf
op_add_assign
id|left
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|count
)paren
(brace
r_goto
id|done
suffix:semicolon
)brace
multiline_comment|/* locate and/or construct the data for this entry */
id|fork
op_assign
l_int|NULL
suffix:semicolon
id|p
op_assign
l_int|NULL
suffix:semicolon
r_switch
c_cond
(paren
id|descr-&gt;id
)paren
(brace
r_case
id|HFS_HDR_DATA
suffix:colon
macro_line|#if 0
multiline_comment|/* Can&squot;t yet write to the data fork via a header file, since there is the&n; * possibility to write via the data file, and the only locking is at the&n; * inode level.&n; */
id|fork
op_assign
op_amp
id|entry-&gt;u.file.data_fork
suffix:semicolon
id|limit
op_assign
id|length
suffix:semicolon
macro_line|#else
id|limit
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|HFS_HDR_RSRC
suffix:colon
id|fork
op_assign
op_amp
id|entry-&gt;u.file.rsrc_fork
suffix:semicolon
id|limit
op_assign
id|length
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HFS_HDR_OLDI
suffix:colon
r_case
id|HFS_HDR_DATES
suffix:colon
id|get_dates
c_func
(paren
id|entry
comma
id|inode
comma
(paren
id|hfs_u32
op_star
)paren
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|descr-&gt;id
op_eq
id|HFS_HDR_DATES
)paren
(brace
id|memcpy
c_func
(paren
id|tmp
op_plus
l_int|12
comma
id|tmp
op_plus
l_int|4
comma
l_int|4
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|entry-&gt;type
op_eq
id|HFS_CDR_FIL
)paren
op_logical_and
(paren
id|entry-&gt;u.file.flags
op_amp
id|HFS_FIL_LOCK
)paren
)paren
(brace
id|hfs_put_hl
c_func
(paren
id|HFS_AFP_RDONLY
comma
id|tmp
op_plus
l_int|12
)paren
suffix:semicolon
)brace
r_else
(brace
id|hfs_put_nl
c_func
(paren
l_int|0
comma
id|tmp
op_plus
l_int|12
)paren
suffix:semicolon
)brace
id|p
op_assign
id|tmp
suffix:semicolon
id|limit
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HFS_HDR_FINFO
suffix:colon
id|p
op_assign
(paren
r_char
op_star
)paren
op_amp
id|entry-&gt;info
suffix:semicolon
id|limit
op_assign
l_int|32
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HFS_HDR_AFPI
suffix:colon
id|hfs_put_ns
c_func
(paren
l_int|0
comma
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|entry-&gt;type
op_eq
id|HFS_CDR_FIL
)paren
op_logical_and
(paren
id|entry-&gt;u.file.flags
op_amp
id|HFS_FIL_LOCK
)paren
)paren
(brace
id|hfs_put_hs
c_func
(paren
id|HFS_AFP_RDONLY
comma
id|tmp
op_plus
l_int|2
)paren
suffix:semicolon
)brace
r_else
(brace
id|hfs_put_ns
c_func
(paren
l_int|0
comma
id|tmp
op_plus
l_int|2
)paren
suffix:semicolon
)brace
id|p
op_assign
id|tmp
suffix:semicolon
id|limit
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HFS_HDR_PRODOSI
suffix:colon
multiline_comment|/* XXX: this needs to do mac-&gt;prodos translations */
id|memset
c_func
(paren
id|tmp
comma
l_int|0
comma
l_int|8
)paren
suffix:semicolon
macro_line|#if 0
id|hfs_put_ns
c_func
(paren
l_int|0
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* access */
id|hfs_put_ns
c_func
(paren
l_int|0
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* type */
id|hfs_put_nl
c_func
(paren
l_int|0
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* aux type */
macro_line|#endif
id|p
op_assign
id|tmp
suffix:semicolon
id|limit
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HFS_HDR_MACI
suffix:colon
id|hfs_put_ns
c_func
(paren
l_int|0
comma
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry-&gt;type
op_eq
id|HFS_CDR_FIL
)paren
(brace
id|hfs_put_hs
c_func
(paren
id|entry-&gt;u.file.flags
comma
id|tmp
op_plus
l_int|2
)paren
suffix:semicolon
)brace
r_else
(brace
id|hfs_put_ns
c_func
(paren
id|entry-&gt;u.dir.flags
comma
id|tmp
op_plus
l_int|2
)paren
suffix:semicolon
)brace
id|p
op_assign
id|tmp
suffix:semicolon
id|limit
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HFS_HDR_FNAME
suffix:colon
multiline_comment|/* Can&squot;t rename a file this way */
r_case
id|HFS_HDR_DID
suffix:colon
multiline_comment|/* can&squot;t specify a did this way */
r_default
suffix:colon
id|limit
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* limit the transfer to the available data&n;&t;&t;   of to the stated length of the entry. */
r_if
c_cond
(paren
id|length
OG
id|limit
)paren
(brace
id|length
op_assign
id|limit
suffix:semicolon
)brace
id|offset
op_assign
id|pos
op_minus
id|start
suffix:semicolon
id|left
op_assign
id|length
op_minus
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|left
OG
id|count
)paren
(brace
id|left
op_assign
id|count
suffix:semicolon
)brace
r_if
c_cond
(paren
id|left
op_le
l_int|0
)paren
(brace
r_continue
suffix:semicolon
)brace
multiline_comment|/* transfer the data from user space */
r_if
c_cond
(paren
id|p
)paren
(brace
id|left
op_sub_assign
id|copy_from_user
c_func
(paren
id|p
op_plus
id|offset
comma
id|buf
comma
id|left
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fork
)paren
(brace
id|left
op_assign
id|hfs_do_write
c_func
(paren
id|inode
comma
id|fork
comma
id|offset
comma
id|buf
comma
id|left
)paren
suffix:semicolon
)brace
multiline_comment|/* process the data */
r_switch
c_cond
(paren
id|descr-&gt;id
)paren
(brace
r_case
id|HFS_HDR_OLDI
suffix:colon
id|set_dates
c_func
(paren
id|entry
comma
id|inode
comma
(paren
id|hfs_u32
op_star
)paren
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry-&gt;type
op_eq
id|HFS_CDR_FIL
)paren
(brace
id|hfs_u8
id|new_flags
op_assign
id|entry-&gt;u.file.flags
suffix:semicolon
r_if
c_cond
(paren
id|hfs_get_nl
c_func
(paren
id|tmp
op_plus
l_int|12
)paren
op_amp
id|htonl
c_func
(paren
id|HFS_AFP_WRI
)paren
)paren
(brace
id|new_flags
op_or_assign
id|HFS_FIL_LOCK
suffix:semicolon
)brace
r_else
(brace
id|new_flags
op_and_assign
op_complement
id|HFS_FIL_LOCK
suffix:semicolon
)brace
r_if
c_cond
(paren
id|new_flags
op_ne
id|entry-&gt;u.file.flags
)paren
(brace
id|entry-&gt;u.file.flags
op_assign
id|new_flags
suffix:semicolon
id|hfs_cat_mark_dirty
c_func
(paren
id|entry
)paren
suffix:semicolon
id|hfs_file_fix_mode
c_func
(paren
id|entry
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|HFS_HDR_DATES
suffix:colon
id|set_dates
c_func
(paren
id|entry
comma
id|inode
comma
(paren
id|hfs_u32
op_star
)paren
id|tmp
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HFS_HDR_FINFO
suffix:colon
id|hfs_cat_mark_dirty
c_func
(paren
id|entry
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HFS_HDR_MACI
suffix:colon
r_if
c_cond
(paren
id|entry-&gt;type
op_eq
id|HFS_CDR_DIR
)paren
(brace
id|hfs_u16
id|new_flags
op_assign
id|hfs_get_ns
c_func
(paren
id|tmp
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry-&gt;u.dir.flags
op_ne
id|new_flags
)paren
(brace
id|entry-&gt;u.dir.flags
op_assign
id|new_flags
suffix:semicolon
id|hfs_cat_mark_dirty
c_func
(paren
id|entry
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|hfs_u8
id|new_flags
op_assign
id|tmp
(braket
l_int|3
)braket
suffix:semicolon
id|hfs_u8
id|changed
op_assign
id|entry-&gt;u.file.flags
op_xor
id|new_flags
suffix:semicolon
r_if
c_cond
(paren
id|changed
)paren
(brace
id|entry-&gt;u.file.flags
op_assign
id|new_flags
suffix:semicolon
id|hfs_cat_mark_dirty
c_func
(paren
id|entry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|changed
op_amp
id|HFS_FIL_LOCK
)paren
(brace
id|hfs_file_fix_mode
c_func
(paren
id|entry
)paren
suffix:semicolon
)brace
)brace
)brace
r_break
suffix:semicolon
r_case
id|HFS_HDR_DATA
suffix:colon
r_case
id|HFS_HDR_RSRC
suffix:colon
r_if
c_cond
(paren
id|left
op_le
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|written
)paren
(brace
r_return
id|left
suffix:semicolon
)brace
r_else
(brace
r_goto
id|done
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|fork-&gt;lsize
OG
id|descr-&gt;length
)paren
(brace
id|descr-&gt;length
op_assign
id|fork-&gt;lsize
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|HFS_HDR_FNAME
suffix:colon
multiline_comment|/* Can&squot;t rename a file this way */
r_case
id|HFS_HDR_DID
suffix:colon
multiline_comment|/* Can&squot;t specify a did this way */
r_case
id|HFS_HDR_PRODOSI
suffix:colon
multiline_comment|/* not implemented yet */
r_case
id|HFS_HDR_AFPI
suffix:colon
multiline_comment|/* ditto */
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|count
op_sub_assign
id|left
suffix:semicolon
id|written
op_add_assign
id|left
suffix:semicolon
id|pos
op_add_assign
id|left
suffix:semicolon
id|buf
op_add_assign
id|left
suffix:semicolon
)brace
multiline_comment|/* Skip any padding at the end */
r_if
c_cond
(paren
id|count
)paren
(brace
id|written
op_add_assign
id|count
suffix:semicolon
id|pos
op_add_assign
id|count
suffix:semicolon
)brace
id|done
suffix:colon
op_star
id|ppos
op_assign
id|pos
suffix:semicolon
r_if
c_cond
(paren
id|written
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|pos
OG
id|inode-&gt;i_size
)paren
id|inode-&gt;i_size
op_assign
id|pos
suffix:semicolon
id|inode-&gt;i_mtime
op_assign
id|inode-&gt;i_atime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
r_return
id|written
suffix:semicolon
)brace
multiline_comment|/*&n; * hdr_truncate()&n; *&n; * This is the truncate field in the inode_operations structure for&n; * header files.  The purpose is to allocate or release blocks as needed&n; * to satisfy a change in file length.&n; */
DECL|function|hdr_truncate
r_void
id|hdr_truncate
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_int
id|size
)paren
(brace
r_struct
id|hfs_cat_entry
op_star
id|entry
op_assign
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|entry
suffix:semicolon
r_struct
id|hfs_hdr_layout
op_star
id|layout
suffix:semicolon
r_int
id|lcv
comma
id|last
suffix:semicolon
id|inode-&gt;i_size
op_assign
id|size
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|layout
)paren
(brace
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|layout
op_assign
id|dup_layout
c_func
(paren
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|default_layout
)paren
suffix:semicolon
)brace
id|layout
op_assign
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|layout
suffix:semicolon
id|last
op_assign
id|layout-&gt;entries
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|lcv
op_assign
l_int|0
suffix:semicolon
id|lcv
op_le
id|last
suffix:semicolon
op_increment
id|lcv
)paren
(brace
r_struct
id|hfs_hdr_descr
op_star
id|descr
op_assign
id|layout-&gt;order
(braket
id|lcv
)braket
suffix:semicolon
r_struct
id|hfs_fork
op_star
id|fork
suffix:semicolon
id|hfs_u32
id|offset
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|descr
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|descr-&gt;id
op_eq
id|HFS_HDR_RSRC
)paren
(brace
id|fork
op_assign
op_amp
id|entry-&gt;u.file.rsrc_fork
suffix:semicolon
macro_line|#if 0
multiline_comment|/* Can&squot;t yet truncate the data fork via a header file, since there is the&n; * possibility to truncate via the data file, and the only locking is at&n; * the inode level.&n; */
)brace
r_else
r_if
c_cond
(paren
id|descr-&gt;id
op_eq
id|HFS_HDR_DATA
)paren
(brace
id|fork
op_assign
op_amp
id|entry-&gt;u.file.data_fork
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
r_continue
suffix:semicolon
)brace
id|offset
op_assign
id|descr-&gt;offset
suffix:semicolon
r_if
c_cond
(paren
(paren
id|lcv
op_ne
id|last
)paren
op_logical_and
(paren
(paren
id|offset
op_plus
id|descr-&gt;length
)paren
op_le
id|size
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|offset
OL
id|size
)paren
(brace
id|descr-&gt;length
op_assign
id|size
op_minus
id|offset
suffix:semicolon
)brace
r_else
(brace
id|descr-&gt;length
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fork-&gt;lsize
op_ne
id|descr-&gt;length
)paren
(brace
id|fork-&gt;lsize
op_assign
id|descr-&gt;length
suffix:semicolon
id|hfs_extent_adj
c_func
(paren
id|fork
)paren
suffix:semicolon
id|hfs_cat_mark_dirty
c_func
(paren
id|entry
)paren
suffix:semicolon
)brace
)brace
)brace
eof
