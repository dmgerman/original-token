multiline_comment|/*&n; * linux/fs/hfs/mdb.c&n; *&n; * Copyright (C) 1995-1997  Paul H. Hargrove&n; * This file may be distributed under the terms of the GNU Public License.&n; *&n; * This file contains functions for reading/writing the MDB.&n; *&n; * &quot;XXX&quot; in a comment is a note to myself to consider changing something.&n; *&n; * In function preconditions the term &quot;valid&quot; applied to a pointer to&n; * a structure means that the pointer is non-NULL and the structure it&n; * points to has all fields initialized to consistent values.&n; *&n; * The code in this file initializes some structures which contain&n; * pointers by calling memset(&amp;foo, 0, sizeof(foo)).&n; * This produces the desired behavior only due to the non-ANSI&n; * assumption that the machine representation of NULL is all zeros.&n; */
macro_line|#include &quot;hfs.h&quot;
multiline_comment|/*================ File-local data types ================*/
multiline_comment|/* &n; * The HFS Master Directory Block (MDB).&n; *&n; * Also known as the Volume Information Block (VIB), this structure is&n; * the HFS equivalent of a superblock.&n; *&n; * Reference: _Inside Macintosh: Files_ pages 2-59 through 2-62&n; *&n; * modified for HFS Extended&n; */
DECL|struct|raw_mdb
r_struct
id|raw_mdb
(brace
DECL|member|drSigWord
id|hfs_word_t
id|drSigWord
suffix:semicolon
multiline_comment|/* Signature word indicating fs type */
DECL|member|drCrDate
id|hfs_lword_t
id|drCrDate
suffix:semicolon
multiline_comment|/* fs creation date/time */
DECL|member|drLsMod
id|hfs_lword_t
id|drLsMod
suffix:semicolon
multiline_comment|/* fs modification date/time */
DECL|member|drAtrb
id|hfs_word_t
id|drAtrb
suffix:semicolon
multiline_comment|/* fs attributes */
DECL|member|drNmFls
id|hfs_word_t
id|drNmFls
suffix:semicolon
multiline_comment|/* number of files in root directory */
DECL|member|drVBMSt
id|hfs_word_t
id|drVBMSt
suffix:semicolon
multiline_comment|/* location (in 512-byte blocks)&n;&t;&t;&t;&t;&t;   of the volume bitmap */
DECL|member|drAllocPtr
id|hfs_word_t
id|drAllocPtr
suffix:semicolon
multiline_comment|/* location (in allocation blocks)&n;&t;&t;&t;&t;&t;   to begin next allocation search */
DECL|member|drNmAlBlks
id|hfs_word_t
id|drNmAlBlks
suffix:semicolon
multiline_comment|/* number of allocation blocks */
DECL|member|drAlBlkSiz
id|hfs_lword_t
id|drAlBlkSiz
suffix:semicolon
multiline_comment|/* bytes in an allocation block */
DECL|member|drClpSiz
id|hfs_lword_t
id|drClpSiz
suffix:semicolon
multiline_comment|/* clumpsize, the number of bytes to&n;&t;&t;&t;&t;&t;   allocate when extending a file */
DECL|member|drAlBlSt
id|hfs_word_t
id|drAlBlSt
suffix:semicolon
multiline_comment|/* location (in 512-byte blocks)&n;&t;&t;&t;&t;&t;   of the first allocation block */
DECL|member|drNxtCNID
id|hfs_lword_t
id|drNxtCNID
suffix:semicolon
multiline_comment|/* CNID to assign to the next&n;&t;&t;&t;&t;&t;   file or directory created */
DECL|member|drFreeBks
id|hfs_word_t
id|drFreeBks
suffix:semicolon
multiline_comment|/* number of free allocation blocks */
DECL|member|drVN
id|hfs_byte_t
id|drVN
(braket
l_int|28
)braket
suffix:semicolon
multiline_comment|/* the volume label */
DECL|member|drVolBkUp
id|hfs_lword_t
id|drVolBkUp
suffix:semicolon
multiline_comment|/* fs backup date/time */
DECL|member|drVSeqNum
id|hfs_word_t
id|drVSeqNum
suffix:semicolon
multiline_comment|/* backup sequence number */
DECL|member|drWrCnt
id|hfs_lword_t
id|drWrCnt
suffix:semicolon
multiline_comment|/* fs write count */
DECL|member|drXTClpSiz
id|hfs_lword_t
id|drXTClpSiz
suffix:semicolon
multiline_comment|/* clumpsize for the extents B-tree */
DECL|member|drCTClpSiz
id|hfs_lword_t
id|drCTClpSiz
suffix:semicolon
multiline_comment|/* clumpsize for the catalog B-tree */
DECL|member|drNmRtDirs
id|hfs_word_t
id|drNmRtDirs
suffix:semicolon
multiline_comment|/* number of directories in&n;&t;&t;&t;&t;&t;   the root directory */
DECL|member|drFilCnt
id|hfs_lword_t
id|drFilCnt
suffix:semicolon
multiline_comment|/* number of files in the fs */
DECL|member|drDirCnt
id|hfs_lword_t
id|drDirCnt
suffix:semicolon
multiline_comment|/* number of directories in the fs */
DECL|member|drFndrInfo
id|hfs_byte_t
id|drFndrInfo
(braket
l_int|32
)braket
suffix:semicolon
multiline_comment|/* data used by the Finder */
DECL|member|drEmbedSigWord
id|hfs_word_t
id|drEmbedSigWord
suffix:semicolon
multiline_comment|/* embedded volume signature */
DECL|member|drEmbedExtent
id|hfs_lword_t
id|drEmbedExtent
suffix:semicolon
multiline_comment|/* starting block number (xdrStABN) &n;&t;&t;&t;&t;&t;   and number of allocation blocks &n;&t;&t;&t;&t;&t;   (xdrNumABlks) occupied by embedded&n;&t;&t;&t;&t;&t;   volume */
DECL|member|drXTFlSize
id|hfs_lword_t
id|drXTFlSize
suffix:semicolon
multiline_comment|/* bytes in the extents B-tree */
DECL|member|drXTExtRec
id|hfs_byte_t
id|drXTExtRec
(braket
l_int|12
)braket
suffix:semicolon
multiline_comment|/* extents B-tree&squot;s first 3 extents */
DECL|member|drCTFlSize
id|hfs_lword_t
id|drCTFlSize
suffix:semicolon
multiline_comment|/* bytes in the catalog B-tree */
DECL|member|drCTExtRec
id|hfs_byte_t
id|drCTExtRec
(braket
l_int|12
)braket
suffix:semicolon
multiline_comment|/* catalog B-tree&squot;s first 3 extents */
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
multiline_comment|/*================ Global functions ================*/
multiline_comment|/*&n; * hfs_mdb_get()&n; *&n; * Build the in-core MDB for a filesystem, including&n; * the B-trees and the volume bitmap.&n; */
DECL|function|hfs_mdb_get
r_struct
id|hfs_mdb
op_star
id|hfs_mdb_get
c_func
(paren
id|hfs_sysmdb
id|sys_mdb
comma
r_int
id|readonly
comma
id|hfs_s32
id|part_start
)paren
(brace
r_struct
id|hfs_mdb
op_star
id|mdb
suffix:semicolon
id|hfs_buffer
id|buf
suffix:semicolon
r_struct
id|raw_mdb
op_star
id|raw
suffix:semicolon
r_int
r_int
id|bs
comma
id|block
suffix:semicolon
r_int
id|lcv
comma
id|limit
suffix:semicolon
id|hfs_buffer
op_star
id|bmbuf
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|HFS_NEW
c_func
(paren
id|mdb
)paren
)paren
(brace
id|hfs_warn
c_func
(paren
l_string|&quot;hfs_fs: out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|mdb
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|mdb
)paren
)paren
suffix:semicolon
id|mdb-&gt;magic
op_assign
id|HFS_MDB_MAGIC
suffix:semicolon
id|mdb-&gt;sys_mdb
op_assign
id|sys_mdb
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|mdb-&gt;entry_dirty
)paren
suffix:semicolon
id|hfs_init_waitqueue
c_func
(paren
op_amp
id|mdb-&gt;rename_wait
)paren
suffix:semicolon
id|hfs_init_waitqueue
c_func
(paren
op_amp
id|mdb-&gt;bitmap_wait
)paren
suffix:semicolon
multiline_comment|/* See if this is an HFS filesystem */
id|buf
op_assign
id|hfs_buffer_get
c_func
(paren
id|sys_mdb
comma
id|part_start
op_plus
id|HFS_MDB_BLK
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hfs_buffer_ok
c_func
(paren
id|buf
)paren
)paren
(brace
id|hfs_warn
c_func
(paren
l_string|&quot;hfs_fs: Unable to read superblock&bslash;n&quot;
)paren
suffix:semicolon
id|HFS_DELETE
c_func
(paren
id|mdb
)paren
suffix:semicolon
r_goto
id|bail2
suffix:semicolon
)brace
id|raw
op_assign
(paren
r_struct
id|raw_mdb
op_star
)paren
id|hfs_buffer_data
c_func
(paren
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hfs_get_ns
c_func
(paren
id|raw-&gt;drSigWord
)paren
op_ne
id|htons
c_func
(paren
id|HFS_SUPER_MAGIC
)paren
)paren
(brace
id|hfs_buffer_put
c_func
(paren
id|buf
)paren
suffix:semicolon
id|HFS_DELETE
c_func
(paren
id|mdb
)paren
suffix:semicolon
r_goto
id|bail2
suffix:semicolon
)brace
id|mdb-&gt;buf
op_assign
id|buf
suffix:semicolon
id|bs
op_assign
id|hfs_get_hl
c_func
(paren
id|raw-&gt;drAlBlkSiz
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bs
op_logical_or
(paren
id|bs
op_amp
(paren
id|HFS_SECTOR_SIZE
op_minus
l_int|1
)paren
)paren
)paren
(brace
id|hfs_warn
c_func
(paren
l_string|&quot;hfs_fs: bad allocation block size %d != 512&bslash;n&quot;
comma
id|bs
)paren
suffix:semicolon
id|hfs_buffer_put
c_func
(paren
id|buf
)paren
suffix:semicolon
id|HFS_DELETE
c_func
(paren
id|mdb
)paren
suffix:semicolon
r_goto
id|bail2
suffix:semicolon
)brace
id|mdb-&gt;alloc_blksz
op_assign
id|bs
op_rshift
id|HFS_SECTOR_SIZE_BITS
suffix:semicolon
multiline_comment|/* These parameters are read from the MDB, and never written */
id|mdb-&gt;create_date
op_assign
id|hfs_get_hl
c_func
(paren
id|raw-&gt;drCrDate
)paren
suffix:semicolon
id|mdb-&gt;fs_ablocks
op_assign
id|hfs_get_hs
c_func
(paren
id|raw-&gt;drNmAlBlks
)paren
suffix:semicolon
id|mdb-&gt;fs_start
op_assign
id|hfs_get_hs
c_func
(paren
id|raw-&gt;drAlBlSt
)paren
op_plus
id|part_start
suffix:semicolon
id|mdb-&gt;backup_date
op_assign
id|hfs_get_hl
c_func
(paren
id|raw-&gt;drVolBkUp
)paren
suffix:semicolon
id|mdb-&gt;clumpablks
op_assign
(paren
id|hfs_get_hl
c_func
(paren
id|raw-&gt;drClpSiz
)paren
op_div
id|mdb-&gt;alloc_blksz
)paren
op_rshift
id|HFS_SECTOR_SIZE_BITS
suffix:semicolon
id|memcpy
c_func
(paren
id|mdb-&gt;vname
comma
id|raw-&gt;drVN
comma
r_sizeof
(paren
id|raw-&gt;drVN
)paren
)paren
suffix:semicolon
multiline_comment|/* These parameters are read from and written to the MDB */
id|mdb-&gt;modify_date
op_assign
id|hfs_get_nl
c_func
(paren
id|raw-&gt;drLsMod
)paren
suffix:semicolon
id|mdb-&gt;attrib
op_assign
id|hfs_get_ns
c_func
(paren
id|raw-&gt;drAtrb
)paren
suffix:semicolon
id|mdb-&gt;free_ablocks
op_assign
id|hfs_get_hs
c_func
(paren
id|raw-&gt;drFreeBks
)paren
suffix:semicolon
id|mdb-&gt;next_id
op_assign
id|hfs_get_hl
c_func
(paren
id|raw-&gt;drNxtCNID
)paren
suffix:semicolon
id|mdb-&gt;write_count
op_assign
id|hfs_get_hl
c_func
(paren
id|raw-&gt;drWrCnt
)paren
suffix:semicolon
id|mdb-&gt;root_files
op_assign
id|hfs_get_hs
c_func
(paren
id|raw-&gt;drNmFls
)paren
suffix:semicolon
id|mdb-&gt;root_dirs
op_assign
id|hfs_get_hs
c_func
(paren
id|raw-&gt;drNmRtDirs
)paren
suffix:semicolon
id|mdb-&gt;file_count
op_assign
id|hfs_get_hl
c_func
(paren
id|raw-&gt;drFilCnt
)paren
suffix:semicolon
id|mdb-&gt;dir_count
op_assign
id|hfs_get_hl
c_func
(paren
id|raw-&gt;drDirCnt
)paren
suffix:semicolon
multiline_comment|/* TRY to get the alternate (backup) MDB. */
id|lcv
op_assign
id|mdb-&gt;fs_start
op_plus
id|mdb-&gt;fs_ablocks
op_star
id|mdb-&gt;alloc_blksz
suffix:semicolon
id|limit
op_assign
id|lcv
op_plus
id|mdb-&gt;alloc_blksz
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|lcv
OL
id|limit
suffix:semicolon
op_increment
id|lcv
)paren
(brace
id|buf
op_assign
id|hfs_buffer_get
c_func
(paren
id|sys_mdb
comma
id|lcv
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hfs_buffer_ok
c_func
(paren
id|buf
)paren
)paren
(brace
r_struct
id|raw_mdb
op_star
id|tmp
op_assign
(paren
r_struct
id|raw_mdb
op_star
)paren
id|hfs_buffer_data
c_func
(paren
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hfs_get_ns
c_func
(paren
id|tmp-&gt;drSigWord
)paren
op_eq
id|htons
c_func
(paren
id|HFS_SUPER_MAGIC
)paren
)paren
(brace
id|mdb-&gt;alt_buf
op_assign
id|buf
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|hfs_buffer_put
c_func
(paren
id|buf
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mdb-&gt;alt_buf
op_eq
l_int|NULL
)paren
(brace
id|hfs_warn
c_func
(paren
l_string|&quot;hfs_fs: unable to locate alternate MDB&bslash;n&quot;
)paren
suffix:semicolon
id|hfs_warn
c_func
(paren
l_string|&quot;hfs_fs: continuing without an alternate MDB&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* read in the bitmap */
id|block
op_assign
id|hfs_get_hs
c_func
(paren
id|raw-&gt;drVBMSt
)paren
op_plus
id|part_start
suffix:semicolon
id|bmbuf
op_assign
id|mdb-&gt;bitmap
suffix:semicolon
id|lcv
op_assign
(paren
id|mdb-&gt;fs_ablocks
op_plus
l_int|4095
)paren
op_div
l_int|4096
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|lcv
suffix:semicolon
op_decrement
id|lcv
comma
op_increment
id|bmbuf
comma
op_increment
id|block
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|hfs_buffer_ok
c_func
(paren
op_star
id|bmbuf
op_assign
id|hfs_buffer_get
c_func
(paren
id|sys_mdb
comma
id|block
comma
l_int|1
)paren
)paren
)paren
(brace
id|hfs_warn
c_func
(paren
l_string|&quot;hfs_fs: unable to read volume bitmap&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|bail1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|mdb-&gt;ext_tree
op_assign
id|hfs_btree_init
c_func
(paren
id|mdb
comma
id|htonl
c_func
(paren
id|HFS_EXT_CNID
)paren
comma
id|raw-&gt;drXTExtRec
comma
id|hfs_get_hl
c_func
(paren
id|raw-&gt;drXTFlSize
)paren
comma
id|hfs_get_hl
c_func
(paren
id|raw-&gt;drXTClpSiz
)paren
)paren
)paren
op_logical_or
op_logical_neg
(paren
id|mdb-&gt;cat_tree
op_assign
id|hfs_btree_init
c_func
(paren
id|mdb
comma
id|htonl
c_func
(paren
id|HFS_CAT_CNID
)paren
comma
id|raw-&gt;drCTExtRec
comma
id|hfs_get_hl
c_func
(paren
id|raw-&gt;drCTFlSize
)paren
comma
id|hfs_get_hl
c_func
(paren
id|raw-&gt;drCTClpSiz
)paren
)paren
)paren
)paren
(brace
id|hfs_warn
c_func
(paren
l_string|&quot;hfs_fs: unable to initialize data structures&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|bail1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|mdb-&gt;attrib
op_amp
id|htons
c_func
(paren
id|HFS_SB_ATTRIB_CLEAN
)paren
)paren
)paren
(brace
id|hfs_warn
c_func
(paren
l_string|&quot;hfs_fs: WARNING: mounting unclean filesystem.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|readonly
)paren
(brace
multiline_comment|/* Mark the volume uncleanly unmounted in case we crash */
id|hfs_put_ns
c_func
(paren
id|mdb-&gt;attrib
op_amp
id|htons
c_func
(paren
op_complement
id|HFS_SB_ATTRIB_CLEAN
)paren
comma
id|raw-&gt;drAtrb
)paren
suffix:semicolon
id|hfs_buffer_dirty
c_func
(paren
id|mdb-&gt;buf
)paren
suffix:semicolon
id|hfs_buffer_sync
c_func
(paren
id|mdb-&gt;buf
)paren
suffix:semicolon
)brace
r_return
id|mdb
suffix:semicolon
id|bail1
suffix:colon
id|hfs_mdb_put
c_func
(paren
id|mdb
comma
id|readonly
)paren
suffix:semicolon
id|bail2
suffix:colon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * hfs_mdb_commit()&n; *&n; * Description:&n; *   This updates the MDB on disk (look also at hfs_write_super()).&n; *   It does not check, if the superblock has been modified, or&n; *   if the filesystem has been mounted read-only. It is mainly&n; *   called by hfs_write_super() and hfs_btree_extend().&n; * Input Variable(s):&n; *   struct hfs_mdb *mdb: Pointer to the hfs MDB&n; *   int backup;&n; * Output Variable(s):&n; *   NONE&n; * Returns:&n; *   void&n; * Preconditions:&n; *   &squot;mdb&squot; points to a &quot;valid&quot; (struct hfs_mdb).&n; * Postconditions:&n; *   The HFS MDB and on disk will be updated, by copying the possibly&n; *   modified fields from the in memory MDB (in native byte order) to&n; *   the disk block buffer.&n; *   If &squot;backup&squot; is non-zero then the alternate MDB is also written&n; *   and the function doesn&squot;t return until it is actually on disk.&n; */
DECL|function|hfs_mdb_commit
r_void
id|hfs_mdb_commit
c_func
(paren
r_struct
id|hfs_mdb
op_star
id|mdb
comma
r_int
id|backup
)paren
(brace
r_struct
id|raw_mdb
op_star
id|raw
op_assign
(paren
r_struct
id|raw_mdb
op_star
)paren
id|hfs_buffer_data
c_func
(paren
id|mdb-&gt;buf
)paren
suffix:semicolon
multiline_comment|/* Commit catalog entries to buffers */
id|hfs_cat_commit
c_func
(paren
id|mdb
)paren
suffix:semicolon
multiline_comment|/* Commit B-tree data to buffers */
id|hfs_btree_commit
c_func
(paren
id|mdb-&gt;cat_tree
comma
id|raw-&gt;drCTExtRec
comma
id|raw-&gt;drCTFlSize
)paren
suffix:semicolon
id|hfs_btree_commit
c_func
(paren
id|mdb-&gt;ext_tree
comma
id|raw-&gt;drXTExtRec
comma
id|raw-&gt;drXTFlSize
)paren
suffix:semicolon
multiline_comment|/* Update write_count and modify_date */
op_increment
id|mdb-&gt;write_count
suffix:semicolon
id|mdb-&gt;modify_date
op_assign
id|hfs_time
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* These parameters may have been modified, so write them back */
id|hfs_put_nl
c_func
(paren
id|mdb-&gt;modify_date
comma
id|raw-&gt;drLsMod
)paren
suffix:semicolon
id|hfs_put_hs
c_func
(paren
id|mdb-&gt;free_ablocks
comma
id|raw-&gt;drFreeBks
)paren
suffix:semicolon
id|hfs_put_hl
c_func
(paren
id|mdb-&gt;next_id
comma
id|raw-&gt;drNxtCNID
)paren
suffix:semicolon
id|hfs_put_hl
c_func
(paren
id|mdb-&gt;write_count
comma
id|raw-&gt;drWrCnt
)paren
suffix:semicolon
id|hfs_put_hs
c_func
(paren
id|mdb-&gt;root_files
comma
id|raw-&gt;drNmFls
)paren
suffix:semicolon
id|hfs_put_hs
c_func
(paren
id|mdb-&gt;root_dirs
comma
id|raw-&gt;drNmRtDirs
)paren
suffix:semicolon
id|hfs_put_hl
c_func
(paren
id|mdb-&gt;file_count
comma
id|raw-&gt;drFilCnt
)paren
suffix:semicolon
id|hfs_put_hl
c_func
(paren
id|mdb-&gt;dir_count
comma
id|raw-&gt;drDirCnt
)paren
suffix:semicolon
multiline_comment|/* write MDB to disk */
id|hfs_buffer_dirty
c_func
(paren
id|mdb-&gt;buf
)paren
suffix:semicolon
multiline_comment|/* write the backup MDB, not returning until it is written. &n;         * we only do this when either the catalog or extents overflow&n;         * files grow. */
r_if
c_cond
(paren
id|backup
op_logical_and
id|hfs_buffer_ok
c_func
(paren
id|mdb-&gt;alt_buf
)paren
)paren
(brace
r_struct
id|raw_mdb
op_star
id|tmp
op_assign
(paren
r_struct
id|raw_mdb
op_star
)paren
id|hfs_buffer_data
c_func
(paren
id|mdb-&gt;alt_buf
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hfs_get_hl
c_func
(paren
id|tmp-&gt;drCTFlSize
)paren
OL
id|hfs_get_hl
c_func
(paren
id|raw-&gt;drCTFlSize
)paren
)paren
op_logical_or
(paren
id|hfs_get_hl
c_func
(paren
id|tmp-&gt;drXTFlSize
)paren
OL
id|hfs_get_hl
c_func
(paren
id|raw-&gt;drXTFlSize
)paren
)paren
)paren
(brace
id|memcpy
c_func
(paren
id|hfs_buffer_data
c_func
(paren
id|mdb-&gt;alt_buf
)paren
comma
id|hfs_buffer_data
c_func
(paren
id|mdb-&gt;buf
)paren
comma
id|HFS_SECTOR_SIZE
)paren
suffix:semicolon
id|hfs_buffer_dirty
c_func
(paren
id|mdb-&gt;alt_buf
)paren
suffix:semicolon
id|hfs_buffer_sync
c_func
(paren
id|mdb-&gt;alt_buf
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * hfs_mdb_put()&n; *&n; * Release the resources associated with the in-core MDB.  */
DECL|function|hfs_mdb_put
r_void
id|hfs_mdb_put
c_func
(paren
r_struct
id|hfs_mdb
op_star
id|mdb
comma
r_int
id|readonly
)paren
(brace
r_int
id|lcv
suffix:semicolon
multiline_comment|/* invalidate cached catalog entries */
id|hfs_cat_invalidate
c_func
(paren
id|mdb
)paren
suffix:semicolon
multiline_comment|/* free the B-trees */
id|hfs_btree_free
c_func
(paren
id|mdb-&gt;ext_tree
)paren
suffix:semicolon
id|hfs_btree_free
c_func
(paren
id|mdb-&gt;cat_tree
)paren
suffix:semicolon
multiline_comment|/* free the volume bitmap */
r_for
c_loop
(paren
id|lcv
op_assign
l_int|0
suffix:semicolon
id|lcv
OL
id|HFS_BM_MAXBLOCKS
suffix:semicolon
op_increment
id|lcv
)paren
(brace
id|hfs_buffer_put
c_func
(paren
id|mdb-&gt;bitmap
(braket
id|lcv
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* update volume attributes */
r_if
c_cond
(paren
op_logical_neg
id|readonly
)paren
(brace
r_struct
id|raw_mdb
op_star
id|raw
op_assign
(paren
r_struct
id|raw_mdb
op_star
)paren
id|hfs_buffer_data
c_func
(paren
id|mdb-&gt;buf
)paren
suffix:semicolon
id|hfs_put_ns
c_func
(paren
id|mdb-&gt;attrib
comma
id|raw-&gt;drAtrb
)paren
suffix:semicolon
id|hfs_buffer_dirty
c_func
(paren
id|mdb-&gt;buf
)paren
suffix:semicolon
)brace
multiline_comment|/* free the buffers holding the primary and alternate MDBs */
id|hfs_buffer_put
c_func
(paren
id|mdb-&gt;buf
)paren
suffix:semicolon
id|hfs_buffer_put
c_func
(paren
id|mdb-&gt;alt_buf
)paren
suffix:semicolon
multiline_comment|/* free the MDB */
id|HFS_DELETE
c_func
(paren
id|mdb
)paren
suffix:semicolon
)brace
eof
