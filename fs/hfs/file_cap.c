multiline_comment|/*&n; * linux/fs/hfs/file_cap.c&n; *&n; * Copyright (C) 1995-1997  Paul H. Hargrove&n; * This file may be distributed under the terms of the GNU Public License.&n; *&n; * This file contains the file_ops and inode_ops for the metadata&n; * files under the CAP representation.&n; *&n; * The source code distribution of the Columbia AppleTalk Package for&n; * UNIX, version 6.0, (CAP) was used as a specification of the&n; * location and format of files used by CAP&squot;s Aufs.  No code from CAP&n; * appears in hfs_fs.  hfs_fs is not a work ``derived&squot;&squot; from CAP in&n; * the sense of intellectual property law.&n; *&n; * &quot;XXX&quot; in a comment is a note to myself to consider changing something.&n; *&n; * In function preconditions the term &quot;valid&quot; applied to a pointer to&n; * a structure means that the pointer is non-NULL and the structure it&n; * points to has all fields initialized to consistent values.&n; */
macro_line|#include &quot;hfs.h&quot;
macro_line|#include &lt;linux/hfs_fs_sb.h&gt;
macro_line|#include &lt;linux/hfs_fs_i.h&gt;
macro_line|#include &lt;linux/hfs_fs.h&gt;
multiline_comment|/*================ Forward declarations ================*/
r_static
id|hfs_rwret_t
id|cap_info_read
c_func
(paren
r_struct
id|file
op_star
comma
r_char
op_star
comma
id|hfs_rwarg_t
comma
id|loff_t
op_star
)paren
suffix:semicolon
r_static
id|hfs_rwret_t
id|cap_info_write
c_func
(paren
r_struct
id|file
op_star
comma
r_const
r_char
op_star
comma
id|hfs_rwarg_t
comma
id|loff_t
op_star
)paren
suffix:semicolon
multiline_comment|/*================ Function-like macros ================*/
multiline_comment|/*&n; * OVERLAPS()&n; *&n; * Determines if a given range overlaps the specified structure member&n; */
DECL|macro|OVERLAPS
mdefine_line|#define OVERLAPS(START, END, TYPE, MEMB) &bslash;&n;&t;((END &gt; offsetof(TYPE, MEMB)) &amp;&amp; &bslash;&n;&t; (START &lt; offsetof(TYPE, MEMB) + sizeof(((TYPE *)0)-&gt;MEMB)))
multiline_comment|/*================ Global variables ================*/
DECL|variable|hfs_cap_info_operations
r_struct
id|file_operations
id|hfs_cap_info_operations
op_assign
(brace
id|read
suffix:colon
id|cap_info_read
comma
id|write
suffix:colon
id|cap_info_write
comma
id|fsync
suffix:colon
id|file_fsync
comma
)brace
suffix:semicolon
DECL|variable|hfs_cap_info_inode_operations
r_struct
id|inode_operations
id|hfs_cap_info_inode_operations
op_assign
(brace
id|setattr
suffix:colon
id|hfs_notify_change_cap
comma
)brace
suffix:semicolon
multiline_comment|/*================ File-local functions ================*/
multiline_comment|/*&n; * cap_build_meta()&n; *&n; * Build the metadata structure.&n; */
DECL|function|cap_build_meta
r_static
r_void
id|cap_build_meta
c_func
(paren
r_struct
id|hfs_cap_info
op_star
id|meta
comma
r_struct
id|hfs_cat_entry
op_star
id|entry
)paren
(brace
id|memset
c_func
(paren
id|meta
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|meta
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|meta-&gt;fi_fndr
comma
op_amp
id|entry-&gt;info
comma
l_int|32
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|entry-&gt;type
op_eq
id|HFS_CDR_FIL
)paren
op_logical_and
(paren
id|entry-&gt;u.file.flags
op_amp
id|HFS_FIL_LOCK
)paren
)paren
(brace
multiline_comment|/* Couple the locked bit of the file to the&n;&t;&t;   AFP {write,rename,delete} inhibit bits. */
id|hfs_put_hs
c_func
(paren
id|HFS_AFP_RDONLY
comma
id|meta-&gt;fi_attr
)paren
suffix:semicolon
)brace
id|meta-&gt;fi_magic1
op_assign
id|HFS_CAP_MAGIC1
suffix:semicolon
id|meta-&gt;fi_version
op_assign
id|HFS_CAP_VERSION
suffix:semicolon
id|meta-&gt;fi_magic
op_assign
id|HFS_CAP_MAGIC
suffix:semicolon
id|meta-&gt;fi_bitmap
op_assign
id|HFS_CAP_LONGNAME
suffix:semicolon
id|memcpy
c_func
(paren
id|meta-&gt;fi_macfilename
comma
id|entry-&gt;key.CName.Name
comma
id|entry-&gt;key.CName.Len
)paren
suffix:semicolon
id|meta-&gt;fi_datemagic
op_assign
id|HFS_CAP_DMAGIC
suffix:semicolon
id|meta-&gt;fi_datevalid
op_assign
id|HFS_CAP_MDATE
op_or
id|HFS_CAP_CDATE
suffix:semicolon
id|hfs_put_nl
c_func
(paren
id|hfs_m_to_htime
c_func
(paren
id|entry-&gt;create_date
)paren
comma
id|meta-&gt;fi_ctime
)paren
suffix:semicolon
id|hfs_put_nl
c_func
(paren
id|hfs_m_to_htime
c_func
(paren
id|entry-&gt;modify_date
)paren
comma
id|meta-&gt;fi_mtime
)paren
suffix:semicolon
id|hfs_put_nl
c_func
(paren
id|CURRENT_TIME
comma
id|meta-&gt;fi_utime
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * cap_info_read()&n; *&n; * This is the read() entry in the file_operations structure for CAP&n; * metadata files.  The purpose is to transfer up to &squot;count&squot; bytes&n; * from the file corresponding to &squot;inode&squot; beginning at offset&n; * &squot;file-&gt;f_pos&squot; to user-space at the address &squot;buf&squot;.  The return value&n; * is the number of bytes actually transferred.&n; */
DECL|function|cap_info_read
r_static
id|hfs_rwret_t
id|cap_info_read
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_char
op_star
id|buf
comma
id|hfs_rwarg_t
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|filp-&gt;f_dentry-&gt;d_inode
suffix:semicolon
r_struct
id|hfs_cat_entry
op_star
id|entry
op_assign
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|entry
suffix:semicolon
id|hfs_s32
id|left
comma
id|size
comma
id|read
op_assign
l_int|0
suffix:semicolon
id|hfs_u32
id|pos
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|S_ISREG
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
(brace
id|hfs_warn
c_func
(paren
l_string|&quot;hfs_cap_info_read: mode = %07o&bslash;n&quot;
comma
id|inode-&gt;i_mode
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|pos
op_assign
op_star
id|ppos
suffix:semicolon
r_if
c_cond
(paren
id|pos
OG
id|HFS_FORK_MAX
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|size
op_assign
id|inode-&gt;i_size
suffix:semicolon
r_if
c_cond
(paren
id|pos
OG
id|size
)paren
(brace
id|left
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|left
op_assign
id|size
op_minus
id|pos
suffix:semicolon
)brace
r_if
c_cond
(paren
id|left
OG
id|count
)paren
(brace
id|left
op_assign
id|count
suffix:semicolon
)brace
r_if
c_cond
(paren
id|left
op_le
l_int|0
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pos
OL
r_sizeof
(paren
r_struct
id|hfs_cap_info
)paren
)paren
(brace
r_int
id|memcount
op_assign
r_sizeof
(paren
r_struct
id|hfs_cap_info
)paren
op_minus
id|pos
suffix:semicolon
r_struct
id|hfs_cap_info
id|meta
suffix:semicolon
r_if
c_cond
(paren
id|memcount
OG
id|left
)paren
(brace
id|memcount
op_assign
id|left
suffix:semicolon
)brace
id|cap_build_meta
c_func
(paren
op_amp
id|meta
comma
id|entry
)paren
suffix:semicolon
id|memcount
op_sub_assign
id|copy_to_user
c_func
(paren
id|buf
comma
(paren
(paren
r_char
op_star
)paren
op_amp
id|meta
)paren
op_plus
id|pos
comma
id|memcount
)paren
suffix:semicolon
id|left
op_sub_assign
id|memcount
suffix:semicolon
id|read
op_add_assign
id|memcount
suffix:semicolon
id|pos
op_add_assign
id|memcount
suffix:semicolon
id|buf
op_add_assign
id|memcount
suffix:semicolon
)brace
r_if
c_cond
(paren
id|left
OG
l_int|0
)paren
(brace
id|clear_user
c_func
(paren
id|buf
comma
id|left
)paren
suffix:semicolon
id|pos
op_add_assign
id|left
suffix:semicolon
)brace
r_if
c_cond
(paren
id|read
)paren
(brace
id|inode-&gt;i_atime
op_assign
id|CURRENT_TIME
suffix:semicolon
op_star
id|ppos
op_assign
id|pos
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
r_return
id|read
suffix:semicolon
)brace
multiline_comment|/*&n; * cap_info_write()&n; *&n; * This is the write() entry in the file_operations structure for CAP&n; * metadata files.  The purpose is to transfer up to &squot;count&squot; bytes&n; * to the file corresponding to &squot;inode&squot; beginning at offset&n; * &squot;*ppos&squot; from user-space at the address &squot;buf&squot;.&n; * The return value is the number of bytes actually transferred.&n; */
DECL|function|cap_info_write
r_static
id|hfs_rwret_t
id|cap_info_write
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_const
r_char
op_star
id|buf
comma
id|hfs_rwarg_t
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|filp-&gt;f_dentry-&gt;d_inode
suffix:semicolon
id|hfs_u32
id|pos
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|S_ISREG
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
(brace
id|hfs_warn
c_func
(paren
l_string|&quot;hfs_file_write: mode = %07o&bslash;n&quot;
comma
id|inode-&gt;i_mode
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
op_le
l_int|0
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|pos
op_assign
(paren
id|filp-&gt;f_flags
op_amp
id|O_APPEND
)paren
ques
c_cond
id|inode-&gt;i_size
suffix:colon
op_star
id|ppos
suffix:semicolon
r_if
c_cond
(paren
id|pos
OG
id|HFS_FORK_MAX
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
op_star
id|ppos
op_add_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
op_star
id|ppos
OG
id|HFS_FORK_MAX
)paren
(brace
op_star
id|ppos
op_assign
id|HFS_FORK_MAX
suffix:semicolon
id|count
op_assign
id|HFS_FORK_MAX
op_minus
id|pos
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|ppos
OG
id|inode-&gt;i_size
)paren
id|inode-&gt;i_size
op_assign
op_star
id|ppos
suffix:semicolon
multiline_comment|/* Only deal with the part we store in memory */
r_if
c_cond
(paren
id|pos
OL
r_sizeof
(paren
r_struct
id|hfs_cap_info
)paren
)paren
(brace
r_int
id|end
comma
id|mem_count
suffix:semicolon
r_struct
id|hfs_cat_entry
op_star
id|entry
op_assign
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|entry
suffix:semicolon
r_struct
id|hfs_cap_info
id|meta
suffix:semicolon
id|mem_count
op_assign
r_sizeof
(paren
r_struct
id|hfs_cap_info
)paren
op_minus
id|pos
suffix:semicolon
r_if
c_cond
(paren
id|mem_count
OG
id|count
)paren
(brace
id|mem_count
op_assign
id|count
suffix:semicolon
)brace
id|end
op_assign
id|pos
op_plus
id|mem_count
suffix:semicolon
id|cap_build_meta
c_func
(paren
op_amp
id|meta
comma
id|entry
)paren
suffix:semicolon
id|mem_count
op_sub_assign
id|copy_from_user
c_func
(paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|meta
)paren
op_plus
id|pos
comma
id|buf
comma
id|mem_count
)paren
suffix:semicolon
multiline_comment|/* Update finder attributes if changed */
r_if
c_cond
(paren
id|OVERLAPS
c_func
(paren
id|pos
comma
id|end
comma
r_struct
id|hfs_cap_info
comma
id|fi_fndr
)paren
)paren
(brace
id|memcpy
c_func
(paren
op_amp
id|entry-&gt;info
comma
id|meta.fi_fndr
comma
l_int|32
)paren
suffix:semicolon
id|hfs_cat_mark_dirty
c_func
(paren
id|entry
)paren
suffix:semicolon
)brace
multiline_comment|/* Update file flags if changed */
r_if
c_cond
(paren
id|OVERLAPS
c_func
(paren
id|pos
comma
id|end
comma
r_struct
id|hfs_cap_info
comma
id|fi_attr
)paren
op_logical_and
(paren
id|entry-&gt;type
op_eq
id|HFS_CDR_FIL
)paren
)paren
(brace
r_int
id|locked
op_assign
id|hfs_get_ns
c_func
(paren
op_amp
id|meta.fi_attr
)paren
op_amp
id|htons
c_func
(paren
id|HFS_AFP_WRI
)paren
suffix:semicolon
id|hfs_u8
id|new_flags
suffix:semicolon
r_if
c_cond
(paren
id|locked
)paren
(brace
id|new_flags
op_assign
id|entry-&gt;u.file.flags
op_or
id|HFS_FIL_LOCK
suffix:semicolon
)brace
r_else
(brace
id|new_flags
op_assign
id|entry-&gt;u.file.flags
op_amp
op_complement
id|HFS_FIL_LOCK
suffix:semicolon
)brace
r_if
c_cond
(paren
id|new_flags
op_ne
id|entry-&gt;u.file.flags
)paren
(brace
id|entry-&gt;u.file.flags
op_assign
id|new_flags
suffix:semicolon
id|hfs_cat_mark_dirty
c_func
(paren
id|entry
)paren
suffix:semicolon
id|hfs_file_fix_mode
c_func
(paren
id|entry
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Update CrDat if changed */
r_if
c_cond
(paren
id|OVERLAPS
c_func
(paren
id|pos
comma
id|end
comma
r_struct
id|hfs_cap_info
comma
id|fi_ctime
)paren
)paren
(brace
id|entry-&gt;create_date
op_assign
id|hfs_h_to_mtime
c_func
(paren
id|hfs_get_nl
c_func
(paren
id|meta.fi_ctime
)paren
)paren
suffix:semicolon
id|hfs_cat_mark_dirty
c_func
(paren
id|entry
)paren
suffix:semicolon
)brace
multiline_comment|/* Update MdDat if changed */
r_if
c_cond
(paren
id|OVERLAPS
c_func
(paren
id|pos
comma
id|end
comma
r_struct
id|hfs_cap_info
comma
id|fi_mtime
)paren
)paren
(brace
id|entry-&gt;modify_date
op_assign
id|hfs_h_to_mtime
c_func
(paren
id|hfs_get_nl
c_func
(paren
id|meta.fi_mtime
)paren
)paren
suffix:semicolon
id|hfs_cat_mark_dirty
c_func
(paren
id|entry
)paren
suffix:semicolon
)brace
)brace
id|inode-&gt;i_mtime
op_assign
id|inode-&gt;i_ctime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
eof
