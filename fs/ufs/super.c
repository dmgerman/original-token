multiline_comment|/*&n; *  linux/fs/ufs/super.c&n; *&n; * Copyright (C) 1996&n; * Adrian Rodriguez (adrian@franklins-tower.rutgers.edu)&n; * Laboratory for Computer Science Research Computing Facility&n; * Rutgers, The State University of New Jersey&n; *&n; * Copyright (C) 1996  Eddie C. Dost  (ecd@skynet.be)&n; *&n; * Kernel module support added on 96/04/26 by&n; * Stefan Reinauer &lt;stepan@home.culture.mipt.ru&gt;&n; *&n; * Module usage counts added on 96/04/29 by&n; * Gertjan van Wingerde &lt;gertjan@cs.vu.nl&gt;&n; *&n; * Clean swab support on 19970406 by&n; * Francois-Rene Rideau &lt;fare@tunes.org&gt;&n; *&n; * 4.4BSD (FreeBSD) support added on February 1st 1998 by&n; * Niels Kristian Bech Jensen &lt;nkbj@image.dk&gt; partially based&n; * on code by Martin von Loewis &lt;martin@mira.isdn.cs.tu-berlin.de&gt;.&n; *&n; * NeXTstep support added on February 5th 1998 by&n; * Niels Kristian Bech Jensen &lt;nkbj@image.dk&gt;.&n; *&n; * write support Daniel Pirkl &lt;daniel.pirkl@email.cz&gt; 1998&n; * &n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/ufs_fs.h&gt;
macro_line|#include &lt;linux/locks.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &quot;swab.h&quot;
macro_line|#include &quot;util.h&quot;
DECL|macro|UFS_SUPER_DEBUG
macro_line|#undef UFS_SUPER_DEBUG
DECL|macro|UFS_SUPER_DEBUG_MORE
macro_line|#undef UFS_SUPER_DEBUG_MORE
macro_line|#ifdef UFS_SUPER_DEBUG
DECL|macro|UFSD
mdefine_line|#define UFSD(x) printk(&quot;(%s, %d), %s: &quot;, __FILE__, __LINE__, __FUNCTION__); printk x;
macro_line|#else
DECL|macro|UFSD
mdefine_line|#define UFSD(x)
macro_line|#endif
macro_line|#ifdef UFS_SUPER_DEBUG_MORE
multiline_comment|/*&n; * Print contents of ufs_super_block, useful for debuging&n; */
DECL|function|ufs_print_super_stuff
r_void
id|ufs_print_super_stuff
c_func
(paren
r_struct
id|ufs_super_block_first
op_star
id|usb1
comma
r_struct
id|ufs_super_block_second
op_star
id|usb2
comma
r_struct
id|ufs_super_block_third
op_star
id|usb3
comma
r_int
id|swab
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;nufs_print_super_stuff&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;size of usb:    %lu&bslash;n&quot;
comma
r_sizeof
(paren
r_struct
id|ufs_super_block
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  magic:        0x%x&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|usb3-&gt;fs_magic
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  sblkno:       %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_sblkno
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  cblkno:       %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_cblkno
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  iblkno:       %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_iblkno
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  dblkno:       %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_dblkno
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  cgoffset:     %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_cgoffset
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  ~cgmask:      0x%x&bslash;n&quot;
comma
op_complement
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_cgmask
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  size:         %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_size
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  dsize:        %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_dsize
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  ncg:          %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_ncg
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  bsize:        %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_bsize
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  fsize:        %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_fsize
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  frag:         %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_frag
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  fragshift:    %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_fragshift
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  ~fmask:       %u&bslash;n&quot;
comma
op_complement
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_fmask
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  fshift:       %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_fshift
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  sbsize:       %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_sbsize
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  spc:          %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_spc
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  cpg:          %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_cpg
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  ipg:          %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_ipg
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  fpg:          %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_fpg
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  csaddr:       %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_csaddr
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  cssize:       %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_cssize
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  cgsize:       %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_cgsize
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  fstodb:       %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_fsbtodb
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  postblformat: %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|usb3-&gt;fs_postblformat
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  nrpos:        %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|usb3-&gt;fs_nrpos
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  ndir          %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_cstotal.cs_ndir
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  nifree        %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_cstotal.cs_nifree
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  nbfree        %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_cstotal.cs_nbfree
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  nffree        %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_cstotal.cs_nffree
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Print contents of ufs_cylinder_group, useful for debuging&n; */
DECL|function|ufs_print_cylinder_stuff
r_void
id|ufs_print_cylinder_stuff
c_func
(paren
r_struct
id|ufs_cylinder_group
op_star
id|cg
comma
r_int
id|swab
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;nufs_print_cylinder_stuff&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;size of ucg: %lu&bslash;n&quot;
comma
r_sizeof
(paren
r_struct
id|ufs_cylinder_group
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  magic:       %x&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|cg-&gt;cg_magic
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  time:        %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|cg-&gt;cg_time
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  cgx:         %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|cg-&gt;cg_cgx
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  ncyl:        %u&bslash;n&quot;
comma
id|SWAB16
c_func
(paren
id|cg-&gt;cg_ncyl
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  niblk:       %u&bslash;n&quot;
comma
id|SWAB16
c_func
(paren
id|cg-&gt;cg_niblk
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  ndblk:       %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|cg-&gt;cg_ndblk
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  cs_ndir:     %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|cg-&gt;cg_cs.cs_ndir
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  cs_nbfree:   %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|cg-&gt;cg_cs.cs_nbfree
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  cs_nifree:   %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|cg-&gt;cg_cs.cs_nifree
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  cs_nffree:   %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|cg-&gt;cg_cs.cs_nffree
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  rotor:       %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|cg-&gt;cg_rotor
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  frotor:      %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|cg-&gt;cg_frotor
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  irotor:      %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|cg-&gt;cg_irotor
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  frsum:       %u, %u, %u, %u, %u, %u, %u, %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|cg-&gt;cg_frsum
(braket
l_int|0
)braket
)paren
comma
id|SWAB32
c_func
(paren
id|cg-&gt;cg_frsum
(braket
l_int|1
)braket
)paren
comma
id|SWAB32
c_func
(paren
id|cg-&gt;cg_frsum
(braket
l_int|2
)braket
)paren
comma
id|SWAB32
c_func
(paren
id|cg-&gt;cg_frsum
(braket
l_int|3
)braket
)paren
comma
id|SWAB32
c_func
(paren
id|cg-&gt;cg_frsum
(braket
l_int|4
)braket
)paren
comma
id|SWAB32
c_func
(paren
id|cg-&gt;cg_frsum
(braket
l_int|5
)braket
)paren
comma
id|SWAB32
c_func
(paren
id|cg-&gt;cg_frsum
(braket
l_int|6
)braket
)paren
comma
id|SWAB32
c_func
(paren
id|cg-&gt;cg_frsum
(braket
l_int|7
)braket
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  btotoff:     %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|cg-&gt;cg_btotoff
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  boff:        %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|cg-&gt;cg_boff
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  iuseoff:     %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|cg-&gt;cg_iusedoff
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  freeoff:     %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|cg-&gt;cg_freeoff
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  nextfreeoff: %u&bslash;n&quot;
comma
id|SWAB32
c_func
(paren
id|cg-&gt;cg_nextfreeoff
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif /* UFS_SUPER_DEBUG_MORE */
multiline_comment|/*&n; * Called while file system is mounted, read super block&n; * and create important internal structures.&n; */
DECL|function|ufs_read_super
r_struct
id|super_block
op_star
id|ufs_read_super
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_void
op_star
id|data
comma
r_int
id|silent
)paren
(brace
r_struct
id|ufs_sb_private_info
op_star
id|uspi
suffix:semicolon
r_struct
id|ufs_super_block_first
op_star
id|usb1
suffix:semicolon
r_struct
id|ufs_super_block_second
op_star
id|usb2
suffix:semicolon
r_struct
id|ufs_super_block_third
op_star
id|usb3
suffix:semicolon
r_struct
id|ufs_buffer_head
op_star
id|ubh
suffix:semicolon
r_int
r_char
op_star
id|base
comma
op_star
id|space
suffix:semicolon
r_int
id|size
comma
id|blks
comma
id|i
suffix:semicolon
r_int
id|block_size
comma
id|super_block_size
suffix:semicolon
r_int
id|flags
comma
id|swab
suffix:semicolon
id|s64
id|tmp
suffix:semicolon
r_static
r_int
id|offsets
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|96
comma
l_int|160
)brace
suffix:semicolon
multiline_comment|/* different superblock locations */
id|UFSD
c_func
(paren
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
)paren
id|uspi
op_assign
l_int|NULL
suffix:semicolon
id|ubh
op_assign
l_int|NULL
suffix:semicolon
id|base
op_assign
id|space
op_assign
l_int|NULL
suffix:semicolon
id|sb-&gt;u.ufs_sb.s_ucg
op_assign
l_int|NULL
suffix:semicolon
id|flags
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* sb-&gt;s_dev and sb-&gt;s_flags are set by our caller&n;&t; * data is the mystery argument to sys_mount()&n;&t; *&n;&t; * Our caller also sets s_dev, s_covered, s_rd_only, s_dirt,&n;&t; *   and s_type when we return.&n;&t; */
id|MOD_INC_USE_COUNT
suffix:semicolon
id|lock_super
(paren
id|sb
)paren
suffix:semicolon
id|sb-&gt;u.ufs_sb.s_uspi
op_assign
id|uspi
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|ufs_sb_private_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|uspi
)paren
r_goto
id|failed
suffix:semicolon
id|block_size
op_assign
id|BLOCK_SIZE
suffix:semicolon
id|super_block_size
op_assign
id|BLOCK_SIZE
op_star
l_int|2
suffix:semicolon
id|uspi-&gt;s_fsize
op_assign
id|block_size
suffix:semicolon
id|uspi-&gt;s_fmask
op_assign
op_complement
(paren
id|BLOCK_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|uspi-&gt;s_fshift
op_assign
id|BLOCK_SIZE_BITS
suffix:semicolon
id|uspi-&gt;s_sbsize
op_assign
id|super_block_size
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
id|uspi-&gt;s_sbbase
op_assign
id|offsets
(braket
id|i
)braket
suffix:semicolon
id|again
suffix:colon
id|set_blocksize
(paren
id|sb-&gt;s_dev
comma
id|block_size
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * read ufs super block from device&n;&t; */
id|ubh
op_assign
id|ubh_bread2
(paren
id|sb-&gt;s_dev
comma
id|uspi-&gt;s_sbbase
op_plus
id|UFS_SBLOCK
op_div
id|block_size
comma
id|super_block_size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ubh
)paren
r_goto
id|failed
suffix:semicolon
id|usb1
op_assign
id|ubh_get_usb_first
c_func
(paren
id|USPI_UBH
)paren
suffix:semicolon
id|usb2
op_assign
id|ubh_get_usb_second
c_func
(paren
id|USPI_UBH
)paren
suffix:semicolon
id|usb3
op_assign
id|ubh_get_usb_third
c_func
(paren
id|USPI_UBH
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Check ufs magic number&n;&t; * This code uses goto, because it&squot;s a lesser evil than unbalanced&n;&t; * structure in conditional code. Brought to you by Fare&squot; as a minimal&n;&t; * hack to live with Daniel&squot;s (unnecessary, IMNSHO) manual swab&n;&t; * optimization -- see swab.h.&n;&t; */
macro_line|#if defined(__LITTLE_ENDIAN) || defined(__BIG_ENDIAN) /* sane bytesex */
r_switch
c_cond
(paren
id|usb3-&gt;fs_magic
)paren
(brace
r_case
id|UFS_MAGIC
suffix:colon
id|swab
op_assign
id|UFS_NATIVE_ENDIAN
suffix:semicolon
r_goto
id|magic_found
suffix:semicolon
r_case
id|UFS_CIGAM
suffix:colon
id|swab
op_assign
id|UFS_SWABBED_ENDIAN
suffix:semicolon
r_goto
id|magic_found
suffix:semicolon
)brace
macro_line|#else /* bytesex perversion */
r_switch
c_cond
(paren
id|le32_to_cpup
c_func
(paren
op_amp
id|usb3-&gt;fs_magic
)paren
)paren
(brace
r_case
id|UFS_MAGIC
suffix:colon
id|swab
op_assign
id|UFS_LITTLE_ENDIAN
suffix:semicolon
r_goto
id|magic_found
suffix:semicolon
r_case
id|UFS_CIGAM
suffix:colon
id|swab
op_assign
id|UFS_BIG_ENDIAN
suffix:semicolon
r_goto
id|magic_found
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;&t; * Magic number not found -- try another super block location&n;&t; */
r_if
c_cond
(paren
op_increment
id|i
OL
r_sizeof
(paren
id|offsets
)paren
op_div
r_sizeof
(paren
r_int
)paren
)paren
(brace
id|ubh_brelse2
c_func
(paren
id|ubh
)paren
suffix:semicolon
id|ubh
op_assign
l_int|NULL
suffix:semicolon
id|uspi-&gt;s_sbbase
op_assign
id|offsets
(braket
id|i
)braket
suffix:semicolon
r_goto
id|again
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;ufs_read_super: &quot;
l_string|&quot;super block location not in &quot;
l_string|&quot;{ 0, 96, 160} &quot;
l_string|&quot;or bad magic number&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
id|magic_found
suffix:colon
multiline_comment|/*&n;&t; * Check block and fragment sizes&n;&t; */
id|uspi-&gt;s_bsize
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_bsize
)paren
suffix:semicolon
id|uspi-&gt;s_fsize
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_fsize
)paren
suffix:semicolon
id|uspi-&gt;s_sbsize
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_sbsize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uspi-&gt;s_bsize
op_ne
l_int|4096
op_logical_and
id|uspi-&gt;s_bsize
op_ne
l_int|8192
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ufs_read_super: fs_bsize %u != {4096, 8192}&bslash;n&quot;
comma
id|uspi-&gt;s_bsize
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
r_if
c_cond
(paren
id|uspi-&gt;s_fsize
op_ne
l_int|512
op_logical_and
id|uspi-&gt;s_fsize
op_ne
l_int|1024
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ufs_read_super: fs_fsize %u != {512, 1024}&bslash;n&quot;
comma
id|uspi-&gt;s_fsize
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Block size is not 1024. Free buffers, set block_size and&n;&t; * super_block_size to superblock-declared values, and try again.&n;&t; */
r_if
c_cond
(paren
id|uspi-&gt;s_fsize
op_ne
id|block_size
op_logical_or
id|uspi-&gt;s_sbsize
op_ne
id|super_block_size
)paren
(brace
id|ubh_brelse2
c_func
(paren
id|ubh
)paren
suffix:semicolon
id|ubh
op_assign
l_int|NULL
suffix:semicolon
id|uspi-&gt;s_fmask
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_fmask
)paren
suffix:semicolon
id|uspi-&gt;s_fshift
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_fshift
)paren
suffix:semicolon
id|block_size
op_assign
id|uspi-&gt;s_fsize
suffix:semicolon
id|super_block_size
op_assign
id|uspi-&gt;s_sbsize
suffix:semicolon
r_goto
id|again
suffix:semicolon
)brace
macro_line|#ifdef UFS_SUPER_DEBUG_MORE
id|ufs_print_super_stuff
(paren
id|usb1
comma
id|usb2
comma
id|usb3
comma
id|swab
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * Check file system flavor&n;&t; */
id|flags
op_or_assign
id|UFS_VANILLA
suffix:semicolon
multiline_comment|/* XXX more consistency check */
id|UFSD
c_func
(paren
(paren
l_string|&quot;ufs_read_super: maxsymlinklen 0x%8.8x&bslash;n&quot;
comma
id|usb3-&gt;fs_u.fs_44.fs_maxsymlinklen
)paren
)paren
r_if
c_cond
(paren
id|usb3-&gt;fs_u.fs_44.fs_maxsymlinklen
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|usb3-&gt;fs_u.fs_44.fs_inodefmt
op_ge
id|UFS_44INODEFMT
)paren
(brace
id|UFSD
c_func
(paren
(paren
l_string|&quot;Flavor: 44BSD&bslash;n&quot;
)paren
)paren
id|flags
op_or_assign
id|UFS_44BSD
suffix:semicolon
id|sb-&gt;s_flags
op_or_assign
id|MS_RDONLY
suffix:semicolon
)brace
r_else
(brace
id|UFSD
c_func
(paren
(paren
l_string|&quot;Flavor: OLD&bslash;n&quot;
)paren
)paren
id|sb-&gt;s_flags
op_or_assign
id|UFS_OLD
suffix:semicolon
multiline_comment|/* 4.2BSD */
)brace
)brace
r_else
r_if
c_cond
(paren
id|uspi-&gt;s_sbbase
OG
l_int|0
)paren
(brace
id|UFSD
c_func
(paren
(paren
l_string|&quot;Flavor: NEXT&bslash;n&quot;
)paren
)paren
id|flags
op_or_assign
id|UFS_NEXT
suffix:semicolon
id|sb-&gt;s_flags
op_or_assign
id|MS_RDONLY
suffix:semicolon
)brace
r_else
(brace
id|UFSD
c_func
(paren
(paren
l_string|&quot;Flavor: SUN&bslash;n&quot;
)paren
)paren
id|flags
op_or_assign
id|UFS_SUN
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Check whether file system was correctly unmounted.&n;&t; * If not, make it read only.&n;&t; */
r_if
c_cond
(paren
(paren
(paren
id|flags
op_amp
id|UFS_ST_MASK
)paren
op_eq
id|UFS_ST_44BSD
)paren
op_logical_or
(paren
(paren
id|flags
op_amp
id|UFS_ST_MASK
)paren
op_eq
id|UFS_ST_OLD
)paren
op_logical_or
(paren
(paren
id|flags
op_amp
id|UFS_ST_MASK
)paren
op_eq
id|UFS_ST_NEXT
)paren
op_logical_or
(paren
(paren
(paren
id|flags
op_amp
id|UFS_ST_MASK
)paren
op_eq
id|UFS_ST_SUN
)paren
op_logical_and
id|ufs_state
c_func
(paren
id|usb3
)paren
op_eq
id|UFS_FSOK
op_minus
id|usb1-&gt;fs_time
)paren
)paren
(brace
r_switch
c_cond
(paren
id|usb1-&gt;fs_clean
)paren
(brace
r_case
id|UFS_FSACTIVE
suffix:colon
multiline_comment|/* 0x00 */
id|printk
c_func
(paren
l_string|&quot;ufs_read_super: fs is active&bslash;n&quot;
)paren
suffix:semicolon
id|sb-&gt;s_flags
op_or_assign
id|MS_RDONLY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|UFS_FSCLEAN
suffix:colon
multiline_comment|/* 0x01 */
id|UFSD
c_func
(paren
(paren
l_string|&quot;ufs_read_super: fs is clean&bslash;n&quot;
)paren
)paren
r_break
suffix:semicolon
r_case
id|UFS_FSSTABLE
suffix:colon
id|UFSD
c_func
(paren
(paren
l_string|&quot;ufs_read_super: fs is stable&bslash;n&quot;
)paren
)paren
r_break
suffix:semicolon
r_case
id|UFS_FSOSF1
suffix:colon
multiline_comment|/* 0x03 */
multiline_comment|/* XXX - is this the correct interpretation under DEC OSF/1? */
id|printk
c_func
(paren
l_string|&quot;ufs_read_super: &quot;
l_string|&quot;fs is clean and stable (OSF/1)&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|UFS_FSBAD
suffix:colon
multiline_comment|/* 0xFF */
id|printk
c_func
(paren
l_string|&quot;ufs_read_super: fs is bad&bslash;n&quot;
)paren
suffix:semicolon
id|sb-&gt;s_flags
op_or_assign
id|MS_RDONLY
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;ufs_read_super: can&squot;t grok fs_clean 0x%x&bslash;n&quot;
comma
id|usb1-&gt;fs_clean
)paren
suffix:semicolon
id|sb-&gt;s_flags
op_or_assign
id|MS_RDONLY
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;ufs_read_super: fs needs fsck&bslash;n&quot;
)paren
suffix:semicolon
id|sb-&gt;s_flags
op_or_assign
id|MS_RDONLY
suffix:semicolon
)brace
id|sb-&gt;s_flags
op_and_assign
op_complement
id|MS_RDONLY
suffix:semicolon
multiline_comment|/*&n;&t; * Read ufs_super_block into internal data structures&n;&t; */
id|sb-&gt;s_blocksize
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_fsize
)paren
suffix:semicolon
id|sb-&gt;s_blocksize_bits
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_fshift
)paren
suffix:semicolon
id|sb-&gt;s_op
op_assign
op_amp
id|ufs_super_ops
suffix:semicolon
id|sb-&gt;dq_op
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* XXX */
id|sb-&gt;s_magic
op_assign
id|SWAB32
c_func
(paren
id|usb3-&gt;fs_magic
)paren
suffix:semicolon
id|uspi-&gt;s_sblkno
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_sblkno
)paren
suffix:semicolon
id|uspi-&gt;s_cblkno
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_cblkno
)paren
suffix:semicolon
id|uspi-&gt;s_iblkno
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_iblkno
)paren
suffix:semicolon
id|uspi-&gt;s_dblkno
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_dblkno
)paren
suffix:semicolon
id|uspi-&gt;s_cgoffset
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_cgoffset
)paren
suffix:semicolon
id|uspi-&gt;s_cgmask
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_cgmask
)paren
suffix:semicolon
id|uspi-&gt;s_size
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_size
)paren
suffix:semicolon
id|uspi-&gt;s_dsize
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_dsize
)paren
suffix:semicolon
id|uspi-&gt;s_ncg
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_ncg
)paren
suffix:semicolon
multiline_comment|/* s_bsize already set */
multiline_comment|/* s_fsize already set */
id|uspi-&gt;s_fpb
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_frag
)paren
suffix:semicolon
id|uspi-&gt;s_minfree
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_minfree
)paren
suffix:semicolon
id|uspi-&gt;s_bmask
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_bmask
)paren
suffix:semicolon
id|uspi-&gt;s_fmask
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_fmask
)paren
suffix:semicolon
id|uspi-&gt;s_bshift
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_bshift
)paren
suffix:semicolon
id|uspi-&gt;s_fshift
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_fshift
)paren
suffix:semicolon
id|uspi-&gt;s_fpbshift
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_fragshift
)paren
suffix:semicolon
id|uspi-&gt;s_fsbtodb
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_fsbtodb
)paren
suffix:semicolon
multiline_comment|/* s_sbsize already set */
id|uspi-&gt;s_csmask
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_csmask
)paren
suffix:semicolon
id|uspi-&gt;s_csshift
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_csshift
)paren
suffix:semicolon
id|uspi-&gt;s_nindir
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_nindir
)paren
suffix:semicolon
id|uspi-&gt;s_inopb
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_inopb
)paren
suffix:semicolon
id|uspi-&gt;s_nspf
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_nspf
)paren
suffix:semicolon
id|uspi-&gt;s_npsect
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_npsect
)paren
suffix:semicolon
id|uspi-&gt;s_interleave
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_interleave
)paren
suffix:semicolon
id|uspi-&gt;s_trackskew
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_trackskew
)paren
suffix:semicolon
id|uspi-&gt;s_csaddr
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_csaddr
)paren
suffix:semicolon
id|uspi-&gt;s_cssize
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_cssize
)paren
suffix:semicolon
id|uspi-&gt;s_cgsize
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_cgsize
)paren
suffix:semicolon
id|uspi-&gt;s_ntrak
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_ntrak
)paren
suffix:semicolon
id|uspi-&gt;s_nsect
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_nsect
)paren
suffix:semicolon
id|uspi-&gt;s_spc
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_spc
)paren
suffix:semicolon
id|uspi-&gt;s_ipg
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_ipg
)paren
suffix:semicolon
id|uspi-&gt;s_fpg
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_fpg
)paren
suffix:semicolon
id|uspi-&gt;s_cpc
op_assign
id|SWAB32
c_func
(paren
id|usb2-&gt;fs_cpc
)paren
suffix:semicolon
(paren
(paren
id|u32
op_star
)paren
op_amp
id|tmp
)paren
(braket
l_int|0
)braket
op_assign
id|usb3-&gt;fs_u.fs_sun.fs_qbmask
(braket
l_int|0
)braket
suffix:semicolon
(paren
(paren
id|u32
op_star
)paren
op_amp
id|tmp
)paren
(braket
l_int|1
)braket
op_assign
id|usb3-&gt;fs_u.fs_sun.fs_qbmask
(braket
l_int|1
)braket
suffix:semicolon
id|uspi-&gt;s_qbmask
op_assign
id|SWAB64
c_func
(paren
id|tmp
)paren
suffix:semicolon
(paren
(paren
id|u32
op_star
)paren
op_amp
id|tmp
)paren
(braket
l_int|0
)braket
op_assign
id|usb3-&gt;fs_u.fs_sun.fs_qfmask
(braket
l_int|0
)braket
suffix:semicolon
(paren
(paren
id|u32
op_star
)paren
op_amp
id|tmp
)paren
(braket
l_int|1
)braket
op_assign
id|usb3-&gt;fs_u.fs_sun.fs_qfmask
(braket
l_int|1
)braket
suffix:semicolon
id|uspi-&gt;s_qfmask
op_assign
id|SWAB64
c_func
(paren
id|tmp
)paren
suffix:semicolon
id|uspi-&gt;s_postblformat
op_assign
id|SWAB32
c_func
(paren
id|usb3-&gt;fs_postblformat
)paren
suffix:semicolon
id|uspi-&gt;s_nrpos
op_assign
id|SWAB32
c_func
(paren
id|usb3-&gt;fs_nrpos
)paren
suffix:semicolon
id|uspi-&gt;s_postbloff
op_assign
id|SWAB32
c_func
(paren
id|usb3-&gt;fs_postbloff
)paren
suffix:semicolon
id|uspi-&gt;s_rotbloff
op_assign
id|SWAB32
c_func
(paren
id|usb3-&gt;fs_rotbloff
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Compute another frequently used values&n;&t; */
id|uspi-&gt;s_fpbmask
op_assign
id|uspi-&gt;s_fpb
op_minus
l_int|1
suffix:semicolon
id|uspi-&gt;s_apbshift
op_assign
id|uspi-&gt;s_bshift
op_minus
l_int|2
suffix:semicolon
id|uspi-&gt;s_2apbshift
op_assign
id|uspi-&gt;s_apbshift
op_star
l_int|2
suffix:semicolon
id|uspi-&gt;s_3apbshift
op_assign
id|uspi-&gt;s_apbshift
op_star
l_int|3
suffix:semicolon
id|uspi-&gt;s_apb
op_assign
l_int|1
op_lshift
id|uspi-&gt;s_apbshift
suffix:semicolon
id|uspi-&gt;s_2apb
op_assign
l_int|1
op_lshift
id|uspi-&gt;s_2apbshift
suffix:semicolon
id|uspi-&gt;s_3apb
op_assign
l_int|1
op_lshift
id|uspi-&gt;s_3apbshift
suffix:semicolon
id|uspi-&gt;s_apbmask
op_assign
id|uspi-&gt;s_apb
op_minus
l_int|1
suffix:semicolon
id|uspi-&gt;s_nspfshift
op_assign
id|uspi-&gt;s_fshift
op_minus
id|UFS_SECTOR_BITS
suffix:semicolon
id|uspi-&gt;s_nspb
op_assign
id|uspi-&gt;s_nspf
op_lshift
id|uspi-&gt;s_fpbshift
suffix:semicolon
id|uspi-&gt;s_inopf
op_assign
id|uspi-&gt;s_inopb
op_rshift
id|uspi-&gt;s_fpbshift
suffix:semicolon
multiline_comment|/* we could merge back s_swab and s_flags by having&n;&t;   foo.s_flags = flags | swab; here, and #defining&n;&t;   s_swab to s_flags &amp; UFS_BYTESEX in swab.h */
id|sb-&gt;u.ufs_sb.s_flags
op_assign
id|flags
suffix:semicolon
id|sb-&gt;u.ufs_sb.s_swab
op_assign
id|swab
suffix:semicolon
id|sb-&gt;u.ufs_sb.s_rename_lock
op_assign
l_int|0
suffix:semicolon
id|sb-&gt;u.ufs_sb.s_rename_wait
op_assign
l_int|NULL
suffix:semicolon
id|sb-&gt;s_root
op_assign
id|d_alloc_root
c_func
(paren
id|iget
c_func
(paren
id|sb
comma
id|UFS_ROOTINO
)paren
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Read cs structures from (usually) first data block&n;&t; * on the device. &n;&t; */
id|size
op_assign
id|uspi-&gt;s_cssize
suffix:semicolon
id|blks
op_assign
id|howmany
c_func
(paren
id|size
comma
id|uspi-&gt;s_fsize
)paren
suffix:semicolon
id|base
op_assign
id|space
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|base
)paren
r_goto
id|failed
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|blks
suffix:semicolon
id|i
op_add_assign
id|uspi-&gt;s_fpb
)paren
(brace
id|size
op_assign
id|uspi-&gt;s_bsize
suffix:semicolon
r_if
c_cond
(paren
id|i
op_plus
id|uspi-&gt;s_fpb
OG
id|blks
)paren
id|size
op_assign
(paren
id|blks
op_minus
id|i
)paren
op_star
id|uspi-&gt;s_fsize
suffix:semicolon
id|ubh
op_assign
id|ubh_bread
c_func
(paren
id|sb-&gt;s_dev
comma
id|uspi-&gt;s_csaddr
op_plus
id|i
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ubh
)paren
r_goto
id|failed
suffix:semicolon
id|ubh_ubhcpymem
(paren
id|space
comma
id|ubh
comma
id|size
)paren
suffix:semicolon
id|sb-&gt;u.ufs_sb.s_csp
(braket
id|ufs_fragstoblks
c_func
(paren
id|i
)paren
)braket
op_assign
(paren
r_struct
id|ufs_csum
op_star
)paren
id|space
suffix:semicolon
id|space
op_add_assign
id|size
suffix:semicolon
id|ubh_brelse
(paren
id|ubh
)paren
suffix:semicolon
id|ubh
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Read cylinder group (we read only first fragment from block&n;&t; * at this time) and prepare internal data structures for cg caching.&n;&t; * XXX - something here fails on CDROMs from DEC!&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb-&gt;u.ufs_sb.s_ucg
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|buffer_head
op_star
)paren
op_star
id|uspi-&gt;s_ncg
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_goto
id|failed
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|uspi-&gt;s_ncg
suffix:semicolon
id|i
op_increment
)paren
id|sb-&gt;u.ufs_sb.s_ucg
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|UFS_MAX_GROUP_LOADED
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sb-&gt;u.ufs_sb.s_ucpi
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|sb-&gt;u.ufs_sb.s_cgno
(braket
id|i
)braket
op_assign
id|UFS_CGNO_EMPTY
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|uspi-&gt;s_ncg
suffix:semicolon
id|i
op_increment
)paren
(brace
id|UFSD
c_func
(paren
(paren
l_string|&quot;read cg %u&bslash;n&quot;
comma
id|i
)paren
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb-&gt;u.ufs_sb.s_ucg
(braket
id|i
)braket
op_assign
id|bread
(paren
id|sb-&gt;s_dev
comma
id|ufs_cgcmin
c_func
(paren
id|i
)paren
comma
id|sb-&gt;s_blocksize
)paren
)paren
)paren
r_goto
id|failed
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ufs_cg_chkmagic
(paren
(paren
r_struct
id|ufs_cylinder_group
op_star
)paren
id|sb-&gt;u.ufs_sb.s_ucg
(braket
id|i
)braket
op_member_access_from_pointer
id|b_data
)paren
)paren
r_goto
id|failed
suffix:semicolon
macro_line|#ifdef UFS_SUPER_DEBUG_MORE
id|ufs_print_cylinder_stuff
c_func
(paren
(paren
r_struct
id|ufs_cylinder_group
op_star
)paren
id|sb-&gt;u.ufs_sb.s_ucg
(braket
id|i
)braket
op_member_access_from_pointer
id|b_data
comma
id|swab
)paren
suffix:semicolon
macro_line|#endif
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|UFS_MAX_GROUP_LOADED
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb-&gt;u.ufs_sb.s_ucpi
(braket
id|i
)braket
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|ufs_cg_private_info
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_goto
id|failed
suffix:semicolon
id|sb-&gt;u.ufs_sb.s_cgno
(braket
id|i
)braket
op_assign
id|UFS_CGNO_EMPTY
suffix:semicolon
)brace
id|sb-&gt;u.ufs_sb.s_cg_loaded
op_assign
l_int|0
suffix:semicolon
id|unlock_super
c_func
(paren
id|sb
)paren
suffix:semicolon
id|UFSD
c_func
(paren
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
)paren
r_return
id|sb
suffix:semicolon
id|failed
suffix:colon
r_if
c_cond
(paren
id|ubh
)paren
id|ubh_brelse2
(paren
id|ubh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uspi
)paren
id|kfree
(paren
id|uspi
)paren
suffix:semicolon
r_if
c_cond
(paren
id|base
)paren
id|kfree
(paren
id|base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb-&gt;u.ufs_sb.s_ucg
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|uspi-&gt;s_ncg
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|sb-&gt;u.ufs_sb.s_ucg
(braket
id|i
)braket
)paren
id|brelse
(paren
id|sb-&gt;u.ufs_sb.s_ucg
(braket
id|i
)braket
)paren
suffix:semicolon
id|kfree
(paren
id|sb-&gt;u.ufs_sb.s_ucg
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|UFS_MAX_GROUP_LOADED
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|sb-&gt;u.ufs_sb.s_ucpi
(braket
id|i
)braket
)paren
id|kfree
(paren
id|sb-&gt;u.ufs_sb.s_ucpi
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|sb-&gt;s_dev
op_assign
l_int|0
suffix:semicolon
id|unlock_super
(paren
id|sb
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|UFSD
c_func
(paren
(paren
l_string|&quot;EXIT (FAILED)&bslash;n&quot;
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Put super block, release internal structures&n; */
DECL|function|ufs_put_super
r_void
id|ufs_put_super
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_struct
id|ufs_sb_private_info
op_star
id|uspi
suffix:semicolon
r_struct
id|ufs_buffer_head
op_star
id|ubh
suffix:semicolon
r_int
r_char
op_star
id|base
comma
op_star
id|space
suffix:semicolon
r_int
id|size
comma
id|blks
comma
id|i
suffix:semicolon
id|UFSD
c_func
(paren
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
)paren
id|uspi
op_assign
id|sb-&gt;u.ufs_sb.s_uspi
suffix:semicolon
id|size
op_assign
id|uspi-&gt;s_cssize
suffix:semicolon
id|blks
op_assign
id|howmany
c_func
(paren
id|size
comma
id|uspi-&gt;s_fsize
)paren
suffix:semicolon
id|base
op_assign
id|space
op_assign
(paren
r_char
op_star
)paren
id|sb-&gt;u.ufs_sb.s_csp
(braket
l_int|0
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|blks
suffix:semicolon
id|i
op_add_assign
id|uspi-&gt;s_fpb
)paren
(brace
id|size
op_assign
id|uspi-&gt;s_bsize
suffix:semicolon
r_if
c_cond
(paren
id|i
op_plus
id|uspi-&gt;s_fpb
OG
id|blks
)paren
id|size
op_assign
(paren
id|blks
op_minus
id|i
)paren
op_star
id|uspi-&gt;s_fsize
suffix:semicolon
id|ubh
op_assign
id|ubh_bread
(paren
id|sb-&gt;s_dev
comma
id|uspi-&gt;s_csaddr
op_plus
id|i
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ubh
)paren
r_goto
id|go_on
suffix:semicolon
id|ubh_memcpyubh
(paren
id|ubh
comma
id|space
comma
id|size
)paren
suffix:semicolon
id|space
op_add_assign
id|size
suffix:semicolon
id|ubh_mark_buffer_uptodate
(paren
id|ubh
comma
l_int|1
)paren
suffix:semicolon
id|ubh_mark_buffer_dirty
(paren
id|ubh
comma
l_int|0
)paren
suffix:semicolon
id|ubh_brelse
(paren
id|ubh
)paren
suffix:semicolon
)brace
id|go_on
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|UFS_MAX_GROUP_LOADED
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ufs_put_cylinder
(paren
id|sb
comma
id|i
)paren
suffix:semicolon
id|kfree
(paren
id|sb-&gt;u.ufs_sb.s_ucpi
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|uspi-&gt;s_ncg
suffix:semicolon
id|i
op_increment
)paren
id|brelse
(paren
id|sb-&gt;u.ufs_sb.s_ucg
(braket
id|i
)braket
)paren
suffix:semicolon
id|kfree
(paren
id|sb-&gt;u.ufs_sb.s_ucg
)paren
suffix:semicolon
id|kfree
(paren
id|base
)paren
suffix:semicolon
id|ubh_brelse2
(paren
id|USPI_UBH
)paren
suffix:semicolon
id|kfree
(paren
id|sb-&gt;u.ufs_sb.s_uspi
)paren
suffix:semicolon
id|sb-&gt;s_dev
op_assign
l_int|0
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Write super block to device&n; */
DECL|function|ufs_write_super
r_void
id|ufs_write_super
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_struct
id|ufs_sb_private_info
op_star
id|uspi
suffix:semicolon
r_struct
id|ufs_super_block_first
op_star
id|usb1
suffix:semicolon
r_struct
id|ufs_super_block_third
op_star
id|usb3
suffix:semicolon
r_int
id|swab
suffix:semicolon
id|UFSD
c_func
(paren
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
)paren
id|swab
op_assign
id|sb-&gt;u.ufs_sb.s_swab
suffix:semicolon
id|uspi
op_assign
id|sb-&gt;u.ufs_sb.s_uspi
suffix:semicolon
id|usb1
op_assign
id|ubh_get_usb_first
c_func
(paren
id|USPI_UBH
)paren
suffix:semicolon
id|usb3
op_assign
id|ubh_get_usb_third
c_func
(paren
id|USPI_UBH
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
)paren
(brace
r_if
c_cond
(paren
id|SWAB16
c_func
(paren
id|usb3-&gt;fs_u.fs_sun.fs_state
)paren
op_amp
id|UFS_FSOK
)paren
id|usb3-&gt;fs_u.fs_sun.fs_state
op_assign
id|SWAB16
c_func
(paren
id|SWAB16
c_func
(paren
id|usb3-&gt;fs_u.fs_sun.fs_state
)paren
op_amp
op_complement
id|UFS_FSOK
)paren
suffix:semicolon
id|usb1-&gt;fs_time
op_assign
id|SWAB32
c_func
(paren
id|CURRENT_TIME
)paren
suffix:semicolon
id|usb3-&gt;fs_u.fs_sun.fs_state
op_assign
id|SWAB32
c_func
(paren
id|UFS_FSOK
op_minus
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_time
)paren
)paren
suffix:semicolon
id|ubh_mark_buffer_dirty
(paren
id|USPI_UBH
comma
l_int|1
)paren
suffix:semicolon
)brace
id|sb-&gt;s_dirt
op_assign
l_int|0
suffix:semicolon
id|UFSD
c_func
(paren
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
)paren
)brace
multiline_comment|/*&n; * Copy some info about file system to user&n; */
DECL|function|ufs_statfs
r_int
id|ufs_statfs
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|statfs
op_star
id|buf
comma
r_int
id|bufsiz
)paren
(brace
r_struct
id|ufs_sb_private_info
op_star
id|uspi
suffix:semicolon
r_struct
id|ufs_super_block_first
op_star
id|usb1
suffix:semicolon
r_struct
id|statfs
id|tmp
suffix:semicolon
r_struct
id|statfs
op_star
id|sp
op_assign
op_amp
id|tmp
suffix:semicolon
r_int
r_int
id|used
comma
id|avail
suffix:semicolon
r_int
id|swab
suffix:semicolon
id|UFSD
c_func
(paren
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
)paren
id|swab
op_assign
id|sb-&gt;u.ufs_sb.s_swab
suffix:semicolon
id|uspi
op_assign
id|sb-&gt;u.ufs_sb.s_uspi
suffix:semicolon
id|usb1
op_assign
id|ubh_get_usb_first
(paren
id|USPI_UBH
)paren
suffix:semicolon
id|sp-&gt;f_type
op_assign
id|UFS_MAGIC
suffix:semicolon
id|sp-&gt;f_bsize
op_assign
id|sb-&gt;s_blocksize
suffix:semicolon
id|sp-&gt;f_blocks
op_assign
id|uspi-&gt;s_dsize
suffix:semicolon
id|sp-&gt;f_bfree
op_assign
(paren
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_cstotal.cs_nbfree
)paren
op_lshift
id|uspi-&gt;s_fpbshift
)paren
op_plus
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_cstotal.cs_nffree
)paren
suffix:semicolon
id|avail
op_assign
id|sp-&gt;f_blocks
op_minus
(paren
id|sp-&gt;f_blocks
op_div
l_int|100
)paren
op_star
id|uspi-&gt;s_minfree
suffix:semicolon
id|used
op_assign
id|sp-&gt;f_blocks
op_minus
id|sp-&gt;f_bfree
suffix:semicolon
r_if
c_cond
(paren
id|avail
OG
id|used
)paren
id|sp-&gt;f_bavail
op_assign
id|avail
op_minus
id|used
suffix:semicolon
r_else
id|sp-&gt;f_bavail
op_assign
l_int|0
suffix:semicolon
id|sp-&gt;f_files
op_assign
id|uspi-&gt;s_ncg
op_star
id|uspi-&gt;s_ipg
suffix:semicolon
id|sp-&gt;f_ffree
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_cstotal.cs_nifree
)paren
suffix:semicolon
id|sp-&gt;f_fsid.val
(braket
l_int|0
)braket
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_id
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|sp-&gt;f_fsid.val
(braket
l_int|1
)braket
op_assign
id|SWAB32
c_func
(paren
id|usb1-&gt;fs_id
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|sp-&gt;f_namelen
op_assign
id|UFS_MAXNAMLEN
suffix:semicolon
id|UFSD
c_func
(paren
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
)paren
r_return
id|copy_to_user
c_func
(paren
id|buf
comma
id|sp
comma
id|bufsiz
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|variable|error_buf
r_static
r_char
id|error_buf
(braket
l_int|1024
)braket
suffix:semicolon
DECL|function|ufs_warning
r_void
id|ufs_warning
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_const
r_char
op_star
id|function
comma
r_const
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
id|va_list
id|args
suffix:semicolon
id|va_start
(paren
id|args
comma
id|fmt
)paren
suffix:semicolon
id|vsprintf
(paren
id|error_buf
comma
id|fmt
comma
id|args
)paren
suffix:semicolon
id|va_end
(paren
id|args
)paren
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;UFS-fs warning (device %s): %s: %s&bslash;n&quot;
comma
id|kdevname
c_func
(paren
id|sb-&gt;s_dev
)paren
comma
id|function
comma
id|error_buf
)paren
suffix:semicolon
)brace
DECL|function|ufs_error
r_void
id|ufs_error
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_const
r_char
op_star
id|function
comma
r_const
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
r_struct
id|ufs_sb_private_info
op_star
id|uspi
suffix:semicolon
r_struct
id|ufs_super_block_first
op_star
id|usb1
suffix:semicolon
id|va_list
id|args
suffix:semicolon
id|uspi
op_assign
id|sb-&gt;u.ufs_sb.s_uspi
suffix:semicolon
id|usb1
op_assign
id|ubh_get_usb_first
c_func
(paren
id|USPI_UBH
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
)paren
(brace
id|usb1-&gt;fs_clean
op_assign
id|UFS_FSBAD
suffix:semicolon
id|ubh_mark_buffer_dirty
c_func
(paren
id|USPI_UBH
comma
l_int|1
)paren
suffix:semicolon
id|sb-&gt;s_dirt
op_assign
l_int|1
suffix:semicolon
id|sb-&gt;s_flags
op_or_assign
id|MS_RDONLY
suffix:semicolon
)brace
id|va_start
(paren
id|args
comma
id|fmt
)paren
suffix:semicolon
id|vsprintf
(paren
id|error_buf
comma
id|fmt
comma
id|args
)paren
suffix:semicolon
id|va_end
(paren
id|args
)paren
suffix:semicolon
id|printk
(paren
id|KERN_CRIT
l_string|&quot;UFS-fs error (device %s): %s: %s&bslash;n&quot;
comma
id|kdevname
c_func
(paren
id|sb-&gt;s_dev
)paren
comma
id|function
comma
id|error_buf
)paren
suffix:semicolon
)brace
DECL|function|ufs_panic
r_void
id|ufs_panic
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_const
r_char
op_star
id|function
comma
r_const
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
r_struct
id|ufs_sb_private_info
op_star
id|uspi
suffix:semicolon
r_struct
id|ufs_super_block_first
op_star
id|usb1
suffix:semicolon
id|va_list
id|args
suffix:semicolon
id|uspi
op_assign
id|sb-&gt;u.ufs_sb.s_uspi
suffix:semicolon
id|usb1
op_assign
id|ubh_get_usb_first
c_func
(paren
id|USPI_UBH
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
)paren
(brace
id|usb1-&gt;fs_clean
op_assign
id|UFS_FSBAD
suffix:semicolon
id|ubh_mark_buffer_dirty
c_func
(paren
id|USPI_UBH
comma
l_int|1
)paren
suffix:semicolon
id|sb-&gt;s_dirt
op_assign
l_int|1
suffix:semicolon
)brace
id|va_start
(paren
id|args
comma
id|fmt
)paren
suffix:semicolon
id|vsprintf
(paren
id|error_buf
comma
id|fmt
comma
id|args
)paren
suffix:semicolon
id|va_end
(paren
id|args
)paren
suffix:semicolon
multiline_comment|/* this is to prevent panic from syncing this filesystem */
r_if
c_cond
(paren
id|sb-&gt;s_lock
)paren
id|sb-&gt;s_lock
op_assign
l_int|0
suffix:semicolon
id|sb-&gt;s_flags
op_or_assign
id|MS_RDONLY
suffix:semicolon
id|printk
(paren
id|KERN_CRIT
l_string|&quot;UFS-fs panic (device %s): %s: %s&bslash;n&quot;
comma
id|kdevname
c_func
(paren
id|sb-&gt;s_dev
)paren
comma
id|function
comma
id|error_buf
)paren
suffix:semicolon
multiline_comment|/*&t;panic (&quot;UFS-fs panic (device %s): %s: %s&bslash;n&quot;, &n;&t;&t;kdevname(sb-&gt;s_dev), function, error_buf);&n;*/
)brace
DECL|variable|ufs_super_ops
r_static
r_struct
id|super_operations
id|ufs_super_ops
op_assign
(brace
id|ufs_read_inode
comma
id|ufs_write_inode
comma
id|ufs_put_inode
comma
id|ufs_delete_inode
comma
l_int|NULL
comma
multiline_comment|/* notify_change() */
id|ufs_put_super
comma
id|ufs_write_super
comma
id|ufs_statfs
comma
l_int|NULL
comma
multiline_comment|/* XXX - ufs_remount() */
)brace
suffix:semicolon
DECL|variable|ufs_fs_type
r_static
r_struct
id|file_system_type
id|ufs_fs_type
op_assign
(brace
l_string|&quot;ufs&quot;
comma
id|FS_REQUIRES_DEV
comma
id|ufs_read_super
comma
l_int|NULL
)brace
suffix:semicolon
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|init_ufs_fs
c_func
(paren
r_void
)paren
)paren
(brace
r_return
id|register_filesystem
c_func
(paren
op_amp
id|ufs_fs_type
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|EXPORT_NO_SYMBOLS
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|init_ufs_fs
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|unregister_filesystem
c_func
(paren
op_amp
id|ufs_fs_type
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
