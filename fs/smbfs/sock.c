multiline_comment|/*&n; *  sock.c&n; *&n; *  Copyright (C) 1995 by Paal-Kr. Engstad and Volker Lendecke&n; *&n; */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/smb_fs.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;net/ip.h&gt;
macro_line|#include &lt;linux/smb.h&gt;
macro_line|#include &lt;linux/smbno.h&gt;
DECL|macro|_S
mdefine_line|#define _S(nr) (1&lt;&lt;((nr)-1))
DECL|function|_recvfrom
r_static
r_int
id|_recvfrom
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
r_char
op_star
id|ubuf
comma
r_int
id|size
comma
r_int
id|noblock
comma
r_int
id|flags
comma
r_struct
id|sockaddr_in
op_star
id|sa
comma
r_int
op_star
id|addr_len
)paren
(brace
r_struct
id|iovec
id|iov
suffix:semicolon
r_struct
id|msghdr
id|msg
suffix:semicolon
id|iov.iov_base
op_assign
id|ubuf
suffix:semicolon
id|iov.iov_len
op_assign
id|size
suffix:semicolon
id|msg.msg_name
op_assign
(paren
r_void
op_star
)paren
id|sa
suffix:semicolon
id|msg.msg_namelen
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|addr_len
)paren
id|msg.msg_namelen
op_assign
op_star
id|addr_len
suffix:semicolon
id|msg.msg_accrights
op_assign
l_int|NULL
suffix:semicolon
id|msg.msg_iov
op_assign
op_amp
id|iov
suffix:semicolon
id|msg.msg_iovlen
op_assign
l_int|1
suffix:semicolon
r_return
id|sock-&gt;ops
op_member_access_from_pointer
id|recvmsg
c_func
(paren
id|sock
comma
op_amp
id|msg
comma
id|size
comma
id|noblock
comma
id|flags
comma
id|addr_len
)paren
suffix:semicolon
)brace
DECL|function|_send
r_static
r_int
id|_send
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_const
r_void
op_star
id|buff
comma
r_int
id|len
comma
r_int
id|nonblock
comma
r_int
id|flags
)paren
(brace
r_struct
id|iovec
id|iov
suffix:semicolon
r_struct
id|msghdr
id|msg
suffix:semicolon
id|iov.iov_base
op_assign
(paren
r_void
op_star
)paren
id|buff
suffix:semicolon
id|iov.iov_len
op_assign
id|len
suffix:semicolon
id|msg.msg_name
op_assign
l_int|NULL
suffix:semicolon
id|msg.msg_namelen
op_assign
l_int|0
suffix:semicolon
id|msg.msg_accrights
op_assign
l_int|NULL
suffix:semicolon
id|msg.msg_iov
op_assign
op_amp
id|iov
suffix:semicolon
id|msg.msg_iovlen
op_assign
l_int|1
suffix:semicolon
r_return
id|sock-&gt;ops
op_member_access_from_pointer
id|sendmsg
c_func
(paren
id|sock
comma
op_amp
id|msg
comma
id|len
comma
id|nonblock
comma
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|smb_data_callback
id|smb_data_callback
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
id|len
)paren
(brace
r_struct
id|socket
op_star
id|sock
op_assign
id|sk-&gt;socket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;dead
)paren
(brace
r_int
r_char
id|peek_buf
(braket
l_int|4
)braket
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
r_int
id|fs
suffix:semicolon
id|fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
id|result
op_assign
id|_recvfrom
c_func
(paren
id|sock
comma
(paren
r_void
op_star
)paren
id|peek_buf
comma
l_int|1
comma
l_int|1
comma
id|MSG_PEEK
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|result
op_ne
op_minus
id|EAGAIN
)paren
op_logical_and
(paren
id|peek_buf
(braket
l_int|0
)braket
op_eq
l_int|0x85
)paren
)paren
(brace
multiline_comment|/* got SESSION KEEP ALIVE */
id|result
op_assign
id|_recvfrom
c_func
(paren
id|sock
comma
(paren
r_void
op_star
)paren
id|peek_buf
comma
l_int|4
comma
l_int|1
comma
l_int|0
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
id|DDPRINTK
c_func
(paren
l_string|&quot;smb_data_callback:&quot;
l_string|&quot; got SESSION KEEP ALIVE&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
op_minus
id|EAGAIN
)paren
r_break
suffix:semicolon
id|result
op_assign
id|_recvfrom
c_func
(paren
id|sock
comma
(paren
r_void
op_star
)paren
id|peek_buf
comma
l_int|1
comma
l_int|1
comma
id|MSG_PEEK
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
)brace
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
op_minus
id|EAGAIN
)paren
(brace
id|wake_up_interruptible
c_func
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
)brace
)brace
)brace
r_int
DECL|function|smb_catch_keepalive
id|smb_catch_keepalive
c_func
(paren
r_struct
id|smb_server
op_star
id|server
)paren
(brace
r_struct
id|file
op_star
id|file
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_struct
id|socket
op_star
id|sock
suffix:semicolon
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_if
c_cond
(paren
(paren
id|server
op_eq
l_int|NULL
)paren
op_logical_or
(paren
(paren
id|file
op_assign
id|server-&gt;sock_file
)paren
op_eq
l_int|NULL
)paren
op_logical_or
(paren
(paren
id|inode
op_assign
id|file-&gt;f_inode
)paren
op_eq
l_int|NULL
)paren
op_logical_or
(paren
op_logical_neg
id|S_ISSOCK
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_catch_keepalive: did not get valid server!&bslash;n&quot;
)paren
suffix:semicolon
id|server-&gt;data_ready
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|sock
op_assign
op_amp
(paren
id|inode-&gt;u.socket_i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;type
op_ne
id|SOCK_STREAM
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_catch_keepalive: did not get SOCK_STREAM&bslash;n&quot;
)paren
suffix:semicolon
id|server-&gt;data_ready
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|sk
op_assign
(paren
r_struct
id|sock
op_star
)paren
(paren
id|sock-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_catch_keepalive: sk == NULL&quot;
)paren
suffix:semicolon
id|server-&gt;data_ready
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|DDPRINTK
c_func
(paren
l_string|&quot;smb_catch_keepalive.: sk-&gt;d_r = %x, server-&gt;d_r = %x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
(paren
id|sk-&gt;data_ready
)paren
comma
(paren
r_int
r_int
)paren
(paren
id|server-&gt;data_ready
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;data_ready
op_eq
id|smb_data_callback
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_catch_keepalive: already done&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|server-&gt;data_ready
op_assign
id|sk-&gt;data_ready
suffix:semicolon
id|sk-&gt;data_ready
op_assign
id|smb_data_callback
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|smb_dont_catch_keepalive
id|smb_dont_catch_keepalive
c_func
(paren
r_struct
id|smb_server
op_star
id|server
)paren
(brace
r_struct
id|file
op_star
id|file
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_struct
id|socket
op_star
id|sock
suffix:semicolon
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_if
c_cond
(paren
(paren
id|server
op_eq
l_int|NULL
)paren
op_logical_or
(paren
(paren
id|file
op_assign
id|server-&gt;sock_file
)paren
op_eq
l_int|NULL
)paren
op_logical_or
(paren
(paren
id|inode
op_assign
id|file-&gt;f_inode
)paren
op_eq
l_int|NULL
)paren
op_logical_or
(paren
op_logical_neg
id|S_ISSOCK
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_dont_catch_keepalive: &quot;
l_string|&quot;did not get valid server!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|sock
op_assign
op_amp
(paren
id|inode-&gt;u.socket_i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;type
op_ne
id|SOCK_STREAM
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_dont_catch_keepalive: did not get SOCK_STREAM&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|sk
op_assign
(paren
r_struct
id|sock
op_star
)paren
(paren
id|sock-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_dont_catch_keepalive: sk == NULL&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|server-&gt;data_ready
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_dont_catch_keepalive: &quot;
l_string|&quot;server-&gt;data_ready == NULL&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sk-&gt;data_ready
op_ne
id|smb_data_callback
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_dont_catch_keepalive: &quot;
l_string|&quot;sk-&gt;data_callback != smb_data_callback&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|DDPRINTK
c_func
(paren
l_string|&quot;smb_dont_catch_keepalive: sk-&gt;d_r = %x, server-&gt;d_r = %x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
(paren
id|sk-&gt;data_ready
)paren
comma
(paren
r_int
r_int
)paren
(paren
id|server-&gt;data_ready
)paren
)paren
suffix:semicolon
id|sk-&gt;data_ready
op_assign
id|server-&gt;data_ready
suffix:semicolon
id|server-&gt;data_ready
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * smb_receive_raw&n; * fs points to the correct segment, sock != NULL, target != NULL&n; * The smb header is only stored if want_header != 0.&n; */
r_static
r_int
DECL|function|smb_receive_raw
id|smb_receive_raw
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
r_char
op_star
id|target
comma
r_int
id|max_raw_length
comma
r_int
id|want_header
)paren
(brace
r_int
id|len
comma
id|result
suffix:semicolon
r_int
id|already_read
suffix:semicolon
r_int
r_char
id|peek_buf
(braket
l_int|4
)braket
suffix:semicolon
r_int
r_int
id|fs
suffix:semicolon
multiline_comment|/* We fool the kernel to believe&n;                                   we call from user space. */
id|re_recv
suffix:colon
id|fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
id|result
op_assign
id|_recvfrom
c_func
(paren
id|sock
comma
(paren
r_void
op_star
)paren
id|peek_buf
comma
l_int|4
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;smb_receive_raw: recv error = %d&bslash;n&quot;
comma
op_minus
id|result
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_if
c_cond
(paren
id|result
OL
l_int|4
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;smb_receive_raw: got less than 4 bytes&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|peek_buf
(braket
l_int|0
)braket
)paren
(brace
r_case
l_int|0x00
suffix:colon
r_case
l_int|0x82
suffix:colon
r_break
suffix:semicolon
r_case
l_int|0x85
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;smb_receive_raw: Got SESSION KEEP ALIVE&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|re_recv
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;smb_receive_raw: Invalid packet&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* The length in the RFC NB header is the raw data length */
id|len
op_assign
id|smb_len
c_func
(paren
id|peek_buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|max_raw_length
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_receive_raw: Received length (%d) &gt; max_xmit (%d)!&bslash;n&quot;
comma
id|len
comma
id|max_raw_length
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|want_header
op_ne
l_int|0
)paren
(brace
id|memcpy_tofs
c_func
(paren
id|target
comma
id|peek_buf
comma
l_int|4
)paren
suffix:semicolon
id|target
op_add_assign
l_int|4
suffix:semicolon
)brace
id|already_read
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|already_read
OL
id|len
)paren
(brace
id|result
op_assign
id|_recvfrom
c_func
(paren
id|sock
comma
(paren
r_void
op_star
)paren
(paren
id|target
op_plus
id|already_read
)paren
comma
id|len
op_minus
id|already_read
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_receive_raw: recvfrom error = %d&bslash;n&quot;
comma
op_minus
id|result
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|already_read
op_add_assign
id|result
suffix:semicolon
)brace
r_return
id|already_read
suffix:semicolon
)brace
multiline_comment|/*&n; * smb_receive&n; * fs points to the correct segment, server != NULL, sock!=NULL&n; */
r_static
r_int
DECL|function|smb_receive
id|smb_receive
c_func
(paren
r_struct
id|smb_server
op_star
id|server
comma
r_struct
id|socket
op_star
id|sock
)paren
(brace
r_int
id|result
suffix:semicolon
id|result
op_assign
id|smb_receive_raw
c_func
(paren
id|sock
comma
id|server-&gt;packet
comma
id|server-&gt;max_xmit
op_minus
l_int|4
comma
multiline_comment|/* max_xmit in server&n;                                                          includes NB header */
l_int|1
)paren
suffix:semicolon
multiline_comment|/* We want the header */
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_receive: receive error: %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|server-&gt;rcls
op_assign
op_star
(paren
(paren
r_int
r_char
op_star
)paren
(paren
id|server-&gt;packet
op_plus
l_int|9
)paren
)paren
suffix:semicolon
id|server-&gt;err
op_assign
op_star
(paren
(paren
r_int
r_int
op_star
)paren
(paren
id|server-&gt;packet
op_plus
l_int|11
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;rcls
op_ne
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;smb_receive: rcls=%d, err=%d&bslash;n&quot;
comma
id|server-&gt;rcls
comma
id|server-&gt;err
)paren
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * smb_receive&squot;s preconditions also apply here.&n; */
r_static
r_int
DECL|function|smb_receive_trans2
id|smb_receive_trans2
c_func
(paren
r_struct
id|smb_server
op_star
id|server
comma
r_struct
id|socket
op_star
id|sock
comma
r_int
op_star
id|data_len
comma
r_int
op_star
id|param_len
comma
r_char
op_star
op_star
id|data
comma
r_char
op_star
op_star
id|param
)paren
(brace
r_int
id|total_data
op_assign
l_int|0
suffix:semicolon
r_int
id|total_param
op_assign
l_int|0
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
r_char
op_star
id|inbuf
op_assign
id|server-&gt;packet
suffix:semicolon
op_star
id|data_len
op_assign
op_star
id|param_len
op_assign
l_int|0
suffix:semicolon
id|DDPRINTK
c_func
(paren
l_string|&quot;smb_receive_trans2: enter&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_receive
c_func
(paren
id|server
comma
id|sock
)paren
)paren
OL
l_int|0
)paren
(brace
r_return
id|result
suffix:semicolon
)brace
r_if
c_cond
(paren
id|server-&gt;rcls
op_ne
l_int|0
)paren
(brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* parse out the lengths */
id|total_data
op_assign
id|WVAL
c_func
(paren
id|inbuf
comma
id|smb_tdrcnt
)paren
suffix:semicolon
id|total_param
op_assign
id|WVAL
c_func
(paren
id|inbuf
comma
id|smb_tprcnt
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|total_data
OG
id|TRANS2_MAX_TRANSFER
)paren
op_logical_or
(paren
id|total_param
OG
id|TRANS2_MAX_TRANSFER
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_receive_trans2: data/param too long&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* allocate it */
r_if
c_cond
(paren
(paren
op_star
id|data
op_assign
id|smb_kmalloc
c_func
(paren
id|total_data
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_receive_trans2: could not alloc data area&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
op_star
id|param
op_assign
id|smb_kmalloc
c_func
(paren
id|total_param
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_receive_trans2: could not alloc param area&bslash;n&quot;
)paren
suffix:semicolon
id|smb_kfree_s
c_func
(paren
op_star
id|data
comma
id|total_data
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|DDPRINTK
c_func
(paren
l_string|&quot;smb_rec_trans2: total_data/param: %d/%d&bslash;n&quot;
comma
id|total_data
comma
id|total_param
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|WVAL
c_func
(paren
id|inbuf
comma
id|smb_prdisp
)paren
op_plus
id|WVAL
c_func
(paren
id|inbuf
comma
id|smb_prcnt
)paren
OG
id|total_param
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_receive_trans2: invalid parameters&bslash;n&quot;
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|memcpy
c_func
(paren
op_star
id|param
op_plus
id|WVAL
c_func
(paren
id|inbuf
comma
id|smb_prdisp
)paren
comma
id|smb_base
c_func
(paren
id|inbuf
)paren
op_plus
id|WVAL
c_func
(paren
id|inbuf
comma
id|smb_proff
)paren
comma
id|WVAL
c_func
(paren
id|inbuf
comma
id|smb_prcnt
)paren
)paren
suffix:semicolon
op_star
id|param_len
op_add_assign
id|WVAL
c_func
(paren
id|inbuf
comma
id|smb_prcnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|WVAL
c_func
(paren
id|inbuf
comma
id|smb_drdisp
)paren
op_plus
id|WVAL
c_func
(paren
id|inbuf
comma
id|smb_drcnt
)paren
OG
id|total_data
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_receive_trans2: invalid data block&bslash;n&quot;
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|memcpy
c_func
(paren
op_star
id|data
op_plus
id|WVAL
c_func
(paren
id|inbuf
comma
id|smb_drdisp
)paren
comma
id|smb_base
c_func
(paren
id|inbuf
)paren
op_plus
id|WVAL
c_func
(paren
id|inbuf
comma
id|smb_droff
)paren
comma
id|WVAL
c_func
(paren
id|inbuf
comma
id|smb_drcnt
)paren
)paren
suffix:semicolon
op_star
id|data_len
op_add_assign
id|WVAL
c_func
(paren
id|inbuf
comma
id|smb_drcnt
)paren
suffix:semicolon
id|DDPRINTK
c_func
(paren
l_string|&quot;smb_rec_trans2: drcnt/prcnt: %d/%d&bslash;n&quot;
comma
id|WVAL
c_func
(paren
id|inbuf
comma
id|smb_drcnt
)paren
comma
id|WVAL
c_func
(paren
id|inbuf
comma
id|smb_prcnt
)paren
)paren
suffix:semicolon
multiline_comment|/* parse out the total lengths again - they can shrink! */
r_if
c_cond
(paren
(paren
id|WVAL
c_func
(paren
id|inbuf
comma
id|smb_tdrcnt
)paren
OG
id|total_data
)paren
op_logical_or
(paren
id|WVAL
c_func
(paren
id|inbuf
comma
id|smb_tprcnt
)paren
OG
id|total_param
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_receive_trans2: data/params grew!&bslash;n&quot;
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|total_data
op_assign
id|WVAL
c_func
(paren
id|inbuf
comma
id|smb_tdrcnt
)paren
suffix:semicolon
id|total_param
op_assign
id|WVAL
c_func
(paren
id|inbuf
comma
id|smb_tprcnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|total_data
op_le
op_star
id|data_len
op_logical_and
id|total_param
op_le
op_star
id|param_len
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_receive
c_func
(paren
id|server
comma
id|sock
)paren
)paren
OL
l_int|0
)paren
(brace
r_goto
id|fail
suffix:semicolon
)brace
r_if
c_cond
(paren
id|server-&gt;rcls
op_ne
l_int|0
)paren
(brace
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
)brace
id|DDPRINTK
c_func
(paren
l_string|&quot;smb_receive_trans2: normal exit&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|fail
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;smb_receive_trans2: failed exit&bslash;n&quot;
)paren
suffix:semicolon
id|smb_kfree_s
c_func
(paren
op_star
id|param
comma
l_int|0
)paren
suffix:semicolon
op_star
id|param
op_assign
l_int|NULL
suffix:semicolon
id|smb_kfree_s
c_func
(paren
op_star
id|data
comma
l_int|0
)paren
suffix:semicolon
op_star
id|data
op_assign
l_int|NULL
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_static
r_inline
r_struct
id|socket
op_star
DECL|function|server_sock
id|server_sock
c_func
(paren
r_struct
id|smb_server
op_star
id|server
)paren
(brace
r_struct
id|file
op_star
id|file
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_if
c_cond
(paren
id|server
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|file
op_assign
id|server-&gt;sock_file
)paren
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inode
op_assign
id|file-&gt;f_inode
)paren
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
r_return
op_amp
(paren
id|inode-&gt;u.socket_i
)paren
suffix:semicolon
)brace
r_int
DECL|function|smb_release
id|smb_release
c_func
(paren
r_struct
id|smb_server
op_star
id|server
)paren
(brace
r_struct
id|socket
op_star
id|sock
op_assign
id|server_sock
c_func
(paren
id|server
)paren
suffix:semicolon
r_int
id|result
suffix:semicolon
r_if
c_cond
(paren
id|sock
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|result
op_assign
id|sock-&gt;ops
op_member_access_from_pointer
id|release
c_func
(paren
id|sock
comma
l_int|NULL
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;smb_release: sock-&gt;ops-&gt;release = %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
multiline_comment|/* inet_release does not set sock-&gt;state.  Maybe someone is&n;           confused about sock-&gt;state being SS_CONNECTED while there&n;           is nothing behind it, so I set it to SS_UNCONNECTED.*/
id|sock-&gt;state
op_assign
id|SS_UNCONNECTED
suffix:semicolon
id|result
op_assign
id|sock-&gt;ops
op_member_access_from_pointer
id|create
c_func
(paren
id|sock
comma
l_int|0
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;smb_release: sock-&gt;ops-&gt;create = %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|smb_connect
id|smb_connect
c_func
(paren
r_struct
id|smb_server
op_star
id|server
)paren
(brace
r_struct
id|socket
op_star
id|sock
op_assign
id|server_sock
c_func
(paren
id|server
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sock
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;state
op_ne
id|SS_UNCONNECTED
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;smb_connect: socket is not unconnected: %d&bslash;n&quot;
comma
id|sock-&gt;state
)paren
suffix:semicolon
)brace
r_return
id|sock-&gt;ops
op_member_access_from_pointer
id|connect
c_func
(paren
id|sock
comma
(paren
r_struct
id|sockaddr
op_star
)paren
op_amp
(paren
id|server-&gt;m.addr
)paren
comma
r_sizeof
(paren
r_struct
id|sockaddr_in
)paren
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*                                                                           */
multiline_comment|/*  This routine was once taken from nfs, which is for udp. Here TCP does     */
multiline_comment|/*  most of the ugly stuff for us (thanks, Alan!)                            */
multiline_comment|/*                                                                           */
multiline_comment|/*****************************************************************************/
r_int
DECL|function|smb_request
id|smb_request
c_func
(paren
r_struct
id|smb_server
op_star
id|server
)paren
(brace
r_int
r_int
id|old_mask
suffix:semicolon
r_int
r_int
id|fs
suffix:semicolon
multiline_comment|/* We fool the kernel to believe&n;                                   we call from user space. */
r_int
id|len
comma
id|result
comma
id|result2
suffix:semicolon
r_struct
id|socket
op_star
id|sock
op_assign
id|server_sock
c_func
(paren
id|server
)paren
suffix:semicolon
r_int
r_char
op_star
id|buffer
op_assign
(paren
id|server
op_eq
l_int|NULL
)paren
ques
c_cond
l_int|NULL
suffix:colon
id|server-&gt;packet
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sock
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|buffer
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_request: Bad server!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBADF
suffix:semicolon
)brace
r_if
c_cond
(paren
id|server-&gt;state
op_ne
id|CONN_VALID
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_dont_catch_keepalive
c_func
(paren
id|server
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|server-&gt;state
op_assign
id|CONN_INVALID
suffix:semicolon
id|smb_invalidate_all_inodes
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|len
op_assign
id|smb_len
c_func
(paren
id|buffer
)paren
op_plus
l_int|4
suffix:semicolon
id|DDPRINTK
c_func
(paren
l_string|&quot;smb_request: len = %d cmd = 0x%X&bslash;n&quot;
comma
id|len
comma
id|buffer
(braket
l_int|8
)braket
)paren
suffix:semicolon
id|old_mask
op_assign
id|current-&gt;blocked
suffix:semicolon
id|current-&gt;blocked
op_or_assign
op_complement
(paren
id|_S
c_func
(paren
id|SIGKILL
)paren
op_or
id|_S
c_func
(paren
id|SIGSTOP
)paren
)paren
suffix:semicolon
id|fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
id|result
op_assign
id|_send
c_func
(paren
id|sock
comma
(paren
r_void
op_star
)paren
id|buffer
comma
id|len
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_request: send error = %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
)brace
r_else
(brace
id|result
op_assign
id|smb_receive
c_func
(paren
id|server
comma
id|sock
)paren
suffix:semicolon
)brace
multiline_comment|/* read/write errors are handled by errno */
id|current-&gt;signal
op_and_assign
op_complement
id|_S
c_func
(paren
id|SIGPIPE
)paren
suffix:semicolon
id|current-&gt;blocked
op_assign
id|old_mask
suffix:semicolon
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result2
op_assign
id|smb_catch_keepalive
c_func
(paren
id|server
)paren
)paren
OL
l_int|0
)paren
(brace
id|result
op_assign
id|result2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|server-&gt;state
op_assign
id|CONN_INVALID
suffix:semicolon
id|smb_invalidate_all_inodes
c_func
(paren
id|server
)paren
suffix:semicolon
)brace
id|DDPRINTK
c_func
(paren
l_string|&quot;smb_request: result = %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * This is not really a trans2 request, we assume that you only have&n; * one packet to send.&n; */
r_int
DECL|function|smb_trans2_request
id|smb_trans2_request
c_func
(paren
r_struct
id|smb_server
op_star
id|server
comma
r_int
op_star
id|data_len
comma
r_int
op_star
id|param_len
comma
r_char
op_star
op_star
id|data
comma
r_char
op_star
op_star
id|param
)paren
(brace
r_int
r_int
id|old_mask
suffix:semicolon
r_int
r_int
id|fs
suffix:semicolon
multiline_comment|/* We fool the kernel to believe&n;                                   we call from user space. */
r_int
id|len
comma
id|result
comma
id|result2
suffix:semicolon
r_struct
id|socket
op_star
id|sock
op_assign
id|server_sock
c_func
(paren
id|server
)paren
suffix:semicolon
r_int
r_char
op_star
id|buffer
op_assign
(paren
id|server
op_eq
l_int|NULL
)paren
ques
c_cond
l_int|NULL
suffix:colon
id|server-&gt;packet
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sock
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|buffer
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_trans2_request: Bad server!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBADF
suffix:semicolon
)brace
r_if
c_cond
(paren
id|server-&gt;state
op_ne
id|CONN_VALID
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_dont_catch_keepalive
c_func
(paren
id|server
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|server-&gt;state
op_assign
id|CONN_INVALID
suffix:semicolon
id|smb_invalidate_all_inodes
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|len
op_assign
id|smb_len
c_func
(paren
id|buffer
)paren
op_plus
l_int|4
suffix:semicolon
id|old_mask
op_assign
id|current-&gt;blocked
suffix:semicolon
id|current-&gt;blocked
op_or_assign
op_complement
(paren
id|_S
c_func
(paren
id|SIGKILL
)paren
op_or
id|_S
c_func
(paren
id|SIGSTOP
)paren
)paren
suffix:semicolon
id|fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
id|DDPRINTK
c_func
(paren
l_string|&quot;smb_request: len = %d cmd = 0x%X&bslash;n&quot;
comma
id|len
comma
id|buffer
(braket
l_int|8
)braket
)paren
suffix:semicolon
id|result
op_assign
id|_send
c_func
(paren
id|sock
comma
(paren
r_void
op_star
)paren
id|buffer
comma
id|len
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_trans2_request: send error = %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
)brace
r_else
(brace
id|result
op_assign
id|smb_receive_trans2
c_func
(paren
id|server
comma
id|sock
comma
id|data_len
comma
id|param_len
comma
id|data
comma
id|param
)paren
suffix:semicolon
)brace
multiline_comment|/* read/write errors are handled by errno */
id|current-&gt;signal
op_and_assign
op_complement
id|_S
c_func
(paren
id|SIGPIPE
)paren
suffix:semicolon
id|current-&gt;blocked
op_assign
id|old_mask
suffix:semicolon
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result2
op_assign
id|smb_catch_keepalive
c_func
(paren
id|server
)paren
)paren
OL
l_int|0
)paren
(brace
id|result
op_assign
id|result2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|server-&gt;state
op_assign
id|CONN_INVALID
suffix:semicolon
id|smb_invalidate_all_inodes
c_func
(paren
id|server
)paren
suffix:semicolon
)brace
id|DDPRINTK
c_func
(paren
l_string|&quot;smb_trans2_request: result = %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* target must be in user space */
r_int
DECL|function|smb_request_read_raw
id|smb_request_read_raw
c_func
(paren
r_struct
id|smb_server
op_star
id|server
comma
r_int
r_char
op_star
id|target
comma
r_int
id|max_len
)paren
(brace
r_int
r_int
id|old_mask
suffix:semicolon
r_int
id|len
comma
id|result
comma
id|result2
suffix:semicolon
r_int
r_int
id|fs
suffix:semicolon
multiline_comment|/* We fool the kernel to believe&n;                                   we call from user space. */
r_struct
id|socket
op_star
id|sock
op_assign
id|server_sock
c_func
(paren
id|server
)paren
suffix:semicolon
r_int
r_char
op_star
id|buffer
op_assign
(paren
id|server
op_eq
l_int|NULL
)paren
ques
c_cond
l_int|NULL
suffix:colon
id|server-&gt;packet
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sock
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|buffer
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_request_read_raw: Bad server!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBADF
suffix:semicolon
)brace
r_if
c_cond
(paren
id|server-&gt;state
op_ne
id|CONN_VALID
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_dont_catch_keepalive
c_func
(paren
id|server
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|server-&gt;state
op_assign
id|CONN_INVALID
suffix:semicolon
id|smb_invalidate_all_inodes
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|len
op_assign
id|smb_len
c_func
(paren
id|buffer
)paren
op_plus
l_int|4
suffix:semicolon
id|old_mask
op_assign
id|current-&gt;blocked
suffix:semicolon
id|current-&gt;blocked
op_or_assign
op_complement
(paren
id|_S
c_func
(paren
id|SIGKILL
)paren
op_or
id|_S
c_func
(paren
id|SIGSTOP
)paren
)paren
suffix:semicolon
id|fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;smb_request_read_raw: len = %d cmd = 0x%X&bslash;n&quot;
comma
id|len
comma
id|buffer
(braket
l_int|8
)braket
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;smb_request_read_raw: target=%X, max_len=%d&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|target
comma
id|max_len
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;smb_request_read_raw: buffer=%X, sock=%X&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|buffer
comma
(paren
r_int
r_int
)paren
id|sock
)paren
suffix:semicolon
id|result
op_assign
id|_send
c_func
(paren
id|sock
comma
(paren
r_void
op_star
)paren
id|buffer
comma
id|len
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;smb_request_read_raw: send returned %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
multiline_comment|/* We recv into user space */
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_request_read_raw: send error = %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
)brace
r_else
(brace
id|result
op_assign
id|smb_receive_raw
c_func
(paren
id|sock
comma
id|target
comma
id|max_len
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* read/write errors are handled by errno */
id|current-&gt;signal
op_and_assign
op_complement
id|_S
c_func
(paren
id|SIGPIPE
)paren
suffix:semicolon
id|current-&gt;blocked
op_assign
id|old_mask
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result2
op_assign
id|smb_catch_keepalive
c_func
(paren
id|server
)paren
)paren
OL
l_int|0
)paren
(brace
id|result
op_assign
id|result2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|server-&gt;state
op_assign
id|CONN_INVALID
suffix:semicolon
id|smb_invalidate_all_inodes
c_func
(paren
id|server
)paren
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;smb_request_read_raw: result = %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* Source must be in user space. smb_request_write_raw assumes that&n; * the request SMBwriteBraw has been completed successfully, so that&n; * we can send the raw data now.  */
r_int
DECL|function|smb_request_write_raw
id|smb_request_write_raw
c_func
(paren
r_struct
id|smb_server
op_star
id|server
comma
r_int
r_const
r_char
op_star
id|source
comma
r_int
id|length
)paren
(brace
r_int
r_int
id|old_mask
suffix:semicolon
r_int
id|result
comma
id|result2
suffix:semicolon
r_int
r_int
id|fs
suffix:semicolon
multiline_comment|/* We fool the kernel to believe&n;                                   we call from user space. */
id|byte
id|nb_header
(braket
l_int|4
)braket
suffix:semicolon
r_struct
id|socket
op_star
id|sock
op_assign
id|server_sock
c_func
(paren
id|server
)paren
suffix:semicolon
r_int
r_char
op_star
id|buffer
op_assign
(paren
id|server
op_eq
l_int|NULL
)paren
ques
c_cond
l_int|NULL
suffix:colon
id|server-&gt;packet
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sock
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|buffer
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_request_write_raw: Bad server!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBADF
suffix:semicolon
)brace
r_if
c_cond
(paren
id|server-&gt;state
op_ne
id|CONN_VALID
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_dont_catch_keepalive
c_func
(paren
id|server
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|server-&gt;state
op_assign
id|CONN_INVALID
suffix:semicolon
id|smb_invalidate_all_inodes
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|old_mask
op_assign
id|current-&gt;blocked
suffix:semicolon
id|current-&gt;blocked
op_or_assign
op_complement
(paren
id|_S
c_func
(paren
id|SIGKILL
)paren
op_or
id|_S
c_func
(paren
id|SIGSTOP
)paren
)paren
suffix:semicolon
id|fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
id|smb_encode_smb_length
c_func
(paren
id|nb_header
comma
id|length
)paren
suffix:semicolon
id|result
op_assign
id|_send
c_func
(paren
id|sock
comma
(paren
r_void
op_star
)paren
id|nb_header
comma
l_int|4
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
l_int|4
)paren
(brace
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
multiline_comment|/* source is in user-land */
id|result
op_assign
id|_send
c_func
(paren
id|sock
comma
(paren
r_void
op_star
)paren
id|source
comma
id|length
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;smb_request_write_raw: send returned %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
id|length
)paren
(brace
id|result
op_assign
id|smb_receive
c_func
(paren
id|server
comma
id|sock
)paren
suffix:semicolon
)brace
r_else
(brace
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* read/write errors are handled by errno */
id|current-&gt;signal
op_and_assign
op_complement
id|_S
c_func
(paren
id|SIGPIPE
)paren
suffix:semicolon
id|current-&gt;blocked
op_assign
id|old_mask
suffix:semicolon
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result2
op_assign
id|smb_catch_keepalive
c_func
(paren
id|server
)paren
)paren
OL
l_int|0
)paren
(brace
id|result
op_assign
id|result2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|server-&gt;state
op_assign
id|CONN_INVALID
suffix:semicolon
id|smb_invalidate_all_inodes
c_func
(paren
id|server
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|result
OG
l_int|0
)paren
(brace
id|result
op_assign
id|length
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;smb_request_write_raw: result = %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * Overrides for Emacs so that we follow Linus&squot;s tabbing style.&n; * Emacs will notice this stuff at the end of the file and automatically&n; * adjust the settings for this buffer only.  This must remain at the end&n; * of the file.&n; * ---------------------------------------------------------------------------&n; * Local variables:&n; * c-indent-level: 8&n; * c-brace-imaginary-offset: 0&n; * c-brace-offset: -8&n; * c-argdecl-indent: 8&n; * c-label-offset: -8&n; * c-continued-statement-offset: 8&n; * c-continued-brace-offset: 0&n; * End:&n; */
eof
