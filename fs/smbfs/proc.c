multiline_comment|/*&n; *  proc.c&n; *&n; *  Copyright (C) 1995 by Paal-Kr. Engstad and Volker Lendecke&n; *&n; *  28/06/96 - Fixed long file name support (smb_proc_readdir_long) by Yuri Per&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/smbno.h&gt;
macro_line|#include &lt;linux/smb_fs.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/string.h&gt;
DECL|macro|ARCH
mdefine_line|#define ARCH i386
DECL|macro|SMB_VWV
mdefine_line|#define SMB_VWV(packet)  ((packet) + SMB_HEADER_LEN)
DECL|macro|SMB_CMD
mdefine_line|#define SMB_CMD(packet)  ((packet)[8])
DECL|macro|SMB_WCT
mdefine_line|#define SMB_WCT(packet)  ((packet)[SMB_HEADER_LEN - 1])
DECL|macro|SMB_BCC
mdefine_line|#define SMB_BCC(packet)  smb_bcc(packet)
DECL|macro|SMB_BUF
mdefine_line|#define SMB_BUF(packet)  ((packet) + SMB_HEADER_LEN + SMB_WCT(packet) * 2 + 2)
DECL|macro|SMB_DIRINFO_SIZE
mdefine_line|#define SMB_DIRINFO_SIZE 43
DECL|macro|SMB_STATUS_SIZE
mdefine_line|#define SMB_STATUS_SIZE  21
DECL|macro|HI_WORD
mdefine_line|#define HI_WORD(l) ((word)(l &gt;&gt; 16))
DECL|macro|LO_WORD
mdefine_line|#define LO_WORD(l) ((word)(l % 0xFFFF))
r_void
id|smb_printerr
c_func
(paren
r_int
r_class
comma
r_int
id|num
)paren
suffix:semicolon
r_static
r_int
id|smb_request_ok
c_func
(paren
r_struct
id|smb_server
op_star
id|s
comma
r_int
id|command
comma
r_int
id|wct
comma
r_int
id|bcc
)paren
suffix:semicolon
DECL|function|min
r_static
r_inline
r_int
id|min
c_func
(paren
r_int
id|a
comma
r_int
id|b
)paren
(brace
r_return
id|a
OL
id|b
ques
c_cond
id|a
suffix:colon
id|b
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*                                                                           */
multiline_comment|/*  Encoding/Decoding section                                                */
multiline_comment|/*                                                                           */
multiline_comment|/*****************************************************************************/
r_static
id|byte
op_star
DECL|function|smb_encode_word
id|smb_encode_word
c_func
(paren
id|byte
op_star
id|p
comma
id|word
id|data
)paren
(brace
macro_line|#if (ARCH == i386)
op_star
(paren
(paren
id|word
op_star
)paren
id|p
)paren
op_assign
id|data
suffix:semicolon
macro_line|#else
id|p
(braket
l_int|0
)braket
op_assign
id|data
op_amp
l_int|0x00ffU
suffix:semicolon
id|p
(braket
l_int|1
)braket
op_assign
(paren
id|data
op_amp
l_int|0xff00U
)paren
op_rshift
l_int|8
suffix:semicolon
macro_line|#error &quot;Non-Intel&quot;
macro_line|#endif
r_return
op_amp
id|p
(braket
l_int|2
)braket
suffix:semicolon
)brace
r_static
id|byte
op_star
DECL|function|smb_decode_word
id|smb_decode_word
c_func
(paren
id|byte
op_star
id|p
comma
id|word
op_star
id|data
)paren
(brace
macro_line|#if (ARCH == i386)
op_star
id|data
op_assign
op_star
(paren
id|word
op_star
)paren
id|p
suffix:semicolon
macro_line|#else
op_star
id|data
op_assign
(paren
id|word
)paren
id|p
(braket
l_int|0
)braket
op_or
id|p
(braket
l_int|1
)braket
op_lshift
l_int|8
suffix:semicolon
macro_line|#endif 
r_return
op_amp
id|p
(braket
l_int|2
)braket
suffix:semicolon
)brace
id|byte
op_star
DECL|function|smb_encode_smb_length
id|smb_encode_smb_length
c_func
(paren
id|byte
op_star
id|p
comma
id|dword
id|len
)paren
(brace
id|p
(braket
l_int|0
)braket
op_assign
id|p
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|p
(braket
l_int|2
)braket
op_assign
(paren
id|len
op_amp
l_int|0xFF00
)paren
op_rshift
l_int|8
suffix:semicolon
id|p
(braket
l_int|3
)braket
op_assign
(paren
id|len
op_amp
l_int|0xFF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0xFFFF
)paren
id|p
(braket
l_int|1
)braket
op_or_assign
l_int|0x01
suffix:semicolon
r_return
op_amp
id|p
(braket
l_int|4
)braket
suffix:semicolon
)brace
r_static
id|byte
op_star
DECL|function|smb_encode_dialect
id|smb_encode_dialect
c_func
(paren
id|byte
op_star
id|p
comma
r_const
id|byte
op_star
id|name
comma
r_int
id|len
)paren
(brace
op_star
id|p
op_increment
op_assign
l_int|2
suffix:semicolon
id|strcpy
c_func
(paren
id|p
comma
id|name
)paren
suffix:semicolon
r_return
id|p
op_plus
id|len
op_plus
l_int|1
suffix:semicolon
)brace
r_static
id|byte
op_star
DECL|function|smb_encode_ascii
id|smb_encode_ascii
c_func
(paren
id|byte
op_star
id|p
comma
r_const
id|byte
op_star
id|name
comma
r_int
id|len
)paren
(brace
op_star
id|p
op_increment
op_assign
l_int|4
suffix:semicolon
id|strcpy
c_func
(paren
id|p
comma
id|name
)paren
suffix:semicolon
r_return
id|p
op_plus
id|len
op_plus
l_int|1
suffix:semicolon
)brace
r_static
id|byte
op_star
DECL|function|smb_encode_vblock
id|smb_encode_vblock
c_func
(paren
id|byte
op_star
id|p
comma
r_const
id|byte
op_star
id|data
comma
id|word
id|len
comma
r_int
id|fs
)paren
(brace
op_star
id|p
op_increment
op_assign
l_int|5
suffix:semicolon
id|p
op_assign
id|smb_encode_word
c_func
(paren
id|p
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fs
)paren
id|memcpy_fromfs
c_func
(paren
id|p
comma
id|data
comma
id|len
)paren
suffix:semicolon
r_else
id|memcpy
c_func
(paren
id|p
comma
id|data
comma
id|len
)paren
suffix:semicolon
r_return
id|p
op_plus
id|len
suffix:semicolon
)brace
r_static
id|byte
op_star
DECL|function|smb_decode_data
id|smb_decode_data
c_func
(paren
id|byte
op_star
id|p
comma
id|byte
op_star
id|data
comma
id|word
op_star
id|data_len
comma
r_int
id|fs
)paren
(brace
id|word
id|len
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|p
op_eq
l_int|1
op_logical_or
op_star
id|p
op_eq
l_int|5
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_decode_data: Warning! Data block not starting &quot;
l_string|&quot;with 1 or 5&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|len
op_assign
id|WVAL
c_func
(paren
id|p
comma
l_int|1
)paren
suffix:semicolon
id|p
op_add_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|fs
)paren
id|memcpy_tofs
c_func
(paren
id|data
comma
id|p
comma
id|len
)paren
suffix:semicolon
r_else
id|memcpy
c_func
(paren
id|data
comma
id|p
comma
id|len
)paren
suffix:semicolon
op_star
id|data_len
op_assign
id|len
suffix:semicolon
r_return
id|p
op_plus
id|len
suffix:semicolon
)brace
r_static
id|byte
op_star
DECL|function|smb_name_mangle
id|smb_name_mangle
c_func
(paren
id|byte
op_star
id|p
comma
r_const
id|byte
op_star
id|name
)paren
(brace
r_int
id|len
comma
id|pad
op_assign
l_int|0
suffix:semicolon
id|len
op_assign
id|strlen
c_func
(paren
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|16
)paren
id|pad
op_assign
l_int|16
op_minus
id|len
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|2
op_star
(paren
id|len
op_plus
id|pad
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|name
)paren
(brace
op_star
id|p
op_increment
op_assign
(paren
op_star
id|name
op_rshift
l_int|4
)paren
op_plus
l_char|&squot;A&squot;
suffix:semicolon
op_star
id|p
op_increment
op_assign
(paren
op_star
id|name
op_amp
l_int|0x0F
)paren
op_plus
l_char|&squot;A&squot;
suffix:semicolon
id|name
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|pad
op_decrement
)paren
(brace
op_star
id|p
op_increment
op_assign
l_char|&squot;C&squot;
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_char|&squot;A&squot;
suffix:semicolon
)brace
op_star
id|p
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
id|p
suffix:semicolon
)brace
multiline_comment|/* The following are taken directly from msdos-fs */
multiline_comment|/* Linear day numbers of the respective 1sts in non-leap years. */
DECL|variable|day_n
r_static
r_int
id|day_n
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|31
comma
l_int|59
comma
l_int|90
comma
l_int|120
comma
l_int|151
comma
l_int|181
comma
l_int|212
comma
l_int|243
comma
l_int|273
comma
l_int|304
comma
l_int|334
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/* JanFebMarApr May Jun Jul Aug Sep Oct Nov Dec */
r_extern
r_struct
id|timezone
id|sys_tz
suffix:semicolon
r_static
r_int
DECL|function|utc2local
id|utc2local
c_func
(paren
r_int
id|time
)paren
(brace
r_return
id|time
op_minus
id|sys_tz.tz_minuteswest
op_star
l_int|60
suffix:semicolon
)brace
r_static
r_int
DECL|function|local2utc
id|local2utc
c_func
(paren
r_int
id|time
)paren
(brace
r_return
id|time
op_plus
id|sys_tz.tz_minuteswest
op_star
l_int|60
suffix:semicolon
)brace
multiline_comment|/* Convert a MS-DOS time/date pair to a UNIX date (seconds since 1 1 70). */
r_static
r_int
DECL|function|date_dos2unix
id|date_dos2unix
c_func
(paren
r_int
r_int
id|time
comma
r_int
r_int
id|date
)paren
(brace
r_int
id|month
comma
id|year
comma
id|secs
suffix:semicolon
id|month
op_assign
(paren
(paren
id|date
op_rshift
l_int|5
)paren
op_amp
l_int|15
)paren
op_minus
l_int|1
suffix:semicolon
id|year
op_assign
id|date
op_rshift
l_int|9
suffix:semicolon
id|secs
op_assign
(paren
id|time
op_amp
l_int|31
)paren
op_star
l_int|2
op_plus
l_int|60
op_star
(paren
(paren
id|time
op_rshift
l_int|5
)paren
op_amp
l_int|63
)paren
op_plus
(paren
id|time
op_rshift
l_int|11
)paren
op_star
l_int|3600
op_plus
l_int|86400
op_star
(paren
(paren
id|date
op_amp
l_int|31
)paren
op_minus
l_int|1
op_plus
id|day_n
(braket
id|month
)braket
op_plus
(paren
id|year
op_div
l_int|4
)paren
op_plus
id|year
op_star
l_int|365
op_minus
(paren
(paren
id|year
op_amp
l_int|3
)paren
op_eq
l_int|0
op_logical_and
id|month
OL
l_int|2
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
op_plus
l_int|3653
)paren
suffix:semicolon
multiline_comment|/* days since 1.1.70 plus 80&squot;s leap day */
r_return
id|local2utc
c_func
(paren
id|secs
)paren
suffix:semicolon
)brace
multiline_comment|/* Convert linear UNIX date to a MS-DOS time/date pair. */
r_static
r_void
DECL|function|date_unix2dos
id|date_unix2dos
c_func
(paren
r_int
id|unix_date
comma
r_int
r_int
op_star
id|time
comma
r_int
r_int
op_star
id|date
)paren
(brace
r_int
id|day
comma
id|year
comma
id|nl_day
comma
id|month
suffix:semicolon
id|unix_date
op_assign
id|utc2local
c_func
(paren
id|unix_date
)paren
suffix:semicolon
op_star
id|time
op_assign
(paren
id|unix_date
op_mod
l_int|60
)paren
op_div
l_int|2
op_plus
(paren
(paren
(paren
id|unix_date
op_div
l_int|60
)paren
op_mod
l_int|60
)paren
op_lshift
l_int|5
)paren
op_plus
(paren
(paren
(paren
id|unix_date
op_div
l_int|3600
)paren
op_mod
l_int|24
)paren
op_lshift
l_int|11
)paren
suffix:semicolon
id|day
op_assign
id|unix_date
op_div
l_int|86400
op_minus
l_int|3652
suffix:semicolon
id|year
op_assign
id|day
op_div
l_int|365
suffix:semicolon
r_if
c_cond
(paren
(paren
id|year
op_plus
l_int|3
)paren
op_div
l_int|4
op_plus
l_int|365
op_star
id|year
OG
id|day
)paren
id|year
op_decrement
suffix:semicolon
id|day
op_sub_assign
(paren
id|year
op_plus
l_int|3
)paren
op_div
l_int|4
op_plus
l_int|365
op_star
id|year
suffix:semicolon
r_if
c_cond
(paren
id|day
op_eq
l_int|59
op_logical_and
op_logical_neg
(paren
id|year
op_amp
l_int|3
)paren
)paren
(brace
id|nl_day
op_assign
id|day
suffix:semicolon
id|month
op_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
id|nl_day
op_assign
(paren
id|year
op_amp
l_int|3
)paren
op_logical_or
id|day
op_le
l_int|59
ques
c_cond
id|day
suffix:colon
id|day
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|month
op_assign
l_int|0
suffix:semicolon
id|month
OL
l_int|12
suffix:semicolon
id|month
op_increment
)paren
r_if
c_cond
(paren
id|day_n
(braket
id|month
)braket
OG
id|nl_day
)paren
r_break
suffix:semicolon
)brace
op_star
id|date
op_assign
id|nl_day
op_minus
id|day_n
(braket
id|month
op_minus
l_int|1
)braket
op_plus
l_int|1
op_plus
(paren
id|month
op_lshift
l_int|5
)paren
op_plus
(paren
id|year
op_lshift
l_int|9
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*                                                                           */
multiline_comment|/*  Support section.                                                         */
multiline_comment|/*                                                                           */
multiline_comment|/*****************************************************************************/
id|dword
DECL|function|smb_len
id|smb_len
c_func
(paren
id|byte
op_star
id|packet
)paren
(brace
r_return
(paren
(paren
id|packet
(braket
l_int|1
)braket
op_amp
l_int|0x1
)paren
op_lshift
l_int|16L
)paren
op_or
(paren
id|packet
(braket
l_int|2
)braket
op_lshift
l_int|8L
)paren
op_or
(paren
id|packet
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
r_static
id|word
DECL|function|smb_bcc
id|smb_bcc
c_func
(paren
id|byte
op_star
id|packet
)paren
(brace
r_int
id|pos
op_assign
id|SMB_HEADER_LEN
op_plus
id|SMB_WCT
c_func
(paren
id|packet
)paren
op_star
r_sizeof
(paren
id|word
)paren
suffix:semicolon
macro_line|#if (ARCH == i386)
r_return
op_star
(paren
(paren
id|word
op_star
)paren
(paren
(paren
id|byte
op_star
)paren
id|packet
op_plus
id|pos
)paren
)paren
suffix:semicolon
macro_line|#else
r_return
id|packet
(braket
id|pos
)braket
op_or
id|packet
(braket
id|pos
op_plus
l_int|1
)braket
op_lshift
l_int|8
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* smb_valid_packet: We check if packet fulfills the basic&n;   requirements of a smb packet */
r_static
r_int
DECL|function|smb_valid_packet
id|smb_valid_packet
c_func
(paren
id|byte
op_star
id|packet
)paren
(brace
id|DDPRINTK
c_func
(paren
l_string|&quot;len: %ld, wct: %d, bcc: %d&bslash;n&quot;
comma
id|smb_len
c_func
(paren
id|packet
)paren
comma
id|SMB_WCT
c_func
(paren
id|packet
)paren
comma
id|SMB_BCC
c_func
(paren
id|packet
)paren
)paren
suffix:semicolon
r_return
(paren
id|packet
(braket
l_int|4
)braket
op_eq
l_int|0xff
op_logical_and
id|packet
(braket
l_int|5
)braket
op_eq
l_char|&squot;S&squot;
op_logical_and
id|packet
(braket
l_int|6
)braket
op_eq
l_char|&squot;M&squot;
op_logical_and
id|packet
(braket
l_int|7
)braket
op_eq
l_char|&squot;B&squot;
op_logical_and
(paren
id|smb_len
c_func
(paren
id|packet
)paren
op_plus
l_int|4
op_eq
id|SMB_HEADER_LEN
op_plus
id|SMB_WCT
c_func
(paren
id|packet
)paren
op_star
l_int|2
op_plus
id|SMB_BCC
c_func
(paren
id|packet
)paren
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* smb_verify: We check if we got the answer we expected, and if we&n;   got enough data. If bcc == -1, we don&squot;t care. */
r_static
r_int
DECL|function|smb_verify
id|smb_verify
c_func
(paren
id|byte
op_star
id|packet
comma
r_int
id|command
comma
r_int
id|wct
comma
r_int
id|bcc
)paren
(brace
r_return
(paren
id|SMB_CMD
c_func
(paren
id|packet
)paren
op_eq
id|command
op_logical_and
id|SMB_WCT
c_func
(paren
id|packet
)paren
op_ge
id|wct
op_logical_and
(paren
id|bcc
op_eq
op_minus
l_int|1
op_logical_or
id|SMB_BCC
c_func
(paren
id|packet
)paren
op_ge
id|bcc
)paren
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
id|EIO
suffix:semicolon
)brace
r_static
r_int
DECL|function|smb_errno
id|smb_errno
c_func
(paren
r_int
id|errcls
comma
r_int
id|error
)paren
(brace
macro_line|#if DEBUG_SMB &gt; 1
r_if
c_cond
(paren
id|errcls
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_errno: &quot;
)paren
suffix:semicolon
id|smb_printerr
c_func
(paren
id|errcls
comma
id|error
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|errcls
op_eq
id|ERRDOS
)paren
r_switch
c_cond
(paren
id|error
)paren
(brace
r_case
id|ERRbadfunc
suffix:colon
r_return
id|EINVAL
suffix:semicolon
r_case
id|ERRbadfile
suffix:colon
r_return
id|ENOENT
suffix:semicolon
r_case
id|ERRbadpath
suffix:colon
r_return
id|ENOENT
suffix:semicolon
r_case
id|ERRnofids
suffix:colon
r_return
id|EMFILE
suffix:semicolon
r_case
id|ERRnoaccess
suffix:colon
r_return
id|EACCES
suffix:semicolon
r_case
id|ERRbadfid
suffix:colon
r_return
id|EBADF
suffix:semicolon
r_case
id|ERRbadmcb
suffix:colon
r_return
id|EREMOTEIO
suffix:semicolon
r_case
id|ERRnomem
suffix:colon
r_return
id|ENOMEM
suffix:semicolon
r_case
id|ERRbadmem
suffix:colon
r_return
id|EFAULT
suffix:semicolon
r_case
id|ERRbadenv
suffix:colon
r_return
id|EREMOTEIO
suffix:semicolon
r_case
id|ERRbadformat
suffix:colon
r_return
id|EREMOTEIO
suffix:semicolon
r_case
id|ERRbadaccess
suffix:colon
r_return
id|EACCES
suffix:semicolon
r_case
id|ERRbaddata
suffix:colon
r_return
id|E2BIG
suffix:semicolon
r_case
id|ERRbaddrive
suffix:colon
r_return
id|ENXIO
suffix:semicolon
r_case
id|ERRremcd
suffix:colon
r_return
id|EREMOTEIO
suffix:semicolon
r_case
id|ERRdiffdevice
suffix:colon
r_return
id|EXDEV
suffix:semicolon
r_case
id|ERRnofiles
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|ERRbadshare
suffix:colon
r_return
id|ETXTBSY
suffix:semicolon
r_case
id|ERRlock
suffix:colon
r_return
id|EDEADLK
suffix:semicolon
r_case
id|ERRfilexists
suffix:colon
r_return
id|EEXIST
suffix:semicolon
r_case
l_int|87
suffix:colon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Unknown error!! */
multiline_comment|/* This next error seems to occur on an mv when&n;&t;&t;&t; * the destination exists */
r_case
l_int|183
suffix:colon
r_return
id|EEXIST
suffix:semicolon
r_default
suffix:colon
r_return
id|EIO
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|errcls
op_eq
id|ERRSRV
)paren
r_switch
c_cond
(paren
id|error
)paren
(brace
r_case
id|ERRerror
suffix:colon
r_return
id|ENFILE
suffix:semicolon
r_case
id|ERRbadpw
suffix:colon
r_return
id|EINVAL
suffix:semicolon
r_case
id|ERRbadtype
suffix:colon
r_return
id|EIO
suffix:semicolon
r_case
id|ERRaccess
suffix:colon
r_return
id|EACCES
suffix:semicolon
r_default
suffix:colon
r_return
id|EIO
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|errcls
op_eq
id|ERRHRD
)paren
r_switch
c_cond
(paren
id|error
)paren
(brace
r_case
id|ERRnowrite
suffix:colon
r_return
id|EROFS
suffix:semicolon
r_case
id|ERRbadunit
suffix:colon
r_return
id|ENODEV
suffix:semicolon
r_case
id|ERRnotready
suffix:colon
r_return
id|EUCLEAN
suffix:semicolon
r_case
id|ERRbadcmd
suffix:colon
r_return
id|EIO
suffix:semicolon
r_case
id|ERRdata
suffix:colon
r_return
id|EIO
suffix:semicolon
r_case
id|ERRbadreq
suffix:colon
r_return
id|ERANGE
suffix:semicolon
r_case
id|ERRbadshare
suffix:colon
r_return
id|ETXTBSY
suffix:semicolon
r_case
id|ERRlock
suffix:colon
r_return
id|EDEADLK
suffix:semicolon
r_default
suffix:colon
r_return
id|EIO
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|errcls
op_eq
id|ERRCMD
)paren
r_return
id|EIO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if DEBUG_SMB &gt; 0
r_static
r_char
DECL|function|print_char
id|print_char
c_func
(paren
r_char
id|c
)paren
(brace
r_if
c_cond
(paren
(paren
id|c
OL
l_char|&squot; &squot;
)paren
op_logical_or
(paren
id|c
OG
l_char|&squot;~&squot;
)paren
)paren
r_return
l_char|&squot;.&squot;
suffix:semicolon
r_return
id|c
suffix:semicolon
)brace
r_static
r_void
DECL|function|smb_dump_packet
id|smb_dump_packet
c_func
(paren
id|byte
op_star
id|packet
)paren
(brace
r_int
id|i
comma
id|j
comma
id|len
suffix:semicolon
r_int
id|errcls
comma
id|error
suffix:semicolon
id|errcls
op_assign
(paren
r_int
)paren
id|packet
(braket
l_int|9
)braket
suffix:semicolon
id|error
op_assign
(paren
r_int
)paren
(paren
r_int
)paren
(paren
id|packet
(braket
l_int|11
)braket
op_or
id|packet
(braket
l_int|12
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;smb_len = %d  valid = %d    &bslash;n&quot;
comma
id|len
op_assign
id|smb_len
c_func
(paren
id|packet
)paren
comma
id|smb_valid_packet
c_func
(paren
id|packet
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;smb_cmd = %d  smb_wct = %d  smb_bcc = %d&bslash;n&quot;
comma
id|packet
(braket
l_int|8
)braket
comma
id|SMB_WCT
c_func
(paren
id|packet
)paren
comma
id|SMB_BCC
c_func
(paren
id|packet
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;smb_rcls = %d smb_err = %d&bslash;n&quot;
comma
id|errcls
comma
id|error
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errcls
)paren
(brace
id|smb_printerr
c_func
(paren
id|errcls
comma
id|error
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OG
l_int|100
)paren
id|len
op_assign
l_int|100
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_add_assign
l_int|10
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%03d:&quot;
comma
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
id|i
suffix:semicolon
id|j
OL
id|i
op_plus
l_int|10
suffix:semicolon
id|j
op_increment
)paren
r_if
c_cond
(paren
id|j
OL
id|len
)paren
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
id|packet
(braket
id|j
)braket
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;   &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
id|i
suffix:semicolon
id|j
OL
id|i
op_plus
l_int|10
suffix:semicolon
id|j
op_increment
)paren
r_if
c_cond
(paren
id|j
OL
id|len
)paren
id|printk
c_func
(paren
l_string|&quot;%c&quot;
comma
id|print_char
c_func
(paren
id|packet
(braket
id|j
)braket
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
r_static
r_void
DECL|function|smb_lock_server
id|smb_lock_server
c_func
(paren
r_struct
id|smb_server
op_star
id|server
)paren
(brace
r_while
c_loop
(paren
id|server-&gt;lock
)paren
id|sleep_on
c_func
(paren
op_amp
id|server-&gt;wait
)paren
suffix:semicolon
id|server-&gt;lock
op_assign
l_int|1
suffix:semicolon
)brace
r_static
r_void
DECL|function|smb_unlock_server
id|smb_unlock_server
c_func
(paren
r_struct
id|smb_server
op_star
id|server
)paren
(brace
r_if
c_cond
(paren
id|server-&gt;lock
op_ne
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_unlock_server: was not locked!&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|server-&gt;lock
op_assign
l_int|0
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|server-&gt;wait
)paren
suffix:semicolon
)brace
multiline_comment|/* smb_request_ok: We expect the server to be locked. Then we do the&n;   request and check the answer completely. When smb_request_ok&n;   returns 0, you can be quite sure that everything went well. When&n;   the answer is &lt;=0, the returned number is a valid unix errno. */
r_static
r_int
DECL|function|smb_request_ok
id|smb_request_ok
c_func
(paren
r_struct
id|smb_server
op_star
id|s
comma
r_int
id|command
comma
r_int
id|wct
comma
r_int
id|bcc
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
id|s-&gt;rcls
op_assign
l_int|0
suffix:semicolon
id|s-&gt;err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|smb_request
c_func
(paren
id|s
)paren
OL
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;smb_request failed&bslash;n&quot;
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|smb_valid_packet
c_func
(paren
id|s-&gt;packet
)paren
op_ne
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;not a valid packet!&bslash;n&quot;
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|s-&gt;rcls
op_ne
l_int|0
)paren
(brace
id|result
op_assign
op_minus
id|smb_errno
c_func
(paren
id|s-&gt;rcls
comma
id|s-&gt;err
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|smb_verify
c_func
(paren
id|s-&gt;packet
comma
id|command
comma
id|wct
comma
id|bcc
)paren
op_ne
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;smb_verify failed&bslash;n&quot;
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* smb_retry: This function should be called when smb_request_ok has&n;   indicated an error. If the error was indicated because the&n;   connection was killed, we try to reconnect. If smb_retry returns 0,&n;   the error was indicated for another reason, so a retry would not be&n;   of any use. */
r_static
r_int
DECL|function|smb_retry
id|smb_retry
c_func
(paren
r_struct
id|smb_server
op_star
id|server
)paren
(brace
r_if
c_cond
(paren
id|server-&gt;state
op_ne
id|CONN_INVALID
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|smb_release
c_func
(paren
id|server
)paren
OL
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;smb_retry: smb_release failed&bslash;n&quot;
)paren
suffix:semicolon
id|server-&gt;state
op_assign
id|CONN_RETRIED
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|smb_proc_reconnect
c_func
(paren
id|server
)paren
OL
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;smb_proc_reconnect failed&bslash;n&quot;
)paren
suffix:semicolon
id|server-&gt;state
op_assign
id|CONN_RETRIED
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|server-&gt;state
op_assign
id|CONN_VALID
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_static
r_int
DECL|function|smb_request_ok_unlock
id|smb_request_ok_unlock
c_func
(paren
r_struct
id|smb_server
op_star
id|s
comma
r_int
id|command
comma
r_int
id|wct
comma
r_int
id|bcc
)paren
(brace
r_int
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|s
comma
id|command
comma
id|wct
comma
id|bcc
)paren
suffix:semicolon
id|smb_unlock_server
c_func
(paren
id|s
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* smb_setup_header: We completely set up the packet. You only have to&n;   insert the command-specific fields */
r_static
id|byte
op_star
DECL|function|smb_setup_header
id|smb_setup_header
c_func
(paren
r_struct
id|smb_server
op_star
id|server
comma
id|byte
id|command
comma
id|word
id|wct
comma
id|word
id|bcc
)paren
(brace
id|dword
id|xmit_len
op_assign
id|SMB_HEADER_LEN
op_plus
id|wct
op_star
r_sizeof
(paren
id|word
)paren
op_plus
id|bcc
op_plus
l_int|2
suffix:semicolon
id|byte
op_star
id|p
op_assign
id|server-&gt;packet
suffix:semicolon
id|byte
op_star
id|buf
op_assign
id|server-&gt;packet
suffix:semicolon
id|p
op_assign
id|smb_encode_smb_length
c_func
(paren
id|p
comma
id|xmit_len
)paren
suffix:semicolon
id|BSET
c_func
(paren
id|p
comma
l_int|0
comma
l_int|0xff
)paren
suffix:semicolon
id|BSET
c_func
(paren
id|p
comma
l_int|1
comma
l_char|&squot;S&squot;
)paren
suffix:semicolon
id|BSET
c_func
(paren
id|p
comma
l_int|2
comma
l_char|&squot;M&squot;
)paren
suffix:semicolon
id|BSET
c_func
(paren
id|p
comma
l_int|3
comma
l_char|&squot;B&squot;
)paren
suffix:semicolon
id|BSET
c_func
(paren
id|p
comma
l_int|4
comma
id|command
)paren
suffix:semicolon
id|p
op_add_assign
l_int|5
suffix:semicolon
id|memset
c_func
(paren
id|p
comma
l_char|&squot;&bslash;0&squot;
comma
l_int|19
)paren
suffix:semicolon
id|p
op_add_assign
l_int|19
suffix:semicolon
id|p
op_add_assign
l_int|8
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_tid
comma
id|server-&gt;tid
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_pid
comma
id|server-&gt;pid
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_uid
comma
id|server-&gt;server_uid
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_mid
comma
id|server-&gt;mid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;protocol
OG
id|PROTOCOL_CORE
)paren
(brace
id|BSET
c_func
(paren
id|buf
comma
id|smb_flg
comma
l_int|0x8
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_flg2
comma
l_int|0x3
)paren
suffix:semicolon
)brace
op_star
id|p
op_increment
op_assign
id|wct
suffix:semicolon
multiline_comment|/* wct */
id|p
op_add_assign
l_int|2
op_star
id|wct
suffix:semicolon
id|WSET
c_func
(paren
id|p
comma
l_int|0
comma
id|bcc
)paren
suffix:semicolon
r_return
id|p
op_plus
l_int|2
suffix:semicolon
)brace
multiline_comment|/* smb_setup_header_exclusive waits on server-&gt;lock and locks the&n;   server, when it&squot;s free. You have to unlock it manually when you&squot;re&n;   finished with server-&gt;packet! */
r_static
id|byte
op_star
DECL|function|smb_setup_header_exclusive
id|smb_setup_header_exclusive
c_func
(paren
r_struct
id|smb_server
op_star
id|server
comma
id|byte
id|command
comma
id|word
id|wct
comma
id|word
id|bcc
)paren
(brace
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|smb_setup_header
c_func
(paren
id|server
comma
id|command
comma
id|wct
comma
id|bcc
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*                                                                           */
multiline_comment|/*  File operation section.                                                  */
multiline_comment|/*                                                                           */
multiline_comment|/*****************************************************************************/
r_int
DECL|function|smb_proc_open
id|smb_proc_open
c_func
(paren
r_struct
id|smb_server
op_star
id|server
comma
r_const
r_char
op_star
id|pathname
comma
r_int
id|len
comma
r_struct
id|smb_dirent
op_star
id|entry
)paren
(brace
r_int
id|error
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_char
op_star
id|buf
op_assign
id|server-&gt;packet
suffix:semicolon
r_const
id|word
id|o_attr
op_assign
id|aSYSTEM
op_or
id|aHIDDEN
op_or
id|aDIR
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;smb_proc_open: path=%s&bslash;n&quot;
comma
id|pathname
)paren
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry-&gt;opened
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Somebody else opened the file while we slept */
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|retry
suffix:colon
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBopen
comma
l_int|2
comma
l_int|2
op_plus
id|len
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv0
comma
l_int|0x42
)paren
suffix:semicolon
multiline_comment|/* read/write */
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv1
comma
id|o_attr
)paren
suffix:semicolon
id|smb_encode_ascii
c_func
(paren
id|p
comma
id|pathname
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBopen
comma
l_int|7
comma
l_int|0
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|smb_retry
c_func
(paren
id|server
)paren
)paren
(brace
r_goto
id|retry
suffix:semicolon
)brace
r_if
c_cond
(paren
id|error
op_ne
op_minus
id|EACCES
)paren
(brace
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBopen
comma
l_int|2
comma
l_int|2
op_plus
id|len
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv0
comma
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* read only */
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv1
comma
id|o_attr
)paren
suffix:semicolon
id|smb_encode_ascii
c_func
(paren
id|p
comma
id|pathname
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBopen
comma
l_int|7
comma
l_int|0
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|smb_retry
c_func
(paren
id|server
)paren
)paren
(brace
r_goto
id|retry
suffix:semicolon
)brace
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
)brace
multiline_comment|/* We should now have data in vwv[0..6]. */
id|entry-&gt;fileid
op_assign
id|WVAL
c_func
(paren
id|buf
comma
id|smb_vwv0
)paren
suffix:semicolon
id|entry-&gt;attr
op_assign
id|WVAL
c_func
(paren
id|buf
comma
id|smb_vwv1
)paren
suffix:semicolon
id|entry-&gt;ctime
op_assign
id|entry-&gt;atime
op_assign
id|entry-&gt;mtime
op_assign
id|local2utc
c_func
(paren
id|DVAL
c_func
(paren
id|buf
comma
id|smb_vwv2
)paren
)paren
suffix:semicolon
id|entry-&gt;size
op_assign
id|DVAL
c_func
(paren
id|buf
comma
id|smb_vwv4
)paren
suffix:semicolon
id|entry-&gt;access
op_assign
id|WVAL
c_func
(paren
id|buf
comma
id|smb_vwv6
)paren
suffix:semicolon
id|entry-&gt;opened
op_assign
l_int|1
suffix:semicolon
id|entry-&gt;access
op_and_assign
l_int|3
suffix:semicolon
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;smb_proc_open: entry-&gt;access = %d&bslash;n&quot;
comma
id|entry-&gt;access
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* smb_proc_close: in finfo-&gt;mtime we can send a modification time to&n;   the server */
r_int
DECL|function|smb_proc_close
id|smb_proc_close
c_func
(paren
r_struct
id|smb_server
op_star
id|server
comma
id|__u16
id|fileid
comma
id|__u32
id|mtime
)paren
(brace
r_char
op_star
id|buf
op_assign
id|server-&gt;packet
suffix:semicolon
id|smb_setup_header_exclusive
c_func
(paren
id|server
comma
id|SMBclose
comma
l_int|3
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv0
comma
id|fileid
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|buf
comma
id|smb_vwv1
comma
id|utc2local
c_func
(paren
id|mtime
)paren
)paren
suffix:semicolon
r_return
id|smb_request_ok_unlock
c_func
(paren
id|server
comma
id|SMBclose
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* In smb_proc_read and smb_proc_write we do not retry, because the&n;   file-id would not be valid after a reconnection. */
multiline_comment|/* smb_proc_read: fs indicates if it should be copied with&n;   memcpy_tofs. */
r_int
DECL|function|smb_proc_read
id|smb_proc_read
c_func
(paren
r_struct
id|smb_server
op_star
id|server
comma
r_struct
id|smb_dirent
op_star
id|finfo
comma
id|off_t
id|offset
comma
r_int
id|count
comma
r_char
op_star
id|data
comma
r_int
id|fs
)paren
(brace
id|word
id|returned_count
comma
id|data_len
suffix:semicolon
r_char
op_star
id|buf
op_assign
id|server-&gt;packet
suffix:semicolon
r_int
id|error
suffix:semicolon
id|smb_setup_header_exclusive
c_func
(paren
id|server
comma
id|SMBread
comma
l_int|5
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv0
comma
id|finfo-&gt;fileid
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv1
comma
id|count
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|buf
comma
id|smb_vwv2
comma
id|offset
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv4
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBread
comma
l_int|5
comma
op_minus
l_int|1
)paren
)paren
OL
l_int|0
)paren
(brace
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|returned_count
op_assign
id|WVAL
c_func
(paren
id|buf
comma
id|smb_vwv0
)paren
suffix:semicolon
id|smb_decode_data
c_func
(paren
id|SMB_BUF
c_func
(paren
id|server-&gt;packet
)paren
comma
id|data
comma
op_amp
id|data_len
comma
id|fs
)paren
suffix:semicolon
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_if
c_cond
(paren
id|returned_count
op_ne
id|data_len
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_proc_read: Warning, returned_count != data_len&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;smb_proc_read: ret_c=%d, data_len=%d&bslash;n&quot;
comma
id|returned_count
comma
id|data_len
)paren
suffix:semicolon
)brace
r_return
id|data_len
suffix:semicolon
)brace
multiline_comment|/* count must be &lt;= 65535. No error number is returned.  A result of 0&n;   indicates an error, which has to be investigated by a normal read&n;   call. */
r_int
DECL|function|smb_proc_read_raw
id|smb_proc_read_raw
c_func
(paren
r_struct
id|smb_server
op_star
id|server
comma
r_struct
id|smb_dirent
op_star
id|finfo
comma
id|off_t
id|offset
comma
r_int
id|count
comma
r_char
op_star
id|data
)paren
(brace
r_char
op_star
id|buf
op_assign
id|server-&gt;packet
suffix:semicolon
r_int
id|result
suffix:semicolon
r_if
c_cond
(paren
(paren
id|count
op_le
l_int|0
)paren
op_logical_or
(paren
id|count
OG
l_int|65535
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|smb_setup_header_exclusive
c_func
(paren
id|server
comma
id|SMBreadbraw
comma
l_int|8
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv0
comma
id|finfo-&gt;fileid
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|buf
comma
id|smb_vwv1
comma
id|offset
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv3
comma
id|count
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv4
comma
l_int|0
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|buf
comma
id|smb_vwv5
comma
l_int|0
)paren
suffix:semicolon
id|result
op_assign
id|smb_request_read_raw
c_func
(paren
id|server
comma
id|data
comma
id|count
)paren
suffix:semicolon
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|smb_proc_write
id|smb_proc_write
c_func
(paren
r_struct
id|smb_server
op_star
id|server
comma
r_struct
id|smb_dirent
op_star
id|finfo
comma
id|off_t
id|offset
comma
r_int
id|count
comma
r_const
r_char
op_star
id|data
)paren
(brace
r_int
id|res
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|buf
op_assign
id|server-&gt;packet
suffix:semicolon
id|byte
op_star
id|p
suffix:semicolon
id|p
op_assign
id|smb_setup_header_exclusive
c_func
(paren
id|server
comma
id|SMBwrite
comma
l_int|5
comma
id|count
op_plus
l_int|3
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv0
comma
id|finfo-&gt;fileid
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv1
comma
id|count
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|buf
comma
id|smb_vwv2
comma
id|offset
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv4
comma
l_int|0
)paren
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|1
suffix:semicolon
id|WSET
c_func
(paren
id|p
comma
l_int|0
comma
id|count
)paren
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
id|p
op_plus
l_int|2
comma
id|data
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBwrite
comma
l_int|1
comma
l_int|0
)paren
)paren
op_ge
l_int|0
)paren
(brace
id|res
op_assign
id|WVAL
c_func
(paren
id|buf
comma
id|smb_vwv0
)paren
suffix:semicolon
)brace
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/* count must be &lt;= 65535 */
r_int
DECL|function|smb_proc_write_raw
id|smb_proc_write_raw
c_func
(paren
r_struct
id|smb_server
op_star
id|server
comma
r_struct
id|smb_dirent
op_star
id|finfo
comma
id|off_t
id|offset
comma
r_int
id|count
comma
r_const
r_char
op_star
id|data
)paren
(brace
r_char
op_star
id|buf
op_assign
id|server-&gt;packet
suffix:semicolon
r_int
id|result
suffix:semicolon
r_if
c_cond
(paren
(paren
id|count
op_le
l_int|0
)paren
op_logical_or
(paren
id|count
OG
l_int|65535
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|smb_setup_header_exclusive
c_func
(paren
id|server
comma
id|SMBwritebraw
comma
l_int|11
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv0
comma
id|finfo-&gt;fileid
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv1
comma
id|count
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv2
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* reserved */
id|DSET
c_func
(paren
id|buf
comma
id|smb_vwv3
comma
id|offset
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|buf
comma
id|smb_vwv5
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* timeout */
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv7
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* send final result response */
id|DSET
c_func
(paren
id|buf
comma
id|smb_vwv8
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* reserved */
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv10
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* no data in this buf */
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv11
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* no data in this buf */
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBwritebraw
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;smb_proc_write_raw: first request returned %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|result
op_assign
id|smb_request_write_raw
c_func
(paren
id|server
comma
id|data
comma
id|count
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;smb_proc_write_raw: raw request returned %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OG
l_int|0
)paren
(brace
multiline_comment|/* We have to do the checks of smb_request_ok here as well */
r_if
c_cond
(paren
id|smb_valid_packet
c_func
(paren
id|server-&gt;packet
)paren
op_ne
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;not a valid packet!&bslash;n&quot;
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|server-&gt;rcls
op_ne
l_int|0
)paren
(brace
id|result
op_assign
op_minus
id|smb_errno
c_func
(paren
id|server-&gt;rcls
comma
id|server-&gt;err
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|smb_verify
c_func
(paren
id|server-&gt;packet
comma
id|SMBwritec
comma
l_int|1
comma
l_int|0
)paren
op_ne
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;smb_verify failed&bslash;n&quot;
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
)brace
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* smb_proc_create: We expect entry-&gt;attr &amp; entry-&gt;ctime to be set. */
r_int
DECL|function|smb_proc_create
id|smb_proc_create
c_func
(paren
r_struct
id|smb_server
op_star
id|server
comma
r_const
r_char
op_star
id|path
comma
r_int
id|len
comma
r_struct
id|smb_dirent
op_star
id|entry
)paren
(brace
r_int
id|error
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_char
op_star
id|buf
op_assign
id|server-&gt;packet
suffix:semicolon
id|__u16
id|fileid
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|retry
suffix:colon
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBcreate
comma
l_int|3
comma
id|len
op_plus
l_int|2
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv0
comma
id|entry-&gt;attr
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|buf
comma
id|smb_vwv1
comma
id|utc2local
c_func
(paren
id|entry-&gt;ctime
)paren
)paren
suffix:semicolon
id|smb_encode_ascii
c_func
(paren
id|p
comma
id|path
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBcreate
comma
l_int|1
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|smb_retry
c_func
(paren
id|server
)paren
)paren
(brace
r_goto
id|retry
suffix:semicolon
)brace
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|entry-&gt;opened
op_assign
l_int|0
suffix:semicolon
id|fileid
op_assign
id|WVAL
c_func
(paren
id|buf
comma
id|smb_vwv0
)paren
suffix:semicolon
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|smb_proc_close
c_func
(paren
id|server
comma
id|fileid
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|smb_proc_mv
id|smb_proc_mv
c_func
(paren
r_struct
id|smb_server
op_star
id|server
comma
r_const
r_char
op_star
id|opath
comma
r_const
r_int
id|olen
comma
r_const
r_char
op_star
id|npath
comma
r_const
r_int
id|nlen
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
r_char
op_star
id|buf
op_assign
id|server-&gt;packet
suffix:semicolon
r_int
id|result
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|retry
suffix:colon
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBmv
comma
l_int|1
comma
id|olen
op_plus
id|nlen
op_plus
l_int|4
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv0
comma
l_int|0
)paren
suffix:semicolon
id|p
op_assign
id|smb_encode_ascii
c_func
(paren
id|p
comma
id|opath
comma
id|olen
)paren
suffix:semicolon
id|smb_encode_ascii
c_func
(paren
id|p
comma
id|npath
comma
id|olen
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBmv
comma
l_int|0
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|smb_retry
c_func
(paren
id|server
)paren
)paren
(brace
r_goto
id|retry
suffix:semicolon
)brace
)brace
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|smb_proc_mkdir
id|smb_proc_mkdir
c_func
(paren
r_struct
id|smb_server
op_star
id|server
comma
r_const
r_char
op_star
id|path
comma
r_const
r_int
id|len
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
r_int
id|result
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|retry
suffix:colon
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBmkdir
comma
l_int|0
comma
l_int|2
op_plus
id|len
)paren
suffix:semicolon
id|smb_encode_ascii
c_func
(paren
id|p
comma
id|path
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBmkdir
comma
l_int|0
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|smb_retry
c_func
(paren
id|server
)paren
)paren
(brace
r_goto
id|retry
suffix:semicolon
)brace
)brace
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|smb_proc_rmdir
id|smb_proc_rmdir
c_func
(paren
r_struct
id|smb_server
op_star
id|server
comma
r_const
r_char
op_star
id|path
comma
r_const
r_int
id|len
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
r_int
id|result
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|retry
suffix:colon
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBrmdir
comma
l_int|0
comma
l_int|2
op_plus
id|len
)paren
suffix:semicolon
id|smb_encode_ascii
c_func
(paren
id|p
comma
id|path
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBrmdir
comma
l_int|0
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|smb_retry
c_func
(paren
id|server
)paren
)paren
(brace
r_goto
id|retry
suffix:semicolon
)brace
)brace
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|smb_proc_unlink
id|smb_proc_unlink
c_func
(paren
r_struct
id|smb_server
op_star
id|server
comma
r_const
r_char
op_star
id|path
comma
r_const
r_int
id|len
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
r_char
op_star
id|buf
op_assign
id|server-&gt;packet
suffix:semicolon
r_int
id|result
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|retry
suffix:colon
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBunlink
comma
l_int|1
comma
l_int|2
op_plus
id|len
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv0
comma
l_int|0
)paren
suffix:semicolon
id|smb_encode_ascii
c_func
(paren
id|p
comma
id|path
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBunlink
comma
l_int|0
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|smb_retry
c_func
(paren
id|server
)paren
)paren
(brace
r_goto
id|retry
suffix:semicolon
)brace
)brace
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|smb_proc_trunc
id|smb_proc_trunc
c_func
(paren
r_struct
id|smb_server
op_star
id|server
comma
id|word
id|fid
comma
id|dword
id|length
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
r_char
op_star
id|buf
op_assign
id|server-&gt;packet
suffix:semicolon
r_int
id|result
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|retry
suffix:colon
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBwrite
comma
l_int|5
comma
l_int|3
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv0
comma
id|fid
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv1
comma
l_int|0
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|buf
comma
id|smb_vwv2
comma
id|length
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv4
comma
l_int|0
)paren
suffix:semicolon
id|smb_encode_ascii
c_func
(paren
id|p
comma
l_string|&quot;&quot;
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBwrite
comma
l_int|1
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|smb_retry
c_func
(paren
id|server
)paren
)paren
(brace
r_goto
id|retry
suffix:semicolon
)brace
)brace
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_static
r_char
op_star
DECL|function|smb_decode_dirent
id|smb_decode_dirent
c_func
(paren
r_char
op_star
id|p
comma
r_struct
id|smb_dirent
op_star
id|entry
)paren
(brace
id|p
op_add_assign
id|SMB_STATUS_SIZE
suffix:semicolon
multiline_comment|/* reserved (search_status) */
id|entry-&gt;attr
op_assign
id|BVAL
c_func
(paren
id|p
comma
l_int|0
)paren
suffix:semicolon
id|entry-&gt;mtime
op_assign
id|entry-&gt;atime
op_assign
id|entry-&gt;ctime
op_assign
id|date_dos2unix
c_func
(paren
id|WVAL
c_func
(paren
id|p
comma
l_int|1
)paren
comma
id|WVAL
c_func
(paren
id|p
comma
l_int|3
)paren
)paren
suffix:semicolon
id|entry-&gt;size
op_assign
id|DVAL
c_func
(paren
id|p
comma
l_int|5
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|entry-&gt;path
comma
id|p
op_plus
l_int|9
comma
l_int|13
)paren
suffix:semicolon
id|DDPRINTK
c_func
(paren
l_string|&quot;smb_decode_dirent: path = %s&bslash;n&quot;
comma
id|entry-&gt;path
)paren
suffix:semicolon
r_return
id|p
op_plus
l_int|22
suffix:semicolon
)brace
multiline_comment|/* This routine is used to read in directory entries from the network.&n;   Note that it is for short directory name seeks, i.e.: protocol &lt;&n;   PROTOCOL_LANMAN2 */
r_static
r_int
DECL|function|smb_proc_readdir_short
id|smb_proc_readdir_short
c_func
(paren
r_struct
id|smb_server
op_star
id|server
comma
r_struct
id|inode
op_star
id|dir
comma
r_int
id|fpos
comma
r_int
id|cache_size
comma
r_struct
id|smb_dirent
op_star
id|entry
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
r_char
op_star
id|buf
suffix:semicolon
r_int
id|error
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|first
comma
id|total_count
suffix:semicolon
r_struct
id|smb_dirent
op_star
id|current_entry
suffix:semicolon
id|word
id|bcc
suffix:semicolon
id|word
id|count
suffix:semicolon
r_char
id|status
(braket
id|SMB_STATUS_SIZE
)braket
suffix:semicolon
r_int
id|entries_asked
op_assign
(paren
id|server-&gt;max_xmit
op_minus
l_int|100
)paren
op_div
id|SMB_DIRINFO_SIZE
suffix:semicolon
r_int
id|dirlen
op_assign
id|strlen
c_func
(paren
id|SMB_FINFO
c_func
(paren
id|dir
)paren
op_member_access_from_pointer
id|path
)paren
suffix:semicolon
r_char
id|mask
(braket
id|dirlen
op_plus
l_int|5
)braket
suffix:semicolon
id|strcpy
c_func
(paren
id|mask
comma
id|SMB_FINFO
c_func
(paren
id|dir
)paren
op_member_access_from_pointer
id|path
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|mask
comma
l_string|&quot;&bslash;&bslash;*.*&quot;
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;SMB call  readdir %d @ %d&bslash;n&quot;
comma
id|cache_size
comma
id|fpos
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;          mask = %s&bslash;n&quot;
comma
id|mask
)paren
suffix:semicolon
id|buf
op_assign
id|server-&gt;packet
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|retry
suffix:colon
id|first
op_assign
l_int|1
suffix:semicolon
id|total_count
op_assign
l_int|0
suffix:semicolon
id|current_entry
op_assign
id|entry
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|first
op_eq
l_int|1
)paren
(brace
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBsearch
comma
l_int|2
comma
l_int|5
op_plus
id|strlen
c_func
(paren
id|mask
)paren
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv0
comma
id|entries_asked
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv1
comma
id|aDIR
)paren
suffix:semicolon
id|p
op_assign
id|smb_encode_ascii
c_func
(paren
id|p
comma
id|mask
comma
id|strlen
c_func
(paren
id|mask
)paren
)paren
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|5
suffix:semicolon
id|p
op_assign
id|smb_encode_word
c_func
(paren
id|p
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBsearch
comma
l_int|2
comma
l_int|5
op_plus
id|SMB_STATUS_SIZE
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv0
comma
id|entries_asked
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv1
comma
id|aDIR
)paren
suffix:semicolon
id|p
op_assign
id|smb_encode_ascii
c_func
(paren
id|p
comma
l_string|&quot;&quot;
comma
l_int|0
)paren
suffix:semicolon
id|p
op_assign
id|smb_encode_vblock
c_func
(paren
id|p
comma
id|status
comma
id|SMB_STATUS_SIZE
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|error
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBsearch
comma
l_int|1
comma
op_minus
l_int|1
)paren
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|server-&gt;rcls
op_eq
id|ERRDOS
)paren
op_logical_and
(paren
id|server-&gt;err
op_eq
id|ERRnofiles
)paren
)paren
(brace
id|result
op_assign
id|total_count
op_minus
id|fpos
suffix:semicolon
r_goto
id|unlock_return
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|smb_retry
c_func
(paren
id|server
)paren
)paren
(brace
r_goto
id|retry
suffix:semicolon
)brace
id|result
op_assign
id|error
suffix:semicolon
r_goto
id|unlock_return
suffix:semicolon
)brace
)brace
id|p
op_assign
id|SMB_VWV
c_func
(paren
id|server-&gt;packet
)paren
suffix:semicolon
id|p
op_assign
id|smb_decode_word
c_func
(paren
id|p
comma
op_amp
id|count
)paren
suffix:semicolon
multiline_comment|/* vwv[0] = count-returned */
id|p
op_assign
id|smb_decode_word
c_func
(paren
id|p
comma
op_amp
id|bcc
)paren
suffix:semicolon
id|first
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|count
op_le
l_int|0
)paren
(brace
id|result
op_assign
id|total_count
op_minus
id|fpos
suffix:semicolon
r_goto
id|unlock_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bcc
op_ne
id|count
op_star
id|SMB_DIRINFO_SIZE
op_plus
l_int|3
)paren
(brace
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|unlock_return
suffix:semicolon
)brace
id|p
op_add_assign
l_int|3
suffix:semicolon
multiline_comment|/* Skipping VBLOCK header (5, length lo, length hi). */
multiline_comment|/* Read the last entry into the status field. */
id|memcpy
c_func
(paren
id|status
comma
id|SMB_BUF
c_func
(paren
id|server-&gt;packet
)paren
op_plus
l_int|3
op_plus
(paren
id|count
op_minus
l_int|1
)paren
op_star
id|SMB_DIRINFO_SIZE
comma
id|SMB_STATUS_SIZE
)paren
suffix:semicolon
multiline_comment|/* Now we are ready to parse smb directory entries. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|total_count
OL
id|fpos
)paren
(brace
id|p
op_add_assign
id|SMB_DIRINFO_SIZE
suffix:semicolon
id|DDPRINTK
c_func
(paren
l_string|&quot;smb_proc_readdir: skipped entry.&bslash;n&quot;
)paren
suffix:semicolon
id|DDPRINTK
c_func
(paren
l_string|&quot;                  total_count = %d&bslash;n&quot;
l_string|&quot;                i = %d, fpos = %d&bslash;n&quot;
comma
id|total_count
comma
id|i
comma
id|fpos
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|total_count
op_ge
id|fpos
op_plus
id|cache_size
)paren
(brace
id|result
op_assign
id|total_count
op_minus
id|fpos
suffix:semicolon
r_goto
id|unlock_return
suffix:semicolon
)brace
r_else
(brace
id|p
op_assign
id|smb_decode_dirent
c_func
(paren
id|p
comma
id|current_entry
)paren
suffix:semicolon
id|current_entry-&gt;f_pos
op_assign
id|total_count
suffix:semicolon
id|DDPRINTK
c_func
(paren
l_string|&quot;smb_proc_readdir: entry-&gt;f_pos = &quot;
l_string|&quot;%lu&bslash;n&quot;
comma
id|entry-&gt;f_pos
)paren
suffix:semicolon
id|current_entry
op_add_assign
l_int|1
suffix:semicolon
)brace
id|total_count
op_add_assign
l_int|1
suffix:semicolon
)brace
)brace
id|unlock_return
suffix:colon
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* interpret a long filename structure - this is mostly guesses at the&n;   moment.  The length of the structure is returned.  The structure of&n;   a long filename depends on the info level. 260 is used by NT and 2&n;   is used by OS/2. */
r_static
r_char
op_star
DECL|function|smb_decode_long_dirent
id|smb_decode_long_dirent
c_func
(paren
r_char
op_star
id|p
comma
r_struct
id|smb_dirent
op_star
id|finfo
comma
r_int
id|level
)paren
(brace
r_char
op_star
id|result
suffix:semicolon
r_if
c_cond
(paren
id|finfo
)paren
(brace
multiline_comment|/* I have to set times to 0 here, because I do not&n;                   have specs about this for all info levels. */
id|finfo-&gt;ctime
op_assign
id|finfo-&gt;mtime
op_assign
id|finfo-&gt;atime
op_assign
l_int|0
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|level
)paren
(brace
r_case
l_int|1
suffix:colon
multiline_comment|/* OS/2 understands this */
r_if
c_cond
(paren
id|finfo
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;received entry&bslash;n&quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|finfo-&gt;path
comma
id|p
op_plus
l_int|27
)paren
suffix:semicolon
id|finfo-&gt;len
op_assign
id|strlen
c_func
(paren
id|finfo-&gt;path
)paren
suffix:semicolon
id|finfo-&gt;size
op_assign
id|DVAL
c_func
(paren
id|p
comma
l_int|16
)paren
suffix:semicolon
id|finfo-&gt;attr
op_assign
id|BVAL
c_func
(paren
id|p
comma
l_int|24
)paren
suffix:semicolon
id|finfo-&gt;ctime
op_assign
id|date_dos2unix
c_func
(paren
id|WVAL
c_func
(paren
id|p
comma
l_int|6
)paren
comma
id|WVAL
c_func
(paren
id|p
comma
l_int|4
)paren
)paren
suffix:semicolon
id|finfo-&gt;atime
op_assign
id|date_dos2unix
c_func
(paren
id|WVAL
c_func
(paren
id|p
comma
l_int|10
)paren
comma
id|WVAL
c_func
(paren
id|p
comma
l_int|8
)paren
)paren
suffix:semicolon
id|finfo-&gt;mtime
op_assign
id|date_dos2unix
c_func
(paren
id|WVAL
c_func
(paren
id|p
comma
l_int|14
)paren
comma
id|WVAL
c_func
(paren
id|p
comma
l_int|12
)paren
)paren
suffix:semicolon
)brace
id|result
op_assign
id|p
op_plus
l_int|28
op_plus
id|BVAL
c_func
(paren
id|p
comma
l_int|26
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* this is what OS/2 uses */
r_if
c_cond
(paren
id|finfo
)paren
(brace
id|strcpy
c_func
(paren
id|finfo-&gt;path
comma
id|p
op_plus
l_int|31
)paren
suffix:semicolon
id|finfo-&gt;len
op_assign
id|strlen
c_func
(paren
id|finfo-&gt;path
)paren
suffix:semicolon
id|finfo-&gt;size
op_assign
id|DVAL
c_func
(paren
id|p
comma
l_int|16
)paren
suffix:semicolon
id|finfo-&gt;attr
op_assign
id|BVAL
c_func
(paren
id|p
comma
l_int|24
)paren
suffix:semicolon
macro_line|#if 0
id|finfo-&gt;atime
op_assign
id|make_unix_date2
c_func
(paren
id|p
op_plus
l_int|8
)paren
suffix:semicolon
id|finfo-&gt;mtime
op_assign
id|make_unix_date2
c_func
(paren
id|p
op_plus
l_int|12
)paren
suffix:semicolon
macro_line|#endif
)brace
id|result
op_assign
id|p
op_plus
l_int|32
op_plus
id|BVAL
c_func
(paren
id|p
comma
l_int|30
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|260
suffix:colon
multiline_comment|/* NT uses this, but also accepts 2 */
id|result
op_assign
id|p
op_plus
id|WVAL
c_func
(paren
id|p
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|finfo
)paren
(brace
r_int
id|namelen
suffix:semicolon
id|p
op_add_assign
l_int|4
suffix:semicolon
multiline_comment|/* next entry offset */
id|p
op_add_assign
l_int|4
suffix:semicolon
multiline_comment|/* fileindex */
multiline_comment|/* finfo-&gt;ctime = interpret_filetime(p);*/
id|p
op_add_assign
l_int|8
suffix:semicolon
multiline_comment|/* finfo-&gt;atime = interpret_filetime(p);*/
id|p
op_add_assign
l_int|8
suffix:semicolon
id|p
op_add_assign
l_int|8
suffix:semicolon
multiline_comment|/* write time */
multiline_comment|/* finfo-&gt;mtime = interpret_filetime(p);*/
id|p
op_add_assign
l_int|8
suffix:semicolon
id|finfo-&gt;size
op_assign
id|DVAL
c_func
(paren
id|p
comma
l_int|0
)paren
suffix:semicolon
id|p
op_add_assign
l_int|8
suffix:semicolon
id|p
op_add_assign
l_int|8
suffix:semicolon
multiline_comment|/* alloc size */
id|finfo-&gt;attr
op_assign
id|BVAL
c_func
(paren
id|p
comma
l_int|0
)paren
suffix:semicolon
id|p
op_add_assign
l_int|4
suffix:semicolon
id|namelen
op_assign
id|min
c_func
(paren
id|DVAL
c_func
(paren
id|p
comma
l_int|0
)paren
comma
id|SMB_MAXNAMELEN
)paren
suffix:semicolon
id|p
op_add_assign
l_int|4
suffix:semicolon
id|p
op_add_assign
l_int|4
suffix:semicolon
multiline_comment|/* EA size */
id|p
op_add_assign
l_int|2
suffix:semicolon
multiline_comment|/* short name len? */
id|p
op_add_assign
l_int|24
suffix:semicolon
multiline_comment|/* short name? */
id|strncpy
c_func
(paren
id|finfo-&gt;path
comma
id|p
comma
id|namelen
)paren
suffix:semicolon
id|finfo-&gt;len
op_assign
id|namelen
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;Unknown long filename format %d&bslash;n&quot;
comma
id|level
)paren
suffix:semicolon
id|result
op_assign
id|p
op_plus
id|WVAL
c_func
(paren
id|p
comma
l_int|0
)paren
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|smb_proc_readdir_long
id|smb_proc_readdir_long
c_func
(paren
r_struct
id|smb_server
op_star
id|server
comma
r_struct
id|inode
op_star
id|dir
comma
r_int
id|fpos
comma
r_int
id|cache_size
comma
r_struct
id|smb_dirent
op_star
id|entry
)paren
(brace
r_int
id|max_matches
op_assign
l_int|64
suffix:semicolon
multiline_comment|/* this should actually be based on the &n;&t;&t;&t;&t; maxxmit */
multiline_comment|/* NT uses 260, OS/2 uses 2. Both accept 1. */
r_int
id|info_level
op_assign
l_int|1
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_char
op_star
id|lastname
suffix:semicolon
r_int
id|lastname_len
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|first
comma
id|total_count
suffix:semicolon
r_struct
id|smb_dirent
op_star
id|current_entry
suffix:semicolon
r_char
op_star
id|resp_data
suffix:semicolon
r_char
op_star
id|resp_param
suffix:semicolon
r_int
id|resp_data_len
op_assign
l_int|0
suffix:semicolon
r_int
id|resp_param_len
op_assign
l_int|0
suffix:semicolon
r_int
id|attribute
op_assign
id|aSYSTEM
op_or
id|aHIDDEN
op_or
id|aDIR
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
id|ff_resume_key
op_assign
l_int|0
suffix:semicolon
r_int
id|ff_searchcount
op_assign
l_int|0
suffix:semicolon
r_int
id|ff_eos
op_assign
l_int|0
suffix:semicolon
r_int
id|ff_lastname
op_assign
l_int|0
suffix:semicolon
r_int
id|ff_dir_handle
op_assign
l_int|0
suffix:semicolon
r_int
id|loop_count
op_assign
l_int|0
suffix:semicolon
r_int
id|dirlen
op_assign
id|strlen
c_func
(paren
id|SMB_FINFO
c_func
(paren
id|dir
)paren
op_member_access_from_pointer
id|path
)paren
op_plus
l_int|3
suffix:semicolon
r_char
op_star
id|mask
suffix:semicolon
id|mask
op_assign
id|smb_kmalloc
c_func
(paren
id|dirlen
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mask
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_proc_readdir_long: Memory allocation failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|mask
comma
id|SMB_FINFO
c_func
(paren
id|dir
)paren
op_member_access_from_pointer
id|path
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|mask
comma
l_string|&quot;&bslash;&bslash;*&quot;
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;SMB call lreaddir %d @ %d&bslash;n&quot;
comma
id|cache_size
comma
id|fpos
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;          mask = %s&bslash;n&quot;
comma
id|mask
)paren
suffix:semicolon
id|resp_param
op_assign
l_int|NULL
suffix:semicolon
id|resp_data
op_assign
l_int|NULL
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|retry
suffix:colon
id|first
op_assign
l_int|1
suffix:semicolon
id|total_count
op_assign
l_int|0
suffix:semicolon
id|current_entry
op_assign
id|entry
suffix:semicolon
r_while
c_loop
(paren
id|ff_eos
op_eq
l_int|0
)paren
(brace
r_int
id|masklen
op_assign
id|strlen
c_func
(paren
id|mask
)paren
suffix:semicolon
r_int
r_char
op_star
id|outbuf
op_assign
id|server-&gt;packet
suffix:semicolon
id|loop_count
op_add_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|loop_count
OG
l_int|200
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_proc_readdir_long: &quot;
l_string|&quot;Looping in FIND_NEXT??&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBtrans2
comma
l_int|15
comma
l_int|5
op_plus
l_int|12
op_plus
id|masklen
op_plus
l_int|1
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|outbuf
comma
id|smb_tpscnt
comma
l_int|12
op_plus
id|masklen
op_plus
l_int|1
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|outbuf
comma
id|smb_tdscnt
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|outbuf
comma
id|smb_mprcnt
comma
l_int|10
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|outbuf
comma
id|smb_mdrcnt
comma
id|TRANS2_MAX_TRANSFER
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|outbuf
comma
id|smb_msrcnt
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|outbuf
comma
id|smb_flags
comma
l_int|0
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|outbuf
comma
id|smb_timeout
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|outbuf
comma
id|smb_pscnt
comma
id|WVAL
c_func
(paren
id|outbuf
comma
id|smb_tpscnt
)paren
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|outbuf
comma
id|smb_psoff
comma
(paren
(paren
id|SMB_BUF
c_func
(paren
id|outbuf
)paren
op_plus
l_int|3
)paren
op_minus
id|outbuf
)paren
op_minus
l_int|4
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|outbuf
comma
id|smb_dscnt
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|outbuf
comma
id|smb_dsoff
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|outbuf
comma
id|smb_suwcnt
comma
l_int|1
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|outbuf
comma
id|smb_setup0
comma
id|first
op_eq
l_int|1
ques
c_cond
id|TRANSACT2_FINDFIRST
suffix:colon
id|TRANSACT2_FINDNEXT
)paren
suffix:semicolon
id|p
op_assign
id|SMB_BUF
c_func
(paren
id|outbuf
)paren
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* put in a null smb_name */
op_star
id|p
op_increment
op_assign
l_char|&squot;D&squot;
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_char|&squot; &squot;
suffix:semicolon
multiline_comment|/* this was added because OS/2 does it */
r_if
c_cond
(paren
id|first
op_ne
l_int|0
)paren
(brace
id|WSET
c_func
(paren
id|p
comma
l_int|0
comma
id|attribute
)paren
suffix:semicolon
multiline_comment|/* attribute */
id|WSET
c_func
(paren
id|p
comma
l_int|2
comma
id|max_matches
)paren
suffix:semicolon
multiline_comment|/* max count */
id|WSET
c_func
(paren
id|p
comma
l_int|4
comma
l_int|8
op_plus
l_int|4
op_plus
l_int|2
)paren
suffix:semicolon
multiline_comment|/* resume required + close on end +&n;                                            continue */
id|WSET
c_func
(paren
id|p
comma
l_int|6
comma
id|info_level
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|p
comma
l_int|8
comma
l_int|0
)paren
suffix:semicolon
id|p
op_add_assign
l_int|12
suffix:semicolon
id|strncpy
c_func
(paren
id|p
comma
id|mask
comma
id|masklen
)paren
suffix:semicolon
id|p
op_add_assign
id|masklen
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|0
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;hand=0x%X resume=%d ff_lastname=%d mask=%s&bslash;n&quot;
comma
id|ff_dir_handle
comma
id|ff_resume_key
comma
id|ff_lastname
comma
id|mask
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|p
comma
l_int|0
comma
id|ff_dir_handle
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|p
comma
l_int|2
comma
id|max_matches
)paren
suffix:semicolon
multiline_comment|/* max count */
id|WSET
c_func
(paren
id|p
comma
l_int|4
comma
id|info_level
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|p
comma
l_int|6
comma
id|ff_resume_key
)paren
suffix:semicolon
multiline_comment|/* ff_resume_key */
id|WSET
c_func
(paren
id|p
comma
l_int|10
comma
l_int|8
op_plus
l_int|4
op_plus
l_int|2
)paren
suffix:semicolon
multiline_comment|/* resume required + close on end +&n;                                             continue */
id|p
op_add_assign
l_int|12
suffix:semicolon
id|strncpy
c_func
(paren
id|p
comma
id|mask
comma
id|masklen
)paren
suffix:semicolon
id|p
op_add_assign
id|masklen
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|0
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|0
suffix:semicolon
)brace
id|result
op_assign
id|smb_trans2_request
c_func
(paren
id|server
comma
op_amp
id|resp_data_len
comma
op_amp
id|resp_param_len
comma
op_amp
id|resp_data
comma
op_amp
id|resp_param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|smb_retry
c_func
(paren
id|server
)paren
)paren
(brace
r_goto
id|retry
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;smb_proc_readdir_long: &quot;
l_string|&quot;got error from trans2_request&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|server-&gt;rcls
op_ne
l_int|0
)paren
(brace
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* parse out some important return info */
id|p
op_assign
id|resp_param
suffix:semicolon
r_if
c_cond
(paren
id|first
op_ne
l_int|0
)paren
(brace
id|ff_dir_handle
op_assign
id|WVAL
c_func
(paren
id|p
comma
l_int|0
)paren
suffix:semicolon
id|ff_searchcount
op_assign
id|WVAL
c_func
(paren
id|p
comma
l_int|2
)paren
suffix:semicolon
id|ff_eos
op_assign
id|WVAL
c_func
(paren
id|p
comma
l_int|4
)paren
suffix:semicolon
id|ff_lastname
op_assign
id|WVAL
c_func
(paren
id|p
comma
l_int|8
)paren
suffix:semicolon
)brace
r_else
(brace
id|ff_searchcount
op_assign
id|WVAL
c_func
(paren
id|p
comma
l_int|0
)paren
suffix:semicolon
id|ff_eos
op_assign
id|WVAL
c_func
(paren
id|p
comma
l_int|2
)paren
suffix:semicolon
id|ff_lastname
op_assign
id|WVAL
c_func
(paren
id|p
comma
l_int|6
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ff_searchcount
op_eq
l_int|0
)paren
r_break
suffix:semicolon
multiline_comment|/* point to the data bytes */
id|p
op_assign
id|resp_data
suffix:semicolon
multiline_comment|/* we might need the lastname for continuations */
id|lastname
op_assign
l_string|&quot;&quot;
suffix:semicolon
id|lastname_len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ff_lastname
OG
l_int|0
)paren
(brace
r_switch
c_cond
(paren
id|info_level
)paren
(brace
r_case
l_int|260
suffix:colon
id|lastname
op_assign
id|p
op_plus
id|ff_lastname
suffix:semicolon
id|lastname_len
op_assign
id|resp_data_len
op_minus
id|ff_lastname
suffix:semicolon
id|ff_resume_key
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|lastname
op_assign
id|p
op_plus
id|ff_lastname
op_plus
l_int|1
suffix:semicolon
id|lastname_len
op_assign
id|strlen
c_func
(paren
id|lastname
)paren
suffix:semicolon
id|ff_resume_key
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Increase size of mask, if it is too small */
id|i
op_assign
id|strlen
c_func
(paren
id|lastname
)paren
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
id|dirlen
)paren
(brace
id|smb_kfree_s
c_func
(paren
id|mask
comma
l_int|0
)paren
suffix:semicolon
id|dirlen
op_assign
id|i
suffix:semicolon
id|mask
op_assign
id|smb_kmalloc
c_func
(paren
id|dirlen
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mask
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_proc_readdir_long: &quot;
l_string|&quot;Memory allocation failed&bslash;n&quot;
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|strncpy
c_func
(paren
id|mask
comma
id|lastname
comma
id|lastname_len
)paren
suffix:semicolon
id|mask
(braket
id|lastname_len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
multiline_comment|/* Now we are ready to parse smb directory entries. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ff_searchcount
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|total_count
OL
id|fpos
)paren
(brace
id|p
op_assign
id|smb_decode_long_dirent
c_func
(paren
id|p
comma
l_int|NULL
comma
id|info_level
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;smb_proc_readdir: skipped entry.&bslash;n&quot;
)paren
suffix:semicolon
id|DDPRINTK
c_func
(paren
l_string|&quot;                  total_count = %d&bslash;n&quot;
l_string|&quot;                i = %d, fpos = %d&bslash;n&quot;
comma
id|total_count
comma
id|i
comma
id|fpos
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|total_count
op_ge
id|fpos
op_plus
id|cache_size
)paren
(brace
r_goto
id|finished
suffix:semicolon
)brace
r_else
(brace
id|p
op_assign
id|smb_decode_long_dirent
c_func
(paren
id|p
comma
id|current_entry
comma
id|info_level
)paren
suffix:semicolon
id|current_entry-&gt;f_pos
op_assign
id|total_count
suffix:semicolon
id|DDPRINTK
c_func
(paren
l_string|&quot;smb_proc_readdir: entry-&gt;f_pos = &quot;
l_string|&quot;%lu&bslash;n&quot;
comma
id|entry-&gt;f_pos
)paren
suffix:semicolon
id|current_entry
op_add_assign
l_int|1
suffix:semicolon
)brace
id|total_count
op_add_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|resp_data
op_ne
l_int|NULL
)paren
(brace
id|smb_kfree_s
c_func
(paren
id|resp_data
comma
l_int|0
)paren
suffix:semicolon
id|resp_data
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|resp_param
op_ne
l_int|NULL
)paren
(brace
id|smb_kfree_s
c_func
(paren
id|resp_param
comma
l_int|0
)paren
suffix:semicolon
id|resp_param
op_assign
l_int|NULL
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;received %d entries (eos=%d resume=%d)&bslash;n&quot;
comma
id|ff_searchcount
comma
id|ff_eos
comma
id|ff_resume_key
)paren
suffix:semicolon
id|first
op_assign
l_int|0
suffix:semicolon
)brace
id|finished
suffix:colon
r_if
c_cond
(paren
id|mask
op_ne
l_int|NULL
)paren
id|smb_kfree_s
c_func
(paren
id|mask
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|resp_data
op_ne
l_int|NULL
)paren
(brace
id|smb_kfree_s
c_func
(paren
id|resp_data
comma
l_int|0
)paren
suffix:semicolon
id|resp_data
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|resp_param
op_ne
l_int|NULL
)paren
(brace
id|smb_kfree_s
c_func
(paren
id|resp_param
comma
l_int|0
)paren
suffix:semicolon
id|resp_param
op_assign
l_int|NULL
suffix:semicolon
)brace
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|total_count
op_minus
id|fpos
suffix:semicolon
)brace
r_int
DECL|function|smb_proc_readdir
id|smb_proc_readdir
c_func
(paren
r_struct
id|smb_server
op_star
id|server
comma
r_struct
id|inode
op_star
id|dir
comma
r_int
id|fpos
comma
r_int
id|cache_size
comma
r_struct
id|smb_dirent
op_star
id|entry
)paren
(brace
r_if
c_cond
(paren
id|server-&gt;protocol
op_ge
id|PROTOCOL_LANMAN2
)paren
r_return
id|smb_proc_readdir_long
c_func
(paren
id|server
comma
id|dir
comma
id|fpos
comma
id|cache_size
comma
id|entry
)paren
suffix:semicolon
r_else
r_return
id|smb_proc_readdir_short
c_func
(paren
id|server
comma
id|dir
comma
id|fpos
comma
id|cache_size
comma
id|entry
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|smb_proc_getattr_core
id|smb_proc_getattr_core
c_func
(paren
r_struct
id|smb_server
op_star
id|server
comma
r_const
r_char
op_star
id|path
comma
r_int
id|len
comma
r_struct
id|smb_dirent
op_star
id|entry
)paren
(brace
r_int
id|result
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_char
op_star
id|buf
op_assign
id|server-&gt;packet
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|DDPRINTK
c_func
(paren
l_string|&quot;smb_proc_getattr: %s&bslash;n&quot;
comma
id|path
)paren
suffix:semicolon
id|retry
suffix:colon
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBgetatr
comma
l_int|0
comma
l_int|2
op_plus
id|len
)paren
suffix:semicolon
id|smb_encode_ascii
c_func
(paren
id|p
comma
id|path
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBgetatr
comma
l_int|10
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|smb_retry
c_func
(paren
id|server
)paren
)paren
(brace
r_goto
id|retry
suffix:semicolon
)brace
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|entry-&gt;attr
op_assign
id|WVAL
c_func
(paren
id|buf
comma
id|smb_vwv0
)paren
suffix:semicolon
id|entry-&gt;ctime
op_assign
id|entry-&gt;atime
op_assign
multiline_comment|/* The server only tells us 1 time */
id|entry-&gt;mtime
op_assign
id|local2utc
c_func
(paren
id|DVAL
c_func
(paren
id|buf
comma
id|smb_vwv1
)paren
)paren
suffix:semicolon
id|entry-&gt;size
op_assign
id|DVAL
c_func
(paren
id|buf
comma
id|smb_vwv3
)paren
suffix:semicolon
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* smb_proc_getattrE: entry-&gt;fid must be valid */
r_static
r_int
DECL|function|smb_proc_getattrE
id|smb_proc_getattrE
c_func
(paren
r_struct
id|smb_server
op_star
id|server
comma
r_struct
id|smb_dirent
op_star
id|entry
)paren
(brace
r_char
op_star
id|buf
op_assign
id|server-&gt;packet
suffix:semicolon
r_int
id|result
suffix:semicolon
id|smb_setup_header_exclusive
c_func
(paren
id|server
comma
id|SMBgetattrE
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv0
comma
id|entry-&gt;fileid
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBgetattrE
comma
l_int|11
comma
l_int|0
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|entry-&gt;ctime
op_assign
id|date_dos2unix
c_func
(paren
id|WVAL
c_func
(paren
id|buf
comma
id|smb_vwv1
)paren
comma
id|WVAL
c_func
(paren
id|buf
comma
id|smb_vwv0
)paren
)paren
suffix:semicolon
id|entry-&gt;atime
op_assign
id|date_dos2unix
c_func
(paren
id|WVAL
c_func
(paren
id|buf
comma
id|smb_vwv3
)paren
comma
id|WVAL
c_func
(paren
id|buf
comma
id|smb_vwv2
)paren
)paren
suffix:semicolon
id|entry-&gt;mtime
op_assign
id|date_dos2unix
c_func
(paren
id|WVAL
c_func
(paren
id|buf
comma
id|smb_vwv5
)paren
comma
id|WVAL
c_func
(paren
id|buf
comma
id|smb_vwv4
)paren
)paren
suffix:semicolon
id|entry-&gt;size
op_assign
id|DVAL
c_func
(paren
id|buf
comma
id|smb_vwv6
)paren
suffix:semicolon
id|entry-&gt;attr
op_assign
id|WVAL
c_func
(paren
id|buf
comma
id|smb_vwv10
)paren
suffix:semicolon
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|smb_proc_getattr
id|smb_proc_getattr
c_func
(paren
r_struct
id|smb_server
op_star
id|server
comma
r_const
r_char
op_star
id|path
comma
r_int
id|len
comma
r_struct
id|smb_dirent
op_star
id|entry
)paren
(brace
r_if
c_cond
(paren
id|server-&gt;protocol
op_ge
id|PROTOCOL_LANMAN1
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_struct
id|smb_dirent
id|temp_entry
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|temp_entry
comma
l_int|0
comma
r_sizeof
(paren
id|temp_entry
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_proc_open
c_func
(paren
id|server
comma
id|path
comma
id|len
comma
op_amp
id|temp_entry
)paren
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* We cannot open directories, so we try to use the&n;                           core variant */
r_return
id|smb_proc_getattr_core
c_func
(paren
id|server
comma
id|path
comma
id|len
comma
id|entry
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_proc_getattrE
c_func
(paren
id|server
comma
op_amp
id|temp_entry
)paren
)paren
op_ge
l_int|0
)paren
(brace
id|entry-&gt;attr
op_assign
id|temp_entry.attr
suffix:semicolon
id|entry-&gt;atime
op_assign
id|temp_entry.atime
suffix:semicolon
id|entry-&gt;mtime
op_assign
id|temp_entry.mtime
suffix:semicolon
id|entry-&gt;ctime
op_assign
id|temp_entry.ctime
suffix:semicolon
id|entry-&gt;size
op_assign
id|temp_entry.size
suffix:semicolon
)brace
id|smb_proc_close
c_func
(paren
id|server
comma
id|temp_entry.fileid
comma
id|temp_entry.mtime
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_else
(brace
r_return
id|smb_proc_getattr_core
c_func
(paren
id|server
comma
id|path
comma
id|len
comma
id|entry
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* In core protocol, there is only 1 time to be set, we use&n;   entry-&gt;mtime, to make touch work. */
r_static
r_int
DECL|function|smb_proc_setattr_core
id|smb_proc_setattr_core
c_func
(paren
r_struct
id|smb_server
op_star
id|server
comma
r_const
r_char
op_star
id|path
comma
r_int
id|len
comma
r_struct
id|smb_dirent
op_star
id|new_finfo
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
r_char
op_star
id|buf
op_assign
id|server-&gt;packet
suffix:semicolon
r_int
id|result
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|retry
suffix:colon
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBsetatr
comma
l_int|8
comma
l_int|4
op_plus
id|len
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv0
comma
id|new_finfo-&gt;attr
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|buf
comma
id|smb_vwv1
comma
id|utc2local
c_func
(paren
id|new_finfo-&gt;mtime
)paren
)paren
suffix:semicolon
id|p
op_assign
id|smb_encode_ascii
c_func
(paren
id|p
comma
id|path
comma
id|len
)paren
suffix:semicolon
id|p
op_assign
id|smb_encode_ascii
c_func
(paren
id|p
comma
l_string|&quot;&quot;
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBsetatr
comma
l_int|0
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|smb_retry
c_func
(paren
id|server
)paren
)paren
(brace
r_goto
id|retry
suffix:semicolon
)brace
)brace
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* smb_proc_setattrE: we do not retry here, because we rely on fid,&n;   which would not be valid after a retry. */
r_static
r_int
DECL|function|smb_proc_setattrE
id|smb_proc_setattrE
c_func
(paren
r_struct
id|smb_server
op_star
id|server
comma
id|word
id|fid
comma
r_struct
id|smb_dirent
op_star
id|new_entry
)paren
(brace
r_char
op_star
id|buf
op_assign
id|server-&gt;packet
suffix:semicolon
id|word
id|date
comma
id|time
suffix:semicolon
id|smb_setup_header_exclusive
c_func
(paren
id|server
comma
id|SMBsetattrE
comma
l_int|7
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv0
comma
id|fid
)paren
suffix:semicolon
id|date_unix2dos
c_func
(paren
id|new_entry-&gt;ctime
comma
op_amp
id|time
comma
op_amp
id|date
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv1
comma
id|date
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv2
comma
id|time
)paren
suffix:semicolon
id|date_unix2dos
c_func
(paren
id|new_entry-&gt;atime
comma
op_amp
id|time
comma
op_amp
id|date
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv3
comma
id|date
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv4
comma
id|time
)paren
suffix:semicolon
id|date_unix2dos
c_func
(paren
id|new_entry-&gt;mtime
comma
op_amp
id|time
comma
op_amp
id|date
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv5
comma
id|date
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv6
comma
id|time
)paren
suffix:semicolon
r_return
id|smb_request_ok_unlock
c_func
(paren
id|server
comma
id|SMBsetattrE
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* smb_proc_setattr: for protocol &gt;= LANMAN1 we expect the file to be&n;   opened for writing. */
r_int
DECL|function|smb_proc_setattr
id|smb_proc_setattr
c_func
(paren
r_struct
id|smb_server
op_star
id|server
comma
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|smb_dirent
op_star
id|new_finfo
)paren
(brace
r_struct
id|smb_dirent
op_star
id|finfo
op_assign
id|SMB_FINFO
c_func
(paren
id|inode
)paren
suffix:semicolon
r_int
id|result
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;protocol
op_ge
id|PROTOCOL_LANMAN1
)paren
(brace
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_make_open
c_func
(paren
id|inode
comma
id|O_RDWR
)paren
)paren
OL
l_int|0
)paren
r_return
id|result
suffix:semicolon
r_return
id|smb_proc_setattrE
c_func
(paren
id|server
comma
id|finfo-&gt;fileid
comma
id|new_finfo
)paren
suffix:semicolon
)brace
r_else
(brace
r_return
id|smb_proc_setattr_core
c_func
(paren
id|server
comma
id|finfo-&gt;path
comma
id|finfo-&gt;len
comma
id|new_finfo
)paren
suffix:semicolon
)brace
)brace
r_int
DECL|function|smb_proc_dskattr
id|smb_proc_dskattr
c_func
(paren
r_struct
id|super_block
op_star
id|super
comma
r_struct
id|smb_dskattr
op_star
id|attr
)paren
(brace
r_int
id|error
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_struct
id|smb_server
op_star
id|server
op_assign
op_amp
(paren
id|SMB_SBP
c_func
(paren
id|super
)paren
op_member_access_from_pointer
id|s_server
)paren
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|retry
suffix:colon
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBdskattr
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBdskattr
comma
l_int|5
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|smb_retry
c_func
(paren
id|server
)paren
)paren
(brace
r_goto
id|retry
suffix:semicolon
)brace
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|p
op_assign
id|SMB_VWV
c_func
(paren
id|server-&gt;packet
)paren
suffix:semicolon
id|p
op_assign
id|smb_decode_word
c_func
(paren
id|p
comma
op_amp
id|attr-&gt;total
)paren
suffix:semicolon
id|p
op_assign
id|smb_decode_word
c_func
(paren
id|p
comma
op_amp
id|attr-&gt;allocblocks
)paren
suffix:semicolon
id|p
op_assign
id|smb_decode_word
c_func
(paren
id|p
comma
op_amp
id|attr-&gt;blocksize
)paren
suffix:semicolon
id|p
op_assign
id|smb_decode_word
c_func
(paren
id|p
comma
op_amp
id|attr-&gt;free
)paren
suffix:semicolon
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*                                                                           */
multiline_comment|/*  Mount/umount operations.                                                 */
multiline_comment|/*                                                                           */
multiline_comment|/*****************************************************************************/
DECL|struct|smb_prots
r_struct
id|smb_prots
(brace
DECL|member|prot
r_enum
id|smb_protocol
id|prot
suffix:semicolon
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* smb_proc_reconnect: We expect the server to be locked, so that you&n;   can call the routine from within smb_retry. The socket must be&n;   created, like after a user-level socket()-call. It may not be&n;   connected. */
r_int
DECL|function|smb_proc_reconnect
id|smb_proc_reconnect
c_func
(paren
r_struct
id|smb_server
op_star
id|server
)paren
(brace
r_struct
id|smb_prots
id|prots
(braket
)braket
op_assign
(brace
(brace
id|PROTOCOL_CORE
comma
l_string|&quot;PC NETWORK PROGRAM 1.0&quot;
)brace
comma
(brace
id|PROTOCOL_COREPLUS
comma
l_string|&quot;MICROSOFT NETWORKS 1.03&quot;
)brace
comma
macro_line|#ifdef LANMAN1
(brace
id|PROTOCOL_LANMAN1
comma
l_string|&quot;MICROSOFT NETWORKS 3.0&quot;
)brace
comma
(brace
id|PROTOCOL_LANMAN1
comma
l_string|&quot;LANMAN1.0&quot;
)brace
comma
macro_line|#endif
macro_line|#ifdef CONFIG_SMB_LONG
macro_line|#ifdef LANMAN2
(brace
id|PROTOCOL_LANMAN2
comma
l_string|&quot;LM1.2X002&quot;
)brace
comma
macro_line|#endif
macro_line|#ifdef NT1
(brace
id|PROTOCOL_NT1
comma
l_string|&quot;NT LM 0.12&quot;
)brace
comma
(brace
id|PROTOCOL_NT1
comma
l_string|&quot;NT LANMAN 1.0&quot;
)brace
comma
macro_line|#endif
macro_line|#endif
(brace
op_minus
l_int|1
comma
l_int|NULL
)brace
)brace
suffix:semicolon
r_char
id|dev
(braket
)braket
op_assign
l_string|&quot;A:&quot;
suffix:semicolon
r_int
id|i
comma
id|plength
suffix:semicolon
r_int
id|max_xmit
op_assign
l_int|1024
suffix:semicolon
multiline_comment|/* Space needed for first request. */
r_int
id|given_max_xmit
op_assign
id|server-&gt;m.max_xmit
suffix:semicolon
r_int
id|result
suffix:semicolon
id|byte
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_connect
c_func
(paren
id|server
)paren
)paren
OL
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;smb_proc_reconnect: could not smb_connect&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
multiline_comment|/* Here we assume that the connection is valid */
id|server-&gt;state
op_assign
id|CONN_VALID
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;packet
op_ne
l_int|NULL
)paren
(brace
id|smb_kfree_s
c_func
(paren
id|server-&gt;packet
comma
id|server-&gt;max_xmit
)paren
suffix:semicolon
)brace
id|server-&gt;packet
op_assign
id|smb_kmalloc
c_func
(paren
id|max_xmit
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;packet
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_proc_connect: No memory! Bailing out.&bslash;n&quot;
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|server-&gt;max_xmit
op_assign
id|max_xmit
suffix:semicolon
multiline_comment|/*&n;&t; * Start with an RFC1002 session request packet.&n;&t; */
id|p
op_assign
id|server-&gt;packet
op_plus
l_int|4
suffix:semicolon
id|p
op_assign
id|smb_name_mangle
c_func
(paren
id|p
comma
id|server-&gt;m.server_name
)paren
suffix:semicolon
id|p
op_assign
id|smb_name_mangle
c_func
(paren
id|p
comma
id|server-&gt;m.client_name
)paren
suffix:semicolon
id|smb_encode_smb_length
c_func
(paren
id|server-&gt;packet
comma
(paren
r_void
op_star
)paren
id|p
op_minus
(paren
r_void
op_star
)paren
(paren
id|server-&gt;packet
)paren
)paren
suffix:semicolon
id|server-&gt;packet
(braket
l_int|0
)braket
op_assign
l_int|0x81
suffix:semicolon
multiline_comment|/* SESSION REQUEST */
r_if
c_cond
(paren
id|smb_catch_keepalive
c_func
(paren
id|server
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_proc_connect: could not catch_keepalives&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_request
c_func
(paren
id|server
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_proc_connect: Failed to send SESSION REQUEST.&bslash;n&quot;
)paren
suffix:semicolon
id|smb_dont_catch_keepalive
c_func
(paren
id|server
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
r_if
c_cond
(paren
id|server-&gt;packet
(braket
l_int|0
)braket
op_ne
l_int|0x82
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_proc_connect: Did not receive positive response &quot;
l_string|&quot;(err = %x)&bslash;n&quot;
comma
id|server-&gt;packet
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|smb_dont_catch_keepalive
c_func
(paren
id|server
)paren
suffix:semicolon
macro_line|#if DEBUG_SMB &gt; 0
id|smb_dump_packet
c_func
(paren
id|server-&gt;packet
)paren
suffix:semicolon
macro_line|#endif
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;smb_proc_connect: Passed SESSION REQUEST.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Now we are ready to send a SMB Negotiate Protocol packet. */
id|memset
c_func
(paren
id|server-&gt;packet
comma
l_int|0
comma
id|SMB_HEADER_LEN
)paren
suffix:semicolon
id|plength
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|prots
(braket
id|i
)braket
dot
id|name
op_ne
l_int|NULL
suffix:semicolon
id|i
op_increment
)paren
(brace
id|plength
op_add_assign
id|strlen
c_func
(paren
id|prots
(braket
id|i
)braket
dot
id|name
)paren
op_plus
l_int|2
suffix:semicolon
)brace
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBnegprot
comma
l_int|0
comma
id|plength
)paren
suffix:semicolon
id|p
op_assign
id|SMB_BUF
c_func
(paren
id|server-&gt;packet
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|prots
(braket
id|i
)braket
dot
id|name
op_ne
l_int|NULL
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p
op_assign
id|smb_encode_dialect
c_func
(paren
id|p
comma
id|prots
(braket
id|i
)braket
dot
id|name
comma
id|strlen
c_func
(paren
id|prots
(braket
id|i
)braket
dot
id|name
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBnegprot
comma
l_int|1
comma
op_minus
l_int|1
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_proc_connect: Failure requesting SMBnegprot&bslash;n&quot;
)paren
suffix:semicolon
id|smb_dont_catch_keepalive
c_func
(paren
id|server
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
r_else
(brace
id|DDPRINTK
c_func
(paren
l_string|&quot;smb_proc_connect: Request SMBnegprot..&quot;
)paren
suffix:semicolon
)brace
id|DDPRINTK
c_func
(paren
l_string|&quot;Verified!&bslash;n&quot;
)paren
suffix:semicolon
id|p
op_assign
id|SMB_VWV
c_func
(paren
id|server-&gt;packet
)paren
suffix:semicolon
id|p
op_assign
id|smb_decode_word
c_func
(paren
id|p
comma
(paren
id|word
op_star
)paren
op_amp
id|i
)paren
suffix:semicolon
id|server-&gt;protocol
op_assign
id|prots
(braket
id|i
)braket
dot
id|prot
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;smb_proc_connect: Server wants %s protocol.&bslash;n&quot;
comma
id|prots
(braket
id|i
)braket
dot
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;protocol
op_ge
id|PROTOCOL_LANMAN1
)paren
(brace
id|word
id|passlen
op_assign
id|strlen
c_func
(paren
id|server-&gt;m.password
)paren
suffix:semicolon
id|word
id|userlen
op_assign
id|strlen
c_func
(paren
id|server-&gt;m.username
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;smb_proc_connect: password = %s&bslash;n&quot;
comma
id|server-&gt;m.password
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;smb_proc_connect: usernam = %s&bslash;n&quot;
comma
id|server-&gt;m.username
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;smb_proc_connect: blkmode = %d&bslash;n&quot;
comma
id|WVAL
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv5
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;protocol
op_ge
id|PROTOCOL_NT1
)paren
(brace
id|server-&gt;maxxmt
op_assign
id|DVAL
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv3
op_plus
l_int|1
)paren
suffix:semicolon
id|server-&gt;maxmux
op_assign
id|WVAL
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv1
op_plus
l_int|1
)paren
suffix:semicolon
id|server-&gt;maxvcs
op_assign
id|WVAL
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv2
op_plus
l_int|1
)paren
suffix:semicolon
id|server-&gt;blkmode
op_assign
id|DVAL
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv9
op_plus
l_int|1
)paren
suffix:semicolon
id|server-&gt;sesskey
op_assign
id|DVAL
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv7
op_plus
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|server-&gt;maxxmt
op_assign
id|WVAL
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv2
)paren
suffix:semicolon
id|server-&gt;maxmux
op_assign
id|WVAL
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv3
)paren
suffix:semicolon
id|server-&gt;maxvcs
op_assign
id|WVAL
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv4
)paren
suffix:semicolon
id|server-&gt;blkmode
op_assign
id|WVAL
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv5
)paren
suffix:semicolon
id|server-&gt;sesskey
op_assign
id|DVAL
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv6
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|server-&gt;protocol
op_ge
id|PROTOCOL_NT1
)paren
(brace
r_char
op_star
id|workgroup
op_assign
l_string|&quot;WORKGROUP&quot;
suffix:semicolon
r_char
op_star
id|OS_id
op_assign
l_string|&quot;Unix&quot;
suffix:semicolon
r_char
op_star
id|client_id
op_assign
l_string|&quot;ksmbfs&quot;
suffix:semicolon
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBsesssetupX
comma
l_int|13
comma
l_int|5
op_plus
id|userlen
op_plus
id|passlen
op_plus
id|strlen
c_func
(paren
id|workgroup
)paren
op_plus
id|strlen
c_func
(paren
id|OS_id
)paren
op_plus
id|strlen
c_func
(paren
id|client_id
)paren
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv0
comma
l_int|0x00ff
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv1
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv2
comma
id|given_max_xmit
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv3
comma
l_int|2
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv4
comma
id|server-&gt;pid
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv5
comma
id|server-&gt;sesskey
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv7
comma
id|passlen
op_plus
l_int|1
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv8
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv9
comma
l_int|0
)paren
suffix:semicolon
id|p
op_assign
id|SMB_BUF
c_func
(paren
id|server-&gt;packet
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|p
comma
id|server-&gt;m.password
)paren
suffix:semicolon
id|p
op_add_assign
id|passlen
op_plus
l_int|1
suffix:semicolon
id|strcpy
c_func
(paren
id|p
comma
id|server-&gt;m.username
)paren
suffix:semicolon
id|p
op_add_assign
id|userlen
op_plus
l_int|1
suffix:semicolon
id|strcpy
c_func
(paren
id|p
comma
id|workgroup
)paren
suffix:semicolon
id|p
op_add_assign
id|strlen
c_func
(paren
id|p
)paren
op_plus
l_int|1
suffix:semicolon
id|strcpy
c_func
(paren
id|p
comma
id|OS_id
)paren
suffix:semicolon
id|p
op_add_assign
id|strlen
c_func
(paren
id|p
)paren
op_plus
l_int|1
suffix:semicolon
id|strcpy
c_func
(paren
id|p
comma
id|client_id
)paren
suffix:semicolon
)brace
r_else
(brace
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBsesssetupX
comma
l_int|10
comma
l_int|2
op_plus
id|userlen
op_plus
id|passlen
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv0
comma
l_int|0x00ff
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv1
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv2
comma
id|given_max_xmit
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv3
comma
l_int|2
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv4
comma
id|server-&gt;pid
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv5
comma
id|server-&gt;sesskey
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv7
comma
id|passlen
op_plus
l_int|1
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv8
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv9
comma
l_int|0
)paren
suffix:semicolon
id|p
op_assign
id|SMB_BUF
c_func
(paren
id|server-&gt;packet
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|p
comma
id|server-&gt;m.password
)paren
suffix:semicolon
id|p
op_add_assign
id|passlen
op_plus
l_int|1
suffix:semicolon
id|strcpy
c_func
(paren
id|p
comma
id|server-&gt;m.username
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBsesssetupX
comma
l_int|3
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;smb_proc_connect: SMBsessetupX failed&bslash;n&quot;
)paren
suffix:semicolon
id|smb_dont_catch_keepalive
c_func
(paren
id|server
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|smb_decode_word
c_func
(paren
id|server-&gt;packet
op_plus
l_int|32
comma
op_amp
(paren
id|server-&gt;server_uid
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|server-&gt;maxxmt
op_assign
l_int|0
suffix:semicolon
id|server-&gt;maxmux
op_assign
l_int|0
suffix:semicolon
id|server-&gt;maxvcs
op_assign
l_int|0
suffix:semicolon
id|server-&gt;blkmode
op_assign
l_int|0
suffix:semicolon
id|server-&gt;sesskey
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Fine! We have a connection, send a tcon message. */
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBtcon
comma
l_int|0
comma
l_int|6
op_plus
id|strlen
c_func
(paren
id|server-&gt;m.service
)paren
op_plus
id|strlen
c_func
(paren
id|server-&gt;m.password
)paren
op_plus
id|strlen
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|p
op_assign
id|SMB_BUF
c_func
(paren
id|server-&gt;packet
)paren
suffix:semicolon
id|p
op_assign
id|smb_encode_ascii
c_func
(paren
id|p
comma
id|server-&gt;m.service
comma
id|strlen
c_func
(paren
id|server-&gt;m.service
)paren
)paren
suffix:semicolon
id|p
op_assign
id|smb_encode_ascii
c_func
(paren
id|p
comma
id|server-&gt;m.password
comma
id|strlen
c_func
(paren
id|server-&gt;m.password
)paren
)paren
suffix:semicolon
id|p
op_assign
id|smb_encode_ascii
c_func
(paren
id|p
comma
id|dev
comma
id|strlen
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBtcon
comma
l_int|2
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;smb_proc_connect: SMBtcon not verified.&bslash;n&quot;
)paren
suffix:semicolon
id|smb_dont_catch_keepalive
c_func
(paren
id|server
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|DDPRINTK
c_func
(paren
l_string|&quot;OK! Managed to set up SMBtcon!&bslash;n&quot;
)paren
suffix:semicolon
id|p
op_assign
id|SMB_VWV
c_func
(paren
id|server-&gt;packet
)paren
suffix:semicolon
id|p
op_assign
id|smb_decode_word
c_func
(paren
id|p
comma
op_amp
id|server-&gt;max_xmit
)paren
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;max_xmit
OG
id|given_max_xmit
)paren
id|server-&gt;max_xmit
op_assign
id|given_max_xmit
suffix:semicolon
id|p
op_assign
id|smb_decode_word
c_func
(paren
id|p
comma
op_amp
id|server-&gt;tid
)paren
suffix:semicolon
multiline_comment|/* Ok, everything is fine. max_xmit does not include */
multiline_comment|/* the TCP-SMB header of 4 bytes. */
id|server-&gt;max_xmit
op_add_assign
l_int|4
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;max_xmit = %d, tid = %d&bslash;n&quot;
comma
id|server-&gt;max_xmit
comma
id|server-&gt;tid
)paren
suffix:semicolon
multiline_comment|/* Now make a new packet with the correct size. */
id|smb_kfree_s
c_func
(paren
id|server-&gt;packet
comma
id|max_xmit
)paren
suffix:semicolon
id|server-&gt;packet
op_assign
id|smb_kmalloc
c_func
(paren
id|server-&gt;max_xmit
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;packet
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_proc_connect: No memory left in end of &quot;
l_string|&quot;connection phase :-(&bslash;n&quot;
)paren
suffix:semicolon
id|smb_dont_catch_keepalive
c_func
(paren
id|server
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;smb_proc_connect: Normal exit&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|fail
suffix:colon
id|server-&gt;state
op_assign
id|CONN_INVALID
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* smb_proc_reconnect: server-&gt;packet is allocated with&n;   server-&gt;max_xmit bytes if and only if we return &gt;= 0 */
r_int
DECL|function|smb_proc_connect
id|smb_proc_connect
c_func
(paren
r_struct
id|smb_server
op_star
id|server
)paren
(brace
r_int
id|result
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|result
op_assign
id|smb_proc_reconnect
c_func
(paren
id|server
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
OL
l_int|0
)paren
op_logical_and
(paren
id|server-&gt;packet
op_ne
l_int|NULL
)paren
)paren
(brace
id|smb_kfree_s
c_func
(paren
id|server-&gt;packet
comma
id|server-&gt;max_xmit
)paren
suffix:semicolon
id|server-&gt;packet
op_assign
l_int|NULL
suffix:semicolon
)brace
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|smb_proc_disconnect
id|smb_proc_disconnect
c_func
(paren
r_struct
id|smb_server
op_star
id|server
)paren
(brace
id|smb_setup_header_exclusive
c_func
(paren
id|server
comma
id|SMBtdis
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
id|smb_request_ok_unlock
c_func
(paren
id|server
comma
id|SMBtdis
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* error code stuff - put together by Merik Karman&n;   merik@blackadder.dsh.oz.au */
macro_line|#if DEBUG_SMB &gt; 0
r_typedef
r_struct
(brace
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|code
r_int
id|code
suffix:semicolon
DECL|member|message
r_char
op_star
id|message
suffix:semicolon
DECL|typedef|err_code_struct
)brace
id|err_code_struct
suffix:semicolon
multiline_comment|/* Dos Error Messages */
DECL|variable|dos_msgs
id|err_code_struct
id|dos_msgs
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;ERRbadfunc&quot;
comma
l_int|1
comma
l_string|&quot;Invalid function.&quot;
)brace
comma
(brace
l_string|&quot;ERRbadfile&quot;
comma
l_int|2
comma
l_string|&quot;File not found.&quot;
)brace
comma
(brace
l_string|&quot;ERRbadpath&quot;
comma
l_int|3
comma
l_string|&quot;Directory invalid.&quot;
)brace
comma
(brace
l_string|&quot;ERRnofids&quot;
comma
l_int|4
comma
l_string|&quot;No file descriptors available&quot;
)brace
comma
(brace
l_string|&quot;ERRnoaccess&quot;
comma
l_int|5
comma
l_string|&quot;Access denied.&quot;
)brace
comma
(brace
l_string|&quot;ERRbadfid&quot;
comma
l_int|6
comma
l_string|&quot;Invalid file handle.&quot;
)brace
comma
(brace
l_string|&quot;ERRbadmcb&quot;
comma
l_int|7
comma
l_string|&quot;Memory control blocks destroyed.&quot;
)brace
comma
(brace
l_string|&quot;ERRnomem&quot;
comma
l_int|8
comma
l_string|&quot;Insufficient server memory to perform the requested function.&quot;
)brace
comma
(brace
l_string|&quot;ERRbadmem&quot;
comma
l_int|9
comma
l_string|&quot;Invalid memory block address.&quot;
)brace
comma
(brace
l_string|&quot;ERRbadenv&quot;
comma
l_int|10
comma
l_string|&quot;Invalid environment.&quot;
)brace
comma
(brace
l_string|&quot;ERRbadformat&quot;
comma
l_int|11
comma
l_string|&quot;Invalid format.&quot;
)brace
comma
(brace
l_string|&quot;ERRbadaccess&quot;
comma
l_int|12
comma
l_string|&quot;Invalid open mode.&quot;
)brace
comma
(brace
l_string|&quot;ERRbaddata&quot;
comma
l_int|13
comma
l_string|&quot;Invalid data.&quot;
)brace
comma
(brace
l_string|&quot;ERR&quot;
comma
l_int|14
comma
l_string|&quot;reserved.&quot;
)brace
comma
(brace
l_string|&quot;ERRbaddrive&quot;
comma
l_int|15
comma
l_string|&quot;Invalid drive specified.&quot;
)brace
comma
(brace
l_string|&quot;ERRremcd&quot;
comma
l_int|16
comma
l_string|&quot;A Delete Directory request attempted  to  remove  the  server&squot;s  current directory.&quot;
)brace
comma
(brace
l_string|&quot;ERRdiffdevice&quot;
comma
l_int|17
comma
l_string|&quot;Not same device.&quot;
)brace
comma
(brace
l_string|&quot;ERRnofiles&quot;
comma
l_int|18
comma
l_string|&quot;A File Search command can find no more files matching the specified criteria.&quot;
)brace
comma
(brace
l_string|&quot;ERRbadshare&quot;
comma
l_int|32
comma
l_string|&quot;The sharing mode specified for an Open conflicts with existing  FIDs  on the file.&quot;
)brace
comma
(brace
l_string|&quot;ERRlock&quot;
comma
l_int|33
comma
l_string|&quot;A Lock request conflicted with an existing lock or specified an  invalid mode,  or an Unlock requested attempted to remove a lock held by another process.&quot;
)brace
comma
(brace
l_string|&quot;ERRfilexists&quot;
comma
l_int|80
comma
l_string|&quot;The file named in a Create Directory, Make  New  File  or  Link  request already exists.&quot;
)brace
comma
(brace
l_string|&quot;ERRbadpipe&quot;
comma
l_int|230
comma
l_string|&quot;Pipe invalid.&quot;
)brace
comma
(brace
l_string|&quot;ERRpipebusy&quot;
comma
l_int|231
comma
l_string|&quot;All instances of the requested pipe are busy.&quot;
)brace
comma
(brace
l_string|&quot;ERRpipeclosing&quot;
comma
l_int|232
comma
l_string|&quot;Pipe close in progress.&quot;
)brace
comma
(brace
l_string|&quot;ERRnotconnected&quot;
comma
l_int|233
comma
l_string|&quot;No process on other end of pipe.&quot;
)brace
comma
(brace
l_string|&quot;ERRmoredata&quot;
comma
l_int|234
comma
l_string|&quot;There is more data to be returned.&quot;
)brace
comma
(brace
l_int|NULL
comma
op_minus
l_int|1
comma
l_int|NULL
)brace
)brace
suffix:semicolon
multiline_comment|/* Server Error Messages */
DECL|variable|server_msgs
id|err_code_struct
id|server_msgs
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;ERRerror&quot;
comma
l_int|1
comma
l_string|&quot;Non-specific error code.&quot;
)brace
comma
(brace
l_string|&quot;ERRbadpw&quot;
comma
l_int|2
comma
l_string|&quot;Bad password - name/password pair in a Tree Connect or Session Setup are invalid.&quot;
)brace
comma
(brace
l_string|&quot;ERRbadtype&quot;
comma
l_int|3
comma
l_string|&quot;reserved.&quot;
)brace
comma
(brace
l_string|&quot;ERRaccess&quot;
comma
l_int|4
comma
l_string|&quot;The requester does not have  the  necessary  access  rights  within  the specified  context for the requested function. The context is defined by the TID or the UID.&quot;
)brace
comma
(brace
l_string|&quot;ERRinvnid&quot;
comma
l_int|5
comma
l_string|&quot;The tree ID (TID) specified in a command was invalid.&quot;
)brace
comma
(brace
l_string|&quot;ERRinvnetname&quot;
comma
l_int|6
comma
l_string|&quot;Invalid network name in tree connect.&quot;
)brace
comma
(brace
l_string|&quot;ERRinvdevice&quot;
comma
l_int|7
comma
l_string|&quot;Invalid device - printer request made to non-printer connection or  non-printer request made to printer connection.&quot;
)brace
comma
(brace
l_string|&quot;ERRqfull&quot;
comma
l_int|49
comma
l_string|&quot;Print queue full (files) -- returned by open print file.&quot;
)brace
comma
(brace
l_string|&quot;ERRqtoobig&quot;
comma
l_int|50
comma
l_string|&quot;Print queue full -- no space.&quot;
)brace
comma
(brace
l_string|&quot;ERRqeof&quot;
comma
l_int|51
comma
l_string|&quot;EOF on print queue dump.&quot;
)brace
comma
(brace
l_string|&quot;ERRinvpfid&quot;
comma
l_int|52
comma
l_string|&quot;Invalid print file FID.&quot;
)brace
comma
(brace
l_string|&quot;ERRsmbcmd&quot;
comma
l_int|64
comma
l_string|&quot;The server did not recognize the command received.&quot;
)brace
comma
(brace
l_string|&quot;ERRsrverror&quot;
comma
l_int|65
comma
l_string|&quot;The server encountered an internal error, e.g., system file unavailable.&quot;
)brace
comma
(brace
l_string|&quot;ERRfilespecs&quot;
comma
l_int|67
comma
l_string|&quot;The file handle (FID) and pathname parameters contained an invalid  combination of values.&quot;
)brace
comma
(brace
l_string|&quot;ERRreserved&quot;
comma
l_int|68
comma
l_string|&quot;reserved.&quot;
)brace
comma
(brace
l_string|&quot;ERRbadpermits&quot;
comma
l_int|69
comma
l_string|&quot;The access permissions specified for a file or directory are not a valid combination.  The server cannot set the requested attribute.&quot;
)brace
comma
(brace
l_string|&quot;ERRreserved&quot;
comma
l_int|70
comma
l_string|&quot;reserved.&quot;
)brace
comma
(brace
l_string|&quot;ERRsetattrmode&quot;
comma
l_int|71
comma
l_string|&quot;The attribute mode in the Set File Attribute request is invalid.&quot;
)brace
comma
(brace
l_string|&quot;ERRpaused&quot;
comma
l_int|81
comma
l_string|&quot;Server is paused.&quot;
)brace
comma
(brace
l_string|&quot;ERRmsgoff&quot;
comma
l_int|82
comma
l_string|&quot;Not receiving messages.&quot;
)brace
comma
(brace
l_string|&quot;ERRnoroom&quot;
comma
l_int|83
comma
l_string|&quot;No room to buffer message.&quot;
)brace
comma
(brace
l_string|&quot;ERRrmuns&quot;
comma
l_int|87
comma
l_string|&quot;Too many remote user names.&quot;
)brace
comma
(brace
l_string|&quot;ERRtimeout&quot;
comma
l_int|88
comma
l_string|&quot;Operation timed out.&quot;
)brace
comma
(brace
l_string|&quot;ERRnoresource&quot;
comma
l_int|89
comma
l_string|&quot;No resources currently available for request.&quot;
)brace
comma
(brace
l_string|&quot;ERRtoomanyuids&quot;
comma
l_int|90
comma
l_string|&quot;Too many UIDs active on this session.&quot;
)brace
comma
(brace
l_string|&quot;ERRbaduid&quot;
comma
l_int|91
comma
l_string|&quot;The UID is not known as a valid ID on this session.&quot;
)brace
comma
(brace
l_string|&quot;ERRusempx&quot;
comma
l_int|250
comma
l_string|&quot;Temp unable to support Raw, use MPX mode.&quot;
)brace
comma
(brace
l_string|&quot;ERRusestd&quot;
comma
l_int|251
comma
l_string|&quot;Temp unable to support Raw, use standard read/write.&quot;
)brace
comma
(brace
l_string|&quot;ERRcontmpx&quot;
comma
l_int|252
comma
l_string|&quot;Continue in MPX mode.&quot;
)brace
comma
(brace
l_string|&quot;ERRreserved&quot;
comma
l_int|253
comma
l_string|&quot;reserved.&quot;
)brace
comma
(brace
l_string|&quot;ERRreserved&quot;
comma
l_int|254
comma
l_string|&quot;reserved.&quot;
)brace
comma
(brace
l_string|&quot;ERRnosupport&quot;
comma
l_int|0xFFFF
comma
l_string|&quot;Function not supported.&quot;
)brace
comma
(brace
l_int|NULL
comma
op_minus
l_int|1
comma
l_int|NULL
)brace
)brace
suffix:semicolon
multiline_comment|/* Hard Error Messages */
DECL|variable|hard_msgs
id|err_code_struct
id|hard_msgs
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;ERRnowrite&quot;
comma
l_int|19
comma
l_string|&quot;Attempt to write on write-protected diskette.&quot;
)brace
comma
(brace
l_string|&quot;ERRbadunit&quot;
comma
l_int|20
comma
l_string|&quot;Unknown unit.&quot;
)brace
comma
(brace
l_string|&quot;ERRnotready&quot;
comma
l_int|21
comma
l_string|&quot;Drive not ready.&quot;
)brace
comma
(brace
l_string|&quot;ERRbadcmd&quot;
comma
l_int|22
comma
l_string|&quot;Unknown command.&quot;
)brace
comma
(brace
l_string|&quot;ERRdata&quot;
comma
l_int|23
comma
l_string|&quot;Data error (CRC).&quot;
)brace
comma
(brace
l_string|&quot;ERRbadreq&quot;
comma
l_int|24
comma
l_string|&quot;Bad request structure length.&quot;
)brace
comma
(brace
l_string|&quot;ERRseek&quot;
comma
l_int|25
comma
l_string|&quot;Seek error.&quot;
)brace
comma
(brace
l_string|&quot;ERRbadmedia&quot;
comma
l_int|26
comma
l_string|&quot;Unknown media type.&quot;
)brace
comma
(brace
l_string|&quot;ERRbadsector&quot;
comma
l_int|27
comma
l_string|&quot;Sector not found.&quot;
)brace
comma
(brace
l_string|&quot;ERRnopaper&quot;
comma
l_int|28
comma
l_string|&quot;Printer out of paper.&quot;
)brace
comma
(brace
l_string|&quot;ERRwrite&quot;
comma
l_int|29
comma
l_string|&quot;Write fault.&quot;
)brace
comma
(brace
l_string|&quot;ERRread&quot;
comma
l_int|30
comma
l_string|&quot;Read fault.&quot;
)brace
comma
(brace
l_string|&quot;ERRgeneral&quot;
comma
l_int|31
comma
l_string|&quot;General failure.&quot;
)brace
comma
(brace
l_string|&quot;ERRbadshare&quot;
comma
l_int|32
comma
l_string|&quot;A open conflicts with an existing open.&quot;
)brace
comma
(brace
l_string|&quot;ERRlock&quot;
comma
l_int|33
comma
l_string|&quot;A Lock request conflicted with an existing lock or specified an invalid mode, or an Unlock requested attempted to remove a lock held by another process.&quot;
)brace
comma
(brace
l_string|&quot;ERRwrongdisk&quot;
comma
l_int|34
comma
l_string|&quot;The wrong disk was found in a drive.&quot;
)brace
comma
(brace
l_string|&quot;ERRFCBUnavail&quot;
comma
l_int|35
comma
l_string|&quot;No FCBs are available to process request.&quot;
)brace
comma
(brace
l_string|&quot;ERRsharebufexc&quot;
comma
l_int|36
comma
l_string|&quot;A sharing buffer has been exceeded.&quot;
)brace
comma
(brace
l_int|NULL
comma
op_minus
l_int|1
comma
l_int|NULL
)brace
)brace
suffix:semicolon
r_struct
(brace
DECL|member|code
r_int
id|code
suffix:semicolon
DECL|member|class
r_char
op_star
r_class
suffix:semicolon
DECL|member|err_msgs
id|err_code_struct
op_star
id|err_msgs
suffix:semicolon
DECL|variable|err_classes
)brace
id|err_classes
(braket
)braket
op_assign
(brace
(brace
l_int|0
comma
l_string|&quot;SUCCESS&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x01
comma
l_string|&quot;ERRDOS&quot;
comma
id|dos_msgs
)brace
comma
(brace
l_int|0x02
comma
l_string|&quot;ERRSRV&quot;
comma
id|server_msgs
)brace
comma
(brace
l_int|0x03
comma
l_string|&quot;ERRHRD&quot;
comma
id|hard_msgs
)brace
comma
(brace
l_int|0x04
comma
l_string|&quot;ERRXOS&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0xE1
comma
l_string|&quot;ERRRMX1&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0xE2
comma
l_string|&quot;ERRRMX2&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0xE3
comma
l_string|&quot;ERRRMX3&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0xFF
comma
l_string|&quot;ERRCMD&quot;
comma
l_int|NULL
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|NULL
comma
l_int|NULL
)brace
)brace
suffix:semicolon
r_void
DECL|function|smb_printerr
id|smb_printerr
c_func
(paren
r_int
r_class
comma
r_int
id|num
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
id|err_code_struct
op_star
id|err
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|err_classes
(braket
id|i
)braket
dot
r_class
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|err_classes
(braket
id|i
)braket
dot
id|code
op_ne
r_class
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err_classes
(braket
id|i
)braket
dot
id|err_msgs
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s - %d&quot;
comma
id|err_classes
(braket
id|i
)braket
dot
r_class
comma
id|num
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|err
op_assign
id|err_classes
(braket
id|i
)braket
dot
id|err_msgs
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|err
(braket
id|j
)braket
dot
id|name
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|num
op_ne
id|err
(braket
id|j
)braket
dot
id|code
)paren
r_continue
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s - %s (%s)&quot;
comma
id|err_classes
(braket
id|i
)braket
dot
r_class
comma
id|err
(braket
id|j
)braket
dot
id|name
comma
id|err
(braket
id|j
)braket
dot
id|message
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;Unknown error - (%d,%d)&quot;
comma
r_class
comma
id|num
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif /* DEBUG_SMB &gt; 0 */
eof
