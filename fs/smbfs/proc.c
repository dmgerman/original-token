multiline_comment|/*&n; *  proc.c&n; *&n; *  Copyright (C) 1995, 1996 by Paal-Kr. Engstad and Volker Lendecke&n; *  Copyright (C) 1997 by Volker Lendecke&n; *&n; *  28/06/96 - Fixed long file name support (smb_proc_readdir_long) by Yuri Per&n; *  28/09/97 - Fixed smb_d_path [now smb_build_path()] to be non-recursive&n; *             by Riccardo Facchetti&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/smbno.h&gt;
macro_line|#include &lt;linux/smb_fs.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/dcache.h&gt;
macro_line|#include &lt;linux/dirent.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/string.h&gt;
DECL|macro|SMB_VWV
mdefine_line|#define SMB_VWV(packet)  ((packet) + SMB_HEADER_LEN)
DECL|macro|SMB_CMD
mdefine_line|#define SMB_CMD(packet)  (*(packet+8))
DECL|macro|SMB_WCT
mdefine_line|#define SMB_WCT(packet)  (*(packet+SMB_HEADER_LEN - 1))
DECL|macro|SMB_BCC
mdefine_line|#define SMB_BCC(packet)  smb_bcc(packet)
DECL|macro|SMB_BUF
mdefine_line|#define SMB_BUF(packet)  ((packet) + SMB_HEADER_LEN + SMB_WCT(packet) * 2 + 2)
DECL|macro|SMB_DIRINFO_SIZE
mdefine_line|#define SMB_DIRINFO_SIZE 43
DECL|macro|SMB_STATUS_SIZE
mdefine_line|#define SMB_STATUS_SIZE  21
DECL|macro|SMBFS_PARANOIA
mdefine_line|#define SMBFS_PARANOIA 1
multiline_comment|/* #define SMBFS_DEBUG_VERBOSE 1 */
multiline_comment|/* #define pr_debug printk */
r_extern
r_void
id|smb_renew_times
c_func
(paren
r_struct
id|dentry
op_star
)paren
suffix:semicolon
r_static
r_inline
r_int
DECL|function|min
id|min
c_func
(paren
r_int
id|a
comma
r_int
id|b
)paren
(brace
r_return
id|a
OL
id|b
ques
c_cond
id|a
suffix:colon
id|b
suffix:semicolon
)brace
r_static
r_void
DECL|function|str_upper
id|str_upper
c_func
(paren
r_char
op_star
id|name
)paren
(brace
r_while
c_loop
(paren
op_star
id|name
)paren
(brace
r_if
c_cond
(paren
op_star
id|name
op_ge
l_char|&squot;a&squot;
op_logical_and
op_star
id|name
op_le
l_char|&squot;z&squot;
)paren
op_star
id|name
op_sub_assign
(paren
l_char|&squot;a&squot;
op_minus
l_char|&squot;A&squot;
)paren
suffix:semicolon
id|name
op_increment
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|str_lower
id|str_lower
c_func
(paren
r_char
op_star
id|name
)paren
(brace
r_while
c_loop
(paren
op_star
id|name
)paren
(brace
r_if
c_cond
(paren
op_star
id|name
op_ge
l_char|&squot;A&squot;
op_logical_and
op_star
id|name
op_le
l_char|&squot;Z&squot;
)paren
op_star
id|name
op_add_assign
(paren
l_char|&squot;a&squot;
op_minus
l_char|&squot;A&squot;
)paren
suffix:semicolon
id|name
op_increment
suffix:semicolon
)brace
)brace
DECL|function|reverse_string
r_static
r_void
id|reverse_string
c_func
(paren
r_char
op_star
id|buf
comma
r_int
id|len
)paren
(brace
r_char
id|c
suffix:semicolon
r_char
op_star
id|end
op_assign
id|buf
op_plus
id|len
op_minus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|buf
OL
id|end
)paren
(brace
id|c
op_assign
op_star
id|buf
suffix:semicolon
op_star
(paren
id|buf
op_increment
)paren
op_assign
op_star
id|end
suffix:semicolon
op_star
(paren
id|end
op_decrement
)paren
op_assign
id|c
suffix:semicolon
)brace
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*                                                                           */
multiline_comment|/*  Encoding/Decoding section                                                */
multiline_comment|/*                                                                           */
multiline_comment|/*****************************************************************************/
id|__u8
op_star
DECL|function|smb_encode_smb_length
id|smb_encode_smb_length
c_func
(paren
id|__u8
op_star
id|p
comma
id|__u32
id|len
)paren
(brace
op_star
id|p
op_assign
l_int|0
suffix:semicolon
op_star
(paren
id|p
op_plus
l_int|1
)paren
op_assign
l_int|0
suffix:semicolon
op_star
(paren
id|p
op_plus
l_int|2
)paren
op_assign
(paren
id|len
op_amp
l_int|0xFF00
)paren
op_rshift
l_int|8
suffix:semicolon
op_star
(paren
id|p
op_plus
l_int|3
)paren
op_assign
(paren
id|len
op_amp
l_int|0xFF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0xFFFF
)paren
(brace
op_star
(paren
id|p
op_plus
l_int|1
)paren
op_assign
l_int|1
suffix:semicolon
)brace
r_return
id|p
op_plus
l_int|4
suffix:semicolon
)brace
multiline_comment|/*&n; * smb_build_path: build the path to entry and name storing it in buf.&n; * The path returned will have the trailing &squot;&bslash;0&squot;.&n; */
DECL|function|smb_build_path
r_static
r_int
id|smb_build_path
c_func
(paren
r_struct
id|dentry
op_star
id|entry
comma
r_struct
id|qstr
op_star
id|name
comma
r_char
op_star
id|buf
)paren
(brace
r_char
op_star
id|path
op_assign
id|buf
suffix:semicolon
r_if
c_cond
(paren
id|entry
op_eq
l_int|NULL
)paren
r_goto
id|test_name_and_out
suffix:semicolon
multiline_comment|/*&n;&t; * If IS_ROOT, we have to do no walking at all.&n;&t; */
r_if
c_cond
(paren
id|IS_ROOT
c_func
(paren
id|entry
)paren
)paren
(brace
op_star
(paren
id|path
op_increment
)paren
op_assign
l_char|&squot;&bslash;&bslash;&squot;
suffix:semicolon
r_if
c_cond
(paren
id|name
op_ne
l_int|NULL
)paren
r_goto
id|name_and_out
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Build the path string walking the tree backward from end to ROOT&n;&t; * and store it in reversed order [see reverse_string()]&n;&t; */
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|memcpy
c_func
(paren
id|path
comma
id|entry-&gt;d_name.name
comma
id|entry-&gt;d_name.len
)paren
suffix:semicolon
id|reverse_string
c_func
(paren
id|path
comma
id|entry-&gt;d_name.len
)paren
suffix:semicolon
id|path
op_add_assign
id|entry-&gt;d_name.len
suffix:semicolon
op_star
(paren
id|path
op_increment
)paren
op_assign
l_char|&squot;&bslash;&bslash;&squot;
suffix:semicolon
id|entry
op_assign
id|entry-&gt;d_parent
suffix:semicolon
r_if
c_cond
(paren
id|IS_ROOT
c_func
(paren
id|entry
)paren
)paren
r_break
suffix:semicolon
)brace
id|reverse_string
c_func
(paren
id|buf
comma
id|path
op_minus
id|buf
)paren
suffix:semicolon
id|test_name_and_out
suffix:colon
r_if
c_cond
(paren
id|name
op_ne
l_int|NULL
)paren
(brace
op_star
(paren
id|path
op_increment
)paren
op_assign
l_char|&squot;&bslash;&bslash;&squot;
suffix:semicolon
id|name_and_out
suffix:colon
id|memcpy
c_func
(paren
id|path
comma
id|name-&gt;name
comma
id|name-&gt;len
)paren
suffix:semicolon
id|path
op_add_assign
id|name-&gt;len
suffix:semicolon
)brace
id|out
suffix:colon
op_star
(paren
id|path
op_increment
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
(paren
id|path
op_minus
id|buf
)paren
suffix:semicolon
)brace
DECL|function|smb_encode_path
r_static
r_char
op_star
id|smb_encode_path
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_char
op_star
id|buf
comma
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|qstr
op_star
id|name
)paren
(brace
r_char
op_star
id|start
op_assign
id|buf
suffix:semicolon
id|buf
op_add_assign
id|smb_build_path
c_func
(paren
id|dir
comma
id|name
comma
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;opt.protocol
op_le
id|SMB_PROTOCOL_COREPLUS
)paren
id|str_upper
c_func
(paren
id|start
)paren
suffix:semicolon
r_return
id|buf
suffix:semicolon
)brace
multiline_comment|/* The following are taken directly from msdos-fs */
multiline_comment|/* Linear day numbers of the respective 1sts in non-leap years. */
DECL|variable|day_n
r_static
r_int
id|day_n
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|31
comma
l_int|59
comma
l_int|90
comma
l_int|120
comma
l_int|151
comma
l_int|181
comma
l_int|212
comma
l_int|243
comma
l_int|273
comma
l_int|304
comma
l_int|334
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/* JanFebMarApr May Jun Jul Aug Sep Oct Nov Dec */
r_extern
r_struct
id|timezone
id|sys_tz
suffix:semicolon
r_static
r_int
DECL|function|utc2local
id|utc2local
c_func
(paren
r_int
id|time
)paren
(brace
r_return
id|time
op_minus
id|sys_tz.tz_minuteswest
op_star
l_int|60
suffix:semicolon
)brace
r_static
r_int
DECL|function|local2utc
id|local2utc
c_func
(paren
r_int
id|time
)paren
(brace
r_return
id|time
op_plus
id|sys_tz.tz_minuteswest
op_star
l_int|60
suffix:semicolon
)brace
multiline_comment|/* Convert a MS-DOS time/date pair to a UNIX date (seconds since 1 1 70). */
r_static
r_int
DECL|function|date_dos2unix
id|date_dos2unix
c_func
(paren
r_int
r_int
id|time
comma
r_int
r_int
id|date
)paren
(brace
r_int
id|month
comma
id|year
comma
id|secs
suffix:semicolon
id|month
op_assign
(paren
(paren
id|date
op_rshift
l_int|5
)paren
op_amp
l_int|15
)paren
op_minus
l_int|1
suffix:semicolon
id|year
op_assign
id|date
op_rshift
l_int|9
suffix:semicolon
id|secs
op_assign
(paren
id|time
op_amp
l_int|31
)paren
op_star
l_int|2
op_plus
l_int|60
op_star
(paren
(paren
id|time
op_rshift
l_int|5
)paren
op_amp
l_int|63
)paren
op_plus
(paren
id|time
op_rshift
l_int|11
)paren
op_star
l_int|3600
op_plus
l_int|86400
op_star
(paren
(paren
id|date
op_amp
l_int|31
)paren
op_minus
l_int|1
op_plus
id|day_n
(braket
id|month
)braket
op_plus
(paren
id|year
op_div
l_int|4
)paren
op_plus
id|year
op_star
l_int|365
op_minus
(paren
(paren
id|year
op_amp
l_int|3
)paren
op_eq
l_int|0
op_logical_and
id|month
OL
l_int|2
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
op_plus
l_int|3653
)paren
suffix:semicolon
multiline_comment|/* days since 1.1.70 plus 80&squot;s leap day */
r_return
id|local2utc
c_func
(paren
id|secs
)paren
suffix:semicolon
)brace
multiline_comment|/* Convert linear UNIX date to a MS-DOS time/date pair. */
r_static
r_void
DECL|function|date_unix2dos
id|date_unix2dos
c_func
(paren
r_int
id|unix_date
comma
id|__u8
op_star
id|date
comma
id|__u8
op_star
id|time
)paren
(brace
r_int
id|day
comma
id|year
comma
id|nl_day
comma
id|month
suffix:semicolon
id|unix_date
op_assign
id|utc2local
c_func
(paren
id|unix_date
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|time
comma
l_int|0
comma
(paren
id|unix_date
op_mod
l_int|60
)paren
op_div
l_int|2
op_plus
(paren
(paren
(paren
id|unix_date
op_div
l_int|60
)paren
op_mod
l_int|60
)paren
op_lshift
l_int|5
)paren
op_plus
(paren
(paren
(paren
id|unix_date
op_div
l_int|3600
)paren
op_mod
l_int|24
)paren
op_lshift
l_int|11
)paren
)paren
suffix:semicolon
id|day
op_assign
id|unix_date
op_div
l_int|86400
op_minus
l_int|3652
suffix:semicolon
id|year
op_assign
id|day
op_div
l_int|365
suffix:semicolon
r_if
c_cond
(paren
(paren
id|year
op_plus
l_int|3
)paren
op_div
l_int|4
op_plus
l_int|365
op_star
id|year
OG
id|day
)paren
id|year
op_decrement
suffix:semicolon
id|day
op_sub_assign
(paren
id|year
op_plus
l_int|3
)paren
op_div
l_int|4
op_plus
l_int|365
op_star
id|year
suffix:semicolon
r_if
c_cond
(paren
id|day
op_eq
l_int|59
op_logical_and
op_logical_neg
(paren
id|year
op_amp
l_int|3
)paren
)paren
(brace
id|nl_day
op_assign
id|day
suffix:semicolon
id|month
op_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
id|nl_day
op_assign
(paren
id|year
op_amp
l_int|3
)paren
op_logical_or
id|day
op_le
l_int|59
ques
c_cond
id|day
suffix:colon
id|day
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|month
op_assign
l_int|0
suffix:semicolon
id|month
OL
l_int|12
suffix:semicolon
id|month
op_increment
)paren
r_if
c_cond
(paren
id|day_n
(braket
id|month
)braket
OG
id|nl_day
)paren
r_break
suffix:semicolon
)brace
id|WSET
c_func
(paren
id|date
comma
l_int|0
comma
id|nl_day
op_minus
id|day_n
(braket
id|month
op_minus
l_int|1
)braket
op_plus
l_int|1
op_plus
(paren
id|month
op_lshift
l_int|5
)paren
op_plus
(paren
id|year
op_lshift
l_int|9
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*                                                                           */
multiline_comment|/*  Support section.                                                         */
multiline_comment|/*                                                                           */
multiline_comment|/*****************************************************************************/
id|__u32
DECL|function|smb_len
id|smb_len
c_func
(paren
id|__u8
op_star
id|p
)paren
(brace
r_return
(paren
(paren
op_star
(paren
id|p
op_plus
l_int|1
)paren
op_amp
l_int|0x1
)paren
op_lshift
l_int|16L
)paren
op_or
(paren
op_star
(paren
id|p
op_plus
l_int|2
)paren
op_lshift
l_int|8L
)paren
op_or
op_star
(paren
id|p
op_plus
l_int|3
)paren
suffix:semicolon
)brace
r_static
id|__u16
DECL|function|smb_bcc
id|smb_bcc
c_func
(paren
id|__u8
op_star
id|packet
)paren
(brace
r_int
id|pos
op_assign
id|SMB_HEADER_LEN
op_plus
id|SMB_WCT
c_func
(paren
id|packet
)paren
op_star
r_sizeof
(paren
id|__u16
)paren
suffix:semicolon
r_return
id|WVAL
c_func
(paren
id|packet
comma
id|pos
)paren
suffix:semicolon
)brace
multiline_comment|/* smb_valid_packet: We check if packet fulfills the basic&n;   requirements of a smb packet */
r_static
r_int
DECL|function|smb_valid_packet
id|smb_valid_packet
c_func
(paren
id|__u8
op_star
id|packet
)paren
(brace
r_return
(paren
id|packet
(braket
l_int|4
)braket
op_eq
l_int|0xff
op_logical_and
id|packet
(braket
l_int|5
)braket
op_eq
l_char|&squot;S&squot;
op_logical_and
id|packet
(braket
l_int|6
)braket
op_eq
l_char|&squot;M&squot;
op_logical_and
id|packet
(braket
l_int|7
)braket
op_eq
l_char|&squot;B&squot;
op_logical_and
(paren
id|smb_len
c_func
(paren
id|packet
)paren
op_plus
l_int|4
op_eq
id|SMB_HEADER_LEN
op_plus
id|SMB_WCT
c_func
(paren
id|packet
)paren
op_star
l_int|2
op_plus
id|SMB_BCC
c_func
(paren
id|packet
)paren
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* smb_verify: We check if we got the answer we expected, and if we&n;   got enough data. If bcc == -1, we don&squot;t care. */
r_static
r_int
DECL|function|smb_verify
id|smb_verify
c_func
(paren
id|__u8
op_star
id|packet
comma
r_int
id|command
comma
r_int
id|wct
comma
r_int
id|bcc
)paren
(brace
r_return
(paren
id|SMB_CMD
c_func
(paren
id|packet
)paren
op_eq
id|command
op_logical_and
id|SMB_WCT
c_func
(paren
id|packet
)paren
op_ge
id|wct
op_logical_and
(paren
id|bcc
op_eq
op_minus
l_int|1
op_logical_or
id|SMB_BCC
c_func
(paren
id|packet
)paren
op_ge
id|bcc
)paren
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/*&n; * Returns the maximum read or write size for the current packet size&n; * and max_xmit value.&n; * N.B. Since this value is usually computed before locking the server,&n; * the server&squot;s packet size must never be decreased!&n; */
r_static
r_int
DECL|function|smb_get_xmitsize
id|smb_get_xmitsize
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_int
id|overhead
)paren
(brace
r_int
id|size
op_assign
id|server-&gt;packet_size
suffix:semicolon
multiline_comment|/*&n;&t; * Start with the smaller of packet size and max_xmit ...&n;&t; */
r_if
c_cond
(paren
id|size
OG
id|server-&gt;opt.max_xmit
)paren
id|size
op_assign
id|server-&gt;opt.max_xmit
suffix:semicolon
r_return
id|size
op_minus
id|overhead
suffix:semicolon
)brace
multiline_comment|/*&n; * Calculate the maximum read size&n; */
r_int
DECL|function|smb_get_rsize
id|smb_get_rsize
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
)paren
(brace
r_int
id|overhead
op_assign
id|SMB_HEADER_LEN
op_plus
l_int|5
op_star
r_sizeof
(paren
id|__u16
)paren
op_plus
l_int|2
op_plus
l_int|1
op_plus
l_int|2
suffix:semicolon
r_int
id|size
op_assign
id|smb_get_xmitsize
c_func
(paren
id|server
comma
id|overhead
)paren
suffix:semicolon
macro_line|#ifdef SMBFS_DEBUG_VERBOSE
id|printk
c_func
(paren
l_string|&quot;smb_get_rsize: packet=%d, xmit=%d, size=%d&bslash;n&quot;
comma
id|server-&gt;packet_size
comma
id|server-&gt;opt.max_xmit
comma
id|size
)paren
suffix:semicolon
macro_line|#endif
r_return
id|size
suffix:semicolon
)brace
multiline_comment|/*&n; * Calculate the maximum write size&n; */
r_int
DECL|function|smb_get_wsize
id|smb_get_wsize
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
)paren
(brace
r_int
id|overhead
op_assign
id|SMB_HEADER_LEN
op_plus
l_int|5
op_star
r_sizeof
(paren
id|__u16
)paren
op_plus
l_int|2
op_plus
l_int|1
op_plus
l_int|2
suffix:semicolon
r_int
id|size
op_assign
id|smb_get_xmitsize
c_func
(paren
id|server
comma
id|overhead
)paren
suffix:semicolon
macro_line|#ifdef SMBFS_DEBUG_VERBOSE
id|printk
c_func
(paren
l_string|&quot;smb_get_wsize: packet=%d, xmit=%d, size=%d&bslash;n&quot;
comma
id|server-&gt;packet_size
comma
id|server-&gt;opt.max_xmit
comma
id|size
)paren
suffix:semicolon
macro_line|#endif
r_return
id|size
suffix:semicolon
)brace
r_static
r_int
DECL|function|smb_errno
id|smb_errno
c_func
(paren
r_int
id|errcls
comma
r_int
id|error
)paren
(brace
r_if
c_cond
(paren
id|errcls
op_eq
id|ERRDOS
)paren
r_switch
c_cond
(paren
id|error
)paren
(brace
r_case
id|ERRbadfunc
suffix:colon
r_return
id|EINVAL
suffix:semicolon
r_case
id|ERRbadfile
suffix:colon
r_return
id|ENOENT
suffix:semicolon
r_case
id|ERRbadpath
suffix:colon
r_return
id|ENOENT
suffix:semicolon
r_case
id|ERRnofids
suffix:colon
r_return
id|EMFILE
suffix:semicolon
r_case
id|ERRnoaccess
suffix:colon
r_return
id|EACCES
suffix:semicolon
r_case
id|ERRbadfid
suffix:colon
r_return
id|EBADF
suffix:semicolon
r_case
id|ERRbadmcb
suffix:colon
r_return
id|EREMOTEIO
suffix:semicolon
r_case
id|ERRnomem
suffix:colon
r_return
id|ENOMEM
suffix:semicolon
r_case
id|ERRbadmem
suffix:colon
r_return
id|EFAULT
suffix:semicolon
r_case
id|ERRbadenv
suffix:colon
r_return
id|EREMOTEIO
suffix:semicolon
r_case
id|ERRbadformat
suffix:colon
r_return
id|EREMOTEIO
suffix:semicolon
r_case
id|ERRbadaccess
suffix:colon
r_return
id|EACCES
suffix:semicolon
r_case
id|ERRbaddata
suffix:colon
r_return
id|E2BIG
suffix:semicolon
r_case
id|ERRbaddrive
suffix:colon
r_return
id|ENXIO
suffix:semicolon
r_case
id|ERRremcd
suffix:colon
r_return
id|EREMOTEIO
suffix:semicolon
r_case
id|ERRdiffdevice
suffix:colon
r_return
id|EXDEV
suffix:semicolon
r_case
id|ERRnofiles
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|ERRbadshare
suffix:colon
r_return
id|ETXTBSY
suffix:semicolon
r_case
id|ERRlock
suffix:colon
r_return
id|EDEADLK
suffix:semicolon
r_case
id|ERRfilexists
suffix:colon
r_return
id|EEXIST
suffix:semicolon
r_case
l_int|87
suffix:colon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Unknown error!! */
r_case
l_int|123
suffix:colon
multiline_comment|/* Invalid name?? e.g. .tmp* */
r_return
id|ENOENT
suffix:semicolon
multiline_comment|/* This next error seems to occur on an mv when&n;&t;&t;&t; * the destination exists */
r_case
l_int|183
suffix:colon
r_return
id|EEXIST
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;smb_errno: ERRDOS code %d, returning EIO&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
r_return
id|EIO
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|errcls
op_eq
id|ERRSRV
)paren
r_switch
c_cond
(paren
id|error
)paren
(brace
r_case
id|ERRerror
suffix:colon
r_return
id|ENFILE
suffix:semicolon
r_case
id|ERRbadpw
suffix:colon
r_return
id|EINVAL
suffix:semicolon
r_case
id|ERRbadtype
suffix:colon
r_return
id|EIO
suffix:semicolon
r_case
id|ERRaccess
suffix:colon
r_return
id|EACCES
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;smb_errno: ERRSRV code %d, returning EIO&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
r_return
id|EIO
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|errcls
op_eq
id|ERRHRD
)paren
r_switch
c_cond
(paren
id|error
)paren
(brace
r_case
id|ERRnowrite
suffix:colon
r_return
id|EROFS
suffix:semicolon
r_case
id|ERRbadunit
suffix:colon
r_return
id|ENODEV
suffix:semicolon
r_case
id|ERRnotready
suffix:colon
r_return
id|EUCLEAN
suffix:semicolon
r_case
id|ERRbadcmd
suffix:colon
r_return
id|EIO
suffix:semicolon
r_case
id|ERRdata
suffix:colon
r_return
id|EIO
suffix:semicolon
r_case
id|ERRbadreq
suffix:colon
r_return
id|ERANGE
suffix:semicolon
r_case
id|ERRbadshare
suffix:colon
r_return
id|ETXTBSY
suffix:semicolon
r_case
id|ERRlock
suffix:colon
r_return
id|EDEADLK
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;smb_errno: ERRHRD code %d, returning EIO&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
r_return
id|EIO
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|errcls
op_eq
id|ERRCMD
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_errno: ERRCMD code %d, returning EIO&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
r_return
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|smb_lock_server
id|smb_lock_server
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
)paren
(brace
id|down
c_func
(paren
op_amp
(paren
id|server-&gt;sem
)paren
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|smb_unlock_server
id|smb_unlock_server
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
)paren
(brace
id|up
c_func
(paren
op_amp
(paren
id|server-&gt;sem
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * smb_retry: This function should be called when smb_request_ok has&n;   indicated an error. If the error was indicated because the&n;   connection was killed, we try to reconnect. If smb_retry returns 0,&n;   the error was indicated for another reason, so a retry would not be&n;   of any use.&n; * N.B. The server must be locked for this call.&n; */
r_static
r_int
DECL|function|smb_retry
id|smb_retry
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
)paren
(brace
r_struct
id|wait_queue
id|wait
op_assign
(brace
id|current
comma
l_int|NULL
)brace
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;state
op_ne
id|CONN_INVALID
)paren
r_goto
id|out
suffix:semicolon
id|smb_close_socket
c_func
(paren
id|server
)paren
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;conn_pid
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_retry: no connection process&bslash;n&quot;
)paren
suffix:semicolon
id|server-&gt;state
op_assign
id|CONN_RETRIED
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|kill_proc
c_func
(paren
id|server-&gt;conn_pid
comma
id|SIGUSR1
comma
l_int|0
)paren
suffix:semicolon
macro_line|#if 0
id|server-&gt;conn_pid
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#ifdef SMBFS_DEBUG_VERBOSE
id|printk
c_func
(paren
l_string|&quot;smb_retry: signalled pid %d, waiting for new connection&bslash;n&quot;
comma
id|server-&gt;conn_pid
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * Wait here for a new connection.&n;&t; */
id|timeout
op_assign
id|jiffies
op_plus
l_int|10
op_star
id|HZ
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|server-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|current-&gt;timeout
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;state
op_ne
id|CONN_INVALID
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
OG
id|timeout
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_retry: timed out, try again later&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_retry: caught signal&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
id|remove_wait_queue
c_func
(paren
op_amp
id|server-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|current-&gt;timeout
op_assign
l_int|0
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;state
op_eq
id|CONN_VALID
)paren
(brace
macro_line|#ifdef SMBFS_PARANOIA
id|printk
c_func
(paren
l_string|&quot;smb_retry: new connection pid=%d&bslash;n&quot;
comma
id|server-&gt;conn_pid
)paren
suffix:semicolon
macro_line|#endif
id|result
op_assign
l_int|1
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* smb_request_ok: We expect the server to be locked. Then we do the&n;   request and check the answer completely. When smb_request_ok&n;   returns 0, you can be quite sure that everything went well. When&n;   the answer is &lt;=0, the returned number is a valid unix errno. */
r_static
r_int
DECL|function|smb_request_ok
id|smb_request_ok
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|s
comma
r_int
id|command
comma
r_int
id|wct
comma
r_int
id|bcc
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
id|s-&gt;rcls
op_assign
l_int|0
suffix:semicolon
id|s-&gt;err
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Make sure we have a connection */
r_if
c_cond
(paren
id|s-&gt;state
op_ne
id|CONN_VALID
op_logical_and
op_logical_neg
id|smb_retry
c_func
(paren
id|s
)paren
)paren
(brace
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|smb_request
c_func
(paren
id|s
)paren
OL
l_int|0
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;smb_request failed&bslash;n&quot;
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|smb_valid_packet
c_func
(paren
id|s-&gt;packet
)paren
op_ne
l_int|0
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;not a valid packet!&bslash;n&quot;
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|s-&gt;rcls
op_ne
l_int|0
)paren
(brace
id|result
op_assign
op_minus
id|smb_errno
c_func
(paren
id|s-&gt;rcls
comma
id|s-&gt;err
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|smb_verify
c_func
(paren
id|s-&gt;packet
comma
id|command
comma
id|wct
comma
id|bcc
)paren
op_ne
l_int|0
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;smb_verify failed&bslash;n&quot;
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * This is called with the server locked after a successful smb_newconn().&n; * It installs the new connection pid, sets server-&gt;state to CONN_VALID,&n; * and wakes up the process waiting for the new connection.&n; * N.B. The first call is made without locking the server -- need to fix!&n; */
r_int
DECL|function|smb_offerconn
id|smb_offerconn
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
)paren
(brace
r_int
id|error
suffix:semicolon
id|error
op_assign
op_minus
id|EACCES
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
op_logical_and
(paren
id|current-&gt;uid
op_ne
id|server-&gt;m.mounted_uid
)paren
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|server-&gt;sem.count
)paren
op_eq
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_offerconn: server not locked, count=%d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|server-&gt;sem.count
)paren
)paren
suffix:semicolon
macro_line|#if 0
r_goto
id|out
suffix:semicolon
macro_line|#endif
)brace
id|server-&gt;conn_pid
op_assign
id|current-&gt;pid
suffix:semicolon
id|server-&gt;state
op_assign
id|CONN_VALID
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|server-&gt;wait
)paren
suffix:semicolon
macro_line|#ifdef SMBFS_PARANOIA
id|printk
c_func
(paren
l_string|&quot;smb_offerconn: state valid, pid=%d&bslash;n&quot;
comma
id|server-&gt;conn_pid
)paren
suffix:semicolon
macro_line|#endif
id|error
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/*&n; * This must be called with the server locked.&n; * N.B. The first call is made without locking the server -- need to fix!&n; */
r_int
DECL|function|smb_newconn
id|smb_newconn
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|smb_conn_opt
op_star
id|opt
)paren
(brace
r_struct
id|file
op_star
id|filp
suffix:semicolon
r_int
id|error
suffix:semicolon
id|error
op_assign
op_minus
id|EBADF
suffix:semicolon
r_if
c_cond
(paren
id|opt-&gt;fd
op_ge
id|NR_OPEN
op_logical_or
op_logical_neg
(paren
id|filp
op_assign
id|current-&gt;files-&gt;fd
(braket
id|opt-&gt;fd
)braket
)paren
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|smb_valid_socket
c_func
(paren
id|filp-&gt;f_dentry-&gt;d_inode
)paren
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
op_minus
id|EACCES
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
op_logical_and
(paren
id|current-&gt;uid
op_ne
id|server-&gt;m.mounted_uid
)paren
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|server-&gt;sem.count
)paren
op_eq
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_newconn: server not locked, count=%d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|server-&gt;sem.count
)paren
)paren
suffix:semicolon
macro_line|#if 0
r_goto
id|out
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n;&t; * Make sure the old socket is closed&n;&t; */
id|smb_close_socket
c_func
(paren
id|server
)paren
suffix:semicolon
id|filp-&gt;f_count
op_add_assign
l_int|1
suffix:semicolon
id|server-&gt;sock_file
op_assign
id|filp
suffix:semicolon
id|smb_catch_keepalive
c_func
(paren
id|server
)paren
suffix:semicolon
id|server-&gt;opt
op_assign
op_star
id|opt
suffix:semicolon
macro_line|#ifdef SMBFS_DEBUG_VERBOSE
id|printk
c_func
(paren
l_string|&quot;smb_newconn: protocol=%d, max_xmit=%d&bslash;n&quot;
comma
id|server-&gt;opt.protocol
comma
id|server-&gt;opt.max_xmit
)paren
suffix:semicolon
macro_line|#endif
id|server-&gt;generation
op_add_assign
l_int|1
suffix:semicolon
id|error
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* smb_setup_header: We completely set up the packet. You only have to&n;   insert the command-specific fields */
id|__u8
op_star
DECL|function|smb_setup_header
id|smb_setup_header
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
id|__u8
id|command
comma
id|__u16
id|wct
comma
id|__u16
id|bcc
)paren
(brace
id|__u32
id|xmit_len
op_assign
id|SMB_HEADER_LEN
op_plus
id|wct
op_star
r_sizeof
(paren
id|__u16
)paren
op_plus
id|bcc
op_plus
l_int|2
suffix:semicolon
id|__u8
op_star
id|p
op_assign
id|server-&gt;packet
suffix:semicolon
id|__u8
op_star
id|buf
op_assign
id|server-&gt;packet
suffix:semicolon
r_if
c_cond
(paren
id|xmit_len
OG
id|server-&gt;packet_size
)paren
id|printk
c_func
(paren
l_string|&quot;smb_setup_header: Aieee, xmit len &gt; packet! len=%d, size=%d&bslash;n&quot;
comma
id|xmit_len
comma
id|server-&gt;packet_size
)paren
suffix:semicolon
id|p
op_assign
id|smb_encode_smb_length
c_func
(paren
id|p
comma
id|xmit_len
op_minus
l_int|4
)paren
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|0xff
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_char|&squot;S&squot;
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_char|&squot;M&squot;
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_char|&squot;B&squot;
suffix:semicolon
op_star
id|p
op_increment
op_assign
id|command
suffix:semicolon
id|memset
c_func
(paren
id|p
comma
l_char|&squot;&bslash;0&squot;
comma
l_int|19
)paren
suffix:semicolon
id|p
op_add_assign
l_int|19
suffix:semicolon
id|p
op_add_assign
l_int|8
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_tid
comma
id|server-&gt;opt.tid
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_pid
comma
l_int|1
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_uid
comma
id|server-&gt;opt.server_uid
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_mid
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;opt.protocol
OG
id|SMB_PROTOCOL_CORE
)paren
(brace
op_star
(paren
id|buf
op_plus
id|smb_flg
)paren
op_assign
l_int|0x8
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_flg2
comma
l_int|0x3
)paren
suffix:semicolon
)brace
op_star
id|p
op_increment
op_assign
id|wct
suffix:semicolon
multiline_comment|/* wct */
id|p
op_add_assign
l_int|2
op_star
id|wct
suffix:semicolon
id|WSET
c_func
(paren
id|p
comma
l_int|0
comma
id|bcc
)paren
suffix:semicolon
r_return
id|p
op_plus
l_int|2
suffix:semicolon
)brace
r_static
r_void
DECL|function|smb_setup_bcc
id|smb_setup_bcc
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
id|__u8
op_star
id|p
)paren
(brace
id|__u8
op_star
id|packet
op_assign
id|server-&gt;packet
suffix:semicolon
id|__u8
op_star
id|pbcc
op_assign
id|packet
op_plus
id|SMB_HEADER_LEN
op_plus
l_int|2
op_star
id|SMB_WCT
c_func
(paren
id|packet
)paren
suffix:semicolon
id|__u16
id|bcc
op_assign
id|p
op_minus
(paren
id|pbcc
op_plus
l_int|2
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|pbcc
comma
l_int|0
comma
id|bcc
)paren
suffix:semicolon
id|smb_encode_smb_length
c_func
(paren
id|packet
comma
id|SMB_HEADER_LEN
op_plus
l_int|2
op_star
id|SMB_WCT
c_func
(paren
id|packet
)paren
op_minus
l_int|2
op_plus
id|bcc
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * We&squot;re called with the server locked, and we leave it that way.&n; * Set the permissions to be consistent with the desired access.&n; */
r_static
r_int
DECL|function|smb_proc_open
id|smb_proc_open
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|dentry
op_star
id|dir
comma
r_int
id|wish
)paren
(brace
r_struct
id|inode
op_star
id|ino
op_assign
id|dir-&gt;d_inode
suffix:semicolon
r_int
id|mode
comma
id|read_write
op_assign
l_int|0x42
comma
id|read_only
op_assign
l_int|0x40
suffix:semicolon
r_int
id|error
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
id|mode
op_assign
id|read_write
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
op_logical_neg
(paren
id|wish
op_amp
(paren
id|O_WRONLY
op_or
id|O_RDWR
)paren
)paren
)paren
id|mode
op_assign
id|read_only
suffix:semicolon
macro_line|#endif
id|retry
suffix:colon
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBopen
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv0
comma
id|mode
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv1
comma
id|aSYSTEM
op_or
id|aHIDDEN
op_or
id|aDIR
)paren
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|4
suffix:semicolon
id|p
op_assign
id|smb_encode_path
c_func
(paren
id|server
comma
id|p
comma
id|dir
comma
l_int|NULL
)paren
suffix:semicolon
id|smb_setup_bcc
c_func
(paren
id|server
comma
id|p
)paren
suffix:semicolon
id|error
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBopen
comma
l_int|7
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|smb_retry
c_func
(paren
id|server
)paren
)paren
r_goto
id|retry
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
id|read_write
op_logical_and
(paren
id|error
op_eq
op_minus
id|EACCES
op_logical_or
id|error
op_eq
op_minus
id|ETXTBSY
op_logical_or
id|error
op_eq
op_minus
id|EROFS
)paren
)paren
(brace
macro_line|#ifdef SMBFS_PARANOIA
id|printk
c_func
(paren
l_string|&quot;smb_proc_open: %s/%s open failed, error=%d, retrying R/O&bslash;n&quot;
comma
id|dir-&gt;d_parent-&gt;d_name.name
comma
id|dir-&gt;d_name.name
comma
id|error
)paren
suffix:semicolon
macro_line|#endif
id|mode
op_assign
id|read_only
suffix:semicolon
r_goto
id|retry
suffix:semicolon
)brace
)brace
multiline_comment|/* We should now have data in vwv[0..6]. */
id|ino-&gt;u.smbfs_i.fileid
op_assign
id|WVAL
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv0
)paren
suffix:semicolon
id|ino-&gt;u.smbfs_i.attr
op_assign
id|WVAL
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv1
)paren
suffix:semicolon
multiline_comment|/* smb_vwv2 has mtime */
multiline_comment|/* smb_vwv4 has size  */
id|ino-&gt;u.smbfs_i.access
op_assign
id|WVAL
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv6
)paren
suffix:semicolon
id|ino-&gt;u.smbfs_i.access
op_and_assign
l_int|3
suffix:semicolon
multiline_comment|/* N.B. Suppose the open failed?? */
id|ino-&gt;u.smbfs_i.open
op_assign
id|server-&gt;generation
suffix:semicolon
macro_line|#ifdef SMBFS_DEBUG_VERBOSE
id|printk
c_func
(paren
l_string|&quot;smb_proc_open: error=%d, access=%d&bslash;n&quot;
comma
id|error
comma
id|ino-&gt;u.smbfs_i.access
)paren
suffix:semicolon
macro_line|#endif
r_return
id|error
suffix:semicolon
)brace
r_int
DECL|function|smb_open
id|smb_open
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|wish
)paren
(brace
r_struct
id|inode
op_star
id|i
op_assign
id|dentry-&gt;d_inode
suffix:semicolon
r_int
id|result
suffix:semicolon
id|result
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|i
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;smb_open: no inode for dentry %s/%s&bslash;n&quot;
comma
id|dentry-&gt;d_parent-&gt;d_name.name
comma
id|dentry-&gt;d_name.name
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Note: If the caller holds an active dentry and the file is&n;&t; * currently open, we can be sure that the file isn&squot;t about&n;&t; * to be closed. (See smb_close_dentry() below.)&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|smb_is_open
c_func
(paren
id|i
)paren
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
op_assign
id|SMB_SERVER
c_func
(paren
id|i
)paren
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|smb_is_open
c_func
(paren
id|i
)paren
)paren
id|result
op_assign
id|smb_proc_open
c_func
(paren
id|server
comma
id|dentry
comma
id|wish
)paren
suffix:semicolon
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
macro_line|#ifdef SMBFS_PARANOIA
id|printk
c_func
(paren
l_string|&quot;smb_open: %s/%s open failed, result=%d&bslash;n&quot;
comma
id|dentry-&gt;d_parent-&gt;d_name.name
comma
id|dentry-&gt;d_name.name
comma
id|result
)paren
suffix:semicolon
macro_line|#endif
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * A successful open means the path is still valid ...&n;&t;&t; */
id|smb_renew_times
c_func
(paren
id|dentry
)paren
suffix:semicolon
)brace
id|result
op_assign
op_minus
id|EACCES
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|wish
op_eq
id|O_RDONLY
)paren
op_logical_and
(paren
(paren
id|i-&gt;u.smbfs_i.access
op_eq
id|O_RDONLY
)paren
op_logical_or
(paren
id|i-&gt;u.smbfs_i.access
op_eq
id|O_RDWR
)paren
)paren
)paren
op_logical_or
(paren
(paren
id|wish
op_eq
id|O_WRONLY
)paren
op_logical_and
(paren
(paren
id|i-&gt;u.smbfs_i.access
op_eq
id|O_WRONLY
)paren
op_logical_or
(paren
id|i-&gt;u.smbfs_i.access
op_eq
id|O_RDWR
)paren
)paren
)paren
op_logical_or
(paren
(paren
id|wish
op_eq
id|O_RDWR
)paren
op_logical_and
(paren
id|i-&gt;u.smbfs_i.access
op_eq
id|O_RDWR
)paren
)paren
)paren
id|result
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* We&squot;re called with the server locked */
r_static
r_int
DECL|function|smb_proc_close
id|smb_proc_close
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
id|__u16
id|fileid
comma
id|__u32
id|mtime
)paren
(brace
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBclose
comma
l_int|3
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv0
comma
id|fileid
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv1
comma
id|utc2local
c_func
(paren
id|mtime
)paren
)paren
suffix:semicolon
r_return
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBclose
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Called with the server locked&n; */
r_static
r_int
DECL|function|smb_proc_close_inode
id|smb_proc_close_inode
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|inode
op_star
id|ino
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|smb_is_open
c_func
(paren
id|ino
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * We clear the open flag in advance, in case another&n; &t;&t; * process observes the value while we block below.&n;&t;&t; */
id|ino-&gt;u.smbfs_i.open
op_assign
l_int|0
suffix:semicolon
id|result
op_assign
id|smb_proc_close
c_func
(paren
id|server
comma
id|ino-&gt;u.smbfs_i.fileid
comma
id|ino-&gt;i_mtime
)paren
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|smb_close
id|smb_close
c_func
(paren
r_struct
id|inode
op_star
id|ino
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|smb_is_open
c_func
(paren
id|ino
)paren
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
op_assign
id|SMB_SERVER
c_func
(paren
id|ino
)paren
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|result
op_assign
id|smb_proc_close_inode
c_func
(paren
id|server
comma
id|ino
)paren
suffix:semicolon
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * This routine is called from dput() when d_count is going to 0.&n; * We use this to close the file so that cached dentries don&squot;t&n; * keep too many files open.&n; *&n; * There are some tricky race conditions here: the dentry may go&n; * back into use while we&squot;re closing the file, and we don&squot;t want&n; * the new user to be confused as to the open status.&n; */
r_void
DECL|function|smb_close_dentry
id|smb_close_dentry
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_struct
id|inode
op_star
id|ino
op_assign
id|dentry-&gt;d_inode
suffix:semicolon
r_if
c_cond
(paren
id|ino
)paren
(brace
r_if
c_cond
(paren
id|smb_is_open
c_func
(paren
id|ino
)paren
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
op_assign
id|SMB_SERVER
c_func
(paren
id|ino
)paren
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Check whether the dentry is back in use.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|dentry-&gt;d_count
op_le
l_int|1
)paren
(brace
macro_line|#ifdef SMBFS_DEBUG_VERBOSE
id|printk
c_func
(paren
l_string|&quot;smb_close_dentry: closing %s/%s, count=%d&bslash;n&quot;
comma
id|dentry-&gt;d_parent-&gt;d_name.name
comma
id|dentry-&gt;d_name.name
comma
id|dentry-&gt;d_count
)paren
suffix:semicolon
macro_line|#endif
id|smb_proc_close_inode
c_func
(paren
id|server
comma
id|ino
)paren
suffix:semicolon
)brace
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Consider dropping negative dentries? */
macro_line|#if 0
r_else
id|d_drop
c_func
(paren
id|dentry
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* In smb_proc_read and smb_proc_write we do not retry, because the&n;   file-id would not be valid after a reconnection. */
r_int
DECL|function|smb_proc_read
id|smb_proc_read
c_func
(paren
r_struct
id|inode
op_star
id|ino
comma
id|off_t
id|offset
comma
r_int
id|count
comma
r_char
op_star
id|data
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
op_assign
id|SMB_SERVER
c_func
(paren
id|ino
)paren
suffix:semicolon
id|__u16
id|returned_count
comma
id|data_len
suffix:semicolon
r_char
op_star
id|buf
suffix:semicolon
r_int
id|result
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBread
comma
l_int|5
comma
l_int|0
)paren
suffix:semicolon
id|buf
op_assign
id|server-&gt;packet
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv0
comma
id|ino-&gt;u.smbfs_i.fileid
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv1
comma
id|count
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|buf
comma
id|smb_vwv2
comma
id|offset
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv4
comma
l_int|0
)paren
suffix:semicolon
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBread
comma
l_int|5
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|returned_count
op_assign
id|WVAL
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv0
)paren
suffix:semicolon
id|buf
op_assign
id|SMB_BUF
c_func
(paren
id|server-&gt;packet
)paren
suffix:semicolon
id|data_len
op_assign
id|WVAL
c_func
(paren
id|buf
comma
l_int|1
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|data
comma
id|buf
op_plus
l_int|3
comma
id|data_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|returned_count
op_ne
id|data_len
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;smb_proc_read: returned != data_len&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;smb_proc_read: ret_c=%d, data_len=%d&bslash;n&quot;
comma
id|returned_count
comma
id|data_len
)paren
suffix:semicolon
)brace
id|result
op_assign
id|data_len
suffix:semicolon
id|out
suffix:colon
macro_line|#ifdef SMBFS_DEBUG_VERBOSE
id|printk
c_func
(paren
l_string|&quot;smb_proc_read: file %s/%s, count=%d, result=%d&bslash;n&quot;
comma
(paren
(paren
r_struct
id|dentry
op_star
)paren
id|ino-&gt;u.smbfs_i.dentry
)paren
op_member_access_from_pointer
id|d_parent-&gt;d_name.name
comma
(paren
(paren
r_struct
id|dentry
op_star
)paren
id|ino-&gt;u.smbfs_i.dentry
)paren
op_member_access_from_pointer
id|d_name.name
comma
id|count
comma
id|result
)paren
suffix:semicolon
macro_line|#endif
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|smb_proc_write
id|smb_proc_write
c_func
(paren
r_struct
id|inode
op_star
id|ino
comma
id|off_t
id|offset
comma
r_int
id|count
comma
r_const
r_char
op_star
id|data
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
op_assign
id|SMB_SERVER
c_func
(paren
id|ino
)paren
suffix:semicolon
r_int
id|result
suffix:semicolon
id|__u8
op_star
id|p
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
macro_line|#if SMBFS_DEBUG_VERBOSE
(brace
r_struct
id|dentry
op_star
id|dentry
op_assign
id|ino-&gt;u.smbfs_i.dentry
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;smb_proc_write: file %s/%s, count=%d@%ld, packet_size=%d&bslash;n&quot;
comma
id|dentry-&gt;d_parent-&gt;d_name.name
comma
id|dentry-&gt;d_name.name
comma
id|count
comma
id|offset
comma
id|server-&gt;packet_size
)paren
suffix:semicolon
)brace
macro_line|#endif
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBwrite
comma
l_int|5
comma
id|count
op_plus
l_int|3
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv0
comma
id|ino-&gt;u.smbfs_i.fileid
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv1
comma
id|count
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv2
comma
id|offset
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv4
comma
l_int|0
)paren
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|1
suffix:semicolon
id|WSET
c_func
(paren
id|p
comma
l_int|0
comma
id|count
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|p
op_plus
l_int|2
comma
id|data
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBwrite
comma
l_int|1
comma
l_int|0
)paren
)paren
op_ge
l_int|0
)paren
id|result
op_assign
id|WVAL
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv0
)paren
suffix:semicolon
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|smb_proc_create
id|smb_proc_create
c_func
(paren
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|qstr
op_star
id|name
comma
id|__u16
id|attr
comma
id|time_t
id|ctime
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
suffix:semicolon
r_int
id|error
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
id|server
op_assign
id|server_from_dentry
c_func
(paren
id|dir
)paren
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|retry
suffix:colon
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBcreate
comma
l_int|3
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv0
comma
id|attr
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv1
comma
id|utc2local
c_func
(paren
id|ctime
)paren
)paren
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|4
suffix:semicolon
id|p
op_assign
id|smb_encode_path
c_func
(paren
id|server
comma
id|p
comma
id|dir
comma
id|name
)paren
suffix:semicolon
id|smb_setup_bcc
c_func
(paren
id|server
comma
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBcreate
comma
l_int|1
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|smb_retry
c_func
(paren
id|server
)paren
)paren
(brace
r_goto
id|retry
suffix:semicolon
)brace
r_goto
id|out
suffix:semicolon
)brace
id|smb_proc_close
c_func
(paren
id|server
comma
id|WVAL
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv0
)paren
comma
id|CURRENT_TIME
)paren
suffix:semicolon
id|error
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_int
DECL|function|smb_proc_mv
id|smb_proc_mv
c_func
(paren
r_struct
id|dentry
op_star
id|odir
comma
r_struct
id|qstr
op_star
id|oname
comma
r_struct
id|dentry
op_star
id|ndir
comma
r_struct
id|qstr
op_star
id|nname
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_int
id|result
suffix:semicolon
id|server
op_assign
id|server_from_dentry
c_func
(paren
id|odir
)paren
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|retry
suffix:colon
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBmv
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv0
comma
id|aSYSTEM
op_or
id|aHIDDEN
)paren
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|4
suffix:semicolon
id|p
op_assign
id|smb_encode_path
c_func
(paren
id|server
comma
id|p
comma
id|odir
comma
id|oname
)paren
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|4
suffix:semicolon
id|p
op_assign
id|smb_encode_path
c_func
(paren
id|server
comma
id|p
comma
id|ndir
comma
id|nname
)paren
suffix:semicolon
id|smb_setup_bcc
c_func
(paren
id|server
comma
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBmv
comma
l_int|0
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|smb_retry
c_func
(paren
id|server
)paren
)paren
(brace
r_goto
id|retry
suffix:semicolon
)brace
)brace
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|smb_proc_mkdir
id|smb_proc_mkdir
c_func
(paren
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|qstr
op_star
id|name
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_int
id|result
suffix:semicolon
id|server
op_assign
id|server_from_dentry
c_func
(paren
id|dir
)paren
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|retry
suffix:colon
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBmkdir
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|4
suffix:semicolon
id|p
op_assign
id|smb_encode_path
c_func
(paren
id|server
comma
id|p
comma
id|dir
comma
id|name
)paren
suffix:semicolon
id|smb_setup_bcc
c_func
(paren
id|server
comma
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBmkdir
comma
l_int|0
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|smb_retry
c_func
(paren
id|server
)paren
)paren
(brace
r_goto
id|retry
suffix:semicolon
)brace
)brace
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|smb_proc_rmdir
id|smb_proc_rmdir
c_func
(paren
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|qstr
op_star
id|name
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_int
id|result
suffix:semicolon
id|server
op_assign
id|server_from_dentry
c_func
(paren
id|dir
)paren
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|retry
suffix:colon
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBrmdir
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|4
suffix:semicolon
id|p
op_assign
id|smb_encode_path
c_func
(paren
id|server
comma
id|p
comma
id|dir
comma
id|name
)paren
suffix:semicolon
id|smb_setup_bcc
c_func
(paren
id|server
comma
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBrmdir
comma
l_int|0
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|smb_retry
c_func
(paren
id|server
)paren
)paren
(brace
r_goto
id|retry
suffix:semicolon
)brace
)brace
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|smb_proc_unlink
id|smb_proc_unlink
c_func
(paren
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|qstr
op_star
id|name
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_int
id|result
suffix:semicolon
id|server
op_assign
id|server_from_dentry
c_func
(paren
id|dir
)paren
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|retry
suffix:colon
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBunlink
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv0
comma
id|aSYSTEM
op_or
id|aHIDDEN
)paren
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|4
suffix:semicolon
id|p
op_assign
id|smb_encode_path
c_func
(paren
id|server
comma
id|p
comma
id|dir
comma
id|name
)paren
suffix:semicolon
id|smb_setup_bcc
c_func
(paren
id|server
comma
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBunlink
comma
l_int|0
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|smb_retry
c_func
(paren
id|server
)paren
)paren
(brace
r_goto
id|retry
suffix:semicolon
)brace
)brace
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|smb_proc_trunc
id|smb_proc_trunc
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
id|__u16
id|fid
comma
id|__u32
id|length
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
r_char
op_star
id|buf
suffix:semicolon
r_int
id|result
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|retry
suffix:colon
id|buf
op_assign
id|server-&gt;packet
suffix:semicolon
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBwrite
comma
l_int|5
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv0
comma
id|fid
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv1
comma
l_int|0
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|buf
comma
id|smb_vwv2
comma
id|length
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv4
comma
l_int|0
)paren
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|4
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|0
suffix:semicolon
id|smb_setup_bcc
c_func
(paren
id|server
comma
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBwrite
comma
l_int|1
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|smb_retry
c_func
(paren
id|server
)paren
)paren
(brace
r_goto
id|retry
suffix:semicolon
)brace
)brace
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_static
r_void
DECL|function|smb_init_dirent
id|smb_init_dirent
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|smb_fattr
op_star
id|fattr
)paren
(brace
id|memset
c_func
(paren
id|fattr
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|fattr
)paren
)paren
suffix:semicolon
id|fattr-&gt;f_nlink
op_assign
l_int|1
suffix:semicolon
id|fattr-&gt;f_uid
op_assign
id|server-&gt;m.uid
suffix:semicolon
id|fattr-&gt;f_gid
op_assign
id|server-&gt;m.gid
suffix:semicolon
id|fattr-&gt;f_blksize
op_assign
l_int|512
suffix:semicolon
)brace
r_static
r_void
DECL|function|smb_finish_dirent
id|smb_finish_dirent
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|smb_fattr
op_star
id|fattr
)paren
(brace
id|fattr-&gt;f_mode
op_assign
id|server-&gt;m.file_mode
suffix:semicolon
r_if
c_cond
(paren
id|fattr-&gt;attr
op_amp
id|aDIR
)paren
(brace
id|fattr-&gt;f_mode
op_assign
id|server-&gt;m.dir_mode
suffix:semicolon
id|fattr-&gt;f_size
op_assign
l_int|512
suffix:semicolon
)brace
id|fattr-&gt;f_blocks
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* already set to zero? */
r_if
c_cond
(paren
(paren
id|fattr-&gt;f_blksize
op_ne
l_int|0
)paren
op_logical_and
(paren
id|fattr-&gt;f_size
op_ne
l_int|0
)paren
)paren
(brace
id|fattr-&gt;f_blocks
op_assign
(paren
id|fattr-&gt;f_size
op_minus
l_int|1
)paren
op_div
id|fattr-&gt;f_blksize
op_plus
l_int|1
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_void
DECL|function|smb_init_root_dirent
id|smb_init_root_dirent
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|smb_fattr
op_star
id|fattr
)paren
(brace
id|smb_init_dirent
c_func
(paren
id|server
comma
id|fattr
)paren
suffix:semicolon
id|fattr-&gt;attr
op_assign
id|aDIR
suffix:semicolon
id|fattr-&gt;f_ino
op_assign
l_int|1
suffix:semicolon
id|fattr-&gt;f_mtime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|smb_finish_dirent
c_func
(paren
id|server
comma
id|fattr
)paren
suffix:semicolon
)brace
r_static
id|__u8
op_star
DECL|function|smb_decode_dirent
id|smb_decode_dirent
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
id|__u8
op_star
id|p
comma
r_struct
id|dirent
op_star
id|entry
)paren
(brace
r_int
id|len
suffix:semicolon
id|p
op_add_assign
id|SMB_STATUS_SIZE
suffix:semicolon
multiline_comment|/* reserved (search_status) */
id|len
op_assign
id|strlen
c_func
(paren
id|p
op_plus
l_int|9
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|12
)paren
(brace
id|len
op_assign
l_int|12
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|entry-&gt;d_name
comma
id|p
op_plus
l_int|9
comma
id|len
)paren
suffix:semicolon
macro_line|#ifdef SMBFS_TRIM_BLANKS
multiline_comment|/*&n;&t; * Trim trailing blanks for Pathworks servers&n;&t; */
r_while
c_loop
(paren
id|len
OG
l_int|2
op_logical_and
id|entry-&gt;d_name
(braket
id|len
op_minus
l_int|1
)braket
op_eq
l_char|&squot; &squot;
)paren
id|len
op_decrement
suffix:semicolon
macro_line|#endif
id|entry-&gt;d_name
(braket
id|len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|entry-&gt;d_reclen
op_assign
id|len
suffix:semicolon
id|entry-&gt;d_ino
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* no inode number available */
r_switch
c_cond
(paren
id|server-&gt;opt.case_handling
)paren
(brace
r_case
id|SMB_CASE_UPPER
suffix:colon
id|str_upper
c_func
(paren
id|entry-&gt;d_name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SMB_CASE_LOWER
suffix:colon
id|str_lower
c_func
(paren
id|entry-&gt;d_name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|pr_debug
c_func
(paren
l_string|&quot;smb_decode_dirent: name = %s&bslash;n&quot;
comma
id|entry-&gt;name
)paren
suffix:semicolon
r_return
id|p
op_plus
l_int|22
suffix:semicolon
)brace
multiline_comment|/* This routine is used to read in directory entries from the network.&n;   Note that it is for short directory name seeks, i.e.: protocol &lt;&n;   SMB_PROTOCOL_LANMAN2 */
r_static
r_int
DECL|function|smb_proc_readdir_short
id|smb_proc_readdir_short
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|dentry
op_star
id|dir
comma
r_int
id|fpos
comma
r_void
op_star
id|cachep
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
id|i
comma
id|first
comma
id|entries_seen
comma
id|entries
suffix:semicolon
r_int
id|entries_asked
op_assign
(paren
id|server-&gt;opt.max_xmit
op_minus
l_int|100
)paren
op_div
id|SMB_DIRINFO_SIZE
suffix:semicolon
id|__u16
id|bcc
suffix:semicolon
id|__u16
id|count
suffix:semicolon
r_char
id|status
(braket
id|SMB_STATUS_SIZE
)braket
suffix:semicolon
r_static
r_struct
id|qstr
id|mask
op_assign
(brace
l_string|&quot;*.*&quot;
comma
l_int|3
comma
l_int|0
)brace
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;smb_proc_readdir_short: %d @ %d&bslash;n&quot;
comma
id|cache_size
comma
id|fpos
)paren
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
multiline_comment|/* N.B. We need to reinitialize the cache to restart */
id|retry
suffix:colon
id|smb_init_dircache
c_func
(paren
id|cachep
)paren
suffix:semicolon
id|first
op_assign
l_int|1
suffix:semicolon
id|entries
op_assign
l_int|0
suffix:semicolon
id|entries_seen
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* implicit . and .. */
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBsearch
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv0
comma
id|entries_asked
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv1
comma
id|aDIR
)paren
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|first
op_eq
l_int|1
)paren
(brace
id|p
op_assign
id|smb_encode_path
c_func
(paren
id|server
comma
id|p
comma
id|dir
comma
op_amp
id|mask
)paren
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|5
suffix:semicolon
id|WSET
c_func
(paren
id|p
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|p
op_add_assign
l_int|2
suffix:semicolon
id|first
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
op_star
id|p
op_increment
op_assign
l_int|0
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|5
suffix:semicolon
id|WSET
c_func
(paren
id|p
comma
l_int|0
comma
id|SMB_STATUS_SIZE
)paren
suffix:semicolon
id|p
op_add_assign
l_int|2
suffix:semicolon
id|memcpy
c_func
(paren
id|p
comma
id|status
comma
id|SMB_STATUS_SIZE
)paren
suffix:semicolon
id|p
op_add_assign
id|SMB_STATUS_SIZE
suffix:semicolon
)brace
id|smb_setup_bcc
c_func
(paren
id|server
comma
id|p
)paren
suffix:semicolon
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBsearch
comma
l_int|1
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|server-&gt;rcls
op_eq
id|ERRDOS
)paren
op_logical_and
(paren
id|server-&gt;err
op_eq
id|ERRnofiles
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|smb_retry
c_func
(paren
id|server
)paren
)paren
r_goto
id|retry
suffix:semicolon
r_goto
id|unlock_return
suffix:semicolon
)brace
id|p
op_assign
id|SMB_VWV
c_func
(paren
id|server-&gt;packet
)paren
suffix:semicolon
id|count
op_assign
id|WVAL
c_func
(paren
id|p
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_le
l_int|0
)paren
r_break
suffix:semicolon
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
id|bcc
op_assign
id|WVAL
c_func
(paren
id|p
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bcc
op_ne
id|count
op_star
id|SMB_DIRINFO_SIZE
op_plus
l_int|3
)paren
r_goto
id|unlock_return
suffix:semicolon
id|p
op_add_assign
l_int|7
suffix:semicolon
multiline_comment|/* Read the last entry into the status field. */
id|memcpy
c_func
(paren
id|status
comma
id|SMB_BUF
c_func
(paren
id|server-&gt;packet
)paren
op_plus
l_int|3
op_plus
(paren
id|count
op_minus
l_int|1
)paren
op_star
id|SMB_DIRINFO_SIZE
comma
id|SMB_STATUS_SIZE
)paren
suffix:semicolon
multiline_comment|/* Now we are ready to parse smb directory entries. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|dirent
id|this_ent
comma
op_star
id|entry
op_assign
op_amp
id|this_ent
suffix:semicolon
id|p
op_assign
id|smb_decode_dirent
c_func
(paren
id|server
comma
id|p
comma
id|entry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entries_seen
op_eq
l_int|2
op_logical_and
id|entry-&gt;d_name
(braket
l_int|0
)braket
op_eq
l_char|&squot;.&squot;
)paren
(brace
r_if
c_cond
(paren
id|entry-&gt;d_reclen
op_eq
l_int|1
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|entry-&gt;d_name
(braket
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
op_logical_and
id|entry-&gt;d_reclen
op_eq
l_int|2
)paren
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|entries_seen
op_ge
id|fpos
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;smb_proc_readdir: fpos=%u&bslash;n&quot;
comma
id|entries_seen
)paren
suffix:semicolon
id|smb_add_to_cache
c_func
(paren
id|cachep
comma
id|entry
comma
id|entries_seen
)paren
suffix:semicolon
id|entries
op_increment
suffix:semicolon
)brace
macro_line|#ifdef SMBFS_DEBUG_VERBOSE
r_else
id|printk
c_func
(paren
l_string|&quot;smb_proc_readdir: skipped, seen=%d, i=%d, fpos=%d&bslash;n&quot;
comma
id|entries_seen
comma
id|i
comma
id|fpos
)paren
suffix:semicolon
macro_line|#endif
id|entries_seen
op_increment
suffix:semicolon
)brace
)brace
id|result
op_assign
id|entries
suffix:semicolon
id|unlock_return
suffix:colon
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * Interpret a long filename structure using the specified info level:&n; *   level 1 -- Win NT, Win 95, OS/2&n; *   level 2 -- OS/2&n; *   level 259 -- File name and length only, Win NT, Win 95&n; *   level 260 -- Win NT, Win 95&n; * There seem to be numerous inconsistencies and bugs in implementation.&n; */
r_static
r_char
op_star
DECL|function|smb_decode_long_dirent
id|smb_decode_long_dirent
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_char
op_star
id|p
comma
r_struct
id|dirent
op_star
id|entry
comma
r_int
id|level
)paren
(brace
r_char
op_star
id|result
suffix:semicolon
r_int
r_int
id|len
suffix:semicolon
multiline_comment|/*&n;&t; * SMB doesn&squot;t have a concept of inode numbers ...&n;&t; */
id|entry-&gt;d_ino
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|level
)paren
(brace
r_case
l_int|1
suffix:colon
id|len
op_assign
op_star
(paren
(paren
r_int
r_char
op_star
)paren
id|p
op_plus
l_int|26
)paren
suffix:semicolon
id|entry-&gt;d_reclen
op_assign
id|len
suffix:semicolon
id|strncpy
c_func
(paren
id|entry-&gt;d_name
comma
id|p
op_plus
l_int|27
comma
id|len
)paren
suffix:semicolon
id|entry-&gt;d_name
(braket
id|len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|result
op_assign
id|p
op_plus
l_int|28
op_plus
id|len
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|259
suffix:colon
multiline_comment|/* SMB_FIND_FILE_NAMES_INFO = 0x103 */
multiline_comment|/*&n;&t;&t; * This info level returns just the file name and length,&n;&t;&t; * which is all we need right now.&n;&t;&t; */
id|result
op_assign
id|p
op_plus
id|DVAL
c_func
(paren
id|p
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* DVAL(p, 4) should be resume key? Seems to be 0 .. */
id|len
op_assign
id|DVAL
c_func
(paren
id|p
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|255
)paren
id|len
op_assign
l_int|255
suffix:semicolon
id|strncpy
c_func
(paren
id|entry-&gt;d_name
comma
id|p
op_plus
l_int|12
comma
id|len
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Kludge alert: Win NT 4.0 adds a trailing null byte and&n;&t;&t; * counts it in the name length, but Win 95 doesn&squot;t.  Hence&n;&t;&t; * we test for a trailing null and decrement the length ...&n;&t;&t; */
r_if
c_cond
(paren
id|len
op_logical_and
id|entry-&gt;d_name
(braket
id|len
op_minus
l_int|1
)braket
op_eq
l_char|&squot;&bslash;0&squot;
)paren
id|len
op_decrement
suffix:semicolon
id|entry-&gt;d_name
(braket
id|len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|entry-&gt;d_reclen
op_assign
id|len
suffix:semicolon
macro_line|#ifdef SMBFS_DEBUG_VERBOSE
id|printk
c_func
(paren
l_string|&quot;smb_decode_long_dirent: info 259, len=%d, name=%s&bslash;n&quot;
comma
id|len
comma
id|entry-&gt;d_name
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;smb_decode_long_dirent: Unknown level %d&bslash;n&quot;
comma
id|level
)paren
suffix:semicolon
id|result
op_assign
id|p
op_plus
id|WVAL
c_func
(paren
id|p
comma
l_int|0
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|server-&gt;opt.case_handling
)paren
(brace
r_case
id|SMB_CASE_UPPER
suffix:colon
id|str_upper
c_func
(paren
id|entry-&gt;d_name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SMB_CASE_LOWER
suffix:colon
id|str_lower
c_func
(paren
id|entry-&gt;d_name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
r_static
r_int
DECL|function|smb_proc_readdir_long
id|smb_proc_readdir_long
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|dentry
op_star
id|dir
comma
r_int
id|fpos
comma
r_void
op_star
id|cachep
)paren
(brace
multiline_comment|/* Both NT and OS/2 accept info level 1 (but see note below). */
r_int
id|info_level
op_assign
l_int|1
suffix:semicolon
r_const
r_int
id|max_matches
op_assign
l_int|512
suffix:semicolon
r_char
op_star
id|p
comma
op_star
id|mask
comma
op_star
id|lastname
suffix:semicolon
r_int
id|first
comma
id|entries
comma
id|entries_seen
suffix:semicolon
r_int
r_char
op_star
id|resp_data
op_assign
l_int|NULL
suffix:semicolon
r_int
r_char
op_star
id|resp_param
op_assign
l_int|NULL
suffix:semicolon
r_int
id|resp_data_len
op_assign
l_int|0
suffix:semicolon
r_int
id|resp_param_len
op_assign
l_int|0
suffix:semicolon
id|__u16
id|command
suffix:semicolon
r_int
id|ff_resume_key
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* this isn&squot;t being used */
r_int
id|ff_searchcount
op_assign
l_int|0
suffix:semicolon
r_int
id|ff_eos
op_assign
l_int|0
suffix:semicolon
r_int
id|ff_lastname
op_assign
l_int|0
suffix:semicolon
r_int
id|ff_dir_handle
op_assign
l_int|0
suffix:semicolon
r_int
id|loop_count
op_assign
l_int|0
suffix:semicolon
r_int
id|mask_len
comma
id|i
comma
id|result
suffix:semicolon
r_char
id|param
(braket
l_int|12
op_plus
id|SMB_MAXPATHLEN
op_plus
l_int|2
)braket
suffix:semicolon
multiline_comment|/* too long for the stack! */
r_static
r_struct
id|qstr
id|star
op_assign
(brace
l_string|&quot;*&quot;
comma
l_int|1
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/*&n;&t; * Check whether to change the info level.  There appears to be&n;&t; * a bug in Win NT 4.0&squot;s handling of info level 1, whereby it&n;&t; * truncates the directory scan for certain patterns of files.&n;&t; * Hence we use level 259 for NT. (Win 95 uses this too?)&n;&t; */
r_if
c_cond
(paren
id|server-&gt;opt.protocol
op_ge
id|SMB_PROTOCOL_NT1
)paren
id|info_level
op_assign
l_int|259
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|retry
suffix:colon
multiline_comment|/*&n;&t; * Encode the initial path&n;&t; */
id|mask
op_assign
op_amp
(paren
id|param
(braket
l_int|12
)braket
)paren
suffix:semicolon
id|mask_len
op_assign
id|smb_encode_path
c_func
(paren
id|server
comma
id|mask
comma
id|dir
comma
op_amp
id|star
)paren
op_minus
id|mask
suffix:semicolon
id|first
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef SMBFS_DEBUG_VERBOSE
id|printk
c_func
(paren
l_string|&quot;smb_proc_readdir_long: starting fpos=%d, mask=%s&bslash;n&quot;
comma
id|fpos
comma
id|mask
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * We must reinitialize the dircache when retrying.&n;&t; */
id|smb_init_dircache
c_func
(paren
id|cachep
)paren
suffix:semicolon
id|entries
op_assign
l_int|0
suffix:semicolon
id|entries_seen
op_assign
l_int|2
suffix:semicolon
id|ff_eos
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|ff_eos
op_eq
l_int|0
)paren
(brace
id|loop_count
op_add_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|loop_count
OG
l_int|200
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;smb_proc_readdir_long: &quot;
l_string|&quot;Looping in FIND_NEXT??&bslash;n&quot;
)paren
suffix:semicolon
id|entries
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|first
op_ne
l_int|0
)paren
(brace
id|command
op_assign
id|TRANSACT2_FINDFIRST
suffix:semicolon
id|WSET
c_func
(paren
id|param
comma
l_int|0
comma
id|aSYSTEM
op_or
id|aHIDDEN
op_or
id|aDIR
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|param
comma
l_int|2
comma
id|max_matches
)paren
suffix:semicolon
multiline_comment|/* max count */
id|WSET
c_func
(paren
id|param
comma
l_int|4
comma
l_int|8
op_plus
l_int|4
op_plus
l_int|2
)paren
suffix:semicolon
multiline_comment|/* resume required +&n;&t;&t;&t;&t;&t;&t;&t;   close on end +&n;&t;&t;&t;&t;&t;&t;&t;   continue */
id|WSET
c_func
(paren
id|param
comma
l_int|6
comma
id|info_level
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|param
comma
l_int|8
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|command
op_assign
id|TRANSACT2_FINDNEXT
suffix:semicolon
macro_line|#ifdef SMBFS_DEBUG_VERBOSE
id|printk
c_func
(paren
l_string|&quot;smb_proc_readdir_long: handle=0x%X, resume=%d, lastname=%d, mask=%s&bslash;n&quot;
comma
id|ff_dir_handle
comma
id|ff_resume_key
comma
id|ff_lastname
comma
id|mask
)paren
suffix:semicolon
macro_line|#endif
id|WSET
c_func
(paren
id|param
comma
l_int|0
comma
id|ff_dir_handle
)paren
suffix:semicolon
multiline_comment|/* search handle */
id|WSET
c_func
(paren
id|param
comma
l_int|2
comma
id|max_matches
)paren
suffix:semicolon
multiline_comment|/* max count */
id|WSET
c_func
(paren
id|param
comma
l_int|4
comma
id|info_level
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|param
comma
l_int|6
comma
id|ff_resume_key
)paren
suffix:semicolon
multiline_comment|/* ff_resume_key */
id|WSET
c_func
(paren
id|param
comma
l_int|10
comma
l_int|8
op_plus
l_int|4
op_plus
l_int|2
)paren
suffix:semicolon
multiline_comment|/* resume required +&n;&t;&t;&t;&t;&t;&t;&t;   close on end +&n;&t;&t;&t;&t;&t;&t;&t;   continue */
macro_line|#ifdef CONFIG_SMB_WIN95
multiline_comment|/* Windows 95 is not able to deliver answers&n;&t;&t;&t;   to FIND_NEXT fast enough, so sleep 0.2 seconds */
id|current-&gt;timeout
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|5
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|current-&gt;timeout
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
)brace
id|result
op_assign
id|smb_trans2_request
c_func
(paren
id|server
comma
id|command
comma
l_int|0
comma
l_int|NULL
comma
l_int|12
op_plus
id|mask_len
op_plus
l_int|1
comma
id|param
comma
op_amp
id|resp_data_len
comma
op_amp
id|resp_data
comma
op_amp
id|resp_param_len
comma
op_amp
id|resp_param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|smb_retry
c_func
(paren
id|server
)paren
)paren
(brace
macro_line|#ifdef SMBFS_PARANOIA
id|printk
c_func
(paren
l_string|&quot;smb_proc_readdir_long: error=%d, retrying&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
macro_line|#endif
r_goto
id|retry
suffix:semicolon
)brace
macro_line|#ifdef SMBFS_PARANOIA
id|printk
c_func
(paren
l_string|&quot;smb_proc_readdir_long: error=%d, breaking&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
macro_line|#endif
id|entries
op_assign
id|result
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|server-&gt;rcls
op_ne
l_int|0
)paren
(brace
macro_line|#ifdef SMBFS_PARANOIA
id|printk
c_func
(paren
l_string|&quot;smb_proc_readdir_long: rcls=%d, err=%d, breaking&bslash;n&quot;
comma
id|server-&gt;rcls
comma
id|server-&gt;err
)paren
suffix:semicolon
macro_line|#endif
id|entries
op_assign
op_minus
id|smb_errno
c_func
(paren
id|server-&gt;rcls
comma
id|server-&gt;err
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#ifdef SMBFS_PARANOIA
r_if
c_cond
(paren
id|resp_data
op_plus
id|resp_data_len
OG
id|server-&gt;packet
op_plus
id|server-&gt;packet_size
)paren
id|printk
c_func
(paren
l_string|&quot;s_p_r_l: data past packet end! data=%p, len=%d, packet=%p&bslash;n&quot;
comma
id|resp_data
op_plus
id|resp_data_len
comma
id|resp_data_len
comma
id|server-&gt;packet
op_plus
id|server-&gt;packet_size
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* parse out some important return info */
r_if
c_cond
(paren
id|first
op_ne
l_int|0
)paren
(brace
id|ff_dir_handle
op_assign
id|WVAL
c_func
(paren
id|resp_param
comma
l_int|0
)paren
suffix:semicolon
id|ff_searchcount
op_assign
id|WVAL
c_func
(paren
id|resp_param
comma
l_int|2
)paren
suffix:semicolon
id|ff_eos
op_assign
id|WVAL
c_func
(paren
id|resp_param
comma
l_int|4
)paren
suffix:semicolon
id|ff_lastname
op_assign
id|WVAL
c_func
(paren
id|resp_param
comma
l_int|8
)paren
suffix:semicolon
)brace
r_else
(brace
id|ff_searchcount
op_assign
id|WVAL
c_func
(paren
id|resp_param
comma
l_int|0
)paren
suffix:semicolon
id|ff_eos
op_assign
id|WVAL
c_func
(paren
id|resp_param
comma
l_int|2
)paren
suffix:semicolon
id|ff_lastname
op_assign
id|WVAL
c_func
(paren
id|resp_param
comma
l_int|6
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ff_searchcount
op_eq
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/* we might need the lastname for continuations */
id|mask_len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ff_lastname
OG
l_int|0
)paren
(brace
id|lastname
op_assign
id|resp_data
op_plus
id|ff_lastname
suffix:semicolon
r_switch
c_cond
(paren
id|info_level
)paren
(brace
r_case
l_int|260
suffix:colon
r_if
c_cond
(paren
id|ff_lastname
OL
id|resp_data_len
)paren
id|mask_len
op_assign
id|resp_data_len
op_minus
id|ff_lastname
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* Win NT 4.0 doesn&squot;t set the length byte */
id|lastname
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ff_lastname
op_plus
l_int|2
OL
id|resp_data_len
)paren
id|mask_len
op_assign
id|strlen
c_func
(paren
id|lastname
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * Update the mask string for the next message.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|mask_len
OG
l_int|255
)paren
id|mask_len
op_assign
l_int|255
suffix:semicolon
r_if
c_cond
(paren
id|mask_len
)paren
id|strncpy
c_func
(paren
id|mask
comma
id|lastname
comma
id|mask_len
)paren
suffix:semicolon
id|ff_resume_key
op_assign
l_int|0
suffix:semicolon
)brace
id|mask
(braket
id|mask_len
)braket
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef SMBFS_DEBUG_VERBOSE
id|printk
c_func
(paren
l_string|&quot;smb_proc_readdir_long: new mask, len=%d@%d, mask=%s&bslash;n&quot;
comma
id|mask_len
comma
id|ff_lastname
comma
id|mask
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Now we are ready to parse smb directory entries. */
multiline_comment|/* point to the data bytes */
id|p
op_assign
id|resp_data
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ff_searchcount
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|dirent
id|this_ent
comma
op_star
id|entry
op_assign
op_amp
id|this_ent
suffix:semicolon
id|p
op_assign
id|smb_decode_long_dirent
c_func
(paren
id|server
comma
id|p
comma
id|entry
comma
id|info_level
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;smb_readdir_long: got %s&bslash;n&quot;
comma
id|entry-&gt;name
)paren
suffix:semicolon
multiline_comment|/* ignore . and .. from the server */
r_if
c_cond
(paren
id|entries_seen
op_eq
l_int|2
op_logical_and
id|entry-&gt;d_name
(braket
l_int|0
)braket
op_eq
l_char|&squot;.&squot;
)paren
(brace
r_if
c_cond
(paren
id|entry-&gt;d_reclen
op_eq
l_int|1
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|entry-&gt;d_name
(braket
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
op_logical_and
id|entry-&gt;d_reclen
op_eq
l_int|2
)paren
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|entries_seen
op_ge
id|fpos
)paren
(brace
id|smb_add_to_cache
c_func
(paren
id|cachep
comma
id|entry
comma
id|entries_seen
)paren
suffix:semicolon
id|entries
op_add_assign
l_int|1
suffix:semicolon
)brace
id|entries_seen
op_increment
suffix:semicolon
)brace
macro_line|#ifdef SMBFS_DEBUG_VERBOSE
id|printk
c_func
(paren
l_string|&quot;smb_proc_readdir_long: received %d entries, eos=%d, resume=%d&bslash;n&quot;
comma
id|ff_searchcount
comma
id|ff_eos
comma
id|ff_resume_key
)paren
suffix:semicolon
macro_line|#endif
id|first
op_assign
l_int|0
suffix:semicolon
)brace
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|entries
suffix:semicolon
)brace
r_int
DECL|function|smb_proc_readdir
id|smb_proc_readdir
c_func
(paren
r_struct
id|dentry
op_star
id|dir
comma
r_int
id|fpos
comma
r_void
op_star
id|cachep
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
suffix:semicolon
id|server
op_assign
id|server_from_dentry
c_func
(paren
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;opt.protocol
op_ge
id|SMB_PROTOCOL_LANMAN2
)paren
r_return
id|smb_proc_readdir_long
c_func
(paren
id|server
comma
id|dir
comma
id|fpos
comma
id|cachep
)paren
suffix:semicolon
r_else
r_return
id|smb_proc_readdir_short
c_func
(paren
id|server
comma
id|dir
comma
id|fpos
comma
id|cachep
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|smb_proc_getattr_core
id|smb_proc_getattr_core
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|qstr
op_star
id|name
comma
r_struct
id|smb_fattr
op_star
id|attr
)paren
(brace
r_int
id|result
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|retry
suffix:colon
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBgetatr
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|4
suffix:semicolon
id|p
op_assign
id|smb_encode_path
c_func
(paren
id|server
comma
id|p
comma
id|dir
comma
id|name
)paren
suffix:semicolon
id|smb_setup_bcc
c_func
(paren
id|server
comma
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBgetatr
comma
l_int|10
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|smb_retry
c_func
(paren
id|server
)paren
)paren
r_goto
id|retry
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|attr-&gt;attr
op_assign
id|WVAL
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv0
)paren
suffix:semicolon
id|attr-&gt;f_ctime
op_assign
id|attr-&gt;f_atime
op_assign
id|attr-&gt;f_mtime
op_assign
id|local2utc
c_func
(paren
id|DVAL
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv1
)paren
)paren
suffix:semicolon
id|attr-&gt;f_size
op_assign
id|DVAL
c_func
(paren
id|server-&gt;packet
comma
id|smb_vwv3
)paren
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_static
r_int
DECL|function|smb_proc_getattr_trans2
id|smb_proc_getattr_trans2
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|qstr
op_star
id|name
comma
r_struct
id|smb_fattr
op_star
id|attr
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
r_char
op_star
id|resp_data
op_assign
l_int|NULL
suffix:semicolon
r_int
r_char
op_star
id|resp_param
op_assign
l_int|NULL
suffix:semicolon
r_int
id|resp_data_len
op_assign
l_int|0
suffix:semicolon
r_int
id|resp_param_len
op_assign
l_int|0
suffix:semicolon
r_char
id|param
(braket
id|SMB_MAXPATHLEN
op_plus
l_int|20
)braket
suffix:semicolon
multiline_comment|/* too big for the stack! */
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|retry
suffix:colon
id|WSET
c_func
(paren
id|param
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Info level SMB_INFO_STANDARD */
id|DSET
c_func
(paren
id|param
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
id|p
op_assign
id|smb_encode_path
c_func
(paren
id|server
comma
id|param
op_plus
l_int|6
comma
id|dir
comma
id|name
)paren
suffix:semicolon
id|result
op_assign
id|smb_trans2_request
c_func
(paren
id|server
comma
id|TRANSACT2_QPATHINFO
comma
l_int|0
comma
l_int|NULL
comma
id|p
op_minus
id|param
comma
id|param
comma
op_amp
id|resp_data_len
comma
op_amp
id|resp_data
comma
op_amp
id|resp_param_len
comma
op_amp
id|resp_param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|smb_retry
c_func
(paren
id|server
)paren
)paren
r_goto
id|retry
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|server-&gt;rcls
op_ne
l_int|0
)paren
(brace
macro_line|#ifdef SMBFS_DEBUG_VERBOSE
id|printk
c_func
(paren
l_string|&quot;smb_proc_getattr_trans2: for %s: result=%d, rcls=%d, err=%d&bslash;n&quot;
comma
op_amp
id|param
(braket
l_int|6
)braket
comma
id|result
comma
id|server-&gt;rcls
comma
id|server-&gt;err
)paren
suffix:semicolon
macro_line|#endif
id|result
op_assign
op_minus
id|smb_errno
c_func
(paren
id|server-&gt;rcls
comma
id|server-&gt;err
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|result
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_if
c_cond
(paren
id|resp_data_len
OL
l_int|22
)paren
r_goto
id|out
suffix:semicolon
id|attr-&gt;f_ctime
op_assign
id|date_dos2unix
c_func
(paren
id|WVAL
c_func
(paren
id|resp_data
comma
l_int|2
)paren
comma
id|WVAL
c_func
(paren
id|resp_data
comma
l_int|0
)paren
)paren
suffix:semicolon
id|attr-&gt;f_atime
op_assign
id|date_dos2unix
c_func
(paren
id|WVAL
c_func
(paren
id|resp_data
comma
l_int|6
)paren
comma
id|WVAL
c_func
(paren
id|resp_data
comma
l_int|4
)paren
)paren
suffix:semicolon
id|attr-&gt;f_mtime
op_assign
id|date_dos2unix
c_func
(paren
id|WVAL
c_func
(paren
id|resp_data
comma
l_int|10
)paren
comma
id|WVAL
c_func
(paren
id|resp_data
comma
l_int|8
)paren
)paren
suffix:semicolon
id|attr-&gt;f_size
op_assign
id|DVAL
c_func
(paren
id|resp_data
comma
l_int|12
)paren
suffix:semicolon
id|attr-&gt;attr
op_assign
id|WVAL
c_func
(paren
id|resp_data
comma
l_int|20
)paren
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|smb_proc_getattr
id|smb_proc_getattr
c_func
(paren
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|qstr
op_star
id|name
comma
r_struct
id|smb_fattr
op_star
id|fattr
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
suffix:semicolon
r_int
id|result
suffix:semicolon
id|server
op_assign
id|server_from_dentry
c_func
(paren
id|dir
)paren
suffix:semicolon
id|smb_init_dirent
c_func
(paren
id|server
comma
id|fattr
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * N.B. Why would we want to fall back to xxx_core on error?&n;&t; * If the file doesn&squot;t exist (a very common case), the core&n;&t; * protocol won&squot;t find it either.&n;&t; */
r_if
c_cond
(paren
id|server-&gt;opt.protocol
op_ge
id|SMB_PROTOCOL_LANMAN2
)paren
id|result
op_assign
id|smb_proc_getattr_trans2
c_func
(paren
id|server
comma
id|dir
comma
id|name
comma
id|fattr
)paren
suffix:semicolon
r_else
id|result
op_assign
id|smb_proc_getattr_core
c_func
(paren
id|server
comma
id|dir
comma
id|name
comma
id|fattr
)paren
suffix:semicolon
id|smb_finish_dirent
c_func
(paren
id|server
comma
id|fattr
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* In core protocol, there is only 1 time to be set, we use&n;   entry-&gt;f_mtime, to make touch work. */
r_static
r_int
DECL|function|smb_proc_setattr_core
id|smb_proc_setattr_core
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|smb_fattr
op_star
id|fattr
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
r_char
op_star
id|buf
suffix:semicolon
r_int
id|result
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|retry
suffix:colon
id|buf
op_assign
id|server-&gt;packet
suffix:semicolon
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBsetatr
comma
l_int|8
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv0
comma
id|fattr-&gt;attr
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|buf
comma
id|smb_vwv1
comma
id|utc2local
c_func
(paren
id|fattr-&gt;f_mtime
)paren
)paren
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|4
suffix:semicolon
id|p
op_assign
id|smb_encode_path
c_func
(paren
id|server
comma
id|p
comma
id|dir
comma
l_int|NULL
)paren
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|4
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|0
suffix:semicolon
id|smb_setup_bcc
c_func
(paren
id|server
comma
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBsetatr
comma
l_int|0
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
r_if
c_cond
(paren
id|smb_retry
c_func
(paren
id|server
)paren
)paren
r_goto
id|retry
suffix:semicolon
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_static
r_int
DECL|function|smb_proc_setattr_trans2
id|smb_proc_setattr_trans2
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|smb_fattr
op_star
id|fattr
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
r_char
op_star
id|resp_data
op_assign
l_int|NULL
suffix:semicolon
r_int
r_char
op_star
id|resp_param
op_assign
l_int|NULL
suffix:semicolon
r_int
id|resp_data_len
op_assign
l_int|0
suffix:semicolon
r_int
id|resp_param_len
op_assign
l_int|0
suffix:semicolon
r_char
id|param
(braket
id|SMB_MAXPATHLEN
op_plus
l_int|20
)braket
suffix:semicolon
multiline_comment|/* too long for the stack! */
r_char
id|data
(braket
l_int|26
)braket
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|retry
suffix:colon
id|WSET
c_func
(paren
id|param
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Info level SMB_INFO_STANDARD */
id|DSET
c_func
(paren
id|param
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
id|p
op_assign
id|smb_encode_path
c_func
(paren
id|server
comma
id|param
op_plus
l_int|6
comma
id|dir
comma
l_int|NULL
)paren
suffix:semicolon
id|date_unix2dos
c_func
(paren
id|fattr-&gt;f_ctime
comma
op_amp
(paren
id|data
(braket
l_int|0
)braket
)paren
comma
op_amp
(paren
id|data
(braket
l_int|2
)braket
)paren
)paren
suffix:semicolon
id|date_unix2dos
c_func
(paren
id|fattr-&gt;f_atime
comma
op_amp
(paren
id|data
(braket
l_int|4
)braket
)paren
comma
op_amp
(paren
id|data
(braket
l_int|6
)braket
)paren
)paren
suffix:semicolon
id|date_unix2dos
c_func
(paren
id|fattr-&gt;f_mtime
comma
op_amp
(paren
id|data
(braket
l_int|8
)braket
)paren
comma
op_amp
(paren
id|data
(braket
l_int|10
)braket
)paren
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|data
comma
l_int|12
comma
id|fattr-&gt;f_size
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|data
comma
l_int|16
comma
id|fattr-&gt;f_blksize
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|data
comma
l_int|20
comma
id|fattr-&gt;attr
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|data
comma
l_int|22
comma
l_int|0
)paren
suffix:semicolon
id|result
op_assign
id|smb_trans2_request
c_func
(paren
id|server
comma
id|TRANSACT2_SETPATHINFO
comma
l_int|26
comma
id|data
comma
id|p
op_minus
id|param
comma
id|param
comma
op_amp
id|resp_data_len
comma
op_amp
id|resp_data
comma
op_amp
id|resp_param_len
comma
op_amp
id|resp_param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|smb_retry
c_func
(paren
id|server
)paren
)paren
r_goto
id|retry
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|server-&gt;rcls
op_ne
l_int|0
)paren
id|result
op_assign
op_minus
id|smb_errno
c_func
(paren
id|server-&gt;rcls
comma
id|server-&gt;err
)paren
suffix:semicolon
id|out
suffix:colon
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|smb_proc_setattr
id|smb_proc_setattr
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|smb_fattr
op_star
id|fattr
)paren
(brace
r_int
id|result
suffix:semicolon
multiline_comment|/*&n;&t; * N.B. Why would we want to fall back to xxx_core on error?&n;&t; */
r_if
c_cond
(paren
id|server-&gt;opt.protocol
op_ge
id|SMB_PROTOCOL_LANMAN2
)paren
id|result
op_assign
id|smb_proc_setattr_trans2
c_func
(paren
id|server
comma
id|dir
comma
id|fattr
)paren
suffix:semicolon
r_else
id|result
op_assign
id|smb_proc_setattr_core
c_func
(paren
id|server
comma
id|dir
comma
id|fattr
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|smb_proc_dskattr
id|smb_proc_dskattr
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|statfs
op_star
id|attr
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
op_assign
op_amp
(paren
id|sb-&gt;u.smbfs_sb
)paren
suffix:semicolon
r_int
id|error
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|retry
suffix:colon
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBdskattr
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBdskattr
comma
l_int|5
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|smb_retry
c_func
(paren
id|server
)paren
)paren
r_goto
id|retry
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|p
op_assign
id|SMB_VWV
c_func
(paren
id|server-&gt;packet
)paren
suffix:semicolon
id|attr-&gt;f_bsize
op_assign
id|WVAL
c_func
(paren
id|p
comma
l_int|2
)paren
op_star
id|WVAL
c_func
(paren
id|p
comma
l_int|4
)paren
suffix:semicolon
id|attr-&gt;f_blocks
op_assign
id|WVAL
c_func
(paren
id|p
comma
l_int|0
)paren
suffix:semicolon
id|attr-&gt;f_bavail
op_assign
id|attr-&gt;f_bfree
op_assign
id|WVAL
c_func
(paren
id|p
comma
l_int|6
)paren
suffix:semicolon
id|error
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_int
DECL|function|smb_proc_disconnect
id|smb_proc_disconnect
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
)paren
(brace
r_int
id|result
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|smb_setup_header
c_func
(paren
id|server
comma
id|SMBtdis
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|server
comma
id|SMBtdis
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
eof
