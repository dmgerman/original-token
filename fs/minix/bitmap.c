multiline_comment|/*&n; *  linux/fs/minix/bitmap.c&n; *&n; *  Copyright (C) 1991, 1992  Linus Torvalds&n; */
multiline_comment|/* bitmap.c contains the code that handles the inode and block bitmaps */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/minix_fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
DECL|macro|clear_block
mdefine_line|#define clear_block(addr) &bslash;&n;__asm__(&quot;cld&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;rep&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;stosl&quot; &bslash;&n;&t;::&quot;a&quot; (0),&quot;c&quot; (BLOCK_SIZE/4),&quot;D&quot; ((long) (addr)):&quot;cx&quot;,&quot;di&quot;)
DECL|macro|set_bit
mdefine_line|#define set_bit(nr,addr) ({&bslash;&n;char res; &bslash;&n;__asm__ __volatile__(&quot;btsl %1,%2&bslash;n&bslash;tsetb %0&quot;: &bslash;&n;&quot;=q&quot; (res):&quot;r&quot; (nr),&quot;m&quot; (*(addr))); &bslash;&n;res;})
DECL|macro|clear_bit
mdefine_line|#define clear_bit(nr,addr) ({&bslash;&n;char res; &bslash;&n;__asm__ __volatile__(&quot;btrl %1,%2&bslash;n&bslash;tsetnb %0&quot;: &bslash;&n;&quot;=q&quot; (res):&quot;r&quot; (nr),&quot;m&quot; (*(addr))); &bslash;&n;res;})
DECL|macro|find_first_zero
mdefine_line|#define find_first_zero(addr) ({ &bslash;&n;int __res; &bslash;&n;__asm__(&quot;cld&bslash;n&quot; &bslash;&n;&t;&quot;1:&bslash;tlodsl&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;notl %%eax&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;bsfl %%eax,%%edx&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;jne 2f&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;addl $32,%%ecx&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;cmpl $8192,%%ecx&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;jl 1b&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;xorl %%edx,%%edx&bslash;n&quot; &bslash;&n;&t;&quot;2:&bslash;taddl %%edx,%%ecx&quot; &bslash;&n;&t;:&quot;=c&quot; (__res):&quot;0&quot; (0),&quot;S&quot; (addr):&quot;ax&quot;,&quot;dx&quot;,&quot;si&quot;); &bslash;&n;__res;})
DECL|variable|nibblemap
r_static
r_int
id|nibblemap
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|1
comma
l_int|1
comma
l_int|2
comma
l_int|1
comma
l_int|2
comma
l_int|2
comma
l_int|3
comma
l_int|1
comma
l_int|2
comma
l_int|2
comma
l_int|3
comma
l_int|2
comma
l_int|3
comma
l_int|3
comma
l_int|4
)brace
suffix:semicolon
DECL|function|count_used
r_static
r_int
r_int
id|count_used
c_func
(paren
r_struct
id|buffer_head
op_star
id|map
(braket
)braket
comma
r_int
id|numblocks
comma
r_int
id|numbits
)paren
(brace
r_int
id|i
comma
id|j
comma
id|end
comma
id|sum
op_assign
l_int|0
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|numblocks
)paren
op_logical_and
id|numbits
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|bh
op_assign
id|map
(braket
id|i
)braket
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|numbits
op_ge
(paren
l_int|8
op_star
id|BLOCK_SIZE
)paren
)paren
(brace
id|end
op_assign
id|BLOCK_SIZE
suffix:semicolon
id|numbits
op_sub_assign
l_int|8
op_star
id|BLOCK_SIZE
suffix:semicolon
)brace
r_else
(brace
r_int
id|tmp
suffix:semicolon
id|end
op_assign
id|numbits
op_rshift
l_int|3
suffix:semicolon
id|numbits
op_and_assign
l_int|0x7
suffix:semicolon
id|tmp
op_assign
id|bh-&gt;b_data
(braket
id|end
)braket
op_amp
(paren
(paren
l_int|1
op_lshift
id|numbits
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|sum
op_add_assign
id|nibblemap
(braket
id|tmp
op_amp
l_int|0xf
)braket
op_plus
id|nibblemap
(braket
(paren
id|tmp
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
)braket
suffix:semicolon
id|numbits
op_assign
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|end
suffix:semicolon
id|j
op_increment
)paren
id|sum
op_add_assign
id|nibblemap
(braket
id|bh-&gt;b_data
(braket
id|j
)braket
op_amp
l_int|0xf
)braket
op_plus
id|nibblemap
(braket
(paren
id|bh-&gt;b_data
(braket
id|j
)braket
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
)braket
suffix:semicolon
)brace
r_return
id|sum
suffix:semicolon
)brace
DECL|function|minix_free_block
r_int
id|minix_free_block
c_func
(paren
r_int
id|dev
comma
r_int
id|block
)paren
(brace
r_struct
id|super_block
op_star
id|sb
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_int
r_int
id|bit
comma
id|zone
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb
op_assign
id|get_super
c_func
(paren
id|dev
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;trying to free block on nonexistent device&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|block
OL
id|sb-&gt;u.minix_sb.s_firstdatazone
op_logical_or
id|block
op_ge
id|sb-&gt;u.minix_sb.s_nzones
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;trying to free block not in datazone&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|bh
op_assign
id|get_hash_table
c_func
(paren
id|dev
comma
id|block
comma
id|BLOCK_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bh
)paren
(brace
r_if
c_cond
(paren
id|bh-&gt;b_count
OG
l_int|1
)paren
(brace
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|bh-&gt;b_dirt
op_assign
l_int|0
suffix:semicolon
id|bh-&gt;b_uptodate
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|bh-&gt;b_count
)paren
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
)brace
id|zone
op_assign
id|block
op_minus
id|sb-&gt;u.minix_sb.s_firstdatazone
op_plus
l_int|1
suffix:semicolon
id|bit
op_assign
id|zone
op_amp
l_int|8191
suffix:semicolon
id|zone
op_rshift_assign
l_int|13
suffix:semicolon
id|bh
op_assign
id|sb-&gt;u.minix_sb.s_zmap
(braket
id|zone
)braket
suffix:semicolon
r_if
c_cond
(paren
id|clear_bit
c_func
(paren
id|bit
comma
id|bh-&gt;b_data
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;free_block (%04x:%d): bit already cleared&bslash;n&quot;
comma
id|dev
comma
id|block
)paren
suffix:semicolon
id|bh-&gt;b_dirt
op_assign
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|minix_new_block
r_int
id|minix_new_block
c_func
(paren
r_int
id|dev
)paren
(brace
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_struct
id|super_block
op_star
id|sb
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb
op_assign
id|get_super
c_func
(paren
id|dev
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;trying to get new block from nonexistant device&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|repeat
suffix:colon
id|j
op_assign
l_int|8192
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|bh
op_assign
id|sb-&gt;u.minix_sb.s_zmap
(braket
id|i
)braket
)paren
r_if
c_cond
(paren
(paren
id|j
op_assign
id|find_first_zero
c_func
(paren
id|bh-&gt;b_data
)paren
)paren
OL
l_int|8192
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
l_int|8
op_logical_or
op_logical_neg
id|bh
op_logical_or
id|j
op_ge
l_int|8192
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|set_bit
c_func
(paren
id|j
comma
id|bh-&gt;b_data
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;new_block: bit already set&quot;
)paren
suffix:semicolon
r_goto
id|repeat
suffix:semicolon
)brace
id|bh-&gt;b_dirt
op_assign
l_int|1
suffix:semicolon
id|j
op_add_assign
id|i
op_star
l_int|8192
op_plus
id|sb-&gt;u.minix_sb.s_firstdatazone
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|j
op_ge
id|sb-&gt;u.minix_sb.s_nzones
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bh
op_assign
id|getblk
c_func
(paren
id|dev
comma
id|j
comma
id|BLOCK_SIZE
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;new_block: cannot get block&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bh-&gt;b_count
op_ne
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;new block: count is != 1&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|clear_block
c_func
(paren
id|bh-&gt;b_data
)paren
suffix:semicolon
id|bh-&gt;b_uptodate
op_assign
l_int|1
suffix:semicolon
id|bh-&gt;b_dirt
op_assign
l_int|1
suffix:semicolon
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
r_return
id|j
suffix:semicolon
)brace
DECL|function|minix_count_free_blocks
r_int
r_int
id|minix_count_free_blocks
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_return
(paren
id|sb-&gt;u.minix_sb.s_nzones
op_minus
id|count_used
c_func
(paren
id|sb-&gt;u.minix_sb.s_zmap
comma
id|sb-&gt;u.minix_sb.s_zmap_blocks
comma
id|sb-&gt;u.minix_sb.s_nzones
)paren
)paren
op_lshift
id|sb-&gt;u.minix_sb.s_log_zone_size
suffix:semicolon
)brace
DECL|function|minix_free_inode
r_void
id|minix_free_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode-&gt;i_dev
)paren
(brace
id|memset
c_func
(paren
id|inode
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|inode
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inode-&gt;i_count
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;free_inode: inode has count=%d&bslash;n&quot;
comma
id|inode-&gt;i_count
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inode-&gt;i_nlink
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;free_inode: inode has nlink=%d&bslash;n&quot;
comma
id|inode-&gt;i_nlink
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|inode-&gt;i_sb
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;free_inode: inode on nonexistent device&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inode-&gt;i_ino
template_param
id|inode-&gt;i_sb-&gt;u.minix_sb.s_ninodes
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;free_inode: inode 0 or nonexistent inode&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|bh
op_assign
id|inode-&gt;i_sb-&gt;u.minix_sb.s_imap
(braket
id|inode-&gt;i_ino
op_rshift
l_int|13
)braket
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;free_inode: nonexistent imap in superblock&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|clear_bit
c_func
(paren
id|inode-&gt;i_ino
op_amp
l_int|8191
comma
id|bh-&gt;b_data
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;free_inode: bit already cleared.&bslash;n&bslash;r&quot;
)paren
suffix:semicolon
id|bh-&gt;b_dirt
op_assign
l_int|1
suffix:semicolon
id|memset
c_func
(paren
id|inode
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|inode
)paren
)paren
suffix:semicolon
)brace
DECL|function|minix_new_inode
r_struct
id|inode
op_star
id|minix_new_inode
c_func
(paren
r_int
id|dev
)paren
(brace
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|inode
op_assign
id|get_empty_inode
c_func
(paren
)paren
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|inode-&gt;i_sb
op_assign
id|get_super
c_func
(paren
id|dev
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;new_inode: unknown device&bslash;n&quot;
)paren
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|inode-&gt;i_flags
op_assign
id|inode-&gt;i_sb-&gt;s_flags
suffix:semicolon
id|j
op_assign
l_int|8192
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|bh
op_assign
id|inode-&gt;i_sb-&gt;u.minix_sb.s_imap
(braket
id|i
)braket
)paren
r_if
c_cond
(paren
(paren
id|j
op_assign
id|find_first_zero
c_func
(paren
id|bh-&gt;b_data
)paren
)paren
OL
l_int|8192
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bh
op_logical_or
id|j
op_ge
l_int|8192
op_logical_or
id|j
op_plus
id|i
op_star
l_int|8192
OG
id|inode-&gt;i_sb-&gt;u.minix_sb.s_ninodes
)paren
(brace
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|set_bit
c_func
(paren
id|j
comma
id|bh-&gt;b_data
)paren
)paren
(brace
multiline_comment|/* shouldn&squot;t happen */
id|printk
c_func
(paren
l_string|&quot;new_inode: bit already set&quot;
)paren
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|bh-&gt;b_dirt
op_assign
l_int|1
suffix:semicolon
id|inode-&gt;i_count
op_assign
l_int|1
suffix:semicolon
id|inode-&gt;i_nlink
op_assign
l_int|1
suffix:semicolon
id|inode-&gt;i_dev
op_assign
id|dev
suffix:semicolon
id|inode-&gt;i_uid
op_assign
id|current-&gt;euid
suffix:semicolon
id|inode-&gt;i_gid
op_assign
id|current-&gt;egid
suffix:semicolon
id|inode-&gt;i_dirt
op_assign
l_int|1
suffix:semicolon
id|inode-&gt;i_ino
op_assign
id|j
op_plus
id|i
op_star
l_int|8192
suffix:semicolon
id|inode-&gt;i_mtime
op_assign
id|inode-&gt;i_atime
op_assign
id|inode-&gt;i_ctime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|inode-&gt;i_op
op_assign
l_int|NULL
suffix:semicolon
r_return
id|inode
suffix:semicolon
)brace
DECL|function|minix_count_free_inodes
r_int
r_int
id|minix_count_free_inodes
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_return
id|sb-&gt;u.minix_sb.s_ninodes
op_minus
id|count_used
c_func
(paren
id|sb-&gt;u.minix_sb.s_imap
comma
id|sb-&gt;u.minix_sb.s_imap_blocks
comma
id|sb-&gt;u.minix_sb.s_ninodes
)paren
suffix:semicolon
)brace
eof
