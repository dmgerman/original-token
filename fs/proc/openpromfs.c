multiline_comment|/* $Id: openpromfs.c,v 1.15 1997/06/05 01:28:11 davem Exp $&n; * openpromfs.c: /proc/openprom handling routines&n; *&n; * Copyright (C) 1996 Jakub Jelinek (jj@sunsite.mff.cuni.cz)&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/openprom.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
DECL|macro|ALIASES_NNODES
mdefine_line|#define ALIASES_NNODES 64
r_typedef
r_struct
(brace
DECL|member|parent
id|u16
id|parent
suffix:semicolon
DECL|member|next
id|u16
id|next
suffix:semicolon
DECL|member|child
id|u16
id|child
suffix:semicolon
DECL|member|first_prop
id|u16
id|first_prop
suffix:semicolon
DECL|member|node
id|u32
id|node
suffix:semicolon
DECL|typedef|openpromfs_node
)brace
id|openpromfs_node
suffix:semicolon
r_typedef
r_struct
(brace
DECL|macro|OPP_STRING
mdefine_line|#define OPP_STRING&t;0x10
DECL|macro|OPP_BINARY
mdefine_line|#define OPP_BINARY&t;0x20
DECL|macro|OPP_DIRTY
mdefine_line|#define OPP_DIRTY&t;0x01
DECL|macro|OPP_QUOTED
mdefine_line|#define OPP_QUOTED&t;0x02
DECL|macro|OPP_NOTQUOTED
mdefine_line|#define OPP_NOTQUOTED&t;0x04
DECL|macro|OPP_ASCIIZ
mdefine_line|#define OPP_ASCIIZ&t;0x08
DECL|member|flag
id|u32
id|flag
suffix:semicolon
DECL|member|alloclen
id|u32
id|alloclen
suffix:semicolon
DECL|member|len
id|u32
id|len
suffix:semicolon
DECL|member|value
r_char
op_star
id|value
suffix:semicolon
DECL|member|name
r_char
id|name
(braket
l_int|8
)braket
suffix:semicolon
DECL|typedef|openprom_property
)brace
id|openprom_property
suffix:semicolon
DECL|variable|nodes
r_static
id|openpromfs_node
op_star
id|nodes
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|alloced
r_static
r_int
id|alloced
op_assign
l_int|0
suffix:semicolon
DECL|variable|last_node
r_static
id|u16
id|last_node
op_assign
l_int|0
suffix:semicolon
DECL|variable|first_prop
r_static
id|u16
id|first_prop
op_assign
l_int|0
suffix:semicolon
DECL|variable|options
r_static
id|u16
id|options
op_assign
l_int|0xffff
suffix:semicolon
DECL|variable|aliases
r_static
id|u16
id|aliases
op_assign
l_int|0xffff
suffix:semicolon
DECL|variable|aliases_nodes
r_static
r_int
id|aliases_nodes
op_assign
l_int|0
suffix:semicolon
DECL|variable|alias_names
r_static
r_char
op_star
id|alias_names
(braket
id|ALIASES_NNODES
)braket
suffix:semicolon
DECL|variable|proc_openprom_iops
r_static
r_struct
id|inode_operations
op_star
id|proc_openprom_iops
op_assign
l_int|0
suffix:semicolon
DECL|variable|devices
r_static
r_struct
id|openpromfs_dev
op_star
op_star
id|devices
suffix:semicolon
DECL|macro|NODE
mdefine_line|#define NODE(ino) nodes[ino - PROC_OPENPROM_FIRST]
DECL|macro|NODE2INO
mdefine_line|#define NODE2INO(node) (node + PROC_OPENPROM_FIRST)
DECL|macro|NODEP2INO
mdefine_line|#define NODEP2INO(no) (no + PROC_OPENPROM_FIRST + last_node)
r_static
r_int
id|openpromfs_create
(paren
r_struct
id|inode
op_star
comma
r_const
r_char
op_star
comma
r_int
comma
r_int
comma
r_struct
id|inode
op_star
op_star
)paren
suffix:semicolon
r_static
r_int
id|openpromfs_readdir
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
comma
r_void
op_star
comma
id|filldir_t
)paren
suffix:semicolon
r_static
r_int
id|openpromfs_lookup
c_func
(paren
r_struct
id|inode
op_star
comma
r_const
r_char
op_star
comma
r_int
comma
r_struct
id|inode
op_star
op_star
)paren
suffix:semicolon
r_static
r_int
id|openpromfs_unlink
(paren
r_struct
id|inode
op_star
comma
r_const
r_char
op_star
comma
r_int
)paren
suffix:semicolon
DECL|function|nodenum_read
r_static
r_int
id|nodenum_read
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
r_int
id|count
)paren
(brace
r_char
id|buffer
(braket
l_int|10
)braket
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
l_int|0
op_logical_or
op_logical_neg
id|inode-&gt;u.generic_ip
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|sprintf
(paren
id|buffer
comma
l_string|&quot;%8.8x&bslash;n&quot;
comma
(paren
id|u32
)paren
(paren
id|inode-&gt;u.generic_ip
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_pos
op_ge
l_int|9
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
l_int|9
op_minus
id|file-&gt;f_pos
)paren
id|count
op_assign
l_int|9
op_minus
id|file-&gt;f_pos
suffix:semicolon
id|copy_to_user
c_func
(paren
id|buf
comma
id|buffer
op_plus
id|file-&gt;f_pos
comma
id|count
)paren
suffix:semicolon
id|file-&gt;f_pos
op_add_assign
id|count
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|property_read
r_static
r_int
id|property_read
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_char
op_star
id|buf
comma
r_int
r_int
id|count
)paren
(brace
r_int
id|i
comma
id|j
comma
id|k
suffix:semicolon
id|u32
id|node
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
id|u32
op_star
id|q
suffix:semicolon
id|openprom_property
op_star
id|op
suffix:semicolon
r_if
c_cond
(paren
id|filp-&gt;f_pos
op_ge
l_int|0xffffff
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|filp-&gt;private_data
)paren
(brace
id|node
op_assign
id|nodes
(braket
(paren
id|u16
)paren
(paren
(paren
id|uint
)paren
id|inode-&gt;u.generic_ip
)paren
)braket
dot
id|node
suffix:semicolon
id|i
op_assign
(paren
(paren
id|u32
)paren
id|inode-&gt;u.generic_ip
)paren
op_rshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
(paren
id|u16
)paren
(paren
(paren
id|uint
)paren
id|inode-&gt;u.generic_ip
)paren
op_eq
id|aliases
)paren
(brace
r_if
c_cond
(paren
id|i
op_ge
id|aliases_nodes
)paren
id|p
op_assign
l_int|0
suffix:semicolon
r_else
id|p
op_assign
id|alias_names
(braket
id|i
)braket
suffix:semicolon
)brace
r_else
r_for
c_loop
(paren
id|p
op_assign
id|prom_firstprop
(paren
id|node
)paren
suffix:semicolon
id|i
op_logical_and
id|p
op_logical_and
op_star
id|p
suffix:semicolon
id|p
op_assign
id|prom_nextprop
(paren
id|node
comma
id|p
)paren
comma
id|i
op_decrement
)paren
multiline_comment|/* nothing */
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
op_logical_or
op_logical_neg
op_star
id|p
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|i
op_assign
id|prom_getproplen
(paren
id|node
comma
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|u16
)paren
(paren
(paren
id|uint
)paren
id|inode-&gt;u.generic_ip
)paren
op_eq
id|aliases
)paren
id|i
op_assign
l_int|0
suffix:semicolon
r_else
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|k
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|64
)paren
id|i
op_assign
l_int|64
suffix:semicolon
id|filp-&gt;private_data
op_assign
id|kmalloc
(paren
r_sizeof
(paren
id|openprom_property
)paren
op_plus
(paren
id|j
op_assign
id|strlen
(paren
id|p
)paren
)paren
op_plus
l_int|2
op_star
id|i
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|filp-&gt;private_data
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|op
op_assign
(paren
id|openprom_property
op_star
)paren
id|filp-&gt;private_data
suffix:semicolon
id|op-&gt;flag
op_assign
l_int|0
suffix:semicolon
id|op-&gt;alloclen
op_assign
l_int|2
op_star
id|i
suffix:semicolon
id|strcpy
(paren
id|op-&gt;name
comma
id|p
)paren
suffix:semicolon
id|op-&gt;value
op_assign
(paren
r_char
op_star
)paren
(paren
(paren
(paren
r_int
r_int
)paren
(paren
id|op-&gt;name
op_plus
id|j
op_plus
l_int|4
)paren
)paren
op_amp
op_complement
l_int|3
)paren
suffix:semicolon
id|op-&gt;len
op_assign
id|k
suffix:semicolon
r_if
c_cond
(paren
id|k
op_logical_and
id|prom_getproperty
(paren
id|node
comma
id|p
comma
id|op-&gt;value
comma
id|i
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|op-&gt;value
(braket
id|k
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|k
)paren
(brace
r_for
c_loop
(paren
id|p
op_assign
id|op-&gt;value
suffix:semicolon
op_star
id|p
op_ge
l_char|&squot; &squot;
op_logical_and
op_star
id|p
op_le
l_char|&squot;~&squot;
suffix:semicolon
id|p
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_ge
id|op-&gt;value
op_plus
id|k
op_minus
l_int|1
op_logical_and
op_logical_neg
op_star
id|p
)paren
(brace
id|op-&gt;flag
op_or_assign
id|OPP_STRING
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
id|op-&gt;value
op_plus
id|k
op_minus
l_int|1
)paren
(brace
id|op-&gt;flag
op_or_assign
id|OPP_ASCIIZ
suffix:semicolon
id|op-&gt;len
op_decrement
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|k
op_amp
l_int|3
)paren
)paren
id|op-&gt;flag
op_or_assign
id|OPP_BINARY
suffix:semicolon
r_else
(brace
id|printk
(paren
l_string|&quot;/proc/openprom: Strange property &quot;
l_string|&quot;size %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
)brace
r_else
id|op
op_assign
(paren
id|openprom_property
op_star
)paren
id|filp-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|count
op_logical_or
op_logical_neg
id|op-&gt;len
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|op-&gt;flag
op_amp
id|OPP_STRING
)paren
id|i
op_assign
id|op-&gt;len
op_plus
l_int|3
suffix:semicolon
r_else
id|i
op_assign
(paren
id|op-&gt;len
op_star
l_int|9
)paren
op_rshift
l_int|2
suffix:semicolon
id|k
op_assign
id|filp-&gt;f_pos
suffix:semicolon
r_if
c_cond
(paren
id|k
op_ge
id|i
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
id|i
op_minus
id|k
)paren
id|count
op_assign
id|i
op_minus
id|k
suffix:semicolon
r_if
c_cond
(paren
id|op-&gt;flag
op_amp
id|OPP_STRING
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|k
)paren
(brace
op_star
id|buf
op_assign
l_char|&squot;&bslash;&squot;&squot;
suffix:semicolon
id|k
op_increment
suffix:semicolon
id|count
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|k
op_plus
id|count
op_ge
id|i
op_minus
l_int|2
)paren
id|j
op_assign
id|i
op_minus
l_int|2
op_minus
id|k
suffix:semicolon
r_else
id|j
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|j
op_ge
l_int|0
)paren
(brace
id|copy_to_user
c_func
(paren
id|buf
op_plus
id|k
op_minus
id|filp-&gt;f_pos
comma
id|op-&gt;value
op_plus
id|k
op_minus
l_int|1
comma
id|j
)paren
suffix:semicolon
id|count
op_sub_assign
id|j
suffix:semicolon
id|k
op_add_assign
id|j
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
)paren
id|buf
(braket
id|k
op_increment
op_minus
id|filp-&gt;f_pos
)braket
op_assign
l_char|&squot;&bslash;&squot;&squot;
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
l_int|1
)paren
id|buf
(braket
id|k
op_increment
op_minus
id|filp-&gt;f_pos
)braket
op_assign
l_char|&squot;&bslash;n&squot;
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|op-&gt;flag
op_amp
id|OPP_BINARY
)paren
(brace
r_char
id|buffer
(braket
l_int|10
)braket
suffix:semicolon
id|u32
op_star
id|first
comma
op_star
id|last
suffix:semicolon
r_int
id|first_off
comma
id|last_cnt
suffix:semicolon
id|first
op_assign
(paren
(paren
id|u32
op_star
)paren
id|op-&gt;value
)paren
op_plus
id|k
op_div
l_int|9
suffix:semicolon
id|first_off
op_assign
id|k
op_mod
l_int|9
suffix:semicolon
id|last
op_assign
(paren
(paren
id|u32
op_star
)paren
id|op-&gt;value
)paren
op_plus
(paren
id|k
op_plus
id|count
op_minus
l_int|1
)paren
op_div
l_int|9
suffix:semicolon
id|last_cnt
op_assign
(paren
id|k
op_plus
id|count
)paren
op_mod
l_int|9
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|last_cnt
)paren
id|last_cnt
op_assign
l_int|9
suffix:semicolon
r_if
c_cond
(paren
id|first
op_eq
id|last
)paren
(brace
id|sprintf
(paren
id|buffer
comma
l_string|&quot;%08x.&quot;
comma
op_star
id|first
)paren
suffix:semicolon
id|memcpy
(paren
id|buf
comma
id|buffer
op_plus
id|first_off
comma
id|last_cnt
op_minus
id|first_off
)paren
suffix:semicolon
id|buf
op_add_assign
id|last_cnt
op_minus
id|first_off
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|q
op_assign
id|first
suffix:semicolon
id|q
op_le
id|last
suffix:semicolon
id|q
op_increment
)paren
(brace
id|sprintf
(paren
id|buffer
comma
l_string|&quot;%08x.&quot;
comma
op_star
id|q
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q
op_eq
id|first
)paren
(brace
id|memcpy
(paren
id|buf
comma
id|buffer
op_plus
id|first_off
comma
l_int|9
op_minus
id|first_off
)paren
suffix:semicolon
id|buf
op_add_assign
l_int|9
op_minus
id|first_off
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|q
op_eq
id|last
)paren
(brace
id|memcpy
(paren
id|buf
comma
id|buffer
comma
id|last_cnt
)paren
suffix:semicolon
id|buf
op_add_assign
id|last_cnt
suffix:semicolon
)brace
r_else
(brace
id|memcpy
(paren
id|buf
comma
id|buffer
comma
l_int|9
)paren
suffix:semicolon
id|buf
op_add_assign
l_int|9
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|last
op_eq
(paren
id|u32
op_star
)paren
(paren
id|op-&gt;value
op_plus
id|op-&gt;len
op_minus
l_int|4
)paren
op_logical_and
id|last_cnt
op_eq
l_int|9
)paren
op_star
(paren
id|buf
op_minus
l_int|1
)paren
op_assign
l_char|&squot;&bslash;n&squot;
suffix:semicolon
id|k
op_add_assign
id|count
suffix:semicolon
)brace
id|count
op_assign
id|k
op_minus
id|filp-&gt;f_pos
suffix:semicolon
id|filp-&gt;f_pos
op_assign
id|k
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|property_write
r_static
r_int
id|property_write
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_const
r_char
op_star
id|buf
comma
r_int
r_int
id|count
)paren
(brace
r_int
id|i
comma
id|j
comma
id|k
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
id|u32
op_star
id|q
suffix:semicolon
r_void
op_star
id|b
suffix:semicolon
id|openprom_property
op_star
id|op
suffix:semicolon
r_if
c_cond
(paren
id|filp-&gt;f_pos
op_ge
l_int|0xffffff
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|filp-&gt;private_data
)paren
(brace
id|i
op_assign
id|property_read
(paren
id|inode
comma
id|filp
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
)brace
id|k
op_assign
id|filp-&gt;f_pos
suffix:semicolon
id|op
op_assign
(paren
id|openprom_property
op_star
)paren
id|filp-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|op-&gt;flag
op_amp
id|OPP_STRING
)paren
)paren
(brace
id|u32
op_star
id|first
comma
op_star
id|last
suffix:semicolon
r_int
id|first_off
comma
id|last_cnt
suffix:semicolon
id|u32
id|mask
comma
id|mask2
suffix:semicolon
r_char
id|tmp
(braket
l_int|9
)braket
suffix:semicolon
r_int
id|forcelen
op_assign
l_int|0
suffix:semicolon
id|j
op_assign
id|k
op_mod
l_int|9
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
comma
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|j
op_eq
l_int|9
)paren
id|j
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|j
)paren
(brace
r_if
c_cond
(paren
id|buf
(braket
id|i
)braket
op_ne
l_char|&squot;.&squot;
)paren
(brace
r_if
c_cond
(paren
id|buf
(braket
id|i
)braket
op_ne
l_char|&squot;&bslash;n&squot;
)paren
(brace
r_if
c_cond
(paren
id|op-&gt;flag
op_amp
id|OPP_BINARY
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_else
r_goto
id|write_try_string
suffix:semicolon
)brace
r_else
(brace
id|count
op_assign
id|i
op_plus
l_int|1
suffix:semicolon
id|forcelen
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|buf
(braket
id|i
)braket
template_param
l_char|&squot;f&squot;
)paren
(brace
r_if
c_cond
(paren
id|op-&gt;flag
op_amp
id|OPP_BINARY
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_else
r_goto
id|write_try_string
suffix:semicolon
)brace
)brace
)brace
id|op-&gt;flag
op_or_assign
id|OPP_BINARY
suffix:semicolon
id|tmp
(braket
l_int|8
)braket
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
(paren
(paren
id|count
op_plus
id|k
op_plus
l_int|8
)paren
op_div
l_int|9
)paren
op_lshift
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|op-&gt;alloclen
op_le
id|i
)paren
(brace
id|b
op_assign
id|kmalloc
(paren
r_sizeof
(paren
id|openprom_property
)paren
op_plus
l_int|2
op_star
id|i
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|b
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memcpy
(paren
id|b
comma
id|filp-&gt;private_data
comma
r_sizeof
(paren
id|openprom_property
)paren
op_plus
id|strlen
(paren
id|op-&gt;name
)paren
op_plus
id|op-&gt;alloclen
)paren
suffix:semicolon
id|memset
(paren
(paren
(paren
r_char
op_star
)paren
id|b
)paren
op_plus
r_sizeof
(paren
id|openprom_property
)paren
op_plus
id|strlen
(paren
id|op-&gt;name
)paren
op_plus
id|op-&gt;alloclen
comma
l_int|0
comma
l_int|2
op_star
id|i
op_minus
id|op-&gt;alloclen
)paren
suffix:semicolon
id|op
op_assign
(paren
id|openprom_property
op_star
)paren
id|b
suffix:semicolon
id|op-&gt;alloclen
op_assign
l_int|2
op_star
id|i
suffix:semicolon
id|b
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|filp-&gt;private_data
op_assign
(paren
r_void
op_star
)paren
id|op
suffix:semicolon
id|kfree
(paren
id|b
)paren
suffix:semicolon
)brace
id|first
op_assign
(paren
(paren
id|u32
op_star
)paren
id|op-&gt;value
)paren
op_plus
(paren
id|k
op_div
l_int|9
)paren
suffix:semicolon
id|first_off
op_assign
id|k
op_mod
l_int|9
suffix:semicolon
id|last
op_assign
(paren
id|u32
op_star
)paren
(paren
id|op-&gt;value
op_plus
id|i
)paren
suffix:semicolon
id|last_cnt
op_assign
(paren
id|k
op_plus
id|count
)paren
op_mod
l_int|9
suffix:semicolon
r_if
c_cond
(paren
id|first
op_plus
l_int|1
op_eq
id|last
)paren
(brace
id|memset
(paren
id|tmp
comma
l_char|&squot;0&squot;
comma
l_int|8
)paren
suffix:semicolon
id|memcpy
(paren
id|tmp
op_plus
id|first_off
comma
id|buf
comma
(paren
id|count
op_plus
id|first_off
OG
l_int|8
)paren
ques
c_cond
l_int|8
op_minus
id|first_off
suffix:colon
id|count
)paren
suffix:semicolon
id|mask
op_assign
l_int|0xffffffff
suffix:semicolon
id|mask2
op_assign
l_int|0xffffffff
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|first_off
suffix:semicolon
id|j
op_increment
)paren
id|mask
op_rshift_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|8
op_minus
id|count
op_minus
id|first_off
suffix:semicolon
id|j
OG
l_int|0
suffix:semicolon
id|j
op_decrement
)paren
id|mask2
op_lshift_assign
l_int|1
suffix:semicolon
id|mask
op_and_assign
id|mask2
suffix:semicolon
r_if
c_cond
(paren
id|mask
)paren
(brace
op_star
id|first
op_and_assign
op_complement
id|mask
suffix:semicolon
op_star
id|first
op_or_assign
id|simple_strtoul
(paren
id|tmp
comma
l_int|0
comma
l_int|16
)paren
suffix:semicolon
id|op-&gt;flag
op_or_assign
id|OPP_DIRTY
suffix:semicolon
)brace
)brace
r_else
(brace
id|op-&gt;flag
op_or_assign
id|OPP_DIRTY
suffix:semicolon
r_for
c_loop
(paren
id|q
op_assign
id|first
suffix:semicolon
id|q
OL
id|last
suffix:semicolon
id|q
op_increment
)paren
(brace
r_if
c_cond
(paren
id|q
op_eq
id|first
)paren
(brace
r_if
c_cond
(paren
id|first_off
OL
l_int|8
)paren
(brace
id|memset
(paren
id|tmp
comma
l_char|&squot;0&squot;
comma
l_int|8
)paren
suffix:semicolon
id|memcpy
(paren
id|tmp
op_plus
id|first_off
comma
id|buf
comma
l_int|8
op_minus
id|first_off
)paren
suffix:semicolon
id|mask
op_assign
l_int|0xffffffff
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|first_off
suffix:semicolon
id|j
op_increment
)paren
id|mask
op_rshift_assign
l_int|1
suffix:semicolon
op_star
id|q
op_and_assign
op_complement
id|mask
suffix:semicolon
op_star
id|q
op_or_assign
id|simple_strtoul
(paren
id|tmp
comma
l_int|0
comma
l_int|16
)paren
suffix:semicolon
)brace
id|buf
op_add_assign
l_int|9
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|q
op_eq
id|last
op_minus
l_int|1
)paren
op_logical_and
id|last_cnt
op_logical_and
(paren
id|last_cnt
OL
l_int|8
)paren
)paren
(brace
id|memset
(paren
id|tmp
comma
l_char|&squot;0&squot;
comma
l_int|8
)paren
suffix:semicolon
id|memcpy
(paren
id|tmp
comma
id|buf
comma
id|last_cnt
)paren
suffix:semicolon
id|mask
op_assign
l_int|0xffffffff
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
op_minus
id|last_cnt
suffix:semicolon
id|j
op_increment
)paren
id|mask
op_lshift_assign
l_int|1
suffix:semicolon
op_star
id|q
op_and_assign
op_complement
id|mask
suffix:semicolon
op_star
id|q
op_or_assign
id|simple_strtoul
(paren
id|tmp
comma
l_int|0
comma
l_int|16
)paren
suffix:semicolon
id|buf
op_add_assign
id|last_cnt
suffix:semicolon
)brace
r_else
(brace
op_star
id|q
op_assign
id|simple_strtoul
(paren
id|buf
comma
l_int|0
comma
l_int|16
)paren
suffix:semicolon
id|buf
op_add_assign
l_int|9
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|forcelen
)paren
(brace
r_if
c_cond
(paren
id|op-&gt;len
OL
id|i
)paren
id|op-&gt;len
op_assign
id|i
suffix:semicolon
)brace
r_else
id|op-&gt;len
op_assign
id|i
suffix:semicolon
id|filp-&gt;f_pos
op_add_assign
id|count
suffix:semicolon
)brace
id|write_try_string
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|op-&gt;flag
op_amp
id|OPP_BINARY
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|op-&gt;flag
op_amp
(paren
id|OPP_QUOTED
op_or
id|OPP_NOTQUOTED
)paren
)paren
)paren
(brace
multiline_comment|/* No way, if somebody starts writing from the middle, &n;&t;&t;&t; * we don&squot;t know whether he uses quotes around or not &n;&t;&t;&t; */
r_if
c_cond
(paren
id|k
OG
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_star
id|buf
op_eq
l_char|&squot;&bslash;&squot;&squot;
)paren
(brace
id|op-&gt;flag
op_or_assign
id|OPP_QUOTED
suffix:semicolon
id|buf
op_increment
suffix:semicolon
id|count
op_decrement
suffix:semicolon
id|filp-&gt;f_pos
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|count
)paren
(brace
id|op-&gt;flag
op_or_assign
id|OPP_STRING
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_else
id|op-&gt;flag
op_or_assign
id|OPP_NOTQUOTED
suffix:semicolon
)brace
id|op-&gt;flag
op_or_assign
id|OPP_STRING
suffix:semicolon
r_if
c_cond
(paren
id|op-&gt;alloclen
op_le
id|count
op_plus
id|filp-&gt;f_pos
)paren
(brace
id|b
op_assign
id|kmalloc
(paren
r_sizeof
(paren
id|openprom_property
)paren
op_plus
l_int|2
op_star
(paren
id|count
op_plus
id|filp-&gt;f_pos
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|b
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memcpy
(paren
id|b
comma
id|filp-&gt;private_data
comma
r_sizeof
(paren
id|openprom_property
)paren
op_plus
id|strlen
(paren
id|op-&gt;name
)paren
op_plus
id|op-&gt;alloclen
)paren
suffix:semicolon
id|memset
(paren
(paren
(paren
r_char
op_star
)paren
id|b
)paren
op_plus
r_sizeof
(paren
id|openprom_property
)paren
op_plus
id|strlen
(paren
id|op-&gt;name
)paren
op_plus
id|op-&gt;alloclen
comma
l_int|0
comma
l_int|2
op_star
(paren
id|count
op_minus
id|filp-&gt;f_pos
)paren
op_minus
id|op-&gt;alloclen
)paren
suffix:semicolon
id|op
op_assign
(paren
id|openprom_property
op_star
)paren
id|b
suffix:semicolon
id|op-&gt;alloclen
op_assign
l_int|2
op_star
(paren
id|count
op_plus
id|filp-&gt;f_pos
)paren
suffix:semicolon
id|b
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|filp-&gt;private_data
op_assign
(paren
r_void
op_star
)paren
id|op
suffix:semicolon
id|kfree
(paren
id|b
)paren
suffix:semicolon
)brace
id|p
op_assign
id|op-&gt;value
op_plus
id|filp-&gt;f_pos
op_minus
(paren
(paren
id|op-&gt;flag
op_amp
id|OPP_QUOTED
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|memcpy
(paren
id|p
comma
id|buf
comma
id|count
)paren
suffix:semicolon
id|op-&gt;flag
op_or_assign
id|OPP_DIRTY
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
comma
id|p
op_increment
)paren
r_if
c_cond
(paren
op_star
id|p
op_eq
l_char|&squot;&bslash;n&squot;
)paren
(brace
op_star
id|p
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
OL
id|count
)paren
(brace
id|op-&gt;len
op_assign
id|p
op_minus
id|op-&gt;value
suffix:semicolon
id|filp-&gt;f_pos
op_add_assign
id|i
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
OG
id|op-&gt;value
)paren
op_logical_and
(paren
id|op-&gt;flag
op_amp
id|OPP_QUOTED
)paren
op_logical_and
(paren
op_star
(paren
id|p
op_minus
l_int|1
)paren
op_eq
l_char|&squot;&bslash;&squot;&squot;
)paren
)paren
id|op-&gt;len
op_decrement
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|p
op_minus
id|op-&gt;value
OG
id|op-&gt;len
)paren
id|op-&gt;len
op_assign
id|p
op_minus
id|op-&gt;value
suffix:semicolon
id|filp-&gt;f_pos
op_add_assign
id|count
suffix:semicolon
)brace
)brace
r_return
id|filp-&gt;f_pos
op_minus
id|k
suffix:semicolon
)brace
DECL|function|property_release
r_int
id|property_release
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|openprom_property
op_star
id|op
op_assign
(paren
id|openprom_property
op_star
)paren
id|filp-&gt;private_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|error
suffix:semicolon
id|u32
id|node
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|op
)paren
r_return
l_int|0
suffix:semicolon
id|node
op_assign
id|nodes
(braket
(paren
id|u16
)paren
(paren
(paren
id|uint
)paren
id|inode-&gt;u.generic_ip
)paren
)braket
dot
id|node
suffix:semicolon
r_if
c_cond
(paren
(paren
id|u16
)paren
(paren
(paren
id|uint
)paren
id|inode-&gt;u.generic_ip
)paren
op_eq
id|aliases
)paren
(brace
r_if
c_cond
(paren
(paren
id|op-&gt;flag
op_amp
id|OPP_DIRTY
)paren
op_logical_and
(paren
id|op-&gt;flag
op_amp
id|OPP_STRING
)paren
)paren
(brace
r_char
op_star
id|p
op_assign
id|op-&gt;name
suffix:semicolon
r_int
id|i
op_assign
(paren
id|op-&gt;value
op_minus
id|op-&gt;name
)paren
op_minus
id|strlen
(paren
id|op-&gt;name
)paren
op_minus
l_int|1
suffix:semicolon
id|op-&gt;value
(braket
id|op-&gt;len
)braket
op_assign
l_int|0
suffix:semicolon
op_star
(paren
id|op-&gt;value
op_minus
l_int|1
)paren
op_assign
l_char|&squot; &squot;
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
(brace
r_for
c_loop
(paren
id|p
op_assign
id|op-&gt;value
op_minus
id|i
op_minus
l_int|2
suffix:semicolon
id|p
op_ge
id|op-&gt;name
suffix:semicolon
id|p
op_decrement
)paren
id|p
(braket
id|i
)braket
op_assign
op_star
id|p
suffix:semicolon
id|p
op_assign
id|op-&gt;name
op_plus
id|i
suffix:semicolon
)brace
id|memcpy
(paren
id|p
op_minus
l_int|8
comma
l_string|&quot;nvalias &quot;
comma
l_int|8
)paren
suffix:semicolon
id|prom_feval
(paren
id|p
op_minus
l_int|8
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|op-&gt;flag
op_amp
id|OPP_DIRTY
)paren
(brace
r_if
c_cond
(paren
id|op-&gt;flag
op_amp
id|OPP_STRING
)paren
(brace
id|op-&gt;value
(braket
id|op-&gt;len
)braket
op_assign
l_int|0
suffix:semicolon
id|save_and_cli
(paren
id|flags
)paren
suffix:semicolon
id|error
op_assign
id|prom_setprop
(paren
id|node
comma
id|op-&gt;name
comma
id|op-&gt;value
comma
id|op-&gt;len
op_plus
l_int|1
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_le
l_int|0
)paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;/proc/openprom: &quot;
l_string|&quot;Couldn&squot;t write property %s&bslash;n&quot;
comma
id|op-&gt;name
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|op-&gt;flag
op_amp
id|OPP_BINARY
)paren
op_logical_or
op_logical_neg
id|op-&gt;len
)paren
(brace
id|save_and_cli
(paren
id|flags
)paren
suffix:semicolon
id|error
op_assign
id|prom_setprop
(paren
id|node
comma
id|op-&gt;name
comma
id|op-&gt;value
comma
id|op-&gt;len
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_le
l_int|0
)paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;/proc/openprom: &quot;
l_string|&quot;Couldn&squot;t write property %s&bslash;n&quot;
comma
id|op-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;/proc/openprom: &quot;
l_string|&quot;Unknown property type of %s&bslash;n&quot;
comma
id|op-&gt;name
)paren
suffix:semicolon
)brace
)brace
id|kfree
(paren
id|filp-&gt;private_data
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|openpromfs_prop_ops
r_static
r_struct
id|file_operations
id|openpromfs_prop_ops
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* lseek - default */
id|property_read
comma
multiline_comment|/* read */
id|property_write
comma
multiline_comment|/* write - bad */
l_int|NULL
comma
multiline_comment|/* readdir */
l_int|NULL
comma
multiline_comment|/* poll - default */
l_int|NULL
comma
multiline_comment|/* ioctl - default */
l_int|NULL
comma
multiline_comment|/* mmap */
l_int|NULL
comma
multiline_comment|/* no special open code */
id|property_release
comma
multiline_comment|/* no special release code */
l_int|NULL
multiline_comment|/* can&squot;t fsync */
)brace
suffix:semicolon
DECL|variable|openpromfs_prop_inode_ops
r_static
r_struct
id|inode_operations
id|openpromfs_prop_inode_ops
op_assign
(brace
op_amp
id|openpromfs_prop_ops
comma
multiline_comment|/* default property file-ops */
l_int|NULL
comma
multiline_comment|/* create */
l_int|NULL
comma
multiline_comment|/* lookup */
l_int|NULL
comma
multiline_comment|/* link */
l_int|NULL
comma
multiline_comment|/* unlink */
l_int|NULL
comma
multiline_comment|/* symlink */
l_int|NULL
comma
multiline_comment|/* mkdir */
l_int|NULL
comma
multiline_comment|/* rmdir */
l_int|NULL
comma
multiline_comment|/* mknod */
l_int|NULL
comma
multiline_comment|/* rename */
l_int|NULL
comma
multiline_comment|/* readlink */
l_int|NULL
comma
multiline_comment|/* readpage */
l_int|NULL
comma
multiline_comment|/* writepage */
l_int|NULL
comma
multiline_comment|/* bmap */
l_int|NULL
comma
multiline_comment|/* truncate */
l_int|NULL
multiline_comment|/* permission */
)brace
suffix:semicolon
DECL|variable|openpromfs_nodenum_ops
r_static
r_struct
id|file_operations
id|openpromfs_nodenum_ops
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* lseek - default */
id|nodenum_read
comma
multiline_comment|/* read */
l_int|NULL
comma
multiline_comment|/* write - bad */
l_int|NULL
comma
multiline_comment|/* readdir */
l_int|NULL
comma
multiline_comment|/* poll - default */
l_int|NULL
comma
multiline_comment|/* ioctl - default */
l_int|NULL
comma
multiline_comment|/* mmap */
l_int|NULL
comma
multiline_comment|/* no special open code */
l_int|NULL
comma
multiline_comment|/* no special release code */
l_int|NULL
multiline_comment|/* can&squot;t fsync */
)brace
suffix:semicolon
DECL|variable|openpromfs_nodenum_inode_ops
r_static
r_struct
id|inode_operations
id|openpromfs_nodenum_inode_ops
op_assign
(brace
op_amp
id|openpromfs_nodenum_ops
comma
multiline_comment|/* default .node file-ops */
l_int|NULL
comma
multiline_comment|/* create */
l_int|NULL
comma
multiline_comment|/* lookup */
l_int|NULL
comma
multiline_comment|/* link */
l_int|NULL
comma
multiline_comment|/* unlink */
l_int|NULL
comma
multiline_comment|/* symlink */
l_int|NULL
comma
multiline_comment|/* mkdir */
l_int|NULL
comma
multiline_comment|/* rmdir */
l_int|NULL
comma
multiline_comment|/* mknod */
l_int|NULL
comma
multiline_comment|/* rename */
l_int|NULL
comma
multiline_comment|/* readlink */
l_int|NULL
comma
multiline_comment|/* readpage */
l_int|NULL
comma
multiline_comment|/* writepage */
l_int|NULL
comma
multiline_comment|/* bmap */
l_int|NULL
comma
multiline_comment|/* truncate */
l_int|NULL
multiline_comment|/* permission */
)brace
suffix:semicolon
DECL|variable|openprom_alias_operations
r_static
r_struct
id|file_operations
id|openprom_alias_operations
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* lseek - default */
l_int|NULL
comma
multiline_comment|/* read - bad */
l_int|NULL
comma
multiline_comment|/* write - bad */
id|openpromfs_readdir
comma
multiline_comment|/* readdir */
l_int|NULL
comma
multiline_comment|/* poll - default */
l_int|NULL
comma
multiline_comment|/* ioctl - default */
l_int|NULL
comma
multiline_comment|/* mmap */
l_int|NULL
comma
multiline_comment|/* no special open code */
l_int|NULL
comma
multiline_comment|/* no special release code */
l_int|NULL
multiline_comment|/* can&squot;t fsync */
)brace
suffix:semicolon
DECL|variable|openprom_alias_inode_operations
r_static
r_struct
id|inode_operations
id|openprom_alias_inode_operations
op_assign
(brace
op_amp
id|openprom_alias_operations
comma
multiline_comment|/* default aliases directory file-ops */
id|openpromfs_create
comma
multiline_comment|/* create */
id|openpromfs_lookup
comma
multiline_comment|/* lookup */
l_int|NULL
comma
multiline_comment|/* link */
id|openpromfs_unlink
comma
multiline_comment|/* unlink */
l_int|NULL
comma
multiline_comment|/* symlink */
l_int|NULL
comma
multiline_comment|/* mkdir */
l_int|NULL
comma
multiline_comment|/* rmdir */
l_int|NULL
comma
multiline_comment|/* mknod */
l_int|NULL
comma
multiline_comment|/* rename */
l_int|NULL
comma
multiline_comment|/* readlink */
l_int|NULL
comma
multiline_comment|/* readpage */
l_int|NULL
comma
multiline_comment|/* writepage */
l_int|NULL
comma
multiline_comment|/* bmap */
l_int|NULL
comma
multiline_comment|/* truncate */
l_int|NULL
multiline_comment|/* permission */
)brace
suffix:semicolon
DECL|function|lookup_children
r_static
r_int
id|lookup_children
c_func
(paren
id|u16
id|n
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
)paren
(brace
r_int
id|ret
suffix:semicolon
id|u16
id|node
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|n
op_ne
l_int|0xffff
suffix:semicolon
id|n
op_assign
id|nodes
(braket
id|n
)braket
dot
id|next
)paren
(brace
id|node
op_assign
id|nodes
(braket
id|n
)braket
dot
id|child
suffix:semicolon
r_if
c_cond
(paren
id|node
op_ne
l_int|0xffff
)paren
(brace
r_char
id|buffer
(braket
l_int|128
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_while
c_loop
(paren
id|node
op_ne
l_int|0xffff
)paren
(brace
r_if
c_cond
(paren
id|prom_getname
(paren
id|nodes
(braket
id|node
)braket
dot
id|node
comma
id|buffer
comma
l_int|128
)paren
op_ge
l_int|0
)paren
(brace
id|i
op_assign
id|strlen
(paren
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
op_eq
id|i
)paren
op_logical_and
op_logical_neg
id|strncmp
(paren
id|buffer
comma
id|name
comma
id|len
)paren
)paren
r_return
id|NODE2INO
c_func
(paren
id|node
)paren
suffix:semicolon
id|p
op_assign
id|strchr
(paren
id|buffer
comma
l_char|&squot;@&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_logical_and
(paren
id|len
op_eq
id|p
op_minus
id|buffer
)paren
op_logical_and
op_logical_neg
id|strncmp
(paren
id|buffer
comma
id|name
comma
id|len
)paren
)paren
r_return
id|NODE2INO
c_func
(paren
id|node
)paren
suffix:semicolon
)brace
id|node
op_assign
id|nodes
(braket
id|node
)braket
dot
id|next
suffix:semicolon
)brace
)brace
r_else
r_continue
suffix:semicolon
id|ret
op_assign
id|lookup_children
(paren
id|nodes
(braket
id|n
)braket
dot
id|child
comma
id|name
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|openpromfs_lookup
r_static
r_int
id|openpromfs_lookup
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
comma
r_struct
id|inode
op_star
op_star
id|result
)paren
(brace
r_int
id|ino
op_assign
l_int|0
suffix:semicolon
DECL|macro|OPFSL_DIR
mdefine_line|#define OPFSL_DIR&t;0
DECL|macro|OPFSL_PROPERTY
mdefine_line|#define OPFSL_PROPERTY&t;1
DECL|macro|OPFSL_NODENUM
mdefine_line|#define OPFSL_NODENUM&t;2
DECL|macro|OPFSL_DEVICE
mdefine_line|#define OPFSL_DEVICE&t;3
r_int
id|type
op_assign
l_int|0
suffix:semicolon
r_char
id|buffer
(braket
l_int|128
)braket
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
id|u32
id|n
suffix:semicolon
id|u16
id|dirnode
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_struct
id|openpromfs_dev
op_star
id|d
op_assign
l_int|NULL
suffix:semicolon
op_star
id|result
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dir
op_logical_or
op_logical_neg
id|S_ISDIR
c_func
(paren
id|dir-&gt;i_mode
)paren
)paren
(brace
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|ENOTDIR
suffix:semicolon
)brace
op_star
id|result
op_assign
id|dir
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|name
(braket
l_int|0
)braket
op_eq
l_char|&squot;.&squot;
)paren
(brace
r_if
c_cond
(paren
id|len
op_eq
l_int|1
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|name
(braket
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
op_logical_and
id|len
op_eq
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|dir-&gt;i_ino
op_eq
id|PROC_OPENPROM
)paren
(brace
id|inode
op_assign
id|proc_get_inode
(paren
id|dir-&gt;i_sb
comma
id|PROC_ROOT_INO
comma
op_amp
id|proc_root
)paren
suffix:semicolon
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
op_star
id|result
op_assign
id|inode
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|ino
op_assign
id|NODE2INO
c_func
(paren
id|NODE
c_func
(paren
id|dir-&gt;i_ino
)paren
dot
id|parent
)paren
suffix:semicolon
id|type
op_assign
id|OPFSL_DIR
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|len
op_eq
l_int|5
op_logical_and
op_logical_neg
id|strncmp
(paren
id|name
op_plus
l_int|1
comma
l_string|&quot;node&quot;
comma
l_int|4
)paren
)paren
(brace
id|ino
op_assign
id|NODEP2INO
c_func
(paren
id|NODE
c_func
(paren
id|dir-&gt;i_ino
)paren
dot
id|first_prop
)paren
suffix:semicolon
id|type
op_assign
id|OPFSL_NODENUM
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|ino
)paren
(brace
id|u16
id|node
op_assign
id|NODE
c_func
(paren
id|dir-&gt;i_ino
)paren
dot
id|child
suffix:semicolon
r_while
c_loop
(paren
id|node
op_ne
l_int|0xffff
)paren
(brace
r_if
c_cond
(paren
id|prom_getname
(paren
id|nodes
(braket
id|node
)braket
dot
id|node
comma
id|buffer
comma
l_int|128
)paren
op_ge
l_int|0
)paren
(brace
id|i
op_assign
id|strlen
(paren
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_eq
id|i
op_logical_and
op_logical_neg
id|strncmp
(paren
id|buffer
comma
id|name
comma
id|len
)paren
)paren
(brace
id|ino
op_assign
id|NODE2INO
c_func
(paren
id|node
)paren
suffix:semicolon
id|type
op_assign
id|OPFSL_DIR
suffix:semicolon
r_break
suffix:semicolon
)brace
id|p
op_assign
id|strchr
(paren
id|buffer
comma
l_char|&squot;@&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_logical_and
(paren
id|len
op_eq
id|p
op_minus
id|buffer
)paren
op_logical_and
op_logical_neg
id|strncmp
(paren
id|buffer
comma
id|name
comma
id|len
)paren
)paren
(brace
id|ino
op_assign
id|NODE2INO
c_func
(paren
id|node
)paren
suffix:semicolon
id|type
op_assign
id|OPFSL_DIR
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|node
op_assign
id|nodes
(braket
id|node
)braket
dot
id|next
suffix:semicolon
)brace
)brace
id|n
op_assign
id|NODE
c_func
(paren
id|dir-&gt;i_ino
)paren
dot
id|node
suffix:semicolon
id|dirnode
op_assign
id|dir-&gt;i_ino
op_minus
id|PROC_OPENPROM_FIRST
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ino
)paren
(brace
r_int
id|j
op_assign
id|NODEP2INO
c_func
(paren
id|NODE
c_func
(paren
id|dir-&gt;i_ino
)paren
dot
id|first_prop
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dirnode
op_ne
id|aliases
)paren
(brace
r_for
c_loop
(paren
id|p
op_assign
id|prom_firstprop
(paren
id|n
)paren
suffix:semicolon
id|p
op_logical_and
op_star
id|p
suffix:semicolon
id|p
op_assign
id|prom_nextprop
(paren
id|n
comma
id|p
)paren
)paren
(brace
id|j
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
op_eq
id|strlen
(paren
id|p
)paren
)paren
op_logical_and
op_logical_neg
id|strncmp
(paren
id|p
comma
id|name
comma
id|len
)paren
)paren
(brace
id|ino
op_assign
id|j
suffix:semicolon
id|type
op_assign
id|OPFSL_PROPERTY
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_int
id|k
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|aliases_nodes
suffix:semicolon
id|k
op_increment
)paren
(brace
id|j
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|alias_names
(braket
id|k
)braket
op_logical_and
(paren
id|len
op_eq
id|strlen
(paren
id|alias_names
(braket
id|k
)braket
)paren
)paren
op_logical_and
op_logical_neg
id|strncmp
(paren
id|alias_names
(braket
id|k
)braket
comma
id|name
comma
id|len
)paren
)paren
(brace
id|ino
op_assign
id|j
suffix:semicolon
id|type
op_assign
id|OPFSL_PROPERTY
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|ino
)paren
(brace
r_for
c_loop
(paren
id|d
op_assign
op_star
id|devices
suffix:semicolon
id|d
suffix:semicolon
id|d
op_assign
id|d-&gt;next
)paren
r_if
c_cond
(paren
(paren
id|d-&gt;node
op_eq
id|n
)paren
op_logical_and
(paren
id|strlen
(paren
id|d-&gt;name
)paren
op_eq
id|len
)paren
op_logical_and
op_logical_neg
id|strncmp
(paren
id|d-&gt;name
comma
id|name
comma
id|len
)paren
)paren
(brace
id|ino
op_assign
id|d-&gt;inode
suffix:semicolon
id|type
op_assign
id|OPFSL_DEVICE
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|ino
)paren
(brace
id|ino
op_assign
id|lookup_children
(paren
id|NODE
c_func
(paren
id|dir-&gt;i_ino
)paren
dot
id|child
comma
id|name
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ino
)paren
id|type
op_assign
id|OPFSL_DIR
suffix:semicolon
r_else
(brace
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
)brace
id|inode
op_assign
id|proc_get_inode
(paren
id|dir-&gt;i_sb
comma
id|ino
comma
l_int|0
)paren
suffix:semicolon
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|OPFSL_DIR
suffix:colon
id|inode-&gt;i_mode
op_assign
id|S_IFDIR
op_or
id|S_IRUGO
op_or
id|S_IXUGO
suffix:semicolon
r_if
c_cond
(paren
id|ino
op_eq
id|PROC_OPENPROM_FIRST
op_plus
id|aliases
)paren
(brace
id|inode-&gt;i_mode
op_or_assign
id|S_IWUSR
suffix:semicolon
id|inode-&gt;i_op
op_assign
op_amp
id|openprom_alias_inode_operations
suffix:semicolon
)brace
r_else
id|inode-&gt;i_op
op_assign
id|proc_openprom_iops
suffix:semicolon
id|inode-&gt;i_nlink
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OPFSL_NODENUM
suffix:colon
id|inode-&gt;i_mode
op_assign
id|S_IFREG
op_or
id|S_IRUGO
suffix:semicolon
id|inode-&gt;i_op
op_assign
op_amp
id|openpromfs_nodenum_inode_ops
suffix:semicolon
id|inode-&gt;i_nlink
op_assign
l_int|1
suffix:semicolon
id|inode-&gt;u.generic_ip
op_assign
(paren
r_void
op_star
)paren
(paren
id|n
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OPFSL_PROPERTY
suffix:colon
r_if
c_cond
(paren
(paren
id|dirnode
op_eq
id|options
)paren
op_logical_and
(paren
id|len
op_eq
l_int|17
)paren
op_logical_and
op_logical_neg
id|strncmp
(paren
id|name
comma
l_string|&quot;security-password&quot;
comma
l_int|17
)paren
)paren
id|inode-&gt;i_mode
op_assign
id|S_IFREG
op_or
id|S_IRUSR
op_or
id|S_IWUSR
suffix:semicolon
r_else
(brace
id|inode-&gt;i_mode
op_assign
id|S_IFREG
op_or
id|S_IRUGO
suffix:semicolon
r_if
c_cond
(paren
id|dirnode
op_eq
id|options
op_logical_or
id|dirnode
op_eq
id|aliases
)paren
(brace
r_if
c_cond
(paren
id|len
op_ne
l_int|4
op_logical_or
id|strncmp
(paren
id|name
comma
l_string|&quot;name&quot;
comma
l_int|4
)paren
)paren
id|inode-&gt;i_mode
op_or_assign
id|S_IWUSR
suffix:semicolon
)brace
)brace
id|inode-&gt;i_op
op_assign
op_amp
id|openpromfs_prop_inode_ops
suffix:semicolon
id|inode-&gt;i_nlink
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|inode-&gt;i_size
OL
l_int|0
)paren
id|inode-&gt;i_size
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;u.generic_ip
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
(paren
id|u16
)paren
id|dirnode
)paren
op_or
(paren
(paren
(paren
id|u16
)paren
(paren
id|ino
op_minus
id|NODEP2INO
c_func
(paren
id|NODE
c_func
(paren
id|dir-&gt;i_ino
)paren
dot
id|first_prop
)paren
op_minus
l_int|1
)paren
)paren
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OPFSL_DEVICE
suffix:colon
id|inode-&gt;i_mode
op_assign
id|d-&gt;mode
suffix:semicolon
id|inode-&gt;i_op
op_assign
op_amp
id|chrdev_inode_operations
suffix:semicolon
id|inode-&gt;i_nlink
op_assign
l_int|1
suffix:semicolon
id|inode-&gt;i_rdev
op_assign
id|d-&gt;rdev
suffix:semicolon
r_break
suffix:semicolon
)brace
op_star
id|result
op_assign
id|inode
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|openpromfs_readdir
r_static
r_int
id|openpromfs_readdir
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_void
op_star
id|dirent
comma
id|filldir_t
id|filldir
)paren
(brace
r_int
r_int
id|ino
suffix:semicolon
id|u32
id|n
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
r_char
id|buffer
(braket
l_int|128
)braket
suffix:semicolon
id|u16
id|node
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_struct
id|openpromfs_dev
op_star
id|d
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
op_logical_or
op_logical_neg
id|S_ISDIR
(paren
id|inode-&gt;i_mode
)paren
)paren
r_return
op_minus
id|ENOTDIR
suffix:semicolon
id|ino
op_assign
id|inode-&gt;i_ino
suffix:semicolon
id|i
op_assign
id|filp-&gt;f_pos
suffix:semicolon
r_switch
c_cond
(paren
id|i
)paren
(brace
r_case
l_int|0
suffix:colon
r_if
c_cond
(paren
id|filldir
c_func
(paren
id|dirent
comma
l_string|&quot;.&quot;
comma
l_int|1
comma
id|i
comma
id|ino
)paren
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|i
op_increment
suffix:semicolon
id|filp-&gt;f_pos
op_increment
suffix:semicolon
multiline_comment|/* fall thru */
r_case
l_int|1
suffix:colon
r_if
c_cond
(paren
id|filldir
c_func
(paren
id|dirent
comma
l_string|&quot;..&quot;
comma
l_int|2
comma
id|i
comma
(paren
id|NODE
c_func
(paren
id|ino
)paren
dot
id|parent
op_eq
l_int|0xffff
)paren
ques
c_cond
id|PROC_ROOT_INO
suffix:colon
id|NODE2INO
c_func
(paren
id|NODE
c_func
(paren
id|ino
)paren
dot
id|parent
)paren
)paren
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|i
op_increment
suffix:semicolon
id|filp-&gt;f_pos
op_increment
suffix:semicolon
multiline_comment|/* fall thru */
r_default
suffix:colon
id|i
op_sub_assign
l_int|2
suffix:semicolon
id|node
op_assign
id|NODE
c_func
(paren
id|ino
)paren
dot
id|child
suffix:semicolon
r_while
c_loop
(paren
id|i
op_logical_and
id|node
op_ne
l_int|0xffff
)paren
(brace
id|node
op_assign
id|nodes
(braket
id|node
)braket
dot
id|next
suffix:semicolon
id|i
op_decrement
suffix:semicolon
)brace
r_while
c_loop
(paren
id|node
op_ne
l_int|0xffff
)paren
(brace
r_if
c_cond
(paren
id|prom_getname
(paren
id|nodes
(braket
id|node
)braket
dot
id|node
comma
id|buffer
comma
l_int|128
)paren
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|filldir
c_func
(paren
id|dirent
comma
id|buffer
comma
id|strlen
c_func
(paren
id|buffer
)paren
comma
id|filp-&gt;f_pos
comma
id|NODE2INO
c_func
(paren
id|node
)paren
)paren
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|filp-&gt;f_pos
op_increment
suffix:semicolon
id|node
op_assign
id|nodes
(braket
id|node
)braket
dot
id|next
suffix:semicolon
)brace
id|j
op_assign
id|NODEP2INO
c_func
(paren
id|NODE
c_func
(paren
id|ino
)paren
dot
id|first_prop
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|i
)paren
(brace
r_if
c_cond
(paren
id|filldir
c_func
(paren
id|dirent
comma
l_string|&quot;.node&quot;
comma
l_int|5
comma
id|filp-&gt;f_pos
comma
id|j
)paren
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|filp-&gt;f_pos
op_increment
suffix:semicolon
)brace
r_else
id|i
op_decrement
suffix:semicolon
id|n
op_assign
id|NODE
c_func
(paren
id|ino
)paren
dot
id|node
suffix:semicolon
r_if
c_cond
(paren
id|ino
op_eq
id|PROC_OPENPROM_FIRST
op_plus
id|aliases
)paren
(brace
r_for
c_loop
(paren
id|j
op_increment
suffix:semicolon
id|i
OL
id|aliases_nodes
suffix:semicolon
id|i
op_increment
comma
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|alias_names
(braket
id|i
)braket
)paren
(brace
r_if
c_cond
(paren
id|filldir
(paren
id|dirent
comma
id|alias_names
(braket
id|i
)braket
comma
id|strlen
(paren
id|alias_names
(braket
id|i
)braket
)paren
comma
id|filp-&gt;f_pos
comma
id|j
)paren
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|filp-&gt;f_pos
op_increment
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_for
c_loop
(paren
id|p
op_assign
id|prom_firstprop
(paren
id|n
)paren
suffix:semicolon
id|p
op_logical_and
op_star
id|p
suffix:semicolon
id|p
op_assign
id|prom_nextprop
(paren
id|n
comma
id|p
)paren
)paren
(brace
id|j
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
id|i
op_decrement
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|filldir
c_func
(paren
id|dirent
comma
id|p
comma
id|strlen
c_func
(paren
id|p
)paren
comma
id|filp-&gt;f_pos
comma
id|j
)paren
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|filp-&gt;f_pos
op_increment
suffix:semicolon
)brace
)brace
)brace
r_for
c_loop
(paren
id|d
op_assign
op_star
id|devices
suffix:semicolon
id|d
suffix:semicolon
id|d
op_assign
id|d-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|d-&gt;node
op_eq
id|n
)paren
(brace
r_if
c_cond
(paren
id|i
)paren
id|i
op_decrement
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|filldir
c_func
(paren
id|dirent
comma
id|d-&gt;name
comma
id|strlen
c_func
(paren
id|d-&gt;name
)paren
comma
id|filp-&gt;f_pos
comma
id|d-&gt;inode
)paren
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|filp-&gt;f_pos
op_increment
suffix:semicolon
)brace
)brace
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|openpromfs_create
r_static
r_int
id|openpromfs_create
(paren
r_struct
id|inode
op_star
id|dir
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
comma
r_int
id|mode
comma
r_struct
id|inode
op_star
op_star
id|result
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
op_star
id|result
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dir
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|256
)paren
(brace
id|iput
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|aliases_nodes
op_eq
id|ALIASES_NNODES
)paren
(brace
id|iput
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|p
op_assign
id|kmalloc
(paren
id|len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
(brace
id|iput
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|strncpy
(paren
id|p
comma
id|name
comma
id|len
)paren
suffix:semicolon
id|p
(braket
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|alias_names
(braket
id|aliases_nodes
op_increment
)braket
op_assign
id|p
suffix:semicolon
id|inode
op_assign
id|proc_get_inode
(paren
id|dir-&gt;i_sb
comma
id|NODEP2INO
c_func
(paren
id|NODE
c_func
(paren
id|dir-&gt;i_ino
)paren
dot
id|first_prop
)paren
op_plus
id|aliases_nodes
comma
l_int|0
)paren
suffix:semicolon
id|iput
(paren
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|inode-&gt;i_mode
op_assign
id|S_IFREG
op_or
id|S_IRUGO
op_or
id|S_IWUSR
suffix:semicolon
id|inode-&gt;i_op
op_assign
op_amp
id|openpromfs_prop_inode_ops
suffix:semicolon
id|inode-&gt;i_nlink
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|inode-&gt;i_size
OL
l_int|0
)paren
id|inode-&gt;i_size
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;u.generic_ip
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
(paren
id|u16
)paren
id|aliases
)paren
op_or
(paren
(paren
(paren
id|u16
)paren
(paren
id|aliases_nodes
op_minus
l_int|1
)paren
)paren
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
op_star
id|result
op_assign
id|inode
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|openpromfs_unlink
r_static
r_int
id|openpromfs_unlink
(paren
r_struct
id|inode
op_star
id|dir
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dir
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|aliases_nodes
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
id|strlen
(paren
id|alias_names
(braket
id|i
)braket
)paren
op_eq
id|len
)paren
op_logical_and
op_logical_neg
id|strncmp
(paren
id|name
comma
id|alias_names
(braket
id|i
)braket
comma
id|len
)paren
)paren
(brace
r_char
id|buffer
(braket
l_int|512
)braket
suffix:semicolon
id|p
op_assign
id|alias_names
(braket
id|i
)braket
suffix:semicolon
id|alias_names
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|kfree
(paren
id|p
)paren
suffix:semicolon
id|strcpy
(paren
id|buffer
comma
l_string|&quot;nvunalias &quot;
)paren
suffix:semicolon
id|memcpy
(paren
id|buffer
op_plus
l_int|10
comma
id|name
comma
id|len
)paren
suffix:semicolon
id|buffer
(braket
l_int|10
op_plus
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|prom_feval
(paren
id|buffer
)paren
suffix:semicolon
)brace
id|iput
(paren
id|dir
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* {{{ init section */
macro_line|#ifndef MODULE
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_int
id|check_space
(paren
id|u16
id|n
)paren
)paren
macro_line|#else
r_static
r_int
id|check_space
(paren
id|u16
id|n
)paren
macro_line|#endif
(brace
r_int
r_int
id|pages
suffix:semicolon
r_if
c_cond
(paren
(paren
l_int|1
op_lshift
id|alloced
)paren
op_star
id|PAGE_SIZE
OL
(paren
id|n
op_plus
l_int|2
)paren
op_star
r_sizeof
(paren
id|openpromfs_node
)paren
)paren
(brace
id|pages
op_assign
id|__get_free_pages
(paren
id|GFP_KERNEL
comma
id|alloced
op_plus
l_int|1
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pages
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|nodes
)paren
(brace
id|memcpy
(paren
(paren
r_char
op_star
)paren
id|pages
comma
(paren
r_char
op_star
)paren
id|nodes
comma
(paren
l_int|1
op_lshift
id|alloced
)paren
op_star
id|PAGE_SIZE
)paren
suffix:semicolon
id|free_pages
(paren
(paren
r_int
r_int
)paren
id|nodes
comma
id|alloced
)paren
suffix:semicolon
)brace
id|alloced
op_increment
suffix:semicolon
id|nodes
op_assign
(paren
id|openpromfs_node
op_star
)paren
id|pages
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifndef MODULE
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
id|u16
id|get_nodes
(paren
id|u16
id|parent
comma
id|u32
id|node
)paren
)paren
macro_line|#else
r_static
id|u16
id|get_nodes
(paren
id|u16
id|parent
comma
id|u32
id|node
)paren
macro_line|#endif
(brace
r_char
op_star
id|p
suffix:semicolon
id|u16
id|n
op_assign
id|last_node
op_increment
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
id|check_space
(paren
id|n
)paren
OL
l_int|0
)paren
r_return
l_int|0xffff
suffix:semicolon
id|nodes
(braket
id|n
)braket
dot
id|parent
op_assign
id|parent
suffix:semicolon
id|nodes
(braket
id|n
)braket
dot
id|node
op_assign
id|node
suffix:semicolon
id|nodes
(braket
id|n
)braket
dot
id|next
op_assign
l_int|0xffff
suffix:semicolon
id|nodes
(braket
id|n
)braket
dot
id|child
op_assign
l_int|0xffff
suffix:semicolon
id|nodes
(braket
id|n
)braket
dot
id|first_prop
op_assign
id|first_prop
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|parent
)paren
(brace
r_char
id|buffer
(braket
l_int|8
)braket
suffix:semicolon
r_int
id|j
suffix:semicolon
r_if
c_cond
(paren
(paren
id|j
op_assign
id|prom_getproperty
(paren
id|node
comma
l_string|&quot;name&quot;
comma
id|buffer
comma
l_int|8
)paren
)paren
op_ge
l_int|0
)paren
(brace
id|buffer
(braket
id|j
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
(paren
id|buffer
comma
l_string|&quot;options&quot;
)paren
)paren
id|options
op_assign
id|n
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
(paren
id|buffer
comma
l_string|&quot;aliases&quot;
)paren
)paren
id|aliases
op_assign
id|n
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|n
op_ne
id|aliases
)paren
r_for
c_loop
(paren
id|p
op_assign
id|prom_firstprop
(paren
id|node
)paren
suffix:semicolon
id|p
op_logical_and
id|p
op_ne
(paren
r_char
op_star
)paren
op_minus
l_int|1
op_logical_and
op_star
id|p
suffix:semicolon
id|p
op_assign
id|prom_nextprop
(paren
id|node
comma
id|p
)paren
)paren
id|first_prop
op_increment
suffix:semicolon
r_else
(brace
r_char
op_star
id|q
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|prom_firstprop
(paren
id|node
)paren
suffix:semicolon
id|p
op_logical_and
id|p
op_ne
(paren
r_char
op_star
)paren
op_minus
l_int|1
op_logical_and
op_star
id|p
suffix:semicolon
id|p
op_assign
id|prom_nextprop
(paren
id|node
comma
id|p
)paren
)paren
(brace
r_if
c_cond
(paren
id|aliases_nodes
op_eq
id|ALIASES_NNODES
)paren
r_break
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|aliases_nodes
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|strcmp
(paren
id|p
comma
id|alias_names
(braket
id|i
)braket
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
id|aliases_nodes
)paren
r_continue
suffix:semicolon
id|q
op_assign
id|kmalloc
(paren
id|strlen
(paren
id|p
)paren
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|q
)paren
r_return
l_int|0xffff
suffix:semicolon
id|strcpy
(paren
id|q
comma
id|p
)paren
suffix:semicolon
id|alias_names
(braket
id|aliases_nodes
op_increment
)braket
op_assign
id|q
suffix:semicolon
)brace
id|first_prop
op_add_assign
id|ALIASES_NNODES
suffix:semicolon
)brace
id|node
op_assign
id|prom_getchild
(paren
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|node
)paren
(brace
id|parent
op_assign
id|get_nodes
(paren
id|n
comma
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|parent
op_eq
l_int|0xffff
)paren
r_return
l_int|0xffff
suffix:semicolon
id|nodes
(braket
id|n
)braket
dot
id|child
op_assign
id|parent
suffix:semicolon
r_while
c_loop
(paren
(paren
id|node
op_assign
id|prom_getsibling
(paren
id|node
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|i
op_assign
id|get_nodes
(paren
id|n
comma
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|0xffff
)paren
r_return
l_int|0xffff
suffix:semicolon
id|nodes
(braket
id|parent
)braket
dot
id|next
op_assign
id|i
suffix:semicolon
id|parent
op_assign
id|i
suffix:semicolon
)brace
)brace
r_return
id|n
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|openpromfs_use
r_void
id|openpromfs_use
(paren
r_struct
id|inode
op_star
id|inode
comma
r_int
id|inc
)paren
(brace
r_static
r_int
id|root_fresh
op_assign
l_int|1
suffix:semicolon
r_static
r_int
id|dec_first
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef OPENPROM_DEBUGGING
r_static
r_int
id|usec
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|inc
)paren
(brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|inode-&gt;i_count
)paren
op_eq
l_int|1
)paren
id|usec
op_increment
suffix:semicolon
r_else
r_if
c_cond
(paren
id|root_fresh
op_logical_and
id|inode-&gt;i_ino
op_eq
id|PROC_OPENPROM_FIRST
)paren
(brace
id|root_fresh
op_assign
l_int|0
suffix:semicolon
id|usec
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|inode-&gt;i_ino
op_eq
id|PROC_OPENPROM_FIRST
)paren
id|root_fresh
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dec_first
)paren
id|usec
op_decrement
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot;openpromfs_use: %d %d %d %d&bslash;n&quot;
comma
id|inode-&gt;i_ino
comma
id|inc
comma
id|usec
comma
id|atomic_read
c_func
(paren
op_amp
id|inode-&gt;i_count
)paren
)paren
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|inc
)paren
(brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|inode-&gt;i_count
)paren
op_eq
l_int|1
)paren
id|MOD_INC_USE_COUNT
suffix:semicolon
r_else
r_if
c_cond
(paren
id|root_fresh
op_logical_and
id|inode-&gt;i_ino
op_eq
id|PROC_OPENPROM_FIRST
)paren
(brace
id|root_fresh
op_assign
l_int|0
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|inode-&gt;i_ino
op_eq
id|PROC_OPENPROM_FIRST
)paren
id|root_fresh
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dec_first
)paren
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
macro_line|#endif&t;
id|dec_first
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#else
DECL|macro|openpromfs_use
mdefine_line|#define openpromfs_use 0
macro_line|#endif
macro_line|#ifndef MODULE
DECL|macro|RET
mdefine_line|#define RET(x)
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|openpromfs_init
(paren
r_void
)paren
)paren
macro_line|#else
id|EXPORT_NO_SYMBOLS
suffix:semicolon
mdefine_line|#define RET(x) -x
r_int
id|init_module
(paren
r_void
)paren
macro_line|#endif
(brace
r_if
c_cond
(paren
op_logical_neg
id|romvec-&gt;pv_romvers
)paren
r_return
id|RET
c_func
(paren
id|ENODEV
)paren
suffix:semicolon
id|nodes
op_assign
(paren
id|openpromfs_node
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nodes
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;/proc/openprom: can&squot;t get free page&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RET
c_func
(paren
id|EIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|get_nodes
(paren
l_int|0xffff
comma
id|prom_root_node
)paren
op_eq
l_int|0xffff
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;/proc/openprom: couldn&squot;t setup tree&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RET
c_func
(paren
id|EIO
)paren
suffix:semicolon
)brace
id|nodes
(braket
id|last_node
)braket
dot
id|first_prop
op_assign
id|first_prop
suffix:semicolon
id|proc_openprom_iops
op_assign
id|proc_openprom_register
(paren
id|openpromfs_readdir
comma
id|openpromfs_lookup
comma
id|openpromfs_use
comma
op_amp
id|devices
)paren
suffix:semicolon
r_return
id|RET
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|proc_openprom_deregister
(paren
)paren
suffix:semicolon
id|free_pages
(paren
(paren
r_int
r_int
)paren
id|nodes
comma
id|alloced
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|aliases_nodes
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|alias_names
(braket
id|i
)braket
)paren
id|kfree
(paren
id|alias_names
(braket
id|i
)braket
)paren
suffix:semicolon
id|nodes
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#endif
eof
