multiline_comment|/*&n; *  linux/fs/fifo.c&n; *&n; *  written by Paul H. Hargrove&n; *&n; *  Fixes:&n; *&t;10-06-1999, AV: fixed OOM handling in fifo_open(), moved&n; *&t;&t;&t;initialization there, switched to external&n; *&t;&t;&t;allocation of pipe_inode_info.&n; */
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
DECL|function|wait_for_partner
r_static
r_void
id|wait_for_partner
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_int
r_int
op_star
id|cnt
)paren
(brace
r_int
id|cur
op_assign
op_star
id|cnt
suffix:semicolon
r_while
c_loop
(paren
id|cur
op_eq
op_star
id|cnt
)paren
(brace
id|pipe_wait
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
)brace
DECL|function|wake_up_partner
r_static
r_void
id|wake_up_partner
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
id|wake_up_interruptible
c_func
(paren
id|PIPE_WAIT
c_func
(paren
op_star
id|inode
)paren
)paren
suffix:semicolon
)brace
DECL|function|fifo_open
r_static
r_int
id|fifo_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_int
id|ret
suffix:semicolon
id|ret
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
id|PIPE_SEM
c_func
(paren
op_star
id|inode
)paren
)paren
)paren
r_goto
id|err_nolock_nocleanup
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode-&gt;i_pipe
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pipe_new
c_func
(paren
id|inode
)paren
)paren
(brace
r_goto
id|err_nocleanup
suffix:semicolon
)brace
)brace
id|filp-&gt;f_version
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|filp-&gt;f_mode
)paren
(brace
r_case
l_int|1
suffix:colon
multiline_comment|/*&n;&t; *  O_RDONLY&n;&t; *  POSIX.1 says that O_NONBLOCK means return with the FIFO&n;&t; *  opened, even when there is no process writing the FIFO.&n;&t; */
id|filp-&gt;f_op
op_assign
op_amp
id|read_fifo_fops
suffix:semicolon
id|PIPE_RCOUNTER
c_func
(paren
op_star
id|inode
)paren
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|PIPE_READERS
c_func
(paren
op_star
id|inode
)paren
op_increment
op_eq
l_int|0
)paren
id|wake_up_partner
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|PIPE_WRITERS
c_func
(paren
op_star
id|inode
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|filp-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
)paren
(brace
multiline_comment|/* suppress POLLHUP until we have&n;&t;&t;&t;&t; * seen a writer */
id|filp-&gt;f_version
op_assign
id|PIPE_WCOUNTER
c_func
(paren
op_star
id|inode
)paren
suffix:semicolon
)brace
r_else
(brace
id|wait_for_partner
c_func
(paren
id|inode
comma
op_amp
id|PIPE_WCOUNTER
c_func
(paren
op_star
id|inode
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_goto
id|err_rd
suffix:semicolon
)brace
)brace
)brace
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/*&n;&t; *  O_WRONLY&n;&t; *  POSIX.1 says that O_NONBLOCK means return -1 with&n;&t; *  errno=ENXIO when there is no process reading the FIFO.&n;&t; */
id|ret
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
(paren
id|filp-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
op_logical_and
op_logical_neg
id|PIPE_READERS
c_func
(paren
op_star
id|inode
)paren
)paren
r_goto
id|err
suffix:semicolon
id|filp-&gt;f_op
op_assign
op_amp
id|write_fifo_fops
suffix:semicolon
id|PIPE_WCOUNTER
c_func
(paren
op_star
id|inode
)paren
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|PIPE_WRITERS
c_func
(paren
op_star
id|inode
)paren
op_increment
)paren
id|wake_up_partner
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|PIPE_READERS
c_func
(paren
op_star
id|inode
)paren
)paren
(brace
id|wait_for_partner
c_func
(paren
id|inode
comma
op_amp
id|PIPE_RCOUNTER
c_func
(paren
op_star
id|inode
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_goto
id|err_wr
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/*&n;&t; *  O_RDWR&n;&t; *  POSIX.1 leaves this case &quot;undefined&quot; when O_NONBLOCK is set.&n;&t; *  This implementation will NEVER block on a O_RDWR open, since&n;&t; *  the process can at least talk to itself.&n;&t; */
id|filp-&gt;f_op
op_assign
op_amp
id|rdwr_fifo_fops
suffix:semicolon
id|PIPE_READERS
c_func
(paren
op_star
id|inode
)paren
op_increment
suffix:semicolon
id|PIPE_WRITERS
c_func
(paren
op_star
id|inode
)paren
op_increment
suffix:semicolon
id|PIPE_RCOUNTER
c_func
(paren
op_star
id|inode
)paren
op_increment
suffix:semicolon
id|PIPE_WCOUNTER
c_func
(paren
op_star
id|inode
)paren
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|PIPE_READERS
c_func
(paren
op_star
id|inode
)paren
op_eq
l_int|1
op_logical_or
id|PIPE_WRITERS
c_func
(paren
op_star
id|inode
)paren
op_eq
l_int|1
)paren
id|wake_up_partner
c_func
(paren
id|inode
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
multiline_comment|/* Ok! */
id|up
c_func
(paren
id|PIPE_SEM
c_func
(paren
op_star
id|inode
)paren
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_rd
suffix:colon
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|PIPE_READERS
c_func
(paren
op_star
id|inode
)paren
)paren
id|wake_up_interruptible
c_func
(paren
id|PIPE_WAIT
c_func
(paren
op_star
id|inode
)paren
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_goto
id|err
suffix:semicolon
id|err_wr
suffix:colon
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|PIPE_WRITERS
c_func
(paren
op_star
id|inode
)paren
)paren
id|wake_up_interruptible
c_func
(paren
id|PIPE_WAIT
c_func
(paren
op_star
id|inode
)paren
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_goto
id|err
suffix:semicolon
id|err
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|PIPE_READERS
c_func
(paren
op_star
id|inode
)paren
op_logical_and
op_logical_neg
id|PIPE_WRITERS
c_func
(paren
op_star
id|inode
)paren
)paren
(brace
r_struct
id|pipe_inode_info
op_star
id|info
op_assign
id|inode-&gt;i_pipe
suffix:semicolon
id|inode-&gt;i_pipe
op_assign
l_int|NULL
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|info-&gt;base
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
id|err_nocleanup
suffix:colon
id|up
c_func
(paren
id|PIPE_SEM
c_func
(paren
op_star
id|inode
)paren
)paren
suffix:semicolon
id|err_nolock_nocleanup
suffix:colon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Dummy default file-operations: the only thing this does&n; * is contain the open that then fills in the correct operations&n; * depending on the access mode of the file...&n; */
DECL|variable|def_fifo_fops
r_struct
id|file_operations
id|def_fifo_fops
op_assign
(brace
id|open
suffix:colon
id|fifo_open
comma
multiline_comment|/* will set read or write pipe_fops */
)brace
suffix:semicolon
eof
