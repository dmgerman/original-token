multiline_comment|/*&n; *  linux/fs/affs/namei.c&n; *&n; *  (c) 1996  Hans-Joachim Widmaier - Rewritten&n; *&n; *  (C) 1993  Ray Burr - Modified for Amiga FFS filesystem.&n; *&n; *  (C) 1991  Linus Torvalds - minix filesystem&n; */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/affs_fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/locks.h&gt;
macro_line|#include &lt;linux/amigaffs.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
multiline_comment|/* Simple toupper() for DOS&bslash;1 */
r_static
r_inline
r_int
r_int
DECL|function|affs_toupper
id|affs_toupper
c_func
(paren
r_int
r_int
id|ch
)paren
(brace
r_return
id|ch
op_ge
l_char|&squot;a&squot;
op_logical_and
id|ch
op_le
l_char|&squot;z&squot;
ques
c_cond
id|ch
op_sub_assign
(paren
l_char|&squot;a&squot;
op_minus
l_char|&squot;A&squot;
)paren
suffix:colon
id|ch
suffix:semicolon
)brace
multiline_comment|/* International toupper() for DOS&bslash;3 */
r_static
r_inline
r_int
r_int
DECL|function|affs_intl_toupper
id|affs_intl_toupper
c_func
(paren
r_int
r_int
id|ch
)paren
(brace
r_return
(paren
id|ch
op_ge
l_char|&squot;a&squot;
op_logical_and
id|ch
op_le
l_char|&squot;z&squot;
)paren
op_logical_or
(paren
id|ch
op_ge
l_int|0xE0
op_logical_and
id|ch
op_le
l_int|0xFE
op_logical_and
id|ch
op_ne
l_int|0xF7
)paren
ques
c_cond
id|ch
op_minus
(paren
l_char|&squot;a&squot;
op_minus
l_char|&squot;A&squot;
)paren
suffix:colon
id|ch
suffix:semicolon
)brace
multiline_comment|/*&n; * NOTE! unlike strncmp, affs_match returns 1 for success, 0 for failure.&n; */
r_static
r_int
DECL|function|affs_match
id|affs_match
c_func
(paren
r_const
r_char
op_star
id|name
comma
r_int
id|len
comma
r_const
r_char
op_star
id|compare
comma
r_int
id|dlen
comma
r_int
id|intl
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|compare
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|30
)paren
id|len
op_assign
l_int|30
suffix:semicolon
r_if
c_cond
(paren
id|dlen
OG
l_int|30
)paren
id|dlen
op_assign
l_int|30
suffix:semicolon
multiline_comment|/* &quot;&quot; means &quot;.&quot; ---&gt; so paths like &quot;/usr/lib//libc.a&quot; work */
r_if
c_cond
(paren
op_logical_neg
id|len
op_logical_and
id|dlen
op_eq
l_int|1
op_logical_and
id|compare
(braket
l_int|0
)braket
op_eq
l_char|&squot;.&squot;
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|dlen
op_ne
id|len
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|intl
)paren
(brace
r_while
c_loop
(paren
id|dlen
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|affs_intl_toupper
c_func
(paren
op_star
id|name
op_amp
l_int|0xFF
)paren
op_ne
id|affs_intl_toupper
c_func
(paren
op_star
id|compare
op_amp
l_int|0xFF
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|name
op_increment
suffix:semicolon
id|compare
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
r_while
c_loop
(paren
id|dlen
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|affs_toupper
c_func
(paren
op_star
id|name
op_amp
l_int|0xFF
)paren
op_ne
id|affs_toupper
c_func
(paren
op_star
id|compare
op_amp
l_int|0xFF
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|name
op_increment
suffix:semicolon
id|compare
op_increment
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
r_int
DECL|function|affs_hash_name
id|affs_hash_name
c_func
(paren
r_const
r_char
op_star
id|name
comma
r_int
id|len
comma
r_int
id|intl
comma
r_int
id|hashsize
)paren
(brace
r_int
r_int
id|i
comma
id|x
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|30
)paren
id|len
op_assign
l_int|30
suffix:semicolon
id|x
op_assign
id|len
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|intl
)paren
id|x
op_assign
(paren
id|x
op_star
l_int|13
op_plus
id|affs_intl_toupper
c_func
(paren
id|name
(braket
id|i
)braket
op_amp
l_int|0xFF
)paren
)paren
op_amp
l_int|0x7ff
suffix:semicolon
r_else
id|x
op_assign
(paren
id|x
op_star
l_int|13
op_plus
id|affs_toupper
c_func
(paren
id|name
(braket
id|i
)braket
op_amp
l_int|0xFF
)paren
)paren
op_amp
l_int|0x7ff
suffix:semicolon
r_return
id|x
op_mod
id|hashsize
suffix:semicolon
)brace
r_static
r_struct
id|buffer_head
op_star
DECL|function|affs_find_entry
id|affs_find_entry
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_const
r_char
op_star
id|name
comma
r_int
id|namelen
comma
r_int
r_int
op_star
id|ino
)paren
(brace
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_int
id|intl
suffix:semicolon
r_int
id|key
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;AFFS: find_entry(%.*s)=&bslash;n&quot;
comma
id|namelen
comma
id|name
)paren
suffix:semicolon
id|intl
op_assign
id|AFFS_I2FSTYPE
c_func
(paren
id|dir
)paren
suffix:semicolon
id|bh
op_assign
id|affs_bread
c_func
(paren
id|dir-&gt;i_dev
comma
id|dir-&gt;i_ino
comma
id|AFFS_I2BSIZE
c_func
(paren
id|dir
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bh
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|affs_match
c_func
(paren
id|name
comma
id|namelen
comma
l_string|&quot;.&quot;
comma
l_int|1
comma
id|intl
)paren
)paren
(brace
op_star
id|ino
op_assign
id|dir-&gt;i_ino
suffix:semicolon
r_return
id|bh
suffix:semicolon
)brace
r_if
c_cond
(paren
id|affs_match
c_func
(paren
id|name
comma
id|namelen
comma
l_string|&quot;..&quot;
comma
l_int|2
comma
id|intl
)paren
)paren
(brace
op_star
id|ino
op_assign
id|affs_parent_ino
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
id|bh
suffix:semicolon
)brace
id|key
op_assign
id|AFFS_GET_HASHENTRY
c_func
(paren
id|bh-&gt;b_data
comma
id|affs_hash_name
c_func
(paren
id|name
comma
id|namelen
comma
id|intl
comma
id|AFFS_I2HSIZE
c_func
(paren
id|dir
)paren
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_char
op_star
id|cname
suffix:semicolon
r_int
id|cnamelen
suffix:semicolon
id|affs_brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|key
op_eq
l_int|0
)paren
(brace
id|bh
op_assign
l_int|NULL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|bh
op_assign
id|affs_bread
c_func
(paren
id|dir-&gt;i_dev
comma
id|key
comma
id|AFFS_I2BSIZE
c_func
(paren
id|dir
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bh
)paren
r_break
suffix:semicolon
id|cnamelen
op_assign
id|affs_get_file_name
c_func
(paren
id|AFFS_I2BSIZE
c_func
(paren
id|dir
)paren
comma
id|bh-&gt;b_data
comma
op_amp
id|cname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|affs_match
c_func
(paren
id|name
comma
id|namelen
comma
id|cname
comma
id|cnamelen
comma
id|intl
)paren
)paren
r_break
suffix:semicolon
id|key
op_assign
id|htonl
c_func
(paren
id|FILE_END
c_func
(paren
id|bh-&gt;b_data
comma
id|dir
)paren
op_member_access_from_pointer
id|hash_chain
)paren
suffix:semicolon
)brace
op_star
id|ino
op_assign
id|key
suffix:semicolon
r_return
id|bh
suffix:semicolon
)brace
r_int
DECL|function|affs_lookup
id|affs_lookup
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
comma
r_struct
id|inode
op_star
op_star
id|result
)paren
(brace
r_int
id|res
suffix:semicolon
r_int
r_int
id|ino
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;AFFS: lookup(%.*s)&bslash;n&quot;
comma
id|len
comma
id|name
)paren
suffix:semicolon
op_star
id|result
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dir
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
id|res
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|dir-&gt;i_mode
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|bh
op_assign
id|affs_find_entry
c_func
(paren
id|dir
comma
id|name
comma
id|len
comma
op_amp
id|ino
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|FILE_END
c_func
(paren
id|bh-&gt;b_data
comma
id|dir
)paren
op_member_access_from_pointer
id|original
)paren
id|ino
op_assign
id|htonl
c_func
(paren
id|FILE_END
c_func
(paren
id|bh-&gt;b_data
comma
id|dir
)paren
op_member_access_from_pointer
id|original
)paren
suffix:semicolon
id|affs_brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|result
op_assign
id|iget
c_func
(paren
id|dir-&gt;i_sb
comma
id|ino
)paren
)paren
)paren
id|res
op_assign
l_int|0
suffix:semicolon
r_else
id|res
op_assign
op_minus
id|EACCES
suffix:semicolon
)brace
)brace
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_int
DECL|function|affs_unlink
id|affs_unlink
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
)paren
(brace
r_int
id|retval
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_int
r_int
id|ino
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;AFFS: unlink(dir=%ld,&bslash;&quot;%.*s&bslash;&quot;)&bslash;n&quot;
comma
id|dir-&gt;i_ino
comma
id|len
comma
id|name
)paren
suffix:semicolon
id|bh
op_assign
l_int|NULL
suffix:semicolon
id|inode
op_assign
l_int|NULL
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bh
op_assign
id|affs_find_entry
c_func
(paren
id|dir
comma
id|name
comma
id|len
comma
op_amp
id|ino
)paren
)paren
)paren
(brace
r_goto
id|unlink_done
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|inode
op_assign
id|iget
c_func
(paren
id|dir-&gt;i_sb
comma
id|ino
)paren
)paren
)paren
(brace
r_goto
id|unlink_done
suffix:semicolon
)brace
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EPERM
suffix:semicolon
r_goto
id|unlink_done
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|affs_fix_hash_pred
c_func
(paren
id|dir
comma
id|affs_hash_name
c_func
(paren
id|name
comma
id|len
comma
id|AFFS_I2FSTYPE
c_func
(paren
id|dir
)paren
comma
id|AFFS_I2HSIZE
c_func
(paren
id|dir
)paren
)paren
op_plus
l_int|6
comma
id|ino
comma
id|FILE_END
c_func
(paren
id|bh-&gt;b_data
comma
id|dir
)paren
op_member_access_from_pointer
id|hash_chain
)paren
)paren
)paren
r_goto
id|unlink_done
suffix:semicolon
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|affs_fixup
c_func
(paren
id|bh
comma
id|inode
)paren
)paren
)paren
r_goto
id|unlink_done
suffix:semicolon
id|inode-&gt;i_nlink
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;i_dirt
op_assign
l_int|1
suffix:semicolon
id|inode-&gt;i_ctime
op_assign
id|dir-&gt;i_ctime
op_assign
id|dir-&gt;i_mtime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|dir-&gt;i_version
op_assign
op_increment
id|event
suffix:semicolon
id|dir-&gt;i_dirt
op_assign
l_int|1
suffix:semicolon
id|unlink_done
suffix:colon
id|affs_brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_int
DECL|function|affs_create
id|affs_create
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
comma
r_int
id|mode
comma
r_struct
id|inode
op_star
op_star
id|result
)paren
(brace
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_int
id|error
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;AFFS: create(%lu,&bslash;&quot;%.*s&bslash;&quot;,0%o)&bslash;n&quot;
comma
id|dir-&gt;i_ino
comma
id|len
comma
id|name
comma
id|mode
)paren
suffix:semicolon
op_star
id|result
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dir
op_logical_or
op_logical_neg
id|dir-&gt;i_sb
)paren
(brace
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|inode
op_assign
id|affs_new_inode
c_func
(paren
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
(brace
id|iput
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
id|inode-&gt;i_mode
op_assign
id|mode
suffix:semicolon
r_if
c_cond
(paren
id|dir-&gt;i_sb-&gt;u.affs_sb.s_flags
op_amp
id|SF_OFS
)paren
id|inode-&gt;i_op
op_assign
op_amp
id|affs_file_inode_operations_ofs
suffix:semicolon
r_else
id|inode-&gt;i_op
op_assign
op_amp
id|affs_file_inode_operations
suffix:semicolon
id|error
op_assign
id|affs_add_entry
c_func
(paren
id|dir
comma
l_int|NULL
comma
id|inode
comma
id|name
comma
id|len
comma
id|ST_FILE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
id|inode-&gt;i_nlink
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;i_dirt
op_assign
l_int|1
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
id|inode-&gt;u.affs_i.i_protect
op_assign
id|mode_to_prot
c_func
(paren
id|inode-&gt;i_mode
)paren
suffix:semicolon
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
op_star
id|result
op_assign
id|inode
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|affs_mkdir
id|affs_mkdir
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
comma
r_int
id|mode
)paren
(brace
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
r_int
id|error
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;AFFS: mkdir(%lu,&bslash;&quot;%.*s&bslash;&quot;,0%o)&bslash;n&quot;
comma
id|dir-&gt;i_ino
comma
id|len
comma
id|name
comma
id|mode
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dir
op_logical_or
op_logical_neg
id|dir-&gt;i_sb
)paren
(brace
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|bh
op_assign
id|affs_find_entry
c_func
(paren
id|dir
comma
id|name
comma
id|len
comma
op_amp
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bh
)paren
(brace
id|affs_brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|EEXIST
suffix:semicolon
)brace
id|inode
op_assign
id|affs_new_inode
c_func
(paren
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
(brace
id|iput
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
id|inode-&gt;i_op
op_assign
op_amp
id|affs_dir_inode_operations
suffix:semicolon
id|error
op_assign
id|affs_add_entry
c_func
(paren
id|dir
comma
l_int|NULL
comma
id|inode
comma
id|name
comma
id|len
comma
id|ST_USERDIR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
id|inode-&gt;i_nlink
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;i_dirt
op_assign
l_int|1
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|inode-&gt;i_mode
op_assign
id|S_IFDIR
op_or
(paren
id|mode
op_amp
l_int|0777
op_amp
op_complement
id|current-&gt;fs-&gt;umask
)paren
suffix:semicolon
id|inode-&gt;u.affs_i.i_protect
op_assign
id|mode_to_prot
c_func
(paren
id|inode-&gt;i_mode
)paren
suffix:semicolon
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|empty_dir
id|empty_dir
c_func
(paren
r_struct
id|buffer_head
op_star
id|bh
comma
r_int
id|hashsize
)paren
(brace
r_while
c_loop
(paren
op_decrement
id|hashsize
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
r_struct
id|dir_front
op_star
)paren
id|bh-&gt;b_data
)paren
op_member_access_from_pointer
id|hashtable
(braket
id|hashsize
)braket
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
r_int
DECL|function|affs_rmdir
id|affs_rmdir
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
)paren
(brace
r_int
id|retval
suffix:semicolon
r_int
r_int
id|ino
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;AFFS: rmdir(dir=%lu,&bslash;&quot;%.*s&bslash;&quot;)&bslash;n&quot;
comma
id|dir-&gt;i_ino
comma
id|len
comma
id|name
)paren
suffix:semicolon
id|inode
op_assign
l_int|NULL
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bh
op_assign
id|affs_find_entry
c_func
(paren
id|dir
comma
id|name
comma
id|len
comma
op_amp
id|ino
)paren
)paren
)paren
(brace
r_goto
id|rmdir_done
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|inode
op_assign
id|iget
c_func
(paren
id|dir-&gt;i_sb
comma
id|ino
)paren
)paren
)paren
(brace
r_goto
id|rmdir_done
suffix:semicolon
)brace
id|retval
op_assign
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fsuser
c_func
(paren
)paren
op_logical_and
id|current-&gt;fsuid
op_ne
id|inode-&gt;i_uid
op_logical_and
id|current-&gt;fsuid
op_ne
id|dir-&gt;i_uid
)paren
r_goto
id|rmdir_done
suffix:semicolon
r_if
c_cond
(paren
id|inode-&gt;i_dev
op_ne
id|dir-&gt;i_dev
)paren
r_goto
id|rmdir_done
suffix:semicolon
r_if
c_cond
(paren
id|inode
op_eq
id|dir
)paren
multiline_comment|/* we may not delete &quot;.&quot;, but &quot;../dir&quot; is ok */
r_goto
id|rmdir_done
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|S_ISDIR
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|ENOTDIR
suffix:semicolon
r_goto
id|rmdir_done
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|empty_dir
c_func
(paren
id|bh
comma
id|AFFS_I2HSIZE
c_func
(paren
id|inode
)paren
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|ENOTEMPTY
suffix:semicolon
r_goto
id|rmdir_done
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inode-&gt;i_count
OG
l_int|1
)paren
(brace
id|retval
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|rmdir_done
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|affs_fix_hash_pred
c_func
(paren
id|dir
comma
id|affs_hash_name
c_func
(paren
id|name
comma
id|len
comma
id|AFFS_I2FSTYPE
c_func
(paren
id|dir
)paren
comma
id|AFFS_I2HSIZE
c_func
(paren
id|dir
)paren
)paren
op_plus
l_int|6
comma
id|ino
comma
id|FILE_END
c_func
(paren
id|bh-&gt;b_data
comma
id|dir
)paren
op_member_access_from_pointer
id|hash_chain
)paren
)paren
)paren
r_goto
id|rmdir_done
suffix:semicolon
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|affs_fixup
c_func
(paren
id|bh
comma
id|inode
)paren
)paren
)paren
r_goto
id|rmdir_done
suffix:semicolon
id|inode-&gt;i_nlink
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;i_dirt
op_assign
l_int|1
suffix:semicolon
id|inode-&gt;i_ctime
op_assign
id|dir-&gt;i_ctime
op_assign
id|dir-&gt;i_mtime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|dir-&gt;i_version
op_assign
op_increment
id|event
suffix:semicolon
id|dir-&gt;i_dirt
op_assign
l_int|1
suffix:semicolon
id|rmdir_done
suffix:colon
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
id|affs_brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_int
DECL|function|affs_symlink
id|affs_symlink
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
comma
r_const
r_char
op_star
id|symname
)paren
(brace
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_int
r_int
id|tmp
suffix:semicolon
r_int
id|i
comma
id|maxlen
suffix:semicolon
r_char
id|c
comma
id|lc
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;AFFS: symlink(%lu,&bslash;&quot;%.*s&bslash;&quot; -&gt; &bslash;&quot;%s&bslash;&quot;)&bslash;n&quot;
comma
id|dir-&gt;i_ino
comma
id|len
comma
id|name
comma
id|symname
)paren
suffix:semicolon
id|maxlen
op_assign
l_int|4
op_star
id|AFFS_I2HSIZE
c_func
(paren
id|dir
)paren
op_minus
l_int|1
suffix:semicolon
id|inode
op_assign
id|affs_new_inode
c_func
(paren
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
(brace
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
id|inode-&gt;i_op
op_assign
op_amp
id|affs_symlink_inode_operations
suffix:semicolon
id|inode-&gt;i_mode
op_assign
id|S_IFLNK
op_or
l_int|0777
suffix:semicolon
id|inode-&gt;u.affs_i.i_protect
op_assign
id|mode_to_prot
c_func
(paren
id|inode-&gt;i_mode
)paren
suffix:semicolon
id|bh
op_assign
id|affs_bread
c_func
(paren
id|inode-&gt;i_dev
comma
id|inode-&gt;i_ino
comma
id|AFFS_I2BSIZE
c_func
(paren
id|inode
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bh
)paren
(brace
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
id|inode-&gt;i_nlink
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;i_dirt
op_assign
l_int|1
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|i
op_assign
l_int|0
suffix:semicolon
id|p
op_assign
(paren
(paren
r_struct
id|slink_front
op_star
)paren
id|bh-&gt;b_data
)paren
op_member_access_from_pointer
id|symname
suffix:semicolon
id|lc
op_assign
l_char|&squot;/&squot;
suffix:semicolon
r_if
c_cond
(paren
op_star
id|symname
op_eq
l_char|&squot;/&squot;
)paren
(brace
r_while
c_loop
(paren
op_star
id|symname
op_eq
l_char|&squot;/&squot;
)paren
id|symname
op_increment
suffix:semicolon
r_while
c_loop
(paren
id|inode-&gt;i_sb-&gt;u.affs_sb.s_volume
(braket
id|i
)braket
)paren
multiline_comment|/* Cannot overflow */
op_star
id|p
op_increment
op_assign
id|inode-&gt;i_sb-&gt;u.affs_sb.s_volume
(braket
id|i
op_increment
)braket
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
OL
id|maxlen
op_logical_and
(paren
id|c
op_assign
op_star
id|symname
op_increment
)paren
)paren
(brace
r_if
c_cond
(paren
id|c
op_eq
l_char|&squot;.&squot;
op_logical_and
id|lc
op_eq
l_char|&squot;/&squot;
op_logical_and
op_star
id|symname
op_eq
l_char|&squot;.&squot;
op_logical_and
id|symname
(braket
l_int|1
)braket
op_eq
l_char|&squot;/&squot;
)paren
(brace
op_star
id|p
op_increment
op_assign
l_char|&squot;/&squot;
suffix:semicolon
id|i
op_increment
suffix:semicolon
id|symname
op_add_assign
l_int|2
suffix:semicolon
id|lc
op_assign
l_char|&squot;/&squot;
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|c
op_eq
l_char|&squot;.&squot;
op_logical_and
id|lc
op_eq
l_char|&squot;/&squot;
op_logical_and
op_star
id|symname
op_eq
l_char|&squot;/&squot;
)paren
(brace
id|symname
op_increment
suffix:semicolon
id|lc
op_assign
l_char|&squot;/&squot;
suffix:semicolon
)brace
r_else
(brace
op_star
id|p
op_increment
op_assign
id|c
suffix:semicolon
id|lc
op_assign
id|c
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lc
op_eq
l_char|&squot;/&squot;
)paren
r_while
c_loop
(paren
op_star
id|symname
op_eq
l_char|&squot;/&squot;
)paren
id|symname
op_increment
suffix:semicolon
)brace
op_star
id|p
op_assign
l_int|0
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|bh
comma
l_int|1
)paren
suffix:semicolon
id|affs_brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
id|inode-&gt;i_dirt
op_assign
l_int|1
suffix:semicolon
id|bh
op_assign
id|affs_find_entry
c_func
(paren
id|dir
comma
id|name
comma
id|len
comma
op_amp
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bh
)paren
(brace
id|inode-&gt;i_nlink
op_assign
l_int|0
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
id|affs_brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|EEXIST
suffix:semicolon
)brace
id|i
op_assign
id|affs_add_entry
c_func
(paren
id|dir
comma
l_int|NULL
comma
id|inode
comma
id|name
comma
id|len
comma
id|ST_SOFTLINK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
(brace
id|inode-&gt;i_nlink
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;i_dirt
op_assign
l_int|1
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
id|affs_brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|affs_link
id|affs_link
c_func
(paren
r_struct
id|inode
op_star
id|oldinode
comma
r_struct
id|inode
op_star
id|dir
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
)paren
(brace
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
r_int
id|error
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;AFFS: link(%lu,%lu,&bslash;&quot;%.*s&bslash;&quot;)&bslash;n&quot;
comma
id|oldinode-&gt;i_ino
comma
id|dir-&gt;i_ino
comma
id|len
comma
id|name
)paren
suffix:semicolon
id|bh
op_assign
id|affs_find_entry
c_func
(paren
id|dir
comma
id|name
comma
id|len
comma
op_amp
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bh
)paren
(brace
id|affs_brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
id|iput
c_func
(paren
id|oldinode
)paren
suffix:semicolon
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|EEXIST
suffix:semicolon
)brace
r_if
c_cond
(paren
id|oldinode-&gt;u.affs_i.i_hlink
)paren
(brace
id|i
op_assign
id|oldinode-&gt;u.affs_i.i_original
suffix:semicolon
id|iput
c_func
(paren
id|oldinode
)paren
suffix:semicolon
id|oldinode
op_assign
id|iget
c_func
(paren
id|dir-&gt;i_sb
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|oldinode
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;AFFS: link(): original does not exist.&bslash;n&quot;
)paren
suffix:semicolon
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
)brace
id|inode
op_assign
id|affs_new_inode
c_func
(paren
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
(brace
id|iput
c_func
(paren
id|oldinode
)paren
suffix:semicolon
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
id|inode-&gt;i_op
op_assign
id|oldinode-&gt;i_op
suffix:semicolon
id|inode-&gt;i_mode
op_assign
id|oldinode-&gt;i_mode
suffix:semicolon
id|inode-&gt;i_uid
op_assign
id|oldinode-&gt;i_uid
suffix:semicolon
id|inode-&gt;i_gid
op_assign
id|oldinode-&gt;i_gid
suffix:semicolon
id|inode-&gt;u.affs_i.i_protect
op_assign
id|mode_to_prot
c_func
(paren
id|inode-&gt;i_mode
)paren
suffix:semicolon
id|inode-&gt;u.affs_i.i_original
op_assign
id|oldinode-&gt;i_ino
suffix:semicolon
id|inode-&gt;u.affs_i.i_hlink
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|oldinode-&gt;i_mode
)paren
)paren
id|error
op_assign
id|affs_add_entry
c_func
(paren
id|dir
comma
id|oldinode
comma
id|inode
comma
id|name
comma
id|len
comma
id|ST_LINKDIR
)paren
suffix:semicolon
r_else
id|error
op_assign
id|affs_add_entry
c_func
(paren
id|dir
comma
id|oldinode
comma
id|inode
comma
id|name
comma
id|len
comma
id|ST_LINKFILE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|inode-&gt;i_nlink
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;i_dirt
op_assign
l_int|1
suffix:semicolon
)brace
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
id|iput
c_func
(paren
id|oldinode
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_static
r_int
DECL|function|subdir
id|subdir
c_func
(paren
r_struct
id|inode
op_star
id|new_inode
comma
r_struct
id|inode
op_star
id|old_inode
)paren
(brace
r_int
id|ino
suffix:semicolon
r_int
id|result
suffix:semicolon
id|new_inode-&gt;i_count
op_increment
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|new_inode
op_eq
id|old_inode
)paren
(brace
id|result
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|new_inode-&gt;i_dev
op_ne
id|old_inode-&gt;i_dev
)paren
r_break
suffix:semicolon
id|ino
op_assign
id|new_inode-&gt;i_ino
suffix:semicolon
r_if
c_cond
(paren
id|affs_lookup
c_func
(paren
id|new_inode
comma
l_string|&quot;..&quot;
comma
l_int|2
comma
op_amp
id|new_inode
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|new_inode-&gt;i_ino
op_eq
id|ino
)paren
r_break
suffix:semicolon
)brace
id|iput
c_func
(paren
id|new_inode
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* I&squot;m afraid this might not be race proof. Maybe next time. */
r_int
DECL|function|affs_rename
id|affs_rename
c_func
(paren
r_struct
id|inode
op_star
id|old_dir
comma
r_const
r_char
op_star
id|old_name
comma
r_int
id|old_len
comma
r_struct
id|inode
op_star
id|new_dir
comma
r_const
r_char
op_star
id|new_name
comma
r_int
id|new_len
comma
r_int
id|must_be_dir
)paren
(brace
r_struct
id|inode
op_star
id|old_inode
suffix:semicolon
r_struct
id|inode
op_star
id|new_inode
suffix:semicolon
r_struct
id|buffer_head
op_star
id|old_bh
suffix:semicolon
r_struct
id|buffer_head
op_star
id|new_bh
suffix:semicolon
r_int
r_int
id|old_ino
suffix:semicolon
r_int
r_int
id|new_ino
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;AFFS: rename(old=%lu,&bslash;&quot;%*s&bslash;&quot; to new=%lu,&bslash;&quot;%*s&bslash;&quot;)&bslash;n&quot;
comma
id|old_dir-&gt;i_ino
comma
id|old_len
comma
id|old_name
comma
id|new_dir-&gt;i_ino
comma
id|new_len
comma
id|new_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_len
OG
l_int|30
)paren
id|new_len
op_assign
l_int|30
suffix:semicolon
r_goto
id|start_up
suffix:semicolon
id|retry
suffix:colon
id|affs_brelse
c_func
(paren
id|old_bh
)paren
suffix:semicolon
id|affs_brelse
c_func
(paren
id|new_bh
)paren
suffix:semicolon
id|iput
c_func
(paren
id|new_inode
)paren
suffix:semicolon
id|iput
c_func
(paren
id|old_inode
)paren
suffix:semicolon
id|current-&gt;counter
op_assign
l_int|0
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|start_up
suffix:colon
id|old_inode
op_assign
id|new_inode
op_assign
l_int|NULL
suffix:semicolon
id|old_bh
op_assign
id|new_bh
op_assign
l_int|NULL
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOENT
suffix:semicolon
id|old_bh
op_assign
id|affs_find_entry
c_func
(paren
id|old_dir
comma
id|old_name
comma
id|old_len
comma
op_amp
id|old_ino
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|old_bh
)paren
r_goto
id|end_rename
suffix:semicolon
id|old_inode
op_assign
id|__iget
c_func
(paren
id|old_dir-&gt;i_sb
comma
id|old_ino
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|old_inode
)paren
r_goto
id|end_rename
suffix:semicolon
r_if
c_cond
(paren
id|must_be_dir
op_logical_and
op_logical_neg
id|S_ISDIR
c_func
(paren
id|old_inode-&gt;i_mode
)paren
)paren
r_goto
id|end_rename
suffix:semicolon
id|new_bh
op_assign
id|affs_find_entry
c_func
(paren
id|new_dir
comma
id|new_name
comma
id|new_len
comma
op_amp
id|new_ino
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_bh
)paren
(brace
id|new_inode
op_assign
id|__iget
c_func
(paren
id|new_dir-&gt;i_sb
comma
id|new_ino
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_inode
)paren
(brace
multiline_comment|/* What does this mean? */
id|affs_brelse
c_func
(paren
id|new_bh
)paren
suffix:semicolon
id|new_bh
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|new_inode
op_eq
id|old_inode
)paren
(brace
multiline_comment|/* Won&squot;t happen */
id|retval
op_assign
l_int|0
suffix:semicolon
r_goto
id|end_rename
suffix:semicolon
)brace
r_if
c_cond
(paren
id|new_inode
op_logical_and
id|S_ISDIR
c_func
(paren
id|new_inode-&gt;i_mode
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EISDIR
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|S_ISDIR
c_func
(paren
id|old_inode-&gt;i_mode
)paren
)paren
r_goto
id|end_rename
suffix:semicolon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|subdir
c_func
(paren
id|new_dir
comma
id|old_inode
)paren
)paren
r_goto
id|end_rename
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOTEMPTY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|empty_dir
c_func
(paren
id|new_bh
comma
id|AFFS_I2HSIZE
c_func
(paren
id|new_inode
)paren
)paren
)paren
r_goto
id|end_rename
suffix:semicolon
id|retval
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|new_inode-&gt;i_count
OG
l_int|1
)paren
r_goto
id|end_rename
suffix:semicolon
)brace
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|old_inode-&gt;i_mode
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|ENOTDIR
suffix:semicolon
r_if
c_cond
(paren
id|new_inode
op_logical_and
op_logical_neg
id|S_ISDIR
c_func
(paren
id|new_inode-&gt;i_mode
)paren
)paren
r_goto
id|end_rename
suffix:semicolon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|subdir
c_func
(paren
id|new_dir
comma
id|old_inode
)paren
)paren
r_goto
id|end_rename
suffix:semicolon
r_if
c_cond
(paren
id|affs_parent_ino
c_func
(paren
id|old_inode
)paren
op_ne
id|old_dir-&gt;i_ino
)paren
r_goto
id|end_rename
suffix:semicolon
)brace
multiline_comment|/* Unlink destination if existent */
r_if
c_cond
(paren
id|new_inode
)paren
(brace
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|affs_fix_hash_pred
c_func
(paren
id|new_dir
comma
id|affs_hash_name
c_func
(paren
id|new_name
comma
id|new_len
comma
id|AFFS_I2FSTYPE
c_func
(paren
id|new_dir
)paren
comma
id|AFFS_I2HSIZE
c_func
(paren
id|new_dir
)paren
)paren
op_plus
l_int|6
comma
id|new_ino
comma
id|FILE_END
c_func
(paren
id|new_bh-&gt;b_data
comma
id|new_dir
)paren
op_member_access_from_pointer
id|hash_chain
)paren
)paren
)paren
r_goto
id|retry
suffix:semicolon
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|affs_fixup
c_func
(paren
id|new_bh
comma
id|new_inode
)paren
)paren
)paren
r_goto
id|retry
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|new_bh
comma
l_int|1
)paren
suffix:semicolon
id|new_dir-&gt;i_version
op_assign
op_increment
id|event
suffix:semicolon
id|new_dir-&gt;i_dirt
op_assign
l_int|1
suffix:semicolon
id|new_inode-&gt;i_nlink
op_assign
l_int|0
suffix:semicolon
id|new_inode-&gt;i_dirt
op_assign
l_int|1
suffix:semicolon
)brace
id|retval
op_assign
id|affs_fix_hash_pred
c_func
(paren
id|old_dir
comma
id|affs_hash_name
c_func
(paren
id|old_name
comma
id|old_len
comma
id|AFFS_I2FSTYPE
c_func
(paren
id|old_dir
)paren
comma
id|AFFS_I2HSIZE
c_func
(paren
id|old_dir
)paren
)paren
op_plus
l_int|6
comma
id|old_ino
comma
id|FILE_END
c_func
(paren
id|old_bh-&gt;b_data
comma
id|old_dir
)paren
op_member_access_from_pointer
id|hash_chain
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|retry
suffix:semicolon
id|retval
op_assign
id|affs_add_entry
c_func
(paren
id|new_dir
comma
l_int|NULL
comma
id|old_inode
comma
id|new_name
comma
id|new_len
comma
id|htonl
c_func
(paren
id|FILE_END
c_func
(paren
id|old_bh-&gt;b_data
comma
id|old_dir
)paren
op_member_access_from_pointer
id|secondary_type
)paren
)paren
suffix:semicolon
id|new_dir-&gt;i_ctime
op_assign
id|new_dir-&gt;i_mtime
op_assign
id|old_dir-&gt;i_ctime
op_assign
id|old_dir-&gt;i_mtime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|new_dir-&gt;i_version
op_assign
op_increment
id|event
suffix:semicolon
id|old_dir-&gt;i_version
op_assign
op_increment
id|event
suffix:semicolon
id|new_dir-&gt;i_dirt
op_assign
l_int|1
suffix:semicolon
id|old_dir-&gt;i_dirt
op_assign
l_int|1
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|old_bh
comma
l_int|1
)paren
suffix:semicolon
id|end_rename
suffix:colon
id|affs_brelse
c_func
(paren
id|old_bh
)paren
suffix:semicolon
id|affs_brelse
c_func
(paren
id|new_bh
)paren
suffix:semicolon
id|iput
c_func
(paren
id|new_inode
)paren
suffix:semicolon
id|iput
c_func
(paren
id|old_inode
)paren
suffix:semicolon
id|iput
c_func
(paren
id|old_dir
)paren
suffix:semicolon
id|iput
c_func
(paren
id|new_dir
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_int
DECL|function|affs_fixup
id|affs_fixup
c_func
(paren
r_struct
id|buffer_head
op_star
id|bh
comma
r_struct
id|inode
op_star
id|inode
)paren
(brace
r_int
id|key
comma
id|link_key
suffix:semicolon
r_int
id|type
suffix:semicolon
r_struct
id|buffer_head
op_star
id|nbh
suffix:semicolon
r_struct
id|inode
op_star
id|ofinode
suffix:semicolon
id|type
op_assign
id|htonl
c_func
(paren
id|FILE_END
c_func
(paren
id|bh-&gt;b_data
comma
id|inode
)paren
op_member_access_from_pointer
id|secondary_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|type
op_eq
id|ST_LINKFILE
op_logical_or
id|type
op_eq
id|ST_LINKDIR
)paren
(brace
id|key
op_assign
id|htonl
c_func
(paren
id|LINK_END
c_func
(paren
id|bh-&gt;b_data
comma
id|inode
)paren
op_member_access_from_pointer
id|original
)paren
suffix:semicolon
id|LINK_END
c_func
(paren
id|bh-&gt;b_data
comma
id|inode
)paren
op_member_access_from_pointer
id|original
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|key
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;AFFS: fixup(): hard link without original: ino=%lu&bslash;n&quot;
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|ofinode
op_assign
id|iget
c_func
(paren
id|inode-&gt;i_sb
comma
id|key
)paren
)paren
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
id|type
op_assign
id|affs_fix_link_pred
c_func
(paren
id|ofinode
comma
id|inode-&gt;i_ino
comma
id|FILE_END
c_func
(paren
id|bh-&gt;b_data
comma
id|inode
)paren
op_member_access_from_pointer
id|link_chain
)paren
suffix:semicolon
id|iput
c_func
(paren
id|ofinode
)paren
suffix:semicolon
r_return
id|type
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|type
op_eq
id|ST_FILE
op_logical_or
id|type
op_eq
id|ST_USERDIR
)paren
(brace
r_if
c_cond
(paren
(paren
id|key
op_assign
id|htonl
c_func
(paren
id|FILE_END
c_func
(paren
id|bh-&gt;b_data
comma
id|inode
)paren
op_member_access_from_pointer
id|link_chain
)paren
)paren
)paren
(brace
multiline_comment|/* Get first link, turn it to a file */
r_if
c_cond
(paren
op_logical_neg
(paren
id|ofinode
op_assign
id|iget
c_func
(paren
id|inode-&gt;i_sb
comma
id|key
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;AFFS: fixup(): cannot read inode %u&bslash;n&quot;
comma
id|key
)paren
suffix:semicolon
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ofinode-&gt;u.affs_i.i_hlink
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;AFFS: fixup(): first link to %lu (%u) is not a link?&bslash;n&quot;
comma
id|inode-&gt;i_ino
comma
id|key
)paren
suffix:semicolon
id|iput
c_func
(paren
id|ofinode
)paren
suffix:semicolon
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|nbh
op_assign
id|affs_bread
c_func
(paren
id|inode-&gt;i_dev
comma
id|key
comma
id|AFFS_I2BSIZE
c_func
(paren
id|inode
)paren
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;AFFS: fixup(): cannot read block %u&bslash;n&quot;
comma
id|key
)paren
suffix:semicolon
id|iput
c_func
(paren
id|ofinode
)paren
suffix:semicolon
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
id|lock_super
c_func
(paren
id|inode-&gt;i_sb
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|nbh-&gt;b_data
op_plus
l_int|8
comma
id|bh-&gt;b_data
op_plus
l_int|8
comma
id|AFFS_I2BSIZE
c_func
(paren
id|inode
)paren
op_minus
l_int|208
)paren
suffix:semicolon
id|FILE_END
c_func
(paren
id|nbh-&gt;b_data
comma
id|inode
)paren
op_member_access_from_pointer
id|byte_size
op_assign
id|FILE_END
c_func
(paren
id|bh-&gt;b_data
comma
id|inode
)paren
op_member_access_from_pointer
id|byte_size
suffix:semicolon
id|FILE_END
c_func
(paren
id|nbh-&gt;b_data
comma
id|inode
)paren
op_member_access_from_pointer
id|extension
op_assign
id|FILE_END
c_func
(paren
id|bh-&gt;b_data
comma
id|inode
)paren
op_member_access_from_pointer
id|extension
suffix:semicolon
id|FILE_END
c_func
(paren
id|nbh-&gt;b_data
comma
id|inode
)paren
op_member_access_from_pointer
id|secondary_type
op_assign
id|FILE_END
c_func
(paren
id|bh-&gt;b_data
comma
id|inode
)paren
op_member_access_from_pointer
id|secondary_type
suffix:semicolon
id|FILE_END
c_func
(paren
id|nbh-&gt;b_data
comma
id|inode
)paren
op_member_access_from_pointer
id|original
op_assign
l_int|0
suffix:semicolon
id|ofinode-&gt;u.affs_i.i_original
op_assign
l_int|0
suffix:semicolon
id|ofinode-&gt;u.affs_i.i_hlink
op_assign
l_int|0
suffix:semicolon
id|ofinode-&gt;i_size
op_assign
id|inode-&gt;i_size
suffix:semicolon
id|ofinode-&gt;i_uid
op_assign
id|inode-&gt;i_uid
suffix:semicolon
id|ofinode-&gt;i_gid
op_assign
id|inode-&gt;i_gid
suffix:semicolon
id|ofinode-&gt;i_dirt
op_assign
l_int|1
suffix:semicolon
id|link_key
op_assign
id|ofinode-&gt;i_ino
suffix:semicolon
multiline_comment|/* Let all remaining links point to the new file */
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|affs_fix_checksum
c_func
(paren
id|AFFS_I2BSIZE
c_func
(paren
id|inode
)paren
comma
id|nbh-&gt;b_data
comma
l_int|5
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|nbh
comma
l_int|1
)paren
suffix:semicolon
id|key
op_assign
id|htonl
c_func
(paren
id|FILE_END
c_func
(paren
id|nbh-&gt;b_data
comma
id|inode
)paren
op_member_access_from_pointer
id|link_chain
)paren
suffix:semicolon
id|affs_brelse
c_func
(paren
id|nbh
)paren
suffix:semicolon
id|iput
c_func
(paren
id|ofinode
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|key
op_logical_or
op_logical_neg
(paren
id|nbh
op_assign
id|affs_bread
c_func
(paren
id|inode-&gt;i_dev
comma
id|key
comma
id|AFFS_I2BSIZE
c_func
(paren
id|inode
)paren
)paren
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ofinode
op_assign
id|iget
c_func
(paren
id|inode-&gt;i_sb
comma
id|key
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ofinode-&gt;u.affs_i.i_hlink
)paren
id|printk
c_func
(paren
l_string|&quot;AFFS: fixup() inode %u in link chain is &quot;
l_string|&quot;not a link&bslash;n&quot;
comma
id|key
)paren
suffix:semicolon
id|ofinode-&gt;u.affs_i.i_original
op_assign
id|link_key
suffix:semicolon
id|ofinode-&gt;i_dirt
op_assign
l_int|1
suffix:semicolon
id|FILE_END
c_func
(paren
id|nbh-&gt;b_data
comma
id|inode
)paren
op_member_access_from_pointer
id|original
op_assign
id|htonl
c_func
(paren
id|link_key
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;AFFS: fixup(): cannot get inode %u&bslash;n&quot;
comma
id|key
)paren
suffix:semicolon
)brace
multiline_comment|/* Turn old inode to a link */
id|inode-&gt;u.affs_i.i_hlink
op_assign
l_int|1
suffix:semicolon
id|unlock_super
c_func
(paren
id|inode-&gt;i_sb
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|type
op_eq
id|ST_SOFTLINK
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;AFFS: fixup(): secondary type=%d&bslash;n&quot;
comma
id|type
)paren
suffix:semicolon
r_return
op_minus
id|EBADF
suffix:semicolon
)brace
)brace
eof
