multiline_comment|/*&n; *  linux/fs/affs/inode.c&n; *&n; *  (C) 1994  Geert Uytterhoeven - Modified for MultiUserFileSystem&n; *&n; *  (C) 1993  Ray Burr - Modified for Amiga FFS filesystem.&n; *&n; *  (C) 1992  Eric Youngdale Modified for ISO9660 filesystem.&n; *&n; *  (C) 1991  Linus Torvalds - minix filesystem&n; */
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/affs_fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/locks.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/genhd.h&gt;
macro_line|#include &quot;amigaffs.h&quot;
r_extern
r_int
id|check_cdrom_media_change
c_func
(paren
r_int
comma
r_int
)paren
suffix:semicolon
macro_line|#ifdef LEAK_CHECK
DECL|variable|check_malloc
r_static
r_int
id|check_malloc
op_assign
l_int|0
suffix:semicolon
DECL|variable|check_bread
r_static
r_int
id|check_bread
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
DECL|function|affs_put_super
r_void
id|affs_put_super
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
id|lock_super
c_func
(paren
id|sb
)paren
suffix:semicolon
macro_line|#ifdef LEAK_CHECK
id|printk
c_func
(paren
l_string|&quot;Outstanding mallocs:%d, outstanding buffers: %d&bslash;n&quot;
comma
id|check_malloc
comma
id|check_bread
)paren
suffix:semicolon
macro_line|#endif
id|sb-&gt;s_dev
op_assign
l_int|0
suffix:semicolon
id|unlock_super
c_func
(paren
id|sb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|variable|affs_sops
r_static
r_struct
id|super_operations
id|affs_sops
op_assign
(brace
id|affs_read_inode
comma
l_int|NULL
comma
multiline_comment|/* notify_change */
l_int|NULL
comma
multiline_comment|/* write_inode */
l_int|NULL
comma
multiline_comment|/* put_inode */
id|affs_put_super
comma
l_int|NULL
comma
multiline_comment|/* write_super */
id|affs_statfs
comma
l_int|NULL
multiline_comment|/* remount */
)brace
suffix:semicolon
DECL|function|affs_parent_ino
r_int
id|affs_parent_ino
c_func
(paren
r_struct
id|inode
op_star
id|dir
)paren
(brace
r_int
id|root_ino
op_assign
(paren
id|dir-&gt;i_sb-&gt;u.affs_sb.s_root_block
op_minus
id|dir-&gt;i_sb-&gt;u.affs_sb.s_partition_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|S_ISDIR
(paren
id|dir-&gt;i_mode
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;affs_parent_ino: argument is not a directory&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|root_ino
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dir-&gt;i_ino
op_eq
id|root_ino
)paren
r_return
id|root_ino
suffix:semicolon
r_return
id|dir-&gt;u.affs_i.i_parent
suffix:semicolon
)brace
DECL|function|parse_options
r_static
r_int
id|parse_options
c_func
(paren
r_char
op_star
id|options
comma
r_struct
id|affs_options
op_star
id|optp
)paren
(brace
r_char
op_star
id|this_opt
comma
op_star
id|value
comma
op_star
id|end
suffix:semicolon
r_int
id|n
suffix:semicolon
id|optp-&gt;offset
op_assign
l_int|0
suffix:semicolon
id|optp-&gt;size
op_assign
l_int|0
suffix:semicolon
id|optp-&gt;root
op_assign
l_int|0
suffix:semicolon
id|optp-&gt;conv_links
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
)paren
r_return
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|this_opt
op_assign
id|strtok
c_func
(paren
id|options
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
id|this_opt
suffix:semicolon
id|this_opt
op_assign
id|strtok
c_func
(paren
l_int|NULL
comma
l_string|&quot;,&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|value
op_assign
id|strchr
c_func
(paren
id|this_opt
comma
l_char|&squot;=&squot;
)paren
)paren
)paren
op_star
id|value
op_increment
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_opt
comma
l_string|&quot;offset&quot;
)paren
op_logical_and
id|value
)paren
(brace
id|n
op_assign
id|simple_strtoul
(paren
id|value
comma
op_amp
id|end
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|end
op_eq
id|value
op_logical_or
op_star
id|end
op_ne
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|optp-&gt;offset
op_assign
id|n
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_opt
comma
l_string|&quot;size&quot;
)paren
op_logical_and
id|value
)paren
(brace
id|n
op_assign
id|simple_strtoul
(paren
id|value
comma
op_amp
id|end
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|end
op_eq
id|value
op_logical_or
op_star
id|end
op_ne
l_int|0
op_logical_or
id|n
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|optp-&gt;size
op_assign
id|n
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_opt
comma
l_string|&quot;root&quot;
)paren
op_logical_and
id|value
)paren
(brace
id|n
op_assign
id|simple_strtoul
(paren
id|value
comma
op_amp
id|end
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|end
op_eq
id|value
op_logical_or
op_star
id|end
op_ne
l_int|0
op_logical_or
id|n
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|optp-&gt;root
op_assign
id|n
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_opt
comma
l_string|&quot;conv_symlinks&quot;
)paren
)paren
(brace
id|optp-&gt;conv_links
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Is this The Right Way?  Should I be locking something? */
DECL|function|get_device_size
r_static
r_int
id|get_device_size
(paren
id|dev_t
id|dev
)paren
(brace
r_struct
id|gendisk
op_star
id|gd_p
suffix:semicolon
r_int
id|dev_size
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|gd_p
op_assign
id|gendisk_head
suffix:semicolon
id|gd_p
suffix:semicolon
id|gd_p
op_assign
id|gd_p-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|gd_p-&gt;major
op_ne
id|MAJOR
c_func
(paren
id|dev
)paren
)paren
r_continue
suffix:semicolon
id|dev_size
op_assign
id|gd_p-&gt;part
(braket
id|MINOR
c_func
(paren
id|dev
)paren
)braket
dot
id|nr_sects
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|dev_size
suffix:semicolon
)brace
DECL|function|affs_read_super
r_struct
id|super_block
op_star
id|affs_read_super
c_func
(paren
r_struct
id|super_block
op_star
id|s
comma
r_void
op_star
id|data
comma
r_int
id|silent
)paren
(brace
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_int
id|dev
op_assign
id|s-&gt;s_dev
suffix:semicolon
r_int
id|root_block
suffix:semicolon
r_int
id|ptype
comma
id|stype
suffix:semicolon
r_void
op_star
id|root_data
suffix:semicolon
r_struct
id|affs_options
op_star
id|optp
suffix:semicolon
id|optp
op_assign
op_amp
id|s-&gt;u.affs_sb.s_options
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|parse_options
c_func
(paren
(paren
r_char
op_star
)paren
id|data
comma
id|optp
)paren
)paren
(brace
id|s-&gt;s_dev
op_assign
l_int|0
suffix:semicolon
id|printk
(paren
l_string|&quot;AFFS: bad mount options&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|lock_super
c_func
(paren
id|s
)paren
suffix:semicolon
id|root_block
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|optp-&gt;size
)paren
(brace
id|s-&gt;u.affs_sb.s_partition_size
op_assign
id|optp-&gt;size
suffix:semicolon
)brace
r_else
(brace
r_int
id|size
op_assign
id|get_device_size
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
op_eq
l_int|0
)paren
(brace
id|s-&gt;s_dev
op_assign
l_int|0
suffix:semicolon
id|unlock_super
c_func
(paren
id|s
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;affs_read_super: could not&quot;
l_string|&quot;determine device size&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|s-&gt;u.affs_sb.s_partition_size
op_assign
id|size
suffix:semicolon
)brace
id|s-&gt;u.affs_sb.s_partition_offset
op_assign
id|optp-&gt;offset
suffix:semicolon
id|root_block
op_assign
id|optp-&gt;root
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|root_block
)paren
id|root_block
op_assign
(paren
id|s-&gt;u.affs_sb.s_partition_offset
op_plus
id|s-&gt;u.affs_sb.s_partition_size
op_div
l_int|2
op_plus
(paren
id|s-&gt;u.affs_sb.s_partition_size
op_amp
l_int|1
)paren
)paren
suffix:semicolon
id|s-&gt;u.affs_sb.s_root_block
op_assign
id|root_block
suffix:semicolon
id|s-&gt;u.affs_sb.s_block_size
op_assign
id|AFFS_BLOCK_SIZE
suffix:semicolon
macro_line|#if 0
id|printk
(paren
l_string|&quot;affs_read_super: dev=0x%04x offset=%d &quot;
l_string|&quot;size=%d root=%d blocksize=%d&bslash;n&quot;
comma
id|dev
comma
id|s-&gt;u.affs_sb.s_partition_offset
comma
id|s-&gt;u.affs_sb.s_partition_size
comma
id|s-&gt;u.affs_sb.s_root_block
comma
id|s-&gt;u.affs_sb.s_block_size
)paren
suffix:semicolon
macro_line|#endif
id|bh
op_assign
id|affs_sread
(paren
id|dev
comma
id|root_block
comma
op_amp
id|root_data
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bh
)paren
(brace
id|s-&gt;s_dev
op_assign
l_int|0
suffix:semicolon
id|unlock_super
c_func
(paren
id|s
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;AFFS: unable to read superblock&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|affs_checksum_block
(paren
id|AFFS_BLOCK_SIZE
comma
id|root_data
comma
op_amp
id|ptype
comma
op_amp
id|stype
)paren
op_logical_or
id|ptype
op_ne
id|T_SHORT
op_logical_or
id|stype
op_ne
id|ST_ROOT
)paren
(brace
id|printk
(paren
l_string|&quot;AFFS: invalid root block %d on device 0x%04x&bslash;n&quot;
comma
id|root_block
comma
id|dev
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
macro_line|#if 1
(brace
r_char
op_star
id|name
suffix:semicolon
r_int
id|len
suffix:semicolon
r_char
id|buf
(braket
l_int|33
)braket
suffix:semicolon
id|len
op_assign
id|affs_get_file_name
(paren
id|AFFS_BLOCK_SIZE
comma
id|root_data
comma
op_amp
id|name
)paren
suffix:semicolon
id|memcpy
(paren
id|buf
comma
id|name
comma
id|len
)paren
suffix:semicolon
id|buf
(braket
id|len
)braket
op_assign
l_int|0
suffix:semicolon
macro_line|#if 0
id|printk
(paren
l_string|&quot;affs_read_super: volume name &bslash;&quot;%s&bslash;&quot;&bslash;n&quot;
comma
id|buf
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#endif
id|s-&gt;s_magic
op_assign
id|AFFS_SUPER_MAGIC
suffix:semicolon
id|s-&gt;s_flags
op_assign
id|MS_RDONLY
op_or
id|MS_NODEV
op_or
id|MS_NOSUID
suffix:semicolon
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
multiline_comment|/* set up enough so that it can read an inode */
id|s-&gt;s_dev
op_assign
id|dev
suffix:semicolon
id|s-&gt;s_op
op_assign
op_amp
id|affs_sops
suffix:semicolon
id|s-&gt;s_blocksize
op_assign
id|AFFS_BUFFER_SIZE
suffix:semicolon
id|s-&gt;s_mounted
op_assign
id|iget
(paren
id|s
comma
id|root_block
op_minus
id|s-&gt;u.affs_sb.s_partition_offset
)paren
suffix:semicolon
id|unlock_super
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|s-&gt;s_mounted
)paren
)paren
(brace
id|s-&gt;s_dev
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;AFFS: get root inode failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
id|s
suffix:semicolon
id|out
suffix:colon
multiline_comment|/* Kick out for various error conditions */
id|brelse
(paren
id|bh
)paren
suffix:semicolon
id|s-&gt;s_dev
op_assign
l_int|0
suffix:semicolon
id|unlock_super
c_func
(paren
id|s
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|affs_statfs
r_void
id|affs_statfs
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|statfs
op_star
id|buf
comma
r_int
id|bufsiz
)paren
(brace
macro_line|#ifdef DEBUG
id|printk
(paren
l_string|&quot;AFFS: affs_statfs called&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|put_fs_long
c_func
(paren
id|AFFS_SUPER_MAGIC
comma
op_amp
id|buf-&gt;f_type
)paren
suffix:semicolon
id|put_fs_long
c_func
(paren
id|sb-&gt;u.affs_sb.s_block_size
comma
op_amp
id|buf-&gt;f_bsize
)paren
suffix:semicolon
id|put_fs_long
c_func
(paren
id|sb-&gt;u.affs_sb.s_partition_size
comma
op_amp
id|buf-&gt;f_blocks
)paren
suffix:semicolon
id|put_fs_long
c_func
(paren
l_int|0
comma
op_amp
id|buf-&gt;f_bfree
)paren
suffix:semicolon
id|put_fs_long
c_func
(paren
l_int|0
comma
op_amp
id|buf-&gt;f_bavail
)paren
suffix:semicolon
id|put_fs_long
c_func
(paren
l_int|0
comma
op_amp
id|buf-&gt;f_files
)paren
suffix:semicolon
id|put_fs_long
c_func
(paren
l_int|0
comma
op_amp
id|buf-&gt;f_ffree
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t know what value to put in buf-&gt;f_fsid */
)brace
DECL|variable|prot_table
r_static
r_int
id|prot_table
(braket
l_int|9
)braket
(braket
l_int|2
)braket
op_assign
(brace
(brace
id|PROT_OTR_EXECUTE
comma
id|PROT_OTR_EXECUTE
)brace
comma
multiline_comment|/* other: 1 = allowed */
(brace
id|PROT_OTR_WRITE
comma
id|PROT_OTR_WRITE
)brace
comma
(brace
id|PROT_OTR_READ
comma
id|PROT_OTR_READ
)brace
comma
(brace
id|PROT_GRP_EXECUTE
comma
id|PROT_GRP_EXECUTE
)brace
comma
multiline_comment|/* group: 1 = allowed */
(brace
id|PROT_GRP_WRITE
comma
id|PROT_GRP_WRITE
)brace
comma
(brace
id|PROT_GRP_READ
comma
id|PROT_GRP_READ
)brace
comma
(brace
id|PROT_EXECUTE
comma
l_int|0
)brace
comma
multiline_comment|/* owner: 0 = allowed */
(brace
id|PROT_WRITE
comma
l_int|0
)brace
comma
(brace
id|PROT_READ
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|function|affs_read_inode
r_void
id|affs_read_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_int
id|block
suffix:semicolon
r_void
op_star
id|fh_data
suffix:semicolon
r_struct
id|file_front
op_star
id|file_front
suffix:semicolon
r_struct
id|file_end
op_star
id|file_end
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|hardlink_end
op_star
id|link_end
suffix:semicolon
r_int
id|link
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
l_string|&quot;AFFS: entering affs_read_inode&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|inode-&gt;i_nlink
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* at least */
r_do
(brace
id|link
op_assign
l_int|0
suffix:semicolon
id|block
op_assign
id|inode-&gt;i_ino
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bh
op_assign
id|affs_pread
(paren
id|inode
comma
id|block
comma
op_amp
id|fh_data
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;AFFS: unable to read i-node block %d&bslash;n&quot;
comma
id|block
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|file_front
op_assign
(paren
r_struct
id|file_front
op_star
)paren
id|fh_data
suffix:semicolon
id|file_end
op_assign
id|GET_END_PTR
(paren
r_struct
id|file_end
comma
id|fh_data
comma
multiline_comment|/* coincidendly the same as  dir_end */
id|AFFS_I2BSIZE
(paren
id|inode
)paren
)paren
suffix:semicolon
multiline_comment|/* don&squot;t use bitmap data for mode, uid &amp; gid of the rootblock */
r_if
c_cond
(paren
id|block
op_eq
id|inode-&gt;i_sb-&gt;u.affs_sb.s_root_block
)paren
(brace
id|inode-&gt;u.affs_i.i_protect
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;u.affs_i.i_parent
op_assign
id|block
suffix:semicolon
id|inode-&gt;i_mode
op_assign
id|S_IRWXUGO
op_or
id|S_IFDIR
op_or
id|S_ISVTX
suffix:semicolon
multiline_comment|/* drwxrwxrwt */
id|inode-&gt;i_nlink
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* at least ..... */
id|inode-&gt;i_size
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* some differrent idea ? */
id|inode-&gt;i_uid
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;i_gid
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|inode-&gt;u.affs_i.i_protect
op_assign
id|file_end-&gt;protect
suffix:semicolon
id|inode-&gt;u.affs_i.i_parent
op_assign
id|swap_long
(paren
id|file_end-&gt;parent
)paren
suffix:semicolon
id|inode-&gt;i_mode
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|9
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
id|prot_table
(braket
id|i
)braket
(braket
l_int|0
)braket
op_amp
id|inode-&gt;u.affs_i.i_protect
)paren
op_eq
id|prot_table
(braket
id|i
)braket
(braket
l_int|1
)braket
)paren
id|inode-&gt;i_mode
op_or_assign
l_int|1
op_lshift
id|i
suffix:semicolon
r_switch
c_cond
(paren
id|swap_long
c_func
(paren
id|file_end-&gt;secondary_type
)paren
)paren
(brace
r_case
id|ST_USERDIR
suffix:colon
id|inode-&gt;i_mode
op_or_assign
(paren
(paren
id|inode-&gt;i_mode
op_amp
l_int|0444
)paren
op_rshift
l_int|2
)paren
op_or
id|S_IFDIR
suffix:semicolon
id|inode-&gt;i_nlink
op_increment
suffix:semicolon
multiline_comment|/* There are always at least 2.  It is&n;&t;&t;&t;&t;&t;&t;&t;       hard to figure out what is correct*/
id|inode-&gt;i_size
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ST_SOFTLINK
suffix:colon
id|inode-&gt;i_mode
op_or_assign
id|S_IFLNK
suffix:semicolon
id|inode-&gt;i_size
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ST_LINKFILE
suffix:colon
multiline_comment|/* doing things very easy (not really correct) */
r_case
id|ST_LINKDIR
suffix:colon
multiline_comment|/* code is _very_ inefficient (see below) */
multiline_comment|/* Where is struct link_end defined?&n;&t;&t;&t;&t;     ... I don&squot;t know what is going on&n;&t;&t;&t;&t;     here, someone else should&n;&t;&t;&t;&t;     probably spend some time on this */
id|link_end
op_assign
(paren
r_struct
id|hardlink_end
op_star
)paren
id|file_end
suffix:semicolon
id|inode-&gt;i_ino
op_assign
id|link_end-&gt;original
suffix:semicolon
id|inode-&gt;i_nlink
op_add_assign
l_int|2
suffix:semicolon
multiline_comment|/* It&squot;s hard to say whats correct */
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
id|link
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;affs: unknown secondary type %ld; assuming file&bslash;n&quot;
comma
id|file_end-&gt;secondary_type
)paren
suffix:semicolon
r_case
id|ST_FILE
suffix:colon
id|inode-&gt;i_mode
op_or_assign
id|S_IFREG
suffix:semicolon
id|inode-&gt;i_size
op_assign
id|swap_long
(paren
id|file_end-&gt;byte_size
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file_end-&gt;uid
op_eq
l_int|0xffff
)paren
id|inode-&gt;i_uid
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* root uid */
r_else
r_if
c_cond
(paren
id|file_end-&gt;uid
op_eq
l_int|0x0000
)paren
(brace
id|umode_t
id|mode
suffix:semicolon
id|inode-&gt;i_uid
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* unknown uid */
multiline_comment|/*&n;&t;&t;&t;&t; * change the mode of the inode to duplicate the&n;&t;&t;&t;&t; * perms of the user in the group and other fields;&n;&t;&t;&t;&t; * the assumption is that this isn&squot;t a MultiUser&n;&t;&t;&t;&t; * filesystem/file, so the permissions should be&n;&t;&t;&t;&t; * the same for all users&n;&t;&t;&t;&t; */
id|mode
op_assign
(paren
id|inode-&gt;i_mode
op_rshift
l_int|6
)paren
op_amp
l_int|7
suffix:semicolon
id|inode-&gt;i_mode
op_or_assign
(paren
id|mode
op_lshift
l_int|3
)paren
op_or
(paren
id|mode
)paren
suffix:semicolon
)brace
r_else
id|inode-&gt;i_uid
op_assign
id|file_end-&gt;uid
suffix:semicolon
r_if
c_cond
(paren
id|file_end-&gt;gid
op_eq
l_int|0xffff
)paren
id|inode-&gt;i_gid
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* root gid */
r_else
r_if
c_cond
(paren
id|file_end-&gt;gid
op_eq
l_int|0x0000
)paren
id|inode-&gt;i_gid
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* unknown gid */
r_else
id|inode-&gt;i_gid
op_assign
id|file_end-&gt;gid
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|link
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
l_string|&quot;AFFS: read inode %d: size=%d&bslash;n&quot;
comma
id|block
comma
id|inode-&gt;i_size
)paren
suffix:semicolon
macro_line|#endif
id|inode-&gt;i_mtime
op_assign
id|inode-&gt;i_atime
op_assign
id|inode-&gt;i_ctime
op_assign
(paren
id|swap_long
(paren
id|file_end-&gt;created.ds_Days
)paren
op_star
(paren
l_int|24
op_star
l_int|60
op_star
l_int|60
)paren
op_plus
id|swap_long
(paren
id|file_end-&gt;created.ds_Minute
)paren
op_star
l_int|60
op_plus
id|swap_long
(paren
id|file_end-&gt;created.ds_Tick
)paren
op_div
l_int|50
op_plus
(paren
(paren
l_int|8
op_star
l_int|365
op_plus
l_int|2
)paren
op_star
l_int|24
op_star
l_int|60
op_star
l_int|60
)paren
)paren
suffix:semicolon
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
id|inode-&gt;i_op
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|S_ISREG
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
id|inode-&gt;i_op
op_assign
op_amp
id|affs_file_inode_operations
suffix:semicolon
r_else
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
id|inode-&gt;i_op
op_assign
op_amp
id|affs_dir_inode_operations
suffix:semicolon
r_else
r_if
c_cond
(paren
id|S_ISLNK
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
id|inode-&gt;i_op
op_assign
op_amp
id|affs_symlink_inode_operations
suffix:semicolon
)brace
macro_line|#ifdef LEAK_CHECK
DECL|macro|malloc
macro_line|#undef malloc
DECL|macro|free_s
macro_line|#undef free_s
DECL|macro|bread
macro_line|#undef bread
DECL|macro|brelse
macro_line|#undef brelse
DECL|function|leak_check_malloc
r_void
op_star
(def_block
id|leak_check_malloc
c_func
(paren
r_int
r_int
id|size
)paren
(brace
r_void
op_star
id|tmp
suffix:semicolon
id|check_malloc
op_increment
suffix:semicolon
id|tmp
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_return
id|tmp
suffix:semicolon
)brace
)def_block
DECL|function|leak_check_free_s
r_void
(def_block
id|leak_check_free_s
c_func
(paren
r_void
op_star
id|obj
comma
r_int
id|size
)paren
(brace
id|check_malloc
op_decrement
suffix:semicolon
r_return
id|kfree_s
c_func
(paren
id|obj
comma
id|size
)paren
suffix:semicolon
)brace
)def_block
DECL|function|leak_check_bread
r_struct
id|buffer_head
op_star
(def_block
id|leak_check_bread
c_func
(paren
r_int
id|dev
comma
r_int
id|block
comma
r_int
id|size
)paren
(brace
id|check_bread
op_increment
suffix:semicolon
r_return
id|bread
c_func
(paren
id|dev
comma
id|block
comma
id|size
)paren
suffix:semicolon
)brace
)def_block
DECL|function|leak_check_brelse
r_void
(def_block
id|leak_check_brelse
c_func
(paren
r_struct
id|buffer_head
op_star
id|bh
)paren
(brace
id|check_bread
op_decrement
suffix:semicolon
r_return
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
)brace
)def_block
macro_line|#endif
eof
