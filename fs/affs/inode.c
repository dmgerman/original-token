multiline_comment|/*&n; *  linux/fs/affs/inode.c&n; *&n; *  (c) 1996  Hans-Joachim Widmaier - Rewritten&n; *&n; *  (C) 1993  Ray Burr - Modified for Amiga FFS filesystem.&n; *&n; *  (C) 1992  Eric Youngdale Modified for ISO9660 filesystem.&n; *&n; *  (C) 1991  Linus Torvalds - minix filesystem&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/affs_fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/locks.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/genhd.h&gt;
macro_line|#include &lt;linux/amigaffs.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
multiline_comment|/* AmigaOS allows file names with up to 30 characters length.&n; * Names longer than that will be silently truncated. If you&n; * want to disallow this, comment out the following #define.&n; * Creating filesystem objects with longer names will then&n; * result in an error (ENAMETOOLONG).&n; */
multiline_comment|/*#define NO_TRUNCATE */
r_extern
r_int
op_star
id|blk_size
(braket
)braket
suffix:semicolon
r_extern
r_struct
id|timezone
id|sys_tz
suffix:semicolon
DECL|macro|MIN
mdefine_line|#define MIN(a,b) (((a)&lt;(b))?(a):(b))
r_static
r_int
id|affs_notify_change
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|iattr
op_star
id|attr
)paren
suffix:semicolon
r_static
r_void
id|affs_put_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
suffix:semicolon
r_static
r_void
id|affs_read_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
suffix:semicolon
r_static
r_void
id|affs_statfs
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|statfs
op_star
id|buf
comma
r_int
id|bufsiz
)paren
suffix:semicolon
r_static
r_void
id|affs_write_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
suffix:semicolon
r_static
r_void
DECL|function|affs_put_super
id|affs_put_super
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_int
id|i
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;affs_put_super()&bslash;n&quot;
)paren
suffix:semicolon
id|lock_super
c_func
(paren
id|sb
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sb-&gt;u.affs_sb.s_bm_count
suffix:semicolon
id|i
op_increment
)paren
id|affs_brelse
c_func
(paren
id|sb-&gt;u.affs_sb.s_bitmap
(braket
id|i
)braket
dot
id|bm_bh
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
)paren
(brace
id|ROOT_END_S
c_func
(paren
id|sb-&gt;u.affs_sb.s_root_bh-&gt;b_data
comma
id|sb
)paren
op_member_access_from_pointer
id|bm_flag
op_assign
id|htonl
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|secs_to_datestamp
c_func
(paren
id|CURRENT_TIME
comma
op_amp
id|ROOT_END_S
c_func
(paren
id|sb-&gt;u.affs_sb.s_root_bh-&gt;b_data
comma
id|sb
)paren
op_member_access_from_pointer
id|disk_altered
)paren
suffix:semicolon
id|affs_fix_checksum
c_func
(paren
id|sb-&gt;s_blocksize
comma
id|sb-&gt;u.affs_sb.s_root_bh-&gt;b_data
comma
l_int|5
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|sb-&gt;u.affs_sb.s_root_bh
comma
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sb-&gt;u.affs_sb.s_flags
op_amp
id|SF_PREFIX
)paren
id|kfree
c_func
(paren
id|sb-&gt;u.affs_sb.s_prefix
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sb-&gt;u.affs_sb.s_bitmap
)paren
suffix:semicolon
id|affs_brelse
c_func
(paren
id|sb-&gt;u.affs_sb.s_root_bh
)paren
suffix:semicolon
multiline_comment|/* I&squot;m not happy with this. It would be better to save the previous&n;&t; * value of this devices blksize_size[][] in the super block and&n;&t; * restore it here, but with the affs superblock being quite large&n;&t; * already ...&n;&t; */
id|set_blocksize
c_func
(paren
id|sb-&gt;s_dev
comma
id|BLOCK_SIZE
)paren
suffix:semicolon
id|sb-&gt;s_dev
op_assign
l_int|0
suffix:semicolon
id|unlock_super
c_func
(paren
id|sb
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
suffix:semicolon
)brace
r_static
r_void
DECL|function|affs_write_super
id|affs_write_super
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_int
id|i
comma
id|clean
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
)paren
(brace
id|lock_super
c_func
(paren
id|sb
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|clean
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|sb-&gt;u.affs_sb.s_bm_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|sb-&gt;u.affs_sb.s_bitmap
(braket
id|i
)braket
dot
id|bm_bh
)paren
(brace
r_if
c_cond
(paren
id|buffer_dirty
c_func
(paren
id|sb-&gt;u.affs_sb.s_bitmap
(braket
id|i
)braket
dot
id|bm_bh
)paren
)paren
(brace
id|clean
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
id|unlock_super
c_func
(paren
id|sb
)paren
suffix:semicolon
id|ROOT_END_S
c_func
(paren
id|sb-&gt;u.affs_sb.s_root_bh-&gt;b_data
comma
id|sb
)paren
op_member_access_from_pointer
id|bm_flag
op_assign
id|htonl
c_func
(paren
id|clean
)paren
suffix:semicolon
id|secs_to_datestamp
c_func
(paren
id|CURRENT_TIME
comma
op_amp
id|ROOT_END_S
c_func
(paren
id|sb-&gt;u.affs_sb.s_root_bh-&gt;b_data
comma
id|sb
)paren
op_member_access_from_pointer
id|disk_altered
)paren
suffix:semicolon
id|affs_fix_checksum
c_func
(paren
id|sb-&gt;s_blocksize
comma
id|sb-&gt;u.affs_sb.s_root_bh-&gt;b_data
comma
l_int|5
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|sb-&gt;u.affs_sb.s_root_bh
comma
l_int|1
)paren
suffix:semicolon
id|sb-&gt;s_dirt
op_assign
op_logical_neg
id|clean
suffix:semicolon
multiline_comment|/* redo until bitmap synced */
)brace
r_else
id|sb-&gt;s_dirt
op_assign
l_int|0
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;AFFS: write_super() at %d, clean=%d&bslash;n&quot;
comma
id|CURRENT_TIME
comma
id|clean
)paren
suffix:semicolon
)brace
DECL|variable|affs_sops
r_static
r_struct
id|super_operations
id|affs_sops
op_assign
(brace
id|affs_read_inode
comma
id|affs_notify_change
comma
id|affs_write_inode
comma
id|affs_put_inode
comma
id|affs_put_super
comma
id|affs_write_super
comma
id|affs_statfs
comma
l_int|NULL
multiline_comment|/* remount */
)brace
suffix:semicolon
r_int
r_int
DECL|function|affs_parent_ino
id|affs_parent_ino
c_func
(paren
r_struct
id|inode
op_star
id|dir
)paren
(brace
r_int
id|root_ino
op_assign
(paren
id|dir-&gt;i_sb-&gt;u.affs_sb.s_root_block
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|S_ISDIR
(paren
id|dir-&gt;i_mode
)paren
)paren
(brace
id|affs_error
c_func
(paren
id|dir-&gt;i_sb
comma
l_string|&quot;parent_ino&quot;
comma
l_string|&quot;Trying to get parent of non-directory&quot;
)paren
suffix:semicolon
r_return
id|root_ino
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dir-&gt;i_ino
op_eq
id|root_ino
)paren
r_return
id|root_ino
suffix:semicolon
r_return
id|dir-&gt;u.affs_i.i_parent
suffix:semicolon
)brace
r_static
r_int
DECL|function|parse_options
id|parse_options
c_func
(paren
r_char
op_star
id|options
comma
id|uid_t
op_star
id|uid
comma
id|gid_t
op_star
id|gid
comma
r_int
op_star
id|mode
comma
r_int
op_star
id|reserved
comma
id|s32
op_star
id|root
comma
r_int
op_star
id|blocksize
comma
r_char
op_star
op_star
id|prefix
comma
r_char
op_star
id|volume
comma
r_int
r_int
op_star
id|mount_opts
)paren
(brace
r_char
op_star
id|this_char
comma
op_star
id|value
suffix:semicolon
r_int
id|f
suffix:semicolon
multiline_comment|/* Fill in defaults */
op_star
id|uid
op_assign
l_int|0
suffix:semicolon
op_star
id|gid
op_assign
l_int|0
suffix:semicolon
op_star
id|reserved
op_assign
l_int|2
suffix:semicolon
op_star
id|root
op_assign
op_minus
l_int|1
suffix:semicolon
op_star
id|blocksize
op_assign
op_minus
l_int|1
suffix:semicolon
op_star
id|prefix
op_assign
l_string|&quot;/&quot;
suffix:semicolon
id|volume
(braket
l_int|0
)braket
op_assign
l_char|&squot;:&squot;
suffix:semicolon
id|volume
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
op_star
id|mount_opts
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
)paren
r_return
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|this_char
op_assign
id|strtok
c_func
(paren
id|options
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
id|this_char
suffix:semicolon
id|this_char
op_assign
id|strtok
c_func
(paren
l_int|NULL
comma
l_string|&quot;,&quot;
)paren
)paren
(brace
id|f
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|value
op_assign
id|strchr
c_func
(paren
id|this_char
comma
l_char|&squot;=&squot;
)paren
)paren
op_ne
l_int|NULL
)paren
op_star
id|value
op_increment
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;protect&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
id|value
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;AFFS: Option protect does not take an argument&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
op_star
id|mount_opts
op_or_assign
id|SF_IMMUTABLE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;verbose&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
id|value
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;AFFS: Option verbose does not take an argument&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
op_star
id|mount_opts
op_or_assign
id|SF_VERBOSE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|f
op_assign
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;uid&quot;
)paren
)paren
op_logical_or
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;setuid&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
)paren
op_star
id|uid
op_assign
id|current-&gt;uid
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
op_star
id|value
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;AFFS: Argument for uid option missing&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
op_star
id|uid
op_assign
id|simple_strtoul
c_func
(paren
id|value
comma
op_amp
id|value
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|value
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|f
)paren
op_star
id|mount_opts
op_or_assign
id|SF_SETUID
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|f
op_assign
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;gid&quot;
)paren
)paren
op_logical_or
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;setgid&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
)paren
op_star
id|gid
op_assign
id|current-&gt;gid
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
op_star
id|value
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;AFFS: Argument for gid option missing&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
op_star
id|gid
op_assign
id|simple_strtoul
c_func
(paren
id|value
comma
op_amp
id|value
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|value
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|f
)paren
op_star
id|mount_opts
op_or_assign
id|SF_SETGID
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;prefix&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;AFFS: The prefix option requires an argument&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
op_star
id|prefix
op_assign
id|kmalloc
c_func
(paren
id|strlen
c_func
(paren
id|value
)paren
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|prefix
)paren
r_return
l_int|0
suffix:semicolon
id|strcpy
c_func
(paren
op_star
id|prefix
comma
id|value
)paren
suffix:semicolon
op_star
id|mount_opts
op_or_assign
id|SF_PREFIX
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;volume&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;AFFS: The volume option requires an argument&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|value
)paren
OG
l_int|30
)paren
id|value
(braket
l_int|30
)braket
op_assign
l_int|0
suffix:semicolon
id|strcpy
c_func
(paren
id|volume
comma
id|value
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;mode&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
op_logical_or
op_logical_neg
op_star
id|value
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;AFFS: The mode option requires an argument&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
op_star
id|mode
op_assign
id|simple_strtoul
c_func
(paren
id|value
comma
op_amp
id|value
comma
l_int|8
)paren
op_amp
l_int|0777
suffix:semicolon
r_if
c_cond
(paren
op_star
id|value
)paren
r_return
l_int|0
suffix:semicolon
op_star
id|mount_opts
op_or_assign
id|SF_SETMODE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;reserved&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
op_logical_or
op_logical_neg
op_star
id|value
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;AFFS: The reserved option requires an argument&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
op_star
id|reserved
op_assign
id|simple_strtoul
c_func
(paren
id|value
comma
op_amp
id|value
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|value
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;root&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
op_logical_or
op_logical_neg
op_star
id|value
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;AFFS: The root option requires an argument&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
op_star
id|root
op_assign
id|simple_strtoul
c_func
(paren
id|value
comma
op_amp
id|value
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|value
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;bs&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
op_logical_or
op_logical_neg
op_star
id|value
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;AFFS: The bs option requires an argument&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
op_star
id|blocksize
op_assign
id|simple_strtoul
c_func
(paren
id|value
comma
op_amp
id|value
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|value
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_star
id|blocksize
op_ne
l_int|512
op_logical_and
op_star
id|blocksize
op_ne
l_int|1024
op_logical_and
op_star
id|blocksize
op_ne
l_int|2048
op_logical_and
op_star
id|blocksize
op_ne
l_int|4096
)paren
(brace
id|printk
(paren
l_string|&quot;AFFS: Invalid blocksize (512, 1024, 2048, 4096 allowed)&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* Silently ignore the quota options */
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
(paren
id|this_char
comma
l_string|&quot;grpquota&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
(paren
id|this_char
comma
l_string|&quot;noquota&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
(paren
id|this_char
comma
l_string|&quot;quota&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
(paren
id|this_char
comma
l_string|&quot;usrquota&quot;
)paren
)paren
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;AFFS: Unrecognized mount option %s&bslash;n&quot;
comma
id|this_char
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* This function definitely needs to be split up. Some fine day I&squot;ll&n; * hopefully have the guts to do so. Until then: sorry for the mess.&n; */
r_static
r_struct
id|super_block
op_star
DECL|function|affs_read_super
id|affs_read_super
c_func
(paren
r_struct
id|super_block
op_star
id|s
comma
r_void
op_star
id|data
comma
r_int
id|silent
)paren
(brace
r_struct
id|buffer_head
op_star
id|bh
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bb
suffix:semicolon
id|kdev_t
id|dev
op_assign
id|s-&gt;s_dev
suffix:semicolon
id|s32
id|root_block
suffix:semicolon
r_int
id|size
suffix:semicolon
id|u32
id|chksum
suffix:semicolon
id|u32
op_star
id|bm
suffix:semicolon
id|s32
id|ptype
comma
id|stype
suffix:semicolon
r_int
id|mapidx
suffix:semicolon
r_int
id|num_bm
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
id|s32
id|key
suffix:semicolon
r_int
id|blocksize
suffix:semicolon
id|uid_t
id|uid
suffix:semicolon
id|gid_t
id|gid
suffix:semicolon
r_int
id|reserved
suffix:semicolon
r_int
id|az_no
suffix:semicolon
r_int
r_int
id|mount_flags
suffix:semicolon
r_int
r_int
id|offset
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;affs_read_super(%s)&bslash;n&quot;
comma
id|data
ques
c_cond
(paren
r_const
r_char
op_star
)paren
id|data
suffix:colon
l_string|&quot;no options&quot;
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|parse_options
c_func
(paren
id|data
comma
op_amp
id|uid
comma
op_amp
id|gid
comma
op_amp
id|i
comma
op_amp
id|reserved
comma
op_amp
id|root_block
comma
op_amp
id|blocksize
comma
op_amp
id|s-&gt;u.affs_sb.s_prefix
comma
id|s-&gt;u.affs_sb.s_volume
comma
op_amp
id|mount_flags
)paren
)paren
(brace
id|s-&gt;s_dev
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;AFFS: Error parsing options&bslash;n&quot;
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|lock_super
c_func
(paren
id|s
)paren
suffix:semicolon
multiline_comment|/* Get the size of the device in 512-byte blocks.&n;&t; * If we later see that the partition uses bigger&n;&t; * blocks, we will have to change it.&n;&t; */
id|size
op_assign
id|blksize_size
(braket
id|MAJOR
c_func
(paren
id|dev
)paren
)braket
(braket
id|MINOR
c_func
(paren
id|dev
)paren
)braket
suffix:semicolon
id|size
op_assign
(paren
id|size
ques
c_cond
id|size
suffix:colon
id|BLOCK_SIZE
)paren
op_div
l_int|512
op_star
id|blk_size
(braket
id|MAJOR
c_func
(paren
id|dev
)paren
)braket
(braket
id|MINOR
c_func
(paren
id|dev
)paren
)braket
suffix:semicolon
id|s-&gt;u.affs_sb.s_bitmap
op_assign
l_int|NULL
suffix:semicolon
id|s-&gt;u.affs_sb.s_root_bh
op_assign
l_int|NULL
suffix:semicolon
id|s-&gt;u.affs_sb.s_flags
op_assign
id|mount_flags
suffix:semicolon
id|s-&gt;u.affs_sb.s_mode
op_assign
id|i
suffix:semicolon
id|s-&gt;u.affs_sb.s_uid
op_assign
id|uid
suffix:semicolon
id|s-&gt;u.affs_sb.s_gid
op_assign
id|gid
suffix:semicolon
r_if
c_cond
(paren
id|size
op_eq
l_int|0
)paren
(brace
id|s-&gt;s_dev
op_assign
l_int|0
suffix:semicolon
id|unlock_super
c_func
(paren
id|s
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;AFFS: Could not determine device size&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|s-&gt;u.affs_sb.s_partition_size
op_assign
id|size
suffix:semicolon
id|s-&gt;u.affs_sb.s_reserved
op_assign
id|reserved
suffix:semicolon
multiline_comment|/* Try to find root block. Its location depends on the block size. */
id|s-&gt;u.affs_sb.s_hashsize
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|blocksize
OG
l_int|0
)paren
(brace
id|i
op_assign
id|blocksize
suffix:semicolon
id|j
op_assign
id|blocksize
suffix:semicolon
)brace
r_else
(brace
id|i
op_assign
l_int|512
suffix:semicolon
id|j
op_assign
l_int|4096
suffix:semicolon
)brace
r_for
c_loop
(paren
id|blocksize
op_assign
id|i
comma
id|key
op_assign
l_int|0
suffix:semicolon
id|blocksize
op_le
id|j
suffix:semicolon
id|blocksize
op_lshift_assign
l_int|1
comma
id|size
op_rshift_assign
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|root_block
OL
l_int|0
)paren
id|s-&gt;u.affs_sb.s_root_block
op_assign
(paren
id|reserved
op_plus
id|size
op_minus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
r_else
id|s-&gt;u.affs_sb.s_root_block
op_assign
id|root_block
suffix:semicolon
id|set_blocksize
c_func
(paren
id|dev
comma
id|blocksize
)paren
suffix:semicolon
multiline_comment|/* The root block location that was calculated above is not&n;&t;&t; * correct if the partition size is an odd number of 512-&n;&t;&t; * byte blocks, which will be rounded down to a number of&n;&t;&t; * 1024-byte blocks, and if there were an even number of&n;&t;&t; * reserved blocks. Ideally, all partition checkers should&n;&t;&t; * report the real number of blocks of the real blocksize,&n;&t;&t; * but since this just cannot be done, we have to try to&n;&t;&t; * find the root block anyways. In the above case, it is one&n;&t;&t; * block behind the calculated one. So we check this one, too.&n;&t;&t; */
r_for
c_loop
(paren
id|num_bm
op_assign
l_int|0
suffix:semicolon
id|num_bm
OL
l_int|2
suffix:semicolon
id|num_bm
op_increment
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;AFFS: Dev %s - trying bs=%d bytes, root at %u, &quot;
l_string|&quot;size=%d blocks, %d reserved&bslash;n&quot;
comma
id|kdevname
c_func
(paren
id|dev
)paren
comma
id|blocksize
comma
id|s-&gt;u.affs_sb.s_root_block
op_plus
id|num_bm
comma
id|size
comma
id|reserved
)paren
suffix:semicolon
id|bh
op_assign
id|affs_bread
c_func
(paren
id|dev
comma
id|s-&gt;u.affs_sb.s_root_block
op_plus
id|num_bm
comma
id|blocksize
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bh
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;AFFS: Cannot read root block&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|affs_checksum_block
c_func
(paren
id|blocksize
comma
id|bh-&gt;b_data
comma
op_amp
id|ptype
comma
op_amp
id|stype
)paren
op_logical_and
id|ptype
op_eq
id|T_SHORT
op_logical_and
id|stype
op_eq
id|ST_ROOT
)paren
(brace
id|s-&gt;s_blocksize
op_assign
id|blocksize
suffix:semicolon
id|s-&gt;u.affs_sb.s_hashsize
op_assign
id|blocksize
op_div
l_int|4
op_minus
l_int|56
suffix:semicolon
id|s-&gt;u.affs_sb.s_root_block
op_add_assign
id|num_bm
suffix:semicolon
id|key
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|key
)paren
r_break
suffix:semicolon
id|affs_brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
id|bh
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|key
)paren
(brace
id|affs_brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|silent
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;AFFS: Cannot find a valid root block on device %s&bslash;n&quot;
comma
id|kdevname
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|root_block
op_assign
id|s-&gt;u.affs_sb.s_root_block
suffix:semicolon
id|s-&gt;u.affs_sb.s_partition_size
op_assign
id|size
suffix:semicolon
id|s-&gt;s_blocksize_bits
op_assign
id|blocksize
op_eq
l_int|512
ques
c_cond
l_int|9
suffix:colon
id|blocksize
op_eq
l_int|1024
ques
c_cond
l_int|10
suffix:colon
id|blocksize
op_eq
l_int|2048
ques
c_cond
l_int|11
suffix:colon
l_int|12
suffix:semicolon
multiline_comment|/* Find out which kind of FS we have */
id|bb
op_assign
id|affs_bread
c_func
(paren
id|dev
comma
l_int|0
comma
id|s-&gt;s_blocksize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bb
)paren
(brace
id|chksum
op_assign
id|htonl
c_func
(paren
op_star
(paren
id|u32
op_star
)paren
id|bb-&gt;b_data
)paren
suffix:semicolon
multiline_comment|/* Dircache filesystems are compatible with non-dircache ones&n;&t;&t; * when reading. As long as they aren&squot;t supported, writing is&n;&t;&t; * not recommended.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|chksum
op_eq
id|FS_DCFFS
op_logical_or
id|chksum
op_eq
id|MUFS_DCFFS
op_logical_or
id|chksum
op_eq
id|FS_DCOFS
op_logical_or
id|chksum
op_eq
id|MUFS_DCOFS
)paren
op_logical_and
op_logical_neg
(paren
id|s-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;AFFS: Dircache FS - mounting %s read only&bslash;n&quot;
comma
id|kdevname
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|s-&gt;s_flags
op_or_assign
id|MS_RDONLY
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|chksum
)paren
(brace
r_case
id|MUFS_FS
suffix:colon
r_case
id|MUFS_INTLFFS
suffix:colon
id|s-&gt;u.affs_sb.s_flags
op_or_assign
id|SF_MUFS
suffix:semicolon
multiline_comment|/* fall thru */
r_case
id|FS_INTLFFS
suffix:colon
id|s-&gt;u.affs_sb.s_flags
op_or_assign
id|SF_INTL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MUFS_DCFFS
suffix:colon
r_case
id|MUFS_FFS
suffix:colon
id|s-&gt;u.affs_sb.s_flags
op_or_assign
id|SF_MUFS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FS_DCFFS
suffix:colon
r_case
id|FS_FFS
suffix:colon
r_break
suffix:semicolon
r_case
id|MUFS_OFS
suffix:colon
id|s-&gt;u.affs_sb.s_flags
op_or_assign
id|SF_MUFS
suffix:semicolon
multiline_comment|/* fall thru */
r_case
id|FS_OFS
suffix:colon
id|s-&gt;u.affs_sb.s_flags
op_or_assign
id|SF_OFS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MUFS_DCOFS
suffix:colon
r_case
id|MUFS_INTLOFS
suffix:colon
id|s-&gt;u.affs_sb.s_flags
op_or_assign
id|SF_MUFS
suffix:semicolon
r_case
id|FS_DCOFS
suffix:colon
r_case
id|FS_INTLOFS
suffix:colon
id|s-&gt;u.affs_sb.s_flags
op_or_assign
id|SF_INTL
op_or
id|SF_OFS
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;AFFS: Unknown filesystem on device %s: %08X&bslash;n&quot;
comma
id|kdevname
c_func
(paren
id|dev
)paren
comma
id|chksum
)paren
suffix:semicolon
id|affs_brelse
c_func
(paren
id|bb
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|affs_brelse
c_func
(paren
id|bb
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;AFFS: Cannot read boot block&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mount_flags
op_amp
id|SF_VERBOSE
)paren
(brace
id|chksum
op_assign
id|ntohl
c_func
(paren
id|chksum
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;AFFS: Mounting volume &bslash;&quot;%*s&bslash;&quot;: Type=%.3s&bslash;&bslash;%c, Blocksize=%d&bslash;n&quot;
comma
id|GET_END_PTR
c_func
(paren
r_struct
id|root_end
comma
id|bh-&gt;b_data
comma
id|blocksize
)paren
op_member_access_from_pointer
id|disk_name
(braket
l_int|0
)braket
comma
op_amp
id|GET_END_PTR
c_func
(paren
r_struct
id|root_end
comma
id|bh-&gt;b_data
comma
id|blocksize
)paren
op_member_access_from_pointer
id|disk_name
(braket
l_int|1
)braket
comma
(paren
r_char
op_star
)paren
op_amp
id|chksum
comma
(paren
(paren
r_char
op_star
)paren
op_amp
id|chksum
)paren
(braket
l_int|3
)braket
op_plus
l_char|&squot;0&squot;
comma
id|blocksize
)paren
suffix:semicolon
)brace
id|s-&gt;s_magic
op_assign
id|AFFS_SUPER_MAGIC
suffix:semicolon
id|s-&gt;s_flags
op_or_assign
id|MS_NODEV
op_or
id|MS_NOSUID
suffix:semicolon
multiline_comment|/* Keep super block in cache */
r_if
c_cond
(paren
op_logical_neg
(paren
id|s-&gt;u.affs_sb.s_root_bh
op_assign
id|affs_bread
c_func
(paren
id|dev
comma
id|root_block
comma
id|s-&gt;s_blocksize
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;AFFS: Cannot read root block&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Allocate space for bitmaps, zones and others */
id|size
op_assign
id|s-&gt;u.affs_sb.s_partition_size
op_minus
id|reserved
suffix:semicolon
id|num_bm
op_assign
(paren
id|size
op_plus
id|s-&gt;s_blocksize
op_star
l_int|8
op_minus
l_int|32
op_minus
l_int|1
)paren
op_div
(paren
id|s-&gt;s_blocksize
op_star
l_int|8
op_minus
l_int|32
)paren
suffix:semicolon
id|az_no
op_assign
(paren
id|size
op_plus
id|AFFS_ZONE_SIZE
op_minus
l_int|1
)paren
op_div
(paren
id|AFFS_ZONE_SIZE
op_minus
l_int|32
)paren
suffix:semicolon
id|ptype
op_assign
id|num_bm
op_star
r_sizeof
(paren
r_struct
id|affs_bm_info
)paren
op_plus
id|az_no
op_star
r_sizeof
(paren
r_struct
id|affs_alloc_zone
)paren
op_plus
id|MAX_ZONES
op_star
r_sizeof
(paren
r_struct
id|affs_zone
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;num_bm=%d, az_no=%d, sum=%d&bslash;n&quot;
comma
id|num_bm
comma
id|az_no
comma
id|ptype
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|s-&gt;u.affs_sb.s_bitmap
op_assign
id|kmalloc
c_func
(paren
id|ptype
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;AFFS: Not enough memory&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|memset
c_func
(paren
id|s-&gt;u.affs_sb.s_bitmap
comma
l_int|0
comma
id|ptype
)paren
suffix:semicolon
id|s-&gt;u.affs_sb.s_zones
op_assign
(paren
r_struct
id|affs_zone
op_star
)paren
op_amp
id|s-&gt;u.affs_sb.s_bitmap
(braket
id|num_bm
)braket
suffix:semicolon
id|s-&gt;u.affs_sb.s_alloc
op_assign
(paren
r_struct
id|affs_alloc_zone
op_star
)paren
op_amp
id|s-&gt;u.affs_sb.s_zones
(braket
id|MAX_ZONES
)braket
suffix:semicolon
id|s-&gt;u.affs_sb.s_num_az
op_assign
id|az_no
suffix:semicolon
id|mapidx
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ROOT_END_S
c_func
(paren
id|bh-&gt;b_data
comma
id|s
)paren
op_member_access_from_pointer
id|bm_flag
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|s-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;AFFS: Bitmap invalid - mounting %s read only&bslash;n&quot;
comma
id|kdevname
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|s-&gt;s_flags
op_or_assign
id|MS_RDONLY
suffix:semicolon
)brace
id|affs_brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
id|bh
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|nobitmap
suffix:semicolon
)brace
multiline_comment|/* The following section is ugly, I know. Especially because of the&n;&t; * reuse of some variables that are not named properly.&n;&t; */
id|key
op_assign
id|root_block
suffix:semicolon
id|ptype
op_assign
id|s-&gt;s_blocksize
op_div
l_int|4
op_minus
l_int|49
suffix:semicolon
id|stype
op_assign
id|ptype
op_plus
l_int|25
suffix:semicolon
id|offset
op_assign
id|s-&gt;u.affs_sb.s_reserved
suffix:semicolon
id|az_no
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|bh
)paren
(brace
id|bm
op_assign
(paren
id|u32
op_star
)paren
id|bh-&gt;b_data
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|ptype
suffix:semicolon
id|i
OL
id|stype
op_logical_and
id|bm
(braket
id|i
)braket
suffix:semicolon
id|i
op_increment
comma
id|mapidx
op_increment
)paren
(brace
r_if
c_cond
(paren
id|mapidx
op_ge
id|num_bm
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;AFFS: Not enough bitmap space!?&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|bb
op_assign
id|affs_bread
c_func
(paren
id|s-&gt;s_dev
comma
id|htonl
c_func
(paren
id|bm
(braket
id|i
)braket
)paren
comma
id|s-&gt;s_blocksize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bb
)paren
(brace
r_if
c_cond
(paren
id|affs_checksum_block
c_func
(paren
id|s-&gt;s_blocksize
comma
id|bb-&gt;b_data
comma
l_int|NULL
comma
l_int|NULL
)paren
op_logical_and
op_logical_neg
(paren
id|s-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;AFFS: Bitmap (%d,key=%lu) invalid - &quot;
l_string|&quot;mounting %s read only.&bslash;n&quot;
comma
id|mapidx
comma
id|htonl
c_func
(paren
id|bm
(braket
id|i
)braket
)paren
comma
id|kdevname
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|s-&gt;s_flags
op_or_assign
id|MS_RDONLY
suffix:semicolon
)brace
multiline_comment|/* Mark unused bits in the last word as allocated */
r_if
c_cond
(paren
id|size
op_le
id|s-&gt;s_blocksize
op_star
l_int|8
op_minus
l_int|32
)paren
(brace
multiline_comment|/* last bitmap */
id|ptype
op_assign
id|size
op_div
l_int|32
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* word number */
id|key
op_assign
id|size
op_amp
l_int|0x1F
suffix:semicolon
multiline_comment|/* used bits */
r_if
c_cond
(paren
id|key
)paren
(brace
id|chksum
op_assign
id|ntohl
c_func
(paren
l_int|0x7FFFFFFF
op_rshift
(paren
l_int|31
op_minus
id|key
)paren
)paren
suffix:semicolon
(paren
(paren
id|u32
op_star
)paren
id|bb-&gt;b_data
)paren
(braket
id|ptype
)braket
op_and_assign
id|chksum
suffix:semicolon
id|affs_fix_checksum
c_func
(paren
id|s-&gt;s_blocksize
comma
id|bb-&gt;b_data
comma
l_int|0
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|bb
comma
l_int|1
)paren
suffix:semicolon
)brace
id|ptype
op_assign
(paren
id|size
op_plus
l_int|31
)paren
op_amp
op_complement
l_int|0x1F
suffix:semicolon
id|size
op_assign
l_int|0
suffix:semicolon
id|s-&gt;u.affs_sb.s_flags
op_or_assign
id|SF_BM_VALID
suffix:semicolon
)brace
r_else
(brace
id|ptype
op_assign
id|s-&gt;s_blocksize
op_star
l_int|8
op_minus
l_int|32
suffix:semicolon
id|size
op_sub_assign
id|ptype
suffix:semicolon
)brace
id|s-&gt;u.affs_sb.s_bitmap
(braket
id|mapidx
)braket
dot
id|bm_firstblk
op_assign
id|offset
suffix:semicolon
id|s-&gt;u.affs_sb.s_bitmap
(braket
id|mapidx
)braket
dot
id|bm_bh
op_assign
l_int|NULL
suffix:semicolon
id|s-&gt;u.affs_sb.s_bitmap
(braket
id|mapidx
)braket
dot
id|bm_key
op_assign
id|htonl
c_func
(paren
id|bm
(braket
id|i
)braket
)paren
suffix:semicolon
id|s-&gt;u.affs_sb.s_bitmap
(braket
id|mapidx
)braket
dot
id|bm_count
op_assign
l_int|0
suffix:semicolon
id|offset
op_add_assign
id|ptype
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|ptype
OG
l_int|0
suffix:semicolon
id|j
op_increment
comma
id|az_no
op_increment
comma
id|ptype
op_sub_assign
id|key
)paren
(brace
id|key
op_assign
id|MIN
c_func
(paren
id|ptype
comma
id|AFFS_ZONE_SIZE
)paren
suffix:semicolon
multiline_comment|/* size in bits */
id|s-&gt;u.affs_sb.s_alloc
(braket
id|az_no
)braket
dot
id|az_size
op_assign
id|key
op_div
l_int|32
suffix:semicolon
id|s-&gt;u.affs_sb.s_alloc
(braket
id|az_no
)braket
dot
id|az_free
op_assign
id|affs_count_free_bits
c_func
(paren
id|key
op_div
l_int|8
comma
id|bb-&gt;b_data
op_plus
id|j
op_star
(paren
id|AFFS_ZONE_SIZE
op_div
l_int|8
)paren
op_plus
l_int|4
)paren
suffix:semicolon
)brace
id|affs_brelse
c_func
(paren
id|bb
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;AFFS: Cannot read bitmap&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|key
op_assign
id|htonl
c_func
(paren
id|bm
(braket
id|stype
)braket
)paren
suffix:semicolon
multiline_comment|/* Next block of bitmap pointers&t;*/
id|ptype
op_assign
l_int|0
suffix:semicolon
id|stype
op_assign
id|s-&gt;s_blocksize
op_div
l_int|4
op_minus
l_int|1
suffix:semicolon
id|affs_brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|key
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|bh
op_assign
id|affs_bread
c_func
(paren
id|s-&gt;s_dev
comma
id|key
comma
id|s-&gt;s_blocksize
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;AFFS: Cannot read bitmap extension&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
r_else
id|bh
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mapidx
op_ne
id|num_bm
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;AFFS: Got only %d bitmap blocks, expected %d&bslash;n&quot;
comma
id|mapidx
comma
id|num_bm
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|nobitmap
suffix:colon
id|s-&gt;u.affs_sb.s_bm_count
op_assign
id|mapidx
suffix:semicolon
multiline_comment|/* set up enough so that it can read an inode */
id|s-&gt;s_dev
op_assign
id|dev
suffix:semicolon
id|s-&gt;s_op
op_assign
op_amp
id|affs_sops
suffix:semicolon
id|s-&gt;s_root
op_assign
id|d_alloc_root
c_func
(paren
id|iget
c_func
(paren
id|s
comma
id|root_block
)paren
comma
l_int|NULL
)paren
suffix:semicolon
id|s-&gt;s_dirt
op_assign
l_int|1
suffix:semicolon
id|unlock_super
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|s-&gt;s_root
)paren
)paren
(brace
id|s-&gt;s_dev
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;AFFS: get root inode failed&bslash;n&quot;
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* create data zones if the fs is mounted r/w */
r_if
c_cond
(paren
op_logical_neg
(paren
id|s-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
)paren
(brace
id|ROOT_END
c_func
(paren
id|s-&gt;u.affs_sb.s_root_bh-&gt;b_data
comma
id|s-&gt;s_root-&gt;d_inode
)paren
op_member_access_from_pointer
id|bm_flag
op_assign
l_int|0
suffix:semicolon
id|secs_to_datestamp
c_func
(paren
id|CURRENT_TIME
comma
op_amp
id|ROOT_END
c_func
(paren
id|s-&gt;u.affs_sb.s_root_bh-&gt;b_data
comma
id|s-&gt;s_root-&gt;d_inode
)paren
op_member_access_from_pointer
id|disk_altered
)paren
suffix:semicolon
id|affs_fix_checksum
c_func
(paren
id|s-&gt;s_blocksize
comma
id|s-&gt;u.affs_sb.s_root_bh-&gt;b_data
comma
l_int|5
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|s-&gt;u.affs_sb.s_root_bh
comma
l_int|1
)paren
suffix:semicolon
id|affs_make_zones
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
id|pr_debug
c_func
(paren
l_string|&quot;AFFS: s_flags=%lX&bslash;n&quot;
comma
id|s-&gt;s_flags
)paren
suffix:semicolon
r_return
id|s
suffix:semicolon
id|out
suffix:colon
multiline_comment|/* Kick out for various error conditions */
id|affs_brelse
(paren
id|bh
)paren
suffix:semicolon
id|affs_brelse
c_func
(paren
id|s-&gt;u.affs_sb.s_root_bh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;u.affs_sb.s_bitmap
)paren
id|kfree
c_func
(paren
id|s-&gt;u.affs_sb.s_bitmap
)paren
suffix:semicolon
id|set_blocksize
c_func
(paren
id|dev
comma
id|BLOCK_SIZE
)paren
suffix:semicolon
id|s-&gt;s_dev
op_assign
l_int|0
suffix:semicolon
id|unlock_super
c_func
(paren
id|s
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_static
r_void
DECL|function|affs_statfs
id|affs_statfs
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|statfs
op_star
id|buf
comma
r_int
id|bufsiz
)paren
(brace
r_int
id|free
suffix:semicolon
r_struct
id|statfs
id|tmp
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;AFFS: statfs() partsize=%d, reserved=%d&bslash;n&quot;
comma
id|sb-&gt;u.affs_sb.s_partition_size
comma
id|sb-&gt;u.affs_sb.s_reserved
)paren
suffix:semicolon
id|free
op_assign
id|affs_count_free_blocks
c_func
(paren
id|sb
)paren
suffix:semicolon
id|tmp.f_type
op_assign
id|AFFS_SUPER_MAGIC
suffix:semicolon
id|tmp.f_bsize
op_assign
id|sb-&gt;s_blocksize
suffix:semicolon
id|tmp.f_blocks
op_assign
id|sb-&gt;u.affs_sb.s_partition_size
op_minus
id|sb-&gt;u.affs_sb.s_reserved
suffix:semicolon
id|tmp.f_bfree
op_assign
id|free
suffix:semicolon
id|tmp.f_bavail
op_assign
id|free
suffix:semicolon
id|tmp.f_files
op_assign
l_int|0
suffix:semicolon
id|tmp.f_ffree
op_assign
l_int|0
suffix:semicolon
id|copy_to_user
c_func
(paren
id|buf
comma
op_amp
id|tmp
comma
id|bufsiz
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|affs_read_inode
id|affs_read_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
r_struct
id|buffer_head
op_star
id|bh
comma
op_star
id|lbh
suffix:semicolon
r_struct
id|file_front
op_star
id|file_front
suffix:semicolon
r_struct
id|file_end
op_star
id|file_end
suffix:semicolon
id|s32
id|block
suffix:semicolon
r_int
r_int
id|prot
suffix:semicolon
id|s32
id|ptype
comma
id|stype
suffix:semicolon
r_int
r_int
id|id
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;AFFS: read_inode(%lu)&bslash;n&quot;
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
id|lbh
op_assign
l_int|NULL
suffix:semicolon
id|block
op_assign
id|inode-&gt;i_ino
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bh
op_assign
id|affs_bread
c_func
(paren
id|inode-&gt;i_dev
comma
id|block
comma
id|AFFS_I2BSIZE
c_func
(paren
id|inode
)paren
)paren
)paren
)paren
(brace
id|affs_error
c_func
(paren
id|inode-&gt;i_sb
comma
l_string|&quot;read_inode&quot;
comma
l_string|&quot;Cannot read block %d&quot;
comma
id|block
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|affs_checksum_block
c_func
(paren
id|AFFS_I2BSIZE
c_func
(paren
id|inode
)paren
comma
id|bh-&gt;b_data
comma
op_amp
id|ptype
comma
op_amp
id|stype
)paren
op_logical_or
id|ptype
op_ne
id|T_SHORT
)paren
(brace
id|affs_error
c_func
(paren
id|inode-&gt;i_sb
comma
l_string|&quot;read_inode&quot;
comma
l_string|&quot;Checksum or type (ptype=%d) error on inode %d&quot;
comma
id|ptype
comma
id|block
)paren
suffix:semicolon
id|affs_brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|file_front
op_assign
(paren
r_struct
id|file_front
op_star
)paren
id|bh-&gt;b_data
suffix:semicolon
id|file_end
op_assign
id|GET_END_PTR
c_func
(paren
r_struct
id|file_end
comma
id|bh-&gt;b_data
comma
id|AFFS_I2BSIZE
c_func
(paren
id|inode
)paren
)paren
suffix:semicolon
id|prot
op_assign
(paren
id|htonl
c_func
(paren
id|file_end-&gt;protect
)paren
op_amp
op_complement
l_int|0x10
)paren
op_xor
id|FIBF_OWNER
suffix:semicolon
id|inode-&gt;u.affs_i.i_protect
op_assign
id|prot
suffix:semicolon
id|inode-&gt;u.affs_i.i_parent
op_assign
id|htonl
c_func
(paren
id|file_end-&gt;parent
)paren
suffix:semicolon
id|inode-&gt;u.affs_i.i_original
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;u.affs_i.i_zone
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;u.affs_i.i_hlink
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;u.affs_i.i_pa_cnt
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;u.affs_i.i_pa_next
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;u.affs_i.i_pa_last
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;u.affs_i.i_ec
op_assign
l_int|NULL
suffix:semicolon
id|inode-&gt;u.affs_i.i_lastblock
op_assign
op_minus
l_int|1
suffix:semicolon
id|inode-&gt;i_nlink
op_assign
l_int|1
suffix:semicolon
id|inode-&gt;i_mode
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|inode-&gt;i_sb-&gt;u.affs_sb.s_flags
op_amp
id|SF_SETMODE
)paren
id|inode-&gt;i_mode
op_assign
id|inode-&gt;i_sb-&gt;u.affs_sb.s_mode
suffix:semicolon
r_else
id|inode-&gt;i_mode
op_assign
id|prot_to_mode
c_func
(paren
id|prot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inode-&gt;i_sb-&gt;u.affs_sb.s_flags
op_amp
id|SF_SETUID
)paren
id|inode-&gt;i_uid
op_assign
id|inode-&gt;i_sb-&gt;u.affs_sb.s_uid
suffix:semicolon
r_else
(brace
id|id
op_assign
id|htons
c_func
(paren
id|file_end-&gt;owner_uid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inode-&gt;i_sb-&gt;u.affs_sb.s_flags
op_amp
id|SF_MUFS
)paren
(brace
r_if
c_cond
(paren
id|id
op_eq
l_int|0
op_logical_or
id|id
op_eq
l_int|0xFFFF
)paren
id|id
op_xor_assign
op_complement
l_int|0
suffix:semicolon
)brace
id|inode-&gt;i_uid
op_assign
id|id
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inode-&gt;i_sb-&gt;u.affs_sb.s_flags
op_amp
id|SF_SETGID
)paren
id|inode-&gt;i_gid
op_assign
id|inode-&gt;i_sb-&gt;u.affs_sb.s_gid
suffix:semicolon
r_else
(brace
id|id
op_assign
id|htons
c_func
(paren
id|file_end-&gt;owner_gid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inode-&gt;i_sb-&gt;u.affs_sb.s_flags
op_amp
id|SF_MUFS
)paren
(brace
r_if
c_cond
(paren
id|id
op_eq
l_int|0
op_logical_or
id|id
op_eq
l_int|0xFFFF
)paren
id|id
op_xor_assign
op_complement
l_int|0
suffix:semicolon
)brace
id|inode-&gt;i_gid
op_assign
id|id
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|htonl
c_func
(paren
id|file_end-&gt;secondary_type
)paren
)paren
(brace
r_case
id|ST_ROOT
suffix:colon
id|inode-&gt;i_uid
op_assign
id|inode-&gt;i_sb-&gt;u.affs_sb.s_uid
suffix:semicolon
id|inode-&gt;i_gid
op_assign
id|inode-&gt;i_sb-&gt;u.affs_sb.s_gid
suffix:semicolon
r_case
id|ST_USERDIR
suffix:colon
r_if
c_cond
(paren
id|htonl
c_func
(paren
id|file_end-&gt;secondary_type
)paren
op_eq
id|ST_USERDIR
op_logical_or
id|inode-&gt;i_sb-&gt;u.affs_sb.s_flags
op_amp
id|SF_SETMODE
)paren
(brace
r_if
c_cond
(paren
id|inode-&gt;i_mode
op_amp
id|S_IRUSR
)paren
id|inode-&gt;i_mode
op_or_assign
id|S_IXUSR
suffix:semicolon
r_if
c_cond
(paren
id|inode-&gt;i_mode
op_amp
id|S_IRGRP
)paren
id|inode-&gt;i_mode
op_or_assign
id|S_IXGRP
suffix:semicolon
r_if
c_cond
(paren
id|inode-&gt;i_mode
op_amp
id|S_IROTH
)paren
id|inode-&gt;i_mode
op_or_assign
id|S_IXOTH
suffix:semicolon
id|inode-&gt;i_mode
op_or_assign
id|S_IFDIR
suffix:semicolon
)brace
r_else
id|inode-&gt;i_mode
op_assign
id|S_IRUGO
op_or
id|S_IXUGO
op_or
id|S_IWUSR
op_or
id|S_IFDIR
suffix:semicolon
id|inode-&gt;i_size
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ST_LINKDIR
suffix:colon
id|inode-&gt;u.affs_i.i_original
op_assign
id|htonl
c_func
(paren
id|file_end-&gt;original
)paren
suffix:semicolon
id|inode-&gt;u.affs_i.i_hlink
op_assign
l_int|1
suffix:semicolon
id|inode-&gt;i_mode
op_or_assign
id|S_IFDIR
suffix:semicolon
id|inode-&gt;i_size
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ST_LINKFILE
suffix:colon
id|inode-&gt;u.affs_i.i_original
op_assign
id|htonl
c_func
(paren
id|file_end-&gt;original
)paren
suffix:semicolon
id|inode-&gt;u.affs_i.i_hlink
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|lbh
op_assign
id|affs_bread
c_func
(paren
id|inode-&gt;i_dev
comma
id|inode-&gt;u.affs_i.i_original
comma
id|AFFS_I2BSIZE
c_func
(paren
id|inode
)paren
)paren
)paren
)paren
(brace
id|affs_brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
id|affs_error
c_func
(paren
id|inode-&gt;i_sb
comma
l_string|&quot;read_inode&quot;
comma
l_string|&quot;Cannot read block %lu&quot;
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|file_end
op_assign
id|GET_END_PTR
c_func
(paren
r_struct
id|file_end
comma
id|lbh-&gt;b_data
comma
id|AFFS_I2BSIZE
c_func
(paren
id|inode
)paren
)paren
suffix:semicolon
r_case
id|ST_FILE
suffix:colon
id|inode-&gt;i_mode
op_or_assign
id|S_IFREG
suffix:semicolon
id|inode-&gt;i_size
op_assign
id|htonl
c_func
(paren
id|file_end-&gt;byte_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inode-&gt;i_sb-&gt;u.affs_sb.s_flags
op_amp
id|SF_OFS
)paren
id|block
op_assign
id|AFFS_I2BSIZE
c_func
(paren
id|inode
)paren
op_minus
l_int|24
suffix:semicolon
r_else
id|block
op_assign
id|AFFS_I2BSIZE
c_func
(paren
id|inode
)paren
suffix:semicolon
id|inode-&gt;u.affs_i.i_lastblock
op_assign
(paren
(paren
id|inode-&gt;i_size
op_plus
id|block
op_minus
l_int|1
)paren
op_div
id|block
)paren
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ST_SOFTLINK
suffix:colon
id|inode-&gt;i_mode
op_or_assign
id|S_IFLNK
suffix:semicolon
id|inode-&gt;i_size
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|inode-&gt;i_mtime
op_assign
id|inode-&gt;i_atime
op_assign
id|inode-&gt;i_ctime
op_assign
(paren
id|htonl
c_func
(paren
id|file_end-&gt;created.ds_Days
)paren
op_star
(paren
l_int|24
op_star
l_int|60
op_star
l_int|60
)paren
op_plus
id|htonl
c_func
(paren
id|file_end-&gt;created.ds_Minute
)paren
op_star
l_int|60
op_plus
id|htonl
c_func
(paren
id|file_end-&gt;created.ds_Tick
)paren
op_div
l_int|50
op_plus
(paren
(paren
l_int|8
op_star
l_int|365
op_plus
l_int|2
)paren
op_star
l_int|24
op_star
l_int|60
op_star
l_int|60
)paren
)paren
op_plus
id|sys_tz.tz_minuteswest
op_star
l_int|60
suffix:semicolon
id|affs_brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
id|affs_brelse
c_func
(paren
id|lbh
)paren
suffix:semicolon
id|inode-&gt;i_op
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|S_ISREG
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
(brace
r_if
c_cond
(paren
id|inode-&gt;i_sb-&gt;u.affs_sb.s_flags
op_amp
id|SF_OFS
)paren
(brace
id|inode-&gt;i_op
op_assign
op_amp
id|affs_file_inode_operations_ofs
suffix:semicolon
)brace
r_else
(brace
id|inode-&gt;i_op
op_assign
op_amp
id|affs_file_inode_operations
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
id|inode-&gt;i_op
op_assign
op_amp
id|affs_dir_inode_operations
suffix:semicolon
r_else
r_if
c_cond
(paren
id|S_ISLNK
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
id|inode-&gt;i_op
op_assign
op_amp
id|affs_symlink_inode_operations
suffix:semicolon
)brace
r_static
r_void
DECL|function|affs_write_inode
id|affs_write_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_struct
id|file_end
op_star
id|file_end
suffix:semicolon
id|uid_t
id|uid
suffix:semicolon
id|gid_t
id|gid
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;AFFS: write_inode(%lu)&bslash;n&quot;
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode-&gt;i_nlink
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bh
op_assign
id|bread
c_func
(paren
id|inode-&gt;i_dev
comma
id|inode-&gt;i_ino
comma
id|AFFS_I2BSIZE
c_func
(paren
id|inode
)paren
)paren
)paren
)paren
(brace
id|affs_error
c_func
(paren
id|inode-&gt;i_sb
comma
l_string|&quot;write_inode&quot;
comma
l_string|&quot;Cannot read block %lu&quot;
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|file_end
op_assign
id|GET_END_PTR
c_func
(paren
r_struct
id|file_end
comma
id|bh-&gt;b_data
comma
id|AFFS_I2BSIZE
c_func
(paren
id|inode
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file_end-&gt;secondary_type
op_eq
id|htonl
c_func
(paren
id|ST_ROOT
)paren
)paren
(brace
id|secs_to_datestamp
c_func
(paren
id|inode-&gt;i_mtime
comma
op_amp
id|ROOT_END
c_func
(paren
id|bh-&gt;b_data
comma
id|inode
)paren
op_member_access_from_pointer
id|disk_altered
)paren
suffix:semicolon
)brace
r_else
(brace
id|file_end-&gt;protect
op_assign
id|ntohl
c_func
(paren
id|inode-&gt;u.affs_i.i_protect
op_xor
id|FIBF_OWNER
)paren
suffix:semicolon
id|file_end-&gt;byte_size
op_assign
id|ntohl
c_func
(paren
id|inode-&gt;i_size
)paren
suffix:semicolon
id|secs_to_datestamp
c_func
(paren
id|inode-&gt;i_mtime
comma
op_amp
id|file_end-&gt;created
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|inode-&gt;i_ino
op_eq
id|inode-&gt;i_sb-&gt;u.affs_sb.s_root_block
)paren
)paren
(brace
id|uid
op_assign
id|inode-&gt;i_uid
suffix:semicolon
id|gid
op_assign
id|inode-&gt;i_gid
suffix:semicolon
r_if
c_cond
(paren
id|inode-&gt;i_sb-&gt;u.affs_sb.s_flags
op_amp
id|SF_MUFS
)paren
(brace
r_if
c_cond
(paren
id|inode-&gt;i_uid
op_eq
l_int|0
op_logical_or
id|inode-&gt;i_uid
op_eq
l_int|0xFFFF
)paren
id|uid
op_assign
id|inode-&gt;i_uid
op_xor
op_complement
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|inode-&gt;i_gid
op_eq
l_int|0
op_logical_or
id|inode-&gt;i_gid
op_eq
l_int|0xFFFF
)paren
id|gid
op_assign
id|inode-&gt;i_gid
op_xor
op_complement
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|inode-&gt;i_sb-&gt;u.affs_sb.s_flags
op_amp
id|SF_SETUID
)paren
)paren
id|file_end-&gt;owner_uid
op_assign
id|ntohs
c_func
(paren
id|uid
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|inode-&gt;i_sb-&gt;u.affs_sb.s_flags
op_amp
id|SF_SETGID
)paren
)paren
id|file_end-&gt;owner_gid
op_assign
id|ntohs
c_func
(paren
id|gid
)paren
suffix:semicolon
)brace
)brace
id|affs_fix_checksum
c_func
(paren
id|AFFS_I2BSIZE
c_func
(paren
id|inode
)paren
comma
id|bh-&gt;b_data
comma
l_int|5
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|bh
comma
l_int|1
)paren
suffix:semicolon
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|affs_notify_change
id|affs_notify_change
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|iattr
op_star
id|attr
)paren
(brace
r_int
id|error
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;AFFS: notify_change(%lu,0x%x)&bslash;n&quot;
comma
id|inode-&gt;i_ino
comma
id|attr-&gt;ia_valid
)paren
suffix:semicolon
id|error
op_assign
id|inode_change_ok
c_func
(paren
id|inode
comma
id|attr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|attr-&gt;ia_valid
op_amp
id|ATTR_UID
)paren
op_logical_and
(paren
id|inode-&gt;i_sb-&gt;u.affs_sb.s_flags
op_amp
id|SF_SETUID
)paren
)paren
op_logical_or
(paren
(paren
id|attr-&gt;ia_valid
op_amp
id|ATTR_GID
)paren
op_logical_and
(paren
id|inode-&gt;i_sb-&gt;u.affs_sb.s_flags
op_amp
id|SF_SETGID
)paren
)paren
op_logical_or
(paren
(paren
id|attr-&gt;ia_valid
op_amp
id|ATTR_MODE
)paren
op_logical_and
(paren
id|inode-&gt;i_sb-&gt;u.affs_sb.s_flags
op_amp
(paren
id|SF_SETMODE
op_or
id|SF_IMMUTABLE
)paren
)paren
)paren
)paren
id|error
op_assign
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
(paren
id|inode-&gt;i_sb-&gt;u.affs_sb.s_flags
op_amp
id|SF_QUIET
)paren
ques
c_cond
l_int|0
suffix:colon
id|error
suffix:semicolon
r_if
c_cond
(paren
id|attr-&gt;ia_valid
op_amp
id|ATTR_MODE
)paren
id|inode-&gt;u.affs_i.i_protect
op_assign
id|mode_to_prot
c_func
(paren
id|attr-&gt;ia_mode
)paren
suffix:semicolon
id|inode_setattr
c_func
(paren
id|inode
comma
id|attr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|affs_put_inode
id|affs_put_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;AFFS: put_inode(ino=%lu, nlink=%u)&bslash;n&quot;
comma
id|inode-&gt;i_ino
comma
id|inode-&gt;i_nlink
)paren
suffix:semicolon
id|lock_super
c_func
(paren
id|inode-&gt;i_sb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inode-&gt;u.affs_i.i_ec
)paren
(brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|inode-&gt;u.affs_i.i_ec
)paren
suffix:semicolon
id|inode-&gt;u.affs_i.i_ec
op_assign
l_int|NULL
suffix:semicolon
)brace
id|unlock_super
c_func
(paren
id|inode-&gt;i_sb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inode-&gt;i_nlink
)paren
(brace
r_return
suffix:semicolon
)brace
id|inode-&gt;i_size
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|S_ISREG
c_func
(paren
id|inode-&gt;i_mode
)paren
op_logical_and
op_logical_neg
id|inode-&gt;u.affs_i.i_hlink
)paren
id|affs_truncate
c_func
(paren
id|inode
)paren
suffix:semicolon
id|affs_free_block
c_func
(paren
id|inode-&gt;i_sb
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
id|clear_inode
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
r_struct
id|inode
op_star
DECL|function|affs_new_inode
id|affs_new_inode
c_func
(paren
r_const
r_struct
id|inode
op_star
id|dir
)paren
(brace
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_struct
id|super_block
op_star
id|sb
suffix:semicolon
id|s32
id|block
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dir
op_logical_or
op_logical_neg
(paren
id|inode
op_assign
id|get_empty_inode
c_func
(paren
)paren
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
id|sb
op_assign
id|dir-&gt;i_sb
suffix:semicolon
id|inode-&gt;i_sb
op_assign
id|sb
suffix:semicolon
id|inode-&gt;i_flags
op_assign
id|sb-&gt;s_flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|block
op_assign
id|affs_new_header
c_func
(paren
(paren
r_struct
id|inode
op_star
)paren
id|dir
)paren
)paren
)paren
(brace
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|inode-&gt;i_count
op_assign
l_int|1
suffix:semicolon
id|inode-&gt;i_nlink
op_assign
l_int|1
suffix:semicolon
id|inode-&gt;i_dev
op_assign
id|sb-&gt;s_dev
suffix:semicolon
id|inode-&gt;i_uid
op_assign
id|current-&gt;fsuid
suffix:semicolon
id|inode-&gt;i_gid
op_assign
id|current-&gt;fsgid
suffix:semicolon
id|inode-&gt;i_ino
op_assign
id|block
suffix:semicolon
id|inode-&gt;i_op
op_assign
l_int|NULL
suffix:semicolon
id|inode-&gt;i_blocks
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;i_size
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;i_mode
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;i_blksize
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;i_mtime
op_assign
id|inode-&gt;i_atime
op_assign
id|inode-&gt;i_ctime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|inode-&gt;u.affs_i.i_original
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;u.affs_i.i_parent
op_assign
id|dir-&gt;i_ino
suffix:semicolon
id|inode-&gt;u.affs_i.i_zone
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;u.affs_i.i_hlink
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;u.affs_i.i_pa_cnt
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;u.affs_i.i_pa_next
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;u.affs_i.i_pa_last
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;u.affs_i.i_ec
op_assign
l_int|NULL
suffix:semicolon
id|inode-&gt;u.affs_i.i_lastblock
op_assign
op_minus
l_int|1
suffix:semicolon
id|insert_inode_hash
c_func
(paren
id|inode
)paren
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
id|inode
suffix:semicolon
)brace
r_int
DECL|function|affs_add_entry
id|affs_add_entry
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|inode
op_star
id|link
comma
r_struct
id|inode
op_star
id|inode
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
comma
r_int
id|type
)paren
(brace
r_struct
id|buffer_head
op_star
id|dir_bh
suffix:semicolon
r_struct
id|buffer_head
op_star
id|inode_bh
suffix:semicolon
r_struct
id|buffer_head
op_star
id|link_bh
suffix:semicolon
r_struct
id|buffer_head
op_star
id|ibh
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_int
id|i
suffix:semicolon
id|s32
id|next
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;AFFS: add_entry(dir=%lu,inode=%lu,&bslash;&quot;%*s&bslash;&quot;,type=%d&bslash;n&quot;
comma
id|dir-&gt;i_ino
comma
id|inode-&gt;i_ino
comma
id|len
comma
id|name
comma
id|type
)paren
suffix:semicolon
id|dir_bh
op_assign
id|affs_bread
c_func
(paren
id|dir-&gt;i_dev
comma
id|dir-&gt;i_ino
comma
id|AFFS_I2BSIZE
c_func
(paren
id|dir
)paren
)paren
suffix:semicolon
id|inode_bh
op_assign
id|affs_bread
c_func
(paren
id|inode-&gt;i_dev
comma
id|inode-&gt;i_ino
comma
id|AFFS_I2BSIZE
c_func
(paren
id|inode
)paren
)paren
suffix:semicolon
id|link_bh
op_assign
l_int|NULL
suffix:semicolon
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dir_bh
op_logical_or
op_logical_neg
id|inode_bh
)paren
r_goto
id|addentry_done
suffix:semicolon
r_if
c_cond
(paren
id|link
)paren
(brace
id|link_bh
op_assign
id|affs_bread
c_func
(paren
id|link-&gt;i_dev
comma
id|link-&gt;i_ino
comma
id|AFFS_I2BSIZE
c_func
(paren
id|link
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|link_bh
)paren
r_goto
id|addentry_done
suffix:semicolon
)brace
(paren
(paren
r_struct
id|dir_front
op_star
)paren
id|inode_bh-&gt;b_data
)paren
op_member_access_from_pointer
id|primary_type
op_assign
id|ntohl
c_func
(paren
id|T_SHORT
)paren
suffix:semicolon
(paren
(paren
r_struct
id|dir_front
op_star
)paren
id|inode_bh-&gt;b_data
)paren
op_member_access_from_pointer
id|own_key
op_assign
id|ntohl
c_func
(paren
id|inode-&gt;i_ino
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENAMETOOLONG
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|30
)paren
macro_line|#ifdef NO_TRUNCATE
r_goto
id|addentry_done
suffix:semicolon
macro_line|#else
id|len
op_assign
l_int|30
suffix:semicolon
macro_line|#endif
multiline_comment|/* Check if name is valid */
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|name
(braket
id|i
)braket
OL
l_char|&squot; &squot;
op_logical_or
id|name
(braket
id|i
)braket
op_eq
l_char|&squot;:&squot;
op_logical_or
(paren
(paren
r_int
r_char
)paren
id|name
(braket
id|i
)braket
OG
l_int|0x7e
op_logical_and
(paren
r_int
r_char
)paren
id|name
(braket
id|i
)braket
OL
l_int|0xa0
)paren
)paren
r_goto
id|addentry_done
suffix:semicolon
)brace
id|retval
op_assign
l_int|0
suffix:semicolon
id|DIR_END
c_func
(paren
id|inode_bh-&gt;b_data
comma
id|inode
)paren
op_member_access_from_pointer
id|dir_name
(braket
l_int|0
)braket
op_assign
id|len
suffix:semicolon
id|strncpy
c_func
(paren
id|DIR_END
c_func
(paren
id|inode_bh-&gt;b_data
comma
id|inode
)paren
op_member_access_from_pointer
id|dir_name
op_plus
l_int|1
comma
id|name
comma
id|len
)paren
suffix:semicolon
id|DIR_END
c_func
(paren
id|inode_bh-&gt;b_data
comma
id|inode
)paren
op_member_access_from_pointer
id|secondary_type
op_assign
id|ntohl
c_func
(paren
id|type
)paren
suffix:semicolon
id|DIR_END
c_func
(paren
id|inode_bh-&gt;b_data
comma
id|inode
)paren
op_member_access_from_pointer
id|parent
op_assign
id|ntohl
c_func
(paren
id|dir-&gt;i_ino
)paren
suffix:semicolon
id|i
op_assign
id|affs_hash_name
c_func
(paren
id|name
comma
id|len
comma
id|AFFS_I2FSTYPE
c_func
(paren
id|dir
)paren
comma
id|AFFS_I2HSIZE
c_func
(paren
id|dir
)paren
)paren
op_plus
l_int|6
suffix:semicolon
id|next
op_assign
id|dir-&gt;i_ino
suffix:semicolon
multiline_comment|/* Alas, we have to search the insertion point with a locked sb */
id|lock_super
c_func
(paren
id|inode-&gt;i_sb
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|ibh
op_assign
id|affs_bread
c_func
(paren
id|dir-&gt;i_dev
comma
id|next
comma
id|AFFS_I2BSIZE
c_func
(paren
id|dir
)paren
)paren
)paren
)paren
r_goto
id|addentry_done
suffix:semicolon
id|next
op_assign
id|htonl
c_func
(paren
(paren
(paren
id|s32
op_star
)paren
id|ibh-&gt;b_data
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|next
op_logical_or
id|next
OG
id|inode-&gt;i_ino
)paren
r_break
suffix:semicolon
id|i
op_assign
id|AFFS_I2BSIZE
c_func
(paren
id|dir
)paren
op_div
l_int|4
op_minus
l_int|4
suffix:semicolon
id|affs_brelse
c_func
(paren
id|ibh
)paren
suffix:semicolon
)brace
id|DIR_END
c_func
(paren
id|inode_bh-&gt;b_data
comma
id|inode
)paren
op_member_access_from_pointer
id|hash_chain
op_assign
id|next
suffix:semicolon
(paren
(paren
id|s32
op_star
)paren
id|ibh-&gt;b_data
)paren
(braket
id|i
)braket
op_assign
id|ntohl
c_func
(paren
id|inode-&gt;i_ino
)paren
suffix:semicolon
id|affs_fix_checksum
c_func
(paren
id|AFFS_I2BSIZE
c_func
(paren
id|dir
)paren
comma
id|ibh-&gt;b_data
comma
l_int|5
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|ibh
comma
l_int|1
)paren
suffix:semicolon
id|affs_brelse
c_func
(paren
id|ibh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link_bh
)paren
(brace
id|LINK_END
c_func
(paren
id|inode_bh-&gt;b_data
comma
id|inode
)paren
op_member_access_from_pointer
id|original
op_assign
id|ntohl
c_func
(paren
id|link-&gt;i_ino
)paren
suffix:semicolon
id|LINK_END
c_func
(paren
id|inode_bh-&gt;b_data
comma
id|inode
)paren
op_member_access_from_pointer
id|link_chain
op_assign
id|FILE_END
c_func
(paren
id|link_bh-&gt;b_data
comma
id|link
)paren
op_member_access_from_pointer
id|link_chain
suffix:semicolon
id|FILE_END
c_func
(paren
id|link_bh-&gt;b_data
comma
id|link
)paren
op_member_access_from_pointer
id|link_chain
op_assign
id|ntohl
c_func
(paren
id|inode-&gt;i_ino
)paren
suffix:semicolon
id|affs_fix_checksum
c_func
(paren
id|AFFS_I2BSIZE
c_func
(paren
id|link
)paren
comma
id|link_bh-&gt;b_data
comma
l_int|5
)paren
suffix:semicolon
id|link-&gt;i_version
op_assign
op_increment
id|event
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|link
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|link_bh
comma
l_int|1
)paren
suffix:semicolon
)brace
id|affs_fix_checksum
c_func
(paren
id|AFFS_I2BSIZE
c_func
(paren
id|inode
)paren
comma
id|inode_bh-&gt;b_data
comma
l_int|5
)paren
suffix:semicolon
id|affs_fix_checksum
c_func
(paren
id|AFFS_I2BSIZE
c_func
(paren
id|dir
)paren
comma
id|dir_bh-&gt;b_data
comma
l_int|5
)paren
suffix:semicolon
id|dir-&gt;i_version
op_assign
op_increment
id|event
suffix:semicolon
id|dir-&gt;i_mtime
op_assign
id|dir-&gt;i_atime
op_assign
id|dir-&gt;i_ctime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|unlock_super
c_func
(paren
id|inode-&gt;i_sb
)paren
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|dir
)paren
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|inode
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|dir_bh
comma
l_int|1
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|inode_bh
comma
l_int|1
)paren
suffix:semicolon
id|addentry_done
suffix:colon
id|affs_brelse
c_func
(paren
id|dir_bh
)paren
suffix:semicolon
id|affs_brelse
c_func
(paren
id|inode_bh
)paren
suffix:semicolon
id|affs_brelse
c_func
(paren
id|link_bh
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|variable|affs_fs_type
r_static
r_struct
id|file_system_type
id|affs_fs_type
op_assign
(brace
l_string|&quot;affs&quot;
comma
id|FS_REQUIRES_DEV
comma
id|affs_read_super
comma
l_int|NULL
)brace
suffix:semicolon
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|init_affs_fs
c_func
(paren
r_void
)paren
)paren
(brace
r_return
id|register_filesystem
c_func
(paren
op_amp
id|affs_fs_type
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|EXPORT_NO_SYMBOLS
suffix:semicolon
r_int
DECL|function|init_module
id|init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|register_filesystem
c_func
(paren
op_amp
id|affs_fs_type
)paren
suffix:semicolon
)brace
r_void
DECL|function|cleanup_module
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|unregister_filesystem
c_func
(paren
op_amp
id|affs_fs_type
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
