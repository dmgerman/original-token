multiline_comment|/*&n; * truncate.c&n; *&n; * PURPOSE&n; *&t;Truncate handling routines for the OSTA-UDF(tm) filesystem.&n; *&n; * CONTACTS&n; *&t;E-mail regarding any portion of the Linux UDF file system should be&n; *&t;directed to the development team mailing list (run by majordomo):&n; *&t;&t;linux_udf@hootie.lvld.hp.com&n; *&n; * COPYRIGHT&n; *&t;This file is distributed under the terms of the GNU General Public&n; *&t;License (GPL). Copies of the GPL can be obtained from:&n; *&t;&t;ftp://prep.ai.mit.edu/pub/gnu/GPL&n; *&t;Each contributing author retains all rights to their own work.&n; *&n; *  (C) 1999-2000 Ben Fennema&n; *  (C) 1999 Stelias Computing Inc&n; *&n; * HISTORY&n; *&n; *  02/24/99 blf  Created.&n; *&n; */
macro_line|#include &quot;udfdecl.h&quot;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/udf_fs.h&gt;
macro_line|#include &quot;udf_i.h&quot;
macro_line|#include &quot;udf_sb.h&quot;
DECL|function|extent_trunc
r_static
r_void
id|extent_trunc
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
id|lb_addr
id|bloc
comma
r_int
id|extoffset
comma
id|lb_addr
id|eloc
comma
id|Uint8
id|etype
comma
id|Uint32
id|elen
comma
r_struct
id|buffer_head
op_star
op_star
id|bh
comma
id|Uint32
id|nelen
)paren
(brace
id|lb_addr
id|neloc
op_assign
(brace
l_int|0
comma
l_int|0
)brace
suffix:semicolon
r_int
id|blocks
op_assign
id|inode-&gt;i_sb-&gt;s_blocksize
op_div
l_int|512
suffix:semicolon
r_int
id|last_block
op_assign
(paren
id|elen
op_plus
id|inode-&gt;i_sb-&gt;s_blocksize
op_minus
l_int|1
)paren
op_rshift
id|inode-&gt;i_sb-&gt;s_blocksize_bits
suffix:semicolon
r_int
id|first_block
op_assign
(paren
id|nelen
op_plus
id|inode-&gt;i_sb-&gt;s_blocksize
op_minus
l_int|1
)paren
op_rshift
id|inode-&gt;i_sb-&gt;s_blocksize_bits
suffix:semicolon
r_if
c_cond
(paren
id|nelen
)paren
(brace
id|neloc
op_assign
id|eloc
suffix:semicolon
id|nelen
op_assign
(paren
id|etype
op_lshift
l_int|30
)paren
op_or
id|nelen
suffix:semicolon
)brace
r_if
c_cond
(paren
id|elen
op_ne
id|nelen
)paren
(brace
id|udf_write_aext
c_func
(paren
id|inode
comma
id|bloc
comma
op_amp
id|extoffset
comma
id|neloc
comma
id|nelen
comma
id|bh
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|last_block
op_minus
id|first_block
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|etype
op_eq
id|EXTENT_RECORDED_ALLOCATED
)paren
(brace
id|inode-&gt;i_blocks
op_sub_assign
(paren
id|blocks
op_star
(paren
id|last_block
op_minus
id|first_block
)paren
)paren
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|etype
op_ne
id|EXTENT_NOT_RECORDED_NOT_ALLOCATED
)paren
id|udf_free_blocks
c_func
(paren
id|inode
comma
id|eloc
comma
id|first_block
comma
id|last_block
op_minus
id|first_block
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|udf_trunc
r_void
id|udf_trunc
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
id|lb_addr
id|bloc
comma
id|eloc
comma
id|neloc
op_assign
(brace
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|Uint32
id|extoffset
comma
id|elen
comma
id|offset
comma
id|nelen
op_assign
l_int|0
comma
id|lelen
op_assign
l_int|0
comma
id|lenalloc
suffix:semicolon
r_int
id|etype
suffix:semicolon
r_int
id|first_block
op_assign
id|inode-&gt;i_size
op_rshift
id|inode-&gt;i_sb-&gt;s_blocksize_bits
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
op_assign
l_int|NULL
suffix:semicolon
r_int
id|adsize
suffix:semicolon
r_if
c_cond
(paren
id|UDF_I_ALLOCTYPE
c_func
(paren
id|inode
)paren
op_eq
id|ICB_FLAG_AD_SHORT
)paren
id|adsize
op_assign
r_sizeof
(paren
id|short_ad
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|UDF_I_ALLOCTYPE
c_func
(paren
id|inode
)paren
op_eq
id|ICB_FLAG_AD_LONG
)paren
id|adsize
op_assign
r_sizeof
(paren
id|long_ad
)paren
suffix:semicolon
r_else
id|adsize
op_assign
l_int|0
suffix:semicolon
id|etype
op_assign
id|inode_bmap
c_func
(paren
id|inode
comma
id|first_block
comma
op_amp
id|bloc
comma
op_amp
id|extoffset
comma
op_amp
id|eloc
comma
op_amp
id|elen
comma
op_amp
id|offset
comma
op_amp
id|bh
)paren
suffix:semicolon
id|offset
op_assign
(paren
id|offset
op_lshift
id|inode-&gt;i_sb-&gt;s_blocksize_bits
)paren
op_or
(paren
id|inode-&gt;i_size
op_amp
(paren
id|inode-&gt;i_sb-&gt;s_blocksize
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|etype
op_ne
op_minus
l_int|1
)paren
(brace
id|extoffset
op_sub_assign
id|adsize
suffix:semicolon
id|extent_trunc
c_func
(paren
id|inode
comma
id|bloc
comma
id|extoffset
comma
id|eloc
comma
id|etype
comma
id|elen
comma
op_amp
id|bh
comma
id|offset
)paren
suffix:semicolon
id|extoffset
op_add_assign
id|adsize
suffix:semicolon
r_if
c_cond
(paren
id|offset
)paren
id|lenalloc
op_assign
id|extoffset
suffix:semicolon
r_else
id|lenalloc
op_assign
id|extoffset
op_minus
id|adsize
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
op_amp
id|UDF_I_LOCATION
c_func
(paren
id|inode
)paren
comma
op_amp
id|bloc
comma
r_sizeof
(paren
id|lb_addr
)paren
)paren
)paren
id|lenalloc
op_sub_assign
id|udf_file_entry_alloc_offset
c_func
(paren
id|inode
)paren
suffix:semicolon
r_else
id|lenalloc
op_sub_assign
r_sizeof
(paren
r_struct
id|AllocExtDesc
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|etype
op_assign
id|udf_current_aext
c_func
(paren
id|inode
comma
op_amp
id|bloc
comma
op_amp
id|extoffset
comma
op_amp
id|eloc
comma
op_amp
id|elen
comma
op_amp
id|bh
comma
l_int|0
)paren
)paren
op_ne
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|etype
op_eq
id|EXTENT_NEXT_EXTENT_ALLOCDECS
)paren
(brace
id|udf_write_aext
c_func
(paren
id|inode
comma
id|bloc
comma
op_amp
id|extoffset
comma
id|neloc
comma
id|nelen
comma
op_amp
id|bh
comma
l_int|0
)paren
suffix:semicolon
id|extoffset
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|lelen
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
op_amp
id|UDF_I_LOCATION
c_func
(paren
id|inode
)paren
comma
op_amp
id|bloc
comma
r_sizeof
(paren
id|lb_addr
)paren
)paren
)paren
id|memset
c_func
(paren
id|bh-&gt;b_data
comma
l_int|0x00
comma
id|udf_file_entry_alloc_offset
c_func
(paren
id|inode
)paren
)paren
suffix:semicolon
r_else
id|memset
c_func
(paren
id|bh-&gt;b_data
comma
l_int|0x00
comma
r_sizeof
(paren
r_struct
id|AllocExtDesc
)paren
)paren
suffix:semicolon
id|udf_free_blocks
c_func
(paren
id|inode
comma
id|bloc
comma
l_int|0
comma
id|lelen
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
op_amp
id|UDF_I_LOCATION
c_func
(paren
id|inode
)paren
comma
op_amp
id|bloc
comma
r_sizeof
(paren
id|lb_addr
)paren
)paren
)paren
(brace
id|UDF_I_LENALLOC
c_func
(paren
id|inode
)paren
op_assign
id|lenalloc
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|AllocExtDesc
op_star
id|aed
op_assign
(paren
r_struct
id|AllocExtDesc
op_star
)paren
(paren
id|bh-&gt;b_data
)paren
suffix:semicolon
id|aed-&gt;lengthAllocDescs
op_assign
id|cpu_to_le32
c_func
(paren
id|lenalloc
)paren
suffix:semicolon
id|udf_update_tag
c_func
(paren
id|bh-&gt;b_data
comma
id|lenalloc
op_plus
r_sizeof
(paren
r_struct
id|AllocExtDesc
)paren
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|bh
)paren
suffix:semicolon
)brace
)brace
id|udf_release_data
c_func
(paren
id|bh
)paren
suffix:semicolon
id|bh
op_assign
l_int|NULL
suffix:semicolon
id|bloc
op_assign
id|eloc
suffix:semicolon
r_if
c_cond
(paren
id|elen
)paren
id|lelen
op_assign
(paren
id|elen
op_plus
id|inode-&gt;i_sb-&gt;s_blocksize
op_minus
l_int|1
)paren
op_rshift
id|inode-&gt;i_sb-&gt;s_blocksize_bits
suffix:semicolon
r_else
id|lelen
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|extent_trunc
c_func
(paren
id|inode
comma
id|bloc
comma
id|extoffset
comma
id|eloc
comma
id|etype
comma
id|elen
comma
op_amp
id|bh
comma
l_int|0
)paren
suffix:semicolon
id|extoffset
op_add_assign
id|adsize
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|lelen
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
op_amp
id|UDF_I_LOCATION
c_func
(paren
id|inode
)paren
comma
op_amp
id|bloc
comma
r_sizeof
(paren
id|lb_addr
)paren
)paren
)paren
id|memset
c_func
(paren
id|bh-&gt;b_data
comma
l_int|0x00
comma
id|udf_file_entry_alloc_offset
c_func
(paren
id|inode
)paren
)paren
suffix:semicolon
r_else
id|memset
c_func
(paren
id|bh-&gt;b_data
comma
l_int|0x00
comma
r_sizeof
(paren
r_struct
id|AllocExtDesc
)paren
)paren
suffix:semicolon
id|udf_free_blocks
c_func
(paren
id|inode
comma
id|bloc
comma
l_int|0
comma
id|lelen
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
op_amp
id|UDF_I_LOCATION
c_func
(paren
id|inode
)paren
comma
op_amp
id|bloc
comma
r_sizeof
(paren
id|lb_addr
)paren
)paren
)paren
(brace
id|UDF_I_LENALLOC
c_func
(paren
id|inode
)paren
op_assign
id|lenalloc
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|AllocExtDesc
op_star
id|aed
op_assign
(paren
r_struct
id|AllocExtDesc
op_star
)paren
(paren
id|bh-&gt;b_data
)paren
suffix:semicolon
id|aed-&gt;lengthAllocDescs
op_assign
id|cpu_to_le32
c_func
(paren
id|lenalloc
)paren
suffix:semicolon
id|udf_update_tag
c_func
(paren
id|bh-&gt;b_data
comma
id|lenalloc
op_plus
r_sizeof
(paren
r_struct
id|AllocExtDesc
)paren
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|bh
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|inode-&gt;i_size
)paren
(brace
r_if
c_cond
(paren
id|offset
)paren
(brace
id|extoffset
op_sub_assign
id|adsize
suffix:semicolon
id|etype
op_assign
id|udf_next_aext
c_func
(paren
id|inode
comma
op_amp
id|bloc
comma
op_amp
id|extoffset
comma
op_amp
id|eloc
comma
op_amp
id|elen
comma
op_amp
id|bh
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|etype
op_eq
id|EXTENT_NOT_RECORDED_NOT_ALLOCATED
)paren
(brace
id|extoffset
op_sub_assign
id|adsize
suffix:semicolon
id|elen
op_assign
(paren
id|EXTENT_NOT_RECORDED_NOT_ALLOCATED
op_lshift
l_int|30
)paren
op_or
(paren
id|elen
op_plus
id|offset
)paren
suffix:semicolon
id|udf_write_aext
c_func
(paren
id|inode
comma
id|bloc
comma
op_amp
id|extoffset
comma
id|eloc
comma
id|elen
comma
op_amp
id|bh
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|etype
op_eq
id|EXTENT_NOT_RECORDED_ALLOCATED
)paren
(brace
id|lb_addr
id|neloc
op_assign
(brace
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|extoffset
op_sub_assign
id|adsize
suffix:semicolon
id|nelen
op_assign
(paren
id|EXTENT_NOT_RECORDED_NOT_ALLOCATED
op_lshift
l_int|30
)paren
op_or
(paren
(paren
id|elen
op_plus
id|offset
op_plus
id|inode-&gt;i_sb-&gt;s_blocksize
op_minus
l_int|1
)paren
op_amp
op_complement
(paren
id|inode-&gt;i_sb-&gt;s_blocksize
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|udf_write_aext
c_func
(paren
id|inode
comma
id|bloc
comma
op_amp
id|extoffset
comma
id|neloc
comma
id|nelen
comma
op_amp
id|bh
comma
l_int|1
)paren
suffix:semicolon
id|udf_add_aext
c_func
(paren
id|inode
comma
op_amp
id|bloc
comma
op_amp
id|extoffset
comma
id|eloc
comma
(paren
id|etype
op_lshift
l_int|30
)paren
op_or
id|elen
comma
op_amp
id|bh
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|elen
op_amp
(paren
id|inode-&gt;i_sb-&gt;s_blocksize
op_minus
l_int|1
)paren
)paren
(brace
id|extoffset
op_sub_assign
id|adsize
suffix:semicolon
id|elen
op_assign
(paren
id|EXTENT_RECORDED_ALLOCATED
op_lshift
l_int|30
)paren
op_or
(paren
(paren
id|elen
op_plus
id|inode-&gt;i_sb-&gt;s_blocksize
op_minus
l_int|1
)paren
op_amp
op_complement
(paren
id|inode-&gt;i_sb-&gt;s_blocksize
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|udf_write_aext
c_func
(paren
id|inode
comma
id|bloc
comma
op_amp
id|extoffset
comma
id|eloc
comma
id|elen
comma
op_amp
id|bh
comma
l_int|1
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
op_amp
id|eloc
comma
l_int|0x00
comma
r_sizeof
(paren
id|lb_addr
)paren
)paren
suffix:semicolon
id|elen
op_assign
(paren
id|EXTENT_NOT_RECORDED_NOT_ALLOCATED
op_lshift
l_int|30
)paren
op_or
id|offset
suffix:semicolon
id|udf_add_aext
c_func
(paren
id|inode
comma
op_amp
id|bloc
comma
op_amp
id|extoffset
comma
id|eloc
comma
id|elen
comma
op_amp
id|bh
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
)brace
id|udf_release_data
c_func
(paren
id|bh
)paren
suffix:semicolon
)brace
DECL|function|udf_truncate
r_void
id|udf_truncate
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|S_ISREG
c_func
(paren
id|inode-&gt;i_mode
)paren
op_logical_or
id|S_ISDIR
c_func
(paren
id|inode-&gt;i_mode
)paren
op_logical_or
id|S_ISLNK
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|IS_APPEND
c_func
(paren
id|inode
)paren
op_logical_or
id|IS_IMMUTABLE
c_func
(paren
id|inode
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|UDF_I_ALLOCTYPE
c_func
(paren
id|inode
)paren
op_eq
id|ICB_FLAG_AD_IN_ICB
)paren
(brace
r_if
c_cond
(paren
id|inode-&gt;i_sb-&gt;s_blocksize
OL
(paren
id|udf_file_entry_alloc_offset
c_func
(paren
id|inode
)paren
op_plus
id|inode-&gt;i_size
)paren
)paren
(brace
id|udf_expand_file_adinicb
c_func
(paren
id|inode
comma
id|inode-&gt;i_size
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
id|UDF_I_ALLOCTYPE
c_func
(paren
id|inode
)paren
op_eq
id|ICB_FLAG_AD_IN_ICB
)paren
(brace
id|inode-&gt;i_size
op_assign
id|UDF_I_LENALLOC
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
id|udf_trunc
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
r_else
id|UDF_I_LENALLOC
c_func
(paren
id|inode
)paren
op_assign
id|inode-&gt;i_size
suffix:semicolon
)brace
r_else
id|udf_trunc
c_func
(paren
id|inode
)paren
suffix:semicolon
id|inode-&gt;i_mtime
op_assign
id|inode-&gt;i_ctime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
eof
