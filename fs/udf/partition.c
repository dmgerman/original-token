multiline_comment|/*&n; * partition.c&n; *&n; * PURPOSE&n; *      Partition handling routines for the OSTA-UDF(tm) filesystem.&n; *&n; * CONTACTS&n; *      E-mail regarding any portion of the Linux UDF file system should be&n; *      directed to the development team mailing list (run by majordomo):&n; *              linux_udf@hootie.lvld.hp.com&n; *&n; * COPYRIGHT&n; *      This file is distributed under the terms of the GNU General Public&n; *      License (GPL). Copies of the GPL can be obtained from:&n; *              ftp://prep.ai.mit.edu/pub/gnu/GPL&n; *      Each contributing author retains all rights to their own work.&n; *&n; *  (C) 1998-1999 Ben Fennema&n; *&n; * HISTORY&n; *&n; * 12/06/98 blf  Created file. &n; *&n; */
macro_line|#include &quot;udfdecl.h&quot;
macro_line|#include &quot;udf_sb.h&quot;
macro_line|#include &quot;udf_i.h&quot;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/udf_fs.h&gt;
DECL|function|udf_get_pblock
r_extern
id|Uint32
id|udf_get_pblock
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
id|Uint32
id|block
comma
id|Uint16
id|partition
comma
id|Uint32
id|offset
)paren
(brace
id|Uint16
id|ident
suffix:semicolon
r_if
c_cond
(paren
id|partition
op_ge
id|UDF_SB_NUMPARTS
c_func
(paren
id|sb
)paren
)paren
(brace
id|udf_debug
c_func
(paren
l_string|&quot;block=%d, partition=%d, offset=%d: invalid partition&bslash;n&quot;
comma
id|block
comma
id|partition
comma
id|offset
)paren
suffix:semicolon
r_return
l_int|0xFFFFFFFF
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|UDF_SB_PARTTYPE
c_func
(paren
id|sb
comma
id|partition
)paren
)paren
(brace
r_case
id|UDF_TYPE1_MAP15
suffix:colon
(brace
r_return
id|UDF_SB_PARTROOT
c_func
(paren
id|sb
comma
id|partition
)paren
op_plus
id|block
op_plus
id|offset
suffix:semicolon
)brace
r_case
id|UDF_VIRTUAL_MAP15
suffix:colon
r_case
id|UDF_VIRTUAL_MAP20
suffix:colon
(brace
r_struct
id|buffer_head
op_star
id|bh
op_assign
l_int|NULL
suffix:semicolon
id|Uint32
id|newblock
suffix:semicolon
id|Uint32
id|index
suffix:semicolon
id|Uint32
id|loc
suffix:semicolon
id|index
op_assign
(paren
id|sb-&gt;s_blocksize
op_minus
id|UDF_SB_TYPEVIRT
c_func
(paren
id|sb
comma
id|partition
)paren
dot
id|s_start_offset
)paren
op_div
r_sizeof
(paren
id|Uint32
)paren
suffix:semicolon
r_if
c_cond
(paren
id|block
OG
id|UDF_SB_TYPEVIRT
c_func
(paren
id|sb
comma
id|partition
)paren
dot
id|s_num_entries
)paren
(brace
id|udf_debug
c_func
(paren
l_string|&quot;Trying to access block beyond end of VAT (%d max %d)&bslash;n&quot;
comma
id|block
comma
id|UDF_SB_TYPEVIRT
c_func
(paren
id|sb
comma
id|partition
)paren
dot
id|s_num_entries
)paren
suffix:semicolon
r_return
l_int|0xFFFFFFFF
suffix:semicolon
)brace
r_if
c_cond
(paren
id|block
op_ge
id|index
)paren
(brace
id|block
op_sub_assign
id|index
suffix:semicolon
id|newblock
op_assign
l_int|1
op_plus
(paren
id|block
op_div
(paren
id|sb-&gt;s_blocksize
op_div
r_sizeof
(paren
id|Uint32
)paren
)paren
)paren
suffix:semicolon
id|index
op_assign
id|block
op_mod
(paren
id|sb-&gt;s_blocksize
op_div
r_sizeof
(paren
id|Uint32
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|newblock
op_assign
l_int|0
suffix:semicolon
id|index
op_assign
id|UDF_SB_TYPEVIRT
c_func
(paren
id|sb
comma
id|partition
)paren
dot
id|s_start_offset
op_div
r_sizeof
(paren
id|Uint32
)paren
op_plus
id|block
suffix:semicolon
)brace
id|loc
op_assign
id|udf_locked_block_map
c_func
(paren
id|UDF_SB_VAT
c_func
(paren
id|sb
)paren
comma
id|newblock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bh
op_assign
id|bread
c_func
(paren
id|sb-&gt;s_dev
comma
id|loc
comma
id|sb-&gt;s_blocksize
)paren
)paren
)paren
(brace
id|udf_debug
c_func
(paren
l_string|&quot;get_pblock(UDF_VIRTUAL_MAP:%p,%d,%d) VAT: %d[%d]&bslash;n&quot;
comma
id|sb
comma
id|block
comma
id|partition
comma
id|loc
comma
id|index
)paren
suffix:semicolon
r_return
l_int|0xFFFFFFFF
suffix:semicolon
)brace
id|loc
op_assign
id|le32_to_cpu
c_func
(paren
(paren
(paren
id|Uint32
op_star
)paren
id|bh-&gt;b_data
)paren
(braket
id|index
)braket
)paren
suffix:semicolon
id|udf_release_data
c_func
(paren
id|bh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|UDF_I_LOCATION
c_func
(paren
id|UDF_SB_VAT
c_func
(paren
id|sb
)paren
)paren
dot
id|partitionReferenceNum
op_eq
id|partition
)paren
(brace
id|udf_debug
c_func
(paren
l_string|&quot;recursive call to udf_get_pblock!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0xFFFFFFFF
suffix:semicolon
)brace
r_return
id|udf_get_pblock
c_func
(paren
id|sb
comma
id|loc
comma
id|UDF_I_LOCATION
c_func
(paren
id|UDF_SB_VAT
c_func
(paren
id|sb
)paren
)paren
dot
id|partitionReferenceNum
comma
id|offset
)paren
suffix:semicolon
)brace
r_case
id|UDF_SPARABLE_MAP15
suffix:colon
(brace
id|Uint32
id|newblock
op_assign
id|UDF_SB_PARTROOT
c_func
(paren
id|sb
comma
id|partition
)paren
op_plus
id|block
op_plus
id|offset
suffix:semicolon
id|Uint32
id|spartable
op_assign
id|UDF_SB_TYPESPAR
c_func
(paren
id|sb
comma
id|partition
)paren
dot
id|s_spar_loc
suffix:semicolon
id|Uint32
id|plength
op_assign
id|UDF_SB_TYPESPAR
c_func
(paren
id|sb
comma
id|partition
)paren
dot
id|s_spar_plen
suffix:semicolon
id|Uint32
id|packet
op_assign
(paren
id|block
op_plus
id|offset
)paren
op_amp
(paren
op_complement
(paren
id|plength
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|SparingTable
op_star
id|st
suffix:semicolon
id|SparingEntry
op_star
id|se
suffix:semicolon
id|bh
op_assign
id|udf_read_tagged
c_func
(paren
id|sb
comma
id|spartable
comma
id|spartable
comma
op_amp
id|ident
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bh
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;udf: udf_read_tagged(%p,%d,%d)&bslash;n&quot;
comma
id|sb
comma
id|spartable
comma
id|spartable
)paren
suffix:semicolon
r_return
l_int|0xFFFFFFFF
suffix:semicolon
)brace
id|st
op_assign
(paren
r_struct
id|SparingTable
op_star
)paren
id|bh-&gt;b_data
suffix:semicolon
r_if
c_cond
(paren
id|ident
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|st-&gt;sparingIdent.ident
comma
id|UDF_ID_SPARING
comma
id|strlen
c_func
(paren
id|UDF_ID_SPARING
)paren
)paren
)paren
(brace
id|Uint16
id|rtl
op_assign
id|le16_to_cpu
c_func
(paren
id|st-&gt;reallocationTableLen
)paren
suffix:semicolon
id|Uint16
id|index
suffix:semicolon
multiline_comment|/* If the sparing table span multiple blocks, find out which block we are on */
id|se
op_assign
op_amp
(paren
id|st-&gt;mapEntry
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rtl
op_star
r_sizeof
(paren
id|SparingEntry
)paren
op_plus
r_sizeof
(paren
r_struct
id|SparingTable
)paren
OG
id|sb-&gt;s_blocksize
)paren
(brace
id|index
op_assign
(paren
id|sb-&gt;s_blocksize
op_minus
r_sizeof
(paren
r_struct
id|SparingTable
)paren
)paren
op_div
r_sizeof
(paren
id|SparingEntry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|se
(braket
id|index
op_minus
l_int|1
)braket
dot
id|origLocation
)paren
op_eq
id|packet
)paren
(brace
id|udf_release_data
c_func
(paren
id|bh
)paren
suffix:semicolon
r_return
id|le32_to_cpu
c_func
(paren
id|se
(braket
id|index
)braket
dot
id|mappedLocation
)paren
op_or
(paren
id|newblock
op_amp
(paren
id|plength
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|se
(braket
id|index
op_minus
l_int|1
)braket
dot
id|origLocation
)paren
OL
id|packet
)paren
(brace
r_do
(brace
id|udf_release_data
c_func
(paren
id|bh
)paren
suffix:semicolon
id|bh
op_assign
id|udf_tread
c_func
(paren
id|sb
comma
id|spartable
comma
id|sb-&gt;s_blocksize
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bh
)paren
r_return
l_int|0xFFFFFFFF
suffix:semicolon
id|se
op_assign
(paren
id|SparingEntry
op_star
)paren
id|bh-&gt;b_data
suffix:semicolon
id|spartable
op_increment
suffix:semicolon
id|rtl
op_sub_assign
id|index
suffix:semicolon
id|index
op_assign
id|sb-&gt;s_blocksize
op_div
r_sizeof
(paren
id|SparingEntry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|se
(braket
id|index
)braket
dot
id|origLocation
)paren
op_eq
id|packet
)paren
(brace
id|udf_release_data
c_func
(paren
id|bh
)paren
suffix:semicolon
r_return
id|le32_to_cpu
c_func
(paren
id|se
(braket
id|index
)braket
dot
id|mappedLocation
)paren
op_or
(paren
id|newblock
op_amp
(paren
id|plength
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|rtl
op_star
r_sizeof
(paren
id|SparingEntry
)paren
OG
id|sb-&gt;s_blocksize
op_logical_and
id|le32_to_cpu
c_func
(paren
id|se
(braket
id|index
op_minus
l_int|1
)braket
dot
id|origLocation
)paren
OL
id|packet
)paren
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|index
op_assign
l_int|0
suffix:semicolon
id|index
OL
id|rtl
suffix:semicolon
id|index
op_increment
)paren
(brace
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|se
(braket
id|index
)braket
dot
id|origLocation
)paren
op_eq
id|packet
)paren
(brace
id|udf_release_data
c_func
(paren
id|bh
)paren
suffix:semicolon
r_return
id|le32_to_cpu
c_func
(paren
id|se
(braket
id|index
)braket
dot
id|mappedLocation
)paren
op_or
(paren
id|newblock
op_amp
(paren
id|plength
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|se
(braket
id|index
)braket
dot
id|origLocation
)paren
OG
id|packet
)paren
(brace
id|udf_release_data
c_func
(paren
id|bh
)paren
suffix:semicolon
r_return
id|newblock
suffix:semicolon
)brace
)brace
id|udf_release_data
c_func
(paren
id|bh
)paren
suffix:semicolon
r_return
id|newblock
suffix:semicolon
)brace
)brace
id|udf_release_data
c_func
(paren
id|bh
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0xFFFFFFFF
suffix:semicolon
)brace
DECL|function|udf_get_lb_pblock
r_extern
id|Uint32
id|udf_get_lb_pblock
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
id|lb_addr
id|loc
comma
id|Uint32
id|offset
)paren
(brace
r_return
id|udf_get_pblock
c_func
(paren
id|sb
comma
id|loc.logicalBlockNum
comma
id|loc.partitionReferenceNum
comma
id|offset
)paren
suffix:semicolon
)brace
eof
