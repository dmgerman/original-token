multiline_comment|/*&n; * lowlevel.c&n; *&n; * PURPOSE&n; *  Low Level Device Routines for the UDF filesystem&n; *&n; * CONTACTS&n; *&t;E-mail regarding any portion of the Linux UDF file system should be&n; *&t;directed to the development team mailing list (run by majordomo):&n; *&t;&t;linux_udf@hootie.lvld.hp.com&n; *&n; * COPYRIGHT&n; *&t;This file is distributed under the terms of the GNU General Public&n; *&t;License (GPL). Copies of the GPL can be obtained from:&n; *&t;&t;ftp://prep.ai.mit.edu/pub/gnu/GPL&n; *&t;Each contributing author retains all rights to their own work.&n; *&n; *  (C) 1999-2000 Ben Fennema&n; *&n; * HISTORY&n; *&n; *  03/26/99 blf  Created.&n; */
macro_line|#include &quot;udfdecl.h&quot;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/cdrom.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;scsi/scsi.h&gt;
DECL|typedef|Scsi_Device
r_typedef
r_struct
id|scsi_device
id|Scsi_Device
suffix:semicolon
DECL|typedef|Scsi_Cmnd
r_typedef
r_struct
id|scsi_cmnd
id|Scsi_Cmnd
suffix:semicolon
macro_line|#include &lt;scsi/scsi_ioctl.h&gt;
macro_line|#include &lt;linux/udf_fs.h&gt;
macro_line|#include &quot;udf_sb.h&quot;
r_int
r_int
DECL|function|udf_get_last_session
id|udf_get_last_session
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_struct
id|cdrom_multisession
id|ms_info
suffix:semicolon
r_int
r_int
id|vol_desc_start
suffix:semicolon
r_struct
id|block_device
op_star
id|bdev
op_assign
id|sb-&gt;s_bdev
suffix:semicolon
r_int
id|i
suffix:semicolon
id|vol_desc_start
op_assign
l_int|0
suffix:semicolon
id|ms_info.addr_format
op_assign
id|CDROM_LBA
suffix:semicolon
id|i
op_assign
id|ioctl_by_bdev
c_func
(paren
id|bdev
comma
id|CDROMMULTISESSION
comma
(paren
r_int
r_int
)paren
op_amp
id|ms_info
)paren
suffix:semicolon
DECL|macro|WE_OBEY_THE_WRITTEN_STANDARDS
mdefine_line|#define WE_OBEY_THE_WRITTEN_STANDARDS 1
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
(brace
id|udf_debug
c_func
(paren
l_string|&quot;XA disk: %s, vol_desc_start=%d&bslash;n&quot;
comma
(paren
id|ms_info.xa_flag
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
)paren
comma
id|ms_info.addr.lba
)paren
suffix:semicolon
macro_line|#if WE_OBEY_THE_WRITTEN_STANDARDS
r_if
c_cond
(paren
id|ms_info.xa_flag
)paren
multiline_comment|/* necessary for a valid ms_info.addr */
macro_line|#endif
id|vol_desc_start
op_assign
id|ms_info.addr.lba
suffix:semicolon
)brace
r_else
(brace
id|udf_debug
c_func
(paren
l_string|&quot;CDROMMULTISESSION not supported: rc=%d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
r_return
id|vol_desc_start
suffix:semicolon
)brace
r_int
r_int
DECL|function|udf_get_last_block
id|udf_get_last_block
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_struct
id|block_device
op_star
id|bdev
op_assign
id|sb-&gt;s_bdev
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_int
r_int
id|lblock
op_assign
l_int|0
suffix:semicolon
id|ret
op_assign
id|ioctl_by_bdev
c_func
(paren
id|bdev
comma
id|CDROM_LAST_WRITTEN
comma
(paren
r_int
r_int
)paren
op_amp
id|lblock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
multiline_comment|/* Hard Disk */
(brace
id|ret
op_assign
id|ioctl_by_bdev
c_func
(paren
id|bdev
comma
id|BLKGETSIZE
comma
(paren
r_int
r_int
)paren
op_amp
id|lblock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
op_logical_and
id|lblock
op_ne
l_int|0x7FFFFFFF
)paren
id|lblock
op_assign
(paren
(paren
l_int|512
op_star
id|lblock
)paren
op_div
id|sb-&gt;s_blocksize
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ret
op_logical_and
id|lblock
)paren
r_return
id|lblock
op_minus
l_int|1
suffix:semicolon
r_else
r_return
l_int|0
suffix:semicolon
)brace
eof
