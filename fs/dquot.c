multiline_comment|/*&n; * Implementation of the diskquota system for the LINUX operating&n; * system. QUOTA is implemented using the BSD systemcall interface as&n; * the means of communication with the user level. Currently only the&n; * ext2-filesystem has support for diskquotas. Other filesystems may&n; * be added in future time. This file contains the generic routines&n; * called by the different filesystems on allocation of an inode or&n; * block. These routines take care of the administration needed to&n; * have a consistent diskquota tracking system. The ideas of both&n; * user and group quotas are based on the Melbourne quota system as&n; * used on BSD derived systems. The internal implementation is &n; * based on the LINUX inode-subsystem with added complexity of the&n; * diskquota system. This implementation is not based on any BSD&n; * kernel sourcecode.&n; * &n; * Version: $Id: dquot.c,v 5.6 1995/11/15 20:30:27 mvw Exp mvw $&n; * &n; * Author:  Marco van Wieringen &lt;mvw@mcs.ow.nl&gt; &lt;mvw@tnix.net&gt;&n; * &n; * Fixes:   Dmitry Gorodchanin &lt;begemot@bgm.rosprint.net&gt;, 11 Feb 96&n; *&t;    removed race conditions in dqput(), dqget() and iput(). &n; *&n; * (C) Copyright 1994, 1995 Marco van Wieringen &n; *&n; */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/mount.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
DECL|macro|__DQUOT_VERSION__
mdefine_line|#define __DQUOT_VERSION__&t;&quot;dquot_5.6.0&quot;
DECL|variable|quotamessage
r_static
r_char
id|quotamessage
(braket
id|MAX_QUOTA_MESSAGE
)braket
suffix:semicolon
DECL|variable|quotatypes
r_static
r_char
op_star
id|quotatypes
(braket
)braket
op_assign
id|INITQFNAMES
suffix:semicolon
DECL|variable|nr_dquots
DECL|variable|nr_free_dquots
r_static
r_int
id|nr_dquots
op_assign
l_int|0
comma
id|nr_free_dquots
op_assign
l_int|0
suffix:semicolon
DECL|variable|hash_table
r_static
r_struct
id|dquot
op_star
id|hash_table
(braket
id|NR_DQHASH
)braket
suffix:semicolon
DECL|variable|first_dquot
r_static
r_struct
id|dquot
op_star
id|first_dquot
suffix:semicolon
DECL|variable|dqstats
r_static
r_struct
id|dqstats
id|dqstats
suffix:semicolon
DECL|variable|dquot_wait
r_static
r_struct
id|wait_queue
op_star
id|dquot_wait
op_assign
(paren
r_struct
id|wait_queue
op_star
)paren
l_int|NULL
suffix:semicolon
r_extern
r_void
id|add_dquot_ref
c_func
(paren
id|kdev_t
id|dev
comma
r_int
id|type
)paren
suffix:semicolon
r_extern
r_void
id|reset_dquot_ptrs
c_func
(paren
id|kdev_t
id|dev
comma
r_int
id|type
)paren
suffix:semicolon
macro_line|#ifndef min
DECL|macro|min
mdefine_line|#define min(a,b) ((a) &lt; (b)) ? (a) : (b)
macro_line|#endif
multiline_comment|/*&n; * Functions for management of the hashlist.&n; */
DECL|function|hashfn
r_static
r_inline
r_int
r_const
id|hashfn
c_func
(paren
id|kdev_t
id|dev
comma
r_int
r_int
id|id
comma
r_int
id|type
)paren
(brace
r_return
(paren
(paren
id|HASHDEV
c_func
(paren
id|dev
)paren
op_xor
id|id
)paren
op_star
(paren
id|MAXQUOTAS
op_minus
id|type
)paren
)paren
op_mod
id|NR_DQHASH
suffix:semicolon
)brace
DECL|function|hash
r_static
r_inline
r_struct
id|dquot
op_star
op_star
r_const
id|hash
c_func
(paren
id|kdev_t
id|dev
comma
r_int
r_int
id|id
comma
r_int
id|type
)paren
(brace
r_return
id|hash_table
op_plus
id|hashfn
c_func
(paren
id|dev
comma
id|id
comma
id|type
)paren
suffix:semicolon
)brace
DECL|function|has_quota_enabled
r_static
r_inline
r_int
id|has_quota_enabled
c_func
(paren
id|kdev_t
id|dev
comma
r_int
id|type
)paren
(brace
r_struct
id|vfsmount
op_star
id|vfsmnt
suffix:semicolon
r_return
(paren
id|vfsmnt
op_assign
id|lookup_vfsmnt
c_func
(paren
id|dev
)paren
)paren
op_ne
(paren
r_struct
id|vfsmount
op_star
)paren
l_int|NULL
op_logical_and
(paren
id|vfsmnt-&gt;mnt_quotas
(braket
id|type
)braket
op_ne
(paren
r_struct
id|file
op_star
)paren
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|insert_dquot_free
r_static
r_void
id|insert_dquot_free
c_func
(paren
r_struct
id|dquot
op_star
id|dquot
)paren
(brace
id|dquot-&gt;dq_next
op_assign
id|first_dquot
suffix:semicolon
id|dquot-&gt;dq_prev
op_assign
id|first_dquot-&gt;dq_prev
suffix:semicolon
id|dquot-&gt;dq_next-&gt;dq_prev
op_assign
id|dquot
suffix:semicolon
id|dquot-&gt;dq_prev-&gt;dq_next
op_assign
id|dquot
suffix:semicolon
id|first_dquot
op_assign
id|dquot
suffix:semicolon
)brace
DECL|function|remove_dquot_free
r_static
r_void
id|remove_dquot_free
c_func
(paren
r_struct
id|dquot
op_star
id|dquot
)paren
(brace
r_if
c_cond
(paren
id|first_dquot
op_eq
id|dquot
)paren
id|first_dquot
op_assign
id|first_dquot-&gt;dq_next
suffix:semicolon
r_if
c_cond
(paren
id|dquot-&gt;dq_next
)paren
id|dquot-&gt;dq_next-&gt;dq_prev
op_assign
id|dquot-&gt;dq_prev
suffix:semicolon
r_if
c_cond
(paren
id|dquot-&gt;dq_prev
)paren
id|dquot-&gt;dq_prev-&gt;dq_next
op_assign
id|dquot-&gt;dq_next
suffix:semicolon
id|dquot-&gt;dq_next
op_assign
id|dquot-&gt;dq_prev
op_assign
id|NODQUOT
suffix:semicolon
)brace
DECL|function|insert_dquot_hash
r_static
r_void
id|insert_dquot_hash
c_func
(paren
r_struct
id|dquot
op_star
id|dquot
)paren
(brace
r_struct
id|dquot
op_star
op_star
id|hash_ent
suffix:semicolon
id|hash_ent
op_assign
id|hash
c_func
(paren
id|dquot-&gt;dq_dev
comma
id|dquot-&gt;dq_id
comma
id|dquot-&gt;dq_type
)paren
suffix:semicolon
id|dquot-&gt;dq_hash_next
op_assign
op_star
id|hash_ent
suffix:semicolon
id|dquot-&gt;dq_hash_prev
op_assign
id|NODQUOT
suffix:semicolon
r_if
c_cond
(paren
id|dquot-&gt;dq_hash_next
)paren
id|dquot-&gt;dq_hash_next-&gt;dq_hash_prev
op_assign
id|dquot
suffix:semicolon
op_star
id|hash_ent
op_assign
id|dquot
suffix:semicolon
)brace
DECL|function|remove_dquot_hash
r_static
r_void
id|remove_dquot_hash
c_func
(paren
r_struct
id|dquot
op_star
id|dquot
)paren
(brace
r_struct
id|dquot
op_star
op_star
id|hash_ent
suffix:semicolon
id|hash_ent
op_assign
id|hash
c_func
(paren
id|dquot-&gt;dq_dev
comma
id|dquot-&gt;dq_id
comma
id|dquot-&gt;dq_type
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|hash_ent
op_eq
id|dquot
)paren
op_star
id|hash_ent
op_assign
id|dquot-&gt;dq_hash_next
suffix:semicolon
r_if
c_cond
(paren
id|dquot-&gt;dq_hash_next
)paren
id|dquot-&gt;dq_hash_next-&gt;dq_hash_prev
op_assign
id|dquot-&gt;dq_hash_prev
suffix:semicolon
r_if
c_cond
(paren
id|dquot-&gt;dq_hash_prev
)paren
id|dquot-&gt;dq_hash_prev-&gt;dq_hash_next
op_assign
id|dquot-&gt;dq_hash_next
suffix:semicolon
id|dquot-&gt;dq_hash_prev
op_assign
id|dquot-&gt;dq_hash_next
op_assign
id|NODQUOT
suffix:semicolon
)brace
DECL|function|put_last_free
r_static
r_void
id|put_last_free
c_func
(paren
r_struct
id|dquot
op_star
id|dquot
)paren
(brace
id|remove_dquot_free
c_func
(paren
id|dquot
)paren
suffix:semicolon
id|dquot-&gt;dq_prev
op_assign
id|first_dquot-&gt;dq_prev
suffix:semicolon
id|dquot-&gt;dq_prev-&gt;dq_next
op_assign
id|dquot
suffix:semicolon
id|dquot-&gt;dq_next
op_assign
id|first_dquot
suffix:semicolon
id|dquot-&gt;dq_next-&gt;dq_prev
op_assign
id|dquot
suffix:semicolon
)brace
DECL|function|grow_dquots
r_static
r_void
id|grow_dquots
c_func
(paren
r_void
)paren
(brace
r_struct
id|dquot
op_star
id|dquot
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dquot
op_assign
(paren
r_struct
id|dquot
op_star
)paren
id|get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
)paren
)paren
r_return
suffix:semicolon
id|dqstats.pages_allocated
op_increment
suffix:semicolon
id|cnt
op_assign
id|PAGE_SIZE
op_div
r_sizeof
(paren
r_struct
id|dquot
)paren
suffix:semicolon
id|nr_dquots
op_add_assign
id|cnt
suffix:semicolon
id|nr_free_dquots
op_add_assign
id|cnt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|first_dquot
)paren
(brace
id|dquot-&gt;dq_next
op_assign
id|dquot-&gt;dq_prev
op_assign
id|first_dquot
op_assign
id|dquot
op_increment
suffix:semicolon
id|cnt
op_decrement
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
id|cnt
suffix:semicolon
id|cnt
op_decrement
)paren
id|insert_dquot_free
c_func
(paren
id|dquot
op_increment
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Functions for locking and waiting on dquots.&n; */
DECL|function|__wait_on_dquot
r_static
r_void
id|__wait_on_dquot
c_func
(paren
r_struct
id|dquot
op_star
id|dquot
)paren
(brace
r_struct
id|wait_queue
id|wait
op_assign
(brace
id|current
comma
l_int|NULL
)brace
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|dquot-&gt;dq_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|repeat
suffix:colon
id|current-&gt;state
op_assign
id|TASK_UNINTERRUPTIBLE
suffix:semicolon
r_if
c_cond
(paren
id|dquot-&gt;dq_flags
op_amp
id|DQ_LOCKED
)paren
(brace
id|dquot-&gt;dq_flags
op_or_assign
id|DQ_WANT
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_goto
id|repeat
suffix:semicolon
)brace
id|remove_wait_queue
c_func
(paren
op_amp
id|dquot-&gt;dq_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
)brace
DECL|function|wait_on_dquot
r_static
r_inline
r_void
id|wait_on_dquot
c_func
(paren
r_struct
id|dquot
op_star
id|dquot
)paren
(brace
r_if
c_cond
(paren
id|dquot-&gt;dq_flags
op_amp
id|DQ_LOCKED
)paren
id|__wait_on_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
)brace
DECL|function|lock_dquot
r_static
r_inline
r_void
id|lock_dquot
c_func
(paren
r_struct
id|dquot
op_star
id|dquot
)paren
(brace
id|wait_on_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
id|dquot-&gt;dq_flags
op_or_assign
id|DQ_LOCKED
suffix:semicolon
)brace
DECL|function|unlock_dquot
r_static
r_inline
r_void
id|unlock_dquot
c_func
(paren
r_struct
id|dquot
op_star
id|dquot
)paren
(brace
id|dquot-&gt;dq_flags
op_and_assign
op_complement
id|DQ_LOCKED
suffix:semicolon
r_if
c_cond
(paren
id|dquot-&gt;dq_flags
op_amp
id|DQ_WANT
)paren
(brace
id|dquot-&gt;dq_flags
op_and_assign
op_complement
id|DQ_WANT
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|dquot-&gt;dq_wait
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Note that we don&squot;t want to disturb any wait-queues when we discard&n; * an dquot.&n; *&n; * FIXME: As soon as we have a nice solution for the inode problem we&n; *&t;&t;  can also fix this one. I.e. the volatile part.&n; */
DECL|function|clear_dquot
r_static
r_void
id|clear_dquot
c_func
(paren
r_struct
id|dquot
op_star
id|dquot
)paren
(brace
r_struct
id|wait_queue
op_star
id|wait
suffix:semicolon
id|wait_on_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
id|remove_dquot_hash
c_func
(paren
id|dquot
)paren
suffix:semicolon
id|remove_dquot_free
c_func
(paren
id|dquot
)paren
suffix:semicolon
id|wait
op_assign
(paren
(paren
r_volatile
r_struct
id|dquot
op_star
)paren
id|dquot
)paren
op_member_access_from_pointer
id|dq_wait
suffix:semicolon
r_if
c_cond
(paren
id|dquot-&gt;dq_count
)paren
id|nr_free_dquots
op_increment
suffix:semicolon
id|memset
c_func
(paren
id|dquot
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|dquot
)paren
)paren
suffix:semicolon
(paren
(paren
r_volatile
r_struct
id|dquot
op_star
)paren
id|dquot
)paren
op_member_access_from_pointer
id|dq_wait
op_assign
id|wait
suffix:semicolon
id|insert_dquot_free
c_func
(paren
id|dquot
)paren
suffix:semicolon
)brace
DECL|function|write_dquot
r_static
r_void
id|write_dquot
c_func
(paren
r_struct
id|dquot
op_star
id|dquot
)paren
(brace
r_int
id|type
op_assign
id|dquot-&gt;dq_type
suffix:semicolon
r_struct
id|file
op_star
id|filp
op_assign
id|dquot-&gt;dq_mnt-&gt;mnt_quotas
(braket
id|type
)braket
suffix:semicolon
r_int
r_int
id|fs
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dquot-&gt;dq_flags
op_amp
id|DQ_MOD
)paren
op_logical_or
(paren
id|filp
op_eq
(paren
r_struct
id|file
op_star
)paren
l_int|NULL
)paren
)paren
r_return
suffix:semicolon
id|lock_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dquot-&gt;dq_mnt-&gt;mnt_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|filp-&gt;f_op-&gt;lseek
)paren
(brace
r_if
c_cond
(paren
id|filp-&gt;f_op
op_member_access_from_pointer
id|lseek
c_func
(paren
id|filp-&gt;f_inode
comma
id|filp
comma
id|dqoff
c_func
(paren
id|dquot-&gt;dq_id
)paren
comma
l_int|0
)paren
op_ne
id|dqoff
c_func
(paren
id|dquot-&gt;dq_id
)paren
)paren
(brace
id|up
c_func
(paren
op_amp
id|dquot-&gt;dq_mnt-&gt;mnt_sem
)paren
suffix:semicolon
id|unlock_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_else
id|filp-&gt;f_pos
op_assign
id|dqoff
c_func
(paren
id|dquot-&gt;dq_id
)paren
suffix:semicolon
id|fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|KERNEL_DS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|filp-&gt;f_op
op_member_access_from_pointer
id|write
c_func
(paren
id|filp-&gt;f_inode
comma
id|filp
comma
(paren
r_char
op_star
)paren
op_amp
id|dquot-&gt;dq_dqb
comma
r_sizeof
(paren
r_struct
id|dqblk
)paren
)paren
op_eq
r_sizeof
(paren
r_struct
id|dqblk
)paren
)paren
id|dquot-&gt;dq_flags
op_and_assign
op_complement
id|DQ_MOD
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dquot-&gt;dq_mnt-&gt;mnt_sem
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
id|unlock_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
id|dqstats.writes
op_increment
suffix:semicolon
)brace
DECL|function|read_dquot
r_static
r_void
id|read_dquot
c_func
(paren
r_struct
id|dquot
op_star
id|dquot
)paren
(brace
r_int
id|type
op_assign
id|dquot-&gt;dq_type
suffix:semicolon
r_struct
id|file
op_star
id|filp
op_assign
id|dquot-&gt;dq_mnt-&gt;mnt_quotas
(braket
id|type
)braket
suffix:semicolon
r_int
r_int
id|fs
suffix:semicolon
r_if
c_cond
(paren
id|filp
op_eq
(paren
r_struct
id|file
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
id|lock_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dquot-&gt;dq_mnt-&gt;mnt_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|filp-&gt;f_op-&gt;lseek
)paren
(brace
r_if
c_cond
(paren
id|filp-&gt;f_op
op_member_access_from_pointer
id|lseek
c_func
(paren
id|filp-&gt;f_inode
comma
id|filp
comma
id|dqoff
c_func
(paren
id|dquot-&gt;dq_id
)paren
comma
l_int|0
)paren
op_ne
id|dqoff
c_func
(paren
id|dquot-&gt;dq_id
)paren
)paren
(brace
id|up
c_func
(paren
op_amp
id|dquot-&gt;dq_mnt-&gt;mnt_sem
)paren
suffix:semicolon
id|unlock_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_else
id|filp-&gt;f_pos
op_assign
id|dqoff
c_func
(paren
id|dquot-&gt;dq_id
)paren
suffix:semicolon
id|fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|KERNEL_DS
)paren
suffix:semicolon
id|filp-&gt;f_op
op_member_access_from_pointer
id|read
c_func
(paren
id|filp-&gt;f_inode
comma
id|filp
comma
(paren
r_char
op_star
)paren
op_amp
id|dquot-&gt;dq_dqb
comma
r_sizeof
(paren
r_struct
id|dqblk
)paren
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dquot-&gt;dq_mnt-&gt;mnt_sem
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dquot-&gt;dq_bhardlimit
op_eq
l_int|0
op_logical_and
id|dquot-&gt;dq_bsoftlimit
op_eq
l_int|0
op_logical_and
id|dquot-&gt;dq_ihardlimit
op_eq
l_int|0
op_logical_and
id|dquot-&gt;dq_isoftlimit
op_eq
l_int|0
)paren
id|dquot-&gt;dq_flags
op_or_assign
id|DQ_FAKE
suffix:semicolon
id|unlock_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
id|dqstats.reads
op_increment
suffix:semicolon
)brace
DECL|function|sync_dquots
r_int
id|sync_dquots
c_func
(paren
id|kdev_t
id|dev
comma
r_int
id|type
)paren
(brace
r_struct
id|dquot
op_star
id|dquot
op_assign
id|first_dquot
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dqstats.syncs
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nr_dquots
op_star
l_int|2
suffix:semicolon
id|i
op_increment
comma
id|dquot
op_assign
id|dquot-&gt;dq_next
)paren
(brace
r_if
c_cond
(paren
id|dev
op_eq
id|NODEV
op_logical_or
id|dquot-&gt;dq_count
op_eq
l_int|0
op_logical_or
id|dquot-&gt;dq_dev
op_ne
id|dev
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|type
op_ne
op_minus
l_int|1
op_logical_and
id|dquot-&gt;dq_type
op_ne
id|type
)paren
r_continue
suffix:semicolon
id|wait_on_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dquot-&gt;dq_flags
op_amp
id|DQ_MOD
)paren
id|write_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Trash the cache for a certain type on a device.&n; */
DECL|function|invalidate_dquots
r_void
id|invalidate_dquots
c_func
(paren
id|kdev_t
id|dev
comma
r_int
id|type
)paren
(brace
r_struct
id|dquot
op_star
id|dquot
comma
op_star
id|next
suffix:semicolon
r_int
id|cnt
suffix:semicolon
id|next
op_assign
id|first_dquot
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
id|nr_dquots
suffix:semicolon
id|cnt
OG
l_int|0
suffix:semicolon
id|cnt
op_decrement
)paren
(brace
id|dquot
op_assign
id|next
suffix:semicolon
id|next
op_assign
id|dquot-&gt;dq_next
suffix:semicolon
r_if
c_cond
(paren
id|dquot-&gt;dq_dev
op_ne
id|dev
op_logical_or
id|dquot-&gt;dq_type
op_ne
id|type
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|dquot-&gt;dq_flags
op_amp
id|DQ_LOCKED
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;VFS: dquot busy on removed device %s&bslash;n&quot;
comma
id|kdevname
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dquot-&gt;dq_flags
op_amp
id|DQ_MOD
)paren
id|write_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
id|dqstats.drops
op_increment
suffix:semicolon
id|clear_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
)brace
)brace
DECL|function|dquot_incr_inodes
r_static
r_inline
r_void
id|dquot_incr_inodes
c_func
(paren
r_struct
id|dquot
op_star
id|dquot
comma
r_int
r_int
id|number
)paren
(brace
id|lock_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
id|dquot-&gt;dq_curinodes
op_add_assign
id|number
suffix:semicolon
id|dquot-&gt;dq_flags
op_or_assign
id|DQ_MOD
suffix:semicolon
id|unlock_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
)brace
DECL|function|dquot_incr_blocks
r_static
r_inline
r_void
id|dquot_incr_blocks
c_func
(paren
r_struct
id|dquot
op_star
id|dquot
comma
r_int
r_int
id|number
)paren
(brace
id|lock_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
id|dquot-&gt;dq_curblocks
op_add_assign
id|number
suffix:semicolon
id|dquot-&gt;dq_flags
op_or_assign
id|DQ_MOD
suffix:semicolon
id|unlock_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
)brace
DECL|function|dquot_decr_inodes
r_static
r_inline
r_void
id|dquot_decr_inodes
c_func
(paren
r_struct
id|dquot
op_star
id|dquot
comma
r_int
r_int
id|number
)paren
(brace
id|lock_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dquot-&gt;dq_curinodes
OG
id|number
)paren
id|dquot-&gt;dq_curinodes
op_sub_assign
id|number
suffix:semicolon
r_else
id|dquot-&gt;dq_curinodes
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dquot-&gt;dq_curinodes
OL
id|dquot-&gt;dq_isoftlimit
)paren
id|dquot-&gt;dq_itime
op_assign
(paren
id|time_t
)paren
l_int|0
suffix:semicolon
id|dquot-&gt;dq_flags
op_and_assign
op_complement
id|DQ_INODES
suffix:semicolon
id|dquot-&gt;dq_flags
op_or_assign
id|DQ_MOD
suffix:semicolon
id|unlock_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
)brace
DECL|function|dquot_decr_blocks
r_static
r_inline
r_void
id|dquot_decr_blocks
c_func
(paren
r_struct
id|dquot
op_star
id|dquot
comma
r_int
r_int
id|number
)paren
(brace
id|lock_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dquot-&gt;dq_curblocks
OG
id|number
)paren
id|dquot-&gt;dq_curblocks
op_sub_assign
id|number
suffix:semicolon
r_else
id|dquot-&gt;dq_curblocks
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dquot-&gt;dq_curblocks
OL
id|dquot-&gt;dq_bsoftlimit
)paren
id|dquot-&gt;dq_btime
op_assign
(paren
id|time_t
)paren
l_int|0
suffix:semicolon
id|dquot-&gt;dq_flags
op_and_assign
op_complement
id|DQ_BLKS
suffix:semicolon
id|dquot-&gt;dq_flags
op_or_assign
id|DQ_MOD
suffix:semicolon
id|unlock_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
)brace
DECL|function|need_print_warning
r_static
r_inline
r_int
id|need_print_warning
c_func
(paren
r_int
id|type
comma
r_struct
id|dquot
op_star
id|dquot
)paren
(brace
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|USRQUOTA
suffix:colon
r_return
id|current-&gt;fsuid
op_eq
id|dquot-&gt;dq_id
suffix:semicolon
r_case
id|GRPQUOTA
suffix:colon
r_return
id|current-&gt;fsgid
op_eq
id|dquot-&gt;dq_id
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|check_idq
r_static
r_int
id|check_idq
c_func
(paren
r_struct
id|dquot
op_star
id|dquot
comma
r_int
id|type
comma
id|u_long
r_int
id|inodes
)paren
(brace
r_if
c_cond
(paren
id|inodes
op_le
l_int|0
op_logical_or
id|dquot-&gt;dq_flags
op_amp
id|DQ_FAKE
)paren
r_return
id|QUOTA_OK
suffix:semicolon
r_if
c_cond
(paren
id|dquot-&gt;dq_ihardlimit
op_logical_and
(paren
id|dquot-&gt;dq_curinodes
op_plus
id|inodes
)paren
OG
id|dquot-&gt;dq_ihardlimit
op_logical_and
op_logical_neg
id|fsuser
c_func
(paren
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|dquot-&gt;dq_flags
op_amp
id|DQ_INODES
)paren
op_eq
l_int|0
op_logical_and
id|need_print_warning
c_func
(paren
id|type
comma
id|dquot
)paren
)paren
(brace
id|sprintf
c_func
(paren
id|quotamessage
comma
l_string|&quot;%s: write failed, %s file limit reached&bslash;r&bslash;n&quot;
comma
id|dquot-&gt;dq_mnt-&gt;mnt_dirname
comma
id|quotatypes
(braket
id|type
)braket
)paren
suffix:semicolon
id|tty_write_message
c_func
(paren
id|current-&gt;tty
comma
id|quotamessage
)paren
suffix:semicolon
id|dquot-&gt;dq_flags
op_or_assign
id|DQ_INODES
suffix:semicolon
)brace
r_return
id|NO_QUOTA
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dquot-&gt;dq_isoftlimit
op_logical_and
(paren
id|dquot-&gt;dq_curinodes
op_plus
id|inodes
)paren
OG
id|dquot-&gt;dq_isoftlimit
op_logical_and
id|dquot-&gt;dq_itime
op_logical_and
id|CURRENT_TIME
op_ge
id|dquot-&gt;dq_itime
op_logical_and
op_logical_neg
id|fsuser
c_func
(paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|need_print_warning
c_func
(paren
id|type
comma
id|dquot
)paren
)paren
(brace
id|sprintf
c_func
(paren
id|quotamessage
comma
l_string|&quot;%s: warning, %s file quota exceeded too long.&bslash;r&bslash;n&quot;
comma
id|dquot-&gt;dq_mnt-&gt;mnt_dirname
comma
id|quotatypes
(braket
id|type
)braket
)paren
suffix:semicolon
id|tty_write_message
c_func
(paren
id|current-&gt;tty
comma
id|quotamessage
)paren
suffix:semicolon
)brace
r_return
id|NO_QUOTA
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dquot-&gt;dq_isoftlimit
op_logical_and
(paren
id|dquot-&gt;dq_curinodes
op_plus
id|inodes
)paren
OG
id|dquot-&gt;dq_isoftlimit
op_logical_and
id|dquot-&gt;dq_itime
op_eq
l_int|0
op_logical_and
op_logical_neg
id|fsuser
c_func
(paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|need_print_warning
c_func
(paren
id|type
comma
id|dquot
)paren
)paren
(brace
id|sprintf
c_func
(paren
id|quotamessage
comma
l_string|&quot;%s: warning, %s file quota exceeded&bslash;r&bslash;n&quot;
comma
id|dquot-&gt;dq_mnt-&gt;mnt_dirname
comma
id|quotatypes
(braket
id|type
)braket
)paren
suffix:semicolon
id|tty_write_message
c_func
(paren
id|current-&gt;tty
comma
id|quotamessage
)paren
suffix:semicolon
)brace
id|dquot-&gt;dq_itime
op_assign
id|CURRENT_TIME
op_plus
id|dquot-&gt;dq_mnt-&gt;mnt_iexp
(braket
id|type
)braket
suffix:semicolon
)brace
r_return
id|QUOTA_OK
suffix:semicolon
)brace
DECL|function|check_bdq
r_static
r_int
id|check_bdq
c_func
(paren
r_struct
id|dquot
op_star
id|dquot
comma
r_int
id|type
comma
id|u_long
id|blocks
)paren
(brace
r_if
c_cond
(paren
id|blocks
op_le
l_int|0
op_logical_or
id|dquot-&gt;dq_flags
op_amp
id|DQ_FAKE
)paren
r_return
id|QUOTA_OK
suffix:semicolon
r_if
c_cond
(paren
id|dquot-&gt;dq_bhardlimit
op_logical_and
(paren
id|dquot-&gt;dq_curblocks
op_plus
id|blocks
)paren
OG
id|dquot-&gt;dq_bhardlimit
op_logical_and
op_logical_neg
id|fsuser
c_func
(paren
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|dquot-&gt;dq_flags
op_amp
id|DQ_BLKS
)paren
op_eq
l_int|0
op_logical_and
id|need_print_warning
c_func
(paren
id|type
comma
id|dquot
)paren
)paren
(brace
id|sprintf
c_func
(paren
id|quotamessage
comma
l_string|&quot;%s: write failed, %s disk limit reached.&bslash;r&bslash;n&quot;
comma
id|dquot-&gt;dq_mnt-&gt;mnt_dirname
comma
id|quotatypes
(braket
id|type
)braket
)paren
suffix:semicolon
id|tty_write_message
c_func
(paren
id|current-&gt;tty
comma
id|quotamessage
)paren
suffix:semicolon
id|dquot-&gt;dq_flags
op_or_assign
id|DQ_BLKS
suffix:semicolon
)brace
r_return
id|NO_QUOTA
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dquot-&gt;dq_bsoftlimit
op_logical_and
(paren
id|dquot-&gt;dq_curblocks
op_plus
id|blocks
)paren
OG
id|dquot-&gt;dq_bsoftlimit
op_logical_and
id|dquot-&gt;dq_btime
op_logical_and
id|CURRENT_TIME
op_ge
id|dquot-&gt;dq_btime
op_logical_and
op_logical_neg
id|fsuser
c_func
(paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|need_print_warning
c_func
(paren
id|type
comma
id|dquot
)paren
)paren
(brace
id|sprintf
c_func
(paren
id|quotamessage
comma
l_string|&quot;%s: write failed, %s disk quota exceeded too long.&bslash;r&bslash;n&quot;
comma
id|dquot-&gt;dq_mnt-&gt;mnt_dirname
comma
id|quotatypes
(braket
id|type
)braket
)paren
suffix:semicolon
id|tty_write_message
c_func
(paren
id|current-&gt;tty
comma
id|quotamessage
)paren
suffix:semicolon
)brace
r_return
id|NO_QUOTA
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dquot-&gt;dq_bsoftlimit
op_logical_and
(paren
id|dquot-&gt;dq_curblocks
op_plus
id|blocks
)paren
OG
id|dquot-&gt;dq_bsoftlimit
op_logical_and
id|dquot-&gt;dq_btime
op_eq
l_int|0
op_logical_and
op_logical_neg
id|fsuser
c_func
(paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|need_print_warning
c_func
(paren
id|type
comma
id|dquot
)paren
)paren
(brace
id|sprintf
c_func
(paren
id|quotamessage
comma
l_string|&quot;%s: warning, %s disk quota exceeded&bslash;r&bslash;n&quot;
comma
id|dquot-&gt;dq_mnt-&gt;mnt_dirname
comma
id|quotatypes
(braket
id|type
)braket
)paren
suffix:semicolon
id|tty_write_message
c_func
(paren
id|current-&gt;tty
comma
id|quotamessage
)paren
suffix:semicolon
)brace
id|dquot-&gt;dq_btime
op_assign
id|CURRENT_TIME
op_plus
id|dquot-&gt;dq_mnt-&gt;mnt_bexp
(braket
id|type
)braket
suffix:semicolon
)brace
r_return
id|QUOTA_OK
suffix:semicolon
)brace
DECL|function|dqput
r_static
r_void
id|dqput
c_func
(paren
r_struct
id|dquot
op_star
id|dquot
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dquot
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t; * If the dq_mnt pointer isn&squot;t initialized this entry needs no&n;&t; * checking and doesn&squot;t need to be written. It just an empty&n;&t; * dquot that is put back into the freelist.&n;&t; */
r_if
c_cond
(paren
id|dquot-&gt;dq_mnt
op_ne
(paren
r_struct
id|vfsmount
op_star
)paren
l_int|NULL
)paren
(brace
id|dqstats.drops
op_increment
suffix:semicolon
id|wait_on_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dquot-&gt;dq_count
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;VFS: dqput: trying to free free dquot&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;VFS: device %s, dquot of %s %d&bslash;n&quot;
comma
id|kdevname
c_func
(paren
id|dquot-&gt;dq_dev
)paren
comma
id|quotatypes
(braket
id|dquot-&gt;dq_type
)braket
comma
id|dquot-&gt;dq_id
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|repeat
suffix:colon
r_if
c_cond
(paren
id|dquot-&gt;dq_count
OG
l_int|1
)paren
(brace
id|dquot-&gt;dq_count
op_decrement
suffix:semicolon
r_return
suffix:semicolon
)brace
id|wake_up
c_func
(paren
op_amp
id|dquot_wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dquot-&gt;dq_flags
op_amp
id|DQ_MOD
)paren
(brace
id|write_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
multiline_comment|/* we can sleep - so do again */
id|wait_on_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
r_goto
id|repeat
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|dquot-&gt;dq_count
)paren
(brace
id|dquot-&gt;dq_count
op_decrement
suffix:semicolon
id|nr_free_dquots
op_increment
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|get_empty_dquot
r_static
r_struct
id|dquot
op_star
id|get_empty_dquot
c_func
(paren
r_void
)paren
(brace
r_struct
id|dquot
op_star
id|dquot
comma
op_star
id|best
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_if
c_cond
(paren
id|nr_dquots
OL
id|NR_DQUOTS
op_logical_and
id|nr_free_dquots
OL
(paren
id|nr_dquots
op_rshift
l_int|2
)paren
)paren
id|grow_dquots
c_func
(paren
)paren
suffix:semicolon
id|repeat
suffix:colon
id|dquot
op_assign
id|first_dquot
suffix:semicolon
id|best
op_assign
id|NODQUOT
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|nr_dquots
suffix:semicolon
id|dquot
op_assign
id|dquot-&gt;dq_next
comma
id|cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dquot-&gt;dq_count
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|best
)paren
id|best
op_assign
id|dquot
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dquot-&gt;dq_flags
op_amp
id|DQ_MOD
)paren
op_logical_and
op_logical_neg
(paren
id|dquot-&gt;dq_flags
op_amp
id|DQ_LOCKED
)paren
)paren
(brace
id|best
op_assign
id|dquot
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|best
op_logical_or
id|best-&gt;dq_flags
op_amp
id|DQ_MOD
op_logical_or
id|best-&gt;dq_flags
op_amp
id|DQ_LOCKED
)paren
r_if
c_cond
(paren
id|nr_dquots
OL
id|NR_DQUOTS
)paren
(brace
id|grow_dquots
c_func
(paren
)paren
suffix:semicolon
r_goto
id|repeat
suffix:semicolon
)brace
id|dquot
op_assign
id|best
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dquot
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;VFS: No free dquots - contact mvw@mcs.ow.org&bslash;n&quot;
)paren
suffix:semicolon
id|sleep_on
c_func
(paren
op_amp
id|dquot_wait
)paren
suffix:semicolon
r_goto
id|repeat
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dquot-&gt;dq_flags
op_amp
id|DQ_LOCKED
)paren
(brace
id|wait_on_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
r_goto
id|repeat
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dquot-&gt;dq_flags
op_amp
id|DQ_MOD
)paren
(brace
id|write_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
r_goto
id|repeat
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dquot-&gt;dq_count
)paren
r_goto
id|repeat
suffix:semicolon
id|clear_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
id|dquot-&gt;dq_count
op_assign
l_int|1
suffix:semicolon
id|nr_free_dquots
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|nr_free_dquots
OL
l_int|0
)paren
(brace
id|printk
(paren
l_string|&quot;VFS: get_empty_dquot: bad free dquot count.&bslash;n&quot;
)paren
suffix:semicolon
id|nr_free_dquots
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|dquot
suffix:semicolon
)brace
DECL|function|dqget
r_static
r_struct
id|dquot
op_star
id|dqget
c_func
(paren
id|kdev_t
id|dev
comma
r_int
r_int
id|id
comma
r_int
id|type
)paren
(brace
r_struct
id|dquot
op_star
id|dquot
comma
op_star
id|empty
suffix:semicolon
r_struct
id|vfsmount
op_star
id|vfsmnt
suffix:semicolon
r_if
c_cond
(paren
(paren
id|vfsmnt
op_assign
id|lookup_vfsmnt
c_func
(paren
id|dev
)paren
)paren
op_eq
(paren
r_struct
id|vfsmount
op_star
)paren
l_int|NULL
op_logical_or
(paren
id|vfsmnt-&gt;mnt_quotas
(braket
id|type
)braket
op_eq
(paren
r_struct
id|file
op_star
)paren
l_int|0
)paren
)paren
r_return
id|NODQUOT
suffix:semicolon
id|dqstats.lookups
op_increment
suffix:semicolon
id|empty
op_assign
id|get_empty_dquot
c_func
(paren
)paren
suffix:semicolon
id|repeat
suffix:colon
id|dquot
op_assign
op_star
(paren
id|hash
c_func
(paren
id|dev
comma
id|id
comma
id|type
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|dquot
)paren
(brace
r_if
c_cond
(paren
id|dquot-&gt;dq_dev
op_ne
id|dev
op_logical_or
id|dquot-&gt;dq_id
op_ne
id|id
)paren
(brace
id|dquot
op_assign
id|dquot-&gt;dq_hash_next
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|wait_on_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dquot-&gt;dq_dev
op_ne
id|dev
op_logical_or
id|dquot-&gt;dq_id
op_ne
id|id
)paren
r_goto
id|repeat
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dquot-&gt;dq_count
)paren
id|nr_free_dquots
op_decrement
suffix:semicolon
id|dquot-&gt;dq_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|empty
)paren
id|dqput
c_func
(paren
id|empty
)paren
suffix:semicolon
id|dqstats.cache_hits
op_increment
suffix:semicolon
r_return
id|dquot
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|empty
)paren
r_return
id|NODQUOT
suffix:semicolon
id|dquot
op_assign
id|empty
suffix:semicolon
id|dquot-&gt;dq_id
op_assign
id|id
suffix:semicolon
id|dquot-&gt;dq_type
op_assign
id|type
suffix:semicolon
id|dquot-&gt;dq_dev
op_assign
id|dev
suffix:semicolon
id|dquot-&gt;dq_mnt
op_assign
id|vfsmnt
suffix:semicolon
id|put_last_free
c_func
(paren
id|dquot
)paren
suffix:semicolon
id|insert_dquot_hash
c_func
(paren
id|dquot
)paren
suffix:semicolon
id|read_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
r_return
id|dquot
suffix:semicolon
)brace
multiline_comment|/*&n; * Initialize a dquot-struct with new quota info. This is used by the&n; * systemcall interface functions.&n; */
DECL|function|set_dqblk
r_static
r_int
id|set_dqblk
c_func
(paren
id|kdev_t
id|dev
comma
r_int
id|id
comma
r_int
id|type
comma
r_int
id|flags
comma
r_struct
id|dqblk
op_star
id|dqblk
)paren
(brace
r_struct
id|dquot
op_star
id|dquot
suffix:semicolon
r_struct
id|dqblk
id|dq_dqblk
suffix:semicolon
r_int
id|error
suffix:semicolon
r_if
c_cond
(paren
id|dqblk
op_eq
(paren
r_struct
id|dqblk
op_star
)paren
l_int|NULL
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|QUOTA_SYSCALL
)paren
(brace
r_if
c_cond
(paren
(paren
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|dqblk
comma
r_sizeof
(paren
r_struct
id|dqblk
)paren
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|error
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
op_amp
id|dq_dqblk
comma
id|dqblk
comma
r_sizeof
(paren
r_struct
id|dqblk
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
op_amp
id|dq_dqblk
comma
id|dqblk
comma
r_sizeof
(paren
r_struct
id|dqblk
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|dquot
op_assign
id|dqget
c_func
(paren
id|dev
comma
id|id
comma
id|type
)paren
)paren
op_ne
id|NODQUOT
)paren
(brace
id|lock_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|id
OG
l_int|0
op_logical_and
(paren
(paren
id|flags
op_amp
id|SET_QUOTA
)paren
op_logical_or
(paren
id|flags
op_amp
id|SET_QLIMIT
)paren
)paren
)paren
(brace
id|dquot-&gt;dq_bhardlimit
op_assign
id|dq_dqblk.dqb_bhardlimit
suffix:semicolon
id|dquot-&gt;dq_bsoftlimit
op_assign
id|dq_dqblk.dqb_bsoftlimit
suffix:semicolon
id|dquot-&gt;dq_ihardlimit
op_assign
id|dq_dqblk.dqb_ihardlimit
suffix:semicolon
id|dquot-&gt;dq_isoftlimit
op_assign
id|dq_dqblk.dqb_isoftlimit
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|flags
op_amp
id|SET_QUOTA
)paren
op_logical_or
(paren
id|flags
op_amp
id|SET_USE
)paren
)paren
(brace
r_if
c_cond
(paren
id|dquot-&gt;dq_isoftlimit
op_logical_and
id|dquot-&gt;dq_curinodes
OL
id|dquot-&gt;dq_isoftlimit
op_logical_and
id|dq_dqblk.dqb_curinodes
op_ge
id|dquot-&gt;dq_isoftlimit
)paren
id|dquot-&gt;dq_itime
op_assign
id|CURRENT_TIME
op_plus
id|dquot-&gt;dq_mnt-&gt;mnt_iexp
(braket
id|type
)braket
suffix:semicolon
id|dquot-&gt;dq_curinodes
op_assign
id|dq_dqblk.dqb_curinodes
suffix:semicolon
r_if
c_cond
(paren
id|dquot-&gt;dq_curinodes
OL
id|dquot-&gt;dq_isoftlimit
)paren
id|dquot-&gt;dq_flags
op_and_assign
op_complement
id|DQ_INODES
suffix:semicolon
r_if
c_cond
(paren
id|dquot-&gt;dq_bsoftlimit
op_logical_and
id|dquot-&gt;dq_curblocks
OL
id|dquot-&gt;dq_bsoftlimit
op_logical_and
id|dq_dqblk.dqb_curblocks
op_ge
id|dquot-&gt;dq_bsoftlimit
)paren
id|dquot-&gt;dq_btime
op_assign
id|CURRENT_TIME
op_plus
id|dquot-&gt;dq_mnt-&gt;mnt_bexp
(braket
id|type
)braket
suffix:semicolon
id|dquot-&gt;dq_curblocks
op_assign
id|dq_dqblk.dqb_curblocks
suffix:semicolon
r_if
c_cond
(paren
id|dquot-&gt;dq_curblocks
OL
id|dquot-&gt;dq_bsoftlimit
)paren
id|dquot-&gt;dq_flags
op_and_assign
op_complement
id|DQ_BLKS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|id
op_eq
l_int|0
)paren
(brace
multiline_comment|/* &n;&t;&t;&t; * Change in expiretimes, change them in dq_mnt.&n;&t;&t;&t; */
id|dquot-&gt;dq_mnt-&gt;mnt_bexp
(braket
id|type
)braket
op_assign
id|dquot-&gt;dq_btime
op_assign
id|dq_dqblk.dqb_btime
suffix:semicolon
id|dquot-&gt;dq_mnt-&gt;mnt_iexp
(braket
id|type
)braket
op_assign
id|dquot-&gt;dq_itime
op_assign
id|dq_dqblk.dqb_itime
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dq_dqblk.dqb_bhardlimit
op_eq
l_int|0
op_logical_and
id|dq_dqblk.dqb_bsoftlimit
op_eq
l_int|0
op_logical_and
id|dq_dqblk.dqb_ihardlimit
op_eq
l_int|0
op_logical_and
id|dq_dqblk.dqb_isoftlimit
op_eq
l_int|0
)paren
id|dquot-&gt;dq_flags
op_or_assign
id|DQ_FAKE
suffix:semicolon
r_else
id|dquot-&gt;dq_flags
op_and_assign
op_complement
id|DQ_FAKE
suffix:semicolon
id|dquot-&gt;dq_flags
op_or_assign
id|DQ_MOD
suffix:semicolon
id|unlock_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
id|dqput
c_func
(paren
id|dquot
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|get_quota
r_static
r_int
id|get_quota
c_func
(paren
id|kdev_t
id|dev
comma
r_int
id|id
comma
r_int
id|type
comma
r_struct
id|dqblk
op_star
id|dqblk
)paren
(brace
r_struct
id|dquot
op_star
id|dquot
suffix:semicolon
r_int
id|error
suffix:semicolon
r_if
c_cond
(paren
id|has_quota_enabled
c_func
(paren
id|dev
comma
id|type
)paren
)paren
(brace
r_if
c_cond
(paren
id|dqblk
op_eq
(paren
r_struct
id|dqblk
op_star
)paren
l_int|NULL
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|dqblk
comma
r_sizeof
(paren
r_struct
id|dqblk
)paren
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|error
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dquot
op_assign
id|dqget
c_func
(paren
id|dev
comma
id|id
comma
id|type
)paren
)paren
op_ne
id|NODQUOT
)paren
(brace
id|memcpy_tofs
c_func
(paren
id|dqblk
comma
(paren
r_char
op_star
)paren
op_amp
id|dquot-&gt;dq_dqb
comma
r_sizeof
(paren
r_struct
id|dqblk
)paren
)paren
suffix:semicolon
id|dqput
c_func
(paren
id|dquot
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
op_minus
id|ESRCH
suffix:semicolon
)brace
DECL|function|get_stats
r_static
r_int
id|get_stats
c_func
(paren
id|caddr_t
id|addr
)paren
(brace
r_int
id|error
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|addr
comma
r_sizeof
(paren
r_struct
id|dqstats
)paren
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|error
suffix:semicolon
id|dqstats.allocated_dquots
op_assign
id|nr_dquots
suffix:semicolon
id|dqstats.free_dquots
op_assign
id|nr_free_dquots
suffix:semicolon
id|memcpy_tofs
c_func
(paren
id|addr
comma
(paren
id|caddr_t
)paren
op_amp
id|dqstats
comma
r_sizeof
(paren
r_struct
id|dqstats
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Initialize pointer in a inode to the right dquots.&n; */
DECL|function|dquot_initialize
r_void
id|dquot_initialize
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_int
id|type
)paren
(brace
r_int
r_int
id|id
op_assign
l_int|0
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_struct
id|dquot
op_star
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|S_ISREG
c_func
(paren
id|inode-&gt;i_mode
)paren
op_logical_or
id|S_ISDIR
c_func
(paren
id|inode-&gt;i_mode
)paren
op_logical_or
id|S_ISLNK
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
(brace
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|MAXQUOTAS
suffix:semicolon
id|cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
id|type
op_ne
op_minus
l_int|1
op_logical_and
id|cnt
op_ne
id|type
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|has_quota_enabled
c_func
(paren
id|inode-&gt;i_dev
comma
id|cnt
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|inode-&gt;i_dquot
(braket
id|cnt
)braket
op_eq
id|NODQUOT
)paren
(brace
r_switch
c_cond
(paren
id|cnt
)paren
(brace
r_case
id|USRQUOTA
suffix:colon
id|id
op_assign
id|inode-&gt;i_uid
suffix:semicolon
r_break
suffix:semicolon
r_case
id|GRPQUOTA
suffix:colon
id|id
op_assign
id|inode-&gt;i_gid
suffix:semicolon
r_break
suffix:semicolon
)brace
id|tmp
op_assign
id|dqget
c_func
(paren
id|inode-&gt;i_dev
comma
id|id
comma
id|cnt
)paren
suffix:semicolon
multiline_comment|/* We may sleep in dqget(), so check it again.&n;&t;&t;&t;&t; * &t;Dmitry Gorodchanin 02/11/96&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|inode-&gt;i_dquot
(braket
id|cnt
)braket
op_ne
id|NODQUOT
)paren
(brace
id|dqput
c_func
(paren
id|tmp
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|inode-&gt;i_dquot
(braket
id|cnt
)braket
op_assign
id|tmp
suffix:semicolon
id|inode-&gt;i_flags
op_or_assign
id|S_WRITE
suffix:semicolon
)brace
)brace
)brace
)brace
DECL|function|dquot_drop
r_void
id|dquot_drop
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
r_int
id|cnt
suffix:semicolon
r_struct
id|dquot
op_star
id|tmp
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|MAXQUOTAS
suffix:semicolon
id|cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
id|inode-&gt;i_dquot
(braket
id|cnt
)braket
op_eq
id|NODQUOT
)paren
r_continue
suffix:semicolon
multiline_comment|/* We can sleep at dqput(). So we must do it this way.&n;&t;&t; * &t;Dmitry Gorodchanin 02/11/96&n;&t;&t; */
id|tmp
op_assign
id|inode-&gt;i_dquot
(braket
id|cnt
)braket
suffix:semicolon
id|inode-&gt;i_dquot
(braket
id|cnt
)braket
op_assign
id|NODQUOT
suffix:semicolon
id|dqput
c_func
(paren
id|tmp
)paren
suffix:semicolon
)brace
id|inode-&gt;i_flags
op_and_assign
op_complement
id|S_WRITE
suffix:semicolon
)brace
multiline_comment|/*&n; * This is a simple algorithm that calculates the size of a file in blocks.&n; * This is only used on filesystems that do not have a i_blocks count.&n; */
DECL|function|isize_to_blocks
r_static
id|u_long
id|isize_to_blocks
c_func
(paren
r_int
id|isize
comma
r_int
id|blksize
)paren
(brace
id|u_long
id|blocks
suffix:semicolon
id|u_long
id|indirect
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|blksize
)paren
id|blksize
op_assign
id|BLOCK_SIZE
suffix:semicolon
id|blocks
op_assign
(paren
id|isize
op_div
id|blksize
)paren
op_plus
(paren
(paren
id|isize
op_mod
id|blksize
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|blocks
OG
l_int|10
)paren
(brace
id|indirect
op_assign
(paren
(paren
id|blocks
op_minus
l_int|11
)paren
op_rshift
l_int|8
)paren
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* single indirect blocks */
r_if
c_cond
(paren
id|blocks
OG
(paren
l_int|10
op_plus
l_int|256
)paren
)paren
(brace
id|indirect
op_add_assign
(paren
(paren
id|blocks
op_minus
l_int|267
)paren
op_rshift
l_int|16
)paren
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* double indirect blocks */
r_if
c_cond
(paren
id|blocks
OG
(paren
l_int|10
op_plus
l_int|256
op_plus
(paren
l_int|256
op_lshift
l_int|8
)paren
)paren
)paren
id|indirect
op_increment
suffix:semicolon
multiline_comment|/* triple indirect blocks */
)brace
id|blocks
op_add_assign
id|indirect
suffix:semicolon
)brace
r_return
id|blocks
suffix:semicolon
)brace
multiline_comment|/*&n; * Externally referenced functions through dquot_operations.&n; */
DECL|function|dquot_alloc_block
r_int
id|dquot_alloc_block
c_func
(paren
r_const
r_struct
id|inode
op_star
id|inode
comma
r_int
r_int
id|number
)paren
(brace
r_int
r_int
id|cnt
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|MAXQUOTAS
suffix:semicolon
id|cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
id|inode-&gt;i_dquot
(braket
id|cnt
)braket
op_eq
id|NODQUOT
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|check_bdq
c_func
(paren
id|inode-&gt;i_dquot
(braket
id|cnt
)braket
comma
id|cnt
comma
id|number
)paren
)paren
r_return
id|NO_QUOTA
suffix:semicolon
)brace
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|MAXQUOTAS
suffix:semicolon
id|cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
id|inode-&gt;i_dquot
(braket
id|cnt
)braket
op_eq
id|NODQUOT
)paren
r_continue
suffix:semicolon
id|dquot_incr_blocks
c_func
(paren
id|inode-&gt;i_dquot
(braket
id|cnt
)braket
comma
id|number
)paren
suffix:semicolon
)brace
r_return
id|QUOTA_OK
suffix:semicolon
)brace
DECL|function|dquot_alloc_inode
r_int
id|dquot_alloc_inode
c_func
(paren
r_const
r_struct
id|inode
op_star
id|inode
comma
r_int
r_int
id|number
)paren
(brace
r_int
r_int
id|cnt
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|MAXQUOTAS
suffix:semicolon
id|cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
id|inode-&gt;i_dquot
(braket
id|cnt
)braket
op_eq
id|NODQUOT
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|check_idq
c_func
(paren
id|inode-&gt;i_dquot
(braket
id|cnt
)braket
comma
id|cnt
comma
id|number
)paren
)paren
r_return
id|NO_QUOTA
suffix:semicolon
)brace
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|MAXQUOTAS
suffix:semicolon
id|cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
id|inode-&gt;i_dquot
(braket
id|cnt
)braket
op_eq
id|NODQUOT
)paren
r_continue
suffix:semicolon
id|dquot_incr_inodes
c_func
(paren
id|inode-&gt;i_dquot
(braket
id|cnt
)braket
comma
id|number
)paren
suffix:semicolon
)brace
r_return
id|QUOTA_OK
suffix:semicolon
)brace
DECL|function|dquot_free_block
r_void
id|dquot_free_block
c_func
(paren
r_const
r_struct
id|inode
op_star
id|inode
comma
r_int
r_int
id|number
)paren
(brace
r_int
r_int
id|cnt
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|MAXQUOTAS
suffix:semicolon
id|cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
id|inode-&gt;i_dquot
(braket
id|cnt
)braket
op_eq
id|NODQUOT
)paren
r_continue
suffix:semicolon
id|dquot_decr_blocks
c_func
(paren
id|inode-&gt;i_dquot
(braket
id|cnt
)braket
comma
id|number
)paren
suffix:semicolon
)brace
)brace
DECL|function|dquot_free_inode
r_void
id|dquot_free_inode
c_func
(paren
r_const
r_struct
id|inode
op_star
id|inode
comma
r_int
r_int
id|number
)paren
(brace
r_int
r_int
id|cnt
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|MAXQUOTAS
suffix:semicolon
id|cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
id|inode-&gt;i_dquot
(braket
id|cnt
)braket
op_eq
id|NODQUOT
)paren
r_continue
suffix:semicolon
id|dquot_decr_inodes
c_func
(paren
id|inode-&gt;i_dquot
(braket
id|cnt
)braket
comma
id|number
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Transfer the number of inode and blocks from one diskquota to an other.&n; */
DECL|function|dquot_transfer
r_int
id|dquot_transfer
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|iattr
op_star
id|iattr
comma
r_char
id|direction
)paren
(brace
r_int
r_int
id|blocks
suffix:semicolon
r_struct
id|dquot
op_star
id|transfer_from
(braket
id|MAXQUOTAS
)braket
suffix:semicolon
r_struct
id|dquot
op_star
id|transfer_to
(braket
id|MAXQUOTAS
)braket
suffix:semicolon
r_int
id|cnt
comma
id|disc
suffix:semicolon
multiline_comment|/*&n;&t; * Find out if this filesystems uses i_blocks.&n;&t; */
r_if
c_cond
(paren
id|inode-&gt;i_blksize
op_eq
l_int|0
)paren
id|blocks
op_assign
id|isize_to_blocks
c_func
(paren
id|inode-&gt;i_size
comma
id|BLOCK_SIZE
)paren
suffix:semicolon
r_else
id|blocks
op_assign
(paren
id|inode-&gt;i_blocks
op_div
l_int|2
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Build the transfer_from and transfer_to lists and check quotas to see&n;&t; * if operation is permitted.&n;&t; */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|MAXQUOTAS
suffix:semicolon
id|cnt
op_increment
)paren
(brace
id|transfer_from
(braket
id|cnt
)braket
op_assign
id|NODQUOT
suffix:semicolon
id|transfer_to
(braket
id|cnt
)braket
op_assign
id|NODQUOT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|has_quota_enabled
c_func
(paren
id|inode-&gt;i_dev
comma
id|cnt
)paren
)paren
r_continue
suffix:semicolon
r_switch
c_cond
(paren
id|cnt
)paren
(brace
r_case
id|USRQUOTA
suffix:colon
r_if
c_cond
(paren
id|inode-&gt;i_uid
op_eq
id|iattr-&gt;ia_uid
)paren
r_continue
suffix:semicolon
id|transfer_from
(braket
id|cnt
)braket
op_assign
id|dqget
c_func
(paren
id|inode-&gt;i_dev
comma
(paren
id|direction
)paren
ques
c_cond
id|iattr-&gt;ia_uid
suffix:colon
id|inode-&gt;i_uid
comma
id|cnt
)paren
suffix:semicolon
id|transfer_to
(braket
id|cnt
)braket
op_assign
id|dqget
c_func
(paren
id|inode-&gt;i_dev
comma
(paren
id|direction
)paren
ques
c_cond
id|inode-&gt;i_uid
suffix:colon
id|iattr-&gt;ia_uid
comma
id|cnt
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|GRPQUOTA
suffix:colon
r_if
c_cond
(paren
id|inode-&gt;i_gid
op_eq
id|iattr-&gt;ia_gid
)paren
r_continue
suffix:semicolon
id|transfer_from
(braket
id|cnt
)braket
op_assign
id|dqget
c_func
(paren
id|inode-&gt;i_dev
comma
(paren
id|direction
)paren
ques
c_cond
id|iattr-&gt;ia_gid
suffix:colon
id|inode-&gt;i_gid
comma
id|cnt
)paren
suffix:semicolon
id|transfer_to
(braket
id|cnt
)braket
op_assign
id|dqget
c_func
(paren
id|inode-&gt;i_dev
comma
(paren
id|direction
)paren
ques
c_cond
id|inode-&gt;i_gid
suffix:colon
id|iattr-&gt;ia_gid
comma
id|cnt
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|check_idq
c_func
(paren
id|transfer_to
(braket
id|cnt
)braket
comma
id|cnt
comma
l_int|1
)paren
op_eq
id|NO_QUOTA
op_logical_or
id|check_bdq
c_func
(paren
id|transfer_to
(braket
id|cnt
)braket
comma
id|cnt
comma
id|blocks
)paren
op_eq
id|NO_QUOTA
)paren
(brace
r_for
c_loop
(paren
id|disc
op_assign
l_int|0
suffix:semicolon
id|disc
op_le
id|cnt
suffix:semicolon
id|disc
op_increment
)paren
(brace
id|dqput
c_func
(paren
id|transfer_from
(braket
id|disc
)braket
)paren
suffix:semicolon
id|dqput
c_func
(paren
id|transfer_to
(braket
id|disc
)braket
)paren
suffix:semicolon
)brace
r_return
id|NO_QUOTA
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Finally perform the needed transfer from transfer_from to transfer_to.&n;&t; * And release any pointer to dquots not needed anymore.&n;&t; */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|MAXQUOTAS
suffix:semicolon
id|cnt
op_increment
)paren
(brace
multiline_comment|/*&n;&t;&t; * Skip changes for same uid or gid or for non-existing quota-type.&n;&t;&t; */
r_if
c_cond
(paren
id|transfer_from
(braket
id|cnt
)braket
op_eq
id|NODQUOT
op_logical_and
id|transfer_to
(braket
id|cnt
)braket
op_eq
id|NODQUOT
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|transfer_from
(braket
id|cnt
)braket
op_ne
id|NODQUOT
)paren
(brace
id|dquot_decr_inodes
c_func
(paren
id|transfer_from
(braket
id|cnt
)braket
comma
l_int|1
)paren
suffix:semicolon
id|dquot_decr_blocks
c_func
(paren
id|transfer_from
(braket
id|cnt
)braket
comma
id|blocks
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|transfer_to
(braket
id|cnt
)braket
op_ne
id|NODQUOT
)paren
(brace
id|dquot_incr_inodes
c_func
(paren
id|transfer_to
(braket
id|cnt
)braket
comma
l_int|1
)paren
suffix:semicolon
id|dquot_incr_blocks
c_func
(paren
id|transfer_to
(braket
id|cnt
)braket
comma
id|blocks
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inode-&gt;i_dquot
(braket
id|cnt
)braket
op_ne
id|NODQUOT
)paren
(brace
id|dqput
c_func
(paren
id|transfer_from
(braket
id|cnt
)braket
)paren
suffix:semicolon
id|dqput
c_func
(paren
id|inode-&gt;i_dquot
(braket
id|cnt
)braket
)paren
suffix:semicolon
id|inode-&gt;i_dquot
(braket
id|cnt
)braket
op_assign
id|transfer_to
(braket
id|cnt
)braket
suffix:semicolon
)brace
r_else
(brace
id|dqput
c_func
(paren
id|transfer_from
(braket
id|cnt
)braket
)paren
suffix:semicolon
id|dqput
c_func
(paren
id|transfer_to
(braket
id|cnt
)braket
)paren
suffix:semicolon
)brace
)brace
r_return
id|QUOTA_OK
suffix:semicolon
)brace
DECL|function|dquot_init
r_void
id|dquot_init
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;VFS: Diskquotas version %s initialized&bslash;r&bslash;n&quot;
comma
id|__DQUOT_VERSION__
)paren
suffix:semicolon
id|memset
c_func
(paren
id|hash_table
comma
l_int|0
comma
r_sizeof
(paren
id|hash_table
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
id|caddr_t
)paren
op_amp
id|dqstats
comma
l_int|0
comma
r_sizeof
(paren
id|dqstats
)paren
)paren
suffix:semicolon
id|first_dquot
op_assign
id|NODQUOT
suffix:semicolon
)brace
multiline_comment|/*&n; * Definitions of diskquota operations.&n; */
DECL|variable|dquot_operations
r_struct
id|dquot_operations
id|dquot_operations
op_assign
(brace
id|dquot_initialize
comma
id|dquot_drop
comma
id|dquot_alloc_block
comma
id|dquot_alloc_inode
comma
id|dquot_free_block
comma
id|dquot_free_inode
comma
id|dquot_transfer
)brace
suffix:semicolon
multiline_comment|/*&n; * Turn quota off on a device. type == -1 ==&gt; quotaoff for all types (umount)&n; */
DECL|function|quota_off
r_int
id|quota_off
c_func
(paren
id|kdev_t
id|dev
comma
r_int
id|type
)paren
(brace
r_struct
id|vfsmount
op_star
id|vfsmnt
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|MAXQUOTAS
suffix:semicolon
id|cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
id|type
op_ne
op_minus
l_int|1
op_logical_and
id|cnt
op_ne
id|type
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|vfsmnt
op_assign
id|lookup_vfsmnt
c_func
(paren
id|dev
)paren
)paren
op_eq
(paren
r_struct
id|vfsmount
op_star
)paren
l_int|NULL
op_logical_or
id|vfsmnt-&gt;mnt_quotas
(braket
id|cnt
)braket
op_eq
(paren
r_struct
id|file
op_star
)paren
l_int|NULL
)paren
r_continue
suffix:semicolon
id|vfsmnt-&gt;mnt_sb-&gt;dq_op
op_assign
(paren
r_struct
id|dquot_operations
op_star
)paren
l_int|NULL
suffix:semicolon
id|reset_dquot_ptrs
c_func
(paren
id|dev
comma
id|cnt
)paren
suffix:semicolon
id|invalidate_dquots
c_func
(paren
id|dev
comma
id|cnt
)paren
suffix:semicolon
id|close_fp
c_func
(paren
id|vfsmnt-&gt;mnt_quotas
(braket
id|cnt
)braket
)paren
suffix:semicolon
id|vfsmnt-&gt;mnt_quotas
(braket
id|cnt
)braket
op_assign
(paren
r_struct
id|file
op_star
)paren
l_int|NULL
suffix:semicolon
id|vfsmnt-&gt;mnt_iexp
(braket
id|cnt
)braket
op_assign
id|vfsmnt-&gt;mnt_bexp
(braket
id|cnt
)braket
op_assign
(paren
id|time_t
)paren
l_int|NULL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|quota_on
r_int
id|quota_on
c_func
(paren
id|kdev_t
id|dev
comma
r_int
id|type
comma
r_char
op_star
id|path
)paren
(brace
r_struct
id|file
op_star
id|filp
op_assign
(paren
r_struct
id|file
op_star
)paren
l_int|NULL
suffix:semicolon
r_struct
id|vfsmount
op_star
id|vfsmnt
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_struct
id|dquot
op_star
id|dquot
suffix:semicolon
r_char
op_star
id|tmp
suffix:semicolon
r_int
id|error
suffix:semicolon
r_if
c_cond
(paren
(paren
id|vfsmnt
op_assign
id|lookup_vfsmnt
c_func
(paren
id|dev
)paren
)paren
op_eq
(paren
r_struct
id|vfsmount
op_star
)paren
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|vfsmnt-&gt;mnt_quotas
(braket
id|type
)braket
op_ne
(paren
r_struct
id|file
op_star
)paren
l_int|NULL
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_assign
id|getname
c_func
(paren
id|path
comma
op_amp
id|tmp
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|error
suffix:semicolon
id|error
op_assign
id|open_namei
c_func
(paren
id|tmp
comma
id|O_RDWR
comma
l_int|0600
comma
op_amp
id|inode
comma
l_int|0
)paren
suffix:semicolon
id|putname
c_func
(paren
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|S_ISREG
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
(brace
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
op_minus
id|EACCES
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|filp
op_assign
id|get_empty_filp
c_func
(paren
)paren
)paren
op_ne
(paren
r_struct
id|file
op_star
)paren
l_int|NULL
)paren
(brace
id|filp-&gt;f_mode
op_assign
(paren
id|O_RDWR
op_plus
l_int|1
)paren
op_amp
id|O_ACCMODE
suffix:semicolon
id|filp-&gt;f_flags
op_assign
id|O_RDWR
suffix:semicolon
id|filp-&gt;f_inode
op_assign
id|inode
suffix:semicolon
id|filp-&gt;f_pos
op_assign
l_int|0
suffix:semicolon
id|filp-&gt;f_reada
op_assign
l_int|0
suffix:semicolon
id|filp-&gt;f_op
op_assign
id|inode-&gt;i_op-&gt;default_file_ops
suffix:semicolon
r_if
c_cond
(paren
id|filp-&gt;f_op-&gt;read
op_logical_or
id|filp-&gt;f_op-&gt;write
)paren
(brace
r_if
c_cond
(paren
(paren
id|error
op_assign
id|get_write_access
c_func
(paren
id|inode
)paren
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|filp-&gt;f_op
op_logical_and
id|filp-&gt;f_op-&gt;open
)paren
id|error
op_assign
id|filp-&gt;f_op
op_member_access_from_pointer
id|open
c_func
(paren
id|inode
comma
id|filp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_eq
l_int|0
)paren
(brace
id|vfsmnt-&gt;mnt_quotas
(braket
id|type
)braket
op_assign
id|filp
suffix:semicolon
id|dquot
op_assign
id|dqget
c_func
(paren
id|dev
comma
l_int|0
comma
id|type
)paren
suffix:semicolon
id|vfsmnt-&gt;mnt_iexp
(braket
id|type
)braket
op_assign
(paren
id|dquot
)paren
ques
c_cond
id|dquot-&gt;dq_itime
suffix:colon
id|MAX_IQ_TIME
suffix:semicolon
id|vfsmnt-&gt;mnt_bexp
(braket
id|type
)braket
op_assign
(paren
id|dquot
)paren
ques
c_cond
id|dquot-&gt;dq_btime
suffix:colon
id|MAX_DQ_TIME
suffix:semicolon
id|dqput
c_func
(paren
id|dquot
)paren
suffix:semicolon
id|vfsmnt-&gt;mnt_sb-&gt;dq_op
op_assign
op_amp
id|dquot_operations
suffix:semicolon
id|add_dquot_ref
c_func
(paren
id|dev
comma
id|type
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|put_write_access
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
)brace
r_else
id|error
op_assign
op_minus
id|EIO
suffix:semicolon
id|filp-&gt;f_count
op_decrement
suffix:semicolon
)brace
r_else
id|error
op_assign
op_minus
id|EMFILE
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/*&n; * Ok this is the systemcall interface, this communicates with&n; * the userlevel programs. Currently this only supports diskquota&n; * calls. Maybe we need to add the process quotas etc in the future.&n; * But we probably better use rlimits for that.&n; */
DECL|function|sys_quotactl
id|asmlinkage
r_int
id|sys_quotactl
c_func
(paren
r_int
id|cmd
comma
r_const
r_char
op_star
id|special
comma
r_int
id|id
comma
id|caddr_t
id|addr
)paren
(brace
r_int
id|cmds
op_assign
l_int|0
comma
id|type
op_assign
l_int|0
comma
id|flags
op_assign
l_int|0
suffix:semicolon
r_struct
id|inode
op_star
id|ino
suffix:semicolon
id|kdev_t
id|dev
suffix:semicolon
id|cmds
op_assign
id|cmd
op_rshift
id|SUBCMDSHIFT
suffix:semicolon
id|type
op_assign
id|cmd
op_amp
id|SUBCMDMASK
suffix:semicolon
r_if
c_cond
(paren
(paren
id|u_int
)paren
id|type
op_ge
id|MAXQUOTAS
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
id|cmds
)paren
(brace
r_case
id|Q_SYNC
suffix:colon
r_case
id|Q_GETSTATS
suffix:colon
r_break
suffix:semicolon
r_case
id|Q_GETQUOTA
suffix:colon
r_if
c_cond
(paren
(paren
(paren
id|type
op_eq
id|USRQUOTA
op_logical_and
id|current-&gt;uid
op_ne
id|id
)paren
op_logical_or
(paren
id|type
op_eq
id|GRPQUOTA
op_logical_and
id|current-&gt;gid
op_ne
id|id
)paren
)paren
op_logical_and
op_logical_neg
id|fsuser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|fsuser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|special
op_eq
(paren
r_char
op_star
)paren
l_int|NULL
op_logical_and
(paren
id|cmds
op_eq
id|Q_SYNC
op_logical_or
id|cmds
op_eq
id|Q_GETSTATS
)paren
)paren
id|dev
op_assign
l_int|0
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|namei
c_func
(paren
id|special
comma
op_amp
id|ino
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dev
op_assign
id|ino-&gt;i_rdev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|S_ISBLK
c_func
(paren
id|ino-&gt;i_mode
)paren
)paren
(brace
id|iput
c_func
(paren
id|ino
)paren
suffix:semicolon
r_return
op_minus
id|ENOTBLK
suffix:semicolon
)brace
id|iput
c_func
(paren
id|ino
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cmds
)paren
(brace
r_case
id|Q_QUOTAON
suffix:colon
r_return
id|quota_on
c_func
(paren
id|dev
comma
id|type
comma
(paren
r_char
op_star
)paren
id|addr
)paren
suffix:semicolon
r_case
id|Q_QUOTAOFF
suffix:colon
r_return
id|quota_off
c_func
(paren
id|dev
comma
id|type
)paren
suffix:semicolon
r_case
id|Q_GETQUOTA
suffix:colon
r_return
id|get_quota
c_func
(paren
id|dev
comma
id|id
comma
id|type
comma
(paren
r_struct
id|dqblk
op_star
)paren
id|addr
)paren
suffix:semicolon
r_case
id|Q_SETQUOTA
suffix:colon
id|flags
op_or_assign
id|SET_QUOTA
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Q_SETUSE
suffix:colon
id|flags
op_or_assign
id|SET_USE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Q_SETQLIM
suffix:colon
id|flags
op_or_assign
id|SET_QLIMIT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Q_SYNC
suffix:colon
r_return
id|sync_dquots
c_func
(paren
id|dev
comma
id|type
)paren
suffix:semicolon
r_case
id|Q_GETSTATS
suffix:colon
r_return
id|get_stats
c_func
(paren
id|addr
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|flags
op_or_assign
id|QUOTA_SYSCALL
suffix:semicolon
r_if
c_cond
(paren
id|has_quota_enabled
c_func
(paren
id|dev
comma
id|type
)paren
)paren
r_return
id|set_dqblk
c_func
(paren
id|dev
comma
id|id
comma
id|type
comma
id|flags
comma
(paren
r_struct
id|dqblk
op_star
)paren
id|addr
)paren
suffix:semicolon
r_return
op_minus
id|ESRCH
suffix:semicolon
)brace
eof
