multiline_comment|/*&n; *  linux/fs/hpfs/name.c&n; *&n; *  Mikulas Patocka (mikulas@artax.karlin.mff.cuni.cz), 1998-1999&n; *&n; *  operations with filenames&n; */
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &quot;hpfs_fn.h&quot;
DECL|variable|text_postfix
r_char
op_star
id|text_postfix
(braket
)braket
op_assign
initialization_block
suffix:semicolon
DECL|variable|text_prefix
r_char
op_star
id|text_prefix
(braket
)braket
op_assign
initialization_block
suffix:semicolon
DECL|function|hpfs_decide_conv
r_void
id|hpfs_decide_conv
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_int
r_char
op_star
id|name
comma
r_int
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|inode-&gt;i_hpfs_conv
op_ne
id|CONV_AUTO
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
op_star
id|text_postfix
(braket
id|i
)braket
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|l
op_assign
id|strlen
c_func
(paren
id|text_postfix
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|l
op_le
id|len
)paren
r_if
c_cond
(paren
op_logical_neg
id|hpfs_compare_names
c_func
(paren
id|inode-&gt;i_sb
comma
id|text_postfix
(braket
id|i
)braket
comma
id|l
comma
id|name
op_plus
id|len
op_minus
id|l
comma
id|l
comma
l_int|0
)paren
)paren
r_goto
id|text
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
op_star
id|text_prefix
(braket
id|i
)braket
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|l
op_assign
id|strlen
c_func
(paren
id|text_prefix
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|l
op_le
id|len
)paren
r_if
c_cond
(paren
op_logical_neg
id|hpfs_compare_names
c_func
(paren
id|inode-&gt;i_sb
comma
id|text_prefix
(braket
id|i
)braket
comma
id|l
comma
id|name
comma
id|l
comma
l_int|0
)paren
)paren
r_goto
id|text
suffix:semicolon
)brace
id|inode-&gt;i_hpfs_conv
op_assign
id|CONV_BINARY
suffix:semicolon
r_return
suffix:semicolon
id|text
suffix:colon
id|inode-&gt;i_hpfs_conv
op_assign
id|CONV_TEXT
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|not_allowed_char
r_static
r_inline
r_int
id|not_allowed_char
c_func
(paren
r_int
r_char
id|c
)paren
(brace
r_return
id|c
OL
l_char|&squot; &squot;
op_logical_or
id|c
op_eq
l_char|&squot;&quot;&squot;
op_logical_or
id|c
op_eq
l_char|&squot;*&squot;
op_logical_or
id|c
op_eq
l_char|&squot;/&squot;
op_logical_or
id|c
op_eq
l_char|&squot;:&squot;
op_logical_or
id|c
op_eq
l_char|&squot;&lt;&squot;
op_logical_or
id|c
op_eq
l_char|&squot;&gt;&squot;
op_logical_or
id|c
op_eq
l_char|&squot;?&squot;
op_logical_or
id|c
op_eq
l_char|&squot;&bslash;&bslash;&squot;
op_logical_or
id|c
op_eq
l_char|&squot;|&squot;
suffix:semicolon
)brace
DECL|function|no_dos_char
r_static
r_inline
r_int
id|no_dos_char
c_func
(paren
r_int
r_char
id|c
)paren
(brace
multiline_comment|/* Characters that are allowed in HPFS but not in DOS */
r_return
id|c
op_eq
l_char|&squot;+&squot;
op_logical_or
id|c
op_eq
l_char|&squot;,&squot;
op_logical_or
id|c
op_eq
l_char|&squot;;&squot;
op_logical_or
id|c
op_eq
l_char|&squot;=&squot;
op_logical_or
id|c
op_eq
l_char|&squot;[&squot;
op_logical_or
id|c
op_eq
l_char|&squot;]&squot;
suffix:semicolon
)brace
DECL|function|upcase
r_static
r_inline
r_int
r_char
id|upcase
c_func
(paren
r_int
r_char
op_star
id|dir
comma
r_int
r_char
id|a
)paren
(brace
r_if
c_cond
(paren
id|a
OL
l_int|128
op_logical_or
id|a
op_eq
l_int|255
)paren
r_return
id|a
op_ge
l_char|&squot;a&squot;
op_logical_and
id|a
op_le
l_char|&squot;z&squot;
ques
c_cond
id|a
op_minus
l_int|0x20
suffix:colon
id|a
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dir
)paren
r_return
id|a
suffix:semicolon
r_return
id|dir
(braket
id|a
op_minus
l_int|128
)braket
suffix:semicolon
)brace
DECL|function|hpfs_upcase
r_int
r_char
id|hpfs_upcase
c_func
(paren
r_int
r_char
op_star
id|dir
comma
r_int
r_char
id|a
)paren
(brace
r_return
id|upcase
c_func
(paren
id|dir
comma
id|a
)paren
suffix:semicolon
)brace
DECL|function|locase
r_static
r_inline
r_int
r_char
id|locase
c_func
(paren
r_int
r_char
op_star
id|dir
comma
r_int
r_char
id|a
)paren
(brace
r_if
c_cond
(paren
id|a
OL
l_int|128
op_logical_or
id|a
op_eq
l_int|255
)paren
r_return
id|a
op_ge
l_char|&squot;A&squot;
op_logical_and
id|a
op_le
l_char|&squot;Z&squot;
ques
c_cond
id|a
op_plus
l_int|0x20
suffix:colon
id|a
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dir
)paren
r_return
id|a
suffix:semicolon
r_return
id|dir
(braket
id|a
)braket
suffix:semicolon
)brace
DECL|function|hpfs_chk_name
r_int
id|hpfs_chk_name
c_func
(paren
r_int
r_char
op_star
id|name
comma
r_int
op_star
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_star
id|len
OG
l_int|254
)paren
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
id|hpfs_adjust_length
c_func
(paren
id|name
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|len
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
op_star
id|len
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|not_allowed_char
c_func
(paren
id|name
(braket
id|i
)braket
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_star
id|len
op_eq
l_int|1
)paren
r_if
c_cond
(paren
id|name
(braket
l_int|0
)braket
op_eq
l_char|&squot;.&squot;
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_star
id|len
op_eq
l_int|2
)paren
r_if
c_cond
(paren
id|name
(braket
l_int|0
)braket
op_eq
l_char|&squot;.&squot;
op_logical_and
id|name
(braket
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hpfs_translate_name
r_char
op_star
id|hpfs_translate_name
c_func
(paren
r_struct
id|super_block
op_star
id|s
comma
r_int
r_char
op_star
id|from
comma
r_int
id|len
comma
r_int
id|lc
comma
r_int
id|lng
)paren
(brace
r_char
op_star
id|to
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;s_hpfs_chk
op_ge
l_int|2
)paren
r_if
c_cond
(paren
id|hpfs_is_name_long
c_func
(paren
id|from
comma
id|len
)paren
op_ne
id|lng
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HPFS: Long name flag mismatch - name &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%c&quot;
comma
id|from
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; misidentified as %s.&bslash;n&quot;
comma
id|lng
ques
c_cond
l_string|&quot;short&quot;
suffix:colon
l_string|&quot;long&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;HPFS: It&squot;s nothing serious. It could happen because of bug in OS/2.&bslash;nHPFS: Set checks=normal to disable this message.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|lc
)paren
r_return
id|from
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|to
op_assign
id|kmalloc
c_func
(paren
id|len
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HPFS: can&squot;t allocate memory for name conversion buffer&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|from
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
id|to
(braket
id|i
)braket
op_assign
id|locase
c_func
(paren
id|s-&gt;s_hpfs_cp_table
comma
id|from
(braket
id|i
)braket
)paren
suffix:semicolon
r_return
id|to
suffix:semicolon
)brace
DECL|function|hpfs_compare_names
r_int
id|hpfs_compare_names
c_func
(paren
r_struct
id|super_block
op_star
id|s
comma
r_int
r_char
op_star
id|n1
comma
r_int
id|l1
comma
r_int
r_char
op_star
id|n2
comma
r_int
id|l2
comma
r_int
id|last
)paren
(brace
r_int
id|l
op_assign
id|l1
OL
id|l2
ques
c_cond
id|l1
suffix:colon
id|l2
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|last
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|l
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_char
id|c1
op_assign
id|upcase
c_func
(paren
id|s-&gt;s_hpfs_cp_table
comma
id|n1
(braket
id|i
)braket
)paren
suffix:semicolon
r_int
r_char
id|c2
op_assign
id|upcase
c_func
(paren
id|s-&gt;s_hpfs_cp_table
comma
id|n2
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c1
OL
id|c2
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|c1
OG
id|c2
)paren
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|l1
OL
id|l2
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|l1
OG
id|l2
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hpfs_is_name_long
r_int
id|hpfs_is_name_long
c_func
(paren
r_int
r_char
op_star
id|name
comma
r_int
id|len
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
op_logical_and
id|name
(braket
id|i
)braket
op_ne
l_char|&squot;.&squot;
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|no_dos_char
c_func
(paren
id|name
(braket
id|i
)braket
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|i
op_logical_or
id|i
OG
l_int|8
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|len
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
id|i
op_plus
l_int|1
suffix:semicolon
id|j
OL
id|len
suffix:semicolon
id|j
op_increment
)paren
r_if
c_cond
(paren
id|name
(braket
id|j
)braket
op_eq
l_char|&squot;.&squot;
op_logical_or
id|no_dos_char
c_func
(paren
id|name
(braket
id|i
)braket
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_return
id|j
op_minus
id|i
OG
l_int|4
suffix:semicolon
)brace
multiline_comment|/* OS/2 clears dots and spaces at the end of file name, so we have to */
DECL|function|hpfs_adjust_length
r_void
id|hpfs_adjust_length
c_func
(paren
r_int
r_char
op_star
id|name
comma
r_int
op_star
id|len
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_star
id|len
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_star
id|len
op_eq
l_int|1
op_logical_and
id|name
(braket
l_int|0
)braket
op_eq
l_char|&squot;.&squot;
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_star
id|len
op_eq
l_int|2
op_logical_and
id|name
(braket
l_int|0
)braket
op_eq
l_char|&squot;.&squot;
op_logical_and
id|name
(braket
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
)paren
r_return
suffix:semicolon
r_while
c_loop
(paren
op_star
id|len
op_logical_and
(paren
id|name
(braket
op_star
id|len
op_minus
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
op_logical_or
id|name
(braket
op_star
id|len
op_minus
l_int|1
)braket
op_eq
l_char|&squot; &squot;
)paren
)paren
(paren
op_star
id|len
)paren
op_decrement
suffix:semicolon
)brace
eof
