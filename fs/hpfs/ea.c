multiline_comment|/*&n; *  linux/fs/hpfs/ea.c&n; *&n; *  Mikulas Patocka (mikulas@artax.karlin.mff.cuni.cz), 1998-1999&n; *&n; *  handling extended attributes&n; */
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &quot;hpfs_fn.h&quot;
multiline_comment|/* Remove external extended attributes. ano specifies wheter a is a &n;   direct sector where eas start or an anode */
DECL|function|hpfs_ea_ext_remove
r_void
id|hpfs_ea_ext_remove
c_func
(paren
r_struct
id|super_block
op_star
id|s
comma
id|secno
id|a
comma
r_int
id|ano
comma
r_int
id|len
)paren
(brace
r_int
id|pos
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|pos
OL
id|len
)paren
(brace
r_char
id|ex
(braket
l_int|4
op_plus
l_int|255
op_plus
l_int|1
op_plus
l_int|8
)braket
suffix:semicolon
r_struct
id|extended_attribute
op_star
id|ea
op_assign
(paren
r_struct
id|extended_attribute
op_star
)paren
id|ex
suffix:semicolon
r_if
c_cond
(paren
id|pos
op_plus
l_int|4
OG
id|len
)paren
(brace
id|hpfs_error
c_func
(paren
id|s
comma
l_string|&quot;EAs don&squot;t end correctly, %s %08x, len %08x&quot;
comma
id|ano
ques
c_cond
l_string|&quot;anode&quot;
suffix:colon
l_string|&quot;sectors&quot;
comma
id|a
comma
id|len
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hpfs_ea_read
c_func
(paren
id|s
comma
id|a
comma
id|ano
comma
id|pos
comma
l_int|4
comma
id|ex
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|ea-&gt;indirect
)paren
(brace
r_if
c_cond
(paren
id|ea-&gt;valuelen
op_ne
l_int|8
)paren
(brace
id|hpfs_error
c_func
(paren
id|s
comma
l_string|&quot;ea-&gt;indirect set while ea-&gt;valuelen!=8, %s %08x, pos %08x&quot;
comma
id|ano
ques
c_cond
l_string|&quot;anode&quot;
suffix:colon
l_string|&quot;sectors&quot;
comma
id|a
comma
id|pos
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hpfs_ea_read
c_func
(paren
id|s
comma
id|a
comma
id|ano
comma
id|pos
op_plus
l_int|4
comma
id|ea-&gt;namelen
op_plus
l_int|9
comma
id|ex
op_plus
l_int|4
)paren
)paren
r_return
suffix:semicolon
id|hpfs_ea_remove
c_func
(paren
id|s
comma
id|ea_sec
c_func
(paren
id|ea
)paren
comma
id|ea-&gt;anode
comma
id|ea_len
c_func
(paren
id|ea
)paren
)paren
suffix:semicolon
)brace
id|pos
op_add_assign
id|ea-&gt;namelen
op_plus
id|ea-&gt;valuelen
op_plus
l_int|5
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ano
)paren
id|hpfs_free_sectors
c_func
(paren
id|s
comma
id|a
comma
(paren
id|len
op_plus
l_int|511
)paren
op_rshift
l_int|9
)paren
suffix:semicolon
r_else
(brace
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_struct
id|anode
op_star
id|anode
suffix:semicolon
r_if
c_cond
(paren
(paren
id|anode
op_assign
id|hpfs_map_anode
c_func
(paren
id|s
comma
id|a
comma
op_amp
id|bh
)paren
)paren
)paren
(brace
id|hpfs_remove_btree
c_func
(paren
id|s
comma
op_amp
id|anode-&gt;btree
)paren
suffix:semicolon
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
id|hpfs_free_sectors
c_func
(paren
id|s
comma
id|a
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|get_indirect_ea
r_static
r_char
op_star
id|get_indirect_ea
c_func
(paren
r_struct
id|super_block
op_star
id|s
comma
r_int
id|ano
comma
id|secno
id|a
comma
r_int
id|size
)paren
(brace
r_char
op_star
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ret
op_assign
id|kmalloc
c_func
(paren
id|size
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HPFS: out of memory for EA&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hpfs_ea_read
c_func
(paren
id|s
comma
id|a
comma
id|ano
comma
l_int|0
comma
id|size
comma
id|ret
)paren
)paren
(brace
id|kfree
c_func
(paren
id|ret
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|ret
(braket
id|size
)braket
op_assign
l_int|0
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|set_indirect_ea
r_static
r_void
id|set_indirect_ea
c_func
(paren
r_struct
id|super_block
op_star
id|s
comma
r_int
id|ano
comma
id|secno
id|a
comma
r_char
op_star
id|data
comma
r_int
id|size
)paren
(brace
id|hpfs_ea_write
c_func
(paren
id|s
comma
id|a
comma
id|ano
comma
l_int|0
comma
id|size
comma
id|data
)paren
suffix:semicolon
)brace
multiline_comment|/* Read an extended attribute named &squot;key&squot; into the provided buffer */
DECL|function|hpfs_read_ea
r_int
id|hpfs_read_ea
c_func
(paren
r_struct
id|super_block
op_star
id|s
comma
r_struct
id|fnode
op_star
id|fnode
comma
r_char
op_star
id|key
comma
r_char
op_star
id|buf
comma
r_int
id|size
)paren
(brace
r_int
id|pos
suffix:semicolon
r_int
id|ano
comma
id|len
suffix:semicolon
id|secno
id|a
suffix:semicolon
r_struct
id|extended_attribute
op_star
id|ea
suffix:semicolon
r_struct
id|extended_attribute
op_star
id|ea_end
op_assign
id|fnode_end_ea
c_func
(paren
id|fnode
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ea
op_assign
id|fnode_ea
c_func
(paren
id|fnode
)paren
suffix:semicolon
id|ea
OL
id|ea_end
suffix:semicolon
id|ea
op_assign
id|next_ea
c_func
(paren
id|ea
)paren
)paren
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|ea-&gt;name
comma
id|key
)paren
)paren
(brace
r_if
c_cond
(paren
id|ea-&gt;indirect
)paren
r_goto
id|indirect
suffix:semicolon
r_if
c_cond
(paren
id|ea-&gt;valuelen
op_ge
id|size
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memcpy
c_func
(paren
id|buf
comma
id|ea_data
c_func
(paren
id|ea
)paren
comma
id|ea-&gt;valuelen
)paren
suffix:semicolon
id|buf
(braket
id|ea-&gt;valuelen
)braket
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|a
op_assign
id|fnode-&gt;ea_secno
suffix:semicolon
id|len
op_assign
id|fnode-&gt;ea_size_l
suffix:semicolon
id|ano
op_assign
id|fnode-&gt;ea_anode
suffix:semicolon
id|pos
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|pos
OL
id|len
)paren
(brace
r_char
id|ex
(braket
l_int|4
op_plus
l_int|255
op_plus
l_int|1
op_plus
l_int|8
)braket
suffix:semicolon
id|ea
op_assign
(paren
r_struct
id|extended_attribute
op_star
)paren
id|ex
suffix:semicolon
r_if
c_cond
(paren
id|pos
op_plus
l_int|4
OG
id|len
)paren
(brace
id|hpfs_error
c_func
(paren
id|s
comma
l_string|&quot;EAs don&squot;t end correctly, %s %08x, len %08x&quot;
comma
id|ano
ques
c_cond
l_string|&quot;anode&quot;
suffix:colon
l_string|&quot;sectors&quot;
comma
id|a
comma
id|len
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hpfs_ea_read
c_func
(paren
id|s
comma
id|a
comma
id|ano
comma
id|pos
comma
l_int|4
comma
id|ex
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|hpfs_ea_read
c_func
(paren
id|s
comma
id|a
comma
id|ano
comma
id|pos
op_plus
l_int|4
comma
id|ea-&gt;namelen
op_plus
l_int|1
op_plus
(paren
id|ea-&gt;indirect
ques
c_cond
l_int|8
suffix:colon
l_int|0
)paren
comma
id|ex
op_plus
l_int|4
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|ea-&gt;name
comma
id|key
)paren
)paren
(brace
r_if
c_cond
(paren
id|ea-&gt;indirect
)paren
r_goto
id|indirect
suffix:semicolon
r_if
c_cond
(paren
id|ea-&gt;valuelen
op_ge
id|size
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|hpfs_ea_read
c_func
(paren
id|s
comma
id|a
comma
id|ano
comma
id|pos
op_plus
l_int|4
op_plus
id|ea-&gt;namelen
op_plus
l_int|1
comma
id|ea-&gt;valuelen
comma
id|buf
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|buf
(braket
id|ea-&gt;valuelen
)braket
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|pos
op_add_assign
id|ea-&gt;namelen
op_plus
id|ea-&gt;valuelen
op_plus
l_int|5
suffix:semicolon
)brace
r_return
op_minus
id|ENOENT
suffix:semicolon
id|indirect
suffix:colon
r_if
c_cond
(paren
id|ea_len
c_func
(paren
id|ea
)paren
op_ge
id|size
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|hpfs_ea_read
c_func
(paren
id|s
comma
id|ea_sec
c_func
(paren
id|ea
)paren
comma
id|ea-&gt;anode
comma
l_int|0
comma
id|ea_len
c_func
(paren
id|ea
)paren
comma
id|buf
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|buf
(braket
id|ea_len
c_func
(paren
id|ea
)paren
)braket
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Read an extended attribute named &squot;key&squot; */
DECL|function|hpfs_get_ea
r_char
op_star
id|hpfs_get_ea
c_func
(paren
r_struct
id|super_block
op_star
id|s
comma
r_struct
id|fnode
op_star
id|fnode
comma
r_char
op_star
id|key
comma
r_int
op_star
id|size
)paren
(brace
r_char
op_star
id|ret
suffix:semicolon
r_int
id|pos
suffix:semicolon
r_int
id|ano
comma
id|len
suffix:semicolon
id|secno
id|a
suffix:semicolon
r_struct
id|extended_attribute
op_star
id|ea
suffix:semicolon
r_struct
id|extended_attribute
op_star
id|ea_end
op_assign
id|fnode_end_ea
c_func
(paren
id|fnode
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ea
op_assign
id|fnode_ea
c_func
(paren
id|fnode
)paren
suffix:semicolon
id|ea
OL
id|ea_end
suffix:semicolon
id|ea
op_assign
id|next_ea
c_func
(paren
id|ea
)paren
)paren
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|ea-&gt;name
comma
id|key
)paren
)paren
(brace
r_if
c_cond
(paren
id|ea-&gt;indirect
)paren
r_return
id|get_indirect_ea
c_func
(paren
id|s
comma
id|ea-&gt;anode
comma
id|ea_sec
c_func
(paren
id|ea
)paren
comma
op_star
id|size
op_assign
id|ea_len
c_func
(paren
id|ea
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ret
op_assign
id|kmalloc
c_func
(paren
(paren
op_star
id|size
op_assign
id|ea-&gt;valuelen
)paren
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HPFS: out of memory for EA&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|ret
comma
id|ea_data
c_func
(paren
id|ea
)paren
comma
id|ea-&gt;valuelen
)paren
suffix:semicolon
id|ret
(braket
id|ea-&gt;valuelen
)braket
op_assign
l_int|0
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|a
op_assign
id|fnode-&gt;ea_secno
suffix:semicolon
id|len
op_assign
id|fnode-&gt;ea_size_l
suffix:semicolon
id|ano
op_assign
id|fnode-&gt;ea_anode
suffix:semicolon
id|pos
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|pos
OL
id|len
)paren
(brace
r_char
id|ex
(braket
l_int|4
op_plus
l_int|255
op_plus
l_int|1
op_plus
l_int|8
)braket
suffix:semicolon
id|ea
op_assign
(paren
r_struct
id|extended_attribute
op_star
)paren
id|ex
suffix:semicolon
r_if
c_cond
(paren
id|pos
op_plus
l_int|4
OG
id|len
)paren
(brace
id|hpfs_error
c_func
(paren
id|s
comma
l_string|&quot;EAs don&squot;t end correctly, %s %08x, len %08x&quot;
comma
id|ano
ques
c_cond
l_string|&quot;anode&quot;
suffix:colon
l_string|&quot;sectors&quot;
comma
id|a
comma
id|len
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hpfs_ea_read
c_func
(paren
id|s
comma
id|a
comma
id|ano
comma
id|pos
comma
l_int|4
comma
id|ex
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|hpfs_ea_read
c_func
(paren
id|s
comma
id|a
comma
id|ano
comma
id|pos
op_plus
l_int|4
comma
id|ea-&gt;namelen
op_plus
l_int|1
op_plus
(paren
id|ea-&gt;indirect
ques
c_cond
l_int|8
suffix:colon
l_int|0
)paren
comma
id|ex
op_plus
l_int|4
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|ea-&gt;name
comma
id|key
)paren
)paren
(brace
r_if
c_cond
(paren
id|ea-&gt;indirect
)paren
r_return
id|get_indirect_ea
c_func
(paren
id|s
comma
id|ea-&gt;anode
comma
id|ea_sec
c_func
(paren
id|ea
)paren
comma
op_star
id|size
op_assign
id|ea_len
c_func
(paren
id|ea
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ret
op_assign
id|kmalloc
c_func
(paren
(paren
op_star
id|size
op_assign
id|ea-&gt;valuelen
)paren
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HPFS: out of memory for EA&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hpfs_ea_read
c_func
(paren
id|s
comma
id|a
comma
id|ano
comma
id|pos
op_plus
l_int|4
op_plus
id|ea-&gt;namelen
op_plus
l_int|1
comma
id|ea-&gt;valuelen
comma
id|ret
)paren
)paren
(brace
id|kfree
c_func
(paren
id|ret
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|ret
(braket
id|ea-&gt;valuelen
)braket
op_assign
l_int|0
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|pos
op_add_assign
id|ea-&gt;namelen
op_plus
id|ea-&gt;valuelen
op_plus
l_int|5
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* &n; * Update or create extended attribute &squot;key&squot; with value &squot;data&squot;. Note that&n; * when this ea exists, it MUST have the same size as size of data.&n; * This driver can&squot;t change sizes of eas (&squot;cause I just don&squot;t need it).&n; */
DECL|function|hpfs_set_ea
r_void
id|hpfs_set_ea
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|fnode
op_star
id|fnode
comma
r_char
op_star
id|key
comma
r_char
op_star
id|data
comma
r_int
id|size
)paren
(brace
id|fnode_secno
id|fno
op_assign
id|inode-&gt;i_ino
suffix:semicolon
r_struct
id|super_block
op_star
id|s
op_assign
id|inode-&gt;i_sb
suffix:semicolon
r_int
id|pos
suffix:semicolon
r_int
id|ano
comma
id|len
suffix:semicolon
id|secno
id|a
suffix:semicolon
r_int
r_char
id|h
(braket
l_int|4
)braket
suffix:semicolon
r_struct
id|extended_attribute
op_star
id|ea
suffix:semicolon
r_struct
id|extended_attribute
op_star
id|ea_end
op_assign
id|fnode_end_ea
c_func
(paren
id|fnode
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ea
op_assign
id|fnode_ea
c_func
(paren
id|fnode
)paren
suffix:semicolon
id|ea
OL
id|ea_end
suffix:semicolon
id|ea
op_assign
id|next_ea
c_func
(paren
id|ea
)paren
)paren
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|ea-&gt;name
comma
id|key
)paren
)paren
(brace
r_if
c_cond
(paren
id|ea-&gt;indirect
)paren
(brace
r_if
c_cond
(paren
id|ea_len
c_func
(paren
id|ea
)paren
op_eq
id|size
)paren
id|set_indirect_ea
c_func
(paren
id|s
comma
id|ea-&gt;anode
comma
id|ea_sec
c_func
(paren
id|ea
)paren
comma
id|data
comma
id|size
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ea-&gt;valuelen
op_eq
id|size
)paren
(brace
id|memcpy
c_func
(paren
id|ea_data
c_func
(paren
id|ea
)paren
comma
id|data
comma
id|size
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
id|a
op_assign
id|fnode-&gt;ea_secno
suffix:semicolon
id|len
op_assign
id|fnode-&gt;ea_size_l
suffix:semicolon
id|ano
op_assign
id|fnode-&gt;ea_anode
suffix:semicolon
id|pos
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|pos
OL
id|len
)paren
(brace
r_char
id|ex
(braket
l_int|4
op_plus
l_int|255
op_plus
l_int|1
op_plus
l_int|8
)braket
suffix:semicolon
id|ea
op_assign
(paren
r_struct
id|extended_attribute
op_star
)paren
id|ex
suffix:semicolon
r_if
c_cond
(paren
id|pos
op_plus
l_int|4
OG
id|len
)paren
(brace
id|hpfs_error
c_func
(paren
id|s
comma
l_string|&quot;EAs don&squot;t end correctly, %s %08x, len %08x&quot;
comma
id|ano
ques
c_cond
l_string|&quot;anode&quot;
suffix:colon
l_string|&quot;sectors&quot;
comma
id|a
comma
id|len
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hpfs_ea_read
c_func
(paren
id|s
comma
id|a
comma
id|ano
comma
id|pos
comma
l_int|4
comma
id|ex
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|hpfs_ea_read
c_func
(paren
id|s
comma
id|a
comma
id|ano
comma
id|pos
op_plus
l_int|4
comma
id|ea-&gt;namelen
op_plus
l_int|1
op_plus
(paren
id|ea-&gt;indirect
ques
c_cond
l_int|8
suffix:colon
l_int|0
)paren
comma
id|ex
op_plus
l_int|4
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|ea-&gt;name
comma
id|key
)paren
)paren
(brace
r_if
c_cond
(paren
id|ea-&gt;indirect
)paren
(brace
r_if
c_cond
(paren
id|ea_len
c_func
(paren
id|ea
)paren
op_eq
id|size
)paren
id|set_indirect_ea
c_func
(paren
id|s
comma
id|ea-&gt;anode
comma
id|ea_sec
c_func
(paren
id|ea
)paren
comma
id|data
comma
id|size
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ea-&gt;valuelen
op_eq
id|size
)paren
id|hpfs_ea_write
c_func
(paren
id|s
comma
id|a
comma
id|ano
comma
id|pos
op_plus
l_int|4
op_plus
id|ea-&gt;namelen
op_plus
l_int|1
comma
id|size
comma
id|data
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
id|pos
op_add_assign
id|ea-&gt;namelen
op_plus
id|ea-&gt;valuelen
op_plus
l_int|5
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|fnode-&gt;ea_size_s
)paren
(brace
multiline_comment|/*if (fnode-&gt;ea_size_s) {&n;&t;&t;&t;hpfs_error(s, &quot;fnode %08x: ea_size_s == %03x, ea_offs == 0&quot;,&n;&t;&t;&t;&t;inode-&gt;i_ino, fnode-&gt;ea_size_s);&n;&t;&t;&t;return;&n;&t;&t;}*/
id|fnode-&gt;ea_offs
op_assign
l_int|0xc4
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fnode-&gt;ea_offs
template_param
l_int|0x200
)paren
(brace
id|hpfs_error
c_func
(paren
id|s
comma
l_string|&quot;fnode %08x: ea_offs == %03x, ea_size_s == %03x&quot;
comma
id|inode-&gt;i_ino
comma
id|fnode-&gt;ea_offs
comma
id|fnode-&gt;ea_size_s
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|fnode-&gt;ea_size_s
op_logical_or
op_logical_neg
id|fnode-&gt;ea_size_l
)paren
op_logical_and
id|fnode-&gt;ea_offs
op_plus
id|fnode-&gt;ea_size_s
op_plus
id|strlen
c_func
(paren
id|key
)paren
op_plus
id|size
op_plus
l_int|5
op_le
l_int|0x200
)paren
(brace
multiline_comment|/* I&squot;m not sure ... maybe we overwrite ACL here. I have no info&n;&t;&t;   on it right now :-( */
id|ea
op_assign
id|fnode_end_ea
c_func
(paren
id|fnode
)paren
suffix:semicolon
op_star
(paren
r_char
op_star
)paren
id|ea
op_assign
l_int|0
suffix:semicolon
id|ea-&gt;namelen
op_assign
id|strlen
c_func
(paren
id|key
)paren
suffix:semicolon
id|ea-&gt;valuelen
op_assign
id|size
suffix:semicolon
id|strcpy
c_func
(paren
id|ea-&gt;name
comma
id|key
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|ea_data
c_func
(paren
id|ea
)paren
comma
id|data
comma
id|size
)paren
suffix:semicolon
id|fnode-&gt;ea_size_s
op_add_assign
id|strlen
c_func
(paren
id|key
)paren
op_plus
id|size
op_plus
l_int|5
suffix:semicolon
r_goto
id|ret
suffix:semicolon
)brace
multiline_comment|/* Most the code here is 99.9993422% unused. I hope there are no bugs.&n;&t;   But what .. HPFS.IFS has also bugs in ea management. */
r_if
c_cond
(paren
id|fnode-&gt;ea_size_s
op_logical_and
op_logical_neg
id|fnode-&gt;ea_size_l
)paren
(brace
id|secno
id|n
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_char
op_star
id|data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|n
op_assign
id|hpfs_alloc_sector
c_func
(paren
id|s
comma
id|fno
comma
l_int|1
comma
l_int|0
comma
l_int|1
)paren
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|data
op_assign
id|hpfs_get_sector
c_func
(paren
id|s
comma
id|n
comma
op_amp
id|bh
)paren
)paren
)paren
(brace
id|hpfs_free_sectors
c_func
(paren
id|s
comma
id|n
comma
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|data
comma
id|fnode_ea
c_func
(paren
id|fnode
)paren
comma
id|fnode-&gt;ea_size_s
)paren
suffix:semicolon
id|fnode-&gt;ea_size_l
op_assign
id|fnode-&gt;ea_size_s
suffix:semicolon
id|fnode-&gt;ea_size_s
op_assign
l_int|0
suffix:semicolon
id|fnode-&gt;ea_secno
op_assign
id|n
suffix:semicolon
id|fnode-&gt;ea_anode
op_assign
l_int|0
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|bh
)paren
suffix:semicolon
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
)brace
id|pos
op_assign
id|fnode-&gt;ea_size_l
op_plus
l_int|5
op_plus
id|strlen
c_func
(paren
id|key
)paren
op_plus
id|size
suffix:semicolon
id|len
op_assign
(paren
id|fnode-&gt;ea_size_l
op_plus
l_int|511
)paren
op_rshift
l_int|9
suffix:semicolon
r_if
c_cond
(paren
id|pos
op_ge
l_int|30000
)paren
r_goto
id|bail
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|pos
op_plus
l_int|511
)paren
op_rshift
l_int|9
)paren
OG
id|len
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|fnode-&gt;ea_secno
op_assign
id|hpfs_alloc_sector
c_func
(paren
id|s
comma
id|fno
comma
l_int|1
comma
l_int|0
comma
l_int|1
)paren
)paren
)paren
r_goto
id|bail
suffix:semicolon
id|fnode-&gt;ea_anode
op_assign
l_int|0
suffix:semicolon
id|len
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|fnode-&gt;ea_anode
)paren
(brace
r_if
c_cond
(paren
id|hpfs_alloc_if_possible
c_func
(paren
id|s
comma
id|fnode-&gt;ea_secno
op_plus
id|len
)paren
)paren
(brace
id|len
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Aargh... don&squot;t know how to create ea anodes :-( */
multiline_comment|/*struct buffer_head *bh;&n;&t;&t;&t;&t;struct anode *anode;&n;&t;&t;&t;&t;anode_secno a_s;&n;&t;&t;&t;&t;if (!(anode = hpfs_alloc_anode(s, fno, &amp;a_s, &amp;bh)))&n;&t;&t;&t;&t;&t;goto bail;&n;&t;&t;&t;&t;anode-&gt;up = fno;&n;&t;&t;&t;&t;anode-&gt;btree.fnode_parent = 1;&n;&t;&t;&t;&t;anode-&gt;btree.n_free_nodes--;&n;&t;&t;&t;&t;anode-&gt;btree.n_used_nodes++;&n;&t;&t;&t;&t;anode-&gt;btree.first_free += 12;&n;&t;&t;&t;&t;anode-&gt;u.external[0].disk_secno = fnode-&gt;ea_secno;&n;&t;&t;&t;&t;anode-&gt;u.external[0].file_secno = 0;&n;&t;&t;&t;&t;anode-&gt;u.external[0].length = len;&n;&t;&t;&t;&t;mark_buffer_dirty(bh);&n;&t;&t;&t;&t;brelse(bh);&n;&t;&t;&t;&t;fnode-&gt;ea_anode = 1;&n;&t;&t;&t;&t;fnode-&gt;ea_secno = a_s;*/
id|secno
id|new_sec
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|new_sec
op_assign
id|hpfs_alloc_sector
c_func
(paren
id|s
comma
id|fno
comma
l_int|1
comma
l_int|1
op_minus
(paren
(paren
id|pos
op_plus
l_int|511
)paren
op_rshift
l_int|9
)paren
comma
l_int|1
)paren
)paren
)paren
r_goto
id|bail
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|buffer_head
op_star
id|bh1
comma
op_star
id|bh2
suffix:semicolon
r_void
op_star
id|b1
comma
op_star
id|b2
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|b1
op_assign
id|hpfs_map_sector
c_func
(paren
id|s
comma
id|fnode-&gt;ea_secno
op_plus
id|i
comma
op_amp
id|bh1
comma
id|len
op_minus
id|i
op_minus
l_int|1
)paren
)paren
)paren
(brace
id|hpfs_free_sectors
c_func
(paren
id|s
comma
id|new_sec
comma
(paren
id|pos
op_plus
l_int|511
)paren
op_rshift
l_int|9
)paren
suffix:semicolon
r_goto
id|bail
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|b2
op_assign
id|hpfs_get_sector
c_func
(paren
id|s
comma
id|new_sec
op_plus
id|i
comma
op_amp
id|bh2
)paren
)paren
)paren
(brace
id|brelse
c_func
(paren
id|bh1
)paren
suffix:semicolon
id|hpfs_free_sectors
c_func
(paren
id|s
comma
id|new_sec
comma
(paren
id|pos
op_plus
l_int|511
)paren
op_rshift
l_int|9
)paren
suffix:semicolon
r_goto
id|bail
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|b2
comma
id|b1
comma
l_int|512
)paren
suffix:semicolon
id|brelse
c_func
(paren
id|bh1
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|bh2
)paren
suffix:semicolon
id|brelse
c_func
(paren
id|bh2
)paren
suffix:semicolon
)brace
id|hpfs_free_sectors
c_func
(paren
id|s
comma
id|fnode-&gt;ea_secno
comma
id|len
)paren
suffix:semicolon
id|fnode-&gt;ea_secno
op_assign
id|new_sec
suffix:semicolon
id|len
op_assign
(paren
id|pos
op_plus
l_int|511
)paren
op_rshift
l_int|9
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|fnode-&gt;ea_anode
)paren
(brace
r_if
c_cond
(paren
id|hpfs_add_sector_to_btree
c_func
(paren
id|s
comma
id|fnode-&gt;ea_secno
comma
l_int|0
comma
id|len
)paren
op_ne
op_minus
l_int|1
)paren
(brace
id|len
op_increment
suffix:semicolon
)brace
r_else
(brace
r_goto
id|bail
suffix:semicolon
)brace
)brace
)brace
id|h
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|h
(braket
l_int|1
)braket
op_assign
id|strlen
c_func
(paren
id|key
)paren
suffix:semicolon
id|h
(braket
l_int|2
)braket
op_assign
id|size
op_amp
l_int|0xff
suffix:semicolon
id|h
(braket
l_int|3
)braket
op_assign
id|size
op_rshift
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|hpfs_ea_write
c_func
(paren
id|s
comma
id|fnode-&gt;ea_secno
comma
id|fnode-&gt;ea_anode
comma
id|fnode-&gt;ea_size_l
comma
l_int|4
comma
id|h
)paren
)paren
r_goto
id|bail
suffix:semicolon
r_if
c_cond
(paren
id|hpfs_ea_write
c_func
(paren
id|s
comma
id|fnode-&gt;ea_secno
comma
id|fnode-&gt;ea_anode
comma
id|fnode-&gt;ea_size_l
op_plus
l_int|4
comma
id|h
(braket
l_int|1
)braket
op_plus
l_int|1
comma
id|key
)paren
)paren
r_goto
id|bail
suffix:semicolon
r_if
c_cond
(paren
id|hpfs_ea_write
c_func
(paren
id|s
comma
id|fnode-&gt;ea_secno
comma
id|fnode-&gt;ea_anode
comma
id|fnode-&gt;ea_size_l
op_plus
l_int|5
op_plus
id|h
(braket
l_int|1
)braket
comma
id|size
comma
id|data
)paren
)paren
r_goto
id|bail
suffix:semicolon
id|fnode-&gt;ea_size_l
op_assign
id|pos
suffix:semicolon
id|ret
suffix:colon
id|inode-&gt;i_hpfs_ea_size
op_add_assign
l_int|5
op_plus
id|strlen
c_func
(paren
id|key
)paren
op_plus
id|size
suffix:semicolon
r_return
suffix:semicolon
id|bail
suffix:colon
r_if
c_cond
(paren
id|fnode-&gt;ea_secno
)paren
r_if
c_cond
(paren
id|fnode-&gt;ea_anode
)paren
id|hpfs_truncate_btree
c_func
(paren
id|s
comma
id|fnode-&gt;ea_secno
comma
l_int|1
comma
(paren
id|fnode-&gt;ea_size_l
op_plus
l_int|511
)paren
op_rshift
l_int|9
)paren
suffix:semicolon
r_else
id|hpfs_free_sectors
c_func
(paren
id|s
comma
id|fnode-&gt;ea_secno
op_plus
(paren
(paren
id|fnode-&gt;ea_size_l
op_plus
l_int|511
)paren
op_rshift
l_int|9
)paren
comma
id|len
op_minus
(paren
(paren
id|fnode-&gt;ea_size_l
op_plus
l_int|511
)paren
op_rshift
l_int|9
)paren
)paren
suffix:semicolon
r_else
id|fnode-&gt;ea_secno
op_assign
id|fnode-&gt;ea_size_l
op_assign
l_int|0
suffix:semicolon
)brace
eof
