multiline_comment|/*&n; *  linux/fs/hpfs/dnode.c&n; *&n; *  Mikulas Patocka (mikulas@artax.karlin.mff.cuni.cz), 1998-1999&n; *&n; *  handling directory dnode tree - adding, deleteing &amp; searching for dirents&n; */
macro_line|#include &quot;hpfs_fn.h&quot;
DECL|function|get_pos
r_static
id|loff_t
id|get_pos
c_func
(paren
r_struct
id|dnode
op_star
id|d
comma
r_struct
id|hpfs_dirent
op_star
id|fde
)paren
(brace
r_struct
id|hpfs_dirent
op_star
id|de
suffix:semicolon
r_struct
id|hpfs_dirent
op_star
id|de_end
op_assign
id|dnode_end_de
c_func
(paren
id|d
)paren
suffix:semicolon
r_int
id|i
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|de
op_assign
id|dnode_first_de
c_func
(paren
id|d
)paren
suffix:semicolon
id|de
OL
id|de_end
suffix:semicolon
id|de
op_assign
id|de_next_de
c_func
(paren
id|de
)paren
)paren
(brace
r_if
c_cond
(paren
id|de
op_eq
id|fde
)paren
r_return
(paren
(paren
id|loff_t
)paren
id|d-&gt;self
op_lshift
l_int|4
)paren
op_or
(paren
id|loff_t
)paren
id|i
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;HPFS: get_pos: not_found&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
(paren
id|loff_t
)paren
id|d-&gt;self
op_lshift
l_int|4
)paren
op_or
(paren
id|loff_t
)paren
l_int|1
suffix:semicolon
)brace
DECL|function|hpfs_add_pos
r_void
id|hpfs_add_pos
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
id|loff_t
op_star
id|pos
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|loff_t
op_star
op_star
id|ppos
suffix:semicolon
r_if
c_cond
(paren
id|inode-&gt;i_hpfs_rddir_off
)paren
r_for
c_loop
(paren
suffix:semicolon
id|inode-&gt;i_hpfs_rddir_off
(braket
id|i
)braket
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|inode-&gt;i_hpfs_rddir_off
(braket
id|i
)braket
op_eq
id|pos
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|i
op_amp
l_int|0x0f
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|ppos
op_assign
id|kmalloc
c_func
(paren
(paren
id|i
op_plus
l_int|0x11
)paren
op_star
r_sizeof
(paren
id|loff_t
op_star
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HPFS: out of memory for position list&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inode-&gt;i_hpfs_rddir_off
)paren
(brace
id|memcpy
c_func
(paren
id|ppos
comma
id|inode-&gt;i_hpfs_rddir_off
comma
id|i
op_star
r_sizeof
(paren
id|loff_t
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|inode-&gt;i_hpfs_rddir_off
)paren
suffix:semicolon
)brace
id|inode-&gt;i_hpfs_rddir_off
op_assign
id|ppos
suffix:semicolon
)brace
id|inode-&gt;i_hpfs_rddir_off
(braket
id|i
)braket
op_assign
id|pos
suffix:semicolon
id|inode-&gt;i_hpfs_rddir_off
(braket
id|i
op_plus
l_int|1
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|hpfs_del_pos
r_void
id|hpfs_del_pos
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
id|loff_t
op_star
id|pos
)paren
(brace
id|loff_t
op_star
op_star
id|i
comma
op_star
op_star
id|j
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode-&gt;i_hpfs_rddir_off
)paren
r_goto
id|not_f
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|inode-&gt;i_hpfs_rddir_off
suffix:semicolon
op_star
id|i
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_star
id|i
op_eq
id|pos
)paren
r_goto
id|fnd
suffix:semicolon
r_goto
id|not_f
suffix:semicolon
id|fnd
suffix:colon
r_for
c_loop
(paren
id|j
op_assign
id|i
op_plus
l_int|1
suffix:semicolon
op_star
id|j
suffix:semicolon
id|j
op_increment
)paren
suffix:semicolon
op_star
id|i
op_assign
op_star
(paren
id|j
op_minus
l_int|1
)paren
suffix:semicolon
op_star
(paren
id|j
op_minus
l_int|1
)paren
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|j
op_minus
l_int|1
op_eq
id|inode-&gt;i_hpfs_rddir_off
)paren
(brace
id|kfree
c_func
(paren
id|inode-&gt;i_hpfs_rddir_off
)paren
suffix:semicolon
id|inode-&gt;i_hpfs_rddir_off
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
suffix:semicolon
id|not_f
suffix:colon
multiline_comment|/*printk(&quot;HPFS: warning: position pointer %p-&gt;%08x not found&bslash;n&quot;, pos, (int)*pos);*/
r_return
suffix:semicolon
)brace
DECL|function|for_all_poss
r_static
r_void
id|for_all_poss
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_void
(paren
op_star
id|f
)paren
(paren
id|loff_t
op_star
comma
id|loff_t
comma
id|loff_t
)paren
comma
id|loff_t
id|p1
comma
id|loff_t
id|p2
)paren
(brace
id|loff_t
op_star
op_star
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode-&gt;i_hpfs_rddir_off
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|inode-&gt;i_hpfs_rddir_off
suffix:semicolon
op_star
id|i
suffix:semicolon
id|i
op_increment
)paren
(paren
op_star
id|f
)paren
(paren
op_star
id|i
comma
id|p1
comma
id|p2
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|hpfs_pos_subst
r_void
id|hpfs_pos_subst
c_func
(paren
id|loff_t
op_star
id|p
comma
id|loff_t
id|f
comma
id|loff_t
id|t
)paren
(brace
r_if
c_cond
(paren
op_star
id|p
op_eq
id|f
)paren
op_star
id|p
op_assign
id|t
suffix:semicolon
)brace
multiline_comment|/*void hpfs_hpfs_pos_substd(loff_t *p, loff_t f, loff_t t)&n;{&n;&t;if ((*p &amp; ~0x3f) == (f &amp; ~0x3f)) *p = (t &amp; ~0x3f) | (*p &amp; 0x3f);&n;}*/
DECL|function|hpfs_pos_ins
r_void
id|hpfs_pos_ins
c_func
(paren
id|loff_t
op_star
id|p
comma
id|loff_t
id|d
comma
id|loff_t
id|c
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|p
op_amp
op_complement
l_int|0x3f
)paren
op_eq
(paren
id|d
op_amp
op_complement
l_int|0x3f
)paren
op_logical_and
(paren
op_star
id|p
op_amp
l_int|0x3f
)paren
op_ge
(paren
id|d
op_amp
l_int|0x3f
)paren
)paren
(brace
r_int
id|n
op_assign
(paren
op_star
id|p
op_amp
l_int|0x3f
)paren
op_plus
id|c
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
l_int|0x3f
)paren
id|printk
c_func
(paren
l_string|&quot;HPFS: hpfs_pos_ins: %08x + %d&bslash;n&quot;
comma
(paren
r_int
)paren
op_star
id|p
comma
(paren
r_int
)paren
id|c
op_rshift
l_int|8
)paren
suffix:semicolon
r_else
op_star
id|p
op_assign
(paren
op_star
id|p
op_amp
op_complement
l_int|0x3f
)paren
op_or
id|n
suffix:semicolon
)brace
)brace
DECL|function|hpfs_pos_del
r_void
id|hpfs_pos_del
c_func
(paren
id|loff_t
op_star
id|p
comma
id|loff_t
id|d
comma
id|loff_t
id|c
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|p
op_amp
op_complement
l_int|0x3f
)paren
op_eq
(paren
id|d
op_amp
op_complement
l_int|0x3f
)paren
op_logical_and
(paren
op_star
id|p
op_amp
l_int|0x3f
)paren
op_ge
(paren
id|d
op_amp
l_int|0x3f
)paren
)paren
(brace
r_int
id|n
op_assign
(paren
op_star
id|p
op_amp
l_int|0x3f
)paren
op_minus
id|c
suffix:semicolon
r_if
c_cond
(paren
id|n
OL
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;HPFS: hpfs_pos_ins: %08x - %d&bslash;n&quot;
comma
(paren
r_int
)paren
op_star
id|p
comma
(paren
r_int
)paren
id|c
op_rshift
l_int|8
)paren
suffix:semicolon
r_else
op_star
id|p
op_assign
(paren
op_star
id|p
op_amp
op_complement
l_int|0x3f
)paren
op_or
id|n
suffix:semicolon
)brace
)brace
DECL|function|dnode_pre_last_de
r_static
r_struct
id|hpfs_dirent
op_star
id|dnode_pre_last_de
c_func
(paren
r_struct
id|dnode
op_star
id|d
)paren
(brace
r_struct
id|hpfs_dirent
op_star
id|de
comma
op_star
id|de_end
comma
op_star
id|dee
op_assign
l_int|NULL
comma
op_star
id|deee
op_assign
l_int|NULL
suffix:semicolon
id|de_end
op_assign
id|dnode_end_de
c_func
(paren
id|d
)paren
suffix:semicolon
r_for
c_loop
(paren
id|de
op_assign
id|dnode_first_de
c_func
(paren
id|d
)paren
suffix:semicolon
id|de
OL
id|de_end
suffix:semicolon
id|de
op_assign
id|de_next_de
c_func
(paren
id|de
)paren
)paren
(brace
id|deee
op_assign
id|dee
suffix:semicolon
id|dee
op_assign
id|de
suffix:semicolon
)brace
r_return
id|deee
suffix:semicolon
)brace
DECL|function|dnode_last_de
r_static
r_struct
id|hpfs_dirent
op_star
id|dnode_last_de
c_func
(paren
r_struct
id|dnode
op_star
id|d
)paren
(brace
r_struct
id|hpfs_dirent
op_star
id|de
comma
op_star
id|de_end
comma
op_star
id|dee
op_assign
l_int|NULL
suffix:semicolon
id|de_end
op_assign
id|dnode_end_de
c_func
(paren
id|d
)paren
suffix:semicolon
r_for
c_loop
(paren
id|de
op_assign
id|dnode_first_de
c_func
(paren
id|d
)paren
suffix:semicolon
id|de
OL
id|de_end
suffix:semicolon
id|de
op_assign
id|de_next_de
c_func
(paren
id|de
)paren
)paren
(brace
id|dee
op_assign
id|de
suffix:semicolon
)brace
r_return
id|dee
suffix:semicolon
)brace
DECL|function|set_last_pointer
r_static
r_void
id|set_last_pointer
c_func
(paren
r_struct
id|super_block
op_star
id|s
comma
r_struct
id|dnode
op_star
id|d
comma
id|dnode_secno
id|ptr
)paren
(brace
r_struct
id|hpfs_dirent
op_star
id|de
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|de
op_assign
id|dnode_last_de
c_func
(paren
id|d
)paren
)paren
)paren
(brace
id|hpfs_error
c_func
(paren
id|s
comma
l_string|&quot;set_last_pointer: empty dnode %08x&quot;
comma
id|d-&gt;self
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s-&gt;s_hpfs_chk
)paren
(brace
r_if
c_cond
(paren
id|de-&gt;down
)paren
(brace
id|hpfs_error
c_func
(paren
id|s
comma
l_string|&quot;set_last_pointer: dnode %08x has already last pointer %08x&quot;
comma
id|d-&gt;self
comma
id|de_down_pointer
c_func
(paren
id|de
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|de-&gt;length
op_ne
l_int|32
)paren
(brace
id|hpfs_error
c_func
(paren
id|s
comma
l_string|&quot;set_last_pointer: bad last dirent in dnode %08x&quot;
comma
id|d-&gt;self
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|ptr
)paren
(brace
r_if
c_cond
(paren
(paren
id|d-&gt;first_free
op_add_assign
l_int|4
)paren
OG
l_int|2048
)paren
(brace
id|hpfs_error
c_func
(paren
id|s
comma
l_string|&quot;set_last_pointer: too long dnode %08x&quot;
comma
id|d-&gt;self
)paren
suffix:semicolon
id|d-&gt;first_free
op_sub_assign
l_int|4
suffix:semicolon
r_return
suffix:semicolon
)brace
id|de-&gt;length
op_assign
l_int|36
suffix:semicolon
id|de-&gt;down
op_assign
l_int|1
suffix:semicolon
op_star
(paren
id|dnode_secno
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|de
op_plus
l_int|32
)paren
op_assign
id|ptr
suffix:semicolon
)brace
)brace
multiline_comment|/* Add an entry to dnode and don&squot;t care if it grows over 2048 bytes */
DECL|function|hpfs_add_de
r_struct
id|hpfs_dirent
op_star
id|hpfs_add_de
c_func
(paren
r_struct
id|super_block
op_star
id|s
comma
r_struct
id|dnode
op_star
id|d
comma
r_int
r_char
op_star
id|name
comma
r_int
id|namelen
comma
id|secno
id|down_ptr
)paren
(brace
r_struct
id|hpfs_dirent
op_star
id|de
suffix:semicolon
r_struct
id|hpfs_dirent
op_star
id|de_end
op_assign
id|dnode_end_de
c_func
(paren
id|d
)paren
suffix:semicolon
r_int
id|d_size
op_assign
id|de_size
c_func
(paren
id|namelen
comma
id|down_ptr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|de
op_assign
id|dnode_first_de
c_func
(paren
id|d
)paren
suffix:semicolon
id|de
OL
id|de_end
suffix:semicolon
id|de
op_assign
id|de_next_de
c_func
(paren
id|de
)paren
)paren
(brace
r_int
id|c
op_assign
id|hpfs_compare_names
c_func
(paren
id|s
comma
id|name
comma
id|namelen
comma
id|de-&gt;name
comma
id|de-&gt;namelen
comma
id|de-&gt;last
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c
)paren
(brace
id|hpfs_error
c_func
(paren
id|s
comma
l_string|&quot;name (%c,%d) already exists in dnode %08x&quot;
comma
op_star
id|name
comma
id|namelen
comma
id|d-&gt;self
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|c
OL
l_int|0
)paren
r_break
suffix:semicolon
)brace
id|memmove
c_func
(paren
(paren
r_char
op_star
)paren
id|de
op_plus
id|d_size
comma
id|de
comma
(paren
r_char
op_star
)paren
id|de_end
op_minus
(paren
r_char
op_star
)paren
id|de
)paren
suffix:semicolon
id|memset
c_func
(paren
id|de
comma
l_int|0
comma
id|d_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|down_ptr
)paren
(brace
op_star
(paren
r_int
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|de
op_plus
id|d_size
op_minus
l_int|4
)paren
op_assign
id|down_ptr
suffix:semicolon
id|de-&gt;down
op_assign
l_int|1
suffix:semicolon
)brace
id|de-&gt;length
op_assign
id|d_size
suffix:semicolon
r_if
c_cond
(paren
id|down_ptr
)paren
id|de-&gt;down
op_assign
l_int|1
suffix:semicolon
id|de-&gt;not_8x3
op_assign
id|hpfs_is_name_long
c_func
(paren
id|name
comma
id|namelen
)paren
suffix:semicolon
id|de-&gt;namelen
op_assign
id|namelen
suffix:semicolon
id|memcpy
c_func
(paren
id|de-&gt;name
comma
id|name
comma
id|namelen
)paren
suffix:semicolon
id|d-&gt;first_free
op_add_assign
id|d_size
suffix:semicolon
r_return
id|de
suffix:semicolon
)brace
multiline_comment|/* Delete dirent and don&squot;t care about it&squot;s subtree */
DECL|function|hpfs_delete_de
r_void
id|hpfs_delete_de
c_func
(paren
r_struct
id|super_block
op_star
id|s
comma
r_struct
id|dnode
op_star
id|d
comma
r_struct
id|hpfs_dirent
op_star
id|de
)paren
(brace
r_if
c_cond
(paren
id|de-&gt;last
)paren
(brace
id|hpfs_error
c_func
(paren
id|s
comma
l_string|&quot;attempt to delete last dirent in dnode %08x&quot;
comma
id|d-&gt;self
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|d-&gt;first_free
op_sub_assign
id|de-&gt;length
suffix:semicolon
id|memmove
c_func
(paren
id|de
comma
id|de_next_de
c_func
(paren
id|de
)paren
comma
id|d-&gt;first_free
op_plus
(paren
r_char
op_star
)paren
id|d
op_minus
(paren
r_char
op_star
)paren
id|de
)paren
suffix:semicolon
)brace
DECL|function|fix_up_ptrs
r_static
r_void
id|fix_up_ptrs
c_func
(paren
r_struct
id|super_block
op_star
id|s
comma
r_struct
id|dnode
op_star
id|d
)paren
(brace
r_struct
id|hpfs_dirent
op_star
id|de
suffix:semicolon
r_struct
id|hpfs_dirent
op_star
id|de_end
op_assign
id|dnode_end_de
c_func
(paren
id|d
)paren
suffix:semicolon
id|dnode_secno
id|dno
op_assign
id|d-&gt;self
suffix:semicolon
r_for
c_loop
(paren
id|de
op_assign
id|dnode_first_de
c_func
(paren
id|d
)paren
suffix:semicolon
id|de
OL
id|de_end
suffix:semicolon
id|de
op_assign
id|de_next_de
c_func
(paren
id|de
)paren
)paren
r_if
c_cond
(paren
id|de-&gt;down
)paren
(brace
r_struct
id|quad_buffer_head
id|qbh
suffix:semicolon
r_struct
id|dnode
op_star
id|dd
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dd
op_assign
id|hpfs_map_dnode
c_func
(paren
id|s
comma
id|de_down_pointer
c_func
(paren
id|de
)paren
comma
op_amp
id|qbh
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|dd-&gt;up
op_ne
id|dno
op_logical_or
id|dd-&gt;root_dnode
)paren
(brace
id|dd-&gt;up
op_assign
id|dno
suffix:semicolon
id|dd-&gt;root_dnode
op_assign
l_int|0
suffix:semicolon
id|hpfs_mark_4buffers_dirty
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
)brace
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Add an entry to dnode and do dnode splitting if required */
DECL|function|hpfs_add_to_dnode
r_int
id|hpfs_add_to_dnode
c_func
(paren
r_struct
id|inode
op_star
id|i
comma
id|dnode_secno
id|dno
comma
r_int
r_char
op_star
id|name
comma
r_int
id|namelen
comma
r_struct
id|hpfs_dirent
op_star
id|new_de
comma
id|dnode_secno
id|down_ptr
)paren
(brace
r_struct
id|quad_buffer_head
id|qbh
comma
id|qbh1
comma
id|qbh2
suffix:semicolon
r_struct
id|dnode
op_star
id|d
comma
op_star
id|ad
comma
op_star
id|rd
comma
op_star
id|nd
op_assign
l_int|NULL
suffix:semicolon
id|dnode_secno
id|adno
comma
id|rdno
suffix:semicolon
r_struct
id|hpfs_dirent
op_star
id|de
suffix:semicolon
r_struct
id|hpfs_dirent
id|nde
suffix:semicolon
r_char
op_star
id|nname
suffix:semicolon
r_int
id|h
suffix:semicolon
r_int
id|pos
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_struct
id|fnode
op_star
id|fnode
suffix:semicolon
r_int
id|c1
comma
id|c2
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|nname
op_assign
id|kmalloc
c_func
(paren
l_int|256
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HPFS: out of memory, can&squot;t add to dnode&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|go_up
suffix:colon
r_if
c_cond
(paren
id|namelen
op_ge
l_int|256
)paren
(brace
id|hpfs_error
c_func
(paren
id|i-&gt;i_sb
comma
l_string|&quot;hpfs_add_to_dnode: namelen == %d&quot;
comma
id|namelen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nd
)paren
id|kfree
c_func
(paren
id|nd
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|nname
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|d
op_assign
id|hpfs_map_dnode
c_func
(paren
id|i-&gt;i_sb
comma
id|dno
comma
op_amp
id|qbh
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|nd
)paren
id|kfree
c_func
(paren
id|nd
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|nname
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|go_up_a
suffix:colon
r_if
c_cond
(paren
id|i-&gt;i_sb-&gt;s_hpfs_chk
)paren
r_if
c_cond
(paren
id|hpfs_stop_cycles
c_func
(paren
id|i-&gt;i_sb
comma
id|dno
comma
op_amp
id|c1
comma
op_amp
id|c2
comma
l_string|&quot;hpfs_add_to_dnode&quot;
)paren
)paren
(brace
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nd
)paren
id|kfree
c_func
(paren
id|nd
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|nname
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|d-&gt;first_free
op_plus
id|de_size
c_func
(paren
id|namelen
comma
id|down_ptr
)paren
op_le
l_int|2048
)paren
(brace
id|loff_t
id|t
suffix:semicolon
id|copy_de
c_func
(paren
id|de
op_assign
id|hpfs_add_de
c_func
(paren
id|i-&gt;i_sb
comma
id|d
comma
id|name
comma
id|namelen
comma
id|down_ptr
)paren
comma
id|new_de
)paren
suffix:semicolon
id|t
op_assign
id|get_pos
c_func
(paren
id|d
comma
id|de
)paren
suffix:semicolon
id|for_all_poss
c_func
(paren
id|i
comma
id|hpfs_pos_ins
comma
id|t
comma
l_int|1
)paren
suffix:semicolon
id|for_all_poss
c_func
(paren
id|i
comma
id|hpfs_pos_subst
comma
l_int|4
comma
id|t
)paren
suffix:semicolon
id|for_all_poss
c_func
(paren
id|i
comma
id|hpfs_pos_subst
comma
l_int|5
comma
id|t
op_plus
l_int|1
)paren
suffix:semicolon
id|hpfs_mark_4buffers_dirty
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nd
)paren
id|kfree
c_func
(paren
id|nd
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|nname
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|nd
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|nd
op_assign
id|kmalloc
c_func
(paren
l_int|0x924
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
multiline_comment|/* 0x924 is a max size of dnode after adding a dirent with&n;&t;&t;   max name length. We alloc this only once. There must&n;&t;&t;   not be any error while splitting dnodes, otherwise the&n;&t;&t;   whole directory, not only file we&squot;re adding, would&n;&t;&t;   be lost. */
id|printk
c_func
(paren
l_string|&quot;HPFS: out of memory for dnode splitting&bslash;n&quot;
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|nname
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|nd
comma
id|d
comma
id|d-&gt;first_free
)paren
suffix:semicolon
id|copy_de
c_func
(paren
id|de
op_assign
id|hpfs_add_de
c_func
(paren
id|i-&gt;i_sb
comma
id|nd
comma
id|name
comma
id|namelen
comma
id|down_ptr
)paren
comma
id|new_de
)paren
suffix:semicolon
id|for_all_poss
c_func
(paren
id|i
comma
id|hpfs_pos_ins
comma
id|get_pos
c_func
(paren
id|nd
comma
id|de
)paren
comma
l_int|1
)paren
suffix:semicolon
id|h
op_assign
(paren
(paren
r_char
op_star
)paren
id|dnode_last_de
c_func
(paren
id|nd
)paren
op_minus
(paren
r_char
op_star
)paren
id|nd
)paren
op_div
l_int|2
op_plus
l_int|10
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ad
op_assign
id|hpfs_alloc_dnode
c_func
(paren
id|i-&gt;i_sb
comma
id|d-&gt;up
comma
op_amp
id|adno
comma
op_amp
id|qbh1
comma
l_int|0
)paren
)paren
)paren
(brace
id|hpfs_error
c_func
(paren
id|i-&gt;i_sb
comma
l_string|&quot;unable to alloc dnode - dnode tree will be corrupted&quot;
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|nd
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|nname
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|i-&gt;i_size
op_add_assign
l_int|2048
suffix:semicolon
id|i-&gt;i_blocks
op_add_assign
l_int|4
suffix:semicolon
id|pos
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|de
op_assign
id|dnode_first_de
c_func
(paren
id|nd
)paren
suffix:semicolon
(paren
r_char
op_star
)paren
id|de_next_de
c_func
(paren
id|de
)paren
op_minus
(paren
r_char
op_star
)paren
id|nd
OL
id|h
suffix:semicolon
id|de
op_assign
id|de_next_de
c_func
(paren
id|de
)paren
)paren
(brace
id|copy_de
c_func
(paren
id|hpfs_add_de
c_func
(paren
id|i-&gt;i_sb
comma
id|ad
comma
id|de-&gt;name
comma
id|de-&gt;namelen
comma
id|de-&gt;down
ques
c_cond
id|de_down_pointer
c_func
(paren
id|de
)paren
suffix:colon
l_int|0
)paren
comma
id|de
)paren
suffix:semicolon
id|for_all_poss
c_func
(paren
id|i
comma
id|hpfs_pos_subst
comma
(paren
(paren
id|loff_t
)paren
id|dno
op_lshift
l_int|4
)paren
op_or
id|pos
comma
(paren
(paren
id|loff_t
)paren
id|adno
op_lshift
l_int|4
)paren
op_or
id|pos
)paren
suffix:semicolon
id|pos
op_increment
suffix:semicolon
)brace
id|copy_de
c_func
(paren
id|new_de
op_assign
op_amp
id|nde
comma
id|de
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|name
op_assign
id|nname
comma
id|de-&gt;name
comma
id|namelen
op_assign
id|de-&gt;namelen
)paren
suffix:semicolon
id|for_all_poss
c_func
(paren
id|i
comma
id|hpfs_pos_subst
comma
(paren
(paren
id|loff_t
)paren
id|dno
op_lshift
l_int|4
)paren
op_or
id|pos
comma
l_int|4
)paren
suffix:semicolon
id|down_ptr
op_assign
id|adno
suffix:semicolon
id|set_last_pointer
c_func
(paren
id|i-&gt;i_sb
comma
id|ad
comma
id|de-&gt;down
ques
c_cond
id|de_down_pointer
c_func
(paren
id|de
)paren
suffix:colon
l_int|0
)paren
suffix:semicolon
id|de
op_assign
id|de_next_de
c_func
(paren
id|de
)paren
suffix:semicolon
id|memmove
c_func
(paren
(paren
r_char
op_star
)paren
id|nd
op_plus
l_int|20
comma
id|de
comma
id|nd-&gt;first_free
op_plus
(paren
r_char
op_star
)paren
id|nd
op_minus
(paren
r_char
op_star
)paren
id|de
)paren
suffix:semicolon
id|nd-&gt;first_free
op_sub_assign
(paren
r_char
op_star
)paren
id|de
op_minus
(paren
r_char
op_star
)paren
id|nd
op_minus
l_int|20
suffix:semicolon
id|memcpy
c_func
(paren
id|d
comma
id|nd
comma
id|nd-&gt;first_free
)paren
suffix:semicolon
id|for_all_poss
c_func
(paren
id|i
comma
id|hpfs_pos_del
comma
(paren
id|loff_t
)paren
id|dno
op_lshift
l_int|4
comma
id|pos
)paren
suffix:semicolon
id|fix_up_ptrs
c_func
(paren
id|i-&gt;i_sb
comma
id|ad
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|d-&gt;root_dnode
)paren
(brace
id|dno
op_assign
id|ad-&gt;up
op_assign
id|d-&gt;up
suffix:semicolon
id|hpfs_mark_4buffers_dirty
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
id|hpfs_mark_4buffers_dirty
c_func
(paren
op_amp
id|qbh1
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh1
)paren
suffix:semicolon
r_goto
id|go_up
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|rd
op_assign
id|hpfs_alloc_dnode
c_func
(paren
id|i-&gt;i_sb
comma
id|d-&gt;up
comma
op_amp
id|rdno
comma
op_amp
id|qbh2
comma
l_int|0
)paren
)paren
)paren
(brace
id|hpfs_error
c_func
(paren
id|i-&gt;i_sb
comma
l_string|&quot;unable to alloc dnode - dnode tree will be corrupted&quot;
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh1
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|nd
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|nname
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|i-&gt;i_size
op_add_assign
l_int|2048
suffix:semicolon
id|i-&gt;i_blocks
op_add_assign
l_int|4
suffix:semicolon
id|rd-&gt;root_dnode
op_assign
l_int|1
suffix:semicolon
id|rd-&gt;up
op_assign
id|d-&gt;up
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|fnode
op_assign
id|hpfs_map_fnode
c_func
(paren
id|i-&gt;i_sb
comma
id|d-&gt;up
comma
op_amp
id|bh
)paren
)paren
)paren
(brace
id|hpfs_free_dnode
c_func
(paren
id|i-&gt;i_sb
comma
id|rdno
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh1
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh2
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|nd
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|nname
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|fnode-&gt;u.external
(braket
l_int|0
)braket
dot
id|disk_secno
op_assign
id|rdno
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|bh
)paren
suffix:semicolon
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
id|d-&gt;up
op_assign
id|ad-&gt;up
op_assign
id|i-&gt;i_hpfs_dno
op_assign
id|rdno
suffix:semicolon
id|d-&gt;root_dnode
op_assign
id|ad-&gt;root_dnode
op_assign
l_int|0
suffix:semicolon
id|hpfs_mark_4buffers_dirty
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
id|hpfs_mark_4buffers_dirty
c_func
(paren
op_amp
id|qbh1
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh1
)paren
suffix:semicolon
id|qbh
op_assign
id|qbh2
suffix:semicolon
id|set_last_pointer
c_func
(paren
id|i-&gt;i_sb
comma
id|rd
comma
id|dno
)paren
suffix:semicolon
id|dno
op_assign
id|rdno
suffix:semicolon
id|d
op_assign
id|rd
suffix:semicolon
r_goto
id|go_up_a
suffix:semicolon
)brace
multiline_comment|/*&n; * Add an entry to directory btree.&n; * I hate such crazy directory structure.&n; * It&squot;s easy to read but terrible to write.&n; * I wrote this directory code 4 times.&n; * I hope, now it&squot;s finally bug-free.&n; */
DECL|function|hpfs_add_dirent
r_int
id|hpfs_add_dirent
c_func
(paren
r_struct
id|inode
op_star
id|i
comma
r_int
r_char
op_star
id|name
comma
r_int
id|namelen
comma
r_struct
id|hpfs_dirent
op_star
id|new_de
comma
r_int
id|cdepth
)paren
(brace
r_struct
id|dnode
op_star
id|d
suffix:semicolon
r_struct
id|hpfs_dirent
op_star
id|de
comma
op_star
id|de_end
suffix:semicolon
r_struct
id|quad_buffer_head
id|qbh
suffix:semicolon
id|dnode_secno
id|dno
suffix:semicolon
r_int
id|c
suffix:semicolon
r_int
id|c1
comma
id|c2
op_assign
l_int|0
suffix:semicolon
id|dno
op_assign
id|i-&gt;i_hpfs_dno
suffix:semicolon
id|down
suffix:colon
r_if
c_cond
(paren
id|i-&gt;i_sb-&gt;s_hpfs_chk
)paren
r_if
c_cond
(paren
id|hpfs_stop_cycles
c_func
(paren
id|i-&gt;i_sb
comma
id|dno
comma
op_amp
id|c1
comma
op_amp
id|c2
comma
l_string|&quot;hpfs_add_dirent&quot;
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|d
op_assign
id|hpfs_map_dnode
c_func
(paren
id|i-&gt;i_sb
comma
id|dno
comma
op_amp
id|qbh
)paren
)paren
)paren
r_return
l_int|1
suffix:semicolon
id|de_end
op_assign
id|dnode_end_de
c_func
(paren
id|d
)paren
suffix:semicolon
r_for
c_loop
(paren
id|de
op_assign
id|dnode_first_de
c_func
(paren
id|d
)paren
suffix:semicolon
id|de
OL
id|de_end
suffix:semicolon
id|de
op_assign
id|de_next_de
c_func
(paren
id|de
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|c
op_assign
id|hpfs_compare_names
c_func
(paren
id|i-&gt;i_sb
comma
id|name
comma
id|namelen
comma
id|de-&gt;name
comma
id|de-&gt;namelen
comma
id|de-&gt;last
)paren
)paren
)paren
(brace
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|c
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|de-&gt;down
)paren
(brace
id|dno
op_assign
id|de_down_pointer
c_func
(paren
id|de
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
r_goto
id|down
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cdepth
)paren
id|hpfs_lock_creation
c_func
(paren
id|i-&gt;i_sb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hpfs_check_free_dnodes
c_func
(paren
id|i-&gt;i_sb
comma
id|FREE_DNODES_ADD
)paren
)paren
(brace
id|c
op_assign
l_int|1
suffix:semicolon
r_goto
id|ret
suffix:semicolon
)brace
id|i-&gt;i_version
op_assign
op_increment
id|event
suffix:semicolon
id|c
op_assign
id|hpfs_add_to_dnode
c_func
(paren
id|i
comma
id|dno
comma
id|name
comma
id|namelen
comma
id|new_de
comma
l_int|0
)paren
suffix:semicolon
id|ret
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|cdepth
)paren
id|hpfs_unlock_creation
c_func
(paren
id|i-&gt;i_sb
)paren
suffix:semicolon
r_return
id|c
suffix:semicolon
)brace
multiline_comment|/* &n; * Find dirent with higher name in &squot;from&squot; subtree and move it to &squot;to&squot; dnode.&n; * Return the dnode we moved from (to be checked later if it&squot;s empty)&n; */
DECL|function|move_to_top
r_static
id|secno
id|move_to_top
c_func
(paren
r_struct
id|inode
op_star
id|i
comma
id|dnode_secno
id|from
comma
id|dnode_secno
id|to
)paren
(brace
id|dnode_secno
id|dno
comma
id|ddno
suffix:semicolon
id|dnode_secno
id|chk_up
op_assign
id|to
suffix:semicolon
r_struct
id|dnode
op_star
id|dnode
suffix:semicolon
r_struct
id|quad_buffer_head
id|qbh
suffix:semicolon
r_struct
id|hpfs_dirent
op_star
id|de
comma
op_star
id|nde
suffix:semicolon
r_int
id|a
suffix:semicolon
id|loff_t
id|t
suffix:semicolon
r_int
id|c1
comma
id|c2
op_assign
l_int|0
suffix:semicolon
id|dno
op_assign
id|from
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|i-&gt;i_sb-&gt;s_hpfs_chk
)paren
r_if
c_cond
(paren
id|hpfs_stop_cycles
c_func
(paren
id|i-&gt;i_sb
comma
id|dno
comma
op_amp
id|c1
comma
op_amp
id|c2
comma
l_string|&quot;move_to_top&quot;
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dnode
op_assign
id|hpfs_map_dnode
c_func
(paren
id|i-&gt;i_sb
comma
id|dno
comma
op_amp
id|qbh
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|i-&gt;i_sb-&gt;s_hpfs_chk
)paren
(brace
r_if
c_cond
(paren
id|dnode-&gt;up
op_ne
id|chk_up
)paren
(brace
id|hpfs_error
c_func
(paren
id|i-&gt;i_sb
comma
l_string|&quot;move_to_top: up pointer from %08x should be %08x, is %08x&quot;
comma
id|dno
comma
id|chk_up
comma
id|dnode-&gt;up
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|chk_up
op_assign
id|dno
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|de
op_assign
id|dnode_last_de
c_func
(paren
id|dnode
)paren
)paren
)paren
(brace
id|hpfs_error
c_func
(paren
id|i-&gt;i_sb
comma
l_string|&quot;move_to_top: dnode %08x has no last de&quot;
comma
id|dno
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|de-&gt;down
)paren
r_break
suffix:semicolon
id|dno
op_assign
id|de_down_pointer
c_func
(paren
id|de
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|de
op_assign
id|dnode_pre_last_de
c_func
(paren
id|dnode
)paren
)paren
)paren
(brace
id|dnode_secno
id|up
op_assign
id|dnode-&gt;up
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
id|hpfs_free_dnode
c_func
(paren
id|i-&gt;i_sb
comma
id|dno
)paren
suffix:semicolon
id|i-&gt;i_size
op_sub_assign
l_int|2048
suffix:semicolon
id|i-&gt;i_blocks
op_sub_assign
l_int|4
suffix:semicolon
id|for_all_poss
c_func
(paren
id|i
comma
id|hpfs_pos_subst
comma
(paren
(paren
id|loff_t
)paren
id|dno
op_lshift
l_int|4
)paren
op_or
l_int|1
comma
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|up
op_eq
id|to
)paren
r_return
id|to
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dnode
op_assign
id|hpfs_map_dnode
c_func
(paren
id|i-&gt;i_sb
comma
id|up
comma
op_amp
id|qbh
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dnode-&gt;root_dnode
)paren
(brace
id|hpfs_error
c_func
(paren
id|i-&gt;i_sb
comma
l_string|&quot;move_to_top: got to root_dnode while moving from %08x to %08x&quot;
comma
id|from
comma
id|to
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|de
op_assign
id|dnode_last_de
c_func
(paren
id|dnode
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|de
op_logical_or
op_logical_neg
id|de-&gt;down
)paren
(brace
id|hpfs_error
c_func
(paren
id|i-&gt;i_sb
comma
l_string|&quot;move_to_top: dnode %08x doesn&squot;t point down to %08x&quot;
comma
id|up
comma
id|dno
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|dnode-&gt;first_free
op_sub_assign
l_int|4
suffix:semicolon
id|de-&gt;length
op_sub_assign
l_int|4
suffix:semicolon
id|de-&gt;down
op_assign
l_int|0
suffix:semicolon
id|hpfs_mark_4buffers_dirty
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
id|dno
op_assign
id|up
suffix:semicolon
)brace
id|t
op_assign
id|get_pos
c_func
(paren
id|dnode
comma
id|de
)paren
suffix:semicolon
id|for_all_poss
c_func
(paren
id|i
comma
id|hpfs_pos_subst
comma
id|t
comma
l_int|4
)paren
suffix:semicolon
id|for_all_poss
c_func
(paren
id|i
comma
id|hpfs_pos_subst
comma
id|t
op_plus
l_int|1
comma
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|nde
op_assign
id|kmalloc
c_func
(paren
id|de-&gt;length
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|hpfs_error
c_func
(paren
id|i-&gt;i_sb
comma
l_string|&quot;out of memory for dirent - directory will be corrupted&quot;
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|nde
comma
id|de
comma
id|de-&gt;length
)paren
suffix:semicolon
id|ddno
op_assign
id|de-&gt;down
ques
c_cond
id|de_down_pointer
c_func
(paren
id|de
)paren
suffix:colon
l_int|0
suffix:semicolon
id|hpfs_delete_de
c_func
(paren
id|i-&gt;i_sb
comma
id|dnode
comma
id|de
)paren
suffix:semicolon
id|set_last_pointer
c_func
(paren
id|i-&gt;i_sb
comma
id|dnode
comma
id|ddno
)paren
suffix:semicolon
id|hpfs_mark_4buffers_dirty
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
id|a
op_assign
id|hpfs_add_to_dnode
c_func
(paren
id|i
comma
id|to
comma
id|nde-&gt;name
comma
id|nde-&gt;namelen
comma
id|nde
comma
id|from
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|nde
)paren
suffix:semicolon
r_if
c_cond
(paren
id|a
)paren
r_return
l_int|0
suffix:semicolon
r_return
id|dno
suffix:semicolon
)brace
multiline_comment|/* &n; * Check if a dnode is empty and delete it from the tree&n; * (chkdsk doesn&squot;t like empty dnodes)&n; */
DECL|function|delete_empty_dnode
r_static
r_void
id|delete_empty_dnode
c_func
(paren
r_struct
id|inode
op_star
id|i
comma
id|dnode_secno
id|dno
)paren
(brace
r_struct
id|quad_buffer_head
id|qbh
suffix:semicolon
r_struct
id|dnode
op_star
id|dnode
suffix:semicolon
id|dnode_secno
id|down
comma
id|up
comma
id|ndown
suffix:semicolon
r_int
id|p
suffix:semicolon
r_struct
id|hpfs_dirent
op_star
id|de
suffix:semicolon
r_int
id|c1
comma
id|c2
op_assign
l_int|0
suffix:semicolon
id|try_it_again
suffix:colon
r_if
c_cond
(paren
id|hpfs_stop_cycles
c_func
(paren
id|i-&gt;i_sb
comma
id|dno
comma
op_amp
id|c1
comma
op_amp
id|c2
comma
l_string|&quot;delete_empty_dnode&quot;
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dnode
op_assign
id|hpfs_map_dnode
c_func
(paren
id|i-&gt;i_sb
comma
id|dno
comma
op_amp
id|qbh
)paren
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|dnode-&gt;first_free
OG
l_int|56
)paren
r_goto
id|end
suffix:semicolon
r_if
c_cond
(paren
id|dnode-&gt;first_free
op_eq
l_int|52
op_logical_or
id|dnode-&gt;first_free
op_eq
l_int|56
)paren
(brace
r_struct
id|hpfs_dirent
op_star
id|de_end
suffix:semicolon
r_int
id|root
op_assign
id|dnode-&gt;root_dnode
suffix:semicolon
id|up
op_assign
id|dnode-&gt;up
suffix:semicolon
id|de
op_assign
id|dnode_first_de
c_func
(paren
id|dnode
)paren
suffix:semicolon
id|down
op_assign
id|de-&gt;down
ques
c_cond
id|de_down_pointer
c_func
(paren
id|de
)paren
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|i-&gt;i_sb-&gt;s_hpfs_chk
)paren
r_if
c_cond
(paren
id|root
op_logical_and
op_logical_neg
id|down
)paren
(brace
id|hpfs_error
c_func
(paren
id|i-&gt;i_sb
comma
l_string|&quot;delete_empty_dnode: root dnode %08x is empty&quot;
comma
id|dno
)paren
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
id|hpfs_free_dnode
c_func
(paren
id|i-&gt;i_sb
comma
id|dno
)paren
suffix:semicolon
id|i-&gt;i_size
op_sub_assign
l_int|2048
suffix:semicolon
id|i-&gt;i_blocks
op_sub_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|root
)paren
(brace
r_struct
id|fnode
op_star
id|fnode
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_struct
id|dnode
op_star
id|d1
suffix:semicolon
r_struct
id|quad_buffer_head
id|qbh1
suffix:semicolon
r_if
c_cond
(paren
id|i-&gt;i_sb-&gt;s_hpfs_chk
)paren
r_if
c_cond
(paren
id|up
op_ne
id|i-&gt;i_ino
)paren
(brace
id|hpfs_error
c_func
(paren
id|i-&gt;i_sb
comma
l_string|&quot;bad pointer to fnode, dnode %08x, pointing to %08x, should be %08x&quot;
comma
id|dno
comma
id|up
comma
id|i-&gt;i_ino
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|d1
op_assign
id|hpfs_map_dnode
c_func
(paren
id|i-&gt;i_sb
comma
id|down
comma
op_amp
id|qbh1
)paren
)paren
)paren
(brace
id|d1-&gt;up
op_assign
id|up
suffix:semicolon
id|d1-&gt;root_dnode
op_assign
l_int|1
suffix:semicolon
id|hpfs_mark_4buffers_dirty
c_func
(paren
op_amp
id|qbh1
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|fnode
op_assign
id|hpfs_map_fnode
c_func
(paren
id|i-&gt;i_sb
comma
id|up
comma
op_amp
id|bh
)paren
)paren
)paren
(brace
id|fnode-&gt;u.external
(braket
l_int|0
)braket
dot
id|disk_secno
op_assign
id|down
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|bh
)paren
suffix:semicolon
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
)brace
id|i-&gt;i_hpfs_dno
op_assign
id|down
suffix:semicolon
id|for_all_poss
c_func
(paren
id|i
comma
id|hpfs_pos_subst
comma
(paren
(paren
id|loff_t
)paren
id|dno
op_lshift
l_int|4
)paren
op_or
l_int|1
comma
(paren
id|loff_t
)paren
l_int|12
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|dnode
op_assign
id|hpfs_map_dnode
c_func
(paren
id|i-&gt;i_sb
comma
id|up
comma
op_amp
id|qbh
)paren
)paren
)paren
r_return
suffix:semicolon
id|p
op_assign
l_int|1
suffix:semicolon
id|de_end
op_assign
id|dnode_end_de
c_func
(paren
id|dnode
)paren
suffix:semicolon
r_for
c_loop
(paren
id|de
op_assign
id|dnode_first_de
c_func
(paren
id|dnode
)paren
suffix:semicolon
id|de
OL
id|de_end
suffix:semicolon
id|de
op_assign
id|de_next_de
c_func
(paren
id|de
)paren
comma
id|p
op_increment
)paren
r_if
c_cond
(paren
id|de-&gt;down
)paren
r_if
c_cond
(paren
id|de_down_pointer
c_func
(paren
id|de
)paren
op_eq
id|dno
)paren
r_goto
id|fnd
suffix:semicolon
id|hpfs_error
c_func
(paren
id|i-&gt;i_sb
comma
l_string|&quot;delete_empty_dnode: pointer to dnode %08x not found in dnode %08x&quot;
comma
id|dno
comma
id|up
)paren
suffix:semicolon
r_goto
id|end
suffix:semicolon
id|fnd
suffix:colon
id|for_all_poss
c_func
(paren
id|i
comma
id|hpfs_pos_subst
comma
(paren
(paren
id|loff_t
)paren
id|dno
op_lshift
l_int|4
)paren
op_or
l_int|1
comma
(paren
(paren
id|loff_t
)paren
id|up
op_lshift
l_int|4
)paren
op_or
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|down
)paren
(brace
id|de-&gt;down
op_assign
l_int|0
suffix:semicolon
id|de-&gt;length
op_sub_assign
l_int|4
suffix:semicolon
id|dnode-&gt;first_free
op_sub_assign
l_int|4
suffix:semicolon
id|memmove
c_func
(paren
id|de_next_de
c_func
(paren
id|de
)paren
comma
(paren
r_char
op_star
)paren
id|de_next_de
c_func
(paren
id|de
)paren
op_plus
l_int|4
comma
(paren
r_char
op_star
)paren
id|dnode
op_plus
id|dnode-&gt;first_free
op_minus
(paren
r_char
op_star
)paren
id|de_next_de
c_func
(paren
id|de
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|dnode
op_star
id|d1
suffix:semicolon
r_struct
id|quad_buffer_head
id|qbh1
suffix:semicolon
op_star
(paren
id|dnode_secno
op_star
)paren
(paren
(paren
r_void
op_star
)paren
id|de
op_plus
id|de-&gt;length
op_minus
l_int|4
)paren
op_assign
id|down
suffix:semicolon
r_if
c_cond
(paren
(paren
id|d1
op_assign
id|hpfs_map_dnode
c_func
(paren
id|i-&gt;i_sb
comma
id|down
comma
op_amp
id|qbh1
)paren
)paren
)paren
(brace
id|d1-&gt;up
op_assign
id|up
suffix:semicolon
id|hpfs_mark_4buffers_dirty
c_func
(paren
op_amp
id|qbh1
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh1
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|hpfs_error
c_func
(paren
id|i-&gt;i_sb
comma
l_string|&quot;delete_empty_dnode: dnode %08x, first_free == %03x&quot;
comma
id|dno
comma
id|dnode-&gt;first_free
)paren
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|de-&gt;last
)paren
(brace
r_struct
id|hpfs_dirent
op_star
id|de_next
op_assign
id|de_next_de
c_func
(paren
id|de
)paren
suffix:semicolon
r_struct
id|hpfs_dirent
op_star
id|de_cp
suffix:semicolon
r_struct
id|dnode
op_star
id|d1
suffix:semicolon
r_struct
id|quad_buffer_head
id|qbh1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|de_next-&gt;down
)paren
r_goto
id|endm
suffix:semicolon
id|ndown
op_assign
id|de_down_pointer
c_func
(paren
id|de_next
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|de_cp
op_assign
id|kmalloc
c_func
(paren
id|de-&gt;length
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HPFS: out of memory for dtree balancing&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|endm
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|de_cp
comma
id|de
comma
id|de-&gt;length
)paren
suffix:semicolon
id|hpfs_delete_de
c_func
(paren
id|i-&gt;i_sb
comma
id|dnode
comma
id|de
)paren
suffix:semicolon
id|hpfs_mark_4buffers_dirty
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
id|for_all_poss
c_func
(paren
id|i
comma
id|hpfs_pos_subst
comma
(paren
(paren
id|loff_t
)paren
id|up
op_lshift
l_int|4
)paren
op_or
id|p
comma
l_int|4
)paren
suffix:semicolon
id|for_all_poss
c_func
(paren
id|i
comma
id|hpfs_pos_del
comma
(paren
(paren
id|loff_t
)paren
id|up
op_lshift
l_int|4
)paren
op_or
id|p
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|de_cp-&gt;down
)paren
r_if
c_cond
(paren
(paren
id|d1
op_assign
id|hpfs_map_dnode
c_func
(paren
id|i-&gt;i_sb
comma
id|de_down_pointer
c_func
(paren
id|de_cp
)paren
comma
op_amp
id|qbh1
)paren
)paren
)paren
(brace
id|d1-&gt;up
op_assign
id|ndown
suffix:semicolon
id|hpfs_mark_4buffers_dirty
c_func
(paren
op_amp
id|qbh1
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh1
)paren
suffix:semicolon
)brace
id|hpfs_add_to_dnode
c_func
(paren
id|i
comma
id|ndown
comma
id|de_cp-&gt;name
comma
id|de_cp-&gt;namelen
comma
id|de_cp
comma
id|de_cp-&gt;down
ques
c_cond
id|de_down_pointer
c_func
(paren
id|de_cp
)paren
suffix:colon
l_int|0
)paren
suffix:semicolon
multiline_comment|/*printk(&quot;UP-TO-DNODE: %08x (ndown = %08x, down = %08x, dno = %08x)&bslash;n&quot;, up, ndown, down, dno);*/
id|dno
op_assign
id|up
suffix:semicolon
id|kfree
c_func
(paren
id|de_cp
)paren
suffix:semicolon
r_goto
id|try_it_again
suffix:semicolon
)brace
r_else
(brace
r_struct
id|hpfs_dirent
op_star
id|de_prev
op_assign
id|dnode_pre_last_de
c_func
(paren
id|dnode
)paren
suffix:semicolon
r_struct
id|hpfs_dirent
op_star
id|de_cp
suffix:semicolon
r_struct
id|dnode
op_star
id|d1
suffix:semicolon
r_struct
id|quad_buffer_head
id|qbh1
suffix:semicolon
id|dnode_secno
id|dlp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|de_prev
)paren
(brace
id|hpfs_error
c_func
(paren
id|i-&gt;i_sb
comma
l_string|&quot;delete_empty_dnode: empty dnode %08x&quot;
comma
id|up
)paren
suffix:semicolon
id|hpfs_mark_4buffers_dirty
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
id|dno
op_assign
id|up
suffix:semicolon
r_goto
id|try_it_again
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|de_prev-&gt;down
)paren
r_goto
id|endm
suffix:semicolon
id|ndown
op_assign
id|de_down_pointer
c_func
(paren
id|de_prev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|d1
op_assign
id|hpfs_map_dnode
c_func
(paren
id|i-&gt;i_sb
comma
id|ndown
comma
op_amp
id|qbh1
)paren
)paren
)paren
(brace
r_struct
id|hpfs_dirent
op_star
id|del
op_assign
id|dnode_last_de
c_func
(paren
id|d1
)paren
suffix:semicolon
id|dlp
op_assign
id|del-&gt;down
ques
c_cond
id|de_down_pointer
c_func
(paren
id|del
)paren
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dlp
op_logical_and
id|down
)paren
(brace
r_if
c_cond
(paren
id|d1-&gt;first_free
OG
l_int|2044
)paren
(brace
r_if
c_cond
(paren
id|i-&gt;i_sb-&gt;s_hpfs_chk
op_ge
l_int|2
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HPFS: warning: unbalanced dnode tree, see hpfs.txt 4 more info&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;HPFS: warning: terminating balancing operation&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh1
)paren
suffix:semicolon
r_goto
id|endm
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i-&gt;i_sb-&gt;s_hpfs_chk
op_ge
l_int|2
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HPFS: warning: unbalanced dnode tree, see hpfs.txt 4 more info&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;HPFS: warning: goin&squot;on&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|del-&gt;length
op_add_assign
l_int|4
suffix:semicolon
id|del-&gt;down
op_assign
l_int|1
suffix:semicolon
id|d1-&gt;first_free
op_add_assign
l_int|4
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dlp
op_logical_and
op_logical_neg
id|down
)paren
(brace
id|del-&gt;length
op_sub_assign
l_int|4
suffix:semicolon
id|del-&gt;down
op_assign
l_int|0
suffix:semicolon
id|d1-&gt;first_free
op_sub_assign
l_int|4
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|down
)paren
op_star
(paren
id|dnode_secno
op_star
)paren
(paren
(paren
r_void
op_star
)paren
id|del
op_plus
id|del-&gt;length
op_minus
l_int|4
)paren
op_assign
id|down
suffix:semicolon
)brace
r_else
r_goto
id|endm
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|de_cp
op_assign
id|kmalloc
c_func
(paren
id|de_prev-&gt;length
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HPFS: out of memory for dtree balancing&bslash;n&quot;
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh1
)paren
suffix:semicolon
r_goto
id|endm
suffix:semicolon
)brace
id|hpfs_mark_4buffers_dirty
c_func
(paren
op_amp
id|qbh1
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh1
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|de_cp
comma
id|de_prev
comma
id|de_prev-&gt;length
)paren
suffix:semicolon
id|hpfs_delete_de
c_func
(paren
id|i-&gt;i_sb
comma
id|dnode
comma
id|de_prev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|de_prev-&gt;down
)paren
(brace
id|de_prev-&gt;length
op_add_assign
l_int|4
suffix:semicolon
id|de_prev-&gt;down
op_assign
l_int|1
suffix:semicolon
id|dnode-&gt;first_free
op_add_assign
l_int|4
suffix:semicolon
)brace
op_star
(paren
id|dnode_secno
op_star
)paren
(paren
(paren
r_void
op_star
)paren
id|de_prev
op_plus
id|de_prev-&gt;length
op_minus
l_int|4
)paren
op_assign
id|ndown
suffix:semicolon
id|hpfs_mark_4buffers_dirty
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
id|for_all_poss
c_func
(paren
id|i
comma
id|hpfs_pos_subst
comma
(paren
(paren
id|loff_t
)paren
id|up
op_lshift
l_int|4
)paren
op_or
(paren
id|p
op_minus
l_int|1
)paren
comma
l_int|4
)paren
suffix:semicolon
id|for_all_poss
c_func
(paren
id|i
comma
id|hpfs_pos_subst
comma
(paren
(paren
id|loff_t
)paren
id|up
op_lshift
l_int|4
)paren
op_or
id|p
comma
(paren
(paren
id|loff_t
)paren
id|up
op_lshift
l_int|4
)paren
op_or
(paren
id|p
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|down
)paren
r_if
c_cond
(paren
(paren
id|d1
op_assign
id|hpfs_map_dnode
c_func
(paren
id|i-&gt;i_sb
comma
id|de_down_pointer
c_func
(paren
id|de
)paren
comma
op_amp
id|qbh1
)paren
)paren
)paren
(brace
id|d1-&gt;up
op_assign
id|ndown
suffix:semicolon
id|hpfs_mark_4buffers_dirty
c_func
(paren
op_amp
id|qbh1
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh1
)paren
suffix:semicolon
)brace
id|hpfs_add_to_dnode
c_func
(paren
id|i
comma
id|ndown
comma
id|de_cp-&gt;name
comma
id|de_cp-&gt;namelen
comma
id|de_cp
comma
id|dlp
)paren
suffix:semicolon
id|dno
op_assign
id|up
suffix:semicolon
id|kfree
c_func
(paren
id|de_cp
)paren
suffix:semicolon
r_goto
id|try_it_again
suffix:semicolon
)brace
id|endm
suffix:colon
id|hpfs_mark_4buffers_dirty
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
id|end
suffix:colon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
)brace
multiline_comment|/* Delete dirent from directory */
DECL|function|hpfs_remove_dirent
r_int
id|hpfs_remove_dirent
c_func
(paren
r_struct
id|inode
op_star
id|i
comma
id|dnode_secno
id|dno
comma
r_struct
id|hpfs_dirent
op_star
id|de
comma
r_struct
id|quad_buffer_head
op_star
id|qbh
comma
r_int
id|depth
)paren
(brace
r_struct
id|dnode
op_star
id|dnode
op_assign
id|qbh-&gt;data
suffix:semicolon
id|dnode_secno
id|down
op_assign
l_int|0
suffix:semicolon
r_int
id|lock
op_assign
l_int|0
suffix:semicolon
id|loff_t
id|t
suffix:semicolon
r_if
c_cond
(paren
id|de-&gt;first
op_logical_or
id|de-&gt;last
)paren
(brace
id|hpfs_error
c_func
(paren
id|i-&gt;i_sb
comma
l_string|&quot;hpfs_remove_dirent: attempt to delete first or last dirent in dnode %08x&quot;
comma
id|dno
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
id|qbh
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|de-&gt;down
)paren
id|down
op_assign
id|de_down_pointer
c_func
(paren
id|de
)paren
suffix:semicolon
r_if
c_cond
(paren
id|depth
op_logical_and
(paren
id|de-&gt;down
op_logical_or
(paren
id|de
op_eq
id|dnode_first_de
c_func
(paren
id|dnode
)paren
op_logical_and
id|de_next_de
c_func
(paren
id|de
)paren
op_member_access_from_pointer
id|last
)paren
)paren
)paren
(brace
id|lock
op_assign
l_int|1
suffix:semicolon
id|hpfs_lock_creation
c_func
(paren
id|i-&gt;i_sb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hpfs_check_free_dnodes
c_func
(paren
id|i-&gt;i_sb
comma
id|FREE_DNODES_DEL
)paren
)paren
(brace
id|hpfs_brelse4
c_func
(paren
id|qbh
)paren
suffix:semicolon
id|hpfs_unlock_creation
c_func
(paren
id|i-&gt;i_sb
)paren
suffix:semicolon
r_return
l_int|2
suffix:semicolon
)brace
)brace
id|i-&gt;i_version
op_assign
op_increment
id|event
suffix:semicolon
id|for_all_poss
c_func
(paren
id|i
comma
id|hpfs_pos_del
comma
(paren
id|t
op_assign
id|get_pos
c_func
(paren
id|dnode
comma
id|de
)paren
)paren
op_plus
l_int|1
comma
l_int|1
)paren
suffix:semicolon
id|hpfs_delete_de
c_func
(paren
id|i-&gt;i_sb
comma
id|dnode
comma
id|de
)paren
suffix:semicolon
id|hpfs_mark_4buffers_dirty
c_func
(paren
id|qbh
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
id|qbh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|down
)paren
(brace
id|dnode_secno
id|a
op_assign
id|move_to_top
c_func
(paren
id|i
comma
id|down
comma
id|dno
)paren
suffix:semicolon
id|for_all_poss
c_func
(paren
id|i
comma
id|hpfs_pos_subst
comma
l_int|5
comma
id|t
)paren
suffix:semicolon
r_if
c_cond
(paren
id|a
)paren
id|delete_empty_dnode
c_func
(paren
id|i
comma
id|a
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lock
)paren
id|hpfs_unlock_creation
c_func
(paren
id|i-&gt;i_sb
)paren
suffix:semicolon
r_return
op_logical_neg
id|a
suffix:semicolon
)brace
id|delete_empty_dnode
c_func
(paren
id|i
comma
id|dno
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lock
)paren
id|hpfs_unlock_creation
c_func
(paren
id|i-&gt;i_sb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hpfs_count_dnodes
r_void
id|hpfs_count_dnodes
c_func
(paren
r_struct
id|super_block
op_star
id|s
comma
id|dnode_secno
id|dno
comma
r_int
op_star
id|n_dnodes
comma
r_int
op_star
id|n_subdirs
comma
r_int
op_star
id|n_items
)paren
(brace
r_struct
id|dnode
op_star
id|dnode
suffix:semicolon
r_struct
id|quad_buffer_head
id|qbh
suffix:semicolon
r_struct
id|hpfs_dirent
op_star
id|de
suffix:semicolon
id|dnode_secno
id|ptr
comma
id|odno
op_assign
l_int|0
suffix:semicolon
r_int
id|c1
comma
id|c2
op_assign
l_int|0
suffix:semicolon
r_int
id|d1
comma
id|d2
op_assign
l_int|0
suffix:semicolon
id|go_down
suffix:colon
r_if
c_cond
(paren
id|n_dnodes
)paren
(paren
op_star
id|n_dnodes
)paren
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;s_hpfs_chk
)paren
r_if
c_cond
(paren
id|hpfs_stop_cycles
c_func
(paren
id|s
comma
id|dno
comma
op_amp
id|c1
comma
op_amp
id|c2
comma
l_string|&quot;hpfs_count_dnodes #1&quot;
)paren
)paren
r_return
suffix:semicolon
id|ptr
op_assign
l_int|0
suffix:semicolon
id|go_up
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dnode
op_assign
id|hpfs_map_dnode
c_func
(paren
id|s
comma
id|dno
comma
op_amp
id|qbh
)paren
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;s_hpfs_chk
)paren
r_if
c_cond
(paren
id|odno
op_logical_and
id|odno
op_ne
op_minus
l_int|1
op_logical_and
id|dnode-&gt;up
op_ne
id|odno
)paren
id|hpfs_error
c_func
(paren
id|s
comma
l_string|&quot;hpfs_count_dnodes: bad up pointer; dnode %08x, down %08x points to %08x&quot;
comma
id|odno
comma
id|dno
comma
id|dnode-&gt;up
)paren
suffix:semicolon
id|de
op_assign
id|dnode_first_de
c_func
(paren
id|dnode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptr
)paren
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|de-&gt;down
)paren
r_if
c_cond
(paren
id|de_down_pointer
c_func
(paren
id|de
)paren
op_eq
id|ptr
)paren
r_goto
id|process_de
suffix:semicolon
r_if
c_cond
(paren
id|de-&gt;last
)paren
(brace
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
id|hpfs_error
c_func
(paren
id|s
comma
l_string|&quot;hpfs_count_dnodes: pointer to dnode %08x not found in dnode %08x, got here from %08x&quot;
comma
id|ptr
comma
id|dno
comma
id|odno
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|de
op_assign
id|de_next_de
c_func
(paren
id|de
)paren
suffix:semicolon
)brace
id|next_de
suffix:colon
r_if
c_cond
(paren
id|de-&gt;down
)paren
(brace
id|odno
op_assign
id|dno
suffix:semicolon
id|dno
op_assign
id|de_down_pointer
c_func
(paren
id|de
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
r_goto
id|go_down
suffix:semicolon
)brace
id|process_de
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|de-&gt;first
op_logical_and
op_logical_neg
id|de-&gt;last
op_logical_and
id|de-&gt;directory
op_logical_and
id|n_subdirs
)paren
(paren
op_star
id|n_subdirs
)paren
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|de-&gt;first
op_logical_and
op_logical_neg
id|de-&gt;last
op_logical_and
id|n_items
)paren
(paren
op_star
id|n_items
)paren
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|de
op_assign
id|de_next_de
c_func
(paren
id|de
)paren
)paren
OL
id|dnode_end_de
c_func
(paren
id|dnode
)paren
)paren
r_goto
id|next_de
suffix:semicolon
id|ptr
op_assign
id|dno
suffix:semicolon
id|dno
op_assign
id|dnode-&gt;up
suffix:semicolon
r_if
c_cond
(paren
id|dnode-&gt;root_dnode
)paren
(brace
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;s_hpfs_chk
)paren
r_if
c_cond
(paren
id|hpfs_stop_cycles
c_func
(paren
id|s
comma
id|ptr
comma
op_amp
id|d1
comma
op_amp
id|d2
comma
l_string|&quot;hpfs_count_dnodes #2&quot;
)paren
)paren
r_return
suffix:semicolon
id|odno
op_assign
op_minus
l_int|1
suffix:semicolon
r_goto
id|go_up
suffix:semicolon
)brace
DECL|function|map_nth_dirent
r_static
r_struct
id|hpfs_dirent
op_star
id|map_nth_dirent
c_func
(paren
r_struct
id|super_block
op_star
id|s
comma
id|dnode_secno
id|dno
comma
r_int
id|n
comma
r_struct
id|quad_buffer_head
op_star
id|qbh
comma
r_struct
id|dnode
op_star
op_star
id|dn
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|hpfs_dirent
op_star
id|de
comma
op_star
id|de_end
suffix:semicolon
r_struct
id|dnode
op_star
id|dnode
suffix:semicolon
id|dnode
op_assign
id|hpfs_map_dnode
c_func
(paren
id|s
comma
id|dno
comma
id|qbh
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dnode
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|dn
)paren
op_star
id|dn
op_assign
id|dnode
suffix:semicolon
id|de
op_assign
id|dnode_first_de
c_func
(paren
id|dnode
)paren
suffix:semicolon
id|de_end
op_assign
id|dnode_end_de
c_func
(paren
id|dnode
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|de
OL
id|de_end
suffix:semicolon
id|i
op_increment
comma
id|de
op_assign
id|de_next_de
c_func
(paren
id|de
)paren
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
id|n
)paren
(brace
r_return
id|de
suffix:semicolon
)brace
r_if
c_cond
(paren
id|de-&gt;last
)paren
r_break
suffix:semicolon
)brace
id|hpfs_brelse4
c_func
(paren
id|qbh
)paren
suffix:semicolon
id|hpfs_error
c_func
(paren
id|s
comma
l_string|&quot;map_nth_dirent: n too high; dnode = %08x, requested %08x&quot;
comma
id|dno
comma
id|n
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|hpfs_de_as_down_as_possible
id|dnode_secno
id|hpfs_de_as_down_as_possible
c_func
(paren
r_struct
id|super_block
op_star
id|s
comma
id|dnode_secno
id|dno
)paren
(brace
r_struct
id|quad_buffer_head
id|qbh
suffix:semicolon
id|dnode_secno
id|d
op_assign
id|dno
suffix:semicolon
id|dnode_secno
id|up
op_assign
l_int|0
suffix:semicolon
r_struct
id|hpfs_dirent
op_star
id|de
suffix:semicolon
r_int
id|c1
comma
id|c2
op_assign
l_int|0
suffix:semicolon
id|again
suffix:colon
r_if
c_cond
(paren
id|s-&gt;s_hpfs_chk
)paren
r_if
c_cond
(paren
id|hpfs_stop_cycles
c_func
(paren
id|s
comma
id|d
comma
op_amp
id|c1
comma
op_amp
id|c2
comma
l_string|&quot;hpfs_de_as_down_as_possible&quot;
)paren
)paren
r_return
id|d
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|de
op_assign
id|map_nth_dirent
c_func
(paren
id|s
comma
id|d
comma
l_int|1
comma
op_amp
id|qbh
comma
l_int|NULL
)paren
)paren
)paren
r_return
id|dno
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;s_hpfs_chk
)paren
r_if
c_cond
(paren
id|up
op_logical_and
(paren
(paren
r_struct
id|dnode
op_star
)paren
id|qbh.data
)paren
op_member_access_from_pointer
id|up
op_ne
id|up
)paren
id|hpfs_error
c_func
(paren
id|s
comma
l_string|&quot;hpfs_de_as_down_as_possible: bad up pointer; dnode %08x, down %08x points to %08x&quot;
comma
id|up
comma
id|d
comma
(paren
(paren
r_struct
id|dnode
op_star
)paren
id|qbh.data
)paren
op_member_access_from_pointer
id|up
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|de-&gt;down
)paren
(brace
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
r_return
id|d
suffix:semicolon
)brace
id|up
op_assign
id|d
suffix:semicolon
id|d
op_assign
id|de_down_pointer
c_func
(paren
id|de
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
r_goto
id|again
suffix:semicolon
)brace
DECL|function|map_pos_dirent
r_struct
id|hpfs_dirent
op_star
id|map_pos_dirent
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
id|loff_t
op_star
id|posp
comma
r_struct
id|quad_buffer_head
op_star
id|qbh
)paren
(brace
id|loff_t
id|pos
suffix:semicolon
r_int
id|c
suffix:semicolon
id|dnode_secno
id|dno
suffix:semicolon
r_struct
id|hpfs_dirent
op_star
id|de
comma
op_star
id|d
suffix:semicolon
r_struct
id|hpfs_dirent
op_star
id|up_de
suffix:semicolon
r_struct
id|hpfs_dirent
op_star
id|end_up_de
suffix:semicolon
r_struct
id|dnode
op_star
id|dnode
suffix:semicolon
r_struct
id|dnode
op_star
id|up_dnode
suffix:semicolon
r_struct
id|quad_buffer_head
id|qbh0
suffix:semicolon
id|pos
op_assign
op_star
id|posp
suffix:semicolon
id|dno
op_assign
id|pos
op_rshift
l_int|6
op_lshift
l_int|2
suffix:semicolon
id|pos
op_and_assign
l_int|077
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|de
op_assign
id|map_nth_dirent
c_func
(paren
id|inode-&gt;i_sb
comma
id|dno
comma
id|pos
comma
id|qbh
comma
op_amp
id|dnode
)paren
)paren
)paren
r_goto
id|bail
suffix:semicolon
multiline_comment|/* Going to the next dirent */
r_if
c_cond
(paren
(paren
id|d
op_assign
id|de_next_de
c_func
(paren
id|de
)paren
)paren
OL
id|dnode_end_de
c_func
(paren
id|dnode
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
op_increment
op_star
id|posp
op_amp
l_int|077
)paren
)paren
(brace
id|hpfs_error
c_func
(paren
id|inode-&gt;i_sb
comma
l_string|&quot;map_pos_dirent: pos crossed dnode boundary; pos = %08x&quot;
comma
op_star
id|posp
)paren
suffix:semicolon
r_goto
id|bail
suffix:semicolon
)brace
multiline_comment|/* We&squot;re going down the tree */
r_if
c_cond
(paren
id|d-&gt;down
)paren
(brace
op_star
id|posp
op_assign
(paren
(paren
id|loff_t
)paren
id|hpfs_de_as_down_as_possible
c_func
(paren
id|inode-&gt;i_sb
comma
id|de_down_pointer
c_func
(paren
id|d
)paren
)paren
op_lshift
l_int|4
)paren
op_plus
l_int|1
suffix:semicolon
)brace
r_return
id|de
suffix:semicolon
)brace
multiline_comment|/* Going up */
r_if
c_cond
(paren
id|dnode-&gt;root_dnode
)paren
r_goto
id|bail
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|up_dnode
op_assign
id|hpfs_map_dnode
c_func
(paren
id|inode-&gt;i_sb
comma
id|dnode-&gt;up
comma
op_amp
id|qbh0
)paren
)paren
)paren
r_goto
id|bail
suffix:semicolon
id|end_up_de
op_assign
id|dnode_end_de
c_func
(paren
id|up_dnode
)paren
suffix:semicolon
id|c
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|up_de
op_assign
id|dnode_first_de
c_func
(paren
id|up_dnode
)paren
suffix:semicolon
id|up_de
OL
id|end_up_de
suffix:semicolon
id|up_de
op_assign
id|de_next_de
c_func
(paren
id|up_de
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
op_increment
id|c
op_amp
l_int|077
)paren
)paren
id|hpfs_error
c_func
(paren
id|inode-&gt;i_sb
comma
l_string|&quot;map_pos_dirent: pos crossed dnode boundary; dnode = %08x&quot;
comma
id|dnode-&gt;up
)paren
suffix:semicolon
r_if
c_cond
(paren
id|up_de-&gt;down
op_logical_and
id|de_down_pointer
c_func
(paren
id|up_de
)paren
op_eq
id|dno
)paren
(brace
op_star
id|posp
op_assign
(paren
(paren
id|loff_t
)paren
id|dnode-&gt;up
op_lshift
l_int|4
)paren
op_plus
id|c
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh0
)paren
suffix:semicolon
r_return
id|de
suffix:semicolon
)brace
)brace
id|hpfs_error
c_func
(paren
id|inode-&gt;i_sb
comma
l_string|&quot;map_pos_dirent: pointer to dnode %08x not found in parent dnode %08x&quot;
comma
id|dno
comma
id|dnode-&gt;up
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh0
)paren
suffix:semicolon
id|bail
suffix:colon
op_star
id|posp
op_assign
l_int|12
suffix:semicolon
r_return
id|de
suffix:semicolon
)brace
multiline_comment|/* Find a dirent in tree */
DECL|function|map_dirent
r_struct
id|hpfs_dirent
op_star
id|map_dirent
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
id|dnode_secno
id|dno
comma
r_char
op_star
id|name
comma
r_int
id|len
comma
id|dnode_secno
op_star
id|dd
comma
r_struct
id|quad_buffer_head
op_star
id|qbh
)paren
(brace
r_struct
id|dnode
op_star
id|dnode
suffix:semicolon
r_struct
id|hpfs_dirent
op_star
id|de
suffix:semicolon
r_struct
id|hpfs_dirent
op_star
id|de_end
suffix:semicolon
r_int
id|c1
comma
id|c2
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|S_ISDIR
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
id|hpfs_error
c_func
(paren
id|inode-&gt;i_sb
comma
l_string|&quot;map_dirent: not a directory&bslash;n&quot;
)paren
suffix:semicolon
id|again
suffix:colon
r_if
c_cond
(paren
id|inode-&gt;i_sb-&gt;s_hpfs_chk
)paren
r_if
c_cond
(paren
id|hpfs_stop_cycles
c_func
(paren
id|inode-&gt;i_sb
comma
id|dno
comma
op_amp
id|c1
comma
op_amp
id|c2
comma
l_string|&quot;map_dirent&quot;
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dnode
op_assign
id|hpfs_map_dnode
c_func
(paren
id|inode-&gt;i_sb
comma
id|dno
comma
id|qbh
)paren
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
id|de_end
op_assign
id|dnode_end_de
c_func
(paren
id|dnode
)paren
suffix:semicolon
r_for
c_loop
(paren
id|de
op_assign
id|dnode_first_de
c_func
(paren
id|dnode
)paren
suffix:semicolon
id|de
OL
id|de_end
suffix:semicolon
id|de
op_assign
id|de_next_de
c_func
(paren
id|de
)paren
)paren
(brace
r_int
id|t
op_assign
id|hpfs_compare_names
c_func
(paren
id|inode-&gt;i_sb
comma
id|name
comma
id|len
comma
id|de-&gt;name
comma
id|de-&gt;namelen
comma
id|de-&gt;last
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|t
)paren
(brace
r_if
c_cond
(paren
id|dd
)paren
op_star
id|dd
op_assign
id|dno
suffix:semicolon
r_return
id|de
suffix:semicolon
)brace
r_if
c_cond
(paren
id|t
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|de-&gt;down
)paren
(brace
id|dno
op_assign
id|de_down_pointer
c_func
(paren
id|de
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
id|qbh
)paren
suffix:semicolon
r_goto
id|again
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
id|hpfs_brelse4
c_func
(paren
id|qbh
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Remove empty directory. In normal cases it is only one dnode with two&n; * entries, but we must handle also such obscure cases when it&squot;s a tree&n; * of empty dnodes.&n; */
DECL|function|hpfs_remove_dtree
r_void
id|hpfs_remove_dtree
c_func
(paren
r_struct
id|super_block
op_star
id|s
comma
id|dnode_secno
id|dno
)paren
(brace
r_struct
id|quad_buffer_head
id|qbh
suffix:semicolon
r_struct
id|dnode
op_star
id|dnode
suffix:semicolon
r_struct
id|hpfs_dirent
op_star
id|de
suffix:semicolon
id|dnode_secno
id|d1
comma
id|d2
comma
id|rdno
op_assign
id|dno
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|dnode
op_assign
id|hpfs_map_dnode
c_func
(paren
id|s
comma
id|dno
comma
op_amp
id|qbh
)paren
)paren
)paren
r_return
suffix:semicolon
id|de
op_assign
id|dnode_first_de
c_func
(paren
id|dnode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|de-&gt;last
)paren
(brace
r_if
c_cond
(paren
id|de-&gt;down
)paren
id|d1
op_assign
id|de_down_pointer
c_func
(paren
id|de
)paren
suffix:semicolon
r_else
r_goto
id|error
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
id|hpfs_free_dnode
c_func
(paren
id|s
comma
id|dno
)paren
suffix:semicolon
id|dno
op_assign
id|d1
suffix:semicolon
)brace
r_else
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|de-&gt;first
)paren
r_goto
id|error
suffix:semicolon
id|d1
op_assign
id|de-&gt;down
ques
c_cond
id|de_down_pointer
c_func
(paren
id|de
)paren
suffix:colon
l_int|0
suffix:semicolon
id|de
op_assign
id|de_next_de
c_func
(paren
id|de
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|de-&gt;last
)paren
r_goto
id|error
suffix:semicolon
id|d2
op_assign
id|de-&gt;down
ques
c_cond
id|de_down_pointer
c_func
(paren
id|de
)paren
suffix:colon
l_int|0
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
id|hpfs_free_dnode
c_func
(paren
id|s
comma
id|dno
)paren
suffix:semicolon
r_do
(brace
r_while
c_loop
(paren
id|d1
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|dnode
op_assign
id|hpfs_map_dnode
c_func
(paren
id|s
comma
id|dno
op_assign
id|d1
comma
op_amp
id|qbh
)paren
)paren
)paren
r_return
suffix:semicolon
id|de
op_assign
id|dnode_first_de
c_func
(paren
id|dnode
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|de-&gt;last
)paren
r_goto
id|error
suffix:semicolon
id|d1
op_assign
id|de-&gt;down
ques
c_cond
id|de_down_pointer
c_func
(paren
id|de
)paren
suffix:colon
l_int|0
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
id|hpfs_free_dnode
c_func
(paren
id|s
comma
id|dno
)paren
suffix:semicolon
)brace
id|d1
op_assign
id|d2
suffix:semicolon
id|d2
op_assign
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
id|d1
)paren
suffix:semicolon
r_return
suffix:semicolon
id|error
suffix:colon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
id|hpfs_free_dnode
c_func
(paren
id|s
comma
id|dno
)paren
suffix:semicolon
id|hpfs_error
c_func
(paren
id|s
comma
l_string|&quot;directory %08x is corrupted or not empty&quot;
comma
id|rdno
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * Find dirent for specified fnode. Use truncated 15-char name in fnode as&n; * a help for searching.&n; */
DECL|function|map_fnode_dirent
r_struct
id|hpfs_dirent
op_star
id|map_fnode_dirent
c_func
(paren
r_struct
id|super_block
op_star
id|s
comma
id|fnode_secno
id|fno
comma
r_struct
id|fnode
op_star
id|f
comma
r_struct
id|quad_buffer_head
op_star
id|qbh
)paren
(brace
r_char
op_star
id|name1
suffix:semicolon
r_char
op_star
id|name2
suffix:semicolon
r_int
id|name1len
comma
id|name2len
suffix:semicolon
r_struct
id|dnode
op_star
id|d
suffix:semicolon
id|dnode_secno
id|dno
comma
id|downd
suffix:semicolon
r_struct
id|fnode
op_star
id|upf
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_struct
id|hpfs_dirent
op_star
id|de
comma
op_star
id|de_end
suffix:semicolon
r_int
id|c
suffix:semicolon
r_int
id|c1
comma
id|c2
op_assign
l_int|0
suffix:semicolon
r_int
id|d1
comma
id|d2
op_assign
l_int|0
suffix:semicolon
id|name1
op_assign
id|f-&gt;name
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|name2
op_assign
id|kmalloc
c_func
(paren
l_int|256
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HPFS: out of memory, can&squot;t map dirent&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|f-&gt;len
op_le
l_int|15
)paren
id|memcpy
c_func
(paren
id|name2
comma
id|name1
comma
id|name1len
op_assign
id|name2len
op_assign
id|f-&gt;len
)paren
suffix:semicolon
r_else
(brace
id|memcpy
c_func
(paren
id|name2
comma
id|name1
comma
l_int|15
)paren
suffix:semicolon
id|memset
c_func
(paren
id|name2
op_plus
l_int|15
comma
l_int|0xff
comma
l_int|256
op_minus
l_int|15
)paren
suffix:semicolon
multiline_comment|/*name2[15] = 0xff;*/
id|name1len
op_assign
l_int|15
suffix:semicolon
id|name2len
op_assign
l_int|256
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|upf
op_assign
id|hpfs_map_fnode
c_func
(paren
id|s
comma
id|f-&gt;up
comma
op_amp
id|bh
)paren
)paren
)paren
(brace
id|kfree
c_func
(paren
id|name2
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|upf-&gt;dirflag
)paren
(brace
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
id|hpfs_error
c_func
(paren
id|s
comma
l_string|&quot;fnode %08x has non-directory parent %08x&quot;
comma
id|fno
comma
id|f-&gt;up
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|name2
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|dno
op_assign
id|upf-&gt;u.external
(braket
l_int|0
)braket
dot
id|disk_secno
suffix:semicolon
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
id|go_down
suffix:colon
id|downd
op_assign
l_int|0
suffix:semicolon
id|go_up
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|d
op_assign
id|hpfs_map_dnode
c_func
(paren
id|s
comma
id|dno
comma
id|qbh
)paren
)paren
)paren
(brace
id|kfree
c_func
(paren
id|name2
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|de_end
op_assign
id|dnode_end_de
c_func
(paren
id|d
)paren
suffix:semicolon
id|de
op_assign
id|dnode_first_de
c_func
(paren
id|d
)paren
suffix:semicolon
r_if
c_cond
(paren
id|downd
)paren
(brace
r_while
c_loop
(paren
id|de
OL
id|de_end
)paren
(brace
r_if
c_cond
(paren
id|de-&gt;down
)paren
r_if
c_cond
(paren
id|de_down_pointer
c_func
(paren
id|de
)paren
op_eq
id|downd
)paren
r_goto
id|f
suffix:semicolon
id|de
op_assign
id|de_next_de
c_func
(paren
id|de
)paren
suffix:semicolon
)brace
id|hpfs_error
c_func
(paren
id|s
comma
l_string|&quot;pointer to dnode %08x not found in dnode %08x&quot;
comma
id|downd
comma
id|dno
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
id|qbh
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|name2
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|next_de
suffix:colon
r_if
c_cond
(paren
id|de-&gt;fnode
op_eq
id|fno
)paren
(brace
id|kfree
c_func
(paren
id|name2
)paren
suffix:semicolon
r_return
id|de
suffix:semicolon
)brace
id|c
op_assign
id|hpfs_compare_names
c_func
(paren
id|s
comma
id|name1
comma
id|name1len
comma
id|de-&gt;name
comma
id|de-&gt;namelen
comma
id|de-&gt;last
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
OL
l_int|0
op_logical_and
id|de-&gt;down
)paren
(brace
id|dno
op_assign
id|de_down_pointer
c_func
(paren
id|de
)paren
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
id|qbh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;s_hpfs_chk
)paren
r_if
c_cond
(paren
id|hpfs_stop_cycles
c_func
(paren
id|s
comma
id|dno
comma
op_amp
id|c1
comma
op_amp
id|c2
comma
l_string|&quot;map_fnode_dirent #1&quot;
)paren
)paren
(brace
id|kfree
c_func
(paren
id|name2
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_goto
id|go_down
suffix:semicolon
)brace
id|f
suffix:colon
r_if
c_cond
(paren
id|de-&gt;fnode
op_eq
id|fno
)paren
(brace
id|kfree
c_func
(paren
id|name2
)paren
suffix:semicolon
r_return
id|de
suffix:semicolon
)brace
id|c
op_assign
id|hpfs_compare_names
c_func
(paren
id|s
comma
id|name2
comma
id|name2len
comma
id|de-&gt;name
comma
id|de-&gt;namelen
comma
id|de-&gt;last
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
OL
l_int|0
op_logical_and
op_logical_neg
id|de-&gt;last
)paren
r_goto
id|not_found
suffix:semicolon
r_if
c_cond
(paren
(paren
id|de
op_assign
id|de_next_de
c_func
(paren
id|de
)paren
)paren
OL
id|de_end
)paren
r_goto
id|next_de
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;root_dnode
)paren
r_goto
id|not_found
suffix:semicolon
id|downd
op_assign
id|dno
suffix:semicolon
id|dno
op_assign
id|d-&gt;up
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
id|qbh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;s_hpfs_chk
)paren
r_if
c_cond
(paren
id|hpfs_stop_cycles
c_func
(paren
id|s
comma
id|downd
comma
op_amp
id|d1
comma
op_amp
id|d2
comma
l_string|&quot;map_fnode_dirent #2&quot;
)paren
)paren
(brace
id|kfree
c_func
(paren
id|name2
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_goto
id|go_up
suffix:semicolon
id|not_found
suffix:colon
id|hpfs_brelse4
c_func
(paren
id|qbh
)paren
suffix:semicolon
id|hpfs_error
c_func
(paren
id|s
comma
l_string|&quot;dirent for fnode %08x not found&quot;
comma
id|fno
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|name2
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
eof
