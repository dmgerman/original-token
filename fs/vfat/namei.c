multiline_comment|/*&n; *  linux/fs/vfat/namei.c&n; *&n; *  Written 1992,1993 by Werner Almesberger&n; *&n; *  Windows95/Windows NT compatible extended MSDOS filesystem&n; *    by Gordon Chaffee Copyright (C) 1995.  Send bug reports for the&n; *    VFAT filesystem to &lt;chaffee@cs.berkeley.edu&gt;.  Specify&n; *    what file operation caused you trouble and if you can duplicate&n; *    the problem, send a script that demonstrates it.&n; */
macro_line|#include &lt;linux/config.h&gt;
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/msdos_fs.h&gt;
macro_line|#include &lt;linux/nls.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &quot;../fat/msbuffer.h&quot;
DECL|macro|DEBUG_LEVEL
mdefine_line|#define DEBUG_LEVEL 0
macro_line|#if (DEBUG_LEVEL &gt;= 1)
DECL|macro|PRINTK1
macro_line|#  define PRINTK1(x) printk x
macro_line|#else
DECL|macro|PRINTK1
macro_line|#  define PRINTK1(x)
macro_line|#endif
macro_line|#if (DEBUG_LEVEL &gt;= 2)
DECL|macro|PRINTK2
macro_line|#  define PRINTK2(x) printk x
macro_line|#else
DECL|macro|PRINTK2
macro_line|#  define PRINTK2(x)
macro_line|#endif
macro_line|#if (DEBUG_LEVEL &gt;= 3)
DECL|macro|PRINTK3
macro_line|#  define PRINTK3(x) printk x
macro_line|#else
DECL|macro|PRINTK3
macro_line|#  define PRINTK3(x)
macro_line|#endif
macro_line|#ifndef DEBUG
DECL|macro|CHECK_STACK
macro_line|# define CHECK_STACK
macro_line|#else
DECL|macro|CHECK_STACK
macro_line|# define CHECK_STACK check_stack(__FILE__, __LINE__)
macro_line|#endif
DECL|struct|vfat_find_info
r_struct
id|vfat_find_info
(brace
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|member|len
r_int
id|len
suffix:semicolon
DECL|member|new_filename
r_int
id|new_filename
suffix:semicolon
DECL|member|found
r_int
id|found
suffix:semicolon
DECL|member|is_long
r_int
id|is_long
suffix:semicolon
DECL|member|offset
id|off_t
id|offset
suffix:semicolon
DECL|member|short_offset
id|off_t
id|short_offset
suffix:semicolon
DECL|member|long_slots
r_int
id|long_slots
suffix:semicolon
DECL|member|ino
id|ino_t
id|ino
suffix:semicolon
DECL|member|posix
r_int
id|posix
suffix:semicolon
DECL|member|anycase
r_int
id|anycase
suffix:semicolon
)brace
suffix:semicolon
r_void
id|vfat_read_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
suffix:semicolon
r_static
r_int
id|vfat_valid_shortname
c_func
(paren
r_const
r_char
op_star
comma
r_int
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|vfat_format_name
c_func
(paren
r_const
r_char
op_star
comma
r_int
comma
r_char
op_star
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|vfat_valid_longname
c_func
(paren
r_const
r_char
op_star
comma
r_int
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|vfat_hashi
c_func
(paren
r_struct
id|dentry
op_star
id|parent
comma
r_struct
id|qstr
op_star
id|qstr
)paren
suffix:semicolon
r_static
r_int
id|vfat_hash
c_func
(paren
r_struct
id|dentry
op_star
id|parent
comma
r_struct
id|qstr
op_star
id|qstr
)paren
suffix:semicolon
r_static
r_int
id|vfat_cmpi
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|qstr
op_star
id|a
comma
r_struct
id|qstr
op_star
id|b
)paren
suffix:semicolon
r_static
r_int
id|vfat_cmp
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|qstr
op_star
id|a
comma
r_struct
id|qstr
op_star
id|b
)paren
suffix:semicolon
r_static
r_int
id|vfat_revalidate
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
)paren
suffix:semicolon
DECL|variable|vfat_dentry_ops
r_static
r_struct
id|dentry_operations
id|vfat_dentry_ops
(braket
l_int|4
)braket
op_assign
(brace
(brace
l_int|NULL
comma
multiline_comment|/* d_revalidate */
id|vfat_hashi
comma
id|vfat_cmpi
comma
l_int|NULL
multiline_comment|/* d_delete */
)brace
comma
(brace
id|vfat_revalidate
comma
id|vfat_hashi
comma
id|vfat_cmpi
comma
l_int|NULL
multiline_comment|/* d_delete */
)brace
comma
(brace
l_int|NULL
comma
multiline_comment|/* d_revalidate */
id|vfat_hash
comma
id|vfat_cmp
comma
l_int|NULL
multiline_comment|/* d_delete */
)brace
comma
(brace
id|vfat_revalidate
comma
id|vfat_hash
comma
id|vfat_cmp
comma
l_int|NULL
multiline_comment|/* d_delete */
)brace
)brace
suffix:semicolon
DECL|function|strnicmp
r_static
r_int
id|strnicmp
c_func
(paren
r_const
r_char
op_star
id|s1
comma
r_const
r_char
op_star
id|s2
comma
r_int
id|len
)paren
(brace
r_int
id|n
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_star
id|s1
op_logical_and
op_star
id|s2
op_logical_and
(paren
id|tolower
c_func
(paren
op_star
id|s1
)paren
op_eq
id|tolower
c_func
(paren
op_star
id|s2
)paren
)paren
)paren
(brace
id|s1
op_increment
suffix:semicolon
id|s2
op_increment
suffix:semicolon
id|n
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|n
op_eq
id|len
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|s1
op_eq
l_int|0
op_logical_and
op_star
id|s2
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_star
id|s1
op_logical_and
op_star
id|s2
)paren
(brace
r_if
c_cond
(paren
op_star
id|s1
OG
op_star
id|s2
)paren
r_return
l_int|1
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|s1
)paren
r_return
l_int|1
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|vfat_put_super
r_void
id|vfat_put_super
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
id|fat_put_super
c_func
(paren
id|sb
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
DECL|function|vfat_revalidate
r_static
r_int
id|vfat_revalidate
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
id|PRINTK1
c_func
(paren
(paren
l_string|&quot;vfat_revalidate: %s&bslash;n&quot;
comma
id|dentry-&gt;d_name.name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dentry-&gt;d_time
op_eq
id|dentry-&gt;d_parent-&gt;d_inode-&gt;i_version
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|vfat_sops
r_static
r_struct
id|super_operations
id|vfat_sops
op_assign
(brace
id|vfat_read_inode
comma
id|fat_write_inode
comma
id|fat_put_inode
comma
id|fat_delete_inode
comma
id|fat_notify_change
comma
id|vfat_put_super
comma
l_int|NULL
comma
multiline_comment|/* write_super */
id|fat_statfs
comma
l_int|NULL
multiline_comment|/* remount */
)brace
suffix:semicolon
DECL|function|simple_getbool
r_static
r_int
id|simple_getbool
c_func
(paren
r_char
op_star
id|s
comma
r_int
op_star
id|setval
)paren
(brace
r_if
c_cond
(paren
id|s
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|s
comma
l_string|&quot;1&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
c_func
(paren
id|s
comma
l_string|&quot;yes&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
c_func
(paren
id|s
comma
l_string|&quot;true&quot;
)paren
)paren
(brace
op_star
id|setval
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|s
comma
l_string|&quot;0&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
c_func
(paren
id|s
comma
l_string|&quot;no&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
c_func
(paren
id|s
comma
l_string|&quot;false&quot;
)paren
)paren
(brace
op_star
id|setval
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
op_star
id|setval
op_assign
l_int|1
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|parse_options
r_static
r_int
id|parse_options
c_func
(paren
r_char
op_star
id|options
comma
r_struct
id|fat_mount_options
op_star
id|opts
)paren
(brace
r_char
op_star
id|this_char
comma
op_star
id|value
comma
id|save
comma
op_star
id|savep
suffix:semicolon
r_int
id|ret
comma
id|val
suffix:semicolon
id|opts-&gt;unicode_xlate
op_assign
id|opts-&gt;posixfs
op_assign
l_int|0
suffix:semicolon
id|opts-&gt;numtail
op_assign
l_int|1
suffix:semicolon
id|opts-&gt;utf8
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
)paren
r_return
l_int|1
suffix:semicolon
id|save
op_assign
l_int|0
suffix:semicolon
id|savep
op_assign
l_int|NULL
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|this_char
op_assign
id|strtok
c_func
(paren
id|options
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
id|this_char
suffix:semicolon
id|this_char
op_assign
id|strtok
c_func
(paren
l_int|NULL
comma
l_string|&quot;,&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|value
op_assign
id|strchr
c_func
(paren
id|this_char
comma
l_char|&squot;=&squot;
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|save
op_assign
op_star
id|value
suffix:semicolon
id|savep
op_assign
id|value
suffix:semicolon
op_star
id|value
op_increment
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;utf8&quot;
)paren
)paren
(brace
id|ret
op_assign
id|simple_getbool
c_func
(paren
id|value
comma
op_amp
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|opts-&gt;utf8
op_assign
id|val
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;uni_xlate&quot;
)paren
)paren
(brace
id|ret
op_assign
id|simple_getbool
c_func
(paren
id|value
comma
op_amp
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|opts-&gt;unicode_xlate
op_assign
id|val
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;posix&quot;
)paren
)paren
(brace
id|ret
op_assign
id|simple_getbool
c_func
(paren
id|value
comma
op_amp
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|opts-&gt;posixfs
op_assign
id|val
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;nonumtail&quot;
)paren
)paren
(brace
id|ret
op_assign
id|simple_getbool
c_func
(paren
id|value
comma
op_amp
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|opts-&gt;numtail
op_assign
op_logical_neg
id|val
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|this_char
op_ne
id|options
)paren
op_star
(paren
id|this_char
op_minus
l_int|1
)paren
op_assign
l_char|&squot;,&squot;
suffix:semicolon
r_if
c_cond
(paren
id|value
)paren
(brace
op_star
id|savep
op_assign
id|save
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|opts-&gt;unicode_xlate
)paren
(brace
id|opts-&gt;utf8
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Compute the hash for the vfat name corresponding to the dentry.&n; * Note: if the name is invalid, we leave the hash code unchanged so&n; * that the existing dentry can be used. The vfat fs routines will&n; * return ENOENT or EINVAL as appropriate.&n; */
DECL|function|vfat_hash
r_static
r_int
id|vfat_hash
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|qstr
op_star
id|qstr
)paren
(brace
r_const
r_char
op_star
id|name
suffix:semicolon
r_int
id|len
suffix:semicolon
id|len
op_assign
id|qstr-&gt;len
suffix:semicolon
id|name
op_assign
id|qstr-&gt;name
suffix:semicolon
r_while
c_loop
(paren
id|len
op_logical_and
id|name
(braket
id|len
op_minus
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
)paren
id|len
op_decrement
suffix:semicolon
id|qstr-&gt;hash
op_assign
id|full_name_hash
c_func
(paren
id|name
comma
id|len
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Compute the hash for the vfat name corresponding to the dentry.&n; * Note: if the name is invalid, we leave the hash code unchanged so&n; * that the existing dentry can be used. The vfat fs routines will&n; * return ENOENT or EINVAL as appropriate.&n; */
DECL|function|vfat_hashi
r_static
r_int
id|vfat_hashi
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|qstr
op_star
id|qstr
)paren
(brace
r_const
r_char
op_star
id|name
suffix:semicolon
r_int
id|len
suffix:semicolon
r_char
id|c
suffix:semicolon
r_int
r_int
id|hash
suffix:semicolon
id|len
op_assign
id|qstr-&gt;len
suffix:semicolon
id|name
op_assign
id|qstr-&gt;name
suffix:semicolon
r_while
c_loop
(paren
id|len
op_logical_and
id|name
(braket
id|len
op_minus
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
)paren
id|len
op_decrement
suffix:semicolon
id|hash
op_assign
id|init_name_hash
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
op_decrement
)paren
(brace
id|c
op_assign
id|tolower
c_func
(paren
op_star
id|name
op_increment
)paren
suffix:semicolon
id|hash
op_assign
id|partial_name_hash
c_func
(paren
id|tolower
c_func
(paren
id|c
)paren
comma
id|hash
)paren
suffix:semicolon
)brace
id|qstr-&gt;hash
op_assign
id|end_name_hash
c_func
(paren
id|hash
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Case insensitive compare of two vfat names.&n; */
DECL|function|vfat_cmpi
r_static
r_int
id|vfat_cmpi
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|qstr
op_star
id|a
comma
r_struct
id|qstr
op_star
id|b
)paren
(brace
r_int
id|alen
comma
id|blen
suffix:semicolon
multiline_comment|/* A filename cannot end in &squot;.&squot; or we treat it like it has none */
id|alen
op_assign
id|a-&gt;len
suffix:semicolon
id|blen
op_assign
id|b-&gt;len
suffix:semicolon
r_while
c_loop
(paren
id|alen
op_logical_and
id|a-&gt;name
(braket
id|alen
op_minus
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
)paren
id|alen
op_decrement
suffix:semicolon
r_while
c_loop
(paren
id|blen
op_logical_and
id|b-&gt;name
(braket
id|blen
op_minus
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
)paren
id|blen
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|alen
op_eq
id|blen
)paren
(brace
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|a-&gt;name
comma
id|b-&gt;name
comma
id|alen
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Case sensitive compare of two vfat names.&n; */
DECL|function|vfat_cmp
r_static
r_int
id|vfat_cmp
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|qstr
op_star
id|a
comma
r_struct
id|qstr
op_star
id|b
)paren
(brace
r_int
id|alen
comma
id|blen
suffix:semicolon
multiline_comment|/* A filename cannot end in &squot;.&squot; or we treat it like it has none */
id|alen
op_assign
id|a-&gt;len
suffix:semicolon
id|blen
op_assign
id|b-&gt;len
suffix:semicolon
r_while
c_loop
(paren
id|alen
op_logical_and
id|a-&gt;name
(braket
id|alen
op_minus
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
)paren
id|alen
op_decrement
suffix:semicolon
r_while
c_loop
(paren
id|blen
op_logical_and
id|b-&gt;name
(braket
id|blen
op_minus
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
)paren
id|blen
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|alen
op_eq
id|blen
)paren
(brace
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|a-&gt;name
comma
id|b-&gt;name
comma
id|alen
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|vfat_read_super
r_struct
id|super_block
op_star
id|vfat_read_super
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_void
op_star
id|data
comma
r_int
id|silent
)paren
(brace
r_struct
id|super_block
op_star
id|res
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|MSDOS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|options.isvfat
op_assign
l_int|1
suffix:semicolon
id|sb-&gt;s_op
op_assign
op_amp
id|vfat_sops
suffix:semicolon
id|res
op_assign
id|fat_read_super
c_func
(paren
id|sb
comma
id|data
comma
id|silent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
op_eq
l_int|NULL
)paren
(brace
id|sb-&gt;s_dev
op_assign
l_int|0
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|parse_options
c_func
(paren
(paren
r_char
op_star
)paren
id|data
comma
op_amp
(paren
id|MSDOS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|options
)paren
)paren
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
r_else
(brace
id|MSDOS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|options.dotsOK
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|MSDOS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|options.posixfs
)paren
(brace
id|MSDOS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|options.name_check
op_assign
l_char|&squot;s&squot;
suffix:semicolon
)brace
r_if
c_cond
(paren
id|MSDOS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|options.name_check
op_ne
l_char|&squot;s&squot;
)paren
(brace
id|sb-&gt;s_root-&gt;d_op
op_assign
op_amp
id|vfat_dentry_ops
(braket
l_int|0
)braket
suffix:semicolon
)brace
r_else
(brace
id|sb-&gt;s_root-&gt;d_op
op_assign
op_amp
id|vfat_dentry_ops
(braket
l_int|2
)braket
suffix:semicolon
)brace
)brace
r_return
id|res
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
r_static
r_void
DECL|function|check_stack
id|check_stack
c_func
(paren
r_const
r_char
op_star
id|fname
comma
r_int
id|lineno
)paren
(brace
r_int
id|stack_level
suffix:semicolon
r_char
op_star
id|pg_dir
suffix:semicolon
id|stack_level
op_assign
(paren
r_int
)paren
(paren
op_amp
id|pg_dir
)paren
op_minus
id|current-&gt;kernel_stack_page
suffix:semicolon
r_if
c_cond
(paren
id|stack_level
OL
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;*-*-*-* vfat kstack overflow in %s line %d: SL=%d&bslash;n&quot;
comma
id|fname
comma
id|lineno
comma
id|stack_level
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|stack_level
OL
l_int|500
)paren
id|printk
c_func
(paren
l_string|&quot;*-*-*-* vfat kstack low in %s line %d: SL=%d&bslash;n&quot;
comma
id|fname
comma
id|lineno
comma
id|stack_level
)paren
suffix:semicolon
macro_line|#if 0
r_else
id|printk
c_func
(paren
l_string|&quot;------- vfat kstack ok in %s line %d: SL=%d&bslash;n&quot;
comma
id|fname
comma
id|lineno
comma
id|stack_level
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if 0
r_if
c_cond
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|current-&gt;kernel_stack_page
op_ne
id|STACK_MAGIC
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;******* vfat stack corruption detected in %s at line %d&bslash;n&quot;
comma
id|fname
comma
id|lineno
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|0
suffix:semicolon
DECL|function|dump_fat
r_static
r_void
id|dump_fat
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_int
id|start
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;[&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|start
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%d &quot;
comma
id|start
)paren
suffix:semicolon
id|start
op_assign
id|fat_access
c_func
(paren
id|sb
comma
id|start
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|start
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ERROR&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|start
op_eq
op_minus
l_int|1
)paren
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;]&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|dump_de
r_static
r_void
id|dump_de
c_func
(paren
r_struct
id|msdos_dir_entry
op_star
id|de
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_char
op_star
id|p
op_assign
(paren
r_int
r_char
op_star
)paren
id|de
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;[&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
comma
id|p
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
op_star
id|p
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;]&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* MS-DOS &quot;device special files&quot; */
DECL|variable|reserved3_names
r_static
r_const
r_char
op_star
id|reserved3_names
(braket
)braket
op_assign
(brace
l_string|&quot;con     &quot;
comma
l_string|&quot;prn     &quot;
comma
l_string|&quot;nul     &quot;
comma
l_string|&quot;aux     &quot;
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|reserved4_names
r_static
r_const
r_char
op_star
id|reserved4_names
(braket
)braket
op_assign
(brace
l_string|&quot;com1    &quot;
comma
l_string|&quot;com2    &quot;
comma
l_string|&quot;com3    &quot;
comma
l_string|&quot;com4    &quot;
comma
l_string|&quot;com5    &quot;
comma
l_string|&quot;com6    &quot;
comma
l_string|&quot;com7    &quot;
comma
l_string|&quot;com8    &quot;
comma
l_string|&quot;com9    &quot;
comma
l_string|&quot;lpt1    &quot;
comma
l_string|&quot;lpt2    &quot;
comma
l_string|&quot;lpt3    &quot;
comma
l_string|&quot;lpt4    &quot;
comma
l_string|&quot;lpt5    &quot;
comma
l_string|&quot;lpt6    &quot;
comma
l_string|&quot;lpt7    &quot;
comma
l_string|&quot;lpt8    &quot;
comma
l_string|&quot;lpt9    &quot;
comma
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/* Characters that are undesirable in an MS-DOS file name */
DECL|variable|bad_chars
r_static
r_char
id|bad_chars
(braket
)braket
op_assign
l_string|&quot;*?&lt;&gt;|&bslash;&quot;:/&bslash;&bslash;&quot;
suffix:semicolon
DECL|variable|replace_chars
r_static
r_char
id|replace_chars
(braket
)braket
op_assign
l_string|&quot;[];,+=&quot;
suffix:semicolon
r_static
r_int
id|vfat_find
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|qstr
op_star
id|name
comma
r_int
id|find_long
comma
r_int
id|new_filename
comma
r_int
id|is_dir
comma
r_struct
id|vfat_slot_info
op_star
id|sinfo_out
)paren
suffix:semicolon
multiline_comment|/* Checks the validity of a long MS-DOS filename */
multiline_comment|/* Returns negative number on error, 0 for a normal&n; * return, and 1 for . or .. */
DECL|function|vfat_valid_longname
r_static
r_int
id|vfat_valid_longname
c_func
(paren
r_const
r_char
op_star
id|name
comma
r_int
id|len
comma
r_int
id|dot_dirs
comma
r_int
id|xlate
)paren
(brace
r_const
r_char
op_star
op_star
id|reserved
comma
op_star
id|walk
suffix:semicolon
r_int
r_char
id|c
suffix:semicolon
r_int
id|i
comma
id|baselen
suffix:semicolon
r_if
c_cond
(paren
id|IS_FREE
c_func
(paren
id|name
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|name
(braket
l_int|0
)braket
op_eq
l_char|&squot;.&squot;
op_logical_and
(paren
id|len
op_eq
l_int|1
op_logical_or
(paren
id|len
op_eq
l_int|2
op_logical_and
id|name
(braket
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dot_dirs
)paren
r_return
op_minus
id|EEXIST
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
op_logical_and
id|name
(braket
id|len
op_minus
l_int|1
)braket
op_eq
l_char|&squot; &squot;
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ge
l_int|256
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|c
op_assign
id|name
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|xlate
op_logical_and
id|c
op_eq
l_char|&squot;:&squot;
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|strchr
c_func
(paren
id|bad_chars
comma
id|c
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|len
OL
l_int|3
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|walk
op_assign
id|name
suffix:semicolon
op_star
id|walk
op_ne
l_int|0
op_logical_and
op_star
id|walk
op_ne
l_char|&squot;.&squot;
suffix:semicolon
id|walk
op_increment
)paren
suffix:semicolon
id|baselen
op_assign
id|walk
op_minus
id|name
suffix:semicolon
r_if
c_cond
(paren
id|baselen
op_eq
l_int|3
)paren
(brace
r_for
c_loop
(paren
id|reserved
op_assign
id|reserved3_names
suffix:semicolon
op_star
id|reserved
suffix:semicolon
id|reserved
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strnicmp
c_func
(paren
id|name
comma
op_star
id|reserved
comma
id|baselen
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|baselen
op_eq
l_int|4
)paren
(brace
r_for
c_loop
(paren
id|reserved
op_assign
id|reserved4_names
suffix:semicolon
op_star
id|reserved
suffix:semicolon
id|reserved
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strnicmp
c_func
(paren
id|name
comma
op_star
id|reserved
comma
id|baselen
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vfat_valid_shortname
r_static
r_int
id|vfat_valid_shortname
c_func
(paren
r_const
r_char
op_star
id|name
comma
r_int
id|len
comma
r_int
id|dot_dirs
comma
r_int
id|utf8
)paren
(brace
r_const
r_char
op_star
id|walk
comma
op_star
op_star
id|reserved
suffix:semicolon
r_int
r_char
id|c
suffix:semicolon
r_int
id|space
suffix:semicolon
r_int
id|baselen
suffix:semicolon
r_if
c_cond
(paren
id|IS_FREE
c_func
(paren
id|name
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|name
(braket
l_int|0
)braket
op_eq
l_char|&squot;.&squot;
op_logical_and
(paren
id|len
op_eq
l_int|1
op_logical_or
(paren
id|len
op_eq
l_int|2
op_logical_and
id|name
(braket
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dot_dirs
)paren
r_return
op_minus
id|EEXIST
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|space
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* disallow names starting with a dot */
id|c
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|walk
op_assign
id|name
suffix:semicolon
id|len
op_logical_and
id|walk
op_minus
id|name
OL
l_int|8
suffix:semicolon
)paren
(brace
id|c
op_assign
op_star
id|walk
op_increment
suffix:semicolon
id|len
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|utf8
op_logical_and
(paren
id|c
op_amp
l_int|0x80
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|strchr
c_func
(paren
id|bad_chars
comma
id|c
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|strchr
c_func
(paren
id|replace_chars
comma
id|c
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|c
op_ge
l_char|&squot;A&squot;
op_logical_and
id|c
op_le
l_char|&squot;Z&squot;
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|c
OL
l_char|&squot; &squot;
op_logical_or
id|c
op_eq
l_char|&squot;:&squot;
op_logical_or
id|c
op_eq
l_char|&squot;&bslash;&bslash;&squot;
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|walk
op_eq
id|name
)paren
op_logical_and
(paren
id|c
op_eq
l_int|0xE5
)paren
)paren
id|c
op_assign
l_int|0x05
suffix:semicolon
r_if
c_cond
(paren
id|c
op_eq
l_char|&squot;.&squot;
)paren
r_break
suffix:semicolon
id|space
op_assign
id|c
op_eq
l_char|&squot; &squot;
suffix:semicolon
)brace
r_if
c_cond
(paren
id|space
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|len
op_logical_and
id|c
op_ne
l_char|&squot;.&squot;
)paren
(brace
id|c
op_assign
op_star
id|walk
op_increment
suffix:semicolon
id|len
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|c
op_ne
l_char|&squot;.&squot;
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_while
c_loop
(paren
id|c
op_ne
l_char|&squot;.&squot;
op_logical_and
id|len
op_decrement
)paren
id|c
op_assign
op_star
id|walk
op_increment
suffix:semicolon
id|baselen
op_assign
id|walk
op_minus
id|name
suffix:semicolon
r_if
c_cond
(paren
id|c
op_eq
l_char|&squot;.&squot;
)paren
(brace
id|baselen
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ge
l_int|4
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_while
c_loop
(paren
id|len
OG
l_int|0
op_logical_and
id|walk
op_minus
id|name
OL
(paren
id|MSDOS_NAME
op_plus
l_int|1
)paren
)paren
(brace
id|c
op_assign
op_star
id|walk
op_increment
suffix:semicolon
id|len
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|utf8
op_logical_and
(paren
id|c
op_amp
l_int|0x80
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|strchr
c_func
(paren
id|bad_chars
comma
id|c
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|strchr
c_func
(paren
id|replace_chars
comma
id|c
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|c
OL
l_char|&squot; &squot;
op_logical_or
id|c
op_eq
l_char|&squot;:&squot;
op_logical_or
id|c
op_eq
l_char|&squot;&bslash;&bslash;&squot;
op_logical_or
id|c
op_eq
l_char|&squot;.&squot;
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|c
op_ge
l_char|&squot;A&squot;
op_logical_and
id|c
op_le
l_char|&squot;Z&squot;
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|space
op_assign
id|c
op_eq
l_char|&squot; &squot;
suffix:semicolon
)brace
r_if
c_cond
(paren
id|space
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|len
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|baselen
op_eq
l_int|3
)paren
(brace
r_for
c_loop
(paren
id|reserved
op_assign
id|reserved3_names
suffix:semicolon
op_star
id|reserved
suffix:semicolon
id|reserved
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|strnicmp
c_func
(paren
id|name
comma
op_star
id|reserved
comma
id|baselen
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|baselen
op_eq
l_int|4
)paren
(brace
r_for
c_loop
(paren
id|reserved
op_assign
id|reserved4_names
suffix:semicolon
op_star
id|reserved
suffix:semicolon
id|reserved
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|strnicmp
c_func
(paren
id|name
comma
op_star
id|reserved
comma
id|baselen
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Takes a short filename and converts it to a formatted MS-DOS filename.&n; * If the short filename is not a valid MS-DOS filename, an error is &n; * returned.  The formatted short filename is returned in &squot;res&squot;.&n; */
DECL|function|vfat_format_name
r_static
r_int
id|vfat_format_name
c_func
(paren
r_const
r_char
op_star
id|name
comma
r_int
id|len
comma
r_char
op_star
id|res
comma
r_int
id|dot_dirs
comma
r_int
id|utf8
)paren
(brace
r_char
op_star
id|walk
suffix:semicolon
r_const
r_char
op_star
op_star
id|reserved
suffix:semicolon
r_int
r_char
id|c
suffix:semicolon
r_int
id|space
suffix:semicolon
r_if
c_cond
(paren
id|IS_FREE
c_func
(paren
id|name
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|name
(braket
l_int|0
)braket
op_eq
l_char|&squot;.&squot;
op_logical_and
(paren
id|len
op_eq
l_int|1
op_logical_or
(paren
id|len
op_eq
l_int|2
op_logical_and
id|name
(braket
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dot_dirs
)paren
r_return
op_minus
id|EEXIST
suffix:semicolon
id|memset
c_func
(paren
id|res
op_plus
l_int|1
comma
l_char|&squot; &squot;
comma
l_int|10
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
op_decrement
)paren
op_star
id|res
op_increment
op_assign
l_char|&squot;.&squot;
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|space
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* disallow names starting with a dot */
id|c
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|walk
op_assign
id|res
suffix:semicolon
id|len
op_logical_and
id|walk
op_minus
id|res
OL
l_int|8
suffix:semicolon
id|walk
op_increment
)paren
(brace
id|c
op_assign
op_star
id|name
op_increment
suffix:semicolon
id|len
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|utf8
op_logical_and
(paren
id|c
op_amp
l_int|0x80
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|strchr
c_func
(paren
id|bad_chars
comma
id|c
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|strchr
c_func
(paren
id|replace_chars
comma
id|c
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|c
op_ge
l_char|&squot;A&squot;
op_logical_and
id|c
op_le
l_char|&squot;Z&squot;
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|c
OL
l_char|&squot; &squot;
op_logical_or
id|c
op_eq
l_char|&squot;:&squot;
op_logical_or
id|c
op_eq
l_char|&squot;&bslash;&bslash;&squot;
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|c
op_eq
l_char|&squot;.&squot;
)paren
r_break
suffix:semicolon
id|space
op_assign
id|c
op_eq
l_char|&squot; &squot;
suffix:semicolon
op_star
id|walk
op_assign
id|c
op_ge
l_char|&squot;a&squot;
op_logical_and
id|c
op_le
l_char|&squot;z&squot;
ques
c_cond
id|c
op_minus
l_int|32
suffix:colon
id|c
suffix:semicolon
)brace
r_if
c_cond
(paren
id|space
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|len
op_logical_and
id|c
op_ne
l_char|&squot;.&squot;
)paren
(brace
id|c
op_assign
op_star
id|name
op_increment
suffix:semicolon
id|len
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|c
op_ne
l_char|&squot;.&squot;
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_while
c_loop
(paren
id|c
op_ne
l_char|&squot;.&squot;
op_logical_and
id|len
op_decrement
)paren
id|c
op_assign
op_star
id|name
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|c
op_eq
l_char|&squot;.&squot;
)paren
(brace
r_while
c_loop
(paren
id|walk
op_minus
id|res
OL
l_int|8
)paren
op_star
id|walk
op_increment
op_assign
l_char|&squot; &squot;
suffix:semicolon
r_while
c_loop
(paren
id|len
OG
l_int|0
op_logical_and
id|walk
op_minus
id|res
OL
id|MSDOS_NAME
)paren
(brace
id|c
op_assign
op_star
id|name
op_increment
suffix:semicolon
id|len
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|utf8
op_logical_and
(paren
id|c
op_amp
l_int|0x80
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|strchr
c_func
(paren
id|bad_chars
comma
id|c
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|strchr
c_func
(paren
id|replace_chars
comma
id|c
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|c
OL
l_char|&squot; &squot;
op_logical_or
id|c
op_eq
l_char|&squot;:&squot;
op_logical_or
id|c
op_eq
l_char|&squot;&bslash;&bslash;&squot;
op_logical_or
id|c
op_eq
l_char|&squot;.&squot;
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|c
op_ge
l_char|&squot;A&squot;
op_logical_and
id|c
op_le
l_char|&squot;Z&squot;
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|space
op_assign
id|c
op_eq
l_char|&squot; &squot;
suffix:semicolon
op_star
id|walk
op_increment
op_assign
id|c
op_ge
l_char|&squot;a&squot;
op_logical_and
id|c
op_le
l_char|&squot;z&squot;
ques
c_cond
id|c
op_minus
l_int|32
suffix:colon
id|c
suffix:semicolon
)brace
r_if
c_cond
(paren
id|space
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|len
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_while
c_loop
(paren
id|walk
op_minus
id|res
OL
id|MSDOS_NAME
)paren
op_star
id|walk
op_increment
op_assign
l_char|&squot; &squot;
suffix:semicolon
r_for
c_loop
(paren
id|reserved
op_assign
id|reserved3_names
suffix:semicolon
op_star
id|reserved
suffix:semicolon
id|reserved
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|strnicmp
c_func
(paren
id|res
comma
op_star
id|reserved
comma
l_int|8
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_for
c_loop
(paren
id|reserved
op_assign
id|reserved4_names
suffix:semicolon
op_star
id|reserved
suffix:semicolon
id|reserved
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|strnicmp
c_func
(paren
id|res
comma
op_star
id|reserved
comma
l_int|8
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|skip_chars
r_static
r_char
id|skip_chars
(braket
)braket
op_assign
l_string|&quot;.:&bslash;&quot;?&lt;&gt;| &quot;
suffix:semicolon
multiline_comment|/* Given a valid longname, create a unique shortname.  Make sure the&n; * shortname does not exist&n; */
DECL|function|vfat_create_shortname
r_static
r_int
id|vfat_create_shortname
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
comma
r_char
op_star
id|name_res
comma
r_int
id|utf8
)paren
(brace
r_const
r_char
op_star
id|ip
comma
op_star
id|ext_start
comma
op_star
id|end
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_int
id|sz
comma
id|extlen
comma
id|baselen
comma
id|totlen
suffix:semicolon
r_char
id|msdos_name
(braket
l_int|13
)braket
suffix:semicolon
r_char
id|base
(braket
l_int|9
)braket
comma
id|ext
(braket
l_int|4
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|res
suffix:semicolon
r_int
id|spaces
suffix:semicolon
r_char
id|buf
(braket
l_int|8
)braket
suffix:semicolon
r_struct
id|vfat_slot_info
id|sinfo
suffix:semicolon
r_const
r_char
op_star
id|name_start
suffix:semicolon
r_struct
id|qstr
id|qname
suffix:semicolon
id|PRINTK2
c_func
(paren
(paren
l_string|&quot;Entering vfat_create_shortname: name=%s, len=%d&bslash;n&quot;
comma
id|name
comma
id|len
)paren
)paren
suffix:semicolon
id|sz
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Make compiler happy */
r_if
c_cond
(paren
id|len
op_logical_and
id|name
(braket
id|len
op_minus
l_int|1
)braket
op_eq
l_char|&squot; &squot;
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
l_int|12
)paren
(brace
multiline_comment|/* Do a case insensitive search if the name would be a valid&n;&t;&t; * shortname if is were all capitalized.  However, do not&n;&t;&t; * allow spaces in short names because Win95 scandisk does&n;&t;&t; * not like that */
id|res
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|p
op_assign
id|msdos_name
comma
id|ip
op_assign
id|name
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
comma
id|p
op_increment
comma
id|ip
op_increment
)paren
(brace
r_if
c_cond
(paren
op_star
id|ip
op_eq
l_char|&squot; &squot;
)paren
(brace
id|res
op_assign
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|ip
op_ge
l_char|&squot;A&squot;
op_logical_and
op_star
id|ip
op_le
l_char|&squot;Z&squot;
)paren
(brace
op_star
id|p
op_assign
op_star
id|ip
op_plus
l_int|32
suffix:semicolon
)brace
r_else
(brace
op_star
id|p
op_assign
op_star
id|ip
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|res
op_eq
l_int|0
)paren
(brace
id|res
op_assign
id|vfat_format_name
c_func
(paren
id|msdos_name
comma
id|len
comma
id|name_res
comma
l_int|1
comma
id|utf8
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|res
OG
op_minus
l_int|1
)paren
(brace
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_create_shortname 1&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|qname.name
op_assign
id|msdos_name
suffix:semicolon
id|qname.len
op_assign
id|len
suffix:semicolon
id|res
op_assign
id|vfat_find
c_func
(paren
id|dir
comma
op_amp
id|qname
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_amp
id|sinfo
)paren
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_create_shortname 2&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OG
op_minus
l_int|1
)paren
r_return
op_minus
id|EEXIST
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_create_shortname 3&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Now, we need to create a shortname from the long name */
id|ext_start
op_assign
id|end
op_assign
op_amp
id|name
(braket
id|len
)braket
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|ext_start
op_ge
id|name
)paren
(brace
r_if
c_cond
(paren
op_star
id|ext_start
op_eq
l_char|&squot;.&squot;
)paren
(brace
r_if
c_cond
(paren
id|ext_start
op_eq
id|end
op_minus
l_int|1
)paren
(brace
id|sz
op_assign
id|len
suffix:semicolon
id|ext_start
op_assign
l_int|NULL
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|ext_start
op_eq
id|name
op_minus
l_int|1
)paren
(brace
id|sz
op_assign
id|len
suffix:semicolon
id|ext_start
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ext_start
)paren
(brace
multiline_comment|/*&n;&t;&t; * Names which start with a dot could be just&n;&t;&t; * an extension eg. &quot;...test&quot;.  In this case Win95&n;&t;&t; * uses the extension as the name and sets no extension.&n;&t;&t; */
id|name_start
op_assign
op_amp
id|name
(braket
l_int|0
)braket
suffix:semicolon
r_while
c_loop
(paren
id|name_start
OL
id|ext_start
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strchr
c_func
(paren
id|skip_chars
comma
op_star
id|name_start
)paren
)paren
r_break
suffix:semicolon
id|name_start
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|name_start
op_ne
id|ext_start
)paren
(brace
id|sz
op_assign
id|ext_start
op_minus
id|name
suffix:semicolon
id|ext_start
op_increment
suffix:semicolon
)brace
r_else
(brace
id|sz
op_assign
id|len
suffix:semicolon
id|ext_start
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|baselen
op_assign
id|i
op_assign
l_int|0
comma
id|p
op_assign
id|base
comma
id|ip
op_assign
id|name
suffix:semicolon
id|i
OL
id|sz
op_logical_and
id|baselen
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|utf8
op_logical_and
(paren
op_star
id|ip
op_amp
l_int|0x80
)paren
)paren
(brace
op_star
id|p
op_increment
op_assign
l_char|&squot;_&squot;
suffix:semicolon
id|baselen
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strchr
c_func
(paren
id|skip_chars
comma
op_star
id|ip
)paren
)paren
(brace
r_if
c_cond
(paren
op_star
id|ip
op_ge
l_char|&squot;A&squot;
op_logical_and
op_star
id|ip
op_le
l_char|&squot;Z&squot;
)paren
(brace
op_star
id|p
op_assign
op_star
id|ip
op_plus
l_int|32
suffix:semicolon
)brace
r_else
(brace
op_star
id|p
op_assign
op_star
id|ip
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strchr
c_func
(paren
id|replace_chars
comma
op_star
id|p
)paren
)paren
op_star
id|p
op_assign
l_char|&squot;_&squot;
suffix:semicolon
id|p
op_increment
suffix:semicolon
id|baselen
op_increment
suffix:semicolon
)brace
id|ip
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|baselen
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|spaces
op_assign
l_int|8
op_minus
id|baselen
suffix:semicolon
r_if
c_cond
(paren
id|ext_start
)paren
(brace
id|extlen
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|ext
comma
id|ip
op_assign
id|ext_start
suffix:semicolon
id|extlen
OL
l_int|3
op_logical_and
id|ip
OL
id|end
suffix:semicolon
id|ip
op_increment
)paren
(brace
r_if
c_cond
(paren
id|utf8
op_logical_and
(paren
op_star
id|ip
op_amp
l_int|0x80
)paren
)paren
(brace
op_star
id|p
op_increment
op_assign
l_char|&squot;_&squot;
suffix:semicolon
id|extlen
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strchr
c_func
(paren
id|skip_chars
comma
op_star
id|ip
)paren
)paren
(brace
r_if
c_cond
(paren
op_star
id|ip
op_ge
l_char|&squot;A&squot;
op_logical_and
op_star
id|ip
op_le
l_char|&squot;Z&squot;
)paren
(brace
op_star
id|p
op_assign
op_star
id|ip
op_plus
l_int|32
suffix:semicolon
)brace
r_else
(brace
op_star
id|p
op_assign
op_star
id|ip
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strchr
c_func
(paren
id|replace_chars
comma
op_star
id|p
)paren
)paren
op_star
id|p
op_assign
l_char|&squot;_&squot;
suffix:semicolon
id|extlen
op_increment
suffix:semicolon
id|p
op_increment
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|extlen
op_assign
l_int|0
suffix:semicolon
)brace
id|ext
(braket
id|extlen
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|base
(braket
id|baselen
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|strcpy
c_func
(paren
id|msdos_name
comma
id|base
)paren
suffix:semicolon
id|msdos_name
(braket
id|baselen
)braket
op_assign
l_char|&squot;.&squot;
suffix:semicolon
id|strcpy
c_func
(paren
op_amp
id|msdos_name
(braket
id|baselen
op_plus
l_int|1
)braket
comma
id|ext
)paren
suffix:semicolon
id|totlen
op_assign
id|baselen
op_plus
id|extlen
op_plus
(paren
id|extlen
OG
l_int|0
)paren
suffix:semicolon
id|res
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|MSDOS_SB
c_func
(paren
id|dir-&gt;i_sb
)paren
op_member_access_from_pointer
id|options.numtail
op_eq
l_int|0
)paren
(brace
id|qname.name
op_assign
id|msdos_name
suffix:semicolon
id|qname.len
op_assign
id|totlen
suffix:semicolon
id|res
op_assign
id|vfat_find
c_func
(paren
id|dir
comma
op_amp
id|qname
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_amp
id|sinfo
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|res
OG
op_minus
l_int|1
)paren
(brace
multiline_comment|/*&n;&t;&t; * Try to find a unique extension.  This used to&n;&t;&t; * iterate through all possibilities sequentially,&n;&t;&t; * but that gave extremely bad performance.  Windows&n;&t;&t; * only tries a few cases before using random&n;&t;&t; * values for part of the base.&n;&t;&t; */
r_if
c_cond
(paren
l_int|2
OG
id|spaces
)paren
(brace
id|baselen
op_assign
id|baselen
op_minus
(paren
l_int|2
op_minus
id|spaces
)paren
suffix:semicolon
id|spaces
op_assign
l_int|2
suffix:semicolon
)brace
id|msdos_name
(braket
id|baselen
)braket
op_assign
l_char|&squot;~&squot;
suffix:semicolon
id|msdos_name
(braket
id|baselen
op_plus
l_int|2
)braket
op_assign
l_char|&squot;.&squot;
suffix:semicolon
id|strcpy
c_func
(paren
op_amp
id|msdos_name
(braket
id|baselen
op_plus
l_int|3
)braket
comma
id|ext
)paren
suffix:semicolon
id|totlen
op_assign
id|baselen
op_plus
l_int|2
op_plus
id|extlen
op_plus
(paren
id|extlen
OG
l_int|0
)paren
suffix:semicolon
id|qname.name
op_assign
id|msdos_name
suffix:semicolon
id|qname.len
op_assign
id|totlen
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|res
OG
op_minus
l_int|1
op_logical_and
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
(brace
id|strncpy
c_func
(paren
id|msdos_name
comma
id|base
comma
id|baselen
)paren
suffix:semicolon
id|msdos_name
(braket
id|baselen
op_plus
l_int|1
)braket
op_assign
id|i
op_plus
l_char|&squot;0&squot;
suffix:semicolon
id|res
op_assign
id|vfat_find
c_func
(paren
id|dir
comma
op_amp
id|qname
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_amp
id|sinfo
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|res
OG
op_minus
l_int|1
)paren
(brace
id|i
op_assign
id|jiffies
op_amp
l_int|0xffff
suffix:semicolon
id|sz
op_assign
(paren
id|jiffies
op_rshift
l_int|16
)paren
op_amp
l_int|0x7
suffix:semicolon
r_if
c_cond
(paren
l_int|6
OG
id|spaces
)paren
(brace
id|baselen
op_assign
id|baselen
op_minus
(paren
l_int|6
op_minus
id|spaces
)paren
suffix:semicolon
id|spaces
op_assign
l_int|6
suffix:semicolon
)brace
id|msdos_name
(braket
id|baselen
op_plus
l_int|4
)braket
op_assign
l_char|&squot;~&squot;
suffix:semicolon
id|msdos_name
(braket
id|baselen
op_plus
l_int|5
)braket
op_assign
l_char|&squot;1&squot;
op_plus
id|sz
suffix:semicolon
id|msdos_name
(braket
id|baselen
op_plus
l_int|6
)braket
op_assign
l_char|&squot;.&squot;
suffix:semicolon
id|strcpy
c_func
(paren
op_amp
id|msdos_name
(braket
id|baselen
op_plus
l_int|7
)braket
comma
id|ext
)paren
suffix:semicolon
id|totlen
op_assign
id|baselen
op_plus
l_int|6
op_plus
id|extlen
op_plus
(paren
id|extlen
OG
l_int|0
)paren
suffix:semicolon
id|qname.name
op_assign
id|msdos_name
suffix:semicolon
id|qname.len
op_assign
id|totlen
suffix:semicolon
r_while
c_loop
(paren
id|res
OG
op_minus
l_int|1
)paren
(brace
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%04x&quot;
comma
id|i
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|msdos_name
(braket
id|baselen
)braket
comma
id|buf
comma
l_int|4
)paren
suffix:semicolon
id|msdos_name
(braket
l_int|12
)braket
op_assign
l_int|0
suffix:semicolon
id|res
op_assign
id|vfat_find
c_func
(paren
id|dir
comma
op_amp
id|qname
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_amp
id|sinfo
)paren
suffix:semicolon
id|i
op_sub_assign
l_int|11
suffix:semicolon
)brace
)brace
id|res
op_assign
id|vfat_format_name
c_func
(paren
id|msdos_name
comma
id|totlen
comma
id|name_res
comma
l_int|1
comma
id|utf8
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
DECL|function|vfat_find_free_slots
r_static
id|loff_t
id|vfat_find_free_slots
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_int
id|slots
)paren
(brace
r_struct
id|super_block
op_star
id|sb
op_assign
id|dir-&gt;i_sb
suffix:semicolon
id|loff_t
id|offset
comma
id|curr
suffix:semicolon
r_struct
id|msdos_dir_entry
op_star
id|de
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_int
id|ino
suffix:semicolon
r_int
id|row
suffix:semicolon
r_int
id|done
suffix:semicolon
r_int
id|res
suffix:semicolon
r_int
id|added
suffix:semicolon
id|PRINTK2
c_func
(paren
(paren
l_string|&quot;vfat_find_free_slots: find %d free slots&bslash;n&quot;
comma
id|slots
)paren
)paren
suffix:semicolon
id|offset
op_assign
id|curr
op_assign
l_int|0
suffix:semicolon
id|bh
op_assign
l_int|NULL
suffix:semicolon
id|row
op_assign
l_int|0
suffix:semicolon
id|ino
op_assign
id|fat_get_entry
c_func
(paren
id|dir
comma
op_amp
id|curr
comma
op_amp
id|bh
comma
op_amp
id|de
)paren
suffix:semicolon
r_for
c_loop
(paren
id|added
op_assign
l_int|0
suffix:semicolon
id|added
OL
l_int|2
suffix:semicolon
id|added
op_increment
)paren
(brace
r_while
c_loop
(paren
id|ino
OG
op_minus
l_int|1
)paren
(brace
id|done
op_assign
id|IS_FREE
c_func
(paren
id|de-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|done
)paren
(brace
id|inode
op_assign
id|iget
c_func
(paren
id|sb
comma
id|ino
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inode
)paren
(brace
multiline_comment|/* Directory slots of busy deleted files aren&squot;t available yet. */
id|done
op_assign
op_logical_neg
id|MSDOS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|i_busy
suffix:semicolon
multiline_comment|/* PRINTK3((&quot;inode %d still busy&bslash;n&quot;, ino)); */
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|done
)paren
(brace
id|row
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|row
op_eq
id|slots
)paren
(brace
id|fat_brelse
c_func
(paren
id|sb
comma
id|bh
)paren
suffix:semicolon
multiline_comment|/* printk(&quot;----- Free offset at %d&bslash;n&quot;, offset); */
r_return
id|offset
suffix:semicolon
)brace
)brace
r_else
(brace
id|row
op_assign
l_int|0
suffix:semicolon
id|offset
op_assign
id|curr
suffix:semicolon
)brace
id|ino
op_assign
id|fat_get_entry
c_func
(paren
id|dir
comma
op_amp
id|curr
comma
op_amp
id|bh
comma
op_amp
id|de
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|dir-&gt;i_ino
op_eq
id|MSDOS_ROOT_INO
)paren
op_logical_and
(paren
id|MSDOS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|fat_bits
op_ne
l_int|32
)paren
)paren
r_return
op_minus
id|ENOSPC
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res
op_assign
id|fat_add_cluster
c_func
(paren
id|dir
)paren
)paren
OL
l_int|0
)paren
r_return
id|res
suffix:semicolon
id|ino
op_assign
id|fat_get_entry
c_func
(paren
id|dir
comma
op_amp
id|curr
comma
op_amp
id|bh
comma
op_amp
id|de
)paren
suffix:semicolon
)brace
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
multiline_comment|/* Translate a string, including coded sequences into Unicode */
r_static
r_int
DECL|function|xlate_to_uni
id|xlate_to_uni
c_func
(paren
r_const
r_char
op_star
id|name
comma
r_int
id|len
comma
r_char
op_star
id|outname
comma
r_int
op_star
id|outlen
comma
r_int
id|escape
comma
r_int
id|utf8
comma
r_struct
id|nls_table
op_star
id|nls
)paren
(brace
r_int
id|i
suffix:semicolon
r_const
r_int
r_char
op_star
id|ip
suffix:semicolon
r_char
op_star
id|op
suffix:semicolon
r_int
id|fill
suffix:semicolon
r_int
r_char
id|c1
comma
id|c2
comma
id|c3
suffix:semicolon
r_if
c_cond
(paren
id|utf8
)paren
(brace
op_star
id|outlen
op_assign
id|utf8_mbstowcs
c_func
(paren
(paren
id|__u16
op_star
)paren
id|outname
comma
id|name
comma
id|PAGE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|name
(braket
id|len
op_minus
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
)paren
op_star
id|outlen
op_sub_assign
l_int|2
suffix:semicolon
id|op
op_assign
op_amp
id|outname
(braket
op_star
id|outlen
op_star
r_sizeof
(paren
id|__u16
)paren
)braket
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|name
(braket
id|len
op_minus
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
)paren
id|len
op_decrement
suffix:semicolon
id|op
op_assign
id|outname
suffix:semicolon
r_if
c_cond
(paren
id|nls
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|ip
op_assign
id|name
comma
id|op
op_assign
id|outname
comma
op_star
id|outlen
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
op_logical_and
op_star
id|outlen
op_le
l_int|260
suffix:semicolon
id|i
op_increment
comma
op_star
id|outlen
op_add_assign
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|escape
op_logical_and
(paren
op_star
id|ip
op_eq
l_char|&squot;:&squot;
)paren
)paren
(brace
r_if
c_cond
(paren
id|i
OG
id|len
op_minus
l_int|4
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|c1
op_assign
id|fat_esc2uni
(braket
id|ip
(braket
l_int|1
)braket
)braket
suffix:semicolon
id|c2
op_assign
id|fat_esc2uni
(braket
id|ip
(braket
l_int|2
)braket
)braket
suffix:semicolon
id|c3
op_assign
id|fat_esc2uni
(braket
id|ip
(braket
l_int|3
)braket
)braket
suffix:semicolon
r_if
c_cond
(paren
id|c1
op_eq
l_int|255
op_logical_or
id|c2
op_eq
l_int|255
op_logical_or
id|c3
op_eq
l_int|255
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
op_star
id|op
op_increment
op_assign
(paren
id|c1
op_lshift
l_int|4
)paren
op_plus
(paren
id|c2
op_rshift
l_int|2
)paren
suffix:semicolon
op_star
id|op
op_increment
op_assign
(paren
(paren
id|c2
op_amp
l_int|0x3
)paren
op_lshift
l_int|6
)paren
op_plus
id|c3
suffix:semicolon
id|ip
op_add_assign
l_int|4
suffix:semicolon
)brace
r_else
(brace
op_star
id|op
op_increment
op_assign
id|nls-&gt;charset2uni
(braket
op_star
id|ip
)braket
dot
id|uni1
suffix:semicolon
op_star
id|op
op_increment
op_assign
id|nls-&gt;charset2uni
(braket
op_star
id|ip
)braket
dot
id|uni2
suffix:semicolon
id|ip
op_increment
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|ip
op_assign
id|name
comma
id|op
op_assign
id|outname
comma
op_star
id|outlen
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
op_logical_and
op_star
id|outlen
op_le
l_int|260
suffix:semicolon
id|i
op_increment
comma
op_star
id|outlen
op_add_assign
l_int|1
)paren
(brace
op_star
id|op
op_increment
op_assign
op_star
id|ip
op_increment
suffix:semicolon
op_star
id|op
op_increment
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
op_star
id|outlen
OG
l_int|260
)paren
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
r_if
c_cond
(paren
op_star
id|outlen
op_mod
l_int|13
)paren
(brace
op_star
id|op
op_increment
op_assign
l_int|0
suffix:semicolon
op_star
id|op
op_increment
op_assign
l_int|0
suffix:semicolon
op_star
id|outlen
op_add_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_star
id|outlen
op_mod
l_int|13
)paren
(brace
id|fill
op_assign
l_int|13
op_minus
(paren
op_star
id|outlen
op_mod
l_int|13
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|fill
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|op
op_increment
op_assign
l_int|0xff
suffix:semicolon
op_star
id|op
op_increment
op_assign
l_int|0xff
suffix:semicolon
)brace
op_star
id|outlen
op_add_assign
id|fill
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|vfat_fill_long_slots
id|vfat_fill_long_slots
c_func
(paren
r_struct
id|msdos_dir_slot
op_star
id|ds
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
comma
r_char
op_star
id|msdos_name
comma
r_int
op_star
id|slots
comma
r_int
id|uni_xlate
comma
r_int
id|utf8
comma
r_struct
id|nls_table
op_star
id|nls
)paren
(brace
r_struct
id|msdos_dir_slot
op_star
id|ps
suffix:semicolon
r_struct
id|msdos_dir_entry
op_star
id|de
suffix:semicolon
r_int
id|res
suffix:semicolon
r_int
id|slot
suffix:semicolon
r_int
r_char
id|cksum
suffix:semicolon
r_char
op_star
id|uniname
suffix:semicolon
r_const
r_char
op_star
id|ip
suffix:semicolon
r_int
r_int
id|page
suffix:semicolon
r_int
id|unilen
suffix:semicolon
r_int
id|i
suffix:semicolon
id|loff_t
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|name
(braket
id|len
op_minus
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
)paren
id|len
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|page
op_assign
id|__get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
)paren
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|uniname
op_assign
(paren
r_char
op_star
)paren
id|page
suffix:semicolon
id|res
op_assign
id|xlate_to_uni
c_func
(paren
id|name
comma
id|len
comma
id|uniname
comma
op_amp
id|unilen
comma
id|uni_xlate
comma
id|utf8
comma
id|nls
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
(brace
id|free_page
c_func
(paren
id|page
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
op_star
id|slots
op_assign
id|unilen
op_div
l_int|13
suffix:semicolon
r_for
c_loop
(paren
id|cksum
op_assign
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|11
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cksum
op_assign
(paren
(paren
(paren
id|cksum
op_amp
l_int|1
)paren
op_lshift
l_int|7
)paren
op_or
(paren
(paren
id|cksum
op_amp
l_int|0xfe
)paren
op_rshift
l_int|1
)paren
)paren
op_plus
id|msdos_name
(braket
id|i
)braket
suffix:semicolon
)brace
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_fill_long_slots 3: slots=%d&bslash;n&quot;
comma
op_star
id|slots
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ps
op_assign
id|ds
comma
id|slot
op_assign
op_star
id|slots
suffix:semicolon
id|slot
OG
l_int|0
suffix:semicolon
id|slot
op_decrement
comma
id|ps
op_increment
)paren
(brace
r_int
id|end
comma
id|j
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_fill_long_slots 4&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ps-&gt;id
op_assign
id|slot
suffix:semicolon
id|ps-&gt;attr
op_assign
id|ATTR_EXT
suffix:semicolon
id|ps-&gt;reserved
op_assign
l_int|0
suffix:semicolon
id|ps-&gt;alias_checksum
op_assign
id|cksum
suffix:semicolon
id|ps-&gt;start
op_assign
l_int|0
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_fill_long_slots 5: uniname=%s&bslash;n&quot;
comma
id|uniname
)paren
)paren
suffix:semicolon
id|offset
op_assign
(paren
id|slot
op_minus
l_int|1
)paren
op_star
l_int|26
suffix:semicolon
id|ip
op_assign
op_amp
id|uniname
(braket
id|offset
)braket
suffix:semicolon
id|j
op_assign
id|offset
suffix:semicolon
id|end
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
(brace
id|ps-&gt;name0_4
(braket
id|i
)braket
op_assign
op_star
id|ip
op_increment
suffix:semicolon
id|ps-&gt;name0_4
(braket
id|i
op_plus
l_int|1
)braket
op_assign
op_star
id|ip
op_increment
suffix:semicolon
)brace
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_fill_long_slots 6&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|12
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
(brace
id|ps-&gt;name5_10
(braket
id|i
)braket
op_assign
op_star
id|ip
op_increment
suffix:semicolon
id|ps-&gt;name5_10
(braket
id|i
op_plus
l_int|1
)braket
op_assign
op_star
id|ip
op_increment
suffix:semicolon
)brace
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_fill_long_slots 7&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
(brace
id|ps-&gt;name11_12
(braket
id|i
)braket
op_assign
op_star
id|ip
op_increment
suffix:semicolon
id|ps-&gt;name11_12
(braket
id|i
op_plus
l_int|1
)braket
op_assign
op_star
id|ip
op_increment
suffix:semicolon
)brace
)brace
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_fill_long_slots 8&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ds
(braket
l_int|0
)braket
dot
id|id
op_or_assign
l_int|0x40
suffix:semicolon
id|de
op_assign
(paren
r_struct
id|msdos_dir_entry
op_star
)paren
id|ps
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_fill_long_slots 9&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|de-&gt;name
comma
id|msdos_name
comma
id|MSDOS_NAME
)paren
suffix:semicolon
id|free_page
c_func
(paren
id|page
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vfat_build_slots
r_static
r_int
id|vfat_build_slots
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
comma
r_struct
id|msdos_dir_slot
op_star
id|ds
comma
r_int
op_star
id|slots
comma
r_int
op_star
id|is_long
)paren
(brace
r_struct
id|msdos_dir_entry
op_star
id|de
suffix:semicolon
r_char
id|msdos_name
(braket
id|MSDOS_NAME
)braket
suffix:semicolon
r_int
id|res
comma
id|xlate
comma
id|utf8
suffix:semicolon
r_struct
id|nls_table
op_star
id|nls
suffix:semicolon
id|PRINTK2
c_func
(paren
(paren
l_string|&quot;Entering vfat_build_slots: name=%s, len=%d&bslash;n&quot;
comma
id|name
comma
id|len
)paren
)paren
suffix:semicolon
id|de
op_assign
(paren
r_struct
id|msdos_dir_entry
op_star
)paren
id|ds
suffix:semicolon
id|xlate
op_assign
id|MSDOS_SB
c_func
(paren
id|dir-&gt;i_sb
)paren
op_member_access_from_pointer
id|options.unicode_xlate
suffix:semicolon
id|utf8
op_assign
id|MSDOS_SB
c_func
(paren
id|dir-&gt;i_sb
)paren
op_member_access_from_pointer
id|options.utf8
suffix:semicolon
id|nls
op_assign
id|MSDOS_SB
c_func
(paren
id|dir-&gt;i_sb
)paren
op_member_access_from_pointer
id|nls_io
suffix:semicolon
op_star
id|slots
op_assign
l_int|1
suffix:semicolon
op_star
id|is_long
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|len
op_eq
l_int|1
op_logical_and
id|name
(braket
l_int|0
)braket
op_eq
l_char|&squot;.&squot;
)paren
(brace
id|strncpy
c_func
(paren
id|de-&gt;name
comma
id|MSDOS_DOT
comma
id|MSDOS_NAME
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|len
op_eq
l_int|2
op_logical_and
id|name
(braket
l_int|0
)braket
op_eq
l_char|&squot;.&squot;
op_logical_and
id|name
(braket
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
)paren
(brace
id|strncpy
c_func
(paren
id|de-&gt;name
comma
id|MSDOS_DOT
comma
id|MSDOS_NAME
)paren
suffix:semicolon
)brace
r_else
(brace
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_build_slots 4&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|res
op_assign
id|vfat_valid_shortname
c_func
(paren
id|name
comma
id|len
comma
l_int|1
comma
id|utf8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OG
op_minus
l_int|1
)paren
(brace
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_build_slots 5a&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|res
op_assign
id|vfat_format_name
c_func
(paren
id|name
comma
id|len
comma
id|de-&gt;name
comma
l_int|1
comma
id|utf8
)paren
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_build_slots 5b&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|res
op_assign
id|vfat_create_shortname
c_func
(paren
id|dir
comma
id|name
comma
id|len
comma
id|msdos_name
comma
id|utf8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
(brace
r_return
id|res
suffix:semicolon
)brace
id|res
op_assign
id|vfat_valid_longname
c_func
(paren
id|name
comma
id|len
comma
l_int|1
comma
id|xlate
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
(brace
r_return
id|res
suffix:semicolon
)brace
op_star
id|is_long
op_assign
l_int|1
suffix:semicolon
r_return
id|vfat_fill_long_slots
c_func
(paren
id|ds
comma
id|name
comma
id|len
comma
id|msdos_name
comma
id|slots
comma
id|xlate
comma
id|utf8
comma
id|nls
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vfat_readdir_cb
r_static
r_int
id|vfat_readdir_cb
c_func
(paren
id|filldir_t
id|filldir
comma
r_void
op_star
id|buf
comma
r_const
r_char
op_star
id|name
comma
r_int
id|name_len
comma
r_int
id|is_long
comma
id|off_t
id|offset
comma
id|off_t
id|short_offset
comma
r_int
id|long_slots
comma
id|ino_t
id|ino
)paren
(brace
r_struct
id|vfat_find_info
op_star
id|vf
op_assign
(paren
r_struct
id|vfat_find_info
op_star
)paren
id|buf
suffix:semicolon
r_const
r_char
op_star
id|s1
comma
op_star
id|s2
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
id|debug
)paren
id|printk
c_func
(paren
l_string|&quot;cb: vf.name=%s, len=%d, name=%s, name_len=%d&bslash;n&quot;
comma
id|vf-&gt;name
comma
id|vf-&gt;len
comma
id|name
comma
id|name_len
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|vf-&gt;len
op_ne
id|name_len
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|s1
op_assign
id|name
suffix:semicolon
id|s2
op_assign
id|vf-&gt;name
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|name_len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|vf-&gt;anycase
op_logical_or
(paren
id|vf-&gt;new_filename
op_logical_and
op_logical_neg
id|vf-&gt;posix
)paren
)paren
(brace
r_if
c_cond
(paren
id|tolower
c_func
(paren
op_star
id|s1
)paren
op_ne
id|tolower
c_func
(paren
op_star
id|s2
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_star
id|s1
op_ne
op_star
id|s2
)paren
r_return
l_int|0
suffix:semicolon
)brace
id|s1
op_increment
suffix:semicolon
id|s2
op_increment
suffix:semicolon
)brace
id|vf-&gt;found
op_assign
l_int|1
suffix:semicolon
id|vf-&gt;is_long
op_assign
id|is_long
suffix:semicolon
id|vf-&gt;offset
op_assign
(paren
id|offset
op_eq
l_int|2
)paren
ques
c_cond
l_int|0
suffix:colon
id|offset
suffix:semicolon
id|vf-&gt;short_offset
op_assign
(paren
id|short_offset
op_eq
l_int|2
)paren
ques
c_cond
l_int|0
suffix:colon
id|short_offset
suffix:semicolon
id|vf-&gt;long_slots
op_assign
id|long_slots
suffix:semicolon
id|vf-&gt;ino
op_assign
id|ino
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|vfat_find
r_static
r_int
id|vfat_find
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|qstr
op_star
id|qname
comma
r_int
id|find_long
comma
r_int
id|new_filename
comma
r_int
id|is_dir
comma
r_struct
id|vfat_slot_info
op_star
id|sinfo_out
)paren
(brace
r_struct
id|super_block
op_star
id|sb
op_assign
id|dir-&gt;i_sb
suffix:semicolon
r_struct
id|vfat_find_info
id|vf
suffix:semicolon
r_struct
id|file
id|fil
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_struct
id|msdos_dir_entry
op_star
id|de
suffix:semicolon
r_struct
id|msdos_dir_slot
op_star
id|ps
suffix:semicolon
id|loff_t
id|offset
suffix:semicolon
r_struct
id|msdos_dir_slot
op_star
id|ds
suffix:semicolon
r_int
id|is_long
suffix:semicolon
r_int
id|slots
comma
id|slot
suffix:semicolon
r_int
id|res
suffix:semicolon
id|PRINTK2
c_func
(paren
(paren
l_string|&quot;Entering vfat_find&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ds
op_assign
(paren
r_struct
id|msdos_dir_slot
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|msdos_dir_slot
)paren
op_star
id|MSDOS_SLOTS
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ds
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|fil.f_pos
op_assign
l_int|0
suffix:semicolon
id|vf.name
op_assign
id|qname-&gt;name
suffix:semicolon
id|vf.len
op_assign
id|qname-&gt;len
suffix:semicolon
id|vf.new_filename
op_assign
id|new_filename
suffix:semicolon
id|vf.found
op_assign
l_int|0
suffix:semicolon
id|vf.posix
op_assign
id|MSDOS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|options.posixfs
suffix:semicolon
id|vf.anycase
op_assign
(paren
id|MSDOS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|options.name_check
op_ne
l_char|&squot;s&squot;
)paren
suffix:semicolon
id|res
op_assign
id|fat_readdirx
c_func
(paren
id|dir
comma
op_amp
id|fil
comma
(paren
r_void
op_star
)paren
op_amp
id|vf
comma
id|vfat_readdir_cb
comma
l_int|NULL
comma
l_int|1
comma
id|find_long
comma
l_int|0
)paren
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_find: Debug 1&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
r_goto
id|cleanup
suffix:semicolon
r_if
c_cond
(paren
id|vf.found
)paren
(brace
r_if
c_cond
(paren
id|new_filename
)paren
(brace
id|res
op_assign
op_minus
id|EEXIST
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
id|sinfo_out-&gt;longname_offset
op_assign
id|vf.offset
suffix:semicolon
id|sinfo_out-&gt;shortname_offset
op_assign
id|vf.short_offset
suffix:semicolon
id|sinfo_out-&gt;is_long
op_assign
id|vf.is_long
suffix:semicolon
id|sinfo_out-&gt;long_slots
op_assign
id|vf.long_slots
suffix:semicolon
id|sinfo_out-&gt;total_slots
op_assign
id|vf.long_slots
op_plus
l_int|1
suffix:semicolon
id|sinfo_out-&gt;ino
op_assign
id|vf.ino
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_find: Debug 2&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|res
op_assign
l_int|0
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_find: Debug 3&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vf.found
op_logical_and
op_logical_neg
id|new_filename
)paren
(brace
id|res
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
id|res
op_assign
id|vfat_build_slots
c_func
(paren
id|dir
comma
id|qname-&gt;name
comma
id|qname-&gt;len
comma
id|ds
comma
op_amp
id|slots
comma
op_amp
id|is_long
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
r_goto
id|cleanup
suffix:semicolon
id|de
op_assign
(paren
r_struct
id|msdos_dir_entry
op_star
)paren
id|ds
suffix:semicolon
id|bh
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|new_filename
)paren
(brace
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_find: create file 1&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_long
)paren
id|slots
op_increment
suffix:semicolon
id|offset
op_assign
id|vfat_find_free_slots
c_func
(paren
id|dir
comma
id|slots
)paren
suffix:semicolon
r_if
c_cond
(paren
id|offset
OL
l_int|0
)paren
(brace
id|res
op_assign
id|offset
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_find: create file 2&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Now create the new entry */
id|bh
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|slot
op_assign
l_int|0
comma
id|ps
op_assign
id|ds
suffix:semicolon
id|slot
OL
id|slots
suffix:semicolon
id|slot
op_increment
comma
id|ps
op_increment
)paren
(brace
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_find: create file 3, slot=%d&bslash;n&quot;
comma
id|slot
)paren
)paren
suffix:semicolon
id|sinfo_out-&gt;ino
op_assign
id|fat_get_entry
c_func
(paren
id|dir
comma
op_amp
id|offset
comma
op_amp
id|bh
comma
op_amp
id|de
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sinfo_out-&gt;ino
OL
l_int|0
)paren
(brace
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_find: problem&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|res
op_assign
id|sinfo_out-&gt;ino
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|de
comma
id|ps
comma
r_sizeof
(paren
r_struct
id|msdos_dir_slot
)paren
)paren
suffix:semicolon
id|fat_mark_buffer_dirty
c_func
(paren
id|sb
comma
id|bh
comma
l_int|1
)paren
suffix:semicolon
)brace
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_find: create file 4&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|dir-&gt;i_ctime
op_assign
id|dir-&gt;i_mtime
op_assign
id|dir-&gt;i_atime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|dir
)paren
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_find: create file 5&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|fat_date_unix2dos
c_func
(paren
id|dir-&gt;i_mtime
comma
op_amp
id|de-&gt;time
comma
op_amp
id|de-&gt;date
)paren
suffix:semicolon
id|de-&gt;ctime_ms
op_assign
l_int|0
suffix:semicolon
id|de-&gt;ctime
op_assign
id|de-&gt;time
suffix:semicolon
id|de-&gt;adate
op_assign
id|de-&gt;cdate
op_assign
id|de-&gt;date
suffix:semicolon
id|de-&gt;start
op_assign
l_int|0
suffix:semicolon
id|de-&gt;starthi
op_assign
l_int|0
suffix:semicolon
id|de-&gt;size
op_assign
l_int|0
suffix:semicolon
id|de-&gt;attr
op_assign
id|is_dir
ques
c_cond
id|ATTR_DIR
suffix:colon
id|ATTR_ARCH
suffix:semicolon
id|de-&gt;lcase
op_assign
id|CASE_LOWER_BASE
op_or
id|CASE_LOWER_EXT
suffix:semicolon
id|fat_mark_buffer_dirty
c_func
(paren
id|sb
comma
id|bh
comma
l_int|1
)paren
suffix:semicolon
id|fat_brelse
c_func
(paren
id|sb
comma
id|bh
)paren
suffix:semicolon
id|sinfo_out-&gt;is_long
op_assign
(paren
id|slots
OG
l_int|1
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sinfo_out-&gt;is_long
)paren
(brace
id|sinfo_out-&gt;long_slots
op_assign
id|slots
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|sinfo_out-&gt;long_slots
op_assign
l_int|0
suffix:semicolon
)brace
id|sinfo_out-&gt;total_slots
op_assign
id|slots
suffix:semicolon
id|sinfo_out-&gt;shortname_offset
op_assign
id|offset
op_minus
r_sizeof
(paren
r_struct
id|msdos_dir_slot
)paren
suffix:semicolon
id|sinfo_out-&gt;longname_offset
op_assign
id|offset
op_minus
r_sizeof
(paren
r_struct
id|msdos_dir_slot
)paren
op_star
id|slots
suffix:semicolon
id|res
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|res
op_assign
op_minus
id|ENOENT
suffix:semicolon
)brace
id|cleanup
suffix:colon
id|kfree
c_func
(paren
id|ds
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
DECL|function|vfat_lookup
r_int
id|vfat_lookup
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_int
id|res
suffix:semicolon
r_struct
id|vfat_slot_info
id|sinfo
suffix:semicolon
r_struct
id|inode
op_star
id|result
suffix:semicolon
r_int
id|table
suffix:semicolon
id|PRINTK2
c_func
(paren
(paren
l_string|&quot;vfat_lookup: name=%s, len=%d&bslash;n&quot;
comma
id|dentry-&gt;d_name.name
comma
id|dentry-&gt;d_name.len
)paren
)paren
suffix:semicolon
id|table
op_assign
(paren
id|MSDOS_SB
c_func
(paren
id|dir-&gt;i_sb
)paren
op_member_access_from_pointer
id|options.name_check
op_eq
l_char|&squot;s&squot;
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|0
suffix:semicolon
id|dentry-&gt;d_op
op_assign
op_amp
id|vfat_dentry_ops
(braket
id|table
)braket
suffix:semicolon
id|result
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res
op_assign
id|vfat_find
c_func
(paren
id|dir
comma
op_amp
id|dentry-&gt;d_name
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
op_amp
id|sinfo
)paren
)paren
OL
l_int|0
)paren
(brace
id|result
op_assign
l_int|NULL
suffix:semicolon
id|table
op_increment
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_lookup 4.5&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|result
op_assign
id|iget
c_func
(paren
id|dir-&gt;i_sb
comma
id|sinfo.ino
)paren
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_lookup 5&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|MSDOS_I
c_func
(paren
id|result
)paren
op_member_access_from_pointer
id|i_busy
)paren
(brace
multiline_comment|/* mkdir in progress */
id|iput
c_func
(paren
id|result
)paren
suffix:semicolon
id|result
op_assign
l_int|NULL
suffix:semicolon
id|table
op_increment
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_lookup 6&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|error
suffix:colon
id|dentry-&gt;d_op
op_assign
op_amp
id|vfat_dentry_ops
(braket
id|table
)braket
suffix:semicolon
id|dentry-&gt;d_time
op_assign
id|dentry-&gt;d_parent-&gt;d_inode-&gt;i_version
suffix:semicolon
id|d_add
c_func
(paren
id|dentry
comma
id|result
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vfat_create_entry
r_static
r_int
id|vfat_create_entry
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|qstr
op_star
id|qname
comma
r_int
id|is_dir
comma
r_struct
id|inode
op_star
op_star
id|result
)paren
(brace
r_struct
id|super_block
op_star
id|sb
op_assign
id|dir-&gt;i_sb
suffix:semicolon
r_int
id|res
comma
id|ino
suffix:semicolon
id|loff_t
id|offset
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_struct
id|msdos_dir_entry
op_star
id|de
suffix:semicolon
r_struct
id|vfat_slot_info
id|sinfo
suffix:semicolon
op_star
id|result
op_assign
l_int|0
suffix:semicolon
id|PRINTK1
c_func
(paren
(paren
l_string|&quot;vfat_create_entry: Entering&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|res
op_assign
id|vfat_find
c_func
(paren
id|dir
comma
id|qname
comma
l_int|1
comma
l_int|1
comma
id|is_dir
comma
op_amp
id|sinfo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
(brace
r_return
id|res
suffix:semicolon
)brace
id|offset
op_assign
id|sinfo.shortname_offset
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_create_entry 2&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|bh
op_assign
l_int|NULL
suffix:semicolon
id|ino
op_assign
id|fat_get_entry
c_func
(paren
id|dir
comma
op_amp
id|offset
comma
op_amp
id|bh
comma
op_amp
id|de
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ino
OL
l_int|0
)paren
(brace
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_mkdir problem&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bh
)paren
id|fat_brelse
c_func
(paren
id|sb
comma
id|bh
)paren
suffix:semicolon
r_return
id|ino
suffix:semicolon
)brace
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_create_entry 3&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|result
op_assign
id|iget
c_func
(paren
id|dir-&gt;i_sb
comma
id|ino
)paren
)paren
op_ne
l_int|NULL
)paren
id|vfat_read_inode
c_func
(paren
op_star
id|result
)paren
suffix:semicolon
id|fat_brelse
c_func
(paren
id|sb
comma
id|bh
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|result
)paren
r_return
op_minus
id|EIO
suffix:semicolon
(paren
op_star
id|result
)paren
op_member_access_from_pointer
id|i_mtime
op_assign
(paren
op_star
id|result
)paren
op_member_access_from_pointer
id|i_atime
op_assign
(paren
op_star
id|result
)paren
op_member_access_from_pointer
id|i_ctime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
op_star
id|result
)paren
suffix:semicolon
(paren
op_star
id|result
)paren
op_member_access_from_pointer
id|i_version
op_assign
op_increment
id|event
suffix:semicolon
id|dir-&gt;i_version
op_assign
id|event
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vfat_create
r_int
id|vfat_create
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|mode
)paren
(brace
r_int
id|res
suffix:semicolon
r_struct
id|inode
op_star
id|result
suffix:semicolon
id|result
op_assign
l_int|NULL
suffix:semicolon
id|fat_lock_creation
c_func
(paren
)paren
suffix:semicolon
id|res
op_assign
id|vfat_create_entry
c_func
(paren
id|dir
comma
op_amp
id|dentry-&gt;d_name
comma
l_int|0
comma
op_amp
id|result
)paren
suffix:semicolon
id|fat_unlock_creation
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
(brace
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_create: unable to get new entry&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|dentry-&gt;d_time
op_assign
id|dentry-&gt;d_parent-&gt;d_inode-&gt;i_version
suffix:semicolon
id|d_instantiate
c_func
(paren
id|dentry
comma
id|result
)paren
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
DECL|function|vfat_create_a_dotdir
r_static
r_int
id|vfat_create_a_dotdir
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|inode
op_star
id|parent
comma
r_struct
id|buffer_head
op_star
id|bh
comma
r_struct
id|msdos_dir_entry
op_star
id|de
comma
r_int
id|ino
comma
r_const
r_char
op_star
id|name
comma
r_int
id|isdot
)paren
(brace
r_struct
id|super_block
op_star
id|sb
op_assign
id|dir-&gt;i_sb
suffix:semicolon
r_struct
id|inode
op_star
id|dot
suffix:semicolon
id|PRINTK2
c_func
(paren
(paren
l_string|&quot;vfat_create_a_dotdir: Entering&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * XXX all times should be set by caller upon successful completion.&n;&t; */
id|dir-&gt;i_atime
op_assign
id|dir-&gt;i_ctime
op_assign
id|dir-&gt;i_mtime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|dir
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|de-&gt;name
comma
id|name
comma
id|MSDOS_NAME
)paren
suffix:semicolon
id|de-&gt;lcase
op_assign
l_int|0
suffix:semicolon
id|de-&gt;attr
op_assign
id|ATTR_DIR
suffix:semicolon
id|de-&gt;start
op_assign
l_int|0
suffix:semicolon
id|de-&gt;starthi
op_assign
l_int|0
suffix:semicolon
id|fat_date_unix2dos
c_func
(paren
id|dir-&gt;i_mtime
comma
op_amp
id|de-&gt;time
comma
op_amp
id|de-&gt;date
)paren
suffix:semicolon
id|de-&gt;ctime_ms
op_assign
l_int|0
suffix:semicolon
id|de-&gt;ctime
op_assign
id|de-&gt;time
suffix:semicolon
id|de-&gt;adate
op_assign
id|de-&gt;cdate
op_assign
id|de-&gt;date
suffix:semicolon
id|de-&gt;size
op_assign
l_int|0
suffix:semicolon
id|fat_mark_buffer_dirty
c_func
(paren
id|sb
comma
id|bh
comma
l_int|1
)paren
suffix:semicolon
id|dot
op_assign
id|iget
c_func
(paren
id|dir-&gt;i_sb
comma
id|ino
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dot
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|vfat_read_inode
c_func
(paren
id|dot
)paren
suffix:semicolon
id|dot-&gt;i_mtime
op_assign
id|dot-&gt;i_atime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|dot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isdot
)paren
(brace
id|dot-&gt;i_size
op_assign
id|dir-&gt;i_size
suffix:semicolon
id|MSDOS_I
c_func
(paren
id|dot
)paren
op_member_access_from_pointer
id|i_start
op_assign
id|MSDOS_I
c_func
(paren
id|dir
)paren
op_member_access_from_pointer
id|i_start
suffix:semicolon
id|MSDOS_I
c_func
(paren
id|dot
)paren
op_member_access_from_pointer
id|i_logstart
op_assign
id|MSDOS_I
c_func
(paren
id|dir
)paren
op_member_access_from_pointer
id|i_logstart
suffix:semicolon
id|dot-&gt;i_nlink
op_assign
id|dir-&gt;i_nlink
suffix:semicolon
)brace
r_else
(brace
id|dot-&gt;i_size
op_assign
id|parent-&gt;i_size
suffix:semicolon
id|MSDOS_I
c_func
(paren
id|dot
)paren
op_member_access_from_pointer
id|i_start
op_assign
id|MSDOS_I
c_func
(paren
id|parent
)paren
op_member_access_from_pointer
id|i_start
suffix:semicolon
id|MSDOS_I
c_func
(paren
id|dot
)paren
op_member_access_from_pointer
id|i_logstart
op_assign
id|MSDOS_I
c_func
(paren
id|parent
)paren
op_member_access_from_pointer
id|i_logstart
suffix:semicolon
id|dot-&gt;i_nlink
op_assign
id|parent-&gt;i_nlink
suffix:semicolon
)brace
id|iput
c_func
(paren
id|dot
)paren
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_create_a_dotdir 2&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vfat_create_dotdirs
r_static
r_int
id|vfat_create_dotdirs
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|inode
op_star
id|parent
)paren
(brace
r_struct
id|super_block
op_star
id|sb
op_assign
id|dir-&gt;i_sb
suffix:semicolon
r_int
id|res
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_struct
id|msdos_dir_entry
op_star
id|de
suffix:semicolon
id|loff_t
id|offset
suffix:semicolon
id|PRINTK2
c_func
(paren
(paren
l_string|&quot;vfat_create_dotdirs: Entering&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res
op_assign
id|fat_add_cluster
c_func
(paren
id|dir
)paren
)paren
OL
l_int|0
)paren
r_return
id|res
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_create_dotdirs 2&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
id|bh
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res
op_assign
id|fat_get_entry
c_func
(paren
id|dir
comma
op_amp
id|offset
comma
op_amp
id|bh
comma
op_amp
id|de
)paren
)paren
OL
l_int|0
)paren
r_return
id|res
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_create_dotdirs 3&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|res
op_assign
id|vfat_create_a_dotdir
c_func
(paren
id|dir
comma
id|parent
comma
id|bh
comma
id|de
comma
id|res
comma
id|MSDOS_DOT
comma
l_int|1
)paren
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_create_dotdirs 4&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
(brace
id|fat_brelse
c_func
(paren
id|sb
comma
id|bh
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_create_dotdirs 5&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res
op_assign
id|fat_get_entry
c_func
(paren
id|dir
comma
op_amp
id|offset
comma
op_amp
id|bh
comma
op_amp
id|de
)paren
)paren
OL
l_int|0
)paren
(brace
id|fat_brelse
c_func
(paren
id|sb
comma
id|bh
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_create_dotdirs 6&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|res
op_assign
id|vfat_create_a_dotdir
c_func
(paren
id|dir
comma
id|parent
comma
id|bh
comma
id|de
comma
id|res
comma
id|MSDOS_DOTDOT
comma
l_int|0
)paren
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_create_dotdirs 7&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|fat_brelse
c_func
(paren
id|sb
comma
id|bh
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/***** See if directory is empty */
DECL|function|vfat_empty
r_static
r_int
id|vfat_empty
c_func
(paren
r_struct
id|inode
op_star
id|dir
)paren
(brace
r_struct
id|super_block
op_star
id|sb
op_assign
id|dir-&gt;i_sb
suffix:semicolon
id|loff_t
id|pos
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_struct
id|msdos_dir_entry
op_star
id|de
suffix:semicolon
r_if
c_cond
(paren
id|dir-&gt;i_count
OG
l_int|1
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|MSDOS_I
c_func
(paren
id|dir
)paren
op_member_access_from_pointer
id|i_start
)paren
(brace
multiline_comment|/* may be zero in mkdir */
id|pos
op_assign
l_int|0
suffix:semicolon
id|bh
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
id|fat_get_entry
c_func
(paren
id|dir
comma
op_amp
id|pos
comma
op_amp
id|bh
comma
op_amp
id|de
)paren
OG
op_minus
l_int|1
)paren
(brace
multiline_comment|/* Skip extended filename entries */
r_if
c_cond
(paren
id|de-&gt;attr
op_eq
id|ATTR_EXT
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_FREE
c_func
(paren
id|de-&gt;name
)paren
op_logical_and
id|strncmp
c_func
(paren
id|de-&gt;name
comma
id|MSDOS_DOT
comma
id|MSDOS_NAME
)paren
op_logical_and
id|strncmp
c_func
(paren
id|de-&gt;name
comma
id|MSDOS_DOTDOT
comma
id|MSDOS_NAME
)paren
)paren
(brace
id|fat_brelse
c_func
(paren
id|sb
comma
id|bh
)paren
suffix:semicolon
r_return
op_minus
id|ENOTEMPTY
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|bh
)paren
id|fat_brelse
c_func
(paren
id|sb
comma
id|bh
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vfat_rmdir_free_ino
r_static
r_int
id|vfat_rmdir_free_ino
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|buffer_head
op_star
id|bh
comma
r_struct
id|msdos_dir_entry
op_star
id|de
comma
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_struct
id|super_block
op_star
id|sb
op_assign
id|dir-&gt;i_sb
suffix:semicolon
r_int
id|res
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|S_ISDIR
c_func
(paren
id|dentry-&gt;d_inode-&gt;i_mode
)paren
)paren
(brace
r_return
op_minus
id|ENOTDIR
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dir-&gt;i_dev
op_ne
id|dentry-&gt;d_inode-&gt;i_dev
op_logical_or
id|dir
op_eq
id|dentry-&gt;d_inode
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|res
op_assign
id|vfat_empty
c_func
(paren
id|dentry-&gt;d_inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
(brace
r_return
id|res
suffix:semicolon
)brace
id|dentry-&gt;d_inode-&gt;i_nlink
op_assign
l_int|0
suffix:semicolon
id|dentry-&gt;d_inode-&gt;i_mtime
op_assign
id|dir-&gt;i_mtime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|dentry-&gt;d_inode-&gt;i_atime
op_assign
id|dir-&gt;i_atime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|dir-&gt;i_nlink
op_decrement
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|dir
)paren
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|dentry-&gt;d_inode
)paren
suffix:semicolon
id|de-&gt;name
(braket
l_int|0
)braket
op_assign
id|DELETED_FLAG
suffix:semicolon
id|fat_mark_buffer_dirty
c_func
(paren
id|sb
comma
id|bh
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vfat_unlink_free_ino
r_static
r_int
id|vfat_unlink_free_ino
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|buffer_head
op_star
id|bh
comma
r_struct
id|msdos_dir_entry
op_star
id|de
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|nospc
)paren
(brace
r_struct
id|super_block
op_star
id|sb
op_assign
id|dir-&gt;i_sb
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|S_ISREG
c_func
(paren
id|dentry-&gt;d_inode-&gt;i_mode
)paren
op_logical_and
id|nospc
)paren
op_logical_or
id|IS_IMMUTABLE
c_func
(paren
id|dentry-&gt;d_inode
)paren
)paren
(brace
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
id|dentry-&gt;d_inode-&gt;i_nlink
op_assign
l_int|0
suffix:semicolon
id|dentry-&gt;d_inode-&gt;i_mtime
op_assign
id|dir-&gt;i_mtime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|dentry-&gt;d_inode-&gt;i_atime
op_assign
id|dir-&gt;i_atime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|dir-&gt;i_version
op_assign
op_increment
id|event
suffix:semicolon
id|MSDOS_I
c_func
(paren
id|dentry-&gt;d_inode
)paren
op_member_access_from_pointer
id|i_busy
op_assign
l_int|1
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|dir
)paren
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|dentry-&gt;d_inode
)paren
suffix:semicolon
id|de-&gt;name
(braket
l_int|0
)braket
op_assign
id|DELETED_FLAG
suffix:semicolon
id|fat_mark_buffer_dirty
c_func
(paren
id|sb
comma
id|bh
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vfat_remove_entry
r_static
r_int
id|vfat_remove_entry
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|vfat_slot_info
op_star
id|sinfo
comma
r_struct
id|buffer_head
op_star
op_star
id|bh
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|is_dir
comma
r_int
id|nospc
)paren
(brace
r_struct
id|super_block
op_star
id|sb
op_assign
id|dir-&gt;i_sb
suffix:semicolon
id|loff_t
id|offset
suffix:semicolon
r_struct
id|msdos_dir_entry
op_star
id|de
suffix:semicolon
r_int
id|res
comma
id|i
suffix:semicolon
multiline_comment|/* remove the shortname */
id|offset
op_assign
id|sinfo-&gt;shortname_offset
suffix:semicolon
id|res
op_assign
id|fat_get_entry
c_func
(paren
id|dir
comma
op_amp
id|offset
comma
id|bh
comma
op_amp
id|de
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
r_return
id|res
suffix:semicolon
r_if
c_cond
(paren
id|is_dir
)paren
(brace
id|res
op_assign
id|vfat_rmdir_free_ino
c_func
(paren
id|dir
comma
op_star
id|bh
comma
id|de
comma
id|dentry
)paren
suffix:semicolon
)brace
r_else
(brace
id|res
op_assign
id|vfat_unlink_free_ino
c_func
(paren
id|dir
comma
op_star
id|bh
comma
id|de
comma
id|dentry
comma
id|nospc
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
r_return
id|res
suffix:semicolon
multiline_comment|/* remove the longname */
id|offset
op_assign
id|sinfo-&gt;longname_offset
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|sinfo-&gt;long_slots
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
op_decrement
id|i
)paren
(brace
id|res
op_assign
id|fat_get_entry
c_func
(paren
id|dir
comma
op_amp
id|offset
comma
id|bh
comma
op_amp
id|de
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
(brace
r_continue
suffix:semicolon
)brace
id|de-&gt;name
(braket
l_int|0
)braket
op_assign
id|DELETED_FLAG
suffix:semicolon
id|de-&gt;attr
op_assign
l_int|0
suffix:semicolon
id|fat_mark_buffer_dirty
c_func
(paren
id|sb
comma
op_star
id|bh
comma
l_int|1
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Replace inodes in alias dentries and drop all but the initial dentry */
DECL|function|drop_replace_inodes
r_static
r_void
id|drop_replace_inodes
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|inode
op_star
id|inode
)paren
(brace
r_struct
id|list_head
op_star
id|head
comma
op_star
id|next
comma
op_star
id|tmp
suffix:semicolon
r_struct
id|dentry
op_star
id|alias
suffix:semicolon
id|PRINTK1
c_func
(paren
(paren
l_string|&quot;drop_replace_inodes: dentry=%p, inode=%p&bslash;n&quot;
comma
id|dentry
comma
id|inode
)paren
)paren
suffix:semicolon
id|head
op_assign
op_amp
id|dentry-&gt;d_inode-&gt;i_dentry
suffix:semicolon
r_if
c_cond
(paren
id|dentry-&gt;d_inode
)paren
(brace
id|next
op_assign
id|dentry-&gt;d_inode-&gt;i_dentry.next
suffix:semicolon
r_while
c_loop
(paren
id|next
op_ne
id|head
)paren
(brace
id|tmp
op_assign
id|next
suffix:semicolon
id|next
op_assign
id|tmp-&gt;next
suffix:semicolon
id|alias
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|dentry
comma
id|d_alias
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inode
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|alias-&gt;d_alias
)paren
suffix:semicolon
id|iput
c_func
(paren
id|alias-&gt;d_inode
)paren
suffix:semicolon
id|d_instantiate
c_func
(paren
id|alias
comma
id|inode
)paren
suffix:semicolon
multiline_comment|/* dentry is already accounted for */
r_if
c_cond
(paren
id|alias
op_ne
id|dentry
)paren
(brace
id|inode-&gt;i_count
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|alias
op_ne
id|dentry
)paren
(brace
id|d_drop
c_func
(paren
id|alias
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
DECL|function|vfat_rmdirx
r_static
r_int
id|vfat_rmdirx
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_struct
id|super_block
op_star
id|sb
op_assign
id|dir-&gt;i_sb
suffix:semicolon
r_int
id|res
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_struct
id|vfat_slot_info
id|sinfo
suffix:semicolon
id|PRINTK1
c_func
(paren
(paren
l_string|&quot;vfat_rmdirx: dentry=%p&bslash;n&quot;
comma
id|dentry
)paren
)paren
suffix:semicolon
id|res
op_assign
id|vfat_find
c_func
(paren
id|dir
comma
op_amp
id|dentry-&gt;d_name
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
op_amp
id|sinfo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
op_ge
l_int|0
op_logical_and
id|sinfo.total_slots
OG
l_int|0
)paren
(brace
id|bh
op_assign
l_int|NULL
suffix:semicolon
id|res
op_assign
id|vfat_remove_entry
c_func
(paren
id|dir
comma
op_amp
id|sinfo
comma
op_amp
id|bh
comma
id|dentry
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OG
l_int|0
)paren
(brace
id|res
op_assign
l_int|0
suffix:semicolon
)brace
id|dir-&gt;i_version
op_assign
op_increment
id|event
suffix:semicolon
r_if
c_cond
(paren
id|bh
)paren
id|fat_brelse
c_func
(paren
id|sb
comma
id|bh
)paren
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/***** Remove a directory */
DECL|function|vfat_rmdir
r_int
id|vfat_rmdir
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_int
id|res
suffix:semicolon
id|PRINTK1
c_func
(paren
(paren
l_string|&quot;vfat_rmdir: dentry=%p, inode=%p&bslash;n&quot;
comma
id|dentry
comma
id|dentry-&gt;d_inode
)paren
)paren
suffix:semicolon
id|res
op_assign
id|vfat_rmdirx
c_func
(paren
id|dir
comma
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
op_ge
l_int|0
)paren
(brace
id|drop_replace_inodes
c_func
(paren
id|dentry
comma
l_int|NULL
)paren
suffix:semicolon
id|d_delete
c_func
(paren
id|dentry
)paren
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
DECL|function|vfat_unlinkx
r_static
r_int
id|vfat_unlinkx
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|nospc
)paren
multiline_comment|/* Flag special file ? */
(brace
r_struct
id|super_block
op_star
id|sb
op_assign
id|dir-&gt;i_sb
suffix:semicolon
r_int
id|res
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_struct
id|vfat_slot_info
id|sinfo
suffix:semicolon
id|PRINTK1
c_func
(paren
(paren
l_string|&quot;vfat_unlinkx: dentry=%p, inode=%p&bslash;n&quot;
comma
id|dentry
comma
id|dentry-&gt;d_inode
)paren
)paren
suffix:semicolon
id|bh
op_assign
l_int|NULL
suffix:semicolon
id|res
op_assign
id|vfat_find
c_func
(paren
id|dir
comma
op_amp
id|dentry-&gt;d_name
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
op_amp
id|sinfo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
op_ge
l_int|0
op_logical_and
id|sinfo.total_slots
OG
l_int|0
)paren
(brace
id|res
op_assign
id|vfat_remove_entry
c_func
(paren
id|dir
comma
op_amp
id|sinfo
comma
op_amp
id|bh
comma
id|dentry
comma
l_int|0
comma
id|nospc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OG
l_int|0
)paren
(brace
id|res
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|bh
)paren
id|fat_brelse
c_func
(paren
id|sb
comma
id|bh
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
DECL|function|vfat_mkdir
r_int
id|vfat_mkdir
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|mode
)paren
(brace
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_int
id|res
suffix:semicolon
id|PRINTK1
c_func
(paren
(paren
l_string|&quot;vfat_mkdir: dentry=%p, inode=%p&bslash;n&quot;
comma
id|dentry
comma
id|dentry-&gt;d_inode
)paren
)paren
suffix:semicolon
id|fat_lock_creation
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res
op_assign
id|vfat_create_entry
c_func
(paren
id|dir
comma
op_amp
id|dentry-&gt;d_name
comma
l_int|1
comma
op_amp
id|inode
)paren
)paren
OL
l_int|0
)paren
(brace
id|fat_unlock_creation
c_func
(paren
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
id|dir-&gt;i_nlink
op_increment
suffix:semicolon
id|inode-&gt;i_nlink
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* no need to mark them dirty */
id|MSDOS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|i_busy
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* prevent lookups */
id|res
op_assign
id|vfat_create_dotdirs
c_func
(paren
id|inode
comma
id|dir
)paren
suffix:semicolon
id|fat_unlock_creation
c_func
(paren
)paren
suffix:semicolon
id|MSDOS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|i_busy
op_assign
l_int|0
suffix:semicolon
id|dentry-&gt;d_time
op_assign
id|dentry-&gt;d_parent-&gt;d_inode-&gt;i_version
suffix:semicolon
id|d_instantiate
c_func
(paren
id|dentry
comma
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|vfat_rmdir
c_func
(paren
id|dir
comma
id|dentry
)paren
OL
l_int|0
)paren
id|fat_fs_panic
c_func
(paren
id|dir-&gt;i_sb
comma
l_string|&quot;rmdir in mkdir failed&quot;
)paren
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/***** Unlink, as called for msdosfs */
DECL|function|vfat_unlink
r_int
id|vfat_unlink
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_int
id|res
suffix:semicolon
id|PRINTK1
c_func
(paren
(paren
l_string|&quot;vfat_unlink: dentry=%p, inode=%p&bslash;n&quot;
comma
id|dentry
comma
id|dentry-&gt;d_inode
)paren
)paren
suffix:semicolon
id|res
op_assign
id|vfat_unlinkx
(paren
id|dir
comma
id|dentry
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
op_ge
l_int|0
)paren
(brace
id|drop_replace_inodes
c_func
(paren
id|dentry
comma
l_int|NULL
)paren
suffix:semicolon
id|d_delete
c_func
(paren
id|dentry
)paren
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/***** Unlink, as called for uvfatfs */
DECL|function|vfat_unlink_uvfat
r_int
id|vfat_unlink_uvfat
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_int
id|res
suffix:semicolon
id|res
op_assign
id|vfat_unlinkx
(paren
id|dir
comma
id|dentry
comma
l_int|0
)paren
suffix:semicolon
id|iput
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
DECL|function|vfat_rename
r_int
id|vfat_rename
c_func
(paren
r_struct
id|inode
op_star
id|old_dir
comma
r_struct
id|dentry
op_star
id|old_dentry
comma
r_struct
id|inode
op_star
id|new_dir
comma
r_struct
id|dentry
op_star
id|new_dentry
)paren
(brace
r_struct
id|super_block
op_star
id|sb
op_assign
id|old_dir-&gt;i_sb
suffix:semicolon
r_struct
id|buffer_head
op_star
id|old_bh
comma
op_star
id|new_bh
comma
op_star
id|dotdot_bh
suffix:semicolon
r_struct
id|msdos_dir_entry
op_star
id|old_de
comma
op_star
id|new_de
comma
op_star
id|dotdot_de
suffix:semicolon
id|loff_t
id|old_offset
comma
id|new_offset
comma
id|old_longname_offset
suffix:semicolon
r_int
id|old_slots
comma
id|old_ino
comma
id|new_ino
comma
id|dotdot_ino
suffix:semicolon
r_struct
id|inode
op_star
id|old_inode
comma
op_star
id|new_inode
comma
op_star
id|dotdot_inode
suffix:semicolon
r_struct
id|dentry
op_star
id|walk
suffix:semicolon
r_int
id|res
comma
id|is_dir
comma
id|i
suffix:semicolon
r_int
id|locked
op_assign
l_int|0
suffix:semicolon
r_struct
id|vfat_slot_info
id|sinfo
suffix:semicolon
r_int
id|put_new_inode
op_assign
l_int|0
suffix:semicolon
id|PRINTK1
c_func
(paren
(paren
l_string|&quot;vfat_rename: Entering: old_dentry=%p, old_inode=%p, old ino=%ld, new_dentry=%p, new_inode=%p, new ino=%ld&bslash;n&quot;
comma
id|old_dentry
comma
id|old_dentry-&gt;d_inode
comma
id|old_dentry-&gt;d_inode-&gt;i_ino
comma
id|new_dentry
comma
id|new_dentry-&gt;d_inode
comma
id|new_dentry-&gt;d_inode
ques
c_cond
id|new_dentry-&gt;d_inode-&gt;i_ino
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|old_dir
op_eq
id|new_dir
op_logical_and
id|old_dentry-&gt;d_name.len
op_eq
id|new_dentry-&gt;d_name.len
op_logical_and
id|strncmp
c_func
(paren
id|old_dentry-&gt;d_name.name
comma
id|new_dentry-&gt;d_name.name
comma
id|old_dentry-&gt;d_name.len
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|old_bh
op_assign
id|new_bh
op_assign
l_int|NULL
suffix:semicolon
id|old_inode
op_assign
id|new_inode
op_assign
l_int|NULL
suffix:semicolon
id|res
op_assign
id|vfat_find
c_func
(paren
id|old_dir
comma
op_amp
id|old_dentry-&gt;d_name
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
op_amp
id|sinfo
)paren
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_rename 2&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
r_goto
id|rename_done
suffix:semicolon
id|old_slots
op_assign
id|sinfo.total_slots
suffix:semicolon
id|old_longname_offset
op_assign
id|sinfo.longname_offset
suffix:semicolon
id|old_offset
op_assign
id|sinfo.shortname_offset
suffix:semicolon
id|old_ino
op_assign
id|sinfo.ino
suffix:semicolon
id|res
op_assign
id|fat_get_entry
c_func
(paren
id|old_dir
comma
op_amp
id|old_offset
comma
op_amp
id|old_bh
comma
op_amp
id|old_de
)paren
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_rename 3&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
r_goto
id|rename_done
suffix:semicolon
id|res
op_assign
op_minus
id|ENOENT
suffix:semicolon
id|old_inode
op_assign
id|old_dentry-&gt;d_inode
suffix:semicolon
id|is_dir
op_assign
id|S_ISDIR
c_func
(paren
id|old_inode-&gt;i_mode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_dir
)paren
(brace
r_if
c_cond
(paren
(paren
id|old_dir-&gt;i_dev
op_ne
id|new_dir-&gt;i_dev
)paren
op_logical_or
(paren
id|old_ino
op_eq
id|new_dir-&gt;i_ino
)paren
)paren
(brace
id|res
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|rename_done
suffix:semicolon
)brace
id|walk
op_assign
id|new_dentry
suffix:semicolon
multiline_comment|/* prevent moving directory below itself */
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|walk
op_eq
id|old_dentry
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|walk
op_eq
id|walk-&gt;d_parent
)paren
r_break
suffix:semicolon
id|walk
op_assign
id|walk-&gt;d_parent
suffix:semicolon
)brace
)brace
id|res
op_assign
id|vfat_find
c_func
(paren
id|new_dir
comma
op_amp
id|new_dentry-&gt;d_name
comma
l_int|1
comma
l_int|0
comma
id|is_dir
comma
op_amp
id|sinfo
)paren
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_rename 4&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OG
op_minus
l_int|1
)paren
(brace
r_int
id|new_is_dir
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_rename 5&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Filename currently exists.  Need to delete it */
id|new_offset
op_assign
id|sinfo.shortname_offset
suffix:semicolon
id|res
op_assign
id|fat_get_entry
c_func
(paren
id|new_dir
comma
op_amp
id|new_offset
comma
op_amp
id|new_bh
comma
op_amp
id|new_de
)paren
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_rename 6&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
r_goto
id|rename_done
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|new_inode
op_assign
id|iget
c_func
(paren
id|new_dir-&gt;i_sb
comma
id|res
)paren
)paren
)paren
r_goto
id|rename_done
suffix:semicolon
id|new_is_dir
op_assign
id|S_ISDIR
c_func
(paren
id|new_inode-&gt;i_mode
)paren
suffix:semicolon
id|iput
c_func
(paren
id|new_inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_is_dir
)paren
(brace
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_rename 7&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|res
op_assign
id|vfat_rmdirx
c_func
(paren
id|new_dir
comma
id|new_dentry
)paren
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_rename 8&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
r_goto
id|rename_done
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Is this the same file, different case? */
r_if
c_cond
(paren
id|new_inode
op_ne
id|old_inode
)paren
(brace
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_rename 9&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|res
op_assign
id|vfat_unlink
c_func
(paren
id|new_dir
comma
id|new_dentry
)paren
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_rename 10&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
r_goto
id|rename_done
suffix:semicolon
)brace
)brace
)brace
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_rename 11&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|fat_lock_creation
c_func
(paren
)paren
suffix:semicolon
id|locked
op_assign
l_int|1
suffix:semicolon
id|res
op_assign
id|vfat_find
c_func
(paren
id|new_dir
comma
op_amp
id|new_dentry-&gt;d_name
comma
l_int|1
comma
l_int|1
comma
id|is_dir
comma
op_amp
id|sinfo
)paren
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_rename 12&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
r_goto
id|rename_done
suffix:semicolon
id|new_offset
op_assign
id|sinfo.shortname_offset
suffix:semicolon
id|new_ino
op_assign
id|sinfo.ino
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_rename 13: new_ino=%d&bslash;n&quot;
comma
id|new_ino
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|new_inode
op_assign
id|iget
c_func
(paren
id|new_dir-&gt;i_sb
comma
id|new_ino
)paren
)paren
)paren
r_goto
id|rename_done
suffix:semicolon
id|put_new_inode
op_assign
l_int|1
suffix:semicolon
id|new_inode-&gt;i_mode
op_assign
id|old_inode-&gt;i_mode
suffix:semicolon
id|new_inode-&gt;i_size
op_assign
id|old_inode-&gt;i_size
suffix:semicolon
id|new_inode-&gt;i_blocks
op_assign
id|old_inode-&gt;i_blocks
suffix:semicolon
id|new_inode-&gt;i_mtime
op_assign
id|old_inode-&gt;i_mtime
suffix:semicolon
id|new_inode-&gt;i_atime
op_assign
id|old_inode-&gt;i_atime
suffix:semicolon
id|new_inode-&gt;i_ctime
op_assign
id|old_inode-&gt;i_ctime
suffix:semicolon
id|MSDOS_I
c_func
(paren
id|new_inode
)paren
op_member_access_from_pointer
id|i_ctime_ms
op_assign
id|MSDOS_I
c_func
(paren
id|old_inode
)paren
op_member_access_from_pointer
id|i_ctime_ms
suffix:semicolon
id|MSDOS_I
c_func
(paren
id|new_inode
)paren
op_member_access_from_pointer
id|i_start
op_assign
id|MSDOS_I
c_func
(paren
id|old_inode
)paren
op_member_access_from_pointer
id|i_start
suffix:semicolon
id|MSDOS_I
c_func
(paren
id|new_inode
)paren
op_member_access_from_pointer
id|i_logstart
op_assign
id|MSDOS_I
c_func
(paren
id|old_inode
)paren
op_member_access_from_pointer
id|i_logstart
suffix:semicolon
id|MSDOS_I
c_func
(paren
id|new_inode
)paren
op_member_access_from_pointer
id|i_attrs
op_assign
id|MSDOS_I
c_func
(paren
id|old_inode
)paren
op_member_access_from_pointer
id|i_attrs
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|new_inode
)paren
suffix:semicolon
id|old_dir-&gt;i_version
op_assign
op_increment
id|event
suffix:semicolon
id|new_dir-&gt;i_version
op_assign
op_increment
id|event
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_rename 14: old_slots=%d&bslash;n&quot;
comma
id|old_slots
)paren
)paren
suffix:semicolon
multiline_comment|/* remove the old entry */
r_for
c_loop
(paren
id|i
op_assign
id|old_slots
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
op_decrement
id|i
)paren
(brace
id|res
op_assign
id|fat_get_entry
c_func
(paren
id|old_dir
comma
op_amp
id|old_longname_offset
comma
op_amp
id|old_bh
comma
op_amp
id|old_de
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;vfat_rename: problem 1&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|old_de-&gt;name
(braket
l_int|0
)braket
op_assign
id|DELETED_FLAG
suffix:semicolon
id|old_de-&gt;attr
op_assign
l_int|0
suffix:semicolon
id|fat_mark_buffer_dirty
c_func
(paren
id|sb
comma
id|old_bh
comma
l_int|1
)paren
suffix:semicolon
)brace
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_rename 15b&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|old_inode-&gt;i_mode
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|res
op_assign
id|fat_scan
c_func
(paren
id|old_inode
comma
id|MSDOS_DOTDOT
comma
op_amp
id|dotdot_bh
comma
op_amp
id|dotdot_de
comma
op_amp
id|dotdot_ino
comma
id|SCAN_ANY
)paren
)paren
OL
l_int|0
)paren
r_goto
id|rename_done
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dotdot_inode
op_assign
id|iget
c_func
(paren
id|old_inode-&gt;i_sb
comma
id|dotdot_ino
)paren
)paren
)paren
(brace
id|fat_brelse
c_func
(paren
id|sb
comma
id|dotdot_bh
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|rename_done
suffix:semicolon
)brace
id|MSDOS_I
c_func
(paren
id|dotdot_inode
)paren
op_member_access_from_pointer
id|i_start
op_assign
id|MSDOS_I
c_func
(paren
id|new_dir
)paren
op_member_access_from_pointer
id|i_start
suffix:semicolon
id|MSDOS_I
c_func
(paren
id|dotdot_inode
)paren
op_member_access_from_pointer
id|i_logstart
op_assign
id|MSDOS_I
c_func
(paren
id|new_dir
)paren
op_member_access_from_pointer
id|i_logstart
suffix:semicolon
id|dotdot_de-&gt;start
op_assign
id|CT_LE_W
c_func
(paren
id|MSDOS_I
c_func
(paren
id|new_dir
)paren
op_member_access_from_pointer
id|i_logstart
)paren
suffix:semicolon
id|dotdot_de-&gt;starthi
op_assign
id|CT_LE_W
c_func
(paren
(paren
id|MSDOS_I
c_func
(paren
id|new_dir
)paren
op_member_access_from_pointer
id|i_logstart
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|dotdot_inode
)paren
suffix:semicolon
id|fat_mark_buffer_dirty
c_func
(paren
id|sb
comma
id|dotdot_bh
comma
l_int|1
)paren
suffix:semicolon
id|old_dir-&gt;i_nlink
op_decrement
suffix:semicolon
id|new_dir-&gt;i_nlink
op_increment
suffix:semicolon
multiline_comment|/* no need to mark them dirty */
id|dotdot_inode-&gt;i_nlink
op_assign
id|new_dir-&gt;i_nlink
suffix:semicolon
id|iput
c_func
(paren
id|dotdot_inode
)paren
suffix:semicolon
id|fat_brelse
c_func
(paren
id|sb
comma
id|dotdot_bh
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|res
OG
l_int|0
)paren
id|res
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|res
op_eq
l_int|0
)paren
(brace
id|drop_replace_inodes
c_func
(paren
id|old_dentry
comma
id|new_inode
)paren
suffix:semicolon
id|d_move
c_func
(paren
id|old_dentry
comma
id|new_dentry
)paren
suffix:semicolon
id|put_new_inode
op_assign
l_int|0
suffix:semicolon
)brace
id|rename_done
suffix:colon
r_if
c_cond
(paren
id|locked
)paren
id|fat_unlock_creation
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|old_bh
)paren
id|fat_brelse
c_func
(paren
id|sb
comma
id|old_bh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_bh
)paren
id|fat_brelse
c_func
(paren
id|sb
comma
id|new_bh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|put_new_inode
)paren
id|iput
c_func
(paren
id|new_inode
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/* Public inode operations for the VFAT fs */
DECL|variable|vfat_dir_inode_operations
r_struct
id|inode_operations
id|vfat_dir_inode_operations
op_assign
(brace
op_amp
id|fat_dir_operations
comma
multiline_comment|/* default directory file-ops */
id|vfat_create
comma
multiline_comment|/* create */
id|vfat_lookup
comma
multiline_comment|/* lookup */
l_int|NULL
comma
multiline_comment|/* link */
id|vfat_unlink
comma
multiline_comment|/* unlink */
l_int|NULL
comma
multiline_comment|/* symlink */
id|vfat_mkdir
comma
multiline_comment|/* mkdir */
id|vfat_rmdir
comma
multiline_comment|/* rmdir */
l_int|NULL
comma
multiline_comment|/* mknod */
id|vfat_rename
comma
multiline_comment|/* rename */
l_int|NULL
comma
multiline_comment|/* readlink */
l_int|NULL
comma
multiline_comment|/* followlink */
l_int|NULL
comma
multiline_comment|/* readpage */
l_int|NULL
comma
multiline_comment|/* writepage */
id|fat_bmap
comma
multiline_comment|/* bmap */
l_int|NULL
comma
multiline_comment|/* truncate */
l_int|NULL
multiline_comment|/* permission */
)brace
suffix:semicolon
DECL|function|vfat_read_inode
r_void
id|vfat_read_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
id|fat_read_inode
c_func
(paren
id|inode
comma
op_amp
id|vfat_dir_inode_operations
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|init_vfat_fs
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|unregister_filesystem
c_func
(paren
op_amp
id|vfat_fs_type
)paren
suffix:semicolon
)brace
macro_line|#endif /* ifdef MODULE */
eof
