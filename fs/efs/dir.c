multiline_comment|/*&n; * dir.c&n; *&n; * Copyright (c) 1999 Al Smith&n; */
macro_line|#include &lt;linux/efs_fs.h&gt;
r_static
r_int
id|efs_readdir
c_func
(paren
r_struct
id|file
op_star
comma
r_void
op_star
comma
id|filldir_t
)paren
suffix:semicolon
DECL|variable|efs_dir_operations
r_struct
id|file_operations
id|efs_dir_operations
op_assign
(brace
id|read
suffix:colon
id|generic_read_dir
comma
id|readdir
suffix:colon
id|efs_readdir
comma
)brace
suffix:semicolon
DECL|variable|efs_dir_inode_operations
r_struct
id|inode_operations
id|efs_dir_inode_operations
op_assign
(brace
id|lookup
suffix:colon
id|efs_lookup
comma
)brace
suffix:semicolon
DECL|function|efs_readdir
r_static
r_int
id|efs_readdir
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_void
op_star
id|dirent
comma
id|filldir_t
id|filldir
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|filp-&gt;f_dentry-&gt;d_inode
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_struct
id|efs_dir
op_star
id|dirblock
suffix:semicolon
r_struct
id|efs_dentry
op_star
id|dirslot
suffix:semicolon
id|efs_ino_t
id|inodenum
suffix:semicolon
id|efs_block_t
id|block
suffix:semicolon
r_int
id|slot
comma
id|namelen
suffix:semicolon
r_char
op_star
id|nameptr
suffix:semicolon
r_if
c_cond
(paren
id|inode-&gt;i_size
op_amp
(paren
id|EFS_DIRBSIZE
op_minus
l_int|1
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;EFS: WARNING: readdir(): directory size not a multiple of EFS_DIRBSIZE&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* work out where this entry can be found */
id|block
op_assign
id|filp-&gt;f_pos
op_rshift
id|EFS_DIRBSIZE_BITS
suffix:semicolon
multiline_comment|/* each block contains at most 256 slots */
id|slot
op_assign
id|filp-&gt;f_pos
op_amp
l_int|0xff
suffix:semicolon
multiline_comment|/* look at all blocks */
r_while
c_loop
(paren
id|block
OL
id|inode-&gt;i_blocks
)paren
(brace
multiline_comment|/* read the dir block */
id|bh
op_assign
id|bread
c_func
(paren
id|inode-&gt;i_dev
comma
id|efs_bmap
c_func
(paren
id|inode
comma
id|block
)paren
comma
id|EFS_DIRBSIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bh
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EFS: readdir(): failed to read dir block %d&bslash;n&quot;
comma
id|block
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dirblock
op_assign
(paren
r_struct
id|efs_dir
op_star
)paren
id|bh-&gt;b_data
suffix:semicolon
r_if
c_cond
(paren
id|be16_to_cpu
c_func
(paren
id|dirblock-&gt;magic
)paren
op_ne
id|EFS_DIRBLK_MAGIC
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EFS: readdir(): invalid directory block&bslash;n&quot;
)paren
suffix:semicolon
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|slot
OL
id|dirblock-&gt;slots
)paren
(brace
r_if
c_cond
(paren
id|dirblock-&gt;space
(braket
id|slot
)braket
op_eq
l_int|0
)paren
(brace
id|slot
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|dirslot
op_assign
(paren
r_struct
id|efs_dentry
op_star
)paren
(paren
(paren
(paren
r_char
op_star
)paren
id|bh-&gt;b_data
)paren
op_plus
id|EFS_SLOTAT
c_func
(paren
id|dirblock
comma
id|slot
)paren
)paren
suffix:semicolon
id|inodenum
op_assign
id|be32_to_cpu
c_func
(paren
id|dirslot-&gt;inode
)paren
suffix:semicolon
id|namelen
op_assign
id|dirslot-&gt;namelen
suffix:semicolon
id|nameptr
op_assign
id|dirslot-&gt;name
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;EFS: readdir(): block %d slot %d/%d: inode %u, name &bslash;&quot;%s&bslash;&quot;, namelen %u&bslash;n&quot;
comma
id|block
comma
id|slot
comma
id|dirblock-&gt;slots
op_minus
l_int|1
comma
id|inodenum
comma
id|nameptr
comma
id|namelen
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|namelen
OG
l_int|0
)paren
(brace
multiline_comment|/* found the next entry */
id|filp-&gt;f_pos
op_assign
(paren
id|block
op_lshift
id|EFS_DIRBSIZE_BITS
)paren
op_or
id|slot
suffix:semicolon
multiline_comment|/* copy filename and data in dirslot */
id|filldir
c_func
(paren
id|dirent
comma
id|nameptr
comma
id|namelen
comma
id|filp-&gt;f_pos
comma
id|inodenum
comma
id|DT_UNKNOWN
)paren
suffix:semicolon
multiline_comment|/* sanity check */
r_if
c_cond
(paren
id|nameptr
op_minus
(paren
r_char
op_star
)paren
id|dirblock
op_plus
id|namelen
OG
id|EFS_DIRBSIZE
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;EFS: directory entry %d exceeds directory block&bslash;n&quot;
comma
id|slot
)paren
suffix:semicolon
id|slot
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* store position of next slot */
r_if
c_cond
(paren
op_increment
id|slot
op_eq
id|dirblock-&gt;slots
)paren
(brace
id|slot
op_assign
l_int|0
suffix:semicolon
id|block
op_increment
suffix:semicolon
)brace
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
id|filp-&gt;f_pos
op_assign
(paren
id|block
op_lshift
id|EFS_DIRBSIZE_BITS
)paren
op_or
id|slot
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|slot
op_increment
suffix:semicolon
)brace
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
id|slot
op_assign
l_int|0
suffix:semicolon
id|block
op_increment
suffix:semicolon
)brace
id|filp-&gt;f_pos
op_assign
(paren
id|block
op_lshift
id|EFS_DIRBSIZE_BITS
)paren
op_or
id|slot
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
