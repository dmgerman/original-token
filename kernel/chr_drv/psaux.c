multiline_comment|/*&n; * linux/kernel/chr_drv/psaux.c&n; *&n; * Driver for PS/2 type mouse by Johan Myreen.&n; *&n; * Supports pointing devices attached to a PS/2 type&n; * Keyboard and Auxiliary Device Controller.&n; *&n; */
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/system.h&gt;
DECL|macro|AUX_INPUT_PORT
mdefine_line|#define AUX_INPUT_PORT&t;0x60&t;&t;/* Aux device output buffer */
DECL|macro|AUX_OUTPUT_PORT
mdefine_line|#define AUX_OUTPUT_PORT&t;0x60&t;&t;/* Aux device input buffer */
DECL|macro|AUX_COMMAND
mdefine_line|#define AUX_COMMAND&t;0x64&t;&t;/* Aux device command buffer */
DECL|macro|AUX_STATUS
mdefine_line|#define AUX_STATUS&t;0x64&t;&t;/* Aux device status reg */
DECL|macro|MAX_RETRIES
mdefine_line|#define MAX_RETRIES&t;3
DECL|macro|AUX_IRQ
mdefine_line|#define AUX_IRQ&t;&t;12
DECL|macro|AUX_BUF_SIZE
mdefine_line|#define AUX_BUF_SIZE&t;2048
r_extern
r_int
r_char
id|aux_device_present
suffix:semicolon
DECL|struct|aux_queue
r_struct
id|aux_queue
(brace
DECL|member|head
r_int
r_int
id|head
suffix:semicolon
DECL|member|tail
r_int
r_int
id|tail
suffix:semicolon
DECL|member|proc_list
r_struct
id|wait_queue
op_star
id|proc_list
suffix:semicolon
DECL|member|buf
r_int
r_char
id|buf
(braket
id|AUX_BUF_SIZE
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|queue
r_static
r_struct
id|aux_queue
op_star
id|queue
suffix:semicolon
DECL|variable|aux_ready
r_static
r_int
id|aux_ready
op_assign
l_int|0
suffix:semicolon
DECL|variable|aux_busy
r_static
r_int
id|aux_busy
op_assign
l_int|0
suffix:semicolon
DECL|variable|aux_present
r_static
r_int
id|aux_present
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|poll_status
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|function|get_from_queue
r_static
r_int
r_int
id|get_from_queue
c_func
(paren
)paren
(brace
r_int
r_int
id|result
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|__asm__
id|__volatile__
(paren
l_string|&quot;pushfl ; popl %0; cli&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|flags
)paren
)paren
suffix:semicolon
id|result
op_assign
id|queue-&gt;buf
(braket
id|queue-&gt;tail
)braket
suffix:semicolon
id|queue-&gt;tail
op_assign
(paren
id|queue-&gt;tail
op_plus
l_int|1
)paren
op_amp
(paren
id|AUX_BUF_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|__asm__
id|__volatile__
(paren
l_string|&quot;pushl %0 ; popfl&quot;
op_scope_resolution
l_string|&quot;r&quot;
(paren
id|flags
)paren
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|queue_empty
r_static
r_inline
r_int
id|queue_empty
c_func
(paren
)paren
(brace
r_return
id|queue-&gt;head
op_eq
id|queue-&gt;tail
suffix:semicolon
)brace
multiline_comment|/*&n; * Interrupt from the auxiliary device: a character&n; * is waiting in the keyboard/aux controller.&n; */
DECL|function|aux_interrupt
r_static
r_void
id|aux_interrupt
c_func
(paren
r_int
id|cpl
)paren
(brace
r_int
id|head
op_assign
id|queue-&gt;head
suffix:semicolon
r_int
id|maxhead
op_assign
(paren
id|queue-&gt;tail
op_minus
l_int|1
)paren
op_amp
(paren
id|AUX_BUF_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|queue-&gt;buf
(braket
id|head
)braket
op_assign
id|inb
c_func
(paren
id|AUX_INPUT_PORT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|head
op_ne
id|maxhead
)paren
(brace
id|head
op_increment
suffix:semicolon
id|head
op_and_assign
id|AUX_BUF_SIZE
op_minus
l_int|1
suffix:semicolon
)brace
id|queue-&gt;head
op_assign
id|head
suffix:semicolon
id|aux_ready
op_assign
l_int|1
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|queue-&gt;proc_list
)paren
suffix:semicolon
)brace
DECL|function|release_aux
r_static
r_void
id|release_aux
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|poll_status
c_func
(paren
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0xa7
comma
id|AUX_COMMAND
)paren
suffix:semicolon
multiline_comment|/* Disable Aux device */
id|poll_status
c_func
(paren
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x60
comma
id|AUX_COMMAND
)paren
suffix:semicolon
id|poll_status
c_func
(paren
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x65
comma
id|AUX_OUTPUT_PORT
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|AUX_IRQ
)paren
suffix:semicolon
id|aux_busy
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Install interrupt handler.&n; * Enable auxiliary device.&n; */
DECL|function|open_aux
r_static
r_int
id|open_aux
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_if
c_cond
(paren
id|aux_busy
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|aux_present
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|poll_status
c_func
(paren
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|aux_busy
op_assign
l_int|1
suffix:semicolon
id|queue-&gt;head
op_assign
id|queue-&gt;tail
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Flush input queue */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|AUX_IRQ
comma
id|aux_interrupt
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x60
comma
id|AUX_COMMAND
)paren
suffix:semicolon
multiline_comment|/* Write command */
id|poll_status
c_func
(paren
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x47
comma
id|AUX_OUTPUT_PORT
)paren
suffix:semicolon
multiline_comment|/* Enable AUX and keyb interrupts */
id|poll_status
c_func
(paren
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0xa8
comma
id|AUX_COMMAND
)paren
suffix:semicolon
multiline_comment|/* Enable AUX */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Write to the aux device.&n; */
DECL|function|write_aux
r_static
r_int
id|write_aux
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buffer
comma
r_int
id|count
)paren
(brace
r_int
id|i
op_assign
id|count
suffix:semicolon
r_while
c_loop
(paren
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|poll_status
c_func
(paren
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0xd4
comma
id|AUX_COMMAND
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|poll_status
c_func
(paren
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|outb_p
c_func
(paren
id|get_fs_byte
c_func
(paren
id|buffer
op_increment
)paren
comma
id|AUX_OUTPUT_PORT
)paren
suffix:semicolon
)brace
id|inode-&gt;i_mtime
op_assign
id|CURRENT_TIME
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/*&n; * Put bytes from input queue to buffer.&n; */
DECL|function|read_aux
r_static
r_int
id|read_aux
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buffer
comma
r_int
id|count
)paren
(brace
r_int
id|i
op_assign
id|count
suffix:semicolon
r_int
r_char
id|c
suffix:semicolon
r_if
c_cond
(paren
id|queue_empty
c_func
(paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
r_return
op_minus
id|EWOULDBLOCK
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|queue-&gt;proc_list
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
OG
l_int|0
op_logical_and
op_logical_neg
id|queue_empty
c_func
(paren
)paren
)paren
(brace
id|c
op_assign
id|get_from_queue
c_func
(paren
)paren
suffix:semicolon
id|put_fs_byte
c_func
(paren
id|c
comma
id|buffer
op_increment
)paren
suffix:semicolon
id|i
op_decrement
suffix:semicolon
)brace
id|aux_ready
op_assign
op_logical_neg
id|queue_empty
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_minus
id|i
)paren
(brace
id|inode-&gt;i_atime
op_assign
id|CURRENT_TIME
suffix:semicolon
r_return
id|count
op_minus
id|i
suffix:semicolon
)brace
r_if
c_cond
(paren
id|current-&gt;signal
op_amp
op_complement
id|current-&gt;blocked
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|aux_select
r_static
r_int
id|aux_select
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
id|sel_type
comma
id|select_table
op_star
id|wait
)paren
(brace
r_if
c_cond
(paren
id|sel_type
op_ne
id|SEL_IN
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|aux_ready
)paren
r_return
l_int|1
suffix:semicolon
id|select_wait
c_func
(paren
op_amp
id|queue-&gt;proc_list
comma
id|wait
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|psaux_fops
r_struct
id|file_operations
id|psaux_fops
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* seek */
id|read_aux
comma
id|write_aux
comma
l_int|NULL
comma
multiline_comment|/* readdir */
id|aux_select
comma
l_int|NULL
comma
multiline_comment|/* ioctl */
id|open_aux
comma
id|release_aux
comma
)brace
suffix:semicolon
DECL|function|psaux_init
r_int
id|psaux_init
c_func
(paren
r_int
id|kmem_start
)paren
(brace
r_if
c_cond
(paren
id|aux_device_present
op_ne
l_int|0xaa
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;No PS/2 type pointing device detected.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|kmem_start
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;PS/2 type pointing device detected and installed.&bslash;n&quot;
)paren
suffix:semicolon
id|queue
op_assign
(paren
r_struct
id|aux_queue
op_star
)paren
id|kmem_start
suffix:semicolon
id|kmem_start
op_add_assign
r_sizeof
(paren
r_struct
id|aux_queue
)paren
suffix:semicolon
id|queue-&gt;head
op_assign
id|queue-&gt;tail
op_assign
l_int|0
suffix:semicolon
id|queue-&gt;proc_list
op_assign
l_int|0
suffix:semicolon
id|aux_present
op_assign
l_int|1
suffix:semicolon
r_return
id|kmem_start
suffix:semicolon
)brace
DECL|function|poll_status
r_static
r_int
id|poll_status
c_func
(paren
r_void
)paren
(brace
r_int
id|retries
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|AUX_STATUS
)paren
op_amp
l_int|0x03
)paren
op_logical_and
id|retries
op_increment
OL
id|MAX_RETRIES
)paren
(brace
r_if
c_cond
(paren
id|inb_p
c_func
(paren
id|AUX_STATUS
)paren
op_amp
l_int|0x01
)paren
id|inb_p
c_func
(paren
id|AUX_INPUT_PORT
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|current-&gt;timeout
op_assign
id|jiffies
op_plus
l_int|5
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
op_logical_neg
(paren
id|retries
op_eq
id|MAX_RETRIES
)paren
suffix:semicolon
)brace
eof
