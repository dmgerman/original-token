multiline_comment|/*&n; *  linux/kernel/printk.c&n; *&n; *  Copyright (C) 1991, 1992  Linus Torvalds&n; *&n; * Modified to make sys_syslog() more flexible: added commands to&n; * return the last 4k of kernel messages, regardless of whether&n; * they&squot;ve been read or not.  Added option to suppress kernel printk&squot;s&n; * to the console.  Added hook for sending the console messages&n; * elsewhere, in preparation for a serial line console (someday).&n; * Ted Ts&squot;o, 2/11/93.&n; * Modified for sysctl support, 1/8/97, Chris Horn.&n; */
macro_line|#include &lt;stdarg.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/tty_driver.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
DECL|macro|LOG_BUF_LEN
mdefine_line|#define LOG_BUF_LEN&t;8192
DECL|variable|buf
r_static
r_char
id|buf
(braket
l_int|1024
)braket
suffix:semicolon
multiline_comment|/* printk&squot;s without a loglevel use this.. */
DECL|macro|DEFAULT_MESSAGE_LOGLEVEL
mdefine_line|#define DEFAULT_MESSAGE_LOGLEVEL 4 /* KERN_WARNING */
multiline_comment|/* We show everything that is MORE important than this.. */
DECL|macro|MINIMUM_CONSOLE_LOGLEVEL
mdefine_line|#define MINIMUM_CONSOLE_LOGLEVEL 1 /* Minimum loglevel we let people use */
DECL|macro|DEFAULT_CONSOLE_LOGLEVEL
mdefine_line|#define DEFAULT_CONSOLE_LOGLEVEL 7 /* anything MORE serious than KERN_DEBUG */
DECL|variable|log_size
r_int
r_int
id|log_size
op_assign
l_int|0
suffix:semicolon
DECL|variable|log_wait
r_struct
id|wait_queue
op_star
id|log_wait
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Keep together for sysctl support */
DECL|variable|console_loglevel
r_int
id|console_loglevel
op_assign
id|DEFAULT_CONSOLE_LOGLEVEL
suffix:semicolon
DECL|variable|default_message_loglevel
r_int
id|default_message_loglevel
op_assign
id|DEFAULT_MESSAGE_LOGLEVEL
suffix:semicolon
DECL|variable|minimum_console_loglevel
r_int
id|minimum_console_loglevel
op_assign
id|MINIMUM_CONSOLE_LOGLEVEL
suffix:semicolon
DECL|variable|default_console_loglevel
r_int
id|default_console_loglevel
op_assign
id|DEFAULT_CONSOLE_LOGLEVEL
suffix:semicolon
DECL|variable|console_drivers
r_struct
id|console
op_star
id|console_drivers
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|log_buf
r_static
r_char
id|log_buf
(braket
id|LOG_BUF_LEN
)braket
suffix:semicolon
DECL|variable|log_start
r_static
r_int
r_int
id|log_start
op_assign
l_int|0
suffix:semicolon
DECL|variable|logged_chars
r_static
r_int
r_int
id|logged_chars
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; * Commands to sys_syslog:&n; *&n; * &t;0 -- Close the log.  Currently a NOP.&n; * &t;1 -- Open the log. Currently a NOP.&n; * &t;2 -- Read from the log.&n; * &t;3 -- Read up to the last 4k of messages in the ring buffer.&n; * &t;4 -- Read and clear last 4k of messages in the ring buffer&n; * &t;5 -- Clear ring buffer.&n; * &t;6 -- Disable printk&squot;s to console&n; * &t;7 -- Enable printk&squot;s to console&n; *&t;8 -- Set level of messages printed to console&n; */
DECL|function|sys_syslog
id|asmlinkage
r_int
id|sys_syslog
c_func
(paren
r_int
id|type
comma
r_char
op_star
id|buf
comma
r_int
id|len
)paren
(brace
r_int
r_int
id|i
comma
id|j
comma
id|count
suffix:semicolon
r_int
id|do_clear
op_assign
l_int|0
suffix:semicolon
r_char
id|c
suffix:semicolon
r_int
id|error
op_assign
op_minus
id|EPERM
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|type
op_ne
l_int|3
)paren
op_logical_and
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* Close log */
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* Open log */
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* Read from log */
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buf
op_logical_or
id|len
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|buf
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_goto
id|out
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|log_size
)paren
(brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|log_wait
)paren
suffix:semicolon
)brace
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|log_size
op_logical_and
id|i
OL
id|len
)paren
(brace
id|c
op_assign
op_star
(paren
(paren
r_char
op_star
)paren
id|log_buf
op_plus
id|log_start
)paren
suffix:semicolon
id|log_start
op_increment
suffix:semicolon
id|log_size
op_decrement
suffix:semicolon
id|log_start
op_and_assign
id|LOG_BUF_LEN
op_minus
l_int|1
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|c
comma
id|buf
)paren
suffix:semicolon
id|buf
op_increment
suffix:semicolon
id|i
op_increment
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
id|error
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
multiline_comment|/* Read/clear last kernel messages */
id|do_clear
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* FALL THRU */
r_case
l_int|3
suffix:colon
multiline_comment|/* Read last kernel messages */
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buf
op_logical_or
id|len
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|buf
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_goto
id|out
suffix:semicolon
id|count
op_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
id|LOG_BUF_LEN
)paren
id|count
op_assign
id|LOG_BUF_LEN
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
id|logged_chars
)paren
id|count
op_assign
id|logged_chars
suffix:semicolon
id|j
op_assign
id|log_start
op_plus
id|log_size
op_minus
id|count
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|c
op_assign
op_star
(paren
(paren
r_char
op_star
)paren
id|log_buf
op_plus
(paren
id|j
op_increment
op_amp
(paren
id|LOG_BUF_LEN
op_minus
l_int|1
)paren
)paren
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|c
comma
id|buf
op_increment
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|do_clear
)paren
id|logged_chars
op_assign
l_int|0
suffix:semicolon
id|error
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
multiline_comment|/* Clear ring buffer */
id|logged_chars
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
multiline_comment|/* Disable logging to console */
id|console_loglevel
op_assign
id|minimum_console_loglevel
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
multiline_comment|/* Enable logging to console */
id|console_loglevel
op_assign
id|default_console_loglevel
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|len
template_param
l_int|8
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|minimum_console_loglevel
)paren
id|len
op_assign
id|minimum_console_loglevel
suffix:semicolon
id|console_loglevel
op_assign
id|len
suffix:semicolon
id|error
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|out
suffix:colon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|printk
id|asmlinkage
r_int
id|printk
c_func
(paren
r_const
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
id|va_list
id|args
suffix:semicolon
r_int
id|i
suffix:semicolon
r_char
op_star
id|msg
comma
op_star
id|p
comma
op_star
id|buf_end
suffix:semicolon
r_int
id|line_feed
suffix:semicolon
r_static
r_int
r_char
id|msg_level
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|__save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|__cli
c_func
(paren
)paren
suffix:semicolon
id|va_start
c_func
(paren
id|args
comma
id|fmt
)paren
suffix:semicolon
id|i
op_assign
id|vsprintf
c_func
(paren
id|buf
op_plus
l_int|3
comma
id|fmt
comma
id|args
)paren
suffix:semicolon
multiline_comment|/* hopefully i &lt; sizeof(buf)-4 */
id|buf_end
op_assign
id|buf
op_plus
l_int|3
op_plus
id|i
suffix:semicolon
id|va_end
c_func
(paren
id|args
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|buf
op_plus
l_int|3
suffix:semicolon
id|p
OL
id|buf_end
suffix:semicolon
id|p
op_increment
)paren
(brace
id|msg
op_assign
id|p
suffix:semicolon
r_if
c_cond
(paren
id|msg_level
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|p
(braket
l_int|0
)braket
op_ne
l_char|&squot;&lt;&squot;
op_logical_or
id|p
(braket
l_int|1
)braket
template_param
l_char|&squot;7&squot;
op_logical_or
id|p
(braket
l_int|2
)braket
op_ne
l_char|&squot;&gt;&squot;
)paren
(brace
id|p
op_sub_assign
l_int|3
suffix:semicolon
id|p
(braket
l_int|0
)braket
op_assign
l_char|&squot;&lt;&squot;
suffix:semicolon
id|p
(braket
l_int|1
)braket
op_assign
id|default_message_loglevel
op_plus
l_char|&squot;0&squot;
suffix:semicolon
id|p
(braket
l_int|2
)braket
op_assign
l_char|&squot;&gt;&squot;
suffix:semicolon
)brace
r_else
id|msg
op_add_assign
l_int|3
suffix:semicolon
id|msg_level
op_assign
id|p
(braket
l_int|1
)braket
op_minus
l_char|&squot;0&squot;
suffix:semicolon
)brace
id|line_feed
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|p
OL
id|buf_end
suffix:semicolon
id|p
op_increment
)paren
(brace
id|log_buf
(braket
(paren
id|log_start
op_plus
id|log_size
)paren
op_amp
(paren
id|LOG_BUF_LEN
op_minus
l_int|1
)paren
)braket
op_assign
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|log_size
OL
id|LOG_BUF_LEN
)paren
id|log_size
op_increment
suffix:semicolon
r_else
(brace
id|log_start
op_increment
suffix:semicolon
id|log_start
op_and_assign
id|LOG_BUF_LEN
op_minus
l_int|1
suffix:semicolon
)brace
id|logged_chars
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
op_eq
l_char|&squot;&bslash;n&squot;
)paren
(brace
id|line_feed
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|msg_level
OL
id|console_loglevel
op_logical_and
id|console_drivers
)paren
(brace
r_struct
id|console
op_star
id|c
op_assign
id|console_drivers
suffix:semicolon
r_while
c_loop
(paren
id|c
)paren
(brace
r_if
c_cond
(paren
id|c-&gt;write
)paren
id|c
op_member_access_from_pointer
id|write
c_func
(paren
id|msg
comma
id|p
op_minus
id|msg
op_plus
id|line_feed
)paren
suffix:semicolon
id|c
op_assign
id|c-&gt;next
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|line_feed
)paren
id|msg_level
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
id|__restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|log_wait
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
DECL|function|console_print
r_void
id|console_print
c_func
(paren
r_const
r_char
op_star
id|s
)paren
(brace
r_struct
id|console
op_star
id|c
op_assign
id|console_drivers
suffix:semicolon
r_int
id|len
op_assign
id|strlen
c_func
(paren
id|s
)paren
suffix:semicolon
r_while
c_loop
(paren
id|c
)paren
(brace
r_if
c_cond
(paren
id|c-&gt;write
)paren
id|c
op_member_access_from_pointer
id|write
c_func
(paren
id|s
comma
id|len
)paren
suffix:semicolon
id|c
op_assign
id|c-&gt;next
suffix:semicolon
)brace
)brace
DECL|function|unblank_console
r_void
id|unblank_console
c_func
(paren
r_void
)paren
(brace
r_struct
id|console
op_star
id|c
op_assign
id|console_drivers
suffix:semicolon
r_while
c_loop
(paren
id|c
)paren
(brace
r_if
c_cond
(paren
id|c-&gt;unblank
)paren
id|c
op_member_access_from_pointer
id|unblank
c_func
(paren
)paren
suffix:semicolon
id|c
op_assign
id|c-&gt;next
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * The console driver calls this routine during kernel initialization&n; * to register the console printing procedure with printk() and to&n; * print any messages that were printed by the kernel before the&n; * console driver was initialized.&n; */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|register_console
c_func
(paren
r_struct
id|console
op_star
id|console
)paren
)paren
(brace
r_int
id|i
comma
id|j
comma
id|len
suffix:semicolon
r_int
id|p
op_assign
id|log_start
suffix:semicolon
r_char
id|buf
(braket
l_int|16
)braket
suffix:semicolon
r_int
r_char
id|msg_level
op_assign
op_minus
l_int|1
suffix:semicolon
r_char
op_star
id|q
suffix:semicolon
id|console-&gt;next
op_assign
id|console_drivers
suffix:semicolon
id|console_drivers
op_assign
id|console
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|log_size
suffix:semicolon
id|i
op_increment
)paren
(brace
id|buf
(braket
id|j
op_increment
)braket
op_assign
id|log_buf
(braket
id|p
)braket
suffix:semicolon
id|p
op_increment
suffix:semicolon
id|p
op_and_assign
id|LOG_BUF_LEN
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|buf
(braket
id|j
op_minus
l_int|1
)braket
op_ne
l_char|&squot;&bslash;n&squot;
op_logical_and
id|i
OL
id|log_size
op_minus
l_int|1
op_logical_and
id|j
OL
r_sizeof
(paren
id|buf
)paren
op_minus
l_int|1
)paren
r_continue
suffix:semicolon
id|buf
(braket
id|j
)braket
op_assign
l_int|0
suffix:semicolon
id|q
op_assign
id|buf
suffix:semicolon
id|len
op_assign
id|j
suffix:semicolon
r_if
c_cond
(paren
id|msg_level
OL
l_int|0
)paren
(brace
id|msg_level
op_assign
id|buf
(braket
l_int|1
)braket
op_minus
l_char|&squot;0&squot;
suffix:semicolon
id|q
op_assign
id|buf
op_plus
l_int|3
suffix:semicolon
id|len
op_sub_assign
l_int|3
suffix:semicolon
)brace
r_if
c_cond
(paren
id|msg_level
OL
id|console_loglevel
)paren
id|console
op_member_access_from_pointer
id|write
c_func
(paren
id|q
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf
(braket
id|j
op_minus
l_int|1
)braket
op_eq
l_char|&squot;&bslash;n&squot;
)paren
id|msg_level
op_assign
op_minus
l_int|1
suffix:semicolon
id|j
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Write a message to a certain tty, not just the console. This is used for&n; * messages that need to be redirected to a specific tty.&n; * We don&squot;t put it into the syslog queue right now maybe in the future if&n; * really needed.&n; */
DECL|function|tty_write_message
r_void
id|tty_write_message
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_char
op_star
id|msg
)paren
(brace
r_if
c_cond
(paren
id|tty
op_logical_and
id|tty-&gt;driver.write
)paren
id|tty-&gt;driver
dot
id|write
c_func
(paren
id|tty
comma
l_int|0
comma
id|msg
comma
id|strlen
c_func
(paren
id|msg
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
eof
