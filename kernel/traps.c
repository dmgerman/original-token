multiline_comment|/*&n; *  linux/kernel/traps.c&n; *&n; *  Copyright (C) 1991, 1992  Linus Torvalds&n; */
multiline_comment|/*&n; * &squot;Traps.c&squot; handles hardware traps and faults after we have saved some&n; * state in &squot;asm.s&squot;. Currently mostly a debugging-aid, will be extended&n; * to mainly kill the offending process (probably by giving it a signal,&n; * but possibly by killing it outright if necessary).&n; */
macro_line|#include &lt;linux/head.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/segment.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/io.h&gt;
DECL|macro|get_seg_byte
mdefine_line|#define get_seg_byte(seg,addr) ({ &bslash;&n;register char __res; &bslash;&n;__asm__(&quot;push %%fs;mov %%ax,%%fs;movb %%fs:%2,%%al;pop %%fs&quot; &bslash;&n;&t;:&quot;=a&quot; (__res):&quot;0&quot; (seg),&quot;m&quot; (*(addr))); &bslash;&n;__res;})
DECL|macro|get_seg_long
mdefine_line|#define get_seg_long(seg,addr) ({ &bslash;&n;register unsigned long __res; &bslash;&n;__asm__(&quot;push %%fs;mov %%ax,%%fs;movl %%fs:%2,%%eax;pop %%fs&quot; &bslash;&n;&t;:&quot;=a&quot; (__res):&quot;0&quot; (seg),&quot;m&quot; (*(addr))); &bslash;&n;__res;})
DECL|macro|_fs
mdefine_line|#define _fs() ({ &bslash;&n;register unsigned short __res; &bslash;&n;__asm__(&quot;mov %%fs,%%ax&quot;:&quot;=a&quot; (__res):); &bslash;&n;__res;})
r_void
id|page_exception
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
l_string|&quot;C&quot;
r_void
id|divide_error
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
l_string|&quot;C&quot;
r_void
id|debug
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
l_string|&quot;C&quot;
r_void
id|nmi
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
l_string|&quot;C&quot;
r_void
id|int3
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
l_string|&quot;C&quot;
r_void
id|overflow
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
l_string|&quot;C&quot;
r_void
id|bounds
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
l_string|&quot;C&quot;
r_void
id|invalid_op
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
l_string|&quot;C&quot;
r_void
id|device_not_available
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
l_string|&quot;C&quot;
r_void
id|double_fault
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
l_string|&quot;C&quot;
r_void
id|coprocessor_segment_overrun
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
l_string|&quot;C&quot;
r_void
id|invalid_TSS
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
l_string|&quot;C&quot;
r_void
id|segment_not_present
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
l_string|&quot;C&quot;
r_void
id|stack_segment
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
l_string|&quot;C&quot;
r_void
id|general_protection
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
l_string|&quot;C&quot;
r_void
id|page_fault
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
l_string|&quot;C&quot;
r_void
id|coprocessor_error
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
l_string|&quot;C&quot;
r_void
id|reserved
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
l_string|&quot;C&quot;
r_void
id|alignment_check
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|function|die_if_kernel
multiline_comment|/*static*/
r_void
id|die_if_kernel
c_func
(paren
r_char
op_star
id|str
comma
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|err
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|regs-&gt;eflags
op_amp
id|VM_MASK
)paren
op_logical_or
(paren
(paren
l_int|0xffff
op_amp
id|regs-&gt;cs
)paren
op_eq
id|USER_CS
)paren
)paren
r_return
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: %04x&bslash;n&quot;
comma
id|str
comma
id|err
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;EIP:    %04x:%p&bslash;nEFLAGS: %p&bslash;n&quot;
comma
l_int|0xffff
op_amp
id|regs-&gt;cs
comma
id|regs-&gt;eip
comma
id|regs-&gt;eflags
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;eax: %08x   ebx: %08x   ecx: %08x   edx: %08x&bslash;n&quot;
comma
id|regs-&gt;eax
comma
id|regs-&gt;ebx
comma
id|regs-&gt;ecx
comma
id|regs-&gt;edx
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;esi: %08x   edi: %08x   ebp: %08x&bslash;n&quot;
comma
id|regs-&gt;esi
comma
id|regs-&gt;edi
comma
id|regs-&gt;ebp
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ds: %04x   es: %04x   fs: %04x   gs: %04x&bslash;n&quot;
comma
id|regs-&gt;ds
comma
id|regs-&gt;es
comma
id|regs-&gt;fs
comma
id|regs-&gt;gs
)paren
suffix:semicolon
id|store_TR
c_func
(paren
id|i
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Pid: %d, process nr: %d&bslash;n&quot;
comma
id|current-&gt;pid
comma
l_int|0xffff
op_amp
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
l_int|0xff
op_amp
id|get_seg_byte
c_func
(paren
id|regs-&gt;cs
comma
(paren
id|i
op_plus
(paren
r_char
op_star
)paren
id|regs-&gt;eip
)paren
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|do_exit
c_func
(paren
id|SIGSEGV
)paren
suffix:semicolon
)brace
DECL|function|do_double_fault
r_extern
l_string|&quot;C&quot;
r_void
id|do_double_fault
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|error_code
)paren
(brace
id|send_sig
c_func
(paren
id|SIGSEGV
comma
id|current
comma
l_int|1
)paren
suffix:semicolon
id|die_if_kernel
c_func
(paren
l_string|&quot;double fault&quot;
comma
id|regs
comma
id|error_code
)paren
suffix:semicolon
)brace
DECL|function|do_general_protection
r_extern
l_string|&quot;C&quot;
r_void
id|do_general_protection
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|error_code
)paren
(brace
id|send_sig
c_func
(paren
id|SIGSEGV
comma
id|current
comma
l_int|1
)paren
suffix:semicolon
id|die_if_kernel
c_func
(paren
l_string|&quot;general protection&quot;
comma
id|regs
comma
id|error_code
)paren
suffix:semicolon
)brace
DECL|function|do_alignment_check
r_extern
l_string|&quot;C&quot;
r_void
id|do_alignment_check
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|error_code
)paren
(brace
id|send_sig
c_func
(paren
id|SIGSEGV
comma
id|current
comma
l_int|1
)paren
suffix:semicolon
id|die_if_kernel
c_func
(paren
l_string|&quot;alignment check&quot;
comma
id|regs
comma
id|error_code
)paren
suffix:semicolon
)brace
DECL|function|do_divide_error
r_extern
l_string|&quot;C&quot;
r_void
id|do_divide_error
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|error_code
)paren
(brace
id|send_sig
c_func
(paren
id|SIGFPE
comma
id|current
comma
l_int|1
)paren
suffix:semicolon
id|die_if_kernel
c_func
(paren
l_string|&quot;divide error&quot;
comma
id|regs
comma
id|error_code
)paren
suffix:semicolon
)brace
DECL|function|do_int3
r_extern
l_string|&quot;C&quot;
r_void
id|do_int3
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|error_code
)paren
(brace
r_if
c_cond
(paren
id|current-&gt;flags
op_amp
id|PF_PTRACED
)paren
id|current-&gt;blocked
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|SIGTRAP
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|send_sig
c_func
(paren
id|SIGTRAP
comma
id|current
comma
l_int|1
)paren
suffix:semicolon
id|die_if_kernel
c_func
(paren
l_string|&quot;int3&quot;
comma
id|regs
comma
id|error_code
)paren
suffix:semicolon
)brace
DECL|function|do_nmi
r_extern
l_string|&quot;C&quot;
r_void
id|do_nmi
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|error_code
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Uhhuh. NMI received. Dazed and confused, but trying to continue&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|do_debug
r_extern
l_string|&quot;C&quot;
r_void
id|do_debug
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|error_code
)paren
(brace
r_if
c_cond
(paren
id|current-&gt;flags
op_amp
id|PF_PTRACED
)paren
id|current-&gt;blocked
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|SIGTRAP
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|send_sig
c_func
(paren
id|SIGTRAP
comma
id|current
comma
l_int|1
)paren
suffix:semicolon
id|die_if_kernel
c_func
(paren
l_string|&quot;debug&quot;
comma
id|regs
comma
id|error_code
)paren
suffix:semicolon
)brace
DECL|function|do_overflow
r_extern
l_string|&quot;C&quot;
r_void
id|do_overflow
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|error_code
)paren
(brace
id|send_sig
c_func
(paren
id|SIGSEGV
comma
id|current
comma
l_int|1
)paren
suffix:semicolon
id|die_if_kernel
c_func
(paren
l_string|&quot;overflow&quot;
comma
id|regs
comma
id|error_code
)paren
suffix:semicolon
)brace
DECL|function|do_bounds
r_extern
l_string|&quot;C&quot;
r_void
id|do_bounds
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|error_code
)paren
(brace
id|send_sig
c_func
(paren
id|SIGSEGV
comma
id|current
comma
l_int|1
)paren
suffix:semicolon
id|die_if_kernel
c_func
(paren
l_string|&quot;bounds&quot;
comma
id|regs
comma
id|error_code
)paren
suffix:semicolon
)brace
DECL|function|do_invalid_op
r_extern
l_string|&quot;C&quot;
r_void
id|do_invalid_op
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|error_code
)paren
(brace
id|send_sig
c_func
(paren
id|SIGILL
comma
id|current
comma
l_int|1
)paren
suffix:semicolon
id|die_if_kernel
c_func
(paren
l_string|&quot;invalid operand&quot;
comma
id|regs
comma
id|error_code
)paren
suffix:semicolon
)brace
DECL|function|do_device_not_available
r_extern
l_string|&quot;C&quot;
r_void
id|do_device_not_available
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|error_code
)paren
(brace
id|send_sig
c_func
(paren
id|SIGSEGV
comma
id|current
comma
l_int|1
)paren
suffix:semicolon
id|die_if_kernel
c_func
(paren
l_string|&quot;device not available&quot;
comma
id|regs
comma
id|error_code
)paren
suffix:semicolon
)brace
DECL|function|do_coprocessor_segment_overrun
r_extern
l_string|&quot;C&quot;
r_void
id|do_coprocessor_segment_overrun
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|error_code
)paren
(brace
id|send_sig
c_func
(paren
id|SIGFPE
comma
id|last_task_used_math
comma
l_int|1
)paren
suffix:semicolon
id|die_if_kernel
c_func
(paren
l_string|&quot;coprocessor segment overrun&quot;
comma
id|regs
comma
id|error_code
)paren
suffix:semicolon
)brace
DECL|function|do_invalid_TSS
r_extern
l_string|&quot;C&quot;
r_void
id|do_invalid_TSS
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|error_code
)paren
(brace
id|send_sig
c_func
(paren
id|SIGSEGV
comma
id|current
comma
l_int|1
)paren
suffix:semicolon
id|die_if_kernel
c_func
(paren
l_string|&quot;invalid TSS&quot;
comma
id|regs
comma
id|error_code
)paren
suffix:semicolon
)brace
DECL|function|do_segment_not_present
r_extern
l_string|&quot;C&quot;
r_void
id|do_segment_not_present
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|error_code
)paren
(brace
id|send_sig
c_func
(paren
id|SIGSEGV
comma
id|current
comma
l_int|1
)paren
suffix:semicolon
id|die_if_kernel
c_func
(paren
l_string|&quot;segment not present&quot;
comma
id|regs
comma
id|error_code
)paren
suffix:semicolon
)brace
DECL|function|do_stack_segment
r_extern
l_string|&quot;C&quot;
r_void
id|do_stack_segment
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|error_code
)paren
(brace
id|send_sig
c_func
(paren
id|SIGSEGV
comma
id|current
comma
l_int|1
)paren
suffix:semicolon
id|die_if_kernel
c_func
(paren
l_string|&quot;stack segment&quot;
comma
id|regs
comma
id|error_code
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Allow the process which triggered the interrupt to recover the error&n; * condition.&n; *  - the status word is saved in the cs selector.&n; *  - the tag word is saved in the operand selector.&n; *  - the status word is then cleared and the tags all set to Empty.&n; *&n; * This will give sufficient information for complete recovery provided that&n; * the affected process knows or can deduce the code and data segments&n; * which were in force when the exception condition arose.&n; *&n; * Note that we play around with the &squot;TS&squot; bit to hopefully get&n; * the correct behaviour even in the presense of the asynchronous&n; * IRQ13 behaviour&n; */
DECL|function|math_error
r_void
id|math_error
c_func
(paren
r_void
)paren
(brace
r_struct
id|i387_hard_struct
op_star
id|env
suffix:semicolon
id|clts
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|last_task_used_math
)paren
(brace
id|__asm__
c_func
(paren
l_string|&quot;fnclex&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|env
op_assign
op_amp
id|last_task_used_math-&gt;tss.i387.hard
suffix:semicolon
id|send_sig
c_func
(paren
id|SIGFPE
comma
id|last_task_used_math
comma
l_int|1
)paren
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;fnsave %0&quot;
suffix:colon
l_string|&quot;=m&quot;
(paren
op_star
id|env
)paren
)paren
suffix:semicolon
id|last_task_used_math
op_assign
l_int|NULL
suffix:semicolon
id|stts
c_func
(paren
)paren
suffix:semicolon
id|env-&gt;fcs
op_assign
(paren
id|env-&gt;swd
op_amp
l_int|0x0000ffff
)paren
op_or
(paren
id|env-&gt;fcs
op_amp
l_int|0xffff0000
)paren
suffix:semicolon
id|env-&gt;fos
op_assign
id|env-&gt;twd
suffix:semicolon
id|env-&gt;swd
op_and_assign
l_int|0xffff0000
suffix:semicolon
id|env-&gt;twd
op_assign
l_int|0xffffffff
suffix:semicolon
)brace
DECL|function|do_coprocessor_error
r_extern
l_string|&quot;C&quot;
r_void
id|do_coprocessor_error
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|error_code
)paren
(brace
id|ignore_irq13
op_assign
l_int|1
suffix:semicolon
id|math_error
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|do_reserved
r_extern
l_string|&quot;C&quot;
r_void
id|do_reserved
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|error_code
)paren
(brace
id|send_sig
c_func
(paren
id|SIGSEGV
comma
id|current
comma
l_int|1
)paren
suffix:semicolon
id|die_if_kernel
c_func
(paren
l_string|&quot;reserved (15,17-47) error&quot;
comma
id|regs
comma
id|error_code
)paren
suffix:semicolon
)brace
DECL|function|trap_init
r_void
id|trap_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|set_trap_gate
c_func
(paren
l_int|0
comma
op_amp
id|divide_error
)paren
suffix:semicolon
id|set_trap_gate
c_func
(paren
l_int|1
comma
op_amp
id|debug
)paren
suffix:semicolon
id|set_trap_gate
c_func
(paren
l_int|2
comma
op_amp
id|nmi
)paren
suffix:semicolon
id|set_system_gate
c_func
(paren
l_int|3
comma
op_amp
id|int3
)paren
suffix:semicolon
multiline_comment|/* int3-5 can be called from all */
id|set_system_gate
c_func
(paren
l_int|4
comma
op_amp
id|overflow
)paren
suffix:semicolon
id|set_system_gate
c_func
(paren
l_int|5
comma
op_amp
id|bounds
)paren
suffix:semicolon
id|set_trap_gate
c_func
(paren
l_int|6
comma
op_amp
id|invalid_op
)paren
suffix:semicolon
id|set_trap_gate
c_func
(paren
l_int|7
comma
op_amp
id|device_not_available
)paren
suffix:semicolon
id|set_trap_gate
c_func
(paren
l_int|8
comma
op_amp
id|double_fault
)paren
suffix:semicolon
id|set_trap_gate
c_func
(paren
l_int|9
comma
op_amp
id|coprocessor_segment_overrun
)paren
suffix:semicolon
id|set_trap_gate
c_func
(paren
l_int|10
comma
op_amp
id|invalid_TSS
)paren
suffix:semicolon
id|set_trap_gate
c_func
(paren
l_int|11
comma
op_amp
id|segment_not_present
)paren
suffix:semicolon
id|set_trap_gate
c_func
(paren
l_int|12
comma
op_amp
id|stack_segment
)paren
suffix:semicolon
id|set_trap_gate
c_func
(paren
l_int|13
comma
op_amp
id|general_protection
)paren
suffix:semicolon
id|set_trap_gate
c_func
(paren
l_int|14
comma
op_amp
id|page_fault
)paren
suffix:semicolon
id|set_trap_gate
c_func
(paren
l_int|15
comma
op_amp
id|reserved
)paren
suffix:semicolon
id|set_trap_gate
c_func
(paren
l_int|16
comma
op_amp
id|coprocessor_error
)paren
suffix:semicolon
id|set_trap_gate
c_func
(paren
l_int|17
comma
op_amp
id|alignment_check
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|18
suffix:semicolon
id|i
OL
l_int|48
suffix:semicolon
id|i
op_increment
)paren
id|set_trap_gate
c_func
(paren
id|i
comma
op_amp
id|reserved
)paren
suffix:semicolon
)brace
eof
