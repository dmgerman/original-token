multiline_comment|/*---------------------------------------------------------------------------+&n; |  get_address.c                                                            |&n; |                                                                           |&n; | Get the effective address from an FPU instruction.                        |&n; |                                                                           |&n; | Copyright (C) 1992    W. Metzenthen, 22 Parker St, Ormond, Vic 3163,      |&n; |                       Australia.  E-mail apm233m@vaxc.cc.monash.edu.au    |&n; |                                                                           |&n; |                                                                           |&n; +---------------------------------------------------------------------------*/
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/math_emu.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &quot;fpu_system.h&quot;
macro_line|#include &quot;exception.h&quot;
macro_line|#include &quot;fpu_emu.h&quot;
DECL|variable|reg_offset
r_static
r_int
id|reg_offset
(braket
)braket
op_assign
(brace
m_offsetof
(paren
r_struct
id|info
comma
id|___eax
)paren
comma
m_offsetof
(paren
r_struct
id|info
comma
id|___ecx
)paren
comma
m_offsetof
(paren
r_struct
id|info
comma
id|___edx
)paren
comma
m_offsetof
(paren
r_struct
id|info
comma
id|___ebx
)paren
comma
m_offsetof
(paren
r_struct
id|info
comma
id|___esp
)paren
comma
m_offsetof
(paren
r_struct
id|info
comma
id|___ebp
)paren
comma
m_offsetof
(paren
r_struct
id|info
comma
id|___esi
)paren
comma
m_offsetof
(paren
r_struct
id|info
comma
id|___edi
)paren
)brace
suffix:semicolon
DECL|macro|REG_
mdefine_line|#define REG_(x) (*(long *)(reg_offset[(x)]+(char *) FPU_info))
DECL|variable|FPU_data_address
r_void
op_star
id|FPU_data_address
suffix:semicolon
multiline_comment|/* Decode the SIB byte. This function assumes mod != 0 */
DECL|function|sib
r_static
r_void
op_star
id|sib
c_func
(paren
r_int
id|mod
)paren
(brace
r_int
r_char
id|ss
comma
id|index
comma
id|base
suffix:semicolon
r_int
id|offset
suffix:semicolon
id|base
op_assign
id|get_fs_byte
c_func
(paren
(paren
r_char
op_star
)paren
id|FPU_EIP
)paren
suffix:semicolon
multiline_comment|/* The SIB byte */
id|FPU_EIP
op_increment
suffix:semicolon
id|ss
op_assign
id|base
op_rshift
l_int|6
suffix:semicolon
id|index
op_assign
(paren
id|base
op_rshift
l_int|3
)paren
op_amp
l_int|7
suffix:semicolon
id|base
op_and_assign
l_int|7
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mod
op_eq
l_int|0
)paren
op_logical_and
(paren
id|base
op_eq
l_int|5
)paren
)paren
id|offset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* No base register */
r_else
id|offset
op_assign
id|REG_
c_func
(paren
id|base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|index
op_eq
l_int|4
)paren
(brace
multiline_comment|/* No index register */
multiline_comment|/* A non-zero ss is illegal */
r_if
c_cond
(paren
id|ss
)paren
id|EXCEPTION
c_func
(paren
id|EX_Invalid
)paren
suffix:semicolon
)brace
r_else
(brace
id|offset
op_add_assign
(paren
id|REG_
c_func
(paren
id|index
)paren
)paren
op_lshift
id|ss
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mod
op_eq
l_int|1
)paren
(brace
multiline_comment|/* 8 bit signed displacement */
id|offset
op_add_assign
(paren
r_int
r_char
)paren
id|get_fs_byte
c_func
(paren
(paren
r_char
op_star
)paren
id|FPU_EIP
)paren
suffix:semicolon
id|FPU_EIP
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mod
op_eq
l_int|2
op_logical_or
id|base
op_eq
l_int|5
)paren
multiline_comment|/* The second condition also has mod==0 */
(brace
multiline_comment|/* 32 bit displacment */
id|offset
op_add_assign
(paren
r_int
)paren
id|get_fs_long
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|FPU_EIP
)paren
suffix:semicolon
id|FPU_EIP
op_add_assign
l_int|4
suffix:semicolon
)brace
r_return
(paren
r_void
op_star
)paren
id|offset
suffix:semicolon
)brace
multiline_comment|/*&n;       MOD R/M byte:  MOD == 3 has a special use for the FPU&n;                      SIB byte used iff R/M = 100b&n;&n;       7   6   5   4   3   2   1   0&n;       .....   .........   .........&n;        MOD    OPCODE(2)     R/M&n;&n;&n;       SIB byte&n;&n;       7   6   5   4   3   2   1   0&n;       .....   .........   .........&n;        SS      INDEX        BASE&n;&n;*/
DECL|function|get_address
r_void
id|get_address
c_func
(paren
r_void
)paren
(brace
r_int
r_char
id|mod
suffix:semicolon
r_int
op_star
id|cpu_reg_ptr
suffix:semicolon
r_int
id|offset
suffix:semicolon
id|mod
op_assign
(paren
id|FPU_modrm
op_rshift
l_int|6
)paren
op_amp
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|FPU_rm
op_eq
l_int|4
op_logical_and
id|mod
op_ne
l_int|3
)paren
(brace
id|FPU_data_address
op_assign
id|sib
c_func
(paren
id|mod
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|cpu_reg_ptr
op_assign
op_amp
id|REG_
c_func
(paren
id|FPU_rm
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|mod
)paren
(brace
r_case
l_int|0
suffix:colon
r_if
c_cond
(paren
id|FPU_rm
op_eq
l_int|5
)paren
(brace
multiline_comment|/* Special case: disp32 */
id|offset
op_assign
id|get_fs_long
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|FPU_EIP
)paren
suffix:semicolon
id|FPU_EIP
op_add_assign
l_int|4
suffix:semicolon
id|FPU_data_address
op_assign
(paren
r_void
op_star
)paren
id|offset
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
(brace
id|FPU_data_address
op_assign
(paren
r_void
op_star
)paren
op_star
id|cpu_reg_ptr
suffix:semicolon
multiline_comment|/* Just return the contents&n;&t;&t;&t;&t;&t;&t;   of the cpu register */
r_return
suffix:semicolon
)brace
r_case
l_int|1
suffix:colon
multiline_comment|/* 8 bit signed displacement */
id|offset
op_assign
(paren
r_int
r_char
)paren
id|get_fs_byte
c_func
(paren
(paren
r_char
op_star
)paren
id|FPU_EIP
)paren
suffix:semicolon
id|FPU_EIP
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* 32 bit displacement */
id|offset
op_assign
(paren
r_int
)paren
id|get_fs_long
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|FPU_EIP
)paren
suffix:semicolon
id|FPU_EIP
op_add_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* Not legal for the FPU */
id|EXCEPTION
c_func
(paren
id|EX_Invalid
)paren
suffix:semicolon
)brace
id|FPU_data_address
op_assign
id|offset
op_plus
(paren
r_char
op_star
)paren
op_star
id|cpu_reg_ptr
suffix:semicolon
)brace
eof
