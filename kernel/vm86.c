multiline_comment|/*&n; *  linux/kernel/vm86.c&n; *&n; *  Copyright (C) 1994  Linus Torvalds&n; */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/io.h&gt;
DECL|function|save_v86_state
id|asmlinkage
r_struct
id|pt_regs
op_star
id|save_v86_state
c_func
(paren
r_struct
id|vm86_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|stack
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|current-&gt;vm86_info
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;no vm86_info: BAD&bslash;n&quot;
)paren
suffix:semicolon
id|do_exit
c_func
(paren
id|SIGSEGV
)paren
suffix:semicolon
)brace
id|memcpy_tofs
c_func
(paren
op_amp
(paren
id|current-&gt;vm86_info-&gt;regs
)paren
comma
id|regs
comma
r_sizeof
(paren
op_star
id|regs
)paren
)paren
suffix:semicolon
id|put_fs_long
c_func
(paren
id|current-&gt;screen_bitmap
comma
op_amp
(paren
id|current-&gt;vm86_info-&gt;screen_bitmap
)paren
)paren
suffix:semicolon
id|stack
op_assign
id|current-&gt;tss.esp0
suffix:semicolon
id|current-&gt;tss.esp0
op_assign
id|current-&gt;saved_kernel_stack
suffix:semicolon
id|current-&gt;saved_kernel_stack
op_assign
l_int|0
suffix:semicolon
r_return
(paren
r_struct
id|pt_regs
op_star
)paren
id|stack
suffix:semicolon
)brace
DECL|function|mark_screen_rdonly
r_static
r_void
id|mark_screen_rdonly
c_func
(paren
r_struct
id|task_struct
op_star
id|tsk
)paren
(brace
r_int
r_int
id|tmp
suffix:semicolon
r_int
r_int
op_star
id|pg_table
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_assign
id|tsk-&gt;tss.cr3
)paren
op_ne
l_int|0
)paren
(brace
id|tmp
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_amp
id|PAGE_PRESENT
)paren
(brace
id|tmp
op_and_assign
id|PAGE_MASK
suffix:semicolon
id|pg_table
op_assign
(paren
l_int|0xA0000
op_rshift
id|PAGE_SHIFT
)paren
op_plus
(paren
r_int
r_int
op_star
)paren
id|tmp
suffix:semicolon
id|tmp
op_assign
l_int|32
suffix:semicolon
r_while
c_loop
(paren
id|tmp
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|PAGE_PRESENT
op_amp
op_star
id|pg_table
)paren
op_star
id|pg_table
op_and_assign
op_complement
id|PAGE_RW
suffix:semicolon
id|pg_table
op_increment
suffix:semicolon
)brace
)brace
)brace
)brace
DECL|function|sys_vm86
id|asmlinkage
r_int
id|sys_vm86
c_func
(paren
r_struct
id|vm86_struct
op_star
id|v86
)paren
(brace
r_struct
id|vm86_struct
id|info
suffix:semicolon
r_struct
id|pt_regs
op_star
id|pt_regs
op_assign
(paren
r_struct
id|pt_regs
op_star
)paren
op_amp
id|v86
suffix:semicolon
r_int
id|error
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;saved_kernel_stack
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
multiline_comment|/* v86 must be readable (now) and writable (for save_v86_state) */
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|v86
comma
r_sizeof
(paren
op_star
id|v86
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
op_amp
id|info
comma
id|v86
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
multiline_comment|/*&n; * make sure the vm86() system call doesn&squot;t try to do anything silly&n; */
id|info.regs.__null_ds
op_assign
l_int|0
suffix:semicolon
id|info.regs.__null_es
op_assign
l_int|0
suffix:semicolon
id|info.regs.__null_fs
op_assign
l_int|0
suffix:semicolon
id|info.regs.__null_gs
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; * The eflags register is also special: we cannot trust that the user&n; * has set it up safely, so this makes sure interrupt etc flags are&n; * inherited from protected mode.&n; */
id|info.regs.eflags
op_and_assign
l_int|0x00000dd5
suffix:semicolon
id|info.regs.eflags
op_or_assign
op_complement
l_int|0x00000dd5
op_amp
id|pt_regs-&gt;eflags
suffix:semicolon
id|info.regs.eflags
op_or_assign
id|VM_MASK
suffix:semicolon
id|current-&gt;saved_kernel_stack
op_assign
id|current-&gt;tss.esp0
suffix:semicolon
id|current-&gt;tss.esp0
op_assign
(paren
r_int
r_int
)paren
id|pt_regs
suffix:semicolon
id|current-&gt;vm86_info
op_assign
id|v86
suffix:semicolon
id|current-&gt;screen_bitmap
op_assign
id|info.screen_bitmap
suffix:semicolon
r_if
c_cond
(paren
id|info.flags
op_amp
id|VM86_SCREEN_BITMAP
)paren
id|mark_screen_rdonly
c_func
(paren
id|current
)paren
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;movl %0,%%esp&bslash;n&bslash;t&quot;
l_string|&quot;pushl $ret_from_sys_call&bslash;n&bslash;t&quot;
l_string|&quot;ret&quot;
suffix:colon
multiline_comment|/* no outputs */
suffix:colon
l_string|&quot;g&quot;
(paren
(paren
r_int
)paren
op_amp
(paren
id|info.regs
)paren
)paren
comma
l_string|&quot;a&quot;
(paren
id|info.regs.eax
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|return_to_32bit
r_static
r_inline
r_void
id|return_to_32bit
c_func
(paren
r_struct
id|vm86_regs
op_star
id|regs16
comma
r_int
id|retval
)paren
(brace
r_struct
id|pt_regs
op_star
id|regs32
suffix:semicolon
id|regs32
op_assign
id|save_v86_state
c_func
(paren
id|regs16
)paren
suffix:semicolon
id|regs32-&gt;eax
op_assign
id|retval
suffix:semicolon
id|__asm__
c_func
(paren
l_string|&quot;movl %0,%%esp&bslash;n&bslash;t&quot;
l_string|&quot;jmp ret_from_sys_call&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|regs32
)paren
)paren
suffix:semicolon
)brace
DECL|function|handle_vm86_fault
r_void
id|handle_vm86_fault
c_func
(paren
r_struct
id|vm86_regs
op_star
id|regs
comma
r_int
id|error_code
)paren
(brace
r_int
r_char
op_star
id|csp
suffix:semicolon
r_int
r_int
op_star
id|ssp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|i
suffix:semicolon
id|csp
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
(paren
id|regs-&gt;cs
op_lshift
l_int|4
)paren
op_plus
(paren
id|regs-&gt;eip
op_amp
l_int|0xffff
)paren
)paren
suffix:semicolon
id|ssp
op_assign
(paren
r_int
r_int
op_star
)paren
(paren
(paren
id|regs-&gt;ss
op_lshift
l_int|4
)paren
op_plus
(paren
id|regs-&gt;esp
op_amp
l_int|0xffff
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|get_fs_byte
c_func
(paren
id|csp
)paren
)paren
(brace
multiline_comment|/* operand size override */
r_case
l_int|0x66
suffix:colon
r_switch
c_cond
(paren
id|get_fs_byte
c_func
(paren
op_increment
id|csp
)paren
)paren
(brace
multiline_comment|/* pushfd */
r_case
l_int|0x9c
suffix:colon
id|regs-&gt;esp
op_sub_assign
l_int|4
suffix:semicolon
id|regs-&gt;eip
op_add_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|get_fs_long
c_func
(paren
op_amp
(paren
id|current-&gt;vm86_info-&gt;cpu_type
)paren
)paren
op_eq
id|CPU_386
)paren
id|put_fs_long
c_func
(paren
(paren
(paren
id|regs-&gt;eflags
)paren
op_amp
op_complement
(paren
id|AC_MASK
op_or
id|NT_MASK
op_or
id|IOPL_MASK
op_or
id|IF_MASK
)paren
)paren
op_or
(paren
id|get_fs_long
c_func
(paren
op_amp
(paren
id|current-&gt;vm86_info-&gt;v_eflags
)paren
)paren
op_amp
(paren
id|NT_MASK
op_or
id|IOPL_MASK
op_or
id|IF_MASK
)paren
)paren
comma
id|ssp
op_minus
l_int|2
)paren
suffix:semicolon
r_else
id|put_fs_long
c_func
(paren
(paren
(paren
id|regs-&gt;eflags
)paren
op_amp
op_complement
(paren
id|AC_MASK
op_or
id|NT_MASK
op_or
id|IOPL_MASK
op_or
id|IF_MASK
)paren
)paren
op_or
(paren
id|get_fs_long
c_func
(paren
op_amp
(paren
id|current-&gt;vm86_info-&gt;v_eflags
)paren
)paren
op_amp
(paren
id|AC_MASK
op_or
id|NT_MASK
op_or
id|IOPL_MASK
op_or
id|IF_MASK
)paren
)paren
comma
id|ssp
op_minus
l_int|2
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* popfd */
r_case
l_int|0x9d
suffix:colon
id|regs-&gt;esp
op_add_assign
l_int|4
suffix:semicolon
id|regs-&gt;eip
op_add_assign
l_int|2
suffix:semicolon
id|flags
op_assign
id|get_fs_word
c_func
(paren
id|ssp
op_plus
l_int|1
)paren
suffix:semicolon
id|put_fs_word
c_func
(paren
id|flags
comma
(paren
r_int
r_int
op_star
)paren
op_amp
(paren
id|current-&gt;vm86_info-&gt;v_eflags
)paren
op_plus
l_int|1
)paren
suffix:semicolon
r_goto
id|return_from_popf
suffix:semicolon
)brace
multiline_comment|/* pushf */
r_case
l_int|0x9c
suffix:colon
id|regs-&gt;esp
op_sub_assign
l_int|2
suffix:semicolon
id|regs-&gt;eip
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|get_fs_long
c_func
(paren
op_amp
(paren
id|current-&gt;vm86_info-&gt;cpu_type
)paren
)paren
op_eq
id|CPU_286
)paren
id|put_fs_word
c_func
(paren
(paren
(paren
id|regs-&gt;eflags
)paren
op_amp
l_int|0x0dd5
)paren
op_or
(paren
id|get_fs_word
c_func
(paren
op_amp
(paren
id|current-&gt;vm86_info-&gt;v_eflags
)paren
)paren
op_amp
op_complement
l_int|0xfdd5
)paren
comma
op_decrement
id|ssp
)paren
suffix:semicolon
r_else
id|put_fs_word
c_func
(paren
(paren
(paren
id|regs-&gt;eflags
)paren
op_amp
op_complement
(paren
id|NT_MASK
op_or
id|IOPL_MASK
op_or
id|IF_MASK
)paren
)paren
op_or
(paren
id|get_fs_word
c_func
(paren
op_amp
(paren
id|current-&gt;vm86_info-&gt;v_eflags
)paren
)paren
op_amp
(paren
id|NT_MASK
op_or
id|IOPL_MASK
op_or
id|IF_MASK
)paren
)paren
comma
op_decrement
id|ssp
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* popf */
r_case
l_int|0x9d
suffix:colon
id|regs-&gt;esp
op_add_assign
l_int|2
suffix:semicolon
id|regs-&gt;eip
op_increment
suffix:semicolon
id|return_from_popf
suffix:colon
id|flags
op_assign
id|get_fs_word
c_func
(paren
id|ssp
)paren
suffix:semicolon
id|regs-&gt;eflags
op_and_assign
op_complement
l_int|0x00000dd5
suffix:semicolon
id|regs-&gt;eflags
op_or_assign
id|flags
op_amp
l_int|0x00000dd5
suffix:semicolon
id|put_fs_word
c_func
(paren
id|flags
comma
op_amp
(paren
id|current-&gt;vm86_info-&gt;v_eflags
)paren
)paren
suffix:semicolon
r_goto
id|do_dosemu_timer
suffix:semicolon
multiline_comment|/* int 3 */
r_case
l_int|0xcc
suffix:colon
r_if
c_cond
(paren
id|get_fs_word
c_func
(paren
(paren
r_void
op_star
)paren
l_int|14
)paren
op_eq
id|BIOSSEG
op_logical_or
id|regs-&gt;cs
op_eq
id|BIOSSEG
op_logical_or
id|get_fs_byte
c_func
(paren
op_amp
(paren
id|current-&gt;vm86_info-&gt;int_revectored
(braket
l_int|3
)braket
)paren
)paren
)paren
id|return_to_32bit
c_func
(paren
id|regs
comma
id|SIGSEGV
)paren
suffix:semicolon
id|i
op_assign
l_int|3
suffix:semicolon
id|regs-&gt;eip
op_increment
suffix:semicolon
r_goto
id|return_from_int_xx
suffix:semicolon
multiline_comment|/* int xx */
r_case
l_int|0xcd
suffix:colon
id|i
op_assign
id|get_fs_byte
c_func
(paren
op_increment
id|csp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|get_fs_word
c_func
(paren
(paren
r_void
op_star
)paren
(paren
(paren
id|i
op_lshift
l_int|2
)paren
op_plus
l_int|2
)paren
)paren
op_eq
id|BIOSSEG
op_logical_or
id|regs-&gt;cs
op_eq
id|BIOSSEG
op_logical_or
id|get_fs_byte
c_func
(paren
op_amp
(paren
id|current-&gt;vm86_info-&gt;int_revectored
(braket
id|i
)braket
)paren
)paren
)paren
id|return_to_32bit
c_func
(paren
id|regs
comma
id|SIGSEGV
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_eq
l_int|0x21
)paren
op_logical_and
id|get_fs_byte
c_func
(paren
op_amp
(paren
id|current-&gt;vm86_info-&gt;int21_revectored
(braket
(paren
(paren
id|regs-&gt;eax
op_rshift
l_int|4
)paren
op_amp
l_int|0xff
)paren
)braket
)paren
)paren
)paren
id|return_to_32bit
c_func
(paren
id|regs
comma
id|SIGSEGV
)paren
suffix:semicolon
id|regs-&gt;eip
op_add_assign
l_int|2
suffix:semicolon
id|return_from_int_xx
suffix:colon
id|regs-&gt;esp
op_sub_assign
l_int|6
suffix:semicolon
r_if
c_cond
(paren
id|get_fs_long
c_func
(paren
op_amp
(paren
id|current-&gt;vm86_info-&gt;cpu_type
)paren
)paren
op_eq
id|CPU_286
)paren
id|put_fs_word
c_func
(paren
(paren
(paren
id|regs-&gt;eflags
)paren
op_amp
l_int|0x0dd5
)paren
op_or
(paren
id|get_fs_word
c_func
(paren
op_amp
(paren
id|current-&gt;vm86_info-&gt;v_eflags
)paren
)paren
op_amp
op_complement
l_int|0xfdd5
)paren
comma
op_decrement
id|ssp
)paren
suffix:semicolon
r_else
id|put_fs_word
c_func
(paren
(paren
(paren
id|regs-&gt;eflags
)paren
op_amp
op_complement
id|IF_MASK
)paren
op_or
(paren
id|get_fs_word
c_func
(paren
op_amp
(paren
id|current-&gt;vm86_info-&gt;v_eflags
)paren
)paren
op_amp
id|IF_MASK
)paren
comma
op_decrement
id|ssp
)paren
suffix:semicolon
id|put_fs_word
c_func
(paren
id|regs-&gt;cs
comma
op_decrement
id|ssp
)paren
suffix:semicolon
id|put_fs_word
c_func
(paren
(paren
r_int
r_int
)paren
(paren
id|regs-&gt;eip
)paren
comma
op_decrement
id|ssp
)paren
suffix:semicolon
id|regs-&gt;cs
op_assign
id|get_fs_word
c_func
(paren
(paren
r_void
op_star
)paren
(paren
(paren
id|i
op_lshift
l_int|2
)paren
op_plus
l_int|2
)paren
)paren
suffix:semicolon
id|regs-&gt;eip
op_assign
(paren
r_int
r_int
)paren
id|get_fs_word
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|i
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
id|regs-&gt;eflags
op_and_assign
op_complement
id|TF_MASK
suffix:semicolon
id|and_fs_long
c_func
(paren
op_complement
id|IF_MASK
comma
op_amp
(paren
id|current-&gt;vm86_info-&gt;v_eflags
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* iret */
r_case
l_int|0xcf
suffix:colon
id|regs-&gt;esp
op_add_assign
l_int|6
suffix:semicolon
id|regs-&gt;eip
op_assign
id|get_fs_word
c_func
(paren
id|ssp
op_increment
)paren
suffix:semicolon
id|regs-&gt;cs
op_assign
id|get_fs_word
c_func
(paren
id|ssp
op_increment
)paren
suffix:semicolon
r_goto
id|return_from_popf
suffix:semicolon
multiline_comment|/* cli */
r_case
l_int|0xfa
suffix:colon
id|regs-&gt;eip
op_increment
suffix:semicolon
id|and_fs_long
c_func
(paren
op_complement
id|IF_MASK
comma
op_amp
(paren
id|current-&gt;vm86_info-&gt;v_eflags
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* sti */
r_case
l_int|0xfb
suffix:colon
id|regs-&gt;eip
op_increment
suffix:semicolon
id|or_fs_long
c_func
(paren
id|IF_MASK
comma
op_amp
(paren
id|current-&gt;vm86_info-&gt;v_eflags
)paren
)paren
suffix:semicolon
id|do_dosemu_timer
suffix:colon
r_if
c_cond
(paren
(paren
id|get_fs_long
c_func
(paren
op_amp
(paren
id|current-&gt;vm86_info-&gt;v_eflags
)paren
)paren
op_amp
id|IF_MASK
)paren
op_logical_and
id|get_fs_long
c_func
(paren
op_amp
(paren
id|current-&gt;vm86_info-&gt;return_if_iflag
)paren
)paren
)paren
r_break
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
id|return_to_32bit
c_func
(paren
id|regs
comma
id|SIGSEGV
)paren
suffix:semicolon
)brace
id|return_to_32bit
c_func
(paren
id|regs
comma
id|SIGALRM
)paren
suffix:semicolon
)brace
eof
