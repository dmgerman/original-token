macro_line|#include &lt;time.h&gt;
multiline_comment|/*&n; * This isn&squot;t the library routine, it is only used in the kernel.&n; * as such, we don&squot;t care about years&lt;1970 etc, but assume everything&n; * is ok. Similarly, TZ etc is happily ignored. We just do everything&n; * as easily as possible. Let&squot;s find something public for the library&n; * routines (although I think minix times is public).&n; */
multiline_comment|/*&n; * PS. I hate whoever though up the year 1970 - couldn&squot;t they have gotten&n; * a leap-year instead? I also hate Gregorius, pope or no. I&squot;m grumpy.&n; */
DECL|macro|MINUTE
mdefine_line|#define MINUTE 60
DECL|macro|HOUR
mdefine_line|#define HOUR (60*MINUTE)
DECL|macro|DAY
mdefine_line|#define DAY (24*HOUR)
DECL|macro|YEAR
mdefine_line|#define YEAR (365*DAY)
multiline_comment|/* interestingly, we assume leap-years */
DECL|variable|month
r_static
r_int
id|month
(braket
l_int|12
)braket
op_assign
(brace
l_int|0
comma
id|DAY
op_star
(paren
l_int|31
)paren
comma
id|DAY
op_star
(paren
l_int|31
op_plus
l_int|29
)paren
comma
id|DAY
op_star
(paren
l_int|31
op_plus
l_int|29
op_plus
l_int|31
)paren
comma
id|DAY
op_star
(paren
l_int|31
op_plus
l_int|29
op_plus
l_int|31
op_plus
l_int|30
)paren
comma
id|DAY
op_star
(paren
l_int|31
op_plus
l_int|29
op_plus
l_int|31
op_plus
l_int|30
op_plus
l_int|31
)paren
comma
id|DAY
op_star
(paren
l_int|31
op_plus
l_int|29
op_plus
l_int|31
op_plus
l_int|30
op_plus
l_int|31
op_plus
l_int|30
)paren
comma
id|DAY
op_star
(paren
l_int|31
op_plus
l_int|29
op_plus
l_int|31
op_plus
l_int|30
op_plus
l_int|31
op_plus
l_int|30
op_plus
l_int|31
)paren
comma
id|DAY
op_star
(paren
l_int|31
op_plus
l_int|29
op_plus
l_int|31
op_plus
l_int|30
op_plus
l_int|31
op_plus
l_int|30
op_plus
l_int|31
op_plus
l_int|31
)paren
comma
id|DAY
op_star
(paren
l_int|31
op_plus
l_int|29
op_plus
l_int|31
op_plus
l_int|30
op_plus
l_int|31
op_plus
l_int|30
op_plus
l_int|31
op_plus
l_int|31
op_plus
l_int|30
)paren
comma
id|DAY
op_star
(paren
l_int|31
op_plus
l_int|29
op_plus
l_int|31
op_plus
l_int|30
op_plus
l_int|31
op_plus
l_int|30
op_plus
l_int|31
op_plus
l_int|31
op_plus
l_int|30
op_plus
l_int|31
)paren
comma
id|DAY
op_star
(paren
l_int|31
op_plus
l_int|29
op_plus
l_int|31
op_plus
l_int|30
op_plus
l_int|31
op_plus
l_int|30
op_plus
l_int|31
op_plus
l_int|31
op_plus
l_int|30
op_plus
l_int|31
op_plus
l_int|30
)paren
)brace
suffix:semicolon
DECL|function|kernel_mktime
r_int
id|kernel_mktime
c_func
(paren
r_struct
id|tm
op_star
id|tm
)paren
(brace
r_int
id|res
suffix:semicolon
r_int
id|year
suffix:semicolon
id|year
op_assign
id|tm-&gt;tm_year
op_minus
l_int|70
suffix:semicolon
multiline_comment|/* magic offsets (y+1) needed to get leapyears right.*/
id|res
op_assign
id|YEAR
op_star
id|year
op_plus
id|DAY
op_star
(paren
(paren
id|year
op_plus
l_int|1
)paren
op_div
l_int|4
)paren
suffix:semicolon
id|res
op_add_assign
id|month
(braket
id|tm-&gt;tm_mon
)braket
suffix:semicolon
multiline_comment|/* and (y+2) here. If it wasn&squot;t a leap-year, we have to adjust */
r_if
c_cond
(paren
id|tm-&gt;tm_mon
OG
l_int|1
op_logical_and
(paren
(paren
id|year
op_plus
l_int|2
)paren
op_mod
l_int|4
)paren
)paren
id|res
op_sub_assign
id|DAY
suffix:semicolon
id|res
op_add_assign
id|DAY
op_star
(paren
id|tm-&gt;tm_mday
op_minus
l_int|1
)paren
suffix:semicolon
id|res
op_add_assign
id|HOUR
op_star
id|tm-&gt;tm_hour
suffix:semicolon
id|res
op_add_assign
id|MINUTE
op_star
id|tm-&gt;tm_min
suffix:semicolon
id|res
op_add_assign
id|tm-&gt;tm_sec
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
eof
