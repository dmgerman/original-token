multiline_comment|/*&n;  SCSI Tape Driver for Linux&n;&n;  Version 0.02 for Linux 0.98.4 and Eric Youngdale&squot;s new scsi driver&n;&n;  History:&n;  Rewritten from Dwayne Forsyth&squot;s SCSI tape driver by Kai Makisara.&n;&n;  Features:&n;  - support for different block sizes and internal buffering&n;  - *nix-style ioctl with codes from mtio.h from the QIC-02 driver by&n;    Hennus Bergman (command MTSETBLK added)&n;  - character device&n;  - rewind and non-rewind devices&n;  - capability to handle several tape drives simultaneously&n;  - one buffer if one drive, two buffers if more than one drive (limits the&n;    number of simultaneously open drives to two)&n;  - write behind&n;  - seek and tell (Tandberg compatible and SCSI-2)&n;&n;  Devices:&n;  Autorewind devices have minor numbers equal to the tape numbers (0 &gt; ).&n;  Nonrewind device has the minor number equal to tape number + 128.&n;&n;  Problems:&n;  The end of media detection may not work correctly because of the buffering.&n;  If you want to do multiple tape backups relying on end of tape detection,&n;  you should disable write behind and in addition to that check that the&n;  tapes are readable.&n;&n;  Kai Makisara, Nov 9, 1992  email makisara@vtinsx.ins.vtt.fi or&n;                                    Kai.Makisara@vtt.fi&n;  Last changes Jan 3, 1993.&n;*/
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/mtio.h&gt;
macro_line|#include &lt;linux/ioctl.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/system.h&gt;
DECL|macro|MAJOR_NR
mdefine_line|#define MAJOR_NR 9
macro_line|#include &quot;../blk.h&quot;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;st.h&quot;
DECL|macro|MAX_RETRIES
mdefine_line|#define MAX_RETRIES 5
DECL|macro|NO_TAPE
mdefine_line|#define NO_TAPE  NOT_READY
multiline_comment|/* Uncomment the following if you want the rewind, etc. commands return&n;   before command completion. */
multiline_comment|/* #define ST_NOWAIT */
multiline_comment|/* Uncomment the following if you want the tape to be positioned correctly&n;   within file after close (the tape is positioned correctly with respect&n;   to the filemarks even wihout ST_IN_FILE_POS defined */
multiline_comment|/* #define ST_IN_FILE_POS */
multiline_comment|/* #define DEBUG */
DECL|macro|ST_TIMEOUT
mdefine_line|#define ST_TIMEOUT 6000
DECL|macro|ST_LONG_TIMEOUT
mdefine_line|#define ST_LONG_TIMEOUT 200000
multiline_comment|/* Number of ST_BLOCK_SIZE blocks in the buffers */
DECL|macro|ST_BUFFER_BLOCKS
mdefine_line|#define ST_BUFFER_BLOCKS 64
multiline_comment|/* Write-behind can be disabled by setting ST_WRITE_THRESHOLD_BLOCKS equal to or&n;   larger than ST_BUFFER_BLOCKS */
DECL|macro|ST_WRITE_THRESHOLD_BLOCKS
mdefine_line|#define ST_WRITE_THRESHOLD_BLOCKS 60
DECL|macro|ST_BLOCK_SIZE
mdefine_line|#define ST_BLOCK_SIZE 512
DECL|macro|ST_BUFFER_SIZE
mdefine_line|#define ST_BUFFER_SIZE (ST_BUFFER_BLOCKS * ST_BLOCK_SIZE)
DECL|macro|ST_WRITE_THRESHOLD
mdefine_line|#define ST_WRITE_THRESHOLD (ST_WRITE_THRESHOLD_BLOCKS * ST_BLOCK_SIZE)
DECL|variable|st_nbr_buffers
r_static
r_int
id|st_nbr_buffers
suffix:semicolon
DECL|variable|st_buffers
r_static
id|ST_buffer
op_star
id|st_buffers
(braket
l_int|2
)braket
suffix:semicolon
DECL|variable|scsi_tapes
r_static
id|Scsi_Tape
op_star
id|scsi_tapes
suffix:semicolon
DECL|variable|NR_ST
r_int
id|NR_ST
op_assign
l_int|0
suffix:semicolon
DECL|variable|MAX_ST
r_int
id|MAX_ST
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|st_int_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd_in
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
"&f;"
multiline_comment|/* Wakeup from interrupt */
DECL|function|st_sleep_done
r_static
r_void
id|st_sleep_done
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_int
id|st_nbr
suffix:semicolon
r_if
c_cond
(paren
(paren
id|st_nbr
op_assign
id|SCpnt-&gt;request.dev
)paren
OL
id|NR_ST
op_logical_and
id|st_nbr
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|st_nbr
)braket
dot
id|buffer-&gt;writing
op_logical_and
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x70
)paren
op_eq
l_int|0x70
op_logical_and
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x40
)paren
)paren
id|scsi_tapes
(braket
id|st_nbr
)braket
dot
id|buffer-&gt;last_result
op_assign
l_int|0x7fffffff
suffix:semicolon
r_else
id|scsi_tapes
(braket
id|st_nbr
)braket
dot
id|buffer-&gt;last_result
op_assign
id|SCpnt-&gt;result
suffix:semicolon
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|st_nbr
)braket
dot
id|buffer-&gt;writing
)paren
id|SCpnt-&gt;request.dev
op_assign
op_minus
l_int|1
suffix:semicolon
r_else
id|SCpnt-&gt;request.dev
op_assign
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|st_nbr
)braket
dot
id|buffer-&gt;writing
op_le
l_int|0
)paren
id|wake_up
c_func
(paren
op_amp
id|scsi_tapes
(braket
id|st_nbr
)braket
dot
id|waiting
)paren
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
r_else
id|printk
c_func
(paren
l_string|&quot;st?: Illegal interrupt device %x&bslash;n&quot;
comma
id|st_nbr
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#ifdef DEBUG
multiline_comment|/* Print sense information */
DECL|function|decode_sns
r_static
r_void
id|decode_sns
c_func
(paren
r_int
id|dev
comma
r_char
op_star
id|sense_buffer
)paren
(brace
r_static
r_char
op_star
id|snstext
(braket
)braket
op_assign
(brace
l_string|&quot;None&quot;
comma
l_string|&quot;Recovered Error&quot;
comma
l_string|&quot;Not Ready&quot;
comma
l_string|&quot;Medium Error&quot;
comma
l_string|&quot;Hardware Error&quot;
comma
l_string|&quot;Illegal Request&quot;
comma
l_string|&quot;Unit Attention&quot;
comma
l_string|&quot;Data Protect&quot;
comma
l_string|&quot;Blank Check&quot;
comma
l_string|&quot;Key=E&quot;
comma
l_string|&quot;Key=F&quot;
comma
l_string|&quot;Filemark&quot;
comma
l_string|&quot;End-Of-Medium&quot;
comma
l_string|&quot;Incorrect Block Length&quot;
comma
l_string|&quot;14&quot;
comma
l_string|&quot;15&quot;
)brace
suffix:semicolon
r_if
c_cond
(paren
id|sense_buffer
(braket
l_int|0
)braket
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x70
)paren
op_eq
l_int|0x70
)paren
(brace
r_if
c_cond
(paren
id|sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x80
)paren
id|printk
c_func
(paren
l_string|&quot;FMK &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x40
)paren
id|printk
c_func
(paren
l_string|&quot;EOM &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x20
)paren
id|printk
c_func
(paren
l_string|&quot;ILI &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;st%d: sense key %s&bslash;n&quot;
comma
id|dev
comma
id|snstext
(braket
id|sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|sense_buffer
(braket
l_int|0
)braket
OL
l_int|15
)paren
id|printk
c_func
(paren
l_string|&quot;st%d: old sense key %s&bslash;n&quot;
comma
id|dev
comma
id|snstext
(braket
id|sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x0f
)braket
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;st%d: sns = %2x %2x&bslash;n&quot;
comma
id|dev
comma
id|sense_buffer
(braket
l_int|0
)braket
comma
id|sense_buffer
(braket
l_int|2
)braket
)paren
suffix:semicolon
)brace
)brace
r_return
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Convert the result to success code */
DECL|function|st_chk_result
r_static
r_int
id|st_chk_result
c_func
(paren
r_int
id|dev
comma
r_int
id|result
comma
r_char
op_star
id|sense
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|result
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st%d: Error: %x&bslash;n&quot;
comma
id|dev
comma
id|result
)paren
suffix:semicolon
id|decode_sns
c_func
(paren
id|dev
comma
id|sense
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|sense
(braket
l_int|0
)braket
op_amp
l_int|0x70
)paren
op_eq
l_int|0x70
op_logical_and
(paren
(paren
id|sense
(braket
l_int|2
)braket
op_amp
l_int|0x80
)paren
multiline_comment|/* || ((sense[2] &amp; 0x0f) == 8) */
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
macro_line|#if ST_WRITE_THRESHOLD_BLOCKS &lt; ST_BUFFER_BLOCKS
multiline_comment|/* Handle the write-behind checking */
DECL|function|write_behind_check
r_static
r_void
id|write_behind_check
c_func
(paren
r_int
id|dev
)paren
(brace
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;last_result
OL
l_int|0
)paren
(brace
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;writing
op_assign
(paren
op_minus
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;writing
)paren
suffix:semicolon
id|sleep_on
c_func
(paren
op_amp
id|scsi_tapes
(braket
id|dev
)braket
dot
id|waiting
)paren
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;writing
op_assign
(paren
op_minus
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;writing
)paren
suffix:semicolon
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;writing
OL
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_bytes
)paren
id|memcpy
c_func
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
op_plus
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;writing
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_bytes
op_minus
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;writing
)paren
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_bytes
op_sub_assign
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;writing
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;writing
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Flush the write buffer */
DECL|function|flush_write_buffer
r_static
r_int
id|flush_write_buffer
c_func
(paren
r_int
id|dev
)paren
(brace
r_int
id|offset
comma
id|transfer
comma
id|blks
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
r_char
id|cmd
(braket
l_int|10
)braket
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
macro_line|#if ST_WRITE_THRESHOLD_BLOCKS &lt; ST_BUFFER_BLOCKS
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;writing
)paren
(brace
id|write_behind_check
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;last_result
)paren
(brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st%d: Async write error %x.&bslash;n&quot;
comma
id|dev
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;last_result
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
id|result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|dirty
op_eq
l_int|1
)paren
(brace
id|SCpnt
op_assign
id|allocate_device
c_func
(paren
l_int|NULL
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|device-&gt;index
comma
l_int|1
)paren
suffix:semicolon
id|offset
op_assign
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_bytes
suffix:semicolon
id|transfer
op_assign
(paren
(paren
id|offset
op_plus
id|scsi_tapes
(braket
id|dev
)braket
dot
id|block_size
op_minus
l_int|1
)paren
op_div
id|scsi_tapes
(braket
id|dev
)braket
dot
id|block_size
)paren
op_star
id|scsi_tapes
(braket
id|dev
)braket
dot
id|block_size
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st%d: Flushing %d bytes.&bslash;n&quot;
comma
id|dev
comma
id|transfer
)paren
suffix:semicolon
macro_line|#endif
id|memset
c_func
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
op_plus
id|offset
comma
l_int|0
comma
id|transfer
op_minus
id|offset
)paren
suffix:semicolon
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
l_int|10
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|WRITE_6
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
id|blks
op_assign
id|transfer
op_div
id|scsi_tapes
(braket
id|dev
)braket
dot
id|block_size
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
id|blks
op_rshift
l_int|16
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
id|blks
op_rshift
l_int|8
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|blks
suffix:semicolon
id|SCpnt-&gt;request.dev
op_assign
id|dev
suffix:semicolon
id|scsi_do_cmd
(paren
id|SCpnt
comma
(paren
r_void
op_star
)paren
id|cmd
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
comma
id|transfer
comma
id|st_sleep_done
comma
id|ST_TIMEOUT
comma
id|MAX_RETRIES
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;request.dev
op_eq
id|dev
)paren
id|sleep_on
c_func
(paren
op_amp
id|scsi_tapes
(braket
id|dev
)braket
dot
id|waiting
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;result
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;st%d: Error on flush:&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|st_chk_result
c_func
(paren
id|dev
comma
id|SCpnt-&gt;result
comma
id|SCpnt-&gt;sense_buffer
)paren
suffix:semicolon
macro_line|#endif
id|result
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_else
(brace
id|scsi_tapes
(braket
id|dev
)braket
dot
id|dirty
op_assign
l_int|0
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_bytes
op_assign
l_int|0
suffix:semicolon
)brace
id|SCpnt-&gt;request.dev
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Mark as not busy */
)brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* Flush the tape buffer. The tape will be positioned correctly unless&n;   seek_next is true. */
DECL|function|flush_buffer
r_static
r_int
id|flush_buffer
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
id|seek_next
)paren
(brace
r_int
id|dev
suffix:semicolon
r_int
id|backspace
comma
id|result
suffix:semicolon
id|dev
op_assign
id|inode-&gt;i_rdev
op_amp
l_int|127
suffix:semicolon
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|rw
op_eq
l_int|2
)paren
multiline_comment|/* Writing */
r_return
id|flush_write_buffer
c_func
(paren
id|dev
)paren
suffix:semicolon
id|backspace
op_assign
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_bytes
op_plus
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;read_pointer
)paren
op_div
id|scsi_tapes
(braket
id|dev
)braket
dot
id|block_size
op_minus
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;read_pointer
op_plus
id|scsi_tapes
(braket
id|dev
)braket
dot
id|block_size
op_minus
l_int|1
)paren
op_div
id|scsi_tapes
(braket
id|dev
)braket
dot
id|block_size
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_bytes
op_assign
l_int|0
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;read_pointer
op_assign
l_int|0
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|seek_next
op_logical_and
id|backspace
OG
l_int|0
)paren
(brace
id|result
op_assign
id|st_int_ioctl
c_func
(paren
id|inode
comma
id|filp
comma
id|MTBSR
comma
id|backspace
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|result
)paren
(brace
id|scsi_tapes
(braket
id|dev
)braket
dot
id|eof
op_assign
l_int|0
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|eof_hit
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_return
id|result
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Open the device */
DECL|function|scsi_tape_open
r_static
r_int
id|scsi_tape_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_int
id|dev
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_char
id|cmd
(braket
l_int|10
)braket
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
id|dev
op_assign
id|inode-&gt;i_rdev
op_amp
l_int|127
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|NR_ST
)paren
r_return
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|in_use
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;st%d: Device already in use.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
)brace
multiline_comment|/* Allocate buffer for this user */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|st_nbr_buffers
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|st_buffers
(braket
id|i
)braket
op_member_access_from_pointer
id|in_use
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|st_nbr_buffers
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;st%d: No free buffers.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
)brace
id|st_buffers
(braket
id|i
)braket
op_member_access_from_pointer
id|in_use
op_assign
l_int|1
suffix:semicolon
id|st_buffers
(braket
id|i
)braket
op_member_access_from_pointer
id|writing
op_assign
l_int|0
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer
op_assign
id|st_buffers
(braket
id|i
)braket
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|in_use
op_assign
l_int|1
suffix:semicolon
id|flags
op_assign
id|filp-&gt;f_flags
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|write_prot
op_assign
(paren
(paren
id|flags
op_amp
id|O_ACCMODE
)paren
op_eq
id|O_RDONLY
)paren
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|dirty
op_assign
l_int|0
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|rw
op_assign
l_int|0
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|eof
op_assign
l_int|0
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|eof_hit
op_assign
l_int|0
suffix:semicolon
id|SCpnt
op_assign
id|allocate_device
c_func
(paren
l_int|NULL
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|device-&gt;index
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SCpnt
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;st%d: Tape request not allocated&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
)brace
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|memset
(paren
(paren
r_void
op_star
)paren
op_amp
id|cmd
(braket
l_int|0
)braket
comma
l_int|0
comma
l_int|10
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|TEST_UNIT_READY
suffix:semicolon
id|SCpnt-&gt;request.dev
op_assign
id|dev
suffix:semicolon
id|scsi_do_cmd
c_func
(paren
id|SCpnt
comma
(paren
r_void
op_star
)paren
id|cmd
comma
(paren
r_void
op_star
)paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
comma
id|ST_BLOCK_SIZE
comma
id|st_sleep_done
comma
id|ST_LONG_TIMEOUT
comma
id|MAX_RETRIES
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;request.dev
op_eq
id|dev
)paren
id|sleep_on
c_func
(paren
op_amp
id|scsi_tapes
(braket
id|dev
)braket
dot
id|waiting
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x70
)paren
op_eq
l_int|0x70
op_logical_and
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
op_eq
id|UNIT_ATTENTION
)paren
(brace
multiline_comment|/* New media? */
macro_line|#ifdef DEBUG
id|decode_sns
c_func
(paren
id|dev
comma
id|SCpnt-&gt;sense_buffer
)paren
suffix:semicolon
macro_line|#endif
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|memset
(paren
(paren
r_void
op_star
)paren
op_amp
id|cmd
(braket
l_int|0
)braket
comma
l_int|0
comma
l_int|10
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|TEST_UNIT_READY
suffix:semicolon
id|SCpnt-&gt;request.dev
op_assign
id|dev
suffix:semicolon
id|scsi_do_cmd
c_func
(paren
id|SCpnt
comma
(paren
r_void
op_star
)paren
id|cmd
comma
(paren
r_void
op_star
)paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
comma
id|ST_BLOCK_SIZE
comma
id|st_sleep_done
comma
id|ST_LONG_TIMEOUT
comma
id|MAX_RETRIES
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;request.dev
op_eq
id|dev
)paren
id|sleep_on
c_func
(paren
op_amp
id|scsi_tapes
(braket
id|dev
)braket
dot
id|waiting
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|SCpnt-&gt;result
op_ne
l_int|0
)paren
(brace
macro_line|#ifdef DEBUG
id|decode_sns
c_func
(paren
id|dev
comma
id|SCpnt-&gt;sense_buffer
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x70
)paren
op_eq
l_int|0x70
op_logical_and
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
op_eq
id|NO_TAPE
)paren
id|printk
c_func
(paren
l_string|&quot;st%d: No tape.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;st%d: Error %x.&bslash;n&quot;
comma
id|dev
comma
id|SCpnt-&gt;result
)paren
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;in_use
op_assign
l_int|0
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|in_use
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;request.dev
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Mark as not busy */
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|memset
(paren
(paren
r_void
op_star
)paren
op_amp
id|cmd
(braket
l_int|0
)braket
comma
l_int|0
comma
l_int|10
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|READ_BLOCK_LIMITS
suffix:semicolon
id|SCpnt-&gt;request.dev
op_assign
id|dev
suffix:semicolon
id|scsi_do_cmd
c_func
(paren
id|SCpnt
comma
(paren
r_void
op_star
)paren
id|cmd
comma
(paren
r_void
op_star
)paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
comma
id|ST_BLOCK_SIZE
comma
id|st_sleep_done
comma
id|ST_TIMEOUT
comma
id|MAX_RETRIES
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;request.dev
op_eq
id|dev
)paren
id|sleep_on
c_func
(paren
op_amp
id|scsi_tapes
(braket
id|dev
)braket
dot
id|waiting
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SCpnt-&gt;result
op_logical_and
op_logical_neg
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
)paren
(brace
id|scsi_tapes
(braket
id|dev
)braket
dot
id|max_block
op_assign
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|1
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|3
)braket
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|min_block
op_assign
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_or
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|5
)braket
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st%d: Block limits %d - %d bytes.&bslash;n&quot;
comma
id|dev
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|min_block
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|max_block
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|scsi_tapes
(braket
id|dev
)braket
dot
id|min_block
op_assign
id|scsi_tapes
(braket
id|dev
)braket
dot
id|max_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st%d: Can&squot;t read block limits.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
)brace
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|memset
(paren
(paren
r_void
op_star
)paren
op_amp
id|cmd
(braket
l_int|0
)braket
comma
l_int|0
comma
l_int|10
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|MODE_SENSE
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
l_int|12
suffix:semicolon
id|SCpnt-&gt;request.dev
op_assign
id|dev
suffix:semicolon
id|scsi_do_cmd
c_func
(paren
id|SCpnt
comma
(paren
r_void
op_star
)paren
id|cmd
comma
(paren
r_void
op_star
)paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
comma
id|ST_BLOCK_SIZE
comma
id|st_sleep_done
comma
id|ST_TIMEOUT
comma
id|MAX_RETRIES
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;request.dev
op_eq
id|dev
)paren
id|sleep_on
c_func
(paren
op_amp
id|scsi_tapes
(braket
id|dev
)braket
dot
id|waiting
)paren
suffix:semicolon
id|i
op_assign
id|st_chk_result
c_func
(paren
id|dev
comma
id|SCpnt-&gt;result
comma
id|SCpnt-&gt;sense_buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
(brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st%d: No Mode Sense.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|2
)braket
op_assign
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|SCpnt-&gt;request.dev
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Mark as not busy */
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st%d: Mode sense. Length %d, medium %x, WBS %x, BLL %d&bslash;n&quot;
comma
id|dev
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|0
)braket
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|1
)braket
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|2
)braket
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|3
)braket
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|3
)braket
op_ge
l_int|8
)paren
(brace
id|scsi_tapes
(braket
id|dev
)braket
dot
id|block_size
op_assign
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|9
)braket
op_star
l_int|65536
op_plus
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|10
)braket
op_star
l_int|256
op_plus
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|11
)braket
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st%d: Density %x, tape length: %x, blocksize: %d&bslash;n&quot;
comma
id|dev
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|4
)braket
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|5
)braket
op_star
l_int|65536
op_plus
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|6
)braket
op_star
l_int|256
op_plus
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|7
)braket
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|9
)braket
op_star
l_int|65536
op_plus
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|10
)braket
op_star
l_int|256
op_plus
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|11
)braket
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|block_size
OG
id|ST_BUFFER_SIZE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;st%d: Blocksize %d too large for buffer.&bslash;n&quot;
comma
id|dev
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|block_size
)paren
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;in_use
op_assign
l_int|0
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|in_use
op_assign
l_int|0
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|block_size
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;st%d: Fixing block size to 512 bytes.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st_int_ioctl
c_func
(paren
id|inode
comma
id|filp
comma
id|MTSETBLK
comma
id|ST_BLOCK_SIZE
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;st%d: Can&squot;t set fixed block size.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;in_use
op_assign
l_int|0
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|in_use
op_assign
l_int|0
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|scsi_tapes
(braket
id|dev
)braket
dot
id|block_size
op_assign
id|ST_BLOCK_SIZE
suffix:semicolon
)brace
)brace
r_else
id|scsi_tapes
(braket
id|dev
)braket
dot
id|block_size
op_assign
id|ST_BLOCK_SIZE
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_blocks
op_assign
id|ST_BUFFER_SIZE
op_div
id|scsi_tapes
(braket
id|dev
)braket
dot
id|block_size
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_size
op_assign
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_blocks
op_star
id|scsi_tapes
(braket
id|dev
)braket
dot
id|block_size
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_bytes
op_assign
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;read_pointer
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st%d: Block size: %d, buffer size: %d (%d blocks).&bslash;n&quot;
comma
id|dev
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|block_size
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_size
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_blocks
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|2
)braket
op_amp
l_int|0x80
)paren
(brace
id|scsi_tapes
(braket
id|dev
)braket
dot
id|write_prot
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st%d: Write protected&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
)brace
r_return
l_int|0
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Close the device*/
DECL|function|scsi_tape_close
r_static
r_void
id|scsi_tape_close
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_int
id|dev
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
id|rewind
suffix:semicolon
r_static
r_int
r_char
id|cmd
(braket
l_int|10
)braket
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
id|dev
op_assign
id|inode-&gt;i_rdev
suffix:semicolon
id|rewind
op_assign
(paren
id|dev
op_amp
l_int|0x80
)paren
op_eq
l_int|0
suffix:semicolon
id|dev
op_assign
id|dev
op_amp
l_int|127
suffix:semicolon
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|rw
op_eq
l_int|2
)paren
(brace
id|result
op_assign
id|flush_write_buffer
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st%d: File length %d bytes.&bslash;n&quot;
comma
id|dev
comma
id|filp-&gt;f_pos
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|result
)paren
(brace
id|SCpnt
op_assign
id|allocate_device
c_func
(paren
l_int|NULL
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|device-&gt;index
comma
l_int|1
)paren
suffix:semicolon
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
l_int|10
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|WRITE_FILEMARKS
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
l_int|1
suffix:semicolon
id|SCpnt-&gt;request.dev
op_assign
id|dev
suffix:semicolon
id|scsi_do_cmd
c_func
(paren
id|SCpnt
comma
(paren
r_void
op_star
)paren
id|cmd
comma
(paren
r_void
op_star
)paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
comma
id|ST_BLOCK_SIZE
comma
id|st_sleep_done
comma
id|ST_TIMEOUT
comma
id|MAX_RETRIES
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;request.dev
op_eq
id|dev
)paren
id|sleep_on
c_func
(paren
op_amp
id|scsi_tapes
(braket
id|dev
)braket
dot
id|waiting
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;result
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;st%d: Error on write filemark:&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|st_chk_result
c_func
(paren
id|dev
comma
id|SCpnt-&gt;result
comma
id|SCpnt-&gt;sense_buffer
)paren
suffix:semicolon
macro_line|#endif
)brace
id|SCpnt-&gt;request.dev
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Mark as not busy */
)brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st%d: Buffer flushed, EOF written&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|rewind
)paren
(brace
r_if
c_cond
(paren
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|eof
op_eq
l_int|1
)paren
op_logical_and
op_logical_neg
id|scsi_tapes
(braket
id|dev
)braket
dot
id|eof_hit
)paren
id|st_int_ioctl
c_func
(paren
id|inode
comma
id|filp
comma
id|MTBSF
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Back over the EOF hit */
macro_line|#ifdef ST_IN_FILE_POS
id|flush_buffer
c_func
(paren
id|inode
comma
id|filp
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|rewind
)paren
id|st_int_ioctl
c_func
(paren
id|inode
comma
id|filp
comma
id|MTREW
comma
l_int|1
)paren
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;in_use
op_assign
l_int|0
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|in_use
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Write command */
DECL|function|st_write
r_int
id|st_write
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
id|dev
suffix:semicolon
r_int
id|total
comma
id|do_count
comma
id|blks
comma
id|retval
suffix:semicolon
r_static
r_int
r_char
id|cmd
(braket
l_int|10
)braket
suffix:semicolon
r_char
op_star
id|b_point
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
id|dev
op_assign
id|inode-&gt;i_rdev
op_amp
l_int|127
suffix:semicolon
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
op_logical_neg
id|scsi_tapes
(braket
id|dev
)braket
dot
id|in_use
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;st%d: Incorrect device.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|write_prot
)paren
r_return
(paren
op_minus
id|EACCES
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|rw
op_eq
l_int|1
)paren
(brace
id|retval
op_assign
id|flush_buffer
c_func
(paren
id|inode
comma
id|filp
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
id|retval
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|rw
op_assign
l_int|2
suffix:semicolon
)brace
macro_line|#if ST_WRITE_THRESHOLD_BLOCKS &lt; ST_BUFFER_BLOCKS
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;writing
)paren
(brace
id|write_behind_check
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;last_result
)paren
(brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st%d: Async write error %x.&bslash;n&quot;
comma
id|dev
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;last_result
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*if (scsi_tapes[dev].buffer-&gt;last_result = 0x7fffffff)&n;&t;  retval = (-ENOSPC);&n;&t;else */
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
)brace
macro_line|#endif
id|SCpnt
op_assign
id|allocate_device
c_func
(paren
l_int|NULL
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|device-&gt;index
comma
l_int|1
)paren
suffix:semicolon
id|total
op_assign
id|count
suffix:semicolon
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
l_int|10
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|WRITE_6
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|rw
op_assign
l_int|2
suffix:semicolon
id|b_point
op_assign
id|buf
suffix:semicolon
r_while
c_loop
(paren
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_bytes
op_plus
id|count
)paren
op_ge
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_size
)paren
(brace
id|do_count
op_assign
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_size
op_minus
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_bytes
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
op_plus
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_bytes
comma
id|b_point
comma
id|do_count
)paren
suffix:semicolon
id|blks
op_assign
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_blocks
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
id|blks
op_rshift
l_int|16
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
id|blks
op_rshift
l_int|8
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|blks
suffix:semicolon
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;request.dev
op_assign
id|dev
suffix:semicolon
id|scsi_do_cmd
(paren
id|SCpnt
comma
(paren
r_void
op_star
)paren
id|cmd
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_size
comma
id|st_sleep_done
comma
id|ST_TIMEOUT
comma
id|MAX_RETRIES
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;request.dev
op_eq
id|dev
)paren
id|sleep_on
c_func
(paren
op_amp
id|scsi_tapes
(braket
id|dev
)braket
dot
id|waiting
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;result
op_logical_or
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_ne
l_int|0
)paren
(brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st%d: Error on write:&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|st_chk_result
c_func
(paren
id|dev
comma
id|SCpnt-&gt;result
comma
id|SCpnt-&gt;sense_buffer
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x70
)paren
op_eq
l_int|0x70
op_logical_and
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x40
)paren
)paren
id|retval
op_assign
(paren
op_minus
id|ENOSPC
)paren
suffix:semicolon
multiline_comment|/* EOM */
r_else
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
id|SCpnt-&gt;request.dev
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Mark as not busy */
r_if
c_cond
(paren
id|count
OL
id|total
)paren
r_return
id|total
op_minus
id|count
suffix:semicolon
r_else
r_return
id|retval
suffix:semicolon
)brace
id|filp-&gt;f_pos
op_add_assign
id|do_count
suffix:semicolon
id|b_point
op_add_assign
id|do_count
suffix:semicolon
id|count
op_sub_assign
id|do_count
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_bytes
op_assign
l_int|0
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|dirty
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
op_ne
l_int|0
)paren
(brace
id|scsi_tapes
(braket
id|dev
)braket
dot
id|dirty
op_assign
l_int|1
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
op_plus
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_bytes
comma
id|b_point
comma
id|count
)paren
suffix:semicolon
id|filp-&gt;f_pos
op_add_assign
id|count
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_bytes
op_add_assign
id|count
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
)brace
id|do_count
op_assign
id|st_chk_result
c_func
(paren
id|dev
comma
id|SCpnt-&gt;result
comma
id|SCpnt-&gt;sense_buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|do_count
)paren
(brace
id|SCpnt-&gt;request.dev
op_assign
op_minus
l_int|1
suffix:semicolon
r_return
id|do_count
suffix:semicolon
)brace
macro_line|#if ST_WRITE_THRESHOLD_BLOCKS &lt; ST_BUFFER_BLOCKS
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_bytes
op_ge
id|ST_WRITE_THRESHOLD
)paren
(brace
multiline_comment|/* Schedule an asynchronous write */
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;writing
op_assign
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_bytes
op_div
id|scsi_tapes
(braket
id|dev
)braket
dot
id|block_size
)paren
op_star
id|scsi_tapes
(braket
id|dev
)braket
dot
id|block_size
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|dirty
op_assign
l_int|0
suffix:semicolon
id|blks
op_assign
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;writing
op_div
id|scsi_tapes
(braket
id|dev
)braket
dot
id|block_size
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
id|blks
op_rshift
l_int|16
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
id|blks
op_rshift
l_int|8
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|blks
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;last_result
op_assign
op_minus
l_int|1
suffix:semicolon
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;request.dev
op_assign
id|dev
suffix:semicolon
id|scsi_do_cmd
(paren
id|SCpnt
comma
(paren
r_void
op_star
)paren
id|cmd
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;writing
comma
id|st_sleep_done
comma
id|ST_TIMEOUT
comma
id|MAX_RETRIES
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif
id|SCpnt-&gt;request.dev
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Mark as not busy */
r_return
id|total
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Read command */
DECL|function|st_read
r_int
id|st_read
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
id|dev
suffix:semicolon
r_int
id|total
suffix:semicolon
r_int
id|transfer
comma
id|blks
suffix:semicolon
r_static
r_int
r_char
id|cmd
(braket
l_int|10
)braket
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
id|dev
op_assign
id|inode-&gt;i_rdev
op_amp
l_int|127
suffix:semicolon
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
op_logical_neg
id|scsi_tapes
(braket
id|dev
)braket
dot
id|in_use
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;st%d: Incorrect device.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|rw
op_eq
l_int|2
)paren
(brace
id|transfer
op_assign
id|flush_buffer
c_func
(paren
id|inode
comma
id|filp
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|transfer
)paren
r_return
id|transfer
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|rw
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|eof
)paren
id|printk
c_func
(paren
l_string|&quot;st%d: EOF flag up. Bytes %d&bslash;n&quot;
comma
id|dev
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_bytes
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_bytes
op_eq
l_int|0
)paren
op_logical_and
id|scsi_tapes
(braket
id|dev
)braket
dot
id|eof
op_eq
l_int|2
)paren
multiline_comment|/* EOM or Blank Check */
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|rw
op_assign
l_int|1
suffix:semicolon
id|SCpnt
op_assign
id|allocate_device
c_func
(paren
l_int|NULL
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|device-&gt;index
comma
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|total
op_assign
l_int|0
suffix:semicolon
id|total
OL
id|count
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_bytes
op_eq
l_int|0
op_logical_and
id|scsi_tapes
(braket
id|dev
)braket
dot
id|eof
op_eq
l_int|0
)paren
(brace
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
l_int|10
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|READ_6
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
id|blks
op_assign
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_blocks
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
id|blks
op_rshift
l_int|16
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
id|blks
op_rshift
l_int|8
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|blks
suffix:semicolon
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;request.dev
op_assign
id|dev
suffix:semicolon
id|scsi_do_cmd
(paren
id|SCpnt
comma
(paren
r_void
op_star
)paren
id|cmd
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_size
comma
id|st_sleep_done
comma
id|ST_TIMEOUT
comma
id|MAX_RETRIES
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;request.dev
op_eq
id|dev
)paren
id|sleep_on
c_func
(paren
op_amp
id|scsi_tapes
(braket
id|dev
)braket
dot
id|waiting
)paren
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;read_pointer
op_assign
l_int|0
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|eof_hit
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;result
op_ne
l_int|0
op_logical_or
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_ne
l_int|0
)paren
(brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st%d: Sense: %2x %2x %2x %2x %2x %2x %2x %2x&bslash;n&quot;
comma
id|dev
comma
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
comma
id|SCpnt-&gt;sense_buffer
(braket
l_int|1
)braket
comma
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
comma
id|SCpnt-&gt;sense_buffer
(braket
l_int|3
)braket
comma
id|SCpnt-&gt;sense_buffer
(braket
l_int|4
)braket
comma
id|SCpnt-&gt;sense_buffer
(braket
l_int|5
)braket
comma
id|SCpnt-&gt;sense_buffer
(braket
l_int|6
)braket
comma
id|SCpnt-&gt;sense_buffer
(braket
l_int|7
)braket
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x70
)paren
op_eq
l_int|0x70
)paren
(brace
multiline_comment|/* extended sense */
r_if
c_cond
(paren
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0xe0
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* EOF, EOM, or ILI */
id|transfer
op_assign
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|3
)braket
op_lshift
l_int|24
)paren
op_or
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|4
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|5
)braket
op_lshift
l_int|8
)paren
op_or
id|SCpnt-&gt;sense_buffer
(braket
l_int|6
)braket
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x20
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;st%d: Incorrect block size.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|SCpnt-&gt;request.dev
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Mark as not busy */
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x40
)paren
(brace
id|scsi_tapes
(braket
id|dev
)braket
dot
id|eof
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* What should be done at EOM ? */
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_bytes
op_assign
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_blocks
op_minus
id|transfer
)paren
op_star
id|scsi_tapes
(braket
id|dev
)braket
dot
id|block_size
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st%d: EOM detected (%d blocks read).&bslash;n&quot;
comma
id|dev
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_blocks
op_minus
id|transfer
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
r_if
c_cond
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x80
)paren
(brace
id|scsi_tapes
(braket
id|dev
)braket
dot
id|eof
op_assign
l_int|1
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_bytes
op_assign
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_blocks
op_minus
id|transfer
)paren
op_star
id|scsi_tapes
(braket
id|dev
)braket
dot
id|block_size
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st%d: EOF detected (%d blocks read, transferred %d bytes).&bslash;n&quot;
comma
id|dev
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_blocks
op_minus
id|transfer
comma
id|total
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* end of EOF, EOM, ILI test */
)brace
r_else
(brace
multiline_comment|/* nonzero sense key */
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st%d: Tape error. Sense key %x&bslash;n&quot;
comma
id|dev
comma
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
suffix:semicolon
id|decode_sns
c_func
(paren
id|dev
comma
id|SCpnt-&gt;sense_buffer
)paren
suffix:semicolon
macro_line|#endif
id|SCpnt-&gt;request.dev
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|total
)paren
r_return
id|total
suffix:semicolon
r_else
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
r_else
(brace
id|transfer
op_assign
id|st_chk_result
c_func
(paren
id|dev
comma
id|SCpnt-&gt;result
comma
id|SCpnt-&gt;sense_buffer
)paren
suffix:semicolon
id|SCpnt-&gt;request.dev
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Mark as not busy */
r_return
id|transfer
suffix:semicolon
)brace
)brace
r_else
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_bytes
op_assign
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_size
suffix:semicolon
)brace
multiline_comment|/* if (scsi_tapes[dev].buffer-&gt;buffer_bytes == 0 &amp;&amp;&n;&t;   scsi_tapes[dev].eof == 0) */
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_bytes
OG
l_int|0
)paren
(brace
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|eof
)paren
id|printk
c_func
(paren
l_string|&quot;st%d: EOF up. Left %d, needed %d.&bslash;n&quot;
comma
id|dev
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_bytes
comma
id|count
op_minus
id|total
)paren
suffix:semicolon
macro_line|#endif
id|transfer
op_assign
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_bytes
OL
id|count
op_minus
id|total
ques
c_cond
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_bytes
suffix:colon
id|count
op_minus
id|total
suffix:semicolon
id|memcpy_tofs
c_func
(paren
id|buf
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
op_plus
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;read_pointer
comma
id|transfer
)paren
suffix:semicolon
id|filp-&gt;f_pos
op_add_assign
id|transfer
suffix:semicolon
id|buf
op_add_assign
id|transfer
suffix:semicolon
id|total
op_add_assign
id|transfer
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_bytes
op_sub_assign
id|transfer
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;read_pointer
op_add_assign
id|transfer
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|eof
)paren
(brace
id|scsi_tapes
(braket
id|dev
)braket
dot
id|eof_hit
op_assign
l_int|1
suffix:semicolon
id|SCpnt-&gt;request.dev
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Mark as not busy */
r_if
c_cond
(paren
id|total
op_eq
l_int|0
op_logical_and
id|scsi_tapes
(braket
id|dev
)braket
dot
id|eof
op_eq
l_int|1
)paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|eof
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|total
op_eq
l_int|0
op_logical_and
id|scsi_tapes
(braket
id|dev
)braket
dot
id|eof
op_eq
l_int|2
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_return
id|total
suffix:semicolon
)brace
)brace
multiline_comment|/* for (total = 0; total &lt; count; ) */
id|SCpnt-&gt;request.dev
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Mark as not busy */
r_return
id|total
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Internal ioctl function */
DECL|function|st_int_ioctl
r_static
r_int
id|st_int_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd_in
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|dev
op_assign
id|inode-&gt;i_rdev
suffix:semicolon
r_int
id|timeout
op_assign
id|ST_LONG_TIMEOUT
suffix:semicolon
r_int
id|ltmp
suffix:semicolon
r_int
id|ioctl_result
suffix:semicolon
r_int
r_char
id|cmd
(braket
l_int|10
)braket
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
id|dev
op_assign
id|dev
op_amp
l_int|127
suffix:semicolon
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
l_int|10
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd_in
)paren
(brace
r_case
id|MTFSF
suffix:colon
r_case
id|MTFSFM
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|SPACE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* Space FileMarks */
id|cmd
(braket
l_int|2
)braket
op_assign
(paren
id|arg
op_rshift
l_int|16
)paren
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
(paren
id|arg
op_rshift
l_int|8
)paren
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|arg
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st%d: Spacing tape forward %d files.&bslash;n&quot;
comma
id|dev
comma
id|cmd
(braket
l_int|2
)braket
op_star
l_int|65536
op_plus
id|cmd
(braket
l_int|3
)braket
op_star
l_int|256
op_plus
id|cmd
(braket
l_int|4
)braket
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|MTBSF
suffix:colon
r_case
id|MTBSFM
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|SPACE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* Space FileMarks */
id|ltmp
op_assign
(paren
op_minus
id|arg
)paren
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
(paren
id|ltmp
op_rshift
l_int|16
)paren
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
(paren
id|ltmp
op_rshift
l_int|8
)paren
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|ltmp
suffix:semicolon
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
id|cmd
(braket
l_int|2
)braket
op_amp
l_int|0x80
)paren
id|ltmp
op_assign
l_int|0xff000000
suffix:semicolon
id|ltmp
op_assign
id|ltmp
op_or
(paren
id|cmd
(braket
l_int|2
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|cmd
(braket
l_int|3
)braket
op_lshift
l_int|8
)paren
op_or
id|cmd
(braket
l_int|4
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;st%d: Spacing tape backward %d files.&bslash;n&quot;
comma
id|dev
comma
(paren
op_minus
id|ltmp
)paren
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|MTFSR
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|SPACE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Space Blocks */
id|cmd
(braket
l_int|2
)braket
op_assign
(paren
id|arg
op_rshift
l_int|16
)paren
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
(paren
id|arg
op_rshift
l_int|8
)paren
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|arg
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st%d: Spacing tape forward %d blocks.&bslash;n&quot;
comma
id|dev
comma
id|cmd
(braket
l_int|2
)braket
op_star
l_int|65536
op_plus
id|cmd
(braket
l_int|3
)braket
op_star
l_int|256
op_plus
id|cmd
(braket
l_int|4
)braket
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|MTBSR
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|SPACE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Space Blocks */
id|ltmp
op_assign
(paren
op_minus
id|arg
)paren
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
(paren
id|ltmp
op_rshift
l_int|16
)paren
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
(paren
id|ltmp
op_rshift
l_int|8
)paren
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|ltmp
suffix:semicolon
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
id|cmd
(braket
l_int|2
)braket
op_amp
l_int|0x80
)paren
id|ltmp
op_assign
l_int|0xff000000
suffix:semicolon
id|ltmp
op_assign
id|ltmp
op_or
(paren
id|cmd
(braket
l_int|2
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|cmd
(braket
l_int|3
)braket
op_lshift
l_int|8
)paren
op_or
id|cmd
(braket
l_int|4
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;st%d: Spacing tape backward %d blocks.&bslash;n&quot;
comma
id|dev
comma
(paren
op_minus
id|ltmp
)paren
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|MTWEOF
suffix:colon
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|write_prot
)paren
r_return
(paren
op_minus
id|EACCES
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|WRITE_FILEMARKS
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
(paren
id|arg
op_rshift
l_int|16
)paren
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
(paren
id|arg
op_rshift
l_int|8
)paren
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|arg
suffix:semicolon
id|timeout
op_assign
id|ST_TIMEOUT
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st%d: Writing %d filemarks.&bslash;n&quot;
comma
id|dev
comma
id|cmd
(braket
l_int|2
)braket
op_star
l_int|65536
op_plus
id|cmd
(braket
l_int|3
)braket
op_star
l_int|256
op_plus
id|cmd
(braket
l_int|4
)braket
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|MTREW
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|REZERO_UNIT
suffix:semicolon
macro_line|#ifdef ST_NOWAIT
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Don&squot;t wait for completion */
id|timeout
op_assign
id|ST_TIMEOUT
suffix:semicolon
macro_line|#endif
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st%d: Rewinding tape.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|MTOFFL
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|START_STOP
suffix:semicolon
macro_line|#ifdef ST_NOWAIT
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Don&squot;t wait for completion */
id|timeout
op_assign
id|ST_TIMEOUT
suffix:semicolon
macro_line|#endif
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st%d: Unloading tape.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|MTNOP
suffix:colon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st%d: No op on tape.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Should do something ? */
r_break
suffix:semicolon
r_case
id|MTRETEN
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|START_STOP
suffix:semicolon
macro_line|#ifdef ST_NOWAIT
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Don&squot;t wait for completion */
id|timeout
op_assign
id|ST_TIMEOUT
suffix:semicolon
macro_line|#endif
id|cmd
(braket
l_int|4
)braket
op_assign
l_int|3
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st%d: Retensioning tape.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|MTEOM
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|SPACE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|3
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st%d: Spacing to end of recorded medium.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|MTERASE
suffix:colon
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|write_prot
)paren
r_return
(paren
op_minus
id|EACCES
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|ERASE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* To the end of tape */
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st%d: Erasing tape.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|MTSEEK
suffix:colon
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|device-&gt;scsi_level
OL
id|SCSI_2
)paren
(brace
id|cmd
(braket
l_int|0
)braket
op_assign
id|QFA_SEEK_BLOCK
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
(paren
id|arg
op_rshift
l_int|16
)paren
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
(paren
id|arg
op_rshift
l_int|8
)paren
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|arg
suffix:semicolon
id|cmd
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|cmd
(braket
l_int|0
)braket
op_assign
id|SEEK_10
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|4
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
(paren
id|arg
op_rshift
l_int|24
)paren
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
(paren
id|arg
op_rshift
l_int|16
)paren
suffix:semicolon
id|cmd
(braket
l_int|5
)braket
op_assign
(paren
id|arg
op_rshift
l_int|8
)paren
suffix:semicolon
id|cmd
(braket
l_int|6
)braket
op_assign
id|arg
suffix:semicolon
)brace
macro_line|#ifdef ST_NOWAIT
id|cmd
(braket
l_int|1
)braket
op_or_assign
l_int|1
suffix:semicolon
multiline_comment|/* Don&squot;t wait for completion */
id|timeout
op_assign
id|ST_TIMEOUT
suffix:semicolon
macro_line|#endif
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st%d: Seeking tape to block %d.&bslash;n&quot;
comma
id|dev
comma
id|arg
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|MTSETBLK
suffix:colon
multiline_comment|/* Set block length */
r_case
id|MTSETDENSITY
suffix:colon
multiline_comment|/* Set tape density */
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|dirty
op_logical_or
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_bytes
op_ne
l_int|0
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
multiline_comment|/* Not allowed if data in buffer */
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTSETBLK
op_logical_and
(paren
id|arg
template_param
id|scsi_tapes
(braket
id|dev
)braket
dot
id|max_block
op_logical_or
id|arg
OG
id|ST_BUFFER_SIZE
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;st%d: Illegal block size.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
id|cmd
(braket
l_int|0
)braket
op_assign
id|MODE_SELECT
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
l_int|12
suffix:semicolon
id|memset
c_func
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
comma
l_int|0
comma
l_int|12
)paren
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|2
)braket
op_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* buffered mode */
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|3
)braket
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* block descriptor length */
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTSETBLK
)paren
id|ltmp
op_assign
id|arg
suffix:semicolon
r_else
(brace
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|4
)braket
op_assign
id|arg
suffix:semicolon
id|ltmp
op_assign
id|scsi_tapes
(braket
id|dev
)braket
dot
id|block_size
suffix:semicolon
)brace
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|9
)braket
op_assign
(paren
id|ltmp
op_rshift
l_int|16
)paren
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|10
)braket
op_assign
(paren
id|ltmp
op_rshift
l_int|8
)paren
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|11
)braket
op_assign
id|ltmp
suffix:semicolon
id|timeout
op_assign
id|ST_TIMEOUT
suffix:semicolon
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTSETBLK
)paren
id|printk
c_func
(paren
l_string|&quot;st%d: Setting block size to %d bytes.&bslash;n&quot;
comma
id|dev
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|9
)braket
op_star
l_int|65536
op_plus
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|10
)braket
op_star
l_int|256
op_plus
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|11
)braket
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;st%d: Setting density code to %x.&bslash;n&quot;
comma
id|dev
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|4
)braket
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;st%d: Unknown st_ioctl command %x.&bslash;n&quot;
comma
id|dev
comma
id|cmd_in
)paren
suffix:semicolon
r_return
(paren
op_minus
id|ENOSYS
)paren
suffix:semicolon
)brace
id|SCpnt
op_assign
id|allocate_device
c_func
(paren
l_int|NULL
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|device-&gt;index
comma
l_int|1
)paren
suffix:semicolon
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;request.dev
op_assign
id|dev
suffix:semicolon
id|scsi_do_cmd
c_func
(paren
id|SCpnt
comma
(paren
r_void
op_star
)paren
id|cmd
comma
(paren
r_void
op_star
)paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
comma
id|ST_BLOCK_SIZE
comma
id|st_sleep_done
comma
id|timeout
comma
id|MAX_RETRIES
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;request.dev
op_eq
id|dev
)paren
id|sleep_on
c_func
(paren
op_amp
id|scsi_tapes
(braket
id|dev
)braket
dot
id|waiting
)paren
suffix:semicolon
id|SCpnt-&gt;request.dev
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Mark as not busy */
id|ioctl_result
op_assign
id|st_chk_result
c_func
(paren
id|dev
comma
id|SCpnt-&gt;result
comma
id|SCpnt-&gt;sense_buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ioctl_result
)paren
(brace
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTBSFM
)paren
id|ioctl_result
op_assign
id|st_int_ioctl
c_func
(paren
id|inode
comma
id|file
comma
id|MTFSF
comma
l_int|1
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTFSFM
)paren
id|ioctl_result
op_assign
id|st_int_ioctl
c_func
(paren
id|inode
comma
id|file
comma
id|MTBSF
comma
l_int|1
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTSETBLK
)paren
(brace
id|scsi_tapes
(braket
id|dev
)braket
dot
id|block_size
op_assign
id|arg
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_blocks
op_assign
id|ST_BUFFER_SIZE
op_div
id|scsi_tapes
(braket
id|dev
)braket
dot
id|block_size
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_size
op_assign
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_blocks
op_star
id|scsi_tapes
(braket
id|dev
)braket
dot
id|block_size
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;buffer_bytes
op_assign
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;read_pointer
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTEOM
op_logical_or
id|cmd_in
op_eq
id|MTWEOF
)paren
(brace
id|scsi_tapes
(braket
id|dev
)braket
dot
id|eof
op_assign
l_int|2
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|eof_hit
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd_in
op_ne
id|MTSETBLK
op_logical_and
id|cmd_in
op_ne
id|MTNOP
)paren
(brace
id|scsi_tapes
(braket
id|dev
)braket
dot
id|eof
op_assign
l_int|0
suffix:semicolon
id|scsi_tapes
(braket
id|dev
)braket
dot
id|eof_hit
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_return
id|ioctl_result
suffix:semicolon
)brace
"&f;"
multiline_comment|/* The ioctl command */
DECL|function|st_ioctl
r_static
r_int
id|st_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd_in
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|dev
op_assign
id|inode-&gt;i_rdev
suffix:semicolon
r_int
id|i
comma
id|cmd
comma
id|result
suffix:semicolon
r_struct
id|mtop
id|mtc
suffix:semicolon
r_struct
id|mtpos
id|mt_pos
suffix:semicolon
r_int
r_char
id|scmd
(braket
l_int|10
)braket
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
id|dev
op_assign
id|dev
op_amp
l_int|127
suffix:semicolon
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
op_logical_neg
id|scsi_tapes
(braket
id|dev
)braket
dot
id|in_use
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;st%d: Incorrect device.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
macro_line|#endif
id|cmd
op_assign
id|cmd_in
op_amp
id|IOCCMD_MASK
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
(paren
id|MTIOCTOP
op_amp
id|IOCCMD_MASK
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|cmd_in
op_amp
id|IOCSIZE_MASK
)paren
op_rshift
id|IOCSIZE_SHIFT
)paren
op_ne
r_sizeof
(paren
id|mtc
)paren
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|mtc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|mtc
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|mtop
)paren
)paren
suffix:semicolon
id|i
op_assign
id|flush_buffer
c_func
(paren
id|inode
comma
id|file
comma
id|mtc.mt_op
op_eq
id|MTSEEK
op_logical_or
id|mtc.mt_op
op_eq
id|MTREW
op_logical_or
id|mtc.mt_op
op_eq
id|MTOFFL
op_logical_or
id|mtc.mt_op
op_eq
id|MTRETEN
op_logical_or
id|mtc.mt_op
op_eq
id|MTEOM
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
id|i
suffix:semicolon
r_return
id|st_int_ioctl
c_func
(paren
id|inode
comma
id|file
comma
id|mtc.mt_op
comma
id|mtc.mt_count
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd
op_eq
(paren
id|MTIOCGET
op_amp
id|IOCCMD_MASK
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|cmd_in
op_amp
id|IOCSIZE_MASK
)paren
op_rshift
id|IOCSIZE_SHIFT
)paren
op_ne
r_sizeof
(paren
r_struct
id|mtget
)paren
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|mtget
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|memcpy_tofs
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
(paren
r_char
op_star
)paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;mt_status
comma
r_sizeof
(paren
r_struct
id|mtget
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd
op_eq
(paren
id|MTIOCPOS
op_amp
id|IOCCMD_MASK
)paren
)paren
(brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st%d: get tape position.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
(paren
id|cmd_in
op_amp
id|IOCSIZE_MASK
)paren
op_rshift
id|IOCSIZE_SHIFT
)paren
op_ne
r_sizeof
(paren
r_struct
id|mtpos
)paren
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|i
op_assign
id|flush_buffer
c_func
(paren
id|inode
comma
id|file
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
id|i
suffix:semicolon
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|mtpos
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|SCpnt
op_assign
id|allocate_device
c_func
(paren
l_int|NULL
comma
id|scsi_tapes
(braket
id|dev
)braket
dot
id|device-&gt;index
comma
l_int|1
)paren
suffix:semicolon
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|memset
(paren
id|scmd
comma
l_int|0
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|device-&gt;scsi_level
OL
id|SCSI_2
)paren
(brace
id|scmd
(braket
l_int|0
)braket
op_assign
id|QFA_REQUEST_BLOCK
suffix:semicolon
id|scmd
(braket
l_int|4
)braket
op_assign
l_int|3
suffix:semicolon
)brace
r_else
(brace
id|scmd
(braket
l_int|0
)braket
op_assign
id|READ_POSITION
suffix:semicolon
id|scmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
)brace
id|SCpnt-&gt;request.dev
op_assign
id|dev
suffix:semicolon
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|scsi_do_cmd
c_func
(paren
id|SCpnt
comma
(paren
r_void
op_star
)paren
id|scmd
comma
(paren
r_void
op_star
)paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
comma
id|ST_BLOCK_SIZE
comma
id|st_sleep_done
comma
id|ST_TIMEOUT
comma
id|MAX_RETRIES
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;request.dev
op_eq
id|dev
)paren
id|sleep_on
c_func
(paren
op_amp
id|scsi_tapes
(braket
id|dev
)braket
dot
id|waiting
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;result
op_logical_or
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
)paren
(brace
id|mt_pos.mt_blkno
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st%d: Can&squot;t read tape position.&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|result
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_else
(brace
id|result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|device-&gt;scsi_level
OL
id|SCSI_2
)paren
id|mt_pos.mt_blkno
op_assign
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|0
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_plus
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|2
)braket
suffix:semicolon
r_else
id|mt_pos.mt_blkno
op_assign
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|4
)braket
op_lshift
l_int|24
)paren
op_plus
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|5
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|6
)braket
op_lshift
l_int|8
)paren
op_plus
id|scsi_tapes
(braket
id|dev
)braket
dot
id|buffer-&gt;b_data
(braket
l_int|7
)braket
suffix:semicolon
)brace
id|SCpnt-&gt;request.dev
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Mark as not busy */
id|memcpy_tofs
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
(paren
r_char
op_star
)paren
(paren
op_amp
id|mt_pos
)paren
comma
r_sizeof
(paren
r_struct
id|mtpos
)paren
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_else
r_return
id|scsi_ioctl
c_func
(paren
id|scsi_tapes
(braket
id|dev
)braket
dot
id|device
comma
id|cmd_in
comma
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
"&f;"
DECL|variable|st_fops
r_static
r_struct
id|file_operations
id|st_fops
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* lseek - default */
id|st_read
comma
multiline_comment|/* read - general block-dev read */
id|st_write
comma
multiline_comment|/* write - general block-dev write */
l_int|NULL
comma
multiline_comment|/* readdir - bad */
l_int|NULL
comma
multiline_comment|/* select */
id|st_ioctl
comma
multiline_comment|/* ioctl */
l_int|NULL
comma
multiline_comment|/* mmap */
id|scsi_tape_open
comma
multiline_comment|/* open */
id|scsi_tape_close
multiline_comment|/* release */
)brace
suffix:semicolon
DECL|function|st_attach
r_void
(def_block
id|st_attach
c_func
(paren
id|Scsi_Device
op_star
id|SDp
)paren
(brace
id|scsi_tapes
(braket
id|NR_ST
op_increment
)braket
dot
id|device
op_assign
id|SDp
suffix:semicolon
r_if
c_cond
(paren
id|NR_ST
OG
id|MAX_ST
)paren
(brace
id|panic
(paren
l_string|&quot;scsi_devices corrupt (st)&quot;
)paren
suffix:semicolon
)brace
)brace
)def_block
suffix:semicolon
DECL|function|st_init1
r_int
r_int
(def_block
id|st_init1
c_func
(paren
r_int
r_int
id|mem_start
comma
r_int
r_int
id|mem_end
)paren
(brace
id|scsi_tapes
op_assign
(paren
id|Scsi_Tape
op_star
)paren
id|mem_start
suffix:semicolon
id|mem_start
op_add_assign
id|MAX_ST
op_star
r_sizeof
(paren
id|Scsi_Tape
)paren
suffix:semicolon
r_return
id|mem_start
suffix:semicolon
)brace
)def_block
suffix:semicolon
multiline_comment|/* Driver initialization */
DECL|function|st_init
r_int
r_int
id|st_init
c_func
(paren
r_int
r_int
id|mem_start
comma
r_int
r_int
id|mem_end
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|register_chrdev
c_func
(paren
id|MAJOR_NR
comma
l_string|&quot;st&quot;
comma
op_amp
id|st_fops
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Unable to get major %d for SCSI tapes&bslash;n&quot;
comma
id|MAJOR_NR
)paren
suffix:semicolon
r_return
id|mem_start
suffix:semicolon
)brace
r_if
c_cond
(paren
id|NR_ST
op_eq
l_int|0
)paren
r_return
id|mem_start
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st: Init tape.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_ST
suffix:semicolon
op_increment
id|i
)paren
(brace
id|scsi_tapes
(braket
id|i
)braket
dot
id|capacity
op_assign
l_int|0xfffff
suffix:semicolon
id|scsi_tapes
(braket
id|i
)braket
dot
id|dirty
op_assign
l_int|0
suffix:semicolon
id|scsi_tapes
(braket
id|i
)braket
dot
id|rw
op_assign
l_int|0
suffix:semicolon
id|scsi_tapes
(braket
id|i
)braket
dot
id|eof
op_assign
l_int|0
suffix:semicolon
id|scsi_tapes
(braket
id|i
)braket
dot
id|waiting
op_assign
l_int|NULL
suffix:semicolon
id|scsi_tapes
(braket
id|i
)braket
dot
id|in_use
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Allocate the buffers */
r_if
c_cond
(paren
id|NR_ST
op_eq
l_int|1
)paren
id|st_nbr_buffers
op_assign
l_int|1
suffix:semicolon
r_else
id|st_nbr_buffers
op_assign
l_int|2
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|st_nbr_buffers
suffix:semicolon
id|i
op_increment
)paren
(brace
id|st_buffers
(braket
id|i
)braket
op_assign
(paren
id|ST_buffer
op_star
)paren
id|mem_start
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;st: Buffer address: %x&bslash;n&quot;
comma
id|st_buffers
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#endif
id|mem_start
op_add_assign
r_sizeof
(paren
id|ST_buffer
)paren
op_minus
l_int|1
op_plus
id|ST_BUFFER_BLOCKS
op_star
id|ST_BLOCK_SIZE
suffix:semicolon
id|st_buffers
(braket
id|i
)braket
op_member_access_from_pointer
id|mt_status
op_assign
(paren
r_struct
id|mtget
op_star
)paren
id|mem_start
suffix:semicolon
id|mem_start
op_add_assign
r_sizeof
(paren
r_struct
id|mtget
)paren
suffix:semicolon
id|st_buffers
(braket
id|i
)braket
op_member_access_from_pointer
id|in_use
op_assign
l_int|0
suffix:semicolon
id|st_buffers
(braket
id|i
)braket
op_member_access_from_pointer
id|writing
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* &quot;generic&quot; status */
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|st_buffers
(braket
id|i
)braket
op_member_access_from_pointer
id|mt_status
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|mtget
)paren
)paren
suffix:semicolon
id|st_buffers
(braket
id|i
)braket
op_member_access_from_pointer
id|mt_status-&gt;mt_type
op_assign
id|MT_ISSCSI1
suffix:semicolon
)brace
r_return
id|mem_start
suffix:semicolon
)brace
eof
