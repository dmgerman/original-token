multiline_comment|/* $Id: aha1740.c,v 1.1 1992/07/24 06:27:38 root Exp root $&n; *  linux/kernel/aha1740.c&n; *&n; *  Based loosely on aha1542.c which is&n; *  Copyright (C) 1992  Tommy Thorn&n; *  and&n; *  Modified by Eric Youngdale&n; *&n; *  This file is aha1740.c, written and&n; *  Copyright (C) 1992  Brad McLean&n; *  &n; * aha1740_makecode needs more work&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/head.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;../blk.h&quot;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;aha1740.h&quot;
multiline_comment|/* #define DEBUG */
macro_line|#ifdef DEBUG
DECL|macro|DEB
mdefine_line|#define DEB(x) x
macro_line|#else
DECL|macro|DEB
mdefine_line|#define DEB(x)
macro_line|#endif
multiline_comment|/*&n;static const char RCSid[] = &quot;$Header: /usr/src/linux/kernel/blk_drv/scsi/RCS/aha1740.c,v 1.1 1992/07/24 06:27:38 root Exp root $&quot;;&n;*/
DECL|variable|slot
DECL|variable|base
r_static
r_int
r_int
id|slot
comma
id|base
suffix:semicolon
DECL|variable|irq_level
r_static
r_int
r_char
id|irq_level
suffix:semicolon
DECL|variable|ecb
r_static
r_struct
id|ecb
id|ecb
(braket
id|AHA1740_ECBS
)braket
suffix:semicolon
multiline_comment|/* One for each queued operation */
DECL|variable|aha1740_last_ecb_used
r_static
r_int
id|aha1740_last_ecb_used
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* optimization */
DECL|function|aha1740_makecode
r_int
id|aha1740_makecode
c_func
(paren
id|unchar
op_star
id|sense
comma
id|unchar
op_star
id|status
)paren
(brace
r_struct
id|statusword
(brace
id|ushort
id|don
suffix:colon
l_int|1
comma
multiline_comment|/* Command Done - No Error */
id|du
suffix:colon
l_int|1
comma
multiline_comment|/* Data underrun */
suffix:colon
l_int|1
comma
id|qf
suffix:colon
l_int|1
comma
multiline_comment|/* Queue full */
id|sc
suffix:colon
l_int|1
comma
multiline_comment|/* Specification Check */
id|dor
suffix:colon
l_int|1
comma
multiline_comment|/* Data overrun */
id|ch
suffix:colon
l_int|1
comma
multiline_comment|/* Chaining Halted */
id|intr
suffix:colon
l_int|1
comma
multiline_comment|/* Interrupt issued */
id|asa
suffix:colon
l_int|1
comma
multiline_comment|/* Additional Status Available */
id|sns
suffix:colon
l_int|1
comma
multiline_comment|/* Sense information Stored */
suffix:colon
l_int|1
comma
id|ini
suffix:colon
l_int|1
comma
multiline_comment|/* Initialization Required */
id|me
suffix:colon
l_int|1
comma
multiline_comment|/* Major error or exception */
suffix:colon
l_int|1
comma
id|eca
suffix:colon
l_int|1
comma
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Extended Contingent alliance */
)brace
id|status_word
suffix:semicolon
r_int
id|retval
op_assign
id|DID_OK
suffix:semicolon
id|status_word
op_assign
op_star
(paren
r_struct
id|statusword
op_star
)paren
id|status
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;makecode from %x,%x,%x,%x %x,%x,%x,%x&quot;
comma
id|status
(braket
l_int|0
)braket
comma
id|status
(braket
l_int|1
)braket
comma
id|status
(braket
l_int|2
)braket
comma
id|status
(braket
l_int|3
)braket
comma
id|sense
(braket
l_int|0
)braket
comma
id|sense
(braket
l_int|1
)braket
comma
id|sense
(braket
l_int|2
)braket
comma
id|sense
(braket
l_int|3
)braket
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|status_word.don
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;    if ( status_word.du &amp;&amp; status[2] != 0x11 )&n;&t;return 0;&n;*/
r_if
c_cond
(paren
id|status
(braket
l_int|2
)braket
op_eq
l_int|0x11
)paren
id|retval
op_assign
id|DID_TIME_OUT
suffix:semicolon
r_else
id|retval
op_assign
id|DID_ERROR
suffix:semicolon
r_return
id|status
(braket
l_int|3
)braket
op_or
id|retval
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/* OKAY, SO I&squot;M LAZY! I&squot;ll fix it later... */
)brace
DECL|function|aha1740_test_port
r_int
id|aha1740_test_port
c_func
(paren
)paren
(brace
r_char
id|name
(braket
l_int|4
)braket
comma
id|tmp
suffix:semicolon
multiline_comment|/* Okay, look for the EISA ID&squot;s */
id|name
(braket
l_int|0
)braket
op_assign
l_char|&squot;A&squot;
op_minus
l_int|1
op_plus
(paren
(paren
id|tmp
op_assign
id|inb
c_func
(paren
id|HID0
)paren
)paren
op_rshift
l_int|2
)paren
suffix:semicolon
multiline_comment|/* First character */
id|name
(braket
l_int|1
)braket
op_assign
l_char|&squot;A&squot;
op_minus
l_int|1
op_plus
(paren
(paren
id|tmp
op_amp
l_int|3
)paren
op_lshift
l_int|3
)paren
suffix:semicolon
id|name
(braket
l_int|1
)braket
op_add_assign
(paren
(paren
id|tmp
op_assign
id|inb
c_func
(paren
id|HID1
)paren
)paren
op_rshift
l_int|5
)paren
op_amp
l_int|0x7
suffix:semicolon
multiline_comment|/* Second Character */
id|name
(braket
l_int|2
)braket
op_assign
l_char|&squot;A&squot;
op_minus
l_int|1
op_plus
(paren
id|tmp
op_amp
l_int|0x1f
)paren
suffix:semicolon
multiline_comment|/* Third Character */
id|name
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|tmp
op_assign
id|inb
c_func
(paren
id|HID2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
(paren
id|name
comma
id|HID_MFG
)paren
op_logical_or
id|inb
c_func
(paren
id|HID2
)paren
op_ne
id|HID_PRD
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Not an Adaptec 174x */
multiline_comment|/*    if ( inb(HID3) &lt; HID_REV ) */
r_if
c_cond
(paren
id|inb
c_func
(paren
id|HID3
)paren
op_ne
id|HID_REV
)paren
id|printk
c_func
(paren
l_string|&quot;aha1740: Warning; board revision of %d; expected %d&bslash;n&quot;
comma
id|inb
c_func
(paren
id|HID3
)paren
comma
id|HID_REV
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|EBCNTRL
)paren
op_ne
id|EBCNTRL_VALUE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;aha1740: Board detected, but EBCNTRL = %x, so disabled it.&bslash;n&quot;
comma
id|inb
c_func
(paren
id|EBCNTRL
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inb
c_func
(paren
id|PORTADR
)paren
op_amp
id|PORTADDR_ENH
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* Okay, we&squot;re all set */
id|printk
c_func
(paren
l_string|&quot;aha1740: Board detected, but not in enhanced mode, so disabled it.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* What&squot;s this little function for? */
DECL|function|aha1740_info
r_const
r_char
op_star
id|aha1740_info
c_func
(paren
r_void
)paren
(brace
r_static
r_char
id|buffer
(braket
)braket
op_assign
l_string|&quot;&quot;
suffix:semicolon
multiline_comment|/* looks nicer without anything here */
r_return
id|buffer
suffix:semicolon
)brace
multiline_comment|/* A &quot;high&quot; level interrupt handler */
DECL|function|aha1740_intr_handle
r_void
id|aha1740_intr_handle
c_func
(paren
r_int
id|foo
)paren
(brace
r_void
(paren
op_star
id|my_done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
r_int
id|errstatus
comma
id|adapstat
suffix:semicolon
r_int
id|number_serviced
suffix:semicolon
r_struct
id|ecb
op_star
id|ecbptr
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCtmp
suffix:semicolon
id|number_serviced
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|G2STAT
)paren
op_amp
id|G2STAT_INTPEND
)paren
(brace
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;aha1740_intr top of loop.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|adapstat
op_assign
id|inb
c_func
(paren
id|G2INTST
)paren
suffix:semicolon
id|outb
c_func
(paren
id|G2CNTRL_IRST
comma
id|G2CNTRL
)paren
suffix:semicolon
multiline_comment|/* interrupt reset */
r_switch
c_cond
(paren
id|adapstat
op_amp
id|G2INTST_MASK
)paren
(brace
r_case
id|G2INTST_CCBRETRY
suffix:colon
id|printk
c_func
(paren
l_string|&quot;aha1740 complete with retry!&bslash;n&quot;
)paren
suffix:semicolon
r_case
id|G2INTST_CCBERROR
suffix:colon
r_case
id|G2INTST_CCBGOOD
suffix:colon
id|ecbptr
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
(paren
id|ulong
)paren
id|inb
c_func
(paren
id|MBOXIN0
)paren
)paren
op_plus
(paren
(paren
id|ulong
)paren
id|inb
c_func
(paren
id|MBOXIN1
)paren
op_lshift
l_int|8
)paren
op_plus
(paren
(paren
id|ulong
)paren
id|inb
c_func
(paren
id|MBOXIN2
)paren
op_lshift
l_int|16
)paren
op_plus
(paren
(paren
id|ulong
)paren
id|inb
c_func
(paren
id|MBOXIN3
)paren
op_lshift
l_int|24
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|G2CNTRL_HRDY
comma
id|G2CNTRL
)paren
suffix:semicolon
multiline_comment|/* Host Ready -&gt; Mailbox in complete */
id|SCtmp
op_assign
id|ecbptr-&gt;SCpnt
suffix:semicolon
r_if
c_cond
(paren
id|SCtmp-&gt;host_scribble
)paren
id|scsi_free
c_func
(paren
id|SCtmp-&gt;host_scribble
comma
l_int|512
)paren
suffix:semicolon
multiline_comment|/* Fetch the sense data, and tuck it away, in the required slot.  The&n;&t;     Adaptec automatically fetches it, and there is no guarantee that&n;&t;     we will still have it in the cdb when we come back */
r_if
c_cond
(paren
(paren
id|adapstat
op_amp
id|G2INTST_MASK
)paren
op_eq
id|G2INTST_CCBERROR
)paren
(brace
id|memcpy
c_func
(paren
id|SCtmp-&gt;sense_buffer
comma
id|ecbptr-&gt;sense
comma
r_sizeof
(paren
id|SCtmp-&gt;sense_buffer
)paren
)paren
suffix:semicolon
id|errstatus
op_assign
id|aha1740_makecode
c_func
(paren
id|ecbptr-&gt;sense
comma
id|ecbptr-&gt;status
)paren
suffix:semicolon
)brace
r_else
id|errstatus
op_assign
l_int|0
suffix:semicolon
id|DEB
c_func
(paren
r_if
(paren
id|errstatus
)paren
id|printk
c_func
(paren
l_string|&quot;aha1740_intr_handle: returning %6x&bslash;n&quot;
comma
id|errstatus
)paren
)paren
suffix:semicolon
id|SCtmp-&gt;result
op_assign
id|errstatus
suffix:semicolon
id|my_done
op_assign
id|ecbptr-&gt;done
suffix:semicolon
id|memset
c_func
(paren
id|ecbptr
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ecb
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|my_done
)paren
id|my_done
c_func
(paren
id|SCtmp
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|G2INTST_HARDFAIL
suffix:colon
id|printk
c_func
(paren
l_string|&quot;aha1740 hardware failure!&bslash;n&quot;
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;aha1740.c&quot;
)paren
suffix:semicolon
multiline_comment|/* Goodbye */
r_case
id|G2INTST_ASNEVENT
suffix:colon
id|printk
c_func
(paren
l_string|&quot;aha1740 asynchronous event: %02x %02x %02x %02x %02x&bslash;n&quot;
comma
id|adapstat
comma
id|inb
c_func
(paren
id|MBOXIN0
)paren
comma
id|inb
c_func
(paren
id|MBOXIN1
)paren
comma
id|inb
c_func
(paren
id|MBOXIN2
)paren
comma
id|inb
c_func
(paren
id|MBOXIN3
)paren
)paren
suffix:semicolon
multiline_comment|/* Say What? */
id|outb
c_func
(paren
id|G2CNTRL_HRDY
comma
id|G2CNTRL
)paren
suffix:semicolon
multiline_comment|/* Host Ready -&gt; Mailbox in complete */
r_break
suffix:semicolon
r_case
id|G2INTST_CMDGOOD
suffix:colon
multiline_comment|/* set immediate command success flag here: */
r_break
suffix:semicolon
r_case
id|G2INTST_CMDERROR
suffix:colon
multiline_comment|/* Set immediate command failure flag here: */
r_break
suffix:semicolon
)brace
id|number_serviced
op_increment
suffix:semicolon
)brace
suffix:semicolon
)brace
DECL|function|aha1740_queuecommand
r_int
id|aha1740_queuecommand
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
id|unchar
id|direction
suffix:semicolon
id|unchar
op_star
id|cmd
op_assign
(paren
id|unchar
op_star
)paren
id|SCpnt-&gt;cmnd
suffix:semicolon
id|unchar
id|target
op_assign
id|SCpnt-&gt;target
suffix:semicolon
r_void
op_star
id|buff
op_assign
id|SCpnt-&gt;request_buffer
suffix:semicolon
r_int
id|bufflen
op_assign
id|SCpnt-&gt;request_bufflen
suffix:semicolon
r_int
id|ecbno
suffix:semicolon
id|DEB
c_func
(paren
r_int
id|i
)paren
suffix:semicolon
id|DEB
c_func
(paren
r_if
(paren
id|target
OG
l_int|0
op_logical_or
id|SCpnt-&gt;lun
OG
l_int|0
)paren
(brace
id|SCpnt-&gt;result
op_assign
id|DID_TIME_OUT
op_lshift
l_int|16
suffix:semicolon
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|cmd
op_eq
id|REQUEST_SENSE
)paren
(brace
macro_line|#ifndef DEBUG
r_if
c_cond
(paren
id|bufflen
op_ne
l_int|16
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Wrong buffer length supplied for request sense (%d)&bslash;n&quot;
comma
id|bufflen
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;aha1740.c&quot;
)paren
suffix:semicolon
)brace
suffix:semicolon
macro_line|#endif
id|SCpnt-&gt;result
op_assign
l_int|0
suffix:semicolon
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
op_star
id|cmd
op_eq
id|READ_10
op_logical_or
op_star
id|cmd
op_eq
id|WRITE_10
)paren
id|i
op_assign
id|xscsi2int
c_func
(paren
id|cmd
op_plus
l_int|2
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_star
id|cmd
op_eq
id|READ_6
op_logical_or
op_star
id|cmd
op_eq
id|WRITE_6
)paren
id|i
op_assign
id|scsi2int
c_func
(paren
id|cmd
op_plus
l_int|2
)paren
suffix:semicolon
r_else
id|i
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|done
)paren
id|printk
c_func
(paren
l_string|&quot;aha1740_queuecommand: dev %d cmd %02x pos %d len %d &quot;
comma
id|target
comma
op_star
id|cmd
comma
id|i
comma
id|bufflen
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;aha1740_command: dev %d cmd %02x pos %d len %d &quot;
comma
id|target
comma
op_star
id|cmd
comma
id|i
comma
id|bufflen
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi cmd:&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
op_star
id|cmd
op_le
l_int|0x1f
ques
c_cond
l_int|6
suffix:colon
l_int|10
)paren
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
id|cmd
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef 0
r_if
c_cond
(paren
op_star
id|cmd
op_eq
id|WRITE_10
op_logical_or
op_star
id|cmd
op_eq
id|WRITE_6
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* we are still testing, so *don&squot;t* write */
macro_line|#endif
macro_line|#endif
multiline_comment|/* locate an available ecb */
id|cli
c_func
(paren
)paren
suffix:semicolon
id|ecbno
op_assign
id|aha1740_last_ecb_used
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ecbno
op_ge
id|AHA1740_ECBS
)paren
id|ecbno
op_assign
l_int|0
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
op_logical_neg
id|ecb
(braket
id|ecbno
)braket
dot
id|cmdw
)paren
(brace
r_break
suffix:semicolon
)brace
id|ecbno
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ecbno
op_ge
id|AHA1740_ECBS
)paren
id|ecbno
op_assign
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
id|ecbno
op_ne
id|aha1740_last_ecb_used
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ecb
(braket
id|ecbno
)braket
dot
id|cmdw
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Unable to find empty ecb for aha1740.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|ecb
(braket
id|ecbno
)braket
dot
id|cmdw
op_assign
id|AHA1740CMD_INIT
suffix:semicolon
multiline_comment|/* SCSI Initiator Command to reserve*/
id|aha1740_last_ecb_used
op_assign
id|ecbno
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;Sending command (%d %x)...&quot;
comma
id|ecbno
comma
id|done
)paren
suffix:semicolon
macro_line|#endif
id|ecb
(braket
id|ecbno
)braket
dot
id|cdblen
op_assign
(paren
op_star
id|cmd
op_le
l_int|0x1f
)paren
ques
c_cond
l_int|6
suffix:colon
l_int|10
suffix:semicolon
multiline_comment|/* SCSI Command Descriptor Block Length */
id|direction
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_star
id|cmd
op_eq
id|READ_10
op_logical_or
op_star
id|cmd
op_eq
id|READ_6
)paren
id|direction
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
op_star
id|cmd
op_eq
id|WRITE_10
op_logical_or
op_star
id|cmd
op_eq
id|WRITE_6
)paren
id|direction
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
id|ecb
(braket
id|ecbno
)braket
dot
id|cdb
comma
id|cmd
comma
id|ecb
(braket
id|ecbno
)braket
dot
id|cdblen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;use_sg
)paren
(brace
r_struct
id|scatterlist
op_star
id|sgpnt
suffix:semicolon
r_struct
id|aha1740_chain
op_star
id|cptr
suffix:semicolon
macro_line|#ifdef DEBUG
r_int
r_char
op_star
id|ptr
suffix:semicolon
macro_line|#endif
r_int
id|i
suffix:semicolon
id|ecb
(braket
id|ecbno
)braket
dot
id|sg
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* SCSI Initiator Command  w/scatter-gather*/
id|SCpnt-&gt;host_scribble
op_assign
id|scsi_malloc
c_func
(paren
l_int|512
)paren
suffix:semicolon
id|sgpnt
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
id|cptr
op_assign
(paren
r_struct
id|aha1740_chain
op_star
)paren
id|SCpnt-&gt;host_scribble
suffix:semicolon
r_if
c_cond
(paren
id|cptr
op_eq
l_int|NULL
)paren
id|panic
c_func
(paren
l_string|&quot;aha1740.c: unable to allocate DMA memory&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SCpnt-&gt;use_sg
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cptr
(braket
id|i
)braket
dot
id|dataptr
op_assign
(paren
r_int
)paren
id|sgpnt
(braket
id|i
)braket
dot
id|address
suffix:semicolon
id|cptr
(braket
id|i
)braket
dot
id|datalen
op_assign
id|sgpnt
(braket
id|i
)braket
dot
id|length
suffix:semicolon
)brace
suffix:semicolon
id|ecb
(braket
id|ecbno
)braket
dot
id|datalen
op_assign
id|SCpnt-&gt;use_sg
op_star
r_sizeof
(paren
r_struct
id|aha1740_chain
)paren
suffix:semicolon
id|ecb
(braket
id|ecbno
)braket
dot
id|dataptr
op_assign
(paren
r_int
)paren
id|cptr
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;cptr %x: &quot;
comma
id|cptr
)paren
suffix:semicolon
id|ptr
op_assign
(paren
r_int
r_char
op_star
)paren
id|cptr
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|24
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
id|ptr
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
r_else
(brace
id|SCpnt-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
id|ecb
(braket
id|ecbno
)braket
dot
id|datalen
op_assign
id|bufflen
suffix:semicolon
id|ecb
(braket
id|ecbno
)braket
dot
id|dataptr
op_assign
(paren
r_int
)paren
id|buff
suffix:semicolon
)brace
suffix:semicolon
id|ecb
(braket
id|ecbno
)braket
dot
id|lun
op_assign
id|SCpnt-&gt;lun
suffix:semicolon
id|ecb
(braket
id|ecbno
)braket
dot
id|ses
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Suppress underrun errors */
multiline_comment|/*    ecb[ecbno].dat=1;&t;*/
multiline_comment|/* Yes, check the data direction */
id|ecb
(braket
id|ecbno
)braket
dot
id|dir
op_assign
id|direction
suffix:semicolon
id|ecb
(braket
id|ecbno
)braket
dot
id|ars
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Yes, get the sense on an error */
id|ecb
(braket
id|ecbno
)braket
dot
id|senselen
op_assign
l_int|12
suffix:semicolon
multiline_comment|/* Why 12? Eric? MAXSENSE? */
id|ecb
(braket
id|ecbno
)braket
dot
id|senseptr
op_assign
(paren
r_int
)paren
id|ecb
(braket
id|ecbno
)braket
dot
id|sense
suffix:semicolon
id|ecb
(braket
id|ecbno
)braket
dot
id|statusptr
op_assign
(paren
r_int
)paren
id|ecb
(braket
id|ecbno
)braket
dot
id|status
suffix:semicolon
id|ecb
(braket
id|ecbno
)braket
dot
id|done
op_assign
id|done
suffix:semicolon
id|ecb
(braket
id|ecbno
)braket
dot
id|SCpnt
op_assign
id|SCpnt
suffix:semicolon
macro_line|#ifdef DEBUG
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;aha1740_command: sending.. &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|ecb
(braket
id|ecbno
)braket
)paren
op_minus
l_int|10
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
(paren
(paren
id|unchar
op_star
)paren
op_amp
id|ecb
(braket
id|ecbno
)braket
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|done
)paren
(brace
id|ulong
id|adrs
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|G2STAT
)paren
op_amp
id|G2STAT_MBXOUT
)paren
)paren
multiline_comment|/* Spec claim&squot;s it&squot;s so fast */
id|printk
c_func
(paren
l_string|&quot;aha1740_mbxout wait!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* that this is okay? It seems */
r_while
c_loop
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|G2STAT
)paren
op_amp
id|G2STAT_MBXOUT
)paren
)paren
suffix:semicolon
multiline_comment|/* to work, so I&squot;ll leave it */
id|adrs
op_assign
(paren
id|ulong
)paren
op_amp
(paren
id|ecb
(braket
id|ecbno
)braket
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
r_char
)paren
(paren
id|adrs
op_amp
l_int|0xff
)paren
comma
id|MBOXOUT0
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
r_char
)paren
(paren
(paren
id|adrs
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
comma
id|MBOXOUT1
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
r_char
)paren
(paren
(paren
id|adrs
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
)paren
comma
id|MBOXOUT2
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
r_char
)paren
(paren
(paren
id|adrs
op_rshift
l_int|24
)paren
op_amp
l_int|0xff
)paren
comma
id|MBOXOUT3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|G2STAT
)paren
op_amp
id|G2STAT_BUSY
)paren
multiline_comment|/* Again, allegedly fast */
id|printk
c_func
(paren
l_string|&quot;aha1740_attn wait!&bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|G2STAT
)paren
op_amp
id|G2STAT_BUSY
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ATTN_START
op_or
(paren
id|target
op_amp
l_int|7
)paren
comma
id|ATTN
)paren
suffix:semicolon
multiline_comment|/* Start it up */
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;aha1740_queuecommand: done can&squot;t be NULL&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|internal_done_flag
r_static
r_volatile
r_int
id|internal_done_flag
op_assign
l_int|0
suffix:semicolon
DECL|variable|internal_done_errcode
r_static
r_volatile
r_int
id|internal_done_errcode
op_assign
l_int|0
suffix:semicolon
DECL|function|internal_done
r_static
r_void
id|internal_done
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|internal_done_errcode
op_assign
id|SCpnt-&gt;result
suffix:semicolon
op_increment
id|internal_done_flag
suffix:semicolon
)brace
DECL|function|aha1740_command
r_int
id|aha1740_command
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|aha1740_queuecommand
c_func
(paren
id|SCpnt
comma
id|internal_done
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|internal_done_flag
)paren
suffix:semicolon
id|internal_done_flag
op_assign
l_int|0
suffix:semicolon
r_return
id|internal_done_errcode
suffix:semicolon
)brace
multiline_comment|/* Query the board for it&squot;s port addresses, etc.  Actually, the irq_level is&n;    all we care about for this board, since it&squot;s EISA */
DECL|function|aha1740_getconfig
r_static
r_int
id|aha1740_getconfig
c_func
(paren
)paren
(brace
r_int
id|iop
comma
id|bios
comma
id|scsi
comma
id|dma
suffix:semicolon
r_static
r_int
id|iotab
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0x130
comma
l_int|0x134
comma
l_int|0x230
comma
l_int|0x234
comma
l_int|0x330
comma
l_int|0x334
)brace
suffix:semicolon
r_static
r_int
id|intab
(braket
)braket
op_assign
(brace
l_int|9
comma
l_int|10
comma
l_int|11
comma
l_int|12
comma
l_int|0
comma
l_int|14
comma
l_int|15
comma
l_int|0
)brace
suffix:semicolon
r_static
r_int
id|dmatab
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|5
comma
l_int|6
comma
l_int|7
)brace
suffix:semicolon
id|iop
op_assign
id|iotab
(braket
id|inb
c_func
(paren
id|PORTADR
)paren
op_amp
l_int|0x7
)braket
suffix:semicolon
id|bios
op_assign
id|inb
c_func
(paren
id|BIOSADR
)paren
suffix:semicolon
id|irq_level
op_assign
id|intab
(braket
id|inb
c_func
(paren
id|INTDEF
)paren
op_amp
l_int|0x7
)braket
suffix:semicolon
id|scsi
op_assign
id|inb
c_func
(paren
id|SCSIDEF
)paren
suffix:semicolon
id|dma
op_assign
id|dmatab
(braket
(paren
id|inb
c_func
(paren
id|BUSDEF
)paren
op_rshift
l_int|2
)paren
op_amp
l_int|0x3
)braket
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|aha1740_detect
r_int
id|aha1740_detect
c_func
(paren
r_int
id|hostnum
)paren
(brace
id|memset
c_func
(paren
id|ecb
comma
l_int|0
comma
r_sizeof
(paren
id|ecb
)paren
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;aha1740_detect: &bslash;n&quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|slot
op_assign
id|MINEISA
suffix:semicolon
id|slot
op_le
id|MAXEISA
suffix:semicolon
id|slot
op_increment
)paren
(brace
id|base
op_assign
id|SLOTBASE
c_func
(paren
id|slot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|aha1740_test_port
c_func
(paren
id|base
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot
OG
id|MAXEISA
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|aha1740_getconfig
c_func
(paren
)paren
op_eq
op_minus
l_int|1
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|G2STAT
)paren
op_amp
(paren
id|G2STAT_MBXOUT
op_or
id|G2STAT_BUSY
)paren
)paren
op_ne
id|G2STAT_MBXOUT
)paren
(brace
id|outb
c_func
(paren
id|G2CNTRL_HRST
comma
id|G2CNTRL
)paren
suffix:semicolon
multiline_comment|/* 10 Msec Delay Here */
id|outb
c_func
(paren
l_int|0
comma
id|G2CNTRL
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;Configuring Adaptec at IO:%x, IRQ %d&bslash;n&quot;
comma
id|base
comma
id|irq_level
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;aha1740_detect: enable interrupt channel %d&bslash;n&quot;
comma
id|irq_level
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq_level
comma
id|aha1740_intr_handle
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Unable to allocate IRQ for adaptec controller.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|aha1740_abort
r_int
id|aha1740_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_int
id|i
)paren
(brace
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;aha1740_abort&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|aha1740_reset
r_int
id|aha1740_reset
c_func
(paren
r_void
)paren
(brace
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;aha1740_reset called&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|aha1740_biosparam
r_int
(def_block
id|aha1740_biosparam
c_func
(paren
r_int
id|size
comma
r_int
id|dev
comma
r_int
op_star
id|info
)paren
(brace
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;aha1740_biosparam&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|info
(braket
l_int|0
)braket
op_assign
l_int|64
suffix:semicolon
id|info
(braket
l_int|1
)braket
op_assign
l_int|32
suffix:semicolon
id|info
(braket
l_int|2
)braket
op_assign
id|size
op_rshift
l_int|11
suffix:semicolon
r_if
c_cond
(paren
id|info
(braket
l_int|2
)braket
op_ge
l_int|1024
)paren
id|info
(braket
l_int|2
)braket
op_assign
l_int|1024
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)def_block
eof
