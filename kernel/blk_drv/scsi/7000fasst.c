multiline_comment|/* $Id: 7000fasst.c,v 1.1 1992/07/24 06:27:38 root Exp root $&n; *  linux/kernel/7000fasst.c&n; *&n; *  Copyright (C) 1992  Thomas Wuensche&n; *&t;closely related to the aha1542 driver from Tommy Thorn&n; *&t;( as close as different hardware allows on a lowlevel-driver :-) )&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/head.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
DECL|struct|mailbox
r_struct
id|mailbox
(brace
DECL|member|status
id|unchar
id|status
suffix:semicolon
DECL|member|scbptr
id|unchar
id|scbptr
(braket
l_int|3
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* #define DEBUG */
macro_line|#include &quot;7000fasst.h&quot;
macro_line|#ifdef DEBUG
DECL|macro|DEB
mdefine_line|#define DEB(x) x
macro_line|#else
DECL|macro|DEB
mdefine_line|#define DEB(x)
macro_line|#endif
multiline_comment|/*static const char RCSid[] = &quot;$Header: /usr/src/linux/kernel/blk_drv/scsi/RCS/7000fasst.c,v 1.1 1992/07/24 06:27:38 root Exp root $&quot;;*/
DECL|variable|scbs
r_static
r_struct
id|scb
id|scbs
(braket
id|OGMB_CNT
)braket
suffix:semicolon
DECL|variable|wd7000fasst_WAITnexttimeout
r_int
id|wd7000fasst_WAITnexttimeout
op_assign
l_int|3000000
suffix:semicolon
DECL|variable|wd7000fasst_do_done
r_void
(paren
op_star
id|wd7000fasst_do_done
)paren
(paren
)paren
op_assign
l_int|NULL
suffix:semicolon
r_extern
r_void
id|wd7000fasst_interrupt
c_func
(paren
)paren
suffix:semicolon
r_void
id|wd7000fasst_call_buh
c_func
(paren
)paren
suffix:semicolon
DECL|variable|controlstat
r_static
id|unchar
id|controlstat
op_assign
l_int|0
suffix:semicolon
DECL|variable|wd7000fasst_hostno
r_static
id|unchar
id|wd7000fasst_hostno
suffix:semicolon
DECL|macro|wd7000fasst_intr_reset
mdefine_line|#define wd7000fasst_intr_reset()  outb(0,INTR_ACK)
DECL|macro|PC_IMR
mdefine_line|#define PC_IMR&t;0x21
DECL|macro|AT_IMR
mdefine_line|#define AT_IMR&t;0xa1
DECL|macro|wd7000fasst_enable_intr
mdefine_line|#define wd7000fasst_enable_intr(){&bslash;&n;&t;controlstat |= INT_EN;&bslash;&n;&t;outb(controlstat,CONTROL);&bslash;&n;&t;outb((inb((intr_chan&lt;=7)?PC_IMR:AT_IMR))&amp; ~0xff,(intr_chan&lt;=7)?PC_IMR:AT_IMR);}
DECL|macro|wd7000fasst_disable_intr
mdefine_line|#define wd7000fasst_disable_intr() outb(controlstat |= INT_EN, CONTROL)
DECL|macro|wd7000fasst_enable_dma
mdefine_line|#define wd7000fasst_enable_dma() {&bslash;&n;&t;controlstat |= DMA_EN;&bslash;&n;&t;outb(controlstat,CONTROL);&bslash;&n;&t;outb((DMA_CH|CASCADE),DMA_MODE_REG);&bslash;&n;&t;outb(DMA_CH,DMA_MASK_REG);}
DECL|macro|wd7000fasst_disable_dma
mdefine_line|#define wd7000fasst_disable_dma() {&bslash;&n;&t;outb(DMA_CH|S_DMA_MASK,DMA_MASK_REG);&bslash;&n;&t;controlstat &amp;= ~DMA_EN;&bslash;&n;&t;outb(controlstat,CONTROL);}
DECL|macro|WAIT
mdefine_line|#define WAIT(port, mask, allof, noneof)&t;&t;&t;&t;&t;&bslash;&n; { register WAITbits;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;   register WAITtimeout = wd7000fasst_WAITnexttimeout;&t;&t;&t;&t;&bslash;&n;   while (1) {&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;     WAITbits = inb(port) &amp; (mask);&t;&t;&t;&t;&t;&bslash;&n;     if ((WAITbits &amp; (allof)) == (allof) &amp;&amp; ((WAITbits &amp; (noneof)) == 0)) &bslash;&n;       break;                                                         &t;&bslash;&n;     if (--WAITtimeout == 0) goto fail;&t;&t;&t;&t;&t;&bslash;&n;   }&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n; }
DECL|function|wd7000fasst_stat
r_static
r_void
id|wd7000fasst_stat
c_func
(paren
r_void
)paren
(brace
multiline_comment|/*    int s = inb(ASC_STAT), i = inb(INTR_STAT);*/
multiline_comment|/*    printk(&quot;status = %x, intrflags = %x served %d last %x&bslash;n&quot;, s, i, intr_flag, intr_last); &n;    printk(&quot;status=%x intrflags=%x&bslash;n&quot;, s, i);&n;*/
)brace
DECL|function|wd7000fasst_out
r_static
r_int
id|wd7000fasst_out
c_func
(paren
id|unchar
op_star
id|cmdp
comma
r_int
id|len
)paren
(brace
r_while
c_loop
(paren
id|len
op_decrement
)paren
(brace
id|WAIT
c_func
(paren
id|ASC_STAT
comma
id|STATMASK
comma
id|CMD_RDY
comma
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
op_star
id|cmdp
op_increment
comma
id|COMMAND
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|fail
suffix:colon
id|printk
c_func
(paren
l_string|&quot;wd7000fasst_out failed(%d): &quot;
comma
id|len
op_plus
l_int|1
)paren
suffix:semicolon
id|wd7000fasst_stat
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|wd7000fasst_make_error_code
r_int
id|wd7000fasst_make_error_code
c_func
(paren
r_int
id|hosterr
comma
r_int
id|scsierr
)paren
(brace
macro_line|#ifdef DEBUG
r_int
id|in_error
op_assign
id|hosterr
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
(paren
id|hosterr
op_amp
l_int|0xff00
)paren
op_rshift
l_int|8
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* It is reserved, should never happen */
id|hosterr
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|hosterr
op_assign
id|DID_OK
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* Command complete with logged error */
multiline_comment|/* My actual copies of the manual pages are unreadable&n;&t;&t; * For now we simply tell there is an error */
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Hosterror: VUE = %x&bslash;n&quot;
comma
id|hosterr
op_amp
l_int|0xff
)paren
suffix:semicolon
)paren
r_switch
c_cond
(paren
id|hosterr
op_amp
l_int|0xff
)paren
(brace
r_default
suffix:colon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;wd7000fasst_make_error_code: unknown hoststatus %x&bslash;n&quot;
comma
id|hosterr
)paren
suffix:semicolon
)paren
id|hosterr
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|hosterr
op_assign
id|DID_BAD_TARGET
suffix:semicolon
multiline_comment|/* Command failed to complete without SCSI status */
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|hosterr
op_assign
id|DID_RESET
suffix:semicolon
multiline_comment|/* Cmd terminated; Bus reset by external device */
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|hosterr
op_assign
id|DID_ERROR
suffix:semicolon
multiline_comment|/* Hardware Failure, requires host reset */
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|hosterr
op_assign
id|DID_RESET
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|hosterr
op_assign
id|DID_OK
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;wd7000fasst: Linked command not implemented&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
id|scsierr
op_logical_or
id|hosterr
)paren
id|printk
c_func
(paren
l_string|&quot;SCSI-Command error: SCSI %x HOST %x RETURN %x&bslash;n&quot;
comma
id|scsierr
comma
id|in_error
comma
id|hosterr
)paren
suffix:semicolon
macro_line|#endif
r_return
id|scsierr
op_or
(paren
id|hosterr
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
multiline_comment|/* The following is space for the Mailboxes */
DECL|member|ombox
(def_block
r_struct
(brace
r_struct
id|mailbox
id|ombox
(braket
id|OGMB_CNT
)braket
suffix:semicolon
DECL|member|imbox
DECL|variable|mbstruct
r_struct
id|mailbox
id|imbox
(braket
id|ICMB_CNT
)braket
suffix:semicolon
)brace
)def_block
id|mbstruct
suffix:semicolon
DECL|function|wd7000fasst_init
r_int
id|wd7000fasst_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_volatile
r_int
id|debug
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Page 47 */
id|unchar
id|init_block
(braket
)braket
op_assign
initialization_block
suffix:semicolon
multiline_comment|/* Reset the adapter. I ought to make a hard reset, but it&squot;s not really nessesary */
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;wd7000fasst_init called &bslash;n&quot;
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|SCSI_RES
op_or
id|ASC_RES
comma
id|CONTROL
)paren
suffix:semicolon
multiline_comment|/* Wait at least 25 us */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
suffix:semicolon
id|i
op_increment
)paren
id|inb
c_func
(paren
id|ASC_STAT
)paren
suffix:semicolon
multiline_comment|/* Now reset the reset */
id|outb
c_func
(paren
l_int|0
comma
id|CONTROL
)paren
suffix:semicolon
id|debug
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Expect Command Port Ready */
id|WAIT
c_func
(paren
id|ASC_STAT
comma
id|STATMASK
comma
id|CMD_RDY
comma
l_int|0
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;wd7000fasst_init: Power on Diagnostics finished&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|inb
c_func
(paren
id|INTR_STAT
)paren
)paren
op_ne
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;Power on Diagnostics error %x&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|debug
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* Clear mbstruct */
id|memset
c_func
(paren
op_amp
id|mbstruct
comma
l_int|0
comma
r_sizeof
(paren
id|mbstruct
)paren
)paren
suffix:semicolon
multiline_comment|/* Set up init block */
id|any2scsi
c_func
(paren
id|init_block
op_plus
l_int|5
comma
op_amp
id|mbstruct
)paren
suffix:semicolon
multiline_comment|/* Execute init command */
id|wd7000fasst_out
c_func
(paren
id|init_block
comma
r_sizeof
(paren
id|init_block
)paren
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Init-Block :&quot;
)paren
suffix:semicolon
r_for
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|init_block
)paren
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %x&quot;
comma
id|init_block
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)paren
multiline_comment|/* Wait until init finished */
id|WAIT
c_func
(paren
id|ASC_STAT
comma
id|STATMASK
comma
id|CMD_RDY
op_or
id|ASC_INI
comma
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|2
comma
id|COMMAND
)paren
suffix:semicolon
id|WAIT
c_func
(paren
id|ASC_STAT
comma
id|STATMASK
comma
id|CMD_RDY
op_or
id|ASC_INI
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Enable Interrupt and DMA */
id|wd7000fasst_enable_dma
c_func
(paren
)paren
suffix:semicolon
id|wd7000fasst_call_buh
c_func
(paren
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;wd7000fasst_detect: enable interrupt channel %d&bslash;n&quot;
comma
id|intr_chan
)paren
)paren
suffix:semicolon
id|wd7000fasst_enable_intr
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;wd7000fasst_init: Controller initialized&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
id|fail
suffix:colon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* 0 = not ok */
)brace
multiline_comment|/* What&squot;s this little function for? */
DECL|function|wd7000fasst_info
r_char
op_star
id|wd7000fasst_info
c_func
(paren
r_void
)paren
(brace
r_static
r_char
id|buffer
(braket
)braket
op_assign
l_string|&quot;Western Digital 7000-FASST&quot;
suffix:semicolon
r_return
id|buffer
suffix:semicolon
)brace
multiline_comment|/* A &quot;high&quot; level interrupt handler */
DECL|function|wd7000fasst_intr_handle
r_void
id|wd7000fasst_intr_handle
c_func
(paren
r_void
)paren
(brace
r_struct
id|scb
op_star
id|scbptr
suffix:semicolon
id|DEB
c_func
(paren
r_int
id|len
op_assign
r_sizeof
(paren
r_struct
id|scb
)paren
suffix:semicolon
)paren
id|DEB
c_func
(paren
r_int
id|k
suffix:semicolon
)paren
r_int
id|host_error
comma
id|scsi_error
suffix:semicolon
r_int
id|flag
op_assign
id|inb
c_func
(paren
id|INTR_STAT
)paren
suffix:semicolon
r_void
(paren
op_star
id|my_done
)paren
(paren
)paren
op_assign
id|wd7000fasst_do_done
suffix:semicolon
r_int
id|errstatus
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;WD Interrupt aufgetreten&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|ASC_STAT
)paren
op_amp
l_int|0x80
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Interrupt without Interrupt&bslash;n&quot;
)paren
suffix:semicolon
id|wd7000fasst_intr_reset
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|wd7000fasst_do_done
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|my_done
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;wd7000fasst_intr_handle: Unexpected interrupt&bslash;n&quot;
)paren
suffix:semicolon
id|wd7000fasst_intr_reset
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* is there mail for me :-) */
r_if
c_cond
(paren
(paren
id|flag
op_amp
l_int|0xc0
)paren
op_eq
l_int|0xc0
)paren
(brace
multiline_comment|/* Ok, the interrupt is for an incoming mailbox */
multiline_comment|/* We make the content available for the starter  of the command */
id|DEB
c_func
(paren
r_if
(paren
(paren
id|flag
op_amp
l_int|0xc0
)paren
op_eq
l_int|0xc0
)paren
id|printk
c_func
(paren
l_string|&quot;INTR_STAT: %x mbstat: %x&bslash;n&quot;
comma
id|flag
comma
id|mbstruct.imbox
(braket
id|flag
op_amp
l_int|0x3f
)braket
dot
id|status
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mbstruct.imbox
(braket
id|flag
op_amp
l_int|0x3f
)braket
dot
id|status
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Something strange happened */
id|wd7000fasst_intr_reset
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
suffix:semicolon
)brace
id|scbptr
op_assign
(paren
r_struct
id|scb
op_star
)paren
id|scsi2int
c_func
(paren
id|mbstruct.imbox
(braket
id|flag
op_amp
l_int|0x3f
)braket
dot
id|scbptr
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Datenbereiche aus %x ein %x &bslash;n&quot;
comma
id|scbptr
comma
op_amp
(paren
id|scbs
(braket
id|flag
op_amp
l_int|0x3f
)braket
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCB after return:&bslash;n&quot;
)paren
suffix:semicolon
id|k
op_assign
l_int|0
suffix:semicolon
r_while
(paren
id|len
op_decrement
OG
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%x &quot;
comma
op_star
(paren
(paren
id|unchar
op_star
)paren
id|scbptr
)paren
)paren
suffix:semicolon
(paren
(paren
id|unchar
op_star
)paren
id|scbptr
)paren
op_increment
suffix:semicolon
r_if
(paren
op_increment
id|k
op_eq
l_int|16
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|k
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;Error in interrupt&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* more error checking left out here */
id|scbptr
op_assign
(paren
r_struct
id|scb
op_star
)paren
id|scsi2int
c_func
(paren
id|mbstruct.imbox
(braket
id|flag
op_amp
l_int|0x3f
)braket
dot
id|scbptr
)paren
suffix:semicolon
id|host_error
op_assign
id|scbptr-&gt;vue
op_or
id|mbstruct.imbox
(braket
id|flag
op_amp
l_int|0x3f
)braket
dot
id|status
op_lshift
l_int|8
suffix:semicolon
id|scsi_error
op_assign
id|scbptr-&gt;sretstat
suffix:semicolon
id|errstatus
op_assign
id|wd7000fasst_make_error_code
c_func
(paren
id|host_error
comma
id|scsi_error
)paren
suffix:semicolon
id|DEB
c_func
(paren
r_if
(paren
id|errstatus
)paren
id|printk
c_func
(paren
l_string|&quot;Target was %x&bslash;n&quot;
comma
id|scbptr-&gt;idlun
op_rshift
l_int|5
)paren
suffix:semicolon
)paren
id|DEB
c_func
(paren
r_if
(paren
id|errstatus
)paren
id|printk
c_func
(paren
l_string|&quot;wd7000fasst_intr_handle: returning %6x&bslash;n&quot;
comma
id|errstatus
)paren
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;wd7000fasst_intr_handle: Status of the finished command: %x&bslash;n&quot;
comma
id|mbstruct.imbox
(braket
id|flag
op_amp
l_int|0x3f
)braket
dot
id|status
)paren
)paren
suffix:semicolon
multiline_comment|/* I make a SCSI reset */
multiline_comment|/* Left out */
id|my_done
c_func
(paren
id|wd7000fasst_hostno
comma
id|errstatus
)paren
suffix:semicolon
id|wd7000fasst_intr_reset
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|variable|internal_done_flag
r_volatile
r_static
r_int
id|internal_done_flag
op_assign
l_int|0
suffix:semicolon
DECL|variable|internal_done_errcode
r_volatile
r_static
r_int
id|internal_done_errcode
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* The following code queues a SCSI command */
DECL|function|wd7000fasst_queuecommand
r_int
id|wd7000fasst_queuecommand
c_func
(paren
id|unchar
id|target
comma
r_const
r_void
op_star
id|cmnd
comma
r_void
op_star
id|buff
comma
r_int
id|bufflen
comma
r_void
(paren
op_star
id|done
)paren
(paren
r_int
comma
r_int
)paren
)paren
(brace
r_int
id|i
suffix:semicolon
macro_line|#ifdef DEBUG
r_int
id|j
suffix:semicolon
macro_line|#endif
id|unchar
op_star
id|cmd
op_assign
(paren
id|unchar
op_star
)paren
id|cmnd
suffix:semicolon
multiline_comment|/* We first look for a free outgoing mailbox */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|OGMB_CNT
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|mbstruct.ombox
(braket
id|i
)braket
dot
id|status
op_eq
l_int|0
)paren
(brace
multiline_comment|/* We found one, now set up the scb */
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Found outgoing mbox %x&bslash;n&quot;
comma
id|i
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|scbs
(braket
id|i
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|scb
)paren
)paren
suffix:semicolon
multiline_comment|/* scbs[i].cdblen = (*cmd&lt;=0x1f)?6:10; */
multiline_comment|/* SCSI Command Descriptor Block Length */
id|memcpy
c_func
(paren
id|scbs
(braket
id|i
)braket
dot
id|scbdata
comma
id|cmd
comma
(paren
op_star
id|cmd
op_le
l_int|0x1f
)paren
ques
c_cond
l_int|6
suffix:colon
l_int|10
)paren
suffix:semicolon
id|scbs
(braket
id|i
)braket
dot
id|op
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* SCSI Initiator Command */
id|scbs
(braket
id|i
)braket
dot
id|idlun
op_assign
(paren
id|target
op_lshift
l_int|5
)paren
op_amp
l_int|0xe0
suffix:semicolon
multiline_comment|/* SCSI Target Id Bit 7-5 Target Id*/
id|any2scsi
c_func
(paren
id|scbs
(braket
id|i
)braket
dot
id|dataptr
comma
id|buff
)paren
suffix:semicolon
id|any2scsi
c_func
(paren
id|scbs
(braket
id|i
)braket
dot
id|maxdata
comma
id|bufflen
)paren
suffix:semicolon
id|scbs
(braket
id|i
)braket
dot
id|direc
op_assign
l_int|0x40
suffix:semicolon
multiline_comment|/* Disable direction check */
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Kommando fuer target %x ist: &quot;
comma
id|target
)paren
suffix:semicolon
r_for
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|12
suffix:semicolon
id|j
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %x&quot;
comma
id|scbs
(braket
id|i
)braket
dot
id|scbdata
(braket
id|j
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Now we set up the pointer to scb, then the status of the mbox */
id|any2scsi
c_func
(paren
(paren
id|mbstruct.ombox
(braket
id|i
)braket
dot
id|scbptr
)paren
comma
op_amp
(paren
id|scbs
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|mbstruct.ombox
(braket
id|i
)braket
dot
id|status
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Everything set up, start the command */
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i
op_eq
id|OGMB_CNT
)paren
(brace
multiline_comment|/* No free mbox, send command &quot;Interrupt on free OGMB&quot; */
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;No free Mailbox&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
(brace
r_int
id|len
comma
id|k
suffix:semicolon
r_struct
id|scb
op_star
id|scbptr
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Found outgoing mbox %x&bslash;n&quot;
comma
id|i
)paren
)paren
suffix:semicolon
id|scbptr
op_assign
op_amp
(paren
id|scbs
(braket
id|i
)braket
)paren
suffix:semicolon
id|len
op_assign
r_sizeof
(paren
r_struct
id|scb
)paren
suffix:semicolon
id|k
op_assign
l_int|0
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;SCB before execute:&bslash;n&quot;
)paren
suffix:semicolon
r_while
(paren
id|len
op_decrement
OG
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%x &quot;
comma
op_star
(paren
(paren
id|unchar
op_star
)paren
id|scbptr
)paren
)paren
suffix:semicolon
(paren
(paren
id|unchar
op_star
)paren
id|scbptr
)paren
op_increment
suffix:semicolon
r_if
(paren
op_increment
id|k
op_eq
l_int|16
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|k
op_assign
l_int|0
suffix:semicolon
)brace
)brace
suffix:semicolon
)paren
)brace
multiline_comment|/* Set up the &quot;done&quot; response function */
r_if
c_cond
(paren
id|done
)paren
(brace
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;wd7000fasst_queuecommand: now waiting for interrupt &quot;
)paren
suffix:semicolon
id|wd7000fasst_stat
c_func
(paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wd7000fasst_do_done
)paren
id|printk
c_func
(paren
l_string|&quot;wd7000fasst_queuecommand: Two concurrent queuecommand?&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|wd7000fasst_do_done
op_assign
id|done
suffix:semicolon
id|DEB
c_func
(paren
id|wd7000fasst_stat
c_func
(paren
)paren
)paren
suffix:semicolon
id|wd7000fasst_enable_intr
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;wd7000fasst_queuecommand: done can&squot;t be NULL&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Now we initialize execution */
id|retry
suffix:colon
id|WAIT
c_func
(paren
id|ASC_STAT
comma
id|STATMASK
comma
id|CMD_RDY
comma
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x80
op_plus
id|i
comma
id|COMMAND
)paren
suffix:semicolon
id|WAIT
c_func
(paren
id|ASC_STAT
comma
id|STATMASK
comma
id|CMD_RDY
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|ASC_STAT
)paren
op_amp
id|CMD_REJ
)paren
r_goto
id|retry
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* Wait until done */
id|fail
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* We use this function for queueing a command from wd7000fasst_command */
DECL|function|internal_done
r_static
r_void
id|internal_done
c_func
(paren
r_int
id|host
comma
r_int
id|errcode
)paren
(brace
id|internal_done_errcode
op_assign
id|errcode
suffix:semicolon
op_increment
id|internal_done_flag
suffix:semicolon
)brace
DECL|function|wd7000fasst_command
r_int
id|wd7000fasst_command
c_func
(paren
id|unchar
id|target
comma
r_const
r_void
op_star
id|cmnd
comma
r_void
op_star
id|buff
comma
r_int
id|bufflen
)paren
(brace
macro_line|#ifdef DEBUG
r_int
id|k
suffix:semicolon
macro_line|#endif
id|wd7000fasst_queuecommand
c_func
(paren
id|target
comma
id|cmnd
comma
id|buff
comma
id|bufflen
comma
id|internal_done
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|internal_done_flag
)paren
suffix:semicolon
id|internal_done_flag
op_assign
l_int|0
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;wd7000fasst_command finished: ..leaving with errcode %x&bslash;n&quot;
comma
id|internal_done_errcode
)paren
)paren
suffix:semicolon
id|DEB
c_func
(paren
r_for
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
l_int|5000000
suffix:semicolon
id|k
op_increment
)paren
id|inb
c_func
(paren
id|INTR_STAT
)paren
)paren
suffix:semicolon
r_return
id|internal_done_errcode
suffix:semicolon
)brace
multiline_comment|/* a hack to avoid a strange compilation error */
DECL|function|wd7000fasst_call_buh
r_void
id|wd7000fasst_call_buh
c_func
(paren
)paren
(brace
id|set_intr_gate
c_func
(paren
(paren
id|intr_chan
op_le
l_int|7
)paren
ques
c_cond
id|intr_chan
op_plus
l_int|8
suffix:colon
id|intr_chan
op_plus
l_int|0x20
comma
op_amp
id|wd7000fasst_interrupt
)paren
suffix:semicolon
)brace
multiline_comment|/* return non-zero on detection */
DECL|variable|wd_bases
r_static
r_const
r_char
op_star
id|wd_bases
(braket
)braket
op_assign
(brace
(paren
r_char
op_star
)paren
l_int|0xce000
)brace
suffix:semicolon
DECL|member|signature
r_typedef
r_struct
(brace
r_char
op_star
id|signature
suffix:semicolon
DECL|member|offset
r_int
id|offset
suffix:semicolon
DECL|member|length
r_int
id|length
suffix:semicolon
DECL|typedef|Signature
)brace
id|Signature
suffix:semicolon
DECL|variable|signatures
r_static
r_const
id|Signature
id|signatures
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;SSTBIOS&quot;
comma
l_int|0xd
comma
l_int|0x7
)brace
)brace
suffix:semicolon
DECL|macro|NUM_SIGNATURES
mdefine_line|#define NUM_SIGNATURES (sizeof(signatures)/sizeof(Signature))
DECL|function|wd7000fasst_detect
r_int
id|wd7000fasst_detect
c_func
(paren
r_int
id|hostnum
)paren
multiline_comment|/* hostnum ignored for now */
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_char
r_const
op_star
id|base_address
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Store our host number */
id|wd7000fasst_hostno
op_assign
id|hostnum
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;wd7000fasst_detect: &bslash;n&quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
r_sizeof
(paren
id|wd_bases
)paren
op_div
r_sizeof
(paren
r_char
op_star
)paren
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|NUM_SIGNATURES
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|wd_bases
(braket
id|i
)braket
op_plus
id|signatures
(braket
id|j
)braket
dot
id|offset
)paren
comma
(paren
r_void
op_star
)paren
id|signatures
(braket
id|j
)braket
dot
id|signature
comma
id|signatures
(braket
id|j
)braket
dot
id|length
)paren
)paren
(brace
id|base_address
op_assign
id|wd_bases
(braket
id|i
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;WD 7000-FASST detected&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|base_address
)paren
r_return
l_int|0
suffix:semicolon
id|wd7000fasst_init
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Set the Bus on/off-times as not to ruin floppy performens */
id|wd7000fasst_stat
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; *** READ CAPACITY ***&bslash;n&quot;
)paren
suffix:semicolon
(brace
id|unchar
id|rstat
suffix:semicolon
id|unchar
id|buf
(braket
l_int|8
)braket
suffix:semicolon
r_static
id|unchar
id|cmd
(braket
)braket
op_assign
(brace
id|READ_CAPACITY
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|buf
)paren
suffix:semicolon
op_increment
id|i
)paren
id|buf
(braket
id|i
)braket
op_assign
l_int|0x87
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
op_increment
id|i
)paren
(brace
id|rstat
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|rstat
OL
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|wd7000fasst_command
c_func
(paren
id|i
comma
id|cmd
comma
id|buf
comma
r_sizeof
(paren
id|buf
)paren
)paren
)paren
id|rstat
op_increment
suffix:semicolon
r_else
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rstat
OL
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;wd7000fasst_detect: LU %d sector_size 0x%x device_size 0x%x capacity %d&bslash;n&quot;
comma
id|i
comma
id|xscsi2int
c_func
(paren
id|buf
op_plus
l_int|4
)paren
comma
id|xscsi2int
c_func
(paren
id|buf
)paren
comma
id|xscsi2int
c_func
(paren
id|buf
op_plus
l_int|4
)paren
op_star
id|xscsi2int
c_func
(paren
id|buf
)paren
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|wd7000fasst_abort
r_int
id|wd7000fasst_abort
c_func
(paren
r_int
id|i
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;wd7000fasst_abort&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|wd7000fasst_reset
r_int
id|wd7000fasst_reset
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;wd7000fasst_reset called&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|__asm__
c_func
(paren
"&quot;"
id|_wd7000fasst_interrupt
suffix:colon
id|cld
id|pushl
op_mod
id|eax
id|pushl
op_mod
id|ecx
id|pushl
op_mod
id|edx
id|push
op_mod
id|ds
id|push
op_mod
id|es
id|push
op_mod
id|fs
id|movl
"$"
l_int|0x10
comma
op_mod
id|eax
id|mov
op_mod
id|ax
comma
op_mod
id|ds
id|mov
op_mod
id|ax
comma
op_mod
id|es
id|movl
"$"
l_int|0x17
comma
op_mod
id|eax
id|mov
op_mod
id|ax
comma
op_mod
id|fs
macro_line|# Please, someone, change this to use the timer
macro_line|#&t;andl $0xfffeffff,_timer_active
id|movl
"$"
id|_wd7000fasst_intr_handle
comma
op_mod
id|edx
id|call
op_star
op_mod
id|edx
macro_line|# ``interesting&squot;&squot; way of handling intr.
macro_line|# Free the interrupt only after resetting the host interrupt
id|movb
"$"
l_int|0x20
comma
op_mod
id|al
id|outb
op_mod
id|al
comma
"$"
l_int|0xA0
macro_line|# EOI to interrupt controller #1
id|jmp
l_float|1f
macro_line|# give port chance to breathe
l_int|1
suffix:colon
id|jmp
l_float|1f
l_int|1
suffix:colon
id|outb
op_mod
id|al
comma
"$"
l_int|0x20
id|pop
op_mod
id|fs
id|pop
op_mod
id|es
id|pop
op_mod
id|ds
id|popl
op_mod
id|edx
id|popl
op_mod
id|ecx
id|popl
op_mod
id|eax
id|iret
"&quot;"
)paren
suffix:semicolon
eof
