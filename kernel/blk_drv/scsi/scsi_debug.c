multiline_comment|/* $Id: scsi_debug.c,v 1.1 1992/07/24 06:27:38 root Exp root $&n; *  linux/kernel/scsi_debug.c&n; *&n; *  Copyright (C) 1992  Eric Youngdale&n; *  Simulate a host adapter with 2 disks attached.  Do a lot of checking&n; *  to make sure that we are not getting blocks mixed up, and panic if&n; *  anything out of the ordinary is seen.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/head.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/genhd.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;../blk.h&quot;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
multiline_comment|/* Number of real scsi disks that will be detected ahead of time */
DECL|variable|NR_REAL
r_static
r_int
id|NR_REAL
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|macro|NR_BLK_DEV
mdefine_line|#define NR_BLK_DEV&t;12
DECL|macro|MAJOR_NR
mdefine_line|#define MAJOR_NR 8
DECL|macro|START_PARTITION
mdefine_line|#define START_PARTITION 4
DECL|macro|SCSI_DEBUG_TIMER
mdefine_line|#define SCSI_DEBUG_TIMER 20
multiline_comment|/* Number of jiffies to wait before completing a command */
DECL|macro|DISK_SPEED
mdefine_line|#define DISK_SPEED     10
DECL|macro|CAPACITY
mdefine_line|#define CAPACITY (0x80000)
DECL|variable|starts
r_static
r_int
id|starts
(braket
)braket
op_assign
(brace
l_int|4
comma
l_int|1000
comma
l_int|50000
comma
id|CAPACITY
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|npart
r_static
r_int
id|npart
op_assign
l_int|0
suffix:semicolon
macro_line|#include &quot;scsi_debug.h&quot;
macro_line|#ifdef DEBUG
DECL|macro|DEB
mdefine_line|#define DEB(x) x
macro_line|#else
DECL|macro|DEB
mdefine_line|#define DEB(x)
macro_line|#endif
DECL|macro|VERIFY1_DEBUG
mdefine_line|#define VERIFY1_DEBUG(RW)&t;&t;&t;       &t;&t;&t;&bslash;&n;      if (bufflen != 1024) {printk(&quot;%d&quot;, bufflen); panic(&quot;(1)Bad bufflen&quot;);};&t;&t;&t;&bslash;&n;      start = 0;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;      if ((SCpnt-&gt;request.dev &amp; 0xf) != 0) start = starts[(SCpnt-&gt;request.dev &amp; 0xf) - 1];&t;&t;&bslash;&n;      if (bh){&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;if (bh-&gt;b_size != 1024) panic (&quot;Wrong bh size&quot;);&t;&bslash;&n;&t;if ((bh-&gt;b_blocknr &lt;&lt; 1) + start != block)&t;       &t;&bslash;&n;&t;  {  printk(&quot;Wrong bh block# %d %d &quot;,bh-&gt;b_blocknr, block);  &bslash;&n;&t;  panic (&quot;Wrong bh block#&quot;);};  &bslash;&n;&t;if (bh-&gt;b_dev != SCpnt-&gt;request.dev) panic (&quot;Bad bh target&quot;);&bslash;&n;      };
macro_line|#if 0
multiline_comment|/* This had been in the VERIFY_DEBUG macro, but it fails if there is already&n;   a disk on the system */
r_if
c_cond
(paren
(paren
id|SCpnt-&gt;request.dev
op_amp
l_int|0xfff0
)paren
op_ne
(paren
(paren
id|target
op_plus
id|NR_REAL
)paren
op_lshift
l_int|4
)paren
op_plus
(paren
id|MAJOR_NR
op_lshift
l_int|8
)paren
)paren
(brace
"&bslash;"
id|printk
c_func
(paren
l_string|&quot;Dev #s %x %x &quot;
comma
id|SCpnt-&gt;request.dev
comma
id|target
)paren
suffix:semicolon
"&bslash;"
id|panic
(paren
l_string|&quot;Bad target&quot;
)paren
suffix:semicolon
)brace
suffix:semicolon
"&bslash;"
macro_line|#endif
DECL|macro|VERIFY_DEBUG
mdefine_line|#define VERIFY_DEBUG(RW)&t;&t;&t;       &t;&t;&t;&bslash;&n;      if (bufflen != 1024 &amp;&amp; (!SCpnt-&gt;use_sg)) {printk(&quot;%x %d&bslash;n &quot;,bufflen, SCpnt-&gt;use_sg); panic(&quot;Bad bufflen&quot;);};   &t;&bslash;&n;      start = 0;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;      if ((SCpnt-&gt;request.dev &amp; 0xf) &gt; npart) panic (&quot;Bad partition&quot;);&t;&bslash;&n;      if ((SCpnt-&gt;request.dev &amp; 0xf) != 0) start = starts[(SCpnt-&gt;request.dev &amp; 0xf) - 1];&t;&t;&bslash;&n;      if (SCpnt-&gt;request.cmd != RW) panic (&quot;Wrong  operation&quot;);&t;&t;&bslash;&n;      if (SCpnt-&gt;request.sector + start != block) panic(&quot;Wrong block.&quot;);&t;&bslash;&n;      if (SCpnt-&gt;request.current_nr_sectors != 2 &amp;&amp; (!SCpnt-&gt;use_sg)) panic (&quot;Wrong # blocks&quot;);&t;&bslash;&n;      if (SCpnt-&gt;request.bh){&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;if (SCpnt-&gt;request.bh-&gt;b_size != 1024) panic (&quot;Wrong bh size&quot;);&t;&bslash;&n;&t;if ((SCpnt-&gt;request.bh-&gt;b_blocknr &lt;&lt; 1) + start != block)&t;       &t;&bslash;&n;&t;  {  printk(&quot;Wrong bh block# %d %d &quot;,SCpnt-&gt;request.bh-&gt;b_blocknr, block);  &bslash;&n;&t;  panic (&quot;Wrong bh block#&quot;);};  &bslash;&n;&t;if (SCpnt-&gt;request.bh-&gt;b_dev != SCpnt-&gt;request.dev) panic (&quot;Bad bh target&quot;);&bslash;&n;      };
DECL|variable|do_done
r_static
r_volatile
r_void
(paren
op_star
id|do_done
(braket
id|SCSI_DEBUG_MAILBOXES
)braket
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
op_assign
(brace
l_int|NULL
comma
)brace
suffix:semicolon
DECL|variable|scsi_debug_host
r_static
r_int
id|scsi_debug_host
op_assign
l_int|0
suffix:semicolon
r_extern
r_void
id|scsi_debug_interrupt
c_func
(paren
)paren
suffix:semicolon
DECL|variable|SCint
r_volatile
id|Scsi_Cmnd
op_star
id|SCint
(braket
id|SCSI_DEBUG_MAILBOXES
)braket
op_assign
(brace
l_int|NULL
comma
)brace
suffix:semicolon
DECL|variable|timeout
r_static
r_volatile
r_int
r_int
id|timeout
(braket
id|SCSI_DEBUG_MAILBOXES
)braket
op_assign
initialization_block
suffix:semicolon
DECL|variable|sense_buffer
r_static
r_char
id|sense_buffer
(braket
l_int|128
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
DECL|function|scsi_dump
r_static
r_void
(def_block
id|scsi_dump
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_int
id|flag
)paren
(brace
r_int
id|i
suffix:semicolon
macro_line|#if 0
r_int
r_char
op_star
id|pnt
suffix:semicolon
macro_line|#endif
r_int
r_int
op_star
id|lpnt
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sgpnt
op_assign
l_int|NULL
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;use_sg: %d&quot;
comma
id|SCpnt-&gt;use_sg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;use_sg
)paren
(brace
id|sgpnt
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|SCpnt-&gt;buffer
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SCpnt-&gt;use_sg
suffix:semicolon
id|i
op_increment
)paren
(brace
id|lpnt
op_assign
(paren
r_int
op_star
)paren
id|sgpnt
(braket
id|i
)braket
dot
id|alt_address
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;:%x %x %d&bslash;n&quot;
comma
id|sgpnt
(braket
id|i
)braket
dot
id|alt_address
comma
id|sgpnt
(braket
id|i
)braket
dot
id|address
comma
id|sgpnt
(braket
id|i
)braket
dot
id|length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lpnt
)paren
id|printk
c_func
(paren
l_string|&quot; (Alt %x) &quot;
comma
id|lpnt
(braket
l_int|15
)braket
)paren
suffix:semicolon
)brace
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;nosg: %x %x %d&bslash;n&quot;
comma
id|SCpnt-&gt;request.buffer
comma
id|SCpnt-&gt;buffer
comma
id|SCpnt-&gt;bufflen
)paren
suffix:semicolon
id|lpnt
op_assign
(paren
r_int
op_star
)paren
id|SCpnt-&gt;request.buffer
suffix:semicolon
r_if
c_cond
(paren
id|lpnt
)paren
id|printk
c_func
(paren
l_string|&quot; (Alt %x) &quot;
comma
id|lpnt
(braket
l_int|15
)braket
)paren
suffix:semicolon
)brace
suffix:semicolon
id|lpnt
op_assign
(paren
r_int
r_int
op_star
)paren
id|SCpnt
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|Scsi_Cmnd
)paren
op_div
l_int|4
op_plus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|i
op_amp
l_int|7
)paren
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%x &quot;
comma
op_star
id|lpnt
op_increment
)paren
suffix:semicolon
)brace
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|lpnt
op_assign
(paren
r_int
r_int
op_star
)paren
id|sgpnt
(braket
l_int|0
)braket
dot
id|alt_address
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|Scsi_Cmnd
)paren
op_div
l_int|4
op_plus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|i
op_amp
l_int|7
)paren
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%x &quot;
comma
op_star
id|lpnt
op_increment
)paren
suffix:semicolon
)brace
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|lpnt
op_assign
(paren
r_int
r_int
op_star
)paren
id|sgpnt
(braket
l_int|0
)braket
dot
id|address
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|Scsi_Cmnd
)paren
op_div
l_int|4
op_plus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|i
op_amp
l_int|7
)paren
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%x &quot;
comma
op_star
id|lpnt
op_increment
)paren
suffix:semicolon
)brace
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;DMA free %d sectors.&bslash;n&quot;
comma
id|dma_free_sectors
)paren
suffix:semicolon
)brace
)def_block
DECL|function|scsi_debug_queuecommand
r_int
id|scsi_debug_queuecommand
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
id|unchar
op_star
id|cmd
op_assign
(paren
id|unchar
op_star
)paren
id|SCpnt-&gt;cmnd
suffix:semicolon
r_struct
id|partition
op_star
id|p
suffix:semicolon
r_int
id|block
comma
id|start
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
op_assign
l_int|NULL
suffix:semicolon
r_int
r_char
op_star
id|buff
suffix:semicolon
r_int
id|nbytes
comma
id|sgcount
suffix:semicolon
r_int
id|scsi_debug_errsts
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sgpnt
suffix:semicolon
r_int
id|target
op_assign
id|SCpnt-&gt;target
suffix:semicolon
r_int
id|bufflen
op_assign
id|SCpnt-&gt;request_bufflen
suffix:semicolon
r_int
id|i
suffix:semicolon
id|sgcount
op_assign
l_int|0
suffix:semicolon
id|sgpnt
op_assign
l_int|NULL
suffix:semicolon
id|DEB
c_func
(paren
r_if
(paren
id|target
OG
l_int|1
)paren
(brace
id|SCpnt-&gt;result
op_assign
id|DID_TIME_OUT
op_lshift
l_int|16
suffix:semicolon
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)paren
suffix:semicolon
id|buff
op_assign
(paren
r_int
r_char
op_star
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
r_if
c_cond
(paren
id|target
op_ge
l_int|2
op_logical_or
id|SCpnt-&gt;lun
op_ne
l_int|0
)paren
(brace
id|SCpnt-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|cmd
)paren
(brace
r_case
id|REQUEST_SENSE
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Request sense...&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifndef DEBUG
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi_debug: Requesting sense buffer (%x %x %x %d):&quot;
comma
id|SCpnt
comma
id|buff
comma
id|done
comma
id|bufflen
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|12
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%d &quot;
comma
id|sense_buffer
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
suffix:semicolon
macro_line|#endif
id|memset
c_func
(paren
id|buff
comma
l_int|0
comma
id|bufflen
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|buff
comma
id|sense_buffer
comma
id|bufflen
)paren
suffix:semicolon
id|memset
c_func
(paren
id|sense_buffer
comma
l_int|0
comma
r_sizeof
(paren
id|sense_buffer
)paren
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
l_int|0
suffix:semicolon
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ALLOW_MEDIUM_REMOVAL
suffix:colon
r_if
c_cond
(paren
id|cmd
(braket
l_int|4
)braket
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Medium removal inhibited...&quot;
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;Medium removal enabled...&quot;
)paren
suffix:semicolon
id|scsi_debug_errsts
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INQUIRY
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Inquiry...(%x %d)&bslash;n&quot;
comma
id|buff
comma
id|bufflen
)paren
suffix:semicolon
id|memset
c_func
(paren
id|buff
comma
l_int|0
comma
id|bufflen
)paren
suffix:semicolon
id|buff
(braket
l_int|0
)braket
op_assign
id|TYPE_DISK
suffix:semicolon
id|buff
(braket
l_int|1
)braket
op_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* Removable disk */
id|buff
(braket
l_int|2
)braket
op_assign
l_int|1
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|buff
(braket
l_int|8
)braket
comma
l_string|&quot;Foo Inc&quot;
comma
l_int|7
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|buff
(braket
l_int|16
)braket
comma
l_string|&quot;XYZZY&quot;
comma
l_int|5
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|buff
(braket
l_int|32
)braket
comma
l_string|&quot;1&quot;
comma
l_int|1
)paren
suffix:semicolon
id|scsi_debug_errsts
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TEST_UNIT_READY
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Test unit ready.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buff
)paren
id|memset
c_func
(paren
id|buff
comma
l_int|0
comma
id|bufflen
)paren
suffix:semicolon
id|scsi_debug_errsts
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_CAPACITY
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Read Capacity&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|NR_REAL
OL
l_int|0
)paren
(brace
id|NR_REAL
op_assign
(paren
id|SCpnt-&gt;request.dev
op_rshift
l_int|4
)paren
op_amp
l_int|0x0f
suffix:semicolon
)brace
id|memset
c_func
(paren
id|buff
comma
l_int|0
comma
id|bufflen
)paren
suffix:semicolon
id|buff
(braket
l_int|0
)braket
op_assign
(paren
id|CAPACITY
op_rshift
l_int|24
)paren
suffix:semicolon
id|buff
(braket
l_int|1
)braket
op_assign
(paren
id|CAPACITY
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|buff
(braket
l_int|2
)braket
op_assign
(paren
id|CAPACITY
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|buff
(braket
l_int|3
)braket
op_assign
id|CAPACITY
op_amp
l_int|0xff
suffix:semicolon
id|buff
(braket
l_int|6
)braket
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* 512 byte sectors */
id|scsi_debug_errsts
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_10
suffix:colon
r_case
id|READ_6
suffix:colon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;Read...&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
op_star
id|cmd
)paren
op_eq
id|READ_10
)paren
id|block
op_assign
id|cmd
(braket
l_int|5
)braket
op_plus
(paren
id|cmd
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_plus
(paren
id|cmd
(braket
l_int|3
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|cmd
(braket
l_int|2
)braket
op_lshift
l_int|24
)paren
suffix:semicolon
r_else
id|block
op_assign
id|cmd
(braket
l_int|3
)braket
op_plus
(paren
id|cmd
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_plus
(paren
(paren
id|cmd
(braket
l_int|1
)braket
op_amp
l_int|0x1f
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|VERIFY_DEBUG
c_func
(paren
id|READ
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(r%d)&quot;
comma
id|SCpnt-&gt;request.nr_sectors
)paren
suffix:semicolon
id|nbytes
op_assign
id|bufflen
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;use_sg
)paren
(brace
id|sgcount
op_assign
l_int|0
suffix:semicolon
id|sgpnt
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|buff
suffix:semicolon
id|buff
op_assign
id|sgpnt
(braket
id|sgcount
)braket
dot
id|address
suffix:semicolon
id|bufflen
op_assign
id|sgpnt
(braket
id|sgcount
)braket
dot
id|length
suffix:semicolon
id|bh
op_assign
id|SCpnt-&gt;request.bh
suffix:semicolon
)brace
suffix:semicolon
id|scsi_debug_errsts
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|VERIFY1_DEBUG
c_func
(paren
id|READ
)paren
suffix:semicolon
id|memset
c_func
(paren
id|buff
comma
l_int|0
comma
id|bufflen
)paren
suffix:semicolon
multiline_comment|/* If this is block 0, then we want to read the partition table for this&n;   device.  Let&squot;s make one up */
r_if
c_cond
(paren
id|block
op_eq
l_int|0
op_logical_and
id|target
op_eq
l_int|0
)paren
(brace
op_star
(paren
(paren
r_int
r_int
op_star
)paren
(paren
id|buff
op_plus
l_int|510
)paren
)paren
op_assign
l_int|0xAA55
suffix:semicolon
id|p
op_assign
(paren
r_struct
id|partition
op_star
)paren
(paren
id|buff
op_plus
l_int|0x1be
)paren
suffix:semicolon
id|npart
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|starts
(braket
id|npart
op_plus
l_int|1
)braket
)paren
(brace
id|p-&gt;start_sect
op_assign
id|starts
(braket
id|npart
)braket
suffix:semicolon
id|p-&gt;nr_sects
op_assign
id|starts
(braket
id|npart
op_plus
l_int|1
)braket
op_minus
id|starts
(braket
id|npart
)braket
suffix:semicolon
id|p-&gt;sys_ind
op_assign
l_int|0x81
suffix:semicolon
multiline_comment|/* Linux partition */
id|p
op_increment
suffix:semicolon
id|npart
op_increment
suffix:semicolon
)brace
suffix:semicolon
id|scsi_debug_errsts
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
id|SCpnt-&gt;use_sg
)paren
id|printk
c_func
(paren
l_string|&quot;Block %x (%d %d)&bslash;n&quot;
comma
id|block
comma
id|SCpnt-&gt;request.nr_sectors
comma
id|SCpnt-&gt;request.current_nr_sectors
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Simulate a disk change */
r_if
c_cond
(paren
id|block
op_eq
l_int|0xfff0
)paren
(brace
id|sense_buffer
(braket
l_int|0
)braket
op_assign
l_int|0x70
suffix:semicolon
id|sense_buffer
(braket
l_int|2
)braket
op_assign
id|UNIT_ATTENTION
suffix:semicolon
id|starts
(braket
l_int|0
)braket
op_add_assign
l_int|10
suffix:semicolon
id|starts
(braket
l_int|1
)braket
op_add_assign
l_int|10
suffix:semicolon
id|starts
(braket
l_int|2
)braket
op_add_assign
l_int|10
suffix:semicolon
macro_line|#ifdef DEBUG
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi_debug: Filling sense buffer:&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|12
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%d &quot;
comma
id|sense_buffer
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
suffix:semicolon
macro_line|#endif
id|scsi_debug_errsts
op_assign
(paren
id|COMMAND_COMPLETE
op_lshift
l_int|8
)paren
op_or
(paren
id|CHECK_CONDITION
op_lshift
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* End phony disk change code */
id|memset
c_func
(paren
id|buff
comma
l_int|0
comma
id|bufflen
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|buff
comma
op_amp
id|target
comma
r_sizeof
(paren
id|target
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|buff
op_plus
r_sizeof
(paren
id|target
)paren
comma
id|cmd
comma
l_int|24
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|buff
op_plus
l_int|60
comma
op_amp
id|block
comma
r_sizeof
(paren
id|block
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|buff
op_plus
l_int|64
comma
id|SCpnt
comma
r_sizeof
(paren
id|Scsi_Cmnd
)paren
)paren
suffix:semicolon
id|nbytes
op_sub_assign
id|bufflen
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;use_sg
)paren
(brace
id|memcpy
c_func
(paren
id|buff
op_plus
l_int|128
comma
id|bh
comma
r_sizeof
(paren
r_struct
id|buffer_head
)paren
)paren
suffix:semicolon
id|block
op_add_assign
id|bufflen
op_rshift
l_int|9
suffix:semicolon
id|bh
op_assign
id|bh-&gt;b_reqnext
suffix:semicolon
id|sgcount
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|nbytes
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|bh
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Too few blocks for linked request.&quot;
)paren
suffix:semicolon
)brace
id|buff
op_assign
id|sgpnt
(braket
id|sgcount
)braket
dot
id|address
suffix:semicolon
id|bufflen
op_assign
id|sgpnt
(braket
id|sgcount
)braket
dot
id|length
suffix:semicolon
)brace
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|nbytes
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|SCpnt-&gt;use_sg
op_logical_and
op_logical_neg
id|scsi_debug_errsts
)paren
r_if
c_cond
(paren
id|bh
)paren
(brace
id|scsi_dump
c_func
(paren
id|SCpnt
comma
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|WRITE_10
suffix:colon
r_case
id|WRITE_6
suffix:colon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;Write&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
op_star
id|cmd
)paren
op_eq
id|WRITE_10
)paren
id|block
op_assign
id|cmd
(braket
l_int|5
)braket
op_plus
(paren
id|cmd
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_plus
(paren
id|cmd
(braket
l_int|3
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|cmd
(braket
l_int|2
)braket
op_lshift
l_int|24
)paren
suffix:semicolon
r_else
id|block
op_assign
id|cmd
(braket
l_int|3
)braket
op_plus
(paren
id|cmd
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_plus
(paren
(paren
id|cmd
(braket
l_int|1
)braket
op_amp
l_int|0x1f
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|VERIFY_DEBUG
c_func
(paren
id|WRITE
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(w%d)&quot;
comma
id|SCpnt-&gt;request.nr_sectors
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;use_sg
)paren
(brace
r_if
c_cond
(paren
(paren
id|bufflen
op_rshift
l_int|9
)paren
op_ne
id|SCpnt-&gt;request.nr_sectors
)paren
id|panic
(paren
l_string|&quot;Trying to write wrong number of blocks&bslash;n&quot;
)paren
suffix:semicolon
id|sgpnt
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|buff
suffix:semicolon
id|buff
op_assign
id|sgpnt
(braket
id|sgcount
)braket
dot
id|address
suffix:semicolon
)brace
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|block
op_ne
op_star
(paren
(paren
r_int
r_int
op_star
)paren
(paren
id|buff
op_plus
l_int|60
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%x %x :&quot;
comma
id|block
comma
op_star
(paren
(paren
r_int
r_int
op_star
)paren
(paren
id|buff
op_plus
l_int|60
)paren
)paren
)paren
suffix:semicolon
id|scsi_dump
c_func
(paren
id|SCpnt
comma
l_int|1
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;Bad block written.&bslash;n&quot;
)paren
suffix:semicolon
)brace
suffix:semicolon
macro_line|#endif
id|scsi_debug_errsts
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Unknown command %d&bslash;n&quot;
comma
op_star
id|cmd
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SCSI_DEBUG_MAILBOXES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|SCint
(braket
id|i
)braket
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|SCSI_DEBUG_MAILBOXES
op_logical_or
id|SCint
(braket
id|i
)braket
op_ne
l_int|0
)paren
id|panic
c_func
(paren
l_string|&quot;Unable to find empty SCSI_DEBUG command slot.&bslash;n&quot;
)paren
suffix:semicolon
id|SCint
(braket
id|i
)braket
op_assign
id|SCpnt
suffix:semicolon
r_if
c_cond
(paren
id|done
)paren
(brace
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi_debug_queuecommand: now waiting for interrupt &quot;
)paren
suffix:semicolon
)paren
suffix:semicolon
r_if
c_cond
(paren
id|do_done
(braket
id|i
)braket
)paren
id|printk
c_func
(paren
l_string|&quot;scsi_debug_queuecommand: Two concurrent queuecommand?&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|do_done
(braket
id|i
)braket
op_assign
id|done
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;scsi_debug_queuecommand: done cant be NULL&bslash;n&quot;
)paren
suffix:semicolon
id|timeout
(braket
id|i
)braket
op_assign
id|jiffies
op_plus
id|DISK_SPEED
suffix:semicolon
multiline_comment|/* If no timers active, then set this one */
r_if
c_cond
(paren
(paren
id|timer_active
op_amp
(paren
l_int|1
op_lshift
id|SCSI_DEBUG_TIMER
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|timer_table
(braket
id|SCSI_DEBUG_TIMER
)braket
dot
id|expires
op_assign
id|timeout
(braket
id|i
)braket
suffix:semicolon
id|timer_active
op_or_assign
l_int|1
op_lshift
id|SCSI_DEBUG_TIMER
suffix:semicolon
)brace
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|scsi_debug_errsts
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;Sending command (%d %x %d %d)...&quot;
comma
id|i
comma
id|done
comma
id|timeout
(braket
id|i
)braket
comma
id|jiffies
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|internal_done_flag
r_volatile
r_static
r_int
id|internal_done_flag
op_assign
l_int|0
suffix:semicolon
DECL|variable|internal_done_errcode
r_volatile
r_static
r_int
id|internal_done_errcode
op_assign
l_int|0
suffix:semicolon
DECL|function|internal_done
r_static
r_void
id|internal_done
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|internal_done_errcode
op_assign
id|SCpnt-&gt;result
suffix:semicolon
op_increment
id|internal_done_flag
suffix:semicolon
)brace
DECL|function|scsi_debug_command
r_int
id|scsi_debug_command
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi_debug_command: ..calling scsi_debug_queuecommand&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|scsi_debug_queuecommand
c_func
(paren
id|SCpnt
comma
id|internal_done
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|internal_done_flag
)paren
suffix:semicolon
id|internal_done_flag
op_assign
l_int|0
suffix:semicolon
r_return
id|internal_done_errcode
suffix:semicolon
)brace
multiline_comment|/* A &quot;high&quot; level interrupt handler.  This should be called once per jiffy&n; to simulate a regular scsi disk.  We use a timer to do this. */
DECL|function|scsi_debug_intr_handle
r_static
r_void
id|scsi_debug_intr_handle
c_func
(paren
r_void
)paren
(brace
id|Scsi_Cmnd
op_star
id|SCtmp
suffix:semicolon
r_int
id|i
comma
id|pending
suffix:semicolon
r_void
(paren
op_star
id|my_done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
r_int
id|to
suffix:semicolon
id|timer_table
(braket
id|SCSI_DEBUG_TIMER
)braket
dot
id|expires
op_assign
l_int|0
suffix:semicolon
id|timer_active
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|SCSI_DEBUG_TIMER
)paren
suffix:semicolon
id|repeat
suffix:colon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SCSI_DEBUG_MAILBOXES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|SCint
(braket
id|i
)braket
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|timeout
(braket
id|i
)braket
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|timeout
(braket
id|i
)braket
op_le
id|jiffies
)paren
r_break
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|SCSI_DEBUG_MAILBOXES
)paren
(brace
id|pending
op_assign
l_int|0x7fffffff
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SCSI_DEBUG_MAILBOXES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|SCint
(braket
id|i
)braket
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|timeout
(braket
id|i
)braket
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|timeout
(braket
id|i
)braket
op_le
id|jiffies
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_goto
id|repeat
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
id|timeout
(braket
id|i
)braket
OG
id|jiffies
)paren
(brace
r_if
c_cond
(paren
id|pending
OG
id|timeout
(braket
id|i
)braket
)paren
id|pending
op_assign
id|timeout
(braket
id|i
)braket
suffix:semicolon
r_continue
suffix:semicolon
)brace
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
id|pending
op_logical_and
id|pending
op_ne
l_int|0x7fffffff
)paren
(brace
id|timer_table
(braket
id|SCSI_DEBUG_TIMER
)braket
dot
id|expires
op_assign
(paren
id|pending
op_le
id|jiffies
ques
c_cond
id|jiffies
op_plus
l_int|1
suffix:colon
id|pending
)paren
suffix:semicolon
id|timer_active
op_or_assign
l_int|1
op_lshift
id|SCSI_DEBUG_TIMER
suffix:semicolon
)brace
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
id|SCSI_DEBUG_MAILBOXES
)paren
(brace
id|timeout
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|my_done
op_assign
id|do_done
(braket
id|i
)braket
suffix:semicolon
id|do_done
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|to
op_assign
id|timeout
(braket
id|i
)braket
suffix:semicolon
id|timeout
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|SCtmp
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|SCint
(braket
id|i
)braket
suffix:semicolon
id|SCint
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|my_done
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi_debug_intr_handle: Unexpected interrupt&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;In intr_handle...&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;...done %d %x %d %d&bslash;n&quot;
comma
id|i
comma
id|my_done
comma
id|to
comma
id|jiffies
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;In intr_handle: %d %x %x&bslash;n&quot;
comma
id|i
comma
id|SCtmp
comma
id|my_done
)paren
suffix:semicolon
macro_line|#endif
id|my_done
c_func
(paren
id|SCtmp
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;Called done.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
suffix:semicolon
r_goto
id|repeat
suffix:semicolon
)brace
DECL|function|scsi_debug_detect
r_int
id|scsi_debug_detect
c_func
(paren
r_int
id|hostnum
)paren
(brace
id|scsi_debug_host
op_assign
id|hostnum
suffix:semicolon
id|timer_table
(braket
id|SCSI_DEBUG_TIMER
)braket
dot
id|fn
op_assign
id|scsi_debug_intr_handle
suffix:semicolon
id|timer_table
(braket
id|SCSI_DEBUG_TIMER
)braket
dot
id|expires
op_assign
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|scsi_debug_abort
r_int
id|scsi_debug_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_int
id|i
)paren
(brace
r_int
id|j
suffix:semicolon
r_void
(paren
op_star
id|my_done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi_debug_abort&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|i
op_lshift
l_int|16
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|SCSI_DEBUG_MAILBOXES
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|SCpnt
op_eq
id|SCint
(braket
id|j
)braket
)paren
(brace
id|my_done
op_assign
id|do_done
(braket
id|j
)braket
suffix:semicolon
id|my_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|timeout
(braket
id|j
)braket
op_assign
l_int|0
suffix:semicolon
id|SCint
(braket
id|j
)braket
op_assign
l_int|NULL
suffix:semicolon
id|do_done
(braket
id|j
)braket
op_assign
l_int|NULL
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
)brace
suffix:semicolon
)brace
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|scsi_debug_biosparam
r_int
(def_block
id|scsi_debug_biosparam
c_func
(paren
r_int
id|size
comma
r_int
op_star
id|info
)paren
(brace
id|info
(braket
l_int|0
)braket
op_assign
l_int|32
suffix:semicolon
id|info
(braket
l_int|1
)braket
op_assign
l_int|64
suffix:semicolon
id|info
(braket
l_int|2
)braket
op_assign
(paren
id|size
op_plus
l_int|2047
)paren
op_rshift
l_int|11
suffix:semicolon
r_if
c_cond
(paren
id|info
(braket
l_int|2
)braket
op_ge
l_int|1024
)paren
id|info
(braket
l_int|2
)braket
op_assign
l_int|1024
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)def_block
DECL|function|scsi_debug_reset
r_int
id|scsi_debug_reset
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_void
(paren
op_star
id|my_done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi_debug_reset called&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SCSI_DEBUG_MAILBOXES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|SCint
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
id|SCint
(braket
id|i
)braket
op_member_access_from_pointer
id|result
op_assign
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
id|my_done
op_assign
id|do_done
(braket
id|i
)braket
suffix:semicolon
id|my_done
c_func
(paren
id|SCint
(braket
id|i
)braket
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|SCint
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|do_done
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|timeout
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
)brace
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|scsi_debug_info
r_char
op_star
id|scsi_debug_info
c_func
(paren
r_void
)paren
(brace
r_static
r_char
id|buffer
(braket
)braket
op_assign
l_string|&quot; &quot;
suffix:semicolon
multiline_comment|/* looks nicer without anything here */
r_return
id|buffer
suffix:semicolon
)brace
eof
