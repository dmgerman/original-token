multiline_comment|/*&n; *  linux/kernel/fork.c&n; *&n; *  Copyright (C) 1991, 1992  Linus Torvalds&n; */
multiline_comment|/*&n; *  &squot;fork.c&squot; contains the help-routines for the &squot;fork&squot; system call&n; * (see also system_call.s), and some misc functions (&squot;verify_area&squot;).&n; * Fork is rather simple, once you get the hang of it, but the memory&n; * management can be a bitch. See &squot;mm/mm.c&squot;: &squot;copy_page_tables()&squot;&n; */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/system.h&gt;
DECL|macro|MAX_TASKS_PER_USER
mdefine_line|#define MAX_TASKS_PER_USER ((NR_TASKS/4)*3)
DECL|variable|last_pid
r_int
id|last_pid
op_assign
l_int|0
suffix:semicolon
DECL|function|verify_area
r_void
id|verify_area
c_func
(paren
r_void
op_star
id|addr
comma
r_int
id|size
)paren
(brace
r_int
r_int
id|start
suffix:semicolon
id|start
op_assign
(paren
r_int
r_int
)paren
id|addr
suffix:semicolon
id|size
op_add_assign
id|start
op_amp
l_int|0xfff
suffix:semicolon
id|start
op_and_assign
l_int|0xfffff000
suffix:semicolon
id|start
op_add_assign
id|get_base
c_func
(paren
id|current-&gt;ldt
(braket
l_int|2
)braket
)paren
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|size
op_sub_assign
l_int|4096
suffix:semicolon
id|write_verify
c_func
(paren
id|start
)paren
suffix:semicolon
id|start
op_add_assign
l_int|4096
suffix:semicolon
)brace
)brace
DECL|function|copy_mem
r_int
id|copy_mem
c_func
(paren
r_int
id|nr
comma
r_struct
id|task_struct
op_star
id|p
)paren
(brace
r_int
r_int
id|old_data_base
comma
id|new_data_base
comma
id|data_limit
suffix:semicolon
r_int
r_int
id|old_code_base
comma
id|new_code_base
comma
id|code_limit
suffix:semicolon
id|code_limit
op_assign
id|get_limit
c_func
(paren
l_int|0x0f
)paren
suffix:semicolon
id|data_limit
op_assign
id|get_limit
c_func
(paren
l_int|0x17
)paren
suffix:semicolon
id|old_code_base
op_assign
id|get_base
c_func
(paren
id|current-&gt;ldt
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|old_data_base
op_assign
id|get_base
c_func
(paren
id|current-&gt;ldt
(braket
l_int|2
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|old_data_base
op_ne
id|old_code_base
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ldt[0]: %08x %08x&bslash;n&quot;
comma
id|current-&gt;ldt
(braket
l_int|0
)braket
dot
id|a
comma
id|current-&gt;ldt
(braket
l_int|0
)braket
dot
id|b
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ldt[1]: %08x %08x&bslash;n&quot;
comma
id|current-&gt;ldt
(braket
l_int|1
)braket
dot
id|a
comma
id|current-&gt;ldt
(braket
l_int|1
)braket
dot
id|b
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ldt[2]: %08x %08x&bslash;n&quot;
comma
id|current-&gt;ldt
(braket
l_int|2
)braket
dot
id|a
comma
id|current-&gt;ldt
(braket
l_int|2
)braket
dot
id|b
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;We don&squot;t support separate I&amp;D&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data_limit
OL
id|code_limit
)paren
id|panic
c_func
(paren
l_string|&quot;Bad data_limit&quot;
)paren
suffix:semicolon
id|new_data_base
op_assign
id|old_data_base
suffix:semicolon
id|new_code_base
op_assign
id|old_code_base
suffix:semicolon
id|p-&gt;start_code
op_assign
id|new_code_base
suffix:semicolon
id|set_base
c_func
(paren
id|p-&gt;ldt
(braket
l_int|1
)braket
comma
id|new_code_base
)paren
suffix:semicolon
id|set_base
c_func
(paren
id|p-&gt;ldt
(braket
l_int|2
)braket
comma
id|new_data_base
)paren
suffix:semicolon
r_return
id|copy_page_tables
c_func
(paren
id|p
)paren
suffix:semicolon
)brace
DECL|function|find_empty_process
r_static
r_int
id|find_empty_process
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|task_nr
suffix:semicolon
r_int
id|this_user_tasks
op_assign
l_int|0
suffix:semicolon
id|repeat
suffix:colon
r_if
c_cond
(paren
(paren
op_increment
id|last_pid
)paren
op_amp
l_int|0xffff0000
)paren
id|last_pid
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_TASKS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|task
(braket
id|i
)braket
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|task
(braket
id|i
)braket
op_member_access_from_pointer
id|uid
op_eq
id|current-&gt;uid
)paren
id|this_user_tasks
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|task
(braket
id|i
)braket
op_member_access_from_pointer
id|pid
op_eq
id|last_pid
op_logical_or
id|task
(braket
id|i
)braket
op_member_access_from_pointer
id|pgrp
op_eq
id|last_pid
)paren
r_goto
id|repeat
suffix:semicolon
)brace
r_if
c_cond
(paren
id|this_user_tasks
OG
id|MAX_TASKS_PER_USER
op_logical_and
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
multiline_comment|/* Only the super-user can fill the last available slot */
id|task_nr
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|NR_TASKS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|task
(braket
id|i
)braket
)paren
r_if
c_cond
(paren
id|task_nr
)paren
r_return
id|task_nr
suffix:semicolon
r_else
id|task_nr
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|task_nr
op_logical_and
id|suser
c_func
(paren
)paren
)paren
r_return
id|task_nr
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/*&n; *  Ok, this is the main fork-routine. It copies the system process&n; * information (task[nr]) and sets up the necessary registers. It&n; * also copies the data segment in it&squot;s entirety.&n; */
DECL|function|sys_fork
r_int
id|sys_fork
c_func
(paren
r_int
id|ebx
comma
r_int
id|ecx
comma
r_int
id|edx
comma
r_int
id|esi
comma
r_int
id|edi
comma
r_int
id|ebp
comma
r_int
id|eax
comma
r_int
id|ds
comma
r_int
id|es
comma
r_int
id|fs
comma
r_int
id|gs
comma
r_int
id|orig_eax
comma
r_int
id|eip
comma
r_int
id|cs
comma
r_int
id|eflags
comma
r_int
id|esp
comma
r_int
id|ss
)paren
(brace
r_struct
id|task_struct
op_star
id|p
suffix:semicolon
r_int
id|i
comma
id|nr
suffix:semicolon
r_struct
id|file
op_star
id|f
suffix:semicolon
id|p
op_assign
(paren
r_struct
id|task_struct
op_star
)paren
id|get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|nr
op_assign
id|find_empty_process
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nr
OL
l_int|0
)paren
(brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|p
)paren
suffix:semicolon
r_return
id|nr
suffix:semicolon
)brace
id|task
(braket
id|nr
)braket
op_assign
id|p
suffix:semicolon
op_star
id|p
op_assign
op_star
id|current
suffix:semicolon
id|p-&gt;kernel_stack_page
op_assign
l_int|0
suffix:semicolon
id|p-&gt;state
op_assign
id|TASK_UNINTERRUPTIBLE
suffix:semicolon
id|p-&gt;flags
op_and_assign
op_complement
(paren
id|PF_PTRACED
op_or
id|PF_TRACESYS
)paren
suffix:semicolon
id|p-&gt;pid
op_assign
id|last_pid
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;pid
OG
l_int|1
)paren
id|p-&gt;swappable
op_assign
l_int|1
suffix:semicolon
id|p-&gt;p_pptr
op_assign
id|p-&gt;p_opptr
op_assign
id|current
suffix:semicolon
id|p-&gt;p_cptr
op_assign
l_int|NULL
suffix:semicolon
id|SET_LINKS
c_func
(paren
id|p
)paren
suffix:semicolon
id|p-&gt;counter
op_assign
id|p-&gt;priority
suffix:semicolon
id|p-&gt;signal
op_assign
l_int|0
suffix:semicolon
id|p-&gt;it_real_value
op_assign
id|p-&gt;it_virt_value
op_assign
id|p-&gt;it_prof_value
op_assign
l_int|0
suffix:semicolon
id|p-&gt;it_real_incr
op_assign
id|p-&gt;it_virt_incr
op_assign
id|p-&gt;it_prof_incr
op_assign
l_int|0
suffix:semicolon
id|p-&gt;leader
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* process leadership doesn&squot;t inherit */
id|p-&gt;utime
op_assign
id|p-&gt;stime
op_assign
l_int|0
suffix:semicolon
id|p-&gt;cutime
op_assign
id|p-&gt;cstime
op_assign
l_int|0
suffix:semicolon
id|p-&gt;min_flt
op_assign
id|p-&gt;maj_flt
op_assign
l_int|0
suffix:semicolon
id|p-&gt;cmin_flt
op_assign
id|p-&gt;cmaj_flt
op_assign
l_int|0
suffix:semicolon
id|p-&gt;start_time
op_assign
id|jiffies
suffix:semicolon
id|p-&gt;tss.back_link
op_assign
l_int|0
suffix:semicolon
id|p-&gt;tss.ss0
op_assign
l_int|0x10
suffix:semicolon
id|p-&gt;tss.eip
op_assign
id|eip
suffix:semicolon
id|p-&gt;tss.eflags
op_assign
id|eflags
op_amp
l_int|0xffffcfff
suffix:semicolon
multiline_comment|/* iopl is always 0 for a new process */
id|p-&gt;tss.eax
op_assign
l_int|0
suffix:semicolon
id|p-&gt;tss.ecx
op_assign
id|ecx
suffix:semicolon
id|p-&gt;tss.edx
op_assign
id|edx
suffix:semicolon
id|p-&gt;tss.ebx
op_assign
id|ebx
suffix:semicolon
id|p-&gt;tss.esp
op_assign
id|esp
suffix:semicolon
id|p-&gt;tss.ebp
op_assign
id|ebp
suffix:semicolon
id|p-&gt;tss.esi
op_assign
id|esi
suffix:semicolon
id|p-&gt;tss.edi
op_assign
id|edi
suffix:semicolon
id|p-&gt;tss.es
op_assign
id|es
op_amp
l_int|0xffff
suffix:semicolon
id|p-&gt;tss.cs
op_assign
id|cs
op_amp
l_int|0xffff
suffix:semicolon
id|p-&gt;tss.ss
op_assign
id|ss
op_amp
l_int|0xffff
suffix:semicolon
id|p-&gt;tss.ds
op_assign
id|ds
op_amp
l_int|0xffff
suffix:semicolon
id|p-&gt;tss.fs
op_assign
id|fs
op_amp
l_int|0xffff
suffix:semicolon
id|p-&gt;tss.gs
op_assign
id|gs
op_amp
l_int|0xffff
suffix:semicolon
id|p-&gt;tss.ldt
op_assign
id|_LDT
c_func
(paren
id|nr
)paren
suffix:semicolon
id|p-&gt;tss.trace_bitmap
op_assign
m_offsetof
(paren
r_struct
id|tss_struct
comma
id|io_bitmap
)paren
op_lshift
l_int|16
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IO_BITMAP_SIZE
suffix:semicolon
id|i
op_increment
)paren
id|p-&gt;tss.io_bitmap
(braket
id|i
)braket
op_assign
op_complement
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|last_task_used_math
op_eq
id|current
)paren
id|__asm__
c_func
(paren
l_string|&quot;clts ; fnsave %0 ; frstor %0&quot;
op_scope_resolution
l_string|&quot;m&quot;
(paren
id|p-&gt;tss.i387
)paren
)paren
suffix:semicolon
id|p-&gt;kernel_stack_page
op_assign
id|get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;kernel_stack_page
op_logical_or
id|copy_mem
c_func
(paren
id|nr
comma
id|p
)paren
)paren
(brace
id|task
(braket
id|nr
)braket
op_assign
l_int|NULL
suffix:semicolon
id|REMOVE_LINKS
c_func
(paren
id|p
)paren
suffix:semicolon
id|free_page
c_func
(paren
id|p-&gt;kernel_stack_page
)paren
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
)paren
id|p
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|p-&gt;tss.esp0
op_assign
id|PAGE_SIZE
op_plus
id|p-&gt;kernel_stack_page
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_OPEN
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|f
op_assign
id|p-&gt;filp
(braket
id|i
)braket
)paren
id|f-&gt;f_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;pwd
)paren
id|current-&gt;pwd-&gt;i_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;root
)paren
id|current-&gt;root-&gt;i_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;executable
)paren
id|current-&gt;executable-&gt;i_count
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|current-&gt;numlibraries
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|current-&gt;libraries
(braket
id|i
)braket
dot
id|library
)paren
id|current-&gt;libraries
(braket
id|i
)braket
dot
id|library-&gt;i_count
op_increment
suffix:semicolon
id|set_tss_desc
c_func
(paren
id|gdt
op_plus
(paren
id|nr
op_lshift
l_int|1
)paren
op_plus
id|FIRST_TSS_ENTRY
comma
op_amp
(paren
id|p-&gt;tss
)paren
)paren
suffix:semicolon
id|set_ldt_desc
c_func
(paren
id|gdt
op_plus
(paren
id|nr
op_lshift
l_int|1
)paren
op_plus
id|FIRST_LDT_ENTRY
comma
op_amp
(paren
id|p-&gt;ldt
)paren
)paren
suffix:semicolon
id|p-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
multiline_comment|/* do this last, just in case */
r_return
id|p-&gt;pid
suffix:semicolon
)brace
eof
